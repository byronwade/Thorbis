module.exports=[98692,a=>{"use strict";var b=a.i(7912),c=a.i(46052),d=a.i(8574),e=a.i(35234),f=a.i(49177),g=a.i(84251);let h=new f.Resend(process.env.RESEND_API_KEY),i=process.env.RESEND_FROM_EMAIL||"hello@thorbis.com",j=process.env.RESEND_FROM_NAME||"Thorbis";async function k(a){try{var b;let e=await (0,d.createClient)(),{data:f,error:g}=await e.from("email_campaigns").insert({name:a.name,subject:a.subject,preview_text:a.previewText,template_id:a.templateId,template_data:a.templateData,html_content:a.htmlContent,plain_text_content:a.plainTextContent,audience_type:a.audienceType,audience_filter:a.audienceFilter,from_name:a.fromName||j,from_email:a.fromEmail||i,reply_to:a.replyTo,tags:a.tags||[],notes:a.notes,status:"draft",total_recipients:0,sent_count:0,delivered_count:0,opened_count:0,unique_opens:0,clicked_count:0,unique_clicks:0,bounced_count:0,complained_count:0,unsubscribed_count:0,failed_count:0,revenue_attributed:0,conversions_count:0}).select().single();if(g)return console.error("Failed to create campaign:",g),{success:!1,error:"Failed to create campaign"};return(0,c.revalidatePath)("/dashboard/marketing/campaigns"),{success:!0,data:{id:(b=f).id,name:b.name,subject:b.subject,previewText:b.preview_text,templateId:b.template_id,templateData:b.template_data,htmlContent:b.html_content,plainTextContent:b.plain_text_content,status:b.status,scheduledFor:b.scheduled_for,audienceType:b.audience_type,audienceFilter:b.audience_filter,totalRecipients:b.total_recipients||0,sentCount:b.sent_count||0,deliveredCount:b.delivered_count||0,openedCount:b.opened_count||0,uniqueOpens:b.unique_opens||0,clickedCount:b.clicked_count||0,uniqueClicks:b.unique_clicks||0,bouncedCount:b.bounced_count||0,complainedCount:b.complained_count||0,unsubscribedCount:b.unsubscribed_count||0,failedCount:b.failed_count||0,revenueAttributed:Number(b.revenue_attributed||0),conversionsCount:b.conversions_count||0,fromName:b.from_name,fromEmail:b.from_email,replyTo:b.reply_to,tags:b.tags||[],notes:b.notes,createdAt:b.created_at,updatedAt:b.updated_at,sentAt:b.sent_at}}}catch(a){return console.error("Failed to create campaign:",a),{success:!1,error:"Failed to create campaign"}}}async function l(a){try{let b=await (0,d.createClient)(),{data:e,error:f}=await b.from("email_campaigns").select("*").eq("id",a).single();if(f||!e)return{success:!1,error:"Campaign not found"};if("draft"!==e.status)return{success:!1,error:"Only draft campaigns can be sent"};let g=await n(e.audience_type,e.audience_filter);if(0===g.length)return{success:!1,error:"No recipients found for this audience"};await b.from("email_campaigns").update({status:"sending",sending_started_at:new Date().toISOString(),total_recipients:g.length}).eq("id",a);let i=g.map(b=>({campaign_id:a,recipient_email:b.email,recipient_name:b.name,recipient_type:b.type,recipient_id:b.id,status:"pending"}));await b.from("email_campaign_sends").insert(i);let j=0,k=0;for(let c of g)try{let{data:d,error:f}=await h.emails.send({from:`${e.from_name} <${e.from_email}>`,to:c.email,subject:e.subject,html:e.html_content||`<p>${e.plain_text_content}</p>`,text:e.plain_text_content,replyTo:e.reply_to,tags:[{name:"campaign_id",value:a},{name:"recipient_type",value:c.type}]});f?(k++,await b.from("email_campaign_sends").update({status:"failed",error_message:f.message,updated_at:new Date().toISOString()}).eq("campaign_id",a).eq("recipient_email",c.email)):(j++,await b.from("email_campaign_sends").update({status:"sent",resend_id:d?.id,sent_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("campaign_id",a).eq("recipient_email",c.email))}catch(a){k++,console.error(`Failed to send to ${c.email}:`,a)}return await b.from("email_campaigns").update({status:"sent",sent_at:new Date().toISOString(),completed_at:new Date().toISOString(),sent_count:j,failed_count:k}).eq("id",a),(0,c.revalidatePath)("/dashboard/marketing/campaigns"),(0,c.revalidatePath)(`/dashboard/marketing/campaigns/${a}`),{success:!0,data:{campaignId:a,recipientCount:g.length,estimatedCompletionTime:new Date().toISOString()}}}catch(a){return console.error("Failed to send campaign:",a),{success:!1,error:"Failed to send campaign"}}}async function m(a,b){try{let e=await (0,d.createClient)(),{data:f}=await e.from("email_campaigns").select("status, audience_type, audience_filter").eq("id",a).single();if(f?.status!=="draft")return{success:!1,error:"Only draft campaigns can be scheduled"};let g=await n(f.audience_type,f.audience_filter),{error:h}=await e.from("email_campaigns").update({status:"scheduled",scheduled_for:b,total_recipients:g.length,updated_at:new Date().toISOString()}).eq("id",a);if(h)return console.error("Failed to schedule campaign:",h),{success:!1,error:"Failed to schedule campaign"};return(0,c.revalidatePath)("/dashboard/marketing/campaigns"),(0,c.revalidatePath)(`/dashboard/marketing/campaigns/${a}`),{success:!0}}catch(a){return console.error("Failed to schedule campaign:",a),{success:!1,error:"Failed to schedule campaign"}}}async function n(a,b){let c=await (0,d.createClient)(),f=(0,e.getWebReaderClient)(),g=[];if(!f&&["all_users","all_companies","segment"].includes(a))return console.warn("Web database reader not configured, returning empty recipients for:",a),g;switch(a){case"waitlist":{let{data:a}=await c.from("waitlist").select("id, email, name").eq("status","pending").not("email","is",null);g.push(...(a||[]).map(a=>({email:a.email,name:a.name||void 0,type:"waitlist",id:a.id})));break}case"all_users":{let{data:a}=await f.from("users").select("id, email, full_name").not("email","is",null);g.push(...(a||[]).map(a=>({email:a.email,name:a.full_name||void 0,type:"user",id:a.id})));break}case"all_companies":{let{data:a}=await f.from("companies").select("id, email, name").not("email","is",null);g.push(...(a||[]).map(a=>({email:a.email,name:a.name||void 0,type:"company",id:a.id})));break}case"custom":b?.customEmails&&g.push(...b.customEmails.map(a=>({email:a,type:"custom"})));break;case"segment":{let a=f.from("users").select("id, email, full_name, role");b?.userRoles?.length&&(a=a.in("role",b.userRoles)),b?.userStatuses?.length&&(a=a.in("status",b.userStatuses)),b?.createdAfter&&(a=a.gte("created_at",b.createdAfter)),b?.createdBefore&&(a=a.lte("created_at",b.createdBefore));let{data:c}=await a.not("email","is",null);g.push(...(c||[]).map(a=>({email:a.email,name:a.full_name||void 0,type:"segment",id:a.id})))}}if(b?.excludeUnsubscribed||b?.excludeBounced||b?.excludeComplained){let{data:a}=await c.from("email_suppressions").select("email, reason"),d=new Set((a||[]).filter(a=>!!b.excludeUnsubscribed&&"unsubscribed"===a.reason||!!b.excludeBounced&&"bounced"===a.reason||!!b.excludeComplained&&"complained"===a.reason).map(a=>a.email.toLowerCase()));return g.filter(a=>!d.has(a.email.toLowerCase()))}return g}(0,g.ensureServerEntryExports)([k,l,m]),(0,b.registerServerReference)(k,"40258905938530fcaaa6c784215a0af2e117525e15",null),(0,b.registerServerReference)(l,"405237084f20421a77a390c37538f97ae561efb671",null),(0,b.registerServerReference)(m,"603c1099f42d7fe11c54fe611b3e9cb7940af4926b",null),a.s([],14568),a.i(14568),a.s(["40258905938530fcaaa6c784215a0af2e117525e15",()=>k,"405237084f20421a77a390c37538f97ae561efb671",()=>l,"603c1099f42d7fe11c54fe611b3e9cb7940af4926b",()=>m],98692)}];

//# sourceMappingURL=7947d_server_app_%28dashboard%29_dashboard_marketing_campaigns_new_page_actions_45e171ad.js.map