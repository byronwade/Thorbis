module.exports=[98692,a=>{"use strict";var b=a.i(7912),c=a.i(46052),d=a.i(8574),e=a.i(35234),f=a.i(49177),g=a.i(84251);let h=new f.Resend(process.env.RESEND_API_KEY),i=process.env.RESEND_FROM_EMAIL||"hello@thorbis.com",j=process.env.RESEND_FROM_NAME||"Thorbis";async function k(a){try{let b=await (0,d.createClient)(),{data:e,error:f}=await b.from("email_campaigns").insert({name:a.name,subject:a.subject,preview_text:a.previewText,template_id:a.templateId,template_data:a.templateData,html_content:a.htmlContent,plain_text_content:a.plainTextContent,audience_type:a.audienceType,audience_filter:a.audienceFilter,from_name:a.fromName||j,from_email:a.fromEmail||i,reply_to:a.replyTo,tags:a.tags||[],notes:a.notes,status:"draft",total_recipients:0,sent_count:0,delivered_count:0,opened_count:0,unique_opens:0,clicked_count:0,unique_clicks:0,bounced_count:0,complained_count:0,unsubscribed_count:0,failed_count:0,revenue_attributed:0,conversions_count:0}).select().single();if(f)return console.error("Failed to create campaign:",f),{success:!1,error:"Failed to create campaign"};return(0,c.revalidatePath)("/dashboard/marketing/campaigns"),{success:!0,data:y(e)}}catch(a){return console.error("Failed to create campaign:",a),{success:!1,error:"Failed to create campaign"}}}async function l(a){try{let b=await (0,d.createClient)(),e={updated_at:new Date().toISOString()};void 0!==a.name&&(e.name=a.name),void 0!==a.subject&&(e.subject=a.subject),void 0!==a.previewText&&(e.preview_text=a.previewText),void 0!==a.templateId&&(e.template_id=a.templateId),void 0!==a.templateData&&(e.template_data=a.templateData),void 0!==a.htmlContent&&(e.html_content=a.htmlContent),void 0!==a.plainTextContent&&(e.plain_text_content=a.plainTextContent),void 0!==a.audienceType&&(e.audience_type=a.audienceType),void 0!==a.audienceFilter&&(e.audience_filter=a.audienceFilter),void 0!==a.fromName&&(e.from_name=a.fromName),void 0!==a.fromEmail&&(e.from_email=a.fromEmail),void 0!==a.replyTo&&(e.reply_to=a.replyTo),void 0!==a.tags&&(e.tags=a.tags),void 0!==a.notes&&(e.notes=a.notes);let{data:f,error:g}=await b.from("email_campaigns").update(e).eq("id",a.id).select().single();if(g)return console.error("Failed to update campaign:",g),{success:!1,error:"Failed to update campaign"};return(0,c.revalidatePath)("/dashboard/marketing/campaigns"),(0,c.revalidatePath)(`/dashboard/marketing/campaigns/${a.id}`),{success:!0,data:y(f)}}catch(a){return console.error("Failed to update campaign:",a),{success:!1,error:"Failed to update campaign"}}}async function m(a){try{let b=await (0,d.createClient)(),{data:e}=await b.from("email_campaigns").select("status").eq("id",a).single();if(e?.status!=="draft")return{success:!1,error:"Only draft campaigns can be deleted"};let{error:f}=await b.from("email_campaigns").delete().eq("id",a);if(f)return console.error("Failed to delete campaign:",f),{success:!1,error:"Failed to delete campaign"};return(0,c.revalidatePath)("/dashboard/marketing/campaigns"),{success:!0}}catch(a){return console.error("Failed to delete campaign:",a),{success:!1,error:"Failed to delete campaign"}}}async function n(a){try{let b=await (0,d.createClient)(),{data:e,error:f}=await b.from("email_campaigns").select("*").eq("id",a).single();if(f||!e)return{success:!1,error:"Campaign not found"};let{data:g,error:h}=await b.from("email_campaigns").insert({name:`${e.name} (Copy)`,subject:e.subject,preview_text:e.preview_text,template_id:e.template_id,template_data:e.template_data,html_content:e.html_content,plain_text_content:e.plain_text_content,audience_type:e.audience_type,audience_filter:e.audience_filter,from_name:e.from_name,from_email:e.from_email,reply_to:e.reply_to,tags:e.tags,notes:e.notes,status:"draft",total_recipients:0,sent_count:0,delivered_count:0,opened_count:0,unique_opens:0,clicked_count:0,unique_clicks:0,bounced_count:0,complained_count:0,unsubscribed_count:0,failed_count:0,revenue_attributed:0,conversions_count:0}).select().single();if(h)return console.error("Failed to duplicate campaign:",h),{success:!1,error:"Failed to duplicate campaign"};return(0,c.revalidatePath)("/dashboard/marketing/campaigns"),{success:!0,data:y(g)}}catch(a){return console.error("Failed to duplicate campaign:",a),{success:!1,error:"Failed to duplicate campaign"}}}async function o(a){try{let b=await (0,d.createClient)(),{data:e,error:f}=await b.from("email_campaigns").select("*").eq("id",a).single();if(f||!e)return{success:!1,error:"Campaign not found"};if("draft"!==e.status)return{success:!1,error:"Only draft campaigns can be sent"};let g=await w(e.audience_type,e.audience_filter);if(0===g.length)return{success:!1,error:"No recipients found for this audience"};await b.from("email_campaigns").update({status:"sending",sending_started_at:new Date().toISOString(),total_recipients:g.length}).eq("id",a);let i=g.map(b=>({campaign_id:a,recipient_email:b.email,recipient_name:b.name,recipient_type:b.type,recipient_id:b.id,status:"pending"}));await b.from("email_campaign_sends").insert(i);let j=0,k=0;for(let c of g)try{let{data:d,error:f}=await h.emails.send({from:`${e.from_name} <${e.from_email}>`,to:c.email,subject:e.subject,html:e.html_content||`<p>${e.plain_text_content}</p>`,text:e.plain_text_content,replyTo:e.reply_to,tags:[{name:"campaign_id",value:a},{name:"recipient_type",value:c.type}]});f?(k++,await b.from("email_campaign_sends").update({status:"failed",error_message:f.message,updated_at:new Date().toISOString()}).eq("campaign_id",a).eq("recipient_email",c.email)):(j++,await b.from("email_campaign_sends").update({status:"sent",resend_id:d?.id,sent_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("campaign_id",a).eq("recipient_email",c.email))}catch(a){k++,console.error(`Failed to send to ${c.email}:`,a)}return await b.from("email_campaigns").update({status:"sent",sent_at:new Date().toISOString(),completed_at:new Date().toISOString(),sent_count:j,failed_count:k}).eq("id",a),(0,c.revalidatePath)("/dashboard/marketing/campaigns"),(0,c.revalidatePath)(`/dashboard/marketing/campaigns/${a}`),{success:!0,data:{campaignId:a,recipientCount:g.length,estimatedCompletionTime:new Date().toISOString()}}}catch(a){return console.error("Failed to send campaign:",a),{success:!1,error:"Failed to send campaign"}}}async function p(a,b){try{let e=await (0,d.createClient)(),{data:f}=await e.from("email_campaigns").select("status, audience_type, audience_filter").eq("id",a).single();if(f?.status!=="draft")return{success:!1,error:"Only draft campaigns can be scheduled"};let g=await w(f.audience_type,f.audience_filter),{error:h}=await e.from("email_campaigns").update({status:"scheduled",scheduled_for:b,total_recipients:g.length,updated_at:new Date().toISOString()}).eq("id",a);if(h)return console.error("Failed to schedule campaign:",h),{success:!1,error:"Failed to schedule campaign"};return(0,c.revalidatePath)("/dashboard/marketing/campaigns"),(0,c.revalidatePath)(`/dashboard/marketing/campaigns/${a}`),{success:!0}}catch(a){return console.error("Failed to schedule campaign:",a),{success:!1,error:"Failed to schedule campaign"}}}async function q(a){try{let b=await (0,d.createClient)(),{error:e}=await b.from("email_campaigns").update({status:"draft",scheduled_for:null,updated_at:new Date().toISOString()}).eq("id",a).eq("status","scheduled");if(e)return console.error("Failed to cancel scheduled campaign:",e),{success:!1,error:"Failed to cancel scheduled campaign"};return(0,c.revalidatePath)("/dashboard/marketing/campaigns"),(0,c.revalidatePath)(`/dashboard/marketing/campaigns/${a}`),{success:!0}}catch(a){return console.error("Failed to cancel scheduled campaign:",a),{success:!1,error:"Failed to cancel scheduled campaign"}}}async function r(a){try{let b=await (0,d.createClient)(),{error:e}=await b.from("email_campaigns").update({status:"paused",updated_at:new Date().toISOString()}).eq("id",a).eq("status","sending");if(e)return console.error("Failed to pause campaign:",e),{success:!1,error:"Failed to pause campaign"};return(0,c.revalidatePath)("/dashboard/marketing/campaigns"),(0,c.revalidatePath)(`/dashboard/marketing/campaigns/${a}`),{success:!0}}catch(a){return console.error("Failed to pause campaign:",a),{success:!1,error:"Failed to pause campaign"}}}async function s(a){try{let b=await (0,d.createClient)(),{error:e}=await b.from("email_campaigns").update({status:"sending",updated_at:new Date().toISOString()}).eq("id",a).eq("status","paused");if(e)return console.error("Failed to resume campaign:",e),{success:!1,error:"Failed to resume campaign"};return(0,c.revalidatePath)("/dashboard/marketing/campaigns"),(0,c.revalidatePath)(`/dashboard/marketing/campaigns/${a}`),{success:!0}}catch(a){return console.error("Failed to resume campaign:",a),{success:!1,error:"Failed to resume campaign"}}}async function t(a,b){try{let c=await w(a,b);return{success:!0,data:{estimatedCount:c.length,sampleRecipients:c.slice(0,5).map(a=>({email:a.email,name:a.name,type:a.type}))}}}catch(a){return console.error("Failed to preview audience:",a),{success:!1,error:"Failed to preview audience"}}}async function u(a){try{let b=await (0,d.createClient)(),{data:c}=await b.from("email_campaign_links").select("*").eq("campaign_id",a).order("unique_clicks",{ascending:!1}).limit(10),e=(c||[]).map(a=>({url:a.original_url,linkText:a.link_text||a.original_url,clicks:a.total_clicks||0,uniqueClicks:a.unique_clicks||0})),{data:f}=await b.from("email_campaign_sends").select("metadata, first_opened_at").eq("campaign_id",a).not("first_opened_at","is",null),g=0,h=0,i=0;(f||[]).forEach(a=>{let b=a.metadata?.device;"mobile"===b?h++:"tablet"===b?i++:g++});let j=g+h+i||1,k={desktop:Math.round(g/j*100),mobile:Math.round(h/j*100),tablet:Math.round(i/j*100)},l={};(f||[]).forEach(a=>{if(a.first_opened_at){let b=new Date(a.first_opened_at).getHours(),c=b<12?`${b||12} AM`:`${12===b?12:b-12} PM`;l[c]=(l[c]||0)+1}});let m=Object.entries(l).map(([a,b])=>({hour:a,opens:b})).sort((a,b)=>{let c=a=>{let[b,c]=a.split(" ");return"PM"===c&&"12"!==b?parseInt(b)+12:parseInt(b)};return c(a.hour)-c(b.hour)});return{success:!0,data:{topLinks:e,deviceBreakdown:k,hourlyOpens:m}}}catch(a){return console.error("Failed to get campaign analytics:",a),{success:!1,error:"Failed to get campaign analytics"}}}async function v(a,b,c,e){try{let f=await (0,d.createClient)(),g=new Date().toISOString(),h={updated_at:g};switch(c){case"delivered":h.status="delivered",h.delivered_at=g;break;case"opened":h.status="opened",h.last_opened_at=g,await f.rpc("increment_campaign_send_open_count",{p_campaign_id:a,p_recipient_email:b});break;case"clicked":h.status="clicked",h.last_clicked_at=g,e?.url&&await f.rpc("increment_campaign_link_click",{p_campaign_id:a,p_url:e.url});break;case"bounced":h.status="bounced",h.bounced_at=g,h.error_message=e?.reason;break;case"complained":h.status="complained",h.complained_at=g;break;case"unsubscribed":h.unsubscribed_at=g}return await f.from("email_campaign_sends").update(h).eq("campaign_id",a).eq("recipient_email",b),await x(a),{success:!0}}catch(a){return console.error("Failed to record campaign event:",a),{success:!1,error:"Failed to record campaign event"}}}async function w(a,b){let c=await (0,d.createClient)(),f=(0,e.getWebReaderClient)(),g=[];if(!f&&["all_users","all_companies","segment"].includes(a))return console.warn("Web database reader not configured, returning empty recipients for:",a),g;switch(a){case"waitlist":{let{data:a}=await c.from("waitlist").select("id, email, name").eq("status","pending").not("email","is",null);g.push(...(a||[]).map(a=>({email:a.email,name:a.name||void 0,type:"waitlist",id:a.id})));break}case"all_users":{let{data:a}=await f.from("users").select("id, email, full_name").not("email","is",null);g.push(...(a||[]).map(a=>({email:a.email,name:a.full_name||void 0,type:"user",id:a.id})));break}case"all_companies":{let{data:a}=await f.from("companies").select("id, email, name").not("email","is",null);g.push(...(a||[]).map(a=>({email:a.email,name:a.name||void 0,type:"company",id:a.id})));break}case"custom":b?.customEmails&&g.push(...b.customEmails.map(a=>({email:a,type:"custom"})));break;case"segment":{let a=f.from("users").select("id, email, full_name, role");b?.userRoles?.length&&(a=a.in("role",b.userRoles)),b?.userStatuses?.length&&(a=a.in("status",b.userStatuses)),b?.createdAfter&&(a=a.gte("created_at",b.createdAfter)),b?.createdBefore&&(a=a.lte("created_at",b.createdBefore));let{data:c}=await a.not("email","is",null);g.push(...(c||[]).map(a=>({email:a.email,name:a.full_name||void 0,type:"segment",id:a.id})))}}if(b?.excludeUnsubscribed||b?.excludeBounced||b?.excludeComplained){let{data:a}=await c.from("email_suppressions").select("email, reason"),d=new Set((a||[]).filter(a=>!!b.excludeUnsubscribed&&"unsubscribed"===a.reason||!!b.excludeBounced&&"bounced"===a.reason||!!b.excludeComplained&&"complained"===a.reason).map(a=>a.email.toLowerCase()));return g.filter(a=>!d.has(a.email.toLowerCase()))}return g}async function x(a){let b=await (0,d.createClient)(),{data:c}=await b.from("email_campaign_sends").select("status").eq("campaign_id",a);if(!c)return;let e={delivered_count:c.filter(a=>["delivered","opened","clicked"].includes(a.status)).length,opened_count:c.filter(a=>["opened","clicked"].includes(a.status)).length,unique_opens:c.filter(a=>["opened","clicked"].includes(a.status)).length,clicked_count:c.filter(a=>"clicked"===a.status).length,unique_clicks:c.filter(a=>"clicked"===a.status).length,bounced_count:c.filter(a=>"bounced"===a.status).length,complained_count:c.filter(a=>"complained"===a.status).length};await b.from("email_campaigns").update(e).eq("id",a)}function y(a){return{id:a.id,name:a.name,subject:a.subject,previewText:a.preview_text,templateId:a.template_id,templateData:a.template_data,htmlContent:a.html_content,plainTextContent:a.plain_text_content,status:a.status,scheduledFor:a.scheduled_for,audienceType:a.audience_type,audienceFilter:a.audience_filter,totalRecipients:a.total_recipients||0,sentCount:a.sent_count||0,deliveredCount:a.delivered_count||0,openedCount:a.opened_count||0,uniqueOpens:a.unique_opens||0,clickedCount:a.clicked_count||0,uniqueClicks:a.unique_clicks||0,bouncedCount:a.bounced_count||0,complainedCount:a.complained_count||0,unsubscribedCount:a.unsubscribed_count||0,failedCount:a.failed_count||0,revenueAttributed:Number(a.revenue_attributed||0),conversionsCount:a.conversions_count||0,fromName:a.from_name,fromEmail:a.from_email,replyTo:a.reply_to,tags:a.tags||[],notes:a.notes,createdAt:a.created_at,updatedAt:a.updated_at,sentAt:a.sent_at}}(0,g.ensureServerEntryExports)([k,l,m,n,o,p,q,r,s,t,u,v]),(0,b.registerServerReference)(k,"400403bb450c59f3dc1281ec17ff5b405bf16f0803",null),(0,b.registerServerReference)(l,"40b1c40fee38694908f91c87390ef4bed62433c46b",null),(0,b.registerServerReference)(m,"4041fc8f04cd6fcc8f9775e6d83e50f6fc78d526db",null),(0,b.registerServerReference)(n,"40bcabf2a35b7a118030d24b9ad3658e7925808098",null),(0,b.registerServerReference)(o,"406d12cccc4bf8889af742b3bed928745802a14be8",null),(0,b.registerServerReference)(p,"60ebdc09048a2877f279f11960034ee53b27f6c669",null),(0,b.registerServerReference)(q,"40397511b47b65a0f852b7a90f41c9c8f7cdb1f6ef",null),(0,b.registerServerReference)(r,"40a1784f393e2e5b3d3429acfb6bfa244b4b78d841",null),(0,b.registerServerReference)(s,"406146dab92d046f3b8a91617539d366237e16e9e4",null),(0,b.registerServerReference)(t,"608774120f6d6e64ef2b1571475813adc44eea18f2",null),(0,b.registerServerReference)(u,"40bb5cd00a328c172d6f65b6c8f4fd8a69ed2741d8",null),(0,b.registerServerReference)(v,"782f84bd8621ac9007f1592926298ad6762d82498c",null),a.s([],14568),a.i(14568),a.s(["400403bb450c59f3dc1281ec17ff5b405bf16f0803",()=>k,"406d12cccc4bf8889af742b3bed928745802a14be8",()=>o,"60ebdc09048a2877f279f11960034ee53b27f6c669",()=>p],98692)}];

//# sourceMappingURL=7947d_server_app_%28dashboard%29_dashboard_marketing_campaigns_new_page_actions_45e171ad.js.map