module.exports=[7912,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"registerServerReference",{enumerable:!0,get:function(){return d.registerServerReference}});let d=a.r(64460)},84251,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},95683,a=>{"use strict";var b=a.i(7912),c=a.i(93097),d=a.i(12906);async function e(a){let b=(0,c.createAdminClient)(),{error:d}=await b.from("admin_audit_logs").insert({admin_user_id:a.adminUserId,admin_email:a.adminEmail,action:a.action,resource_type:a.resourceType,resource_id:a.resourceId,details:a.details,ip_address:a.ipAddress,user_agent:a.userAgent});d&&console.error("Failed to log admin action:",d)}var f=a.i(46052);async function g(a,b,f,h=["view"]){let i=await (0,d.getAdminSession)();if(!i)return{error:"Unauthorized"};let j=(0,c.createAdminClient)(),{data:k}=await j.rpc("get_active_session_for_company",{p_company_id:a});if(k)return{error:"Active session already exists for this company"};let{data:l,error:m}=await j.from("support_sessions").insert({company_id:a,admin_user_id:i.userId,ticket_id:b,status:"pending",reason:f,requested_permissions:h}).select().single();if(m||!l)return{error:"Failed to create support session"};if(h.length>0){let a=h.map(a=>({session_id:l.id,action_type:a,granted:!1}));await j.from("support_session_permissions").insert(a)}return await e({adminUserId:i.userId,adminEmail:i.email||"",action:"support_session_requested",resourceType:"company",resourceId:a,details:{session_id:l.id,ticket_id:b,reason:f,permissions:h}}),{data:l}}async function h(a,b=60){let d=(0,c.createAdminClient)(),{data:e,error:g}=await d.from("support_sessions").select("*").eq("id",a).single();if(g||!e)return{error:"Session not found"};if("pending"!==e.status)return{error:"Session is not pending approval"};let i=new Date(Date.now()+60*b*1e3),{error:j}=await d.from("support_sessions").update({status:"active",approved_at:new Date().toISOString(),expires_at:i.toISOString()}).eq("id",a);return j?{error:"Failed to approve session"}:(await d.from("support_session_permissions").update({granted:!0,granted_at:new Date().toISOString()}).eq("session_id",a),(0,f.revalidatePath)("/admin/dashboard/work/companies"),{success:!0,expiresAt:i.toISOString()})}async function i(a,b){let d=(0,c.createAdminClient)(),{error:e}=await d.from("support_sessions").update({status:"rejected",rejected_at:new Date().toISOString(),rejected_reason:b}).eq("id",a);return e?{error:"Failed to reject session"}:{success:!0}}async function j(a,b="admin"){let g=await (0,d.getAdminSession)();if(!g&&"admin"===b)return{error:"Unauthorized"};let h=(0,c.createAdminClient)(),{data:i}=await h.from("support_sessions").select("*").eq("id",a).single(),{error:k}=await h.from("support_sessions").update({status:"ended",ended_at:new Date().toISOString(),ended_by:b}).eq("id",a);return k?{error:"Failed to end session"}:(g&&i&&await e({adminUserId:g.userId,adminEmail:g.email||"",action:"support_session_ended",resourceType:"company",resourceId:i.company_id,details:{session_id:a,ended_by:b}}),(0,f.revalidatePath)("/admin/dashboard/work/companies"),{success:!0})}async function k(a){let b=(0,c.createAdminClient)(),{data:d,error:e}=await b.from("support_sessions").select("*, admin_users(email, full_name)").eq("id",a).single();if(e||!d)return{error:"Session not found"};let f="active"===d.status&&d.expires_at&&new Date(d.expires_at)>new Date;return{data:{...d,isActive:f,timeRemaining:d.expires_at?Math.max(0,new Date(d.expires_at).getTime()-Date.now()):0}}}async function l(a){let b=(0,c.createAdminClient)(),{data:d}=await b.rpc("get_active_session_for_company",{p_company_id:a});return d?k(d):{data:null}}async function m(a,b=30){let f=await (0,d.getAdminSession)();if(!f)return{error:"Unauthorized"};let g=(0,c.createAdminClient)(),{data:h}=await g.from("support_sessions").select("*").eq("id",a).single();return h&&"active"===h.status?(await e({adminUserId:f.userId,adminEmail:f.email||"",action:"support_session_extension_requested",resourceType:"company",resourceId:h.company_id,details:{session_id:a,additional_minutes:b}}),{success:!0,message:"Extension request sent to customer"}):{error:"Session is not active"}}async function n(a,b,e,f,g,h,i){let j=await (0,d.getAdminSession)();if(!j)return{error:"Unauthorized"};let k=(0,c.createAdminClient)(),{data:l}=await k.rpc("is_session_active",{p_session_id:a});if(!l)return{error:"Session is not active"};let{error:m}=await k.from("support_session_actions").insert({session_id:a,admin_user_id:j.userId,action:b,resource_type:e,resource_id:f,before_data:g,after_data:h,reason:i});return m?{error:"Failed to log action"}:{success:!0}}async function o(a,b=50){let d=(0,c.createAdminClient)(),{data:e,error:f}=await d.from("support_sessions").select(`
      *,
      admin_users(email, full_name),
      support_tickets(subject)
    `).eq("company_id",a).order("created_at",{ascending:!1}).limit(b);return f?{error:"Failed to fetch sessions"}:{data:e}}async function p(a){let b=(0,c.createAdminClient)(),{data:d,error:e}=await b.from("support_session_actions").select(`
      *,
      admin_users(email, full_name)
    `).eq("session_id",a).order("created_at",{ascending:!1});return e?{error:"Failed to fetch session actions"}:{data:d}}async function q(a,b){let d=(0,c.createAdminClient)(),{data:e}=await d.from("support_session_permissions").select("granted").eq("session_id",a).eq("action_type",b).single();return e?.granted===!0}(0,a.i(84251).ensureServerEntryExports)([g,h,i,j,k,l,m,n,o,p,q]),(0,b.registerServerReference)(g,"785ece91b04405010555785eaea3acb0f6b9b465ae",null),(0,b.registerServerReference)(h,"60cba6ff4b2fb9adf9665a09ead0a2461d0e3dd122",null),(0,b.registerServerReference)(i,"6037ff3db77d31f4f7769487ba22d89e9c052f981e",null),(0,b.registerServerReference)(j,"603b56562ac905a59ad611c9c26163970265203d60",null),(0,b.registerServerReference)(k,"400b832a24cb4d02bfffbee0b5b9f92ec6333a2bd1",null),(0,b.registerServerReference)(l,"40296f64de2115235f9bc4ac8fffa6524982ba037f",null),(0,b.registerServerReference)(m,"605182e57c70ab27ddedab36620eff23417c30de7a",null),(0,b.registerServerReference)(n,"7fcd7ac11d763cb868a031856fc4d7c7b4ea6e5e66",null),(0,b.registerServerReference)(o,"609b2899aa920547871a2f9460ad89c3e3f1db8b09",null),(0,b.registerServerReference)(p,"402c1bc24876298b15f600b20865aeabf5eaf11439",null),(0,b.registerServerReference)(q,"60133529cb5fc09bf1904cc6f0ce533642df95e9d1",null),a.s(["endSupportSession",()=>j],95683)},97588,a=>{"use strict";var b=a.i(95683);a.s([],25834),a.i(25834),a.s(["603b56562ac905a59ad611c9c26163970265203d60",()=>b.endSupportSession],97588)}];

//# sourceMappingURL=_bb6207ff._.js.map