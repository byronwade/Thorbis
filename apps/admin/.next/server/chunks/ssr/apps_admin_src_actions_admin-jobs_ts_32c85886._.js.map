{"version":3,"sources":["turbopack:///[project]/apps/admin/src/lib/admin-actions/framework.ts","turbopack:///[project]/apps/admin/src/actions/admin-jobs.ts","turbopack:///[project]/apps/admin/src/actions/admin-payments.ts","turbopack:///[project]/apps/admin/src/actions/admin-team.ts","turbopack:///[project]/apps/admin/src/actions/admin-invoices.ts"],"sourcesContent":["/**\n * Admin Actions Framework\n *\n * Core framework for all admin editing actions in view-as mode.\n * Provides:\n * - Session validation\n * - Permission checking\n * - Automatic audit logging\n * - Before/after data capture\n * - Error handling\n */\n\nimport {\n\trequireActiveSupportSession,\n\thasPermission,\n\tlogAdminActionInSession,\n\tgetActiveSupportSessionId,\n} from \"@/lib/admin-context\";\nimport { getAdminSession } from \"@/lib/auth/session\";\nimport { createWebClient } from \"@/lib/supabase/web-client\";\n\nexport type ActionResult<T = void> = {\n\tsuccess: boolean;\n\tdata?: T;\n\terror?: string;\n};\n\n/**\n * Admin Action Options\n */\ninterface AdminActionOptions {\n\tpermission: string;\n\taction: string;\n\tresourceType: string;\n\tresourceId: string;\n\treason?: string;\n}\n\n/**\n * Execute Admin Action\n *\n * Wrapper function that handles all common admin action logic:\n * - Validates active support session\n * - Checks required permission\n * - Logs action to audit trail\n * - Handles errors\n *\n * @param options - Action configuration\n * @param handler - The actual action logic (receives supabase client and session)\n * @returns ActionResult with success status and optional data/error\n */\nexport async function executeAdminAction<T>(\n\toptions: AdminActionOptions,\n\thandler: (supabase: ReturnType<typeof createWebClient>, sessionId: string) => Promise<T>,\n): Promise<ActionResult<T>> {\n\ttry {\n\t\t// 1. Validate active support session\n\t\tconst session = await requireActiveSupportSession();\n\n\t\t// 2. Check permission\n\t\tconst hasRequiredPermission = await hasPermission(options.permission);\n\t\tif (!hasRequiredPermission) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Permission denied: ${options.permission} required`,\n\t\t\t};\n\t\t}\n\n\t\t// 3. Get admin user info\n\t\tconst adminSession = await getAdminSession();\n\t\tif (!adminSession) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Admin session not found\",\n\t\t\t};\n\t\t}\n\n\t\t// 4. Execute the action\n\t\tconst supabase = createWebClient();\n\t\tconst result = await handler(supabase, session.sessionId);\n\n\t\t// 5. Log to audit trail\n\t\tconst sessionId = await getActiveSupportSessionId();\n\t\tif (sessionId) {\n\t\t\tawait logAdminActionInSession(\n\t\t\t\toptions.action,\n\t\t\t\toptions.resourceType,\n\t\t\t\toptions.resourceId,\n\t\t\t\tnull, // before_data - handler should log this if needed\n\t\t\t\tnull, // after_data - handler should log this if needed\n\t\t\t\toptions.reason,\n\t\t\t);\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: result,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(`Admin action error (${options.action}):`, error);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error occurred\",\n\t\t};\n\t}\n}\n\n/**\n * Get Before/After Data for Audit Log\n *\n * Fetches current data from a table before making changes.\n * Used for audit trail to show what was changed.\n */\nexport async function getBeforeData(\n\ttable: string,\n\tid: string,\n\tcolumns: string = \"*\",\n): Promise<any> {\n\tconst supabase = createWebClient();\n\n\tconst { data, error } = await supabase\n\t\t.from(table)\n\t\t.select(columns)\n\t\t.eq(\"id\", id)\n\t\t.single();\n\n\tif (error) {\n\t\tconsole.warn(`Failed to fetch before data from ${table}:`, error);\n\t\treturn null;\n\t}\n\n\treturn data;\n}\n\n/**\n * Log Detailed Action\n *\n * Logs an action with before/after data for complete audit trail.\n */\nexport async function logDetailedAction(\n\taction: string,\n\tresourceType: string,\n\tresourceId: string,\n\tbeforeData: any,\n\tafterData: any,\n\treason?: string,\n): Promise<void> {\n\tconst sessionId = await getActiveSupportSessionId();\n\tif (!sessionId) {\n\t\tconsole.warn(\"No active session - cannot log action\");\n\t\treturn;\n\t}\n\n\tawait logAdminActionInSession(\n\t\taction,\n\t\tresourceType,\n\t\tresourceId,\n\t\tbeforeData,\n\t\tafterData,\n\t\treason,\n\t);\n}\n\n/**\n * Validate Company Ownership\n *\n * Ensures the resource belongs to the impersonated company.\n * Prevents admins from accidentally editing data from other companies.\n */\nexport async function validateCompanyOwnership(\n\ttable: string,\n\tresourceId: string,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst supabase = createWebClient();\n\n\tconst { data, error } = await supabase\n\t\t.from(table)\n\t\t.select(\"company_id\")\n\t\t.eq(\"id\", resourceId)\n\t\t.single();\n\n\tif (error || !data) {\n\t\treturn false;\n\t}\n\n\treturn data.company_id === companyId;\n}\n","\"use server\";\n\n/**\n * Admin Job Management Actions\n *\n * Server actions for managing jobs in view-as mode.\n * All actions include:\n * - Session validation\n * - Permission checking\n * - Audit logging\n * - Company ownership validation\n */\n\nimport {\n\texecuteAdminAction,\n\tgetBeforeData,\n\tlogDetailedAction,\n\tvalidateCompanyOwnership,\n\ttype ActionResult,\n} from \"@/lib/admin-actions/framework\";\nimport { getImpersonatedCompanyId } from \"@/lib/admin-context\";\nimport { revalidatePath } from \"next/cache\";\n\n/**\n * Update Job Status\n *\n * Changes a job's status (e.g., pending → in_progress → completed)\n */\nexport async function updateJobStatus(\n\tjobId: string,\n\tnewStatus: string,\n\treason?: string,\n): Promise<ActionResult<{ statusUpdated: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_jobs\",\n\t\t\taction: \"update_job_status\",\n\t\t\tresourceType: \"job\",\n\t\t\tresourceId: jobId,\n\t\t\treason: reason || `Changed status to ${newStatus}`,\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\t// Validate company ownership\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\"jobs\", jobId, companyId);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Job does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get before data\n\t\t\tconst beforeData = await getBeforeData(\"jobs\", jobId, \"id, status\");\n\n\t\t\t// Update status\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.update({\n\t\t\t\t\tstatus: newStatus,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", jobId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to update job status: ${error.message}`);\n\t\t\t}\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"update_job_status\",\n\t\t\t\t\"job\",\n\t\t\t\tjobId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ status: newStatus },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\t// Revalidate the jobs page\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/jobs`);\n\n\t\t\treturn { statusUpdated: true };\n\t\t},\n\t);\n}\n\n/**\n * Reassign Job\n *\n * Assigns a job to a different team member\n */\nexport async function reassignJob(\n\tjobId: string,\n\tnewTeamMemberId: string,\n\treason?: string,\n): Promise<ActionResult<{ jobReassigned: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_jobs\",\n\t\t\taction: \"reassign_job\",\n\t\t\tresourceType: \"job\",\n\t\t\tresourceId: jobId,\n\t\t\treason: reason || `Reassigned to team member ${newTeamMemberId}`,\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\"jobs\", jobId, companyId);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Job does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get before data\n\t\t\tconst beforeData = await getBeforeData(\"jobs\", jobId, \"id, assigned_to\");\n\n\t\t\t// Reassign job\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.update({\n\t\t\t\t\tassigned_to: newTeamMemberId,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", jobId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to reassign job: ${error.message}`);\n\t\t\t}\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"reassign_job\",\n\t\t\t\t\"job\",\n\t\t\t\tjobId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ assigned_to: newTeamMemberId },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/jobs`);\n\n\t\t\treturn { jobReassigned: true };\n\t\t},\n\t);\n}\n\n/**\n * Update Job Schedule\n *\n * Changes scheduled start/end times for a job\n */\nexport async function updateJobSchedule(\n\tjobId: string,\n\tscheduledStart: string,\n\tscheduledEnd: string,\n\treason?: string,\n): Promise<ActionResult<{ scheduleUpdated: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_jobs\",\n\t\t\taction: \"update_job_schedule\",\n\t\t\tresourceType: \"job\",\n\t\t\tresourceId: jobId,\n\t\t\treason: reason || \"Updated job schedule\",\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\"jobs\", jobId, companyId);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Job does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get before data\n\t\t\tconst beforeData = await getBeforeData(\n\t\t\t\t\"jobs\",\n\t\t\t\tjobId,\n\t\t\t\t\"id, scheduled_start, scheduled_end\",\n\t\t\t);\n\n\t\t\t// Update schedule\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.update({\n\t\t\t\t\tscheduled_start: scheduledStart,\n\t\t\t\t\tscheduled_end: scheduledEnd,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", jobId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to update job schedule: ${error.message}`);\n\t\t\t}\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"update_job_schedule\",\n\t\t\t\t\"job\",\n\t\t\t\tjobId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ scheduled_start: scheduledStart, scheduled_end: scheduledEnd },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/jobs`);\n\n\t\t\treturn { scheduleUpdated: true };\n\t\t},\n\t);\n}\n\n/**\n * Update Job Priority\n *\n * Changes a job's priority level\n */\nexport async function updateJobPriority(\n\tjobId: string,\n\tnewPriority: string,\n\treason?: string,\n): Promise<ActionResult<{ priorityUpdated: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_jobs\",\n\t\t\taction: \"update_job_priority\",\n\t\t\tresourceType: \"job\",\n\t\t\tresourceId: jobId,\n\t\t\treason: reason || `Changed priority to ${newPriority}`,\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\"jobs\", jobId, companyId);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Job does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get before data\n\t\t\tconst beforeData = await getBeforeData(\"jobs\", jobId, \"id, priority\");\n\n\t\t\t// Update priority\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.update({\n\t\t\t\t\tpriority: newPriority,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", jobId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to update job priority: ${error.message}`);\n\t\t\t}\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"update_job_priority\",\n\t\t\t\t\"job\",\n\t\t\t\tjobId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ priority: newPriority },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/jobs`);\n\n\t\t\treturn { priorityUpdated: true };\n\t\t},\n\t);\n}\n\n/**\n * Add Job Note\n *\n * Adds an internal note to a job (visible to support team)\n */\nexport async function addJobNote(\n\tjobId: string,\n\tnote: string,\n\treason?: string,\n): Promise<ActionResult<{ noteAdded: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_jobs\",\n\t\t\taction: \"add_job_note\",\n\t\t\tresourceType: \"job\",\n\t\t\tresourceId: jobId,\n\t\t\treason: reason || \"Added support note\",\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\"jobs\", jobId, companyId);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Job does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get current notes\n\t\t\tconst beforeData = await getBeforeData(\"jobs\", jobId, \"id, notes\");\n\t\t\tconst currentNotes = beforeData?.notes || \"\";\n\n\t\t\t// Append new note with timestamp\n\t\t\tconst timestamp = new Date().toISOString();\n\t\t\tconst newNotes = currentNotes\n\t\t\t\t? `${currentNotes}\\n\\n[SUPPORT ${timestamp}]: ${note}`\n\t\t\t\t: `[SUPPORT ${timestamp}]: ${note}`;\n\n\t\t\t// Update notes\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.update({\n\t\t\t\t\tnotes: newNotes,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", jobId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to add job note: ${error.message}`);\n\t\t\t}\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"add_job_note\",\n\t\t\t\t\"job\",\n\t\t\t\tjobId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ notes: newNotes },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/jobs`);\n\n\t\t\treturn { noteAdded: true };\n\t\t},\n\t);\n}\n","\"use server\";\n\n/**\n * Admin Payment Management Actions\n *\n * Server actions for managing payments in view-as mode.\n * Critical actions for support troubleshooting.\n */\n\nimport {\n\texecuteAdminAction,\n\tgetBeforeData,\n\tlogDetailedAction,\n\tvalidateCompanyOwnership,\n\ttype ActionResult,\n} from \"@/lib/admin-actions/framework\";\nimport { getImpersonatedCompanyId } from \"@/lib/admin-context\";\nimport { revalidatePath } from \"next/cache\";\n\n/**\n * Issue Payment Refund\n *\n * Issues a full or partial refund for a payment.\n * CRITICAL: This action should have additional approval workflows in production.\n */\nexport async function issuePaymentRefund(\n\tpaymentId: string,\n\trefundAmount: number,\n\treason: string,\n): Promise<ActionResult<{ refundIssued: boolean; refundAmount: number; newStatus: string }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"refund\",\n\t\t\taction: \"issue_payment_refund\",\n\t\t\tresourceType: \"payment\",\n\t\t\tresourceId: paymentId,\n\t\t\treason: `Refund $${(refundAmount / 100).toFixed(2)}: ${reason}`,\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\n\t\t\t\t\"payments\",\n\t\t\t\tpaymentId,\n\t\t\t\tcompanyId,\n\t\t\t);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Payment does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get payment data\n\t\t\tconst beforeData = await getBeforeData(\n\t\t\t\t\"payments\",\n\t\t\t\tpaymentId,\n\t\t\t\t\"id, amount, status, refunded_amount\",\n\t\t\t);\n\n\t\t\tif (!beforeData) {\n\t\t\t\tthrow new Error(\"Payment not found\");\n\t\t\t}\n\n\t\t\t// Validate refund amount\n\t\t\tconst totalPaid = beforeData.amount || 0;\n\t\t\tconst alreadyRefunded = beforeData.refunded_amount || 0;\n\t\t\tconst maxRefund = totalPaid - alreadyRefunded;\n\n\t\t\tif (refundAmount > maxRefund) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`Refund amount ($${(refundAmount / 100).toFixed(2)}) exceeds available amount ($${(maxRefund / 100).toFixed(2)})`,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (refundAmount <= 0) {\n\t\t\t\tthrow new Error(\"Refund amount must be greater than zero\");\n\t\t\t}\n\n\t\t\t// Calculate new refunded amount\n\t\t\tconst newRefundedAmount = alreadyRefunded + refundAmount;\n\t\t\tconst newStatus =\n\t\t\t\tnewRefundedAmount >= totalPaid ? \"refunded\" : \"partially_refunded\";\n\n\t\t\t// Update payment record\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"payments\")\n\t\t\t\t.update({\n\t\t\t\t\trefunded_amount: newRefundedAmount,\n\t\t\t\t\tstatus: newStatus,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", paymentId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to issue refund: ${error.message}`);\n\t\t\t}\n\n\t\t\t// TODO: In production, integrate with payment processor (Stripe, etc.)\n\t\t\t// to actually process the refund\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"issue_payment_refund\",\n\t\t\t\t\"payment\",\n\t\t\t\tpaymentId,\n\t\t\t\tbeforeData,\n\t\t\t\t{\n\t\t\t\t\trefunded_amount: newRefundedAmount,\n\t\t\t\t\tstatus: newStatus,\n\t\t\t\t\trefund_amount: refundAmount,\n\t\t\t\t},\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/payments`);\n\n\t\t\treturn {\n\t\t\t\trefundIssued: true,\n\t\t\t\trefundAmount,\n\t\t\t\tnewStatus,\n\t\t\t};\n\t\t},\n\t);\n}\n\n/**\n * Retry Failed Payment\n *\n * Marks a failed payment for retry or resets its status.\n */\nexport async function retryFailedPayment(\n\tpaymentId: string,\n\treason?: string,\n): Promise<ActionResult<{ paymentRetried: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_payments\",\n\t\t\taction: \"retry_failed_payment\",\n\t\t\tresourceType: \"payment\",\n\t\t\tresourceId: paymentId,\n\t\t\treason: reason || \"Retrying failed payment\",\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\n\t\t\t\t\"payments\",\n\t\t\t\tpaymentId,\n\t\t\t\tcompanyId,\n\t\t\t);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Payment does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get before data\n\t\t\tconst beforeData = await getBeforeData(\n\t\t\t\t\"payments\",\n\t\t\t\tpaymentId,\n\t\t\t\t\"id, status, failure_reason\",\n\t\t\t);\n\n\t\t\tif (!beforeData) {\n\t\t\t\tthrow new Error(\"Payment not found\");\n\t\t\t}\n\n\t\t\tif (beforeData.status !== \"failed\") {\n\t\t\t\tthrow new Error(\"Only failed payments can be retried\");\n\t\t\t}\n\n\t\t\t// Mark for retry\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"payments\")\n\t\t\t\t.update({\n\t\t\t\t\tstatus: \"pending\",\n\t\t\t\t\tfailure_reason: null,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", paymentId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to retry payment: ${error.message}`);\n\t\t\t}\n\n\t\t\t// TODO: In production, trigger actual payment retry via processor\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"retry_failed_payment\",\n\t\t\t\t\"payment\",\n\t\t\t\tpaymentId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ status: \"pending\", failure_reason: null },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/payments`);\n\n\t\t\treturn { paymentRetried: true };\n\t\t},\n\t);\n}\n\n/**\n * Mark Payment as Completed\n *\n * Manually marks a payment as completed (e.g., for offline payments).\n */\nexport async function markPaymentCompleted(\n\tpaymentId: string,\n\treason: string,\n): Promise<ActionResult<{ paymentCompleted: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_payments\",\n\t\t\taction: \"mark_payment_completed\",\n\t\t\tresourceType: \"payment\",\n\t\t\tresourceId: paymentId,\n\t\t\treason: `Marked as completed: ${reason}`,\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\n\t\t\t\t\"payments\",\n\t\t\t\tpaymentId,\n\t\t\t\tcompanyId,\n\t\t\t);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Payment does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get before data\n\t\t\tconst beforeData = await getBeforeData(\"payments\", paymentId, \"id, status\");\n\n\t\t\tif (!beforeData) {\n\t\t\t\tthrow new Error(\"Payment not found\");\n\t\t\t}\n\n\t\t\tif (beforeData.status === \"completed\") {\n\t\t\t\tthrow new Error(\"Payment is already completed\");\n\t\t\t}\n\n\t\t\t// Mark as completed\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"payments\")\n\t\t\t\t.update({\n\t\t\t\t\tstatus: \"completed\",\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", paymentId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to mark payment as completed: ${error.message}`);\n\t\t\t}\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"mark_payment_completed\",\n\t\t\t\t\"payment\",\n\t\t\t\tpaymentId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ status: \"completed\" },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/payments`);\n\n\t\t\treturn { paymentCompleted: true };\n\t\t},\n\t);\n}\n\n/**\n * Update Payment Method\n *\n * Changes the payment method for a payment record.\n */\nexport async function updatePaymentMethod(\n\tpaymentId: string,\n\tnewPaymentMethod: string,\n\treason?: string,\n): Promise<ActionResult<{ paymentMethodUpdated: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_payments\",\n\t\t\taction: \"update_payment_method\",\n\t\t\tresourceType: \"payment\",\n\t\t\tresourceId: paymentId,\n\t\t\treason: reason || `Changed payment method to ${newPaymentMethod}`,\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\n\t\t\t\t\"payments\",\n\t\t\t\tpaymentId,\n\t\t\t\tcompanyId,\n\t\t\t);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Payment does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get before data\n\t\t\tconst beforeData = await getBeforeData(\n\t\t\t\t\"payments\",\n\t\t\t\tpaymentId,\n\t\t\t\t\"id, payment_method\",\n\t\t\t);\n\n\t\t\t// Update payment method\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"payments\")\n\t\t\t\t.update({\n\t\t\t\t\tpayment_method: newPaymentMethod,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", paymentId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to update payment method: ${error.message}`);\n\t\t\t}\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"update_payment_method\",\n\t\t\t\t\"payment\",\n\t\t\t\tpaymentId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ payment_method: newPaymentMethod },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/payments`);\n\n\t\t\treturn { paymentMethodUpdated: true };\n\t\t},\n\t);\n}\n","\"use server\";\n\n/**\n * Admin Team Management Actions\n *\n * Server actions for managing team members in view-as mode.\n * Includes password resets, role changes, and access management.\n */\n\nimport {\n\texecuteAdminAction,\n\tgetBeforeData,\n\tlogDetailedAction,\n\tvalidateCompanyOwnership,\n\ttype ActionResult,\n} from \"@/lib/admin-actions/framework\";\nimport { getImpersonatedCompanyId } from \"@/lib/admin-context\";\nimport { createAdminClient } from \"@/lib/supabase/admin-client\";\nimport { revalidatePath } from \"next/cache\";\n\n/**\n * Reset Team Member Password\n *\n * Sends a password reset email to a team member.\n * CRITICAL: This action has security implications.\n */\nexport async function resetTeamMemberPassword(\n\tteamMemberId: string,\n\treason: string,\n): Promise<ActionResult<{ passwordResetSent: boolean; email: string }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"reset_password\",\n\t\t\taction: \"reset_team_member_password\",\n\t\t\tresourceType: \"team_member\",\n\t\t\tresourceId: teamMemberId,\n\t\t\treason: `Password reset requested: ${reason}`,\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\n\t\t\t\t\"team_members\",\n\t\t\t\tteamMemberId,\n\t\t\t\tcompanyId,\n\t\t\t);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Team member does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get team member with user data\n\t\t\tconst { data: teamMember, error: fetchError } = await supabase\n\t\t\t\t.from(\"team_members\")\n\t\t\t\t.select(\n\t\t\t\t\t`\n          id,\n          email,\n          user_id,\n          users!team_members_user_id_users_id_fk (\n            email\n          )\n        `,\n\t\t\t\t)\n\t\t\t\t.eq(\"id\", teamMemberId)\n\t\t\t\t.single();\n\n\t\t\tif (fetchError || !teamMember) {\n\t\t\t\tthrow new Error(\"Team member not found\");\n\t\t\t}\n\n\t\t\t// Get user email\n\t\t\tconst users = Array.isArray(teamMember.users)\n\t\t\t\t? teamMember.users[0]\n\t\t\t\t: teamMember.users;\n\t\t\tconst userEmail = users?.email || teamMember.email;\n\n\t\t\tif (!userEmail) {\n\t\t\t\tthrow new Error(\"No email found for team member\");\n\t\t\t}\n\n\t\t\t// Use admin client to send password reset email\n\t\t\tconst adminSupabase = createAdminClient();\n\t\t\tconst { error: resetError } = await adminSupabase.auth.resetPasswordForEmail(\n\t\t\t\tuserEmail,\n\t\t\t\t{\n\t\t\t\t\tredirectTo: `${process.env.NEXT_PUBLIC_WEB_URL}/reset-password`,\n\t\t\t\t},\n\t\t\t);\n\n\t\t\tif (resetError) {\n\t\t\t\tthrow new Error(`Failed to send password reset: ${resetError.message}`);\n\t\t\t}\n\n\t\t\t// Log action\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"reset_team_member_password\",\n\t\t\t\t\"team_member\",\n\t\t\t\tteamMemberId,\n\t\t\t\t{ email: userEmail },\n\t\t\t\t{ password_reset_sent: true },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\treturn {\n\t\t\t\tpasswordResetSent: true,\n\t\t\t\temail: userEmail,\n\t\t\t};\n\t\t},\n\t);\n}\n\n/**\n * Change Team Member Role\n *\n * Updates a team member's role in the company.\n */\nexport async function changeTeamMemberRole(\n\tteamMemberId: string,\n\tnewRole: string,\n\treason?: string,\n): Promise<ActionResult<{ roleChanged: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_team\",\n\t\t\taction: \"change_team_member_role\",\n\t\t\tresourceType: \"team_member\",\n\t\t\tresourceId: teamMemberId,\n\t\t\treason: reason || `Changed role to ${newRole}`,\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\n\t\t\t\t\"team_members\",\n\t\t\t\tteamMemberId,\n\t\t\t\tcompanyId,\n\t\t\t);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Team member does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get before data\n\t\t\tconst beforeData = await getBeforeData(\n\t\t\t\t\"team_members\",\n\t\t\t\tteamMemberId,\n\t\t\t\t\"id, role\",\n\t\t\t);\n\n\t\t\t// Update role\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"team_members\")\n\t\t\t\t.update({\n\t\t\t\t\trole: newRole,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", teamMemberId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to change role: ${error.message}`);\n\t\t\t}\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"change_team_member_role\",\n\t\t\t\t\"team_member\",\n\t\t\t\tteamMemberId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ role: newRole },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/team`);\n\n\t\t\treturn { roleChanged: true };\n\t\t},\n\t);\n}\n\n/**\n * Update Team Member Status\n *\n * Activates, deactivates, or suspends a team member.\n */\nexport async function updateTeamMemberStatus(\n\tteamMemberId: string,\n\tnewStatus: string,\n\treason?: string,\n): Promise<ActionResult<{ statusUpdated: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_team\",\n\t\t\taction: \"update_team_member_status\",\n\t\t\tresourceType: \"team_member\",\n\t\t\tresourceId: teamMemberId,\n\t\t\treason: reason || `Changed status to ${newStatus}`,\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\n\t\t\t\t\"team_members\",\n\t\t\t\tteamMemberId,\n\t\t\t\tcompanyId,\n\t\t\t);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Team member does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get before data\n\t\t\tconst beforeData = await getBeforeData(\n\t\t\t\t\"team_members\",\n\t\t\t\tteamMemberId,\n\t\t\t\t\"id, status\",\n\t\t\t);\n\n\t\t\t// Update status\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"team_members\")\n\t\t\t\t.update({\n\t\t\t\t\tstatus: newStatus,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", teamMemberId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to update status: ${error.message}`);\n\t\t\t}\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"update_team_member_status\",\n\t\t\t\t\"team_member\",\n\t\t\t\tteamMemberId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ status: newStatus },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/team`);\n\n\t\t\treturn { statusUpdated: true };\n\t\t},\n\t);\n}\n\n/**\n * Update Team Member Email\n *\n * Changes a team member's email address.\n */\nexport async function updateTeamMemberEmail(\n\tteamMemberId: string,\n\tnewEmail: string,\n\treason: string,\n): Promise<ActionResult<{ emailUpdated: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_team\",\n\t\t\taction: \"update_team_member_email\",\n\t\t\tresourceType: \"team_member\",\n\t\t\tresourceId: teamMemberId,\n\t\t\treason: `Updated email to ${newEmail}: ${reason}`,\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\n\t\t\t\t\"team_members\",\n\t\t\t\tteamMemberId,\n\t\t\t\tcompanyId,\n\t\t\t);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Team member does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Validate email format\n\t\t\tconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n\t\t\tif (!emailRegex.test(newEmail)) {\n\t\t\t\tthrow new Error(\"Invalid email format\");\n\t\t\t}\n\n\t\t\t// Get before data\n\t\t\tconst beforeData = await getBeforeData(\n\t\t\t\t\"team_members\",\n\t\t\t\tteamMemberId,\n\t\t\t\t\"id, email, user_id\",\n\t\t\t);\n\n\t\t\t// Update team member email\n\t\t\tconst { error: teamError } = await supabase\n\t\t\t\t.from(\"team_members\")\n\t\t\t\t.update({\n\t\t\t\t\temail: newEmail,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", teamMemberId);\n\n\t\t\tif (teamError) {\n\t\t\t\tthrow new Error(`Failed to update team member email: ${teamError.message}`);\n\t\t\t}\n\n\t\t\t// If there's a linked user, update their email too\n\t\t\tif (beforeData?.user_id) {\n\t\t\t\tconst adminSupabase = createAdminClient();\n\t\t\t\tconst { error: userError } = await adminSupabase.auth.admin.updateUserById(\n\t\t\t\t\tbeforeData.user_id,\n\t\t\t\t\t{\n\t\t\t\t\t\temail: newEmail,\n\t\t\t\t\t},\n\t\t\t\t);\n\n\t\t\t\tif (userError) {\n\t\t\t\t\tconsole.warn(\"Failed to update user email:\", userError);\n\t\t\t\t\t// Don't fail the whole operation if user email update fails\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"update_team_member_email\",\n\t\t\t\t\"team_member\",\n\t\t\t\tteamMemberId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ email: newEmail },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/team`);\n\n\t\t\treturn { emailUpdated: true };\n\t\t},\n\t);\n}\n","\"use server\";\n\n/**\n * Admin Invoice Management Actions\n *\n * Server actions for managing invoices in view-as mode.\n */\n\nimport {\n\texecuteAdminAction,\n\tgetBeforeData,\n\tlogDetailedAction,\n\tvalidateCompanyOwnership,\n\ttype ActionResult,\n} from \"@/lib/admin-actions/framework\";\nimport { getImpersonatedCompanyId } from \"@/lib/admin-context\";\nimport { revalidatePath } from \"next/cache\";\n\n/**\n * Update Invoice Status\n *\n * Changes an invoice's status (draft, sent, paid, overdue, cancelled).\n */\nexport async function updateInvoiceStatus(\n\tinvoiceId: string,\n\tnewStatus: string,\n\treason?: string,\n): Promise<ActionResult<{ statusUpdated: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_invoices\",\n\t\t\taction: \"update_invoice_status\",\n\t\t\tresourceType: \"invoice\",\n\t\t\tresourceId: invoiceId,\n\t\t\treason: reason || `Changed status to ${newStatus}`,\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\n\t\t\t\t\"invoices\",\n\t\t\t\tinvoiceId,\n\t\t\t\tcompanyId,\n\t\t\t);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Invoice does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get before data\n\t\t\tconst beforeData = await getBeforeData(\"invoices\", invoiceId, \"id, status\");\n\n\t\t\t// Update status\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"invoices\")\n\t\t\t\t.update({\n\t\t\t\t\tstatus: newStatus,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", invoiceId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to update invoice status: ${error.message}`);\n\t\t\t}\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"update_invoice_status\",\n\t\t\t\t\"invoice\",\n\t\t\t\tinvoiceId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ status: newStatus },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/invoices`);\n\n\t\t\treturn { statusUpdated: true };\n\t\t},\n\t);\n}\n\n/**\n * Void Invoice\n *\n * Voids an invoice (marks as cancelled and creates audit trail).\n */\nexport async function voidInvoice(\n\tinvoiceId: string,\n\treason: string,\n): Promise<ActionResult<{ invoiceVoided: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_invoices\",\n\t\t\taction: \"void_invoice\",\n\t\t\tresourceType: \"invoice\",\n\t\t\tresourceId: invoiceId,\n\t\t\treason: `Voided invoice: ${reason}`,\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\n\t\t\t\t\"invoices\",\n\t\t\t\tinvoiceId,\n\t\t\t\tcompanyId,\n\t\t\t);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Invoice does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get before data\n\t\t\tconst beforeData = await getBeforeData(\n\t\t\t\t\"invoices\",\n\t\t\t\tinvoiceId,\n\t\t\t\t\"id, status, total_amount\",\n\t\t\t);\n\n\t\t\tif (!beforeData) {\n\t\t\t\tthrow new Error(\"Invoice not found\");\n\t\t\t}\n\n\t\t\t// Check if invoice can be voided\n\t\t\tif (beforeData.status === \"paid\") {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t\"Cannot void a paid invoice. Issue a refund instead.\",\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Void invoice\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"invoices\")\n\t\t\t\t.update({\n\t\t\t\t\tstatus: \"cancelled\",\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", invoiceId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to void invoice: ${error.message}`);\n\t\t\t}\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"void_invoice\",\n\t\t\t\t\"invoice\",\n\t\t\t\tinvoiceId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ status: \"cancelled\", voided: true },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/invoices`);\n\n\t\t\treturn { invoiceVoided: true };\n\t\t},\n\t);\n}\n\n/**\n * Update Invoice Due Date\n *\n * Changes the due date for an invoice.\n */\nexport async function updateInvoiceDueDate(\n\tinvoiceId: string,\n\tnewDueDate: string,\n\treason?: string,\n): Promise<ActionResult<{ dueDateUpdated: boolean }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_invoices\",\n\t\t\taction: \"update_invoice_due_date\",\n\t\t\tresourceType: \"invoice\",\n\t\t\tresourceId: invoiceId,\n\t\t\treason: reason || `Changed due date to ${newDueDate}`,\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\n\t\t\t\t\"invoices\",\n\t\t\t\tinvoiceId,\n\t\t\t\tcompanyId,\n\t\t\t);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Invoice does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get before data\n\t\t\tconst beforeData = await getBeforeData(\n\t\t\t\t\"invoices\",\n\t\t\t\tinvoiceId,\n\t\t\t\t\"id, due_date\",\n\t\t\t);\n\n\t\t\t// Update due date\n\t\t\tconst { error } = await supabase\n\t\t\t\t.from(\"invoices\")\n\t\t\t\t.update({\n\t\t\t\t\tdue_date: newDueDate,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", invoiceId);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Failed to update due date: ${error.message}`);\n\t\t\t}\n\n\t\t\t// Log with before/after data\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"update_invoice_due_date\",\n\t\t\t\t\"invoice\",\n\t\t\t\tinvoiceId,\n\t\t\t\tbeforeData,\n\t\t\t\t{ due_date: newDueDate },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\trevalidatePath(`/admin/dashboard/view-as/${companyId}/work/invoices`);\n\n\t\t\treturn { dueDateUpdated: true };\n\t\t},\n\t);\n}\n\n/**\n * Send Invoice Reminder\n *\n * Manually triggers sending an invoice reminder email.\n */\nexport async function sendInvoiceReminder(\n\tinvoiceId: string,\n\treason?: string,\n): Promise<ActionResult<{ reminderSent: boolean; sentTo?: string }>> {\n\treturn executeAdminAction(\n\t\t{\n\t\t\tpermission: \"edit_invoices\",\n\t\t\taction: \"send_invoice_reminder\",\n\t\t\tresourceType: \"invoice\",\n\t\t\tresourceId: invoiceId,\n\t\t\treason: reason || \"Sent invoice reminder\",\n\t\t},\n\t\tasync (supabase, sessionId) => {\n\t\t\tconst companyId = await getImpersonatedCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\tthrow new Error(\"Not in view-as mode\");\n\t\t\t}\n\n\t\t\tconst isOwned = await validateCompanyOwnership(\n\t\t\t\t\"invoices\",\n\t\t\t\tinvoiceId,\n\t\t\t\tcompanyId,\n\t\t\t);\n\t\t\tif (!isOwned) {\n\t\t\t\tthrow new Error(\"Invoice does not belong to this company\");\n\t\t\t}\n\n\t\t\t// Get invoice with customer info\n\t\t\tconst { data: invoice, error: fetchError } = await supabase\n\t\t\t\t.from(\"invoices\")\n\t\t\t\t.select(\n\t\t\t\t\t`\n          id,\n          invoice_number,\n          status,\n          customers!invoices_customer_id_customers_id_fk (\n            email,\n            display_name\n          )\n        `,\n\t\t\t\t)\n\t\t\t\t.eq(\"id\", invoiceId)\n\t\t\t\t.single();\n\n\t\t\tif (fetchError || !invoice) {\n\t\t\t\tthrow new Error(\"Invoice not found\");\n\t\t\t}\n\n\t\t\t// TODO: In production, integrate with email service to send reminder\n\t\t\t// For now, just log the action\n\n\t\t\tconst customers = Array.isArray(invoice.customers)\n\t\t\t\t? invoice.customers[0]\n\t\t\t\t: invoice.customers;\n\n\t\t\t// Log action\n\t\t\tawait logDetailedAction(\n\t\t\t\t\"send_invoice_reminder\",\n\t\t\t\t\"invoice\",\n\t\t\t\tinvoiceId,\n\t\t\t\t{ invoice_number: invoice.invoice_number },\n\t\t\t\t{ reminder_sent: true, sent_to: customers?.email },\n\t\t\t\treason,\n\t\t\t);\n\n\t\t\treturn {\n\t\t\t\treminderSent: true,\n\t\t\t\tsentTo: customers?.email,\n\t\t\t};\n\t\t},\n\t);\n}\n"],"names":[],"mappings":"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"}