{"version":3,"sources":["turbopack:///[project]/apps/web/src/lib/search/full-text-search.ts"],"sourcesContent":["/**\n * Full-Text Search Utilities\n *\n * Provides enterprise-grade PostgreSQL full-text search with:\n * - Weighted ranking (ts_rank) for best match results\n * - Multi-field search across all relevant columns\n * - Fuzzy matching with pg_trgm for typo tolerance\n * - Company-scoped security (RLS enforced)\n *\n * Performance:\n * - Uses GIN indexes for sub-millisecond search\n * - Searches millions of records efficiently\n * - Returns top 50 results by default (configurable)\n *\n * Search Features:\n * - Multi-word queries: \"john plumber\" matches both words\n * - Phrase search: Use quotes for exact phrases\n * - Fuzzy matching: Handles typos and variations\n * - Weighted fields: Name matches rank higher than notes\n */\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\n\n/**\n * Search result with ranking score\n */\nexport type SearchResult<T> = T & {\n\tsearch_rank?: number;\n\tsearch_similarity?: number;\n};\n\n/**\n * Search options for customization\n */\nexport type SearchOptions = {\n\tlimit?: number;\n\toffset?: number;\n\tminSimilarity?: number; // 0-1, default 0.3\n\tuseFullTextSearch?: boolean; // Default true\n\tuseFuzzyMatch?: boolean; // Default true\n\torderBy?: string; // Additional ordering after rank\n};\n\n/**\n * Search customers with full-text search and ranking\n *\n * Searches across: first_name, last_name, display_name, email, phone, company_name, address\n * Returns results ordered by relevance (best matches first)\n *\n * @example\n * const results = await searchCustomersFullText(supabase, companyId, \"john plumber\");\n * // Returns customers matching \"john\" AND \"plumber\" ranked by relevance\n */\nexport async function searchCustomersFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst {\n\t\tlimit = 50,\n\t\toffset = 0,\n\t\tminSimilarity = 0.3,\n\t\tuseFullTextSearch = true,\n\t\tuseFuzzyMatch = true,\n\t} = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_customers_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search if full-text search not available or fails\n\tconst { data } = await supabase\n\t\t.from(\"customers\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.or(\n\t\t\t`display_name.ilike.%${query}%,email.ilike.%${query}%,phone.ilike.%${query}%,company_name.ilike.%${query}%,address.ilike.%${query}%,city.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"display_name\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search jobs with full-text search and ranking\n *\n * Searches across: job_number, title, description, notes, job_type, status, priority\n * Returns results ordered by relevance\n */\nexport async function searchJobsFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 50, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_jobs_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"jobs\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.or(\n\t\t\t`job_number.ilike.%${query}%,title.ilike.%${query}%,description.ilike.%${query}%,notes.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search properties with full-text search and ranking\n *\n * Searches across: name, address, city, state, zip_code, notes\n * Returns results ordered by relevance\n */\nasync function searchPropertiesFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 50, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_properties_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"properties\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.or(\n\t\t\t`name.ilike.%${query}%,address.ilike.%${query}%,city.ilike.%${query}%,state.ilike.%${query}%,zip_code.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"address\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search price book items with full-text search and ranking\n *\n * Searches across: name, sku, supplier_sku, description, category, subcategory\n * Returns results ordered by relevance\n */\nasync function searchPriceBookItemsFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 100, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\n\t\t\t\"search_price_book_items_ranked\",\n\t\t\t{\n\t\t\t\tcompany_id_param: companyId,\n\t\t\t\tsearch_query: query,\n\t\t\t\tresult_limit: limit,\n\t\t\t\tresult_offset: offset,\n\t\t\t},\n\t\t);\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"price_book_items\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.or(\n\t\t\t`name.ilike.%${query}%,sku.ilike.%${query}%,supplier_sku.ilike.%${query}%,description.ilike.%${query}%,category.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"name\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search equipment with full-text search and ranking\n *\n * Searches across: equipment_number, name, type, manufacturer, model, serial_number\n * Returns results ordered by relevance\n */\nasync function searchEquipmentFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 50, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_equipment_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"equipment\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.or(\n\t\t\t`equipment_number.ilike.%${query}%,name.ilike.%${query}%,type.ilike.%${query}%,manufacturer.ilike.%${query}%,model.ilike.%${query}%,serial_number.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"name\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Universal search function - searches across ALL entities\n *\n * Returns combined results from customers, jobs, properties, equipment, etc.\n * Useful for global search functionality\n */\nexport async function searchAllEntities(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<{\n\tcustomers: SearchResult<any>[];\n\tjobs: SearchResult<any>[];\n\tproperties: SearchResult<any>[];\n\tequipment: SearchResult<any>[];\n\tpriceBookItems: SearchResult<any>[];\n}> {\n\tconst defaultLimit = options.limit || 10; // Limit per entity\n\n\tconst [customers, jobs, properties, equipment, priceBookItems] =\n\t\tawait Promise.all([\n\t\t\tsearchCustomersFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchJobsFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchPropertiesFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchEquipmentFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchPriceBookItemsFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t]);\n\n\treturn {\n\t\tcustomers,\n\t\tjobs,\n\t\tproperties,\n\t\tequipment,\n\t\tpriceBookItems,\n\t};\n}\n"],"names":[],"mappings":"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"}