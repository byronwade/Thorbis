module.exports=[52438,14895,80676,75409,a=>{"use strict";var b=a.i(7912),c=a.i(13206),d=a.i(12906),e=a.i(38734);async function f(a,b){try{let f=await (0,c.requireActiveSupportSession)();if(!await (0,c.hasPermission)(a.permission))return{success:!1,error:`Permission denied: ${a.permission} required`};if(!await (0,d.getAdminSession)())return{success:!1,error:"Admin session not found"};let g=(0,e.createWebClient)(),h=await b(g,f.sessionId);return await (0,c.getActiveSupportSessionId)()&&await (0,c.logAdminActionInSession)(a.action,a.resourceType,a.resourceId,null,null,a.reason),{success:!0,data:h}}catch(b){return console.error(`Admin action error (${a.action}):`,b),{success:!1,error:b instanceof Error?b.message:"Unknown error occurred"}}}async function g(a,b,c="*"){let d=(0,e.createWebClient)(),{data:f,error:h}=await d.from(a).select(c).eq("id",b).single();return h?(console.warn(`Failed to fetch before data from ${a}:`,h),null):f}async function h(a,b,d,e,f,g){await (0,c.getActiveSupportSessionId)()?await (0,c.logAdminActionInSession)(a,b,d,e,f,g):console.warn("No active session - cannot log action")}async function i(a,b,c){let d=(0,e.createWebClient)(),{data:f,error:g}=await d.from(a).select("company_id").eq("id",b).single();return!g&&!!f&&f.company_id===c}var j=a.i(46052),k=a.i(84251);async function l(a,b,d){return f({permission:"edit_jobs",action:"update_job_status",resourceType:"job",resourceId:a,reason:d||`Changed status to ${b}`},async(e,f)=>{let k=await (0,c.getImpersonatedCompanyId)();if(!k)throw Error("Not in view-as mode");if(!await i("jobs",a,k))throw Error("Job does not belong to this company");let l=await g("jobs",a,"id, status"),{error:m}=await e.from("jobs").update({status:b,updated_at:new Date().toISOString()}).eq("id",a);if(m)throw Error(`Failed to update job status: ${m.message}`);return await h("update_job_status","job",a,l,{status:b},d),(0,j.revalidatePath)(`/admin/dashboard/view-as/${k}/work/jobs`),{statusUpdated:!0}})}async function m(a,b,d){return f({permission:"edit_jobs",action:"reassign_job",resourceType:"job",resourceId:a,reason:d||`Reassigned to team member ${b}`},async(e,f)=>{let k=await (0,c.getImpersonatedCompanyId)();if(!k)throw Error("Not in view-as mode");if(!await i("jobs",a,k))throw Error("Job does not belong to this company");let l=await g("jobs",a,"id, assigned_to"),{error:m}=await e.from("jobs").update({assigned_to:b,updated_at:new Date().toISOString()}).eq("id",a);if(m)throw Error(`Failed to reassign job: ${m.message}`);return await h("reassign_job","job",a,l,{assigned_to:b},d),(0,j.revalidatePath)(`/admin/dashboard/view-as/${k}/work/jobs`),{jobReassigned:!0}})}async function n(a,b,d,e){return f({permission:"edit_jobs",action:"update_job_schedule",resourceType:"job",resourceId:a,reason:e||"Updated job schedule"},async(f,k)=>{let l=await (0,c.getImpersonatedCompanyId)();if(!l)throw Error("Not in view-as mode");if(!await i("jobs",a,l))throw Error("Job does not belong to this company");let m=await g("jobs",a,"id, scheduled_start, scheduled_end"),{error:n}=await f.from("jobs").update({scheduled_start:b,scheduled_end:d,updated_at:new Date().toISOString()}).eq("id",a);if(n)throw Error(`Failed to update job schedule: ${n.message}`);return await h("update_job_schedule","job",a,m,{scheduled_start:b,scheduled_end:d},e),(0,j.revalidatePath)(`/admin/dashboard/view-as/${l}/work/jobs`),{scheduleUpdated:!0}})}async function o(a,b,d){return f({permission:"edit_jobs",action:"update_job_priority",resourceType:"job",resourceId:a,reason:d||`Changed priority to ${b}`},async(e,f)=>{let k=await (0,c.getImpersonatedCompanyId)();if(!k)throw Error("Not in view-as mode");if(!await i("jobs",a,k))throw Error("Job does not belong to this company");let l=await g("jobs",a,"id, priority"),{error:m}=await e.from("jobs").update({priority:b,updated_at:new Date().toISOString()}).eq("id",a);if(m)throw Error(`Failed to update job priority: ${m.message}`);return await h("update_job_priority","job",a,l,{priority:b},d),(0,j.revalidatePath)(`/admin/dashboard/view-as/${k}/work/jobs`),{priorityUpdated:!0}})}async function p(a,b,d){return f({permission:"edit_jobs",action:"add_job_note",resourceType:"job",resourceId:a,reason:d||"Added support note"},async(e,f)=>{let k=await (0,c.getImpersonatedCompanyId)();if(!k)throw Error("Not in view-as mode");if(!await i("jobs",a,k))throw Error("Job does not belong to this company");let l=await g("jobs",a,"id, notes"),m=l?.notes||"",n=new Date().toISOString(),o=m?`${m}

[SUPPORT ${n}]: ${b}`:`[SUPPORT ${n}]: ${b}`,{error:p}=await e.from("jobs").update({notes:o,updated_at:new Date().toISOString()}).eq("id",a);if(p)throw Error(`Failed to add job note: ${p.message}`);return await h("add_job_note","job",a,l,{notes:o},d),(0,j.revalidatePath)(`/admin/dashboard/view-as/${k}/work/jobs`),{noteAdded:!0}})}async function q(a,b,d){return f({permission:"refund",action:"issue_payment_refund",resourceType:"payment",resourceId:a,reason:`Refund $${(b/100).toFixed(2)}: ${d}`},async(e,f)=>{let k=await (0,c.getImpersonatedCompanyId)();if(!k)throw Error("Not in view-as mode");if(!await i("payments",a,k))throw Error("Payment does not belong to this company");let l=await g("payments",a,"id, amount, status, refunded_amount");if(!l)throw Error("Payment not found");let m=l.amount||0,n=l.refunded_amount||0,o=m-n;if(b>o)throw Error(`Refund amount ($${(b/100).toFixed(2)}) exceeds available amount ($${(o/100).toFixed(2)})`);if(b<=0)throw Error("Refund amount must be greater than zero");let p=n+b,q=p>=m?"refunded":"partially_refunded",{error:r}=await e.from("payments").update({refunded_amount:p,status:q,updated_at:new Date().toISOString()}).eq("id",a);if(r)throw Error(`Failed to issue refund: ${r.message}`);return await h("issue_payment_refund","payment",a,l,{refunded_amount:p,status:q,refund_amount:b},d),(0,j.revalidatePath)(`/admin/dashboard/view-as/${k}/work/payments`),{refundIssued:!0,refundAmount:b,newStatus:q}})}async function r(a,b){return f({permission:"edit_payments",action:"retry_failed_payment",resourceType:"payment",resourceId:a,reason:b||"Retrying failed payment"},async(d,e)=>{let f=await (0,c.getImpersonatedCompanyId)();if(!f)throw Error("Not in view-as mode");if(!await i("payments",a,f))throw Error("Payment does not belong to this company");let k=await g("payments",a,"id, status, failure_reason");if(!k)throw Error("Payment not found");if("failed"!==k.status)throw Error("Only failed payments can be retried");let{error:l}=await d.from("payments").update({status:"pending",failure_reason:null,updated_at:new Date().toISOString()}).eq("id",a);if(l)throw Error(`Failed to retry payment: ${l.message}`);return await h("retry_failed_payment","payment",a,k,{status:"pending",failure_reason:null},b),(0,j.revalidatePath)(`/admin/dashboard/view-as/${f}/work/payments`),{paymentRetried:!0}})}async function s(a,b){return f({permission:"edit_payments",action:"mark_payment_completed",resourceType:"payment",resourceId:a,reason:`Marked as completed: ${b}`},async(d,e)=>{let f=await (0,c.getImpersonatedCompanyId)();if(!f)throw Error("Not in view-as mode");if(!await i("payments",a,f))throw Error("Payment does not belong to this company");let k=await g("payments",a,"id, status");if(!k)throw Error("Payment not found");if("completed"===k.status)throw Error("Payment is already completed");let{error:l}=await d.from("payments").update({status:"completed",updated_at:new Date().toISOString()}).eq("id",a);if(l)throw Error(`Failed to mark payment as completed: ${l.message}`);return await h("mark_payment_completed","payment",a,k,{status:"completed"},b),(0,j.revalidatePath)(`/admin/dashboard/view-as/${f}/work/payments`),{paymentCompleted:!0}})}async function t(a,b,d){return f({permission:"edit_payments",action:"update_payment_method",resourceType:"payment",resourceId:a,reason:d||`Changed payment method to ${b}`},async(e,f)=>{let k=await (0,c.getImpersonatedCompanyId)();if(!k)throw Error("Not in view-as mode");if(!await i("payments",a,k))throw Error("Payment does not belong to this company");let l=await g("payments",a,"id, payment_method"),{error:m}=await e.from("payments").update({payment_method:b,updated_at:new Date().toISOString()}).eq("id",a);if(m)throw Error(`Failed to update payment method: ${m.message}`);return await h("update_payment_method","payment",a,l,{payment_method:b},d),(0,j.revalidatePath)(`/admin/dashboard/view-as/${k}/work/payments`),{paymentMethodUpdated:!0}})}(0,k.ensureServerEntryExports)([l,m,n,o,p]),(0,b.registerServerReference)(l,"706573facb6d3d9a5a4a93be96af7cc10b01674f7a",null),(0,b.registerServerReference)(m,"70313e32929dd54f4bde93f6cb838669ddedcb3d82",null),(0,b.registerServerReference)(n,"7859a9646c7f3be7bb4a92a9b4fc161b1bae9e5a62",null),(0,b.registerServerReference)(o,"706afc929bd09ee621a65e81531d18139b0609d20a",null),(0,b.registerServerReference)(p,"70dc1ca351b7a32ead1c62c3aa87ad77522378e420",null),a.s(["addJobNote",()=>p,"reassignJob",()=>m,"updateJobPriority",()=>o,"updateJobSchedule",()=>n,"updateJobStatus",()=>l],52438),(0,k.ensureServerEntryExports)([q,r,s,t]),(0,b.registerServerReference)(q,"70c2eb54b6f410fd5d20e2279b1e767acc56fac674",null),(0,b.registerServerReference)(r,"6059eaec1ac21cd6f9ad2890cf40676973fb78379e",null),(0,b.registerServerReference)(s,"60959e02af572f9739a1ce45753bb7014819d85695",null),(0,b.registerServerReference)(t,"70d999140c54489f8ab5f8dfe3697dd25e899809bb",null),a.s(["issuePaymentRefund",()=>q,"markPaymentCompleted",()=>s,"retryFailedPayment",()=>r,"updatePaymentMethod",()=>t],14895);var u=a.i(93097);async function v(a,b){return f({permission:"reset_password",action:"reset_team_member_password",resourceType:"team_member",resourceId:a,reason:`Password reset requested: ${b}`},async(d,e)=>{let f=await (0,c.getImpersonatedCompanyId)();if(!f)throw Error("Not in view-as mode");if(!await i("team_members",a,f))throw Error("Team member does not belong to this company");let{data:g,error:j}=await d.from("team_members").select(`
          id,
          email,
          user_id,
          users!team_members_user_id_users_id_fk (
            email
          )
        `).eq("id",a).single();if(j||!g)throw Error("Team member not found");let k=Array.isArray(g.users)?g.users[0]:g.users,l=k?.email||g.email;if(!l)throw Error("No email found for team member");let m=(0,u.createAdminClient)(),{error:n}=await m.auth.resetPasswordForEmail(l,{redirectTo:`${process.env.NEXT_PUBLIC_WEB_URL}/reset-password`});if(n)throw Error(`Failed to send password reset: ${n.message}`);return await h("reset_team_member_password","team_member",a,{email:l},{password_reset_sent:!0},b),{passwordResetSent:!0,email:l}})}async function w(a,b,d){return f({permission:"edit_team",action:"change_team_member_role",resourceType:"team_member",resourceId:a,reason:d||`Changed role to ${b}`},async(e,f)=>{let k=await (0,c.getImpersonatedCompanyId)();if(!k)throw Error("Not in view-as mode");if(!await i("team_members",a,k))throw Error("Team member does not belong to this company");let l=await g("team_members",a,"id, role"),{error:m}=await e.from("team_members").update({role:b,updated_at:new Date().toISOString()}).eq("id",a);if(m)throw Error(`Failed to change role: ${m.message}`);return await h("change_team_member_role","team_member",a,l,{role:b},d),(0,j.revalidatePath)(`/admin/dashboard/view-as/${k}/work/team`),{roleChanged:!0}})}async function x(a,b,d){return f({permission:"edit_team",action:"update_team_member_status",resourceType:"team_member",resourceId:a,reason:d||`Changed status to ${b}`},async(e,f)=>{let k=await (0,c.getImpersonatedCompanyId)();if(!k)throw Error("Not in view-as mode");if(!await i("team_members",a,k))throw Error("Team member does not belong to this company");let l=await g("team_members",a,"id, status"),{error:m}=await e.from("team_members").update({status:b,updated_at:new Date().toISOString()}).eq("id",a);if(m)throw Error(`Failed to update status: ${m.message}`);return await h("update_team_member_status","team_member",a,l,{status:b},d),(0,j.revalidatePath)(`/admin/dashboard/view-as/${k}/work/team`),{statusUpdated:!0}})}async function y(a,b,d){return f({permission:"edit_team",action:"update_team_member_email",resourceType:"team_member",resourceId:a,reason:`Updated email to ${b}: ${d}`},async(e,f)=>{let k=await (0,c.getImpersonatedCompanyId)();if(!k)throw Error("Not in view-as mode");if(!await i("team_members",a,k))throw Error("Team member does not belong to this company");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(b))throw Error("Invalid email format");let l=await g("team_members",a,"id, email, user_id"),{error:m}=await e.from("team_members").update({email:b,updated_at:new Date().toISOString()}).eq("id",a);if(m)throw Error(`Failed to update team member email: ${m.message}`);if(l?.user_id){let a=(0,u.createAdminClient)(),{error:c}=await a.auth.admin.updateUserById(l.user_id,{email:b});c&&console.warn("Failed to update user email:",c)}return await h("update_team_member_email","team_member",a,l,{email:b},d),(0,j.revalidatePath)(`/admin/dashboard/view-as/${k}/work/team`),{emailUpdated:!0}})}async function z(a,b,d){return f({permission:"edit_invoices",action:"update_invoice_status",resourceType:"invoice",resourceId:a,reason:d||`Changed status to ${b}`},async(e,f)=>{let k=await (0,c.getImpersonatedCompanyId)();if(!k)throw Error("Not in view-as mode");if(!await i("invoices",a,k))throw Error("Invoice does not belong to this company");let l=await g("invoices",a,"id, status"),{error:m}=await e.from("invoices").update({status:b,updated_at:new Date().toISOString()}).eq("id",a);if(m)throw Error(`Failed to update invoice status: ${m.message}`);return await h("update_invoice_status","invoice",a,l,{status:b},d),(0,j.revalidatePath)(`/admin/dashboard/view-as/${k}/work/invoices`),{statusUpdated:!0}})}async function A(a,b){return f({permission:"edit_invoices",action:"void_invoice",resourceType:"invoice",resourceId:a,reason:`Voided invoice: ${b}`},async(d,e)=>{let f=await (0,c.getImpersonatedCompanyId)();if(!f)throw Error("Not in view-as mode");if(!await i("invoices",a,f))throw Error("Invoice does not belong to this company");let k=await g("invoices",a,"id, status, total_amount");if(!k)throw Error("Invoice not found");if("paid"===k.status)throw Error("Cannot void a paid invoice. Issue a refund instead.");let{error:l}=await d.from("invoices").update({status:"cancelled",updated_at:new Date().toISOString()}).eq("id",a);if(l)throw Error(`Failed to void invoice: ${l.message}`);return await h("void_invoice","invoice",a,k,{status:"cancelled",voided:!0},b),(0,j.revalidatePath)(`/admin/dashboard/view-as/${f}/work/invoices`),{invoiceVoided:!0}})}async function B(a,b,d){return f({permission:"edit_invoices",action:"update_invoice_due_date",resourceType:"invoice",resourceId:a,reason:d||`Changed due date to ${b}`},async(e,f)=>{let k=await (0,c.getImpersonatedCompanyId)();if(!k)throw Error("Not in view-as mode");if(!await i("invoices",a,k))throw Error("Invoice does not belong to this company");let l=await g("invoices",a,"id, due_date"),{error:m}=await e.from("invoices").update({due_date:b,updated_at:new Date().toISOString()}).eq("id",a);if(m)throw Error(`Failed to update due date: ${m.message}`);return await h("update_invoice_due_date","invoice",a,l,{due_date:b},d),(0,j.revalidatePath)(`/admin/dashboard/view-as/${k}/work/invoices`),{dueDateUpdated:!0}})}async function C(a,b){return f({permission:"edit_invoices",action:"send_invoice_reminder",resourceType:"invoice",resourceId:a,reason:b||"Sent invoice reminder"},async(d,e)=>{let f=await (0,c.getImpersonatedCompanyId)();if(!f)throw Error("Not in view-as mode");if(!await i("invoices",a,f))throw Error("Invoice does not belong to this company");let{data:g,error:j}=await d.from("invoices").select(`
          id,
          invoice_number,
          status,
          customers!invoices_customer_id_customers_id_fk (
            email,
            display_name
          )
        `).eq("id",a).single();if(j||!g)throw Error("Invoice not found");let k=Array.isArray(g.customers)?g.customers[0]:g.customers;return await h("send_invoice_reminder","invoice",a,{invoice_number:g.invoice_number},{reminder_sent:!0,sent_to:k?.email},b),{reminderSent:!0,sentTo:k?.email}})}(0,k.ensureServerEntryExports)([v,w,x,y]),(0,b.registerServerReference)(v,"6070fa5e4296da2e6896faa0d57b8567d73f11b681",null),(0,b.registerServerReference)(w,"7049d1469c6c66326eefce4aedcbe0769adb1ca483",null),(0,b.registerServerReference)(x,"70d63ce953cb58bab09fc6decf1d72432a48a5c3fd",null),(0,b.registerServerReference)(y,"70b33b4db5177009fd2aca47e81922dd597dfd73d5",null),a.s(["changeTeamMemberRole",()=>w,"resetTeamMemberPassword",()=>v,"updateTeamMemberEmail",()=>y,"updateTeamMemberStatus",()=>x],80676),(0,k.ensureServerEntryExports)([z,A,B,C]),(0,b.registerServerReference)(z,"70011e89a27332af3f21c9840737547e1e76af090f",null),(0,b.registerServerReference)(A,"60f689bdbae4c8c4c0214b03bcda312112badb96b4",null),(0,b.registerServerReference)(B,"708c498faeda8813bc53e1f8bc67509ce1929478c7",null),(0,b.registerServerReference)(C,"60d22fd78c43e37b9bb0eedee7ecf798e5b8b1b5d3",null),a.s(["sendInvoiceReminder",()=>C,"updateInvoiceDueDate",()=>B,"updateInvoiceStatus",()=>z,"voidInvoice",()=>A],75409)}];

//# sourceMappingURL=apps_admin_src_actions_admin-jobs_ts_32c85886._.js.map