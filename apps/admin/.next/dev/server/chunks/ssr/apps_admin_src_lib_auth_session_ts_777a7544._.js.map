{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/admin/src/lib/auth/session.ts"],"sourcesContent":["import { SignJWT, jwtVerify } from \"jose\";\nimport { cookies } from \"next/headers\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n/**\n * Admin Session Management\n *\n * Uses JWT tokens stored in HTTP-only cookies for authentication.\n * Sessions are also tracked in the database for revocation support.\n */\n\nconst SESSION_COOKIE_NAME = \"admin_session\";\nconst SESSION_DURATION_DAYS = 7;\n\ninterface SessionPayload {\n\tuserId: string;\n\temail: string;\n\trole: string;\n\tsessionId: string;\n\tiat: number;\n\texp: number;\n}\n\n/**\n * Get the JWT secret from environment\n */\nfunction getJwtSecret(): Uint8Array {\n\tconst secret = process.env.ADMIN_JWT_SECRET;\n\tif (!secret) {\n\t\tthrow new Error(\"Missing ADMIN_JWT_SECRET environment variable\");\n\t}\n\treturn new TextEncoder().encode(secret);\n}\n\n/**\n * Create a new session for an admin user\n */\nexport async function createSession(\n\tuserId: string,\n\temail: string,\n\trole: string,\n\tipAddress?: string,\n\tuserAgent?: string\n): Promise<string> {\n\tconst supabase = await createClient();\n\n\t// Calculate expiration\n\tconst expiresAt = new Date();\n\texpiresAt.setDate(expiresAt.getDate() + SESSION_DURATION_DAYS);\n\n\t// Generate session ID\n\tconst sessionId = crypto.randomUUID();\n\n\t// Create JWT token\n\tconst token = await new SignJWT({\n\t\tuserId,\n\t\temail,\n\t\trole,\n\t\tsessionId,\n\t})\n\t\t.setProtectedHeader({ alg: \"HS256\" })\n\t\t.setIssuedAt()\n\t\t.setExpirationTime(expiresAt)\n\t\t.sign(getJwtSecret());\n\n\t// Hash the token for storage\n\tconst tokenHash = await hashToken(token);\n\n\t// Store session in database\n\tconst { error } = await supabase.from(\"admin_sessions\").insert({\n\t\tid: sessionId,\n\t\tadmin_user_id: userId,\n\t\ttoken_hash: tokenHash,\n\t\tip_address: ipAddress,\n\t\tuser_agent: userAgent,\n\t\texpires_at: expiresAt.toISOString(),\n\t});\n\n\tif (error) {\n\t\tthrow new Error(`Failed to create session: ${error.message}`);\n\t}\n\n\t// Set cookie\n\tconst cookieStore = await cookies();\n\tcookieStore.set(SESSION_COOKIE_NAME, token, {\n\t\thttpOnly: true,\n\t\tsecure: process.env.NODE_ENV === \"production\",\n\t\tsameSite: \"lax\",\n\t\tpath: \"/\",\n\t\texpires: expiresAt,\n\t});\n\n\treturn token;\n}\n\n/**\n * Verify a session token and return the payload\n */\nexport async function verifySessionToken(token: string): Promise<SessionPayload | null> {\n\ttry {\n\t\tconst { payload } = await jwtVerify(token, getJwtSecret());\n\n\t\t// Check if session exists and is not revoked\n\t\tconst supabase = await createClient();\n\t\tconst { data: session, error } = await supabase\n\t\t\t.from(\"admin_sessions\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"id\", payload.sessionId)\n\t\t\t.is(\"revoked_at\", null)\n\t\t\t.single();\n\n\t\tif (error || !session) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Check expiration\n\t\tif (new Date(session.expires_at) < new Date()) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn payload as SessionPayload;\n\t} catch {\n\t\treturn null;\n\t}\n}\n\n/**\n * Get the current session from cookies\n */\nexport async function getSession(): Promise<SessionPayload | null> {\n\tconst cookieStore = await cookies();\n\tconst token = cookieStore.get(SESSION_COOKIE_NAME)?.value;\n\n\tif (!token) {\n\t\treturn null;\n\t}\n\n\treturn verifySessionToken(token);\n}\n\n/**\n * Destroy the current session\n */\nexport async function destroySession(): Promise<void> {\n\tconst session = await getSession();\n\n\tif (session) {\n\t\t// Revoke session in database\n\t\tconst supabase = await createClient();\n\t\tawait supabase\n\t\t\t.from(\"admin_sessions\")\n\t\t\t.update({ revoked_at: new Date().toISOString() })\n\t\t\t.eq(\"id\", session.sessionId);\n\t}\n\n\t// Clear cookie\n\tconst cookieStore = await cookies();\n\tcookieStore.delete(SESSION_COOKIE_NAME);\n}\n\n/**\n * Revoke all sessions for a user (e.g., on password change)\n */\nexport async function revokeAllUserSessions(userId: string): Promise<void> {\n\tconst supabase = await createClient();\n\n\tawait supabase\n\t\t.from(\"admin_sessions\")\n\t\t.update({ revoked_at: new Date().toISOString() })\n\t\t.eq(\"admin_user_id\", userId)\n\t\t.is(\"revoked_at\", null);\n}\n\n/**\n * Hash a token for storage\n */\nasync function hashToken(token: string): Promise<string> {\n\tconst encoder = new TextEncoder();\n\tconst data = encoder.encode(token);\n\tconst hashBuffer = await crypto.subtle.digest(\"SHA-256\", data);\n\tconst hashArray = Array.from(new Uint8Array(hashBuffer));\n\treturn hashArray.map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n}\n\n/**\n * Clean up expired sessions (run periodically)\n */\nexport async function cleanupExpiredSessions(): Promise<number> {\n\tconst supabase = await createClient();\n\n\tconst { data, error } = await supabase\n\t\t.from(\"admin_sessions\")\n\t\t.delete()\n\t\t.lt(\"expires_at\", new Date().toISOString())\n\t\t.select(\"id\");\n\n\tif (error) {\n\t\tthrow new Error(`Failed to cleanup sessions: ${error.message}`);\n\t}\n\n\treturn data?.length || 0;\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}