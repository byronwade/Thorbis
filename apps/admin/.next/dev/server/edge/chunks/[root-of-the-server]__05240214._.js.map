{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/apps/admin/src/middleware.ts"],"sourcesContent":["import { NextResponse, type NextRequest } from \"next/server\";\nimport { jwtVerify } from \"jose\";\n\n/**\n * Security Headers for Admin Dashboard\n */\nconst SECURITY_HEADERS = {\n\t\"X-Frame-Options\": \"DENY\",\n\t\"X-Content-Type-Options\": \"nosniff\",\n\t\"X-XSS-Protection\": \"1; mode=block\",\n\t\"Referrer-Policy\": \"strict-origin-when-cross-origin\",\n\t\"Permissions-Policy\": \"camera=(), microphone=(), geolocation=(), payment=()\",\n\t\"Content-Security-Policy\": [\n\t\t\"default-src 'self'\",\n\t\t\"script-src 'self' 'unsafe-inline' 'unsafe-eval'\",\n\t\t\"style-src 'self' 'unsafe-inline'\",\n\t\t\"img-src 'self' data: https: blob:\",\n\t\t\"font-src 'self' data:\",\n\t\t\"connect-src 'self' https://*.supabase.co wss://*.supabase.co\",\n\t\t\"frame-ancestors 'none'\",\n\t\t\"base-uri 'self'\",\n\t\t\"form-action 'self'\",\n\t].join(\"; \"),\n};\n\nconst SESSION_COOKIE_NAME = \"admin_session\";\n\n/**\n * Verify JWT token from cookie\n */\nasync function verifyToken(token: string): Promise<boolean> {\n\ttry {\n\t\tconst secret = process.env.ADMIN_JWT_SECRET;\n\t\tif (!secret) {\n\t\t\tconsole.error(\"Missing ADMIN_JWT_SECRET\");\n\t\t\treturn false;\n\t\t}\n\n\t\tconst secretKey = new TextEncoder().encode(secret);\n\t\tconst { payload } = await jwtVerify(token, secretKey);\n\n\t\t// Check if token is expired\n\t\tif (payload.exp && payload.exp * 1000 < Date.now()) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t} catch (error) {\n\t\tconsole.error(\"Token verification failed:\", error);\n\t\treturn false;\n\t}\n}\n\nexport async function middleware(request: NextRequest) {\n\tconst response = NextResponse.next();\n\n\t// Get session cookie\n\tconst sessionToken = request.cookies.get(SESSION_COOKIE_NAME)?.value;\n\n\tconst isLoginPage = request.nextUrl.pathname === \"/login\";\n\tconst isProtectedRoute = request.nextUrl.pathname.startsWith(\"/dashboard\");\n\tconst isApiRoute = request.nextUrl.pathname.startsWith(\"/api\");\n\n\t// Skip auth check for API routes (they handle their own auth)\n\tif (isApiRoute) {\n\t\treturn applySecurityHeaders(response);\n\t}\n\n\t// Verify session for protected routes\n\tif (isProtectedRoute) {\n\t\tif (!sessionToken) {\n\t\t\t// No session - redirect to login\n\t\t\tconst url = request.nextUrl.clone();\n\t\t\turl.pathname = \"/login\";\n\t\t\treturn NextResponse.redirect(url);\n\t\t}\n\n\t\tconst isValidSession = await verifyToken(sessionToken);\n\n\t\tif (!isValidSession) {\n\t\t\t// Invalid session - clear cookie and redirect to login\n\t\t\tconst url = request.nextUrl.clone();\n\t\t\turl.pathname = \"/login\";\n\t\t\tconst redirectResponse = NextResponse.redirect(url);\n\t\t\tredirectResponse.cookies.delete(SESSION_COOKIE_NAME);\n\t\t\treturn redirectResponse;\n\t\t}\n\t}\n\n\t// If authenticated user tries to access login page, redirect to dashboard\n\tif (isLoginPage && sessionToken) {\n\t\tconst isValidSession = await verifyToken(sessionToken);\n\n\t\tif (isValidSession) {\n\t\t\tconst url = request.nextUrl.clone();\n\t\t\turl.pathname = \"/dashboard\";\n\t\t\treturn NextResponse.redirect(url);\n\t\t}\n\t}\n\n\treturn applySecurityHeaders(response);\n}\n\n/**\n * Apply security headers to response\n */\nfunction applySecurityHeaders(response: NextResponse): NextResponse {\n\tObject.entries(SECURITY_HEADERS).forEach(([key, value]) => {\n\t\tresponse.headers.set(key, value);\n\t});\n\treturn response;\n}\n\nexport const config = {\n\tmatcher: [\"/dashboard/:path*\", \"/login\", \"/api/:path*\"],\n};\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;;;AAEA;;CAEC,GACD,MAAM,mBAAmB;IACxB,mBAAmB;IACnB,0BAA0B;IAC1B,oBAAoB;IACpB,mBAAmB;IACnB,sBAAsB;IACtB,2BAA2B;QAC1B;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACA,CAAC,IAAI,CAAC;AACR;AAEA,MAAM,sBAAsB;AAE5B;;CAEC,GACD,eAAe,YAAY,KAAa;IACvC,IAAI;QACH,MAAM,SAAS,QAAQ,GAAG,CAAC,gBAAgB;QAC3C,IAAI,CAAC,QAAQ;YACZ,QAAQ,KAAK,CAAC;YACd,OAAO;QACR;QAEA,MAAM,YAAY,IAAI,cAAc,MAAM,CAAC;QAC3C,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,6NAAS,EAAC,OAAO;QAE3C,4BAA4B;QAC5B,IAAI,QAAQ,GAAG,IAAI,QAAQ,GAAG,GAAG,OAAO,KAAK,GAAG,IAAI;YACnD,OAAO;QACR;QAEA,OAAO;IACR,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO;IACR;AACD;AAEO,eAAe,WAAW,OAAoB;IACpD,MAAM,WAAW,uWAAY,CAAC,IAAI;IAElC,qBAAqB;IACrB,MAAM,eAAe,QAAQ,OAAO,CAAC,GAAG,CAAC,sBAAsB;IAE/D,MAAM,cAAc,QAAQ,OAAO,CAAC,QAAQ,KAAK;IACjD,MAAM,mBAAmB,QAAQ,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC;IAC7D,MAAM,aAAa,QAAQ,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC;IAEvD,8DAA8D;IAC9D,IAAI,YAAY;QACf,OAAO,qBAAqB;IAC7B;IAEA,sCAAsC;IACtC,IAAI,kBAAkB;QACrB,IAAI,CAAC,cAAc;YAClB,iCAAiC;YACjC,MAAM,MAAM,QAAQ,OAAO,CAAC,KAAK;YACjC,IAAI,QAAQ,GAAG;YACf,OAAO,uWAAY,CAAC,QAAQ,CAAC;QAC9B;QAEA,MAAM,iBAAiB,MAAM,YAAY;QAEzC,IAAI,CAAC,gBAAgB;YACpB,uDAAuD;YACvD,MAAM,MAAM,QAAQ,OAAO,CAAC,KAAK;YACjC,IAAI,QAAQ,GAAG;YACf,MAAM,mBAAmB,uWAAY,CAAC,QAAQ,CAAC;YAC/C,iBAAiB,OAAO,CAAC,MAAM,CAAC;YAChC,OAAO;QACR;IACD;IAEA,0EAA0E;IAC1E,IAAI,eAAe,cAAc;QAChC,MAAM,iBAAiB,MAAM,YAAY;QAEzC,IAAI,gBAAgB;YACnB,MAAM,MAAM,QAAQ,OAAO,CAAC,KAAK;YACjC,IAAI,QAAQ,GAAG;YACf,OAAO,uWAAY,CAAC,QAAQ,CAAC;QAC9B;IACD;IAEA,OAAO,qBAAqB;AAC7B;AAEA;;CAEC,GACD,SAAS,qBAAqB,QAAsB;IACnD,OAAO,OAAO,CAAC,kBAAkB,OAAO,CAAC,CAAC,CAAC,KAAK,MAAM;QACrD,SAAS,OAAO,CAAC,GAAG,CAAC,KAAK;IAC3B;IACA,OAAO;AACR;AAEO,MAAM,SAAS;IACrB,SAAS;QAAC;QAAqB;QAAU;KAAc;AACxD"}}]
}