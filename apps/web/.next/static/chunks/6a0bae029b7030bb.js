(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,672573,e=>{"use strict";let t=(0,e.i(383206).default)("map-pin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);e.s(["default",()=>t])},15751,e=>{"use strict";var t=e.i(672573);e.s(["MapPin",()=>t.default])},52573,e=>{"use strict";let t=(0,e.i(383206).default)("link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]);e.s(["default",()=>t])},694288,e=>{"use strict";var t=e.i(52573);e.s(["Link",()=>t.default])},479515,e=>{"use strict";let t=(0,e.i(383206).default)("link-2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);e.s(["default",()=>t])},929294,e=>{"use strict";var t=e.i(479515);e.s(["Link2",()=>t.default])},920856,e=>{"use strict";var t=e.i(111043),i=e.i(970799),a=e.i(904653),r=e.i(552038),s=(0,r.createServerReference)("00a13dbd00149949fc1367d3e76ae7d789e07f5321",r.callServer,void 0,r.findSourceMapURL,"createServiceSupabaseClient");async function n(e,t,i){let a=await s(),{data:r}=await a.from("email_permissions").select("can_read, can_send, can_assign").eq("team_member_id",e).eq("email_category",t).maybeSingle();if(!r)return!1;switch(i){case"read":return r.can_read;case"send":return r.can_send;case"assign":return r.can_assign;default:return!1}}async function o(e,t){return n(e,"all",t)}let d=(0,i.cache)(async(e,t)=>{let i=await s(),{data:a}=await i.from("email_permissions").select("email_category, can_read, can_send, can_assign").eq("team_member_id",e);return a&&0!==a.length?a.filter(e=>{switch(t){case"read":return e.can_read;case"send":return e.can_send;case"assign":return e.can_assign;default:return!1}}).map(e=>e.email_category):[]});async function c(e,t){if(await o(e,"read")||t.mailboxOwnerId===e||t.assignedTo===e)return!0;let i=t.visibilityScope;return!i||"company"===i||"private"!==i&&("shared"===i?n(e,t.emailCategory||"support","read"):"team"===i?l(e,t.mailboxOwnerId):"department"===i&&m(e,t.mailboxOwnerId))}async function l(e,t){if(!t)return!1;let i=await s(),{data:a}=await i.from("team_members").select("id, role").in("id",[e,t]);if(!a||2!==a.length)return!1;let r=a.find(t=>t.id===e),n=a.find(e=>e.id===t);return r?.role===n?.role}async function m(e,t){if(!t)return!1;let i=await s(),{data:a}=await i.from("team_members").select("id, department").in("id",[e,t]);if(!a||2!==a.length)return!1;let r=a.find(t=>t.id===e),n=a.find(e=>e.id===t);return r?.department===n?.department}(0,i.cache)(async e=>{let t=await s(),{data:i}=await t.from("email_permissions").select("*").eq("team_member_id",e).order("email_category");return i?i.map(e=>({id:e.id,companyId:e.company_id,teamMemberId:e.team_member_id,emailCategory:e.email_category,canRead:e.can_read,canSend:e.can_send,canAssign:e.can_assign})):[]});let u=(0,i.cache)(async(e,t,i={})=>{let a=(await s()).from("communications").select(`
			*,
			customer:customers(id, first_name, last_name, email)
		`).eq("company_id",t);i.type&&(a=a.eq("type",i.type)),i.direction&&(a=a.eq("direction",i.direction)),i.status&&(a=a.eq("status",i.status)),i.customerId&&(a=a.eq("customer_id",i.customerId)),i.assignedTo&&(a=a.eq("assigned_to",i.assignedTo)),i.mailboxOwnerId&&(a=a.eq("mailbox_owner_id",i.mailboxOwnerId)),i.visibilityScope&&(a=a.eq("visibility_scope",i.visibilityScope)),i.searchQuery&&(a=a.or(`subject.ilike.%${i.searchQuery}%,body.ilike.%${i.searchQuery}%,from_address.ilike.%${i.searchQuery}%,to_address.ilike.%${i.searchQuery}%`));let r=i.limit||50,n=i.offset||0;a=a.order("created_at",{ascending:!1}).range(n,n+r-1);let{data:o,error:d}=await a;if(d)return console.error("[Communications Query] Error fetching communications:",d),[];if(!o||0===o.length)return[];let l=[];for(let t of o)await c(e,{mailboxOwnerId:t.mailbox_owner_id,assignedTo:t.assigned_to,visibilityScope:t.visibility_scope,emailCategory:t.category})&&l.push({id:t.id,companyId:t.company_id,type:t.type,direction:t.direction,status:t.status,fromAddress:t.from_address||void 0,toAddress:t.to_address||void 0,subject:t.subject||void 0,body:t.body||void 0,customerId:t.customer_id||void 0,mailboxOwnerId:t.mailbox_owner_id,assignedTo:t.assigned_to,visibilityScope:t.visibility_scope,emailCategory:t.category,createdAt:t.created_at,customer:t.customer?{id:t.customer.id,firstName:t.customer.first_name||void 0,lastName:t.customer.last_name||void 0,email:t.customer.email||void 0}:void 0});return l});async function _(e,t,i,a=50){return u(e,t,{category:i,type:"email",limit:a})}(0,i.cache)(async(e,t)=>{let i=await s(),{data:a,error:r}=await i.from("communications").select(`
			*,
			customer:customers(id, first_name, last_name, email)
		`).eq("id",e).single();return!r&&a&&await c(t,{mailboxOwnerId:a.mailbox_owner_id,assignedTo:a.assigned_to,visibilityScope:a.visibility_scope,emailCategory:a.category})?{id:a.id,companyId:a.company_id,type:a.type,direction:a.direction,status:a.status,fromAddress:a.from_address||void 0,toAddress:a.to_address||void 0,subject:a.subject||void 0,body:a.body||void 0,customerId:a.customer_id||void 0,mailboxOwnerId:a.mailbox_owner_id,assignedTo:a.assigned_to,visibilityScope:a.visibility_scope,emailCategory:a.category,createdAt:a.created_at,customer:a.customer?{id:a.customer.id,firstName:a.customer.first_name||void 0,lastName:a.customer.last_name||void 0,email:a.customer.email||void 0}:void 0}:null}),(0,i.cache)(async(e,t)=>{let i=await d(e,"read"),a={};for(let r of i){let i=await _(e,t,r,1e3);a[r]=i.length}return a}),(0,i.cache)(async(e,t,i,a,r=50,n=0)=>{let o=await s(),{data:d,error:c}=await o.rpc("get_communications_filtered",{p_company_id:e,p_channel:t||null,p_type:i||null,p_direction:a||null,p_limit:r,p_offset:n});if(c)return console.error("Error fetching communications via RPC:",c),{data:[],totalCount:0};let l=d?.[0]?.total_count||0;return{data:(d||[]).map(e=>({id:e.id,companyId:e.company_id,type:e.type,direction:e.direction,status:e.status,fromAddress:e.from_address||void 0,toAddress:e.to_address||void 0,subject:e.subject||void 0,body:e.body||void 0,customerId:e.customer_id||void 0,jobId:e.job_id||void 0,propertyId:e.property_id||void 0,mailboxOwnerId:e.mailbox_owner_id,assignedTo:e.assigned_to,visibilityScope:e.visibility_scope,emailCategory:e.category,createdAt:e.created_at,customer:e.customer_name?{id:e.customer_id,firstName:void 0,lastName:void 0,email:void 0}:void 0})),totalCount:l}});let y=(0,i.cache)(async(e,t={})=>{let i=(await s()).from("communications").select(`
			*,
			customer:customers(id, first_name, last_name, email)
		`).eq("company_id",e).is("deleted_at",null);t.type&&(i=i.eq("type",t.type)),t.direction&&(i=i.eq("direction",t.direction)),t.status&&(i=i.eq("status",t.status)),t.customerId&&(i=i.eq("customer_id",t.customerId)),t.assignedTo&&(i=i.eq("assigned_to",t.assignedTo)),t.mailboxOwnerId&&(i=i.eq("mailbox_owner_id",t.mailboxOwnerId)),t.searchQuery&&(i=i.or(`subject.ilike.%${t.searchQuery}%,body.ilike.%${t.searchQuery}%,from_address.ilike.%${t.searchQuery}%,to_address.ilike.%${t.searchQuery}%`));let a=t.limit||100,r=t.offset||0;i=i.order("created_at",{ascending:!1}).range(r,r+a-1);let{data:n,error:o}=await i;return o?(console.error("[Communications Query] Error fetching company communications:",o),[]):n&&0!==n.length?n.map(e=>({id:e.id,companyId:e.company_id,type:e.type,direction:e.direction,status:e.status,fromAddress:e.from_address||void 0,toAddress:e.to_address||void 0,subject:e.subject||void 0,body:e.body||void 0,customerId:e.customer_id||void 0,jobId:e.job_id||void 0,propertyId:e.property_id||void 0,mailboxOwnerId:e.mailbox_owner_id,assignedTo:e.assigned_to,visibilityScope:e.visibility_scope,emailCategory:e.category,autoLinked:e.auto_linked||void 0,linkConfidence:e.link_confidence||void 0,linkMethod:e.link_method||void 0,internalNotes:e.internal_notes||void 0,internalNotesUpdatedAt:e.internal_notes_updated_at||void 0,internalNotesUpdatedBy:e.internal_notes_updated_by||void 0,createdAt:e.created_at,customer:e.customer?{id:e.customer.id,firstName:e.customer.first_name||void 0,lastName:e.customer.last_name||void 0,email:e.customer.email||void 0}:void 0})):[]});e.i(313550),e.i(499839);var p=e.i(41981);let f=(0,i.cache)(async()=>{let t,{cookies:i,headers:a}=await e.A(706534);try{if((await a()).get("x-prerender"))return null}catch{return null}try{t=await i()}catch(e){if(e instanceof Error&&(e.message.includes("During prerendering")||e.message.includes("prerendering")||e.message.includes("cookies()")))return null;throw e}return(0,p.createServerClient)("https://togejqdwggezkxahomeh.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvZ2VqcWR3Z2dlemt4YWhvbWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3MjAyOTUsImV4cCI6MjA3NzI5NjI5NX0.a74QOxiIcxeALZsTsNXNDiOls1MZDsFfyGFq992eBBM",{cookies:{get:e=>t.get(e)?.value,set(e,i,a){try{t.set(e,i,a)}catch{}},remove(e,i){try{t.delete(e)}catch{}}}})}),g=(0,i.cache)(async()=>{try{let e=await f();if(!e)return null;let{data:{user:t},error:i}=await e.auth.getUser();if(i)return i.name,null;return t}catch(e){return e&&"object"==typeof e&&"name"in e&&e.name,null}});(0,i.cache)(async()=>{try{let e=await f();if(!e)return null;let{data:{session:t},error:i}=await e.auth.getSession();if(i)return null;return t}catch(e){return null}});let b=(0,i.cache)(async()=>{let t,{cookies:i}=await e.A(706534);try{t=await i()}catch(e){if(e instanceof Error&&(e.message.includes("During prerendering")||e.message.includes("prerendering")||e.message.includes("cookies()")))return null;throw e}let a=t.get("active_company_id")?.value;if(a&&await h(a))return a;let r=await v();return r[0]?.id||null});(0,i.cache)(async()=>{let e=await b();if(!e)return null;let t=await f();if(!t)return null;let{data:i}=await t.from("companies").select("id, name, logo, phone, email").eq("id",e).is("deleted_at",null).single();return i});let v=(0,i.cache)(async()=>{let e=await g();if(!e)return[];let t=await s();if(!t)return[];let{data:i}=await t.from("company_memberships").select(`
      company_id,
      companies!inner (
        id,
        name,
        logo,
        deleted_at,
        onboarding_completed_at
      )
    `).eq("user_id",e.id).eq("status","active").is("companies.deleted_at",null);return i?i.sort((e,t)=>{let i=!!e.companies.onboarding_completed_at,a=!!t.companies.onboarding_completed_at;return i&&!a?-1:!i&&a?1:e.companies.name.localeCompare(t.companies.name)}).map(e=>({id:e.companies.id,name:e.companies.name,logo:e.companies.logo})):[]}),h=(0,i.cache)(async e=>{let t=await g();if(!t)return!1;let i=await f();if(!i)return!1;let[a,r]=await Promise.all([i.from("companies").select("id").eq("id",e).is("deleted_at",null).single(),i.from("company_memberships").select("id").eq("user_id",t.id).eq("company_id",e).eq("status","active").single()]);return!!(a.data&&r.data)});(0,i.cache)(async()=>{let e=await g();if(!e)return null;let t=await b();if(!t)return null;let i=await f();if(!i)return null;let{data:a}=await i.from("team_members").select("id").eq("user_id",e.id).eq("company_id",t).eq("status","active").single();return a?.id||null});var w=e.i(966757),I=e.i(641304);function x(){return(0,t.jsx)("div",{className:"flex h-full w-full items-center justify-center bg-sidebar",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)(I.Loader2,{className:"h-8 w-8 animate-spin text-primary mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loading communications..."})]})})}async function j({searchParams:e}){let i=await e,r=i?.id||null,s=await f();if(!s)return(0,a.notFound)();let{data:{user:n}}=await s.auth.getUser();n||(0,a.redirect)("/sign-in");let o=await b();o||(0,a.redirect)("/dashboard");let d=n.id,c=await y(o,{limit:100,type:i?.type});return(0,t.jsx)(w.UnifiedInboxPageClient,{initialCommunications:c,companyId:o,teamMemberId:d,selectedId:r})}async function q({searchParams:e}){return(0,t.jsx)("div",{className:"flex h-full w-full",children:(0,t.jsx)(i.Suspense,{fallback:(0,t.jsx)(x,{}),children:(0,t.jsx)(j,{searchParams:e})})})}e.s(["default",()=>q],920856)},760970,e=>{e.n(e.i(920856))},706534,e=>{e.v(t=>Promise.all(["static/chunks/8b71975e15b3fcc4.js"].map(t=>e.l(t))).then(()=>t(14715)))},161886,e=>{e.v(t=>Promise.all(["static/chunks/30bf752a4ae14562.js"].map(t=>e.l(t))).then(()=>t(112867)))},312968,e=>{e.v(t=>Promise.all(["static/chunks/779b4a1a36912c92.js"].map(t=>e.l(t))).then(()=>t(426733)))}]);