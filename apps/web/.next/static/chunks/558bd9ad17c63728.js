(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,468849,e=>{"use strict";function t(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)0>t.indexOf(n[s])&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(i[n[s]]=e[n[s]])}return i}function i(e,t,i,n){return new(i||(i=Promise))(function(s,r){function o(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?s(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,a)}c((n=n.apply(e,t||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;for(var n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto),s=new Uint8Array(16),r=[],o=0;o<256;++o)r[o]=(o+256).toString(16).substr(1);function a(e,t,i){var o,a=t&&i||0;"string"==typeof e&&(t="binary"===e?Array(16):null,e=null);var c=(e=e||{}).random||(e.rng||function(){if(!n)throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(s)})();if(c[6]=15&c[6]|64,c[8]=63&c[8]|128,t)for(var d=0;d<16;++d)t[a+d]=c[d];return t||(o=0,""+r[c[o++]]+r[c[o++]]+r[c[o++]]+r[c[o++]]+"-"+r[c[o++]]+r[c[o++]]+"-"+r[c[o++]]+r[c[o++]]+"-"+r[c[o++]]+r[c[o++]]+"-"+r[c[o++]]+r[c[o++]]+r[c[o++]]+r[c[o++]]+r[c[o++]]+r[c[o++]])}let c="wss://rtc.telnyx.com",d={urls:"stun:stun.l.google.com:19302"},l={urls:"stun:stun.telnyx.com:3478"},u={urls:"turn:turn.telnyx.com:3478?transport=tcp",username:"testuser",credential:"testpassword"};(ex=ej||(ej={})).SocketOpen="telnyx.socket.open",ex.SocketClose="telnyx.socket.close",ex.SocketError="telnyx.socket.error",ex.SocketMessage="telnyx.socket.message",ex.SpeedTest="telnyx.internal.speedtest",ex.Ready="telnyx.ready",ex.Error="telnyx.error",ex.Notification="telnyx.notification",ex.StatsFrame="telnyx.stats.frame",ex.StatsReport="telnyx.stats.report",ex.Messages="telnyx.messages",ex.Calls="telnyx.calls",ex.MediaError="telnyx.rtc.mediaError",ex.PeerConnectionFailureError="telnyx.rtc.peerConnectionFailureError";var h="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:e.g;function p(e,t){return e(t={exports:{}},t.exports),t.exports}let g=p(function(e){var t;t=function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"];function s(e,t){var i=e[t];if("function"==typeof i.bind)return i.bind(e);try{return Function.prototype.bind.call(i,e)}catch(t){return function(){return Function.prototype.apply.apply(i,[e,arguments])}}}function r(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function o(t,i){for(var s=0;s<n.length;s++){var r=n[s];this[r]=s<t?e:this.methodFactory(r,t,i)}this.log=this.debug}function a(e,i,n){return function(){typeof console!==t&&(o.call(this,i,n),this[e].apply(this,arguments))}}function c(n,o,c){var d;return"debug"===(d=n)&&(d="log"),typeof console!==t&&("trace"===d&&i?r:void 0!==console[d]?s(console,d):void 0!==console.log?s(console,"log"):e)||a.apply(this,arguments)}function d(e,i,s){var r,a=this;i=null==i?"WARN":i;var d="loglevel";function l(){var e;if(typeof window!==t&&d){try{e=window.localStorage[d]}catch(e){}if(typeof e===t)try{var i=window.document.cookie,n=i.indexOf(encodeURIComponent(d)+"=");-1!==n&&(e=/^([^;]+)/.exec(i.slice(n))[1])}catch(e){}return void 0===a.levels[e]&&(e=void 0),e}}"string"==typeof e?d+=":"+e:"symbol"==typeof e&&(d=void 0),a.name=e,a.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},a.methodFactory=s||c,a.getLevel=function(){return r},a.setLevel=function(i,s){if("string"==typeof i&&void 0!==a.levels[i.toUpperCase()]&&(i=a.levels[i.toUpperCase()]),!("number"==typeof i&&i>=0&&i<=a.levels.SILENT))throw"log.setLevel() called with invalid level: "+i;if(r=i,!1!==s&&function(e){var i=(n[e]||"silent").toUpperCase();if(typeof window!==t&&d){try{return void(window.localStorage[d]=i)}catch(e){}try{window.document.cookie=encodeURIComponent(d)+"="+i+";"}catch(e){}}}(i),o.call(a,i,e),typeof console===t&&i<a.levels.SILENT)return"No console available for logging"},a.setDefaultLevel=function(e){i=e,l()||a.setLevel(e,!1)},a.resetLevel=function(){a.setLevel(i,!1),function(){if(typeof window!==t&&d){try{return void window.localStorage.removeItem(d)}catch(e){}try{window.document.cookie=encodeURIComponent(d)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}()},a.enableAll=function(e){a.setLevel(a.levels.TRACE,e)},a.disableAll=function(e){a.setLevel(a.levels.SILENT,e)};var u=l();null==u&&(u=i),a.setLevel(u,!1)}var l=new d,u={};l.getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw TypeError("You must supply a name when creating a logger.");var t=u[e];return t||(t=u[e]=new d(e,l.getLevel(),l.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return l.noConflict=function(){return typeof window!==t&&window.log===l&&(window.log=h),l},l.getLoggers=function(){return u},l.default=l,l},e.exports?e.exports=t():h.log=t()}).getLogger("telnyx"),f=g.methodFactory;g.methodFactory=(e,t,i)=>{let n=f(e,t,i);return function(){let e=[(new Date).toISOString().replace("T"," ").replace("Z",""),"-"];for(let t=0;t<arguments.length;t++)e.push(arguments[t]);n.apply(void 0,e)}},g.setLevel(g.getLevel());let m=e=>{let[t,i,n,s,r,o]=e,a={};try{a=JSON.parse(r.replace(/ID"/g,'Id"'))}catch(e){g.warn("Verto LA invalid media JSON string:",r)}return{participantId:Number(t),participantNumber:i,participantName:n,codec:s,media:a,participantData:o}},v=e=>{if("string"!=typeof e)return e;try{return JSON.parse(e)}catch(t){return e}},b=e=>e instanceof Function||"function"==typeof e,y=e=>"object"==typeof document&&"getElementById"in document?"string"==typeof e?document.getElementById(e)||null:"function"==typeof e?e():e instanceof HTMLMediaElement?e:null:null,_=/^(ws|wss):\/\//,w=(e,t=null)=>{let{result:i={},error:n}=e;if(n)return{error:n};let{result:s=null}=i;if(null===s)return null!==t&&(i.node_id=t),{result:i};let{code:r=null,node_id:o=null,result:a=null}=s;return r&&"200"!==r?{error:s}:a?w(a,o):{result:s}},S=(e,t)=>Math.floor(Math.random()*(t-e+1)+e),C=({login:e,passwd:t,password:i,login_token:n})=>!!(e&&(t||i)||n),I=({anonymous_login:e})=>!!e&&!!e.target_id&&!!e.target_type,k=e=>{var t,i,n,s,r,o;let a="",c="";return(null==(i=null==(t=null==e?void 0:e.result)?void 0:t.params)?void 0:i.state)&&(a=null==(s=null==(n=null==e?void 0:e.result)?void 0:n.params)?void 0:s.state),(null==(r=null==e?void 0:e.params)?void 0:r.state)&&(c=null==(o=null==e?void 0:e.params)?void 0:o.state),a||c};function E({debounceTime:e}){let t,i;return{promise:new Promise((n,s)=>{t=e?T(n,e):n,i=s}),resolve:t,reject:i}}let T=(e,t)=>{let i;return(...n)=>{clearTimeout(i),i=window.setTimeout(()=>{e(...n)},t)}},R="telnyx-voice-sdk-id";function x(){return sessionStorage.getItem(R)}"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{sessionStorage.removeItem(R)}),(eA=eF||(eF={})).Offer="offer",eA.Answer="answer",(eO=eG||(eG={})).Inbound="inbound",eO.Outbound="outbound",(eN=eV||(eV={})).Invite="telnyx_rtc.invite",eN.Attach="telnyx_rtc.attach",eN.Answer="telnyx_rtc.answer",eN.Info="telnyx_rtc.info",eN.Candidate="telnyx_rtc.candidate",eN.EndOfCandidates="telnyx_rtc.endOfCandidates",eN.Display="telnyx_rtc.display",eN.Media="telnyx_rtc.media",eN.Event="telnyx_rtc.event",eN.Bye="telnyx_rtc.bye",eN.Punt="telnyx_rtc.punt",eN.Broadcast="telnyx_rtc.broadcast",eN.Subscribe="telnyx_rtc.subscribe",eN.Unsubscribe="telnyx_rtc.unsubscribe",eN.ClientReady="telnyx_rtc.clientReady",eN.Modify="telnyx_rtc.modify",eN.Ringing="telnyx_rtc.ringing",eN.GatewayState="telnyx_rtc.gatewayState",eN.Ping="telnyx_rtc.ping",eN.Pong="telnyx_rtc.pong";let A={generic:"event",[eV.Display]:"participantData",[eV.Attach]:"participantData",conferenceUpdate:"conferenceUpdate",callUpdate:"callUpdate",vertoClientReady:"vertoClientReady",userMediaError:"userMediaError",peerConnectionFailureError:"peerConnectionFailureError"},O={destinationNumber:"",remoteCallerName:"Outbound Call",remoteCallerNumber:"",callerName:"",callerNumber:"",audio:!0,useStereo:!1,debug:!1,debugOutput:"socket",attach:!1,screenShare:!1,userVariables:{},mediaSettings:{useSdpASBandwidthKbps:!1,sdpASBandwidthKbps:0}};(eM=eB||(eB={}))[eM.New=0]="New",eM[eM.Requesting=1]="Requesting",eM[eM.Trying=2]="Trying",eM[eM.Recovering=3]="Recovering",eM[eM.Ringing=4]="Ringing",eM[eM.Answering=5]="Answering",eM[eM.Early=6]="Early",eM[eM.Active=7]="Active",eM[eM.Held=8]="Held",eM[eM.Hangup=9]="Hangup",eM[eM.Destroy=10]="Destroy",eM[eM.Purge=11]="Purge",(eP=eH||(eH={})).Participant="participant",eP.Moderator="moderator",(eL=eW||(eW={})).Join="join",eL.Leave="leave",eL.Bootstrap="bootstrap",eL.Add="add",eL.Modify="modify",eL.Delete="delete",eL.Clear="clear",eL.ChatMessage="chatMessage",eL.LayerInfo="layerInfo",eL.LogoInfo="logoInfo",eL.LayoutInfo="layoutInfo",eL.LayoutList="layoutList",eL.ModCmdResponse="modCommandResponse",(eD=eq||(eq={})).Video="videoinput",eD.AudioIn="audioinput",eD.AudioOut="audiooutput",(eU=eK||(eK={})).REGED="REGED",eU.UNREGED="UNREGED",eU.NOREG="NOREG",eU.FAILED="FAILED",eU.FAIL_WAIT="FAIL_WAIT",eU.REGISTER="REGISTER",eU.TRYING="TRYING",eU.EXPIRED="EXPIRED",eU.UNREGISTER="UNREGISTER";let N="GLOBAL",M={},P=(e,t)=>`${e}|${t}`,L=(e,t,i=N)=>{let n=P(e,i);n in M||(M[n]=[]),M[n].push(t)},D=(e,t,i=N)=>{let n=function(s){U(e,n,i),t(s)};return n.prototype.targetRef=t,L(e,n,i)},U=(e,t,i=N)=>{if(!((e,t=N)=>P(e,t)in M)(e,i))return!1;let n=P(e,i);if(b(t))for(let e=M[n].length-1;e>=0;e--){let i=M[n][e];(t===i||i.prototype&&t===i.prototype.targetRef)&&M[n].splice(e,1)}else M[n]=[];return 0===M[n].length&&delete M[n],!0},$=(e,t,i=N,n=!0)=>{let s=n&&i!==N;if(!((e,t=N)=>P(e,t)in M)(e,i))return s&&$(e,t),!1;let r=P(e,i),o=M[r].length;if(!o)return s&&$(e,t),!1;for(let e=o-1;e>=0;e--)M[r][e](t);return s&&$(e,t),!0},j=e=>{let t=P(e,"");Object.keys(M).filter(e=>0===e.indexOf(t)).forEach(e=>delete M[e])},F="undefined"!=typeof WebSocket?WebSocket:null;class G{constructor(e){this.session=e,this.previousGatewayState="",this._wsClient=null,this._host=c,this._timers={},this._hasTrickleIceCanaryBeenUsed=!1,this._trickleIceCanaryEnabled=!1,this.upDur=null,this.downDur=null;const{host:t,env:i,region:n,trickleIce:s}=e.options;i&&(this._host="development"===i?"wss://rtcdev.telnyx.com":c),t&&(this._host=(e=>`${_.test(e)?"":"wss://"}${e}`)(t)),n&&(this._host=this._host.replace(/rtc(dev)?/,`${n}.rtc$1`)),s&&(this._trickleIceCanaryEnabled=!0)}get connected(){return this._wsClient&&1===this._wsClient.readyState}get connecting(){return this._wsClient&&0===this._wsClient.readyState}get closing(){return this._wsClient&&2===this._wsClient.readyState}get closed(){return this._wsClient&&3===this._wsClient.readyState}get isAlive(){return this.connecting||this.connected}get isDead(){return this.closing||this.closed}connect(){let e=new URL(this._host),t=x();this.session.options.rtcIp&&this.session.options.rtcPort&&(t=null,this._trickleIceCanaryEnabled=!1,e.searchParams.set("rtc_ip",this.session.options.rtcIp),e.searchParams.set("rtc_port",this.session.options.rtcPort.toString())),t&&e.searchParams.set("voice_sdk_id",t),this._trickleIceCanaryEnabled&&(e.searchParams.set("canary","true"),t&&!this._hasTrickleIceCanaryBeenUsed&&(e.searchParams.delete("voice_sdk_id"),g.debug("first trickle ice canary connection. Refreshing voice_sdk_id")),this.session.options.trickleIce=!0,this._hasTrickleIceCanaryBeenUsed=!0),this._wsClient=new F(e.toString()),this._wsClient.onopen=e=>$(ej.SocketOpen,e,this.session.uuid),this._wsClient.onclose=e=>$(ej.SocketClose,e,this.session.uuid),this._wsClient.onerror=e=>$(ej.SocketError,{error:e,sessionId:this.session.sessionid},this.session.uuid),this._wsClient.onmessage=e=>{var t,i,n;let s=v(e.data);if("string"!=typeof s){if(s.voice_sdk_id&&(n=s.voice_sdk_id,sessionStorage.setItem(R,n)),this._unsetTimer(s.id),g.debug("RECV: \n",JSON.stringify(s,null,2),"\n"),eK[`${null==(i=null==(t=null==s?void 0:s.result)?void 0:t.params)?void 0:i.state}`]||!$(s.id,s)){let e=k(s);$(ej.SocketMessage,s,this.session.uuid),e&&(this.previousGatewayState=e)}}else this._handleStringResponse(s)}}sendRawText(e){this._wsClient.send(e)}send(e){let{request:t}=e,i=new Promise((e,i)=>{if(t.hasOwnProperty("result"))return e();D(t.id,t=>{let{result:n,error:s}=w(t);return s?i(s):e(n)})});return g.debug("SEND: \n",JSON.stringify(t,null,2),"\n"),this._wsClient.send(JSON.stringify(t)),i}close(){this._wsClient&&(b(this._wsClient._beginClose)?this._wsClient._beginClose():this._wsClient.close()),this._wsClient=null}_unsetTimer(e){clearTimeout(this._timers[e]),delete this._timers[e]}_handleStringResponse(e){if(/^#SP/.test(e))switch(e[3]){case"U":this.upDur=parseInt(e.substring(4));break;case"D":this.downDur=parseInt(e.substring(4)),$(ej.SpeedTest,{upDur:this.upDur,downDur:this.downDur},this.session.uuid)}else g.warn("Unknown message from socket",e)}}class V{buildRequest(e){this.request=Object.assign({jsonrpc:"2.0",id:a()},e)}}let B={id:"callID",destinationNumber:"destination_number",remoteCallerName:"remote_caller_id_name",remoteCallerNumber:"remote_caller_id_number",callerName:"caller_id_name",callerNumber:"caller_id_number",customHeaders:"custom_headers"};class H extends V{constructor(e={}){if(super(),e.hasOwnProperty("dialogParams")){const i=t(e.dialogParams,["remoteSdp","localStream","remoteStream","onNotification","camId","micId","speakerId"]);for(const e in B)e&&i.hasOwnProperty(e)&&(i[B[e]]=i[e],delete i[e]);e.dialogParams=i}this.buildRequest({method:this.toString(),params:e})}}class W extends H{constructor(e){super(),this.method=eV.GatewayState,this.buildRequest({method:this.method,voice_sdk_id:e,params:{}})}}class q{constructor(e){this.pendingRequestId=null,this.onSocketMessage=e=>i(this,void 0,void 0,function*(){e.id===this.pendingRequestId&&this.gatewayStateTask.resolve(k(e))}),this.getIsRegistered=()=>i(this,void 0,void 0,function*(){let e=new W(x());this.pendingRequestId=e.request.id,this.gatewayStateTask=E({}),this.session.execute(e);let t=yield this.gatewayStateTask.promise;return!!t&&[eK.REGISTER,eK.REGED].includes(t)}),this.session=e,this.gatewayStateTask=E({}),this.session.on("telnyx.socket.message",this.onSocketMessage)}}class K extends H{constructor(e){super(),this.method=eV.Ping,this.buildRequest({method:this.method,voice_sdk_id:e,params:{}})}}class J{constructor(e){if(this.options=e,this.uuid=a(),this.sessionid="",this.subscriptions={},this.signature=null,this.relayProtocol=null,this.contexts=[],this.timeoutErrorCode=-32e3,this.invalidMethodErrorCode=-32601,this.authenticationRequiredErrorCode=-32e3,this.connection=null,this._jwtAuth=!1,this._autoReconnect=!0,this._idle=!1,this._executeQueue=[],!this.validateOptions())throw Error("Invalid init options");this._onSocketOpen=this._onSocketOpen.bind(this),this.onNetworkClose=this.onNetworkClose.bind(this),this._onSocketMessage=this._onSocketMessage.bind(this),this._handleLoginError=this._handleLoginError.bind(this),this._attachListeners(),this.connection=new G(this),this.registerAgent=new q(this)}get __logger(){return g}get connected(){return this.connection&&this.connection.connected}getIsRegistered(){return i(this,void 0,void 0,function*(){return this.registerAgent.getIsRegistered()})}get reconnectDelay(){return 1e3*S(2,6)}execute(e){return this._idle?new Promise(t=>this._executeQueue.push({resolve:t,msg:e})):this.connected?this.connection.send(e):new Promise(t=>{this._executeQueue.push({resolve:t,msg:e}),this.connect()})}executeRaw(e){this._idle?this._executeQueue.push({msg:e}):this.connection.sendRawText(e)}validateOptions(){return C(this.options)||I(this.options)}broadcast(e){}disconnect(){return i(this,void 0,void 0,function*(){clearTimeout(this._reconnectTimeout),this.subscriptions={},this._autoReconnect=!1,this.relayProtocol=null,this._closeConnection(),yield sessionStorage.removeItem(this.signature),this._executeQueue=[],this._detachListeners()})}on(e,t){return L(e,t,this.uuid),this}off(e,t){return U(e,t,this.uuid),this}connect(){return i(this,void 0,void 0,function*(){this.connection||(this.connection=new G(this)),this._attachListeners(),this.connection.isAlive||this.connection.connect()})}_handleLoginError(e){$(ej.Error,{error:e,sessionId:this.sessionid},this.uuid)}_onSocketOpen(){return i(this,void 0,void 0,function*(){this.options.keepConnectionAliveOnSocketClose&&this._emptyExecuteQueues()})}onNetworkClose(){for(let e in this.relayProtocol&&j(this.relayProtocol),this.subscriptions)j(e);this.subscriptions={},this.contexts=[],clearTimeout(this._keepAliveTimeout),this._autoReconnect&&(this._reconnectTimeout=setTimeout(()=>this.connect(),this.reconnectDelay))}_onSocketMessage(e){}_removeSubscription(e,t){this._existsSubscription(e,t)&&(t?(delete this.subscriptions[e][t],U(e,null,t)):(delete this.subscriptions[e],j(e)))}_addSubscription(e,t=null,i){this._existsSubscription(e,i)||(this._existsSubscription(e)||(this.subscriptions[e]={}),this.subscriptions[e][i]={},b(t)&&L(e,t,i))}_existsSubscription(e,t){return!(!this.subscriptions.hasOwnProperty(e)||!(!t||t&&this.subscriptions[e].hasOwnProperty(t)))}_attachListeners(){this._detachListeners(),this.on(ej.SocketOpen,this._onSocketOpen),this.on(ej.SocketClose,this.onNetworkClose),this.on(ej.SocketError,this.onNetworkClose),this.on(ej.SocketMessage,this._onSocketMessage)}_detachListeners(){this.off(ej.SocketOpen,this._onSocketOpen),this.off(ej.SocketClose,this.onNetworkClose),this.off(ej.SocketError,this.onNetworkClose),this.off(ej.SocketMessage,this._onSocketMessage)}_emptyExecuteQueues(){this._executeQueue.forEach(({resolve:e,msg:t})=>{"string"==typeof t?this.executeRaw(t):e(this.execute(t))})}_closeConnection(){this._idle=!0,clearTimeout(this._keepAliveTimeout),this.connection&&this.connection.close()}_resetKeepAlive(){!1===this._pong&&(g.warn("No ping/pong received, forcing PING ACK to keep alive"),this.execute(new K(x()))),clearTimeout(this._keepAliveTimeout),this._triggerKeepAliveTimeoutCheck()}_triggerKeepAliveTimeoutCheck(){this._pong=!1,this._keepAliveTimeout=setTimeout(()=>this._resetKeepAlive(),35e3)}setPingReceived(){g.debug("Ping received"),this._pong=!0}static on(e,t){L(e,t)}static off(e){U(e)}static uuid(){return a()}clearConnection(){this.connection=null}hasAutoReconnect(){return this._autoReconnect}}let z=(e,t)=>{let i=y(e);null!==i&&(i.getAttribute("autoplay")||i.setAttribute("autoplay","autoplay"),i.getAttribute("playsinline")||i.setAttribute("playsinline","playsinline"),i.srcObject=t)},Q=(e,t)=>i(void 0,void 0,void 0,function*(){let i=y(e);if(null===i)return g.info("No HTMLMediaElement to attach the speakerId"),!1;if("string"!=typeof t)return g.info(`Invalid speaker deviceId: '${t}'`),!1;try{return yield i.setSinkId(t),!0}catch(e){return!1}}),Y=e=>{e&&"live"===e.readyState&&e.stop()},X=e=>{let t;(t=e)&&t instanceof MediaStream&&e.getTracks().forEach(Y),e=null},Z=e=>i(void 0,void 0,void 0,function*(){g.info("RTCService.getUserMedia",e);let{audio:t}=e;if(!t)return null;try{return yield navigator.mediaDevices.getUserMedia(e)}catch(e){throw g.error("getUserMedia error: ",e),e}}),ee=(e=null,t=!1)=>i(void 0,void 0,void 0,function*(){let i=[],n=yield navigator.mediaDevices.getUserMedia(((e=null)=>({audio:!e||e===eq.AudioIn||e===eq.AudioOut,video:!e||e===eq.Video}))(e)).catch(e=>(console.error(e),null));if(n){if(X(n),i=yield navigator.mediaDevices.enumerateDevices(),e&&(i=i.filter(t=>t.kind===e)),!0===t)return i;let s=[];i=i.filter(e=>{if(!e.groupId)return!0;let t=`${e.kind}-${e.groupId}`;return!s.includes(t)&&(s.push(t),!0)})}return i}),et=[[320,240],[640,360],[640,480],[1280,720],[1920,1080]],ei=(e,t,n)=>i(void 0,void 0,void 0,function*(){let i=yield ee(n,!0);for(let n=0;n<i.length;n++){let{deviceId:s,label:r}=i[n];if(e===s||t===r)return s}return null}),en=(e,t)=>{if(!e)return!1;let{subscribed:i,alreadySubscribed:n}=es(e);return i.includes(t)||n.includes(t)},es=e=>{let t={subscribed:[],alreadySubscribed:[],unauthorized:[],unsubscribed:[],notSubscribed:[]};return Object.keys(t).forEach(i=>{t[i]=e[`${i}Channels`]||[]}),t},er=(e,t=null,i=null)=>{if(!(e&&e instanceof MediaStream))return null;let n=[];switch(t){case"audio":n=e.getAudioTracks();break;case"video":n=e.getVideoTracks();break;default:n=e.getTracks()}n.forEach(e=>{switch(i){case"on":case!0:e.enabled=!0;break;case"off":case!1:e.enabled=!1;break;default:e.enabled=!e.enabled}})},eo=e=>{er(e,"audio",!0)},ea=e=>{er(e,"audio",!1)},ec=e=>{er(e,"audio",null)};function ed(e,t){let i=document.getElementById(t);if(i)return i;if(e&&t){let i=document.createElement("audio");return i.id=t,i.loop=!0,i.src=e,i.preload="auto",i.load(),document.body.appendChild(i),i}return null}function el(e){e&&(e._playFulfilled=!1,e._promise=e.play(),e._promise.then(()=>{e._playFulfilled=!0}).catch(t=>{console.error("playAudio",t),e._playFulfilled=!0}))}function eu(e){e&&(e._playFulfilled?(e.pause(),e.currentTime=0):e._promise&&e._promise.then?e._promise.then(()=>{e.pause(),e.currentTime=0}):setTimeout(()=>{e.pause(),e.currentTime=0},1e3))}(e$=eJ||(eJ={})).not_supported="not supported",e$.full="full",e$.partial="partial";var eh="2.25.2";class ep extends H{constructor(e,t,i,n,s={},r){super(),this.method="login";const o={login:e,passwd:t,login_token:i,userVariables:s,reconnection:r,loginParams:{},"User-Agent":{sdkVersion:eh,data:navigator.userAgent}};n&&(o.sessid=n),this.buildRequest({method:this.method,params:o})}}class eg extends H{constructor(e,t){super(),this.buildRequest({id:e,result:{method:t}})}}class ef extends H{toString(){return eV.Invite}}class em extends H{toString(){return eV.Answer}}class ev extends H{toString(){return eV.Attach}}class eb extends H{toString(){return eV.Bye}}class ey extends H{toString(){return eV.Candidate}}class e_ extends H{toString(){return eV.EndOfCandidates}}class ew extends H{toString(){return eV.Modify}}class eS extends H{toString(){return eV.Info}}class eC extends H{toString(){return eV.Broadcast}}class eI extends H{toString(){return eV.Subscribe}}class ek extends H{toString(){return eV.Unsubscribe}}class eE extends V{constructor(e,t){super(),this.method="ai_conversation",this.buildRequest({method:this.method,params:{type:"conversation.item.create",previous_item_id:null,item:{id:a(),type:"message",role:"user",content:[{type:"input_text",text:e},...null==t?void 0:t.map(e=>({type:"image_url",image_url:{url:e}}))]}}})}}let eT=(e,t)=>{let{contentType:i,canvasType:n,callID:s,canvasInfo:r=null,currentLayerIdx:o=-1}=t;r&&"mcu-personal-canvas"!==n&&delete r.memberID;let a={type:A.conferenceUpdate,call:e.calls[s],canvasInfo:eR(r),currentLayerIdx:o};switch(i){case"layer-info":{let t=Object.assign({action:eW.LayerInfo},a);$(ej.Notification,t,e.uuid);break}case"layout-info":{let t=Object.assign({action:eW.LayoutInfo},a);$(ej.Notification,t,e.uuid)}}},eR=e=>v(JSON.stringify(e).replace(/memberID/g,"participantId").replace(/ID"/g,'Id"').replace(/POS"/g,'Pos"'));var ex,eA,eO,eN,eM,eP,eL,eD,eU,e$,ej,eF,eG,eV,eB,eH,eW,eq,eK,eJ,ez=p(function(e,t){function i(){}function n(){n.init.call(this)}function s(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function r(e,t,n,r){var o,a,c;if("function"!=typeof n)throw TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),c=a[t]):(a=e._events=new i,e._eventsCount=0),c){if("function"==typeof c?c=a[t]=r?[n,c]:[c,n]:r?c.unshift(n):c.push(n),!c.warned&&(o=s(e))&&0<o&&c.length>o){c.warned=!0;var d=Error("Possible EventEmitter memory leak detected. "+c.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=t,d.count=c.length,"function"==typeof console.warn?console.warn(d):console.log(d)}}else c=a[t]=n,++e._eventsCount;return e}function o(e,t,i){function n(){e.removeListener(t,n),s||(s=!0,i.apply(e,arguments))}var s=!1;return n.listener=i,n}function a(e){var t=this._events;if(t){var i=t[e];if("function"==typeof i)return 1;if(i)return i.length}return 0}function c(e,t){for(var i=Array(t);t--;)i[t]=e[t];return i}Object.defineProperty(t,"__esModule",{value:!0}),i.prototype=Object.create(null),n.EventEmitter=n,n.usingDomains=!1,n.prototype.domain=void 0,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.init=function(){this.domain=null,!n.usingDomains||!d.active||this instanceof d.Domain||(this.domain=d.active),this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new i,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||0>e||isNaN(e))throw TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return s(this)},n.prototype.emit=function(e){var t,i,n,s,r,o,a,d="error"===e;if(o=this._events)d=d&&null==o.error;else if(!d)return!1;if(a=this.domain,d){if(t=arguments[1],!a){if(t instanceof Error)throw t;var l=Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}return t||(t=Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=a,t.domainThrown=!1,a.emit("error",t),!1}if(!(i=o[e]))return!1;var u="function"==typeof i;switch(n=arguments.length){case 1:!function(e,t,i){if(t)e.call(i);else for(var n=e.length,s=c(e,n),r=0;r<n;++r)s[r].call(i)}(i,u,this);break;case 2:!function(e,t,i,n){if(t)e.call(i,n);else for(var s=e.length,r=c(e,s),o=0;o<s;++o)r[o].call(i,n)}(i,u,this,arguments[1]);break;case 3:!function(e,t,i,n,s){if(t)e.call(i,n,s);else for(var r=e.length,o=c(e,r),a=0;a<r;++a)o[a].call(i,n,s)}(i,u,this,arguments[1],arguments[2]);break;case 4:!function(e,t,i,n,s,r){if(t)e.call(i,n,s,r);else for(var o=e.length,a=c(e,o),d=0;d<o;++d)a[d].call(i,n,s,r)}(i,u,this,arguments[1],arguments[2],arguments[3]);break;default:for(s=Array(n-1),r=1;r<n;r++)s[r-1]=arguments[r];!function(e,t,i,n){if(t)e.apply(i,n);else for(var s=e.length,r=c(e,s),o=0;o<s;++o)r[o].apply(i,n)}(i,u,this,s)}return!0},n.prototype.addListener=function(e,t){return r(this,e,t,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(e,t){return r(this,e,t,!0)},n.prototype.once=function(e,t){if("function"!=typeof t)throw TypeError('"listener" argument must be a function');return this.on(e,o(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw TypeError('"listener" argument must be a function');return this.prependListener(e,o(this,e,t)),this},n.prototype.removeListener=function(e,t){var n,s,r,o,a;if("function"!=typeof t)throw TypeError('"listener" argument must be a function');if(!(s=this._events)||!(n=s[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new i:(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(r=-1,o=n.length;0<o--;)if(n[o]===t||n[o].listener&&n[o].listener===t){a=n[o].listener,r=o;break}if(0>r)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new i,this;delete s[e]}else{for(var c=n,d=r,l=d,u=l+1,h=c.length;u<h;l+=1,u+=1)c[l]=c[u];c.pop()}s.removeListener&&this.emit("removeListener",e,a||t)}return this},n.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0==arguments.length?(this._events=new i,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new i:delete n[e]),this;if(0==arguments.length){for(var s,r=Object.keys(n),o=0;o<r.length;++o)"removeListener"!==(s=r[o])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=new i,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do this.removeListener(e,t[t.length-1]);while(t[0])return this},n.prototype.listeners=function(e){var t,i=this._events;return i&&(t=i[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(t):[]},n.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):a.call(e,t)},n.prototype.listenerCount=a,n.prototype.eventNames=function(){return 0<this._eventsCount?Reflect.ownKeys(this._events):[]};for(var d,l,u=new Uint8Array(16),h=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,p=[],g=0;256>g;++g)p.push((g+256).toString(16).substr(1));function f(e,t){if(!e||!t)return{};let i={...e};if(i.localCandidateId){let e=t.get(i.localCandidateId);i.local={...e}}if(i.remoteCandidateId){let e=t.get(i.remoteCandidateId);i.remote={...e}}return i}function m(e,t,i){let n,s;return 8*(n=e[i],s=t?t[i]:null,null===n||null===s?null:(n-s)/(e.timestamp-t.timestamp)*1e3)}let v,b={},y=[];t.WebRTCStats=class extends n{constructor(e){if(super(),this.monitoringSetInterval=0,this.connectionMonitoringSetInterval=0,this.connectionMonitoringInterval=1e3,this.remote=!0,this.peersToMonitor={},this.timeline=[],this.statsToMonitor=["inbound-rtp","outbound-rtp","remote-inbound-rtp","remote-outbound-rtp","peer-connection","data-channel","stream","track","sender","receiver","transport","candidate-pair","local-candidate","remote-candidate"],"undefined"==typeof window)throw Error("WebRTCStats only works in browser");const t={...e};this.isEdge=!!window.RTCIceGatherer,this.getStatsInterval=t.getStatsInterval||1e3,this.rawStats=!!t.rawStats,this.statsObject=!!t.statsObject,this.filteredStats=!!t.filteredStats,this.shouldWrapGetUserMedia=!!t.wrapGetUserMedia,"boolean"==typeof t.remote&&(this.remote=t.remote),this.debug=!!t.debug,this.logLevel=t.logLevel||"none",this.shouldWrapGetUserMedia&&this.wrapGetUserMedia()}async addPeer(e,t){return console.warn("The addPeer() method has been deprecated, please use addConnection()"),this.addConnection({peerId:e,pc:t})}async addConnection(e){var t,i;let{pc:n,peerId:s}=e,{connectionId:r,remote:o}=e;if(o="boolean"==typeof o?o:this.remote,!(n&&n instanceof RTCPeerConnection))throw Error("Missing argument 'pc' or is not of instance RTCPeerConnection");if(!s)throw Error("Missing argument peerId");if(this.isEdge)throw Error("Can't monitor peers in Edge at this time.");if(this.peersToMonitor[s]){if(r&&r in this.peersToMonitor[s])throw Error(`We are already monitoring connection with id ${r}.`);for(let e in this.peersToMonitor[s]){let t=this.peersToMonitor[s][e];if(t.pc===n)throw Error(`We are already monitoring peer with id ${s}.`);"closed"===t.pc.connectionState&&this.removeConnection({pc:t.pc})}}let a=n.getConfiguration();return a.iceServers&&a.iceServers.forEach(function(e){delete e.credential}),r||((i=(t=t||{}).random||(t.rng||function(){if(!l&&!(l="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return l(u)})())[6]=64|15&i[6],i[8]=128|63&i[8],r=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=(p[e[t+0]]+p[e[t+1]]+p[e[t+2]]+p[e[t+3]]+"-"+p[e[t+4]]+p[e[t+5]]+"-"+p[e[t+6]]+p[e[t+7]]+"-"+p[e[t+8]]+p[e[t+9]]+"-"+p[e[t+10]]+p[e[t+11]]+p[e[t+12]]+p[e[t+13]]+p[e[t+14]]+p[e[t+15]]).toLowerCase();if(!("string"==typeof i&&h.test(i)))throw TypeError("Stringified UUID is invalid");return i}(i)),this.emitEvent({event:"addConnection",tag:"peer",peerId:s,connectionId:r,data:{options:e,peerConfiguration:a}}),this.monitorPeer({peerId:s,connectionId:r,pc:n,remote:o}),{connectionId:r}}getTimeline(e){return this.timeline=this.timeline.sort((e,t)=>e.timestamp.getTime()-t.timestamp.getTime()),e?this.timeline.filter(t=>t.tag===e):this.timeline}get logger(){let e=e=>{let t=["none","error","warn","info","debug"];return t.slice(0,t.indexOf(this.logLevel)+1).indexOf(e)>-1};return{error(...t){this.debug&&e("error")&&console.error("[webrtc-stats][error] ",...t)},warn(...t){this.debug&&e("warn")&&console.warn("[webrtc-stats][warn] ",...t)},info(...t){this.debug&&e("info")&&console.log("[webrtc-stats][info] ",...t)},debug(...t){this.debug&&e("debug")&&console.debug("[webrtc-stats][debug] ",...t)}}}removeConnection(e){let t,{connectionId:i,pc:n}=e;if(!n&&!i)throw Error("Missing arguments. You need to either send pc or a connectionId.");if(i){if("string"!=typeof i)throw Error("connectionId must be a string.");for(let e in this.peersToMonitor)i in this.peersToMonitor[e]&&(n=this.peersToMonitor[e][i].pc,t=e)}else if(n){if(!(n instanceof RTCPeerConnection))throw Error("pc must be an instance of RTCPeerConnection.");for(let e in this.peersToMonitor)for(let s in this.peersToMonitor[e])this.peersToMonitor[e][s].pc===n&&(i=s,t=e)}if(!n||!i)throw Error("Could not find the desired connection.");return this.removePeerConnectionEventListeners(i,n),delete this.peersToMonitor[t][i],0===Object.values(this.peersToMonitor[t]).length&&delete this.peersToMonitor[t],{connectionId:i}}removeAllPeers(){for(let e in this.peersToMonitor)this.removePeer(e)}removePeer(e){if(this.logger.info(`Removing PeerConnection with id ${e}.`),this.peersToMonitor[e]){for(let t in this.peersToMonitor[e]){let i=this.peersToMonitor[e][t].pc;this.removePeerConnectionEventListeners(t,i)}delete this.peersToMonitor[e]}}destroy(){this.removeAllPeers(),y.forEach(e=>{this.removeTrackEventListeners(e)}),y=[],this.shouldWrapGetUserMedia&&v&&(navigator.mediaDevices.getUserMedia=v)}monitorPeer(e){let{peerId:t,connectionId:i,pc:n,remote:s}=e;if(!n)return void this.logger.warn("Did not receive pc argument when calling monitorPeer()");let r={pc:n,connectionId:i,stream:null,stats:{parsed:null,raw:null},options:{remote:s}};if(this.peersToMonitor[t]){if(i in this.peersToMonitor[t])return void this.logger.warn(`Already watching connection with ID ${i}`);this.peersToMonitor[t][i]=r}else this.peersToMonitor[t]={[i]:r};this.addPeerConnectionEventListeners(t,i,n),1===this.numberOfMonitoredPeers&&(this.startStatsMonitoring(),this.startConnectionStateMonitoring())}startStatsMonitoring(){this.monitoringSetInterval||(this.monitoringSetInterval=window.setInterval(()=>{this.numberOfMonitoredPeers||this.stopStatsMonitoring(),this.getStats().then(e=>{e.forEach(e=>{this.emitEvent(e)})})},this._getStatsInterval))}stopStatsMonitoring(){this.monitoringSetInterval&&(window.clearInterval(this.monitoringSetInterval),this.monitoringSetInterval=0)}async getStats(e=null){this.logger.info(e?`Getting stats from peer ${e}`:"Getting stats from all peers");let t={};if(e){if(!this.peersToMonitor[e])throw Error(`Cannot get stats. Peer with id ${e} does not exist`);t[e]=this.peersToMonitor[e]}else t=this.peersToMonitor;let i=[];for(let e in t)for(let n in t[e]){let s=t[e][n],r=s.pc;if(r&&!this.checkIfConnectionIsClosed(e,n,r))try{let t=this.getTimestamp(),o=r.getStats(null);if(o){let r=await o,a=this.getTimestamp(),c=function(e){if(!e.entries)return e;let t={};return e.forEach(function(e,i){t[i]=e}),t}(r),d={remote:s.options.remote},l=function(e,t,i={}){var n;if(!e)return null;let s={audio:{inbound:[],outbound:[]},video:{inbound:[],outbound:[]},connection:{inbound:[],outbound:[]}};for(let t of(i.remote&&(s.remote={audio:{inbound:[],outbound:[]},video:{inbound:[],outbound:[]}}),e.values()))switch(t.type){case"outbound-rtp":{let i=t.mediaType||t.kind,n={},r={};if(!["audio","video"].includes(i))continue;if(t.codecId){let i=e.get(t.codecId);i&&(n.clockRate=i.clockRate,n.mimeType=i.mimeType,n.payloadType=i.payloadType)}r=e.get(t.mediaSourceId)||e.get(t.trackId)||{},s[i].outbound.push({...t,...n,track:{...r}});break}case"inbound-rtp":{let i=t.mediaType||t.kind,n={},r={};if(!["audio","video"].includes(i))if(t.id.includes("Video"))i="video";else{if(!t.id.includes("Audio"))continue;i="audio"}if(t.codecId){let i=e.get(t.codecId);i&&(r.clockRate=i.clockRate,r.mimeType=i.mimeType,r.payloadType=i.payloadType)}if(!s.connection.id&&t.transportId){let i=e.get(t.transportId);if(i&&i.selectedCandidatePairId){let t=e.get(i.selectedCandidatePairId);s.connection=f(t,e)}}n=e.get(t.mediaSourceId)||e.get(t.trackId)||{},s[i].inbound.push({...t,...r,track:{...n}});break}case"peer-connection":s.connection.dataChannelsClosed=t.dataChannelsClosed,s.connection.dataChannelsOpened=t.dataChannelsOpened;break;case"remote-inbound-rtp":{if(!i.remote)break;let n=t.mediaType||t.kind,r={};if(!["audio","video"].includes(n))if(t.id.includes("Video"))n="video";else{if(!t.id.includes("Audio"))continue;n="audio"}if(t.codecId){let i=e.get(t.codecId);i&&(r.clockRate=i.clockRate,r.mimeType=i.mimeType,r.payloadType=i.payloadType)}if(!s.connection.id&&t.transportId){let i=e.get(t.transportId);if(i&&i.selectedCandidatePairId){let t=e.get(i.selectedCandidatePairId);s.connection=f(t,e)}}s.remote[n].inbound.push({...t,...r});break}case"remote-outbound-rtp":{if(!i.remote)break;let n=t.mediaType||t.kind,r={};if(!["audio","video"].includes(n))continue;if(t.codecId){let i=e.get(t.codecId);i&&(r.clockRate=i.clockRate,r.mimeType=i.mimeType,r.payloadType=i.payloadType)}s.remote[n].outbound.push({...t,...r})}}if(!s.connection.id)for(let t of e.values())"candidate-pair"===t.type&&t.nominated&&"succeeded"===t.state&&(s.connection=f(t,e));return n=s,t&&(n.audio.inbound.map(e=>{let i=t.audio.inbound.find(t=>t.id===e.id);e.bitrate=m(e,i,"bytesReceived"),e.packetRate=m(e,i,"packetsReceived")}),n.audio.outbound.map(e=>{let i=t.audio.outbound.find(t=>t.id===e.id);e.bitrate=m(e,i,"bytesSent"),e.packetRate=m(e,i,"packetsSent")}),n.video.inbound.map(e=>{let i=t.video.inbound.find(t=>t.id===e.id);e.bitrate=m(e,i,"bytesReceived"),e.packetRate=m(e,i,"packetsReceived")}),n.video.outbound.map(e=>{let i=t.video.outbound.find(t=>t.id===e.id);e.bitrate=m(e,i,"bytesSent"),e.packetRate=m(e,i,"packetsSent")})),s=n}(r,s.stats.parsed,d),u={event:"stats",tag:"stats",peerId:e,connectionId:n,timeTaken:a-t,data:l};!0===this.rawStats&&(u.rawStats=r),!0===this.statsObject&&(u.statsObject=c),!0===this.filteredStats&&(u.filteredStats=this.filteroutStats(c)),i.push(u),s.stats.parsed=l}else this.logger.error(`PeerConnection from peer ${e} did not return any stats data`)}catch(e){this.logger.error(e)}}return i}startConnectionStateMonitoring(){this.connectionMonitoringSetInterval=window.setInterval(()=>{for(let e in this.numberOfMonitoredPeers||this.stopConnectionStateMonitoring(),this.peersToMonitor)for(let t in this.peersToMonitor[e]){let i=this.peersToMonitor[e][t].pc;this.checkIfConnectionIsClosed(e,t,i)}},this.connectionMonitoringInterval)}checkIfConnectionIsClosed(e,t,i){let n=this.isConnectionClosed(i);if(n){this.removeConnection({pc:i});let n="closed"===i.connectionState?"onconnectionstatechange":"oniceconnectionstatechange";this.emitEvent({event:n,peerId:e,connectionId:t,tag:"connection",data:"closed"})}return n}isConnectionClosed(e){return"closed"===e.connectionState||"closed"===e.iceConnectionState}stopConnectionStateMonitoring(){this.connectionMonitoringSetInterval&&(window.clearInterval(this.connectionMonitoringSetInterval),this.connectionMonitoringSetInterval=0)}wrapGetUserMedia(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return void this.logger.warn("'navigator.mediaDevices.getUserMedia' is not available in browser. Will not wrap getUserMedia.");this.logger.info("Wrapping getUsermedia functions."),v=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);let e=this.parseGetUserMedia.bind(this);navigator.mediaDevices.getUserMedia=(function(){return e({constraints:arguments[0]}),v.apply(navigator.mediaDevices,arguments).then(t=>(e({stream:t}),t),t=>(e({error:t}),Promise.reject(t)))}).bind(navigator.mediaDevices)}filteroutStats(e={}){let t={...e};for(let e in t){var i=t[e];this.statsToMonitor.includes(i.type)||delete t[e]}return t}get peerConnectionListeners(){return{icecandidate:(e,t,i,n)=>{this.logger.debug("[pc-event] icecandidate | peerId: ${peerId}",n),this.emitEvent({event:"onicecandidate",tag:"connection",peerId:e,connectionId:t,data:n.candidate})},track:(e,t,i,n)=>{this.logger.debug(`[pc-event] track | peerId: ${e}`,n);let s=n.track,r=n.streams[0];e in this.peersToMonitor&&t in this.peersToMonitor[e]&&(this.peersToMonitor[e][t].stream=r),this.addTrackEventListeners(s,t),this.emitEvent({event:"ontrack",tag:"track",peerId:e,connectionId:t,data:{stream:r?this.getStreamDetails(r):null,track:s?this.getMediaTrackDetails(s):null,title:n.track.kind+":"+n.track.id+" "+n.streams.map(function(e){return"stream:"+e.id})}})},signalingstatechange:(e,t,i)=>{this.logger.debug(`[pc-event] signalingstatechange | peerId: ${e}`),this.emitEvent({event:"onsignalingstatechange",tag:"connection",peerId:e,connectionId:t,data:{signalingState:i.signalingState,localDescription:i.localDescription,remoteDescription:i.remoteDescription}})},iceconnectionstatechange:(e,t,i)=>{this.logger.debug(`[pc-event] iceconnectionstatechange | peerId: ${e}`),this.emitEvent({event:"oniceconnectionstatechange",tag:"connection",peerId:e,connectionId:t,data:i.iceConnectionState})},icegatheringstatechange:(e,t,i)=>{this.logger.debug(`[pc-event] icegatheringstatechange | peerId: ${e}`),this.emitEvent({event:"onicegatheringstatechange",tag:"connection",peerId:e,connectionId:t,data:i.iceGatheringState})},icecandidateerror:(e,t,i,n)=>{this.logger.debug(`[pc-event] icecandidateerror | peerId: ${e}`),this.emitEvent({event:"onicecandidateerror",tag:"connection",peerId:e,connectionId:t,error:{errorCode:n.errorCode}})},connectionstatechange:(e,t,i)=>{this.logger.debug(`[pc-event] connectionstatechange | peerId: ${e}`),this.emitEvent({event:"onconnectionstatechange",tag:"connection",peerId:e,connectionId:t,data:i.connectionState})},negotiationneeded:(e,t,i)=>{this.logger.debug(`[pc-event] negotiationneeded | peerId: ${e}`),this.emitEvent({event:"onnegotiationneeded",tag:"connection",peerId:e,connectionId:t})},datachannel:(e,t,i,n)=>{this.logger.debug(`[pc-event] datachannel | peerId: ${e}`,n),this.emitEvent({event:"ondatachannel",tag:"datachannel",peerId:e,connectionId:t,data:n.channel})}}}addPeerConnectionEventListeners(e,t,i){this.logger.debug(`Adding event listeners for peer ${e} and connection ${t}.`),b[t]={},Object.keys(this.peerConnectionListeners).forEach(n=>{b[t][n]=this.peerConnectionListeners[n].bind(this,e,t,i),i.addEventListener(n,b[t][n],!1)})}parseGetUserMedia(e){try{let t={event:"getUserMedia",tag:"getUserMedia",data:{...e}};e.stream&&(t.data.details=this.parseStream(e.stream),e.stream.getTracks().map(e=>{this.addTrackEventListeners(e),y.push(e)})),this.emitEvent(t)}catch(e){}}parseStream(e){let t={audio:[],video:[]};return e.getTracks().forEach(e=>{t[e.kind].push(this.getMediaTrackDetails(e))}),t}getMediaTrackDetails(e){return{enabled:e.enabled,id:e.id,contentHint:e.contentHint,kind:e.kind,label:e.label,muted:e.muted,readyState:e.readyState,constructorName:e.constructor.name,capabilities:e.getCapabilities?e.getCapabilities():{},constraints:e.getConstraints?e.getConstraints():{},settings:e.getSettings?e.getSettings():{},_track:e}}getStreamDetails(e){return{active:e.active,id:e.id,_stream:e}}getTrackEventObject(e){return{mute:t=>{this.emitEvent({event:"mute",tag:"track",connectionId:e,data:{event:t}})},unmute:t=>{this.emitEvent({event:"unmute",tag:"track",connectionId:e,data:{event:t}})},overconstrained:t=>{this.emitEvent({event:"overconstrained",tag:"track",connectionId:e,data:{event:t}})},ended:t=>{this.emitEvent({event:"ended",tag:"track",connectionId:e,data:{event:t}}),this.removeTrackEventListeners(t.target)}}}addTrackEventListeners(e,t){b[e.id]={};let i=this.getTrackEventObject(t);Object.keys(i).forEach(t=>{b[e.id][t]=i[t].bind(this),e.addEventListener(t,b[e.id][t])}),b[e.id].readyState=setInterval(()=>{if("ended"===e.readyState){let t=new CustomEvent("ended",{detail:{check:"readyState"}});e.dispatchEvent(t)}},1e3)}removeTrackEventListeners(e){e.id in b&&(Object.keys(this.getTrackEventObject()).forEach(t=>{e.removeEventListener(t,b[e.id][t])}),clearInterval(b[e.id].readyState),delete b[e.id])}addToTimeline(e){this.timeline.push(e),this.emit("timeline",e)}emitEvent(e){let t={...e,timestamp:new Date};this.addToTimeline(t),t.tag&&this.emit(t.tag,t)}set getStatsInterval(e){if(!Number.isInteger(e))throw Error(`getStatsInterval should be an integer, got: ${e}`);this._getStatsInterval=e,this.monitoringSetInterval&&(this.stopStatsMonitoring(),this.startStatsMonitoring())}get numberOfMonitoredPeers(){return Object.keys(this.peersToMonitor).length}removePeerConnectionEventListeners(e,t){e in b&&(Object.keys(this.peerConnectionListeners).forEach(i=>{t.removeEventListener(i,b[e][i],!1)}),delete b[e]),t.getSenders().forEach(e=>{e.track&&this.removeTrackEventListeners(e.track)}),t.getReceivers().forEach(e=>{e.track&&this.removeTrackEventListeners(e.track)})}getTimestamp(){return Date.now()}wrapGetDisplayMedia(){let e=this;if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia){let t=navigator.mediaDevices.getDisplayMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getDisplayMedia=(function(){return e.debug("navigator.mediaDevices.getDisplayMedia",null,arguments[0]),t.apply(navigator.mediaDevices,arguments).then(function(e){return e},function(t){return e.debug("navigator.mediaDevices.getDisplayMediaOnFailure",null,t.name),Promise.reject(t)})}).bind(navigator.mediaDevices)}}}});ez&&ez.__esModule&&Object.prototype.hasOwnProperty.call(ez,"default")&&ez.default;var eQ=ez.WebRTCStats;class eY extends V{constructor(e){super(),this.buildRequest({type:"debug_report_start",debug_report_id:e,debug_report_version:1})}}class eX extends V{constructor(e){super(),this.buildRequest({type:"debug_report_stop",debug_report_id:e,debug_report_version:1})}}class eZ extends V{constructor(e,t){super(),this.buildRequest({type:"debug_report_data",debug_report_id:e,debug_report_version:1,debug_report_data:t})}}class e0{constructor(e,t,n,s,r){this.type=e,this.options=t,this.onSdpReadyTwice=null,this.statsReporter=null,this._negotiating=!1,this._prevConnectionState=null,this._restartedIceOnConnectionStateFailed=!1,this.handleConnectionStateChange=e=>i(this,void 0,void 0,function*(){let{connectionState:e}=this.instance;if(console.log(`[${(new Date).toISOString()}] Connection State changed: ${this._prevConnectionState} -> ${e}`),"failed"===e||"disconnected"===e){let t=()=>i(this,void 0,void 0,function*(){this._isOffer()&&!this._restartedIceOnConnectionStateFailed?(this.instance.restartIce(),g.debug(`Peer Connection ${e}. Restarting ICE gathering.`),"failed"===e&&(this._restartedIceOnConnectionStateFailed=!0,g.debug("ICE has been restarted on connection state failed.")),this._isTrickleIce()?yield this.startTrickleIceNegotiation():this.startNegotiation()):this._restartedIceOnConnectionStateFailed&&(g.debug("Peer Connection failed again after ICE restart. Closing unrecoverable call."),$(ej.PeerConnectionFailureError,{error:Error(`Peer Connection failed twice. previous state: ${this._prevConnectionState}, current state: ${e}`),sessionId:this._session.sessionid},this.options.id)),window.removeEventListener("online",t)});navigator.onLine?t():window.addEventListener("online",t)}"connected"===this._prevConnectionState&&"disconnected"===e&&(yield this._resetJitterBuffer()),"disconnected"===this._prevConnectionState&&"connected"===e&&(yield this._resetJitterBuffer()),this._prevConnectionState=e,this._isTrickleIce()&&("connecting"===e&&performance.mark("peer-connection-connecting"),"connected"===e&&(performance.mark("peer-connection-connected"),console.group("Performance Metrics"),console.table(this.trickleIcePerformanceMetrics),console.groupEnd(),performance.clearMarks()))}),this._handleIceConnectionStateChange=e=>{console.log(`[${(new Date).toISOString()}] ICE Connection State`,this.instance.iceConnectionState)},this._handleIceGatheringStateChange=e=>{console.log(`[${(new Date).toISOString()}] ICE Gathering State`,this.instance.iceGatheringState)},this._setAudioCodec=e=>{if(this.options.preferred_codecs&&0!==this.options.preferred_codecs.length)return e.setCodecPreferences?e.setCodecPreferences(this.options.preferred_codecs):void 0},g.info("New Peer with type:",this.type,"Options:",this.options),this._constraints={offerToReceiveAudio:!0},this._sdpReady=this._sdpReady.bind(this),this.handleSignalingStateChangeEvent=this.handleSignalingStateChangeEvent.bind(this),this.handleNegotiationNeededEvent=this.handleNegotiationNeededEvent.bind(this),this.handleTrackEvent=this.handleTrackEvent.bind(this),this.createPeerConnection=this.createPeerConnection.bind(this),this._session=n,this._trickleIceSdpFn=s,this._registerPeerEvents=r}get isOffer(){return this.type===eF.Offer}get isAnswer(){return this.type===eF.Answer}get isDebugEnabled(){return this.options.debug||this._session.options.debug}get debugOutput(){return this.options.debugOutput||this._session.options.debugOutput}get keepConnectionAliveOnSocketClose(){return this.options.keepConnectionAliveOnSocketClose||this._session.options.keepConnectionAliveOnSocketClose}startNegotiation(){performance.mark("ice-gathering-start"),this._negotiating=!0,this._isOffer()?this._createOffer():this._createAnswer()}startTrickleIceNegotiation(){return i(this,void 0,void 0,function*(){performance.mark("ice-gathering-start"),this._negotiating=!0,this._isOffer()?yield this._createOffer().then(this._trickleIceSdpFn.bind(this)):yield this._createAnswer().then(this._trickleIceSdpFn.bind(this))})}_logTransceivers(){g.info("Number of transceivers:",this.instance.getTransceivers().length),this.instance.getTransceivers().forEach((e,t)=>{g.info(`>> Transceiver [${t}]:`,e.mid,e.direction,e.stopped),g.info(`>> Sender Params [${t}]:`,JSON.stringify(e.sender.getParameters(),null,2))})}get trickleIcePerformanceMetrics(){let e=performance.measure("new-call","new-call-start","new-call-end"),t=performance.measure("peer-creation","peer-creation-start","peer-creation-end"),i=performance.measure("ice-gathering","ice-gathering-start","ice-gathering-end"),n=performance.measure("sdp-send","sdp-send-start","sdp-send-end"),s=performance.measure("invite-send","new-call-start","sdp-send-start"),r=performance.measure("total-duration","peer-creation-start","sdp-send-end"),o=e=>`${e.toFixed(2)}ms`;return{"New Call":{duration:o(e.duration)},"Peer Creation":{duration:o(t.duration)},"ICE Gathering":{duration:o(i.duration)},[this._isOffer()?"Invite Send":"Answer Send"]:{duration:o(s.duration)},"SDP Send":{duration:o(n.duration)},"Total Duration":{duration:o(r.duration)}}}handleSignalingStateChangeEvent(e){switch(g.info("signalingState:",this.instance.signalingState),this.instance.signalingState){case"stable":this._negotiating=!1;break;case"closed":this.instance=null;break;default:this._negotiating=!0}}handleNegotiationNeededEvent(){g.info("Negotiation needed event"),"stable"!==this.instance.signalingState||this._negotiating?g.debug("Skipping negotiation, state:",this.instance.signalingState,"negotiating:",this._negotiating):this._isTrickleIce()?this.startTrickleIceNegotiation():this.startNegotiation()}handleTrackEvent(e){let{streams:[t]}=e,{remoteElement:i,screenShare:n}=this.options,{remoteStream:s}=this.options;s=t,!1===n&&z(i,s)}createPeerConnection(){return i(this,void 0,void 0,function*(){var e;this.instance=(e=this._config(),new window.RTCPeerConnection(e)),this.instance.onsignalingstatechange=this.handleSignalingStateChangeEvent,this.instance.onnegotiationneeded=this.handleNegotiationNeededEvent,this.instance.ontrack=this.handleTrackEvent,this.instance.addEventListener("connectionstatechange",this.handleConnectionStateChange),this.instance.addEventListener("iceconnectionstatechange",this._handleIceConnectionStateChange),this.instance.addEventListener("icegatheringstatechange",this._handleIceGatheringStateChange),this.instance.addEventListener("addstream",e=>{this.options.remoteStream=e.stream}),this._registerPeerEvents(this.instance),this._prevConnectionState=this.instance.connectionState,this.isAnswer&&(yield this._setRemoteDescription({sdp:this.options.remoteSdp,type:eF.Offer})),this.options.localStream=yield this._retrieveLocalStream().catch(e=>($(ej.MediaError,e,this.options.id),null)),performance.mark("peer-creation-end")})}init(){var e;return i(this,void 0,void 0,function*(){yield this.createPeerConnection(),yield null==(e=this.statsReporter)?void 0:e.start(this.instance,this._session.sessionid,this._session.sessionid);let{localElement:t,localStream:n=null,screenShare:s=!1}=this.options;if(n&&n instanceof MediaStream){let e=n.getAudioTracks();if(g.info("Local audio tracks: ",e),"object"==typeof this.options.audio&&e.forEach(e=>{g.info("Local audio tracks constraints: ",e.getConstraints())}),this.isOffer&&"function"==typeof this.instance.addTransceiver){let t={direction:"sendrecv",streams:[n]};e.forEach(e=>{this.options.userVariables.microphoneLabel=e.label;let i=this.instance.addTransceiver(e,t);this._setAudioCodec(i)})}else"function"==typeof this.instance.addTrack?(e.forEach(e=>{this.options.userVariables.microphoneLabel=e.label,this.instance.addTrack(e,n)}),this.instance.getTransceivers().forEach(e=>this._setAudioCodec(e))):this.instance.addStream(n);!1===s&&z(t,n)}this.isOffer?this.options.negotiateAudio&&this._checkMediaToNegotiate("audio"):this._isTrickleIce()||this.startNegotiation(),this._isTrickleIce()&&this.startTrickleIceNegotiation(),this._logTransceivers(),this.isDebugEnabled&&(this.statsReporter=function(e){let t=a(),n=new eQ({getStatsInterval:1e3,rawStats:!1,statsObject:!0,filteredStats:!1,remote:!0,debug:!1,logLevel:"warn"}),s=n=>i(this,void 0,void 0,function*(){"stats"===n.event&&$(ej.StatsFrame,function({data:e}){var t,i,n,s,r,o,a,c;let{audio:d,remote:l}=e,{audio:u}=l,h=null!=(i=null==(t=u.inbound[0])?void 0:t.jitter)?i:1/0,p=null!=(s=null==(n=u.inbound[0])?void 0:n.roundTripTime)?s:1/0,g=null!=(o=null==(r=d.inbound[0])?void 0:r.packetsReceived)?o:-1,f=function(e){let{packetsLost:t,packetsReceived:i,jitter:n,rtt:s}=e,r=93.2-function(e){let{jitter:t,rtt:i}=e,n=t+i/2;return .024*n+.11*(n-177.3)*(n>177.3)}({rtt:s,jitter:n})-function(e){let{packetsLost:t,packetsReceived:i}=e;return 20*Math.log(1+t/(i+t)*100)}({packetsLost:t,packetsReceived:i})+0;return Math.min(Math.max(1+.035*r+7e-6*r*(r-60)*(100-r),1),5)}({jitter:1e3*h,rtt:1e3*p,packetsLost:null!=(c=null==(a=d.inbound[0])?void 0:a.packetsLost)?c:-1,packetsReceived:g});return{jitter:h,rtt:p,mos:f,quality:isNaN(f)?null:f>4.2?"excellent":f>=4.1&&f<=4.2?"good":f>=3.7&&f<=4?"fair":f>=3.1&&f<=3.6?"poor":"bad",inboundAudio:d.inbound[0],outboundAudio:d.outbound[0],remoteInboundAudio:u.inbound[0],remoteOutboundAudio:u.outbound[0]}}(n),e.uuid),yield e.execute(new eZ(t,n))});return{start:(r,o,a)=>i(this,void 0,void 0,function*(){yield e.execute(new eY(t)),n.on("timeline",s),yield new Promise(e=>setTimeout(e,500)),n.addConnection({pc:r,peerId:o,connectionId:a})}),stop:s=>i(this,void 0,void 0,function*(){var i;let r,o,a,c=n.getTimeline();$(ej.StatsReport,c,e.uuid),"file"===s&&(i=`webrtc-stats-${t}-${Date.now()}`,r=new Blob([JSON.stringify(c)],{type:"application/json"}),o=URL.createObjectURL(r),(a=document.createElement("a")).href=o,a.download=`${i}.json`,a.click(),URL.revokeObjectURL(o)),yield e.execute(new eX(t)),n.removeAllPeers(),n.destroy()})}}(this._session))})}_getSenderByKind(e){return this.instance.getSenders().find(({track:t})=>t&&t.kind===e)}_checkMediaToNegotiate(e){if(!this._getSenderByKind(e)){let t=this.instance.addTransceiver(e);g.info("Add transceiver",e,t)}}_createOffer(){return i(this,void 0,void 0,function*(){if(this._isOffer()){this._constraints.offerToReceiveAudio=!!this.options.audio,g.info("_createOffer - this._constraints",this._constraints);try{let e=yield this.instance.createOffer(this._constraints);return yield this._setLocalDescription(e),this._isTrickleIce()||this._sdpReady(),e}catch(e){g.error("Peer _createOffer error:",e)}}})}_setRemoteDescription(e){return i(this,void 0,void 0,function*(){g.debug("Setting remote description",e),yield this.instance.setRemoteDescription(e)})}_createAnswer(){return i(this,void 0,void 0,function*(){if(this._isAnswer()){if("stable"!==this.instance.signalingState&&"have-remote-offer"!==this.instance.signalingState)return g.debug("Skipping negotiation, state:",this.instance.signalingState),console.log("  - But the signaling state isn't stable, so triggering rollback"),void(yield Promise.all([this.instance.setLocalDescription({type:"rollback"}),this.instance.setRemoteDescription({sdp:this.options.remoteSdp,type:eF.Offer})]));this._logTransceivers();try{let e=yield this.instance.createAnswer();return yield this._setLocalDescription(e),e}catch(e){g.error("Peer _createAnswer error:",e)}}})}_setLocalDescription(e){return i(this,void 0,void 0,function*(){yield this.instance.setLocalDescription(e)})}_sdpReady(){b(this.onSdpReadyTwice)&&this.onSdpReadyTwice(this.instance.localDescription)}_retrieveLocalStream(){return i(this,void 0,void 0,function*(){var e;let t;return(t=this.options.localStream)&&t instanceof MediaStream?this.options.localStream:Z((yield(e=this.options,i(void 0,void 0,void 0,function*(){let{audio:t=!0,micId:i}=e,{micLabel:n=""}=e;return i&&(i=yield ei(i,n,eq.AudioIn).catch(e=>null))&&("boolean"==typeof t&&(t={}),t.deviceId={exact:i}),{audio:t}}))))})}_resetJitterBuffer(){return i(this,void 0,void 0,function*(){try{let e=this.instance.getReceivers().find(e=>e.track&&"audio"===e.track.kind);e&&"jitterBufferTarget"in e&&(e.jitterBufferTarget=20,g.debug("[jitter] target set to",e.jitterBufferTarget,"ms"))}catch(e){g.error("Peer _resetJitterBuffer error:",e)}})}_isOffer(){return this.type===eF.Offer}_isAnswer(){return this.type===eF.Answer}_isTrickleIce(){return!0===this.options.trickleIce}_config(){let{prefetchIceCandidates:e,forceRelayCandidate:t}=this.options,i={bundlePolicy:"balanced",iceCandidatePoolSize:10*!!e,iceServers:[d,u],iceTransportPolicy:t?"relay":"all"};return g.info("RTC config",i),i}close(){var e;return i(this,void 0,void 0,function*(){yield null==(e=this.statsReporter)?void 0:e.stop(this.debugOutput),this.instance&&(this.instance.close(),this.instance=null)})}}class e1{constructor(e,t){this.session=e,this.id="",this.state=eB[eB.New],this.prevState="",this.channels=[],this.role=eH.Participant,this.extension=null,this._state=eB.New,this._prevState=eB.New,this.gotAnswer=!1,this.gotEarly=!1,this._lastSerno=0,this._targetNodeId=null,this._iceTimeout=null,this._iceDone=!1,this._statsBindings=[],this._statsIntervalId=null,this._pendingIceCandidates=[],this._isRemoteDescriptionSet=!1,this._checkConferenceSerno=e=>{let t=e<0||!this._lastSerno||this._lastSerno&&e===this._lastSerno+1;return t&&e>=0&&(this._lastSerno=e),t},this._doStats=()=>{this.peer&&this.peer.instance&&0!==this._statsBindings.length&&this.peer.instance.getStats().then(e=>{e.forEach(e=>{this._statsBindings.forEach(t=>{if(t.callback){if(t.constraints){for(var i in t.constraints)if(t.constraints.hasOwnProperty(i)&&t.constraints[i]!==e[i])return}t.callback(e)}})})})};const{iceServers:i,speaker:n,micId:s,micLabel:r,camId:o,camLabel:a,localElement:c,remoteElement:d,options:l,mediaConstraints:{audio:u},ringtoneFile:h,ringbackFile:p}=e;this.options=Object.assign({},O,{audio:u,iceServers:i,localElement:c,remoteElement:d,micId:s,micLabel:r,camId:o,camLabel:a,speakerId:n,ringtoneFile:h,ringbackFile:p,debug:l.debug,debugOutput:l.debugOutput,trickleIce:l.trickleIce,prefetchIceCandidates:l.prefetchIceCandidates,keepConnectionAliveOnSocketClose:l.keepConnectionAliveOnSocketClose},t),this._onMediaError=this._onMediaError.bind(this),this._onPeerConnectionFailureError=this._onPeerConnectionFailureError.bind(this),this._onTrickleIceSdp=this._onTrickleIceSdp.bind(this),this._registerPeerEvents=this._registerPeerEvents.bind(this),this._registerTrickleIcePeerEvents=this._registerTrickleIcePeerEvents.bind(this),this._init(),this.options&&(this._ringtone=ed(this.options.ringtoneFile,"_ringtone"),this._ringback=ed(this.options.ringbackFile,"_ringback"))}get performanceMetrics(){let e=performance.measure("peer-creation","peer-creation-start","peer-creation-end"),t=performance.measure("ice-gathering","ice-gathering-start","ice-gathering-end"),i=performance.measure("sdp-send","sdp-send-start","sdp-send-end"),n=performance.measure("total-duration","peer-creation-start","sdp-send-end"),s=e=>`${e.toFixed(2)}ms`;return{"Peer Creation":{duration:s(e.duration)},"ICE Gathering":{duration:s(t.duration)},"SDP Send":{duration:s(i.duration)},"Total Duration":{duration:s(n.duration)}}}get nodeId(){return this._targetNodeId}set nodeId(e){this._targetNodeId=e}get telnyxIDs(){return{telnyxCallControlId:this.options.telnyxCallControlId,telnyxSessionId:this.options.telnyxSessionId,telnyxLegId:this.options.telnyxLegId}}get localStream(){return this.options.localStream}get remoteStream(){return this.options.remoteStream}get memberChannel(){return`conference-member.${this.id}`}invite(){return i(this,void 0,void 0,function*(){this.direction=eG.Outbound,this.options.trickleIce&&this._resetTrickleIceCandidateState(),performance.mark("peer-creation-start"),this.peer=new e0(eF.Offer,this.options,this.session,this._onTrickleIceSdp,this.options.trickleIce?this._registerTrickleIcePeerEvents:this._registerPeerEvents),yield this.peer.init()})}answer(e={}){var t;return i(this,void 0,void 0,function*(){performance.mark("new-call-start"),this.stopRingtone(),this.direction=eG.Inbound,(null==(t=null==e?void 0:e.customHeaders)?void 0:t.length)>0&&(this.options=Object.assign(Object.assign({},this.options),{customHeaders:e.customHeaders})),this.options.trickleIce&&this._resetTrickleIceCandidateState(),performance.mark("peer-creation-start"),this.peer=new e0(eF.Answer,this.options,this.session,this._onTrickleIceSdp,this.options.trickleIce?this._registerTrickleIcePeerEvents:this._registerPeerEvents),yield this.peer.init(),performance.mark("new-call-end")})}playRingtone(){el(this._ringtone)}stopRingtone(){eu(this._ringtone)}playRingback(){el(this._ringback)}stopRingback(){eu(this._ringback)}hangup(e,t){var i,n,s;let r=e||{};this.cause=r.cause||"NORMAL_CLEARING",this.causeCode=r.causeCode||16,this.sipCode=r.sipCode||null,this.sipReason=r.sipReason||null,this.sipCallId=r.sip_call_id||null,this.options.customHeaders=[...null!=(i=this.options.customHeaders)?i:[],...null!=(s=null==(n=null==r?void 0:r.dialogParams)?void 0:n.customHeaders)?s:[]],this.setState(eB.Hangup);let o=()=>{var e;return null==(e=this.peer)||e.close(),this.setState(eB.Destroy)};if(this.stopRingtone(),this.stopRingback(),!1!==t){let e=new eb({sipCode:this.sipCode,sip_call_id:this.sipCallId,sessid:this.session.sessionid,dialogParams:this.options,cause:"USER_BUSY",causeCode:17});this._execute(e).catch(e=>{g.error("telnyx_rtc.bye failed!",e),$(ej.Error,{error:e,sessionId:this.session.sessionid},this.session.uuid)}).then(o.bind(this))}else o()}hold(){let e=new ew({sessid:this.session.sessionid,action:"hold",dialogParams:this.options});return this._execute(e).then(this._handleChangeHoldStateSuccess.bind(this)).catch(this._handleChangeHoldStateError.bind(this))}unhold(){let e=new ew({sessid:this.session.sessionid,action:"unhold",dialogParams:this.options});return this._execute(e).then(this._handleChangeHoldStateSuccess.bind(this)).catch(this._handleChangeHoldStateError.bind(this))}toggleHold(){let e=new ew({sessid:this.session.sessionid,action:"toggleHold",dialogParams:this.options});return this._execute(e).then(this._handleChangeHoldStateSuccess.bind(this)).catch(this._handleChangeHoldStateError.bind(this))}dtmf(e){let t=new eS({sessid:this.session.sessionid,dtmf:e,dialogParams:this.options});this._execute(t)}message(e,t){let i={from:this.session.options.login,to:e,body:t},n=new eS({sessid:this.session.sessionid,msg:i,dialogParams:this.options});this._execute(n)}muteAudio(){ea(this.options.localStream)}unmuteAudio(){eo(this.options.localStream)}toggleAudioMute(){ec(this.options.localStream)}setAudioInDevice(e){return i(this,void 0,void 0,function*(){let{instance:t}=this.peer,i=t.getSenders().find(({track:{kind:e}})=>"audio"===e);if(i){let t,n=yield(t={audio:{deviceId:{exact:e}}},navigator.mediaDevices.getUserMedia(t)),s=n.getAudioTracks()[0];i.replaceTrack(s),this.options.micId=e;let{localStream:r}=this.options;r.getAudioTracks().forEach(e=>e.stop()),r.getVideoTracks().forEach(e=>n.addTrack(e)),this.options.localStream=n}})}muteVideo(){er(this.options.localStream,"video",!1)}unmuteVideo(){er(this.options.localStream,"video",!0)}toggleVideoMute(){er(this.options.localStream,"video",null)}setVideoDevice(e){return i(this,void 0,void 0,function*(){let{instance:t}=this.peer,i=t.getSenders().find(({track:{kind:e}})=>"video"===e);if(i){let t,n=yield(t={video:{deviceId:{exact:e}}},navigator.mediaDevices.getUserMedia(t)),s=n.getVideoTracks()[0];i.replaceTrack(s);let{localElement:r,localStream:o}=this.options;z(r,n),this.options.camId=e,o.getAudioTracks().forEach(e=>n.addTrack(e)),o.getVideoTracks().forEach(e=>e.stop()),this.options.localStream=n}})}deaf(){ea(this.options.remoteStream)}undeaf(){eo(this.options.remoteStream)}toggleDeaf(){ec(this.options.remoteStream)}setBandwidthEncodingsMaxBps(e,t){return i(this,void 0,void 0,function*(){if(!this||!this.peer)return void g.error("Could not set bandwidth (reason: no peer connection). Dynamic bandwidth can only be set when there is a call running - is there any call running?)");let{instance:i}=this.peer,n=i.getSenders();if(!n)return void g.error("Could not set bandwidth (reason: no senders). Dynamic bandwidth can only be set when there is a call running - is there any call running?)");let s=n.find(({track:{kind:e}})=>e===t);if(s){let i=s.getParameters();i.encodings||(i.encodings=[{rid:"h"}]),g.info("Parameters: ",i),g.info("Setting max ","audio"===t?"audio":"video"," bandwidth to: ",e," [bps]"),i.encodings[0].maxBitrate=e,yield s.setParameters(i).then(()=>{g.info("audio"===t?"New audio":"New video"," bandwidth settings in use: ",s.getParameters())}).catch(e=>console.error(e))}else g.error("Could not set bandwidth (reason: no "+t+" sender). Dynamic bandwidth can only be set when there is a call running - is there any call running?)")})}setAudioBandwidthEncodingsMaxBps(e){this.setBandwidthEncodingsMaxBps(e,"audio")}setVideoBandwidthEncodingsMaxBps(e){this.setBandwidthEncodingsMaxBps(e,"video")}getStats(e,t){!e||(this._statsBindings.push({callback:e,constraints:t}),this._statsIntervalId||this._startStats(2e3))}setState(e){switch(this._prevState=this._state,this._state=e,this.state=eB[this._state].toLowerCase(),this.prevState=eB[this._prevState].toLowerCase(),g.info(`Call ${this.id} state change from ${this.prevState} to ${this.state}`),this._dispatchNotification({type:A.callUpdate,call:this}),e){case eB.Purge:this.hangup({cause:"PURGE",causeCode:"01"},!1);break;case eB.Active:setTimeout(()=>{let{remoteElement:e,speakerId:t}=this.options;e&&t&&Q(e,t)},0);break;case eB.Destroy:this._finalize()}}handleMessage(e){let{method:t,params:i}=e;switch(t){case eV.Answer:if(this.gotAnswer=!0,this._state>=eB.Active)return;this._state>=eB.Early&&this.setState(eB.Active),this.gotEarly||this._onRemoteSdp(i.sdp),this.stopRingback(),this.stopRingtone();break;case eV.Media:if(this._state>=eB.Early)return;this.gotEarly=!0,this._onRemoteSdp(i.sdp);break;case eV.Display:case eV.Attach:{let{display_name:e,display_number:n,display_direction:s}=i;this.extension=n;let r=s===eG.Inbound?eG.Outbound:eG.Inbound,o={type:A[t],call:this,displayName:e,displayNumber:n,displayDirection:r};$(ej.Notification,o,this.id)||$(ej.Notification,o,this.session.uuid);break}case eV.Candidate:this._addIceCandidate(i);break;case eV.Info:case eV.Event:{let e=Object.assign(Object.assign({},i),{type:A.generic,call:this});$(ej.Notification,e,this.id)||$(ej.Notification,e,this.session.uuid);break}case eV.Ringing:this.playRingback(),i.telnyx_call_control_id&&(this.options.telnyxCallControlId=i.telnyx_call_control_id),i.telnyx_session_id&&(this.options.telnyxSessionId=i.telnyx_session_id),i.telnyx_leg_id&&(this.options.telnyxLegId=i.telnyx_leg_id);break;case eV.Bye:let n=i.client_state||i.clientState;n&&(this.options.clientState=n),this.stopRingback(),this.stopRingtone(),this.hangup(i,!1)}}handleConferenceUpdate(e,t){return i(this,void 0,void 0,function*(){if(!this._checkConferenceSerno(e.wireSerno)&&e.name!==t.laName)return g.error("ConferenceUpdate invalid wireSerno or packet name:",e),"INVALID_PACKET";let{action:i,data:n,hashKey:s=String(this._lastSerno),arrIndex:r}=e;switch(i){case"bootObj":{this._lastSerno=0;let{chatChannel:e,infoChannel:i,modChannel:s,laName:r,conferenceMemberID:o,role:a}=t;this._dispatchConferenceUpdate({action:eW.Join,conferenceName:r,participantId:Number(o),role:a}),e&&(yield this._subscribeConferenceChat(e)),i&&(yield this._subscribeConferenceInfo(i));let c=[];for(let e in n)c.push(Object.assign({callId:n[e][0],index:Number(e)},m(n[e][1])));this._dispatchConferenceUpdate({action:eW.Bootstrap,participants:c});break}case"add":this._dispatchConferenceUpdate(Object.assign({action:eW.Add,callId:s,index:r},m(n)));break;case"modify":this._dispatchConferenceUpdate(Object.assign({action:eW.Modify,callId:s,index:r},m(n)));break;case"del":this._dispatchConferenceUpdate(Object.assign({action:eW.Delete,callId:s,index:r},m(n)));break;case"clear":this._dispatchConferenceUpdate({action:eW.Clear});break;default:this._dispatchConferenceUpdate({action:i,data:n,callId:s,index:r})}})}_addChannel(e){this.channels.includes(e)||this.channels.push(e);let t=this.session.relayProtocol;this.session._existsSubscription(t,e)&&(this.session.subscriptions[t][e]=Object.assign(Object.assign({},this.session.subscriptions[t][e]),{callId:this.id}))}_subscribeConferenceChat(e){return i(this,void 0,void 0,function*(){let t={nodeId:this.nodeId,channels:[e],handler:e=>{let{direction:t,from:i,fromDisplay:n,message:s,type:r}=e.data;this._dispatchConferenceUpdate({action:eW.ChatMessage,direction:t,participantNumber:i,participantName:n,messageText:s,messageType:r,messageId:e.eventSerno})}};en((yield this.session.vertoSubscribe(t).catch(e=>{g.error("ConfChat subscription error:",e)})),e)&&(this._addChannel(e),Object.defineProperties(this,{sendChatMessage:{configurable:!0,value:(t,i)=>{this.session.vertoBroadcast({nodeId:this.nodeId,channel:e,data:{action:"send",message:t,type:i}})}}}))})}_subscribeConferenceInfo(e){return i(this,void 0,void 0,function*(){let t={nodeId:this.nodeId,channels:[e],handler:e=>{let{eventData:t}=e;"layout-info"===t.contentType?(t.callID=this.id,eT(this.session,t)):g.error("Conference-Info unknown contentType",e)}};en((yield this.session.vertoSubscribe(t).catch(e=>{g.error("ConfInfo subscription error:",e)})),e)&&this._addChannel(e)})}_confControl(e,t={}){let i=Object.assign({application:"conf-control",callID:this.id,value:null},t);this.session.vertoBroadcast({nodeId:this.nodeId,channel:e,data:i})}_handleChangeHoldStateSuccess(e){return"active"===e.holdState?this.setState(eB.Active):this.setState(eB.Held),!0}_handleChangeHoldStateError(e){return g.error(`Failed to ${e.action} on call ${this.id}`),!1}_onRemoteSdp(e){return i(this,void 0,void 0,function*(){let t=new RTCSessionDescription({sdp:e,type:eF.Answer});yield this.peer.instance.setRemoteDescription(t).then(()=>{this.options.trickleIce&&(this._isRemoteDescriptionSet=!0,this._flushPendingTrickleIceCandidates()),this.gotEarly&&this.setState(eB.Early),this.gotAnswer&&this.setState(eB.Active)}).catch(e=>{g.error("Call setRemoteDescription Error: ",e),this.hangup()})})}_requestAnotherLocalDescription(){b(this.peer.onSdpReadyTwice)?$(ej.Error,{error:Error("SDP without candidates for the second time!"),sessionId:this.session.sessionid},this.session.uuid):(Object.defineProperty(this.peer,"onSdpReadyTwice",{value:this._onIceSdp.bind(this)}),this._iceDone=!1,this.peer.startNegotiation())}_onIceSdp(e){var t,i;this._iceTimeout&&clearTimeout(this._iceTimeout),this._iceTimeout=null,this._iceDone=!0;let{sdp:n,type:s}=e;if(-1===n.indexOf("candidate"))return g.info("No candidate - retry \n"),void this._requestAnotherLocalDescription();null==(i=null==(t=this.peer)?void 0:t.instance)||i.removeEventListener("icecandidate",this._onIce),performance.mark("ice-gathering-end");let r=null,o={sessid:this.session.sessionid,sdp:n,dialogParams:this.options,"User-Agent":`Web-${eh}`};switch(s){case eF.Offer:this.setState(eB.Requesting),r=new ef(o);break;case eF.Answer:this.setState(eB.Answering),r=!0===this.options.attach?new ev(o):new em(o);break;default:return g.error(`${this.id} - Unknown local SDP type:`,e),this.hangup({},!1)}performance.mark("sdp-send-start"),this._execute(r).then(e=>{let{node_id:t=null}=e;this._targetNodeId=t,s===eF.Offer?this.setState(eB.Trying):this.setState(eB.Active)}).catch(e=>{g.error(`${this.id} - Sending ${s} error:`,e),this.hangup()}).finally(()=>{performance.mark("sdp-send-end"),console.group("Performance Metrics"),console.table(this.performanceMetrics),console.groupEnd(),performance.clearMarks()})}_onTrickleIceSdp(e){if(!e)return g.error("No SDP data provided"),this.hangup({},!1);let{sdp:t,type:i}=e,n=null,s={sessid:this.session.sessionid,sdp:t,dialogParams:this.options,trickle:!0,"User-Agent":`Web-${eh}`};switch(i){case eF.Offer:this.setState(eB.Requesting),n=new ef(s);break;case eF.Answer:this.setState(eB.Answering),n=!0===this.options.attach?new ev(s):new em(s);break;default:return g.error(`${this.id} - Unknown local SDP type:`,e),this.hangup({},!1)}performance.mark("sdp-send-start"),this._execute(n).then(e=>{let{node_id:t=null}=e;this._targetNodeId=t,i===eF.Offer?this.setState(eB.Trying):this.setState(eB.Active)}).catch(e=>{g.error(`${this.id} - Sending ${i} error:`,e),this.hangup()}).finally(()=>{performance.mark("sdp-send-end")})}_onIce(e){let{instance:t}=this.peer;null===this._iceTimeout&&(this._iceTimeout=setTimeout(()=>this._onIceSdp(t.localDescription),1e3)),e.candidate?g.debug("RTCPeer Candidate:",e.candidate):this._onIceSdp(t.localDescription)}_onTrickleIce(e){e.candidate&&e.candidate.candidate?(g.debug("RTCPeer Candidate:",e.candidate),this._sendIceCandidate(e.candidate)):this._sendEndOfCandidates()}_sendIceCandidate(e){let t=new ey({sessid:this.session.sessionid,candidate:e.candidate,sdpMLineIndex:e.sdpMLineIndex,sdpMid:e.sdpMid,dialogParams:this.options});this._execute(t)}_addIceCandidate(e){this._isRemoteDescriptionSet?this._addIceCandidateToPeer(e):(g.debug("Remote description not set. Queued ICE candidate.",e),this._pendingIceCandidates.push(e))}_addIceCandidateToPeer(e){Promise.resolve(this.peer.instance.addIceCandidate(e)).then(()=>{g.debug("Successfully added ICE candidate:",e)}).catch(t=>{g.error("Failed to add ICE candidate:",t,e)})}_sendEndOfCandidates(){let e=new e_({sessid:this.session.sessionid,endOfCandidates:!0,dialogParams:this.options});this._execute(e),performance.mark("ice-gathering-end")}_resetTrickleIceCandidateState(){this._pendingIceCandidates=[],this._isRemoteDescriptionSet=!1}_flushPendingTrickleIceCandidates(){if(!this._pendingIceCandidates.length)return;let e=[...this._pendingIceCandidates];this._pendingIceCandidates=[],e.forEach(e=>{this._addIceCandidateToPeer(e)})}_registerPeerEvents(e){this._iceDone=!1,e.onicecandidate=e=>{this._iceDone||this._onIce(e)},e.addEventListener("addstream",e=>{this.options.remoteStream=e.stream}),e.addEventListener("track",e=>{this.options.remoteStream=e.streams[0];let{remoteElement:t,remoteStream:i,screenShare:n}=this.options;!1===n&&z(t,i)})}_registerTrickleIcePeerEvents(e){e.onicecandidate=e=>{this._onTrickleIce(e)},e.onicegatheringstatechange=t=>{g.debug("ICE gathering state changed:",e.iceGatheringState),"complete"===e.iceGatheringState&&g.debug("Finished gathering candidates")},e.onicecandidateerror=e=>{g.debug("ICE candidate error:",e)},e.addEventListener("addstream",e=>{this.options.remoteStream=e.stream}),e.addEventListener("track",e=>{this.options.remoteStream=e.streams[0];let{remoteElement:t,remoteStream:i,screenShare:n}=this.options;!1===n&&z(t,i)})}_onMediaError(e){this._dispatchNotification({type:A.userMediaError,error:e}),this.hangup({},!1)}_onPeerConnectionFailureError(e){this._dispatchNotification({type:A.peerConnectionFailureError,error:e}),this.hangup({},!1)}_dispatchConferenceUpdate(e){this._dispatchNotification(Object.assign({type:A.conferenceUpdate,call:this},e))}_dispatchNotification(e){!0!==this.options.screenShare&&($(ej.Notification,e,this.id,!1)||$(ej.Notification,e,this.session.uuid))}_execute(e){return this.nodeId&&(e.targetNodeId=this.nodeId),this.session.execute(e)}_init(){let{id:e,userVariables:t,remoteCallerNumber:i,onNotification:n}=this.options;this.options.id=e?e.toString():a(),this.id=this.options.id,t&&0!==Object.keys(t).length||(this.options.userVariables=this.session.options.userVariables||{}),i||(this.options.remoteCallerNumber=this.options.destinationNumber),this.session.calls[this.id]=this,L(ej.MediaError,this._onMediaError,this.id),L(ej.PeerConnectionFailureError,this._onPeerConnectionFailureError,this.id),b(n)&&L(ej.Notification,n.bind(this),this.id),this.setState(eB.New),g.info("New Call with Options:",this.options)}_finalize(){this._stopStats(),this.peer&&this.peer.instance&&(this.peer.instance.close(),this.peer=null);let{remoteStream:e,localStream:t}=this.options;X(e),X(t),U(ej.MediaError,null,this.id),U(ej.PeerConnectionFailureError,null,this.id),this.session.calls[this.id]=null,delete this.session.calls[this.id]}_startStats(e){this._statsIntervalId=setInterval(this._doStats,e),g.info("Stats started")}_stopStats(){this._statsIntervalId&&(clearInterval(this._statsIntervalId),this._statsIntervalId=null),g.info("Stats stopped")}}e1.setStateTelnyx=e=>{if(e){switch(e._state){case eB.Requesting:case eB.Recovering:case eB.Trying:case eB.Early:e.state="connecting";break;case eB.Active:e.state="active";break;case eB.Held:e.state="held";break;case eB.Hangup:case eB.Destroy:e.state="done";break;case eB.Answering:e.state="ringing";break;case eB.New:e.state="new"}return e}};class e2 extends e1{constructor(){super(...arguments),this._statsInterval=null,this.sendConversationMessage=(e,t)=>this.session.execute(new eE(e,t))}hangup(e={},t=!0){this.screenShare instanceof e2&&this.screenShare.hangup(e,t),super.hangup(e,t)}startScreenShare(e){return i(this,void 0,void 0,function*(){var t;let i=yield(t={video:!0},navigator.mediaDevices.getDisplayMedia(t));i.getTracks().forEach(e=>{e.addEventListener("ended",()=>{this.screenShare&&this.screenShare.hangup()})});let{remoteCallerName:n,remoteCallerNumber:s,callerName:r,callerNumber:o}=this.options,a=Object.assign({screenShare:!0,localStream:i,destinationNumber:`${this.extension}-screen`,remoteCallerName:n,remoteCallerNumber:`${s}-screen`,callerName:`${r} (Screen)`,callerNumber:`${o} (Screen)`},e);return this.screenShare=new e2(this.session,a),this.screenShare.invite(),this.screenShare})}stopScreenShare(){this.screenShare instanceof e2&&this.screenShare.hangup()}setAudioOutDevice(e){return i(this,void 0,void 0,function*(){this.options.speakerId=e;let{remoteElement:t,speakerId:i}=this.options;return!(!t||!i)&&Q(t,i)})}_finalize(){this._stats(!1),super._finalize()}_stats(e=!0){if(!1===e)return clearInterval(this._statsInterval);g.setLevel(2),this._statsInterval=window.setInterval(()=>i(this,void 0,void 0,function*(){let e=yield this.peer.instance.getStats(null),t="",i=["certificate","codec","peer-connection","stream","local-candidate","remote-candidate"],n=["id","type","timestamp"];e.forEach(e=>{i.includes(e.type)||(t+=`
${e.type}
`,Object.keys(e).forEach(i=>{n.includes(i)||(t+=`	${i}: ${e[i]}
`)}))}),g.info(t)}),2e3)}}class e3 extends J{constructor(e){super(e),this.calls={},this.autoRecoverCalls=!0,this._iceServers=[],this._localElement=null,this._remoteElement=null,this._jwtAuth=!0,this._audioConstraints=!0,this._speaker=null,this._onlineHandler=null,this._offlineHandler=null,this._wasOffline=!1,this.iceServers=e.iceServers,this.ringtoneFile=e.ringtoneFile,this.ringbackFile=e.ringbackFile,this._setupNetworkListeners()}get reconnectDelay(){return 1e3}getIsRegistered(){let e=Object.create(null,{getIsRegistered:{get:()=>super.getIsRegistered}});return i(this,void 0,void 0,function*(){return e.getIsRegistered.call(this)})}connect(){let e=Object.create(null,{connect:{get:()=>super.connect}});return i(this,void 0,void 0,function*(){e.connect.call(this)})}checkPermissions(e=!0,t=!0){return i(this,void 0,void 0,function*(){try{let i=yield Z({audio:e,video:t});return X(i),!0}catch(e){return!1}})}logout(){this.disconnect()}disconnect(){let e=Object.create(null,{disconnect:{get:()=>super.disconnect}});return i(this,void 0,void 0,function*(){Object.keys(this.calls).forEach(e=>this.calls[e].setState(eB.Purge)),this.calls={},this._cleanupNetworkListeners(),yield e.disconnect.call(this)})}handleLoginError(e){super._handleLoginError(e)}speedTest(e){return new Promise((t,i)=>{if(D(ej.SpeedTest,i=>{let{upDur:n,downDur:s}=i,r=s?8*e/(s/1e3)/1024:0;t({upDur:n,downDur:s,upKps:(n?8*e/(n/1e3)/1024:0).toFixed(0),downKps:r.toFixed(0)})},this.uuid),!(e=Number(e)))return i(`Invalid parameter 'bytes': ${e}`);this.executeRaw(`#SPU ${e}`);let n=e/1024;e%1024&&n++;let s=".".repeat(1024);for(let e=0;e<n;e++)this.executeRaw(`#SPB ${s}`);this.executeRaw("#SPE")})}getDevices(){return ee().catch(e=>($(ej.MediaError,e,this.uuid),[]))}getVideoDevices(){return ee(eq.Video).catch(e=>($(ej.MediaError,e,this.uuid),[]))}getAudioInDevices(){return ee(eq.AudioIn).catch(e=>($(ej.MediaError,e,this.uuid),[]))}getAudioOutDevices(){return ee(eq.AudioOut).catch(e=>(console.error("getAudioOutDevices",e),$(ej.MediaError,e,this.uuid),[]))}validateDeviceId(e,t,i){return ei(e,t,i)}getDeviceResolutions(e){return i(this,void 0,void 0,function*(){try{return yield i(void 0,void 0,void 0,function*(){let t=[],i=yield Z({video:{deviceId:{exact:e}}}),n=i.getVideoTracks()[0];for(let e=0;e<et.length;e++){let[i,s]=et[e];(yield n.applyConstraints({width:{exact:i},height:{exact:s}}).then(()=>!0).catch(()=>!1))&&t.push({resolution:`${i}x${s}`,width:i,height:s})}return X(i),t})}catch(e){throw e}})}get mediaConstraints(){return{audio:this._audioConstraints}}setAudioSettings(e){return i(this,void 0,void 0,function*(){let n;if(!e)throw Error("You need to provide the settings object");let{micId:s,micLabel:r}=e,o=t(e,["micId","micLabel"]);return n=navigator.mediaDevices.getSupportedConstraints(),Object.keys(o).map(e=>{n.hasOwnProperty(e)&&null!==o[e]&&void 0!==o[e]||delete o[e]}),this._audioConstraints=yield i(void 0,void 0,void 0,function*(){let{deviceId:e}=o;if(void 0===e&&(s||r)){let e=yield ei(s,r,"audioinput").catch(e=>null);e&&(o.deviceId={exact:e})}return o}),this.micId=s,this.micLabel=r,this._audioConstraints})}disableMicrophone(){this._audioConstraints=!1}enableMicrophone(){this._audioConstraints=!0}set iceServers(e){let t={urls:["stun:stun.l.google.com:19302"]};this._iceServers="boolean"==typeof e?e?[t]:[]:e||[u,l,t]}get iceServers(){return this._iceServers}set speaker(e){this._speaker=e}get speaker(){return this._speaker}set localElement(e){this._localElement=y(e)}get localElement(){return this._localElement}set remoteElement(e){this._remoteElement=y(e)}get remoteElement(){return this._remoteElement}vertoBroadcast({nodeId:e,channel:t="",data:i}){if(!t)throw Error(`Invalid channel for broadcast: ${t}`);let n=new eC({sessid:this.sessionid,eventChannel:t,data:i});e&&(n.targetNodeId=e),this.execute(n).catch(e=>e)}vertoSubscribe({nodeId:e,channels:t=[],handler:n}){return i(this,void 0,void 0,function*(){if(!(t=t.filter(e=>e&&!this._existsSubscription(this.relayProtocol,e))).length)return{};let i=new eI({sessid:this.sessionid,eventChannel:t});e&&(i.targetNodeId=e);let s=yield this.execute(i),{unauthorized:r=[],subscribed:o=[]}=es(s);return r.length&&r.forEach(e=>this._removeSubscription(this.relayProtocol,e)),o.forEach(e=>this._addSubscription(this.relayProtocol,n,e)),s})}vertoUnsubscribe({nodeId:e,channels:t=[]}){return i(this,void 0,void 0,function*(){if(!(t=t.filter(e=>e&&this._existsSubscription(this.relayProtocol,e))).length)return{};let i=new ek({sessid:this.sessionid,eventChannel:t});e&&(i.targetNodeId=e);let n=yield this.execute(i),{unsubscribed:s=[],notSubscribed:r=[]}=es(n);return s.forEach(e=>this._removeSubscription(this.relayProtocol,e)),r.forEach(e=>this._removeSubscription(this.relayProtocol,e)),n})}_setupNetworkListeners(){"undefined"!=typeof window&&(this._onlineHandler=()=>{this._wasOffline&&this.connected&&(this._closeConnection(),this.connect()),this._wasOffline=!1},this._offlineHandler=()=>{this._wasOffline=!0},window.addEventListener("online",this._onlineHandler),window.addEventListener("offline",this._offlineHandler))}_cleanupNetworkListeners(){"undefined"!=typeof window&&this._onlineHandler&&this._offlineHandler&&(window.removeEventListener("online",this._onlineHandler),window.removeEventListener("offline",this._offlineHandler),this._onlineHandler=null,this._offlineHandler=null)}static telnyxStateCall(e){return e2.setStateTelnyx(e)}}class e6{constructor(e,t){this.code=t,this.message=e}}class e4 extends H{constructor(e){super(),this.method="anonymous_login";const{target_type:t,target_id:i,target_version_id:n,userVariables:s,sessionId:r,reconnection:o}=e,a={target_type:t,target_id:i,userVariables:s,reconnection:o,"User-Agent":{sdkVersion:eh,data:navigator.userAgent}};r&&(a.sessid=r),n&&(a.target_version_id=n),this.buildRequest({method:this.method,params:a})}}class e9{constructor(e){this.session=e,this.handleLogin=()=>i(this,void 0,void 0,function*(){let{login:e,password:t,passwd:i,login_token:n,userVariables:s}=this.session.options,r=new ep(e,t||i,n,this.session.sessionid,s,!!x()),o=yield this.session.execute(r).catch(this.session.handleLoginError);o&&(this.session.sessionid=o.sessid)}),this.handleAnonymousLogin=()=>i(this,void 0,void 0,function*(){let{anonymous_login:e}=this.session.options,t=new e4({target_id:e.target_id,target_type:e.target_type,target_version_id:e.target_version_id,sessionId:this.session.sessionid,userVariables:this.session.options.userVariables,reconnection:!!x()}),i=yield this.session.execute(t).catch(this.session.handleLoginError);i&&(this.session.sessionid=i.sessid)})}_ack(e,t){let i=new eg(e,t);this.nodeId&&(i.targetNodeId=this.nodeId),this.session.execute(i)}reconnectDelay(){return 1e3*S(2,6)}handleMessage(e){var t;let{session:n}=this,{id:s,method:r,params:o={},voice_sdk_id:a}=e,c=null==o?void 0:o.callID,d=null==o?void 0:o.eventChannel,l=null==o?void 0:o.eventType,u=r===eV.Attach,h=!1;if("channelPvtData"===l)return this._handlePvtEvent(o.pvtData);if(c&&n.calls.hasOwnProperty(c)){if(!u)return n.calls[c].handleMessage(e),void this._ack(s,r);(h=(n.calls[c].options.keepConnectionAliveOnSocketClose||n.options.keepConnectionAliveOnSocketClose)&&!!(null==(t=this.session.calls[c].peer)?void 0:t.instance))?g.info(`[${(new Date).toISOString()}][${c}] re-attaching call due to ATTACH`):(g.debug(`Session Options: ${n.options}`),g.debug(`Call: ${n.calls[c]}`),g.info(`[${(new Date).toISOString()}][${c}] Hanging up the call due to ATTACH`),n.calls[c].hangup({},!1))}let p=()=>{var e,t,i,s,r,a;let d={id:c,remoteSdp:o.sdp,destinationNumber:o.callee_id_number,remoteCallerName:o.caller_id_name,remoteCallerNumber:o.caller_id_number,callerName:o.callee_id_name,callerNumber:o.callee_id_number,attach:u,mediaSettings:o.mediaSettings,debug:null!=(e=n.options.debug)&&e,debugOutput:null!=(t=n.options.debugOutput)?t:"socket",trickleIce:null!=(i=n.options.trickleIce)&&i,prefetchIceCandidates:null!=(s=n.options.prefetchIceCandidates)&&s,forceRelayCandidate:null!=(r=n.options.forceRelayCandidate)&&r,keepConnectionAliveOnSocketClose:null!=(a=n.options.keepConnectionAliveOnSocketClose)&&a};o.telnyx_call_control_id&&(d.telnyxCallControlId=o.telnyx_call_control_id),o.telnyx_session_id&&(d.telnyxSessionId=o.telnyx_session_id),o.telnyx_leg_id&&(d.telnyxLegId=o.telnyx_leg_id),o.client_state&&(d.clientState=o.client_state),o.dialogParams&&o.dialogParams.custom_headers&&o.dialogParams.custom_headers.length&&(d.customHeaders=o.dialogParams.custom_headers);let l=new e2(n,d);return l.nodeId=this.nodeId,l},f=new W(a),m=new K(a);switch(r){case eV.Ping:this.session.setPingReceived(),this.session.execute(m).then(()=>{e9.receivedAuthenticationRequired=0}).catch(e=>i(this,void 0,void 0,function*(){e.code===this.session.authenticationRequiredErrorCode&&(e9.receivedAuthenticationRequired+=1,e9.receivedAuthenticationRequired>1&&this.session.hasAutoReconnect()&&(g.warn("Ping failed twice with Authentication Required. Re-logging in..."),C(this.session.options)?this.handleLogin():I(this.session.options)&&this.handleAnonymousLogin()))}));break;case eV.Punt:if(h)return void g.info(`[${(new Date).toISOString()}][${c}] Ignoring PUNT due to keepConnectionAliveOnSocketClose`);n.disconnect();break;case eV.Invite:{let e=p();e.playRingtone(),e.setState(eB.Ringing),e.direction=eG.Inbound,this._ack(s,r);break}case eV.Attach:{if(h)return void this.session.execute(new ev({sessid:this.session.sessionid,sdp:this.session.calls[c].peer.instance.localDescription.sdp,dialogParams:this.session.calls[c].options,"User-Agent":`Web-${eh}`}));g.info(`[${(new Date).toISOString()}][${c}] Re-creating call instance.`);let t=p();this.session.autoRecoverCalls?t.answer():t.setState(eB.Recovering),t.handleMessage(e);break}case eV.Event:case"webrtc.event":if(!d)return void g.error("Verto received an unknown event:",o);let v=n.relayProtocol,b=d.split(".")[0];n._existsSubscription(v,d)?$(v,o,d):d===n.sessionid?this._handleSessionEvent(o.eventData):n._existsSubscription(v,b)?$(v,o,b):n.calls.hasOwnProperty(d)?n.calls[d].handleMessage(e):$(ej.Notification,o,n.uuid);break;case eV.Info:o.type=A.generic,$(ej.Notification,o,n.uuid);break;case eV.ClientReady:this.session.execute(f);break;default:{let t=k(e);if(t){switch(t){case eK.REGISTER:case eK.REGED:n.connection.previousGatewayState!==eK.REGED&&n.connection.previousGatewayState!==eK.REGISTER&&(this.session._triggerKeepAliveTimeoutCheck(),e9.retriedRegister=0,o.type=A.vertoClientReady,$(ej.Ready,o,n.uuid),n.options.trickleIce&&(g.debug("Trickle ICE is enabled. Checking Gateway support"),this.session.execute(new ey({candidate:""})).catch(e=>{e.code===this.session.invalidMethodErrorCode?(console.warn("Trickle ICE is not supported by the server, disabling it."),g.debug("Trickle ICE check error:",JSON.stringify(e,null,2)),n.options.trickleIce=!1):g.debug("Trickle ICE check:",JSON.stringify(e,null,2))})));break;case eK.UNREGED:case eK.NOREG:if(e9.retriedRegister+=1,5===e9.retriedRegister){e9.retriedRegister=0,$(ej.Error,{error:new e6("Fail to register the user, the server tried 5 times","UNREGED|NOREG"),sessionId:n.sessionid},n.uuid);break}setTimeout(()=>{this.session.execute(f)},this.reconnectDelay());break;case eK.FAILED:case eK.FAIL_WAIT:if(n.connection.previousGatewayState!==eK.FAILED&&n.connection.previousGatewayState!==eK.FAIL_WAIT){if(!this.session.hasAutoReconnect()){e9.retriedConnect=0,$(ej.Error,{error:new e6("Fail to connect the server, the server tried 5 times","FAILED|FAIL_WAIT"),sessionId:n.sessionid},n.uuid);break}if(e9.retriedConnect+=1,5===e9.retriedConnect){e9.retriedConnect=0,$(ej.Error,{error:Error("Connection Retry Failed"),sessionId:n.sessionid},n.uuid);break}setTimeout(()=>{this.session.disconnect().then(()=>{this.session.clearConnection(),this.session.connect()})},this.reconnectDelay())}break;default:g.warn("GatewayState message unknown method:",e)}break}g.debug("Verto message unknown method:",e)}}}_retrieveCallId(e,t){let i=Object.keys(this.session.calls);if("bootObj"!==e.action)return i.find(e=>this.session.calls[e].channels.includes(t));{let t=e.data.find(e=>i.includes(e[0]));if(t instanceof Array)return t[0]}}_handlePvtEvent(e){return i(this,void 0,void 0,function*(){let{session:t}=this,i=t.relayProtocol,{action:n,laChannel:s,laName:r,chatChannel:o,infoChannel:a,modChannel:c,conferenceMemberID:d,role:l,callID:u}=e;switch(n){case"conference-liveArray-join":{let i=()=>{t.vertoBroadcast({nodeId:this.nodeId,channel:s,data:{liveArray:{command:"bootstrap",context:s,name:r}}})},n={nodeId:this.nodeId,channels:[s],handler:({data:n})=>{let o=u||this._retrieveCallId(n,s);if(o&&t.calls.hasOwnProperty(o)){let a=t.calls[o];a._addChannel(s),a.extension=r,a.handleConferenceUpdate(n,e).then(e=>{"INVALID_PACKET"===e&&i()})}}};en((yield t.vertoSubscribe(n).catch(e=>{g.error("liveArray subscription error:",e)})),s)&&i();break}case"conference-liveArray-part":{let e=null;if(s&&t._existsSubscription(i,s)){let{callId:n=null}=t.subscriptions[i][s];if(e=t.calls[n]||null,null!==n){let i={type:A.conferenceUpdate,action:eW.Leave,conferenceName:r,participantId:Number(d),role:l};$(ej.Notification,i,n,!1)||$(ej.Notification,i,t.uuid),null===e&&U(ej.Notification,null,n)}}let n=[s,o,a,c];t.vertoUnsubscribe({nodeId:this.nodeId,channels:n}).then(({unsubscribedChannels:t=[]})=>{e&&(e.channels=e.channels.filter(e=>!t.includes(e)))}).catch(e=>{g.error("liveArray unsubscribe error:",e)})}}})}_handleSessionEvent(e){switch(e.contentType){case"layout-info":case"layer-info":eT(this.session,e);break;case"logo-info":{let t={type:A.conferenceUpdate,action:eW.LogoInfo,logo:e.logoURL};$(ej.Notification,t,this.session.uuid)}}}}e9.retriedConnect=0,e9.retriedRegister=0,e9.receivedAuthenticationRequired=0;class e8 extends e3{constructor(e){super(e),this.relayProtocol="verto-protocol",this.timeoutErrorCode=-329990,this.handleLoginOnSocketOpen=()=>i(this,void 0,void 0,function*(){this._idle=!1;let{login:e,password:t,passwd:i,login_token:n,userVariables:s,autoReconnect:r=!0}=this.options,o=new ep(e,t||i,n,this.sessionid,s,!!x()),a=yield this.execute(o).catch(this._handleLoginError);a&&(this._autoReconnect=r,this.sessionid=a.sessid)}),this.handleAnonymousLoginOnSocketOpen=()=>i(this,void 0,void 0,function*(){this._idle=!1;let{anonymous_login:e}=this.options,t=new e4({target_id:e.target_id,target_type:e.target_type,target_version_id:e.target_version_id,sessionId:this.sessionid,userVariables:this.options.userVariables,reconnection:!!x()}),i=yield this.execute(t).catch(this._handleLoginError);i&&(this.sessionid=i.sessid)}),window.addEventListener("beforeunload",e=>{this.calls&&Object.keys(this.calls).forEach(e=>{this.calls[e]&&(g.info(`Hanging up call due to page unload: ${e}`),this.calls[e].hangup({},!0))})})}validateOptions(){return C(this.options)||I(this.options)}newCall(e){if(!this.validateCallOptions(e))throw Error("Verto.newCall() error: destinationNumber is required.");performance.mark("new-call-start");let t=new e2(this,e);return t.invite(),performance.mark("new-call-end"),t}broadcast(e){return this.vertoBroadcast(e)}subscribe(e){return this.vertoSubscribe(e)}unsubscribe(e){return this.vertoUnsubscribe(e)}validateCallOptions(e){return!!I(this.options)||!!e.destinationNumber}_onSocketOpen(){return i(this,void 0,void 0,function*(){return C(this.options)?this.handleLoginOnSocketOpen():I(this.options)?this.handleAnonymousLoginOnSocketOpen():void 0})}_onSocketMessage(e){new e9(this).handleMessage(e)}}class e5 extends e8{constructor(e){super(e),console.log(`SDK version: ${eh}`)}newCall(e){return super.newCall(e)}static webRTCInfo(){return function(){try{let{browserInfo:e,name:t,version:i,supportAudio:n,supportVideo:s}=function(){if(!window||!window.navigator||!window.navigator.userAgent)throw Error("You should use @telnyx/webrtc in a web browser such as Chrome|Firefox|Safari");if(navigator.userAgent.match(/chrom(e|ium)/gim)&&!navigator.userAgent.match(/OPR\/[0-9]{2}/gi)&&!navigator.userAgent.match(/edg/gim)){let e=navigator.userAgent.match(/chrom(e|ium)\/[0-9]+\./gim)[0].split("/"),t=e[0],i=parseInt(e[1],10);return{browserInfo:navigator.userAgent,name:t,version:i,supportAudio:!0,supportVideo:!0}}if(navigator.userAgent.match(/firefox/gim)&&!navigator.userAgent.match(/OPR\/[0-9]{2}/gi)&&!navigator.userAgent.match(/edg/gim)){let e=navigator.userAgent.match(/firefox\/[0-9]+\./gim)[0].split("/"),t=e[0],i=parseInt(e[1],10);return{browserInfo:navigator.userAgent,name:t,version:i,supportAudio:!0,supportVideo:!1}}if(navigator.userAgent.match(/safari/gim)&&!navigator.userAgent.match(/OPR\/[0-9]{2}/gi)&&!navigator.userAgent.match(/edg/gim)){let e=navigator.userAgent.match(/safari/gim)[0],t=navigator.userAgent.match(/version\/[0-9]+\./gim)[0].split("/"),i=parseInt(t[1],10);return{browserInfo:navigator.userAgent,name:e,version:i,supportAudio:!0,supportVideo:!0}}if(navigator.userAgent.match(/edg/gim)&&!navigator.userAgent.match(/OPR\/[0-9]{2}/gi)){let e=navigator.userAgent.match(/edg\/[0-9]+\./gim)[0].split("/"),t=e[0],i=parseInt(e[1],10);return{browserInfo:navigator.userAgent,name:t,version:i,supportAudio:!0,supportVideo:!0}}throw Error("This browser does not support @telnyx/webrtc. To see browser support list: `TelnyxRTC.webRTCSupportedBrowserList()`")}(),r=window.RTCPeerConnection,o=window.RTCSessionDescription,a=window.RTCIceCandidate,c=window.navigator&&window.navigator.mediaDevices,d=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia||navigator.mozGetUserMedia;return{browserInfo:e,browserName:t,browserVersion:i,supportWebRTC:!!(r&&o&&a&&c&&d),supportWebRTCAudio:n,supportWebRTCVideo:s,supportRTCPeerConnection:!!r,supportSessionDescription:!!o,supportIceCandidate:!!a,supportMediaDevices:!!c,supportGetUserMedia:!!Z}}catch(e){return e.message}}()}static webRTCSupportedBrowserList(){return[{operationSystem:"Android",supported:[{browserName:"Chrome",features:["audio"],supported:eJ.full},{browserName:"Firefox",features:["audio"],supported:eJ.partial},{browserName:"Safari",supported:eJ.not_supported},{browserName:"Edge",supported:eJ.not_supported}]},{operationSystem:"iOS",supported:[{browserName:"Chrome",supported:eJ.not_supported},{browserName:"Firefox",supported:eJ.not_supported},{browserName:"Safari",features:["video","audio"],supported:eJ.full},{browserName:"Edge",supported:eJ.not_supported}]},{operationSystem:"Linux",supported:[{browserName:"Chrome",features:["video","audio"],supported:eJ.full},{browserName:"Firefox",features:["audio"],supported:eJ.partial},{browserName:"Safari",supported:eJ.not_supported},{browserName:"Edge",supported:eJ.not_supported}]},{operationSystem:"MacOS",supported:[{browserName:"Chrome",features:["video","audio"],supported:eJ.full},{browserName:"Firefox",features:["audio"],supported:eJ.partial},{browserName:"Safari",features:["video","audio"],supported:eJ.full},{browserName:"Edge",features:["audio"],supported:eJ.partial}]},{operationSystem:"Windows",supported:[{browserName:"Chrome",features:["video","audio"],supported:eJ.full},{browserName:"Firefox",features:["audio"],supported:eJ.partial},{browserName:"Safari",supported:eJ.not_supported},{browserName:"Edge",features:["audio"],supported:eJ.partial}]}]}}var e7=e.i(970799);function te(e){let[t,i]=(0,e7.useState)(!1),[n,s]=(0,e7.useState)(!1),[r,o]=(0,e7.useState)(!1),[a,c]=(0,e7.useState)(null),[d,l]=(0,e7.useState)(0),[u,h]=(0,e7.useState)(null),[p,g]=(0,e7.useState)([]),f=(0,e7.useRef)(null),m=(0,e7.useRef)(null),v=(0,e7.useRef)(e),b=(0,e7.useRef)(null),y=(0,e7.useRef)(!0);(0,e7.useEffect)(()=>{v.current=e},[e]);let _=(0,e7.useCallback)(e=>{let t=Math.min(1e3*Math.pow(2,e),3e4),i=.3*t*Math.random();return Math.round(t+i)},[]),w=(0,e7.useCallback)(()=>{b.current&&clearTimeout(b.current),l(e=>{let t=e+1;if(t>5)return console.error(` WebRTC: Max reconnection attempts (5) reached`),o(!1),c("Connection lost. Max reconnection attempts (5) exceeded."),e;let n=_(t-1);return o(!0),b.current=setTimeout(async()=>{if(f.current){try{f.current.disconnect()}catch{}f.current=null}try{let e=v.current;if(e.username&&e.password){let t=new e5({login:e.username,password:e.password,debug:e.debug});t.on("telnyx.ready",()=>{i(!0),s(!1),o(!1),c(null),l(0)}),t.on("telnyx.error",e=>{console.error(" WebRTC: Reconnection error:",e),w()}),t.on("telnyx.socket.error",()=>{y.current&&w()}),t.on("telnyx.socket.close",()=>{i(!1),y.current&&w()}),f.current=t,await t.connect()}}catch(e){console.error(" WebRTC: Reconnection attempt failed:",e)}},n),t})},[_]),S=(0,e7.useCallback)(async()=>{if(l(0),y.current=!0,f.current){try{f.current.disconnect()}catch{}f.current=null}b.current&&(clearTimeout(b.current),b.current=null),o(!1);let e=v.current;if(e.username&&e.password){s(!0),c(null);try{let e=C();e&&await e.connect()}catch(e){console.error(" WebRTC: Manual reconnection failed:",e),c(e instanceof Error?e.message:"Reconnection failed"),s(!1)}}},[]),C=(0,e7.useCallback)(()=>{if(f.current)return f.current;let e=v.current;if(!(e.username&&e.password))return console.error(" WebRTC: Missing credentials, cannot initialize"),null;let t=new e5({login:e.username,password:e.password,ringtoneFile:void 0,ringbackFile:void 0,debug:e.debug});return t.on("telnyx.ready",()=>{i(!0),s(!1),o(!1),c(null),l(0)}),t.on("telnyx.error",e=>{console.error(" WebRTC: telnyx.error event:",e);let t=e?.error?.message||e?.message||e?.description||"Connection error";console.error(" WebRTC: Error message:",t),c(t),s(!1)}),t.on("telnyx.socket.error",e=>{console.error(" WebRTC: telnyx.socket.error event:",e),c("Socket connection failed"),s(!1),i(!1),y.current&&w()}),t.on("telnyx.socket.close",e=>{console.warn(" WebRTC: telnyx.socket.close event:",e),i(!1),y.current&&w()}),t.on("telnyx.notification",e=>{if("callUpdate"!==e.type)return;let t=e.call;if(!t)return void console.warn(" WebRTC: callUpdate notification with undefined call");let i=function(e){switch(e){case"new":case"requesting":return"connecting";case"trying":case"recovering":case"ringing":return"ringing";case"active":return"active";case"held":return"held";case"hangup":case"destroy":return"ended";default:return"idle"}}(t.state),n={id:t.id||"unknown",state:i,direction:"inbound"===t.direction?"inbound":"outbound",remoteNumber:t.remoteNumber||t.to||"Unknown",remoteName:t.remoteName,localNumber:t.localNumber||"",startTime:"active"===i?new Date:void 0,duration:0,isMuted:!1,isHeld:"held"===t.state,isRecording:!1};h(n),m.current=t,"inbound"===t.direction&&"ringing"===t.state&&v.current.onIncomingCall?.(n),("destroy"===t.state||"hangup"===t.state)&&(v.current.onCallEnded?.(n),h(null),m.current=null)}),f.current=t,t},[]),I=(0,e7.useCallback)(async()=>{try{s(!0),c(null);let e=C();if(!e){console.warn(" WebRTC: No credentials available, aborting connection"),s(!1);return}await e.connect()}catch(e){console.error(" WebRTC: Connection error in connect():",e),c(e instanceof Error?e.message:"Connection failed"),s(!1)}},[C]),k=(0,e7.useCallback)(()=>{y.current=!1,b.current&&(clearTimeout(b.current),b.current=null),f.current&&(f.current.disconnect(),f.current=null),i(!1),s(!1),o(!1),l(0),h(null),m.current=null},[]),E=(0,e7.useCallback)(async(e,i)=>{let n=e=>{let t=e.replace(/\D/g,"");return 10===t.length?`+1${t}`:11===t.length&&t.startsWith("1")||t.length>10&&!e.startsWith("+")?`+${t}`:e.startsWith("+")?e:`+${t}`},s=n(e),r=i?n(i):void 0;if(!(f.current&&t))throw console.error(" WebRTC makeCall: Not connected to Telnyx"),Error("Not connected to Telnyx");try{let t=await f.current.newCall({destinationNumber:s,callerNumber:r});m.current=t;let n={id:t.id,state:"connecting",direction:"outbound",remoteNumber:e,localNumber:i||"",duration:0,isMuted:!1,isHeld:!1,isRecording:!1};return h(n),t}catch(e){throw console.error(" WebRTC makeCall error:",e),e}},[t]),T=(0,e7.useCallback)(async()=>{if(!m.current)throw Error("No active call to answer");await m.current.answer()},[]),R=(0,e7.useCallback)(async()=>{if(!m.current)throw Error("No active call to end");await m.current.hangup(),h(null),m.current=null},[]),x=(0,e7.useCallback)(async()=>{if(!m.current)throw Error("No active call to mute");await m.current.muteAudio(),h(e=>e?{...e,isMuted:!0}:null)},[]),A=(0,e7.useCallback)(async()=>{if(!m.current)throw Error("No active call to unmute");await m.current.unmuteAudio(),h(e=>e?{...e,isMuted:!1}:null)},[]),O=(0,e7.useCallback)(async()=>{if(!m.current)throw Error("No active call to hold");await m.current.hold(),h(e=>e?{...e,isHeld:!0}:null)},[]),N=(0,e7.useCallback)(async()=>{if(!m.current)throw Error("No active call to unhold");await m.current.unhold(),h(e=>e?{...e,isHeld:!1}:null)},[]),M=(0,e7.useCallback)(async e=>{if(!m.current)throw Error("No active call");await m.current.dtmf(e)},[]),P=(0,e7.useCallback)(async e=>{if(!m.current)throw Error("No active call");await m.current.setAudioOutDevice(e)},[]),L=(0,e7.useCallback)(async()=>{if("undefined"!=typeof navigator&&navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices)try{let e=(await navigator.mediaDevices.enumerateDevices()).filter(e=>"audiooutput"===e.kind);g(e)}catch{}},[]);return(0,e7.useEffect)(()=>{if("undefined"==typeof navigator||!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return()=>{};L();let e=()=>{L()};return navigator.mediaDevices.addEventListener("devicechange",e),()=>{navigator.mediaDevices&&navigator.mediaDevices.removeEventListener("devicechange",e)}},[L]),(0,e7.useEffect)(()=>(v.current.autoConnect&&I(),()=>{k()}),[I,k]),{isConnected:t,isConnecting:n,isReconnecting:r,connectionError:a,reconnectAttempts:d,currentCall:u,makeCall:E,answerCall:T,endCall:R,muteCall:x,unmuteCall:A,holdCall:O,unholdCall:N,sendDTMF:M,connect:I,disconnect:k,reconnect:S,audioDevices:p,setAudioDevice:P}}e.s(["useTelnyxWebRTC",()=>te],468849)}]);