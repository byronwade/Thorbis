(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,999490,e=>{"use strict";var t=e.i(313550),r=e.i(111043),i=e.i(970799),n=e.i(904653),a=e.i(818796),s=e.i(751139),o=e.i(4975),l=e.i(907820),c=e.i(555251),c=c,d=e.i(512710),u=e.i(51866),m=e.i(87912),p=e.i(136764),h=e.i(964529),g=e.i(216622),g=g,f=e.i(15751),x=e.i(332845),b=e.i(939397),w=e.i(371526),y=e.i(160424),v=e.i(520824),j=e.i(287268),N=e.i(874283),z=e.i(849500),_=e.i(14435),S=e.i(202724),M=e.i(212409),C=e.i(181893),T=e.i(290583);let I="Thorbis-FMS/1.0 (support@thorbis.app)",R=T.z.object({lat:T.z.number(),lng:T.z.number()}),L=T.z.object({distance:T.z.number(),duration:T.z.number(),durationInTraffic:T.z.number(),from:R,to:R,polyline:T.z.string().optional(),summary:T.z.string().optional(),warnings:T.z.array(T.z.string()).optional(),trafficDelay:T.z.number()}),E=T.z.object({originIndex:T.z.number(),destinationIndex:T.z.number(),distance:T.z.number(),duration:T.z.number(),durationInTraffic:T.z.number(),status:T.z.enum(["OK","NOT_FOUND","ZERO_RESULTS"])}),k=T.z.object({elements:T.z.array(E),originAddresses:T.z.array(T.z.string()).optional(),destinationAddresses:T.z.array(T.z.string()).optional()}),A=T.z.object({totalDistance:T.z.number(),totalDuration:T.z.number(),totalDurationInTraffic:T.z.number(),optimizedOrder:T.z.array(T.z.number()),legs:T.z.array(T.z.object({from:R,to:R,distance:T.z.number(),duration:T.z.number(),durationInTraffic:T.z.number(),polyline:T.z.string().optional()})),polyline:T.z.string().optional()});class D{apiKey;routeCache=new Map;matrixCache=new Map;constructor(){this.apiKey=t.default.env.GOOGLE_API_KEY||"AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0"}isAvailable(){return!!this.apiKey}async getRoute(e,t){if(!this.apiKey)return console.warn("Google Routes Service: No API key configured"),this.getFallbackRoute(e,t);let r=`route:${e.lat.toFixed(5)},${e.lng.toFixed(5)}-${t.lat.toFixed(5)},${t.lng.toFixed(5)}`,i=this.routeCache.get(r);if(i&&Date.now()-i.timestamp<3e5)return i.data;try{let i=new URL("https://maps.googleapis.com/maps/api/directions/json");i.searchParams.set("origin",`${e.lat},${e.lng}`),i.searchParams.set("destination",`${t.lat},${t.lng}`),i.searchParams.set("departure_time","now"),i.searchParams.set("traffic_model","best_guess"),i.searchParams.set("key",this.apiKey);let n=await fetch(i.toString(),{headers:{"User-Agent":I}});if(!n.ok)return console.error(`Google Routes API error: ${n.status} ${n.statusText}`),this.getFallbackRoute(e,t);let a=await n.json();if("OK"!==a.status||!a.routes?.[0])return console.warn(`Google Routes API returned status: ${a.status}`),this.getFallbackRoute(e,t);let s=a.routes[0],o=s.legs[0],l=o.duration?.value||0,c=o.duration_in_traffic?.value||l,d={distance:o.distance?.value||0,duration:l,durationInTraffic:c,from:e,to:t,polyline:s.overview_polyline?.points,summary:s.summary,warnings:s.warnings||[],trafficDelay:Math.max(0,c-l)},u=L.parse(d);return this.routeCache.set(r,{data:u,timestamp:Date.now()}),this.cleanCache(this.routeCache,3e5),u}catch(r){return console.error("Google Routes Service error:",r),this.getFallbackRoute(e,t)}}async getRouteMatrix(e,t){if(!this.apiKey)return console.warn("Google Routes Service: No API key configured for matrix"),null;if(0===e.length||0===t.length)return null;let r=e.slice(0,25),i=t.slice(0,25),n=`matrix:${r.map(e=>`${e.lat.toFixed(4)},${e.lng.toFixed(4)}`).join("|")}-${i.map(e=>`${e.lat.toFixed(4)},${e.lng.toFixed(4)}`).join("|")}`,a=this.matrixCache.get(n);if(a&&Date.now()-a.timestamp<6e5)return a.data;try{let e=new URL("https://maps.googleapis.com/maps/api/distancematrix/json");e.searchParams.set("origins",r.map(e=>`${e.lat},${e.lng}`).join("|")),e.searchParams.set("destinations",i.map(e=>`${e.lat},${e.lng}`).join("|")),e.searchParams.set("departure_time","now"),e.searchParams.set("traffic_model","best_guess"),e.searchParams.set("key",this.apiKey);let t=await fetch(e.toString(),{headers:{"User-Agent":I}});if(!t.ok)return console.error(`Google Distance Matrix API error: ${t.status} ${t.statusText}`),null;let a=await t.json();if("OK"!==a.status)return console.warn(`Google Distance Matrix API status: ${a.status}`),null;let s=[];for(let e=0;e<a.rows.length;e++)for(let t=0;t<a.rows[e].elements.length;t++){let r=a.rows[e].elements[t],i=r.duration?.value||0,n=r.duration_in_traffic?.value||i;s.push({originIndex:e,destinationIndex:t,distance:r.distance?.value||0,duration:i,durationInTraffic:n,status:"OK"===r.status?"OK":"ZERO_RESULTS"===r.status?"ZERO_RESULTS":"NOT_FOUND"})}let o={elements:s,originAddresses:a.origin_addresses,destinationAddresses:a.destination_addresses},l=k.parse(o);return this.matrixCache.set(n,{data:l,timestamp:Date.now()}),this.cleanCache(this.matrixCache,6e5),l}catch(e){return console.error("Google Distance Matrix error:",e),null}}async getETA(e,t){let r=await this.getRoute(e,t);if(!r)return null;let i=new Date(new Date().getTime()+1e3*r.durationInTraffic),n=Math.ceil(r.durationInTraffic/60),a=Math.ceil(r.trafficDelay/60);return{eta:i,durationMinutes:n,durationText:this.formatDuration(r.durationInTraffic),trafficDelayMinutes:a}}async rankTechniciansByETA(e,t){if(0===e.length)return[];let r=e.map(e=>e.location),i=await this.getRouteMatrix(r,[t]);return i?e.map((e,t)=>{let r=i.elements.find(e=>e.originIndex===t&&0===e.destinationIndex);return r&&"OK"===r.status?{id:e.id,name:e.name,etaMinutes:Math.ceil(r.durationInTraffic/60),distanceKm:r.distance/1e3,trafficDelayMinutes:Math.ceil((r.durationInTraffic-r.duration)/60)}:{id:e.id,name:e.name,etaMinutes:1/0,distanceKm:0,trafficDelayMinutes:0}}).sort((e,t)=>e.etaMinutes-t.etaMinutes):(await Promise.all(e.map(async e=>{let r=await this.getRoute(e.location,t);return{id:e.id,name:e.name,etaMinutes:r?Math.ceil(r.durationInTraffic/60):1/0,distanceKm:r?r.distance/1e3:0,trafficDelayMinutes:r?Math.ceil(r.trafficDelay/60):0}}))).sort((e,t)=>e.etaMinutes-t.etaMinutes)}async getMultiStopRoute(e,t,r=!1){if(0===t.length)return null;if(1===t.length){let r=await this.getRoute(e,t[0]);return r?{totalDistance:r.distance,totalDuration:r.duration,totalDurationInTraffic:r.durationInTraffic,optimizedOrder:[0],legs:[{from:e,to:t[0],distance:r.distance,duration:r.duration,durationInTraffic:r.durationInTraffic,polyline:r.polyline}],polyline:r.polyline}:null}let i=[e,...t],n=await this.getRouteMatrix(i,i);if(!n)return this.getSequentialRoute(e,t,r);let a=new Set,s=[],o=0;for(;s.length<t.length;){let e=-1,r=1/0;for(let i=1;i<=t.length;i++){if(a.has(i))continue;let t=n.elements.find(e=>e.originIndex===o&&e.destinationIndex===i);t&&"OK"===t.status&&t.durationInTraffic<r&&(r=t.durationInTraffic,e=i)}if(-1===e)break;a.add(e),s.push(e-1),o=e}let l=[],c=0,d=0,u=0,m=e;for(let e of s){let r=t[e],i=await this.getRoute(m,r);i&&(l.push({from:m,to:r,distance:i.distance,duration:i.duration,durationInTraffic:i.durationInTraffic,polyline:i.polyline}),c+=i.distance,d+=i.duration,u+=i.durationInTraffic),m=r}if(r&&l.length>0){let t=await this.getRoute(m,e);t&&(l.push({from:m,to:e,distance:t.distance,duration:t.duration,durationInTraffic:t.durationInTraffic,polyline:t.polyline}),c+=t.distance,d+=t.duration,u+=t.durationInTraffic)}return A.parse({totalDistance:c,totalDuration:d,totalDurationInTraffic:u,optimizedOrder:s,legs:l})}async getSequentialRoute(e,t,r){let i=[],n=0,a=0,s=0,o=e;for(let e=0;e<t.length;e++){let r=await this.getRoute(o,t[e]);r&&(i.push({from:o,to:t[e],distance:r.distance,duration:r.duration,durationInTraffic:r.durationInTraffic,polyline:r.polyline}),n+=r.distance,a+=r.duration,s+=r.durationInTraffic),o=t[e]}if(r){let t=await this.getRoute(o,e);t&&(i.push({from:o,to:e,distance:t.distance,duration:t.duration,durationInTraffic:t.durationInTraffic,polyline:t.polyline}),n+=t.distance,a+=t.duration,s+=t.durationInTraffic)}return{totalDistance:n,totalDuration:a,totalDurationInTraffic:s,optimizedOrder:t.map((e,t)=>t),legs:i}}getFallbackRoute(e,t){let r=this.calculateHaversineDistance(e,t),i=Math.round(r/4e4*3600);return{distance:Math.round(r),duration:i,durationInTraffic:i,from:e,to:t,trafficDelay:0,warnings:["Using estimated route - Google API unavailable"]}}calculateHaversineDistance(e,t){let r=e.lat*Math.PI/180,i=t.lat*Math.PI/180,n=(t.lat-e.lat)*Math.PI/180,a=(t.lng-e.lng)*Math.PI/180,s=Math.sin(n/2)*Math.sin(n/2)+Math.cos(r)*Math.cos(i)*Math.sin(a/2)*Math.sin(a/2);return 2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))*6371e3}formatDuration(e){if(e<60)return`${Math.round(e)} sec`;if(e<3600)return`${Math.round(e/60)} min`;let t=Math.floor(e/3600),r=Math.round(e%3600/60);return`${t}h ${r}min`}formatDistance(e){return e<1e3?`${Math.round(e)} m`:`${(e/1e3*.621371).toFixed(1)} mi`}cleanCache(e,t){let r=Date.now();for(let[i,n]of e.entries())r-n.timestamp>2*t&&e.delete(i);if(e.size>500){let t=Array.from(e.entries());for(let[r,i]of(t.sort((e,t)=>t[1].timestamp-e[1].timestamp),e.clear(),t.slice(0,250)))e.set(r,i)}}clearCache(){this.routeCache.clear(),this.matrixCache.clear()}}let O=new D,$="Thorbis-FMS/1.0 (support@thorbis.app)",F=T.z.object({code:T.z.string(),description:T.z.string(),icon:T.z.string()}),P=T.z.object({temperature:T.z.number(),temperatureFeelsLike:T.z.number(),humidity:T.z.number(),pressure:T.z.number(),windSpeed:T.z.number(),windDirection:T.z.number(),windGust:T.z.number().optional(),visibility:T.z.number().optional(),uvIndex:T.z.number().optional(),cloudCover:T.z.number().optional(),precipitation:T.z.number().optional(),condition:F,observationTime:T.z.string()}),W=T.z.object({time:T.z.string(),temperature:T.z.number(),temperatureFeelsLike:T.z.number(),humidity:T.z.number(),windSpeed:T.z.number(),windDirection:T.z.number(),precipitationProbability:T.z.number(),precipitationAmount:T.z.number().optional(),condition:F,uvIndex:T.z.number().optional(),solarRadiation:T.z.number().optional()}),U=T.z.object({date:T.z.string(),temperatureHigh:T.z.number(),temperatureLow:T.z.number(),humidity:T.z.number(),windSpeed:T.z.number(),windDirection:T.z.number(),precipitationProbability:T.z.number(),precipitationAmount:T.z.number().optional(),condition:F,uvIndexMax:T.z.number().optional(),sunrise:T.z.string().optional(),sunset:T.z.string().optional(),moonPhase:T.z.string().optional(),solarRadiation:T.z.number().optional()}),K=T.z.object({event:T.z.string(),headline:T.z.string(),description:T.z.string(),severity:T.z.enum(["Extreme","Severe","Moderate","Minor","Unknown"]),urgency:T.z.enum(["Immediate","Expected","Future","Past","Unknown"]),start:T.z.string().optional(),end:T.z.string().optional(),instruction:T.z.string().optional(),source:T.z.string().optional()});T.z.object({location:T.z.object({lat:T.z.number(),lng:T.z.number(),name:T.z.string().optional(),timezone:T.z.string().optional()}),current:P.optional(),hourly:T.z.array(W).optional(),daily:T.z.array(U).optional(),alerts:T.z.array(K),source:T.z.enum(["google","nws","openmeteo"]),enrichedAt:T.z.string()});class G{apiKey;cache=new Map;constructor(){this.apiKey=t.default.env.GOOGLE_API_KEY||"AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0"}isAvailable(){return!!this.apiKey}async getWeatherData(e,t){let r=`weather:${e.toFixed(4)},${t.toFixed(4)}`,i=this.cache.get(r);if(i&&Date.now()-i.timestamp<18e5)return i.data;try{let i=await this.fetchFromOpenMeteo(e,t);if(i)return this.cache.set(r,{data:i,timestamp:Date.now()}),this.cleanCache(),i;if(this.isUSLocation(e,t)){let i=await this.fetchFromNWS(e,t);if(i)return this.cache.set(r,{data:i,timestamp:Date.now()}),i}return null}catch(e){return console.error("Weather service error:",e),null}}async fetchFromOpenMeteo(e,t){try{let r=new URL("https://api.open-meteo.com/v1/forecast");r.searchParams.set("latitude",e.toString()),r.searchParams.set("longitude",t.toString()),r.searchParams.set("current","temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,cloud_cover,pressure_msl,wind_speed_10m,wind_direction_10m,wind_gusts_10m,uv_index"),r.searchParams.set("hourly","temperature_2m,relative_humidity_2m,apparent_temperature,precipitation_probability,precipitation,weather_code,wind_speed_10m,wind_direction_10m,uv_index,direct_radiation"),r.searchParams.set("daily","weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,wind_speed_10m_max,wind_direction_10m_dominant,uv_index_max,sunrise,sunset"),r.searchParams.set("timezone","auto"),r.searchParams.set("forecast_days","10");let i=await fetch(r.toString(),{headers:{"User-Agent":$}});if(!i.ok)return console.error(`Open-Meteo API error: ${i.status}`),null;let n=await i.json(),a={temperature:n.current.temperature_2m,temperatureFeelsLike:n.current.apparent_temperature,humidity:n.current.relative_humidity_2m,pressure:n.current.pressure_msl,windSpeed:n.current.wind_speed_10m/3.6,windDirection:n.current.wind_direction_10m,windGust:n.current.wind_gusts_10m?n.current.wind_gusts_10m/3.6:void 0,uvIndex:n.current.uv_index,cloudCover:n.current.cloud_cover,precipitation:n.current.precipitation,condition:this.getConditionFromCode(n.current.weather_code),observationTime:n.current.time},s=[],o=Math.min(48,n.hourly.time.length);for(let e=0;e<o;e++)s.push({time:n.hourly.time[e],temperature:n.hourly.temperature_2m[e],temperatureFeelsLike:n.hourly.apparent_temperature[e],humidity:n.hourly.relative_humidity_2m[e],windSpeed:n.hourly.wind_speed_10m[e]/3.6,windDirection:n.hourly.wind_direction_10m[e],precipitationProbability:n.hourly.precipitation_probability[e],precipitationAmount:n.hourly.precipitation[e],condition:this.getConditionFromCode(n.hourly.weather_code[e]),uvIndex:n.hourly.uv_index[e],solarRadiation:n.hourly.direct_radiation?.[e]});let l=[];for(let e=0;e<n.daily.time.length;e++)l.push({date:n.daily.time[e],temperatureHigh:n.daily.temperature_2m_max[e],temperatureLow:n.daily.temperature_2m_min[e],humidity:0,windSpeed:n.daily.wind_speed_10m_max[e]/3.6,windDirection:n.daily.wind_direction_10m_dominant[e],precipitationProbability:n.daily.precipitation_probability_max[e],precipitationAmount:n.daily.precipitation_sum[e],condition:this.getConditionFromCode(n.daily.weather_code[e]),uvIndexMax:n.daily.uv_index_max[e],sunrise:n.daily.sunrise[e],sunset:n.daily.sunset[e]});return{location:{lat:e,lng:t,timezone:n.timezone},current:a,hourly:s,daily:l,alerts:[],source:"openmeteo",enrichedAt:new Date().toISOString()}}catch(e){return console.error("Open-Meteo fetch error:",e),null}}async fetchFromNWS(e,t){try{let r=await fetch(`https://api.weather.gov/points/${e.toFixed(4)},${t.toFixed(4)}`,{headers:{"User-Agent":$,Accept:"application/geo+json"}});if(!r.ok)return null;let i=(await r.json()).properties,[n,a]=await Promise.all([fetch(i.forecast,{headers:{"User-Agent":$,Accept:"application/geo+json"}}),fetch(`https://api.weather.gov/alerts/active?point=${e},${t}`,{headers:{"User-Agent":$,Accept:"application/geo+json"}})]),s=n.ok?await n.json():null,o=a.ok?await a.json():null,l=(o?.features||[]).map(e=>({event:e.properties.event||"Unknown",headline:e.properties.headline||"",description:e.properties.description||"",severity:this.mapNWSSeverity(e.properties.severity),urgency:this.mapNWSUrgency(e.properties.urgency),start:e.properties.onset,end:e.properties.expires,instruction:e.properties.instruction,source:"NWS"})),c=[];if(s?.properties?.periods){let e=s.properties.periods;for(let t=0;t<e.length;t+=2){let r=e[t],i=e[t+1];c.push({date:r.startTime.split("T")[0],temperatureHigh:r.isDaytime?r.temperature:i?.temperature||r.temperature,temperatureLow:i?.temperature||r.temperature,humidity:0,windSpeed:this.parseWindSpeed(r.windSpeed),windDirection:this.parseWindDirection(r.windDirection),precipitationProbability:0,condition:this.mapNWSCondition(r.shortForecast),uvIndexMax:void 0})}}return{location:{lat:e,lng:t,name:i.relativeLocation?.properties?.city,timezone:i.timeZone},daily:c,alerts:l,source:"nws",enrichedAt:new Date().toISOString()}}catch(e){return console.error("NWS fetch error:",e),null}}getConditionFromCode(e){return({0:{code:"CLEAR",description:"Clear sky",icon:"01d"},1:{code:"MOSTLY_CLEAR",description:"Mostly clear",icon:"02d"},2:{code:"PARTLY_CLOUDY",description:"Partly cloudy",icon:"03d"},3:{code:"OVERCAST",description:"Overcast",icon:"04d"},45:{code:"FOG",description:"Foggy",icon:"50d"},48:{code:"FOG",description:"Freezing fog",icon:"50d"},51:{code:"DRIZZLE",description:"Light drizzle",icon:"09d"},53:{code:"DRIZZLE",description:"Moderate drizzle",icon:"09d"},55:{code:"DRIZZLE",description:"Dense drizzle",icon:"09d"},56:{code:"FREEZING_DRIZZLE",description:"Freezing drizzle",icon:"09d"},57:{code:"FREEZING_DRIZZLE",description:"Dense freezing drizzle",icon:"09d"},61:{code:"RAIN",description:"Light rain",icon:"10d"},63:{code:"RAIN",description:"Moderate rain",icon:"10d"},65:{code:"RAIN",description:"Heavy rain",icon:"10d"},66:{code:"FREEZING_RAIN",description:"Freezing rain",icon:"13d"},67:{code:"FREEZING_RAIN",description:"Heavy freezing rain",icon:"13d"},71:{code:"SNOW",description:"Light snow",icon:"13d"},73:{code:"SNOW",description:"Moderate snow",icon:"13d"},75:{code:"SNOW",description:"Heavy snow",icon:"13d"},77:{code:"SNOW_GRAINS",description:"Snow grains",icon:"13d"},80:{code:"RAIN_SHOWERS",description:"Light rain showers",icon:"09d"},81:{code:"RAIN_SHOWERS",description:"Moderate rain showers",icon:"09d"},82:{code:"RAIN_SHOWERS",description:"Heavy rain showers",icon:"09d"},85:{code:"SNOW_SHOWERS",description:"Light snow showers",icon:"13d"},86:{code:"SNOW_SHOWERS",description:"Heavy snow showers",icon:"13d"},95:{code:"THUNDERSTORM",description:"Thunderstorm",icon:"11d"},96:{code:"THUNDERSTORM",description:"Thunderstorm with hail",icon:"11d"},99:{code:"THUNDERSTORM",description:"Severe thunderstorm",icon:"11d"}})[e]||{code:"UNKNOWN",description:"Unknown",icon:"03d"}}mapNWSCondition(e){let t=e.toLowerCase();return t.includes("thunder")?{code:"THUNDERSTORM",description:e,icon:"11d"}:t.includes("snow")?{code:"SNOW",description:e,icon:"13d"}:t.includes("rain")||t.includes("showers")?{code:"RAIN",description:e,icon:"10d"}:t.includes("cloudy")||t.includes("overcast")?{code:"CLOUDY",description:e,icon:"04d"}:t.includes("partly")?{code:"PARTLY_CLOUDY",description:e,icon:"03d"}:t.includes("clear")||t.includes("sunny")?{code:"CLEAR",description:e,icon:"01d"}:{code:"UNKNOWN",description:e,icon:"03d"}}mapNWSSeverity(e){switch(e?.toLowerCase()){case"extreme":return"Extreme";case"severe":return"Severe";case"moderate":return"Moderate";case"minor":return"Minor";default:return"Unknown"}}mapNWSUrgency(e){switch(e?.toLowerCase()){case"immediate":return"Immediate";case"expected":return"Expected";case"future":return"Future";case"past":return"Past";default:return"Unknown"}}parseWindSpeed(e){let t=e.match(/(\d+)\s*(?:to\s*(\d+))?\s*mph/i);if(t){let e=parseInt(t[1]),r=t[2]?parseInt(t[2]):e;return(e+r)/2*.44704}return 0}parseWindDirection(e){return({N:0,NNE:22.5,NE:45,ENE:67.5,E:90,ESE:112.5,SE:135,SSE:157.5,S:180,SSW:202.5,SW:225,WSW:247.5,W:270,WNW:292.5,NW:315,NNW:337.5})[e.toUpperCase()]||0}isUSLocation(e,t){return e>=24.5&&e<=49.5&&t>=-125&&t<=-66.9||e>=51&&e<=71.5&&t>=-180&&t<=-130||e>=18.5&&e<=22.5&&t>=-161&&t<=-154}isSuitableForOutdoorWork(e){let t=e.alerts.filter(e=>"Extreme"===e.severity||"Severe"===e.severity);if(t.length>0)return{suitable:!1,reason:t[0].headline||t[0].event,severity:"high"};if(e.current){let{condition:t,temperature:r,windSpeed:i}=e.current;if("THUNDERSTORM"===t.code||t.code.includes("FREEZING"))return{suitable:!1,reason:t.description,severity:"high"};if(r<-10)return{suitable:!1,reason:"Extreme cold (-10°C or below)",severity:"high"};if(r>40)return{suitable:!1,reason:"Extreme heat (40°C or above)",severity:"high"};if(i>20)return{suitable:!1,reason:"High winds",severity:"medium"};if("RAIN"===t.code||"SNOW"===t.code)return{suitable:!0,reason:t.description,severity:"medium"};if(r<0||r>35)return{suitable:!0,reason:`Temperature: ${Math.round(r)}\xb0C`,severity:"low"}}return{suitable:!0,severity:"none"}}getWeatherSummary(e){let t=e.current,r=this.isSuitableForOutdoorWork(e);return{temperature:t?`${Math.round(t.temperature)}\xb0C / ${Math.round(1.8*t.temperature+32)}\xb0F`:"N/A",condition:t?.condition.description||"Unknown",icon:t?.condition.icon||"03d",feelsLike:t?`${Math.round(t.temperatureFeelsLike)}\xb0C`:"N/A",humidity:t?`${Math.round(t.humidity)}%`:"N/A",wind:t?`${Math.round(2.237*t.windSpeed)} mph`:"N/A",alerts:e.alerts.length,suitableForWork:r.suitable}}cleanCache(){let e=Date.now();for(let[t,r]of this.cache.entries())e-r.timestamp>36e5&&this.cache.delete(t);if(this.cache.size>100){let e=Array.from(this.cache.entries());for(let[t,r]of(e.sort((e,t)=>t[1].timestamp-e[1].timestamp),this.cache.clear(),e.slice(0,50)))this.cache.set(t,r)}}clearCache(){this.cache.clear()}}let H=new G;var J=e.i(152088);e.i(553153);var Z=e.i(363712);e.i(889265);var B=e.i(677607);e.i(254851);var q=e.i(605278);e.i(51478);var Y=e.i(635613);e.i(670258);var V=e.i(921251);e.i(254978);var Q=e.i(375308);e.i(794747);var X=e.i(513990),ee=e.i(830891),et=e.i(373915);function er(e){return Math.PI/180*e}async function ei(e){return"undefined"!=typeof google&&google.maps?new Promise(t=>{new google.maps.Geocoder().geocode({location:{lat:e.lat,lng:e.lng}},(e,r)=>{r===google.maps.GeocoderStatus.OK&&e?.[0]?t(e[0].formatted_address):t(null)})}):null}class en extends i.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("Map error caught:",e,t)}render(){return this.state.hasError?this.props.fallback||(0,r.jsx)("div",{className:"flex h-full w-full items-center justify-center bg-muted",children:(0,r.jsxs)("div",{className:"text-center max-w-md p-6",children:[(0,r.jsx)("div",{className:"mx-auto h-12 w-12 text-amber-500 mb-4",children:"⚠️"}),(0,r.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Map Error"}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground mb-4",children:this.state.error?.message||"An error occurred while loading the map."}),(0,r.jsx)("button",{onClick:()=>this.setState({hasError:!1,error:null}),className:"px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm",children:"Try Again"})]})}):this.props.children}}let ea=!1,es=!1,eo=[],el={available:{bg:"bg-emerald-500",text:"text-emerald-500",border:"border-emerald-500"},active:{bg:"bg-emerald-500",text:"text-emerald-500",border:"border-emerald-500"},"on-job":{bg:"bg-blue-500",text:"text-blue-500",border:"border-blue-500"},"in-transit":{bg:"bg-amber-500",text:"text-amber-500",border:"border-amber-500"},"on-break":{bg:"bg-orange-500",text:"text-orange-500",border:"border-orange-500"},offline:{bg:"bg-gray-400",text:"text-gray-400",border:"border-gray-400"},inactive:{bg:"bg-gray-400",text:"text-gray-400",border:"border-gray-400"}},ec={pending:"#f59e0b",scheduled:"#3b82f6",dispatched:"#8b5cf6","in-progress":"#10b981",completed:"#6b7280",cancelled:"#ef4444"},ed={emergency:{bg:"bg-red-500/20",text:"text-red-500"},high:{bg:"bg-orange-500/20",text:"text-orange-500"},normal:{bg:"bg-blue-500/20",text:"text-blue-500"},low:{bg:"bg-gray-500/20",text:"text-gray-500"}};function eu(e){return e?e.split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2):"??"}function em(e){let t=e.property,r=e.customer;return t?.address?`${t.address}, ${t.city||""} ${t.state||""}`.trim():r?.address?`${r.address}, ${r.city||""} ${r.state||""}`.trim():"No address"}function ep(e){return e.property?.lat&&e.property?.lon?{lat:e.property.lat,lng:e.property.lon}:e.customer?.lat&&e.customer?.lon?{lat:e.customer.lat,lng:e.customer.lon}:null}function eh({tech:e,isSelected:t,onClick:i}){let n=el[e.status]||el.offline,a=!!e.gpsLocation,s=e.gpsLocation?.battery_level;return(0,r.jsxs)("div",{className:(0,J.cn)("flex items-center gap-3 p-3 cursor-pointer transition-all","hover:bg-accent/50 border-b border-border/50",t&&"bg-accent"),onClick:i,children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsxs)(V.Avatar,{className:"h-10 w-10",children:[(0,r.jsx)(V.AvatarImage,{src:e.avatar||void 0}),(0,r.jsx)(V.AvatarFallback,{className:"bg-muted text-sm",children:eu(e.name)})]}),(0,r.jsx)("div",{className:(0,J.cn)("absolute -bottom-0.5 -right-0.5 h-3.5 w-3.5 rounded-full border-2 border-background",n.bg)})]}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"font-medium text-sm truncate",children:e.name}),a&&(0,r.jsx)(N.Signal,{className:"h-3 w-3 text-emerald-500 flex-shrink-0"})]}),(0,r.jsx)("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:e.currentJob?(0,r.jsx)("span",{className:"truncate",children:e.currentJob.title}):e.nextJob?(0,r.jsxs)("span",{className:"truncate",children:["Next: ",e.nextJob.title]}):(0,r.jsx)("span",{children:"No jobs scheduled"})}),e.etaToNextJob&&e.nextJob&&(0,r.jsxs)("div",{className:"flex items-center gap-1 text-xs text-blue-500 mt-0.5",children:[(0,r.jsx)(x.Navigation,{className:"h-3 w-3"}),(0,r.jsxs)("span",{children:[e.etaToNextJob.durationMinutes," min (",e.etaToNextJob.distanceKm.toFixed(1)," km)"]})]})]}),(0,r.jsxs)("div",{className:"flex flex-col items-end gap-1",children:[(0,r.jsx)(Z.Badge,{variant:"outline",className:(0,J.cn)("text-[10px] px-1.5 py-0",n.border,n.text),children:"on-job"===e.status?"On Job":e.status}),null!=s&&(0,r.jsxs)("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[s<20?(0,r.jsx)(l.BatteryLow,{className:"h-3 w-3 text-red-500"}):s<50?(0,r.jsx)(c.default,{className:"h-3 w-3 text-amber-500"}):(0,r.jsx)(o.Battery,{className:"h-3 w-3 text-emerald-500"}),(0,r.jsxs)("span",{children:[Math.round(s),"%"]})]})]})]})}function eg({tech:e,onClose:t,onNavigate:i}){if(!e)return null;let n=el[e.status]||el.offline;return(0,r.jsx)("div",{className:"absolute bottom-0 left-0 right-0 z-20 bg-background border-t shadow-lg animate-in slide-in-from-bottom duration-300",children:(0,r.jsxs)("div",{className:"max-w-4xl mx-auto p-4",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between mb-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsxs)(V.Avatar,{className:"h-14 w-14",children:[(0,r.jsx)(V.AvatarImage,{src:e.avatar||void 0}),(0,r.jsx)(V.AvatarFallback,{className:"text-lg",children:eu(e.name)})]}),(0,r.jsx)("div",{className:(0,J.cn)("absolute -bottom-1 -right-1 h-4 w-4 rounded-full border-2 border-background",n.bg)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-lg font-semibold",children:e.name}),(0,r.jsxs)("div",{className:"flex items-center gap-3 text-sm text-muted-foreground",children:[(0,r.jsx)("span",{className:"capitalize",children:e.role?.replace(/_/g," ")}),e.gpsLocation&&(0,r.jsxs)("span",{className:"flex items-center gap-1",children:[(0,r.jsx)(N.Signal,{className:"h-3 w-3 text-emerald-500"}),function(e){let t=new Date,r="string"==typeof e?new Date(e):e,i=Math.floor((t.getTime()-r.getTime())/6e4);if(i<1)return"Just now";if(1===i)return"1 min ago";if(i<60)return`${i} mins ago`;let n=Math.floor(i/60);return 1===n?"1 hour ago":n<24?`${n} hours ago`:"Over a day ago"}(e.gpsLocation.updated_at)]})]})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)(B.Button,{variant:"outline",size:"sm",onClick:i,children:[(0,r.jsx)(_.User,{className:"h-4 w-4 mr-2"}),"View Schedule"]}),e.phone&&(0,r.jsx)(B.Button,{variant:"outline",size:"sm",asChild:!0,children:(0,r.jsxs)("a",{href:`tel:${e.phone}`,children:[(0,r.jsx)(b.Phone,{className:"h-4 w-4 mr-2"}),"Call"]})}),(0,r.jsx)(B.Button,{variant:"ghost",size:"icon",onClick:t,children:(0,r.jsx)(M.X,{className:"h-4 w-4"})})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,r.jsx)(q.Card,{className:"bg-muted/30",children:(0,r.jsxs)(q.CardContent,{className:"p-4",children:[(0,r.jsx)("div",{className:"text-sm text-muted-foreground mb-1",children:"Today's Jobs"}),(0,r.jsx)("div",{className:"text-2xl font-bold",children:e.appointments.length}),(0,r.jsxs)("div",{className:"text-xs text-muted-foreground",children:[e.appointments.filter(e=>"completed"===e.status).length," completed"]})]})}),(0,r.jsx)(q.Card,{className:"md:col-span-2 bg-muted/30",children:(0,r.jsx)(q.CardContent,{className:"p-4",children:e.currentJob?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-1",children:[(0,r.jsx)(C.Zap,{className:"h-3 w-3"}),"Current Job"]}),(0,r.jsx)("div",{className:"font-medium",children:e.currentJob.title}),(0,r.jsxs)("div",{className:"text-sm text-muted-foreground flex items-center gap-1",children:[(0,r.jsx)(f.MapPin,{className:"h-3 w-3"}),em(e.currentJob)]})]}):e.nextJob?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-1",children:[(0,r.jsx)(p.Clock,{className:"h-3 w-3"}),"Next Job"]}),(0,r.jsx)("div",{className:"font-medium",children:e.nextJob.title}),(0,r.jsxs)("div",{className:"text-sm text-muted-foreground flex items-center gap-1",children:[(0,r.jsx)(f.MapPin,{className:"h-3 w-3"}),em(e.nextJob)]})]}):(0,r.jsx)("div",{className:"text-muted-foreground",children:"No upcoming jobs scheduled"})})})]})]})})}function ef({jobs:e,isOpen:t,onToggle:i,onJobSelect:n}){return 0===e.length?null:(0,r.jsx)("div",{className:"absolute top-4 right-4 z-10",children:(0,r.jsxs)(q.Card,{className:(0,J.cn)("transition-all duration-300",t?"w-80":"w-auto"),children:[(0,r.jsx)(q.CardHeader,{className:"p-3 cursor-pointer hover:bg-accent/50",onClick:i,children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(a.AlertCircle,{className:"h-4 w-4 text-amber-500"}),(0,r.jsxs)("span",{className:"text-sm font-medium",children:["Unassigned (",e.length,")"]})]}),(0,r.jsx)(d.ChevronDown,{className:(0,J.cn)("h-4 w-4 transition-transform",t&&"rotate-180")})]})}),t&&(0,r.jsx)(q.CardContent,{className:"p-0",children:(0,r.jsx)(Q.ScrollArea,{className:"max-h-64",children:e.slice(0,10).map(e=>{let t=ed[e.priority||"normal"];return(0,r.jsx)("div",{className:"p-3 border-t cursor-pointer hover:bg-accent/50",onClick:()=>n(e),children:(0,r.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("div",{className:"font-medium text-sm truncate",children:e.title}),(0,r.jsx)("div",{className:"text-xs text-muted-foreground truncate",children:e.customer?.display_name})]}),e.priority&&(0,r.jsx)(Z.Badge,{variant:"outline",className:(0,J.cn)("text-[10px]",t?.bg,t?.text),children:e.priority})]})},e.id)})})})]})})}function ex({technicians:e,gpsLocations:t,appointments:a,unassignedJobs:o,companyId:l}){let c=(0,n.useRouter)(),d=(0,i.useRef)(null),p=(0,i.useRef)(null),f=(0,i.useRef)(new Map),x=(0,i.useRef)(new Map),b=(0,i.useRef)(null),[N,_]=(0,i.useState)(!1),[M,C]=(0,i.useState)(null),[T,I]=(0,i.useState)(!0),[R,L]=(0,i.useState)(null),[E,k]=(0,i.useState)(null),[A,D]=(0,i.useState)(!1),[$,F]=(0,i.useState)(""),[P,W]=(0,i.useState)(new Map(t.map(e=>[e.technician_id,e]))),[U,K]=(0,i.useState)(!1),[G,V]=(0,i.useState)(null),[en,ed]=(0,i.useState)([]),[ex,eb]=(0,i.useState)(null),[ew,ey]=(0,i.useState)(new Map),[ev,ej]=(0,i.useState)(!1),eN="AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0",ez=(0,i.useMemo)(()=>e.map(e=>({id:e.id,name:e.name,avatar:e.avatar})),[e]),e_=(0,i.useCallback)(async e=>{if(!e.latLng)return;let t=e.latLng.lat(),r=e.latLng.lng(),i=await ei({lat:t,lng:r});V({lat:t,lng:r,address:i||void 0});let n=[];for(let e of o)if(e.customer){let t=e.property?.lat&&e.property?.lon?{lat:e.property.lat,lng:e.property.lon}:e.customer?.lat&&e.customer?.lon?{lat:e.customer.lat,lng:e.customer.lon}:null;t&&n.push({id:e.customer.id,display_name:e.customer.display_name,phone:e.customer.phone||void 0,lat:t.lat,lng:t.lng})}let a=function(e,t,r=5){let i=[];for(let n of t){let t=n.lng??n.lon;if(null==n.lat||null==t)continue;let a=function(e,t){let r=er(t.lat-e.lat),i=er(t.lng-e.lng),n=Math.sin(r/2)*Math.sin(r/2)+Math.cos(er(e.lat))*Math.cos(er(t.lat))*Math.sin(i/2)*Math.sin(i/2);return 2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n))*3959}(e,{lat:n.lat,lng:t});a<=r&&i.push({...n,distance:a})}return i.sort((e,t)=>e.distance-t.distance)}({lat:t,lng:r},n,5),s=new Map;for(let e of a)s.has(e.id)||s.set(e.id,{id:e.id,display_name:e.display_name,phone:e.phone});ed(Array.from(s.values()).slice(0,5)),K(!0)},[o]);(0,i.useEffect)(()=>{b.current=e_},[e_]);let eS=(0,i.useMemo)(()=>e.map(e=>{let t=P.get(e.id),r=a.filter(t=>t.assigned_technician_ids?.includes(e.id));r.sort((e,t)=>new Date(e.scheduled_start).getTime()-new Date(t.scheduled_start).getTime());let i=r.find(e=>"in-progress"===e.status||"arrived"===e.status),n=r.find(e=>"scheduled"===e.status||"dispatched"===e.status),s=ew.get(e.id);return{...e,gpsLocation:t,appointments:r,currentJob:i?.job,nextJob:n?.job,etaToNextJob:s}}),[e,P,a,ew]),eM=(0,i.useMemo)(()=>{if(!$.trim())return eS;let e=$.toLowerCase();return eS.filter(t=>t.name?.toLowerCase().includes(e)||t.currentJob?.title?.toLowerCase().includes(e)||t.nextJob?.title?.toLowerCase().includes(e))},[eS,$]),eC=(0,i.useMemo)(()=>eS.find(e=>e.id===R)||null,[eS,R]);(0,i.useEffect)(()=>{let e=!0;return(async()=>{try{if(await new Promise((e,t)=>{if(ea||window.google?.maps){ea=!0,e();return}if(es)return void eo.push(e);let r=document.querySelector('script[src*="maps.googleapis.com"]');if(r){es=!0,r.addEventListener("load",()=>{ea=!0,es=!1,e(),eo.forEach(e=>e()),eo.length=0});return}es=!0;let i=document.createElement("script");i.src=`https://maps.googleapis.com/maps/api/js?key=${eN}&libraries=marker`,i.async=!0,i.defer=!0,i.onload=()=>{ea=!0,es=!1,e(),eo.forEach(e=>e()),eo.length=0},i.onerror=()=>{es=!1,t(Error("Failed to load Google Maps"))},document.head.appendChild(i)}),!e||!d.current)return;let{Map:t}=await google.maps.importLibrary("maps"),r=new t(d.current,{center:{lat:37.7749,lng:-122.4194},zoom:11,mapId:"dispatch-map",disableDefaultUI:!0,zoomControl:!0,fullscreenControl:!0,styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]}]});p.current=r,_(!0),r.addListener("click",e=>{b.current&&b.current(e)})}catch(t){e&&C(t instanceof Error?t.message:"Failed to load map")}})(),()=>{for(let t of(e=!1,f.current.values()))try{t.map=null}catch(e){}for(let e of(f.current.clear(),x.current.values()))try{e.setMap(null)}catch(e){}x.current.clear(),p.current=null,d.current&&(d.current.innerHTML="")}},[eN]),(0,i.useEffect)(()=>{p.current&&N&&(async()=>{try{let{AdvancedMarkerElement:e}=await google.maps.importLibrary("marker"),t=p.current;if(!t)return;let r=new Set;for(let i of eS){let n=i.gpsLocation;if(!n)continue;let a=`tech-${i.id}`;r.add(a);let s={lat:Number(n.lat),lng:Number(n.lng)},o=el[i.status]||el.offline,l=f.current.get(a);if(l)l.position=s;else{let r=document.createElement("div");r.className="relative cursor-pointer",r.innerHTML=`
							<div class="relative">
								<div class="w-10 h-10 rounded-full bg-white shadow-lg border-2 ${o.border.replace("border-","border-")} flex items-center justify-center overflow-hidden">
									${i.avatar?`<img src="${i.avatar}" class="w-full h-full object-cover" />`:`<span class="text-sm font-medium text-gray-700">${eu(i.name)}</span>`}
								</div>
								<div class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full ${o.bg} border-2 border-white"></div>
							</div>
						`,(l=new e({map:t,position:s,content:r,title:i.name})).addListener("click",()=>{L(i.id),k(null)}),f.current.set(a,l)}}for(let i of a){if(!i.job)continue;let n=ep(i.job);if(!n)continue;let a=`job-${i.job.id}`;r.add(a);let s=ec[i.status]||ec.pending,o=f.current.get(a);if(!o){let r=document.createElement("div");r.className="cursor-pointer",r.innerHTML=`
							<div class="w-6 h-6 rounded-full shadow-md flex items-center justify-center" style="background-color: ${s}">
								<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
									<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
									<circle cx="12" cy="10" r="3"/>
								</svg>
							</div>
						`,(o=new e({map:t,position:n,content:r,title:i.job.title})).addListener("click",()=>{k(i.job),L(null)}),f.current.set(a,o)}}for(let[e,t]of f.current)r.has(e)||(t.map=null,f.current.delete(e))}catch(e){console.error("Error updating markers:",e)}})()},[eS,a,N]),(0,i.useEffect)(()=>{if(!p.current||!N)return;let e=p.current,t=["#3b82f6","#10b981","#f59e0b","#8b5cf6","#ef4444","#ec4899"];for(let e of x.current.values())e.setMap(null);x.current.clear(),eS.forEach((r,i)=>{if(!r.gpsLocation||0===r.appointments.length)return;let n=[];for(let e of(n.push({lat:Number(r.gpsLocation.lat),lng:Number(r.gpsLocation.lng)}),r.appointments)){if(!e.job)continue;let t=ep(e.job);t&&n.push(t)}if(n.length<2)return;let a=new google.maps.Polyline({path:n,geodesic:!0,strokeColor:t[i%t.length],strokeOpacity:.7,strokeWeight:3,map:e});x.current.set(`route-${r.id}`,a)})},[eS,N]),(0,i.useEffect)(()=>{let e=(0,ee.createClient)(),t=e.channel("dispatch-gps-updates").on("postgres_changes",{event:"*",schema:"public",table:"technician_locations",filter:`company_id=eq.${l}`},e=>{if(e.new&&"object"==typeof e.new){let t=e.new;W(e=>{let r=new Map(e);return r.set(t.technician_id,t),r})}}).subscribe();return()=>{e.removeChannel(t)}},[l]),(0,i.useEffect)(()=>{let e=async()=>{let e=eS.find(e=>e.gpsLocation);if(e?.gpsLocation)try{let t=await H.getWeatherData(e.gpsLocation.lat,e.gpsLocation.lng);t&&eb({temperature:t.current.temperature,condition:t.current.conditions,icon:t.current.icon,alerts:t.alerts})}catch(e){console.error("Error fetching weather:",e)}};e();let t=setInterval(e,6e5);return()=>clearInterval(t)},[eS]),(0,i.useEffect)(()=>{let e=async()=>{let e=[],t=new Map;for(let r of eS){if(!r.gpsLocation||!r.nextJob)continue;let i=ep(r.nextJob);if(!i)continue;let n=(async()=>{try{let e=await O.getETA({lat:r.gpsLocation.lat,lon:r.gpsLocation.lng},{lat:i.lat,lon:i.lng});e&&t.set(r.id,{durationMinutes:e.durationMinutes,distanceKm:e.distanceKm,arrivalTime:e.arrivalTime})}catch(e){console.error(`Error fetching ETA for tech ${r.id}:`,e)}})();e.push(n)}await Promise.all(e),t.size>0&&ey(t)};if(eS.some(e=>e.gpsLocation&&e.nextJob)){e();let t=setInterval(e,12e4);return()=>clearInterval(t)}},[eS]);let eT=(0,i.useCallback)(async()=>{ej(!0);try{let e=p.current;if(!e)return;for(let e of x.current.values())e.setMap(null);x.current.clear();let t=["#3b82f6","#10b981","#f59e0b","#8b5cf6","#ef4444","#ec4899"];for(let r=0;r<eS.length;r++){let i=eS[r];if(!i.gpsLocation||0===i.appointments.length)continue;let n=[{lat:i.gpsLocation.lat,lon:i.gpsLocation.lng}];for(let e of i.appointments){if(!e.job)continue;let t=ep(e.job);t&&n.push({lat:t.lat,lon:t.lng,address:em(e.job),jobId:e.job.id})}if(!(n.length<2))try{let a=await O.getMultiStopRoute(n,!0);if(a&&a.polyline){let n=google.maps.geometry?.encoding?.decodePath(a.polyline);if(n){let a=new google.maps.Polyline({path:n,geodesic:!0,strokeColor:t[r%t.length],strokeOpacity:.8,strokeWeight:4,map:e});x.current.set(`route-${i.id}`,a)}}}catch(o){console.error(`Error optimizing route for tech ${i.id}:`,o);let a=n.map(e=>({lat:e.lat,lng:e.lon})),s=new google.maps.Polyline({path:a,geodesic:!0,strokeColor:t[r%t.length],strokeOpacity:.7,strokeWeight:3,map:e});x.current.set(`route-${i.id}`,s)}}}catch(e){console.error("Error optimizing routes:",e)}finally{ej(!1)}},[eS]),eI=(0,i.useCallback)(()=>{if(!p.current)return;let e=new google.maps.LatLngBounds,t=!1;for(let r of eS)r.gpsLocation&&(e.extend({lat:Number(r.gpsLocation.lat),lng:Number(r.gpsLocation.lng)}),t=!0);for(let r of a)if(r.job){let i=ep(r.job);i&&(e.extend(i),t=!0)}t&&p.current.fitBounds(e,50)},[eS,a]);(0,i.useEffect)(()=>{p.current&&eC?.gpsLocation&&(p.current.panTo({lat:Number(eC.gpsLocation.lat),lng:Number(eC.gpsLocation.lng)}),p.current.setZoom(15))},[eC]);let eR=eS.filter(e=>e.gpsLocation).length;return(0,r.jsxs)("div",{className:"relative h-full w-full overflow-hidden",children:[(0,r.jsx)("div",{className:(0,J.cn)("absolute top-4 left-4 bottom-4 z-10 transition-all duration-300",T?"w-80":"w-12"),children:(0,r.jsxs)(q.Card,{className:"h-full flex flex-col overflow-hidden",children:[(0,r.jsx)(q.CardHeader,{className:"p-3 border-b flex-shrink-0",children:(0,r.jsx)("div",{className:"flex items-center justify-between",children:T?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(S.Users,{className:"h-4 w-4"}),(0,r.jsx)("span",{className:"font-medium",children:"Technicians"}),(0,r.jsx)(Z.Badge,{variant:"secondary",className:"text-xs",children:e.length})]}),(0,r.jsx)(B.Button,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>I(!1),children:(0,r.jsx)(u.ChevronLeft,{className:"h-4 w-4"})})]}):(0,r.jsx)(B.Button,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>I(!0),children:(0,r.jsx)(m.ChevronRight,{className:"h-4 w-4"})})})}),T&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"p-3 border-b",children:(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)(j.Search,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),(0,r.jsx)(Y.Input,{placeholder:"Search technicians...",className:"pl-9",value:$,onChange:e=>F(e.target.value)})]})}),(0,r.jsx)(Q.ScrollArea,{className:"flex-1",children:eM.length>0?eM.map(e=>(0,r.jsx)(eh,{tech:e,isSelected:R===e.id,onClick:()=>{L(e.id),k(null)}},e.id)):0===e.length?(0,r.jsxs)("div",{className:"p-4 text-center",children:[(0,r.jsx)(s.AlertTriangle,{className:"h-8 w-8 mx-auto mb-2 text-amber-500"}),(0,r.jsx)("p",{className:"text-sm font-medium",children:"No technicians found"}),(0,r.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"Add technicians to your team to see them here"})]}):(0,r.jsxs)("div",{className:"p-4 text-center text-sm text-muted-foreground",children:['No results for "',$,'"']})}),(0,r.jsx)("div",{className:"p-3 border-t bg-muted/30",children:(0,r.jsxs)("div",{className:"flex items-center justify-between text-xs",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("div",{className:"h-2 w-2 rounded-full bg-emerald-500 animate-pulse"}),(0,r.jsx)("span",{className:"text-muted-foreground",children:"Live GPS Tracking"})]}),(0,r.jsxs)("span",{className:"text-muted-foreground",children:[eR,"/",e.length," active"]})]})})]})]})}),ex&&(0,r.jsx)("div",{className:"absolute top-4 left-[21rem] z-10",children:(0,r.jsx)(q.Card,{className:"p-3 bg-background/95 backdrop-blur shadow-lg",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[ex.condition.toLowerCase().includes("rain")||ex.condition.toLowerCase().includes("storm")?(0,r.jsx)(h.CloudRain,{className:"h-5 w-5 text-blue-500"}):ex.condition.toLowerCase().includes("cloud")?(0,r.jsx)(h.CloudRain,{className:"h-5 w-5 text-gray-500"}):(0,r.jsx)(z.Sun,{className:"h-5 w-5 text-amber-500"}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)("span",{className:"font-semibold",children:[Math.round(ex.temperature),"°F"]}),(0,r.jsx)("span",{className:"text-sm text-muted-foreground",children:ex.condition})]}),ex.alerts.length>0&&(0,r.jsxs)("div",{className:"flex items-center gap-1 text-xs text-amber-600",children:[(0,r.jsx)(s.AlertTriangle,{className:"h-3 w-3"}),(0,r.jsx)("span",{children:ex.alerts[0].headline})]})]})]})})}),(0,r.jsx)("div",{className:"absolute bottom-4 right-4 z-10 flex flex-col gap-2",children:(0,r.jsxs)(X.TooltipProvider,{children:[(0,r.jsxs)(X.Tooltip,{children:[(0,r.jsx)(X.TooltipTrigger,{asChild:!0,children:(0,r.jsx)(B.Button,{variant:"secondary",size:"icon",className:"shadow-lg",onClick:eT,disabled:ev,children:ev?(0,r.jsx)(y.RefreshCw,{className:"h-4 w-4 animate-spin"}):(0,r.jsx)(v.Route,{className:"h-4 w-4"})})}),(0,r.jsxs)(X.TooltipContent,{side:"left",children:[(0,r.jsx)("p",{className:"font-medium",children:"Optimize Routes"}),(0,r.jsx)("p",{className:"text-xs text-muted-foreground",children:"Get optimal routes for all technicians"})]})]}),(0,r.jsxs)(X.Tooltip,{children:[(0,r.jsx)(X.TooltipTrigger,{asChild:!0,children:(0,r.jsx)(B.Button,{variant:"secondary",size:"icon",className:"shadow-lg",onClick:()=>K(!0),children:(0,r.jsx)(w.Plus,{className:"h-4 w-4"})})}),(0,r.jsxs)(X.TooltipContent,{side:"left",children:[(0,r.jsx)("p",{className:"font-medium",children:"Quick Appointment"}),(0,r.jsx)("p",{className:"text-xs text-muted-foreground",children:"Or click anywhere on map"})]})]}),(0,r.jsxs)(X.Tooltip,{children:[(0,r.jsx)(X.TooltipTrigger,{asChild:!0,children:(0,r.jsx)(B.Button,{variant:"secondary",size:"icon",className:"shadow-lg",onClick:eI,children:(0,r.jsx)(g.default,{className:"h-4 w-4"})})}),(0,r.jsx)(X.TooltipContent,{side:"left",children:"Fit all markers"})]})]})}),(0,r.jsx)(ef,{jobs:o,isOpen:A,onToggle:()=>D(!A),onJobSelect:e=>{k(e),L(null);let t=ep(e);t&&p.current&&(p.current.panTo(t),p.current.setZoom(15))}}),(0,r.jsxs)("div",{className:"h-full w-full bg-muted relative",children:[(0,r.jsx)("div",{ref:d,className:"absolute inset-0",suppressHydrationWarning:!0}),!N&&!M&&(0,r.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-muted z-10",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)(y.RefreshCw,{className:"mx-auto h-8 w-8 animate-spin text-muted-foreground"}),(0,r.jsx)("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading map..."})]})}),M&&(0,r.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-muted z-10",children:(0,r.jsxs)("div",{className:"text-center max-w-md",children:[(0,r.jsx)(s.AlertTriangle,{className:"mx-auto h-12 w-12 text-amber-500 mb-4"}),(0,r.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Map Unavailable"}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground mb-4",children:M}),(0,r.jsx)("p",{className:"text-xs text-muted-foreground",children:"Please ensure the Google Maps API key is configured in your environment variables."})]})})]}),(0,r.jsx)(eg,{tech:eC,onClose:()=>L(null),onNavigate:()=>{eC&&c.push(`/dashboard/schedule/technician/${eC.id}`)}}),(0,r.jsx)(et.QuickAppointmentDialog,{open:U,onOpenChange:K,location:G,technicians:ez,nearbyCustomers:en,onSuccess:e=>{},onCreateCustomer:()=>{c.push("/dashboard/customers/new")}})]})}function eb(e){return(0,r.jsx)(en,{children:(0,r.jsx)(ex,{...e})})}e.s(["DispatchMapView",()=>eb],999490)}]);