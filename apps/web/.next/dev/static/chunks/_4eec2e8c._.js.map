{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/roles.ts"],"sourcesContent":["/**\n * Role Actions - Server Actions\n *\n * Server-side actions for role management and permission checks.\n * Uses Supabase RLS and database functions for security.\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport {\n\tgetUserRole,\n\thasPermission,\n\thasRole,\n\tisCompanyOwner,\n\ttype Permission,\n\ttype UserRole,\n} from \"@/lib/auth/permissions\";\nimport { withErrorHandling } from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// ============================================================================\n// Validation Schemas\n// ============================================================================\n\nconst updateRoleSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tnewRole: z.enum([\n\t\t\"owner\",\n\t\t\"admin\",\n\t\t\"manager\",\n\t\t\"dispatcher\",\n\t\t\"technician\",\n\t\t\"csr\",\n\t]),\n\treason: z.string().optional(),\n});\n\nconst updatePermissionsSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tpermissions: z.record(z.string(), z.boolean()),\n});\n\n// ============================================================================\n// Query Actions\n// ============================================================================\n\n/**\n * Get current user's role in active company\n *\n * @returns User's role or null\n *\n * @example\n * ```typescript\n * const role = await getCurrentUserRole();\n * if (role.success && role.data === \"manager\") {\n *   // Show manager dashboard\n * }\n * ```\n */\nexport async function getCurrentUserRole() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst role = await getUserRole(supabase, user.id, companyId);\n\n\t\treturn role;\n\t});\n}\n\n/**\n * Check if current user has a specific permission\n *\n * @param permission - Permission to check\n * @returns true if user has permission\n *\n * @example\n * ```typescript\n * const result = await checkPermission(\"delete_jobs\");\n * if (!result.success || !result.data) {\n *   return { error: \"Access denied\" };\n * }\n * ```\n */\nasync function checkPermission(permission: Permission) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasPerm = await hasPermission(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t\tpermission,\n\t\t\tcompanyId,\n\t\t);\n\n\t\treturn hasPerm;\n\t});\n}\n\n/**\n * Check if current user has a specific role\n *\n * @param role - Role to check\n * @returns true if user has role\n *\n * @example\n * ```typescript\n * const result = await checkRole(\"manager\");\n * if (!result.success || !result.data) {\n *   redirect(\"/dashboard\");\n * }\n * ```\n */\nasync function checkRole(role: UserRole) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasRoleResult = await hasRole(supabase, user.id, role, companyId);\n\n\t\treturn hasRoleResult;\n\t});\n}\n\n/**\n * Check if current user is company owner\n *\n * @returns true if user is owner\n */\nasync function checkIsOwner() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\n\t\treturn isOwner;\n\t});\n}\n\n// ============================================================================\n// Mutation Actions\n// ============================================================================\n\n/**\n * Update team member's role\n * Only owners and admins can change roles\n *\n * @param input - Team member ID, new role, and optional reason\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberRole({\n *   teamMemberId: \"123...\",\n *   newRole: \"manager\",\n *   reason: \"Promoted to management\"\n * });\n * ```\n */\nasync function updateTeamMemberRole(\n\tinput: z.infer<typeof updateRoleSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updateRoleSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission - only owners and admins can change roles\n\t\tconst canManageRoles =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManageRoles) {\n\t\t\tthrow new Error(\"Only owners and admins can change roles\");\n\t\t}\n\n\t\t// Get current role for audit log\n\t\tconst { data: currentMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"role\")\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!currentMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Update role\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ role: validated.newRole })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\t// Log role change\n\t\tawait supabase.from(\"role_change_log\").insert({\n\t\t\tteam_member_id: validated.teamMemberId,\n\t\t\tchanged_by: user.id,\n\t\t\told_role: currentMember.role,\n\t\t\tnew_role: validated.newRole,\n\t\t\treason: validated.reason,\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Update team member's custom permissions\n * Only owners and admins can change permissions\n *\n * @param input - Team member ID and permissions object\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberPermissions({\n *   teamMemberId: \"123...\",\n *   permissions: {\n *     \"delete_jobs\": true,\n *     \"approve_estimates\": true\n *   }\n * });\n * ```\n */\nasync function updateTeamMemberPermissions(\n\tinput: z.infer<typeof updatePermissionsSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updatePermissionsSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission\n\t\tconst canManagePermissions =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManagePermissions) {\n\t\t\tthrow new Error(\"Only owners and admins can change permissions\");\n\t\t}\n\n\t\t// Update permissions\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ permissions: validated.permissions })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Get team members with their roles\n *\n * @returns List of team members with roles\n */\nasync function getTeamMembersWithRoles() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        users (\n          id,\n          name,\n          email,\n          avatar\n        )\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n// ============================================================================\n// Owner Protection Actions\n// ============================================================================\n\n/**\n * Transfer company ownership to another team member\n * Requires password verification and extensive validation\n *\n * @param input - Transfer details including new owner, password, and reason\n * @returns Transfer ID for audit\n *\n * @example\n * ```typescript\n * const result = await transferOwnership({\n *   newOwnerId: \"user-uuid\",\n *   password: \"current-password\",\n *   reason: \"Retiring from business\"\n * });\n * ```\n */\nasync function transferOwnership(input: {\n\tnewOwnerId: string;\n\tpassword: string;\n\treason?: string;\n\tipAddress?: string;\n\tuserAgent?: string;\n}) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Verify user is current owner\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\t\tif (!isOwner) {\n\t\t\tthrow new Error(\"Only the current owner can transfer ownership\");\n\t\t}\n\n\t\t// Verify password\n\t\tconst { error: signInError } = await supabase.auth.signInWithPassword({\n\t\t\temail: user.email || \"\",\n\t\t\tpassword: input.password,\n\t\t});\n\n\t\tif (signInError) {\n\t\t\tthrow new Error(\"Password verification failed\");\n\t\t}\n\n\t\t// Call database function to transfer ownership\n\t\tconst { data: transferId, error } = await supabase.rpc(\n\t\t\t\"transfer_company_ownership\",\n\t\t\t{\n\t\t\t\tp_company_id: companyId,\n\t\t\t\tp_current_owner_id: user.id,\n\t\t\t\tp_new_owner_id: input.newOwnerId,\n\t\t\t\tp_reason: input.reason,\n\t\t\t\tp_ip_address: input.ipAddress,\n\t\t\t\tp_user_agent: input.userAgent,\n\t\t\t},\n\t\t);\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message || \"Failed to transfer ownership\");\n\t\t}\n\n\t\t// Revalidate all relevant paths\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard\");\n\n\t\treturn transferId;\n\t});\n}\n\n/**\n * Get ownership transfer history for the company\n * Shows audit trail of all ownership changes\n *\n * @returns List of ownership transfers\n */\nasync function getOwnershipTransferHistory() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\t// Only owners and admins can view transfer history\n\t\tconst canView =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canView) {\n\t\t\tthrow new Error(\"Only owners and admins can view transfer history\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"ownership_transfers\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        previous_owner:users!ownership_transfers_previous_owner_id_fkey(id, name, email),\n        new_owner:users!ownership_transfers_new_owner_id_fkey(id, name, email),\n        initiated_by_user:users!ownership_transfers_initiated_by_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n/**\n * Check if a team member can be deleted\n * Prevents deletion of company owner\n *\n * @param teamMemberId - Team member to check\n * @returns Object with canDelete boolean and reason if not allowed\n */\nexport async function canDeleteTeamMember(teamMemberId: string) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Get team member details\n\t\tconst { data: teamMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"user_id, role\")\n\t\t\t.eq(\"id\", teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error || !teamMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Check if user is company owner\n\t\tconst { data: company } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"owner_id\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (company && company.owner_id === teamMember.user_id) {\n\t\t\treturn {\n\t\t\t\tcanDelete: false,\n\t\t\t\treason:\n\t\t\t\t\t\"Cannot delete company owner. Transfer ownership first before removing this team member.\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tcanDelete: true,\n\t\t};\n\t});\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC"}},
    {"offset": {"line": 20, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/roles.ts"],"sourcesContent":["/**\n * Role Actions - Server Actions\n *\n * Server-side actions for role management and permission checks.\n * Uses Supabase RLS and database functions for security.\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport {\n\tgetUserRole,\n\thasPermission,\n\thasRole,\n\tisCompanyOwner,\n\ttype Permission,\n\ttype UserRole,\n} from \"@/lib/auth/permissions\";\nimport { withErrorHandling } from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// ============================================================================\n// Validation Schemas\n// ============================================================================\n\nconst updateRoleSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tnewRole: z.enum([\n\t\t\"owner\",\n\t\t\"admin\",\n\t\t\"manager\",\n\t\t\"dispatcher\",\n\t\t\"technician\",\n\t\t\"csr\",\n\t]),\n\treason: z.string().optional(),\n});\n\nconst updatePermissionsSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tpermissions: z.record(z.string(), z.boolean()),\n});\n\n// ============================================================================\n// Query Actions\n// ============================================================================\n\n/**\n * Get current user's role in active company\n *\n * @returns User's role or null\n *\n * @example\n * ```typescript\n * const role = await getCurrentUserRole();\n * if (role.success && role.data === \"manager\") {\n *   // Show manager dashboard\n * }\n * ```\n */\nexport async function getCurrentUserRole() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst role = await getUserRole(supabase, user.id, companyId);\n\n\t\treturn role;\n\t});\n}\n\n/**\n * Check if current user has a specific permission\n *\n * @param permission - Permission to check\n * @returns true if user has permission\n *\n * @example\n * ```typescript\n * const result = await checkPermission(\"delete_jobs\");\n * if (!result.success || !result.data) {\n *   return { error: \"Access denied\" };\n * }\n * ```\n */\nasync function checkPermission(permission: Permission) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasPerm = await hasPermission(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t\tpermission,\n\t\t\tcompanyId,\n\t\t);\n\n\t\treturn hasPerm;\n\t});\n}\n\n/**\n * Check if current user has a specific role\n *\n * @param role - Role to check\n * @returns true if user has role\n *\n * @example\n * ```typescript\n * const result = await checkRole(\"manager\");\n * if (!result.success || !result.data) {\n *   redirect(\"/dashboard\");\n * }\n * ```\n */\nasync function checkRole(role: UserRole) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasRoleResult = await hasRole(supabase, user.id, role, companyId);\n\n\t\treturn hasRoleResult;\n\t});\n}\n\n/**\n * Check if current user is company owner\n *\n * @returns true if user is owner\n */\nasync function checkIsOwner() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\n\t\treturn isOwner;\n\t});\n}\n\n// ============================================================================\n// Mutation Actions\n// ============================================================================\n\n/**\n * Update team member's role\n * Only owners and admins can change roles\n *\n * @param input - Team member ID, new role, and optional reason\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberRole({\n *   teamMemberId: \"123...\",\n *   newRole: \"manager\",\n *   reason: \"Promoted to management\"\n * });\n * ```\n */\nasync function updateTeamMemberRole(\n\tinput: z.infer<typeof updateRoleSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updateRoleSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission - only owners and admins can change roles\n\t\tconst canManageRoles =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManageRoles) {\n\t\t\tthrow new Error(\"Only owners and admins can change roles\");\n\t\t}\n\n\t\t// Get current role for audit log\n\t\tconst { data: currentMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"role\")\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!currentMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Update role\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ role: validated.newRole })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\t// Log role change\n\t\tawait supabase.from(\"role_change_log\").insert({\n\t\t\tteam_member_id: validated.teamMemberId,\n\t\t\tchanged_by: user.id,\n\t\t\told_role: currentMember.role,\n\t\t\tnew_role: validated.newRole,\n\t\t\treason: validated.reason,\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Update team member's custom permissions\n * Only owners and admins can change permissions\n *\n * @param input - Team member ID and permissions object\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberPermissions({\n *   teamMemberId: \"123...\",\n *   permissions: {\n *     \"delete_jobs\": true,\n *     \"approve_estimates\": true\n *   }\n * });\n * ```\n */\nasync function updateTeamMemberPermissions(\n\tinput: z.infer<typeof updatePermissionsSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updatePermissionsSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission\n\t\tconst canManagePermissions =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManagePermissions) {\n\t\t\tthrow new Error(\"Only owners and admins can change permissions\");\n\t\t}\n\n\t\t// Update permissions\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ permissions: validated.permissions })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Get team members with their roles\n *\n * @returns List of team members with roles\n */\nasync function getTeamMembersWithRoles() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        users (\n          id,\n          name,\n          email,\n          avatar\n        )\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n// ============================================================================\n// Owner Protection Actions\n// ============================================================================\n\n/**\n * Transfer company ownership to another team member\n * Requires password verification and extensive validation\n *\n * @param input - Transfer details including new owner, password, and reason\n * @returns Transfer ID for audit\n *\n * @example\n * ```typescript\n * const result = await transferOwnership({\n *   newOwnerId: \"user-uuid\",\n *   password: \"current-password\",\n *   reason: \"Retiring from business\"\n * });\n * ```\n */\nasync function transferOwnership(input: {\n\tnewOwnerId: string;\n\tpassword: string;\n\treason?: string;\n\tipAddress?: string;\n\tuserAgent?: string;\n}) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Verify user is current owner\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\t\tif (!isOwner) {\n\t\t\tthrow new Error(\"Only the current owner can transfer ownership\");\n\t\t}\n\n\t\t// Verify password\n\t\tconst { error: signInError } = await supabase.auth.signInWithPassword({\n\t\t\temail: user.email || \"\",\n\t\t\tpassword: input.password,\n\t\t});\n\n\t\tif (signInError) {\n\t\t\tthrow new Error(\"Password verification failed\");\n\t\t}\n\n\t\t// Call database function to transfer ownership\n\t\tconst { data: transferId, error } = await supabase.rpc(\n\t\t\t\"transfer_company_ownership\",\n\t\t\t{\n\t\t\t\tp_company_id: companyId,\n\t\t\t\tp_current_owner_id: user.id,\n\t\t\t\tp_new_owner_id: input.newOwnerId,\n\t\t\t\tp_reason: input.reason,\n\t\t\t\tp_ip_address: input.ipAddress,\n\t\t\t\tp_user_agent: input.userAgent,\n\t\t\t},\n\t\t);\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message || \"Failed to transfer ownership\");\n\t\t}\n\n\t\t// Revalidate all relevant paths\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard\");\n\n\t\treturn transferId;\n\t});\n}\n\n/**\n * Get ownership transfer history for the company\n * Shows audit trail of all ownership changes\n *\n * @returns List of ownership transfers\n */\nasync function getOwnershipTransferHistory() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\t// Only owners and admins can view transfer history\n\t\tconst canView =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canView) {\n\t\t\tthrow new Error(\"Only owners and admins can view transfer history\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"ownership_transfers\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        previous_owner:users!ownership_transfers_previous_owner_id_fkey(id, name, email),\n        new_owner:users!ownership_transfers_new_owner_id_fkey(id, name, email),\n        initiated_by_user:users!ownership_transfers_initiated_by_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n/**\n * Check if a team member can be deleted\n * Prevents deletion of company owner\n *\n * @param teamMemberId - Team member to check\n * @returns Object with canDelete boolean and reason if not allowed\n */\nexport async function canDeleteTeamMember(teamMemberId: string) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Get team member details\n\t\tconst { data: teamMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"user_id, role\")\n\t\t\t.eq(\"id\", teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error || !teamMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Check if user is company owner\n\t\tconst { data: company } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"owner_id\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (company && company.owner_id === teamMember.user_id) {\n\t\t\treturn {\n\t\t\t\tcanDelete: false,\n\t\t\t\treason:\n\t\t\t\t\t\"Cannot delete company owner. Transfer ownership first before removing this team member.\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tcanDelete: true,\n\t\t};\n\t});\n}\n"],"names":[],"mappings":";;;;;;;IA8DsB,qBAAA,WAAA,GAAA,IAAA,yZAAA,EAAA,8CAAA,8YAAA,EAAA,KAAA,GAAA,oZAAA,EAAA"}},
    {"offset": {"line": 35, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/roles.ts"],"sourcesContent":["/**\n * Role Actions - Server Actions\n *\n * Server-side actions for role management and permission checks.\n * Uses Supabase RLS and database functions for security.\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport {\n\tgetUserRole,\n\thasPermission,\n\thasRole,\n\tisCompanyOwner,\n\ttype Permission,\n\ttype UserRole,\n} from \"@/lib/auth/permissions\";\nimport { withErrorHandling } from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// ============================================================================\n// Validation Schemas\n// ============================================================================\n\nconst updateRoleSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tnewRole: z.enum([\n\t\t\"owner\",\n\t\t\"admin\",\n\t\t\"manager\",\n\t\t\"dispatcher\",\n\t\t\"technician\",\n\t\t\"csr\",\n\t]),\n\treason: z.string().optional(),\n});\n\nconst updatePermissionsSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tpermissions: z.record(z.string(), z.boolean()),\n});\n\n// ============================================================================\n// Query Actions\n// ============================================================================\n\n/**\n * Get current user's role in active company\n *\n * @returns User's role or null\n *\n * @example\n * ```typescript\n * const role = await getCurrentUserRole();\n * if (role.success && role.data === \"manager\") {\n *   // Show manager dashboard\n * }\n * ```\n */\nexport async function getCurrentUserRole() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst role = await getUserRole(supabase, user.id, companyId);\n\n\t\treturn role;\n\t});\n}\n\n/**\n * Check if current user has a specific permission\n *\n * @param permission - Permission to check\n * @returns true if user has permission\n *\n * @example\n * ```typescript\n * const result = await checkPermission(\"delete_jobs\");\n * if (!result.success || !result.data) {\n *   return { error: \"Access denied\" };\n * }\n * ```\n */\nasync function checkPermission(permission: Permission) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasPerm = await hasPermission(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t\tpermission,\n\t\t\tcompanyId,\n\t\t);\n\n\t\treturn hasPerm;\n\t});\n}\n\n/**\n * Check if current user has a specific role\n *\n * @param role - Role to check\n * @returns true if user has role\n *\n * @example\n * ```typescript\n * const result = await checkRole(\"manager\");\n * if (!result.success || !result.data) {\n *   redirect(\"/dashboard\");\n * }\n * ```\n */\nasync function checkRole(role: UserRole) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasRoleResult = await hasRole(supabase, user.id, role, companyId);\n\n\t\treturn hasRoleResult;\n\t});\n}\n\n/**\n * Check if current user is company owner\n *\n * @returns true if user is owner\n */\nasync function checkIsOwner() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\n\t\treturn isOwner;\n\t});\n}\n\n// ============================================================================\n// Mutation Actions\n// ============================================================================\n\n/**\n * Update team member's role\n * Only owners and admins can change roles\n *\n * @param input - Team member ID, new role, and optional reason\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberRole({\n *   teamMemberId: \"123...\",\n *   newRole: \"manager\",\n *   reason: \"Promoted to management\"\n * });\n * ```\n */\nasync function updateTeamMemberRole(\n\tinput: z.infer<typeof updateRoleSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updateRoleSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission - only owners and admins can change roles\n\t\tconst canManageRoles =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManageRoles) {\n\t\t\tthrow new Error(\"Only owners and admins can change roles\");\n\t\t}\n\n\t\t// Get current role for audit log\n\t\tconst { data: currentMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"role\")\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!currentMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Update role\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ role: validated.newRole })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\t// Log role change\n\t\tawait supabase.from(\"role_change_log\").insert({\n\t\t\tteam_member_id: validated.teamMemberId,\n\t\t\tchanged_by: user.id,\n\t\t\told_role: currentMember.role,\n\t\t\tnew_role: validated.newRole,\n\t\t\treason: validated.reason,\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Update team member's custom permissions\n * Only owners and admins can change permissions\n *\n * @param input - Team member ID and permissions object\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberPermissions({\n *   teamMemberId: \"123...\",\n *   permissions: {\n *     \"delete_jobs\": true,\n *     \"approve_estimates\": true\n *   }\n * });\n * ```\n */\nasync function updateTeamMemberPermissions(\n\tinput: z.infer<typeof updatePermissionsSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updatePermissionsSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission\n\t\tconst canManagePermissions =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManagePermissions) {\n\t\t\tthrow new Error(\"Only owners and admins can change permissions\");\n\t\t}\n\n\t\t// Update permissions\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ permissions: validated.permissions })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Get team members with their roles\n *\n * @returns List of team members with roles\n */\nasync function getTeamMembersWithRoles() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        users (\n          id,\n          name,\n          email,\n          avatar\n        )\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n// ============================================================================\n// Owner Protection Actions\n// ============================================================================\n\n/**\n * Transfer company ownership to another team member\n * Requires password verification and extensive validation\n *\n * @param input - Transfer details including new owner, password, and reason\n * @returns Transfer ID for audit\n *\n * @example\n * ```typescript\n * const result = await transferOwnership({\n *   newOwnerId: \"user-uuid\",\n *   password: \"current-password\",\n *   reason: \"Retiring from business\"\n * });\n * ```\n */\nasync function transferOwnership(input: {\n\tnewOwnerId: string;\n\tpassword: string;\n\treason?: string;\n\tipAddress?: string;\n\tuserAgent?: string;\n}) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Verify user is current owner\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\t\tif (!isOwner) {\n\t\t\tthrow new Error(\"Only the current owner can transfer ownership\");\n\t\t}\n\n\t\t// Verify password\n\t\tconst { error: signInError } = await supabase.auth.signInWithPassword({\n\t\t\temail: user.email || \"\",\n\t\t\tpassword: input.password,\n\t\t});\n\n\t\tif (signInError) {\n\t\t\tthrow new Error(\"Password verification failed\");\n\t\t}\n\n\t\t// Call database function to transfer ownership\n\t\tconst { data: transferId, error } = await supabase.rpc(\n\t\t\t\"transfer_company_ownership\",\n\t\t\t{\n\t\t\t\tp_company_id: companyId,\n\t\t\t\tp_current_owner_id: user.id,\n\t\t\t\tp_new_owner_id: input.newOwnerId,\n\t\t\t\tp_reason: input.reason,\n\t\t\t\tp_ip_address: input.ipAddress,\n\t\t\t\tp_user_agent: input.userAgent,\n\t\t\t},\n\t\t);\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message || \"Failed to transfer ownership\");\n\t\t}\n\n\t\t// Revalidate all relevant paths\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard\");\n\n\t\treturn transferId;\n\t});\n}\n\n/**\n * Get ownership transfer history for the company\n * Shows audit trail of all ownership changes\n *\n * @returns List of ownership transfers\n */\nasync function getOwnershipTransferHistory() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\t// Only owners and admins can view transfer history\n\t\tconst canView =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canView) {\n\t\t\tthrow new Error(\"Only owners and admins can view transfer history\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"ownership_transfers\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        previous_owner:users!ownership_transfers_previous_owner_id_fkey(id, name, email),\n        new_owner:users!ownership_transfers_new_owner_id_fkey(id, name, email),\n        initiated_by_user:users!ownership_transfers_initiated_by_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n/**\n * Check if a team member can be deleted\n * Prevents deletion of company owner\n *\n * @param teamMemberId - Team member to check\n * @returns Object with canDelete boolean and reason if not allowed\n */\nexport async function canDeleteTeamMember(teamMemberId: string) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Get team member details\n\t\tconst { data: teamMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"user_id, role\")\n\t\t\t.eq(\"id\", teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error || !teamMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Check if user is company owner\n\t\tconst { data: company } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"owner_id\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (company && company.owner_id === teamMember.user_id) {\n\t\t\treturn {\n\t\t\t\tcanDelete: false,\n\t\t\t\treason:\n\t\t\t\t\t\"Cannot delete company owner. Transfer ownership first before removing this team member.\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tcanDelete: true,\n\t\t};\n\t});\n}\n"],"names":[],"mappings":";;;;;;;IA0iBsB,sBAAA,WAAA,GAAA,IAAA,yZAAA,EAAA,8CAAA,8YAAA,EAAA,KAAA,GAAA,oZAAA,EAAA"}},
    {"offset": {"line": 63, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/build/webpack/loaders/next-flight-loader/action-client-wrapper.ts"],"sourcesContent":["// This file must be bundled in the app's client layer, it shouldn't be directly\n// imported by the server.\n\nexport { callServer } from 'next/dist/client/app-call-server'\nexport { findSourceMapURL } from 'next/dist/client/app-find-source-map-url'\n\n// A noop wrapper to let the Flight client create the server reference.\n// See also: https://github.com/facebook/react/pull/26632\n// eslint-disable-next-line import/no-extraneous-dependencies\nexport { createServerReference } from 'react-server-dom-webpack/client'\n"],"names":["callServer","createServerReference","findSourceMapURL"],"mappings":"AAAA,gFAAgF;AAChF,0BAA0B;;;;;;;;;;;;;;;;IAEjBA,UAAU,EAAA;eAAVA,eAAAA,UAAU;;IAMVC,qBAAqB,EAAA;eAArBA,QAAAA,qBAAqB;;IALrBC,gBAAgB,EAAA;eAAhBA,qBAAAA,gBAAgB;;;+BADE;qCACM;wBAKK","ignoreList":[0]}}]
}