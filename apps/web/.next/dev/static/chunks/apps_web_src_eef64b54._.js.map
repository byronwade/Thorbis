{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/ui/card.tsx"],"sourcesContent":["// Re-export from @stratos/ui package\nexport * from \"@stratos/ui\";\n"],"names":[],"mappings":"AAAA,qCAAqC;;AACrC"}},
    {"offset": {"line": 15, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/call/call-indicator-badge.tsx"],"sourcesContent":["\"use client\";\n\n/**\n * Call Indicator Badge - Client Component\n *\n * Client-side features:\n * - Shows when call is popped out to separate window\n * - Click to bring pop-out window to front\n * - Right-click to return call to main window\n * - Real-time call duration display\n * - Animated pulse to show active status\n *\n * Performance optimizations:\n * - Minimal footprint (only renders when call is popped out)\n * - Uses requestAnimationFrame for smooth animations\n * - Cleanup timers on unmount\n */\n\nimport { Phone, PhoneOff, X } from \"lucide-react\";\nimport { useEffect, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport {\n\tTooltip,\n\tTooltipContent,\n\tTooltipProvider,\n\tTooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { cn } from \"@/lib/utils\";\n\ntype CallIndicatorBadgeProps = {\n\tcallId: string;\n\tcustomerName: string;\n\tcustomerPhone: string;\n\tduration: number;\n\tisActive: boolean;\n\tonFocusPopOut: () => void;\n\tonReturnToMain: () => void;\n\tposition?: \"bottom-right\" | \"bottom-left\" | \"top-right\" | \"top-left\";\n};\n\nexport function CallIndicatorBadge({\n\tcallId,\n\tcustomerName,\n\tcustomerPhone,\n\tduration,\n\tisActive,\n\tonFocusPopOut,\n\tonReturnToMain,\n\tposition = \"bottom-right\",\n}: CallIndicatorBadgeProps) {\n\tconst [displayDuration, setDisplayDuration] = useState(duration);\n\tconst [showContextMenu, setShowContextMenu] = useState(false);\n\n\t// Update duration every second\n\tuseEffect(() => {\n\t\tif (!isActive) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst interval = setInterval(() => {\n\t\t\tsetDisplayDuration((prev) => prev + 1);\n\t\t}, 1000);\n\n\t\treturn () => clearInterval(interval);\n\t}, [isActive]);\n\n\t// Format duration as MM:SS\n\tconst formatDuration = (seconds: number) => {\n\t\tconst mins = Math.floor(seconds / 60);\n\t\tconst secs = seconds % 60;\n\t\treturn `${mins.toString().padStart(2, \"0\")}:${secs.toString().padStart(2, \"0\")}`;\n\t};\n\n\t// Position classes\n\tconst positionClasses = {\n\t\t\"bottom-right\": \"bottom-6 right-6\",\n\t\t\"bottom-left\": \"bottom-6 left-6\",\n\t\t\"top-right\": \"top-24 right-6\",\n\t\t\"top-left\": \"top-24 left-6\",\n\t};\n\n\t// Handle right-click to show context menu\n\tconst handleContextMenu = (e: React.MouseEvent) => {\n\t\te.preventDefault();\n\t\tsetShowContextMenu(true);\n\t};\n\n\t// Close context menu when clicking outside\n\tuseEffect(() => {\n\t\tif (!showContextMenu) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleClickOutside = () => setShowContextMenu(false);\n\t\tdocument.addEventListener(\"click\", handleClickOutside);\n\n\t\treturn () => document.removeEventListener(\"click\", handleClickOutside);\n\t}, [showContextMenu]);\n\n\treturn (\n\t\t<div\n\t\t\tclassName={cn(\n\t\t\t\t\"fixed z-50 transition-all duration-200\",\n\t\t\t\tpositionClasses[position],\n\t\t\t)}\n\t\t\tonContextMenu={handleContextMenu}\n\t\t>\n\t\t\t<TooltipProvider>\n\t\t\t\t<Tooltip>\n\t\t\t\t\t<TooltipTrigger asChild>\n\t\t\t\t\t\t<Card\n\t\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\t\"group relative cursor-pointer overflow-hidden\",\n\t\t\t\t\t\t\t\t\"border-primary/30 from-primary/10 to-primary/5 rounded-2xl border-2 bg-gradient-to-br\",\n\t\t\t\t\t\t\t\t\"shadow-primary/20 shadow-lg backdrop-blur-sm\",\n\t\t\t\t\t\t\t\t\"hover:border-primary/50 hover:shadow-primary/30 transition-all duration-300 hover:scale-105 hover:shadow-xl\",\n\t\t\t\t\t\t\t\t\"animate-pulse-slow\",\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\tonClick={onFocusPopOut}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{/* Status indicator pulse */}\n\t\t\t\t\t\t\t<div className=\"bg-primary/20 absolute inset-0 animate-ping rounded-2xl opacity-75\" />\n\n\t\t\t\t\t\t\t{/* Content */}\n\t\t\t\t\t\t\t<div className=\"relative flex items-center gap-3 p-4\">\n\t\t\t\t\t\t\t\t{/* Phone icon */}\n\t\t\t\t\t\t\t\t<div className=\"bg-primary text-primary-foreground flex h-12 w-12 items-center justify-center rounded-full shadow-md\">\n\t\t\t\t\t\t\t\t\t<Phone className=\"h-6 w-6 animate-pulse\" />\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t{/* Call info */}\n\t\t\t\t\t\t\t\t<div className=\"flex flex-col gap-1\">\n\t\t\t\t\t\t\t\t\t<div className=\"text-foreground text-sm font-semibold\">\n\t\t\t\t\t\t\t\t\t\t{customerName}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div className=\"text-muted-foreground text-xs\">\n\t\t\t\t\t\t\t\t\t\t{customerPhone}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div className=\"text-primary font-mono text-xs font-bold\">\n\t\t\t\t\t\t\t\t\t\t{formatDuration(displayDuration)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t{/* Close button */}\n\t\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\t\tclassName=\"ml-2 h-8 w-8 opacity-0 transition-opacity group-hover:opacity-100\"\n\t\t\t\t\t\t\t\t\tonClick={(e) => {\n\t\t\t\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t\t\t\t\tonReturnToMain();\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tsize=\"icon\"\n\t\t\t\t\t\t\t\t\tvariant=\"ghost\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<X className=\"h-4 w-4\" />\n\t\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</Card>\n\t\t\t\t\t</TooltipTrigger>\n\t\t\t\t\t<TooltipContent className=\"max-w-xs\" side=\"left\">\n\t\t\t\t\t\t<div className=\"space-y-2\">\n\t\t\t\t\t\t\t<p className=\"font-semibold\">Active Call (Pop-out Window)</p>\n\t\t\t\t\t\t\t<p className=\"text-muted-foreground text-xs\">\n\t\t\t\t\t\t\t\tClick to bring window to front\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<p className=\"text-muted-foreground text-xs\">\n\t\t\t\t\t\t\t\tRight-click or click X to return to main window\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</TooltipContent>\n\t\t\t\t</Tooltip>\n\t\t\t</TooltipProvider>\n\n\t\t\t{/* Context menu */}\n\t\t\t{showContextMenu && (\n\t\t\t\t<div className=\"border-border bg-background absolute right-0 bottom-full mb-2 rounded-lg border p-2 shadow-lg\">\n\t\t\t\t\t<Button\n\t\t\t\t\t\tclassName=\"w-full justify-start gap-2 text-sm\"\n\t\t\t\t\t\tonClick={(e) => {\n\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t\tonReturnToMain();\n\t\t\t\t\t\t\tsetShowContextMenu(false);\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\tvariant=\"ghost\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<PhoneOff className=\"h-4 w-4\" />\n\t\t\t\t\t\tReturn to Main Window\n\t\t\t\t\t</Button>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 321, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/customers.ts"],"sourcesContent":["/**\n * Customer Management Server Actions\n *\n * Comprehensive customer relationship management with:\n * - Customer CRUD operations\n * - Customer portal invitation and access\n * - Customer metrics tracking (revenue, jobs, invoices)\n * - Communication preferences\n * - Soft delete/archive support\n * - Customer search and filtering\n */\n\n\"use server\";\n\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport { sendEmail } from \"@/lib/email/email-sender\";\nimport { EmailTemplate } from \"@/lib/email/email-types\";\nimport {\n    ActionError,\n    ERROR_CODES,\n    ERROR_MESSAGES,\n} from \"@/lib/errors/action-error\";\nimport {\n    type ActionResult,\n    assertAuthenticated,\n    assertExists,\n    withErrorHandling,\n} from \"@/lib/errors/with-error-handling\";\nimport { geocodeAddressSilent } from \"@/lib/services/geocoding\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport PortalInvitationEmail from \"../../emails/templates/customer/portal-invitation\";\n\n// ============================================================================\n// VALIDATION SCHEMAS\n// ============================================================================\n\nconst CUSTOMER_NAME_MAX_LENGTH = 100;\nconst CUSTOMER_COMPANY_MAX_LENGTH = 200;\nconst CUSTOMER_PHONE_MAX_LENGTH = 20;\nconst CUSTOMER_ADDRESS_MAX_LENGTH = 200;\nconst CUSTOMER_ADDRESS2_MAX_LENGTH = 100;\nconst CUSTOMER_CITY_MAX_LENGTH = 100;\nconst CUSTOMER_STATE_MAX_LENGTH = 50;\n\n// HTTP Status codes\nconst HTTP_STATUS_FORBIDDEN = 403;\n\n// Search defaults\nconst DEFAULT_SEARCH_LIMIT = 50;\nconst CUSTOMER_ZIP_MAX_LENGTH = 20;\nconst CUSTOMER_COUNTRY_MAX_LENGTH = 50;\nconst CUSTOMER_TAX_EXEMPT_NUMBER_MAX_LENGTH = 50;\nconst CENTS_PER_DOLLAR = 100;\n\nfunction requireSiteUrl(): string {\n\tconst siteUrl = process.env.NEXT_PUBLIC_SITE_URL;\n\tif (!siteUrl) {\n\t\tthrow new ActionError(\n\t\t\t\"NEXT_PUBLIC_SITE_URL is not configured\",\n\t\t\tERROR_CODES.INTERNAL_SERVER_ERROR,\n\t\t);\n\t}\n\treturn siteUrl.replace(/\\/$/, \"\");\n}\n\nconst customerSchema = z.object({\n\ttype: z\n\t\t.enum([\"residential\", \"commercial\", \"industrial\"])\n\t\t.default(\"residential\"),\n\tfirstName: z\n\t\t.string()\n\t\t.min(1, \"First name is required\")\n\t\t.max(CUSTOMER_NAME_MAX_LENGTH),\n\tlastName: z\n\t\t.string()\n\t\t.min(1, \"Last name is required\")\n\t\t.max(CUSTOMER_NAME_MAX_LENGTH),\n\tcompanyName: z.string().max(CUSTOMER_COMPANY_MAX_LENGTH).optional(),\n\temail: z.string().email(\"Invalid email address\"),\n\tphone: z.string().min(1, \"Phone is required\").max(CUSTOMER_PHONE_MAX_LENGTH),\n\tsecondaryPhone: z.string().max(CUSTOMER_PHONE_MAX_LENGTH).optional(),\n\taddress: z.string().max(CUSTOMER_ADDRESS_MAX_LENGTH).optional(),\n\taddress2: z.string().max(CUSTOMER_ADDRESS2_MAX_LENGTH).optional(),\n\tcity: z.string().max(CUSTOMER_CITY_MAX_LENGTH).optional(),\n\tstate: z.string().max(CUSTOMER_STATE_MAX_LENGTH).optional(),\n\tzipCode: z.string().max(CUSTOMER_ZIP_MAX_LENGTH).optional(),\n\tcountry: z.string().max(CUSTOMER_COUNTRY_MAX_LENGTH).default(\"USA\"),\n\tsource: z\n\t\t.enum([\"referral\", \"google\", \"facebook\", \"direct\", \"yelp\", \"other\"])\n\t\t.optional(),\n\treferredBy: z.string().uuid().optional().nullable(),\n\tpreferredContactMethod: z.enum([\"email\", \"phone\", \"sms\"]).default(\"email\"),\n\tpreferredTechnician: z.string().uuid().optional().nullable(),\n\tbillingEmail: z.string().email().optional().nullable(),\n\tpaymentTerms: z\n\t\t.enum([\"due_on_receipt\", \"net_15\", \"net_30\", \"net_60\"])\n\t\t.default(\"due_on_receipt\"),\n\tcreditLimit: z.number().int().min(0).default(0), // In cents\n\ttaxExempt: z.boolean().default(false),\n\ttaxExemptNumber: z\n\t\t.string()\n\t\t.max(CUSTOMER_TAX_EXEMPT_NUMBER_MAX_LENGTH)\n\t\t.optional(),\n\ttags: z.array(z.string()).optional(),\n\tnotes: z.string().optional(),\n\tinternalNotes: z.string().optional(),\n});\n\nconst communicationPreferencesSchema = z.object({\n\temail: z.boolean().default(true),\n\tsms: z.boolean().default(true),\n\tphone: z.boolean().default(true),\n\tmarketing: z.boolean().default(false),\n});\n\n// ============================================================================\n// CUSTOMER CRUD OPERATIONS\n// ============================================================================\n\n/**\n * Create a new customer with multiple contacts and properties\n */\nasync function createCustomer(\n\tformData: FormData,\n): Promise<ActionResult<string>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\t\tconst { contacts, properties, tags } =\n\t\t\tparseCustomerContactsPropertiesAndTags(formData);\n\t\tconst primaryContact = getPrimaryContactOrThrow(contacts);\n\t\tconst primaryProperty = getPrimaryProperty(properties);\n\n\t\tawait assertCustomerEmailNotDuplicate(\n\t\t\tsupabase,\n\t\t\tteamMember.company_id,\n\t\t\tprimaryContact.email,\n\t\t);\n\n\t\tconst customerType = formData.get(\"type\") || \"residential\";\n\t\tconst companyName = formData.get(\"companyName\");\n\t\tconst displayName = buildCustomerDisplayName(\n\t\t\tcustomerType,\n\t\t\tcompanyName,\n\t\t\tprimaryContact,\n\t\t);\n\n\t\tconst communicationPreferences = buildDefaultCommunicationPreferences();\n\t\tconst customerMetadata = buildCustomerMetadata(contacts);\n\n\t\tconst { lat: customerLat, lon: customerLon } =\n\t\t\tawait geocodePrimaryPropertyIfAvailable(primaryProperty);\n\n\t\tconst customer = await insertCustomerRecord(supabase, {\n\t\t\tcompanyId: teamMember.company_id,\n\t\t\tcustomerType,\n\t\t\tprimaryContact,\n\t\t\tcompanyNameValue: companyName,\n\t\t\tdisplayName,\n\t\t\tprimaryProperty,\n\t\t\tcustomerLat,\n\t\t\tcustomerLon,\n\t\t\tformData,\n\t\t\ttags,\n\t\t\tcommunicationPreferences,\n\t\t\tcustomerMetadata,\n\t\t});\n\n\t\tawait insertAdditionalPropertiesIfAny(\n\t\t\tsupabase,\n\t\t\tteamMember.company_id,\n\t\t\tcustomer.id,\n\t\t\tproperties,\n\t\t);\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\treturn customer.id;\n\t});\n}\n\ntype ParsedCustomerContact = {\n\tfirstName: string;\n\tlastName: string;\n\temail: string;\n\tphone: string;\n\trole: string;\n\tisPrimary: boolean;\n};\n\ntype ParsedCustomerProperty = {\n\tname: string;\n\taddress: string;\n\taddress2: string;\n\tcity: string;\n\tstate: string;\n\tzipCode: string;\n\tcountry: string;\n\tpropertyType: string;\n\tisPrimary: boolean;\n\tnotes: string;\n};\n\ntype ParsedCustomerFormCollections = {\n\tcontacts: ParsedCustomerContact[];\n\tproperties: ParsedCustomerProperty[];\n\ttags?: string[];\n};\n\nasync function requireCustomerCompanyMembership(\n\tsupabase: NonNullable<Awaited<ReturnType<typeof createClient>>>,\n\tuserId: string,\n) {\n\tconst { data: teamMember } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(\"company_id\")\n\t\t.eq(\"user_id\", userId)\n\t\t.single();\n\n\tif (!teamMember?.company_id) {\n\t\tthrow new ActionError(\n\t\t\t\"You must be part of a company\",\n\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t);\n\t}\n\n\treturn teamMember;\n}\n\nfunction parseCustomerContactsPropertiesAndTags(\n\tformData: FormData,\n): ParsedCustomerFormCollections {\n\tconst contacts = parseContacts(formData.get(\"contacts\"));\n\tconst properties = parseProperties(formData.get(\"properties\"));\n\tconst tags = parseTagsField(formData.get(\"tags\"));\n\n\treturn { contacts, properties, tags };\n}\n\nfunction parseContacts(\n\tvalue: FormDataEntryValue | null,\n): ParsedCustomerContact[] {\n\tif (!value || typeof value !== \"string\") {\n\t\treturn [];\n\t}\n\n\ttry {\n\t\treturn JSON.parse(value) as ParsedCustomerContact[];\n\t} catch {\n\t\tthrow new ActionError(\n\t\t\t\"Invalid contacts data\",\n\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t);\n\t}\n}\n\nfunction parseProperties(\n\tvalue: FormDataEntryValue | null,\n): ParsedCustomerProperty[] {\n\tif (!value || typeof value !== \"string\") {\n\t\treturn [];\n\t}\n\n\ttry {\n\t\treturn JSON.parse(value) as ParsedCustomerProperty[];\n\t} catch {\n\t\tthrow new ActionError(\n\t\t\t\"Invalid properties data\",\n\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t);\n\t}\n}\n\nfunction parseTagsField(\n\tvalue: FormDataEntryValue | null,\n): string[] | undefined {\n\tif (!value || typeof value !== \"string\") {\n\t\treturn;\n\t}\n\n\ttry {\n\t\treturn JSON.parse(value) as string[];\n\t} catch {\n\t\treturn value.split(\",\").map((t) => t.trim());\n\t}\n}\n\nfunction getPrimaryContactOrThrow(\n\tcontacts: ParsedCustomerContact[],\n): ParsedCustomerContact {\n\tconst primaryContact = contacts.find((c) => c.isPrimary) || contacts[0];\n\tif (!primaryContact) {\n\t\tthrow new ActionError(\n\t\t\t\"At least one contact is required\",\n\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t);\n\t}\n\treturn primaryContact;\n}\n\nfunction getPrimaryProperty(\n\tproperties: ParsedCustomerProperty[],\n): ParsedCustomerProperty | undefined {\n\treturn properties.find((p) => p.isPrimary) || properties[0];\n}\n\nasync function assertCustomerEmailNotDuplicate(\n\tsupabase: NonNullable<Awaited<ReturnType<typeof createClient>>>,\n\tcompanyId: string,\n\temail: string,\n) {\n\tconst { data: existingEmail } = await supabase\n\t\t.from(\"customers\")\n\t\t.select(\"id\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"email\", email)\n\t\t.is(\"deleted_at\", null)\n\t\t.single();\n\n\tif (existingEmail) {\n\t\tthrow new ActionError(\n\t\t\t\"A customer with this email already exists\",\n\t\t\tERROR_CODES.DB_DUPLICATE_ENTRY,\n\t\t);\n\t}\n}\n\nfunction buildCustomerDisplayName(\n\tcustomerType: FormDataEntryValue | null,\n\tcompanyNameValue: FormDataEntryValue | null,\n\tprimaryContact: ParsedCustomerContact,\n): string {\n\tconst companyName = companyNameValue ? String(companyNameValue) : null;\n\n\tif (customerType === \"commercial\" && companyName) {\n\t\treturn companyName;\n\t}\n\n\treturn `${primaryContact.firstName} ${primaryContact.lastName}`;\n}\n\nfunction buildDefaultCommunicationPreferences() {\n\treturn {\n\t\temail: true,\n\t\tsms: true,\n\t\tphone: true,\n\t\tmarketing: false,\n\t};\n}\n\nfunction buildCustomerMetadata(contacts: ParsedCustomerContact[]) {\n\treturn {\n\t\tcontacts: contacts.map((c) => ({\n\t\t\tfirstName: c.firstName,\n\t\t\tlastName: c.lastName,\n\t\t\temail: c.email,\n\t\t\tphone: c.phone,\n\t\t\trole: c.role,\n\t\t\tisPrimary: c.isPrimary,\n\t\t})),\n\t};\n}\n\nasync function geocodePrimaryPropertyIfAvailable(\n\tprimaryProperty: ParsedCustomerProperty | undefined,\n): Promise<{ lat: number | null; lon: number | null }> {\n\tif (\n\t\t!(\n\t\t\tprimaryProperty?.address &&\n\t\t\tprimaryProperty.city &&\n\t\t\tprimaryProperty.state &&\n\t\t\tprimaryProperty.zipCode\n\t\t)\n\t) {\n\t\treturn { lat: null, lon: null };\n\t}\n\n\tconst geocodeResult = await geocodeAddressSilent(\n\t\tprimaryProperty.address,\n\t\tprimaryProperty.city,\n\t\tprimaryProperty.state,\n\t\tprimaryProperty.zipCode,\n\t\tprimaryProperty.country || \"USA\",\n\t);\n\n\tif (!geocodeResult) {\n\t\treturn { lat: null, lon: null };\n\t}\n\n\treturn { lat: geocodeResult.lat, lon: geocodeResult.lon };\n}\n\ntype InsertCustomerParams = {\n\tcompanyId: string;\n\tcustomerType: FormDataEntryValue | null;\n\tprimaryContact: ParsedCustomerContact;\n\tcompanyNameValue: FormDataEntryValue | null;\n\tdisplayName: string;\n\tprimaryProperty?: ParsedCustomerProperty;\n\tcustomerLat: number | null;\n\tcustomerLon: number | null;\n\tformData: FormData;\n\ttags?: string[];\n\tcommunicationPreferences: {\n\t\temail: boolean;\n\t\tsms: boolean;\n\t\tphone: boolean;\n\t\tmarketing: boolean;\n\t};\n\tcustomerMetadata: Record<string, unknown>;\n};\n\nasync function insertCustomerRecord(\n\tsupabase: NonNullable<Awaited<ReturnType<typeof createClient>>>,\n\tparams: InsertCustomerParams,\n) {\n\tconst payload = buildCustomerInsertPayload(params);\n\n\tconst { data: customer, error: createError } = await supabase\n\t\t.from(\"customers\")\n\t\t.insert(payload)\n\t\t.select(\"id\")\n\t\t.single();\n\n\tif (createError || !customer) {\n\t\tthrow new ActionError(\n\t\t\tERROR_MESSAGES.operationFailed(\"create customer\"),\n\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t);\n\t}\n\n\treturn customer;\n}\n\nfunction buildCustomerInsertPayload(\n\tparams: InsertCustomerParams,\n): Record<string, unknown> {\n\tconst {\n\t\tcompanyId,\n\t\tcustomerType,\n\t\tprimaryContact,\n\t\tcompanyNameValue,\n\t\tdisplayName,\n\t\tprimaryProperty,\n\t\tcustomerLat,\n\t\tcustomerLon,\n\t\tformData,\n\t\ttags,\n\t\tcommunicationPreferences,\n\t\tcustomerMetadata,\n\t} = params;\n\n\tconst companyName = companyNameValue ? String(companyNameValue) : null;\n\n\treturn {\n\t\tcompany_id: companyId,\n\t\ttype: String(customerType || \"residential\"),\n\t\tfirst_name: primaryContact.firstName,\n\t\tlast_name: primaryContact.lastName,\n\t\tcompany_name: companyName,\n\t\tdisplay_name: displayName,\n\t\temail: primaryContact.email,\n\t\tphone: primaryContact.phone,\n\t\tsecondary_phone: null,\n\t\taddress: primaryProperty?.address || null,\n\t\taddress2: primaryProperty?.address2 || null,\n\t\tcity: primaryProperty?.city || null,\n\t\tstate: primaryProperty?.state || null,\n\t\tzip_code: primaryProperty?.zipCode || null,\n\t\tcountry: primaryProperty?.country || \"USA\",\n\t\tlat: customerLat,\n\t\tlon: customerLon,\n\t\tsource: formData.get(\"source\") ? String(formData.get(\"source\")) : null,\n\t\treferred_by: formData.get(\"referredBy\")\n\t\t\t? String(formData.get(\"referredBy\"))\n\t\t\t: null,\n\t\tpreferred_contact_method:\n\t\t\tString(formData.get(\"preferredContactMethod\")) || \"email\",\n\t\tpreferred_technician: formData.get(\"preferredTechnician\")\n\t\t\t? String(formData.get(\"preferredTechnician\"))\n\t\t\t: null,\n\t\tbilling_email: formData.get(\"billingEmail\")\n\t\t\t? String(formData.get(\"billingEmail\"))\n\t\t\t: null,\n\t\tpayment_terms: String(formData.get(\"paymentTerms\")) || \"due_on_receipt\",\n\t\tcredit_limit: formData.get(\"creditLimit\")\n\t\t\t? Number(formData.get(\"creditLimit\")) * CENTS_PER_DOLLAR\n\t\t\t: 0,\n\t\ttax_exempt: formData.get(\"taxExempt\") === \"on\",\n\t\ttax_exempt_number: formData.get(\"taxExemptNumber\")\n\t\t\t? String(formData.get(\"taxExemptNumber\"))\n\t\t\t: null,\n\t\ttags: tags || null,\n\t\tcommunication_preferences: communicationPreferences,\n\t\tnotes: formData.get(\"notes\") ? String(formData.get(\"notes\")) : null,\n\t\tinternal_notes: formData.get(\"internalNotes\")\n\t\t\t? String(formData.get(\"internalNotes\"))\n\t\t\t: null,\n\t\tmetadata: customerMetadata,\n\t\tstatus: \"active\",\n\t\tportal_enabled: false,\n\t\ttotal_revenue: 0,\n\t\ttotal_jobs: 0,\n\t\ttotal_invoices: 0,\n\t\taverage_job_value: 0,\n\t\toutstanding_balance: 0,\n\t};\n}\n\nasync function insertAdditionalPropertiesIfAny(\n\tsupabase: NonNullable<Awaited<ReturnType<typeof createClient>>>,\n\tcompanyId: string,\n\tcustomerId: string,\n\tproperties: ParsedCustomerProperty[],\n) {\n\tconst additionalProperties = properties.filter((p) => !p.isPrimary);\n\tif (additionalProperties.length === 0) {\n\t\treturn;\n\t}\n\n\tconst propertiesToInsert = await Promise.all(\n\t\tadditionalProperties.map(async (prop) => {\n\t\t\tlet propLat: number | null = null;\n\t\t\tlet propLon: number | null = null;\n\n\t\t\tif (prop.address && prop.city && prop.state && prop.zipCode) {\n\t\t\t\tconst geocodeResult = await geocodeAddressSilent(\n\t\t\t\t\tprop.address,\n\t\t\t\t\tprop.city,\n\t\t\t\t\tprop.state,\n\t\t\t\t\tprop.zipCode,\n\t\t\t\t\tprop.country || \"USA\",\n\t\t\t\t);\n\n\t\t\t\tif (geocodeResult) {\n\t\t\t\t\tpropLat = geocodeResult.lat;\n\t\t\t\t\tpropLon = geocodeResult.lon;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: customerId,\n\t\t\t\tname: prop.name || \"Additional Property\",\n\t\t\t\taddress: prop.address,\n\t\t\t\taddress2: prop.address2 || null,\n\t\t\t\tcity: prop.city,\n\t\t\t\tstate: prop.state,\n\t\t\t\tzip_code: prop.zipCode,\n\t\t\t\tcountry: prop.country || \"USA\",\n\t\t\t\tproperty_type: prop.propertyType || \"residential\",\n\t\t\t\tnotes: prop.notes || null,\n\t\t\t\tlat: propLat,\n\t\t\t\tlon: propLon,\n\t\t\t};\n\t\t}),\n\t);\n\n\tawait supabase.from(\"properties\").insert(propertiesToInsert);\n}\n\n/**\n * Update existing customer\n */\nasync function updateCustomer(\n\tcustomerId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id, email\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Parse tags if provided\n\t\tlet tags: string[] | undefined;\n\t\tconst tagsString = formData.get(\"tags\");\n\t\tif (tagsString && typeof tagsString === \"string\") {\n\t\t\ttry {\n\t\t\t\ttags = JSON.parse(tagsString);\n\t\t\t} catch {\n\t\t\t\ttags = tagsString.split(\",\").map((t) => t.trim());\n\t\t\t}\n\t\t}\n\n\t\t// Validate input\n\t\tconst data = customerSchema.parse({\n\t\t\ttype: formData.get(\"type\") || \"residential\",\n\t\t\tfirstName: formData.get(\"firstName\"),\n\t\t\tlastName: formData.get(\"lastName\"),\n\t\t\tcompanyName: formData.get(\"companyName\") || undefined,\n\t\t\temail: formData.get(\"email\"),\n\t\t\tphone: formData.get(\"phone\"),\n\t\t\tsecondaryPhone: formData.get(\"secondaryPhone\") || undefined,\n\t\t\taddress: formData.get(\"address\") || undefined,\n\t\t\taddress2: formData.get(\"address2\") || undefined,\n\t\t\tcity: formData.get(\"city\") || undefined,\n\t\t\tstate: formData.get(\"state\") || undefined,\n\t\t\tzipCode: formData.get(\"zipCode\") || undefined,\n\t\t\tcountry: formData.get(\"country\") || \"USA\",\n\t\t\tsource: formData.get(\"source\") || undefined,\n\t\t\treferredBy: formData.get(\"referredBy\") || null,\n\t\t\tpreferredContactMethod: formData.get(\"preferredContactMethod\") || \"email\",\n\t\t\tpreferredTechnician: formData.get(\"preferredTechnician\") || null,\n\t\t\tbillingEmail: formData.get(\"billingEmail\") || null,\n\t\t\tpaymentTerms: formData.get(\"paymentTerms\") || \"due_on_receipt\",\n\t\t\tcreditLimit: formData.get(\"creditLimit\")\n\t\t\t\t? Number(formData.get(\"creditLimit\"))\n\t\t\t\t: 0,\n\t\t\ttaxExempt: formData.get(\"taxExempt\") === \"true\",\n\t\t\ttaxExemptNumber: formData.get(\"taxExemptNumber\") || undefined,\n\t\t\ttags,\n\t\t\tnotes: formData.get(\"notes\") || undefined,\n\t\t\tinternalNotes: formData.get(\"internalNotes\") || undefined,\n\t\t});\n\n\t\t// Check if email already exists (excluding current customer)\n\t\tif (data.email !== customer.email) {\n\t\t\tconst { data: existingEmail } = await supabase\n\t\t\t\t.from(\"customers\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t\t.eq(\"email\", data.email)\n\t\t\t\t.neq(\"id\", customerId)\n\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t.single();\n\n\t\t\tif (existingEmail) {\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\t\"A customer with this email already exists\",\n\t\t\t\t\tERROR_CODES.DB_DUPLICATE_ENTRY,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Generate display name\n\t\tconst displayName =\n\t\t\tdata.type === \"commercial\" && data.companyName\n\t\t\t\t? data.companyName\n\t\t\t\t: `${data.firstName} ${data.lastName}`;\n\n\t\tconst companyName = data.companyName ? String(data.companyName) : null;\n\n\t\t// Update customer\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({\n\t\t\t\ttype: data.type,\n\t\t\t\tfirst_name: data.firstName,\n\t\t\t\tlast_name: data.lastName,\n\t\t\t\tcompany_name: companyName,\n\t\t\t\tdisplay_name: displayName,\n\t\t\t\temail: data.email,\n\t\t\t\tphone: data.phone,\n\t\t\t\tsecondary_phone: data.secondaryPhone,\n\t\t\t\taddress: data.address,\n\t\t\t\taddress2: data.address2,\n\t\t\t\tcity: data.city,\n\t\t\t\tstate: data.state,\n\t\t\t\tzip_code: data.zipCode,\n\t\t\t\tcountry: data.country,\n\t\t\t\tsource: data.source,\n\t\t\t\treferred_by: data.referredBy,\n\t\t\t\tpreferred_contact_method: data.preferredContactMethod,\n\t\t\t\tpreferred_technician: data.preferredTechnician,\n\t\t\t\tbilling_email: data.billingEmail,\n\t\t\t\tpayment_terms: data.paymentTerms,\n\t\t\t\tcredit_limit: data.creditLimit,\n\t\t\t\ttax_exempt: data.taxExempt,\n\t\t\t\ttax_exempt_number: data.taxExemptNumber,\n\t\t\t\ttags: data.tags,\n\t\t\t\tnotes: data.notes,\n\t\t\t\tinternal_notes: data.internalNotes,\n\t\t\t})\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update customer\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n/**\n * Delete customer (soft delete/archive)\n */\nexport async function deleteCustomer(\n\tcustomerId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id, outstanding_balance\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Prevent deletion if customer has outstanding balance\n\t\tif (customer.outstanding_balance > 0) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Cannot delete customer with outstanding balance. Collect payment first.\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Soft delete\n\t\tconst { error: deleteError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: user.id,\n\t\t\t\tstatus: \"archived\",\n\t\t\t})\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (deleteError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"delete customer\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t});\n}\n\n// ============================================================================\n// CUSTOMER STATUS & PREFERENCES\n// ============================================================================\n\n/**\n * Update customer status\n */\nasync function updateCustomerStatus(\n\tcustomerId: string,\n\tstatus: \"active\" | \"inactive\" | \"archived\" | \"blocked\",\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Update status\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({ status })\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update customer status\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n/**\n * Update communication preferences\n */\nasync function updateCommunicationPreferences(\n\tcustomerId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Validate input\n\t\tconst preferences = communicationPreferencesSchema.parse({\n\t\t\temail: formData.get(\"email\") === \"true\",\n\t\t\tsms: formData.get(\"sms\") === \"true\",\n\t\t\tphone: formData.get(\"phone\") === \"true\",\n\t\t\tmarketing: formData.get(\"marketing\") === \"true\",\n\t\t});\n\n\t\t// Update preferences\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({ communication_preferences: preferences })\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update communication preferences\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n// ============================================================================\n// CUSTOMER PORTAL\n// ============================================================================\n\n/**\n * Invite customer to portal\n * Sends an email with a secure token-based invitation link.\n */\nasync function inviteToPortal(\n\tcustomerId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id, email, display_name, portal_enabled\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\tif (customer.portal_enabled) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer is already invited to portal\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Generate secure portal invitation token\n\t\tconst inviteToken = Buffer.from(\n\t\t\t`${customerId}:${Date.now()}:${Math.random()}`,\n\t\t).toString(\"base64url\");\n\n\t\t// Update customer\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({\n\t\t\t\tportal_enabled: true,\n\t\t\t\tportal_invited_at: new Date().toISOString(),\n\t\t\t})\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"invite customer to portal\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Send invitation email\n\t\tconst siteUrl = requireSiteUrl();\n\t\tconst portalUrl = `${siteUrl}/portal/setup?token=${inviteToken}`;\n\n\t\tconst emailResult = await sendEmail({\n\t\t\tto: customer.email,\n\t\t\tsubject: \"You've been invited to your Customer Portal\",\n\t\t\ttemplate: PortalInvitationEmail({\n\t\t\t\tcustomerName: customer.display_name,\n\t\t\t\tportalUrl,\n\t\t\t\texpiresInHours: 168, // 7 days\n\t\t\t\tsupportEmail: process.env.RESEND_FROM_EMAIL || \"support@thorbis.com\",\n\t\t\t\tsupportPhone: \"(555) 123-4567\",\n\t\t\t}),\n\t\t\ttemplateType: EmailTemplate.PORTAL_INVITATION,\n\t\t});\n\n\t\tif (!emailResult.success) {\n\t\t\treturn;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n/**\n * Revoke portal access\n */\nasync function revokePortalAccess(\n\tcustomerId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Revoke access\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({ portal_enabled: false })\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"revoke portal access\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n// ============================================================================\n// SEARCH & REPORTING\n// ============================================================================\n\n/**\n * Get customer by phone number\n * Used for incoming call lookups\n */\nexport async function getCustomerByPhone(\n\tphoneNumber: string,\n\tcompanyId: string,\n): Promise<ActionResult<unknown>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Normalize phone number (remove formatting)\n\t\tconst normalizedPhone = phoneNumber.replace(/\\D/g, \"\");\n\n\t\t// Search by primary phone or secondary phone\n\t\tconst { data: customer, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        properties:properties(*)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.or(\n\t\t\t\t`phone.eq.${phoneNumber},phone.eq.${normalizedPhone},secondary_phone.eq.${phoneNumber},secondary_phone.eq.${normalizedPhone}`,\n\t\t\t)\n\t\t\t.single();\n\n\t\tif (error && error.code !== \"PGRST116\") {\n\t\t\t// PGRST116 = no rows found\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to find customer: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn customer || null;\n\t});\n}\n\n/**\n * Search customers by name, email, phone, or company\n */\nexport async function searchCustomers(\n\tsearchTerm: string,\n\toptions?: { limit?: number; offset?: number },\n): Promise<ActionResult<unknown[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Use the active company ID helper (same as getAllCustomers)\n\t\tconst activeCompanyId = await getActiveCompanyId();\n\t\tif (!activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"No active company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Verify user has access to the active company\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.maybeSingle();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You don't have access to this company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Use full-text search with ranking for best matches\n\t\t// Searches across: first_name, last_name, display_name, email, phone,\n\t\t// secondary_phone, company_name, address, city, state\n\t\t// Returns results ordered by relevance (weighted: name > contact > address)\n\t\tconst { searchCustomersFullText } = await import(\n\t\t\t\"@/lib/search/full-text-search\"\n\t\t);\n\n\t\tconst customers = await searchCustomersFullText(\n\t\t\tsupabase,\n\t\t\tactiveCompanyId,\n\t\t\tsearchTerm,\n\t\t\t{\n\t\t\t\tlimit: options?.limit || DEFAULT_SEARCH_LIMIT,\n\t\t\t\toffset: options?.offset || 0,\n\t\t\t},\n\t\t);\n\n\t\treturn customers;\n\t});\n}\n\n/**\n * Get top customers by revenue\n */\nasync function getTopCustomers(\n\tlimit = 10,\n): Promise<ActionResult<unknown[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\tconst { data: customers, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"total_revenue\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch top customers\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn customers || [];\n\t});\n}\n\n/**\n * Get customers with outstanding balance\n */\ntype CustomerWithBalance = {\n\tid: string;\n\tdisplay_name: string;\n\tbalance: number;\n};\n\nasync function getCustomersWithBalance(): Promise<\n\tActionResult<CustomerWithBalance[]>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\tconst { data: customers, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.gt(\"outstanding_balance\", 0)\n\t\t\t.order(\"outstanding_balance\", { ascending: false })\n\t\t\t.limit(100);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch customers with balance\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn customers || [];\n\t});\n}\n\ntype CustomerRecord = {\n\tid: string;\n\tcompany_id: string;\n\ttype: string;\n\tfirst_name: string;\n\tlast_name: string;\n\tdisplay_name: string;\n\tcompany_name?: string | null;\n\temail: string;\n\tphone: string;\n\tsecondary_phone?: string;\n\taddress?: string;\n\taddress2?: string;\n\tcity?: string;\n\tstate?: string;\n\tzip_code?: string;\n\tstatus: string;\n\ttotal_revenue?: number;\n\ttotal_jobs?: number;\n\ttotal_invoices?: number;\n\toutstanding_balance?: number;\n\tlast_job_date?: string;\n\tnext_scheduled_job?: string;\n\tcreated_at: string;\n\tupdated_at: string;\n\tarchived_at?: string | null;\n\tdeleted_at?: string | null;\n};\n\n/**\n * Get customers for phone dialer (lightweight, no enrichment)\n *\n * PERFORMANCE: Returns only basic contact info needed for dialer.\n * Use this instead of getAllCustomers() in AppHeader to avoid N+1 queries.\n *\n * Expected: 50-100ms (single query)\n * vs getAllCustomers(): 1200-2000ms (151 queries with enrichment)\n */\nexport async function getCustomersForDialer(): Promise<\n\tActionResult<\n\t\tArray<{\n\t\t\tid: string;\n\t\t\tfirst_name: string | null;\n\t\t\tlast_name: string | null;\n\t\t\tdisplay_name: string | null;\n\t\t\temail: string | null;\n\t\t\tphone: string | null;\n\t\t\tsecondary_phone?: string | null;\n\t\t\tcompany_name: string | null;\n\t\t\taddress: string | null;\n\t\t\taddress2: string | null;\n\t\t\tcity: string | null;\n\t\t\tstate: string | null;\n\t\t\tzip_code: string | null;\n\t\t}>\n\t>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst activeCompanyId = await getActiveCompanyId();\n\t\tif (!activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"No active company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Single lightweight query - no joins, no enrichment\n\t\tconst { data: customers, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\n\t\t\t\t\"id, first_name, last_name, display_name, email, phone, secondary_phone, company_name, address, address2, city, state, zip_code\",\n\t\t\t)\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"display_name\", { ascending: true });\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch customers\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn customers || [];\n\t});\n}\n\n/**\n * Get all customers for the current company (WITH ENRICHMENT)\n *\n * WARNING: This function does 151 database queries for 50 customers (N+1 pattern).\n * Expected time: 1200-2000ms\n *\n * DO NOT use in AppHeader or other frequently rendered components.\n * Use getCustomersForDialer() instead for lightweight contact info.\n *\n * Only use this on dedicated customer list pages where the enriched data is needed.\n */\nasync function getAllCustomers(): Promise<\n\tActionResult<CustomerRecord[]>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID (from cookie or first available)\n\t\tconst activeCompanyId = await getActiveCompanyId();\n\n\t\tconst FORBIDDEN_STATUS_CODE = 403;\n\t\tif (!activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tFORBIDDEN_STATUS_CODE,\n\t\t\t);\n\t\t}\n\n\t\t// Verify user has access to the active company\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.maybeSingle();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You don't have access to this company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tFORBIDDEN_STATUS_CODE,\n\t\t\t);\n\t\t}\n\n\t\tconst { data: customers, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"display_name\", { ascending: true });\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch customers\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// PERFORMANCE OPTIMIZED: Use RPC function instead of N+1 queries\n\t\t// BEFORE: 151 queries for 50 customers (1 base + 50  3 queries each)\n\t\t// AFTER: 1 RPC call with efficient LATERAL joins\n\t\t// Performance gain: 5-10 seconds faster\n\n\t\t// Note: customers variable contains the base customer data from above query\n\t\t// We replace the enrichment logic with a single RPC call\n\t\tconst { data: enrichedData, error: enrichError } = await supabase.rpc(\n\t\t\t\"get_enriched_customers_rpc\",\n\t\t\t{\n\t\t\t\tp_company_id: activeCompanyId,\n\t\t\t},\n\t\t);\n\n\t\tif (enrichError) {\n\t\t\t// Fallback to base customers if enrichment fails\n\t\t\tconsole.error(\"Failed to enrich customers:\", enrichError);\n\t\t\treturn customers as CustomerRecord[];\n\t\t}\n\n\t\t// Merge enriched data with base customer data\n\t\tconst enrichedCustomers = (enrichedData || []).map((customer: any) => ({\n\t\t\t...customer,\n\t\t\t// Override total_jobs and total_revenue with fresh aggregated values\n\t\t\ttotal_jobs: customer.enriched_total_jobs || customer.total_jobs || 0,\n\t\t\ttotal_revenue:\n\t\t\t\tcustomer.enriched_total_revenue || customer.total_revenue || 0,\n\t\t}));\n\n\t\treturn enrichedCustomers as CustomerRecord[];\n\t});\n}\n\n/**\n * Update customer page content (Novel/Tiptap JSON)\n *\n * Saves the customer's editable page layout and content\n * Used by the Novel editor for auto-save functionality\n */\nasync function updateCustomerPageContent(\n\tcustomerId: string,\n\tpageContent: Record<string, unknown>,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"customer\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Update page content\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({\n\t\t\t\tpage_content: pageContent,\n\t\t\t\tcontent_updated_by: user.id,\n\t\t\t})\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update customer page\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n"],"names":[],"mappings":";;;;;;;IA0lCsB,qBAAA,WAAA,GAAA,IAAA,yZAAA,EAAA,8CAAA,8YAAA,EAAA,KAAA,GAAA,oZAAA,EAAA"}},
    {"offset": {"line": 336, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/hooks/use-customer-lookup.ts"],"sourcesContent":["/**\n * useCustomerLookup - React 19 Hook\n *\n * Performance optimizations:\n * - Uses useState + useEffect for client-side data fetching\n * - Fetches customer data by phone number for incoming call identification\n *\n * Fetches customer data by phone number for incoming call identification.\n */\n\n\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { getCustomerByPhone } from \"@/actions/customers\";\n\n// AI Trust Scores\nconst AI_HIGH_TRUST_SCORE = 0.9;\nconst AI_MEDIUM_TRUST_SCORE = 0.5;\n\nexport type CustomerData = {\n\tname: string;\n\temail: string;\n\tphone: string;\n\tcompany: string;\n\taccountStatus: string;\n\tlastContact: string;\n\ttotalCalls: number;\n\topenTickets: number;\n\tpriority: \"low\" | \"medium\" | \"high\";\n\ttags: string[];\n\trecentIssues: string[];\n\taiData: {\n\t\tisKnownCustomer: boolean;\n\t\tisSpam: boolean;\n\t\tspamConfidence: number;\n\t\trecognitionSource: \"crm\" | \"unknown\";\n\t\ttrustScore: number;\n\t\tcallHistory: string[];\n\t\tsimilarCallers: number;\n\t\triskLevel: \"low\" | \"medium\" | \"high\";\n\t\taiNotes: string[];\n\t};\n};\n\nconst getDefaultCustomerData = (callerNumber?: string): CustomerData => ({\n\tname: \"Unknown Customer\",\n\temail: \"\",\n\tphone: callerNumber || \"Unknown\",\n\tcompany: \"\",\n\taccountStatus: \"Unknown\",\n\tlastContact: \"Never\",\n\ttotalCalls: 0,\n\topenTickets: 0,\n\tpriority: \"medium\",\n\ttags: [],\n\trecentIssues: [],\n\taiData: {\n\t\tisKnownCustomer: false,\n\t\tisSpam: false,\n\t\tspamConfidence: 0,\n\t\trecognitionSource: \"unknown\",\n\t\ttrustScore: AI_MEDIUM_TRUST_SCORE,\n\t\tcallHistory: [],\n\t\tsimilarCallers: 0,\n\t\triskLevel: \"medium\",\n\t\taiNotes: [\n\t\t\t\"First-time caller\",\n\t\t\t\"No prior history\",\n\t\t\t\"Standard verification recommended\",\n\t\t],\n\t},\n});\n\nexport function useCustomerLookup(callerNumber?: string, companyId?: string) {\n\tconst [data, setData] = useState<CustomerData | null>(null);\n\tconst [error, setError] = useState<Error | null>(null);\n\tconst [isLoading, setIsLoading] = useState(false);\n\n\tuseEffect(() => {\n\t\tif (!callerNumber || !companyId) {\n\t\t\tsetData(getDefaultCustomerData(callerNumber));\n\t\t\treturn;\n\t\t}\n\n\t\tconst fetchCustomer = async () => {\n\t\t\tsetIsLoading(true);\n\t\t\tsetError(null);\n\n\t\t\ttry {\n\t\t\t\tconst result = await getCustomerByPhone(callerNumber, companyId);\n\n\t\t\t\tif (result.success && result.data) {\n\t\t\t\t\tconst customer = result.data;\n\n\t\t\t\t\t// Customer found - return enriched data\n\t\t\t\t\tsetData({\n\t\t\t\t\t\tname: `${customer.first_name} ${customer.last_name}`,\n\t\t\t\t\t\temail: customer.email || \"\",\n\t\t\t\t\t\tphone: customer.phone || callerNumber,\n\t\t\t\t\t\tcompany: customer.company_name || \"\",\n\t\t\t\t\t\taccountStatus: customer.status || \"Active\",\n\t\t\t\t\t\tlastContact: customer.last_contact_date\n\t\t\t\t\t\t\t? new Date(customer.last_contact_date).toLocaleDateString()\n\t\t\t\t\t\t\t: \"Unknown\",\n\t\t\t\t\t\ttotalCalls: customer.total_interactions || 0,\n\t\t\t\t\t\topenTickets: 0, // Would need to query jobs/tickets table\n\t\t\t\t\t\tpriority: (customer.priority_level || \"medium\") as\n\t\t\t\t\t\t\t| \"low\"\n\t\t\t\t\t\t\t| \"medium\"\n\t\t\t\t\t\t\t| \"high\",\n\t\t\t\t\t\ttags: customer.tags || [],\n\t\t\t\t\t\trecentIssues: [], // Would need to query jobs table\n\t\t\t\t\t\taiData: {\n\t\t\t\t\t\t\tisKnownCustomer: true,\n\t\t\t\t\t\t\tisSpam: false,\n\t\t\t\t\t\t\tspamConfidence: 0,\n\t\t\t\t\t\t\trecognitionSource: \"crm\",\n\t\t\t\t\t\t\ttrustScore: AI_HIGH_TRUST_SCORE,\n\t\t\t\t\t\t\tcallHistory: [], // Would need to query communications table\n\t\t\t\t\t\t\tsimilarCallers: 0,\n\t\t\t\t\t\t\triskLevel: \"low\",\n\t\t\t\t\t\t\taiNotes: [\n\t\t\t\t\t\t\t\t`Customer since ${customer.created_at ? new Date(customer.created_at).getFullYear() : \"Unknown\"}`,\n\t\t\t\t\t\t\t\t\"Verified customer\",\n\t\t\t\t\t\t\t\t\"Account in good standing\",\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\t// Customer not found - return default\n\t\t\t\t\tsetData(getDefaultCustomerData(callerNumber));\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\t// Error fetching - return default with error note\n\t\t\t\tconst defaultData = getDefaultCustomerData(callerNumber);\n\t\t\t\tdefaultData.aiData.aiNotes = [\"Error loading customer data\"];\n\t\t\t\tsetData(defaultData);\n\t\t\t\tsetError(\n\t\t\t\t\terr instanceof Error ? err : new Error(\"Failed to fetch customer\"),\n\t\t\t\t);\n\t\t\t} finally {\n\t\t\t\tsetIsLoading(false);\n\t\t\t}\n\t\t};\n\n\t\tfetchCustomer();\n\t}, [callerNumber, companyId]);\n\n\treturn { data, error, isLoading };\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC;;;;AAID;AACA;;AAHA;;;AAKA,kBAAkB;AAClB,MAAM,sBAAsB;AAC5B,MAAM,wBAAwB;AA2B9B,MAAM,yBAAyB,CAAC,eAAwC,CAAC;QACxE,MAAM;QACN,OAAO;QACP,OAAO,gBAAgB;QACvB,SAAS;QACT,eAAe;QACf,aAAa;QACb,YAAY;QACZ,aAAa;QACb,UAAU;QACV,MAAM,EAAE;QACR,cAAc,EAAE;QAChB,QAAQ;YACP,iBAAiB;YACjB,QAAQ;YACR,gBAAgB;YAChB,mBAAmB;YACnB,YAAY;YACZ,aAAa,EAAE;YACf,gBAAgB;YAChB,WAAW;YACX,SAAS;gBACR;gBACA;gBACA;aACA;QACF;IACD,CAAC;AAEM,SAAS,kBAAkB,YAAqB,EAAE,SAAkB;;IAC1E,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,gVAAQ,EAAsB;IACtD,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,gVAAQ,EAAe;IACjD,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,gVAAQ,EAAC;IAE3C,IAAA,iVAAS;uCAAC;YACT,IAAI,CAAC,gBAAgB,CAAC,WAAW;gBAChC,QAAQ,uBAAuB;gBAC/B;YACD;YAEA,MAAM;6DAAgB;oBACrB,aAAa;oBACb,SAAS;oBAET,IAAI;wBACH,MAAM,SAAS,MAAM,IAAA,8LAAkB,EAAC,cAAc;wBAEtD,IAAI,OAAO,OAAO,IAAI,OAAO,IAAI,EAAE;4BAClC,MAAM,WAAW,OAAO,IAAI;4BAE5B,wCAAwC;4BACxC,QAAQ;gCACP,MAAM,GAAG,SAAS,UAAU,CAAC,CAAC,EAAE,SAAS,SAAS,EAAE;gCACpD,OAAO,SAAS,KAAK,IAAI;gCACzB,OAAO,SAAS,KAAK,IAAI;gCACzB,SAAS,SAAS,YAAY,IAAI;gCAClC,eAAe,SAAS,MAAM,IAAI;gCAClC,aAAa,SAAS,iBAAiB,GACpC,IAAI,KAAK,SAAS,iBAAiB,EAAE,kBAAkB,KACvD;gCACH,YAAY,SAAS,kBAAkB,IAAI;gCAC3C,aAAa;gCACb,UAAW,SAAS,cAAc,IAAI;gCAItC,MAAM,SAAS,IAAI,IAAI,EAAE;gCACzB,cAAc,EAAE;gCAChB,QAAQ;oCACP,iBAAiB;oCACjB,QAAQ;oCACR,gBAAgB;oCAChB,mBAAmB;oCACnB,YAAY;oCACZ,aAAa,EAAE;oCACf,gBAAgB;oCAChB,WAAW;oCACX,SAAS;wCACR,CAAC,eAAe,EAAE,SAAS,UAAU,GAAG,IAAI,KAAK,SAAS,UAAU,EAAE,WAAW,KAAK,WAAW;wCACjG;wCACA;qCACA;gCACF;4BACD;wBACD,OAAO;4BACN,sCAAsC;4BACtC,QAAQ,uBAAuB;wBAChC;oBACD,EAAE,OAAO,KAAK;wBACb,kDAAkD;wBAClD,MAAM,cAAc,uBAAuB;wBAC3C,YAAY,MAAM,CAAC,OAAO,GAAG;4BAAC;yBAA8B;wBAC5D,QAAQ;wBACR,SACC,eAAe,QAAQ,MAAM,IAAI,MAAM;oBAEzC,SAAU;wBACT,aAAa;oBACd;gBACD;;YAEA;QACD;sCAAG;QAAC;QAAc;KAAU;IAE5B,OAAO;QAAE;QAAM;QAAO;IAAU;AACjC;GA5EgB"}},
    {"offset": {"line": 470, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/telnyx.ts"],"sourcesContent":["/**\n * Telnyx Server Actions\n *\n * Server-side actions for Telnyx VoIP operations:\n * - Phone number management\n * - Call operations\n * - SMS operations\n * - Voicemail operations\n *\n * All actions include proper authentication and authorization checks.\n */\n\n\"use server\";\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { revalidatePath } from \"next/cache\";\nimport { headers } from \"next/headers\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport {\n\tanswerCall,\n\thangupCall,\n\tinitiateCall,\n\trejectCall,\n\tstartRecording,\n\tstopRecording,\n} from \"@/lib/telnyx/calls\";\nimport { TELNYX_CONFIG } from \"@/lib/telnyx/client\";\nimport {\n\tvalidateCallConfig,\n\tvalidateSmsConfig,\n} from \"@/lib/telnyx/config-validator\";\nimport { verifyConnection } from \"@/lib/telnyx/connection-setup\";\nimport { formatPhoneNumber, sendMMS, sendSMS } from \"@/lib/telnyx/messaging\";\nimport { verifyMessagingProfile } from \"@/lib/telnyx/messaging-profile-setup\";\nimport {\n\ttype NumberFeature,\n\ttype NumberType,\n\tpurchaseNumber,\n\treleaseNumber,\n\tsearchAvailableNumbers,\n} from \"@/lib/telnyx/numbers\";\nimport {\n\tverifySmsCapability,\n\tverifyVoiceCapability,\n} from \"@/lib/telnyx/phone-number-setup\";\nimport {\n\ttype CompanyTelnyxSettingsRow,\n\tensureCompanyTelnyxSetup,\n\tfetchCompanyTelnyxSettings,\n} from \"@/lib/telnyx/provision-company\";\nimport type { Database, Json } from \"@/types/supabase\";\nimport { ensureMessagingCampaign } from \"./messaging-branding\";\n\ntype TypedSupabaseClient = SupabaseClient<Database>;\n\nfunction normalizePhoneNumber(phoneNumber: string): string {\n\treturn formatPhoneNumber(phoneNumber);\n}\n\nfunction extractAreaCode(phoneNumber: string): string | null {\n\tconst digits = phoneNumber.replace(/\\D/g, \"\");\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn digits.slice(1, 4);\n\t}\n\tif (digits.length === 10) {\n\t\treturn digits.slice(0, 3);\n\t}\n\treturn null;\n}\n\nconst DEFAULT_MESSAGING_PROFILE_ID =\n\tprocess.env.TELNYX_DEFAULT_MESSAGING_PROFILE_ID ||\n\tprocess.env.NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID ||\n\t\"\";\n\nconst DEFAULT_PHONE_NUMBER_FEATURES: Json = [\"voice\", \"sms\", \"mms\"];\n\nfunction formatDisplayPhoneNumber(phoneNumber: string): string {\n\tconst digits = phoneNumber.replace(/\\D/g, \"\");\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn `+1 (${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;\n\t}\n\tif (digits.length === 10) {\n\t\treturn `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;\n\t}\n\treturn phoneNumber;\n}\n\nasync function getCompanyTelnyxSettings(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string | null,\n): Promise<CompanyTelnyxSettingsRow | null> {\n\tif (!companyId) {\n\t\treturn null;\n\t}\n\n\tconst existing = await fetchCompanyTelnyxSettings(supabase, companyId);\n\tif (existing && existing.status === \"ready\") {\n\t\treturn existing;\n\t}\n\n\tconst provisionResult = await ensureCompanyTelnyxSetup({\n\t\tcompanyId,\n\t\tsupabase,\n\t});\n\n\tif (!provisionResult.success) {\n\t\treturn null;\n\t}\n\n\treturn provisionResult.settings ?? null;\n}\n\nfunction normalizeBaseUrl(url: string): string {\n\tconst trimmed = url.trim().replace(/\\/+$/, \"\");\n\tif (/^https?:\\/\\//i.test(trimmed)) {\n\t\tif (/^http:\\/\\//i.test(trimmed) && !isLocalUrl(trimmed)) {\n\t\t\treturn trimmed.replace(/^http:\\/\\//i, \"https://\");\n\t\t}\n\t\treturn trimmed;\n\t}\n\treturn `https://${trimmed}`;\n}\n\nfunction isLocalUrl(url: string): boolean {\n\tconst lowered = url.toLowerCase();\n\treturn (\n\t\tlowered.includes(\"localhost\") ||\n\t\tlowered.includes(\"127.0.0.1\") ||\n\t\tlowered.includes(\"0.0.0.0\") ||\n\t\tlowered.endsWith(\".local\") ||\n\t\tlowered.includes(\"://local\")\n\t);\n}\n\nfunction shouldUseUrl(url: string): boolean {\n\tif (!url) {\n\t\treturn false;\n\t}\n\tconst trimmed = url.trim();\n\tif (!trimmed) {\n\t\treturn false;\n\t}\n\tconst isHostedProduction =\n\t\t(process.env.VERCEL === \"1\" && process.env.VERCEL_ENV === \"production\") ||\n\t\tprocess.env.DEPLOYMENT_ENV === \"production\";\n\n\tif (isHostedProduction && isLocalUrl(trimmed)) {\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nasync function getBaseAppUrl(): Promise<string | undefined> {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\tfor (const candidate of candidates) {\n\t\tif (candidate && shouldUseUrl(candidate)) {\n\t\t\treturn normalizeBaseUrl(candidate);\n\t\t}\n\t}\n\n\tconst vercelUrl = process.env.VERCEL_URL;\n\tif (vercelUrl && shouldUseUrl(vercelUrl)) {\n\t\treturn normalizeBaseUrl(\n\t\t\tvercelUrl.startsWith(\"http\") ? vercelUrl : `https://${vercelUrl}`,\n\t\t);\n\t}\n\n\ttry {\n\t\tconst hdrs = await headers();\n\t\tconst origin = hdrs.get(\"origin\");\n\t\tif (origin && shouldUseUrl(origin)) {\n\t\t\treturn normalizeBaseUrl(origin);\n\t\t}\n\t\tconst host = hdrs.get(\"host\");\n\t\tif (host && shouldUseUrl(host)) {\n\t\t\tconst protocol = host.includes(\"localhost\") ? \"http\" : \"https\";\n\t\t\treturn normalizeBaseUrl(`${protocol}://${host}`);\n\t\t}\n\t} catch {\n\t\t// headers() not available outside of a request context\n\t}\n\n\treturn undefined;\n}\n\nasync function buildAbsoluteUrl(path: string): Promise<string | undefined> {\n\tconst base = await getBaseAppUrl();\n\tif (!base) {\n\t\treturn undefined;\n\t}\n\tconst normalizedPath = path.startsWith(\"/\") ? path : `/${path}`;\n\treturn `${base}${normalizedPath}`;\n}\n\nasync function getTelnyxWebhookUrl(\n\tcompanyId?: string,\n): Promise<string | undefined> {\n\tif (companyId) {\n\t\treturn buildAbsoluteUrl(`/api/webhooks/telnyx?company=${companyId}`);\n\t}\n\treturn buildAbsoluteUrl(\"/api/webhooks/telnyx\");\n}\n\nasync function getPhoneNumberId(\n\tsupabase: TypedSupabaseClient,\n\tphoneNumber: string,\n): Promise<string | null> {\n\tconst normalized = normalizePhoneNumber(phoneNumber);\n\tconst { data } = await supabase\n\t\t.from(\"phone_numbers\")\n\t\t.select(\"id\")\n\t\t.eq(\"phone_number\", normalized)\n\t\t.is(\"deleted_at\", null)\n\t\t.maybeSingle();\n\n\treturn data?.id ?? null;\n}\n\nasync function ensurePhoneNumberRecordExists(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n\tphoneNumber: string | null,\n): Promise<void> {\n\tif (!phoneNumber) {\n\t\treturn;\n\t}\n\n\tconst normalized = normalizePhoneNumber(phoneNumber);\n\tconst { data } = await supabase\n\t\t.from(\"phone_numbers\")\n\t\t.select(\"id\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"phone_number\", normalized)\n\t\t.limit(1);\n\n\tif (data && data.length > 0) {\n\t\treturn;\n\t}\n\n\tawait supabase.from(\"phone_numbers\").insert({\n\t\tcompany_id: companyId,\n\t\tphone_number: normalized,\n\t\tformatted_number: formatDisplayPhoneNumber(normalized),\n\t\tcountry_code: \"US\",\n\t\tarea_code: extractAreaCode(normalized),\n\t\tnumber_type: \"local\",\n\t\tstatus: \"active\",\n\t\tfeatures: DEFAULT_PHONE_NUMBER_FEATURES,\n\t});\n}\n\nasync function resolveOutboundPhoneNumber(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n\texplicitFrom?: string | null,\n\tdefaultNumber?: string | null,\n): Promise<string | null> {\n\tif (explicitFrom) {\n\t\treturn normalizePhoneNumber(explicitFrom);\n\t}\n\n\tconst normalizedDefault = defaultNumber\n\t\t? normalizePhoneNumber(defaultNumber)\n\t\t: null;\n\n\ttry {\n\t\tconst { data } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"phone_number, number_type\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"active\");\n\n\t\tif (data && data.length > 0) {\n\t\t\tconst tollFree = data.find((n) => n.number_type === \"toll-free\");\n\t\t\tif (tollFree) {\n\t\t\t\treturn normalizePhoneNumber(tollFree.phone_number);\n\t\t\t}\n\n\t\t\tif (normalizedDefault) {\n\t\t\t\tconst defaultExists = data.some(\n\t\t\t\t\t(n) => normalizePhoneNumber(n.phone_number) === normalizedDefault,\n\t\t\t\t);\n\t\t\t\tif (defaultExists) {\n\t\t\t\t\treturn normalizedDefault;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn normalizePhoneNumber(data[0].phone_number);\n\t\t}\n\t} catch (error) {\n\t\tconsole.warn(\n\t\t\t\"Failed to load company phone numbers for outbound selection:\",\n\t\t\terror,\n\t\t);\n\t}\n\n\treturn normalizedDefault;\n}\n\nasync function mergeProviderMetadata(\n\tsupabase: TypedSupabaseClient,\n\tcommunicationId: string,\n\tpatch: Record<string, Json>,\n): Promise<void> {\n\tconst { data } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\"provider_metadata\")\n\t\t.eq(\"id\", communicationId)\n\t\t.maybeSingle();\n\n\tconst currentMetadata =\n\t\t(data?.provider_metadata as Record<string, Json> | null) ?? {};\n\tconst mergedMetadata: Record<string, Json> = {\n\t\t...currentMetadata,\n\t\t...patch,\n\t};\n\n\tawait supabase\n\t\t.from(\"communications\")\n\t\t.update({\n\t\t\tprovider_metadata: mergedMetadata,\n\t\t})\n\t\t.eq(\"id\", communicationId);\n}\n\n// =====================================================================================\n// PHONE NUMBER MANAGEMENT ACTIONS\n// =====================================================================================\n\n/**\n * Search for available phone numbers to purchase\n */\nexport async function searchPhoneNumbers(params: {\n\tareaCode?: string;\n\tnumberType?: NumberType;\n\tfeatures?: NumberFeature[];\n\tlimit?: number;\n}) {\n\ttry {\n\t\tconst result = await searchAvailableNumbers({\n\t\t\tcountryCode: \"US\",\n\t\t\tareaCode: params.areaCode,\n\t\t\tnumberType: params.numberType,\n\t\t\tfeatures: params.features,\n\t\t\tlimit: params.limit || 10,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to search phone numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Purchase a phone number and associate it with the current company\n */\nexport async function purchasePhoneNumber(params: {\n\tphoneNumber: string;\n\tcompanyId: string;\n\tbillingGroupId?: string;\n}) {\n\ttry {\n\t\t// Validate configuration\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tconst callConfig = validateCallConfig();\n\t\tif (!smsConfig.valid || !callConfig.valid) {\n\t\t\tlet errorMessage =\n\t\t\t\t\"Telnyx configuration is incomplete. Please configure all required environment variables.\";\n\n\t\t\t// If we have a suggested profile ID, include it in the error\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} to use it.`;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst normalizedPhoneNumber = normalizePhoneNumber(params.phoneNumber);\n\t\tconst formattedNumber = formatDisplayPhoneNumber(normalizedPhoneNumber);\n\t\tconst areaCode = extractAreaCode(normalizedPhoneNumber);\n\n\t\t// Purchase number from Telnyx\n\t\tconst messagingProfileId = DEFAULT_MESSAGING_PROFILE_ID || undefined;\n\n\t\tconst result = await purchaseNumber({\n\t\t\tphoneNumber: normalizedPhoneNumber,\n\t\t\tconnectionId: TELNYX_CONFIG.connectionId,\n\t\t\tmessagingProfileId,\n\t\t\tbillingGroupId: params.billingGroupId,\n\t\t\tcustomerReference: `company_${params.companyId}`,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\t// Store in database\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: params.companyId,\n\t\t\t\ttelnyx_phone_number_id: result.orderId,\n\t\t\t\ttelnyx_connection_id: TELNYX_CONFIG.connectionId,\n\t\t\t\tphone_number: normalizedPhoneNumber,\n\t\t\t\tformatted_number: formattedNumber,\n\t\t\t\tcountry_code: \"US\",\n\t\t\t\tarea_code: areaCode,\n\t\t\t\tnumber_type: \"local\",\n\t\t\t\tfeatures: [\"voice\", \"sms\"],\n\t\t\t\tstatus: \"pending\",\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\ttry {\n\t\t\tawait ensureMessagingCampaign(\n\t\t\t\tparams.companyId,\n\t\t\t\t{ id: data.id, e164: normalizedPhoneNumber },\n\t\t\t\t{ supabase },\n\t\t\t);\n\t\t} catch (_campaignError) {}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to purchase phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Get all phone numbers for a company\n */\nexport async function getCompanyPhoneNumbers(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get phone numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Update phone number configuration\n */\nasync function updatePhoneNumber(params: {\n\tphoneNumberId: string;\n\troutingRuleId?: string;\n\tforwardToNumber?: string;\n\tvoicemailEnabled?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.update({\n\t\t\t\tcall_routing_rule_id: params.routingRuleId,\n\t\t\t\tforward_to_number: params.forwardToNumber,\n\t\t\t\tvoicemail_enabled: params.voicemailEnabled,\n\t\t\t})\n\t\t\t.eq(\"id\", params.phoneNumberId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to update phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Release (delete) a phone number\n */\nasync function deletePhoneNumber(phoneNumberId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get phone number details\n\t\tconst { data: phoneNumber } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"id\", phoneNumberId)\n\t\t\t.single();\n\n\t\tif (!phoneNumber) {\n\t\t\treturn { success: false, error: \"Phone number not found\" };\n\t\t}\n\n\t\t// Release from Telnyx if we have the ID\n\t\tif (phoneNumber.telnyx_phone_number_id) {\n\t\t\tawait releaseNumber(phoneNumber.telnyx_phone_number_id);\n\t\t}\n\n\t\t// Soft delete in database\n\t\tconst { error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tstatus: \"deleted\",\n\t\t\t})\n\t\t\t.eq(\"id\", phoneNumberId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to delete phone number\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// CALL OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Initiate an outbound call\n */\nexport async function makeCall(params: {\n\tto: string;\n\tfrom: string;\n\tcompanyId: string;\n\tcustomerId?: string;\n\tjobId?: string;\n\tpropertyId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconsole.log(\" makeCall called with params:\", params);\n\n\t\tconst callConfig = validateCallConfig();\n\t\tconsole.log(\" Call config validation:\", callConfig);\n\t\tif (!callConfig.valid) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: callConfig.error || \"Call configuration is invalid\",\n\t\t\t};\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t);\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t\tcompanySettings?.default_outbound_number || null,\n\t\t);\n\n\t\tconst connectionOverride =\n\t\t\tcompanySettings?.call_control_application_id ||\n\t\t\tTELNYX_CONFIG.connectionId;\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings?.default_outbound_number || null,\n\t\t);\n\n\t\tif (!connectionOverride) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"No Telnyx connection configured for this company.\",\n\t\t\t};\n\t\t}\n\n\t\tif (!fromAddress) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured. Please provision numbers first.\",\n\t\t\t};\n\t\t}\n\n\t\t// TEMP: Skip connection verification - Level 2 required for API access\n\t\t// const connectionStatus = await verifyConnection(connectionOverride);\n\t\t// if (connectionStatus.needsFix) {\n\t\t// \treturn {\n\t\t// \t\tsuccess: false,\n\t\t// \t\terror: `Connection configuration issue: ${connectionStatus.issues.join(\", \")}. Run fixConnection() to auto-fix.`,\n\t\t// \t};\n\t\t// }\n\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\n\t\t// TEMP: Skip voice capability check - Level 2 required for API access\n\t\t// const voiceCapability = await verifyVoiceCapability(fromAddress);\n\t\t// if (!voiceCapability.hasVoice) {\n\t\t// \treturn {\n\t\t// \t\tsuccess: false,\n\t\t// \t\terror:\n\t\t// \t\t\tvoiceCapability.error || \"Phone number does not support voice calls\",\n\t\t// \t};\n\t\t// }\n\n\t\tconst telnyxWebhookUrl = await getTelnyxWebhookUrl(params.companyId);\n\t\tconsole.log(\" Webhook URL:\", telnyxWebhookUrl);\n\t\tif (!telnyxWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\n\t\tconsole.log(\" Initiating call:\", {\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\tconnectionId: connectionOverride,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t});\n\n\t\tconst result = await initiateCall({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\tconnectionId: connectionOverride,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t\tansweringMachineDetection: \"premium\",\n\t\t});\n\n\t\tconsole.log(\" Telnyx API response:\", result);\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tproperty_id: params.propertyId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"phone\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: \"\",\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_call_control_id: result.callControlId,\n\t\t\t\ttelnyx_call_session_id: result.callSessionId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\tconsole.log(\" Call created successfully:\", {\n\t\t\tcallControlId: result.callControlId,\n\t\t\tcommunicationId: data.id,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcallControlId: result.callControlId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\" makeCall error:\", error);\n\t\tconsole.error(\"Error details:\", {\n\t\t\tmessage: error instanceof Error ? error.message : String(error),\n\t\t\tstack: error instanceof Error ? error.stack : undefined,\n\t\t});\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to make call\",\n\t\t};\n\t}\n}\n\n/**\n * Answer an incoming call\n/**\n * Answer an incoming call\n */\nasync function acceptCall(callControlId: string) {\n\ttry {\n\t\tconst telnyxWebhookUrl = await getTelnyxWebhookUrl();\n\t\tif (!telnyxWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\t\tconst result = await answerCall({\n\t\t\tcallControlId,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to answer call\",\n\t\t};\n\t}\n}\n\n/**\n * Reject an incoming call\n */\nasync function declineCall(callControlId: string) {\n\ttry {\n\t\tconst result = await rejectCall({\n\t\t\tcallControlId,\n\t\t\tcause: \"CALL_REJECTED\",\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to reject call\",\n\t\t};\n\t}\n}\n\n/**\n * End an active call\n */\nasync function endCall(callControlId: string) {\n\ttry {\n\t\tconst result = await hangupCall({ callControlId });\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to end call\",\n\t\t};\n\t}\n}\n\n/**\n * Start recording a call\n */\nexport async function startCallRecording(callControlId: string) {\n\ttry {\n\t\tconst result = await startRecording({\n\t\t\tcallControlId,\n\t\t\tformat: \"mp3\",\n\t\t\tchannels: \"single\",\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to start recording\",\n\t\t};\n\t}\n}\n\n/**\n * Stop recording a call\n */\nexport async function stopCallRecording(callControlId: string) {\n\ttry {\n\t\tconst result = await stopRecording({ callControlId });\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to stop recording\",\n\t\t};\n\t}\n}\n\n/**\n * Transfer an active call to another number\n */\nexport async function transferActiveCall(params: {\n\tcallControlId: string;\n\tto: string;\n\tfrom: string;\n}) {\n\ttry {\n\t\tconst { transferCall } = await import(\"@/lib/telnyx/calls\");\n\t\tconst result = await transferCall({\n\t\t\tcallControlId: params.callControlId,\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to transfer call\",\n\t\t};\n\t}\n}\n\n/**\n * Transcribe a call recording using AssemblyAI\n *\n * Submits the recording URL to AssemblyAI for post-call transcription.\n * AssemblyAI will process the audio and send the transcript via webhook.\n *\n * @param recordingUrl - URL of the call recording (from Telnyx)\n * @param communicationId - Database ID of the communication record\n * @returns Success/error response with transcription job ID\n */\nexport async function transcribeCallRecording(params: {\n\trecordingUrl: string;\n\tcommunicationId: string;\n}) {\n\ttry {\n\t\tconst { submitTranscription } = await import(\"@/lib/assemblyai/client\");\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst webhookUrl = await buildAbsoluteUrl(\"/api/webhooks/assemblyai\");\n\t\tif (!webhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL.\",\n\t\t\t};\n\t\t}\n\n\t\t// Submit to AssemblyAI\n\t\tconst result = await submitTranscription({\n\t\t\taudio_url: params.recordingUrl,\n\t\t\tspeaker_labels: true, // Enable speaker diarization\n\t\t\twebhook_url: webhookUrl,\n\t\t});\n\n\t\tif (!(result.success && result.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: result.error || \"Failed to submit transcription\",\n\t\t\t};\n\t\t}\n\n\t\t// Store transcription job ID in database\n\t\tawait mergeProviderMetadata(supabase, params.communicationId, {\n\t\t\tassemblyai_transcription_id: result.data.id,\n\t\t\tassemblyai_status: result.data.status,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\ttranscriptionId: result.data.id,\n\t\t\tstatus: result.data.status,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to transcribe recording\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// SMS OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Send an SMS message\n */\nexport async function sendTextMessage(params: {\n\tto: string;\n\tfrom: string;\n\ttext: string;\n\tcompanyId?: string; // Optional - will be fetched if not provided\n\tcustomerId?: string;\n\tjobId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tconsole.error(\" Supabase client unavailable\");\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get company ID if not provided\n\t\tlet companyId = params.companyId;\n\t\tif (!companyId) {\n\t\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\t\tcompanyId = await getActiveCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t\t}\n\t\t}\n\n\t\tconsole.log(\" SMS Send Request:\", {\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t\tcompanyId,\n\t\t});\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t);\n\t\tif (!companySettings) {\n\t\t\tconsole.error(\" Company settings not found\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Unable to provision Telnyx resources for this company. Please verify the company's onboarding is complete and try again.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" Company settings loaded:\", {\n\t\t\tmessagingProfileId: companySettings.messaging_profile_id,\n\t\t\tdefaultNumber: companySettings.default_outbound_number,\n\t\t});\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tif (!smsConfig.valid && !companySettings?.messaging_profile_id) {\n\t\t\tlet errorMessage = smsConfig.error || \"SMS configuration is invalid\";\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} or provision company-specific settings.`;\n\t\t\t}\n\t\t\tconsole.error(\" SMS config invalid:\", errorMessage);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" SMS config valid\");\n\n\t\tconst messagingProfileId =\n\t\t\tcompanySettings?.messaging_profile_id || DEFAULT_MESSAGING_PROFILE_ID;\n\t\tif (!messagingProfileId) {\n\t\t\tconsole.error(\" No messaging profile ID\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Messaging profile is not configured for this company. Please provision communications before sending SMS.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" Using messaging profile:\", messagingProfileId);\n\n\t\tif (messagingProfileId) {\n\t\t\tconst messagingProfileStatus =\n\t\t\t\tawait verifyMessagingProfile(messagingProfileId);\n\t\t\tif (messagingProfileStatus.needsFix) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t\" Messaging profile needs fix:\",\n\t\t\t\t\tmessagingProfileStatus.issues,\n\t\t\t\t);\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Messaging profile configuration issue: ${messagingProfileStatus.issues.join(\", \")}. Run fixMessagingProfile() or reprovision the company.`,\n\t\t\t\t};\n\t\t\t}\n\t\t\tconsole.log(\" Messaging profile verified\");\n\t\t}\n\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\t\tif (!fromAddress) {\n\t\t\tconsole.error(\" No from number available\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured. Please provision numbers first.\",\n\t\t\t};\n\t\t}\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\t\tconsole.log(\" Phone numbers normalized:\", {\n\t\t\tfrom: fromAddress,\n\t\t\tto: toAddress,\n\t\t});\n\n\t\t// Verify phone number has SMS capability\n\t\tconsole.log(\" Verifying SMS capability for:\", fromAddress);\n\t\tconst smsCapability = await verifySmsCapability(fromAddress);\n\t\tif (!smsCapability.hasSms) {\n\t\t\tconsole.error(\" SMS capability check failed:\", smsCapability.error);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: smsCapability.error || \"Phone number does not support SMS\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" SMS capability verified\");\n\n\t\tconst webhookUrl = await getTelnyxWebhookUrl(companyId);\n\t\tif (!webhookUrl) {\n\t\t\tconsole.error(\" No webhook URL\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" Webhook URL:\", webhookUrl);\n\n\t\t// Send SMS via Telnyx\n\t\tconsole.log(\" Sending SMS via Telnyx API...\");\n\t\tconst result = await sendSMS({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\ttext: params.text,\n\t\t\twebhookUrl,\n\t\t\tmessagingProfileId,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\tconsole.error(\" Telnyx API failed:\", result.error);\n\n\t\t\t// Check if error is 10DLC registration required\n\t\t\tif (\n\t\t\t\tresult.error &&\n\t\t\t\t(result.error.includes(\"10DLC\") ||\n\t\t\t\t\tresult.error.includes(\"Not 10DLC registered\") ||\n\t\t\t\t\tresult.error.includes(\"A2P\"))\n\t\t\t) {\n\t\t\t\tconsole.log(\n\t\t\t\t\t\" Detected 10DLC registration required, attempting auto-registration...\",\n\t\t\t\t);\n\n\t\t\t\t// Import 10DLC registration function\n\t\t\t\tconst { registerCompanyFor10DLC } = await import(\n\t\t\t\t\t\"@/actions/ten-dlc-registration\"\n\t\t\t\t);\n\n\t\t\t\tconst registrationResult = await registerCompanyFor10DLC(\n\t\t\t\t\tcompanyId,\n\t\t\t\t);\n\n\t\t\t\tif (registrationResult.success) {\n\t\t\t\t\tconsole.log(\" 10DLC registration successful, retrying SMS send...\");\n\n\t\t\t\t\t// Retry the SMS send now that 10DLC is registered\n\t\t\t\t\tconst retryResult = await sendSMS({\n\t\t\t\t\t\tto: toAddress,\n\t\t\t\t\t\tfrom: fromAddress,\n\t\t\t\t\t\ttext: params.text,\n\t\t\t\t\t\twebhookUrl,\n\t\t\t\t\t\tmessagingProfileId,\n\t\t\t\t\t});\n\n\t\t\t\t\tif (!retryResult.success) {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\terror: `10DLC registration completed but SMS still failed: ${retryResult.error}. The campaign may need additional approval time.`,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\t// Update result with retry success\n\t\t\t\t\tresult.success = true;\n\t\t\t\t\tresult.messageId = retryResult.messageId;\n\t\t\t\t\tconsole.log(\" SMS retry successful after 10DLC registration\");\n\t\t\t\t} else {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: `10DLC registration failed: ${registrationResult.error}. Original error: ${result.error}`,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treturn result;\n\t\t\t}\n\t\t}\n\t\tconsole.log(\" Telnyx API success:\", result.messageId);\n\n\t\t// Create communication record\n\t\tconsole.log(\" Creating communication record in database...\");\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"sms\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: params.text,\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_message_id: result.messageId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.messageId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"SMS send error:\", error);\n\t\tconsole.error(\"Error details:\", {\n\t\t\tmessage: error instanceof Error ? error.message : String(error),\n\t\t\tstack: error instanceof Error ? error.stack : undefined,\n\t\t\ttype: typeof error,\n\t\t\tstringified: JSON.stringify(error, null, 2),\n\t\t});\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: `Failed to send SMS: ${String(error)}`,\n\t\t};\n\t}\n}\n\n/**\n * Send an MMS message with media\n */\nexport async function sendMMSMessage(params: {\n\tto: string;\n\tfrom: string;\n\ttext?: string;\n\tmediaUrls: string[];\n\tcompanyId?: string; // Optional - will be fetched if not provided\n\tcustomerId?: string;\n\tjobId?: string;\n\tpropertyId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get company ID if not provided\n\t\tlet companyId = params.companyId;\n\t\tif (!companyId) {\n\t\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\t\tcompanyId = await getActiveCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t\t}\n\t\t}\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t);\n\t\tif (!companySettings) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Unable to provision Telnyx resources for this company. Please verify onboarding is complete.\",\n\t\t\t};\n\t\t}\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tif (!smsConfig.valid && !companySettings.messaging_profile_id) {\n\t\t\tlet errorMessage = smsConfig.error || \"SMS configuration is invalid\";\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} or reprovision the company.`;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\n\t\tconst messagingProfileId =\n\t\t\tcompanySettings.messaging_profile_id || DEFAULT_MESSAGING_PROFILE_ID;\n\t\tif (!messagingProfileId) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Messaging profile is not configured for this company. Please provision communications before sending MMS.\",\n\t\t\t};\n\t\t}\n\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\t\tif (!fromAddress) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured.\",\n\t\t\t};\n\t\t}\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\n\t\tconst webhookUrl = await getTelnyxWebhookUrl(companyId);\n\t\tif (!webhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\n\t\tif (messagingProfileId) {\n\t\t\tconst messagingProfileStatus =\n\t\t\t\tawait verifyMessagingProfile(messagingProfileId);\n\t\t\tif (messagingProfileStatus.needsFix) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Messaging profile configuration issue: ${messagingProfileStatus.issues.join(\", \")}. Run fixMessagingProfile() or reprovision the company.`,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tconst smsCapability = await verifySmsCapability(fromAddress);\n\t\tif (!smsCapability.hasSms) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: smsCapability.error || \"Phone number does not support SMS/MMS\",\n\t\t\t};\n\t\t}\n\n\t\tconst result = await sendMMS({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\ttext: params.text,\n\t\t\tmediaUrls: params.mediaUrls,\n\t\t\twebhookUrl,\n\t\t\tmessagingProfileId,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tproperty_id: params.propertyId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"sms\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: params.text || \"\",\n\t\t\t\tattachments: params.mediaUrls.map((url) => ({ url, type: \"image\" })),\n\t\t\t\tattachment_count: params.mediaUrls.length,\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_message_id: result.messageId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.messageId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to send MMS\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// WEBRTC OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Generate WebRTC credentials for browser calling\n */\nexport async function getWebRTCCredentials() {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t\terror: userError,\n\t\t} = await supabase.auth.getUser();\n\t\tif (userError || !user) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"User not authenticated\",\n\t\t\t};\n\t\t}\n\n\t\t// OPTION 1: Use static credentials from environment (recommended for production)\n\t\tconst staticUsername = process.env.TELNYX_WEBRTC_USERNAME;\n\t\tconst staticPassword = process.env.TELNYX_WEBRTC_PASSWORD;\n\n\t\tif (staticUsername && staticPassword) {\n\t\t\tconst credential = {\n\t\t\t\tusername: staticUsername,\n\t\t\t\tpassword: staticPassword,\n\t\t\t\texpires_at: Date.now() + 86_400 * 1000, // 24 hours from now\n\t\t\t\trealm: \"sip.telnyx.com\",\n\t\t\t\tsip_uri: `sip:${staticUsername}@sip.telnyx.com`,\n\t\t\t\tstun_servers: [\n\t\t\t\t\t\"stun:stun.telnyx.com:3478\",\n\t\t\t\t\t\"stun:stun.telnyx.com:3479\",\n\t\t\t\t],\n\t\t\t\tturn_servers: [\n\t\t\t\t\t{\n\t\t\t\t\t\turls: [\n\t\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=udp\",\n\t\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=tcp\",\n\t\t\t\t\t\t],\n\t\t\t\t\t\tusername: staticUsername,\n\t\t\t\t\t\tcredential: staticPassword,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t};\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tcredential,\n\t\t\t};\n\t\t}\n\n\t\tconst { generateWebRTCToken } = await import(\"@/lib/telnyx/webrtc\");\n\t\tconst result = await generateWebRTCToken({\n\t\t\tusername: user.email || user.id,\n\t\t\tttl: 86_400, // 24 hours\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcredential: result.credential,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get WebRTC credentials\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// VOICEMAIL OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Get all voicemails for a company\n */\nasync function getVoicemails(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        customer:customers(id, first_name, last_name, email, phone),\n        phone_number:phone_numbers(phone_number, formatted_number)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"received_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get voicemails\",\n\t\t};\n\t}\n}\n\n/**\n * Mark voicemail as read\n */\nasync function markVoicemailAsRead(voicemailId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.update({\n\t\t\t\tis_read: true,\n\t\t\t\tread_at: new Date().toISOString(),\n\t\t\t\tread_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", voicemailId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to mark voicemail as read\",\n\t\t};\n\t}\n}\n\n/**\n * Delete voicemail\n */\nasync function deleteVoicemail(voicemailId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", voicemailId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to delete voicemail\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// CALL ROUTING RULES ACTIONS\n// =====================================================================================\n\n/**\n * Get all call routing rules for a company\n */\nexport async function getCallRoutingRules(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        created_by_user:users!call_routing_rules_created_by_fkey(id, name, email),\n        forward_to_user:users!call_routing_rules_forward_to_user_id_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"priority\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get call routing rules\",\n\t\t};\n\t}\n}\n\n/**\n * Create a new call routing rule\n */\nasync function createCallRoutingRule(params: {\n\tcompanyId: string;\n\tuserId: string;\n\tname: string;\n\tdescription?: string;\n\troutingType:\n\t\t| \"direct\"\n\t\t| \"round_robin\"\n\t\t| \"ivr\"\n\t\t| \"business_hours\"\n\t\t| \"conditional\";\n\tpriority?: number;\n\tbusinessHours?: Record<string, unknown>;\n\ttimezone?: string;\n\tafterHoursAction?: \"voicemail\" | \"forward\" | \"hangup\";\n\tafterHoursForwardTo?: string;\n\tteamMembers?: string[];\n\tringTimeout?: number;\n\tivrMenu?: Record<string, unknown>;\n\tivrGreetingUrl?: string;\n\tforwardToNumber?: string;\n\tforwardToUserId?: string;\n\tenableVoicemail?: boolean;\n\tvoicemailGreetingUrl?: string;\n\tvoicemailTranscriptionEnabled?: boolean;\n\tvoicemailEmailNotifications?: boolean;\n\trecordCalls?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: params.companyId,\n\t\t\t\tcreated_by: params.userId,\n\t\t\t\tname: params.name,\n\t\t\t\tdescription: params.description,\n\t\t\t\trouting_type: params.routingType,\n\t\t\t\tpriority: params.priority || 0,\n\t\t\t\tbusiness_hours: params.businessHours,\n\t\t\t\ttimezone: params.timezone || \"America/Los_Angeles\",\n\t\t\t\tafter_hours_action: params.afterHoursAction,\n\t\t\t\tafter_hours_forward_to: params.afterHoursForwardTo,\n\t\t\t\tteam_members: params.teamMembers,\n\t\t\t\tring_timeout: params.ringTimeout || 20,\n\t\t\t\tivr_menu: params.ivrMenu,\n\t\t\t\tivr_greeting_url: params.ivrGreetingUrl,\n\t\t\t\tforward_to_number: params.forwardToNumber,\n\t\t\t\tforward_to_user_id: params.forwardToUserId,\n\t\t\t\tenable_voicemail: params.enableVoicemail !== false,\n\t\t\t\tvoicemail_greeting_url: params.voicemailGreetingUrl,\n\t\t\t\tvoicemail_transcription_enabled:\n\t\t\t\t\tparams.voicemailTranscriptionEnabled !== false,\n\t\t\t\tvoicemail_email_notifications:\n\t\t\t\t\tparams.voicemailEmailNotifications !== false,\n\t\t\t\trecord_calls: params.recordCalls,\n\t\t\t\tis_active: true,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to create call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Update an existing call routing rule\n */\nexport async function updateCallRoutingRule(params: {\n\truleId: string;\n\tname?: string;\n\tdescription?: string;\n\tpriority?: number;\n\tbusinessHours?: Record<string, unknown>;\n\ttimezone?: string;\n\tafterHoursAction?: \"voicemail\" | \"forward\" | \"hangup\";\n\tafterHoursForwardTo?: string;\n\tteamMembers?: string[];\n\tringTimeout?: number;\n\tivrMenu?: Record<string, unknown>;\n\tivrGreetingUrl?: string;\n\tforwardToNumber?: string;\n\tforwardToUserId?: string;\n\tenableVoicemail?: boolean;\n\tvoicemailGreetingUrl?: string;\n\tvoicemailTranscriptionEnabled?: boolean;\n\tvoicemailEmailNotifications?: boolean;\n\trecordCalls?: boolean;\n\tisActive?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst updateData: Record<string, unknown> = {};\n\n\t\tif (params.name !== undefined) {\n\t\t\tupdateData.name = params.name;\n\t\t}\n\t\tif (params.description !== undefined) {\n\t\t\tupdateData.description = params.description;\n\t\t}\n\t\tif (params.priority !== undefined) {\n\t\t\tupdateData.priority = params.priority;\n\t\t}\n\t\tif (params.businessHours !== undefined) {\n\t\t\tupdateData.business_hours = params.businessHours;\n\t\t}\n\t\tif (params.timezone !== undefined) {\n\t\t\tupdateData.timezone = params.timezone;\n\t\t}\n\t\tif (params.afterHoursAction !== undefined) {\n\t\t\tupdateData.after_hours_action = params.afterHoursAction;\n\t\t}\n\t\tif (params.afterHoursForwardTo !== undefined) {\n\t\t\tupdateData.after_hours_forward_to = params.afterHoursForwardTo;\n\t\t}\n\t\tif (params.teamMembers !== undefined) {\n\t\t\tupdateData.team_members = params.teamMembers;\n\t\t}\n\t\tif (params.ringTimeout !== undefined) {\n\t\t\tupdateData.ring_timeout = params.ringTimeout;\n\t\t}\n\t\tif (params.ivrMenu !== undefined) {\n\t\t\tupdateData.ivr_menu = params.ivrMenu;\n\t\t}\n\t\tif (params.ivrGreetingUrl !== undefined) {\n\t\t\tupdateData.ivr_greeting_url = params.ivrGreetingUrl;\n\t\t}\n\t\tif (params.forwardToNumber !== undefined) {\n\t\t\tupdateData.forward_to_number = params.forwardToNumber;\n\t\t}\n\t\tif (params.forwardToUserId !== undefined) {\n\t\t\tupdateData.forward_to_user_id = params.forwardToUserId;\n\t\t}\n\t\tif (params.enableVoicemail !== undefined) {\n\t\t\tupdateData.enable_voicemail = params.enableVoicemail;\n\t\t}\n\t\tif (params.voicemailGreetingUrl !== undefined) {\n\t\t\tupdateData.voicemail_greeting_url = params.voicemailGreetingUrl;\n\t\t}\n\t\tif (params.voicemailTranscriptionEnabled !== undefined) {\n\t\t\tupdateData.voicemail_transcription_enabled =\n\t\t\t\tparams.voicemailTranscriptionEnabled;\n\t\t}\n\t\tif (params.voicemailEmailNotifications !== undefined) {\n\t\t\tupdateData.voicemail_email_notifications =\n\t\t\t\tparams.voicemailEmailNotifications;\n\t\t}\n\t\tif (params.recordCalls !== undefined) {\n\t\t\tupdateData.record_calls = params.recordCalls;\n\t\t}\n\t\tif (params.isActive !== undefined) {\n\t\t\tupdateData.is_active = params.isActive;\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update(updateData)\n\t\t\t.eq(\"id\", params.ruleId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to update call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Delete a call routing rule\n */\nexport async function deleteCallRoutingRule(ruleId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", ruleId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to delete call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Toggle call routing rule active status\n */\nexport async function toggleCallRoutingRule(ruleId: string, isActive: boolean) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update({ is_active: isActive })\n\t\t\t.eq(\"id\", ruleId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to toggle call routing rule\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// PHONE NUMBER USAGE STATISTICS ACTIONS\n// =====================================================================================\n\n/**\n * Get usage statistics for a phone number\n */\nasync function getPhoneNumberUsageStats(\n\tphoneNumberId: string,\n\tdays = 30,\n) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\t// Get call statistics\n\t\tconst { data: callStats, error: callError } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, call_duration, created_at\")\n\t\t\t.eq(\"type\", \"phone\")\n\t\t\t.eq(\"phone_number_id\", phoneNumberId)\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (callError) {\n\t\t\tthrow callError;\n\t\t}\n\n\t\t// Get SMS statistics\n\t\tconst { data: smsStats, error: smsError } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, created_at\")\n\t\t\t.eq(\"type\", \"sms\")\n\t\t\t.eq(\"phone_number_id\", phoneNumberId)\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (smsError) {\n\t\t\tthrow smsError;\n\t\t}\n\n\t\t// Calculate aggregates\n\t\tconst calls = callStats || [];\n\t\tconst sms = smsStats || [];\n\n\t\tconst incomingCalls = calls.filter((c) => c.direction === \"inbound\").length;\n\t\tconst outgoingCalls = calls.filter(\n\t\t\t(c) => c.direction === \"outbound\",\n\t\t).length;\n\t\tconst totalCallDuration = calls.reduce(\n\t\t\t(sum, c) => sum + (c.call_duration || 0),\n\t\t\t0,\n\t\t);\n\t\tconst incomingSms = sms.filter((s) => s.direction === \"inbound\").length;\n\t\tconst outgoingSms = sms.filter((s) => s.direction === \"outbound\").length;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tincomingCalls,\n\t\t\t\toutgoingCalls,\n\t\t\t\ttotalCalls: incomingCalls + outgoingCalls,\n\t\t\t\ttotalCallDuration,\n\t\t\t\tincomingSms,\n\t\t\t\toutgoingSms,\n\t\t\t\ttotalSms: incomingSms + outgoingSms,\n\t\t\t\tdailyStats: aggregateDailyStats([...calls, ...sms], days),\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get usage statistics\",\n\t\t};\n\t}\n}\n\n/**\n * Get company-wide usage statistics\n */\nasync function getCompanyUsageStats(companyId: string, days = 30) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\t// Get all communications for the company\n\t\tconst { data: communications, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, call_duration, created_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.in(\"type\", [\"phone\", \"sms\"])\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\tconst items = communications || [];\n\t\tconst calls = items.filter((i) => i.type === \"phone\");\n\t\tconst sms = items.filter((i) => i.type === \"sms\");\n\n\t\tconst incomingCalls = calls.filter((c) => c.direction === \"inbound\").length;\n\t\tconst outgoingCalls = calls.filter(\n\t\t\t(c) => c.direction === \"outbound\",\n\t\t).length;\n\t\tconst totalCallDuration = calls.reduce(\n\t\t\t(sum, c) => sum + (c.call_duration || 0),\n\t\t\t0,\n\t\t);\n\t\tconst incomingSms = sms.filter((s) => s.direction === \"inbound\").length;\n\t\tconst outgoingSms = sms.filter((s) => s.direction === \"outbound\").length;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tincomingCalls,\n\t\t\t\toutgoingCalls,\n\t\t\t\ttotalCalls: incomingCalls + outgoingCalls,\n\t\t\t\ttotalCallDuration,\n\t\t\t\taverageCallDuration:\n\t\t\t\t\tcalls.length > 0 ? totalCallDuration / calls.length : 0,\n\t\t\t\tincomingSms,\n\t\t\t\toutgoingSms,\n\t\t\t\ttotalSms: incomingSms + outgoingSms,\n\t\t\t\tdailyStats: aggregateDailyStats(items, days),\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get usage statistics\",\n\t\t};\n\t}\n}\n\n/**\n * Helper function to aggregate daily statistics\n */\nfunction aggregateDailyStats(\n\titems: Array<{ created_at: string; type: string; call_duration?: number }>,\n\tdays: number,\n) {\n\tconst dailyStats: Record<\n\t\tstring,\n\t\t{ date: string; calls: number; sms: number; duration: number }\n\t> = {};\n\n\t// Initialize all days\n\tfor (let i = 0; i < days; i++) {\n\t\tconst date = new Date();\n\t\tdate.setDate(date.getDate() - i);\n\t\tconst dateStr = date.toISOString().split(\"T\")[0];\n\t\tdailyStats[dateStr] = { date: dateStr, calls: 0, sms: 0, duration: 0 };\n\t}\n\n\t// Aggregate data\n\titems.forEach((item) => {\n\t\tconst dateStr = item.created_at.split(\"T\")[0];\n\t\tif (dailyStats[dateStr]) {\n\t\t\tif (item.type === \"phone\") {\n\t\t\t\tdailyStats[dateStr].calls += 1;\n\t\t\t\tdailyStats[dateStr].duration += item.call_duration || 0;\n\t\t\t} else if (item.type === \"sms\") {\n\t\t\t\tdailyStats[dateStr].sms += 1;\n\t\t\t}\n\t\t}\n\t});\n\n\treturn Object.values(dailyStats).sort((a, b) => a.date.localeCompare(b.date));\n}\n"],"names":[],"mappings":";;;;;;;IA20BsB,qBAAA,WAAA,GAAA,IAAA,yZAAA,EAAA,8CAAA,8YAAA,EAAA,KAAA,GAAA,oZAAA,EAAA"}},
    {"offset": {"line": 485, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/telnyx.ts"],"sourcesContent":["/**\n * Telnyx Server Actions\n *\n * Server-side actions for Telnyx VoIP operations:\n * - Phone number management\n * - Call operations\n * - SMS operations\n * - Voicemail operations\n *\n * All actions include proper authentication and authorization checks.\n */\n\n\"use server\";\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { revalidatePath } from \"next/cache\";\nimport { headers } from \"next/headers\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport {\n\tanswerCall,\n\thangupCall,\n\tinitiateCall,\n\trejectCall,\n\tstartRecording,\n\tstopRecording,\n} from \"@/lib/telnyx/calls\";\nimport { TELNYX_CONFIG } from \"@/lib/telnyx/client\";\nimport {\n\tvalidateCallConfig,\n\tvalidateSmsConfig,\n} from \"@/lib/telnyx/config-validator\";\nimport { verifyConnection } from \"@/lib/telnyx/connection-setup\";\nimport { formatPhoneNumber, sendMMS, sendSMS } from \"@/lib/telnyx/messaging\";\nimport { verifyMessagingProfile } from \"@/lib/telnyx/messaging-profile-setup\";\nimport {\n\ttype NumberFeature,\n\ttype NumberType,\n\tpurchaseNumber,\n\treleaseNumber,\n\tsearchAvailableNumbers,\n} from \"@/lib/telnyx/numbers\";\nimport {\n\tverifySmsCapability,\n\tverifyVoiceCapability,\n} from \"@/lib/telnyx/phone-number-setup\";\nimport {\n\ttype CompanyTelnyxSettingsRow,\n\tensureCompanyTelnyxSetup,\n\tfetchCompanyTelnyxSettings,\n} from \"@/lib/telnyx/provision-company\";\nimport type { Database, Json } from \"@/types/supabase\";\nimport { ensureMessagingCampaign } from \"./messaging-branding\";\n\ntype TypedSupabaseClient = SupabaseClient<Database>;\n\nfunction normalizePhoneNumber(phoneNumber: string): string {\n\treturn formatPhoneNumber(phoneNumber);\n}\n\nfunction extractAreaCode(phoneNumber: string): string | null {\n\tconst digits = phoneNumber.replace(/\\D/g, \"\");\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn digits.slice(1, 4);\n\t}\n\tif (digits.length === 10) {\n\t\treturn digits.slice(0, 3);\n\t}\n\treturn null;\n}\n\nconst DEFAULT_MESSAGING_PROFILE_ID =\n\tprocess.env.TELNYX_DEFAULT_MESSAGING_PROFILE_ID ||\n\tprocess.env.NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID ||\n\t\"\";\n\nconst DEFAULT_PHONE_NUMBER_FEATURES: Json = [\"voice\", \"sms\", \"mms\"];\n\nfunction formatDisplayPhoneNumber(phoneNumber: string): string {\n\tconst digits = phoneNumber.replace(/\\D/g, \"\");\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn `+1 (${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;\n\t}\n\tif (digits.length === 10) {\n\t\treturn `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;\n\t}\n\treturn phoneNumber;\n}\n\nasync function getCompanyTelnyxSettings(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string | null,\n): Promise<CompanyTelnyxSettingsRow | null> {\n\tif (!companyId) {\n\t\treturn null;\n\t}\n\n\tconst existing = await fetchCompanyTelnyxSettings(supabase, companyId);\n\tif (existing && existing.status === \"ready\") {\n\t\treturn existing;\n\t}\n\n\tconst provisionResult = await ensureCompanyTelnyxSetup({\n\t\tcompanyId,\n\t\tsupabase,\n\t});\n\n\tif (!provisionResult.success) {\n\t\treturn null;\n\t}\n\n\treturn provisionResult.settings ?? null;\n}\n\nfunction normalizeBaseUrl(url: string): string {\n\tconst trimmed = url.trim().replace(/\\/+$/, \"\");\n\tif (/^https?:\\/\\//i.test(trimmed)) {\n\t\tif (/^http:\\/\\//i.test(trimmed) && !isLocalUrl(trimmed)) {\n\t\t\treturn trimmed.replace(/^http:\\/\\//i, \"https://\");\n\t\t}\n\t\treturn trimmed;\n\t}\n\treturn `https://${trimmed}`;\n}\n\nfunction isLocalUrl(url: string): boolean {\n\tconst lowered = url.toLowerCase();\n\treturn (\n\t\tlowered.includes(\"localhost\") ||\n\t\tlowered.includes(\"127.0.0.1\") ||\n\t\tlowered.includes(\"0.0.0.0\") ||\n\t\tlowered.endsWith(\".local\") ||\n\t\tlowered.includes(\"://local\")\n\t);\n}\n\nfunction shouldUseUrl(url: string): boolean {\n\tif (!url) {\n\t\treturn false;\n\t}\n\tconst trimmed = url.trim();\n\tif (!trimmed) {\n\t\treturn false;\n\t}\n\tconst isHostedProduction =\n\t\t(process.env.VERCEL === \"1\" && process.env.VERCEL_ENV === \"production\") ||\n\t\tprocess.env.DEPLOYMENT_ENV === \"production\";\n\n\tif (isHostedProduction && isLocalUrl(trimmed)) {\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nasync function getBaseAppUrl(): Promise<string | undefined> {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\tfor (const candidate of candidates) {\n\t\tif (candidate && shouldUseUrl(candidate)) {\n\t\t\treturn normalizeBaseUrl(candidate);\n\t\t}\n\t}\n\n\tconst vercelUrl = process.env.VERCEL_URL;\n\tif (vercelUrl && shouldUseUrl(vercelUrl)) {\n\t\treturn normalizeBaseUrl(\n\t\t\tvercelUrl.startsWith(\"http\") ? vercelUrl : `https://${vercelUrl}`,\n\t\t);\n\t}\n\n\ttry {\n\t\tconst hdrs = await headers();\n\t\tconst origin = hdrs.get(\"origin\");\n\t\tif (origin && shouldUseUrl(origin)) {\n\t\t\treturn normalizeBaseUrl(origin);\n\t\t}\n\t\tconst host = hdrs.get(\"host\");\n\t\tif (host && shouldUseUrl(host)) {\n\t\t\tconst protocol = host.includes(\"localhost\") ? \"http\" : \"https\";\n\t\t\treturn normalizeBaseUrl(`${protocol}://${host}`);\n\t\t}\n\t} catch {\n\t\t// headers() not available outside of a request context\n\t}\n\n\treturn undefined;\n}\n\nasync function buildAbsoluteUrl(path: string): Promise<string | undefined> {\n\tconst base = await getBaseAppUrl();\n\tif (!base) {\n\t\treturn undefined;\n\t}\n\tconst normalizedPath = path.startsWith(\"/\") ? path : `/${path}`;\n\treturn `${base}${normalizedPath}`;\n}\n\nasync function getTelnyxWebhookUrl(\n\tcompanyId?: string,\n): Promise<string | undefined> {\n\tif (companyId) {\n\t\treturn buildAbsoluteUrl(`/api/webhooks/telnyx?company=${companyId}`);\n\t}\n\treturn buildAbsoluteUrl(\"/api/webhooks/telnyx\");\n}\n\nasync function getPhoneNumberId(\n\tsupabase: TypedSupabaseClient,\n\tphoneNumber: string,\n): Promise<string | null> {\n\tconst normalized = normalizePhoneNumber(phoneNumber);\n\tconst { data } = await supabase\n\t\t.from(\"phone_numbers\")\n\t\t.select(\"id\")\n\t\t.eq(\"phone_number\", normalized)\n\t\t.is(\"deleted_at\", null)\n\t\t.maybeSingle();\n\n\treturn data?.id ?? null;\n}\n\nasync function ensurePhoneNumberRecordExists(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n\tphoneNumber: string | null,\n): Promise<void> {\n\tif (!phoneNumber) {\n\t\treturn;\n\t}\n\n\tconst normalized = normalizePhoneNumber(phoneNumber);\n\tconst { data } = await supabase\n\t\t.from(\"phone_numbers\")\n\t\t.select(\"id\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"phone_number\", normalized)\n\t\t.limit(1);\n\n\tif (data && data.length > 0) {\n\t\treturn;\n\t}\n\n\tawait supabase.from(\"phone_numbers\").insert({\n\t\tcompany_id: companyId,\n\t\tphone_number: normalized,\n\t\tformatted_number: formatDisplayPhoneNumber(normalized),\n\t\tcountry_code: \"US\",\n\t\tarea_code: extractAreaCode(normalized),\n\t\tnumber_type: \"local\",\n\t\tstatus: \"active\",\n\t\tfeatures: DEFAULT_PHONE_NUMBER_FEATURES,\n\t});\n}\n\nasync function resolveOutboundPhoneNumber(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n\texplicitFrom?: string | null,\n\tdefaultNumber?: string | null,\n): Promise<string | null> {\n\tif (explicitFrom) {\n\t\treturn normalizePhoneNumber(explicitFrom);\n\t}\n\n\tconst normalizedDefault = defaultNumber\n\t\t? normalizePhoneNumber(defaultNumber)\n\t\t: null;\n\n\ttry {\n\t\tconst { data } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"phone_number, number_type\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"active\");\n\n\t\tif (data && data.length > 0) {\n\t\t\tconst tollFree = data.find((n) => n.number_type === \"toll-free\");\n\t\t\tif (tollFree) {\n\t\t\t\treturn normalizePhoneNumber(tollFree.phone_number);\n\t\t\t}\n\n\t\t\tif (normalizedDefault) {\n\t\t\t\tconst defaultExists = data.some(\n\t\t\t\t\t(n) => normalizePhoneNumber(n.phone_number) === normalizedDefault,\n\t\t\t\t);\n\t\t\t\tif (defaultExists) {\n\t\t\t\t\treturn normalizedDefault;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn normalizePhoneNumber(data[0].phone_number);\n\t\t}\n\t} catch (error) {\n\t\tconsole.warn(\n\t\t\t\"Failed to load company phone numbers for outbound selection:\",\n\t\t\terror,\n\t\t);\n\t}\n\n\treturn normalizedDefault;\n}\n\nasync function mergeProviderMetadata(\n\tsupabase: TypedSupabaseClient,\n\tcommunicationId: string,\n\tpatch: Record<string, Json>,\n): Promise<void> {\n\tconst { data } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\"provider_metadata\")\n\t\t.eq(\"id\", communicationId)\n\t\t.maybeSingle();\n\n\tconst currentMetadata =\n\t\t(data?.provider_metadata as Record<string, Json> | null) ?? {};\n\tconst mergedMetadata: Record<string, Json> = {\n\t\t...currentMetadata,\n\t\t...patch,\n\t};\n\n\tawait supabase\n\t\t.from(\"communications\")\n\t\t.update({\n\t\t\tprovider_metadata: mergedMetadata,\n\t\t})\n\t\t.eq(\"id\", communicationId);\n}\n\n// =====================================================================================\n// PHONE NUMBER MANAGEMENT ACTIONS\n// =====================================================================================\n\n/**\n * Search for available phone numbers to purchase\n */\nexport async function searchPhoneNumbers(params: {\n\tareaCode?: string;\n\tnumberType?: NumberType;\n\tfeatures?: NumberFeature[];\n\tlimit?: number;\n}) {\n\ttry {\n\t\tconst result = await searchAvailableNumbers({\n\t\t\tcountryCode: \"US\",\n\t\t\tareaCode: params.areaCode,\n\t\t\tnumberType: params.numberType,\n\t\t\tfeatures: params.features,\n\t\t\tlimit: params.limit || 10,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to search phone numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Purchase a phone number and associate it with the current company\n */\nexport async function purchasePhoneNumber(params: {\n\tphoneNumber: string;\n\tcompanyId: string;\n\tbillingGroupId?: string;\n}) {\n\ttry {\n\t\t// Validate configuration\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tconst callConfig = validateCallConfig();\n\t\tif (!smsConfig.valid || !callConfig.valid) {\n\t\t\tlet errorMessage =\n\t\t\t\t\"Telnyx configuration is incomplete. Please configure all required environment variables.\";\n\n\t\t\t// If we have a suggested profile ID, include it in the error\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} to use it.`;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst normalizedPhoneNumber = normalizePhoneNumber(params.phoneNumber);\n\t\tconst formattedNumber = formatDisplayPhoneNumber(normalizedPhoneNumber);\n\t\tconst areaCode = extractAreaCode(normalizedPhoneNumber);\n\n\t\t// Purchase number from Telnyx\n\t\tconst messagingProfileId = DEFAULT_MESSAGING_PROFILE_ID || undefined;\n\n\t\tconst result = await purchaseNumber({\n\t\t\tphoneNumber: normalizedPhoneNumber,\n\t\t\tconnectionId: TELNYX_CONFIG.connectionId,\n\t\t\tmessagingProfileId,\n\t\t\tbillingGroupId: params.billingGroupId,\n\t\t\tcustomerReference: `company_${params.companyId}`,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\t// Store in database\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: params.companyId,\n\t\t\t\ttelnyx_phone_number_id: result.orderId,\n\t\t\t\ttelnyx_connection_id: TELNYX_CONFIG.connectionId,\n\t\t\t\tphone_number: normalizedPhoneNumber,\n\t\t\t\tformatted_number: formattedNumber,\n\t\t\t\tcountry_code: \"US\",\n\t\t\t\tarea_code: areaCode,\n\t\t\t\tnumber_type: \"local\",\n\t\t\t\tfeatures: [\"voice\", \"sms\"],\n\t\t\t\tstatus: \"pending\",\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\ttry {\n\t\t\tawait ensureMessagingCampaign(\n\t\t\t\tparams.companyId,\n\t\t\t\t{ id: data.id, e164: normalizedPhoneNumber },\n\t\t\t\t{ supabase },\n\t\t\t);\n\t\t} catch (_campaignError) {}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to purchase phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Get all phone numbers for a company\n */\nexport async function getCompanyPhoneNumbers(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get phone numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Update phone number configuration\n */\nasync function updatePhoneNumber(params: {\n\tphoneNumberId: string;\n\troutingRuleId?: string;\n\tforwardToNumber?: string;\n\tvoicemailEnabled?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.update({\n\t\t\t\tcall_routing_rule_id: params.routingRuleId,\n\t\t\t\tforward_to_number: params.forwardToNumber,\n\t\t\t\tvoicemail_enabled: params.voicemailEnabled,\n\t\t\t})\n\t\t\t.eq(\"id\", params.phoneNumberId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to update phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Release (delete) a phone number\n */\nasync function deletePhoneNumber(phoneNumberId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get phone number details\n\t\tconst { data: phoneNumber } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"id\", phoneNumberId)\n\t\t\t.single();\n\n\t\tif (!phoneNumber) {\n\t\t\treturn { success: false, error: \"Phone number not found\" };\n\t\t}\n\n\t\t// Release from Telnyx if we have the ID\n\t\tif (phoneNumber.telnyx_phone_number_id) {\n\t\t\tawait releaseNumber(phoneNumber.telnyx_phone_number_id);\n\t\t}\n\n\t\t// Soft delete in database\n\t\tconst { error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tstatus: \"deleted\",\n\t\t\t})\n\t\t\t.eq(\"id\", phoneNumberId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to delete phone number\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// CALL OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Initiate an outbound call\n */\nexport async function makeCall(params: {\n\tto: string;\n\tfrom: string;\n\tcompanyId: string;\n\tcustomerId?: string;\n\tjobId?: string;\n\tpropertyId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconsole.log(\" makeCall called with params:\", params);\n\n\t\tconst callConfig = validateCallConfig();\n\t\tconsole.log(\" Call config validation:\", callConfig);\n\t\tif (!callConfig.valid) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: callConfig.error || \"Call configuration is invalid\",\n\t\t\t};\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t);\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t\tcompanySettings?.default_outbound_number || null,\n\t\t);\n\n\t\tconst connectionOverride =\n\t\t\tcompanySettings?.call_control_application_id ||\n\t\t\tTELNYX_CONFIG.connectionId;\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings?.default_outbound_number || null,\n\t\t);\n\n\t\tif (!connectionOverride) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"No Telnyx connection configured for this company.\",\n\t\t\t};\n\t\t}\n\n\t\tif (!fromAddress) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured. Please provision numbers first.\",\n\t\t\t};\n\t\t}\n\n\t\t// TEMP: Skip connection verification - Level 2 required for API access\n\t\t// const connectionStatus = await verifyConnection(connectionOverride);\n\t\t// if (connectionStatus.needsFix) {\n\t\t// \treturn {\n\t\t// \t\tsuccess: false,\n\t\t// \t\terror: `Connection configuration issue: ${connectionStatus.issues.join(\", \")}. Run fixConnection() to auto-fix.`,\n\t\t// \t};\n\t\t// }\n\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\n\t\t// TEMP: Skip voice capability check - Level 2 required for API access\n\t\t// const voiceCapability = await verifyVoiceCapability(fromAddress);\n\t\t// if (!voiceCapability.hasVoice) {\n\t\t// \treturn {\n\t\t// \t\tsuccess: false,\n\t\t// \t\terror:\n\t\t// \t\t\tvoiceCapability.error || \"Phone number does not support voice calls\",\n\t\t// \t};\n\t\t// }\n\n\t\tconst telnyxWebhookUrl = await getTelnyxWebhookUrl(params.companyId);\n\t\tconsole.log(\" Webhook URL:\", telnyxWebhookUrl);\n\t\tif (!telnyxWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\n\t\tconsole.log(\" Initiating call:\", {\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\tconnectionId: connectionOverride,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t});\n\n\t\tconst result = await initiateCall({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\tconnectionId: connectionOverride,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t\tansweringMachineDetection: \"premium\",\n\t\t});\n\n\t\tconsole.log(\" Telnyx API response:\", result);\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tproperty_id: params.propertyId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"phone\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: \"\",\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_call_control_id: result.callControlId,\n\t\t\t\ttelnyx_call_session_id: result.callSessionId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\tconsole.log(\" Call created successfully:\", {\n\t\t\tcallControlId: result.callControlId,\n\t\t\tcommunicationId: data.id,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcallControlId: result.callControlId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\" makeCall error:\", error);\n\t\tconsole.error(\"Error details:\", {\n\t\t\tmessage: error instanceof Error ? error.message : String(error),\n\t\t\tstack: error instanceof Error ? error.stack : undefined,\n\t\t});\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to make call\",\n\t\t};\n\t}\n}\n\n/**\n * Answer an incoming call\n/**\n * Answer an incoming call\n */\nasync function acceptCall(callControlId: string) {\n\ttry {\n\t\tconst telnyxWebhookUrl = await getTelnyxWebhookUrl();\n\t\tif (!telnyxWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\t\tconst result = await answerCall({\n\t\t\tcallControlId,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to answer call\",\n\t\t};\n\t}\n}\n\n/**\n * Reject an incoming call\n */\nasync function declineCall(callControlId: string) {\n\ttry {\n\t\tconst result = await rejectCall({\n\t\t\tcallControlId,\n\t\t\tcause: \"CALL_REJECTED\",\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to reject call\",\n\t\t};\n\t}\n}\n\n/**\n * End an active call\n */\nasync function endCall(callControlId: string) {\n\ttry {\n\t\tconst result = await hangupCall({ callControlId });\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to end call\",\n\t\t};\n\t}\n}\n\n/**\n * Start recording a call\n */\nexport async function startCallRecording(callControlId: string) {\n\ttry {\n\t\tconst result = await startRecording({\n\t\t\tcallControlId,\n\t\t\tformat: \"mp3\",\n\t\t\tchannels: \"single\",\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to start recording\",\n\t\t};\n\t}\n}\n\n/**\n * Stop recording a call\n */\nexport async function stopCallRecording(callControlId: string) {\n\ttry {\n\t\tconst result = await stopRecording({ callControlId });\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to stop recording\",\n\t\t};\n\t}\n}\n\n/**\n * Transfer an active call to another number\n */\nexport async function transferActiveCall(params: {\n\tcallControlId: string;\n\tto: string;\n\tfrom: string;\n}) {\n\ttry {\n\t\tconst { transferCall } = await import(\"@/lib/telnyx/calls\");\n\t\tconst result = await transferCall({\n\t\t\tcallControlId: params.callControlId,\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to transfer call\",\n\t\t};\n\t}\n}\n\n/**\n * Transcribe a call recording using AssemblyAI\n *\n * Submits the recording URL to AssemblyAI for post-call transcription.\n * AssemblyAI will process the audio and send the transcript via webhook.\n *\n * @param recordingUrl - URL of the call recording (from Telnyx)\n * @param communicationId - Database ID of the communication record\n * @returns Success/error response with transcription job ID\n */\nexport async function transcribeCallRecording(params: {\n\trecordingUrl: string;\n\tcommunicationId: string;\n}) {\n\ttry {\n\t\tconst { submitTranscription } = await import(\"@/lib/assemblyai/client\");\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst webhookUrl = await buildAbsoluteUrl(\"/api/webhooks/assemblyai\");\n\t\tif (!webhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL.\",\n\t\t\t};\n\t\t}\n\n\t\t// Submit to AssemblyAI\n\t\tconst result = await submitTranscription({\n\t\t\taudio_url: params.recordingUrl,\n\t\t\tspeaker_labels: true, // Enable speaker diarization\n\t\t\twebhook_url: webhookUrl,\n\t\t});\n\n\t\tif (!(result.success && result.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: result.error || \"Failed to submit transcription\",\n\t\t\t};\n\t\t}\n\n\t\t// Store transcription job ID in database\n\t\tawait mergeProviderMetadata(supabase, params.communicationId, {\n\t\t\tassemblyai_transcription_id: result.data.id,\n\t\t\tassemblyai_status: result.data.status,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\ttranscriptionId: result.data.id,\n\t\t\tstatus: result.data.status,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to transcribe recording\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// SMS OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Send an SMS message\n */\nexport async function sendTextMessage(params: {\n\tto: string;\n\tfrom: string;\n\ttext: string;\n\tcompanyId?: string; // Optional - will be fetched if not provided\n\tcustomerId?: string;\n\tjobId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tconsole.error(\" Supabase client unavailable\");\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get company ID if not provided\n\t\tlet companyId = params.companyId;\n\t\tif (!companyId) {\n\t\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\t\tcompanyId = await getActiveCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t\t}\n\t\t}\n\n\t\tconsole.log(\" SMS Send Request:\", {\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t\tcompanyId,\n\t\t});\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t);\n\t\tif (!companySettings) {\n\t\t\tconsole.error(\" Company settings not found\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Unable to provision Telnyx resources for this company. Please verify the company's onboarding is complete and try again.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" Company settings loaded:\", {\n\t\t\tmessagingProfileId: companySettings.messaging_profile_id,\n\t\t\tdefaultNumber: companySettings.default_outbound_number,\n\t\t});\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tif (!smsConfig.valid && !companySettings?.messaging_profile_id) {\n\t\t\tlet errorMessage = smsConfig.error || \"SMS configuration is invalid\";\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} or provision company-specific settings.`;\n\t\t\t}\n\t\t\tconsole.error(\" SMS config invalid:\", errorMessage);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" SMS config valid\");\n\n\t\tconst messagingProfileId =\n\t\t\tcompanySettings?.messaging_profile_id || DEFAULT_MESSAGING_PROFILE_ID;\n\t\tif (!messagingProfileId) {\n\t\t\tconsole.error(\" No messaging profile ID\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Messaging profile is not configured for this company. Please provision communications before sending SMS.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" Using messaging profile:\", messagingProfileId);\n\n\t\tif (messagingProfileId) {\n\t\t\tconst messagingProfileStatus =\n\t\t\t\tawait verifyMessagingProfile(messagingProfileId);\n\t\t\tif (messagingProfileStatus.needsFix) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t\" Messaging profile needs fix:\",\n\t\t\t\t\tmessagingProfileStatus.issues,\n\t\t\t\t);\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Messaging profile configuration issue: ${messagingProfileStatus.issues.join(\", \")}. Run fixMessagingProfile() or reprovision the company.`,\n\t\t\t\t};\n\t\t\t}\n\t\t\tconsole.log(\" Messaging profile verified\");\n\t\t}\n\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\t\tif (!fromAddress) {\n\t\t\tconsole.error(\" No from number available\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured. Please provision numbers first.\",\n\t\t\t};\n\t\t}\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\t\tconsole.log(\" Phone numbers normalized:\", {\n\t\t\tfrom: fromAddress,\n\t\t\tto: toAddress,\n\t\t});\n\n\t\t// Verify phone number has SMS capability\n\t\tconsole.log(\" Verifying SMS capability for:\", fromAddress);\n\t\tconst smsCapability = await verifySmsCapability(fromAddress);\n\t\tif (!smsCapability.hasSms) {\n\t\t\tconsole.error(\" SMS capability check failed:\", smsCapability.error);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: smsCapability.error || \"Phone number does not support SMS\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" SMS capability verified\");\n\n\t\tconst webhookUrl = await getTelnyxWebhookUrl(companyId);\n\t\tif (!webhookUrl) {\n\t\t\tconsole.error(\" No webhook URL\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" Webhook URL:\", webhookUrl);\n\n\t\t// Send SMS via Telnyx\n\t\tconsole.log(\" Sending SMS via Telnyx API...\");\n\t\tconst result = await sendSMS({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\ttext: params.text,\n\t\t\twebhookUrl,\n\t\t\tmessagingProfileId,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\tconsole.error(\" Telnyx API failed:\", result.error);\n\n\t\t\t// Check if error is 10DLC registration required\n\t\t\tif (\n\t\t\t\tresult.error &&\n\t\t\t\t(result.error.includes(\"10DLC\") ||\n\t\t\t\t\tresult.error.includes(\"Not 10DLC registered\") ||\n\t\t\t\t\tresult.error.includes(\"A2P\"))\n\t\t\t) {\n\t\t\t\tconsole.log(\n\t\t\t\t\t\" Detected 10DLC registration required, attempting auto-registration...\",\n\t\t\t\t);\n\n\t\t\t\t// Import 10DLC registration function\n\t\t\t\tconst { registerCompanyFor10DLC } = await import(\n\t\t\t\t\t\"@/actions/ten-dlc-registration\"\n\t\t\t\t);\n\n\t\t\t\tconst registrationResult = await registerCompanyFor10DLC(\n\t\t\t\t\tcompanyId,\n\t\t\t\t);\n\n\t\t\t\tif (registrationResult.success) {\n\t\t\t\t\tconsole.log(\" 10DLC registration successful, retrying SMS send...\");\n\n\t\t\t\t\t// Retry the SMS send now that 10DLC is registered\n\t\t\t\t\tconst retryResult = await sendSMS({\n\t\t\t\t\t\tto: toAddress,\n\t\t\t\t\t\tfrom: fromAddress,\n\t\t\t\t\t\ttext: params.text,\n\t\t\t\t\t\twebhookUrl,\n\t\t\t\t\t\tmessagingProfileId,\n\t\t\t\t\t});\n\n\t\t\t\t\tif (!retryResult.success) {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\terror: `10DLC registration completed but SMS still failed: ${retryResult.error}. The campaign may need additional approval time.`,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\t// Update result with retry success\n\t\t\t\t\tresult.success = true;\n\t\t\t\t\tresult.messageId = retryResult.messageId;\n\t\t\t\t\tconsole.log(\" SMS retry successful after 10DLC registration\");\n\t\t\t\t} else {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: `10DLC registration failed: ${registrationResult.error}. Original error: ${result.error}`,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treturn result;\n\t\t\t}\n\t\t}\n\t\tconsole.log(\" Telnyx API success:\", result.messageId);\n\n\t\t// Create communication record\n\t\tconsole.log(\" Creating communication record in database...\");\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"sms\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: params.text,\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_message_id: result.messageId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.messageId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"SMS send error:\", error);\n\t\tconsole.error(\"Error details:\", {\n\t\t\tmessage: error instanceof Error ? error.message : String(error),\n\t\t\tstack: error instanceof Error ? error.stack : undefined,\n\t\t\ttype: typeof error,\n\t\t\tstringified: JSON.stringify(error, null, 2),\n\t\t});\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: `Failed to send SMS: ${String(error)}`,\n\t\t};\n\t}\n}\n\n/**\n * Send an MMS message with media\n */\nexport async function sendMMSMessage(params: {\n\tto: string;\n\tfrom: string;\n\ttext?: string;\n\tmediaUrls: string[];\n\tcompanyId?: string; // Optional - will be fetched if not provided\n\tcustomerId?: string;\n\tjobId?: string;\n\tpropertyId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get company ID if not provided\n\t\tlet companyId = params.companyId;\n\t\tif (!companyId) {\n\t\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\t\tcompanyId = await getActiveCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t\t}\n\t\t}\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t);\n\t\tif (!companySettings) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Unable to provision Telnyx resources for this company. Please verify onboarding is complete.\",\n\t\t\t};\n\t\t}\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tif (!smsConfig.valid && !companySettings.messaging_profile_id) {\n\t\t\tlet errorMessage = smsConfig.error || \"SMS configuration is invalid\";\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} or reprovision the company.`;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\n\t\tconst messagingProfileId =\n\t\t\tcompanySettings.messaging_profile_id || DEFAULT_MESSAGING_PROFILE_ID;\n\t\tif (!messagingProfileId) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Messaging profile is not configured for this company. Please provision communications before sending MMS.\",\n\t\t\t};\n\t\t}\n\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\t\tif (!fromAddress) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured.\",\n\t\t\t};\n\t\t}\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\n\t\tconst webhookUrl = await getTelnyxWebhookUrl(companyId);\n\t\tif (!webhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\n\t\tif (messagingProfileId) {\n\t\t\tconst messagingProfileStatus =\n\t\t\t\tawait verifyMessagingProfile(messagingProfileId);\n\t\t\tif (messagingProfileStatus.needsFix) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Messaging profile configuration issue: ${messagingProfileStatus.issues.join(\", \")}. Run fixMessagingProfile() or reprovision the company.`,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tconst smsCapability = await verifySmsCapability(fromAddress);\n\t\tif (!smsCapability.hasSms) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: smsCapability.error || \"Phone number does not support SMS/MMS\",\n\t\t\t};\n\t\t}\n\n\t\tconst result = await sendMMS({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\ttext: params.text,\n\t\t\tmediaUrls: params.mediaUrls,\n\t\t\twebhookUrl,\n\t\t\tmessagingProfileId,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tproperty_id: params.propertyId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"sms\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: params.text || \"\",\n\t\t\t\tattachments: params.mediaUrls.map((url) => ({ url, type: \"image\" })),\n\t\t\t\tattachment_count: params.mediaUrls.length,\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_message_id: result.messageId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.messageId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to send MMS\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// WEBRTC OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Generate WebRTC credentials for browser calling\n */\nexport async function getWebRTCCredentials() {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t\terror: userError,\n\t\t} = await supabase.auth.getUser();\n\t\tif (userError || !user) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"User not authenticated\",\n\t\t\t};\n\t\t}\n\n\t\t// OPTION 1: Use static credentials from environment (recommended for production)\n\t\tconst staticUsername = process.env.TELNYX_WEBRTC_USERNAME;\n\t\tconst staticPassword = process.env.TELNYX_WEBRTC_PASSWORD;\n\n\t\tif (staticUsername && staticPassword) {\n\t\t\tconst credential = {\n\t\t\t\tusername: staticUsername,\n\t\t\t\tpassword: staticPassword,\n\t\t\t\texpires_at: Date.now() + 86_400 * 1000, // 24 hours from now\n\t\t\t\trealm: \"sip.telnyx.com\",\n\t\t\t\tsip_uri: `sip:${staticUsername}@sip.telnyx.com`,\n\t\t\t\tstun_servers: [\n\t\t\t\t\t\"stun:stun.telnyx.com:3478\",\n\t\t\t\t\t\"stun:stun.telnyx.com:3479\",\n\t\t\t\t],\n\t\t\t\tturn_servers: [\n\t\t\t\t\t{\n\t\t\t\t\t\turls: [\n\t\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=udp\",\n\t\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=tcp\",\n\t\t\t\t\t\t],\n\t\t\t\t\t\tusername: staticUsername,\n\t\t\t\t\t\tcredential: staticPassword,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t};\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tcredential,\n\t\t\t};\n\t\t}\n\n\t\tconst { generateWebRTCToken } = await import(\"@/lib/telnyx/webrtc\");\n\t\tconst result = await generateWebRTCToken({\n\t\t\tusername: user.email || user.id,\n\t\t\tttl: 86_400, // 24 hours\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcredential: result.credential,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get WebRTC credentials\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// VOICEMAIL OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Get all voicemails for a company\n */\nasync function getVoicemails(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        customer:customers(id, first_name, last_name, email, phone),\n        phone_number:phone_numbers(phone_number, formatted_number)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"received_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get voicemails\",\n\t\t};\n\t}\n}\n\n/**\n * Mark voicemail as read\n */\nasync function markVoicemailAsRead(voicemailId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.update({\n\t\t\t\tis_read: true,\n\t\t\t\tread_at: new Date().toISOString(),\n\t\t\t\tread_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", voicemailId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to mark voicemail as read\",\n\t\t};\n\t}\n}\n\n/**\n * Delete voicemail\n */\nasync function deleteVoicemail(voicemailId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", voicemailId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to delete voicemail\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// CALL ROUTING RULES ACTIONS\n// =====================================================================================\n\n/**\n * Get all call routing rules for a company\n */\nexport async function getCallRoutingRules(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        created_by_user:users!call_routing_rules_created_by_fkey(id, name, email),\n        forward_to_user:users!call_routing_rules_forward_to_user_id_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"priority\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get call routing rules\",\n\t\t};\n\t}\n}\n\n/**\n * Create a new call routing rule\n */\nasync function createCallRoutingRule(params: {\n\tcompanyId: string;\n\tuserId: string;\n\tname: string;\n\tdescription?: string;\n\troutingType:\n\t\t| \"direct\"\n\t\t| \"round_robin\"\n\t\t| \"ivr\"\n\t\t| \"business_hours\"\n\t\t| \"conditional\";\n\tpriority?: number;\n\tbusinessHours?: Record<string, unknown>;\n\ttimezone?: string;\n\tafterHoursAction?: \"voicemail\" | \"forward\" | \"hangup\";\n\tafterHoursForwardTo?: string;\n\tteamMembers?: string[];\n\tringTimeout?: number;\n\tivrMenu?: Record<string, unknown>;\n\tivrGreetingUrl?: string;\n\tforwardToNumber?: string;\n\tforwardToUserId?: string;\n\tenableVoicemail?: boolean;\n\tvoicemailGreetingUrl?: string;\n\tvoicemailTranscriptionEnabled?: boolean;\n\tvoicemailEmailNotifications?: boolean;\n\trecordCalls?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: params.companyId,\n\t\t\t\tcreated_by: params.userId,\n\t\t\t\tname: params.name,\n\t\t\t\tdescription: params.description,\n\t\t\t\trouting_type: params.routingType,\n\t\t\t\tpriority: params.priority || 0,\n\t\t\t\tbusiness_hours: params.businessHours,\n\t\t\t\ttimezone: params.timezone || \"America/Los_Angeles\",\n\t\t\t\tafter_hours_action: params.afterHoursAction,\n\t\t\t\tafter_hours_forward_to: params.afterHoursForwardTo,\n\t\t\t\tteam_members: params.teamMembers,\n\t\t\t\tring_timeout: params.ringTimeout || 20,\n\t\t\t\tivr_menu: params.ivrMenu,\n\t\t\t\tivr_greeting_url: params.ivrGreetingUrl,\n\t\t\t\tforward_to_number: params.forwardToNumber,\n\t\t\t\tforward_to_user_id: params.forwardToUserId,\n\t\t\t\tenable_voicemail: params.enableVoicemail !== false,\n\t\t\t\tvoicemail_greeting_url: params.voicemailGreetingUrl,\n\t\t\t\tvoicemail_transcription_enabled:\n\t\t\t\t\tparams.voicemailTranscriptionEnabled !== false,\n\t\t\t\tvoicemail_email_notifications:\n\t\t\t\t\tparams.voicemailEmailNotifications !== false,\n\t\t\t\trecord_calls: params.recordCalls,\n\t\t\t\tis_active: true,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to create call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Update an existing call routing rule\n */\nexport async function updateCallRoutingRule(params: {\n\truleId: string;\n\tname?: string;\n\tdescription?: string;\n\tpriority?: number;\n\tbusinessHours?: Record<string, unknown>;\n\ttimezone?: string;\n\tafterHoursAction?: \"voicemail\" | \"forward\" | \"hangup\";\n\tafterHoursForwardTo?: string;\n\tteamMembers?: string[];\n\tringTimeout?: number;\n\tivrMenu?: Record<string, unknown>;\n\tivrGreetingUrl?: string;\n\tforwardToNumber?: string;\n\tforwardToUserId?: string;\n\tenableVoicemail?: boolean;\n\tvoicemailGreetingUrl?: string;\n\tvoicemailTranscriptionEnabled?: boolean;\n\tvoicemailEmailNotifications?: boolean;\n\trecordCalls?: boolean;\n\tisActive?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst updateData: Record<string, unknown> = {};\n\n\t\tif (params.name !== undefined) {\n\t\t\tupdateData.name = params.name;\n\t\t}\n\t\tif (params.description !== undefined) {\n\t\t\tupdateData.description = params.description;\n\t\t}\n\t\tif (params.priority !== undefined) {\n\t\t\tupdateData.priority = params.priority;\n\t\t}\n\t\tif (params.businessHours !== undefined) {\n\t\t\tupdateData.business_hours = params.businessHours;\n\t\t}\n\t\tif (params.timezone !== undefined) {\n\t\t\tupdateData.timezone = params.timezone;\n\t\t}\n\t\tif (params.afterHoursAction !== undefined) {\n\t\t\tupdateData.after_hours_action = params.afterHoursAction;\n\t\t}\n\t\tif (params.afterHoursForwardTo !== undefined) {\n\t\t\tupdateData.after_hours_forward_to = params.afterHoursForwardTo;\n\t\t}\n\t\tif (params.teamMembers !== undefined) {\n\t\t\tupdateData.team_members = params.teamMembers;\n\t\t}\n\t\tif (params.ringTimeout !== undefined) {\n\t\t\tupdateData.ring_timeout = params.ringTimeout;\n\t\t}\n\t\tif (params.ivrMenu !== undefined) {\n\t\t\tupdateData.ivr_menu = params.ivrMenu;\n\t\t}\n\t\tif (params.ivrGreetingUrl !== undefined) {\n\t\t\tupdateData.ivr_greeting_url = params.ivrGreetingUrl;\n\t\t}\n\t\tif (params.forwardToNumber !== undefined) {\n\t\t\tupdateData.forward_to_number = params.forwardToNumber;\n\t\t}\n\t\tif (params.forwardToUserId !== undefined) {\n\t\t\tupdateData.forward_to_user_id = params.forwardToUserId;\n\t\t}\n\t\tif (params.enableVoicemail !== undefined) {\n\t\t\tupdateData.enable_voicemail = params.enableVoicemail;\n\t\t}\n\t\tif (params.voicemailGreetingUrl !== undefined) {\n\t\t\tupdateData.voicemail_greeting_url = params.voicemailGreetingUrl;\n\t\t}\n\t\tif (params.voicemailTranscriptionEnabled !== undefined) {\n\t\t\tupdateData.voicemail_transcription_enabled =\n\t\t\t\tparams.voicemailTranscriptionEnabled;\n\t\t}\n\t\tif (params.voicemailEmailNotifications !== undefined) {\n\t\t\tupdateData.voicemail_email_notifications =\n\t\t\t\tparams.voicemailEmailNotifications;\n\t\t}\n\t\tif (params.recordCalls !== undefined) {\n\t\t\tupdateData.record_calls = params.recordCalls;\n\t\t}\n\t\tif (params.isActive !== undefined) {\n\t\t\tupdateData.is_active = params.isActive;\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update(updateData)\n\t\t\t.eq(\"id\", params.ruleId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to update call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Delete a call routing rule\n */\nexport async function deleteCallRoutingRule(ruleId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", ruleId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to delete call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Toggle call routing rule active status\n */\nexport async function toggleCallRoutingRule(ruleId: string, isActive: boolean) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update({ is_active: isActive })\n\t\t\t.eq(\"id\", ruleId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to toggle call routing rule\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// PHONE NUMBER USAGE STATISTICS ACTIONS\n// =====================================================================================\n\n/**\n * Get usage statistics for a phone number\n */\nasync function getPhoneNumberUsageStats(\n\tphoneNumberId: string,\n\tdays = 30,\n) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\t// Get call statistics\n\t\tconst { data: callStats, error: callError } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, call_duration, created_at\")\n\t\t\t.eq(\"type\", \"phone\")\n\t\t\t.eq(\"phone_number_id\", phoneNumberId)\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (callError) {\n\t\t\tthrow callError;\n\t\t}\n\n\t\t// Get SMS statistics\n\t\tconst { data: smsStats, error: smsError } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, created_at\")\n\t\t\t.eq(\"type\", \"sms\")\n\t\t\t.eq(\"phone_number_id\", phoneNumberId)\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (smsError) {\n\t\t\tthrow smsError;\n\t\t}\n\n\t\t// Calculate aggregates\n\t\tconst calls = callStats || [];\n\t\tconst sms = smsStats || [];\n\n\t\tconst incomingCalls = calls.filter((c) => c.direction === \"inbound\").length;\n\t\tconst outgoingCalls = calls.filter(\n\t\t\t(c) => c.direction === \"outbound\",\n\t\t).length;\n\t\tconst totalCallDuration = calls.reduce(\n\t\t\t(sum, c) => sum + (c.call_duration || 0),\n\t\t\t0,\n\t\t);\n\t\tconst incomingSms = sms.filter((s) => s.direction === \"inbound\").length;\n\t\tconst outgoingSms = sms.filter((s) => s.direction === \"outbound\").length;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tincomingCalls,\n\t\t\t\toutgoingCalls,\n\t\t\t\ttotalCalls: incomingCalls + outgoingCalls,\n\t\t\t\ttotalCallDuration,\n\t\t\t\tincomingSms,\n\t\t\t\toutgoingSms,\n\t\t\t\ttotalSms: incomingSms + outgoingSms,\n\t\t\t\tdailyStats: aggregateDailyStats([...calls, ...sms], days),\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get usage statistics\",\n\t\t};\n\t}\n}\n\n/**\n * Get company-wide usage statistics\n */\nasync function getCompanyUsageStats(companyId: string, days = 30) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\t// Get all communications for the company\n\t\tconst { data: communications, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, call_duration, created_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.in(\"type\", [\"phone\", \"sms\"])\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\tconst items = communications || [];\n\t\tconst calls = items.filter((i) => i.type === \"phone\");\n\t\tconst sms = items.filter((i) => i.type === \"sms\");\n\n\t\tconst incomingCalls = calls.filter((c) => c.direction === \"inbound\").length;\n\t\tconst outgoingCalls = calls.filter(\n\t\t\t(c) => c.direction === \"outbound\",\n\t\t).length;\n\t\tconst totalCallDuration = calls.reduce(\n\t\t\t(sum, c) => sum + (c.call_duration || 0),\n\t\t\t0,\n\t\t);\n\t\tconst incomingSms = sms.filter((s) => s.direction === \"inbound\").length;\n\t\tconst outgoingSms = sms.filter((s) => s.direction === \"outbound\").length;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tincomingCalls,\n\t\t\t\toutgoingCalls,\n\t\t\t\ttotalCalls: incomingCalls + outgoingCalls,\n\t\t\t\ttotalCallDuration,\n\t\t\t\taverageCallDuration:\n\t\t\t\t\tcalls.length > 0 ? totalCallDuration / calls.length : 0,\n\t\t\t\tincomingSms,\n\t\t\t\toutgoingSms,\n\t\t\t\ttotalSms: incomingSms + outgoingSms,\n\t\t\t\tdailyStats: aggregateDailyStats(items, days),\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get usage statistics\",\n\t\t};\n\t}\n}\n\n/**\n * Helper function to aggregate daily statistics\n */\nfunction aggregateDailyStats(\n\titems: Array<{ created_at: string; type: string; call_duration?: number }>,\n\tdays: number,\n) {\n\tconst dailyStats: Record<\n\t\tstring,\n\t\t{ date: string; calls: number; sms: number; duration: number }\n\t> = {};\n\n\t// Initialize all days\n\tfor (let i = 0; i < days; i++) {\n\t\tconst date = new Date();\n\t\tdate.setDate(date.getDate() - i);\n\t\tconst dateStr = date.toISOString().split(\"T\")[0];\n\t\tdailyStats[dateStr] = { date: dateStr, calls: 0, sms: 0, duration: 0 };\n\t}\n\n\t// Aggregate data\n\titems.forEach((item) => {\n\t\tconst dateStr = item.created_at.split(\"T\")[0];\n\t\tif (dailyStats[dateStr]) {\n\t\t\tif (item.type === \"phone\") {\n\t\t\t\tdailyStats[dateStr].calls += 1;\n\t\t\t\tdailyStats[dateStr].duration += item.call_duration || 0;\n\t\t\t} else if (item.type === \"sms\") {\n\t\t\t\tdailyStats[dateStr].sms += 1;\n\t\t\t}\n\t\t}\n\t});\n\n\treturn Object.values(dailyStats).sort((a, b) => a.date.localeCompare(b.date));\n}\n"],"names":[],"mappings":";;;;;;;IAg2BsB,oBAAA,WAAA,GAAA,IAAA,yZAAA,EAAA,8CAAA,8YAAA,EAAA,KAAA,GAAA,oZAAA,EAAA"}},
    {"offset": {"line": 500, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/ui/textarea.tsx"],"sourcesContent":["// Re-export from @stratos/ui package\nexport * from \"@stratos/ui\";\n"],"names":[],"mappings":"AAAA,qCAAqC;;AACrC"}},
    {"offset": {"line": 511, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/stores/posts-store.ts"],"sourcesContent":["import { create } from \"zustand\";\nimport { devtools } from \"zustand/middleware\";\nimport { immer } from \"zustand/middleware/immer\";\nimport type { Post } from \"@/lib/db/schema\";\n\n/**\n * Posts store state\n */\ntype PostsState = {\n\tposts: Post[];\n\tselectedPost: Post | null;\n\tisLoading: boolean;\n\terror: string | null;\n\tfilters: {\n\t\tpublished?: boolean;\n\t\tauthorId?: string;\n\t};\n};\n\n/**\n * Posts store actions\n */\ntype PostsActions = {\n\tsetPosts: (posts: Post[]) => void;\n\taddPost: (post: Post) => void;\n\tupdatePost: (id: string, updates: Partial<Post>) => void;\n\tdeletePost: (id: string) => void;\n\tsetSelectedPost: (post: Post | null) => void;\n\tsetLoading: (loading: boolean) => void;\n\tsetError: (error: string | null) => void;\n\tsetFilters: (filters: Partial<PostsState[\"filters\"]>) => void;\n\tclearFilters: () => void;\n\tgetFilteredPosts: () => Post[];\n\treset: () => void;\n};\n\n/**\n * Complete posts store\n */\nexport type PostsStore = PostsState & PostsActions;\n\n/**\n * Initial state\n */\nconst initialState: PostsState = {\n\tposts: [],\n\tselectedPost: null,\n\tisLoading: false,\n\terror: null,\n\tfilters: {},\n};\n\n/**\n * Posts store - manages posts state\n *\n * @example\n * ```tsx\n * import { usePostsStore } from \"@/lib/stores/posts-store\";\n *\n * function PostsList() {\n *   const posts = usePostsStore((state) => state.getFilteredPosts());\n *   const setFilters = usePostsStore((state) => state.setFilters);\n *\n *   return (\n *     <div>\n *       <button onClick={() => setFilters({ published: true })}>\n *         Published Only\n *       </button>\n *       {posts.map(post => (\n *         <PostCard key={post.id} post={post} />\n *       ))}\n *     </div>\n *   );\n * }\n * ```\n */\nexport const usePostsStore = create<PostsStore>()(\n\tdevtools(\n\t\timmer((set, get) => ({\n\t\t\t...initialState,\n\n\t\t\tsetPosts: (posts) =>\n\t\t\t\tset(\n\t\t\t\t\t(state) => {\n\t\t\t\t\t\tstate.posts = posts;\n\t\t\t\t\t\tstate.isLoading = false;\n\t\t\t\t\t\tstate.error = null;\n\t\t\t\t\t},\n\t\t\t\t\tfalse,\n\t\t\t\t\t\"setPosts\",\n\t\t\t\t),\n\n\t\t\taddPost: (post) =>\n\t\t\t\tset(\n\t\t\t\t\t(state) => {\n\t\t\t\t\t\tstate.posts.unshift(post);\n\t\t\t\t\t},\n\t\t\t\t\tfalse,\n\t\t\t\t\t\"addPost\",\n\t\t\t\t),\n\n\t\t\tupdatePost: (id, updates) =>\n\t\t\t\tset(\n\t\t\t\t\t(state) => {\n\t\t\t\t\t\tconst index = state.posts.findIndex((p) => p.id === id);\n\t\t\t\t\t\tif (index !== -1) {\n\t\t\t\t\t\t\tstate.posts[index] = { ...state.posts[index], ...updates };\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (state.selectedPost?.id === id) {\n\t\t\t\t\t\t\tstate.selectedPost = { ...state.selectedPost, ...updates };\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tfalse,\n\t\t\t\t\t\"updatePost\",\n\t\t\t\t),\n\n\t\t\tdeletePost: (id) =>\n\t\t\t\tset(\n\t\t\t\t\t(state) => {\n\t\t\t\t\t\tstate.posts = state.posts.filter((p) => p.id !== id);\n\t\t\t\t\t\tif (state.selectedPost?.id === id) {\n\t\t\t\t\t\t\tstate.selectedPost = null;\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tfalse,\n\t\t\t\t\t\"deletePost\",\n\t\t\t\t),\n\n\t\t\tsetSelectedPost: (post) =>\n\t\t\t\tset(\n\t\t\t\t\t(state) => {\n\t\t\t\t\t\tstate.selectedPost = post;\n\t\t\t\t\t},\n\t\t\t\t\tfalse,\n\t\t\t\t\t\"setSelectedPost\",\n\t\t\t\t),\n\n\t\t\tsetLoading: (loading) =>\n\t\t\t\tset(\n\t\t\t\t\t(state) => {\n\t\t\t\t\t\tstate.isLoading = loading;\n\t\t\t\t\t},\n\t\t\t\t\tfalse,\n\t\t\t\t\t\"setLoading\",\n\t\t\t\t),\n\n\t\t\tsetError: (error) =>\n\t\t\t\tset(\n\t\t\t\t\t(state) => {\n\t\t\t\t\t\tstate.error = error;\n\t\t\t\t\t\tstate.isLoading = false;\n\t\t\t\t\t},\n\t\t\t\t\tfalse,\n\t\t\t\t\t\"setError\",\n\t\t\t\t),\n\n\t\t\tsetFilters: (filters) =>\n\t\t\t\tset(\n\t\t\t\t\t(state) => {\n\t\t\t\t\t\tstate.filters = { ...state.filters, ...filters };\n\t\t\t\t\t},\n\t\t\t\t\tfalse,\n\t\t\t\t\t\"setFilters\",\n\t\t\t\t),\n\n\t\t\tclearFilters: () =>\n\t\t\t\tset(\n\t\t\t\t\t(state) => {\n\t\t\t\t\t\tstate.filters = {};\n\t\t\t\t\t},\n\t\t\t\t\tfalse,\n\t\t\t\t\t\"clearFilters\",\n\t\t\t\t),\n\n\t\t\tgetFilteredPosts: () => {\n\t\t\t\tconst { posts, filters } = get();\n\t\t\t\tlet filtered = [...posts];\n\n\t\t\t\tif (filters.published !== undefined) {\n\t\t\t\t\tfiltered = filtered.filter((p) => {\n\t\t\t\t\t\tconst isPublished =\n\t\t\t\t\t\t\tString(p.published).toLowerCase() === \"true\" ||\n\t\t\t\t\t\t\tp.published === true;\n\t\t\t\t\t\treturn isPublished === filters.published;\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (filters.authorId) {\n\t\t\t\t\tfiltered = filtered.filter((p) => p.authorId === filters.authorId);\n\t\t\t\t}\n\n\t\t\t\treturn filtered;\n\t\t\t},\n\n\t\t\treset: () => set(initialState, false, \"reset\"),\n\t\t})),\n\t\t{ name: \"PostsStore\" },\n\t),\n);\n\n/**\n * Selectors for optimized component re-renders\n */\nexport const postsSelectors = {\n\tposts: (state: PostsStore) => state.posts,\n\tselectedPost: (state: PostsStore) => state.selectedPost,\n\tisLoading: (state: PostsStore) => state.isLoading,\n\terror: (state: PostsStore) => state.error,\n\tfilters: (state: PostsStore) => state.filters,\n\tpublishedPosts: (state: PostsStore) =>\n\t\tstate.posts.filter(\n\t\t\t(p) =>\n\t\t\t\tString(p.published).toLowerCase() === \"true\" || p.published === true,\n\t\t),\n\tdraftPosts: (state: PostsStore) =>\n\t\tstate.posts.filter(\n\t\t\t(p) =>\n\t\t\t\t!(String(p.published).toLowerCase() === \"true\" || p.published === true),\n\t\t),\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 618, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/stores/chat-store.ts"],"sourcesContent":["// import type { UIMessage } from \"ai\";\nimport { create } from \"zustand\";\nimport { immer } from \"zustand/middleware/immer\";\n\n// Constants\nconst RANDOM_STRING_BASE = 36;\nconst RANDOM_STRING_LENGTH = 9;\n\n// Types\nexport type Message = {\n\tid: string;\n\trole: \"user\" | \"assistant\";\n\tcontent: string;\n\ttimestamp: Date;\n};\n\n// Stable empty array reference for selectors (prevents infinite loop with getSnapshot)\nconst EMPTY_MESSAGES: Message[] = [];\n\nexport type Chat = {\n\tid: string;\n\ttitle: string;\n\tcreatedAt: Date;\n\tmessages: Message[];\n};\n\nexport type ChatState = {\n\tchats: Chat[];\n\tactiveChatId: string | null;\n\tisLoading: boolean;\n\terror: string | null;\n};\n\nexport type ChatActions = {\n\t// Chat management\n\tcreateChat: (title?: string) => string;\n\tdeleteChat: (chatId: string) => void;\n\tsetActiveChat: (chatId: string | null) => void;\n\tupdateChatTitle: (chatId: string, title: string) => void;\n\tcleanupDuplicateChats: () => void;\n\n\t// Message management\n\taddMessage: (chatId: string, message: Message) => void;\n\tupdateMessage: (chatId: string, messageId: string, content: string) => void;\n\tdeleteMessage: (chatId: string, messageId: string) => void;\n\tclearMessages: (chatId: string) => void;\n\n\t// UI state\n\tsetLoading: (loading: boolean) => void;\n\tsetError: (error: string | null) => void;\n\n\t// Utility\n\tgetActiveChat: () => Chat | null;\n\tgetChatMessages: (chatId: string) => Message[];\n\treset: () => void;\n};\n\nexport type ChatStore = ChatState & ChatActions;\n\nconst initialState: ChatState = {\n\tchats: [],\n\tactiveChatId: null,\n\tisLoading: false,\n\terror: null,\n};\n\nexport const useChatStore = create<ChatStore>()(\n\timmer((set, get) => ({\n\t\t...initialState,\n\n\t\t// Chat management\n\t\tcreateChat: (title = \"New Chat\") => {\n\t\t\tlet chatId: string;\n\t\t\tconst state = get();\n\n\t\t\t// Ensure unique ID by checking against existing chats\n\t\t\tdo {\n\t\t\t\tchatId = `chat-${Date.now()}-${Math.random().toString(RANDOM_STRING_BASE).substr(2, RANDOM_STRING_LENGTH)}`;\n\t\t\t} while (state.chats.some((chat) => chat.id === chatId));\n\n\t\t\tset((storeState) => {\n\t\t\t\tstoreState.chats.push({\n\t\t\t\t\tid: chatId,\n\t\t\t\t\ttitle,\n\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\tmessages: [],\n\t\t\t\t});\n\t\t\t\tstoreState.activeChatId = chatId;\n\t\t\t});\n\t\t\treturn chatId;\n\t\t},\n\n\t\tdeleteChat: (chatId: string) => {\n\t\t\tset((state) => {\n\t\t\t\tconst index = state.chats.findIndex((c) => c.id === chatId);\n\t\t\t\tif (index !== -1) {\n\t\t\t\t\tstate.chats.splice(index, 1);\n\t\t\t\t}\n\t\t\t\tif (state.activeChatId === chatId) {\n\t\t\t\t\tstate.activeChatId = state.chats[0]?.id ?? null;\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\n\t\tsetActiveChat: (chatId: string | null) => {\n\t\t\tset((state) => {\n\t\t\t\tstate.activeChatId = chatId;\n\t\t\t});\n\t\t},\n\n\t\tupdateChatTitle: (chatId: string, title: string) => {\n\t\t\tset((state) => {\n\t\t\t\tconst chat = state.chats.find((c) => c.id === chatId);\n\t\t\t\tif (chat) {\n\t\t\t\t\tchat.title = title;\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\n\t\tcleanupDuplicateChats: () => {\n\t\t\tset((state) => {\n\t\t\t\tconst seen = new Set<string>();\n\t\t\t\tconst uniqueChats: Chat[] = [];\n\n\t\t\t\t// Keep only the first occurrence of each chat ID\n\t\t\t\tfor (const chat of state.chats) {\n\t\t\t\t\tif (!seen.has(chat.id)) {\n\t\t\t\t\t\tseen.add(chat.id);\n\t\t\t\t\t\tuniqueChats.push(chat);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tstate.chats = uniqueChats;\n\n\t\t\t\t// If active chat was removed due to duplication, set to first chat or null\n\t\t\t\tif (\n\t\t\t\t\tstate.activeChatId &&\n\t\t\t\t\t!uniqueChats.some((chat) => chat.id === state.activeChatId)\n\t\t\t\t) {\n\t\t\t\t\tstate.activeChatId = uniqueChats[0]?.id ?? null;\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\n\t\t// Message management\n\t\taddMessage: (chatId: string, message: Message) => {\n\t\t\tset((state) => {\n\t\t\t\tconst chat = state.chats.find((c) => c.id === chatId);\n\t\t\t\tif (chat) {\n\t\t\t\t\tchat.messages.push(message);\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\n\t\tupdateMessage: (chatId: string, messageId: string, content: string) => {\n\t\t\tset((state) => {\n\t\t\t\tconst chat = state.chats.find((c) => c.id === chatId);\n\t\t\t\tif (chat) {\n\t\t\t\t\tconst message = chat.messages.find((m) => m.id === messageId);\n\t\t\t\t\tif (message) {\n\t\t\t\t\t\tmessage.content = content;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\n\t\tdeleteMessage: (chatId: string, messageId: string) => {\n\t\t\tset((state) => {\n\t\t\t\tconst chat = state.chats.find((c) => c.id === chatId);\n\t\t\t\tif (chat) {\n\t\t\t\t\tconst index = chat.messages.findIndex((m) => m.id === messageId);\n\t\t\t\t\tif (index !== -1) {\n\t\t\t\t\t\tchat.messages.splice(index, 1);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\n\t\tclearMessages: (chatId: string) => {\n\t\t\tset((state) => {\n\t\t\t\tconst chat = state.chats.find((c) => c.id === chatId);\n\t\t\t\tif (chat) {\n\t\t\t\t\tchat.messages = [];\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\n\t\t// UI state\n\t\tsetLoading: (loading: boolean) => {\n\t\t\tset((state) => {\n\t\t\t\tstate.isLoading = loading;\n\t\t\t});\n\t\t},\n\n\t\tsetError: (error: string | null) => {\n\t\t\tset((state) => {\n\t\t\t\tstate.error = error;\n\t\t\t});\n\t\t},\n\n\t\t// Utility\n\t\tgetActiveChat: () => {\n\t\t\tconst state = get();\n\t\t\treturn state.chats.find((c) => c.id === state.activeChatId) ?? null;\n\t\t},\n\n\t\tgetChatMessages: (chatId: string) => {\n\t\t\tconst state = get();\n\t\t\tconst chat = state.chats.find((c) => c.id === chatId);\n\t\t\treturn chat?.messages ?? [];\n\t\t},\n\n\t\treset: () => {\n\t\t\tset(initialState);\n\t\t},\n\t})),\n);\n\n// Selectors\nexport const chatSelectors = {\n\tchats: (state: ChatStore) => state.chats,\n\tactiveChat: (state: ChatStore) =>\n\t\tstate.chats.find((c) => c.id === state.activeChatId) ?? null,\n\tactiveChatId: (state: ChatStore) => state.activeChatId,\n\tmessages: (state: ChatStore) => {\n\t\tconst activeChat = state.chats.find((c) => c.id === state.activeChatId);\n\t\treturn activeChat?.messages ?? EMPTY_MESSAGES;\n\t},\n\tisLoading: (state: ChatStore) => state.isLoading,\n\terror: (state: ChatStore) => state.error,\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 785, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/stores/index.ts"],"sourcesContent":["/**\n * Central exports for all Zustand stores\n *\n * All stores are consolidated in this directory for better organization.\n * Import stores from this file for consistency.\n */\n\n// Feature stores (already in src/lib/stores/)\n;\n;\nexport type { ChatStore } from \"./chat-store\";\n;\n;\n;\n;\n;\n;\n;\n;\n;\n;\n;\n// Core stores (moved from src/lib/store/)\nexport type { PostsStore } from \"./posts-store\";\n;\n;\n;\n;\n;\n// Schedule stores (moved from src/stores/)\n;\n;\n;\n;\nexport type { ExtractState, Store, StoreActions, StoreState } from \"./store-types\";\nexport type { UIStore } from \"./ui-store\";\nexport { useUIStore } from \"./ui-store\";\nexport type { RoleStore, UserRole } from \"./role-store\";\nexport { useRoleStore } from \"./role-store\";\nexport type { UserStore } from \"./user-store\";\n;\nexport {  type ViewFilters, type ZoomLevel } from \"./view-store\";\n;\n\n/**\n * Reset all stores to initial state\n * Useful for logout or clearing all state\n */\nconst resetAllStores = () => {\n\tconst stores = [\n\t\trequire(\"./user-store\").useUserStore,\n\t\trequire(\"./ui-store\").useUIStore,\n\t\trequire(\"./posts-store\").usePostsStore,\n\t\trequire(\"./chat-store\").useChatStore,\n\t];\n\n\tfor (const store of stores) {\n\t\tstore.getState().reset?.();\n\t}\n};\n"],"names":[],"mappings":"AAAA;;;;;CAKC,GAED,8CAA8C;;AA6B9C;AAEA;;;AAMA;;;CAGC,GACD,MAAM,iBAAiB;IACtB,MAAM,SAAS;QACd,qGAAwB,YAAY;QACpC,mGAAsB,UAAU;QAChC,sGAAyB,aAAa;QACtC,qGAAwB,YAAY;KACpC;IAED,KAAK,MAAM,SAAS,OAAQ;QAC3B,MAAM,QAAQ,GAAG,KAAK;IACvB;AACD"}},
    {"offset": {"line": 817, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/stores/call-preferences-store.ts"],"sourcesContent":["/**\n * Call Preferences Store - Zustand State Management\n *\n * Manages CSR preferences for call interface layout including:\n * - Card visibility and order customization\n * - Popover width and size preferences\n * - Card collapsed/expanded states\n * - Auto-save preferences to localStorage\n *\n * Performance optimizations:\n * - Lightweight state management with Zustand\n * - Persisted preferences across sessions\n * - Selective subscriptions prevent unnecessary re-renders\n */\n\nimport { create } from \"zustand\";\nimport { devtools, persist } from \"zustand/middleware\";\n\n// Card types available in the interface\nexport type CardType =\n\t| \"transcript\"\n\t| \"customer-info\"\n\t| \"ai-autofill\"\n\t| \"quick-actions\"\n\t| \"call-controls\"\n\t| \"notes\"\n\t| \"disposition\"\n\t| \"ai-analysis\"\n\t| \"call-scripts\"\n\t| \"transfer\";\n\n// Card preference configuration\nexport type CardPreference = {\n\tid: CardType;\n\tisVisible: boolean;\n\tisCollapsed: boolean;\n\torder: number;\n\tsize?: \"small\" | \"medium\" | \"large\"; // For future grid sizing\n};\n\n// Position type - can be \"default\" (top-right) or specific coordinates\nexport type Position = { x: number; y: number } | \"default\";\n\n// Store state type\ntype CallPreferencesStore = {\n\t// State\n\tpopoverWidth: number; // in pixels\n\tposition: Position; // popover position on screen\n\tcards: CardPreference[];\n\tlayoutMode: \"compact\" | \"comfortable\" | \"spacious\";\n\tshowAIConfidence: boolean;\n\tautoSaveNotes: boolean;\n\tkeyboardShortcutsEnabled: boolean;\n\n\t// Actions\n\tsetPopoverWidth: (width: number) => void;\n\tsetPosition: (position: { x: number; y: number }) => void;\n\tresetPosition: () => void;\n\tsetCardVisibility: (cardId: CardType, isVisible: boolean) => void;\n\tsetCardCollapsed: (cardId: CardType, isCollapsed: boolean) => void;\n\tsetCardOrder: (cardId: CardType, newOrder: number) => void;\n\treorderCards: (newOrder: CardType[]) => void;\n\ttoggleCard: (cardId: CardType) => void;\n\tsetLayoutMode: (mode: \"compact\" | \"comfortable\" | \"spacious\") => void;\n\tsetShowAIConfidence: (show: boolean) => void;\n\tsetAutoSaveNotes: (enabled: boolean) => void;\n\tsetKeyboardShortcutsEnabled: (enabled: boolean) => void;\n\tresetToDefaults: () => void;\n\tgetVisibleCards: () => CardPreference[];\n};\n\n// Default card configuration\nconst defaultCards: CardPreference[] = [\n\t{ id: \"call-controls\", isVisible: true, isCollapsed: false, order: 0 },\n\t{ id: \"transcript\", isVisible: true, isCollapsed: false, order: 1 },\n\t{ id: \"ai-autofill\", isVisible: true, isCollapsed: false, order: 2 },\n\t{ id: \"customer-info\", isVisible: true, isCollapsed: false, order: 3 },\n\t{ id: \"quick-actions\", isVisible: true, isCollapsed: false, order: 4 },\n\t{ id: \"ai-analysis\", isVisible: true, isCollapsed: false, order: 5 },\n\t{ id: \"notes\", isVisible: true, isCollapsed: false, order: 6 },\n\t{ id: \"disposition\", isVisible: true, isCollapsed: false, order: 7 },\n\t{ id: \"call-scripts\", isVisible: false, isCollapsed: true, order: 8 },\n\t{ id: \"transfer\", isVisible: false, isCollapsed: true, order: 9 },\n];\n\n// Initial state\nconst initialState = {\n\tpopoverWidth: 800, // Default to 800px\n\tposition: \"default\" as Position, // Default to top-right corner\n\tcards: defaultCards,\n\tlayoutMode: \"comfortable\" as const,\n\tshowAIConfidence: true,\n\tautoSaveNotes: true,\n\tkeyboardShortcutsEnabled: true,\n};\n\n// Create store with persistence\nexport const useCallPreferencesStore = create<CallPreferencesStore>()(\n\tdevtools(\n\t\tpersist(\n\t\t\t(set, get) => ({\n\t\t\t\t...initialState,\n\n\t\t\t\tsetPopoverWidth: (width) => {\n\t\t\t\t\t// Clamp width between 420px and 1400px\n\t\t\t\t\tconst clampedWidth = Math.max(420, Math.min(1400, width));\n\t\t\t\t\tset({ popoverWidth: clampedWidth });\n\t\t\t\t},\n\n\t\t\t\tsetPosition: (position) => {\n\t\t\t\t\tset({ position });\n\t\t\t\t},\n\n\t\t\t\tresetPosition: () => {\n\t\t\t\t\tset({ position: \"default\" });\n\t\t\t\t},\n\n\t\t\t\tsetCardVisibility: (cardId, isVisible) => {\n\t\t\t\t\tset((state) => ({\n\t\t\t\t\t\tcards: state.cards.map((card) =>\n\t\t\t\t\t\t\tcard.id === cardId ? { ...card, isVisible } : card,\n\t\t\t\t\t\t),\n\t\t\t\t\t}));\n\t\t\t\t},\n\n\t\t\t\tsetCardCollapsed: (cardId, isCollapsed) => {\n\t\t\t\t\tset((state) => ({\n\t\t\t\t\t\tcards: state.cards.map((card) =>\n\t\t\t\t\t\t\tcard.id === cardId ? { ...card, isCollapsed } : card,\n\t\t\t\t\t\t),\n\t\t\t\t\t}));\n\t\t\t\t},\n\n\t\t\t\tsetCardOrder: (cardId, newOrder) => {\n\t\t\t\t\tset((state) => {\n\t\t\t\t\t\tconst cards = [...state.cards];\n\t\t\t\t\t\tconst cardIndex = cards.findIndex((c) => c.id === cardId);\n\t\t\t\t\t\tif (cardIndex === -1) {\n\t\t\t\t\t\t\treturn state;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst [card] = cards.splice(cardIndex, 1);\n\t\t\t\t\t\tcard.order = newOrder;\n\n\t\t\t\t\t\t// Reorder all cards\n\t\t\t\t\t\tconst reordered = [\n\t\t\t\t\t\t\t...cards.slice(0, newOrder),\n\t\t\t\t\t\t\tcard,\n\t\t\t\t\t\t\t...cards.slice(newOrder),\n\t\t\t\t\t\t].map((c, index) => ({\n\t\t\t\t\t\t\t...c,\n\t\t\t\t\t\t\torder: index,\n\t\t\t\t\t\t}));\n\n\t\t\t\t\t\treturn { cards: reordered };\n\t\t\t\t\t});\n\t\t\t\t},\n\n\t\t\t\treorderCards: (newOrder) => {\n\t\t\t\t\tset((state) => {\n\t\t\t\t\t\tconst cards = state.cards.map((card) => {\n\t\t\t\t\t\t\tconst newIndex = newOrder.indexOf(card.id);\n\t\t\t\t\t\t\treturn newIndex !== -1 ? { ...card, order: newIndex } : card;\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn { cards: cards.sort((a, b) => a.order - b.order) };\n\t\t\t\t\t});\n\t\t\t\t},\n\n\t\t\t\ttoggleCard: (cardId) => {\n\t\t\t\t\tset((state) => ({\n\t\t\t\t\t\tcards: state.cards.map((card) =>\n\t\t\t\t\t\t\tcard.id === cardId\n\t\t\t\t\t\t\t\t? { ...card, isCollapsed: !card.isCollapsed }\n\t\t\t\t\t\t\t\t: card,\n\t\t\t\t\t\t),\n\t\t\t\t\t}));\n\t\t\t\t},\n\n\t\t\t\tsetLayoutMode: (mode) => set({ layoutMode: mode }),\n\n\t\t\t\tsetShowAIConfidence: (show) => set({ showAIConfidence: show }),\n\n\t\t\t\tsetAutoSaveNotes: (enabled) => set({ autoSaveNotes: enabled }),\n\n\t\t\t\tsetKeyboardShortcutsEnabled: (enabled) =>\n\t\t\t\t\tset({ keyboardShortcutsEnabled: enabled }),\n\n\t\t\t\tresetToDefaults: () => set(initialState),\n\n\t\t\t\tgetVisibleCards: () => {\n\t\t\t\t\tconst { cards } = get();\n\t\t\t\t\treturn cards\n\t\t\t\t\t\t.filter((card) => card.isVisible)\n\t\t\t\t\t\t.sort((a, b) => a.order - b.order);\n\t\t\t\t},\n\t\t\t}),\n\t\t\t{\n\t\t\t\tname: \"call-preferences-storage\",\n\t\t\t\tpartialize: (state) => ({\n\t\t\t\t\tpopoverWidth: state.popoverWidth,\n\t\t\t\t\tposition: state.position,\n\t\t\t\t\tcards: state.cards,\n\t\t\t\t\tlayoutMode: state.layoutMode,\n\t\t\t\t\tshowAIConfidence: state.showAIConfidence,\n\t\t\t\t\tautoSaveNotes: state.autoSaveNotes,\n\t\t\t\t\tkeyboardShortcutsEnabled: state.keyboardShortcutsEnabled,\n\t\t\t\t}),\n\t\t\t\t// PERFORMANCE: Skip hydration to prevent SSR mismatches\n\t\t\t\t// Allows Next.js to generate static pages without Zustand errors\n\t\t\t\tskipHydration: true,\n\t\t\t},\n\t\t),\n\t\t{ name: \"CallPreferencesStore\" },\n\t),\n);\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;CAaC;;;;AAED;AACA;;;AAuDA,6BAA6B;AAC7B,MAAM,eAAiC;IACtC;QAAE,IAAI;QAAiB,WAAW;QAAM,aAAa;QAAO,OAAO;IAAE;IACrE;QAAE,IAAI;QAAc,WAAW;QAAM,aAAa;QAAO,OAAO;IAAE;IAClE;QAAE,IAAI;QAAe,WAAW;QAAM,aAAa;QAAO,OAAO;IAAE;IACnE;QAAE,IAAI;QAAiB,WAAW;QAAM,aAAa;QAAO,OAAO;IAAE;IACrE;QAAE,IAAI;QAAiB,WAAW;QAAM,aAAa;QAAO,OAAO;IAAE;IACrE;QAAE,IAAI;QAAe,WAAW;QAAM,aAAa;QAAO,OAAO;IAAE;IACnE;QAAE,IAAI;QAAS,WAAW;QAAM,aAAa;QAAO,OAAO;IAAE;IAC7D;QAAE,IAAI;QAAe,WAAW;QAAM,aAAa;QAAO,OAAO;IAAE;IACnE;QAAE,IAAI;QAAgB,WAAW;QAAO,aAAa;QAAM,OAAO;IAAE;IACpE;QAAE,IAAI;QAAY,WAAW;QAAO,aAAa;QAAM,OAAO;IAAE;CAChE;AAED,gBAAgB;AAChB,MAAM,eAAe;IACpB,cAAc;IACd,UAAU;IACV,OAAO;IACP,YAAY;IACZ,kBAAkB;IAClB,eAAe;IACf,0BAA0B;AAC3B;AAGO,MAAM,0BAA0B,IAAA,+VAAM,IAC5C,IAAA,sWAAQ,EACP,IAAA,qWAAO,EACN,CAAC,KAAK,MAAQ,CAAC;QACd,GAAG,YAAY;QAEf,iBAAiB,CAAC;YACjB,uCAAuC;YACvC,MAAM,eAAe,KAAK,GAAG,CAAC,KAAK,KAAK,GAAG,CAAC,MAAM;YAClD,IAAI;gBAAE,cAAc;YAAa;QAClC;QAEA,aAAa,CAAC;YACb,IAAI;gBAAE;YAAS;QAChB;QAEA,eAAe;YACd,IAAI;gBAAE,UAAU;YAAU;QAC3B;QAEA,mBAAmB,CAAC,QAAQ;YAC3B,IAAI,CAAC,QAAU,CAAC;oBACf,OAAO,MAAM,KAAK,CAAC,GAAG,CAAC,CAAC,OACvB,KAAK,EAAE,KAAK,SAAS;4BAAE,GAAG,IAAI;4BAAE;wBAAU,IAAI;gBAEhD,CAAC;QACF;QAEA,kBAAkB,CAAC,QAAQ;YAC1B,IAAI,CAAC,QAAU,CAAC;oBACf,OAAO,MAAM,KAAK,CAAC,GAAG,CAAC,CAAC,OACvB,KAAK,EAAE,KAAK,SAAS;4BAAE,GAAG,IAAI;4BAAE;wBAAY,IAAI;gBAElD,CAAC;QACF;QAEA,cAAc,CAAC,QAAQ;YACtB,IAAI,CAAC;gBACJ,MAAM,QAAQ;uBAAI,MAAM,KAAK;iBAAC;gBAC9B,MAAM,YAAY,MAAM,SAAS,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK;gBAClD,IAAI,cAAc,CAAC,GAAG;oBACrB,OAAO;gBACR;gBAEA,MAAM,CAAC,KAAK,GAAG,MAAM,MAAM,CAAC,WAAW;gBACvC,KAAK,KAAK,GAAG;gBAEb,oBAAoB;gBACpB,MAAM,YAAY;uBACd,MAAM,KAAK,CAAC,GAAG;oBAClB;uBACG,MAAM,KAAK,CAAC;iBACf,CAAC,GAAG,CAAC,CAAC,GAAG,QAAU,CAAC;wBACpB,GAAG,CAAC;wBACJ,OAAO;oBACR,CAAC;gBAED,OAAO;oBAAE,OAAO;gBAAU;YAC3B;QACD;QAEA,cAAc,CAAC;YACd,IAAI,CAAC;gBACJ,MAAM,QAAQ,MAAM,KAAK,CAAC,GAAG,CAAC,CAAC;oBAC9B,MAAM,WAAW,SAAS,OAAO,CAAC,KAAK,EAAE;oBACzC,OAAO,aAAa,CAAC,IAAI;wBAAE,GAAG,IAAI;wBAAE,OAAO;oBAAS,IAAI;gBACzD;gBAEA,OAAO;oBAAE,OAAO,MAAM,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,KAAK,GAAG,EAAE,KAAK;gBAAE;YACzD;QACD;QAEA,YAAY,CAAC;YACZ,IAAI,CAAC,QAAU,CAAC;oBACf,OAAO,MAAM,KAAK,CAAC,GAAG,CAAC,CAAC,OACvB,KAAK,EAAE,KAAK,SACT;4BAAE,GAAG,IAAI;4BAAE,aAAa,CAAC,KAAK,WAAW;wBAAC,IAC1C;gBAEL,CAAC;QACF;QAEA,eAAe,CAAC,OAAS,IAAI;gBAAE,YAAY;YAAK;QAEhD,qBAAqB,CAAC,OAAS,IAAI;gBAAE,kBAAkB;YAAK;QAE5D,kBAAkB,CAAC,UAAY,IAAI;gBAAE,eAAe;YAAQ;QAE5D,6BAA6B,CAAC,UAC7B,IAAI;gBAAE,0BAA0B;YAAQ;QAEzC,iBAAiB,IAAM,IAAI;QAE3B,iBAAiB;YAChB,MAAM,EAAE,KAAK,EAAE,GAAG;YAClB,OAAO,MACL,MAAM,CAAC,CAAC,OAAS,KAAK,SAAS,EAC/B,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,KAAK,GAAG,EAAE,KAAK;QACnC;IACD,CAAC,GACD;IACC,MAAM;IACN,YAAY,CAAC,QAAU,CAAC;YACvB,cAAc,MAAM,YAAY;YAChC,UAAU,MAAM,QAAQ;YACxB,OAAO,MAAM,KAAK;YAClB,YAAY,MAAM,UAAU;YAC5B,kBAAkB,MAAM,gBAAgB;YACxC,eAAe,MAAM,aAAa;YAClC,0BAA0B,MAAM,wBAAwB;QACzD,CAAC;IACD,wDAAwD;IACxD,iEAAiE;IACjE,eAAe;AAChB,IAED;IAAE,MAAM;AAAuB"}},
    {"offset": {"line": 1034, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/hooks/use-cross-tab-sync.ts"],"sourcesContent":["/**\n * useCrossTabSync Hook\n *\n * Synchronizes call state and position across browser tabs\n *\n * Features:\n * - BroadcastChannel API for efficient cross-tab communication\n * - Fallback to localStorage events for older browsers\n * - Syncs call state (incoming, active, ended)\n * - Syncs call actions (answer, end, mute, hold, etc.)\n * - Syncs popover position and size changes\n * - Automatic cleanup on unmount\n *\n * Browser Support:\n * - BroadcastChannel: Chrome 54+, Firefox 38+, Safari 15.4+\n * - localStorage events: All browsers\n */\n\n\"use client\";\n\nimport { useCallback, useEffect, useRef } from \"react\";\nimport { useUIStore } from \"@/lib/stores\";\nimport { useCallPreferencesStore } from \"@/lib/stores/call-preferences-store\";\n\ntype CallSyncMessage = {\n\ttype:\n\t\t| \"CALL_INCOMING\"\n\t\t| \"CALL_ANSWERED\"\n\t\t| \"CALL_ENDED\"\n\t\t| \"CALL_ACTION\"\n\t\t| \"POSITION_UPDATE\"\n\t\t| \"SIZE_UPDATE\";\n\ttimestamp: number;\n\tdata?: unknown;\n};\n\ntype CallAction =\n\t| \"mute\"\n\t| \"unmute\"\n\t| \"hold\"\n\t| \"unhold\"\n\t| \"record_start\"\n\t| \"record_stop\";\n\nconst CHANNEL_NAME = \"thorbis-call-sync\";\nconst STORAGE_KEY = \"thorbis-call-sync-fallback\";\n\nexport function useCrossTabSync() {\n\tconst channelRef = useRef<BroadcastChannel | null>(null);\n\tconst isProcessingSyncRef = useRef(false); // Prevent echo when processing sync messages\n\n\t// Get store actions\n\tconst uiStore = useUIStore();\n\tconst callPrefsStore = useCallPreferencesStore();\n\n\t// Use refs to stabilize callbacks and prevent circular dependency (CRITICAL FIX)\n\tconst callRef = useRef(uiStore.call);\n\tconst positionRef = useRef(callPrefsStore.position);\n\tconst popoverWidthRef = useRef(callPrefsStore.popoverWidth);\n\tconst actionsRef = useRef({\n\t\tanswerCall: uiStore.answerCall,\n\t\tendCall: uiStore.endCall,\n\t\ttoggleMute: uiStore.toggleMute,\n\t\ttoggleHold: uiStore.toggleHold,\n\t\ttoggleRecording: uiStore.toggleRecording,\n\t\tsetIncomingCall: uiStore.setIncomingCall,\n\t\tsetPosition: callPrefsStore.setPosition,\n\t\tsetPopoverWidth: callPrefsStore.setPopoverWidth,\n\t});\n\n\t// Keep refs up to date without triggering re-renders\n\tuseEffect(() => {\n\t\tcallRef.current = uiStore.call;\n\t\tpositionRef.current = callPrefsStore.position;\n\t\tpopoverWidthRef.current = callPrefsStore.popoverWidth;\n\t\tactionsRef.current = {\n\t\t\tanswerCall: uiStore.answerCall,\n\t\t\tendCall: uiStore.endCall,\n\t\t\ttoggleMute: uiStore.toggleMute,\n\t\t\ttoggleHold: uiStore.toggleHold,\n\t\t\ttoggleRecording: uiStore.toggleRecording,\n\t\t\tsetIncomingCall: uiStore.setIncomingCall,\n\t\t\tsetPosition: callPrefsStore.setPosition,\n\t\t\tsetPopoverWidth: callPrefsStore.setPopoverWidth,\n\t\t};\n\t});\n\n\t// Handle incoming sync messages - STABILIZED with refs to prevent circular loops\n\tconst handleSyncMessage = useCallback(\n\t\t(message: CallSyncMessage) => {\n\t\t\t// Ignore old messages (more than 5 seconds old)\n\t\t\tif (Date.now() - message.timestamp > 5000) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Set flag to prevent broadcasting while processing sync\n\t\t\tisProcessingSyncRef.current = true;\n\n\t\t\ttry {\n\t\t\t\tconst call = callRef.current;\n\t\t\t\tconst position = positionRef.current;\n\t\t\t\tconst popoverWidth = popoverWidthRef.current;\n\t\t\t\tconst actions = actionsRef.current;\n\n\t\t\t\tswitch (message.type) {\n\t\t\t\t\tcase \"CALL_INCOMING\": {\n\t\t\t\t\t\tconst callData = message.data as {\n\t\t\t\t\t\t\tcaller: { name?: string; number: string; avatar?: string };\n\t\t\t\t\t\t};\n\t\t\t\t\t\tif (call.status === \"idle\") {\n\t\t\t\t\t\t\tactions.setIncomingCall({\n\t\t\t\t\t\t\t\tnumber: callData.caller.number,\n\t\t\t\t\t\t\t\tname: callData.caller.name || \"Unknown\",\n\t\t\t\t\t\t\t\tavatar: callData.caller.avatar,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\tcase \"CALL_ANSWERED\": {\n\t\t\t\t\t\tif (call.status === \"incoming\") {\n\t\t\t\t\t\t\tactions.answerCall();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\tcase \"CALL_ENDED\": {\n\t\t\t\t\t\tif (call.status !== \"idle\" && call.status !== \"ended\") {\n\t\t\t\t\t\t\tactions.endCall();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\tcase \"CALL_ACTION\": {\n\t\t\t\t\t\tconst action = message.data as CallAction;\n\t\t\t\t\t\tswitch (action) {\n\t\t\t\t\t\t\tcase \"mute\":\n\t\t\t\t\t\t\t\tif (!call.isMuted) {\n\t\t\t\t\t\t\t\t\tactions.toggleMute();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase \"unmute\":\n\t\t\t\t\t\t\t\tif (call.isMuted) {\n\t\t\t\t\t\t\t\t\tactions.toggleMute();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase \"hold\":\n\t\t\t\t\t\t\t\tif (!call.isOnHold) {\n\t\t\t\t\t\t\t\t\tactions.toggleHold();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase \"unhold\":\n\t\t\t\t\t\t\t\tif (call.isOnHold) {\n\t\t\t\t\t\t\t\t\tactions.toggleHold();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase \"record_start\":\n\t\t\t\t\t\t\t\tif (!call.isRecording) {\n\t\t\t\t\t\t\t\t\tactions.toggleRecording();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase \"record_stop\":\n\t\t\t\t\t\t\t\tif (call.isRecording) {\n\t\t\t\t\t\t\t\t\tactions.toggleRecording();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\tcase \"POSITION_UPDATE\": {\n\t\t\t\t\t\tconst newPosition = message.data as { x: number; y: number };\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tposition !== \"default\" &&\n\t\t\t\t\t\t\t(position.x !== newPosition.x || position.y !== newPosition.y)\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tactions.setPosition(newPosition);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\tcase \"SIZE_UPDATE\": {\n\t\t\t\t\t\tconst newWidth = message.data as number;\n\t\t\t\t\t\tif (popoverWidth !== newWidth) {\n\t\t\t\t\t\t\tactions.setPopoverWidth(newWidth);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\t// Always reset the flag after processing\n\t\t\t\tisProcessingSyncRef.current = false;\n\t\t\t}\n\t\t},\n\t\t[], //  No dependencies - uses refs to prevent channel recreation\n\t);\n\n\t// Setup localStorage fallback for older browsers\n\tconst setupLocalStorageFallback = useCallback(() => {\n\t\tconst handleStorageEvent = (e: StorageEvent) => {\n\t\t\tif (e.key === STORAGE_KEY && e.newValue) {\n\t\t\t\ttry {\n\t\t\t\t\tconst message: CallSyncMessage = JSON.parse(e.newValue);\n\t\t\t\t\thandleSyncMessage(message);\n\t\t\t\t} catch (_error) {}\n\t\t\t}\n\t\t};\n\n\t\twindow.addEventListener(\"storage\", handleStorageEvent);\n\n\t\treturn () => {\n\t\t\twindow.removeEventListener(\"storage\", handleStorageEvent);\n\t\t};\n\t}, [handleSyncMessage]);\n\n\t// Initialize BroadcastChannel or fallback\n\tuseEffect(() => {\n\t\t// Try BroadcastChannel (modern browsers)\n\t\tif (typeof BroadcastChannel !== \"undefined\") {\n\t\t\ttry {\n\t\t\t\tchannelRef.current = new BroadcastChannel(CHANNEL_NAME);\n\n\t\t\t\tchannelRef.current.onmessage = (\n\t\t\t\t\tevent: MessageEvent<CallSyncMessage>,\n\t\t\t\t) => {\n\t\t\t\t\thandleSyncMessage(event.data);\n\t\t\t\t};\n\t\t\t} catch (_error) {\n\t\t\t\tsetupLocalStorageFallback();\n\t\t\t}\n\t\t} else {\n\t\t\tsetupLocalStorageFallback();\n\t\t}\n\n\t\t// Listen for localStorage changes to sync persisted preferences across tabs\n\t\tconst handleStorageChange = (e: StorageEvent) => {\n\t\t\t// Zustand persist uses this key for call preferences\n\t\t\tif (e.key === \"call-preferences-storage\" && e.newValue) {\n\t\t\t\ttry {\n\t\t\t\t\tconst newState = JSON.parse(e.newValue);\n\t\t\t\t\tconst position = positionRef.current;\n\t\t\t\t\tconst popoverWidth = popoverWidthRef.current;\n\t\t\t\t\tconst actions = actionsRef.current;\n\n\t\t\t\t\t// Update position if changed\n\t\t\t\t\tif (\n\t\t\t\t\t\tnewState.state?.position &&\n\t\t\t\t\t\tJSON.stringify(newState.state.position) !== JSON.stringify(position)\n\t\t\t\t\t) {\n\t\t\t\t\t\tactions.setPosition(newState.state.position);\n\t\t\t\t\t}\n\t\t\t\t\t// Update width if changed\n\t\t\t\t\tif (\n\t\t\t\t\t\tnewState.state?.popoverWidth &&\n\t\t\t\t\t\tnewState.state.popoverWidth !== popoverWidth\n\t\t\t\t\t) {\n\t\t\t\t\t\tactions.setPopoverWidth(newState.state.popoverWidth);\n\t\t\t\t\t}\n\t\t\t\t} catch (_error) {}\n\t\t\t}\n\t\t};\n\n\t\twindow.addEventListener(\"storage\", handleStorageChange);\n\n\t\treturn () => {\n\t\t\tif (channelRef.current) {\n\t\t\t\tchannelRef.current.close();\n\t\t\t}\n\t\t\twindow.removeEventListener(\"storage\", handleStorageChange);\n\t\t};\n\t}, [handleSyncMessage, setupLocalStorageFallback]); //  Only stable callbacks\n\n\t// Broadcast a message to other tabs\n\tconst broadcast = useCallback((message: CallSyncMessage) => {\n\t\t// Don't broadcast if we're currently processing a sync message (prevents infinite loops)\n\t\tif (isProcessingSyncRef.current) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (channelRef.current) {\n\t\t\t// Use BroadcastChannel (doesn't echo back to sender)\n\t\t\tchannelRef.current.postMessage(message);\n\t\t} else {\n\t\t\t// Use localStorage fallback (will echo back, but we ignore it via timestamp check)\n\t\t\tlocalStorage.setItem(STORAGE_KEY, JSON.stringify(message));\n\t\t\t// Clear immediately to allow same message to be sent again\n\t\t\tlocalStorage.removeItem(STORAGE_KEY);\n\t\t}\n\t}, []);\n\n\t// Public API for broadcasting events\n\treturn {\n\t\tbroadcastIncomingCall: useCallback(\n\t\t\t(caller: { name?: string; number: string; avatar?: string }) => {\n\t\t\t\tbroadcast({\n\t\t\t\t\ttype: \"CALL_INCOMING\",\n\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\tdata: { caller },\n\t\t\t\t});\n\t\t\t},\n\t\t\t[broadcast],\n\t\t),\n\n\t\tbroadcastCallAnswered: useCallback(() => {\n\t\t\tbroadcast({\n\t\t\t\ttype: \"CALL_ANSWERED\",\n\t\t\t\ttimestamp: Date.now(),\n\t\t\t});\n\t\t}, [broadcast]),\n\n\t\tbroadcastCallEnded: useCallback(() => {\n\t\t\tbroadcast({\n\t\t\t\ttype: \"CALL_ENDED\",\n\t\t\t\ttimestamp: Date.now(),\n\t\t\t});\n\t\t}, [broadcast]),\n\n\t\tbroadcastCallAction: useCallback(\n\t\t\t(action: CallAction) => {\n\t\t\t\tbroadcast({\n\t\t\t\t\ttype: \"CALL_ACTION\",\n\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\tdata: action,\n\t\t\t\t});\n\t\t\t},\n\t\t\t[broadcast],\n\t\t),\n\n\t\tbroadcastPositionUpdate: useCallback(\n\t\t\t(x: number, y: number) => {\n\t\t\t\tbroadcast({\n\t\t\t\t\ttype: \"POSITION_UPDATE\",\n\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\tdata: { x, y },\n\t\t\t\t});\n\t\t\t},\n\t\t\t[broadcast],\n\t\t),\n\n\t\tbroadcastSizeUpdate: useCallback(\n\t\t\t(width: number) => {\n\t\t\t\tbroadcast({\n\t\t\t\t\ttype: \"SIZE_UPDATE\",\n\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\tdata: width,\n\t\t\t\t});\n\t\t\t},\n\t\t\t[broadcast],\n\t\t),\n\t};\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1386, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/hooks/use-draggable-position.ts"],"sourcesContent":["/**\n * useDraggablePosition Hook\n *\n * Enables drag-to-move functionality for the call popover\n *\n * Features:\n * - Click and drag header to reposition\n * - Constrain to viewport boundaries\n * - Edge snapping (20px threshold)\n * - Position persistence via preferences store\n * - Visual feedback while dragging\n * - Touch support for mobile\n */\n\nimport { useCallback, useEffect, useRef, useState } from \"react\";\nimport { useCallPreferencesStore } from \"@/lib/stores/call-preferences-store\";\n\ntype Position = {\n\tx: number;\n\ty: number;\n};\n\ntype UseDraggablePositionOptions = {\n\twidth: number;\n\theight: number;\n\tsnapThreshold?: number;\n\tonDragStart?: () => void;\n\tonDragEnd?: () => void;\n\tonBeyondBounds?: (isBeyond: boolean) => void;\n};\n\nconst DEFAULT_SNAP_THRESHOLD = 20;\nconst POP_OUT_THRESHOLD = 50; // pixels beyond window edge\n\nexport function useDraggablePosition(options: UseDraggablePositionOptions) {\n\tconst {\n\t\twidth,\n\t\theight,\n\t\tsnapThreshold = DEFAULT_SNAP_THRESHOLD,\n\t\tonDragStart,\n\t\tonDragEnd,\n\t\tonBeyondBounds,\n\t} = options;\n\n\tconst position = useCallPreferencesStore((state) => state.position);\n\tconst setPosition = useCallPreferencesStore((state) => state.setPosition);\n\n\tconst [isDragging, setIsDragging] = useState(false);\n\t// Lazy initialization to avoid SSR issues with window\n\tconst [currentPosition, setCurrentPosition] = useState<Position>(() => {\n\t\tif (typeof window === \"undefined\") {\n\t\t\treturn { x: 0, y: 0 };\n\t\t}\n\t\treturn position === \"default\"\n\t\t\t? { x: window.innerWidth - width - 24, y: 24 }\n\t\t\t: position;\n\t});\n\n\tconst dragStartPosRef = useRef<Position>({ x: 0, y: 0 });\n\tconst dragOffsetRef = useRef<Position>({ x: 0, y: 0 });\n\tconst animationFrameRef = useRef<number | null>(null);\n\tconst isDraggingRef = useRef(false);\n\n\t// Update current position when width changes or store position changes\n\tuseEffect(() => {\n\t\tif (!isDragging && typeof window !== \"undefined\") {\n\t\t\tif (position === \"default\") {\n\t\t\t\tconst defaultPos = { x: window.innerWidth - width - 24, y: 24 };\n\t\t\t\tsetCurrentPosition(defaultPos);\n\t\t\t} else {\n\t\t\t\tsetCurrentPosition(position);\n\t\t\t}\n\t\t}\n\t}, [position, width, isDragging]);\n\n\t// Check if position is beyond window bounds (for pop-out detection)\n\tconst checkBeyondBounds = useCallback((pos: Position): boolean => {\n\t\tif (typeof window === \"undefined\") {\n\t\t\treturn false;\n\t\t}\n\t\treturn (\n\t\t\tpos.x < -POP_OUT_THRESHOLD ||\n\t\t\tpos.y < -POP_OUT_THRESHOLD ||\n\t\t\tpos.x > window.innerWidth + POP_OUT_THRESHOLD ||\n\t\t\tpos.y > window.innerHeight + POP_OUT_THRESHOLD\n\t\t);\n\t}, []);\n\n\t// Constrain position to viewport with optional edge snapping\n\tconst constrainPosition = useCallback(\n\t\t(pos: Position, allowBeyondBounds = false): Position => {\n\t\t\tif (typeof window === \"undefined\") {\n\t\t\t\treturn pos;\n\t\t\t}\n\n\t\t\tlet { x, y } = pos;\n\n\t\t\tif (!allowBeyondBounds) {\n\t\t\t\t// Hard constraints\n\t\t\t\tx = Math.max(0, Math.min(x, window.innerWidth - width));\n\t\t\t\ty = Math.max(0, Math.min(y, window.innerHeight - height));\n\n\t\t\t\t// Edge snapping\n\t\t\t\tif (x < snapThreshold) {\n\t\t\t\t\tx = 0;\n\t\t\t\t}\n\t\t\t\tif (y < snapThreshold) {\n\t\t\t\t\ty = 0;\n\t\t\t\t}\n\t\t\t\tif (window.innerWidth - x - width < snapThreshold) {\n\t\t\t\t\tx = window.innerWidth - width;\n\t\t\t\t}\n\t\t\t\tif (window.innerHeight - y - height < snapThreshold) {\n\t\t\t\t\ty = window.innerHeight - height;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn { x, y };\n\t\t},\n\t\t[width, height, snapThreshold],\n\t);\n\n\t// Handle drag start\n\tconst handleDragStart = useCallback(\n\t\t(clientX: number, clientY: number, _element: HTMLElement) => {\n\t\t\tisDraggingRef.current = true;\n\t\t\tsetIsDragging(true);\n\t\t\tdragStartPosRef.current = { x: clientX, y: clientY };\n\t\t\tdragOffsetRef.current = {\n\t\t\t\tx: clientX - currentPosition.x,\n\t\t\t\ty: clientY - currentPosition.y,\n\t\t\t};\n\n\t\t\tonDragStart?.();\n\t\t},\n\t\t[currentPosition, onDragStart],\n\t);\n\n\t// Mouse events\n\tconst handleMouseDown = useCallback(\n\t\t(e: React.MouseEvent<HTMLElement>) => {\n\t\t\t// Only start drag if clicking on drag handle area\n\t\t\tconst target = e.target as HTMLElement;\n\t\t\tif (target.closest(\"[data-drag-handle]\")) {\n\t\t\t\te.preventDefault();\n\t\t\t\t// Find the draggable container (go up to the element with drag handlers)\n\t\t\t\tconst container = e.currentTarget.closest(\n\t\t\t\t\t\"[data-draggable-container]\",\n\t\t\t\t) as HTMLElement;\n\t\t\t\tif (container) {\n\t\t\t\t\thandleDragStart(e.clientX, e.clientY, container);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t[handleDragStart],\n\t);\n\n\t// Touch events\n\tconst handleTouchStart = useCallback(\n\t\t(e: React.TouchEvent<HTMLElement>) => {\n\t\t\tconst target = e.target as HTMLElement;\n\t\t\tif (target.closest(\"[data-drag-handle]\")) {\n\t\t\t\te.preventDefault();\n\t\t\t\tconst touch = e.touches[0];\n\t\t\t\tconst container = e.currentTarget.closest(\n\t\t\t\t\t\"[data-draggable-container]\",\n\t\t\t\t) as HTMLElement;\n\t\t\t\tif (container) {\n\t\t\t\t\thandleDragStart(touch.clientX, touch.clientY, container);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t[handleDragStart],\n\t);\n\n\t// Use refs for callbacks to prevent listener stacking (CRITICAL FIX)\n\tconst constrainPositionRef = useRef(constrainPosition);\n\tconst checkBeyondBoundsRef = useRef(checkBeyondBounds);\n\tconst onBeyondBoundsRef = useRef(onBeyondBounds);\n\tconst onDragEndRef = useRef(onDragEnd);\n\tconst setPositionRef = useRef(setPosition);\n\n\t// Keep refs up to date\n\tuseEffect(() => {\n\t\tconstrainPositionRef.current = constrainPosition;\n\t\tcheckBeyondBoundsRef.current = checkBeyondBounds;\n\t\tonBeyondBoundsRef.current = onBeyondBounds;\n\t\tonDragEndRef.current = onDragEnd;\n\t\tsetPositionRef.current = setPosition;\n\t});\n\n\t// Handle dragging\n\tuseEffect(() => {\n\t\tif (!isDragging) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleMouseMove = (e: MouseEvent) => {\n\t\t\tif (!isDraggingRef.current) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Cancel any pending animation frame\n\t\t\tif (animationFrameRef.current) {\n\t\t\t\tcancelAnimationFrame(animationFrameRef.current);\n\t\t\t}\n\n\t\t\t// Use requestAnimationFrame for smooth, performant updates\n\t\t\tanimationFrameRef.current = requestAnimationFrame(() => {\n\t\t\t\tconst newPos = {\n\t\t\t\t\tx: e.clientX - dragOffsetRef.current.x,\n\t\t\t\t\ty: e.clientY - dragOffsetRef.current.y,\n\t\t\t\t};\n\n\t\t\t\t// Check if beyond bounds for pop-out\n\t\t\t\tconst isBeyond = checkBeyondBoundsRef.current(newPos);\n\t\t\t\tonBeyondBoundsRef.current?.(isBeyond);\n\n\t\t\t\t// Allow position beyond bounds while dragging (for pop-out)\n\t\t\t\tconst constrainedPos = constrainPositionRef.current(newPos, true);\n\n\t\t\t\t// Update local state (no store update = fast)\n\t\t\t\tsetCurrentPosition(constrainedPos);\n\t\t\t});\n\t\t};\n\n\t\tconst handleMouseUp = (e: MouseEvent) => {\n\t\t\tif (!isDraggingRef.current) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Cancel any pending animation frame\n\t\t\tif (animationFrameRef.current) {\n\t\t\t\tcancelAnimationFrame(animationFrameRef.current);\n\t\t\t}\n\n\t\t\tconst finalPos = {\n\t\t\t\tx: e.clientX - dragOffsetRef.current.x,\n\t\t\t\ty: e.clientY - dragOffsetRef.current.y,\n\t\t\t};\n\n\t\t\tconst isBeyond = checkBeyondBoundsRef.current(finalPos);\n\n\t\t\tif (!isBeyond) {\n\t\t\t\t// Normal drop - constrain and save (only save to store on drop, not during drag)\n\t\t\t\tconst constrainedPos = constrainPositionRef.current(finalPos, false);\n\n\t\t\t\tsetCurrentPosition(constrainedPos);\n\t\t\t\tsetPositionRef.current(constrainedPos);\n\t\t\t}\n\n\t\t\tisDraggingRef.current = false;\n\t\t\tsetIsDragging(false);\n\t\t\tonBeyondBoundsRef.current?.(false);\n\t\t\tonDragEndRef.current?.();\n\t\t};\n\n\t\tconst handleTouchMove = (e: TouchEvent) => {\n\t\t\tif (!isDraggingRef.current) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Cancel any pending animation frame\n\t\t\tif (animationFrameRef.current) {\n\t\t\t\tcancelAnimationFrame(animationFrameRef.current);\n\t\t\t}\n\n\t\t\t// Use requestAnimationFrame for smooth, performant updates\n\t\t\tanimationFrameRef.current = requestAnimationFrame(() => {\n\t\t\t\tconst touch = e.touches[0];\n\t\t\t\tconst newPos = {\n\t\t\t\t\tx: touch.clientX - dragOffsetRef.current.x,\n\t\t\t\t\ty: touch.clientY - dragOffsetRef.current.y,\n\t\t\t\t};\n\n\t\t\t\tconst isBeyond = checkBeyondBoundsRef.current(newPos);\n\t\t\t\tonBeyondBoundsRef.current?.(isBeyond);\n\n\t\t\t\tconst constrainedPos = constrainPositionRef.current(newPos, true);\n\n\t\t\t\t// Update local state (no store update = fast)\n\t\t\t\tsetCurrentPosition(constrainedPos);\n\t\t\t});\n\t\t};\n\n\t\tconst handleTouchEnd = (e: TouchEvent) => {\n\t\t\tif (!isDraggingRef.current) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Cancel any pending animation frame\n\t\t\tif (animationFrameRef.current) {\n\t\t\t\tcancelAnimationFrame(animationFrameRef.current);\n\t\t\t}\n\n\t\t\tconst touch = e.changedTouches[0];\n\t\t\tconst finalPos = {\n\t\t\t\tx: touch.clientX - dragOffsetRef.current.x,\n\t\t\t\ty: touch.clientY - dragOffsetRef.current.y,\n\t\t\t};\n\n\t\t\tconst isBeyond = checkBeyondBoundsRef.current(finalPos);\n\n\t\t\tif (!isBeyond) {\n\t\t\t\tconst constrainedPos = constrainPositionRef.current(finalPos, false);\n\n\t\t\t\tsetCurrentPosition(constrainedPos);\n\t\t\t\tsetPositionRef.current(constrainedPos);\n\t\t\t}\n\n\t\t\tisDraggingRef.current = false;\n\t\t\tsetIsDragging(false);\n\t\t\tonBeyondBoundsRef.current?.(false);\n\t\t\tonDragEndRef.current?.();\n\t\t};\n\n\t\tdocument.addEventListener(\"mousemove\", handleMouseMove);\n\t\tdocument.addEventListener(\"mouseup\", handleMouseUp);\n\t\tdocument.addEventListener(\"touchmove\", handleTouchMove);\n\t\tdocument.addEventListener(\"touchend\", handleTouchEnd);\n\n\t\treturn () => {\n\t\t\tdocument.removeEventListener(\"mousemove\", handleMouseMove);\n\t\t\tdocument.removeEventListener(\"mouseup\", handleMouseUp);\n\t\t\tdocument.removeEventListener(\"touchmove\", handleTouchMove);\n\t\t\tdocument.removeEventListener(\"touchend\", handleTouchEnd);\n\n\t\t\t// Cleanup animation frame\n\t\t\tif (animationFrameRef.current) {\n\t\t\t\tcancelAnimationFrame(animationFrameRef.current);\n\t\t\t}\n\t\t};\n\t}, [isDragging]); //  Only isDragging - uses refs for callbacks\n\n\t// Reset to default position\n\tconst resetPosition = useCallback(() => {\n\t\tif (typeof window === \"undefined\") {\n\t\t\treturn;\n\t\t}\n\t\tconst defaultPos = { x: window.innerWidth - width - 24, y: 24 };\n\t\tsetCurrentPosition(defaultPos);\n\t\tsetPosition(defaultPos);\n\t}, [width, setPosition]);\n\n\treturn {\n\t\tposition: currentPosition,\n\t\tisDragging,\n\t\thandleMouseDown,\n\t\thandleTouchStart,\n\t\tresetPosition,\n\t};\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1738, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/hooks/use-pop-out-drag.ts"],"sourcesContent":["/**\n * usePopOutDrag Hook\n *\n * Manages pop-out window creation when call UI is dragged beyond window bounds\n *\n * Features:\n * - Detects when drag exceeds threshold (50px beyond edge)\n * - Shows visual indicator when in pop-out zone\n * - Creates pop-out window on release\n * - Manages pop-out state and communication\n * - Handles returning call to main window\n *\n * Works with useDraggablePosition hook for drag detection\n */\n\nimport { useCallback, useEffect, useRef, useState } from \"react\";\n\ntype PopOutState = {\n\tisPopOutZone: boolean; // User is dragging in pop-out zone\n\tisPopOutActive: boolean; // Call is currently popped out\n\tpopOutWindow: Window | null; // Reference to pop-out window\n};\n\ntype UsePopOutDragOptions = {\n\tcallId: string;\n\tonPopOutCreated?: () => void;\n\tonPopOutClosed?: () => void;\n};\n\nexport function usePopOutDrag(options: UsePopOutDragOptions) {\n\tconst { callId, onPopOutCreated, onPopOutClosed } = options;\n\n\tconst [state, setState] = useState<PopOutState>({\n\t\tisPopOutZone: false,\n\t\tisPopOutActive: false,\n\t\tpopOutWindow: null,\n\t});\n\n\tconst popOutWindowRef = useRef<Window | null>(null);\n\tconst messageHandlerRef = useRef<((event: MessageEvent) => void) | null>(\n\t\tnull,\n\t);\n\n\t// Handle when user drags into/out of pop-out zone\n\tconst handleBeyondBounds = useCallback((isBeyond: boolean) => {\n\t\tsetState((prev) => ({\n\t\t\t...prev,\n\t\t\tisPopOutZone: isBeyond && !prev.isPopOutActive,\n\t\t}));\n\t}, []);\n\n\t// Handle when pop-out window is closed\n\tconst handlePopOutClosed = useCallback(() => {\n\t\tpopOutWindowRef.current = null;\n\n\t\tsetState((prev) => ({\n\t\t\t...prev,\n\t\t\tisPopOutActive: false,\n\t\t\tpopOutWindow: null,\n\t\t}));\n\n\t\tonPopOutClosed?.();\n\t}, [onPopOutClosed]);\n\n\t// Create call window in new tab\n\tconst createPopOut = useCallback(() => {\n\t\tif (state.isPopOutActive || popOutWindowRef.current) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Open in new tab (much simpler and more reliable)\n\t\tconst popOut = window.open(\n\t\t\t`/call?callId=${callId}`,\n\t\t\t\"_blank\",\n\t\t\t\"noopener,noreferrer\",\n\t\t);\n\n\t\tif (!popOut) {\n\t\t\treturn;\n\t\t}\n\n\t\tpopOutWindowRef.current = popOut;\n\n\t\tsetState((prev) => ({\n\t\t\t...prev,\n\t\t\tisPopOutActive: true,\n\t\t\tisPopOutZone: false,\n\t\t\tpopOutWindow: popOut,\n\t\t}));\n\n\t\t// Wait for pop-out to load, then send call data\n\t\tconst checkInterval = setInterval(() => {\n\t\t\tif (popOut.closed) {\n\t\t\t\tclearInterval(checkInterval);\n\t\t\t\thandlePopOutClosed();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\t// Send call state to pop-out window\n\t\t\t\tpopOut.postMessage(\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"CALL_STATE_INIT\",\n\t\t\t\t\t\tcallId,\n\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t},\n\t\t\t\t\twindow.location.origin,\n\t\t\t\t);\n\n\t\t\t\t// Successfully sent, stop checking\n\t\t\t\tclearInterval(checkInterval);\n\t\t\t\tonPopOutCreated?.();\n\t\t\t} catch (_error) {\n\t\t\t\t// Pop-out not ready yet, continue checking\n\t\t\t}\n\t\t}, 100);\n\n\t\t// Stop checking after 5 seconds\n\t\tsetTimeout(() => clearInterval(checkInterval), 5000);\n\n\t\t// Monitor for pop-out window close\n\t\tconst closeInterval = setInterval(() => {\n\t\t\tif (popOut.closed) {\n\t\t\t\tclearInterval(closeInterval);\n\t\t\t\thandlePopOutClosed();\n\t\t\t}\n\t\t}, 500);\n\n\t\treturn () => {\n\t\t\tclearInterval(checkInterval);\n\t\t\tclearInterval(closeInterval);\n\t\t};\n\t}, [callId, state.isPopOutActive, onPopOutCreated, handlePopOutClosed]);\n\n\t// Close pop-out and return call to main window\n\tconst returnToMain = useCallback(() => {\n\t\tif (popOutWindowRef.current && !popOutWindowRef.current.closed) {\n\t\t\tpopOutWindowRef.current.close();\n\t\t}\n\n\t\thandlePopOutClosed();\n\t}, [handlePopOutClosed]);\n\n\t// Bring pop-out window to front\n\tconst focusPopOut = useCallback(() => {\n\t\tif (popOutWindowRef.current && !popOutWindowRef.current.closed) {\n\t\t\tpopOutWindowRef.current.focus();\n\t\t}\n\t}, []);\n\n\t// Handle messages from pop-out window\n\tuseEffect(() => {\n\t\tconst handleMessage = (event: MessageEvent) => {\n\t\t\t// Security: Verify origin\n\t\t\tif (event.origin !== window.location.origin) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst { type, callId: messageCallId } = event.data;\n\n\t\t\t// Only handle messages for this call\n\t\t\tif (messageCallId !== callId) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tswitch (type) {\n\t\t\t\tcase \"CALL_POP_OUT_READY\":\n\t\t\t\t\t// Pop-out window is ready to receive data\n\t\t\t\t\tif (popOutWindowRef.current) {\n\t\t\t\t\t\tpopOutWindowRef.current.postMessage(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttype: \"CALL_STATE_SYNC\",\n\t\t\t\t\t\t\t\tcallId,\n\t\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\twindow.location.origin,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"CALL_POP_OUT_CLOSED\":\n\t\t\t\t\t// Pop-out requested to close\n\t\t\t\t\thandlePopOutClosed();\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"CALL_ACTION\":\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t};\n\n\t\tmessageHandlerRef.current = handleMessage;\n\t\twindow.addEventListener(\"message\", handleMessage);\n\n\t\treturn () => {\n\t\t\tif (messageHandlerRef.current) {\n\t\t\t\twindow.removeEventListener(\"message\", messageHandlerRef.current);\n\t\t\t}\n\t\t};\n\t}, [callId, handlePopOutClosed]);\n\n\t// Cleanup on unmount\n\tuseEffect(\n\t\t() => () => {\n\t\t\tif (popOutWindowRef.current && !popOutWindowRef.current.closed) {\n\t\t\t\tpopOutWindowRef.current.close();\n\t\t\t}\n\t\t},\n\t\t[],\n\t);\n\n\treturn {\n\t\t// State\n\t\tisPopOutZone: state.isPopOutZone,\n\t\tisPopOutActive: state.isPopOutActive,\n\t\tpopOutWindow: state.popOutWindow,\n\n\t\t// Actions\n\t\thandleBeyondBounds,\n\t\tcreatePopOut,\n\t\treturnToMain,\n\t\tfocusPopOut,\n\t};\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1963, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/hooks/use-resizable-multi.ts"],"sourcesContent":["/**\n * useResizableMulti Hook\n *\n * Multi-directional resize functionality with snap points\n *\n * Features:\n * - Resize from any edge (top, right, bottom, left)\n * - Resize from corners (diagonal resizing)\n * - Snap points at common sizes\n * - Min/max width and height constraints\n * - Persists size to preferences store\n * - Adjusts position when resizing from top/left\n *\n * Performance optimizations:\n * - Uses requestAnimationFrame for smooth resizing\n * - Debounced store updates\n */\n\nimport { useCallback, useEffect, useRef, useState } from \"react\";\nimport { useCallPreferencesStore } from \"@/lib/stores/call-preferences-store\";\n\nexport type ResizeDirection = \"n\" | \"e\" | \"s\" | \"w\" | \"ne\" | \"se\" | \"sw\" | \"nw\";\n\ntype UseResizableMultiOptions = {\n\tminWidth?: number;\n\tmaxWidth?: number;\n\tminHeight?: number;\n\tmaxHeight?: number;\n\tsnapPoints?: number[];\n\tsnapThreshold?: number;\n\tonResize?: (width: number, height: number, x: number, y: number) => void;\n};\n\nconst DEFAULT_SNAP_POINTS = [600, 800, 1000, 1200];\nconst DEFAULT_MIN_WIDTH = 420;\nconst DEFAULT_MAX_WIDTH = 1400;\nconst DEFAULT_MIN_HEIGHT = 400;\nconst DEFAULT_MAX_HEIGHT = 2000;\nconst DEFAULT_SNAP_THRESHOLD = 30;\n\nexport function useResizableMulti(\n\tcurrentPosition: { x: number; y: number },\n\tcurrentHeight: number,\n\toptions: UseResizableMultiOptions = {},\n) {\n\tconst {\n\t\tminWidth = DEFAULT_MIN_WIDTH,\n\t\tmaxWidth = DEFAULT_MAX_WIDTH,\n\t\tminHeight = DEFAULT_MIN_HEIGHT,\n\t\tmaxHeight = DEFAULT_MAX_HEIGHT,\n\t\tsnapPoints = DEFAULT_SNAP_POINTS,\n\t\tsnapThreshold = DEFAULT_SNAP_THRESHOLD,\n\t\tonResize,\n\t} = options;\n\n\tconst width = useCallPreferencesStore((state) => state.popoverWidth);\n\tconst setPopoverWidth = useCallPreferencesStore(\n\t\t(state) => state.setPopoverWidth,\n\t);\n\tconst setPosition = useCallPreferencesStore((state) => state.setPosition);\n\n\tconst [isResizing, setIsResizing] = useState(false);\n\tconst [activeDirection, setActiveDirection] =\n\t\tuseState<ResizeDirection | null>(null);\n\n\t// Local state for instant updates during resize (no store latency)\n\tconst [localState, setLocalState] = useState({\n\t\twidth,\n\t\theight: currentHeight,\n\t\tx: currentPosition.x,\n\t\ty: currentPosition.y,\n\t});\n\n\tconst startRef = useRef({\n\t\tx: 0,\n\t\ty: 0,\n\t\twidth: 0,\n\t\theight: 0,\n\t\tposX: 0,\n\t\tposY: 0,\n\t});\n\tconst animationFrameRef = useRef<number | null>(null);\n\tconst isResizingRef = useRef(false);\n\n\t// Apply snap to value\n\tconst applySnap = useCallback(\n\t\t(value: number): number => {\n\t\t\tfor (const snapPoint of snapPoints) {\n\t\t\t\tif (Math.abs(value - snapPoint) < snapThreshold) {\n\t\t\t\t\treturn snapPoint;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn value;\n\t\t},\n\t\t[snapPoints, snapThreshold],\n\t);\n\n\t// Sync local state with props when not resizing\n\tuseEffect(() => {\n\t\tif (!isResizing) {\n\t\t\tsetLocalState({\n\t\t\t\twidth,\n\t\t\t\theight: currentHeight,\n\t\t\t\tx: currentPosition.x,\n\t\t\t\ty: currentPosition.y,\n\t\t\t});\n\t\t}\n\t}, [width, currentHeight, currentPosition, isResizing]);\n\n\t// Handle resize start\n\tconst handleResizeStart = useCallback(\n\t\t(e: React.MouseEvent | React.TouchEvent, direction: ResizeDirection) => {\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\n\t\t\tconst clientX = \"touches\" in e ? e.touches[0].clientX : e.clientX;\n\t\t\tconst clientY = \"touches\" in e ? e.touches[0].clientY : e.clientY;\n\n\t\t\tisResizingRef.current = true;\n\t\t\tsetIsResizing(true);\n\t\t\tsetActiveDirection(direction);\n\n\t\t\tstartRef.current = {\n\t\t\t\tx: clientX,\n\t\t\t\ty: clientY,\n\t\t\t\twidth: localState.width,\n\t\t\t\theight: localState.height,\n\t\t\t\tposX: localState.x,\n\t\t\t\tposY: localState.y,\n\t\t\t};\n\t\t},\n\t\t[localState],\n\t);\n\n\t// Calculate new dimensions based on direction\n\tconst calculateResize = useCallback(\n\t\t(deltaX: number, deltaY: number, direction: ResizeDirection) => {\n\t\t\tconst {\n\t\t\t\twidth: startWidth,\n\t\t\t\theight: startHeight,\n\t\t\t\tposX: startPosX,\n\t\t\t\tposY: startPosY,\n\t\t\t} = startRef.current;\n\n\t\t\tlet newWidth = startWidth;\n\t\t\tlet newHeight = startHeight;\n\t\t\tlet newX = startPosX;\n\t\t\tlet newY = startPosY;\n\n\t\t\t// Handle horizontal resizing\n\t\t\tif (direction.includes(\"e\")) {\n\t\t\t\t// Resize from right edge (width increases with mouse movement right)\n\t\t\t\tnewWidth = startWidth + deltaX;\n\t\t\t} else if (direction.includes(\"w\")) {\n\t\t\t\t// Resize from left edge (width increases with mouse movement left, position adjusts)\n\t\t\t\tnewWidth = startWidth - deltaX;\n\t\t\t\tnewX = startPosX + deltaX;\n\t\t\t}\n\n\t\t\t// Handle vertical resizing\n\t\t\tif (direction.includes(\"s\")) {\n\t\t\t\t// Resize from bottom edge (height increases with mouse movement down)\n\t\t\t\tnewHeight = startHeight + deltaY;\n\t\t\t} else if (direction.includes(\"n\")) {\n\t\t\t\t// Resize from top edge (height increases with mouse movement up, position adjusts)\n\t\t\t\tnewHeight = startHeight - deltaY;\n\t\t\t\tnewY = startPosY + deltaY;\n\t\t\t}\n\n\t\t\t// Apply constraints\n\t\t\tnewWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));\n\t\t\tnewHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));\n\n\t\t\t// Apply snap points (only to width for now)\n\t\t\tnewWidth = applySnap(newWidth);\n\n\t\t\t// If we hit min/max constraints, adjust position back\n\t\t\tif (direction.includes(\"w\")) {\n\t\t\t\tconst actualWidthChange = newWidth - startWidth;\n\t\t\t\tnewX = startPosX - actualWidthChange;\n\t\t\t}\n\t\t\tif (direction.includes(\"n\")) {\n\t\t\t\tconst actualHeightChange = newHeight - startHeight;\n\t\t\t\tnewY = startPosY - actualHeightChange;\n\t\t\t}\n\n\t\t\treturn { width: newWidth, height: newHeight, x: newX, y: newY };\n\t\t},\n\t\t[minWidth, maxWidth, minHeight, maxHeight, applySnap],\n\t);\n\n\t// Use refs for callbacks to prevent listener stacking (CRITICAL FIX)\n\tconst calculateResizeRef = useRef(calculateResize);\n\tconst onResizeRef = useRef(onResize);\n\tconst setPopoverWidthRef = useRef(setPopoverWidth);\n\tconst setPositionRef = useRef(setPosition);\n\tconst localStateRef = useRef(localState);\n\n\t// Keep refs up to date\n\tuseEffect(() => {\n\t\tcalculateResizeRef.current = calculateResize;\n\t\tonResizeRef.current = onResize;\n\t\tsetPopoverWidthRef.current = setPopoverWidth;\n\t\tsetPositionRef.current = setPosition;\n\t\tlocalStateRef.current = localState;\n\t});\n\n\t// Handle resize move\n\tuseEffect(() => {\n\t\tif (!(isResizing && activeDirection)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleMove = (e: MouseEvent | TouchEvent) => {\n\t\t\tif (!isResizingRef.current) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Cancel any pending animation frame\n\t\t\tif (animationFrameRef.current) {\n\t\t\t\tcancelAnimationFrame(animationFrameRef.current);\n\t\t\t}\n\n\t\t\t// Use requestAnimationFrame for smooth, performant updates\n\t\t\tanimationFrameRef.current = requestAnimationFrame(() => {\n\t\t\t\tconst clientX = \"touches\" in e ? e.touches[0].clientX : e.clientX;\n\t\t\t\tconst clientY = \"touches\" in e ? e.touches[0].clientY : e.clientY;\n\n\t\t\t\tconst deltaX = clientX - startRef.current.x;\n\t\t\t\tconst deltaY = clientY - startRef.current.y;\n\n\t\t\t\tconst newState = calculateResizeRef.current(\n\t\t\t\t\tdeltaX,\n\t\t\t\t\tdeltaY,\n\t\t\t\t\tactiveDirection,\n\t\t\t\t);\n\n\t\t\t\t// Update local state (no store update = fast)\n\t\t\t\tsetLocalState(newState);\n\t\t\t\tlocalStateRef.current = newState;\n\n\t\t\t\t// Trigger callback for other updates (like height state in parent)\n\t\t\t\tonResizeRef.current?.(\n\t\t\t\t\tnewState.width,\n\t\t\t\t\tnewState.height,\n\t\t\t\t\tnewState.x,\n\t\t\t\t\tnewState.y,\n\t\t\t\t);\n\t\t\t});\n\t\t};\n\n\t\tconst handleEnd = () => {\n\t\t\tif (!isResizingRef.current) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Cancel any pending animation frame\n\t\t\tif (animationFrameRef.current) {\n\t\t\t\tcancelAnimationFrame(animationFrameRef.current);\n\t\t\t}\n\n\t\t\t// Save to store once at the end (prevents lag during resize)\n\t\t\tconst currentState = localStateRef.current;\n\t\t\tsetPopoverWidthRef.current(currentState.width);\n\t\t\tsetPositionRef.current({ x: currentState.x, y: currentState.y });\n\n\t\t\tisResizingRef.current = false;\n\t\t\tsetIsResizing(false);\n\t\t\tsetActiveDirection(null);\n\t\t};\n\n\t\tdocument.addEventListener(\"mousemove\", handleMove);\n\t\tdocument.addEventListener(\"mouseup\", handleEnd);\n\t\tdocument.addEventListener(\"touchmove\", handleMove);\n\t\tdocument.addEventListener(\"touchend\", handleEnd);\n\n\t\treturn () => {\n\t\t\tdocument.removeEventListener(\"mousemove\", handleMove);\n\t\t\tdocument.removeEventListener(\"mouseup\", handleEnd);\n\t\t\tdocument.removeEventListener(\"touchmove\", handleMove);\n\t\t\tdocument.removeEventListener(\"touchend\", handleEnd);\n\n\t\t\t// Cleanup animation frame\n\t\t\tif (animationFrameRef.current) {\n\t\t\t\tcancelAnimationFrame(animationFrameRef.current);\n\t\t\t}\n\t\t};\n\t}, [isResizing, activeDirection]); //  Stable dependencies only\n\n\t// Create handle props for each direction\n\tconst createHandleProps = useCallback(\n\t\t(direction: ResizeDirection) => ({\n\t\t\tonMouseDown: (e: React.MouseEvent) => handleResizeStart(e, direction),\n\t\t\tonTouchStart: (e: React.TouchEvent) => handleResizeStart(e, direction),\n\t\t}),\n\t\t[handleResizeStart],\n\t);\n\n\treturn {\n\t\t// State - always use local state for instant updates\n\t\twidth: localState.width,\n\t\theight: localState.height,\n\t\tposition: { x: localState.x, y: localState.y },\n\t\tisResizing,\n\t\tactiveDirection,\n\n\t\t// Handle props generators\n\t\thandleNorth: createHandleProps(\"n\"),\n\t\thandleEast: createHandleProps(\"e\"),\n\t\thandleSouth: createHandleProps(\"s\"),\n\t\thandleWest: createHandleProps(\"w\"),\n\t\thandleNorthEast: createHandleProps(\"ne\"),\n\t\thandleSouthEast: createHandleProps(\"se\"),\n\t\thandleSouthWest: createHandleProps(\"sw\"),\n\t\thandleNorthWest: createHandleProps(\"nw\"),\n\t};\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;;CAgBC;;;;AAED;AACA;;;;AAcA,MAAM,sBAAsB;IAAC;IAAK;IAAK;IAAM;CAAK;AAClD,MAAM,oBAAoB;AAC1B,MAAM,oBAAoB;AAC1B,MAAM,qBAAqB;AAC3B,MAAM,qBAAqB;AAC3B,MAAM,yBAAyB;AAExB,SAAS,kBACf,eAAyC,EACzC,aAAqB,EACrB,UAAoC,CAAC,CAAC;;IAEtC,MAAM,EACL,WAAW,iBAAiB,EAC5B,WAAW,iBAAiB,EAC5B,YAAY,kBAAkB,EAC9B,YAAY,kBAAkB,EAC9B,aAAa,mBAAmB,EAChC,gBAAgB,sBAAsB,EACtC,QAAQ,EACR,GAAG;IAEJ,MAAM,QAAQ,IAAA,iMAAuB;4DAAC,CAAC,QAAU,MAAM,YAAY;;IACnE,MAAM,kBAAkB,IAAA,iMAAuB;sEAC9C,CAAC,QAAU,MAAM,eAAe;;IAEjC,MAAM,cAAc,IAAA,iMAAuB;kEAAC,CAAC,QAAU,MAAM,WAAW;;IAExE,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,gVAAQ,EAAC;IAC7C,MAAM,CAAC,iBAAiB,mBAAmB,GAC1C,IAAA,gVAAQ,EAAyB;IAElC,mEAAmE;IACnE,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,gVAAQ,EAAC;QAC5C;QACA,QAAQ;QACR,GAAG,gBAAgB,CAAC;QACpB,GAAG,gBAAgB,CAAC;IACrB;IAEA,MAAM,WAAW,IAAA,8UAAM,EAAC;QACvB,GAAG;QACH,GAAG;QACH,OAAO;QACP,QAAQ;QACR,MAAM;QACN,MAAM;IACP;IACA,MAAM,oBAAoB,IAAA,8UAAM,EAAgB;IAChD,MAAM,gBAAgB,IAAA,8UAAM,EAAC;IAE7B,sBAAsB;IACtB,MAAM,YAAY,IAAA,mVAAW;oDAC5B,CAAC;YACA,KAAK,MAAM,aAAa,WAAY;gBACnC,IAAI,KAAK,GAAG,CAAC,QAAQ,aAAa,eAAe;oBAChD,OAAO;gBACR;YACD;YACA,OAAO;QACR;mDACA;QAAC;QAAY;KAAc;IAG5B,gDAAgD;IAChD,IAAA,iVAAS;uCAAC;YACT,IAAI,CAAC,YAAY;gBAChB,cAAc;oBACb;oBACA,QAAQ;oBACR,GAAG,gBAAgB,CAAC;oBACpB,GAAG,gBAAgB,CAAC;gBACrB;YACD;QACD;sCAAG;QAAC;QAAO;QAAe;QAAiB;KAAW;IAEtD,sBAAsB;IACtB,MAAM,oBAAoB,IAAA,mVAAW;4DACpC,CAAC,GAAwC;YACxC,EAAE,cAAc;YAChB,EAAE,eAAe;YAEjB,MAAM,UAAU,aAAa,IAAI,EAAE,OAAO,CAAC,EAAE,CAAC,OAAO,GAAG,EAAE,OAAO;YACjE,MAAM,UAAU,aAAa,IAAI,EAAE,OAAO,CAAC,EAAE,CAAC,OAAO,GAAG,EAAE,OAAO;YAEjE,cAAc,OAAO,GAAG;YACxB,cAAc;YACd,mBAAmB;YAEnB,SAAS,OAAO,GAAG;gBAClB,GAAG;gBACH,GAAG;gBACH,OAAO,WAAW,KAAK;gBACvB,QAAQ,WAAW,MAAM;gBACzB,MAAM,WAAW,CAAC;gBAClB,MAAM,WAAW,CAAC;YACnB;QACD;2DACA;QAAC;KAAW;IAGb,8CAA8C;IAC9C,MAAM,kBAAkB,IAAA,mVAAW;0DAClC,CAAC,QAAgB,QAAgB;YAChC,MAAM,EACL,OAAO,UAAU,EACjB,QAAQ,WAAW,EACnB,MAAM,SAAS,EACf,MAAM,SAAS,EACf,GAAG,SAAS,OAAO;YAEpB,IAAI,WAAW;YACf,IAAI,YAAY;YAChB,IAAI,OAAO;YACX,IAAI,OAAO;YAEX,6BAA6B;YAC7B,IAAI,UAAU,QAAQ,CAAC,MAAM;gBAC5B,qEAAqE;gBACrE,WAAW,aAAa;YACzB,OAAO,IAAI,UAAU,QAAQ,CAAC,MAAM;gBACnC,qFAAqF;gBACrF,WAAW,aAAa;gBACxB,OAAO,YAAY;YACpB;YAEA,2BAA2B;YAC3B,IAAI,UAAU,QAAQ,CAAC,MAAM;gBAC5B,sEAAsE;gBACtE,YAAY,cAAc;YAC3B,OAAO,IAAI,UAAU,QAAQ,CAAC,MAAM;gBACnC,mFAAmF;gBACnF,YAAY,cAAc;gBAC1B,OAAO,YAAY;YACpB;YAEA,oBAAoB;YACpB,WAAW,KAAK,GAAG,CAAC,UAAU,KAAK,GAAG,CAAC,UAAU;YACjD,YAAY,KAAK,GAAG,CAAC,WAAW,KAAK,GAAG,CAAC,WAAW;YAEpD,4CAA4C;YAC5C,WAAW,UAAU;YAErB,sDAAsD;YACtD,IAAI,UAAU,QAAQ,CAAC,MAAM;gBAC5B,MAAM,oBAAoB,WAAW;gBACrC,OAAO,YAAY;YACpB;YACA,IAAI,UAAU,QAAQ,CAAC,MAAM;gBAC5B,MAAM,qBAAqB,YAAY;gBACvC,OAAO,YAAY;YACpB;YAEA,OAAO;gBAAE,OAAO;gBAAU,QAAQ;gBAAW,GAAG;gBAAM,GAAG;YAAK;QAC/D;yDACA;QAAC;QAAU;QAAU;QAAW;QAAW;KAAU;IAGtD,qEAAqE;IACrE,MAAM,qBAAqB,IAAA,8UAAM,EAAC;IAClC,MAAM,cAAc,IAAA,8UAAM,EAAC;IAC3B,MAAM,qBAAqB,IAAA,8UAAM,EAAC;IAClC,MAAM,iBAAiB,IAAA,8UAAM,EAAC;IAC9B,MAAM,gBAAgB,IAAA,8UAAM,EAAC;IAE7B,uBAAuB;IACvB,IAAA,iVAAS;uCAAC;YACT,mBAAmB,OAAO,GAAG;YAC7B,YAAY,OAAO,GAAG;YACtB,mBAAmB,OAAO,GAAG;YAC7B,eAAe,OAAO,GAAG;YACzB,cAAc,OAAO,GAAG;QACzB;;IAEA,qBAAqB;IACrB,IAAA,iVAAS;uCAAC;YACT,IAAI,CAAC,CAAC,cAAc,eAAe,GAAG;gBACrC;YACD;YAEA,MAAM;0DAAa,CAAC;oBACnB,IAAI,CAAC,cAAc,OAAO,EAAE;wBAC3B;oBACD;oBAEA,qCAAqC;oBACrC,IAAI,kBAAkB,OAAO,EAAE;wBAC9B,qBAAqB,kBAAkB,OAAO;oBAC/C;oBAEA,2DAA2D;oBAC3D,kBAAkB,OAAO,GAAG;kEAAsB;4BACjD,MAAM,UAAU,aAAa,IAAI,EAAE,OAAO,CAAC,EAAE,CAAC,OAAO,GAAG,EAAE,OAAO;4BACjE,MAAM,UAAU,aAAa,IAAI,EAAE,OAAO,CAAC,EAAE,CAAC,OAAO,GAAG,EAAE,OAAO;4BAEjE,MAAM,SAAS,UAAU,SAAS,OAAO,CAAC,CAAC;4BAC3C,MAAM,SAAS,UAAU,SAAS,OAAO,CAAC,CAAC;4BAE3C,MAAM,WAAW,mBAAmB,OAAO,CAC1C,QACA,QACA;4BAGD,8CAA8C;4BAC9C,cAAc;4BACd,cAAc,OAAO,GAAG;4BAExB,mEAAmE;4BACnE,YAAY,OAAO,GAClB,SAAS,KAAK,EACd,SAAS,MAAM,EACf,SAAS,CAAC,EACV,SAAS,CAAC;wBAEZ;;gBACD;;YAEA,MAAM;yDAAY;oBACjB,IAAI,CAAC,cAAc,OAAO,EAAE;wBAC3B;oBACD;oBAEA,qCAAqC;oBACrC,IAAI,kBAAkB,OAAO,EAAE;wBAC9B,qBAAqB,kBAAkB,OAAO;oBAC/C;oBAEA,6DAA6D;oBAC7D,MAAM,eAAe,cAAc,OAAO;oBAC1C,mBAAmB,OAAO,CAAC,aAAa,KAAK;oBAC7C,eAAe,OAAO,CAAC;wBAAE,GAAG,aAAa,CAAC;wBAAE,GAAG,aAAa,CAAC;oBAAC;oBAE9D,cAAc,OAAO,GAAG;oBACxB,cAAc;oBACd,mBAAmB;gBACpB;;YAEA,SAAS,gBAAgB,CAAC,aAAa;YACvC,SAAS,gBAAgB,CAAC,WAAW;YACrC,SAAS,gBAAgB,CAAC,aAAa;YACvC,SAAS,gBAAgB,CAAC,YAAY;YAEtC;+CAAO;oBACN,SAAS,mBAAmB,CAAC,aAAa;oBAC1C,SAAS,mBAAmB,CAAC,WAAW;oBACxC,SAAS,mBAAmB,CAAC,aAAa;oBAC1C,SAAS,mBAAmB,CAAC,YAAY;oBAEzC,0BAA0B;oBAC1B,IAAI,kBAAkB,OAAO,EAAE;wBAC9B,qBAAqB,kBAAkB,OAAO;oBAC/C;gBACD;;QACD;sCAAG;QAAC;QAAY;KAAgB,GAAG,6BAA6B;IAEhE,yCAAyC;IACzC,MAAM,oBAAoB,IAAA,mVAAW;4DACpC,CAAC,YAA+B,CAAC;gBAChC,WAAW;wEAAE,CAAC,IAAwB,kBAAkB,GAAG;;gBAC3D,YAAY;wEAAE,CAAC,IAAwB,kBAAkB,GAAG;;YAC7D,CAAC;2DACD;QAAC;KAAkB;IAGpB,OAAO;QACN,qDAAqD;QACrD,OAAO,WAAW,KAAK;QACvB,QAAQ,WAAW,MAAM;QACzB,UAAU;YAAE,GAAG,WAAW,CAAC;YAAE,GAAG,WAAW,CAAC;QAAC;QAC7C;QACA;QAEA,0BAA0B;QAC1B,aAAa,kBAAkB;QAC/B,YAAY,kBAAkB;QAC9B,aAAa,kBAAkB;QAC/B,YAAY,kBAAkB;QAC9B,iBAAiB,kBAAkB;QACnC,iBAAiB,kBAAkB;QACnC,iBAAiB,kBAAkB;QACnC,iBAAiB,kBAAkB;IACpC;AACD;GApRgB;;QAeD,iMAAuB;QACb,iMAAuB;QAG3B,iMAAuB"}},
    {"offset": {"line": 2276, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/stores/transcript-store.ts"],"sourcesContent":["/**\n * Transcript Store - Zustand State Management\n *\n * Manages live call transcript state including:\n * - Real-time transcript entries with speaker detection\n * - AI analysis status for each transcript segment\n * - Transcript search and export functionality\n * - Speaker identification and timestamp tracking\n *\n * Performance optimizations:\n * - Lightweight state management with Zustand\n * - No provider wrapper needed\n * - Selective subscriptions prevent unnecessary re-renders\n */\n\nimport { create } from \"zustand\";\nimport { devtools } from \"zustand/middleware\";\n\n// Transcript entry type\nexport type TranscriptEntry = {\n\tid: string;\n\tspeaker: \"csr\" | \"customer\";\n\ttext: string;\n\ttimestamp: number;\n\tisAnalyzing: boolean;\n\taiExtracted?: {\n\t\tcustomerInfo?: {\n\t\t\tname?: string;\n\t\t\temail?: string;\n\t\t\tphone?: string;\n\t\t\tcompany?: string;\n\t\t};\n\t\tissueCategories?: string[];\n\t\tactionItems?: string[];\n\t\tsentiment?: \"positive\" | \"neutral\" | \"negative\";\n\t\tconfidence?: number; // 0-100\n\t};\n};\n\n// Store state type\ntype TranscriptStore = {\n\t// State\n\tentries: TranscriptEntry[];\n\tisRecording: boolean;\n\tcurrentSpeaker: \"csr\" | \"customer\" | null;\n\tsearchQuery: string;\n\tfilteredEntries: TranscriptEntry[];\n\n\t// Actions\n\taddEntry: (\n\t\tentry: Omit<TranscriptEntry, \"id\" | \"timestamp\" | \"isAnalyzing\">,\n\t) => void;\n\tupdateEntry: (id: string, updates: Partial<TranscriptEntry>) => void;\n\tmarkAsAnalyzing: (id: string) => void;\n\tmarkAsAnalyzed: (\n\t\tid: string,\n\t\textracted: TranscriptEntry[\"aiExtracted\"],\n\t) => void;\n\tsetCurrentSpeaker: (speaker: \"csr\" | \"customer\" | null) => void;\n\tsetSearchQuery: (query: string) => void;\n\tstartRecording: () => void;\n\tstopRecording: () => void;\n\tclearTranscript: () => void;\n\texportTranscript: () => string;\n\tgetFullTranscript: () => string;\n};\n\n// Initial state\nconst initialState = {\n\tentries: [],\n\tisRecording: false,\n\tcurrentSpeaker: null,\n\tsearchQuery: \"\",\n\tfilteredEntries: [],\n};\n\n// Create store\nexport const useTranscriptStore = create<TranscriptStore>()(\n\tdevtools(\n\t\t(set, get) => ({\n\t\t\t...initialState,\n\n\t\t\taddEntry: (entry) => {\n\t\t\t\tconst newEntry: TranscriptEntry = {\n\t\t\t\t\t...entry,\n\t\t\t\t\tid: `transcript-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\tisAnalyzing: false,\n\t\t\t\t};\n\n\t\t\t\tset((state) => {\n\t\t\t\t\tconst entries = [...state.entries, newEntry];\n\t\t\t\t\treturn {\n\t\t\t\t\t\tentries,\n\t\t\t\t\t\tfilteredEntries: state.searchQuery\n\t\t\t\t\t\t\t? entries.filter((e) =>\n\t\t\t\t\t\t\t\t\te.text\n\t\t\t\t\t\t\t\t\t\t.toLowerCase()\n\t\t\t\t\t\t\t\t\t\t.includes(state.searchQuery.toLowerCase()),\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t: entries,\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t},\n\n\t\t\tupdateEntry: (id, updates) => {\n\t\t\t\tset((state) => {\n\t\t\t\t\tconst entries = state.entries.map((entry) =>\n\t\t\t\t\t\tentry.id === id ? { ...entry, ...updates } : entry,\n\t\t\t\t\t);\n\t\t\t\t\treturn {\n\t\t\t\t\t\tentries,\n\t\t\t\t\t\tfilteredEntries: state.searchQuery\n\t\t\t\t\t\t\t? entries.filter((e) =>\n\t\t\t\t\t\t\t\t\te.text\n\t\t\t\t\t\t\t\t\t\t.toLowerCase()\n\t\t\t\t\t\t\t\t\t\t.includes(state.searchQuery.toLowerCase()),\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t: entries,\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t},\n\n\t\t\tmarkAsAnalyzing: (id) => {\n\t\t\t\tget().updateEntry(id, { isAnalyzing: true });\n\t\t\t},\n\n\t\t\tmarkAsAnalyzed: (id, extracted) => {\n\t\t\t\tget().updateEntry(id, {\n\t\t\t\t\tisAnalyzing: false,\n\t\t\t\t\taiExtracted: extracted,\n\t\t\t\t});\n\t\t\t},\n\n\t\t\tsetCurrentSpeaker: (speaker) => set({ currentSpeaker: speaker }),\n\n\t\t\tsetSearchQuery: (query) => {\n\t\t\t\tset((state) => ({\n\t\t\t\t\tsearchQuery: query,\n\t\t\t\t\tfilteredEntries: query\n\t\t\t\t\t\t? state.entries.filter((e) =>\n\t\t\t\t\t\t\t\te.text.toLowerCase().includes(query.toLowerCase()),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t: state.entries,\n\t\t\t\t}));\n\t\t\t},\n\n\t\t\tstartRecording: () => set({ isRecording: true }),\n\n\t\t\tstopRecording: () => set({ isRecording: false }),\n\n\t\t\tclearTranscript: () => set(initialState),\n\n\t\t\texportTranscript: () => {\n\t\t\t\tconst { entries } = get();\n\t\t\t\treturn JSON.stringify(\n\t\t\t\t\tentries.map((e) => ({\n\t\t\t\t\t\tspeaker: e.speaker,\n\t\t\t\t\t\ttext: e.text,\n\t\t\t\t\t\ttimestamp: new Date(e.timestamp).toISOString(),\n\t\t\t\t\t\taiExtracted: e.aiExtracted,\n\t\t\t\t\t})),\n\t\t\t\t\tnull,\n\t\t\t\t\t2,\n\t\t\t\t);\n\t\t\t},\n\n\t\t\tgetFullTranscript: () => {\n\t\t\t\tconst { entries } = get();\n\t\t\t\treturn entries\n\t\t\t\t\t.map((e) => {\n\t\t\t\t\t\tconst time = new Date(e.timestamp).toLocaleTimeString();\n\t\t\t\t\t\tconst speaker = e.speaker === \"csr\" ? \"CSR\" : \"Customer\";\n\t\t\t\t\t\treturn `[${time}] ${speaker}: ${e.text}`;\n\t\t\t\t\t})\n\t\t\t\t\t.join(\"\\n\");\n\t\t\t},\n\t\t}),\n\t\t{ name: \"TranscriptStore\" },\n\t),\n);\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;CAaC;;;;AAED;AACA;;;AAmDA,gBAAgB;AAChB,MAAM,eAAe;IACpB,SAAS,EAAE;IACX,aAAa;IACb,gBAAgB;IAChB,aAAa;IACb,iBAAiB,EAAE;AACpB;AAGO,MAAM,qBAAqB,IAAA,+VAAM,IACvC,IAAA,sWAAQ,EACP,CAAC,KAAK,MAAQ,CAAC;QACd,GAAG,YAAY;QAEf,UAAU,CAAC;YACV,MAAM,WAA4B;gBACjC,GAAG,KAAK;gBACR,IAAI,CAAC,WAAW,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,MAAM,CAAC,GAAG,IAAI;gBACzE,WAAW,KAAK,GAAG;gBACnB,aAAa;YACd;YAEA,IAAI,CAAC;gBACJ,MAAM,UAAU;uBAAI,MAAM,OAAO;oBAAE;iBAAS;gBAC5C,OAAO;oBACN;oBACA,iBAAiB,MAAM,WAAW,GAC/B,QAAQ,MAAM,CAAC,CAAC,IAChB,EAAE,IAAI,CACJ,WAAW,GACX,QAAQ,CAAC,MAAM,WAAW,CAAC,WAAW,OAExC;gBACJ;YACD;QACD;QAEA,aAAa,CAAC,IAAI;YACjB,IAAI,CAAC;gBACJ,MAAM,UAAU,MAAM,OAAO,CAAC,GAAG,CAAC,CAAC,QAClC,MAAM,EAAE,KAAK,KAAK;wBAAE,GAAG,KAAK;wBAAE,GAAG,OAAO;oBAAC,IAAI;gBAE9C,OAAO;oBACN;oBACA,iBAAiB,MAAM,WAAW,GAC/B,QAAQ,MAAM,CAAC,CAAC,IAChB,EAAE,IAAI,CACJ,WAAW,GACX,QAAQ,CAAC,MAAM,WAAW,CAAC,WAAW,OAExC;gBACJ;YACD;QACD;QAEA,iBAAiB,CAAC;YACjB,MAAM,WAAW,CAAC,IAAI;gBAAE,aAAa;YAAK;QAC3C;QAEA,gBAAgB,CAAC,IAAI;YACpB,MAAM,WAAW,CAAC,IAAI;gBACrB,aAAa;gBACb,aAAa;YACd;QACD;QAEA,mBAAmB,CAAC,UAAY,IAAI;gBAAE,gBAAgB;YAAQ;QAE9D,gBAAgB,CAAC;YAChB,IAAI,CAAC,QAAU,CAAC;oBACf,aAAa;oBACb,iBAAiB,QACd,MAAM,OAAO,CAAC,MAAM,CAAC,CAAC,IACtB,EAAE,IAAI,CAAC,WAAW,GAAG,QAAQ,CAAC,MAAM,WAAW,OAE/C,MAAM,OAAO;gBACjB,CAAC;QACF;QAEA,gBAAgB,IAAM,IAAI;gBAAE,aAAa;YAAK;QAE9C,eAAe,IAAM,IAAI;gBAAE,aAAa;YAAM;QAE9C,iBAAiB,IAAM,IAAI;QAE3B,kBAAkB;YACjB,MAAM,EAAE,OAAO,EAAE,GAAG;YACpB,OAAO,KAAK,SAAS,CACpB,QAAQ,GAAG,CAAC,CAAC,IAAM,CAAC;oBACnB,SAAS,EAAE,OAAO;oBAClB,MAAM,EAAE,IAAI;oBACZ,WAAW,IAAI,KAAK,EAAE,SAAS,EAAE,WAAW;oBAC5C,aAAa,EAAE,WAAW;gBAC3B,CAAC,IACD,MACA;QAEF;QAEA,mBAAmB;YAClB,MAAM,EAAE,OAAO,EAAE,GAAG;YACpB,OAAO,QACL,GAAG,CAAC,CAAC;gBACL,MAAM,OAAO,IAAI,KAAK,EAAE,SAAS,EAAE,kBAAkB;gBACrD,MAAM,UAAU,EAAE,OAAO,KAAK,QAAQ,QAAQ;gBAC9C,OAAO,CAAC,CAAC,EAAE,KAAK,EAAE,EAAE,QAAQ,EAAE,EAAE,EAAE,IAAI,EAAE;YACzC,GACC,IAAI,CAAC;QACR;IACD,CAAC,GACD;IAAE,MAAM;AAAkB"}},
    {"offset": {"line": 2391, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/layout/incoming-call-notification.tsx"],"sourcesContent":["\"use client\";\n\n/**\n * Incoming Call Notification - Redesigned\n *\n * Complete redesign with dashboard layout, live transcript, and AI auto-fill\n *\n * Features:\n * - Resizable popover (420px - 1400px) with snap points\n * - Dashboard grid layout with customizable cards\n * - Live transcript panel with AI analysis\n * - AI auto-fill preview with one-click approval\n * - Improved visual design (better contrast, spacing, typography)\n * - Keyboard shortcuts\n * - Auto-save functionality\n *\n * Performance optimizations:\n * - Server Components where possible\n * - Lazy loading for heavy components\n * - Memoized card rendering\n * - Debounced auto-save\n */\n\n/**\n * PERFORMANCE FIX: Using dynamic icon imports from icon-registry\n * Reduces bundle size by ~200KB by lazy-loading icons\n */\nimport dynamic from \"next/dynamic\";\n\n// Dynamic icon imports - only load what's needed\nconst AlertCircle = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.AlertCircle),\n);\nconst AlertTriangle = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.AlertTriangle),\n);\nconst ArrowRightLeft = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.ArrowRightLeft),\n);\nconst Brain = dynamic(() => import(\"lucide-react\").then((mod) => mod.Brain));\nconst Building2 = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.Building2),\n);\nconst CheckCircle2 = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.CheckCircle2),\n);\nconst ChevronDown = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.ChevronDown),\n);\nconst ChevronUp = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.ChevronUp),\n);\nconst Clock = dynamic(() => import(\"lucide-react\").then((mod) => mod.Clock));\nconst FileText = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.FileText),\n);\nconst Hash = dynamic(() => import(\"lucide-react\").then((mod) => mod.Hash));\nconst HelpCircle = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.HelpCircle),\n);\nconst Maximize2 = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.Maximize2),\n);\nconst Mic = dynamic(() => import(\"lucide-react\").then((mod) => mod.Mic));\nconst MicOff = dynamic(() => import(\"lucide-react\").then((mod) => mod.MicOff));\nconst Minimize2 = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.Minimize2),\n);\nconst Pause = dynamic(() => import(\"lucide-react\").then((mod) => mod.Pause));\nconst Phone = dynamic(() => import(\"lucide-react\").then((mod) => mod.Phone));\nconst PhoneOff = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.PhoneOff),\n);\nconst Play = dynamic(() => import(\"lucide-react\").then((mod) => mod.Play));\nconst Settings = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.Settings),\n);\nconst Shield = dynamic(() => import(\"lucide-react\").then((mod) => mod.Shield));\nconst Square = dynamic(() => import(\"lucide-react\").then((mod) => mod.Square));\nconst SquareStack = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.SquareStack),\n);\nconst Tag = dynamic(() => import(\"lucide-react\").then((mod) => mod.Tag));\nconst User = dynamic(() => import(\"lucide-react\").then((mod) => mod.User));\nconst Video = dynamic(() => import(\"lucide-react\").then((mod) => mod.Video));\nconst VideoOff = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.VideoOff),\n);\nconst Voicemail = dynamic(() =>\n\timport(\"lucide-react\").then((mod) => mod.Voicemail),\n);\n\nimport { memo, useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport { CallIndicatorBadge } from \"@/components/call/call-indicator-badge\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\";\nimport { useCustomerLookup } from \"@/hooks/use-customer-lookup\";\n\n/**\n * PERFORMANCE FIX: Heavy components loaded dynamically (only when call is active)\n * - TransferCallModal: ~50KB\n * - AIAutofillPreview: ~30KB\n * - TranscriptPanel: ~40KB\n * - VideoConferenceView: ~100KB+\n * Total savings: ~220KB+ when no call is active\n */\nconst TransferCallModal = dynamic(\n\t() =>\n\t\timport(\"@/components/call/transfer-call-modal\").then((mod) => ({\n\t\t\tdefault: mod.TransferCallModal,\n\t\t})),\n\t{\n\t\tloading: () => null,\n\t},\n);\nconst AIAutofillPreview = dynamic(\n\t() =>\n\t\timport(\"@/components/communication/ai-autofill-preview\").then((mod) => ({\n\t\t\tdefault: mod.AIAutofillPreview,\n\t\t})),\n\t{\n\t\tloading: () => null,\n\t},\n);\nconst TranscriptPanel = dynamic(\n\t() =>\n\t\timport(\"@/components/communication/transcript-panel\").then((mod) => ({\n\t\t\tdefault: mod.TranscriptPanel,\n\t\t})),\n\t{\n\t\tloading: () => null,\n\t},\n);\nconst VideoConferenceView = dynamic(\n\t() =>\n\t\timport(\"./video-conference\").then((mod) => ({\n\t\t\tdefault: mod.VideoConferenceView,\n\t\t})),\n\t{\n\t\tloading: () => null,\n\t},\n);\n\nimport { startCallRecording, stopCallRecording } from \"@/actions/telnyx\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useCrossTabSync } from \"@/hooks/use-cross-tab-sync\";\nimport { useDraggablePosition } from \"@/hooks/use-draggable-position\";\nimport { usePopOutDrag } from \"@/hooks/use-pop-out-drag\";\nimport { useResizableMulti } from \"@/hooks/use-resizable-multi\";\nimport { useTelnyxWebRTC } from \"@/hooks/use-telnyx-webrtc\";\nimport { useUIStore } from \"@/lib/stores\";\nimport {\n\ttype CardType,\n\tuseCallPreferencesStore,\n} from \"@/lib/stores/call-preferences-store\";\nimport { useTranscriptStore } from \"@/lib/stores/transcript-store\";\nimport {\n\tfetchWebRTCCredentialsOnce,\n\tresetWebRTCCredentialsCache,\n} from \"@/lib/telnyx/web-credentials-client\";\nimport { cn } from \"@/lib/utils\";\n\ntype CallDisposition =\n\t| \"resolved\"\n\t| \"escalated\"\n\t| \"callback\"\n\t| \"voicemail\"\n\t| \"no_answer\"\n\t| \"\";\n\ntype CallerAIData = {\n\tisKnownCustomer: boolean;\n\tisSpam: boolean;\n\tspamConfidence: number;\n\trecognitionSource: \"crm\" | \"ai\" | \"community\" | \"manual\" | \"unknown\";\n\ttrustScore: number;\n\tcallHistory: Array<{ date: string; duration: string; outcome: string }>;\n\tsimilarCallers: number;\n\triskLevel: \"low\" | \"medium\" | \"high\";\n\taiNotes: string[];\n};\n\ntype CustomerData = {\n\tname: string;\n\temail: string;\n\tphone: string;\n\tcompany: string;\n\taccountStatus: string;\n\tlastContact: string;\n\ttotalCalls: number;\n\topenTickets: number;\n\tpriority: \"low\" | \"medium\" | \"high\";\n\ttags: string[];\n\trecentIssues: Array<{ id: string; text: string }>;\n\taiData: CallerAIData;\n};\n\n// AI Constants\nconst _AI_SPAM_THRESHOLD = 75;\nconst _AI_MAX_SCORE = 100;\nconst _AI_LOW_SPAM_SCORE = 15;\nconst AI_HIGH_TRUST_SCORE = 95;\nconst _AI_LOW_TRUST_SCORE = 20;\nconst AI_MEDIUM_TRUST_SCORE = 60;\nconst _AI_SPAM_SIMILAR_CALLERS = 47;\nconst AI_TRUST_HIGH_THRESHOLD = 80;\nconst AI_TRUST_MEDIUM_THRESHOLD = 50;\n\n// Helper functions\nconst getPriorityColorClass = (priority: \"low\" | \"medium\" | \"high\"): string => {\n\tif (priority === \"high\") {\n\t\treturn \"bg-destructive text-destructive-foreground\";\n\t}\n\tif (priority === \"medium\") {\n\t\treturn \"bg-warning text-warning-foreground dark:text-warning-foreground\";\n\t}\n\treturn \"bg-success text-success-foreground dark:text-success-foreground\";\n};\n\nconst getPriorityTextColorClass = (\n\tpriority: \"low\" | \"medium\" | \"high\",\n): string => {\n\tif (priority === \"high\") {\n\t\treturn \"text-destructive\";\n\t}\n\tif (priority === \"medium\") {\n\t\treturn \"text-warning\";\n\t}\n\treturn \"text-success\";\n};\n\nconst getTrustScoreColorClass = (score: number): string => {\n\tif (score >= AI_TRUST_HIGH_THRESHOLD) {\n\t\treturn \"bg-success\";\n\t}\n\tif (score >= AI_TRUST_MEDIUM_THRESHOLD) {\n\t\treturn \"bg-warning\";\n\t}\n\treturn \"bg-destructive\";\n};\n\nconst getRiskLevelColorClass = (\n\triskLevel: \"low\" | \"medium\" | \"high\",\n): string => {\n\tif (riskLevel === \"high\") {\n\t\treturn \"bg-destructive text-destructive\";\n\t}\n\tif (riskLevel === \"medium\") {\n\t\treturn \"bg-warning text-warning\";\n\t}\n\treturn \"bg-success text-success\";\n};\n\nconst _getVideoButtonClass = (\n\tvideoStatus: \"off\" | \"requesting\" | \"ringing\" | \"connected\" | \"declined\",\n): string => {\n\tif (videoStatus === \"connected\") {\n\t\treturn \"bg-primary hover:bg-primary/90 text-primary-foreground\";\n\t}\n\tif (videoStatus === \"requesting\" || videoStatus === \"ringing\") {\n\t\treturn \"animate-pulse bg-warning hover:bg-warning/90 text-warning-foreground dark:text-warning-foreground\";\n\t}\n\treturn \"bg-background hover:bg-accent text-muted-foreground\";\n};\n\n/**\n * useCustomerData Hook - MIGRATED TO REACT QUERY\n *\n * Now using useCustomerLookup from /lib/hooks/use-customer-lookup.ts\n * This provides automatic caching, refetching, and better performance.\n *\n * @deprecated Use useCustomerLookup instead\n */\nconst useCustomerData = (callerNumber?: string, companyId?: string) => {\n\tconst [customerData, setCustomerData] = useState<CustomerData | null>(null);\n\tconst [isLoading, setIsLoading] = useState(false);\n\n\tuseEffect(() => {\n\t\t// Cancellation token to prevent state updates after unmount\n\t\tlet cancelled = false;\n\n\t\tif (!(callerNumber && companyId)) {\n\t\t\t// Return default data for unknown callers\n\t\t\tsetCustomerData({\n\t\t\t\tname: \"Unknown Customer\",\n\t\t\t\temail: \"\",\n\t\t\t\tphone: callerNumber || \"Unknown\",\n\t\t\t\tcompany: \"\",\n\t\t\t\taccountStatus: \"Unknown\",\n\t\t\t\tlastContact: \"Never\",\n\t\t\t\ttotalCalls: 0,\n\t\t\t\topenTickets: 0,\n\t\t\t\tpriority: \"medium\",\n\t\t\t\ttags: [],\n\t\t\t\trecentIssues: [],\n\t\t\t\taiData: {\n\t\t\t\t\tisKnownCustomer: false,\n\t\t\t\t\tisSpam: false,\n\t\t\t\t\tspamConfidence: 0,\n\t\t\t\t\trecognitionSource: \"unknown\",\n\t\t\t\t\ttrustScore: AI_MEDIUM_TRUST_SCORE,\n\t\t\t\t\tcallHistory: [],\n\t\t\t\t\tsimilarCallers: 0,\n\t\t\t\t\triskLevel: \"medium\",\n\t\t\t\t\taiNotes: [\n\t\t\t\t\t\t\"First-time caller\",\n\t\t\t\t\t\t\"No prior history\",\n\t\t\t\t\t\t\"Standard verification recommended\",\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\tsetIsLoading(true);\n\n\t\t// Fetch real customer data from database\n\t\timport(\"@/actions/customers\")\n\t\t\t.then(({ getCustomerByPhone }) =>\n\t\t\t\tgetCustomerByPhone(callerNumber, companyId),\n\t\t\t)\n\t\t\t.then((result) => {\n\t\t\t\tif (cancelled) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (result.success && result.data) {\n\t\t\t\t\t// Don't update if unmounted\n\t\t\t\t\tconst customer = result.data;\n\n\t\t\t\t\t// Calculate AI metrics based on real customer data\n\t\t\t\t\tconst isKnown = true;\n\t\t\t\t\tconst randomSpamScore = 0; // Real spam detection would come from external service\n\t\t\t\t\tconst isSpam = false;\n\n\t\t\t\t\tif (cancelled) {\n\t\t\t\t\t\treturn; // Double-check before state update\n\t\t\t\t\t}\n\t\t\t\t\tsetCustomerData({\n\t\t\t\t\t\tname: `${customer.first_name} ${customer.last_name}`,\n\t\t\t\t\t\temail: customer.email || \"\",\n\t\t\t\t\t\tphone: customer.phone || callerNumber,\n\t\t\t\t\t\tcompany: customer.company_name || \"\",\n\t\t\t\t\t\taccountStatus: customer.status || \"Active\",\n\t\t\t\t\t\tlastContact: customer.last_contact_date\n\t\t\t\t\t\t\t? new Date(customer.last_contact_date).toLocaleDateString()\n\t\t\t\t\t\t\t: \"Unknown\",\n\t\t\t\t\t\ttotalCalls: customer.total_interactions || 0,\n\t\t\t\t\t\topenTickets: 0, // Would need to query jobs/tickets table\n\t\t\t\t\t\tpriority: (customer.priority_level || \"medium\") as\n\t\t\t\t\t\t\t| \"low\"\n\t\t\t\t\t\t\t| \"medium\"\n\t\t\t\t\t\t\t| \"high\",\n\t\t\t\t\t\ttags: customer.tags || [],\n\t\t\t\t\t\trecentIssues: [], // Would need to query jobs table\n\t\t\t\t\t\taiData: {\n\t\t\t\t\t\t\tisKnownCustomer: isKnown,\n\t\t\t\t\t\t\tisSpam,\n\t\t\t\t\t\t\tspamConfidence: randomSpamScore,\n\t\t\t\t\t\t\trecognitionSource: \"crm\",\n\t\t\t\t\t\t\ttrustScore: AI_HIGH_TRUST_SCORE,\n\t\t\t\t\t\t\tcallHistory: [], // Would need to query communications table\n\t\t\t\t\t\t\tsimilarCallers: 0,\n\t\t\t\t\t\t\triskLevel: \"low\",\n\t\t\t\t\t\t\taiNotes: [\n\t\t\t\t\t\t\t\t`Customer since ${customer.created_at ? new Date(customer.created_at).getFullYear() : \"Unknown\"}`,\n\t\t\t\t\t\t\t\t\"Verified customer\",\n\t\t\t\t\t\t\t\t\"Account in good standing\",\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\t// Customer not found - return default data\n\t\t\t\t\treturn; // Check before state update\n\t\t\t\t\tsetCustomerData({\n\t\t\t\t\t\tname: \"Unknown Customer\",\n\t\t\t\t\t\temail: \"\",\n\t\t\t\t\t\tphone: callerNumber || \"Unknown\",\n\t\t\t\t\t\tcompany: \"\",\n\t\t\t\t\t\taccountStatus: \"New\",\n\t\t\t\t\t\tlastContact: \"Never\",\n\t\t\t\t\t\ttotalCalls: 0,\n\t\t\t\t\t\topenTickets: 0,\n\t\t\t\t\t\tpriority: \"medium\",\n\t\t\t\t\t\ttags: [],\n\t\t\t\t\t\trecentIssues: [],\n\t\t\t\t\t\taiData: {\n\t\t\t\t\t\t\tisKnownCustomer: false,\n\t\t\t\t\t\t\tisSpam: false,\n\t\t\t\t\t\t\tspamConfidence: 0,\n\t\t\t\t\t\t\trecognitionSource: \"unknown\",\n\t\t\t\t\t\t\ttrustScore: AI_MEDIUM_TRUST_SCORE,\n\t\t\t\t\t\t\tcallHistory: [],\n\t\t\t\t\t\t\tsimilarCallers: 0,\n\t\t\t\t\t\t\triskLevel: \"medium\",\n\t\t\t\t\t\t\taiNotes: [\n\t\t\t\t\t\t\t\t\"First-time caller\",\n\t\t\t\t\t\t\t\t\"No prior history\",\n\t\t\t\t\t\t\t\t\"Standard verification recommended\",\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch((_error) => {\n\t\t\t\tif (cancelled) {\n\t\t\t\t\treturn; // Check before state update\n\t\t\t\t}\n\t\t\t\tsetCustomerData({\n\t\t\t\t\tname: \"Unknown Customer\",\n\t\t\t\t\temail: \"\",\n\t\t\t\t\tphone: callerNumber,\n\t\t\t\t\tcompany: \"\",\n\t\t\t\t\taccountStatus: \"Unknown\",\n\t\t\t\t\tlastContact: \"Never\",\n\t\t\t\t\ttotalCalls: 0,\n\t\t\t\t\topenTickets: 0,\n\t\t\t\t\tpriority: \"medium\",\n\t\t\t\t\ttags: [],\n\t\t\t\t\trecentIssues: [],\n\t\t\t\t\taiData: {\n\t\t\t\t\t\tisKnownCustomer: false,\n\t\t\t\t\t\tisSpam: false,\n\t\t\t\t\t\tspamConfidence: 0,\n\t\t\t\t\t\trecognitionSource: \"unknown\",\n\t\t\t\t\t\ttrustScore: AI_MEDIUM_TRUST_SCORE,\n\t\t\t\t\t\tcallHistory: [],\n\t\t\t\t\t\tsimilarCallers: 0,\n\t\t\t\t\t\triskLevel: \"medium\",\n\t\t\t\t\t\taiNotes: [\"Error loading customer data\"],\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t})\n\t\t\t.finally(() => {\n\t\t\t\tif (!cancelled) {\n\t\t\t\t\tsetIsLoading(false);\n\t\t\t\t}\n\t\t\t});\n\n\t\t// Cleanup function to prevent state updates after unmount\n\t\treturn () => {\n\t\t\tcancelled = true;\n\t\t};\n\t}, [callerNumber, companyId]);\n\n\treturn { customerData, isLoading };\n};\n\n// Incoming Call View - Redesigned with better performance and design\nconst IncomingCallView = memo(function IncomingCallView({\n\tcaller,\n\tcustomerData,\n\tonAnswer,\n\tonDecline,\n\tonVoicemail,\n}: {\n\tcaller: { name?: string; number: string; avatar?: string };\n\tcustomerData: CustomerData;\n\tonAnswer: () => void;\n\tonDecline: () => void;\n\tonVoicemail: () => void;\n}) {\n\tconst { aiData } = customerData;\n\n\t// Memoize expensive computations\n\tconst statusBanner = useMemo(() => {\n\t\tif (aiData.isSpam) {\n\t\t\treturn (\n\t\t\t\t<div className=\"border-destructive/50 bg-destructive/5 dark:bg-destructive/10 mb-4 flex items-center gap-2.5 rounded-lg border p-3 backdrop-blur-sm\">\n\t\t\t\t\t<AlertTriangle className=\"text-destructive size-4 shrink-0\" />\n\t\t\t\t\t<div className=\"min-w-0 flex-1\">\n\t\t\t\t\t\t<p className=\"text-destructive text-xs leading-tight font-semibold\">\n\t\t\t\t\t\t\tPotential Spam Detected\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<p className=\"text-destructive/70 dark:text-destructive/90 mt-0.5 text-[11px]\">\n\t\t\t\t\t\t\t{Math.round(aiData.spamConfidence)}% confidence {\" \"}\n\t\t\t\t\t\t\t{aiData.similarCallers} similar reports\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t);\n\t\t}\n\t\tif (aiData.isKnownCustomer) {\n\t\t\treturn (\n\t\t\t\t<div className=\"border-success/50 bg-success/5 dark:bg-success/10 mb-4 flex items-center gap-2.5 rounded-lg border p-3 backdrop-blur-sm\">\n\t\t\t\t\t<CheckCircle2 className=\"text-success size-4 shrink-0\" />\n\t\t\t\t\t<div className=\"min-w-0 flex-1\">\n\t\t\t\t\t\t<p className=\"text-success text-xs leading-tight font-semibold\">\n\t\t\t\t\t\t\tVerified Customer\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<p className=\"text-success/70 dark:text-success/90 mt-0.5 text-[11px]\">\n\t\t\t\t\t\t\tTrust score: {aiData.trustScore}% {\" \"}\n\t\t\t\t\t\t\t{aiData.recognitionSource.toUpperCase()}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t);\n\t\t}\n\t\treturn (\n\t\t\t<div className=\"border-warning/50 bg-warning/5 dark:bg-warning/10 mb-4 flex items-center gap-2.5 rounded-lg border p-3 backdrop-blur-sm\">\n\t\t\t\t<HelpCircle className=\"text-warning size-4 shrink-0\" />\n\t\t\t\t<div className=\"min-w-0 flex-1\">\n\t\t\t\t\t<p className=\"text-warning text-xs leading-tight font-semibold\">\n\t\t\t\t\t\tUnknown Caller\n\t\t\t\t\t</p>\n\t\t\t\t\t<p className=\"text-warning/70 dark:text-warning/90 mt-0.5 text-[11px]\">\n\t\t\t\t\t\tFirst-time caller  Verification recommended\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t);\n\t}, [\n\t\taiData.isSpam,\n\t\taiData.isKnownCustomer,\n\t\taiData.spamConfidence,\n\t\taiData.similarCallers,\n\t\taiData.trustScore,\n\t\taiData.recognitionSource,\n\t]);\n\n\tconst callerInitials = useMemo(\n\t\t() =>\n\t\t\tcaller.name\n\t\t\t\t?.split(\" \")\n\t\t\t\t.map((n) => n[0])\n\t\t\t\t.join(\"\")\n\t\t\t\t.toUpperCase() || \"?\",\n\t\t[caller.name],\n\t);\n\n\tconst tagsMemo = useMemo(\n\t\t() =>\n\t\t\tcustomerData.tags.map((tag) => (\n\t\t\t\t<Badge className=\"px-2 py-0.5 text-[10px]\" key={tag} variant=\"default\">\n\t\t\t\t\t{tag}\n\t\t\t\t</Badge>\n\t\t\t)),\n\t\t[customerData.tags],\n\t);\n\n\t// Memoize callbacks\n\tconst handleAnswer = useCallback(() => {\n\t\tonAnswer();\n\t}, [onAnswer]);\n\n\tconst handleDecline = useCallback(() => {\n\t\tonDecline();\n\t}, [onDecline]);\n\n\tconst handleVoicemail = useCallback(() => {\n\t\tonVoicemail();\n\t}, [onVoicemail]);\n\n\treturn (\n\t\t<div className=\"fade-in slide-in-from-bottom-4 animate-in fixed right-6 bottom-6 z-50 w-[420px] duration-300 ease-out\">\n\t\t\t<Card className=\"bg-card/95 dark:bg-card/95 border-2 shadow-2xl backdrop-blur-xl dark:shadow-2xl\">\n\t\t\t\t<CardHeader className=\"space-y-0 pb-4\">\n\t\t\t\t\t{statusBanner}\n\n\t\t\t\t\t<div className=\"flex items-start gap-4 pt-2\">\n\t\t\t\t\t\t<div className=\"relative\">\n\t\t\t\t\t\t\t<Avatar className=\"ring-primary/20 dark:ring-primary/30 size-20 shadow-lg ring-2\">\n\t\t\t\t\t\t\t\t<AvatarImage src={caller.avatar} />\n\t\t\t\t\t\t\t\t<AvatarFallback className=\"border-primary/20 from-primary/20 to-primary/10 text-foreground border-2 bg-gradient-to-br text-lg font-semibold\">\n\t\t\t\t\t\t\t\t\t{callerInitials}\n\t\t\t\t\t\t\t\t</AvatarFallback>\n\t\t\t\t\t\t\t</Avatar>\n\t\t\t\t\t\t\t{aiData.isKnownCustomer && (\n\t\t\t\t\t\t\t\t<div className=\"border-card bg-success absolute -right-1 -bottom-1 rounded-full border-2 p-1\">\n\t\t\t\t\t\t\t\t\t<Shield className=\"text-success-foreground size-3\" />\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div className=\"min-w-0 flex-1 pt-1\">\n\t\t\t\t\t\t\t<div className=\"mb-1 flex items-center gap-2\">\n\t\t\t\t\t\t\t\t<h3 className=\"text-foreground truncate text-lg leading-tight font-bold\">\n\t\t\t\t\t\t\t\t\t{caller.name || \"Unknown Caller\"}\n\t\t\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p className=\"text-muted-foreground mb-2 font-mono text-sm\">\n\t\t\t\t\t\t\t\t{caller.number}\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<div className=\"flex items-center gap-2\">\n\t\t\t\t\t\t\t\t<div className=\"bg-success shadow-success/50 size-2 animate-pulse rounded-full shadow-sm\" />\n\t\t\t\t\t\t\t\t<p className=\"text-muted-foreground text-xs font-medium\">\n\t\t\t\t\t\t\t\t\tIncoming call...\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</CardHeader>\n\n\t\t\t\t<CardContent className=\"space-y-4\">\n\t\t\t\t\t<Card className=\"bg-muted/30 dark:bg-muted/20 border-2 p-4\">\n\t\t\t\t\t\t<div className=\"mb-3 flex flex-wrap items-center gap-2\">\n\t\t\t\t\t\t\t{tagsMemo}\n\t\t\t\t\t\t\t<Badge\n\t\t\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\t\t\"px-2 py-0.5 text-[10px]\",\n\t\t\t\t\t\t\t\t\tgetPriorityColorClass(customerData.priority),\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\tvariant={\n\t\t\t\t\t\t\t\t\tcustomerData.priority === \"high\"\n\t\t\t\t\t\t\t\t\t\t? \"destructive\"\n\t\t\t\t\t\t\t\t\t\t: customerData.priority === \"medium\"\n\t\t\t\t\t\t\t\t\t\t\t? \"outline\"\n\t\t\t\t\t\t\t\t\t\t\t: \"secondary\"\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{customerData.priority.toUpperCase()}\n\t\t\t\t\t\t\t</Badge>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div className=\"space-y-2.5 text-xs\">\n\t\t\t\t\t\t\t<div className=\"text-muted-foreground flex items-center gap-2.5\">\n\t\t\t\t\t\t\t\t<Building2 className=\"size-4 shrink-0\" />\n\t\t\t\t\t\t\t\t<span className=\"truncate\">\n\t\t\t\t\t\t\t\t\t{customerData.company || \"No company\"}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div className=\"text-muted-foreground flex items-center gap-2.5\">\n\t\t\t\t\t\t\t\t<Clock className=\"size-4 shrink-0\" />\n\t\t\t\t\t\t\t\t<span>Last contact: {customerData.lastContact}</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div className=\"text-muted-foreground flex items-center gap-2.5\">\n\t\t\t\t\t\t\t\t<FileText className=\"size-4 shrink-0\" />\n\t\t\t\t\t\t\t\t<span>{customerData.openTickets} open tickets</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</Card>\n\n\t\t\t\t\t<div className=\"grid grid-cols-3 gap-3 pt-2\">\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tclassName=\"h-14 flex-col gap-1.5 rounded-xl font-semibold shadow-lg transition-all hover:scale-105 hover:shadow-xl active:scale-95\"\n\t\t\t\t\t\t\tonClick={handleDecline}\n\t\t\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t\t\tvariant=\"destructive\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<PhoneOff className=\"size-5\" />\n\t\t\t\t\t\t\t<span className=\"text-xs\">Decline</span>\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tclassName=\"h-14 flex-col gap-1.5 rounded-xl border-2 font-semibold shadow-lg transition-all hover:scale-105 hover:shadow-xl active:scale-95\"\n\t\t\t\t\t\t\tonClick={handleVoicemail}\n\t\t\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t\t\tvariant=\"outline\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Voicemail className=\"size-5\" />\n\t\t\t\t\t\t\t<span className=\"text-xs\">Voicemail</span>\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tclassName=\"bg-success text-success-foreground hover:bg-success/90 h-14 flex-col gap-1.5 rounded-xl font-semibold shadow-lg transition-all hover:scale-105 hover:shadow-xl active:scale-95\"\n\t\t\t\t\t\t\tonClick={handleAnswer}\n\t\t\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Phone className=\"size-5\" />\n\t\t\t\t\t\t\t<span className=\"text-xs\">Answer</span>\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</div>\n\t\t\t\t</CardContent>\n\t\t\t</Card>\n\t\t</div>\n\t);\n});\n\n// Enhanced Active Call Widget - Draggable with More Controls\nconst MinimizedCallWidget = memo(function MinimizedCallWidget({\n\tcaller,\n\tcallDuration,\n\tcall,\n\tonMaximize,\n\tonEndCall,\n\ttoggleMute,\n\ttoggleHold,\n\tsendDTMF,\n}: {\n\tcaller: { name?: string; number: string; avatar?: string };\n\tcallDuration: string;\n\tcall: { isMuted: boolean; isOnHold: boolean; isRecording: boolean };\n\tonMaximize: () => void;\n\tonEndCall: () => void;\n\ttoggleMute: () => void;\n\ttoggleHold?: () => void;\n\tsendDTMF?: (digit: string) => void;\n}) {\n\tconst [isExpanded, setIsExpanded] = useState(false);\n\tconst [showKeypad, setShowKeypad] = useState(false);\n\t// Fixed: Lazy initialization to prevent hydration mismatch\n\tconst [position, setPosition] = useState(() => {\n\t\tif (typeof window === \"undefined\") {\n\t\t\treturn { x: 0, y: 0 }; // Default for SSR\n\t\t}\n\t\treturn {\n\t\t\tx: window.innerWidth - 350,\n\t\t\ty: window.innerHeight - 150,\n\t\t};\n\t});\n\tconst [isDragging, setIsDragging] = useState(false);\n\n\t// Use refs to avoid dependency issues and prevent listener stacking\n\tconst dragOffsetRef = useRef({ x: 0, y: 0 });\n\n\t// Dragging handlers\n\tconst handleMouseDown = (e: React.MouseEvent) => {\n\t\tsetIsDragging(true);\n\t\tdragOffsetRef.current = {\n\t\t\tx: e.clientX - position.x,\n\t\t\ty: e.clientY - position.y,\n\t\t};\n\t};\n\n\tconst handleMouseMove = useCallback((e: MouseEvent) => {\n\t\tsetPosition({\n\t\t\tx: e.clientX - dragOffsetRef.current.x,\n\t\t\ty: e.clientY - dragOffsetRef.current.y,\n\t\t});\n\t}, []); //  No dependencies - uses ref\n\n\tconst handleMouseUp = useCallback(() => {\n\t\tsetIsDragging(false);\n\t}, []);\n\n\tuseEffect(() => {\n\t\tif (isDragging) {\n\t\t\twindow.addEventListener(\"mousemove\", handleMouseMove);\n\t\t\twindow.addEventListener(\"mouseup\", handleMouseUp);\n\t\t\treturn () => {\n\t\t\t\twindow.removeEventListener(\"mousemove\", handleMouseMove);\n\t\t\t\twindow.removeEventListener(\"mouseup\", handleMouseUp);\n\t\t\t};\n\t\t}\n\t}, [isDragging, handleMouseMove, handleMouseUp]); //  Stable callbacks\n\n\tconst keypadButtons = [\n\t\t[\"1\", \"2\", \"3\"],\n\t\t[\"4\", \"5\", \"6\"],\n\t\t[\"7\", \"8\", \"9\"],\n\t\t[\"*\", \"0\", \"#\"],\n\t];\n\n\treturn (\n\t\t<div\n\t\t\tclassName={cn(\n\t\t\t\t\"fade-in slide-in-from-bottom-2 animate-in fixed z-50 duration-300\",\n\t\t\t\tisDragging && \"cursor-grabbing\",\n\t\t\t)}\n\t\t\tstyle={{\n\t\t\t\tleft: `${position.x}px`,\n\t\t\t\ttop: `${position.y}px`,\n\t\t\t\twidth: isExpanded ? \"340px\" : \"320px\",\n\t\t\t}}\n\t\t>\n\t\t\t<div className=\"border-border bg-card rounded-xl border shadow-2xl dark:shadow-lg\">\n\t\t\t\t{/* Header - Draggable */}\n\t\t\t\t<div\n\t\t\t\t\tclassName=\"border-border bg-muted/50 dark:bg-muted/30 cursor-grab rounded-t-xl border-b px-4 py-3 active:cursor-grabbing\"\n\t\t\t\t\tonMouseDown={handleMouseDown}\n\t\t\t\t>\n\t\t\t\t\t<div className=\"flex items-center gap-3\">\n\t\t\t\t\t\t<Avatar className=\"ring-border dark:ring-border/50 size-10 ring-2\">\n\t\t\t\t\t\t\t<AvatarImage src={caller.avatar} />\n\t\t\t\t\t\t\t<AvatarFallback className=\"bg-muted text-muted-foreground text-xs\">\n\t\t\t\t\t\t\t\t{caller.name\n\t\t\t\t\t\t\t\t\t?.split(\" \")\n\t\t\t\t\t\t\t\t\t.map((n) => n[0])\n\t\t\t\t\t\t\t\t\t.join(\"\")\n\t\t\t\t\t\t\t\t\t.toUpperCase() || \"?\"}\n\t\t\t\t\t\t\t</AvatarFallback>\n\t\t\t\t\t\t</Avatar>\n\t\t\t\t\t\t<div className=\"flex-1 overflow-hidden\">\n\t\t\t\t\t\t\t<p className=\"text-foreground truncate text-sm font-medium\">\n\t\t\t\t\t\t\t\t{caller.name || \"Unknown\"}\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<div className=\"flex items-center gap-1.5\">\n\t\t\t\t\t\t\t\t<div className=\"bg-success size-1.5 animate-pulse rounded-full\" />\n\t\t\t\t\t\t\t\t<p className=\"text-muted-foreground font-mono text-[11px]\">\n\t\t\t\t\t\t\t\t\t{callDuration}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t{call.isRecording && (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t<span className=\"text-muted-foreground\"></span>\n\t\t\t\t\t\t\t\t\t\t<Square className=\"text-destructive size-2 fill-red-500\" />\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tclassName=\"bg-background hover:bg-accent flex size-7 items-center justify-center rounded-lg transition-colors active:scale-95\"\n\t\t\t\t\t\t\tonClick={() => setIsExpanded(!isExpanded)}\n\t\t\t\t\t\t\ttitle={isExpanded ? \"Collapse\" : \"Expand\"}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{isExpanded ? (\n\t\t\t\t\t\t\t\t<ChevronUp className=\"text-muted-foreground size-3.5\" />\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<ChevronDown className=\"text-muted-foreground size-3.5\" />\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Main Controls */}\n\t\t\t\t<div className=\"p-3\">\n\t\t\t\t\t<div className=\"grid grid-cols-5 gap-1.5\">\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\t\"flex flex-col items-center gap-1 rounded-lg p-2 transition-colors active:scale-95\",\n\t\t\t\t\t\t\t\tcall.isMuted\n\t\t\t\t\t\t\t\t\t? \"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n\t\t\t\t\t\t\t\t\t: \"bg-background text-muted-foreground hover:bg-accent\",\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\tonClick={toggleMute}\n\t\t\t\t\t\t\ttitle={call.isMuted ? \"Unmute\" : \"Mute\"}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{call.isMuted ? (\n\t\t\t\t\t\t\t\t<MicOff className=\"size-4\" />\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<Mic className=\"size-4\" />\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span className=\"text-[9px]\">\n\t\t\t\t\t\t\t\t{call.isMuted ? \"Unmute\" : \"Mute\"}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t{toggleHold && (\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\t\t\"flex flex-col items-center gap-1 rounded-lg p-2 transition-colors active:scale-95\",\n\t\t\t\t\t\t\t\t\tcall.isOnHold\n\t\t\t\t\t\t\t\t\t\t? \"bg-warning text-warning-foreground hover:bg-warning/90 dark:text-warning-foreground\"\n\t\t\t\t\t\t\t\t\t\t: \"bg-background text-muted-foreground hover:bg-accent\",\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\tonClick={toggleHold}\n\t\t\t\t\t\t\t\ttitle={call.isOnHold ? \"Resume\" : \"Hold\"}\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{call.isOnHold ? (\n\t\t\t\t\t\t\t\t\t<Play className=\"size-4\" />\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<Pause className=\"size-4\" />\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t<span className=\"text-[9px]\">\n\t\t\t\t\t\t\t\t\t{call.isOnHold ? \"Resume\" : \"Hold\"}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t{sendDTMF && (\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\t\t\"flex flex-col items-center gap-1 rounded-lg p-2 transition-colors active:scale-95\",\n\t\t\t\t\t\t\t\t\tshowKeypad\n\t\t\t\t\t\t\t\t\t\t? \"bg-primary text-primary-foreground hover:bg-primary/90\"\n\t\t\t\t\t\t\t\t\t\t: \"bg-background text-muted-foreground hover:bg-accent\",\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\tonClick={() => setShowKeypad(!showKeypad)}\n\t\t\t\t\t\t\t\ttitle=\"Keypad\"\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<Hash className=\"size-4\" />\n\t\t\t\t\t\t\t\t<span className=\"text-[9px]\">Keypad</span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tclassName=\"bg-background text-muted-foreground hover:bg-accent flex flex-col items-center gap-1 rounded-lg p-2 transition-colors active:scale-95\"\n\t\t\t\t\t\t\tonClick={onMaximize}\n\t\t\t\t\t\t\ttitle=\"Open Dashboard\"\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Maximize2 className=\"size-4\" />\n\t\t\t\t\t\t\t<span className=\"text-[9px]\">Open</span>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tclassName=\"bg-destructive text-destructive-foreground hover:bg-destructive/90 flex flex-col items-center gap-1 rounded-lg p-2 transition-colors active:scale-95\"\n\t\t\t\t\t\t\tonClick={onEndCall}\n\t\t\t\t\t\t\ttitle=\"End Call\"\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<PhoneOff className=\"size-4\" />\n\t\t\t\t\t\t\t<span className=\"text-[9px]\">End</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Expanded Controls */}\n\t\t\t\t{isExpanded && (\n\t\t\t\t\t<div className=\"border-border border-t p-3\">\n\t\t\t\t\t\t<div className=\"space-y-2\">\n\t\t\t\t\t\t\t<div className=\"flex items-center justify-between text-xs\">\n\t\t\t\t\t\t\t\t<span className=\"text-muted-foreground\">Caller Number</span>\n\t\t\t\t\t\t\t\t<span className=\"text-muted-foreground font-mono\">\n\t\t\t\t\t\t\t\t\t{caller.number}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div className=\"flex items-center justify-between text-xs\">\n\t\t\t\t\t\t\t\t<span className=\"text-muted-foreground\">Status</span>\n\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-1.5\">\n\t\t\t\t\t\t\t\t\t<div className=\"bg-success size-1.5 rounded-full\" />\n\t\t\t\t\t\t\t\t\t<span className=\"text-muted-foreground\">\n\t\t\t\t\t\t\t\t\t\t{call.isOnHold ? \"On Hold\" : \"Active\"}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{/* DTMF Keypad */}\n\t\t\t\t{showKeypad && sendDTMF && (\n\t\t\t\t\t<div className=\"border-border border-t p-3\">\n\t\t\t\t\t\t<div className=\"mb-2 text-center\">\n\t\t\t\t\t\t\t<p className=\"text-muted-foreground text-xs\">Dial Tones</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div className=\"grid grid-cols-3 gap-2\">\n\t\t\t\t\t\t\t{keypadButtons.flat().map((digit) => (\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\tclassName=\"border-border bg-background text-foreground hover:bg-accent flex size-12 items-center justify-center rounded-lg border font-mono text-lg transition-colors active:scale-95\"\n\t\t\t\t\t\t\t\t\tkey={digit}\n\t\t\t\t\t\t\t\t\tonClick={() => sendDTMF(digit)}\n\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{digit}\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t</div>\n\t);\n});\n\n// Dashboard Card Component\nconst DashboardCard = memo(function DashboardCard({\n\tid,\n\ttitle,\n\ticon,\n\tchildren,\n\tisCollapsed,\n\tonToggleCollapse,\n\tbadge,\n}: {\n\tid: CardType;\n\ttitle: string;\n\ticon: React.ReactNode;\n\tchildren: React.ReactNode;\n\tisCollapsed: boolean;\n\tonToggleCollapse: () => void;\n\tbadge?: React.ReactNode;\n}) {\n\treturn (\n\t\t<div className=\"border-border bg-card/50 dark:bg-card/80 overflow-hidden rounded-xl border shadow-sm backdrop-blur-sm\">\n\t\t\t<button\n\t\t\t\tclassName=\"bg-muted/50 hover:bg-muted/70 dark:bg-muted/30 dark:hover:bg-muted/50 flex w-full items-center justify-between px-5 py-3.5 text-left transition-colors active:scale-[0.98]\"\n\t\t\t\tonClick={onToggleCollapse}\n\t\t\t\ttype=\"button\"\n\t\t\t>\n\t\t\t\t<div className=\"flex items-center gap-2.5\">\n\t\t\t\t\t{icon}\n\t\t\t\t\t<span className=\"text-foreground text-sm font-semibold\">{title}</span>\n\t\t\t\t\t{badge}\n\t\t\t\t</div>\n\t\t\t\t{isCollapsed ? (\n\t\t\t\t\t<ChevronDown className=\"text-muted-foreground size-4\" />\n\t\t\t\t) : (\n\t\t\t\t\t<ChevronUp className=\"text-muted-foreground size-4\" />\n\t\t\t\t)}\n\t\t\t</button>\n\n\t\t\t{!isCollapsed && (\n\t\t\t\t<div className=\"border-border bg-card/30 dark:bg-card/50 border-t p-5\">\n\t\t\t\t\t{children}\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n});\n\n// Redesigned Active Call View with Dashboard Layout\nconst ActiveCallView = memo(function ActiveCallView({\n\tcall,\n\tcaller,\n\tcallDuration,\n\tcustomerData,\n\tcallNotes,\n\tsetCallNotes,\n\tdisposition,\n\tsetDisposition,\n\tonEndCall,\n\tonMinimize,\n\tonRequestVideo,\n\tonEndVideo,\n\tonTransfer,\n\ttoggleMute,\n\ttoggleHold,\n\ttoggleRecording,\n\tposition,\n\theight,\n\twidth,\n\tisDragging,\n\tisResizing,\n\thandleMouseDown,\n\thandleTouchStart,\n\tisPopOutZone,\n\tresizeHandles,\n}: {\n\tcall: {\n\t\tisMuted: boolean;\n\t\tisOnHold: boolean;\n\t\tisRecording: boolean;\n\t\tvideoStatus: \"off\" | \"requesting\" | \"ringing\" | \"connected\" | \"declined\";\n\t\tisLocalVideoEnabled: boolean;\n\t\tisRemoteVideoEnabled: boolean;\n\t};\n\tcaller: { name?: string; number: string; avatar?: string };\n\tcallDuration: string;\n\tcustomerData: CustomerData;\n\tcallNotes: string;\n\tsetCallNotes: (value: string) => void;\n\tdisposition: CallDisposition;\n\tsetDisposition: (value: CallDisposition) => void;\n\tonEndCall: () => void;\n\tonMinimize: () => void;\n\tonRequestVideo: () => void;\n\tonEndVideo: () => void;\n\tonTransfer: () => void;\n\ttoggleMute: () => void;\n\ttoggleHold: () => void;\n\ttoggleRecording: () => void;\n\tposition: { x: number; y: number };\n\theight: number;\n\twidth: number;\n\tisDragging: boolean;\n\tisResizing: boolean;\n\thandleMouseDown: (e: React.MouseEvent<HTMLElement>) => void;\n\thandleTouchStart: (e: React.TouchEvent<HTMLElement>) => void;\n\tisPopOutZone: boolean;\n\tresizeHandles: {\n\t\thandleNorth: {\n\t\t\tonMouseDown: (e: React.MouseEvent) => void;\n\t\t\tonTouchStart: (e: React.TouchEvent) => void;\n\t\t};\n\t\thandleEast: {\n\t\t\tonMouseDown: (e: React.MouseEvent) => void;\n\t\t\tonTouchStart: (e: React.TouchEvent) => void;\n\t\t};\n\t\thandleSouth: {\n\t\t\tonMouseDown: (e: React.MouseEvent) => void;\n\t\t\tonTouchStart: (e: React.TouchEvent) => void;\n\t\t};\n\t\thandleWest: {\n\t\t\tonMouseDown: (e: React.MouseEvent) => void;\n\t\t\tonTouchStart: (e: React.TouchEvent) => void;\n\t\t};\n\t\thandleNorthEast: {\n\t\t\tonMouseDown: (e: React.MouseEvent) => void;\n\t\t\tonTouchStart: (e: React.TouchEvent) => void;\n\t\t};\n\t\thandleSouthEast: {\n\t\t\tonMouseDown: (e: React.MouseEvent) => void;\n\t\t\tonTouchStart: (e: React.TouchEvent) => void;\n\t\t};\n\t\thandleSouthWest: {\n\t\t\tonMouseDown: (e: React.MouseEvent) => void;\n\t\t\tonTouchStart: (e: React.TouchEvent) => void;\n\t\t};\n\t\thandleNorthWest: {\n\t\t\tonMouseDown: (e: React.MouseEvent) => void;\n\t\t\tonTouchStart: (e: React.TouchEvent) => void;\n\t\t};\n\t};\n}) {\n\tconst cards = useCallPreferencesStore((state) => state.cards);\n\tconst toggleCard = useCallPreferencesStore((state) => state.toggleCard);\n\tconst layoutMode = useCallPreferencesStore((state) => state.layoutMode);\n\n\t// Get spacing based on layout mode\n\tconst spacing =\n\t\tlayoutMode === \"compact\"\n\t\t\t? \"gap-3\"\n\t\t\t: layoutMode === \"comfortable\"\n\t\t\t\t? \"gap-4\"\n\t\t\t\t: \"gap-5\";\n\tconst padding =\n\t\tlayoutMode === \"compact\"\n\t\t\t? \"p-4\"\n\t\t\t: layoutMode === \"comfortable\"\n\t\t\t\t? \"p-5\"\n\t\t\t\t: \"p-6\";\n\n\t// Get visible cards\n\tconst visibleCards = cards\n\t\t.filter((c) => c.isVisible)\n\t\t.sort((a, b) => a.order - b.order);\n\n\treturn (\n\t\t<div\n\t\t\tclassName={cn(\n\t\t\t\t\"fade-in slide-in-from-bottom-2 animate-in fixed z-50 duration-300\",\n\t\t\t\tisDragging && \"cursor-grabbing\",\n\t\t\t\tisPopOutZone && \"scale-95 opacity-50\",\n\t\t\t)}\n\t\t\tdata-draggable-container\n\t\t\tstyle={{\n\t\t\t\twidth: `${width}px`,\n\t\t\t\theight: `${height}px`,\n\t\t\t\tleft: `${position.x}px`,\n\t\t\t\ttop: `${position.y}px`,\n\t\t\t}}\n\t\t>\n\t\t\t{/* Pop-out zone indicator */}\n\t\t\t{isPopOutZone && (\n\t\t\t\t<div className=\"border-primary bg-primary/10 absolute inset-0 z-50 flex items-center justify-center rounded-2xl border-2 border-dashed backdrop-blur-sm\">\n\t\t\t\t\t<div className=\"text-center\">\n\t\t\t\t\t\t<SquareStack className=\"text-primary mx-auto mb-2 h-12 w-12\" />\n\t\t\t\t\t\t<p className=\"text-primary font-semibold\">Release to Pop Out</p>\n\t\t\t\t\t\t<p className=\"text-muted-foreground text-sm\">\n\t\t\t\t\t\t\tOpens call in separate window\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{/* Resize Handles - All 4 edges */}\n\t\t\t{/* North (top) */}\n\t\t\t<div\n\t\t\t\tclassName={cn(\n\t\t\t\t\t\"hover:bg-primary/20 absolute -top-1 right-0 left-0 h-2 cursor-ns-resize\",\n\t\t\t\t\tisResizing && \"bg-primary/30\",\n\t\t\t\t)}\n\t\t\t\t{...resizeHandles.handleNorth}\n\t\t\t/>\n\n\t\t\t{/* East (right) */}\n\t\t\t<div\n\t\t\t\tclassName={cn(\n\t\t\t\t\t\"hover:bg-primary/20 absolute top-0 -right-1 bottom-0 w-2 cursor-ew-resize\",\n\t\t\t\t\tisResizing && \"bg-primary/30\",\n\t\t\t\t)}\n\t\t\t\t{...resizeHandles.handleEast}\n\t\t\t/>\n\n\t\t\t{/* South (bottom) */}\n\t\t\t<div\n\t\t\t\tclassName={cn(\n\t\t\t\t\t\"hover:bg-primary/20 absolute right-0 -bottom-1 left-0 h-2 cursor-ns-resize\",\n\t\t\t\t\tisResizing && \"bg-primary/30\",\n\t\t\t\t)}\n\t\t\t\t{...resizeHandles.handleSouth}\n\t\t\t/>\n\n\t\t\t{/* West (left) */}\n\t\t\t<div\n\t\t\t\tclassName={cn(\n\t\t\t\t\t\"hover:bg-primary/20 absolute top-0 bottom-0 -left-1 w-2 cursor-ew-resize\",\n\t\t\t\t\tisResizing && \"bg-primary/30\",\n\t\t\t\t)}\n\t\t\t\t{...resizeHandles.handleWest}\n\t\t\t/>\n\n\t\t\t{/* Corner Handles */}\n\t\t\t{/* North-West (top-left) */}\n\t\t\t<div\n\t\t\t\tclassName={cn(\n\t\t\t\t\t\"hover:bg-primary/30 absolute -top-1 -left-1 h-4 w-4 cursor-nwse-resize rounded-tl-2xl\",\n\t\t\t\t\tisResizing && \"bg-primary/40\",\n\t\t\t\t)}\n\t\t\t\t{...resizeHandles.handleNorthWest}\n\t\t\t/>\n\n\t\t\t{/* North-East (top-right) */}\n\t\t\t<div\n\t\t\t\tclassName={cn(\n\t\t\t\t\t\"hover:bg-primary/30 absolute -top-1 -right-1 h-4 w-4 cursor-nesw-resize rounded-tr-2xl\",\n\t\t\t\t\tisResizing && \"bg-primary/40\",\n\t\t\t\t)}\n\t\t\t\t{...resizeHandles.handleNorthEast}\n\t\t\t/>\n\n\t\t\t{/* South-East (bottom-right) */}\n\t\t\t<div\n\t\t\t\tclassName={cn(\n\t\t\t\t\t\"hover:bg-primary/30 absolute -right-1 -bottom-1 h-4 w-4 cursor-nwse-resize rounded-br-2xl\",\n\t\t\t\t\tisResizing && \"bg-primary/40\",\n\t\t\t\t)}\n\t\t\t\t{...resizeHandles.handleSouthEast}\n\t\t\t/>\n\n\t\t\t{/* South-West (bottom-left) */}\n\t\t\t<div\n\t\t\t\tclassName={cn(\n\t\t\t\t\t\"hover:bg-primary/30 absolute -bottom-1 -left-1 h-4 w-4 cursor-nesw-resize rounded-bl-2xl\",\n\t\t\t\t\tisResizing && \"bg-primary/40\",\n\t\t\t\t)}\n\t\t\t\t{...resizeHandles.handleSouthWest}\n\t\t\t/>\n\n\t\t\t<div className=\"border-border bg-card flex h-full flex-col rounded-2xl border shadow-2xl dark:shadow-lg\">\n\t\t\t\t{/* Header - Better contrast and spacing with drag handle */}\n\t\t\t\t<div\n\t\t\t\t\tclassName=\"border-border bg-muted/50 dark:bg-muted/30 cursor-grab border-b p-6 active:cursor-grabbing\"\n\t\t\t\t\tdata-drag-handle\n\t\t\t\t\tonMouseDown={handleMouseDown}\n\t\t\t\t\tonTouchStart={handleTouchStart}\n\t\t\t\t>\n\t\t\t\t\t<div className=\"flex items-start justify-between\">\n\t\t\t\t\t\t<div className=\"flex items-center gap-4\">\n\t\t\t\t\t\t\t<Avatar className=\"ring-border dark:ring-border/50 size-14 ring-2\">\n\t\t\t\t\t\t\t\t<AvatarImage src={caller.avatar} />\n\t\t\t\t\t\t\t\t<AvatarFallback className=\"bg-muted text-muted-foreground\">\n\t\t\t\t\t\t\t\t\t{caller.name\n\t\t\t\t\t\t\t\t\t\t?.split(\" \")\n\t\t\t\t\t\t\t\t\t\t.map((n) => n[0])\n\t\t\t\t\t\t\t\t\t\t.join(\"\")\n\t\t\t\t\t\t\t\t\t\t.toUpperCase() || \"?\"}\n\t\t\t\t\t\t\t\t</AvatarFallback>\n\t\t\t\t\t\t\t</Avatar>\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-2\">\n\t\t\t\t\t\t\t\t\t<p className=\"text-foreground text-base font-semibold\">\n\t\t\t\t\t\t\t\t\t\t{caller.name || \"Unknown\"}\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t{customerData.priority === \"high\" && (\n\t\t\t\t\t\t\t\t\t\t<AlertCircle className=\"text-destructive size-4\" />\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<p className=\"text-muted-foreground text-sm\">{caller.number}</p>\n\t\t\t\t\t\t\t\t<div className=\"mt-1.5 flex items-center gap-2\">\n\t\t\t\t\t\t\t\t\t<div className=\"bg-success size-2 animate-pulse rounded-full\" />\n\t\t\t\t\t\t\t\t\t<p className=\"text-muted-foreground font-mono text-xs\">\n\t\t\t\t\t\t\t\t\t\t{callDuration}\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t{call.isRecording && (\n\t\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-muted-foreground\"></span>\n\t\t\t\t\t\t\t\t\t\t\t<Square className=\"text-destructive size-2.5 fill-red-500\" />\n\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-destructive text-xs\">REC</span>\n\t\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div className=\"flex gap-2\">\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tclassName=\"bg-background hover:bg-accent flex size-9 items-center justify-center rounded-lg transition-colors active:scale-95\"\n\t\t\t\t\t\t\t\tonClick={onMinimize}\n\t\t\t\t\t\t\t\ttitle=\"Minimize\"\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<Minimize2 className=\"text-muted-foreground size-4\" />\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tclassName=\"bg-background hover:bg-accent flex size-9 items-center justify-center rounded-lg transition-colors active:scale-95\"\n\t\t\t\t\t\t\t\ttitle=\"Settings\"\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<Settings className=\"text-muted-foreground size-4\" />\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/* Call Controls - Larger, more readable */}\n\t\t\t\t\t<div className=\"mt-5 grid grid-cols-6 gap-2.5\">\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\t\"flex flex-col items-center gap-1.5 rounded-lg p-3 transition-colors active:scale-95\",\n\t\t\t\t\t\t\t\tcall.isMuted\n\t\t\t\t\t\t\t\t\t? \"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n\t\t\t\t\t\t\t\t\t: \"bg-background text-muted-foreground hover:bg-accent\",\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\tonClick={toggleMute}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{call.isMuted ? (\n\t\t\t\t\t\t\t\t<MicOff className=\"size-5\" />\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<Mic className=\"size-5\" />\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span className=\"text-[10px]\">\n\t\t\t\t\t\t\t\t{call.isMuted ? \"Unmute\" : \"Mute\"}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\t\"flex flex-col items-center gap-1.5 rounded-lg p-3 transition-colors active:scale-95\",\n\t\t\t\t\t\t\t\tcall.isOnHold\n\t\t\t\t\t\t\t\t\t? \"bg-warning text-warning-foreground hover:bg-warning/90 dark:text-warning-foreground\"\n\t\t\t\t\t\t\t\t\t: \"bg-background text-muted-foreground hover:bg-accent\",\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\tonClick={toggleHold}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{call.isOnHold ? (\n\t\t\t\t\t\t\t\t<Play className=\"size-5\" />\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<Pause className=\"size-5\" />\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span className=\"text-[10px]\">\n\t\t\t\t\t\t\t\t{call.isOnHold ? \"Resume\" : \"Hold\"}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\t\"flex flex-col items-center gap-1.5 rounded-lg p-3 transition-colors active:scale-95\",\n\t\t\t\t\t\t\t\tcall.isRecording\n\t\t\t\t\t\t\t\t\t? \"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n\t\t\t\t\t\t\t\t\t: \"bg-background text-muted-foreground hover:bg-accent\",\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\tonClick={toggleRecording}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Square className=\"size-5\" />\n\t\t\t\t\t\t\t<span className=\"text-[10px]\">\n\t\t\t\t\t\t\t\t{call.isRecording ? \"Stop\" : \"Record\"}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tclassName=\"bg-background text-muted-foreground hover:bg-accent flex flex-col items-center gap-1.5 rounded-lg p-3 transition-colors active:scale-95\"\n\t\t\t\t\t\t\tonClick={onTransfer}\n\t\t\t\t\t\t\ttitle=\"Transfer Call\"\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<ArrowRightLeft className=\"size-5\" />\n\t\t\t\t\t\t\t<span className=\"text-[10px]\">Transfer</span>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\t\"flex flex-col items-center gap-1.5 rounded-lg p-3 transition-colors active:scale-95\",\n\t\t\t\t\t\t\t\tcall.videoStatus === \"connected\"\n\t\t\t\t\t\t\t\t\t? \"bg-primary text-primary-foreground hover:bg-primary/90\"\n\t\t\t\t\t\t\t\t\t: \"bg-background text-muted-foreground hover:bg-accent\",\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (call.videoStatus === \"off\") {\n\t\t\t\t\t\t\t\t\tonRequestVideo();\n\t\t\t\t\t\t\t\t} else if (call.videoStatus === \"connected\") {\n\t\t\t\t\t\t\t\t\tonEndVideo();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{call.videoStatus === \"connected\" ? (\n\t\t\t\t\t\t\t\t<Video className=\"size-5\" />\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<VideoOff className=\"size-5\" />\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<span className=\"text-[10px]\">Video</span>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tclassName=\"bg-destructive text-destructive-foreground hover:bg-destructive/90 flex flex-col items-center gap-1.5 rounded-lg p-3 transition-colors active:scale-95\"\n\t\t\t\t\t\t\tonClick={onEndCall}\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<PhoneOff className=\"size-5\" />\n\t\t\t\t\t\t\t<span className=\"text-[10px]\">End</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Dashboard Grid Content */}\n\t\t\t\t<div className={cn(\"flex-1 overflow-y-auto\", padding, spacing)}>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\"grid gap-4\",\n\t\t\t\t\t\t\twidth >= 1200 ? \"grid-cols-2\" : \"grid-cols-1\",\n\t\t\t\t\t\t)}\n\t\t\t\t\t>\n\t\t\t\t\t\t{visibleCards.map((card) => {\n\t\t\t\t\t\t\tswitch (card.id) {\n\t\t\t\t\t\t\t\tcase \"transcript\":\n\t\t\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t\t\t<DashboardCard\n\t\t\t\t\t\t\t\t\t\t\ticon={<FileText className=\"text-primary size-4\" />}\n\t\t\t\t\t\t\t\t\t\t\tid={card.id}\n\t\t\t\t\t\t\t\t\t\t\tisCollapsed={card.isCollapsed}\n\t\t\t\t\t\t\t\t\t\t\tkey={card.id}\n\t\t\t\t\t\t\t\t\t\t\tonToggleCollapse={() => toggleCard(card.id)}\n\t\t\t\t\t\t\t\t\t\t\ttitle=\"Live Transcript\"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"h-96\">\n\t\t\t\t\t\t\t\t\t\t\t\t<TranscriptPanel />\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</DashboardCard>\n\t\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\tcase \"ai-autofill\":\n\t\t\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t\t\t<DashboardCard\n\t\t\t\t\t\t\t\t\t\t\tbadge={\n\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"bg-accent text-accent-foreground rounded-full px-2 py-0.5 text-[9px]\">\n\t\t\t\t\t\t\t\t\t\t\t\t\tAI\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\ticon={<Brain className=\"text-accent-foreground size-4\" />}\n\t\t\t\t\t\t\t\t\t\t\tid={card.id}\n\t\t\t\t\t\t\t\t\t\t\tisCollapsed={card.isCollapsed}\n\t\t\t\t\t\t\t\t\t\t\tkey={card.id}\n\t\t\t\t\t\t\t\t\t\t\tonToggleCollapse={() => toggleCard(card.id)}\n\t\t\t\t\t\t\t\t\t\t\ttitle=\"AI Auto-fill\"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"h-96\">\n\t\t\t\t\t\t\t\t\t\t\t\t<AIAutofillPreview />\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</DashboardCard>\n\t\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\tcase \"customer-info\":\n\t\t\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t\t\t<DashboardCard\n\t\t\t\t\t\t\t\t\t\t\ticon={<User className=\"text-success size-4\" />}\n\t\t\t\t\t\t\t\t\t\t\tid={card.id}\n\t\t\t\t\t\t\t\t\t\t\tisCollapsed={card.isCollapsed}\n\t\t\t\t\t\t\t\t\t\t\tkey={card.id}\n\t\t\t\t\t\t\t\t\t\t\tonToggleCollapse={() => toggleCard(card.id)}\n\t\t\t\t\t\t\t\t\t\t\ttitle=\"Customer Information\"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"space-y-4\">\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"grid grid-cols-2 gap-4\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label className=\"text-muted-foreground mb-1.5 block text-xs font-medium\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEmail\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<p className=\"text-muted-foreground text-sm\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{customerData.email}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label className=\"text-muted-foreground mb-1.5 block text-xs font-medium\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tCompany\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<p className=\"text-muted-foreground text-sm\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{customerData.company}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label className=\"text-muted-foreground mb-1.5 block text-xs font-medium\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tStatus\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<p className=\"text-success text-sm\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{customerData.accountStatus}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label className=\"text-muted-foreground mb-1.5 block text-xs font-medium\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tPriority\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"text-sm\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgetPriorityTextColorClass(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcustomerData.priority,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{customerData.priority.charAt(0).toUpperCase() +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcustomerData.priority.slice(1)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label className=\"text-muted-foreground mb-1.5 block text-xs font-medium\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tTags\n\t\t\t\t\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex flex-wrap gap-2\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{customerData.tags.map((tag) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"bg-primary text-primary-foreground rounded-full px-3 py-1 text-xs\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{tag}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label className=\"text-muted-foreground mb-1.5 block text-xs font-medium\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tRecent Issues\n\t\t\t\t\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"space-y-1.5\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{customerData.recentIssues.map((issue) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<p\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"text-muted-foreground text-sm\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tkey={issue.id}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t {issue.text}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</DashboardCard>\n\t\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\tcase \"ai-analysis\":\n\t\t\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t\t\t<DashboardCard\n\t\t\t\t\t\t\t\t\t\t\tbadge={\n\t\t\t\t\t\t\t\t\t\t\t\tcustomerData.aiData.isKnownCustomer ? (\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"bg-success text-success-foreground dark:text-success-foreground rounded px-2 py-0.5 text-[9px]\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tVERIFIED\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t) : customerData.aiData.isSpam ? (\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"bg-destructive text-destructive-foreground rounded px-2 py-0.5 text-[9px]\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tSPAM\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t) : null\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\ticon={<Brain className=\"text-warning size-4\" />}\n\t\t\t\t\t\t\t\t\t\t\tid={card.id}\n\t\t\t\t\t\t\t\t\t\t\tisCollapsed={card.isCollapsed}\n\t\t\t\t\t\t\t\t\t\t\tkey={card.id}\n\t\t\t\t\t\t\t\t\t\t\tonToggleCollapse={() => toggleCard(card.id)}\n\t\t\t\t\t\t\t\t\t\t\ttitle=\"AI Analysis\"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"space-y-4\">\n\t\t\t\t\t\t\t\t\t\t\t\t{/* Trust Score */}\n\t\t\t\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"mb-2 flex items-center justify-between\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-muted-foreground text-xs font-medium\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTrust Score\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-foreground font-mono text-sm font-semibold\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{customerData.aiData.trustScore}%\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"bg-muted h-2 overflow-hidden rounded-full\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"h-full transition-all\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgetTrustScoreColorClass(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcustomerData.aiData.trustScore,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\twidth: `${customerData.aiData.trustScore}%`,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t\t\t\t{/* Risk Level */}\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-muted-foreground text-xs font-medium\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tRisk Level\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"rounded px-3 py-1 text-xs font-semibold\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgetRiskLevelColorClass(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcustomerData.aiData.riskLevel,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{customerData.aiData.riskLevel.toUpperCase()}\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t\t\t\t{/* AI Notes */}\n\t\t\t\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label className=\"text-muted-foreground mb-2 block text-xs font-medium\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tAI Insights\n\t\t\t\t\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"space-y-2\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{customerData.aiData.aiNotes.map((note, index) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"border-border bg-muted/50 dark:bg-muted/30 flex items-start gap-2.5 rounded-lg border p-3\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"bg-success mt-1 size-2 shrink-0 rounded-full\" />\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<p className=\"text-muted-foreground flex-1 text-sm leading-relaxed\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{note}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</DashboardCard>\n\t\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\tcase \"notes\":\n\t\t\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t\t\t<DashboardCard\n\t\t\t\t\t\t\t\t\t\t\ticon={\n\t\t\t\t\t\t\t\t\t\t\t\t<FileText className=\"text-muted-foreground size-4\" />\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\tid={card.id}\n\t\t\t\t\t\t\t\t\t\t\tisCollapsed={card.isCollapsed}\n\t\t\t\t\t\t\t\t\t\t\tkey={card.id}\n\t\t\t\t\t\t\t\t\t\t\tonToggleCollapse={() => toggleCard(card.id)}\n\t\t\t\t\t\t\t\t\t\t\ttitle=\"Call Notes\"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<Textarea\n\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"border-border bg-background text-foreground placeholder:text-muted-foreground min-h-32 text-sm\"\n\t\t\t\t\t\t\t\t\t\t\t\tonChange={(e) => setCallNotes(e.target.value)}\n\t\t\t\t\t\t\t\t\t\t\t\tplaceholder=\"Enter call notes and customer concerns...\"\n\t\t\t\t\t\t\t\t\t\t\t\tvalue={callNotes}\n\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t</DashboardCard>\n\t\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\tcase \"disposition\":\n\t\t\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t\t\t<DashboardCard\n\t\t\t\t\t\t\t\t\t\t\ticon={<Tag className=\"text-muted-foreground size-4\" />}\n\t\t\t\t\t\t\t\t\t\t\tid={card.id}\n\t\t\t\t\t\t\t\t\t\t\tisCollapsed={card.isCollapsed}\n\t\t\t\t\t\t\t\t\t\t\tkey={card.id}\n\t\t\t\t\t\t\t\t\t\t\tonToggleCollapse={() => toggleCard(card.id)}\n\t\t\t\t\t\t\t\t\t\t\ttitle=\"Call Disposition\"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"grid grid-cols-2 gap-3\">\n\t\t\t\t\t\t\t\t\t\t\t\t{[\n\t\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tvalue: \"resolved\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlabel: \"Resolved\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"green\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tvalue: \"escalated\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlabel: \"Escalated\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"red\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tvalue: \"callback\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlabel: \"Callback\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"amber\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tvalue: \"voicemail\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlabel: \"Voicemail\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"blue\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t].map((disp) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"rounded-lg border px-4 py-3 text-sm font-medium transition-colors active:scale-95\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdisposition === disp.value\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? disp.color === \"green\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? \"border-success bg-success text-success-foreground dark:text-success-foreground\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: disp.color === \"red\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? \"border-destructive bg-destructive text-destructive-foreground\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: disp.color === \"amber\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? \"border-warning bg-warning text-warning-foreground dark:text-warning-foreground\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: \"border-primary bg-primary text-primary-foreground\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: \"border-border bg-background text-muted-foreground hover:bg-accent\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tkey={disp.value}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tonClick={() =>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tsetDisposition(disp.value as CallDisposition)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{disp.label}\n\t\t\t\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</DashboardCard>\n\t\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\tcase \"quick-actions\":\n\t\t\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t\t\t<DashboardCard\n\t\t\t\t\t\t\t\t\t\t\ticon={\n\t\t\t\t\t\t\t\t\t\t\t\t<SquareStack className=\"text-muted-foreground size-4\" />\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\tid={card.id}\n\t\t\t\t\t\t\t\t\t\t\tisCollapsed={card.isCollapsed}\n\t\t\t\t\t\t\t\t\t\t\tkey={card.id}\n\t\t\t\t\t\t\t\t\t\t\tonToggleCollapse={() => toggleCard(card.id)}\n\t\t\t\t\t\t\t\t\t\t\ttitle=\"Quick Actions\"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"grid grid-cols-2 gap-2.5\">\n\t\t\t\t\t\t\t\t\t\t\t\t{[\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Check Balance\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Reset Password\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Open Ticket\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Send Email\",\n\t\t\t\t\t\t\t\t\t\t\t\t].map((action) => (\n\t\t\t\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"border-border bg-background text-foreground hover:bg-accent rounded-lg border px-4 py-3 text-sm transition-colors active:scale-95\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tkey={action}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{action}\n\t\t\t\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</DashboardCard>\n\t\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n});\n\n// Main Export Component\nexport function IncomingCallNotification() {\n\t// WebRTC credentials and state\n\tconst [webrtcCredentials, setWebrtcCredentials] = useState<{\n\t\tusername: string;\n\t\tpassword: string;\n\t} | null>(null);\n\tconst [_isLoadingCredentials, setIsLoadingCredentials] = useState(true);\n\n\t// Fetch WebRTC credentials on mount (shared cache across components)\n\tuseEffect(() => {\n\t\tlet cancelled = false;\n\n\t\tfetchWebRTCCredentialsOnce()\n\t\t\t.then((result) => {\n\t\t\t\tif (cancelled) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (result.success && result.credential) {\n\t\t\t\t\tsetWebrtcCredentials({\n\t\t\t\t\t\tusername: result.credential.username,\n\t\t\t\t\t\tpassword: result.credential.password,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(() => {\n\t\t\t\tif (!cancelled) {\n\t\t\t\t\tresetWebRTCCredentialsCache();\n\t\t\t\t}\n\t\t\t})\n\t\t\t.finally(() => {\n\t\t\t\tif (!cancelled) {\n\t\t\t\t\tsetIsLoadingCredentials(false);\n\t\t\t\t}\n\t\t\t});\n\n\t\treturn () => {\n\t\t\tcancelled = true;\n\t\t};\n\t}, []);\n\n\t// PERFORMANCE: Don't auto-connect WebRTC on every page load\n\t// This was hitting Telnyx 5-connection limit causing 2-8s timeouts!\n\t// WebRTC will connect ONLY when there's an actual incoming call or user initiates call\n\tconst webrtc = useTelnyxWebRTC({\n\t\tusername: webrtcCredentials?.username || \"\",\n\t\tpassword: webrtcCredentials?.password || \"\",\n\t\tautoConnect: false, // CHANGED: Don't connect until actually needed\n\t\tdisabled: !webrtcCredentials, // Don't even initialize hook without credentials\n\t\tdebug: process.env.NODE_ENV === \"development\",\n\t\tonIncomingCall: (_call) => {\n\t\t\t// The incoming call UI will show based on currentCall state\n\t\t},\n\t\tonCallEnded: (_call) => {\n\t\t\tclearTranscript();\n\t\t},\n\t});\n\n\t// Fallback to UI store for video features (not in WebRTC)\n\tconst { call: uiCall, requestVideo, endVideo } = useUIStore();\n\n\tconst [callDuration, setCallDuration] = useState(\"00:00\");\n\tconst [callNotes, setCallNotes] = useState(\"\");\n\tconst [disposition, setDisposition] = useState<CallDisposition>(\"\");\n\tconst [isMinimized, setIsMinimized] = useState(false);\n\tconst [showTransferModal, setShowTransferModal] = useState(false);\n\tconst [isRecording, setIsRecording] = useState(false);\n\n\t// Map WebRTC call state to UI format (real Telnyx calls only)\n\tconst call = webrtc.currentCall\n\t\t? {\n\t\t\t\tstatus:\n\t\t\t\t\twebrtc.currentCall.state === \"ringing\"\n\t\t\t\t\t\t? webrtc.currentCall.direction === \"inbound\"\n\t\t\t\t\t\t\t? (\"incoming\" as const)\n\t\t\t\t\t\t\t: (\"active\" as const)\n\t\t\t\t\t\t: webrtc.currentCall.state === \"active\"\n\t\t\t\t\t\t\t? (\"active\" as const)\n\t\t\t\t\t\t\t: webrtc.currentCall.state === \"ended\"\n\t\t\t\t\t\t\t\t? (\"ended\" as const)\n\t\t\t\t\t\t\t\t: (\"idle\" as const),\n\t\t\t\tcaller: {\n\t\t\t\t\tname: webrtc.currentCall.remoteName || \"Unknown Caller\",\n\t\t\t\t\tnumber: webrtc.currentCall.remoteNumber,\n\t\t\t\t},\n\t\t\t\tisMuted: webrtc.currentCall.isMuted,\n\t\t\t\tisOnHold: webrtc.currentCall.isHeld,\n\t\t\t\tisRecording, // Use server-side recording state\n\t\t\t\tstartTime: webrtc.currentCall.startTime?.getTime(),\n\t\t\t\tvideoStatus: uiCall.videoStatus || \"off\",\n\t\t\t\tisLocalVideoEnabled: uiCall.isLocalVideoEnabled,\n\t\t\t\tisRemoteVideoEnabled: uiCall.isRemoteVideoEnabled,\n\t\t\t\tisScreenSharing: false,\n\t\t\t\tconnectionQuality: \"excellent\" as const,\n\t\t\t\thasVirtualBackground: false,\n\t\t\t\treactions: [],\n\t\t\t\tchatMessages: [],\n\t\t\t\tparticipants: [],\n\t\t\t\tmeetingLink: \"\",\n\t\t\t}\n\t\t: {\n\t\t\t\tstatus: \"idle\" as const,\n\t\t\t\tcaller: null,\n\t\t\t\tisMuted: false,\n\t\t\t\tisOnHold: false,\n\t\t\t\tisRecording: false,\n\t\t\t\tstartTime: undefined,\n\t\t\t\tvideoStatus: \"off\" as const,\n\t\t\t\tisLocalVideoEnabled: false,\n\t\t\t\tisRemoteVideoEnabled: false,\n\t\t\t};\n\n\t// Cross-tab synchronization\n\tconst sync = useCrossTabSync();\n\n\t// Initialize transcript on call answer\n\tconst startRecording = useTranscriptStore((state) => state.startRecording);\n\tconst stopRecording = useTranscriptStore((state) => state.stopRecording);\n\tconst clearTranscript = useTranscriptStore((state) => state.clearTranscript);\n\tconst addEntry = useTranscriptStore((state) => state.addEntry);\n\n\t// Fetch company ID for current user\n\tconst [companyId, setCompanyId] = useState<string | null>(null);\n\tuseEffect(() => {\n\t\tasync function fetchCompanyId() {\n\t\t\tconst supabase = await import(\"@/lib/supabase/client\").then((m) =>\n\t\t\t\tm.createClient(),\n\t\t\t);\n\t\t\tif (!supabase) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst {\n\t\t\t\tdata: { user },\n\t\t\t} = await supabase.auth.getUser();\n\n\t\t\ttry {\n\t\t\t\tif (!user) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst { data, error } = await supabase\n\t\t\t\t\t.from(\"company_memberships\")\n\t\t\t\t\t.select(\"company_id\")\n\t\t\t\t\t.eq(\"user_id\", user.id)\n\t\t\t\t\t.eq(\"status\", \"active\")\n\t\t\t\t\t.order(\"updated_at\", { ascending: false })\n\t\t\t\t\t.limit(1);\n\n\t\t\t\tif (error) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst firstRow = Array.isArray(data) ? data[0] : data;\n\n\t\t\t\tif (firstRow?.company_id) {\n\t\t\t\t\tsetCompanyId(firstRow.company_id);\n\t\t\t\t}\n\t\t\t} catch (_error) {}\n\t\t}\n\t\tfetchCompanyId();\n\t}, []);\n\n\t// Fetch real customer data from database (React Query)\n\tconst { data: fetchedCustomerData, isLoading: isLoadingCustomer } =\n\t\tuseCustomerLookup(call.caller?.number, companyId || undefined);\n\n\t// Use fetched data or fallback to default\n\tconst customerData: CustomerData = fetchedCustomerData || {\n\t\tname: call.caller?.name || \"Unknown Customer\",\n\t\temail: \"\",\n\t\tphone: call.caller?.number || \"Unknown\",\n\t\tcompany: \"\",\n\t\taccountStatus: \"Unknown\",\n\t\tlastContact: \"Never\",\n\t\ttotalCalls: 0,\n\t\topenTickets: 0,\n\t\tpriority: \"medium\",\n\t\ttags: [],\n\t\trecentIssues: [],\n\t\taiData: {\n\t\t\tisKnownCustomer: false,\n\t\t\tisSpam: false,\n\t\t\tspamConfidence: 0,\n\t\t\trecognitionSource: \"unknown\",\n\t\t\ttrustScore: AI_MEDIUM_TRUST_SCORE,\n\t\t\tcallHistory: [],\n\t\t\tsimilarCallers: 0,\n\t\t\triskLevel: \"medium\",\n\t\t\taiNotes: [\"Loading customer data...\"],\n\t\t},\n\t};\n\n\t// Generate call ID from caller info\n\tconst callId = `call-${call.caller?.number || Date.now()}`;\n\n\t// Broadcast incoming call to other tabs\n\tuseEffect(() => {\n\t\tif (call.status === \"incoming\" && call.caller) {\n\t\t\tsync.broadcastIncomingCall(call.caller);\n\t\t}\n\t}, [call.status, call.caller, sync]);\n\n\t// Initial dimensions\n\tconst [currentHeight, setCurrentHeight] = useState(800);\n\n\t// Drag-to-move functionality\n\tconst dragHook = useDraggablePosition({\n\t\twidth: 900, // Will be synced with resizable width\n\t\theight: currentHeight,\n\t\tonBeyondBounds: (isBeyond) => {\n\t\t\thandleBeyondBounds(isBeyond);\n\t\t},\n\t});\n\n\t// Multi-directional resize functionality\n\tconst resizeHook = useResizableMulti(dragHook.position, currentHeight, {\n\t\tonResize: (_width, height, _x, _y) => {\n\t\t\tsetCurrentHeight(height);\n\t\t},\n\t});\n\n\t// Pop-out window functionality\n\tconst {\n\t\tisPopOutZone,\n\t\tisPopOutActive,\n\t\tpopOutWindow,\n\t\thandleBeyondBounds,\n\t\tcreatePopOut,\n\t\treturnToMain,\n\t\tfocusPopOut,\n\t} = usePopOutDrag({\n\t\tcallId,\n\t\tonPopOutCreated: () => {},\n\t\tonPopOutClosed: () => {},\n\t});\n\n\t// Handle creating pop-out when drag ends in pop-out zone\n\tuseEffect(() => {\n\t\tif (isPopOutZone && !dragHook.isDragging) {\n\t\t\tcreatePopOut();\n\t\t}\n\t}, [isPopOutZone, dragHook.isDragging, createPopOut]);\n\n\t// Mock transcript entries for demo\n\tuseEffect(() => {\n\t\tif (call.status === \"active\") {\n\t\t\tstartRecording();\n\n\t\t\t// Add demo transcript entries\n\t\t\tconst timer1 = setTimeout(() => {\n\t\t\t\taddEntry({\n\t\t\t\t\tspeaker: \"customer\",\n\t\t\t\t\ttext: \"Hi, I'm calling about my recent order. My name is John Smith and my email is john.smith@example.com\",\n\t\t\t\t});\n\t\t\t}, 2000);\n\n\t\t\tconst timer2 = setTimeout(() => {\n\t\t\t\taddEntry({\n\t\t\t\t\tspeaker: \"csr\",\n\t\t\t\t\ttext: \"Thank you for calling. I'll help you with that. Let me pull up your account.\",\n\t\t\t\t});\n\t\t\t}, 4000);\n\n\t\t\tconst timer3 = setTimeout(() => {\n\t\t\t\taddEntry({\n\t\t\t\t\tspeaker: \"customer\",\n\t\t\t\t\ttext: \"I haven't received my package yet and it's been 5 days. The tracking number shows it's still in processing.\",\n\t\t\t\t});\n\t\t\t}, 6000);\n\n\t\t\tconst timer4 = setTimeout(() => {\n\t\t\t\taddEntry({\n\t\t\t\t\tspeaker: \"csr\",\n\t\t\t\t\ttext: \"I understand your concern. Let me check on that for you right away. I'll follow up with the shipping department and send you an email update within 24 hours.\",\n\t\t\t\t});\n\t\t\t}, 8000);\n\n\t\t\treturn () => {\n\t\t\t\tclearTimeout(timer1);\n\t\t\t\tclearTimeout(timer2);\n\t\t\t\tclearTimeout(timer3);\n\t\t\t\tclearTimeout(timer4);\n\t\t\t};\n\t\t}\n\t\tif (call.status === \"ended\") {\n\t\t\t// Only stop recording when call actually ends\n\t\t\tstopRecording();\n\t\t}\n\t}, [\n\t\tcall.status,\n\t\taddEntry,\n\t\tstartRecording, // Only stop recording when call actually ends\n\t\tstopRecording,\n\t]); // Fixed: Only depend on call.status, functions should be stable\n\n\t// Call duration timer\n\tuseEffect(() => {\n\t\tif (call.status === \"active\" && call.startTime) {\n\t\t\tconst UPDATE_INTERVAL = 1000;\n\t\t\tconst SECONDS_PER_MINUTE = 60;\n\n\t\t\tconst interval = setInterval(() => {\n\t\t\t\tconst now = Date.now();\n\t\t\t\tconst duration = Math.floor(\n\t\t\t\t\t(now - (call.startTime || now)) / UPDATE_INTERVAL,\n\t\t\t\t);\n\t\t\t\tconst minutes = Math.floor(duration / SECONDS_PER_MINUTE);\n\t\t\t\tconst seconds = duration % SECONDS_PER_MINUTE;\n\t\t\t\tsetCallDuration(\n\t\t\t\t\t`${String(minutes).padStart(2, \"0\")}:${String(seconds).padStart(2, \"0\")}`,\n\t\t\t\t);\n\t\t\t}, UPDATE_INTERVAL);\n\n\t\t\treturn () => clearInterval(interval);\n\t\t}\n\t}, [call.status, call.startTime]);\n\n\tif (call.status === \"idle\" || call.status === \"ended\" || !call.caller) {\n\t\treturn null;\n\t}\n\n\t// Wrapped handlers that use WebRTC and broadcast to other tabs\n\tconst handleAnswerCall = async () => {\n\t\t// Real Telnyx call handling only\n\t\ttry {\n\t\t\tawait webrtc.answerCall();\n\t\t\tsync.broadcastCallAnswered();\n\n\t\t\t// Open call window in new tab when user accepts the call\n\t\t\tif (callId) {\n\t\t\t\tconst params = new URLSearchParams({\n\t\t\t\t\tcallId,\n\t\t\t\t\t...(companyId && { companyId }),\n\t\t\t\t\t...(call.caller?.number && { from: call.caller.number }),\n\t\t\t\t\tdirection: \"inbound\",\n\t\t\t\t});\n\n\t\t\t\tconst url = `/call?${params.toString()}`;\n\n\t\t\t\twindow.open(url, \"_blank\", \"noopener,noreferrer\");\n\t\t\t}\n\t\t} catch (_error) {}\n\t};\n\n\tconst handleEndCall = async () => {\n\t\t// Real Telnyx call handling only\n\t\tif (!webrtc.currentCall) {\n\t\t\tclearTranscript();\n\t\t\tsetIsRecording(false);\n\t\t\tsync.broadcastCallEnded();\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\tawait webrtc.endCall();\n\t\t\tclearTranscript();\n\t\t\tsetIsRecording(false); // Reset recording state\n\t\t\tsync.broadcastCallEnded();\n\t\t} catch (_error) {}\n\t};\n\n\tconst handleVoicemail = async () => {\n\t\tsetDisposition(\"voicemail\");\n\t\tif (!webrtc.currentCall) {\n\t\t\tclearTranscript();\n\t\t\tsync.broadcastCallEnded();\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\tawait webrtc.endCall();\n\t\t\tsync.broadcastCallEnded();\n\t\t} catch (_error) {}\n\t};\n\n\tconst handleToggleMute = async () => {\n\t\t// Real Telnyx call handling only\n\t\ttry {\n\t\t\tif (call.isMuted) {\n\t\t\t\tawait webrtc.unmuteCall();\n\t\t\t\tsync.broadcastCallAction(\"unmute\");\n\t\t\t} else {\n\t\t\t\tawait webrtc.muteCall();\n\t\t\t\tsync.broadcastCallAction(\"mute\");\n\t\t\t}\n\t\t} catch (_error) {}\n\t};\n\n\tconst handleToggleHold = async () => {\n\t\t// Real Telnyx call handling only\n\t\ttry {\n\t\t\tif (call.isOnHold) {\n\t\t\t\tawait webrtc.unholdCall();\n\t\t\t\tsync.broadcastCallAction(\"unhold\");\n\t\t\t} else {\n\t\t\t\tawait webrtc.holdCall();\n\t\t\t\tsync.broadcastCallAction(\"hold\");\n\t\t\t}\n\t\t} catch (_error) {}\n\t};\n\n\tconst handleToggleRecording = async () => {\n\t\tif (!webrtc.currentCall?.id) {\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tif (isRecording) {\n\t\t\t\tconst result = await stopCallRecording(webrtc.currentCall.id);\n\n\t\t\t\tif (result.success) {\n\t\t\t\t\tsetIsRecording(false);\n\t\t\t\t\tsync.broadcastCallAction(\"record_stop\");\n\t\t\t\t} else {\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconst result = await startCallRecording(webrtc.currentCall.id);\n\n\t\t\t\tif (result.success) {\n\t\t\t\t\tsetIsRecording(true);\n\t\t\t\t\tsync.broadcastCallAction(\"record_start\");\n\t\t\t\t} else {\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (_error) {}\n\t};\n\n\tconst handleSendDTMF = async (digit: string) => {\n\t\ttry {\n\t\t\tawait webrtc.sendDTMF(digit);\n\t\t} catch (_error) {}\n\t};\n\n\tconst handleTransfer = () => {\n\t\tsetShowTransferModal(true);\n\t};\n\n\tconst handleTransferSuccess = () => {\n\t\t// Call will end after successful transfer\n\t\tclearTranscript();\n\t\tsync.broadcastCallEnded();\n\t};\n\n\t// Show video conference view when video is active\n\tif (\n\t\tcall.status === \"active\" &&\n\t\t(call.videoStatus === \"requesting\" ||\n\t\t\tcall.videoStatus === \"ringing\" ||\n\t\t\tcall.videoStatus === \"connected\")\n\t) {\n\t\treturn (\n\t\t\t<VideoConferenceView\n\t\t\t\taddReaction={useUIStore.getState().addReaction}\n\t\t\t\tcall={call}\n\t\t\t\tcallDuration={callDuration}\n\t\t\t\tcaller={call.caller}\n\t\t\t\tonEndCall={handleEndCall}\n\t\t\t\tonEndVideo={endVideo}\n\t\t\t\tonToggleLocalVideo={useUIStore.getState().toggleLocalVideo}\n\t\t\t\tsendChatMessage={useUIStore.getState().sendChatMessage}\n\t\t\t\ttoggleMute={handleToggleMute}\n\t\t\t\ttoggleRecording={handleToggleRecording}\n\t\t\t\ttoggleScreenShare={useUIStore.getState().toggleScreenShare}\n\t\t\t\ttoggleVirtualBackground={useUIStore.getState().toggleVirtualBackground}\n\t\t\t/>\n\t\t);\n\t}\n\n\tif (call.status === \"incoming\") {\n\t\treturn (\n\t\t\t<IncomingCallView\n\t\t\t\tcaller={call.caller}\n\t\t\t\tcustomerData={customerData}\n\t\t\t\tonAnswer={handleAnswerCall}\n\t\t\t\tonDecline={handleEndCall}\n\t\t\t\tonVoicemail={handleVoicemail}\n\t\t\t/>\n\t\t);\n\t}\n\n\tif (isMinimized) {\n\t\treturn (\n\t\t\t<MinimizedCallWidget\n\t\t\t\tcall={call}\n\t\t\t\tcallDuration={callDuration}\n\t\t\t\tcaller={call.caller}\n\t\t\t\tonEndCall={handleEndCall}\n\t\t\t\tonMaximize={() => setIsMinimized(false)}\n\t\t\t\tsendDTMF={handleSendDTMF}\n\t\t\t\ttoggleHold={handleToggleHold}\n\t\t\t\ttoggleMute={handleToggleMute}\n\t\t\t/>\n\t\t);\n\t}\n\n\t// Show indicator badge when call is popped out\n\tif (isPopOutActive) {\n\t\treturn (\n\t\t\t<CallIndicatorBadge\n\t\t\t\tcallId={callId}\n\t\t\t\tcustomerName={call.caller?.name || \"Unknown Caller\"}\n\t\t\t\tcustomerPhone={call.caller?.number || \"\"}\n\t\t\t\tduration={Math.floor(\n\t\t\t\t\t(Date.now() - (call.startTime || Date.now())) / 1000,\n\t\t\t\t)}\n\t\t\t\tisActive={call.status === \"active\"}\n\t\t\t\tonFocusPopOut={focusPopOut}\n\t\t\t\tonReturnToMain={returnToMain}\n\t\t\t\tposition=\"bottom-right\"\n\t\t\t/>\n\t\t);\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<ActiveCallView\n\t\t\t\tcall={call}\n\t\t\t\tcallDuration={callDuration}\n\t\t\t\tcaller={call.caller}\n\t\t\t\tcallNotes={callNotes}\n\t\t\t\tcustomerData={customerData}\n\t\t\t\tdisposition={disposition}\n\t\t\t\thandleMouseDown={dragHook.handleMouseDown}\n\t\t\t\thandleTouchStart={dragHook.handleTouchStart}\n\t\t\t\theight={resizeHook.height}\n\t\t\t\tisDragging={dragHook.isDragging}\n\t\t\t\tisPopOutZone={isPopOutZone}\n\t\t\t\tisResizing={resizeHook.isResizing}\n\t\t\t\tonEndCall={handleEndCall}\n\t\t\t\tonEndVideo={endVideo}\n\t\t\t\tonMinimize={() => setIsMinimized(true)}\n\t\t\t\tonRequestVideo={requestVideo}\n\t\t\t\tonTransfer={handleTransfer}\n\t\t\t\tposition={resizeHook.position}\n\t\t\t\tresizeHandles={{\n\t\t\t\t\thandleNorth: resizeHook.handleNorth,\n\t\t\t\t\thandleEast: resizeHook.handleEast,\n\t\t\t\t\thandleSouth: resizeHook.handleSouth,\n\t\t\t\t\thandleWest: resizeHook.handleWest,\n\t\t\t\t\thandleNorthEast: resizeHook.handleNorthEast,\n\t\t\t\t\thandleSouthEast: resizeHook.handleSouthEast,\n\t\t\t\t\thandleSouthWest: resizeHook.handleSouthWest,\n\t\t\t\t\thandleNorthWest: resizeHook.handleNorthWest,\n\t\t\t\t}}\n\t\t\t\tsetCallNotes={setCallNotes}\n\t\t\t\tsetDisposition={setDisposition}\n\t\t\t\ttoggleHold={handleToggleHold}\n\t\t\t\ttoggleMute={handleToggleMute}\n\t\t\t\ttoggleRecording={handleToggleRecording}\n\t\t\t\twidth={resizeHook.width}\n\t\t\t/>\n\n\t\t\t<TransferCallModal\n\t\t\t\tcallControlId={webrtc.currentCall?.id || null}\n\t\t\t\tfromNumber={call.caller?.number || \"\"}\n\t\t\t\tonOpenChange={setShowTransferModal}\n\t\t\t\tonTransferSuccess={handleTransferSuccess}\n\t\t\t\topen={showTransferModal}\n\t\t\t/>\n\t\t</>\n\t);\n}\n"],"names":[],"mappings":"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"}}]
}