{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/database/src/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\";\nimport { cache } from \"react\";\n\n/**\n * Create a Supabase client for use in Server Components\n * This is useful for Supabase Auth, Storage, Realtime, etc.\n *\n * PERFORMANCE: Wrapped with React.cache() to prevent recreating\n * the client on every component render. This dramatically improves\n * performance by reusing the same client instance across the request.\n *\n * SESSION ISOLATION: This client uses default Supabase cookie names.\n * The admin app uses prefixed cookies (admin_*) to isolate its sessions.\n * This ensures admin and contractor sessions don't conflict.\n */\nexport const createClient = cache(async () => {\n\tconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n\tconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n\tif (!(supabaseUrl && supabaseAnonKey)) {\n\t\treturn null;\n\t}\n\n\t// Dynamic import of next/headers to prevent bundling in client components\n\tconst { cookies, headers } = await import(\"next/headers\");\n\n\tlet cookieStore;\n\n\t// Check if we're in a prerendering context by looking at headers\n\tlet headersStore;\n\ttry {\n\t\theadersStore = await headers();\n\t\t// If we can get headers and there's no x-prerender header, we might be safe\n\t\tif (headersStore.get(\"x-prerender\")) {\n\t\t\treturn null;\n\t\t}\n\t} catch {\n\t\t// If headers() fails, we're likely in prerendering\n\t\treturn null;\n\t}\n\n\ttry {\n\t\tcookieStore = await cookies();\n\t} catch (error) {\n\t\t// During prerendering, cookies() may reject - return null\n\t\t// This allows PPR to work correctly\n\t\tif (\n\t\t\terror instanceof Error &&\n\t\t\t(error.message.includes(\"During prerendering\") ||\n\t\t\t\terror.message.includes(\"prerendering\") ||\n\t\t\t\terror.message.includes(\"cookies()\"))\n\t\t) {\n\t\t\treturn null;\n\t\t}\n\t\t// For other errors, rethrow\n\t\tthrow error;\n\t}\n\n\treturn createServerClient(supabaseUrl, supabaseAnonKey, {\n\t\tcookies: {\n\t\t\tget(name: string) {\n\t\t\t\treturn cookieStore.get(name)?.value;\n\t\t\t},\n\t\t\tset(name: string, value: string, options) {\n\t\t\t\ttry {\n\t\t\t\t\tcookieStore.set(name, value, options);\n\t\t\t\t} catch {\n\t\t\t\t\t// The `set` method was called from a Server Component.\n\t\t\t\t\t// This can be ignored if you have middleware refreshing\n\t\t\t\t\t// user sessions.\n\t\t\t\t}\n\t\t\t},\n\t\t\tremove(name: string, _options) {\n\t\t\t\ttry {\n\t\t\t\t\tcookieStore.delete(name);\n\t\t\t\t} catch {\n\t\t\t\t\t// The `delete` method was called from a Server Component.\n\t\t\t\t\t// This can be ignored if you have middleware refreshing\n\t\t\t\t\t// user sessions.\n\t\t\t\t}\n\t\t\t},\n\t\t},\n\t});\n});\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAcO,MAAM,eAAe,IAAA,qXAAK,EAAC;IACjC,MAAM;IACN,MAAM;IAEN;;IAIA,0EAA0E;IAC1E,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,GAAG;IAE7B,IAAI;IAEJ,iEAAiE;IACjE,IAAI;IACJ,IAAI;QACH,eAAe,MAAM;QACrB,4EAA4E;QAC5E,IAAI,aAAa,GAAG,CAAC,gBAAgB;YACpC,OAAO;QACR;IACD,EAAE,OAAM;QACP,mDAAmD;QACnD,OAAO;IACR;IAEA,IAAI;QACH,cAAc,MAAM;IACrB,EAAE,OAAO,OAAO;QACf,0DAA0D;QAC1D,oCAAoC;QACpC,IACC,iBAAiB,SACjB,CAAC,MAAM,OAAO,CAAC,QAAQ,CAAC,0BACvB,MAAM,OAAO,CAAC,QAAQ,CAAC,mBACvB,MAAM,OAAO,CAAC,QAAQ,CAAC,YAAY,GACnC;YACD,OAAO;QACR;QACA,4BAA4B;QAC5B,MAAM;IACP;IAEA,OAAO,IAAA,4SAAkB,EAAC,aAAa,iBAAiB;QACvD,SAAS;YACR,KAAI,IAAY;gBACf,OAAO,YAAY,GAAG,CAAC,OAAO;YAC/B;YACA,KAAI,IAAY,EAAE,KAAa,EAAE,OAAO;gBACvC,IAAI;oBACH,YAAY,GAAG,CAAC,MAAM,OAAO;gBAC9B,EAAE,OAAM;gBACP,uDAAuD;gBACvD,wDAAwD;gBACxD,iBAAiB;gBAClB;YACD;YACA,QAAO,IAAY,EAAE,QAAQ;gBAC5B,IAAI;oBACH,YAAY,MAAM,CAAC;gBACpB,EAAE,OAAM;gBACP,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBAClB;YACD;QACD;IACD;AACD"}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/database/src/service-client.ts"],"sourcesContent":["\"use server\";\n\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\";\nimport type { Database } from \"./types\";\n\n/**\n * Creates a Supabase client using the service role key.\n * This bypasses RLS and is intended for background jobs / automation.\n *\n * Performance Optimization:\n * - Uses SUPABASE_POOLER_URL (Transaction Mode) if available for 30-50% faster queries\n * - Falls back to NEXT_PUBLIC_SUPABASE_URL (Session Mode) if pooler not configured\n * - Transaction Mode supports 10,000+ concurrent connections vs 100 in Session Mode\n *\n * @returns Supabase client with service role, or null if not configured\n */\nexport async function createServiceSupabaseClient() {\n\t// Prefer pooler URL for Transaction Mode (better performance)\n\t// WEB_SUPABASE_URL allows admin app to connect to web database for cross-app queries\n\tconst supabaseUrl =\n\t\tprocess.env.SUPABASE_POOLER_URL ||\n\t\tprocess.env.WEB_SUPABASE_URL ||\n\t\tprocess.env.NEXT_PUBLIC_SUPABASE_URL;\n\t// Support multiple env var names for flexibility across apps\n\tconst serviceRoleKey =\n\t\tprocess.env.SUPABASE_SERVICE_ROLE_KEY ||\n\t\tprocess.env.WEB_SUPABASE_SERVICE_ROLE_KEY ||\n\t\tprocess.env.ADMIN_SUPABASE_SERVICE_ROLE_KEY;\n\n\tif (!supabaseUrl || !serviceRoleKey) {\n\t\tconsole.error(\"[Service Client] Missing env vars:\", {\n\t\t\thasUrl: !!supabaseUrl,\n\t\t\thasKey: !!serviceRoleKey,\n\t\t});\n\t\treturn null;\n\t}\n\n\treturn createSupabaseClient<Database>(supabaseUrl, serviceRoleKey, {\n\t\tauth: {\n\t\t\tpersistSession: false,\n\t\t\tautoRefreshToken: false,\n\t\t},\n\t\tdb: {\n\t\t\tschema: \"public\",\n\t\t},\n\t\tglobal: {\n\t\t\theaders: {\n\t\t\t\t\"x-my-custom-header\": \"service-role\",\n\t\t\t},\n\t\t},\n\t});\n}\n\nexport type ServiceSupabaseClient = Awaited<\n\tReturnType<typeof createServiceSupabaseClient>\n>;\n"],"names":[],"mappings":";;;;;AAEA;;;;AAcO,eAAe;IACrB,8DAA8D;IAC9D,qFAAqF;IACrF,MAAM,cACL,QAAQ,GAAG,CAAC,mBAAmB,IAC/B,QAAQ,GAAG,CAAC,gBAAgB;IAE7B,6DAA6D;IAC7D,MAAM,iBACL,QAAQ,GAAG,CAAC,yBAAyB,IACrC,QAAQ,GAAG,CAAC,6BAA6B,IACzC,QAAQ,GAAG,CAAC,+BAA+B;IAE5C,IAAI,CAAC,eAAe,CAAC,gBAAgB;QACpC,QAAQ,KAAK,CAAC,sCAAsC;YACnD,QAAQ,CAAC,CAAC;YACV,QAAQ,CAAC,CAAC;QACX;QACA,OAAO;IACR;IAEA,OAAO,IAAA,iRAAoB,EAAW,aAAa,gBAAgB;QAClE,MAAM;YACL,gBAAgB;YAChB,kBAAkB;QACnB;QACA,IAAI;YACH,QAAQ;QACT;QACA,QAAQ;YACP,SAAS;gBACR,sBAAsB;YACvB;QACD;IACD;AACD;;;IAnCsB;;AAAA,sZAAA"}},
    {"offset": {"line": 120, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/shared/src/onboarding.ts"],"sourcesContent":["/**\n * Utilities for determining onboarding completion across server components\n * and API routes. Keeps the logic centralized so we can evolve the rules\n * (e.g. adding new steps) without hunting down scattered checks.\n */\n\ntype ProgressRecord = Record<string, unknown> | null | undefined;\n\n// Must match STEPS_ORDER from onboarding-store.ts\nconst REQUIRED_STEPS = [\"welcome\", \"company\"] as const;\nconst FINAL_STEP = \"complete\" as const;\n\n/**\n * Determine whether onboarding is complete based on stored progress metadata.\n *\n * Completion criteria (in priority order):\n * 1. `completedAt` timestamp exists (set by completeOnboardingWizard action)\n * 2. `onboardingCompleted` flag is true in progress data\n * 3. \"complete\" step exists in completedSteps array\n *\n * Note: We intentionally check multiple signals for backward compatibility\n * with older onboarding records that may have different data structures.\n */\nexport function isOnboardingComplete(options: {\n\tprogress?: ProgressRecord;\n\tcompletedAt?: string | null;\n}): boolean {\n\tconst { progress, completedAt } = options;\n\n\t// Primary check: completedAt timestamp from database\n\tif (completedAt) {\n\t\treturn true;\n\t}\n\n\tif (!progress || typeof progress !== \"object\") {\n\t\treturn false;\n\t}\n\n\tconst progressRecord = progress as Record<string, unknown>;\n\n\t// Check onboardingCompleted flag\n\tif (progressRecord.onboardingCompleted === true) {\n\t\treturn true;\n\t}\n\n\t// Check if completedSteps array includes the final step\n\tconst completedSteps = progressRecord.completedSteps;\n\tif (Array.isArray(completedSteps) && completedSteps.includes(FINAL_STEP)) {\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n/**\n * Get onboarding progress percentage based on completed steps.\n */\nexport function getOnboardingProgress(options: {\n\tprogress?: ProgressRecord;\n}): number {\n\tconst { progress } = options;\n\n\tif (!progress || typeof progress !== \"object\") {\n\t\treturn 0;\n\t}\n\n\tconst progressRecord = progress as Record<string, unknown>;\n\tconst completedSteps = progressRecord.completedSteps;\n\tconst skippedSteps = progressRecord.skippedSteps;\n\n\tif (!Array.isArray(completedSteps)) {\n\t\treturn 0;\n\t}\n\n\tconst totalSteps = 14; // Total steps in onboarding\n\tconst finishedCount =\n\t\tcompletedSteps.length +\n\t\t(Array.isArray(skippedSteps) ? skippedSteps.length : 0);\n\n\treturn Math.round((finishedCount / totalSteps) * 100);\n}\n\n/**\n * Check if required steps are completed.\n * Returns which required steps are missing if any.\n */\nexport function getMissingRequiredSteps(options: {\n\tprogress?: ProgressRecord;\n}): string[] {\n\tconst { progress } = options;\n\n\tif (!progress || typeof progress !== \"object\") {\n\t\treturn [...REQUIRED_STEPS];\n\t}\n\n\tconst progressRecord = progress as Record<string, unknown>;\n\tconst completedSteps = progressRecord.completedSteps;\n\n\tif (!Array.isArray(completedSteps)) {\n\t\treturn [...REQUIRED_STEPS];\n\t}\n\n\treturn REQUIRED_STEPS.filter((step) => !completedSteps.includes(step));\n}\n\n/**\n * Get the current onboarding step from progress data.\n */\nexport function getCurrentOnboardingStep(options: {\n\tprogress?: ProgressRecord;\n}): string {\n\tconst { progress } = options;\n\n\tif (!progress || typeof progress !== \"object\") {\n\t\treturn \"welcome\";\n\t}\n\n\tconst progressRecord = progress as Record<string, unknown>;\n\tconst currentStep = progressRecord.currentStep;\n\n\tif (typeof currentStep === \"string\" && currentStep.length > 0) {\n\t\treturn currentStep;\n\t}\n\n\treturn \"welcome\";\n}\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;;;;;;;AAID,kDAAkD;AAClD,MAAM,iBAAiB;IAAC;IAAW;CAAU;AAC7C,MAAM,aAAa;AAaZ,SAAS,qBAAqB,OAGpC;IACA,MAAM,EAAE,QAAQ,EAAE,WAAW,EAAE,GAAG;IAElC,qDAAqD;IACrD,IAAI,aAAa;QAChB,OAAO;IACR;IAEA,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC9C,OAAO;IACR;IAEA,MAAM,iBAAiB;IAEvB,iCAAiC;IACjC,IAAI,eAAe,mBAAmB,KAAK,MAAM;QAChD,OAAO;IACR;IAEA,wDAAwD;IACxD,MAAM,iBAAiB,eAAe,cAAc;IACpD,IAAI,MAAM,OAAO,CAAC,mBAAmB,eAAe,QAAQ,CAAC,aAAa;QACzE,OAAO;IACR;IAEA,OAAO;AACR;AAKO,SAAS,sBAAsB,OAErC;IACA,MAAM,EAAE,QAAQ,EAAE,GAAG;IAErB,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC9C,OAAO;IACR;IAEA,MAAM,iBAAiB;IACvB,MAAM,iBAAiB,eAAe,cAAc;IACpD,MAAM,eAAe,eAAe,YAAY;IAEhD,IAAI,CAAC,MAAM,OAAO,CAAC,iBAAiB;QACnC,OAAO;IACR;IAEA,MAAM,aAAa,IAAI,4BAA4B;IACnD,MAAM,gBACL,eAAe,MAAM,GACrB,CAAC,MAAM,OAAO,CAAC,gBAAgB,aAAa,MAAM,GAAG,CAAC;IAEvD,OAAO,KAAK,KAAK,CAAC,AAAC,gBAAgB,aAAc;AAClD;AAMO,SAAS,wBAAwB,OAEvC;IACA,MAAM,EAAE,QAAQ,EAAE,GAAG;IAErB,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC9C,OAAO;eAAI;SAAe;IAC3B;IAEA,MAAM,iBAAiB;IACvB,MAAM,iBAAiB,eAAe,cAAc;IAEpD,IAAI,CAAC,MAAM,OAAO,CAAC,iBAAiB;QACnC,OAAO;eAAI;SAAe;IAC3B;IAEA,OAAO,eAAe,MAAM,CAAC,CAAC,OAAS,CAAC,eAAe,QAAQ,CAAC;AACjE;AAKO,SAAS,yBAAyB,OAExC;IACA,MAAM,EAAE,QAAQ,EAAE,GAAG;IAErB,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC9C,OAAO;IACR;IAEA,MAAM,iBAAiB;IACvB,MAAM,cAAc,eAAe,WAAW;IAE9C,IAAI,OAAO,gBAAgB,YAAY,YAAY,MAAM,GAAG,GAAG;QAC9D,OAAO;IACR;IAEA,OAAO;AACR"}},
    {"offset": {"line": 208, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/auth/src/session.ts"],"sourcesContent":["/**\n * Session Management Utilities - Server Component Helpers\n *\n * Features:\n * - Get current authenticated user\n * - Get current session\n * - Require authentication (throw error if not authenticated)\n * - Check user permissions and roles\n * - Server Component compatible\n */\n\nimport { createClient } from \"@stratos/database/server\";\nimport type { Session, User } from \"@supabase/supabase-js\";\nimport { cache } from \"react\";\n\n/**\n * Get Current User - Cached for performance\n *\n * Returns the currently authenticated user or null if not authenticated.\n * Cached per request to avoid multiple database calls.\n *\n * SECURITY: Uses getUser() instead of getSession() to verify the session\n * is authentic by contacting the Supabase Auth server. Session data from\n * cookies cannot be trusted without server-side verification.\n */\nexport const getCurrentUser = cache(async (): Promise<User | null> => {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Use getUser() to authenticate with Supabase Auth server\n\t\t// This verifies the session is valid and not tampered with\n\t\tconst {\n\t\t\tdata: { user },\n\t\t\terror,\n\t\t} = await supabase.auth.getUser();\n\n\t\t// Handle error - could be AuthSessionMissingError or network error\n\t\tif (error) {\n\t\t\t// AuthSessionMissingError is expected when user is not authenticated\n\t\t\t// Don't log this as an error, just return null\n\t\t\tif (error.name === \"AuthSessionMissingError\") {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\n\t\treturn user;\n\t} catch (error) {\n\t\t// Catch any unexpected errors (network issues, etc.)\n\t\t// The error might be thrown instead of returned in some cases\n\t\tif (\n\t\t\terror &&\n\t\t\ttypeof error === \"object\" &&\n\t\t\t\"name\" in error &&\n\t\t\terror.name === \"AuthSessionMissingError\"\n\t\t) {\n\t\t\treturn null;\n\t\t}\n\t\treturn null;\n\t}\n});\n\n/**\n * Get Session - Cached for performance\n *\n * Returns the current session or null if not authenticated.\n * Cached per request to avoid multiple database calls.\n */\nconst getSession = cache(async (): Promise<Session | null> => {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { session },\n\t\t\terror,\n\t\t} = await supabase.auth.getSession();\n\n\t\tif (error) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn session;\n\t} catch (_error) {\n\t\treturn null;\n\t}\n});\n\n/**\n * Require User - Throw error if not authenticated\n *\n * Use this in Server Components or Server Actions that require authentication.\n * Will throw an error that can be caught by error boundaries.\n */\nexport async function requireUser(): Promise<User> {\n\tconst user = await getCurrentUser();\n\n\tif (!user) {\n\t\tthrow new Error(\"Authentication required. Please log in to continue.\");\n\t}\n\n\treturn user;\n}\n\n/**\n * Require Session - Throw error if no session\n *\n * Use this when you need both user and session data (e.g., access token).\n */\nasync function requireSession(): Promise<Session> {\n\tconst session = await getSession();\n\n\tif (!session) {\n\t\tthrow new Error(\"Active session required. Please log in to continue.\");\n\t}\n\n\treturn session;\n}\n\n/**\n * Check if user is authenticated\n *\n * Returns true if user is authenticated, false otherwise.\n * Useful for conditional rendering in Server Components.\n */\nasync function isAuthenticated(): Promise<boolean> {\n\tconst user = await getCurrentUser();\n\treturn user !== null;\n}\n\n/**\n * Get User Metadata\n *\n * Returns user metadata from Supabase Auth.\n * Useful for accessing additional user properties stored in auth.users.\n */\nasync function getUserMetadata<T = Record<string, any>>(): Promise<T | null> {\n\tconst user = await getCurrentUser();\n\n\tif (!user) {\n\t\treturn null;\n\t}\n\n\treturn (user.user_metadata as T) || null;\n}\n\n/**\n * Check User Email Verified\n *\n * Returns true if user's email is verified, false otherwise.\n */\nasync function isEmailVerified(): Promise<boolean> {\n\tconst user = await getCurrentUser();\n\n\tif (!user) {\n\t\treturn false;\n\t}\n\n\treturn user.email_confirmed_at !== undefined;\n}\n\n/**\n * Get User ID\n *\n * Returns the user's ID or null if not authenticated.\n * Convenient helper for getting just the user ID.\n */\nasync function getUserId(): Promise<string | null> {\n\tconst user = await getCurrentUser();\n\treturn user?.id || null;\n}\n\n/**\n * Get User Email\n *\n * Returns the user's email or null if not authenticated.\n */\nasync function getUserEmail(): Promise<string | null> {\n\tconst user = await getCurrentUser();\n\treturn user?.email || null;\n}\n\n/**\n * Get Access Token\n *\n * Returns the current access token for API calls.\n * Useful for calling external APIs that require authentication.\n */\nasync function getAccessToken(): Promise<string | null> {\n\tconst session = await getSession();\n\treturn session?.access_token || null;\n}\n\n/**\n * Refresh Session\n *\n * Manually refresh the session to get a new access token.\n * Usually not needed as Supabase handles this automatically.\n */\nasync function refreshSession(): Promise<Session | null> {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { session },\n\t\t\terror,\n\t\t} = await supabase.auth.refreshSession();\n\n\t\tif (error) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn session;\n\t} catch (_error) {\n\t\treturn null;\n\t}\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;CASC;;;;;;AAED;AAEA;;;AAYO,MAAM,iBAAiB,IAAA,qXAAK,EAAC;IACnC,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QAEnC,IAAI,CAAC,UAAU;YACd,OAAO;QACR;QAEA,0DAA0D;QAC1D,2DAA2D;QAC3D,MAAM,EACL,MAAM,EAAE,IAAI,EAAE,EACd,KAAK,EACL,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAE/B,mEAAmE;QACnE,IAAI,OAAO;YACV,qEAAqE;YACrE,+CAA+C;YAC/C,IAAI,MAAM,IAAI,KAAK,2BAA2B;gBAC7C,OAAO;YACR;YACA,OAAO;QACR;QAEA,OAAO;IACR,EAAE,OAAO,OAAO;QACf,qDAAqD;QACrD,8DAA8D;QAC9D,IACC,SACA,OAAO,UAAU,YACjB,UAAU,SACV,MAAM,IAAI,KAAK,2BACd;YACD,OAAO;QACR;QACA,OAAO;IACR;AACD;AAEA;;;;;CAKC,GACD,MAAM,aAAa,IAAA,qXAAK,EAAC;IACxB,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QAEnC,IAAI,CAAC,UAAU;YACd,OAAO;QACR;QAEA,MAAM,EACL,MAAM,EAAE,OAAO,EAAE,EACjB,KAAK,EACL,GAAG,MAAM,SAAS,IAAI,CAAC,UAAU;QAElC,IAAI,OAAO;YACV,OAAO;QACR;QAEA,OAAO;IACR,EAAE,OAAO,QAAQ;QAChB,OAAO;IACR;AACD;AAQO,eAAe;IACrB,MAAM,OAAO,MAAM;IAEnB,IAAI,CAAC,MAAM;QACV,MAAM,IAAI,MAAM;IACjB;IAEA,OAAO;AACR;AAEA;;;;CAIC,GACD,eAAe;IACd,MAAM,UAAU,MAAM;IAEtB,IAAI,CAAC,SAAS;QACb,MAAM,IAAI,MAAM;IACjB;IAEA,OAAO;AACR;AAEA;;;;;CAKC,GACD,eAAe;IACd,MAAM,OAAO,MAAM;IACnB,OAAO,SAAS;AACjB;AAEA;;;;;CAKC,GACD,eAAe;IACd,MAAM,OAAO,MAAM;IAEnB,IAAI,CAAC,MAAM;QACV,OAAO;IACR;IAEA,OAAO,AAAC,KAAK,aAAa,IAAU;AACrC;AAEA;;;;CAIC,GACD,eAAe;IACd,MAAM,OAAO,MAAM;IAEnB,IAAI,CAAC,MAAM;QACV,OAAO;IACR;IAEA,OAAO,KAAK,kBAAkB,KAAK;AACpC;AAEA;;;;;CAKC,GACD,eAAe;IACd,MAAM,OAAO,MAAM;IACnB,OAAO,MAAM,MAAM;AACpB;AAEA;;;;CAIC,GACD,eAAe;IACd,MAAM,OAAO,MAAM;IACnB,OAAO,MAAM,SAAS;AACvB;AAEA;;;;;CAKC,GACD,eAAe;IACd,MAAM,UAAU,MAAM;IACtB,OAAO,SAAS,gBAAgB;AACjC;AAEA;;;;;CAKC,GACD,eAAe;IACd,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QAEnC,IAAI,CAAC,UAAU;YACd,OAAO;QACR;QAEA,MAAM,EACL,MAAM,EAAE,OAAO,EAAE,EACjB,KAAK,EACL,GAAG,MAAM,SAAS,IAAI,CAAC,cAAc;QAEtC,IAAI,OAAO;YACV,OAAO;QACR;QAEA,OAAO;IACR,EAAE,OAAO,QAAQ;QAChB,OAAO;IACR;AACD"}},
    {"offset": {"line": 375, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/auth/src/company-context.ts"],"sourcesContent":["/**\n * Company Context Management\n *\n * Handles multi-tenancy by tracking and switching between companies\n * for users who may be members of multiple companies.\n *\n * Features:\n * - Active company stored in HTTP-only cookie\n * - Falls back to first available company\n * - Validates access before switching\n * - Server-side only (no client-side state)\n *\n * PERFORMANCE: All functions wrapped with React.cache() to prevent\n * redundant database queries across components in the same request.\n */\n\nimport { createClient } from \"@stratos/database/server\";\nimport { createServiceSupabaseClient } from \"@stratos/database/service-client\";\nimport { isOnboardingComplete } from \"@stratos/shared/onboarding\";\nimport { cache } from \"react\";\nimport { getCurrentUser } from \"./session\";\n\nconst ACTIVE_COMPANY_COOKIE = \"active_company_id\";\n\n/**\n * Company Info\n */\nexport type CompanyInfo = {\n\tid: string;\n\tname: string;\n\tlogo?: string | null;\n\tphone?: string | null;\n\temail?: string | null;\n};\n\n/**\n * Get Active Company ID\n *\n * Returns the currently active company for the user.\n * Falls back to first company if no active company is set.\n *\n * PERFORMANCE: Wrapped with React.cache() - called by every component,\n * but only executes once per request.\n *\n * @returns Company ID string or null if user has no companies\n */\nexport const getActiveCompanyId = cache(async (): Promise<string | null> => {\n\tconst { cookies } = await import(\"next/headers\");\n\tlet cookieStore;\n\ttry {\n\t\tcookieStore = await cookies();\n\t} catch (error) {\n\t\t// During prerendering, cookies() may reject - return null\n\t\t// This allows PPR to work correctly\n\t\tif (\n\t\t\terror instanceof Error &&\n\t\t\t(error.message.includes(\"During prerendering\") ||\n\t\t\t\terror.message.includes(\"prerendering\") ||\n\t\t\t\terror.message.includes(\"cookies()\"))\n\t\t) {\n\t\t\treturn null;\n\t\t}\n\t\tthrow error;\n\t}\n\tconst activeCompanyId = cookieStore.get(ACTIVE_COMPANY_COOKIE)?.value;\n\n\tif (activeCompanyId) {\n\t\t// Verify user still has access to this company\n\t\tconst hasAccess = await verifyCompanyAccess(activeCompanyId);\n\t\tif (hasAccess) {\n\t\t\treturn activeCompanyId;\n\t\t}\n\t}\n\n\t// Fall back to first available company\n\tconst companies = await getUserCompanies();\n\treturn companies[0]?.id || null;\n});\n\n/**\n * Get Active Company Info\n *\n * Returns the full company object for the active company.\n *\n * PERFORMANCE: Wrapped with React.cache() - called by multiple components,\n * but only executes once per request.\n *\n * @returns CompanyInfo object or null\n */\nexport const getActiveCompany = cache(async (): Promise<CompanyInfo | null> => {\n\tconst companyId = await getActiveCompanyId();\n\tif (!companyId) {\n\t\treturn null;\n\t}\n\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\treturn null;\n\t}\n\n\tconst { data: company } = await supabase\n\t\t.from(\"companies\")\n\t\t.select(\"id, name, logo, phone, email\")\n\t\t.eq(\"id\", companyId)\n\t\t.is(\"deleted_at\", null) // Exclude archived companies\n\t\t.single();\n\n\treturn company;\n});\n\n/**\n * Set Active Company\n *\n * Switches the user's active company context.\n * Validates access before switching.\n *\n * @param companyId - Company ID to switch to\n * @throws Error if user doesn't have access to this company\n */\nexport async function setActiveCompany(companyId: string): Promise<void> {\n\t// Verify access before switching\n\tconst hasAccess = await verifyCompanyAccess(companyId);\n\n\tif (!hasAccess) {\n\t\tthrow new Error(\"You don't have access to this company\");\n\t}\n\n\tconst { cookies } = await import(\"next/headers\");\n\tconst cookieStore = await cookies();\n\tcookieStore.set(ACTIVE_COMPANY_COOKIE, companyId, {\n\t\thttpOnly: true,\n\t\tsecure: process.env.NODE_ENV === \"production\",\n\t\tsameSite: \"lax\",\n\t\tmaxAge: 60 * 60 * 24 * 30, // 30 days\n\t\tpath: \"/\",\n\t});\n}\n\n/**\n * Clear Active Company\n *\n * Removes the active company cookie.\n */\nexport async function clearActiveCompany(): Promise<void> {\n\tconst { cookies } = await import(\"next/headers\");\n\tconst cookieStore = await cookies();\n\tcookieStore.delete(ACTIVE_COMPANY_COOKIE);\n}\n\n/**\n * Get User Companies\n *\n * Returns all companies the user has access to.\n *\n * SECURITY: Uses service role because:\n * - Query filters to user's own memberships (user_id = authenticated user)\n * - JOIN to companies table causes RLS recursion with anon key\n * - User only sees their own team_members records\n * - Companies table has its own RLS protection\n *\n * @returns Array of CompanyInfo objects\n */\nexport const getUserCompanies = cache(async (): Promise<CompanyInfo[]> => {\n\tconst user = await getCurrentUser();\n\tif (!user) {\n\t\treturn [];\n\t}\n\n\t// Use service role to bypass RLS recursion on JOIN\n\t// Query is safe: explicitly filtered to user's own records\n\tconst supabase = await createServiceSupabaseClient();\n\tif (!supabase) {\n\t\treturn [];\n\t}\n\n\tconst { data: memberships } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(\n\t\t\t`\n      company_id,\n      companies!inner (\n        id,\n        name,\n        logo,\n        deleted_at,\n        onboarding_completed_at\n      )\n    `,\n\t\t)\n\t\t.eq(\"user_id\", user.id)\n\t\t.eq(\"status\", \"active\")\n\t\t.is(\"companies.deleted_at\", null); // Exclude archived companies\n\n\tif (!memberships) {\n\t\treturn [];\n\t}\n\n\t// Sort companies: prioritize completed onboarding over incomplete\n\tconst sorted = memberships.sort((a: any, b: any) => {\n\t\tconst aCompleted = !!a.companies.onboarding_completed_at;\n\t\tconst bCompleted = !!b.companies.onboarding_completed_at;\n\n\t\t// Completed companies first\n\t\tif (aCompleted && !bCompleted) return -1;\n\t\tif (!aCompleted && bCompleted) return 1;\n\n\t\t// Then by name alphabetically\n\t\treturn a.companies.name.localeCompare(b.companies.name);\n\t});\n\n\treturn sorted.map((m: any) => ({\n\t\tid: m.companies.id,\n\t\tname: m.companies.name,\n\t\tlogo: m.companies.logo,\n\t}));\n});\n\n/**\n * Verify Company Access\n *\n * Checks if user has access to a company.\n *\n * @param companyId - Company ID to verify\n * @returns true if user has access, false otherwise\n */\nconst verifyCompanyAccess = cache(\n\tasync (companyId: string): Promise<boolean> => {\n\t\tconst user = await getCurrentUser();\n\t\tif (!user) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Parallel queries instead of sequential (saves 20-30ms)\n\t\tconst [companyResult, memberResult] = await Promise.all([\n\t\t\t// Check if company exists and is not archived\n\t\t\tsupabase\n\t\t\t\t.from(\"companies\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"id\", companyId)\n\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t.single(),\n\n\t\t\t// Check if user has active membership\n\t\t\tsupabase\n\t\t\t\t.from(\"company_memberships\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"user_id\", user.id)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"status\", \"active\")\n\t\t\t\t.single(),\n\t\t]);\n\n\t\t// Both must succeed\n\t\treturn !!(companyResult.data && memberResult.data);\n\t},\n);\n\n/**\n * Get Active Team Member ID\n *\n * Returns the team_members.id for the current user in the active company.\n * Used for personal inbox filtering and other team-member-specific features.\n *\n * PERFORMANCE: Wrapped with React.cache() - called by multiple components,\n * but only executes once per request.\n *\n * @returns Team member ID string or null if not found\n */\nexport const getActiveTeamMemberId = cache(async (): Promise<string | null> => {\n\tconst user = await getCurrentUser();\n\tif (!user) {\n\t\treturn null;\n\t}\n\n\tconst companyId = await getActiveCompanyId();\n\tif (!companyId) {\n\t\treturn null;\n\t}\n\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\treturn null;\n\t}\n\n\tconst { data: teamMember } = await supabase\n\t\t.from(\"team_members\")\n\t\t.select(\"id\")\n\t\t.eq(\"user_id\", user.id)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"active\")\n\t\t.single();\n\n\treturn teamMember?.id || null;\n});\n\n/**\n * Require Active Company\n *\n * Throws error if no active company is set.\n * Useful for actions that require a company context.\n *\n * @returns Company ID string\n * @throws Error if no active company\n */\nexport async function requireActiveCompany(): Promise<string> {\n\tconst companyId = await getActiveCompanyId();\n\n\tif (!companyId) {\n\t\tthrow new Error(\"No active company selected. Please select a company.\");\n\t}\n\n\treturn companyId;\n}\n\n/**\n * Check if User Has Multiple Companies\n *\n * Useful for conditionally showing company switcher UI.\n *\n * @returns true if user has 2+ companies, false otherwise\n */\nasync function hasMultipleCompanies(): Promise<boolean> {\n\tconst companies = await getUserCompanies();\n\treturn companies.length > 1;\n}\n\n/**\n * Check if Active Company Has Completed Onboarding\n *\n * Checks if the active company has an active payment subscription.\n * This is used to determine if onboarding is complete.\n *\n * SECURITY: Uses service role because:\n * - Query filters to user's own membership (user_id = authenticated user)\n * - JOIN to companies table causes RLS recursion with anon key\n * - User only sees their own team_members record\n * - Companies table has its own RLS protection\n *\n * @returns true if company has active/trialing subscription, false otherwise\n */\nexport async function isActiveCompanyOnboardingComplete(): Promise<boolean> {\n\tconst user = await getCurrentUser();\n\tif (!user) {\n\t\treturn false;\n\t}\n\n\tconst activeCompanyId = await getActiveCompanyId();\n\tif (!activeCompanyId) {\n\t\treturn false;\n\t}\n\n\t// Use service role to bypass RLS recursion on JOIN\n\t// Query is safe: explicitly filtered to user's own record\n\tconst supabase = await createServiceSupabaseClient();\n\tif (!supabase) {\n\t\treturn false;\n\t}\n\n\t// Check the ACTIVE company's payment status\n\tconst { data: teamMember } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(\n\t\t\t\"company_id, companies!inner(stripe_subscription_status, onboarding_progress, onboarding_completed_at)\",\n\t\t)\n\t\t.eq(\"user_id\", user.id)\n\t\t.eq(\"company_id\", activeCompanyId)\n\t\t.eq(\"status\", \"active\")\n\t\t.maybeSingle();\n\n\tif (!teamMember) {\n\t\treturn false;\n\t}\n\n\tconst companies = Array.isArray(teamMember.companies)\n\t\t? teamMember.companies[0]\n\t\t: teamMember.companies;\n\tconst subscriptionStatus = companies?.stripe_subscription_status;\n\tconst subscriptionActive =\n\t\tsubscriptionStatus === \"active\" || subscriptionStatus === \"trialing\";\n\tconst onboardingProgress =\n\t\t(companies?.onboarding_progress as Record<string, unknown>) || null;\n\tconst onboardingFinished = isOnboardingComplete({\n\t\tprogress: onboardingProgress,\n\t\tcompletedAt: companies?.onboarding_completed_at ?? null,\n\t});\n\n\treturn (\n\t\t(subscriptionActive && onboardingFinished) ||\n\t\tprocess.env.NODE_ENV === \"development\"\n\t);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 610, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/auth/company-context.ts"],"sourcesContent":["// Re-export from @stratos/auth package for backwards compatibility\nexport * from \"@stratos/auth/company-context\";\n"],"names":[],"mappings":"AAAA,mEAAmE;;AACnE"}},
    {"offset": {"line": 618, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/auth/src/permissions.ts"],"sourcesContent":["/**\n * Permission System - Server-Side Utilities\n *\n * Provides type-safe permission checking for role-based access control (RBAC).\n * Uses database functions for secure, centralized permission logic.\n *\n * Performance optimizations:\n * - Database functions are cached by Postgres\n * - Single query permission checks\n * - Prepared statements for security\n *\n * @example\n * ```typescript\n * // Check if user can delete jobs\n * const canDelete = await hasPermission(supabase, userId, \"delete_jobs\", companyId);\n *\n * // Check if user has manager role\n * const isManager = await hasRole(supabase, userId, \"manager\", companyId);\n *\n * // Get user's role\n * const role = await getUserRole(supabase, userId, companyId);\n * ```\n */\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/**\n * User roles in the system\n * Matches the user_role ENUM in database\n */\nexport type UserRole =\n\t| \"owner\"\n\t| \"admin\"\n\t| \"manager\"\n\t| \"dispatcher\"\n\t| \"technician\"\n\t| \"csr\";\n\n/**\n * Permission keys for fine-grained access control\n */\nexport type Permission =\n\t// Manager permissions\n\t| \"view_reports\"\n\t| \"manage_team\"\n\t| \"approve_estimates\"\n\t| \"handle_escalations\"\n\t// Dispatcher permissions\n\t| \"dispatch_jobs\"\n\t| \"manage_schedule\"\n\t| \"view_tech_locations\"\n\t// Technician permissions\n\t| \"update_job_status\"\n\t| \"create_invoices\"\n\t| \"upload_photos\"\n\t// CSR permissions\n\t| \"create_jobs\"\n\t| \"schedule_appointments\"\n\t| \"send_communications\"\n\t// View permissions\n\t| \"view_customers\"\n\t| \"view_jobs\"\n\t| \"view_schedule\"\n\t// Delete permissions\n\t| \"delete_jobs\"\n\t| \"delete_customers\"\n\t| \"delete_team_members\";\n\n/**\n * Role configuration with permissions and metadata\n */\nexport type RoleConfig = {\n\tid: UserRole;\n\tlabel: string;\n\tdescription: string;\n\tpermissions: Permission[];\n\tdashboardFeatures: string[];\n};\n\n// ============================================================================\n// Role Definitions\n// ============================================================================\n\n/**\n * Complete role configurations with their permissions\n * Used for UI display and permission reference\n */\nconst ROLES: Record<UserRole, RoleConfig> = {\n\towner: {\n\t\tid: \"owner\",\n\t\tlabel: \"Owner\",\n\t\tdescription:\n\t\t\t\"Full system access with focus on business financials and growth\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t\t\"delete_customers\",\n\t\t\t\"delete_team_members\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"financial-overview\",\n\t\t\t\"profit-margins\",\n\t\t\t\"cash-flow\",\n\t\t\t\"business-growth\",\n\t\t\t\"payroll-overview\",\n\t\t\t\"all-reports\",\n\t\t],\n\t},\n\tadmin: {\n\t\tid: \"admin\",\n\t\tlabel: \"Admin\",\n\t\tdescription: \"System administration and configuration\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t\t\"delete_customers\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"system-settings\",\n\t\t\t\"user-management\",\n\t\t\t\"integrations\",\n\t\t\t\"audit-logs\",\n\t\t],\n\t},\n\tmanager: {\n\t\tid: \"manager\",\n\t\tlabel: \"Manager\",\n\t\tdescription:\n\t\t\t\"Oversee team performance, customer satisfaction, and operations\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"team-performance\",\n\t\t\t\"customer-satisfaction\",\n\t\t\t\"callback-queue\",\n\t\t\t\"review-alerts\",\n\t\t\t\"kpi-tracking\",\n\t\t\t\"inventory-management\",\n\t\t],\n\t},\n\tdispatcher: {\n\t\tid: \"dispatcher\",\n\t\tlabel: \"Dispatcher\",\n\t\tdescription:\n\t\t\t\"Manage technician schedules, job assignments, and real-time operations\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"dispatch-map\",\n\t\t\t\"technician-locations\",\n\t\t\t\"unassigned-jobs\",\n\t\t\t\"emergency-queue\",\n\t\t\t\"quick-dispatch\",\n\t\t\t\"tech-status\",\n\t\t],\n\t},\n\ttechnician: {\n\t\tid: \"technician\",\n\t\tlabel: \"Technician\",\n\t\tdescription:\n\t\t\t\"View assigned jobs, update job status, and track personal performance\",\n\t\tpermissions: [\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"my-schedule\",\n\t\t\t\"active-job\",\n\t\t\t\"my-earnings\",\n\t\t\t\"my-performance\",\n\t\t\t\"parts-inventory\",\n\t\t\t\"time-tracking\",\n\t\t],\n\t},\n\tcsr: {\n\t\tid: \"csr\",\n\t\tlabel: \"Customer Service Rep\",\n\t\tdescription:\n\t\t\t\"Handle customer calls, schedule appointments, and manage customer relationships\",\n\t\tpermissions: [\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"create_invoices\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"call-queue\",\n\t\t\t\"booking-calendar\",\n\t\t\t\"customer-search\",\n\t\t\t\"follow-up-queue\",\n\t\t\t\"estimate-pipeline\",\n\t\t\t\"call-scripts\",\n\t\t],\n\t},\n};\n\n// ============================================================================\n// Permission Check Functions\n// ============================================================================\n\n/**\n * Check if user has a specific role in a company\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param role - Role to check for\n * @param companyId - Company ID\n * @returns true if user has the role\n *\n * @example\n * ```typescript\n * const isManager = await hasRole(supabase, userId, \"manager\", companyId);\n * if (!isManager) {\n *   throw new Error(\"Access denied: Manager role required\");\n * }\n * ```\n */\nexport async function hasRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\trole: UserRole,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_role\", {\n\t\tuser_uuid: userId,\n\t\trequired_role: role,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Check if user has ANY of the specified roles\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param roles - Array of roles to check\n * @param companyId - Company ID\n * @returns true if user has any of the roles\n *\n * @example\n * ```typescript\n * const canManage = await hasAnyRole(\n *   supabase,\n *   userId,\n *   [\"owner\", \"manager\", \"admin\"],\n *   companyId\n * );\n * ```\n */\nasync function hasAnyRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\troles: UserRole[],\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_any_role\", {\n\t\tuser_uuid: userId,\n\t\trequired_roles: roles,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Get user's role in a company\n *\n * @param supabase - Supabase client\n * @param userId - User ID\n * @param companyId - Company ID\n * @returns User's role or null if not found\n *\n * @example\n * ```typescript\n * const role = await getUserRole(supabase, userId, companyId);\n * console.log(`User role: ${role}`); // \"manager\"\n * ```\n */\nexport async function getUserRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tcompanyId: string,\n): Promise<UserRole | null> {\n\tconst { data, error } = await supabase.rpc(\"get_user_role\", {\n\t\tuser_uuid: userId,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn null;\n\t}\n\n\treturn data as UserRole | null;\n}\n\n/**\n * Check if user has a specific permission\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param permission - Permission key to check\n * @param companyId - Company ID\n * @returns true if user has the permission\n *\n * @example\n * ```typescript\n * const canDelete = await hasPermission(supabase, userId, \"delete_jobs\", companyId);\n * if (!canDelete) {\n *   return { error: \"You don't have permission to delete jobs\" };\n * }\n * ```\n */\nexport async function hasPermission(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tpermission: Permission,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_permission\", {\n\t\tuser_uuid: userId,\n\t\tpermission_key: permission,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Check if user is the company owner\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param companyId - Company ID\n * @returns true if user is the owner\n *\n * @example\n * ```typescript\n * const isOwner = await isCompanyOwner(supabase, userId, companyId);\n * if (!isOwner) {\n *   throw new Error(\"Only company owner can perform this action\");\n * }\n * ```\n */\nexport async function isCompanyOwner(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"is_company_owner\", {\n\t\tuser_uuid: userId,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\n/**\n * Get all permissions for a role\n *\n * @param role - Role to get permissions for\n * @returns Array of permission keys\n *\n * @example\n * ```typescript\n * const managerPerms = getRolePermissions(\"manager\");\n * console.log(managerPerms); // [\"view_reports\", \"manage_team\", ...]\n * ```\n */\nfunction getRolePermissions(role: UserRole): Permission[] {\n\treturn ROLES[role]?.permissions || [];\n}\n\n/**\n * Check if a role has a specific permission (client-side check only)\n *\n * @param role - Role to check\n * @param permission - Permission to check for\n * @returns true if role has the permission\n *\n * @example\n * ```typescript\n * const canDelete = roleHasPermission(\"manager\", \"delete_jobs\");\n * ```\n */\nfunction roleHasPermission(role: UserRole, permission: Permission): boolean {\n\treturn ROLES[role]?.permissions.includes(permission);\n}\n\n/**\n * Get role configuration\n *\n * @param role - Role to get config for\n * @returns Role configuration\n *\n * @example\n * ```typescript\n * const config = getRoleConfig(\"manager\");\n * console.log(config.label); // \"Manager\"\n * ```\n */\nfunction getRoleConfig(role: UserRole): RoleConfig {\n\treturn ROLES[role];\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;CAsBC;;;;;;;;;;AA6DD,+EAA+E;AAC/E,mBAAmB;AACnB,+EAA+E;AAE/E;;;CAGC,GACD,MAAM,QAAsC;IAC3C,OAAO;QACN,IAAI;QACJ,OAAO;QACP,aACC;QACD,aAAa;YACZ;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACA;QACD,mBAAmB;YAClB;YACA;YACA;YACA;YACA;YACA;SACA;IACF;IACA,OAAO;QACN,IAAI;QACJ,OAAO;QACP,aAAa;QACb,aAAa;YACZ;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACA;QACD,mBAAmB;YAClB;YACA;YACA;YACA;SACA;IACF;IACA,SAAS;QACR,IAAI;QACJ,OAAO;QACP,aACC;QACD,aAAa;YACZ;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACA;QACD,mBAAmB;YAClB;YACA;YACA;YACA;YACA;YACA;SACA;IACF;IACA,YAAY;QACX,IAAI;QACJ,OAAO;QACP,aACC;QACD,aAAa;YACZ;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACA;QACD,mBAAmB;YAClB;YACA;YACA;YACA;YACA;YACA;SACA;IACF;IACA,YAAY;QACX,IAAI;QACJ,OAAO;QACP,aACC;QACD,aAAa;YACZ;YACA;YACA;YACA;YACA;YACA;SACA;QACD,mBAAmB;YAClB;YACA;YACA;YACA;YACA;YACA;SACA;IACF;IACA,KAAK;QACJ,IAAI;QACJ,OAAO;QACP,aACC;QACD,aAAa;YACZ;YACA;YACA;YACA;YACA;YACA;YACA;SACA;QACD,mBAAmB;YAClB;YACA;YACA;YACA;YACA;YACA;SACA;IACF;AACD;AAuBO,eAAe,QACrB,QAAwB,EACxB,MAAc,EACd,IAAc,EACd,SAAiB;IAEjB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,YAAY;QACtD,WAAW;QACX,eAAe;QACf,cAAc;IACf;IAEA,IAAI,OAAO;QACV,OAAO;IACR;IAEA,OAAO,SAAS;AACjB;AAEA;;;;;;;;;;;;;;;;;;CAkBC,GACD,eAAe,WACd,QAAwB,EACxB,MAAc,EACd,KAAiB,EACjB,SAAiB;IAEjB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,gBAAgB;QAC1D,WAAW;QACX,gBAAgB;QAChB,cAAc;IACf;IAEA,IAAI,OAAO;QACV,OAAO;IACR;IAEA,OAAO,SAAS;AACjB;AAgBO,eAAe,YACrB,QAAwB,EACxB,MAAc,EACd,SAAiB;IAEjB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,iBAAiB;QAC3D,WAAW;QACX,cAAc;IACf;IAEA,IAAI,OAAO;QACV,OAAO;IACR;IAEA,OAAO;AACR;AAmBO,eAAe,cACrB,QAAwB,EACxB,MAAc,EACd,UAAsB,EACtB,SAAiB;IAEjB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,kBAAkB;QAC5D,WAAW;QACX,gBAAgB;QAChB,cAAc;IACf;IAEA,IAAI,OAAO;QACV,OAAO;IACR;IAEA,OAAO,SAAS;AACjB;AAkBO,eAAe,eACrB,QAAwB,EACxB,MAAc,EACd,SAAiB;IAEjB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,oBAAoB;QAC9D,WAAW;QACX,cAAc;IACf;IAEA,IAAI,OAAO;QACV,OAAO;IACR;IAEA,OAAO,SAAS;AACjB;AAEA,+EAA+E;AAC/E,mBAAmB;AACnB,+EAA+E;AAE/E;;;;;;;;;;;CAWC,GACD,SAAS,mBAAmB,IAAc;IACzC,OAAO,KAAK,CAAC,KAAK,EAAE,eAAe,EAAE;AACtC;AAEA;;;;;;;;;;;CAWC,GACD,SAAS,kBAAkB,IAAc,EAAE,UAAsB;IAChE,OAAO,KAAK,CAAC,KAAK,EAAE,YAAY,SAAS;AAC1C;AAEA;;;;;;;;;;;CAWC,GACD,SAAS,cAAc,IAAc;IACpC,OAAO,KAAK,CAAC,KAAK;AACnB"}},
    {"offset": {"line": 944, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/auth/permissions.ts"],"sourcesContent":["// Re-export from @stratos/auth package for backwards compatibility\nexport * from \"@stratos/auth/permissions\";\n"],"names":[],"mappings":"AAAA,mEAAmE;;AACnE"}},
    {"offset": {"line": 952, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/errors/action-error.ts"],"sourcesContent":["/**\n * Action Error Class & Error Codes\n *\n * Provides standardized error handling for Server Actions with:\n * - Error codes for categorization\n * - HTTP status codes for API responses\n * - Detailed error messages\n * - Optional error details/context\n */\n\n/**\n * Error Code Constants\n *\n * Organized by category for easy management and consistent error handling\n */\nexport const ERROR_CODES = {\n\t// Authentication & Authorization\n\tAUTH_UNAUTHORIZED: \"AUTH_UNAUTHORIZED\",\n\tAUTH_FORBIDDEN: \"AUTH_FORBIDDEN\",\n\tAUTH_TOKEN_EXPIRED: \"AUTH_TOKEN_EXPIRED\",\n\tAUTH_TOKEN_INVALID: \"AUTH_TOKEN_INVALID\",\n\tAUTH_EMAIL_NOT_VERIFIED: \"AUTH_EMAIL_NOT_VERIFIED\",\n\n\t// Validation\n\tVALIDATION_FAILED: \"VALIDATION_FAILED\",\n\tVALIDATION_REQUIRED_FIELD: \"VALIDATION_REQUIRED_FIELD\",\n\tVALIDATION_INVALID_FORMAT: \"VALIDATION_INVALID_FORMAT\",\n\tVALIDATION_OUT_OF_RANGE: \"VALIDATION_OUT_OF_RANGE\",\n\n\t// Database\n\tDB_RECORD_NOT_FOUND: \"DB_RECORD_NOT_FOUND\",\n\tDB_DUPLICATE_ENTRY: \"DB_DUPLICATE_ENTRY\",\n\tDB_CONSTRAINT_VIOLATION: \"DB_CONSTRAINT_VIOLATION\",\n\tDB_FOREIGN_KEY_VIOLATION: \"DB_FOREIGN_KEY_VIOLATION\",\n\tDB_CONNECTION_ERROR: \"DB_CONNECTION_ERROR\",\n\tDB_QUERY_ERROR: \"DB_QUERY_ERROR\",\n\tDB_INSERT_ERROR: \"DB_INSERT_ERROR\",\n\tDB_UPDATE_ERROR: \"DB_UPDATE_ERROR\",\n\n\t// Business Logic\n\tBUSINESS_RULE_VIOLATION: \"BUSINESS_RULE_VIOLATION\",\n\tINSUFFICIENT_PERMISSIONS: \"INSUFFICIENT_PERMISSIONS\",\n\tOPERATION_NOT_ALLOWED: \"OPERATION_NOT_ALLOWED\",\n\tRESOURCE_LOCKED: \"RESOURCE_LOCKED\",\n\tRESOURCE_DELETED: \"RESOURCE_DELETED\",\n\n\t// External Services\n\tSERVICE_UNAVAILABLE: \"SERVICE_UNAVAILABLE\",\n\tSERVICE_TIMEOUT: \"SERVICE_TIMEOUT\",\n\tSERVICE_RATE_LIMIT: \"SERVICE_RATE_LIMIT\",\n\tSERVICE_INTEGRATION_ERROR: \"SERVICE_INTEGRATION_ERROR\",\n\tEXTERNAL_API_ERROR: \"EXTERNAL_API_ERROR\",\n\n\t// File Operations\n\tFILE_NOT_FOUND: \"FILE_NOT_FOUND\",\n\tFILE_TOO_LARGE: \"FILE_TOO_LARGE\",\n\tFILE_INVALID_TYPE: \"FILE_INVALID_TYPE\",\n\tFILE_UPLOAD_FAILED: \"FILE_UPLOAD_FAILED\",\n\n\t// Payment & Financial\n\tPAYMENT_FAILED: \"PAYMENT_FAILED\",\n\tPAYMENT_DECLINED: \"PAYMENT_DECLINED\",\n\tPAYMENT_INSUFFICIENT_FUNDS: \"PAYMENT_INSUFFICIENT_FUNDS\",\n\tPAYMENT_INVALID_AMOUNT: \"PAYMENT_INVALID_AMOUNT\",\n\tPAYMENT_ALREADY_REFUNDED: \"PAYMENT_ALREADY_REFUNDED\",\n\tPAYMENT_CANNOT_REFUND: \"PAYMENT_CANNOT_REFUND\",\n\n\t// Generic\n\tUNKNOWN_ERROR: \"UNKNOWN_ERROR\",\n\tINTERNAL_SERVER_ERROR: \"INTERNAL_SERVER_ERROR\",\n\tBAD_REQUEST: \"BAD_REQUEST\",\n\tNOT_IMPLEMENTED: \"NOT_IMPLEMENTED\",\n\tUNAUTHORIZED: \"UNAUTHORIZED\",\n\tNOT_FOUND: \"NOT_FOUND\",\n\tCONFLICT: \"CONFLICT\",\n\tEXPIRED: \"EXPIRED\",\n\tVALIDATION_ERROR: \"VALIDATION_ERROR\",\n} as const;\n\nexport type ErrorCode = (typeof ERROR_CODES)[keyof typeof ERROR_CODES];\n\n/**\n * Action Error Class\n *\n * Custom error class for Server Actions with additional context\n *\n * @example\n * throw new ActionError(\n *   \"Customer not found\",\n *   ERROR_CODES.DB_RECORD_NOT_FOUND,\n *   404,\n *   { customerId: \"123\" }\n * );\n */\nexport class ActionError extends Error {\n\tconstructor(\n\t\tmessage: string,\n\t\tpublic readonly code: ErrorCode = ERROR_CODES.UNKNOWN_ERROR,\n\t\tpublic readonly statusCode: number = 400,\n\t\tpublic readonly details?: Record<string, any>,\n\t) {\n\t\tsuper(message);\n\t\tthis.name = \"ActionError\";\n\n\t\t// Maintains proper stack trace for where error was thrown (V8 only)\n\t\tif (Error.captureStackTrace) {\n\t\t\tError.captureStackTrace(this, ActionError);\n\t\t}\n\t}\n\n\t/**\n\t * Convert error to a plain object suitable for API responses\n\t */\n\ttoJSON() {\n\t\treturn {\n\t\t\tsuccess: false as const,\n\t\t\terror: this.message,\n\t\t\tcode: this.code,\n\t\t\tstatusCode: this.statusCode,\n\t\t\t...(this.details && { details: this.details }),\n\t\t};\n\t}\n\n\t/**\n\t * Create ActionError from unknown error\n\t */\n\tstatic fromUnknown(error: unknown): ActionError {\n\t\tif (error instanceof ActionError) {\n\t\t\treturn error;\n\t\t}\n\n\t\tif (error instanceof Error) {\n\t\t\treturn new ActionError(\n\t\t\t\terror.message,\n\t\t\t\tERROR_CODES.INTERNAL_SERVER_ERROR,\n\t\t\t\t500,\n\t\t\t);\n\t\t}\n\n\t\treturn new ActionError(\n\t\t\t\"An unexpected error occurred\",\n\t\t\tERROR_CODES.UNKNOWN_ERROR,\n\t\t\t500,\n\t\t);\n\t}\n}\n\n/**\n * Error Message Helpers\n *\n * Consistent error messages for common scenarios\n */\nexport const ERROR_MESSAGES = {\n\t// Authentication\n\tunauthorized: () => \"You must be logged in to perform this action\",\n\tforbidden: (resource: string) =>\n\t\t`You don't have permission to access this ${resource}`,\n\temailNotVerified: () => \"Please verify your email before continuing\",\n\n\t// Validation\n\trequiredField: (field: string) => `${field} is required`,\n\tinvalidFormat: (field: string) => `${field} has an invalid format`,\n\toutOfRange: (field: string, min: number, max: number) =>\n\t\t`${field} must be between ${min} and ${max}`,\n\n\t// Database\n\tnotFound: (resource: string) => `${resource} not found`,\n\talreadyExists: (resource: string) => `${resource} already exists`,\n\tcannotDelete: (resource: string, reason: string) =>\n\t\t`Cannot delete ${resource}: ${reason}`,\n\n\t// Business Logic\n\tinsufficientFunds: () => \"Insufficient funds for this transaction\",\n\tcannotRefund: (reason: string) => `Cannot process refund: ${reason}`,\n\tresourceLocked: (resource: string) =>\n\t\t`${resource} is currently being modified by another user`,\n\n\t// Generic\n\toperationFailed: (operation: string) => `Failed to ${operation}`,\n\tserviceUnavailable: (service: string) =>\n\t\t`${service} is currently unavailable`,\n} as const;\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC,GAED;;;;CAIC;;;;;;;;AACM,MAAM,cAAc;IAC1B,iCAAiC;IACjC,mBAAmB;IACnB,gBAAgB;IAChB,oBAAoB;IACpB,oBAAoB;IACpB,yBAAyB;IAEzB,aAAa;IACb,mBAAmB;IACnB,2BAA2B;IAC3B,2BAA2B;IAC3B,yBAAyB;IAEzB,WAAW;IACX,qBAAqB;IACrB,oBAAoB;IACpB,yBAAyB;IACzB,0BAA0B;IAC1B,qBAAqB;IACrB,gBAAgB;IAChB,iBAAiB;IACjB,iBAAiB;IAEjB,iBAAiB;IACjB,yBAAyB;IACzB,0BAA0B;IAC1B,uBAAuB;IACvB,iBAAiB;IACjB,kBAAkB;IAElB,oBAAoB;IACpB,qBAAqB;IACrB,iBAAiB;IACjB,oBAAoB;IACpB,2BAA2B;IAC3B,oBAAoB;IAEpB,kBAAkB;IAClB,gBAAgB;IAChB,gBAAgB;IAChB,mBAAmB;IACnB,oBAAoB;IAEpB,sBAAsB;IACtB,gBAAgB;IAChB,kBAAkB;IAClB,4BAA4B;IAC5B,wBAAwB;IACxB,0BAA0B;IAC1B,uBAAuB;IAEvB,UAAU;IACV,eAAe;IACf,uBAAuB;IACvB,aAAa;IACb,iBAAiB;IACjB,cAAc;IACd,WAAW;IACX,UAAU;IACV,SAAS;IACT,kBAAkB;AACnB;AAiBO,MAAM,oBAAoB;;;;IAChC,YACC,OAAe,EACf,AAAgB,OAAkB,YAAY,aAAa,EAC3D,AAAgB,aAAqB,GAAG,EACxC,AAAgB,OAA6B,CAC5C;QACD,KAAK,CAAC,eAJU,OAAA,WACA,aAAA,iBACA,UAAA;QAGhB,IAAI,CAAC,IAAI,GAAG;QAEZ,oEAAoE;QACpE,IAAI,MAAM,iBAAiB,EAAE;YAC5B,MAAM,iBAAiB,CAAC,IAAI,EAAE;QAC/B;IACD;IAEA;;EAEC,GACD,SAAS;QACR,OAAO;YACN,SAAS;YACT,OAAO,IAAI,CAAC,OAAO;YACnB,MAAM,IAAI,CAAC,IAAI;YACf,YAAY,IAAI,CAAC,UAAU;YAC3B,GAAI,IAAI,CAAC,OAAO,IAAI;gBAAE,SAAS,IAAI,CAAC,OAAO;YAAC,CAAC;QAC9C;IACD;IAEA;;EAEC,GACD,OAAO,YAAY,KAAc,EAAe;QAC/C,IAAI,iBAAiB,aAAa;YACjC,OAAO;QACR;QAEA,IAAI,iBAAiB,OAAO;YAC3B,OAAO,IAAI,YACV,MAAM,OAAO,EACb,YAAY,qBAAqB,EACjC;QAEF;QAEA,OAAO,IAAI,YACV,gCACA,YAAY,aAAa,EACzB;IAEF;AACD;AAOO,MAAM,iBAAiB;IAC7B,iBAAiB;IACjB,cAAc,IAAM;IACpB,WAAW,CAAC,WACX,CAAC,yCAAyC,EAAE,UAAU;IACvD,kBAAkB,IAAM;IAExB,aAAa;IACb,eAAe,CAAC,QAAkB,GAAG,MAAM,YAAY,CAAC;IACxD,eAAe,CAAC,QAAkB,GAAG,MAAM,sBAAsB,CAAC;IAClE,YAAY,CAAC,OAAe,KAAa,MACxC,GAAG,MAAM,iBAAiB,EAAE,IAAI,KAAK,EAAE,KAAK;IAE7C,WAAW;IACX,UAAU,CAAC,WAAqB,GAAG,SAAS,UAAU,CAAC;IACvD,eAAe,CAAC,WAAqB,GAAG,SAAS,eAAe,CAAC;IACjE,cAAc,CAAC,UAAkB,SAChC,CAAC,cAAc,EAAE,SAAS,EAAE,EAAE,QAAQ;IAEvC,iBAAiB;IACjB,mBAAmB,IAAM;IACzB,cAAc,CAAC,SAAmB,CAAC,uBAAuB,EAAE,QAAQ;IACpE,gBAAgB,CAAC,WAChB,GAAG,SAAS,4CAA4C,CAAC;IAE1D,UAAU;IACV,iBAAiB,CAAC,YAAsB,CAAC,UAAU,EAAE,WAAW;IAChE,oBAAoB,CAAC,UACpB,GAAG,QAAQ,yBAAyB,CAAC;AACvC"}},
    {"offset": {"line": 1090, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/errors/with-error-handling.ts"],"sourcesContent":["/**\n * Error Handling Wrapper for Server Actions\n *\n * Provides consistent error handling, logging, and response formatting\n * for all Server Actions in the application.\n */\n\nimport { ZodError } from \"zod\";\nimport { ActionError, ERROR_CODES } from \"./action-error\";\n\n// Re-export for convenience\nexport { ActionError, ERROR_CODES } from \"./action-error\";\n\n/**\n * Standard Action Result Type\n *\n * All Server Actions should return this type for consistency\n */\nexport type ActionResult<T = void> =\n\t| {\n\t\t\tsuccess: true;\n\t\t\tdata: T;\n\t\t\tmessage?: string;\n\t\t\terror?: string;\n\t  }\n\t| {\n\t\t\tsuccess: false;\n\t\t\terror: string;\n\t\t\tcode?: string;\n\t\t\tdetails?: Record<string, any>;\n\t  };\n\n/**\n * Wrap Server Action with Error Handling\n *\n * Automatically handles errors and returns a consistent ActionResult format.\n * Logs errors appropriately and provides detailed error information in development.\n *\n * @example\n * export async function createCustomer(data: CustomerInsert) {\n *   return withErrorHandling(async () => {\n *     const validated = customerInsertSchema.parse(data);\n *     const supabase = await createClient();\n *\n *     const { data: customer, error } = await supabase\n *       .from(\"customers\")\n *       .insert(validated)\n *       .select()\n *       .single();\n *\n *     if (error) {\n *       throw new ActionError(error.message, ERROR_CODES.DB_QUERY_ERROR);\n *     }\n *\n *     return customer;\n *   });\n * }\n */\nexport async function withErrorHandling<T>(\n\tfn: () => Promise<T>,\n): Promise<ActionResult<T>> {\n\ttry {\n\t\tconst data = await fn();\n\t\treturn { success: true, data };\n\t} catch (error) {\n\t\t// Handle ActionError (our custom errors)\n\t\tif (error instanceof ActionError) {\n\t\t\t// Log authorization errors as warnings since they're expected in some cases\n\t\t\t// (e.g., user not part of a company, insufficient permissions)\n\t\t\tconst isExpectedAuthError =\n\t\t\t\terror.code === ERROR_CODES.AUTH_FORBIDDEN ||\n\t\t\t\terror.code === ERROR_CODES.AUTH_UNAUTHORIZED;\n\n\t\t\tif (isExpectedAuthError) {\n\t\t\t\t// Only log in development, or as a warning\n\t\t\t\tif (process.env.NODE_ENV === \"development\") {\n\t\t\t\t\tconsole.debug(\n\t\t\t\t\t\t`[Auth] Expected auth error: ${error.code} - ${error.message}`,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconsole.error(`[Action Error] ${error.code}: ${error.message}`);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.message,\n\t\t\t\tcode: error.code,\n\t\t\t\t...(error.details && { details: error.details }),\n\t\t\t};\n\t\t}\n\n\t\t// Handle Zod validation errors\n\t\tif (error instanceof ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.issues[0]?.message || \"Validation failed\",\n\t\t\t\tcode: ERROR_CODES.VALIDATION_FAILED,\n\t\t\t\tdetails: {\n\t\t\t\t\tissues: error.issues.map((issue) => ({\n\t\t\t\t\t\tfield: issue.path.join(\".\"),\n\t\t\t\t\t\tmessage: issue.message,\n\t\t\t\t\t})),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t// Handle standard JavaScript errors\n\t\tif (error instanceof Error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\tprocess.env.NODE_ENV === \"development\"\n\t\t\t\t\t\t? error.message\n\t\t\t\t\t\t: \"An unexpected error occurred\",\n\t\t\t\tcode: ERROR_CODES.INTERNAL_SERVER_ERROR,\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"An unexpected error occurred\",\n\t\t\tcode: ERROR_CODES.UNKNOWN_ERROR,\n\t\t};\n\t}\n}\n\n/**\n * Create a success result\n *\n * Helper to create consistent success responses\n */\nfunction successResult<T>(data: T, message?: string): ActionResult<T> {\n\treturn {\n\t\tsuccess: true,\n\t\tdata,\n\t\t...(message && { message }),\n\t};\n}\n\n/**\n * Create an error result\n *\n * Helper to create consistent error responses\n */\nfunction errorResult(\n\terror: string,\n\tcode?: string,\n\tdetails?: Record<string, any>,\n): ActionResult<never> {\n\treturn {\n\t\tsuccess: false,\n\t\terror,\n\t\t...(code && { code }),\n\t\t...(details && { details }),\n\t};\n}\n\n/**\n * Assert Supabase client is available\n *\n * Helper to check if Supabase client exists and throw ActionError if not\n */\nexport function assertSupabase<T>(\n\tsupabase: T | null | undefined,\n): asserts supabase is T {\n\tif (!supabase) {\n\t\tthrow new ActionError(\n\t\t\t\"Database connection failed\",\n\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t500,\n\t\t);\n\t}\n}\n\n/**\n * Assert user is authenticated\n *\n * Helper to check authentication and throw ActionError if not authenticated\n */\nexport function assertAuthenticated(\n\tuserId: string | undefined,\n): asserts userId is string {\n\tif (!userId) {\n\t\tthrow new ActionError(\n\t\t\t\"You must be logged in to perform this action\",\n\t\t\tERROR_CODES.AUTH_UNAUTHORIZED,\n\t\t\t401,\n\t\t);\n\t}\n}\n\n/**\n * Assert resource exists\n *\n * Helper to check if resource exists and throw ActionError if not\n */\nexport function assertExists<T>(\n\tresource: T | null | undefined,\n\tresourceName: string,\n): asserts resource is T {\n\tif (!resource) {\n\t\tthrow new ActionError(\n\t\t\t`${resourceName} not found`,\n\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t404,\n\t\t);\n\t}\n}\n\n/**\n * Assert user has permission\n *\n * Helper to check permissions and throw ActionError if not authorized\n */\nfunction assertPermission(\n\thasPermission: boolean,\n\tresourceName: string,\n): asserts hasPermission {\n\tif (!hasPermission) {\n\t\tthrow new ActionError(\n\t\t\t`You don't have permission to access this ${resourceName}`,\n\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t403,\n\t\t);\n\t}\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;;;AAED;AACA;;;;AAkDO,eAAe,kBACrB,EAAoB;IAEpB,IAAI;QACH,MAAM,OAAO,MAAM;QACnB,OAAO;YAAE,SAAS;YAAM;QAAK;IAC9B,EAAE,OAAO,OAAO;QACf,yCAAyC;QACzC,IAAI,iBAAiB,qKAAW,EAAE;YACjC,4EAA4E;YAC5E,+DAA+D;YAC/D,MAAM,sBACL,MAAM,IAAI,KAAK,qKAAW,CAAC,cAAc,IACzC,MAAM,IAAI,KAAK,qKAAW,CAAC,iBAAiB;YAE7C,IAAI,qBAAqB;gBACxB,2CAA2C;gBAC3C,wCAA4C;oBAC3C,QAAQ,KAAK,CACZ,CAAC,4BAA4B,EAAE,MAAM,IAAI,CAAC,GAAG,EAAE,MAAM,OAAO,EAAE;gBAEhE;YACD,OAAO;gBACN,QAAQ,KAAK,CAAC,CAAC,eAAe,EAAE,MAAM,IAAI,CAAC,EAAE,EAAE,MAAM,OAAO,EAAE;YAC/D;YAEA,OAAO;gBACN,SAAS;gBACT,OAAO,MAAM,OAAO;gBACpB,MAAM,MAAM,IAAI;gBAChB,GAAI,MAAM,OAAO,IAAI;oBAAE,SAAS,MAAM,OAAO;gBAAC,CAAC;YAChD;QACD;QAEA,+BAA+B;QAC/B,IAAI,iBAAiB,2MAAQ,EAAE;YAC9B,OAAO;gBACN,SAAS;gBACT,OAAO,MAAM,MAAM,CAAC,EAAE,EAAE,WAAW;gBACnC,MAAM,qKAAW,CAAC,iBAAiB;gBACnC,SAAS;oBACR,QAAQ,MAAM,MAAM,CAAC,GAAG,CAAC,CAAC,QAAU,CAAC;4BACpC,OAAO,MAAM,IAAI,CAAC,IAAI,CAAC;4BACvB,SAAS,MAAM,OAAO;wBACvB,CAAC;gBACF;YACD;QACD;QAEA,oCAAoC;QACpC,IAAI,iBAAiB,OAAO;YAC3B,OAAO;gBACN,SAAS;gBACT,OACC,uCACG,MAAM,OAAO,GACb;gBACJ,MAAM,qKAAW,CAAC,qBAAqB;YACxC;QACD;QACA,OAAO;YACN,SAAS;YACT,OAAO;YACP,MAAM,qKAAW,CAAC,aAAa;QAChC;IACD;AACD;AAEA;;;;CAIC,GACD,SAAS,cAAiB,IAAO,EAAE,OAAgB;IAClD,OAAO;QACN,SAAS;QACT;QACA,GAAI,WAAW;YAAE;QAAQ,CAAC;IAC3B;AACD;AAEA;;;;CAIC,GACD,SAAS,YACR,KAAa,EACb,IAAa,EACb,OAA6B;IAE7B,OAAO;QACN,SAAS;QACT;QACA,GAAI,QAAQ;YAAE;QAAK,CAAC;QACpB,GAAI,WAAW;YAAE;QAAQ,CAAC;IAC3B;AACD;AAOO,SAAS,eACf,QAA8B;IAE9B,IAAI,CAAC,UAAU;QACd,MAAM,IAAI,qKAAW,CACpB,8BACA,qKAAW,CAAC,mBAAmB,EAC/B;IAEF;AACD;AAOO,SAAS,oBACf,MAA0B;IAE1B,IAAI,CAAC,QAAQ;QACZ,MAAM,IAAI,qKAAW,CACpB,gDACA,qKAAW,CAAC,iBAAiB,EAC7B;IAEF;AACD;AAOO,SAAS,aACf,QAA8B,EAC9B,YAAoB;IAEpB,IAAI,CAAC,UAAU;QACd,MAAM,IAAI,qKAAW,CACpB,GAAG,aAAa,UAAU,CAAC,EAC3B,qKAAW,CAAC,mBAAmB,EAC/B;IAEF;AACD;AAEA;;;;CAIC,GACD,SAAS,iBACR,aAAsB,EACtB,YAAoB;IAEpB,IAAI,CAAC,eAAe;QACnB,MAAM,IAAI,qKAAW,CACpB,CAAC,yCAAyC,EAAE,cAAc,EAC1D,qKAAW,CAAC,cAAc,EAC1B;IAEF;AACD"}},
    {"offset": {"line": 1226, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/roles.ts"],"sourcesContent":["/**\n * Role Actions - Server Actions\n *\n * Server-side actions for role management and permission checks.\n * Uses Supabase RLS and database functions for security.\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport {\n\tgetUserRole,\n\thasPermission,\n\thasRole,\n\tisCompanyOwner,\n\ttype Permission,\n\ttype UserRole,\n} from \"@/lib/auth/permissions\";\nimport { withErrorHandling } from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// ============================================================================\n// Validation Schemas\n// ============================================================================\n\nconst updateRoleSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tnewRole: z.enum([\n\t\t\"owner\",\n\t\t\"admin\",\n\t\t\"manager\",\n\t\t\"dispatcher\",\n\t\t\"technician\",\n\t\t\"csr\",\n\t]),\n\treason: z.string().optional(),\n});\n\nconst updatePermissionsSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tpermissions: z.record(z.string(), z.boolean()),\n});\n\n// ============================================================================\n// Query Actions\n// ============================================================================\n\n/**\n * Get current user's role in active company\n *\n * @returns User's role or null\n *\n * @example\n * ```typescript\n * const role = await getCurrentUserRole();\n * if (role.success && role.data === \"manager\") {\n *   // Show manager dashboard\n * }\n * ```\n */\nexport async function getCurrentUserRole() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst role = await getUserRole(supabase, user.id, companyId);\n\n\t\treturn role;\n\t});\n}\n\n/**\n * Check if current user has a specific permission\n *\n * @param permission - Permission to check\n * @returns true if user has permission\n *\n * @example\n * ```typescript\n * const result = await checkPermission(\"delete_jobs\");\n * if (!result.success || !result.data) {\n *   return { error: \"Access denied\" };\n * }\n * ```\n */\nasync function checkPermission(permission: Permission) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasPerm = await hasPermission(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t\tpermission,\n\t\t\tcompanyId,\n\t\t);\n\n\t\treturn hasPerm;\n\t});\n}\n\n/**\n * Check if current user has a specific role\n *\n * @param role - Role to check\n * @returns true if user has role\n *\n * @example\n * ```typescript\n * const result = await checkRole(\"manager\");\n * if (!result.success || !result.data) {\n *   redirect(\"/dashboard\");\n * }\n * ```\n */\nasync function checkRole(role: UserRole) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasRoleResult = await hasRole(supabase, user.id, role, companyId);\n\n\t\treturn hasRoleResult;\n\t});\n}\n\n/**\n * Check if current user is company owner\n *\n * @returns true if user is owner\n */\nasync function checkIsOwner() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\n\t\treturn isOwner;\n\t});\n}\n\n// ============================================================================\n// Mutation Actions\n// ============================================================================\n\n/**\n * Update team member's role\n * Only owners and admins can change roles\n *\n * @param input - Team member ID, new role, and optional reason\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberRole({\n *   teamMemberId: \"123...\",\n *   newRole: \"manager\",\n *   reason: \"Promoted to management\"\n * });\n * ```\n */\nasync function updateTeamMemberRole(input: z.infer<typeof updateRoleSchema>) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updateRoleSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission - only owners and admins can change roles\n\t\tconst canManageRoles =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManageRoles) {\n\t\t\tthrow new Error(\"Only owners and admins can change roles\");\n\t\t}\n\n\t\t// Get current role for audit log\n\t\tconst { data: currentMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"role\")\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!currentMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Update role\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ role: validated.newRole })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\t// Log role change\n\t\tawait supabase.from(\"role_change_log\").insert({\n\t\t\tteam_member_id: validated.teamMemberId,\n\t\t\tchanged_by: user.id,\n\t\t\told_role: currentMember.role,\n\t\t\tnew_role: validated.newRole,\n\t\t\treason: validated.reason,\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Update team member's custom permissions\n * Only owners and admins can change permissions\n *\n * @param input - Team member ID and permissions object\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberPermissions({\n *   teamMemberId: \"123...\",\n *   permissions: {\n *     \"delete_jobs\": true,\n *     \"approve_estimates\": true\n *   }\n * });\n * ```\n */\nasync function updateTeamMemberPermissions(\n\tinput: z.infer<typeof updatePermissionsSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updatePermissionsSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission\n\t\tconst canManagePermissions =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManagePermissions) {\n\t\t\tthrow new Error(\"Only owners and admins can change permissions\");\n\t\t}\n\n\t\t// Update permissions\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ permissions: validated.permissions })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Get team members with their roles\n *\n * @returns List of team members with roles\n */\nasync function getTeamMembersWithRoles() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        users (\n          id,\n          name,\n          email,\n          avatar\n        )\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n// ============================================================================\n// Owner Protection Actions\n// ============================================================================\n\n/**\n * Transfer company ownership to another team member\n * Requires password verification and extensive validation\n *\n * @param input - Transfer details including new owner, password, and reason\n * @returns Transfer ID for audit\n *\n * @example\n * ```typescript\n * const result = await transferOwnership({\n *   newOwnerId: \"user-uuid\",\n *   password: \"current-password\",\n *   reason: \"Retiring from business\"\n * });\n * ```\n */\nasync function transferOwnership(input: {\n\tnewOwnerId: string;\n\tpassword: string;\n\treason?: string;\n\tipAddress?: string;\n\tuserAgent?: string;\n}) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Verify user is current owner\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\t\tif (!isOwner) {\n\t\t\tthrow new Error(\"Only the current owner can transfer ownership\");\n\t\t}\n\n\t\t// Verify password\n\t\tconst { error: signInError } = await supabase.auth.signInWithPassword({\n\t\t\temail: user.email || \"\",\n\t\t\tpassword: input.password,\n\t\t});\n\n\t\tif (signInError) {\n\t\t\tthrow new Error(\"Password verification failed\");\n\t\t}\n\n\t\t// Call database function to transfer ownership\n\t\tconst { data: transferId, error } = await supabase.rpc(\n\t\t\t\"transfer_company_ownership\",\n\t\t\t{\n\t\t\t\tp_company_id: companyId,\n\t\t\t\tp_current_owner_id: user.id,\n\t\t\t\tp_new_owner_id: input.newOwnerId,\n\t\t\t\tp_reason: input.reason,\n\t\t\t\tp_ip_address: input.ipAddress,\n\t\t\t\tp_user_agent: input.userAgent,\n\t\t\t},\n\t\t);\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message || \"Failed to transfer ownership\");\n\t\t}\n\n\t\t// Revalidate all relevant paths\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard\");\n\n\t\treturn transferId;\n\t});\n}\n\n/**\n * Get ownership transfer history for the company\n * Shows audit trail of all ownership changes\n *\n * @returns List of ownership transfers\n */\nasync function getOwnershipTransferHistory() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\t// Only owners and admins can view transfer history\n\t\tconst canView =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canView) {\n\t\t\tthrow new Error(\"Only owners and admins can view transfer history\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"ownership_transfers\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        previous_owner:users!ownership_transfers_previous_owner_id_fkey(id, name, email),\n        new_owner:users!ownership_transfers_new_owner_id_fkey(id, name, email),\n        initiated_by_user:users!ownership_transfers_initiated_by_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n/**\n * Check if a team member can be deleted\n * Prevents deletion of company owner\n *\n * @param teamMemberId - Team member to check\n * @returns Object with canDelete boolean and reason if not allowed\n */\nexport async function canDeleteTeamMember(teamMemberId: string) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Get team member details\n\t\tconst { data: teamMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"user_id, role\")\n\t\t\t.eq(\"id\", teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error || !teamMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Check if user is company owner\n\t\tconst { data: company } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"owner_id\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (company && company.owner_id === teamMember.user_id) {\n\t\t\treturn {\n\t\t\t\tcanDelete: false,\n\t\t\t\treason:\n\t\t\t\t\t\"Cannot delete company owner. Transfer ownership first before removing this team member.\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tcanDelete: true,\n\t\t};\n\t});\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1660, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/.next-internal/server/app/_not-found/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getCurrentUserRole as '009c286914ac93fa18d3cac3814f6b0541c533da31'} from 'ACTIONS_MODULE0'\nexport {canDeleteTeamMember as '409e41270103fb45f1105fb5721c09fb5921f7de6f'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}