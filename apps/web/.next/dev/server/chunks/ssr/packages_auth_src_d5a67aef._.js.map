{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/auth/src/permissions.ts"],"sourcesContent":["/**\n * Permission System - Server-Side Utilities\n *\n * Provides type-safe permission checking for role-based access control (RBAC).\n * Uses database functions for secure, centralized permission logic.\n *\n * Performance optimizations:\n * - Database functions are cached by Postgres\n * - Single query permission checks\n * - Prepared statements for security\n *\n * @example\n * ```typescript\n * // Check if user can delete jobs\n * const canDelete = await hasPermission(supabase, userId, \"delete_jobs\", companyId);\n *\n * // Check if user has manager role\n * const isManager = await hasRole(supabase, userId, \"manager\", companyId);\n *\n * // Get user's role\n * const role = await getUserRole(supabase, userId, companyId);\n * ```\n */\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/**\n * User roles in the system\n * Matches the user_role ENUM in database\n */\nexport type UserRole =\n\t| \"owner\"\n\t| \"admin\"\n\t| \"manager\"\n\t| \"dispatcher\"\n\t| \"technician\"\n\t| \"csr\";\n\n/**\n * Permission keys for fine-grained access control\n */\nexport type Permission =\n\t// Manager permissions\n\t| \"view_reports\"\n\t| \"manage_team\"\n\t| \"approve_estimates\"\n\t| \"handle_escalations\"\n\t// Dispatcher permissions\n\t| \"dispatch_jobs\"\n\t| \"manage_schedule\"\n\t| \"view_tech_locations\"\n\t// Technician permissions\n\t| \"update_job_status\"\n\t| \"create_invoices\"\n\t| \"upload_photos\"\n\t// CSR permissions\n\t| \"create_jobs\"\n\t| \"schedule_appointments\"\n\t| \"send_communications\"\n\t// View permissions\n\t| \"view_customers\"\n\t| \"view_jobs\"\n\t| \"view_schedule\"\n\t// Delete permissions\n\t| \"delete_jobs\"\n\t| \"delete_customers\"\n\t| \"delete_team_members\";\n\n/**\n * Role configuration with permissions and metadata\n */\nexport type RoleConfig = {\n\tid: UserRole;\n\tlabel: string;\n\tdescription: string;\n\tpermissions: Permission[];\n\tdashboardFeatures: string[];\n};\n\n// ============================================================================\n// Role Definitions\n// ============================================================================\n\n/**\n * Complete role configurations with their permissions\n * Used for UI display and permission reference\n */\nconst ROLES: Record<UserRole, RoleConfig> = {\n\towner: {\n\t\tid: \"owner\",\n\t\tlabel: \"Owner\",\n\t\tdescription:\n\t\t\t\"Full system access with focus on business financials and growth\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t\t\"delete_customers\",\n\t\t\t\"delete_team_members\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"financial-overview\",\n\t\t\t\"profit-margins\",\n\t\t\t\"cash-flow\",\n\t\t\t\"business-growth\",\n\t\t\t\"payroll-overview\",\n\t\t\t\"all-reports\",\n\t\t],\n\t},\n\tadmin: {\n\t\tid: \"admin\",\n\t\tlabel: \"Admin\",\n\t\tdescription: \"System administration and configuration\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t\t\"delete_customers\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"system-settings\",\n\t\t\t\"user-management\",\n\t\t\t\"integrations\",\n\t\t\t\"audit-logs\",\n\t\t],\n\t},\n\tmanager: {\n\t\tid: \"manager\",\n\t\tlabel: \"Manager\",\n\t\tdescription:\n\t\t\t\"Oversee team performance, customer satisfaction, and operations\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"team-performance\",\n\t\t\t\"customer-satisfaction\",\n\t\t\t\"callback-queue\",\n\t\t\t\"review-alerts\",\n\t\t\t\"kpi-tracking\",\n\t\t\t\"inventory-management\",\n\t\t],\n\t},\n\tdispatcher: {\n\t\tid: \"dispatcher\",\n\t\tlabel: \"Dispatcher\",\n\t\tdescription:\n\t\t\t\"Manage technician schedules, job assignments, and real-time operations\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"dispatch-map\",\n\t\t\t\"technician-locations\",\n\t\t\t\"unassigned-jobs\",\n\t\t\t\"emergency-queue\",\n\t\t\t\"quick-dispatch\",\n\t\t\t\"tech-status\",\n\t\t],\n\t},\n\ttechnician: {\n\t\tid: \"technician\",\n\t\tlabel: \"Technician\",\n\t\tdescription:\n\t\t\t\"View assigned jobs, update job status, and track personal performance\",\n\t\tpermissions: [\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"my-schedule\",\n\t\t\t\"active-job\",\n\t\t\t\"my-earnings\",\n\t\t\t\"my-performance\",\n\t\t\t\"parts-inventory\",\n\t\t\t\"time-tracking\",\n\t\t],\n\t},\n\tcsr: {\n\t\tid: \"csr\",\n\t\tlabel: \"Customer Service Rep\",\n\t\tdescription:\n\t\t\t\"Handle customer calls, schedule appointments, and manage customer relationships\",\n\t\tpermissions: [\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"create_invoices\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"call-queue\",\n\t\t\t\"booking-calendar\",\n\t\t\t\"customer-search\",\n\t\t\t\"follow-up-queue\",\n\t\t\t\"estimate-pipeline\",\n\t\t\t\"call-scripts\",\n\t\t],\n\t},\n};\n\n// ============================================================================\n// Permission Check Functions\n// ============================================================================\n\n/**\n * Check if user has a specific role in a company\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param role - Role to check for\n * @param companyId - Company ID\n * @returns true if user has the role\n *\n * @example\n * ```typescript\n * const isManager = await hasRole(supabase, userId, \"manager\", companyId);\n * if (!isManager) {\n *   throw new Error(\"Access denied: Manager role required\");\n * }\n * ```\n */\nexport async function hasRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\trole: UserRole,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_role\", {\n\t\tuser_uuid: userId,\n\t\trequired_role: role,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Check if user has ANY of the specified roles\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param roles - Array of roles to check\n * @param companyId - Company ID\n * @returns true if user has any of the roles\n *\n * @example\n * ```typescript\n * const canManage = await hasAnyRole(\n *   supabase,\n *   userId,\n *   [\"owner\", \"manager\", \"admin\"],\n *   companyId\n * );\n * ```\n */\nasync function hasAnyRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\troles: UserRole[],\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_any_role\", {\n\t\tuser_uuid: userId,\n\t\trequired_roles: roles,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Get user's role in a company\n *\n * @param supabase - Supabase client\n * @param userId - User ID\n * @param companyId - Company ID\n * @returns User's role or null if not found\n *\n * @example\n * ```typescript\n * const role = await getUserRole(supabase, userId, companyId);\n * console.log(`User role: ${role}`); // \"manager\"\n * ```\n */\nexport async function getUserRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tcompanyId: string,\n): Promise<UserRole | null> {\n\tconst { data, error } = await supabase.rpc(\"get_user_role\", {\n\t\tuser_uuid: userId,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn null;\n\t}\n\n\treturn data as UserRole | null;\n}\n\n/**\n * Check if user has a specific permission\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param permission - Permission key to check\n * @param companyId - Company ID\n * @returns true if user has the permission\n *\n * @example\n * ```typescript\n * const canDelete = await hasPermission(supabase, userId, \"delete_jobs\", companyId);\n * if (!canDelete) {\n *   return { error: \"You don't have permission to delete jobs\" };\n * }\n * ```\n */\nexport async function hasPermission(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tpermission: Permission,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_permission\", {\n\t\tuser_uuid: userId,\n\t\tpermission_key: permission,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Check if user is the company owner\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param companyId - Company ID\n * @returns true if user is the owner\n *\n * @example\n * ```typescript\n * const isOwner = await isCompanyOwner(supabase, userId, companyId);\n * if (!isOwner) {\n *   throw new Error(\"Only company owner can perform this action\");\n * }\n * ```\n */\nexport async function isCompanyOwner(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"is_company_owner\", {\n\t\tuser_uuid: userId,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\n/**\n * Get all permissions for a role\n *\n * @param role - Role to get permissions for\n * @returns Array of permission keys\n *\n * @example\n * ```typescript\n * const managerPerms = getRolePermissions(\"manager\");\n * console.log(managerPerms); // [\"view_reports\", \"manage_team\", ...]\n * ```\n */\nfunction getRolePermissions(role: UserRole): Permission[] {\n\treturn ROLES[role]?.permissions || [];\n}\n\n/**\n * Check if a role has a specific permission (client-side check only)\n *\n * @param role - Role to check\n * @param permission - Permission to check for\n * @returns true if role has the permission\n *\n * @example\n * ```typescript\n * const canDelete = roleHasPermission(\"manager\", \"delete_jobs\");\n * ```\n */\nfunction roleHasPermission(\n\trole: UserRole,\n\tpermission: Permission,\n): boolean {\n\treturn ROLES[role]?.permissions.includes(permission);\n}\n\n/**\n * Get role configuration\n *\n * @param role - Role to get config for\n * @returns Role configuration\n *\n * @example\n * ```typescript\n * const config = getRoleConfig(\"manager\");\n * console.log(config.label); // \"Manager\"\n * ```\n */\nfunction getRoleConfig(role: UserRole): RoleConfig {\n\treturn ROLES[role];\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;CAsBC;;;;;;;;;;AA6DD,+EAA+E;AAC/E,mBAAmB;AACnB,+EAA+E;AAE/E;;;CAGC,GACD,MAAM,QAAsC;IAC3C,OAAO;QACN,IAAI;QACJ,OAAO;QACP,aACC;QACD,aAAa;YACZ;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACA;QACD,mBAAmB;YAClB;YACA;YACA;YACA;YACA;YACA;SACA;IACF;IACA,OAAO;QACN,IAAI;QACJ,OAAO;QACP,aAAa;QACb,aAAa;YACZ;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACA;QACD,mBAAmB;YAClB;YACA;YACA;YACA;SACA;IACF;IACA,SAAS;QACR,IAAI;QACJ,OAAO;QACP,aACC;QACD,aAAa;YACZ;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACA;QACD,mBAAmB;YAClB;YACA;YACA;YACA;YACA;YACA;SACA;IACF;IACA,YAAY;QACX,IAAI;QACJ,OAAO;QACP,aACC;QACD,aAAa;YACZ;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACA;QACD,mBAAmB;YAClB;YACA;YACA;YACA;YACA;YACA;SACA;IACF;IACA,YAAY;QACX,IAAI;QACJ,OAAO;QACP,aACC;QACD,aAAa;YACZ;YACA;YACA;YACA;YACA;YACA;SACA;QACD,mBAAmB;YAClB;YACA;YACA;YACA;YACA;YACA;SACA;IACF;IACA,KAAK;QACJ,IAAI;QACJ,OAAO;QACP,aACC;QACD,aAAa;YACZ;YACA;YACA;YACA;YACA;YACA;YACA;SACA;QACD,mBAAmB;YAClB;YACA;YACA;YACA;YACA;YACA;SACA;IACF;AACD;AAuBO,eAAe,QACrB,QAAwB,EACxB,MAAc,EACd,IAAc,EACd,SAAiB;IAEjB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,YAAY;QACtD,WAAW;QACX,eAAe;QACf,cAAc;IACf;IAEA,IAAI,OAAO;QACV,OAAO;IACR;IAEA,OAAO,SAAS;AACjB;AAEA;;;;;;;;;;;;;;;;;;CAkBC,GACD,eAAe,WACd,QAAwB,EACxB,MAAc,EACd,KAAiB,EACjB,SAAiB;IAEjB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,gBAAgB;QAC1D,WAAW;QACX,gBAAgB;QAChB,cAAc;IACf;IAEA,IAAI,OAAO;QACV,OAAO;IACR;IAEA,OAAO,SAAS;AACjB;AAgBO,eAAe,YACrB,QAAwB,EACxB,MAAc,EACd,SAAiB;IAEjB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,iBAAiB;QAC3D,WAAW;QACX,cAAc;IACf;IAEA,IAAI,OAAO;QACV,OAAO;IACR;IAEA,OAAO;AACR;AAmBO,eAAe,cACrB,QAAwB,EACxB,MAAc,EACd,UAAsB,EACtB,SAAiB;IAEjB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,kBAAkB;QAC5D,WAAW;QACX,gBAAgB;QAChB,cAAc;IACf;IAEA,IAAI,OAAO;QACV,OAAO;IACR;IAEA,OAAO,SAAS;AACjB;AAkBO,eAAe,eACrB,QAAwB,EACxB,MAAc,EACd,SAAiB;IAEjB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,oBAAoB;QAC9D,WAAW;QACX,cAAc;IACf;IAEA,IAAI,OAAO;QACV,OAAO;IACR;IAEA,OAAO,SAAS;AACjB;AAEA,+EAA+E;AAC/E,mBAAmB;AACnB,+EAA+E;AAE/E;;;;;;;;;;;CAWC,GACD,SAAS,mBAAmB,IAAc;IACzC,OAAO,KAAK,CAAC,KAAK,EAAE,eAAe,EAAE;AACtC;AAEA;;;;;;;;;;;CAWC,GACD,SAAS,kBACR,IAAc,EACd,UAAsB;IAEtB,OAAO,KAAK,CAAC,KAAK,EAAE,YAAY,SAAS;AAC1C;AAEA;;;;;;;;;;;CAWC,GACD,SAAS,cAAc,IAAc;IACpC,OAAO,KAAK,CAAC,KAAK;AACnB"}},
    {"offset": {"line": 330, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/auth/src/tokens.ts"],"sourcesContent":["/**\n * Authentication Token Utilities\n *\n * Features:\n * - Secure token generation for email verification\n * - Token storage and validation\n * - Expiration handling\n * - One-time use tokens\n *\n * Note: Uses Supabase directly instead of Drizzle ORM\n */\n\n\"use server\";\n\nimport { randomBytes } from \"node:crypto\";\nimport { createClient } from \"@stratos/database/server\";\n\n/**\n * Generate a secure random token\n */\nfunction generateSecureToken(): string {\n\t// Generate 32 bytes of random data and convert to hex string (64 characters)\n\treturn randomBytes(32).toString(\"hex\");\n}\n\n/**\n * Create an email verification token\n *\n * @param email - User's email address\n * @param userId - Optional user ID if already created\n * @param expiresInHours - Token expiration in hours (default: 24)\n */\nexport async function createEmailVerificationToken(\n\temail: string,\n\tuserId?: string,\n\texpiresInHours = 24,\n): Promise<{ token: string; expiresAt: Date }> {\n\tconst token = generateSecureToken();\n\tconst expiresAt = new Date(Date.now() + expiresInHours * 60 * 60 * 1000);\n\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\tthrow new Error(\"Supabase client not configured\");\n\t}\n\n\tconst { error } = await supabase.from(\"verification_tokens\").insert({\n\t\ttoken,\n\t\temail,\n\t\ttype: \"email_verification\",\n\t\tuser_id: userId,\n\t\texpires_at: expiresAt.toISOString(),\n\t\tused: false,\n\t});\n\n\tif (error) {\n\t\tthrow new Error(`Failed to create verification token: ${error.message}`);\n\t}\n\n\treturn { token, expiresAt };\n}\n\n/**\n * Create a password reset token\n *\n * @param email - User's email address\n * @param expiresInHours - Token expiration in hours (default: 1)\n */\nasync function createPasswordResetToken(\n\temail: string,\n\texpiresInHours = 1,\n): Promise<{ token: string; expiresAt: Date }> {\n\tconst token = generateSecureToken();\n\tconst expiresAt = new Date(Date.now() + expiresInHours * 60 * 60 * 1000);\n\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\tthrow new Error(\"Supabase client not configured\");\n\t}\n\n\tconst { error } = await supabase.from(\"verification_tokens\").insert({\n\t\ttoken,\n\t\temail,\n\t\ttype: \"password_reset\",\n\t\texpires_at: expiresAt.toISOString(),\n\t\tused: false,\n\t});\n\n\tif (error) {\n\t\tthrow new Error(`Failed to create password reset token: ${error.message}`);\n\t}\n\n\treturn { token, expiresAt };\n}\n\n/**\n * Create a magic link token\n *\n * @param email - User's email address\n * @param expiresInMinutes - Token expiration in minutes (default: 15)\n */\nasync function createMagicLinkToken(\n\temail: string,\n\texpiresInMinutes = 15,\n): Promise<{ token: string; expiresAt: Date }> {\n\tconst token = generateSecureToken();\n\tconst expiresAt = new Date(Date.now() + expiresInMinutes * 60 * 1000);\n\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\tthrow new Error(\"Supabase client not configured\");\n\t}\n\n\tconst { error } = await supabase.from(\"verification_tokens\").insert({\n\t\ttoken,\n\t\temail,\n\t\ttype: \"magic_link\",\n\t\texpires_at: expiresAt.toISOString(),\n\t\tused: false,\n\t});\n\n\tif (error) {\n\t\tthrow new Error(`Failed to create magic link token: ${error.message}`);\n\t}\n\n\treturn { token, expiresAt };\n}\n\n/**\n * Verify and consume a token\n *\n * @param token - The token to verify\n * @param type - Token type to verify\n * @returns Token data if valid, null if invalid/expired/used\n */\nexport async function verifyAndConsumeToken(\n\ttoken: string,\n\ttype: \"email_verification\" | \"password_reset\" | \"magic_link\",\n) {\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\tthrow new Error(\"Supabase client not configured\");\n\t}\n\tconst now = new Date().toISOString();\n\n\t// Find unused, non-expired token\n\tconst { data: tokenRecord, error: selectError } = await supabase\n\t\t.from(\"verification_tokens\")\n\t\t.select(\"*\")\n\t\t.eq(\"token\", token)\n\t\t.eq(\"type\", type)\n\t\t.eq(\"used\", false)\n\t\t.gt(\"expires_at\", now)\n\t\t.limit(1)\n\t\t.single();\n\n\tif (selectError || !tokenRecord) {\n\t\treturn null;\n\t}\n\n\t// Mark token as used\n\tconst { error: updateError } = await supabase\n\t\t.from(\"verification_tokens\")\n\t\t.update({\n\t\t\tused: true,\n\t\t\tused_at: now,\n\t\t})\n\t\t.eq(\"id\", tokenRecord.id);\n\n\tif (updateError) {\n\t\tthrow new Error(`Failed to consume token: ${updateError.message}`);\n\t}\n\n\treturn tokenRecord;\n}\n\n/**\n * Delete expired tokens (cleanup)\n */\nasync function cleanupExpiredTokens() {\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\tthrow new Error(\"Supabase client not configured\");\n\t}\n\tconst now = new Date().toISOString();\n\n\tconst { error } = await supabase\n\t\t.from(\"verification_tokens\")\n\t\t.delete()\n\t\t.lt(\"expires_at\", now);\n\n\tif (error) {\n\t\tthrow new Error(`Failed to cleanup expired tokens: ${error.message}`);\n\t}\n}\n\n/**\n * Delete all tokens for an email\n *\n * @param email - User's email address\n * @param type - Optional: specific token type to delete\n */\nasync function deleteTokensForEmail(\n\temail: string,\n\ttype?: \"email_verification\" | \"password_reset\" | \"magic_link\",\n) {\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\tthrow new Error(\"Supabase client not configured\");\n\t}\n\n\tlet query = supabase.from(\"verification_tokens\").delete().eq(\"email\", email);\n\n\tif (type) {\n\t\tquery = query.eq(\"type\", type);\n\t}\n\n\tconst { error } = await query;\n\n\tif (error) {\n\t\tthrow new Error(`Failed to delete tokens: ${error.message}`);\n\t}\n}\n"],"names":[],"mappings":"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"}}]
}