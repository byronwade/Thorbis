{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/auth/permissions.ts"],"sourcesContent":["// Re-export from @stratos/auth package for backwards compatibility\nexport * from \"@stratos/auth/permissions\";\n"],"names":[],"mappings":"AAAA,mEAAmE;;AACnE"}},
    {"offset": {"line": 12, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/errors/action-error.ts"],"sourcesContent":["/**\n * Action Error Class & Error Codes\n *\n * Provides standardized error handling for Server Actions with:\n * - Error codes for categorization\n * - HTTP status codes for API responses\n * - Detailed error messages\n * - Optional error details/context\n */\n\n/**\n * Error Code Constants\n *\n * Organized by category for easy management and consistent error handling\n */\nexport const ERROR_CODES = {\n\t// Authentication & Authorization\n\tAUTH_UNAUTHORIZED: \"AUTH_UNAUTHORIZED\",\n\tAUTH_FORBIDDEN: \"AUTH_FORBIDDEN\",\n\tAUTH_TOKEN_EXPIRED: \"AUTH_TOKEN_EXPIRED\",\n\tAUTH_TOKEN_INVALID: \"AUTH_TOKEN_INVALID\",\n\tAUTH_EMAIL_NOT_VERIFIED: \"AUTH_EMAIL_NOT_VERIFIED\",\n\n\t// Validation\n\tVALIDATION_FAILED: \"VALIDATION_FAILED\",\n\tVALIDATION_REQUIRED_FIELD: \"VALIDATION_REQUIRED_FIELD\",\n\tVALIDATION_INVALID_FORMAT: \"VALIDATION_INVALID_FORMAT\",\n\tVALIDATION_OUT_OF_RANGE: \"VALIDATION_OUT_OF_RANGE\",\n\n\t// Database\n\tDB_RECORD_NOT_FOUND: \"DB_RECORD_NOT_FOUND\",\n\tDB_DUPLICATE_ENTRY: \"DB_DUPLICATE_ENTRY\",\n\tDB_CONSTRAINT_VIOLATION: \"DB_CONSTRAINT_VIOLATION\",\n\tDB_FOREIGN_KEY_VIOLATION: \"DB_FOREIGN_KEY_VIOLATION\",\n\tDB_CONNECTION_ERROR: \"DB_CONNECTION_ERROR\",\n\tDB_QUERY_ERROR: \"DB_QUERY_ERROR\",\n\tDB_INSERT_ERROR: \"DB_INSERT_ERROR\",\n\tDB_UPDATE_ERROR: \"DB_UPDATE_ERROR\",\n\n\t// Business Logic\n\tBUSINESS_RULE_VIOLATION: \"BUSINESS_RULE_VIOLATION\",\n\tINSUFFICIENT_PERMISSIONS: \"INSUFFICIENT_PERMISSIONS\",\n\tOPERATION_NOT_ALLOWED: \"OPERATION_NOT_ALLOWED\",\n\tRESOURCE_LOCKED: \"RESOURCE_LOCKED\",\n\tRESOURCE_DELETED: \"RESOURCE_DELETED\",\n\n\t// External Services\n\tSERVICE_UNAVAILABLE: \"SERVICE_UNAVAILABLE\",\n\tSERVICE_TIMEOUT: \"SERVICE_TIMEOUT\",\n\tSERVICE_RATE_LIMIT: \"SERVICE_RATE_LIMIT\",\n\tSERVICE_INTEGRATION_ERROR: \"SERVICE_INTEGRATION_ERROR\",\n\tEXTERNAL_API_ERROR: \"EXTERNAL_API_ERROR\",\n\n\t// File Operations\n\tFILE_NOT_FOUND: \"FILE_NOT_FOUND\",\n\tFILE_TOO_LARGE: \"FILE_TOO_LARGE\",\n\tFILE_INVALID_TYPE: \"FILE_INVALID_TYPE\",\n\tFILE_UPLOAD_FAILED: \"FILE_UPLOAD_FAILED\",\n\n\t// Payment & Financial\n\tPAYMENT_FAILED: \"PAYMENT_FAILED\",\n\tPAYMENT_DECLINED: \"PAYMENT_DECLINED\",\n\tPAYMENT_INSUFFICIENT_FUNDS: \"PAYMENT_INSUFFICIENT_FUNDS\",\n\tPAYMENT_INVALID_AMOUNT: \"PAYMENT_INVALID_AMOUNT\",\n\tPAYMENT_ALREADY_REFUNDED: \"PAYMENT_ALREADY_REFUNDED\",\n\tPAYMENT_CANNOT_REFUND: \"PAYMENT_CANNOT_REFUND\",\n\n\t// Generic\n\tUNKNOWN_ERROR: \"UNKNOWN_ERROR\",\n\tINTERNAL_SERVER_ERROR: \"INTERNAL_SERVER_ERROR\",\n\tBAD_REQUEST: \"BAD_REQUEST\",\n\tNOT_IMPLEMENTED: \"NOT_IMPLEMENTED\",\n\tUNAUTHORIZED: \"UNAUTHORIZED\",\n\tNOT_FOUND: \"NOT_FOUND\",\n\tCONFLICT: \"CONFLICT\",\n\tEXPIRED: \"EXPIRED\",\n\tVALIDATION_ERROR: \"VALIDATION_ERROR\",\n} as const;\n\nexport type ErrorCode = (typeof ERROR_CODES)[keyof typeof ERROR_CODES];\n\n/**\n * Action Error Class\n *\n * Custom error class for Server Actions with additional context\n *\n * @example\n * throw new ActionError(\n *   \"Customer not found\",\n *   ERROR_CODES.DB_RECORD_NOT_FOUND,\n *   404,\n *   { customerId: \"123\" }\n * );\n */\nexport class ActionError extends Error {\n\tconstructor(\n\t\tmessage: string,\n\t\tpublic readonly code: ErrorCode = ERROR_CODES.UNKNOWN_ERROR,\n\t\tpublic readonly statusCode: number = 400,\n\t\tpublic readonly details?: Record<string, any>,\n\t) {\n\t\tsuper(message);\n\t\tthis.name = \"ActionError\";\n\n\t\t// Maintains proper stack trace for where error was thrown (V8 only)\n\t\tif (Error.captureStackTrace) {\n\t\t\tError.captureStackTrace(this, ActionError);\n\t\t}\n\t}\n\n\t/**\n\t * Convert error to a plain object suitable for API responses\n\t */\n\ttoJSON() {\n\t\treturn {\n\t\t\tsuccess: false as const,\n\t\t\terror: this.message,\n\t\t\tcode: this.code,\n\t\t\tstatusCode: this.statusCode,\n\t\t\t...(this.details && { details: this.details }),\n\t\t};\n\t}\n\n\t/**\n\t * Create ActionError from unknown error\n\t */\n\tstatic fromUnknown(error: unknown): ActionError {\n\t\tif (error instanceof ActionError) {\n\t\t\treturn error;\n\t\t}\n\n\t\tif (error instanceof Error) {\n\t\t\treturn new ActionError(\n\t\t\t\terror.message,\n\t\t\t\tERROR_CODES.INTERNAL_SERVER_ERROR,\n\t\t\t\t500,\n\t\t\t);\n\t\t}\n\n\t\treturn new ActionError(\n\t\t\t\"An unexpected error occurred\",\n\t\t\tERROR_CODES.UNKNOWN_ERROR,\n\t\t\t500,\n\t\t);\n\t}\n}\n\n/**\n * Error Message Helpers\n *\n * Consistent error messages for common scenarios\n */\nexport const ERROR_MESSAGES = {\n\t// Authentication\n\tunauthorized: () => \"You must be logged in to perform this action\",\n\tforbidden: (resource: string) =>\n\t\t`You don't have permission to access this ${resource}`,\n\temailNotVerified: () => \"Please verify your email before continuing\",\n\n\t// Validation\n\trequiredField: (field: string) => `${field} is required`,\n\tinvalidFormat: (field: string) => `${field} has an invalid format`,\n\toutOfRange: (field: string, min: number, max: number) =>\n\t\t`${field} must be between ${min} and ${max}`,\n\n\t// Database\n\tnotFound: (resource: string) => `${resource} not found`,\n\talreadyExists: (resource: string) => `${resource} already exists`,\n\tcannotDelete: (resource: string, reason: string) =>\n\t\t`Cannot delete ${resource}: ${reason}`,\n\n\t// Business Logic\n\tinsufficientFunds: () => \"Insufficient funds for this transaction\",\n\tcannotRefund: (reason: string) => `Cannot process refund: ${reason}`,\n\tresourceLocked: (resource: string) =>\n\t\t`${resource} is currently being modified by another user`,\n\n\t// Generic\n\toperationFailed: (operation: string) => `Failed to ${operation}`,\n\tserviceUnavailable: (service: string) =>\n\t\t`${service} is currently unavailable`,\n} as const;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 150, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/errors/with-error-handling.ts"],"sourcesContent":["/**\n * Error Handling Wrapper for Server Actions\n *\n * Provides consistent error handling, logging, and response formatting\n * for all Server Actions in the application.\n */\n\nimport { ZodError } from \"zod\";\nimport { ActionError, ERROR_CODES } from \"./action-error\";\n\n// Re-export for convenience\nexport { ActionError, ERROR_CODES } from \"./action-error\";\n\n/**\n * Standard Action Result Type\n *\n * All Server Actions should return this type for consistency\n */\nexport type ActionResult<T = void> =\n\t| {\n\t\t\tsuccess: true;\n\t\t\tdata: T;\n\t\t\tmessage?: string;\n\t\t\terror?: string;\n\t  }\n\t| {\n\t\t\tsuccess: false;\n\t\t\terror: string;\n\t\t\tcode?: string;\n\t\t\tdetails?: Record<string, any>;\n\t  };\n\n/**\n * Wrap Server Action with Error Handling\n *\n * Automatically handles errors and returns a consistent ActionResult format.\n * Logs errors appropriately and provides detailed error information in development.\n *\n * @example\n * export async function createCustomer(data: CustomerInsert) {\n *   return withErrorHandling(async () => {\n *     const validated = customerInsertSchema.parse(data);\n *     const supabase = await createClient();\n *\n *     const { data: customer, error } = await supabase\n *       .from(\"customers\")\n *       .insert(validated)\n *       .select()\n *       .single();\n *\n *     if (error) {\n *       throw new ActionError(error.message, ERROR_CODES.DB_QUERY_ERROR);\n *     }\n *\n *     return customer;\n *   });\n * }\n */\nexport async function withErrorHandling<T>(\n\tfn: () => Promise<T>,\n): Promise<ActionResult<T>> {\n\ttry {\n\t\tconst data = await fn();\n\t\treturn { success: true, data };\n\t} catch (error) {\n\t\t// Handle ActionError (our custom errors)\n\t\tif (error instanceof ActionError) {\n\t\t\t// Log authorization errors as warnings since they're expected in some cases\n\t\t\t// (e.g., user not part of a company, insufficient permissions)\n\t\t\tconst isExpectedAuthError =\n\t\t\t\terror.code === ERROR_CODES.AUTH_FORBIDDEN ||\n\t\t\t\terror.code === ERROR_CODES.AUTH_UNAUTHORIZED;\n\n\t\t\tif (isExpectedAuthError) {\n\t\t\t\t// Only log in development, or as a warning\n\t\t\t\tif (process.env.NODE_ENV === \"development\") {\n\t\t\t\t\tconsole.debug(`[Auth] Expected auth error: ${error.code} - ${error.message}`);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconsole.error(`[Action Error] ${error.code}: ${error.message}`);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.message,\n\t\t\t\tcode: error.code,\n\t\t\t\t...(error.details && { details: error.details }),\n\t\t\t};\n\t\t}\n\n\t\t// Handle Zod validation errors\n\t\tif (error instanceof ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.issues[0]?.message || \"Validation failed\",\n\t\t\t\tcode: ERROR_CODES.VALIDATION_FAILED,\n\t\t\t\tdetails: {\n\t\t\t\t\tissues: error.issues.map((issue) => ({\n\t\t\t\t\t\tfield: issue.path.join(\".\"),\n\t\t\t\t\t\tmessage: issue.message,\n\t\t\t\t\t})),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t// Handle standard JavaScript errors\n\t\tif (error instanceof Error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\tprocess.env.NODE_ENV === \"development\"\n\t\t\t\t\t\t? error.message\n\t\t\t\t\t\t: \"An unexpected error occurred\",\n\t\t\t\tcode: ERROR_CODES.INTERNAL_SERVER_ERROR,\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"An unexpected error occurred\",\n\t\t\tcode: ERROR_CODES.UNKNOWN_ERROR,\n\t\t};\n\t}\n}\n\n/**\n * Create a success result\n *\n * Helper to create consistent success responses\n */\nfunction successResult<T>(data: T, message?: string): ActionResult<T> {\n\treturn {\n\t\tsuccess: true,\n\t\tdata,\n\t\t...(message && { message }),\n\t};\n}\n\n/**\n * Create an error result\n *\n * Helper to create consistent error responses\n */\nfunction errorResult(\n\terror: string,\n\tcode?: string,\n\tdetails?: Record<string, any>,\n): ActionResult<never> {\n\treturn {\n\t\tsuccess: false,\n\t\terror,\n\t\t...(code && { code }),\n\t\t...(details && { details }),\n\t};\n}\n\n/**\n * Assert Supabase client is available\n *\n * Helper to check if Supabase client exists and throw ActionError if not\n */\nexport function assertSupabase<T>(\n\tsupabase: T | null | undefined,\n): asserts supabase is T {\n\tif (!supabase) {\n\t\tthrow new ActionError(\n\t\t\t\"Database connection failed\",\n\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t500,\n\t\t);\n\t}\n}\n\n/**\n * Assert user is authenticated\n *\n * Helper to check authentication and throw ActionError if not authenticated\n */\nexport function assertAuthenticated(\n\tuserId: string | undefined,\n): asserts userId is string {\n\tif (!userId) {\n\t\tthrow new ActionError(\n\t\t\t\"You must be logged in to perform this action\",\n\t\t\tERROR_CODES.AUTH_UNAUTHORIZED,\n\t\t\t401,\n\t\t);\n\t}\n}\n\n/**\n * Assert resource exists\n *\n * Helper to check if resource exists and throw ActionError if not\n */\nexport function assertExists<T>(\n\tresource: T | null | undefined,\n\tresourceName: string,\n): asserts resource is T {\n\tif (!resource) {\n\t\tthrow new ActionError(\n\t\t\t`${resourceName} not found`,\n\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t404,\n\t\t);\n\t}\n}\n\n/**\n * Assert user has permission\n *\n * Helper to check permissions and throw ActionError if not authorized\n */\nfunction assertPermission(\n\thasPermission: boolean,\n\tresourceName: string,\n): asserts hasPermission {\n\tif (!hasPermission) {\n\t\tthrow new ActionError(\n\t\t\t`You don't have permission to access this ${resourceName}`,\n\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t403,\n\t\t);\n\t}\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;;;AAED;AACA;;;;AAkDO,eAAe,kBACrB,EAAoB;IAEpB,IAAI;QACH,MAAM,OAAO,MAAM;QACnB,OAAO;YAAE,SAAS;YAAM;QAAK;IAC9B,EAAE,OAAO,OAAO;QACf,yCAAyC;QACzC,IAAI,iBAAiB,qKAAW,EAAE;YACjC,4EAA4E;YAC5E,+DAA+D;YAC/D,MAAM,sBACL,MAAM,IAAI,KAAK,qKAAW,CAAC,cAAc,IACzC,MAAM,IAAI,KAAK,qKAAW,CAAC,iBAAiB;YAE7C,IAAI,qBAAqB;gBACxB,2CAA2C;gBAC3C,wCAA4C;oBAC3C,QAAQ,KAAK,CAAC,CAAC,4BAA4B,EAAE,MAAM,IAAI,CAAC,GAAG,EAAE,MAAM,OAAO,EAAE;gBAC7E;YACD,OAAO;gBACN,QAAQ,KAAK,CAAC,CAAC,eAAe,EAAE,MAAM,IAAI,CAAC,EAAE,EAAE,MAAM,OAAO,EAAE;YAC/D;YAEA,OAAO;gBACN,SAAS;gBACT,OAAO,MAAM,OAAO;gBACpB,MAAM,MAAM,IAAI;gBAChB,GAAI,MAAM,OAAO,IAAI;oBAAE,SAAS,MAAM,OAAO;gBAAC,CAAC;YAChD;QACD;QAEA,+BAA+B;QAC/B,IAAI,iBAAiB,2MAAQ,EAAE;YAC9B,OAAO;gBACN,SAAS;gBACT,OAAO,MAAM,MAAM,CAAC,EAAE,EAAE,WAAW;gBACnC,MAAM,qKAAW,CAAC,iBAAiB;gBACnC,SAAS;oBACR,QAAQ,MAAM,MAAM,CAAC,GAAG,CAAC,CAAC,QAAU,CAAC;4BACpC,OAAO,MAAM,IAAI,CAAC,IAAI,CAAC;4BACvB,SAAS,MAAM,OAAO;wBACvB,CAAC;gBACF;YACD;QACD;QAEA,oCAAoC;QACpC,IAAI,iBAAiB,OAAO;YAC3B,OAAO;gBACN,SAAS;gBACT,OACC,uCACG,MAAM,OAAO,GACb;gBACJ,MAAM,qKAAW,CAAC,qBAAqB;YACxC;QACD;QACA,OAAO;YACN,SAAS;YACT,OAAO;YACP,MAAM,qKAAW,CAAC,aAAa;QAChC;IACD;AACD;AAEA;;;;CAIC,GACD,SAAS,cAAiB,IAAO,EAAE,OAAgB;IAClD,OAAO;QACN,SAAS;QACT;QACA,GAAI,WAAW;YAAE;QAAQ,CAAC;IAC3B;AACD;AAEA;;;;CAIC,GACD,SAAS,YACR,KAAa,EACb,IAAa,EACb,OAA6B;IAE7B,OAAO;QACN,SAAS;QACT;QACA,GAAI,QAAQ;YAAE;QAAK,CAAC;QACpB,GAAI,WAAW;YAAE;QAAQ,CAAC;IAC3B;AACD;AAOO,SAAS,eACf,QAA8B;IAE9B,IAAI,CAAC,UAAU;QACd,MAAM,IAAI,qKAAW,CACpB,8BACA,qKAAW,CAAC,mBAAmB,EAC/B;IAEF;AACD;AAOO,SAAS,oBACf,MAA0B;IAE1B,IAAI,CAAC,QAAQ;QACZ,MAAM,IAAI,qKAAW,CACpB,gDACA,qKAAW,CAAC,iBAAiB,EAC7B;IAEF;AACD;AAOO,SAAS,aACf,QAA8B,EAC9B,YAAoB;IAEpB,IAAI,CAAC,UAAU;QACd,MAAM,IAAI,qKAAW,CACpB,GAAG,aAAa,UAAU,CAAC,EAC3B,qKAAW,CAAC,mBAAmB,EAC/B;IAEF;AACD;AAEA;;;;CAIC,GACD,SAAS,iBACR,aAAsB,EACtB,YAAoB;IAEpB,IAAI,CAAC,eAAe;QACnB,MAAM,IAAI,qKAAW,CACpB,CAAC,yCAAyC,EAAE,cAAc,EAC1D,qKAAW,CAAC,cAAc,EAC1B;IAEF;AACD"}},
    {"offset": {"line": 286, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/deliverability-monitor.ts"],"sourcesContent":["\"use server\";\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\n/**\n * Deliverability Monitor for Multi-Tenant Email System\n *\n * Features:\n * - Track delivery events (delivered, bounced, complained)\n * - Update domain reputation scores\n * - Auto-suspend domains with poor reputation\n * - Generate deliverability reports\n */\n\nexport type DeliveryEventType =\n\t| \"delivered\"\n\t| \"bounced\"\n\t| \"soft_bounce\"\n\t| \"complained\"\n\t| \"opened\"\n\t| \"clicked\";\n\nexport interface DeliveryEvent {\n\tdomainId: string;\n\teventType: DeliveryEventType;\n\temailId?: string;\n\tmetadata?: Record<string, any>;\n}\n\nexport interface DomainHealth {\n\tdomainId: string;\n\tdomain: string;\n\treputationScore: number;\n\tbounceRate: number;\n\tcomplaintRate: number;\n\tdeliveryRate: number;\n\tstatus: \"healthy\" | \"warning\" | \"critical\" | \"suspended\";\n\ttotalEmailsSent: number;\n\thardBounces: number;\n\tsoftBounces: number;\n\tcomplaints: number;\n\tlastHealthCheck: string | null;\n}\n\n/**\n * Record a delivery event and update domain metrics\n */\nexport async function recordDeliveryEvent(\n\tevent: DeliveryEvent\n): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Use the database function to update reputation\n\tconst { error } = await supabase.rpc(\"update_domain_reputation\", {\n\t\tp_domain_id: event.domainId,\n\t\tp_event_type: event.eventType,\n\t});\n\n\tif (error) {\n\t\tconsole.error(\"Error recording delivery event:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Process Resend webhook events for deliverability tracking\n */\nexport async function processResendWebhookEvent(webhookData: {\n\ttype: string;\n\tdata: {\n\t\temail_id?: string;\n\t\tfrom?: string;\n\t\tto?: string[];\n\t\tsubject?: string;\n\t\tcreated_at?: string;\n\t\t[key: string]: any;\n\t};\n}): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Map Resend event types to our event types\n\tconst eventTypeMap: Record<string, DeliveryEventType | null> = {\n\t\t\"email.delivered\": \"delivered\",\n\t\t\"email.bounced\": \"bounced\",\n\t\t\"email.complained\": \"complained\",\n\t\t\"email.opened\": \"opened\",\n\t\t\"email.clicked\": \"clicked\",\n\t\t// Soft bounces might come as delivery_delayed in some providers\n\t\t\"email.delivery_delayed\": \"soft_bounce\",\n\t};\n\n\tconst eventType = eventTypeMap[webhookData.type];\n\tif (!eventType) {\n\t\t// Not a delivery event we track\n\t\treturn { success: true };\n\t}\n\n\t// Extract domain from the \"from\" address\n\tconst fromEmail = webhookData.data.from;\n\tif (!fromEmail) {\n\t\treturn { success: true };\n\t}\n\n\tconst domain = fromEmail.includes(\"@\")\n\t\t? fromEmail.split(\"@\")[1]\n\t\t: fromEmail;\n\n\t// Look up the domain in our database\n\tconst { data: domainRecord } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"id\")\n\t\t.eq(\"domain_name\", domain)\n\t\t.maybeSingle();\n\n\tif (!domainRecord) {\n\t\t// Domain not found in our system\n\t\treturn { success: true };\n\t}\n\n\t// Record the event\n\treturn recordDeliveryEvent({\n\t\tdomainId: domainRecord.id,\n\t\teventType,\n\t\temailId: webhookData.data.email_id,\n\t\tmetadata: webhookData.data,\n\t});\n}\n\n/**\n * Get domain health status\n */\nexport async function getDomainHealth(\n\tdomainId: string\n): Promise<DomainHealth | null> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data, error } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\n\t\t\t\"id, domain_name, reputation_score, bounce_rate, total_emails_sent, hard_bounces, soft_bounces, spam_complaints, is_suspended, last_health_check\"\n\t\t)\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (error || !data) {\n\t\treturn null;\n\t}\n\n\tconst totalEvents =\n\t\tdata.total_emails_sent + data.hard_bounces + data.soft_bounces;\n\tconst bounceRate =\n\t\ttotalEvents > 0\n\t\t\t? ((data.hard_bounces + data.soft_bounces) / totalEvents) * 100\n\t\t\t: 0;\n\tconst complaintRate =\n\t\tdata.total_emails_sent > 0\n\t\t\t? (data.spam_complaints / data.total_emails_sent) * 100\n\t\t\t: 0;\n\tconst deliveryRate =\n\t\ttotalEvents > 0 ? (data.total_emails_sent / totalEvents) * 100 : 100;\n\n\tlet status: DomainHealth[\"status\"] = \"healthy\";\n\tif (data.is_suspended) {\n\t\tstatus = \"suspended\";\n\t} else if (data.reputation_score < 30 || bounceRate > 10 || complaintRate > 0.5) {\n\t\tstatus = \"critical\";\n\t} else if (data.reputation_score < 60 || bounceRate > 5 || complaintRate > 0.2) {\n\t\tstatus = \"warning\";\n\t}\n\n\treturn {\n\t\tdomainId: data.id,\n\t\tdomain: data.domain_name,\n\t\treputationScore: Number(data.reputation_score),\n\t\tbounceRate: Number(bounceRate.toFixed(2)),\n\t\tcomplaintRate: Number(complaintRate.toFixed(3)),\n\t\tdeliveryRate: Number(deliveryRate.toFixed(2)),\n\t\tstatus,\n\t\ttotalEmailsSent: data.total_emails_sent,\n\t\thardBounces: data.hard_bounces,\n\t\tsoftBounces: data.soft_bounces,\n\t\tcomplaints: data.spam_complaints,\n\t\tlastHealthCheck: data.last_health_check,\n\t};\n}\n\n/**\n * Get all domains health for a company\n */\nexport async function getCompanyDomainsHealth(\n\tcompanyId: string\n): Promise<DomainHealth[]> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data, error } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\n\t\t\t\"id, domain_name, reputation_score, bounce_rate, total_emails_sent, hard_bounces, soft_bounces, spam_complaints, is_suspended, last_health_check\"\n\t\t)\n\t\t.eq(\"company_id\", companyId);\n\n\tif (error || !data) {\n\t\treturn [];\n\t}\n\n\treturn data.map((d) => {\n\t\tconst totalEvents = d.total_emails_sent + d.hard_bounces + d.soft_bounces;\n\t\tconst bounceRate =\n\t\t\ttotalEvents > 0 ? ((d.hard_bounces + d.soft_bounces) / totalEvents) * 100 : 0;\n\t\tconst complaintRate =\n\t\t\td.total_emails_sent > 0 ? (d.spam_complaints / d.total_emails_sent) * 100 : 0;\n\t\tconst deliveryRate =\n\t\t\ttotalEvents > 0 ? (d.total_emails_sent / totalEvents) * 100 : 100;\n\n\t\tlet status: DomainHealth[\"status\"] = \"healthy\";\n\t\tif (d.is_suspended) {\n\t\t\tstatus = \"suspended\";\n\t\t} else if (d.reputation_score < 30 || bounceRate > 10 || complaintRate > 0.5) {\n\t\t\tstatus = \"critical\";\n\t\t} else if (d.reputation_score < 60 || bounceRate > 5 || complaintRate > 0.2) {\n\t\t\tstatus = \"warning\";\n\t\t}\n\n\t\treturn {\n\t\t\tdomainId: d.id,\n\t\t\tdomain: d.domain_name,\n\t\t\treputationScore: Number(d.reputation_score),\n\t\t\tbounceRate: Number(bounceRate.toFixed(2)),\n\t\t\tcomplaintRate: Number(complaintRate.toFixed(3)),\n\t\t\tdeliveryRate: Number(deliveryRate.toFixed(2)),\n\t\t\tstatus,\n\t\t\ttotalEmailsSent: d.total_emails_sent,\n\t\t\thardBounces: d.hard_bounces,\n\t\t\tsoftBounces: d.soft_bounces,\n\t\t\tcomplaints: d.spam_complaints,\n\t\t\tlastHealthCheck: d.last_health_check,\n\t\t};\n\t});\n}\n\n/**\n * Run health check on all domains and update status\n */\nexport async function runHealthCheckForAllDomains(): Promise<{\n\tchecked: number;\n\tsuspended: number;\n\twarnings: number;\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Get all active domains\n\tconst { data: domains } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"id, reputation_score, hard_bounces, soft_bounces, spam_complaints, total_emails_sent\")\n\t\t.eq(\"is_suspended\", false);\n\n\tif (!domains) {\n\t\treturn { checked: 0, suspended: 0, warnings: 0 };\n\t}\n\n\tlet suspended = 0;\n\tlet warnings = 0;\n\n\tfor (const domain of domains) {\n\t\tconst totalEvents =\n\t\t\tdomain.total_emails_sent + domain.hard_bounces + domain.soft_bounces;\n\t\tconst bounceRate =\n\t\t\ttotalEvents > 100\n\t\t\t\t? ((domain.hard_bounces + domain.soft_bounces) / totalEvents) * 100\n\t\t\t\t: 0;\n\t\tconst complaintRate =\n\t\t\tdomain.total_emails_sent > 100\n\t\t\t\t? (domain.spam_complaints / domain.total_emails_sent) * 100\n\t\t\t\t: 0;\n\n\t\t// Auto-suspend if reputation is critical\n\t\tif (domain.reputation_score < 20 || bounceRate > 15 || complaintRate > 1) {\n\t\t\tawait supabase\n\t\t\t\t.from(\"company_email_domains\")\n\t\t\t\t.update({\n\t\t\t\t\tis_suspended: true,\n\t\t\t\t\tsuspension_reason: `Auto-suspended: Reputation ${domain.reputation_score}, Bounce rate ${bounceRate.toFixed(1)}%, Complaint rate ${complaintRate.toFixed(2)}%`,\n\t\t\t\t\tsuspended_at: new Date().toISOString(),\n\t\t\t\t\tlast_health_check: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", domain.id);\n\t\t\tsuspended++;\n\t\t} else if (domain.reputation_score < 50 || bounceRate > 8 || complaintRate > 0.3) {\n\t\t\t// Update health check timestamp for warning domains\n\t\t\tawait supabase\n\t\t\t\t.from(\"company_email_domains\")\n\t\t\t\t.update({ last_health_check: new Date().toISOString() })\n\t\t\t\t.eq(\"id\", domain.id);\n\t\t\twarnings++;\n\t\t} else {\n\t\t\t// Healthy, just update timestamp\n\t\t\tawait supabase\n\t\t\t\t.from(\"company_email_domains\")\n\t\t\t\t.update({ last_health_check: new Date().toISOString() })\n\t\t\t\t.eq(\"id\", domain.id);\n\t\t}\n\t}\n\n\treturn {\n\t\tchecked: domains.length,\n\t\tsuspended,\n\t\twarnings,\n\t};\n}\n\n/**\n * Generate deliverability report for a domain\n */\nexport async function generateDeliverabilityReport(domainId: string): Promise<{\n\tdomain: string;\n\tperiod: { start: string; end: string };\n\tmetrics: {\n\t\ttotalSent: number;\n\t\tdelivered: number;\n\t\tbounced: number;\n\t\tcomplained: number;\n\t\tdeliveryRate: number;\n\t\tbounceRate: number;\n\t\tcomplaintRate: number;\n\t};\n\treputation: {\n\t\tcurrent: number;\n\t\tchange: number;\n\t\tstatus: string;\n\t};\n\trecommendations: string[];\n} | null> {\n\tconst health = await getDomainHealth(domainId);\n\tif (!health) {\n\t\treturn null;\n\t}\n\n\tconst recommendations: string[] = [];\n\n\tif (health.bounceRate > 5) {\n\t\trecommendations.push(\n\t\t\t\"High bounce rate detected. Clean your email list and remove invalid addresses.\"\n\t\t);\n\t}\n\n\tif (health.complaintRate > 0.1) {\n\t\trecommendations.push(\n\t\t\t\"Spam complaints detected. Ensure recipients have opted in and make unsubscribe easy.\"\n\t\t);\n\t}\n\n\tif (health.reputationScore < 70) {\n\t\trecommendations.push(\n\t\t\t\"Reputation score is below optimal. Reduce sending volume temporarily and focus on engagement.\"\n\t\t);\n\t}\n\n\tif (health.status === \"warning\" || health.status === \"critical\") {\n\t\trecommendations.push(\n\t\t\t\"Domain health is degraded. Review your email content and sending practices.\"\n\t\t);\n\t}\n\n\tif (recommendations.length === 0) {\n\t\trecommendations.push(\n\t\t\t\"Domain health is good. Continue monitoring and maintain current practices.\"\n\t\t);\n\t}\n\n\treturn {\n\t\tdomain: health.domain,\n\t\tperiod: {\n\t\t\tstart: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),\n\t\t\tend: new Date().toISOString(),\n\t\t},\n\t\tmetrics: {\n\t\t\ttotalSent: health.totalEmailsSent,\n\t\t\tdelivered: health.totalEmailsSent - health.hardBounces,\n\t\t\tbounced: health.hardBounces + health.softBounces,\n\t\t\tcomplained: health.complaints,\n\t\t\tdeliveryRate: health.deliveryRate,\n\t\t\tbounceRate: health.bounceRate,\n\t\t\tcomplaintRate: health.complaintRate,\n\t\t},\n\t\treputation: {\n\t\t\tcurrent: health.reputationScore,\n\t\t\tchange: 0, // Would need historical data to calculate\n\t\t\tstatus: health.status,\n\t\t},\n\t\trecommendations,\n\t};\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 542, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/email-types.ts"],"sourcesContent":["/**\n * Email Types - Type definitions for email templates\n *\n * Features:\n * - Type-safe email data\n * - Template props interfaces\n * - Email send result types\n * - Validation schemas\n */\n\nimport { z } from \"zod\";\n\n// Email send result type\nexport type EmailSendResult = {\n\tsuccess: boolean;\n\terror?: string;\n\tdata?: {\n\t\tid?: string;\n\t\tmessage?: string;\n\t};\n};\n\n// Company branding for tenant emails\nexport type CompanyBranding = {\n\tcompanyName: string;\n\tlogoUrl?: string;\n\tprimaryColor?: string;\n\tsupportEmail?: string;\n\tsupportPhone?: string;\n\twebsiteUrl?: string;\n\taddress?: string;\n};\n\n// Base email template props\nexport type BaseEmailProps = {\n\tpreviewText?: string;\n\tcompanyName?: string; // Deprecated - use company.companyName\n\tcompany?: CompanyBranding; // For company-branded emails\n};\n\n// Authentication Email Props\nexport interface WelcomeEmailProps extends BaseEmailProps {\n\tname: string;\n\tloginUrl: string;\n}\n\nexport interface EmailVerificationProps extends BaseEmailProps {\n\tname: string;\n\tverificationUrl: string;\n}\n\nexport interface PasswordResetProps extends BaseEmailProps {\n\tname?: string;\n\tresetUrl: string;\n\texpiresInMinutes?: number;\n}\n\nexport interface PasswordChangedProps extends BaseEmailProps {\n\tname: string;\n\tchangedAt: Date;\n}\n\nexport interface MagicLinkProps extends BaseEmailProps {\n\tloginUrl: string;\n\texpiresInMinutes?: number;\n}\n\n// Job Lifecycle Email Props\nexport interface JobConfirmationProps extends BaseEmailProps {\n\tcustomerName: string;\n\tjobDate: string;\n\tjobTime: string;\n\ttechnicianName: string;\n\tjobType: string;\n\taddress: string;\n\tjobNumber: string;\n\tviewJobUrl: string;\n}\n\nexport interface AppointmentReminderProps extends BaseEmailProps {\n\tcustomerName: string;\n\tappointmentDate: string;\n\tappointmentTime: string;\n\ttechnicianName: string;\n\taddress: string;\n\trescheduleUrl: string;\n}\n\nexport interface TechEnRouteProps extends BaseEmailProps {\n\tcustomerName: string;\n\ttechnicianName: string;\n\testimatedArrival: string;\n\ttechnicianPhoto?: string;\n\ttrackingUrl?: string;\n}\n\nexport interface JobCompleteProps extends BaseEmailProps {\n\tcustomerName: string;\n\tjobNumber: string;\n\tcompletedDate: string;\n\ttotalAmount: string;\n\tinvoiceUrl: string;\n\treviewUrl: string;\n}\n\n// Billing Email Props\nexport interface InvoiceSentProps extends BaseEmailProps {\n\tcustomerName: string;\n\tinvoiceNumber: string;\n\ttotalAmount: string;\n\tdueDate: string;\n\titems: Array<{\n\t\tdescription: string;\n\t\tquantity: number;\n\t\tamount: string;\n\t}>;\n\tpaymentUrl: string;\n\tdownloadUrl: string;\n}\n\nexport interface InvoiceNotificationProps extends BaseEmailProps {\n\tcustomerName: string;\n\tinvoiceNumber: string;\n\tinvoiceDate: string;\n\tdueDate?: string;\n\ttotalAmount: number; // in cents\n\tinvoiceUrl: string;\n\tcurrency?: string;\n\titems?: Array<{\n\t\tdescription: string;\n\t\tquantity: number;\n\t\tamount: number; // in cents\n\t}>;\n\tnotes?: string;\n\tpaymentLink?: string; // Secure payment portal link\n\tcustomBody?: string; // Custom email body from template\n\tcustomFooter?: string; // Custom email footer from template\n}\n\nexport interface EstimateNotificationProps extends BaseEmailProps {\n\tcustomerName: string;\n\testimateNumber: string;\n\testimateDate: string;\n\tvalidUntil?: string;\n\ttotalAmount: number; // in cents\n\testimateUrl: string;\n\tcurrency?: string;\n\titems?: Array<{\n\t\tdescription: string;\n\t\tquantity: number;\n\t\tamount: number; // in cents\n\t}>;\n\tnotes?: string;\n}\n\nexport interface PaymentReceivedProps extends BaseEmailProps {\n\tcustomerName: string;\n\tinvoiceNumber: string;\n\tpaymentAmount: string;\n\tpaymentMethod: string;\n\tpaymentDate: string;\n\treceiptUrl: string;\n}\n\nexport interface PaymentReminderProps extends BaseEmailProps {\n\tcustomerName: string;\n\tinvoiceNumber: string;\n\ttotalAmount: string;\n\tdueDate: string;\n\tdaysOverdue: number;\n\tpaymentUrl: string;\n}\n\nexport interface EstimateSentProps extends BaseEmailProps {\n\tcustomerName: string;\n\testimateNumber: string;\n\ttotalAmount: string;\n\tvalidUntil: string;\n\titems: Array<{\n\t\tdescription: string;\n\t\tamount: string;\n\t}>;\n\tacceptUrl: string;\n\tviewUrl: string;\n}\n\n// Customer Engagement Email Props\nexport interface ReviewRequestProps extends BaseEmailProps {\n\tcustomerName: string;\n\tjobNumber: string;\n\ttechnicianName: string;\n\tcompletedDate: string;\n\treviewUrl: string;\n}\n\nexport interface ServiceReminderProps extends BaseEmailProps {\n\tcustomerName: string;\n\tserviceName: string;\n\tlastServiceDate: string;\n\tscheduleUrl: string;\n}\n\nexport interface WelcomeCustomerProps extends BaseEmailProps {\n\tcustomerName: string;\n\taccountUrl: string;\n\tsupportEmail: string;\n\tsupportPhone: string;\n}\n\nexport interface PortalInvitationProps extends BaseEmailProps {\n\tcustomerName: string;\n\tportalUrl: string;\n\texpiresInHours?: number;\n\tcompanyName?: string;\n\tsupportEmail?: string;\n\tsupportPhone?: string;\n}\n\n// Verification Email Props\nexport interface VerificationSubmittedProps extends BaseEmailProps {\n\tcompanyName: string;\n\tcontactName: string;\n\thasTollFreeNumbers: boolean;\n\thas10DLCNumbers: boolean;\n\ttollFreeCount?: number;\n\tdlcCount?: number;\n\tdashboardUrl: string;\n}\n\nexport interface VerificationCompleteProps extends BaseEmailProps {\n\tcompanyName: string;\n\tcontactName: string;\n\tverificationTypes: string[]; // [\"toll-free\", \"10dlc\"]\n\tdashboardUrl: string;\n\tmessagingUrl: string;\n}\n\n// Waitlist Email Props\nexport interface WaitlistSubscriptionProps extends BaseEmailProps {\n\tname: string;\n}\n\n// Validation Schemas\nconst emailAddressSchema = z\n\t.string()\n\t.email(\"Invalid email address\")\n\t.min(1, \"Email is required\");\n\nexport const emailSendSchema = z.object({\n\tto: z.union([emailAddressSchema, z.array(emailAddressSchema)]),\n\tsubject: z.string().min(1, \"Subject is required\").max(200),\n\treplyTo: emailAddressSchema.optional(),\n});\n\n// Template types enum\nexport enum EmailTemplate {\n\t// Auth\n\tWELCOME = \"welcome\",\n\tEMAIL_VERIFICATION = \"email-verification\",\n\tPASSWORD_RESET = \"password-reset\",\n\tPASSWORD_CHANGED = \"password-changed\",\n\tMAGIC_LINK = \"magic-link\",\n\n\t// Jobs\n\tJOB_CONFIRMATION = \"job-confirmation\",\n\tAPPOINTMENT_REMINDER = \"appointment-reminder\",\n\tTECH_EN_ROUTE = \"tech-en-route\",\n\tJOB_COMPLETE = \"job-complete\",\n\n\t// Billing\n\tINVOICE = \"invoice\",\n\tESTIMATE = \"estimate\",\n\tINVOICE_SENT = \"invoice-sent\",\n\tPAYMENT_RECEIVED = \"payment-received\",\n\tPAYMENT_REMINDER = \"payment-reminder\",\n\tESTIMATE_SENT = \"estimate-sent\",\n\n\t// Customer\n\tREVIEW_REQUEST = \"review-request\",\n\tSERVICE_REMINDER = \"service-reminder\",\n\tWELCOME_CUSTOMER = \"welcome-customer\",\n\tPORTAL_INVITATION = \"portal-invitation\",\n\n\t// Team\n\tTEAM_INVITATION = \"team-invitation\",\n\n\t// Onboarding & Verification\n\tVERIFICATION_SUBMITTED = \"verification-submitted\",\n\tVERIFICATION_COMPLETE = \"verification-complete\",\n\n\t// Waitlist\n\tWAITLIST_SUBSCRIPTION = \"waitlist-subscription\",\n\tWAITLIST_ADMIN_NOTIFICATION = \"waitlist-admin-notification\",\n\n\t// Generic\n\tGENERIC = \"generic\",\n}\n\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC;;;;;;AAED;;AAwOA,qBAAqB;AACrB,MAAM,qBAAqB,mOAAC,CAC1B,MAAM,GACN,KAAK,CAAC,yBACN,GAAG,CAAC,GAAG;AAEF,MAAM,kBAAkB,mOAAC,CAAC,MAAM,CAAC;IACvC,IAAI,mOAAC,CAAC,KAAK,CAAC;QAAC;QAAoB,mOAAC,CAAC,KAAK,CAAC;KAAoB;IAC7D,SAAS,mOAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,uBAAuB,GAAG,CAAC;IACtD,SAAS,mBAAmB,QAAQ;AACrC;AAGO,IAAA,AAAK,uCAAA;IACX,OAAO;;;;;;IAOP,OAAO;;;;;IAMP,UAAU;;;;;;;IAQV,WAAW;;;;;IAMX,OAAO;;IAGP,4BAA4B;;;IAI5B,WAAW;;;IAIX,UAAU;;WAvCC"}},
    {"offset": {"line": 608, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/pre-send-checks.ts"],"sourcesContent":["import { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\n/**\n * Pre-Send Email Deliverability Checks\n *\n * Comprehensive checks before sending any email:\n * 1. Suppression list check (bounces, complaints, unsubscribes)\n * 2. Domain verification status\n * 3. Content spam score analysis\n * 4. Reputation check\n * 5. Rate/volume considerations for warm-up\n */\n\nexport interface PreSendCheckResult {\n\tallowed: boolean;\n\twarnings: string[];\n\terrors: string[];\n\tsuggestions: string[];\n\tspamScore?: number;\n\trecipientStatus?: {\n\t\temail: string;\n\t\tsuppressed: boolean;\n\t\treason?: string;\n\t}[];\n}\n\n// Spam trigger words and patterns\nconst SPAM_TRIGGERS = {\n\turgency: [\n\t\t\"act now\",\n\t\t\"limited time\",\n\t\t\"urgent\",\n\t\t\"immediate\",\n\t\t\"expires\",\n\t\t\"hurry\",\n\t\t\"don't miss\",\n\t\t\"last chance\",\n\t\t\"final notice\",\n\t\t\"deadline\",\n\t],\n\tmoney: [\n\t\t\"free\",\n\t\t\"$$$\",\n\t\t\"cash\",\n\t\t\"discount\",\n\t\t\"save big\",\n\t\t\"best price\",\n\t\t\"cheap\",\n\t\t\"bargain\",\n\t\t\"bonus\",\n\t\t\"prize\",\n\t\t\"winner\",\n\t\t\"congratulations\",\n\t],\n\tsuspicious: [\n\t\t\"click here\",\n\t\t\"click below\",\n\t\t\"buy now\",\n\t\t\"order now\",\n\t\t\"subscribe now\",\n\t\t\"sign up free\",\n\t\t\"no obligation\",\n\t\t\"risk free\",\n\t\t\"100% free\",\n\t\t\"act immediately\",\n\t],\n\tformatting: [\n\t\t\"ALL CAPS WORDS\",\n\t\t\"!!!\",\n\t\t\"???\",\n\t\t\"$$$\",\n\t\t\"***\",\n\t\t\"###\",\n\t],\n};\n\n// Weight multipliers for spam scoring\nconst SPAM_WEIGHTS = {\n\turgency: 2,\n\tmoney: 3,\n\tsuspicious: 4,\n\tformatting: 1.5,\n\texcessiveLinks: 5,\n\tnoUnsubscribe: 3,\n\tshortContent: 2,\n\timageHeavy: 3,\n};\n\n/**\n * Check if recipient is on suppression list (bounces, complaints, unsubscribes)\n */\nexport async function checkSuppressionList(\n\tcompanyId: string,\n\trecipientEmails: string[]\n): Promise<Map<string, { suppressed: boolean; reason?: string; suppressedAt?: string }>> {\n\tconst supabase = await createServiceSupabaseClient();\n\tconst results = new Map<string, { suppressed: boolean; reason?: string; suppressedAt?: string }>();\n\n\t// Initialize all as not suppressed\n\tfor (const email of recipientEmails) {\n\t\tresults.set(email.toLowerCase(), { suppressed: false });\n\t}\n\n\t// Check suppression list\n\tconst { data: suppressions } = await supabase\n\t\t.from(\"email_suppressions\")\n\t\t.select(\"email, reason, created_at\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.in(\"email\", recipientEmails.map((e) => e.toLowerCase()));\n\n\tif (suppressions) {\n\t\tfor (const suppression of suppressions) {\n\t\t\tresults.set(suppression.email, {\n\t\t\t\tsuppressed: true,\n\t\t\t\treason: suppression.reason,\n\t\t\t\tsuppressedAt: suppression.created_at,\n\t\t\t});\n\t\t}\n\t}\n\n\t// Also check global hard bounces (cross-company)\n\tconst { data: globalBounces } = await supabase\n\t\t.from(\"email_global_bounces\")\n\t\t.select(\"email, bounce_type, created_at\")\n\t\t.in(\"email\", recipientEmails.map((e) => e.toLowerCase()))\n\t\t.eq(\"bounce_type\", \"hard\");\n\n\tif (globalBounces) {\n\t\tfor (const bounce of globalBounces) {\n\t\t\tconst existing = results.get(bounce.email);\n\t\t\tif (!existing?.suppressed) {\n\t\t\t\tresults.set(bounce.email, {\n\t\t\t\t\tsuppressed: true,\n\t\t\t\t\treason: `Global hard bounce: ${bounce.bounce_type}`,\n\t\t\t\t\tsuppressedAt: bounce.created_at,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\treturn results;\n}\n\n/**\n * Calculate spam score for email content\n * Lower is better: 0-30 = good, 30-60 = warning, 60+ = likely spam\n */\nexport function calculateSpamScore(\n\tsubject: string,\n\thtmlContent: string,\n\ttextContent: string,\n\thasUnsubscribeLink: boolean\n): { score: number; issues: string[] } {\n\tlet score = 0;\n\tconst issues: string[] = [];\n\n\tconst fullText = `${subject} ${textContent}`.toLowerCase();\n\tconst htmlLower = htmlContent.toLowerCase();\n\n\t// Check spam trigger words\n\tfor (const [category, words] of Object.entries(SPAM_TRIGGERS)) {\n\t\tconst weight = SPAM_WEIGHTS[category as keyof typeof SPAM_WEIGHTS] || 1;\n\t\tfor (const word of words) {\n\t\t\tconst regex = new RegExp(word.toLowerCase(), \"gi\");\n\t\t\tconst matches = fullText.match(regex);\n\t\t\tif (matches) {\n\t\t\t\tscore += matches.length * weight;\n\t\t\t\tif (matches.length > 1) {\n\t\t\t\t\tissues.push(`Contains \"${word}\" ${matches.length} times`);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Check for ALL CAPS in subject\n\tconst capsWords = subject.split(\" \").filter((w) => w.length > 3 && w === w.toUpperCase());\n\tif (capsWords.length > 0) {\n\t\tscore += capsWords.length * 3;\n\t\tissues.push(`Subject contains ${capsWords.length} ALL CAPS words`);\n\t}\n\n\t// Check excessive punctuation\n\tconst exclamations = (subject.match(/!/g) || []).length;\n\tif (exclamations > 1) {\n\t\tscore += exclamations * 2;\n\t\tissues.push(`Excessive exclamation marks in subject (${exclamations})`);\n\t}\n\n\t// Check link density\n\tconst links = (htmlLower.match(/<a\\s/gi) || []).length;\n\tconst wordCount = textContent.split(/\\s+/).length;\n\tif (wordCount > 0 && links / wordCount > 0.1) {\n\t\tscore += SPAM_WEIGHTS.excessiveLinks;\n\t\tissues.push(`High link density (${links} links in ${wordCount} words)`);\n\t}\n\n\t// Check image-to-text ratio\n\tconst images = (htmlLower.match(/<img\\s/gi) || []).length;\n\tif (images > 0 && textContent.length < 200) {\n\t\tscore += SPAM_WEIGHTS.imageHeavy;\n\t\tissues.push(\"Image-heavy email with little text\");\n\t}\n\n\t// Check for unsubscribe link\n\tif (!hasUnsubscribeLink) {\n\t\tscore += SPAM_WEIGHTS.noUnsubscribe;\n\t\tissues.push(\"Missing unsubscribe link (required for marketing emails)\");\n\t}\n\n\t// Check content length (very short emails look suspicious)\n\tif (textContent.length < 50) {\n\t\tscore += SPAM_WEIGHTS.shortContent;\n\t\tissues.push(\"Very short email content\");\n\t}\n\n\t// Check for suspicious patterns\n\tif (htmlLower.includes(\"display:none\") || htmlLower.includes(\"font-size:0\")) {\n\t\tscore += 10;\n\t\tissues.push(\"Contains hidden text (spam technique)\");\n\t}\n\n\t// Check for deceptive link text\n\tconst deceptiveLinkPattern = /<a[^>]*href=[\"']([^\"']+)[\"'][^>]*>([^<]+)<\\/a>/gi;\n\tlet match;\n\twhile ((match = deceptiveLinkPattern.exec(htmlContent)) !== null) {\n\t\tconst href = match[1].toLowerCase();\n\t\tconst text = match[2].toLowerCase();\n\t\tif (\n\t\t\ttext.includes(\"click here\") ||\n\t\t\ttext.includes(\"click this\") ||\n\t\t\t(text.startsWith(\"http\") && !text.includes(new URL(href).hostname))\n\t\t) {\n\t\t\tscore += 5;\n\t\t\tissues.push(\"Contains deceptive or vague link text\");\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn { score: Math.min(score, 100), issues };\n}\n\n/**\n * Check domain warm-up status and recommend volume\n */\nexport async function checkDomainWarmup(\n\tdomainId: string\n): Promise<{\n\tinWarmup: boolean;\n\tdaysSinceCreation: number;\n\trecommendedDailyLimit: number;\n\tcurrentDaySent: number;\n\tsuggestions: string[];\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data: domain } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"created_at, emails_sent_today, total_emails_sent, warmup_completed\")\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (!domain) {\n\t\treturn {\n\t\t\tinWarmup: true,\n\t\t\tdaysSinceCreation: 0,\n\t\t\trecommendedDailyLimit: 10,\n\t\t\tcurrentDaySent: 0,\n\t\t\tsuggestions: [\"Domain not found\"],\n\t\t};\n\t}\n\n\tconst createdAt = new Date(domain.created_at);\n\tconst now = new Date();\n\tconst daysSinceCreation = Math.floor((now.getTime() - createdAt.getTime()) / (1000 * 60 * 60 * 24));\n\n\t// Warm-up schedule (days -> max emails per day)\n\t// Gradual increase over 4-6 weeks for best deliverability\n\tconst warmupSchedule: Record<number, number> = {\n\t\t0: 20, // Day 0-1: 20 emails\n\t\t2: 50, // Day 2-3: 50 emails\n\t\t4: 100, // Day 4-6: 100 emails\n\t\t7: 200, // Week 2: 200 emails\n\t\t14: 500, // Week 3: 500 emails\n\t\t21: 1000, // Week 4: 1000 emails\n\t\t28: 2500, // Week 5: 2500 emails\n\t\t35: 5000, // Week 6: 5000 emails\n\t\t42: 10000, // Week 7+: 10000 emails\n\t};\n\n\tlet recommendedLimit = 20;\n\tfor (const [day, limit] of Object.entries(warmupSchedule)) {\n\t\tif (daysSinceCreation >= parseInt(day)) {\n\t\t\trecommendedLimit = limit;\n\t\t}\n\t}\n\n\tconst inWarmup = daysSinceCreation < 42 && !domain.warmup_completed;\n\tconst suggestions: string[] = [];\n\n\tif (inWarmup) {\n\t\tsuggestions.push(\n\t\t\t`Domain is in warm-up period (day ${daysSinceCreation}/42). Recommended daily limit: ${recommendedLimit} emails.`\n\t\t);\n\n\t\tif (domain.emails_sent_today >= recommendedLimit * 0.8) {\n\t\t\tsuggestions.push(\n\t\t\t\t\"Approaching daily warm-up limit. Consider spreading sends across multiple days.\"\n\t\t\t);\n\t\t}\n\t}\n\n\treturn {\n\t\tinWarmup,\n\t\tdaysSinceCreation,\n\t\trecommendedDailyLimit: recommendedLimit,\n\t\tcurrentDaySent: domain.emails_sent_today || 0,\n\t\tsuggestions,\n\t};\n}\n\n/**\n * Verify domain is properly configured for sending\n */\nexport async function verifyDomainStatus(\n\tdomainId: string\n): Promise<{\n\tcanSend: boolean;\n\tissues: string[];\n\tdnsStatus: {\n\t\tspf: boolean;\n\t\tdkim: boolean;\n\t\tdmarc: boolean;\n\t};\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data: domain } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"status, is_suspended, sending_enabled, spf_verified, dkim_verified, dmarc_verified\")\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (!domain) {\n\t\treturn {\n\t\t\tcanSend: false,\n\t\t\tissues: [\"Domain not found\"],\n\t\t\tdnsStatus: { spf: false, dkim: false, dmarc: false },\n\t\t};\n\t}\n\n\tconst issues: string[] = [];\n\n\tif (domain.status !== \"verified\") {\n\t\tissues.push(`Domain not verified (status: ${domain.status})`);\n\t}\n\n\tif (domain.is_suspended) {\n\t\tissues.push(\"Domain is suspended\");\n\t}\n\n\tif (!domain.sending_enabled) {\n\t\tissues.push(\"Sending is disabled for this domain\");\n\t}\n\n\tif (!domain.spf_verified) {\n\t\tissues.push(\"SPF record not verified - emails may fail authentication\");\n\t}\n\n\tif (!domain.dkim_verified) {\n\t\tissues.push(\"DKIM not verified - emails may fail authentication\");\n\t}\n\n\tif (!domain.dmarc_verified) {\n\t\tissues.push(\"DMARC not configured - reduces deliverability\");\n\t}\n\n\treturn {\n\t\tcanSend: issues.length === 0,\n\t\tissues,\n\t\tdnsStatus: {\n\t\t\tspf: domain.spf_verified || false,\n\t\t\tdkim: domain.dkim_verified || false,\n\t\t\tdmarc: domain.dmarc_verified || false,\n\t\t},\n\t};\n}\n\n/**\n * Comprehensive pre-send check combining all validations\n */\nexport async function runPreSendChecks(\n\tcompanyId: string,\n\tdomainId: string,\n\trecipientEmails: string[],\n\tsubject: string,\n\thtmlContent: string,\n\ttextContent: string,\n\tisMarketingEmail: boolean = false\n): Promise<PreSendCheckResult> {\n\tconst warnings: string[] = [];\n\tconst errors: string[] = [];\n\tconst suggestions: string[] = [];\n\n\t// 1. Check domain status\n\tconst domainStatus = await verifyDomainStatus(domainId);\n\tif (!domainStatus.canSend) {\n\t\terrors.push(...domainStatus.issues);\n\t} else {\n\t\t// Add warnings for missing DNS records\n\t\tif (!domainStatus.dnsStatus.dmarc) {\n\t\t\twarnings.push(\"DMARC not configured - consider adding for better deliverability\");\n\t\t}\n\t}\n\n\t// 2. Check suppression list\n\tconst suppressions = await checkSuppressionList(companyId, recipientEmails);\n\tconst recipientStatus: PreSendCheckResult[\"recipientStatus\"] = [];\n\tlet suppressedCount = 0;\n\n\tfor (const [email, status] of suppressions) {\n\t\trecipientStatus.push({\n\t\t\temail,\n\t\t\tsuppressed: status.suppressed,\n\t\t\treason: status.reason,\n\t\t});\n\t\tif (status.suppressed) {\n\t\t\tsuppressedCount++;\n\t\t}\n\t}\n\n\tif (suppressedCount > 0) {\n\t\twarnings.push(\n\t\t\t`${suppressedCount} recipient(s) on suppression list and will be skipped`\n\t\t);\n\t}\n\n\tif (suppressedCount === recipientEmails.length) {\n\t\terrors.push(\"All recipients are on suppression list - no emails will be sent\");\n\t}\n\n\t// 3. Calculate spam score\n\tconst hasUnsubscribe =\n\t\thtmlContent.includes(\"unsubscribe\") ||\n\t\thtmlContent.includes(\"List-Unsubscribe\");\n\tconst spamAnalysis = calculateSpamScore(\n\t\tsubject,\n\t\thtmlContent,\n\t\ttextContent,\n\t\thasUnsubscribe || !isMarketingEmail\n\t);\n\n\tif (spamAnalysis.score >= 60) {\n\t\terrors.push(\n\t\t\t`High spam score (${spamAnalysis.score}/100) - email likely to be filtered`\n\t\t);\n\t\terrors.push(...spamAnalysis.issues);\n\t} else if (spamAnalysis.score >= 30) {\n\t\twarnings.push(\n\t\t\t`Moderate spam score (${spamAnalysis.score}/100) - consider improvements`\n\t\t);\n\t\twarnings.push(...spamAnalysis.issues);\n\t}\n\n\t// 4. Check warm-up status\n\tconst warmupStatus = await checkDomainWarmup(domainId);\n\tif (warmupStatus.inWarmup) {\n\t\tsuggestions.push(...warmupStatus.suggestions);\n\n\t\tconst activeRecipients = recipientEmails.length - suppressedCount;\n\t\tconst remainingCapacity =\n\t\t\twarmupStatus.recommendedDailyLimit - warmupStatus.currentDaySent;\n\n\t\tif (activeRecipients > remainingCapacity) {\n\t\t\twarnings.push(\n\t\t\t\t`Sending ${activeRecipients} emails exceeds warm-up limit (${remainingCapacity} remaining today). ` +\n\t\t\t\t\t`Consider sending over multiple days.`\n\t\t\t);\n\t\t}\n\t}\n\n\t// 5. Content-specific suggestions\n\tif (!htmlContent.includes(\"<!DOCTYPE\") && !htmlContent.includes(\"<html\")) {\n\t\tsuggestions.push(\n\t\t\t\"Consider using proper HTML structure with DOCTYPE for better rendering\"\n\t\t);\n\t}\n\n\tif (textContent.length < 100) {\n\t\tsuggestions.push(\n\t\t\t\"Consider adding more text content - very short emails may look suspicious\"\n\t\t);\n\t}\n\n\tif (isMarketingEmail && !hasUnsubscribe) {\n\t\terrors.push(\n\t\t\t\"Marketing emails MUST include an unsubscribe link (CAN-SPAM requirement)\"\n\t\t);\n\t}\n\n\t// Check for personalization\n\tif (\n\t\t!htmlContent.includes(\"{{\") &&\n\t\t!htmlContent.includes(\"{name}\") &&\n\t\t!subject.includes(\"{{\")\n\t) {\n\t\tsuggestions.push(\n\t\t\t\"Consider adding personalization (recipient name, company) for better engagement\"\n\t\t);\n\t}\n\n\treturn {\n\t\tallowed: errors.length === 0,\n\t\twarnings,\n\t\terrors,\n\t\tsuggestions,\n\t\tspamScore: spamAnalysis.score,\n\t\trecipientStatus,\n\t};\n}\n\n/**\n * Add email to suppression list\n */\nexport async function addToSuppressionList(\n\tcompanyId: string,\n\temail: string,\n\treason: \"bounce\" | \"complaint\" | \"unsubscribe\" | \"manual\",\n\tdetails?: string\n): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase.from(\"email_suppressions\").upsert(\n\t\t{\n\t\t\tcompany_id: companyId,\n\t\t\temail: email.toLowerCase(),\n\t\t\treason,\n\t\t\tdetails,\n\t\t\tcreated_at: new Date().toISOString(),\n\t\t},\n\t\t{\n\t\t\tonConflict: \"company_id,email\",\n\t\t}\n\t);\n\n\tif (error) {\n\t\tconsole.error(\"Error adding to suppression list:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Add email to global bounce list (cross-company hard bounces)\n */\nexport async function addToGlobalBounceList(\n\temail: string,\n\tbounceType: \"hard\" | \"soft\",\n\tbounceReason?: string\n): Promise<{ success: boolean; error?: string }> {\n\t// Only track hard bounces globally\n\tif (bounceType !== \"hard\") {\n\t\treturn { success: true };\n\t}\n\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase.from(\"email_global_bounces\").upsert(\n\t\t{\n\t\t\temail: email.toLowerCase(),\n\t\t\tbounce_type: bounceType,\n\t\t\tbounce_reason: bounceReason,\n\t\t\tbounce_count: 1,\n\t\t\tlast_bounce_at: new Date().toISOString(),\n\t\t\tcreated_at: new Date().toISOString(),\n\t\t},\n\t\t{\n\t\t\tonConflict: \"email\",\n\t\t}\n\t);\n\n\tif (error) {\n\t\tconsole.error(\"Error adding to global bounce list:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Remove email from suppression list (for manual review cases)\n */\nexport async function removeFromSuppressionList(\n\tcompanyId: string,\n\temail: string\n): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase\n\t\t.from(\"email_suppressions\")\n\t\t.delete()\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"email\", email.toLowerCase());\n\n\tif (error) {\n\t\tconsole.error(\"Error removing from suppression list:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Get suppression list for a company\n */\nexport async function getSuppressionList(\n\tcompanyId: string,\n\tlimit: number = 100,\n\toffset: number = 0\n): Promise<{\n\tdata: Array<{\n\t\temail: string;\n\t\treason: string;\n\t\tdetails?: string;\n\t\tcreated_at: string;\n\t}>;\n\ttotal: number;\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data, count, error } = await supabase\n\t\t.from(\"email_suppressions\")\n\t\t.select(\"email, reason, details, created_at\", { count: \"exact\" })\n\t\t.eq(\"company_id\", companyId)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.range(offset, offset + limit - 1);\n\n\tif (error) {\n\t\tconsole.error(\"Error fetching suppression list:\", error);\n\t\treturn { data: [], total: 0 };\n\t}\n\n\treturn { data: data || [], total: count || 0 };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1064, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/rate-limiter.ts"],"sourcesContent":["/**\n * Email Rate Limiter\n *\n * Implements per-domain rate limiting for email sending to:\n * - Prevent spam/abuse\n * - Protect domain reputation\n * - Enforce plan-based limits\n * - Track daily/hourly email quotas\n */\n\n\"use server\";\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface RateLimitResult {\n\tallowed: boolean;\n\treason?: string;\n\tremaining?: number;\n\tresetAt?: string;\n}\n\nexport interface ActiveDomainInfo {\n\tdomainId: string;\n\tdomain: string;\n\treplyToEmail: string | null;\n\tdailyLimit: number;\n\thourlyLimit: number;\n\temailsSentToday: number;\n\temailsSentThisHour: number;\n}\n\n// =============================================================================\n// RATE LIMIT CONFIGURATION\n// =============================================================================\n\n// Default rate limits (can be overridden per domain/plan)\nconst DEFAULT_LIMITS = {\n\tdaily: 1000, // 1000 emails per day per domain\n\thourly: 100, // 100 emails per hour per domain\n\tperMinute: 10, // 10 emails per minute per domain\n};\n\n// In-memory cache for rate limit tracking (resets on server restart)\n// For production, use Redis or database counters\nconst rateLimitCache = new Map<\n\tstring,\n\t{\n\t\tcount: number;\n\t\twindowStart: number;\n\t}\n>();\n\n// =============================================================================\n// PUBLIC API\n// =============================================================================\n\n/**\n * Get the active email domain for a company\n *\n * Returns the verified, sending-enabled domain for the company,\n * prioritizing custom domains over platform subdomains.\n */\nexport async function getCompanyActiveDomain(\n\tcompanyId: string\n): Promise<ActiveDomainInfo | null> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Query for the active sending domain\n\tconst { data: domain, error } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\n\t\t\t`\n\t\t\tid,\n\t\t\tdomain_name,\n\t\t\treply_to_email,\n\t\t\tdaily_limit,\n\t\t\thourly_limit,\n\t\t\temails_sent_today,\n\t\t\temails_sent_this_hour,\n\t\t\tis_platform_subdomain\n\t\t`\n\t\t)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"verified\")\n\t\t.eq(\"sending_enabled\", true)\n\t\t.eq(\"is_suspended\", false)\n\t\t.order(\"is_platform_subdomain\", { ascending: true }) // Custom domains first\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.maybeSingle();\n\n\tif (error) {\n\t\tconsole.error(\"Error fetching company email domain:\", error);\n\t\treturn null;\n\t}\n\n\tif (!domain) {\n\t\treturn null;\n\t}\n\n\treturn {\n\t\tdomainId: domain.id,\n\t\tdomain: domain.domain_name,\n\t\treplyToEmail: domain.reply_to_email,\n\t\tdailyLimit: domain.daily_limit || DEFAULT_LIMITS.daily,\n\t\thourlyLimit: domain.hourly_limit || DEFAULT_LIMITS.hourly,\n\t\temailsSentToday: domain.emails_sent_today || 0,\n\t\temailsSentThisHour: domain.emails_sent_this_hour || 0,\n\t};\n}\n\n/**\n * Check if a domain has exceeded its rate limit\n *\n * This is a non-blocking check that doesn't increment counters.\n * Use incrementEmailCounter after successfully sending.\n */\nexport async function checkRateLimit(domainId: string): Promise<RateLimitResult> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Get current domain stats\n\tconst { data: domain, error } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\n\t\t\t`\n\t\t\tdaily_limit,\n\t\t\thourly_limit,\n\t\t\temails_sent_today,\n\t\t\temails_sent_this_hour,\n\t\t\tis_suspended,\n\t\t\tdaily_limit_reset_at,\n\t\t\thourly_limit_reset_at\n\t\t`\n\t\t)\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (error || !domain) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Domain not found or error fetching limits\",\n\t\t};\n\t}\n\n\t// Check if domain is suspended\n\tif (domain.is_suspended) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Domain is suspended due to reputation issues\",\n\t\t};\n\t}\n\n\tconst dailyLimit = domain.daily_limit || DEFAULT_LIMITS.daily;\n\tconst hourlyLimit = domain.hourly_limit || DEFAULT_LIMITS.hourly;\n\tconst emailsSentToday = domain.emails_sent_today || 0;\n\tconst emailsSentThisHour = domain.emails_sent_this_hour || 0;\n\n\t// Check daily limit\n\tif (emailsSentToday >= dailyLimit) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: `Daily email limit reached (${dailyLimit} emails/day)`,\n\t\t\tremaining: 0,\n\t\t\tresetAt: domain.daily_limit_reset_at || getNextMidnightUTC(),\n\t\t};\n\t}\n\n\t// Check hourly limit\n\tif (emailsSentThisHour >= hourlyLimit) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: `Hourly email limit reached (${hourlyLimit} emails/hour)`,\n\t\t\tremaining: 0,\n\t\t\tresetAt: domain.hourly_limit_reset_at || getNextHourUTC(),\n\t\t};\n\t}\n\n\t// Check per-minute limit (in-memory)\n\tconst minuteKey = `${domainId}:minute`;\n\tconst minuteWindow = getMinuteWindow();\n\tconst minuteCache = rateLimitCache.get(minuteKey);\n\n\tif (minuteCache && minuteCache.windowStart === minuteWindow) {\n\t\tif (minuteCache.count >= DEFAULT_LIMITS.perMinute) {\n\t\t\treturn {\n\t\t\t\tallowed: false,\n\t\t\t\treason: `Rate limit: Too many emails per minute (${DEFAULT_LIMITS.perMinute}/min)`,\n\t\t\t\tremaining: 0,\n\t\t\t};\n\t\t}\n\t}\n\n\treturn {\n\t\tallowed: true,\n\t\tremaining: Math.min(dailyLimit - emailsSentToday, hourlyLimit - emailsSentThisHour),\n\t};\n}\n\n/**\n * Increment the email counter after successfully sending\n *\n * This atomically increments the counters and validates limits.\n * Should be called after checkRateLimit and before actually sending.\n */\nexport async function incrementEmailCounter(\n\tdomainId: string\n): Promise<RateLimitResult> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Use a database function for atomic increment and validation\n\t// This prevents race conditions in high-concurrency scenarios\n\tconst { data, error } = await supabase.rpc(\"increment_email_counter\", {\n\t\tp_domain_id: domainId,\n\t});\n\n\tif (error) {\n\t\t// If the RPC doesn't exist, fall back to manual increment\n\t\tif (error.code === \"PGRST202\" || error.message.includes(\"function\")) {\n\t\t\treturn await incrementEmailCounterFallback(domainId);\n\t\t}\n\n\t\tconsole.error(\"Error incrementing email counter:\", error);\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: error.message,\n\t\t};\n\t}\n\n\t// Handle RPC result\n\tif (data && typeof data === \"object\") {\n\t\tconst result = data as { allowed: boolean; reason?: string; remaining?: number };\n\t\treturn {\n\t\t\tallowed: result.allowed,\n\t\t\treason: result.reason,\n\t\t\tremaining: result.remaining,\n\t\t};\n\t}\n\n\t// Default: allowed if no error\n\treturn { allowed: true };\n}\n\n// =============================================================================\n// HELPER FUNCTIONS\n// =============================================================================\n\n/**\n * Fallback increment method when RPC function doesn't exist\n */\nasync function incrementEmailCounterFallback(\n\tdomainId: string\n): Promise<RateLimitResult> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Get current counts\n\tconst { data: domain, error: fetchError } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"emails_sent_today, emails_sent_this_hour, daily_limit, hourly_limit\")\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (fetchError || !domain) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Domain not found\",\n\t\t};\n\t}\n\n\tconst dailyLimit = domain.daily_limit || DEFAULT_LIMITS.daily;\n\tconst hourlyLimit = domain.hourly_limit || DEFAULT_LIMITS.hourly;\n\n\t// Check limits before incrementing\n\tif ((domain.emails_sent_today || 0) >= dailyLimit) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Daily limit reached\",\n\t\t};\n\t}\n\n\tif ((domain.emails_sent_this_hour || 0) >= hourlyLimit) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Hourly limit reached\",\n\t\t};\n\t}\n\n\t// Increment counters\n\tconst { error: updateError } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.update({\n\t\t\temails_sent_today: (domain.emails_sent_today || 0) + 1,\n\t\t\temails_sent_this_hour: (domain.emails_sent_this_hour || 0) + 1,\n\t\t})\n\t\t.eq(\"id\", domainId);\n\n\tif (updateError) {\n\t\tconsole.error(\"Error updating email counters:\", updateError);\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: updateError.message,\n\t\t};\n\t}\n\n\t// Update in-memory per-minute counter\n\tconst minuteKey = `${domainId}:minute`;\n\tconst minuteWindow = getMinuteWindow();\n\tconst minuteCache = rateLimitCache.get(minuteKey);\n\n\tif (minuteCache && minuteCache.windowStart === minuteWindow) {\n\t\tminuteCache.count++;\n\t} else {\n\t\trateLimitCache.set(minuteKey, {\n\t\t\tcount: 1,\n\t\t\twindowStart: minuteWindow,\n\t\t});\n\t}\n\n\treturn {\n\t\tallowed: true,\n\t\tremaining: Math.min(\n\t\t\tdailyLimit - (domain.emails_sent_today || 0) - 1,\n\t\t\thourlyLimit - (domain.emails_sent_this_hour || 0) - 1\n\t\t),\n\t};\n}\n\n/**\n * Get the current minute window (for per-minute rate limiting)\n */\nfunction getMinuteWindow(): number {\n\treturn Math.floor(Date.now() / 60000);\n}\n\n/**\n * Get the next midnight UTC timestamp\n */\nfunction getNextMidnightUTC(): string {\n\tconst now = new Date();\n\tconst tomorrow = new Date(now);\n\ttomorrow.setUTCDate(tomorrow.getUTCDate() + 1);\n\ttomorrow.setUTCHours(0, 0, 0, 0);\n\treturn tomorrow.toISOString();\n}\n\n/**\n * Get the next hour UTC timestamp\n */\nfunction getNextHourUTC(): string {\n\tconst now = new Date();\n\tconst nextHour = new Date(now);\n\tnextHour.setUTCHours(nextHour.getUTCHours() + 1, 0, 0, 0);\n\treturn nextHour.toISOString();\n}\n\n// =============================================================================\n// RESET FUNCTIONS (for cron jobs)\n// =============================================================================\n\n/**\n * Reset daily email counters (should be called by cron at midnight UTC)\n */\nexport async function resetDailyCounters(): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.update({\n\t\t\temails_sent_today: 0,\n\t\t\tdaily_limit_reset_at: getNextMidnightUTC(),\n\t\t})\n\t\t.neq(\"id\", \"\"); // Update all rows\n\n\tif (error) {\n\t\tconsole.error(\"Error resetting daily counters:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Reset hourly email counters (should be called by cron every hour)\n */\nexport async function resetHourlyCounters(): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.update({\n\t\t\temails_sent_this_hour: 0,\n\t\t\thourly_limit_reset_at: getNextHourUTC(),\n\t\t})\n\t\t.neq(\"id\", \"\"); // Update all rows\n\n\tif (error) {\n\t\tconsole.error(\"Error resetting hourly counters:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1365, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/resend-client.ts"],"sourcesContent":["/**\n * Resend Client - Email Service Configuration\n *\n * Features:\n * - Singleton Resend client instance\n * - Environment-based configuration\n * - Type-safe email sending\n * - Development mode support (logs instead of sending)\n */\n\nimport { Resend } from \"resend\";\n\nconst requiredSiteUrl = process.env.NEXT_PUBLIC_SITE_URL;\nif (!requiredSiteUrl) {\n\tthrow new Error(\"NEXT_PUBLIC_SITE_URL is not configured\");\n}\n\n// Initialize Resend client\nexport const resend = process.env.RESEND_API_KEY\n\t? new Resend(process.env.RESEND_API_KEY)\n\t: null;\n\n// Email configuration\nexport const emailConfig = {\n\tfrom: `${process.env.RESEND_FROM_NAME || \"Thorbis\"} <${process.env.RESEND_FROM_EMAIL || \"noreply@thorbis.com\"}>`,\n\t// Enable production mode if RESEND_API_KEY is configured, even in development\n\tisDevelopment:\n\t\t!process.env.RESEND_API_KEY ||\n\t\t(process.env.NODE_ENV === \"development\" && !process.env.RESEND_API_KEY),\n\tsiteUrl: requiredSiteUrl,\n\tappUrl: process.env.NEXT_PUBLIC_APP_URL || requiredSiteUrl,\n};\n\n// Check if Resend is properly configured\nexport function isResendConfigured(): boolean {\n\tif (!resend) {\n\t\treturn false;\n\t}\n\treturn true;\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC;;;;;;;;AAED;;AAEA,MAAM;AACN;;AAKO,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc,GAC7C,IAAI,+TAAM,CAAC,QAAQ,GAAG,CAAC,cAAc,IACrC;AAGI,MAAM,cAAc;IAC1B,MAAM,GAAG,QAAQ,GAAG,CAAC,gBAAgB,IAAI,UAAU,EAAE,EAAE,QAAQ,GAAG,CAAC,iBAAiB,IAAI,sBAAsB,CAAC,CAAC;IAChH,8EAA8E;IAC9E,eACC,CAAC,QAAQ,GAAG,CAAC,cAAc,IAC1B,oDAAyB,iBAAiB,CAAC,QAAQ,GAAG,CAAC,cAAc;IACvE,SAAS;IACT,QAAQ,6DAAmC;AAC5C;AAGO,SAAS;IACf,IAAI,CAAC,QAAQ;QACZ,OAAO;IACR;IACA,OAAO;AACR"}},
    {"offset": {"line": 1404, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/postmark-client.ts"],"sourcesContent":["/**\n * Postmark Email Client\n *\n * This module provides integration with Postmark as a fallback email provider.\n * Postmark is known for excellent deliverability and is used when Resend fails.\n *\n * Features:\n * - Email sending with automatic retry\n * - Domain/sender signature management\n * - Webhook signature verification\n * - Delivery status tracking\n *\n * Environment Variables Required:\n * - POSTMARK_API_KEY: Your Postmark server API token\n * - POSTMARK_WEBHOOK_SECRET: Secret for verifying webhook signatures (optional)\n *\n * @see https://postmarkapp.com/developer\n */\n\nimport crypto from \"node:crypto\";\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nconst POSTMARK_API_BASE = \"https://api.postmarkapp.com\";\n\n/**\n * Postmark client configuration\n * Checks environment variables and provides defaults\n */\nexport const postmarkConfig = {\n\tapiKey: process.env.POSTMARK_API_KEY || \"\",\n\twebhookSecret: process.env.POSTMARK_WEBHOOK_SECRET || \"\",\n\t// Default \"from\" address for Postmark (must be verified sender signature)\n\tfrom: process.env.POSTMARK_FROM_EMAIL || process.env.EMAIL_FROM || \"notifications@stratos.app\",\n\t// Is Postmark configured and ready to use?\n\tisConfigured: !!process.env.POSTMARK_API_KEY,\n\t// Provider name for logging/monitoring\n\tproviderName: \"postmark\" as const,\n};\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Standard response wrapper for Postmark API calls\n * Matches the pattern used by Resend for consistency\n */\nexport type PostmarkResponse<T> =\n\t| { success: true; data: T }\n\t| { success: false; error: string; errorCode?: number };\n\n/**\n * Postmark email send request\n * @see https://postmarkapp.com/developer/api/email-api\n */\nexport interface PostmarkSendRequest {\n\tFrom: string;\n\tTo: string;\n\tSubject: string;\n\tHtmlBody?: string;\n\tTextBody?: string;\n\tReplyTo?: string;\n\tTag?: string;\n\tTrackOpens?: boolean;\n\tTrackLinks?: \"None\" | \"HtmlAndText\" | \"HtmlOnly\" | \"TextOnly\";\n\tMessageStream?: string;\n\tMetadata?: Record<string, string>;\n}\n\n/**\n * Postmark email send response\n */\nexport interface PostmarkSendResponse {\n\tTo: string;\n\tSubmittedAt: string;\n\tMessageID: string;\n\tErrorCode: number;\n\tMessage: string;\n}\n\n/**\n * Postmark domain (sender signature) data\n * @see https://postmarkapp.com/developer/api/signatures-api\n */\nexport interface PostmarkDomainData {\n\tID: number;\n\tDomain: string;\n\tEmailAddress: string;\n\tReplyToEmailAddress: string;\n\tName: string;\n\tConfirmed: boolean;\n\tSPFVerified: boolean;\n\tSPFHost: string;\n\tSPFTextValue: string;\n\tDKIMVerified: boolean;\n\tWeakDKIM: boolean;\n\tDKIMHost: string;\n\tDKIMTextValue: string;\n\tDKIMPendingHost: string;\n\tDKIMPendingTextValue: string;\n\tDKIMRevokedHost: string;\n\tDKIMRevokedTextValue: string;\n\tSafeToRemoveRevokedKeyFromDNS: boolean;\n\tDKIMUpdateStatus: string;\n\tReturnPathDomain: string;\n\tReturnPathDomainCNAMEValue: string;\n\tReturnPathDomainVerified: boolean;\n}\n\n/**\n * Postmark webhook event types\n */\nexport type PostmarkWebhookEventType =\n\t| \"Delivery\"\n\t| \"Bounce\"\n\t| \"SpamComplaint\"\n\t| \"Open\"\n\t| \"Click\"\n\t| \"SubscriptionChange\";\n\n/**\n * Postmark webhook payload base\n */\nexport interface PostmarkWebhookPayload {\n\tRecordType: PostmarkWebhookEventType;\n\tMessageID: string;\n\tRecipient: string;\n\tTag: string;\n\tDeliveredAt?: string;\n\tBouncedAt?: string;\n\tType?: string; // Bounce type\n\tTypeCode?: number;\n\tDescription?: string;\n\tDetails?: string;\n\tEmail?: string;\n\tFrom?: string;\n\tSubject?: string;\n\tMetadata?: Record<string, string>;\n}\n\n// =============================================================================\n// API REQUEST HELPER\n// =============================================================================\n\n/**\n * Makes authenticated requests to Postmark API\n *\n * @param path - API endpoint path (e.g., \"/email\")\n * @param init - Fetch request options\n * @returns Typed response with success/error handling\n *\n * @example\n * const result = await postmarkRequest<PostmarkSendResponse>(\"/email\", {\n *   method: \"POST\",\n *   body: JSON.stringify(emailData),\n * });\n */\nasync function postmarkRequest<T>(\n\tpath: string,\n\tinit: RequestInit\n): Promise<PostmarkResponse<T>> {\n\t// Check if Postmark is configured\n\tif (!postmarkConfig.apiKey) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Postmark API key is not configured. Set POSTMARK_API_KEY environment variable.\",\n\t\t};\n\t}\n\n\ttry {\n\t\tconst response = await fetch(`${POSTMARK_API_BASE}${path}`, {\n\t\t\t...init,\n\t\t\theaders: {\n\t\t\t\t// Postmark uses X-Postmark-Server-Token for authentication\n\t\t\t\t\"X-Postmark-Server-Token\": postmarkConfig.apiKey,\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\tAccept: \"application/json\",\n\t\t\t\t...init.headers,\n\t\t\t},\n\t\t});\n\n\t\t// Parse response body\n\t\tconst body = await response.json().catch(() => ({}));\n\n\t\t// Handle non-OK responses\n\t\tif (!response.ok) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: body.Message || body.message || response.statusText,\n\t\t\t\terrorCode: body.ErrorCode,\n\t\t\t};\n\t\t}\n\n\t\treturn { success: true, data: body as T };\n\t} catch (error) {\n\t\t// Network or parsing error\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Postmark request failed\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// EMAIL SENDING\n// =============================================================================\n\n/**\n * Send an email via Postmark\n *\n * This is the primary email sending function for Postmark.\n * It handles HTML emails with optional tracking.\n *\n * @param options - Email send options\n * @returns Send result with MessageID on success\n *\n * @example\n * const result = await sendPostmarkEmail({\n *   to: \"user@example.com\",\n *   subject: \"Welcome!\",\n *   html: \"<h1>Hello</h1>\",\n *   from: \"hello@mycompany.com\",\n *   tags: { template: \"welcome\" },\n * });\n */\nexport async function sendPostmarkEmail(options: {\n\tto: string | string[];\n\tsubject: string;\n\thtml: string;\n\ttext?: string;\n\tfrom?: string;\n\treplyTo?: string;\n\ttag?: string;\n\ttrackOpens?: boolean;\n\ttrackLinks?: boolean;\n\tmetadata?: Record<string, string>;\n\tmessageStream?: string;\n}): Promise<PostmarkResponse<PostmarkSendResponse>> {\n\tconst {\n\t\tto,\n\t\tsubject,\n\t\thtml,\n\t\ttext,\n\t\tfrom = postmarkConfig.from,\n\t\treplyTo,\n\t\ttag,\n\t\ttrackOpens = true,\n\t\ttrackLinks = true,\n\t\tmetadata,\n\t\tmessageStream = \"outbound\", // Default message stream\n\t} = options;\n\n\t// Postmark requires single recipient per request for /email endpoint\n\t// For multiple recipients, we'd use /email/batch\n\tconst recipient = Array.isArray(to) ? to.join(\", \") : to;\n\n\tconst request: PostmarkSendRequest = {\n\t\tFrom: from,\n\t\tTo: recipient,\n\t\tSubject: subject,\n\t\tHtmlBody: html,\n\t\tTextBody: text,\n\t\tReplyTo: replyTo,\n\t\tTag: tag,\n\t\tTrackOpens: trackOpens,\n\t\tTrackLinks: trackLinks ? \"HtmlAndText\" : \"None\",\n\t\tMessageStream: messageStream,\n\t\tMetadata: metadata,\n\t};\n\n\t// Log send attempt for monitoring\n\tconsole.log(`[Postmark] Sending email to ${recipient}, subject: \"${subject}\"`);\n\n\tconst result = await postmarkRequest<PostmarkSendResponse>(\"/email\", {\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify(request),\n\t});\n\n\t// Log result for monitoring\n\tif (result.success) {\n\t\tconsole.log(`[Postmark] Email sent successfully, MessageID: ${result.data.MessageID}`);\n\t} else {\n\t\tconsole.error(`[Postmark] Email send failed: ${result.error}`);\n\t}\n\n\treturn result;\n}\n\n/**\n * Send batch emails via Postmark (up to 500 per request)\n *\n * @param emails - Array of email options\n * @returns Array of send results\n */\nexport async function sendPostmarkBatchEmails(\n\temails: Array<{\n\t\tto: string;\n\t\tsubject: string;\n\t\thtml: string;\n\t\ttext?: string;\n\t\tfrom?: string;\n\t\treplyTo?: string;\n\t\ttag?: string;\n\t\tmetadata?: Record<string, string>;\n\t}>\n): Promise<PostmarkResponse<PostmarkSendResponse[]>> {\n\tif (emails.length > 500) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Postmark batch limit is 500 emails per request\",\n\t\t};\n\t}\n\n\tconst requests: PostmarkSendRequest[] = emails.map((email) => ({\n\t\tFrom: email.from || postmarkConfig.from,\n\t\tTo: email.to,\n\t\tSubject: email.subject,\n\t\tHtmlBody: email.html,\n\t\tTextBody: email.text,\n\t\tReplyTo: email.replyTo,\n\t\tTag: email.tag,\n\t\tTrackOpens: true,\n\t\tTrackLinks: \"HtmlAndText\",\n\t\tMetadata: email.metadata,\n\t}));\n\n\tconsole.log(`[Postmark] Sending batch of ${emails.length} emails`);\n\n\treturn postmarkRequest<PostmarkSendResponse[]>(\"/email/batch\", {\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify(requests),\n\t});\n}\n\n// =============================================================================\n// DOMAIN/SENDER SIGNATURE MANAGEMENT\n// =============================================================================\n\n/**\n * List all sender signatures (domains) in Postmark\n *\n * @returns List of sender signatures\n */\nexport async function listPostmarkDomains(): Promise<\n\tPostmarkResponse<{ TotalCount: number; SenderSignatures: PostmarkDomainData[] }>\n> {\n\tconsole.log(\"[Postmark] Listing sender signatures\");\n\treturn postmarkRequest(\"/senders\", { method: \"GET\" });\n}\n\n/**\n * Get details of a specific sender signature\n *\n * @param signatureId - Postmark sender signature ID\n * @returns Sender signature details\n */\nexport async function getPostmarkDomain(\n\tsignatureId: number\n): Promise<PostmarkResponse<PostmarkDomainData>> {\n\tconsole.log(`[Postmark] Getting sender signature ${signatureId}`);\n\treturn postmarkRequest(`/senders/${signatureId}`, { method: \"GET\" });\n}\n\n/**\n * Create a new sender signature in Postmark\n *\n * Note: Postmark uses \"sender signatures\" which can be either:\n * - Individual email addresses\n * - Entire domains\n *\n * @param options - Sender signature options\n * @returns Created sender signature\n */\nexport async function createPostmarkDomain(options: {\n\tfromEmail: string;\n\tname: string;\n\treplyToEmail?: string;\n}): Promise<PostmarkResponse<PostmarkDomainData>> {\n\tconst { fromEmail, name, replyToEmail } = options;\n\n\tconsole.log(`[Postmark] Creating sender signature for ${fromEmail}`);\n\n\treturn postmarkRequest(\"/senders\", {\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify({\n\t\t\tFromEmail: fromEmail,\n\t\t\tName: name,\n\t\t\tReplyToEmail: replyToEmail || fromEmail,\n\t\t}),\n\t});\n}\n\n/**\n * Delete a sender signature from Postmark\n *\n * @param signatureId - Postmark sender signature ID\n * @returns Deletion result\n */\nexport async function deletePostmarkDomain(\n\tsignatureId: number\n): Promise<PostmarkResponse<{ Message: string }>> {\n\tconsole.log(`[Postmark] Deleting sender signature ${signatureId}`);\n\treturn postmarkRequest(`/senders/${signatureId}`, { method: \"DELETE\" });\n}\n\n/**\n * Resend confirmation email for a sender signature\n *\n * @param signatureId - Postmark sender signature ID\n * @returns Resend result\n */\nexport async function resendPostmarkConfirmation(\n\tsignatureId: number\n): Promise<PostmarkResponse<{ Message: string }>> {\n\tconsole.log(`[Postmark] Resending confirmation for signature ${signatureId}`);\n\treturn postmarkRequest(`/senders/${signatureId}/resend`, { method: \"POST\" });\n}\n\n/**\n * Verify DKIM for a sender signature\n * Triggers Postmark to check DNS records\n *\n * @param signatureId - Postmark sender signature ID\n * @returns Updated sender signature with verification status\n */\nexport async function verifyPostmarkDKIM(\n\tsignatureId: number\n): Promise<PostmarkResponse<PostmarkDomainData>> {\n\tconsole.log(`[Postmark] Verifying DKIM for signature ${signatureId}`);\n\treturn postmarkRequest(`/senders/${signatureId}/verifyDkim`, { method: \"PUT\" });\n}\n\n/**\n * Verify Return-Path for a sender signature\n *\n * @param signatureId - Postmark sender signature ID\n * @returns Updated sender signature with verification status\n */\nexport async function verifyPostmarkReturnPath(\n\tsignatureId: number\n): Promise<PostmarkResponse<PostmarkDomainData>> {\n\tconsole.log(`[Postmark] Verifying Return-Path for signature ${signatureId}`);\n\treturn postmarkRequest(`/senders/${signatureId}/verifyReturnPath`, { method: \"PUT\" });\n}\n\n// =============================================================================\n// SERVER/ACCOUNT INFO\n// =============================================================================\n\n/**\n * Get Postmark server information\n * Useful for verifying API key and getting server settings\n *\n * @returns Server information\n */\nexport async function getPostmarkServerInfo(): Promise<\n\tPostmarkResponse<{\n\t\tID: number;\n\t\tName: string;\n\t\tApiTokens: string[];\n\t\tColor: string;\n\t\tSmtpApiActivated: boolean;\n\t\tRawEmailEnabled: boolean;\n\t\tInboundAddress: string;\n\t\tInboundHookUrl: string;\n\t\tBounceHookUrl: string;\n\t\tOpenHookUrl: string;\n\t\tPostFirstOpenOnly: boolean;\n\t\tTrackOpens: boolean;\n\t\tTrackLinks: string;\n\t\tInboundDomain: string;\n\t\tInboundSpamThreshold: number;\n\t}>\n> {\n\tconsole.log(\"[Postmark] Getting server info\");\n\treturn postmarkRequest(\"/server\", { method: \"GET\" });\n}\n\n// =============================================================================\n// WEBHOOK VERIFICATION\n// =============================================================================\n\n/**\n * Verify Postmark webhook signature\n *\n * Postmark webhooks don't use signatures by default, but you can configure\n * basic auth or use the webhook token. This function verifies the token\n * if POSTMARK_WEBHOOK_SECRET is configured.\n *\n * @param options - Webhook verification options\n * @returns Whether the webhook is valid\n *\n * @example\n * const isValid = verifyPostmarkWebhook({\n *   payload: requestBody,\n *   token: request.headers.get(\"X-Postmark-Token\"),\n * });\n */\nexport function verifyPostmarkWebhook(options: {\n\tpayload: string;\n\ttoken?: string | null;\n}): boolean {\n\tconst { token } = options;\n\n\t// If no secret configured, accept all webhooks (not recommended for production)\n\tif (!postmarkConfig.webhookSecret) {\n\t\tconsole.warn(\"[Postmark] No webhook secret configured - accepting webhook without verification\");\n\t\treturn true;\n\t}\n\n\t// Verify the token matches our secret\n\tif (!token) {\n\t\tconsole.error(\"[Postmark] Webhook missing token\");\n\t\treturn false;\n\t}\n\n\t// Use timing-safe comparison to prevent timing attacks\n\ttry {\n\t\tconst expected = Buffer.from(postmarkConfig.webhookSecret);\n\t\tconst received = Buffer.from(token);\n\n\t\tif (expected.length !== received.length) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn crypto.timingSafeEqual(expected, received);\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n// =============================================================================\n// HEALTH CHECK\n// =============================================================================\n\n/**\n * Check if Postmark is healthy and responsive\n *\n * This function attempts to fetch server info to verify:\n * 1. API key is valid\n * 2. Postmark API is reachable\n * 3. Account is in good standing\n *\n * @returns Health check result\n */\nexport async function checkPostmarkHealth(): Promise<{\n\thealthy: boolean;\n\tprovider: \"postmark\";\n\tlatencyMs: number;\n\terror?: string;\n}> {\n\tconst startTime = Date.now();\n\n\ttry {\n\t\tconst result = await getPostmarkServerInfo();\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tif (result.success) {\n\t\t\tconsole.log(`[Postmark] Health check passed in ${latencyMs}ms`);\n\t\t\treturn {\n\t\t\t\thealthy: true,\n\t\t\t\tprovider: \"postmark\",\n\t\t\t\tlatencyMs,\n\t\t\t};\n\t\t}\n\n\t\tconsole.error(`[Postmark] Health check failed: ${result.error}`);\n\t\treturn {\n\t\t\thealthy: false,\n\t\t\tprovider: \"postmark\",\n\t\t\tlatencyMs,\n\t\t\terror: result.error,\n\t\t};\n\t} catch (error) {\n\t\tconst latencyMs = Date.now() - startTime;\n\t\tconst errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n\n\t\tconsole.error(`[Postmark] Health check error: ${errorMessage}`);\n\t\treturn {\n\t\t\thealthy: false,\n\t\t\tprovider: \"postmark\",\n\t\t\tlatencyMs,\n\t\t\terror: errorMessage,\n\t\t};\n\t}\n}\n\n// =============================================================================\n// UTILITY FUNCTIONS\n// =============================================================================\n\n/**\n * Check if Postmark is properly configured\n *\n * @returns Whether Postmark can be used\n */\nexport function isPostmarkConfigured(): boolean {\n\treturn postmarkConfig.isConfigured;\n}\n\n/**\n * Get DNS records needed for a domain in Postmark format\n *\n * @param domain - Postmark domain data\n * @returns Formatted DNS records for display\n */\nexport function getPostmarkDNSRecords(domain: PostmarkDomainData): Array<{\n\ttype: string;\n\tname: string;\n\tvalue: string;\n\tverified: boolean;\n}> {\n\tconst records: Array<{\n\t\ttype: string;\n\t\tname: string;\n\t\tvalue: string;\n\t\tverified: boolean;\n\t}> = [];\n\n\t// DKIM record\n\tif (domain.DKIMHost && domain.DKIMTextValue) {\n\t\trecords.push({\n\t\t\ttype: \"TXT\",\n\t\t\tname: domain.DKIMHost,\n\t\t\tvalue: domain.DKIMTextValue,\n\t\t\tverified: domain.DKIMVerified,\n\t\t});\n\t}\n\n\t// Return-Path CNAME\n\tif (domain.ReturnPathDomain && domain.ReturnPathDomainCNAMEValue) {\n\t\trecords.push({\n\t\t\ttype: \"CNAME\",\n\t\t\tname: domain.ReturnPathDomain,\n\t\t\tvalue: domain.ReturnPathDomainCNAMEValue,\n\t\t\tverified: domain.ReturnPathDomainVerified,\n\t\t});\n\t}\n\n\treturn records;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1721, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/token-encryption.ts"],"sourcesContent":["/**\n * Token Encryption Service\n *\n * Encrypts and decrypts OAuth refresh tokens before storing in database.\n * Uses AES-256-GCM for authenticated encryption.\n *\n * Security Features:\n * - AES-256-GCM authenticated encryption\n * - Unique IV (initialization vector) per token\n * - Authentication tag prevents tampering\n * - Key derivation from environment variable\n *\n * Environment Variables Required:\n * - TOKEN_ENCRYPTION_KEY: 32-byte hex string (64 characters)\n *\n * Generate key with: openssl rand -hex 32\n *\n * CRITICAL: Never commit encryption key to version control!\n */\n\nimport crypto from \"crypto\";\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\n/** Encryption algorithm (AES-256-GCM) */\nconst ALGORITHM = \"aes-256-gcm\";\n\n/** IV length in bytes (12 bytes = 96 bits, recommended for GCM) */\nconst IV_LENGTH = 12;\n\n/** Auth tag length in bytes (16 bytes = 128 bits) */\nconst AUTH_TAG_LENGTH = 16;\n\n/** Encoding for encrypted output */\nconst ENCODING = \"base64\";\n\n// =============================================================================\n// KEY MANAGEMENT\n// =============================================================================\n\n/**\n * Get encryption key from environment\n * Throws error if key is missing or invalid\n */\nfunction getEncryptionKey(): Buffer {\n\tconst keyHex = process.env.TOKEN_ENCRYPTION_KEY;\n\n\tif (!keyHex) {\n\t\tthrow new Error(\n\t\t\t\"TOKEN_ENCRYPTION_KEY environment variable not set. Generate with: openssl rand -hex 32\"\n\t\t);\n\t}\n\n\t// Verify key is 32 bytes (64 hex characters)\n\tif (keyHex.length !== 64) {\n\t\tthrow new Error(\n\t\t\t\"TOKEN_ENCRYPTION_KEY must be 32 bytes (64 hex characters). Generate with: openssl rand -hex 32\"\n\t\t);\n\t}\n\n\t// Convert hex string to buffer\n\tconst key = Buffer.from(keyHex, \"hex\");\n\n\tif (key.length !== 32) {\n\t\tthrow new Error(\"Invalid TOKEN_ENCRYPTION_KEY format\");\n\t}\n\n\treturn key;\n}\n\n// =============================================================================\n// ENCRYPTION/DECRYPTION\n// =============================================================================\n\n/**\n * Encrypt a token (refresh token or access token)\n *\n * @param plaintext - Token to encrypt\n * @returns Encrypted token string (format: iv:authTag:ciphertext, all base64)\n *\n * @example\n * const encrypted = encryptToken(\"ya29.a0AfH6SMB...\");\n * // Returns: \"rL8Kx2f...==:gH3pQ9...==:aB4cD5...\"\n */\nexport function encryptToken(plaintext: string): string {\n\ttry {\n\t\tconst key = getEncryptionKey();\n\n\t\t// Generate random IV (never reuse IVs!)\n\t\tconst iv = crypto.randomBytes(IV_LENGTH);\n\n\t\t// Create cipher\n\t\tconst cipher = crypto.createCipheriv(ALGORITHM, key, iv);\n\n\t\t// Encrypt\n\t\tlet ciphertext = cipher.update(plaintext, \"utf8\", ENCODING);\n\t\tciphertext += cipher.final(ENCODING);\n\n\t\t// Get authentication tag\n\t\tconst authTag = cipher.getAuthTag();\n\n\t\t// Return format: iv:authTag:ciphertext (all base64)\n\t\treturn [\n\t\t\tiv.toString(ENCODING),\n\t\t\tauthTag.toString(ENCODING),\n\t\t\tciphertext,\n\t\t].join(\":\");\n\t} catch (error) {\n\t\tconsole.error(\"[Token Encryption] Encryption failed:\", error);\n\t\tthrow new Error(\"Failed to encrypt token\");\n\t}\n}\n\n/**\n * Decrypt a token (refresh token or access token)\n *\n * @param encrypted - Encrypted token string (format: iv:authTag:ciphertext)\n * @returns Decrypted plaintext token\n *\n * @example\n * const plaintext = decryptToken(\"rL8Kx2f...==:gH3pQ9...==:aB4cD5...\");\n * // Returns: \"ya29.a0AfH6SMB...\"\n */\nexport function decryptToken(encrypted: string): string {\n\ttry {\n\t\tconst key = getEncryptionKey();\n\n\t\t// Parse encrypted format: iv:authTag:ciphertext\n\t\tconst parts = encrypted.split(\":\");\n\t\tif (parts.length !== 3) {\n\t\t\tthrow new Error(\"Invalid encrypted token format\");\n\t\t}\n\n\t\tconst [ivBase64, authTagBase64, ciphertext] = parts;\n\n\t\t// Convert from base64\n\t\tconst iv = Buffer.from(ivBase64, ENCODING);\n\t\tconst authTag = Buffer.from(authTagBase64, ENCODING);\n\n\t\t// Verify lengths\n\t\tif (iv.length !== IV_LENGTH) {\n\t\t\tthrow new Error(\"Invalid IV length\");\n\t\t}\n\n\t\tif (authTag.length !== AUTH_TAG_LENGTH) {\n\t\t\tthrow new Error(\"Invalid auth tag length\");\n\t\t}\n\n\t\t// Create decipher\n\t\tconst decipher = crypto.createDecipheriv(ALGORITHM, key, iv);\n\t\tdecipher.setAuthTag(authTag);\n\n\t\t// Decrypt\n\t\tlet plaintext = decipher.update(ciphertext, ENCODING, \"utf8\");\n\t\tplaintext += decipher.final(\"utf8\");\n\n\t\treturn plaintext;\n\t} catch (error) {\n\t\tconsole.error(\"[Token Encryption] Decryption failed:\", error);\n\t\tthrow new Error(\"Failed to decrypt token\");\n\t}\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Check if encryption key is configured\n * @returns True if key is set and valid\n */\nexport function isEncryptionConfigured(): boolean {\n\ttry {\n\t\tgetEncryptionKey();\n\t\treturn true;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n/**\n * Test encryption/decryption round-trip\n * Useful for validating configuration\n *\n * @returns True if encryption works correctly\n */\nexport function testEncryption(): boolean {\n\ttry {\n\t\tconst testToken = \"test_token_\" + crypto.randomBytes(32).toString(\"hex\");\n\t\tconst encrypted = encryptToken(testToken);\n\t\tconst decrypted = decryptToken(encrypted);\n\n\t\treturn decrypted === testToken;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n/**\n * Migrate existing plaintext tokens to encrypted format\n *\n * IMPORTANT: Run this as a one-time migration script\n * DO NOT run in production without backup!\n *\n * @example\n * // In a migration script:\n * await migrateTokensToEncrypted();\n */\nexport async function migrateTokensToEncrypted() {\n\t// This would be implemented as a standalone migration script\n\t// NOT included here to prevent accidental execution\n\tconsole.warn(\n\t\t\"[Token Encryption] Migration must be run as standalone script\"\n\t);\n\tthrow new Error(\"Use standalone migration script\");\n}\n\n// =============================================================================\n// WRAPPER FUNCTIONS FOR BACKWARD COMPATIBILITY\n// =============================================================================\n\n/**\n * Encrypt token with fallback for dev/test environments\n *\n * If encryption key not configured, returns plaintext (dev only!)\n * Production should always have encryption key configured\n */\nexport function encryptTokenSafe(plaintext: string): string {\n\tif (!isEncryptionConfigured()) {\n\t\tconsole.warn(\n\t\t\t\"[Token Encryption] Encryption key not configured - storing plaintext (DEV ONLY)\"\n\t\t);\n\t\treturn plaintext;\n\t}\n\n\treturn encryptToken(plaintext);\n}\n\n/**\n * Decrypt token with fallback for migration period\n *\n * If decryption fails (likely plaintext), returns as-is\n * Allows gradual migration from plaintext to encrypted\n */\nexport function decryptTokenSafe(encrypted: string): string {\n\tif (!isEncryptionConfigured()) {\n\t\tconsole.warn(\n\t\t\t\"[Token Encryption] Encryption key not configured - returning plaintext (DEV ONLY)\"\n\t\t);\n\t\treturn encrypted;\n\t}\n\n\t// Check if token is already encrypted (contains colons)\n\tif (!encrypted.includes(\":\")) {\n\t\tconsole.warn(\n\t\t\t\"[Token Encryption] Token appears to be plaintext - returning as-is (MIGRATION MODE)\"\n\t\t);\n\t\treturn encrypted;\n\t}\n\n\ttry {\n\t\treturn decryptToken(encrypted);\n\t} catch (error) {\n\t\tconsole.error(\n\t\t\t\"[Token Encryption] Decryption failed, returning plaintext:\",\n\t\t\terror\n\t\t);\n\t\treturn encrypted;\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1892, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/gmail-rate-limiter.ts"],"sourcesContent":["/**\n * Gmail API Rate Limiter\n *\n * Prevents Gmail API quota exhaustion and abuse by implementing rate limits\n * at multiple levels: per-user, per-company, and global.\n *\n * Gmail API Quotas (Google-imposed):\n * - 1 billion quota units per day (project-wide)\n * - 250 quota units/user/second\n * - messages.get = 5 units, messages.list = 5 units\n *\n * Our Limits:\n * - Per-user: 1 sync every 5 minutes (max 12 syncs/hour)\n * - Per-user: Max 100 messages per sync\n * - Global: Max 10 concurrent syncs\n * - API endpoints: 60 requests/minute per user\n *\n * Implementation:\n * - In-memory rate limiting with Map (resets on server restart)\n * - Redis for distributed rate limiting (optional, for multi-server)\n * - Automatic cleanup of stale entries\n *\n * @see https://developers.google.com/gmail/api/reference/quota\n */\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface RateLimitEntry {\n\tcount: number;\n\tfirstRequest: number;\n\tlastRequest: number;\n}\n\ninterface SyncLock {\n\tteamMemberId: string;\n\tstartedAt: number;\n\texpiresAt: number;\n}\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\n/** Minimum time between syncs per user (5 minutes) */\nconst SYNC_COOLDOWN_MS = 5 * 60 * 1000;\n\n/** Maximum messages per sync */\nconst MAX_MESSAGES_PER_SYNC = 100;\n\n/** Maximum concurrent syncs globally */\nconst MAX_CONCURRENT_SYNCS = 10;\n\n/** API rate limit: requests per window */\nconst API_RATE_LIMIT = 60;\n\n/** API rate limit window (1 minute) */\nconst API_RATE_WINDOW_MS = 60 * 1000;\n\n/** How long to keep rate limit entries in memory */\nconst RATE_LIMIT_CLEANUP_MS = 60 * 60 * 1000; // 1 hour\n\n/** How long a sync lock is valid (30 minutes max) */\nconst SYNC_LOCK_TIMEOUT_MS = 30 * 60 * 1000;\n\n// =============================================================================\n// IN-MEMORY STORAGE\n// =============================================================================\n\n/** Per-user API rate limits */\nconst apiRateLimits = new Map<string, RateLimitEntry>();\n\n/** Per-user last sync timestamps */\nconst lastSyncTimes = new Map<string, number>();\n\n/** Active sync locks */\nconst activeSyncLocks = new Set<SyncLock>();\n\n/** Cleanup interval */\nlet cleanupInterval: NodeJS.Timeout | null = null;\n\n// =============================================================================\n// RATE LIMIT CHECKING\n// =============================================================================\n\n/**\n * Check if user can make an API request\n *\n * @param userId - User ID (team_member_id)\n * @returns { allowed: boolean, retryAfter?: number }\n */\nexport function checkApiRateLimit(userId: string): {\n\tallowed: boolean;\n\tretryAfter?: number;\n} {\n\tconst now = Date.now();\n\tconst entry = apiRateLimits.get(userId);\n\n\tif (!entry) {\n\t\t// First request - allow and record\n\t\tapiRateLimits.set(userId, {\n\t\t\tcount: 1,\n\t\t\tfirstRequest: now,\n\t\t\tlastRequest: now,\n\t\t});\n\t\treturn { allowed: true };\n\t}\n\n\t// Check if window has expired\n\tconst windowAge = now - entry.firstRequest;\n\tif (windowAge > API_RATE_WINDOW_MS) {\n\t\t// Window expired - reset counter\n\t\tapiRateLimits.set(userId, {\n\t\t\tcount: 1,\n\t\t\tfirstRequest: now,\n\t\t\tlastRequest: now,\n\t\t});\n\t\treturn { allowed: true };\n\t}\n\n\t// Within window - check limit\n\tif (entry.count >= API_RATE_LIMIT) {\n\t\t// Rate limit exceeded\n\t\tconst retryAfter = Math.ceil(\n\t\t\t(entry.firstRequest + API_RATE_WINDOW_MS - now) / 1000\n\t\t);\n\t\treturn { allowed: false, retryAfter };\n\t}\n\n\t// Increment counter\n\tentry.count++;\n\tentry.lastRequest = now;\n\tapiRateLimits.set(userId, entry);\n\n\treturn { allowed: true };\n}\n\n/**\n * Check if user can start a sync\n *\n * @param teamMemberId - Team member ID\n * @returns { allowed: boolean, reason?: string, retryAfter?: number }\n */\nexport function checkSyncRateLimit(teamMemberId: string): {\n\tallowed: boolean;\n\treason?: string;\n\tretryAfter?: number;\n} {\n\tconst now = Date.now();\n\n\t// Check sync cooldown\n\tconst lastSync = lastSyncTimes.get(teamMemberId);\n\tif (lastSync) {\n\t\tconst timeSinceLastSync = now - lastSync;\n\t\tif (timeSinceLastSync < SYNC_COOLDOWN_MS) {\n\t\t\tconst retryAfter = Math.ceil(\n\t\t\t\t(SYNC_COOLDOWN_MS - timeSinceLastSync) / 1000\n\t\t\t);\n\t\t\treturn {\n\t\t\t\tallowed: false,\n\t\t\t\treason: \"Sync cooldown active\",\n\t\t\t\tretryAfter,\n\t\t\t};\n\t\t}\n\t}\n\n\t// Check concurrent sync limit\n\tconst activeCount = getActiveSyncCount();\n\tif (activeCount >= MAX_CONCURRENT_SYNCS) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Maximum concurrent syncs reached\",\n\t\t\tretryAfter: 60, // Retry in 1 minute\n\t\t};\n\t}\n\n\t// Check if user already has active sync\n\tconst existingLock = Array.from(activeSyncLocks).find(\n\t\t(lock) => lock.teamMemberId === teamMemberId\n\t);\n\n\tif (existingLock) {\n\t\t// Check if lock is expired\n\t\tif (now > existingLock.expiresAt) {\n\t\t\t// Lock expired - remove it\n\t\t\tactiveSyncLocks.delete(existingLock);\n\t\t} else {\n\t\t\treturn {\n\t\t\t\tallowed: false,\n\t\t\t\treason: \"Sync already in progress\",\n\t\t\t\tretryAfter: Math.ceil((existingLock.expiresAt - now) / 1000),\n\t\t\t};\n\t\t}\n\t}\n\n\treturn { allowed: true };\n}\n\n// =============================================================================\n// SYNC LOCK MANAGEMENT\n// =============================================================================\n\n/**\n * Acquire a sync lock for a user\n *\n * @param teamMemberId - Team member ID\n * @returns Lock ID if acquired, null if failed\n */\nexport function acquireSyncLock(teamMemberId: string): SyncLock | null {\n\tconst check = checkSyncRateLimit(teamMemberId);\n\tif (!check.allowed) {\n\t\treturn null;\n\t}\n\n\tconst now = Date.now();\n\tconst lock: SyncLock = {\n\t\tteamMemberId,\n\t\tstartedAt: now,\n\t\texpiresAt: now + SYNC_LOCK_TIMEOUT_MS,\n\t};\n\n\tactiveSyncLocks.add(lock);\n\tlastSyncTimes.set(teamMemberId, now);\n\n\treturn lock;\n}\n\n/**\n * Release a sync lock\n *\n * @param lock - Lock to release\n */\nexport function releaseSyncLock(lock: SyncLock): void {\n\tactiveSyncLocks.delete(lock);\n}\n\n/**\n * Get count of active syncs\n */\nexport function getActiveSyncCount(): number {\n\t// Clean up expired locks first\n\tconst now = Date.now();\n\tfor (const lock of activeSyncLocks) {\n\t\tif (now > lock.expiresAt) {\n\t\t\tactiveSyncLocks.delete(lock);\n\t\t}\n\t}\n\n\treturn activeSyncLocks.size;\n}\n\n// =============================================================================\n// CLEANUP\n// =============================================================================\n\n/**\n * Clean up stale rate limit entries\n */\nfunction cleanup(): void {\n\tconst now = Date.now();\n\n\t// Clean API rate limits\n\tfor (const [userId, entry] of apiRateLimits.entries()) {\n\t\tconst age = now - entry.lastRequest;\n\t\tif (age > RATE_LIMIT_CLEANUP_MS) {\n\t\t\tapiRateLimits.delete(userId);\n\t\t}\n\t}\n\n\t// Clean last sync times\n\tfor (const [userId, lastSync] of lastSyncTimes.entries()) {\n\t\tconst age = now - lastSync;\n\t\tif (age > RATE_LIMIT_CLEANUP_MS) {\n\t\t\tlastSyncTimes.delete(userId);\n\t\t}\n\t}\n\n\t// Clean expired sync locks\n\tfor (const lock of activeSyncLocks) {\n\t\tif (now > lock.expiresAt) {\n\t\t\tactiveSyncLocks.delete(lock);\n\t\t}\n\t}\n}\n\n/**\n * Start automatic cleanup\n */\nexport function startCleanup(): void {\n\tif (cleanupInterval) {\n\t\treturn; // Already started\n\t}\n\n\t// Run cleanup every 5 minutes\n\tcleanupInterval = setInterval(cleanup, 5 * 60 * 1000);\n\n\tconsole.log(\"[Gmail Rate Limiter] Cleanup scheduled\");\n}\n\n/**\n * Stop automatic cleanup\n */\nexport function stopCleanup(): void {\n\tif (cleanupInterval) {\n\t\tclearInterval(cleanupInterval);\n\t\tcleanupInterval = null;\n\t}\n}\n\n// =============================================================================\n// VALIDATION\n// =============================================================================\n\n/**\n * Validate sync request parameters\n *\n * @param maxResults - Requested message count\n * @returns { valid: boolean, error?: string }\n */\nexport function validateSyncParams(maxResults: number): {\n\tvalid: boolean;\n\terror?: string;\n} {\n\tif (maxResults <= 0) {\n\t\treturn { valid: false, error: \"maxResults must be positive\" };\n\t}\n\n\tif (maxResults > MAX_MESSAGES_PER_SYNC) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: `maxResults cannot exceed ${MAX_MESSAGES_PER_SYNC}`,\n\t\t};\n\t}\n\n\treturn { valid: true };\n}\n\n// =============================================================================\n// STATISTICS\n// =============================================================================\n\n/**\n * Get rate limiter statistics\n */\nexport function getRateLimiterStats(): {\n\tapiRateLimits: number;\n\tlastSyncTimes: number;\n\tactiveSyncs: number;\n\tmaxConcurrentSyncs: number;\n} {\n\treturn {\n\t\tapiRateLimits: apiRateLimits.size,\n\t\tlastSyncTimes: lastSyncTimes.size,\n\t\tactiveSyncs: getActiveSyncCount(),\n\t\tmaxConcurrentSyncs: MAX_CONCURRENT_SYNCS,\n\t};\n}\n\n/**\n * Reset all rate limits (for testing only!)\n */\nexport function resetRateLimits(): void {\n\tapiRateLimits.clear();\n\tlastSyncTimes.clear();\n\tactiveSyncLocks.clear();\n\tconsole.warn(\"[Gmail Rate Limiter] All rate limits reset\");\n}\n\n// =============================================================================\n// INITIALIZATION\n// =============================================================================\n\n// Start cleanup on module load\nstartCleanup();\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport const RATE_LIMITS = {\n\tSYNC_COOLDOWN_MS,\n\tMAX_MESSAGES_PER_SYNC,\n\tMAX_CONCURRENT_SYNCS,\n\tAPI_RATE_LIMIT,\n\tAPI_RATE_WINDOW_MS,\n} as const;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2163, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/audit-logger.ts"],"sourcesContent":["/**\n * Email Security Audit Logger\n *\n * Logs security-relevant events for compliance, investigation, and monitoring.\n * All logs are stored in the database with retention policies.\n *\n * Events Logged:\n * - Gmail connections/disconnections\n * - Token refresh failures\n * - Permission grants/revokes\n * - Sync errors\n * - Email access (optional, for compliance)\n *\n * Usage:\n * await logAuditEvent('gmail_connected', { teamMemberId, email });\n * await logAuditEvent('permission_granted', { grantedBy, grantedTo, category });\n *\n * Database Table: email_audit_log (to be created)\n *\n * @see /docs/email/SECURITY_AUDIT.md\n */\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\nimport type { EmailCategory } from \"./email-permissions\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Audit event types\n */\nexport type AuditEventType =\n\t// Gmail OAuth events\n\t| \"gmail_connected\"\n\t| \"gmail_disconnected\"\n\t| \"gmail_token_refreshed\"\n\t| \"gmail_token_refresh_failed\"\n\t| \"gmail_token_revoked\"\n\t// Permission events\n\t| \"permission_granted\"\n\t| \"permission_revoked\"\n\t| \"permission_updated\"\n\t| \"permission_check_failed\"\n\t// Sync events\n\t| \"sync_started\"\n\t| \"sync_completed\"\n\t| \"sync_failed\"\n\t| \"sync_rate_limited\"\n\t// Email access events (optional)\n\t| \"email_accessed\"\n\t| \"email_sent\"\n\t| \"email_assigned\"\n\t// Security events\n\t| \"unauthorized_access_attempt\"\n\t| \"permission_escalation_attempt\"\n\t| \"invalid_oauth_state\"\n\t// System events\n\t| \"token_cleanup_executed\"\n\t| \"rate_limit_exceeded\";\n\n/**\n * Audit event severity levels\n */\nexport type AuditSeverity = \"info\" | \"warning\" | \"error\" | \"critical\";\n\n/**\n * Audit event metadata\n */\nexport interface AuditEventMetadata {\n\t// Common fields\n\tteamMemberId?: string;\n\tcompanyId?: string;\n\tuserId?: string; // auth.uid\n\tuserName?: string;\n\n\t// Gmail fields\n\tgmailEmail?: string;\n\tgmailMessageId?: string;\n\tsyncMessageCount?: number;\n\n\t// Permission fields\n\tcategory?: EmailCategory;\n\tgrantedBy?: string;\n\tgrantedTo?: string;\n\tcanRead?: boolean;\n\tcanSend?: boolean;\n\tcanAssign?: boolean;\n\n\t// Email fields\n\tcommunicationId?: string;\n\temailSubject?: string;\n\tfromAddress?: string;\n\ttoAddress?: string;\n\n\t// Error fields\n\terror?: string;\n\terrorCode?: string;\n\tstackTrace?: string;\n\n\t// Rate limiting\n\tretryAfter?: number;\n\trequestsPerMinute?: number;\n\n\t// Additional context\n\tipAddress?: string;\n\tuserAgent?: string;\n\t[key: string]: any;\n}\n\n/**\n * Audit event record\n */\nexport interface AuditEvent {\n\tid: string;\n\teventType: AuditEventType;\n\tseverity: AuditSeverity;\n\tmessage: string;\n\tmetadata: AuditEventMetadata;\n\tcreatedAt: string;\n}\n\n// =============================================================================\n// LOGGING FUNCTIONS\n// =============================================================================\n\n/**\n * Log an audit event\n *\n * @param eventType - Type of event\n * @param metadata - Event metadata\n * @param severity - Event severity (default: info)\n * @param message - Optional custom message\n *\n * @example\n * await logAuditEvent('gmail_connected', {\n *   teamMemberId: 'xxx',\n *   gmailEmail: 'user@gmail.com'\n * });\n */\nexport async function logAuditEvent(\n\teventType: AuditEventType,\n\tmetadata: AuditEventMetadata = {},\n\tseverity: AuditSeverity = \"info\",\n\tmessage?: string\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\t// Generate default message if not provided\n\t\tconst defaultMessage = generateDefaultMessage(eventType, metadata);\n\n\t\t// In production, store in database\n\t\t// For now, log to console with structured format\n\t\tconst logEntry = {\n\t\t\ttimestamp: new Date().toISOString(),\n\t\t\teventType,\n\t\t\tseverity,\n\t\t\tmessage: message || defaultMessage,\n\t\t\tmetadata,\n\t\t};\n\n\t\t// Console output with color coding\n\t\tconst prefix = `[Email Audit]`;\n\t\tconst severityEmoji = {\n\t\t\tinfo: \"\",\n\t\t\twarning: \"\",\n\t\t\terror: \"\",\n\t\t\tcritical: \"\",\n\t\t}[severity];\n\n\t\tconsole.log(\n\t\t\t`${prefix} ${severityEmoji} [${severity.toUpperCase()}] ${logEntry.message}`,\n\t\t\tmetadata\n\t\t);\n\n\t\t// Store in database\n\t\ttry {\n\t\t\tconst supabase = await createServiceSupabaseClient();\n\t\t\tif (supabase) {\n\t\t\t\tawait supabase.from(\"email_audit_log\").insert({\n\t\t\t\t\tcompany_id: metadata.companyId || null,\n\t\t\t\t\tevent_type: eventType,\n\t\t\t\t\tseverity,\n\t\t\t\t\tmessage: logEntry.message,\n\t\t\t\t\tteam_member_id: metadata.teamMemberId || null,\n\t\t\t\t\tuser_id: metadata.userId || null,\n\t\t\t\t\tgmail_email: metadata.gmailEmail || null,\n\t\t\t\t\tmetadata,\n\t\t\t\t\tip_address: metadata.ipAddress || null,\n\t\t\t\t\tuser_agent: metadata.userAgent || null,\n\t\t\t\t});\n\t\t\t}\n\t\t} catch (dbError) {\n\t\t\t// Don't fail the audit log if database write fails - console log is still captured\n\t\t\tconsole.error(\"[Email Audit] Failed to store in database:\", dbError);\n\t\t}\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tconsole.error(\"[Email Audit] Failed to log event:\", error);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n\n/**\n * Generate default message for event type\n */\nfunction generateDefaultMessage(\n\teventType: AuditEventType,\n\tmetadata: AuditEventMetadata\n): string {\n\tconst name = metadata.userName || metadata.teamMemberId || \"User\";\n\n\tswitch (eventType) {\n\t\tcase \"gmail_connected\":\n\t\t\treturn `${name} connected Gmail account (${metadata.gmailEmail})`;\n\t\tcase \"gmail_disconnected\":\n\t\t\treturn `${name} disconnected Gmail account (${metadata.gmailEmail})`;\n\t\tcase \"gmail_token_refreshed\":\n\t\t\treturn `Gmail token refreshed for ${metadata.gmailEmail}`;\n\t\tcase \"gmail_token_refresh_failed\":\n\t\t\treturn `Failed to refresh Gmail token for ${metadata.gmailEmail}: ${metadata.error}`;\n\t\tcase \"gmail_token_revoked\":\n\t\t\treturn `Gmail token revoked for ${metadata.gmailEmail}`;\n\n\t\tcase \"permission_granted\":\n\t\t\treturn `${metadata.grantedBy} granted ${metadata.category} permissions to ${metadata.grantedTo}`;\n\t\tcase \"permission_revoked\":\n\t\t\treturn `${metadata.grantedBy} revoked ${metadata.category} permissions from ${metadata.grantedTo}`;\n\t\tcase \"permission_updated\":\n\t\t\treturn `${metadata.grantedBy} updated ${metadata.category} permissions for ${metadata.grantedTo}`;\n\t\tcase \"permission_check_failed\":\n\t\t\treturn `Permission check failed for ${name}: ${metadata.error}`;\n\n\t\tcase \"sync_started\":\n\t\t\treturn `${name} started inbox sync`;\n\t\tcase \"sync_completed\":\n\t\t\treturn `${name} completed inbox sync (${metadata.syncMessageCount} messages)`;\n\t\tcase \"sync_failed\":\n\t\t\treturn `Inbox sync failed for ${name}: ${metadata.error}`;\n\t\tcase \"sync_rate_limited\":\n\t\t\treturn `${name} sync rate limited (retry after ${metadata.retryAfter}s)`;\n\n\t\tcase \"email_accessed\":\n\t\t\treturn `${name} accessed email: ${metadata.emailSubject}`;\n\t\tcase \"email_sent\":\n\t\t\treturn `${name} sent email to ${metadata.toAddress}: ${metadata.emailSubject}`;\n\t\tcase \"email_assigned\":\n\t\t\treturn `${name} assigned email to ${metadata.grantedTo}`;\n\n\t\tcase \"unauthorized_access_attempt\":\n\t\t\treturn `Unauthorized access attempt by ${name}: ${metadata.error}`;\n\t\tcase \"permission_escalation_attempt\":\n\t\t\treturn `Permission escalation attempt by ${name}: ${metadata.error}`;\n\t\tcase \"invalid_oauth_state\":\n\t\t\treturn `Invalid OAuth state detected: ${metadata.error}`;\n\n\t\tcase \"token_cleanup_executed\":\n\t\t\treturn `Token cleanup executed: ${metadata.syncMessageCount} tokens removed`;\n\t\tcase \"rate_limit_exceeded\":\n\t\t\treturn `Rate limit exceeded for ${name} (${metadata.requestsPerMinute} req/min)`;\n\n\t\tdefault:\n\t\t\treturn `${eventType} event for ${name}`;\n\t}\n}\n\n// =============================================================================\n// CONVENIENCE FUNCTIONS\n// =============================================================================\n\n/**\n * Log Gmail connection\n */\nexport async function logGmailConnected(\n\tteamMemberId: string,\n\tuserName: string,\n\tgmailEmail: string,\n\tcompanyId: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"gmail_connected\",\n\t\t{ teamMemberId, userName, gmailEmail, companyId },\n\t\t\"info\"\n\t);\n}\n\n/**\n * Log Gmail disconnection\n */\nexport async function logGmailDisconnected(\n\tteamMemberId: string,\n\tuserName: string,\n\tgmailEmail: string,\n\tcompanyId: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"gmail_disconnected\",\n\t\t{ teamMemberId, userName, gmailEmail, companyId },\n\t\t\"info\"\n\t);\n}\n\n/**\n * Log token refresh failure\n */\nexport async function logTokenRefreshFailed(\n\tteamMemberId: string,\n\tgmailEmail: string,\n\terror: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"gmail_token_refresh_failed\",\n\t\t{ teamMemberId, gmailEmail, error },\n\t\t\"warning\"\n\t);\n}\n\n/**\n * Log permission grant\n */\nexport async function logPermissionGranted(\n\tgrantedBy: string,\n\tgrantedByName: string,\n\tgrantedTo: string,\n\tgrantedToName: string,\n\tcategory: EmailCategory,\n\tcompanyId: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"permission_granted\",\n\t\t{\n\t\t\tgrantedBy,\n\t\t\tuserName: grantedByName,\n\t\t\tgrantedTo,\n\t\t\tcategory,\n\t\t\tcompanyId,\n\t\t},\n\t\t\"info\"\n\t);\n}\n\n/**\n * Log permission revocation\n */\nexport async function logPermissionRevoked(\n\trevokedBy: string,\n\trevokedByName: string,\n\trevokedFrom: string,\n\trevokedFromName: string,\n\tcategory: EmailCategory,\n\tcompanyId: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"permission_revoked\",\n\t\t{\n\t\t\tgrantedBy: revokedBy,\n\t\t\tuserName: revokedByName,\n\t\t\tgrantedTo: revokedFrom,\n\t\t\tcategory,\n\t\t\tcompanyId,\n\t\t},\n\t\t\"info\"\n\t);\n}\n\n/**\n * Log sync failure\n */\nexport async function logSyncFailed(\n\tteamMemberId: string,\n\tuserName: string,\n\tgmailEmail: string,\n\terror: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"sync_failed\",\n\t\t{ teamMemberId, userName, gmailEmail, error },\n\t\t\"error\"\n\t);\n}\n\n/**\n * Log unauthorized access attempt\n */\nexport async function logUnauthorizedAccess(\n\tuserId: string,\n\tuserName: string,\n\tresource: string,\n\terror: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"unauthorized_access_attempt\",\n\t\t{ userId, userName, error, communicationId: resource },\n\t\t\"warning\"\n\t);\n}\n\n/**\n * Log rate limit exceeded\n */\nexport async function logRateLimitExceeded(\n\tuserId: string,\n\tuserName: string,\n\trequestsPerMinute: number,\n\tretryAfter: number\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"rate_limit_exceeded\",\n\t\t{ userId, userName, requestsPerMinute, retryAfter },\n\t\t\"warning\"\n\t);\n}\n\n// =============================================================================\n// QUERY FUNCTIONS\n// =============================================================================\n\n/**\n * Get audit events for a team member\n *\n * @param teamMemberId - Team member ID\n * @param limit - Max events to return\n * @returns List of audit events\n */\nexport async function getAuditEventsForUser(\n\tteamMemberId: string,\n\tlimit: number = 100\n): Promise<AuditEvent[]> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tif (!supabase) return [];\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"email_audit_log\")\n\t\t\t.select(\"id, event_type, severity, message, metadata, created_at\")\n\t\t\t.eq(\"team_member_id\", teamMemberId)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tif (error) {\n\t\t\tconsole.error(\"[Email Audit] Failed to query events for user:\", error);\n\t\t\treturn [];\n\t\t}\n\n\t\treturn (data || []).map((row) => ({\n\t\t\tid: row.id,\n\t\t\teventType: row.event_type as AuditEventType,\n\t\t\tseverity: row.severity as AuditSeverity,\n\t\t\tmessage: row.message,\n\t\t\tmetadata: row.metadata || {},\n\t\t\tcreatedAt: row.created_at,\n\t\t}));\n\t} catch (error) {\n\t\tconsole.error(\"[Email Audit] Failed to query events for user:\", error);\n\t\treturn [];\n\t}\n}\n\n/**\n * Get audit events for a company\n *\n * @param companyId - Company ID\n * @param limit - Max events to return\n * @returns List of audit events\n */\nexport async function getAuditEventsForCompany(\n\tcompanyId: string,\n\tlimit: number = 100\n): Promise<AuditEvent[]> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tif (!supabase) return [];\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"email_audit_log\")\n\t\t\t.select(\"id, event_type, severity, message, metadata, created_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tif (error) {\n\t\t\tconsole.error(\"[Email Audit] Failed to query events for company:\", error);\n\t\t\treturn [];\n\t\t}\n\n\t\treturn (data || []).map((row) => ({\n\t\t\tid: row.id,\n\t\t\teventType: row.event_type as AuditEventType,\n\t\t\tseverity: row.severity as AuditSeverity,\n\t\t\tmessage: row.message,\n\t\t\tmetadata: row.metadata || {},\n\t\t\tcreatedAt: row.created_at,\n\t\t}));\n\t} catch (error) {\n\t\tconsole.error(\"[Email Audit] Failed to query events for company:\", error);\n\t\treturn [];\n\t}\n}\n\n/**\n * Get critical security events\n *\n * @param limit - Max events to return\n * @returns List of critical events\n */\nexport async function getCriticalSecurityEvents(\n\tlimit: number = 50\n): Promise<AuditEvent[]> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tif (!supabase) return [];\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"email_audit_log\")\n\t\t\t.select(\"id, event_type, severity, message, metadata, created_at\")\n\t\t\t.in(\"severity\", [\"error\", \"critical\"])\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tif (error) {\n\t\t\tconsole.error(\"[Email Audit] Failed to query critical events:\", error);\n\t\t\treturn [];\n\t\t}\n\n\t\treturn (data || []).map((row) => ({\n\t\t\tid: row.id,\n\t\t\teventType: row.event_type as AuditEventType,\n\t\t\tseverity: row.severity as AuditSeverity,\n\t\t\tmessage: row.message,\n\t\t\tmetadata: row.metadata || {},\n\t\t\tcreatedAt: row.created_at,\n\t\t}));\n\t} catch (error) {\n\t\tconsole.error(\"[Email Audit] Failed to query critical events:\", error);\n\t\treturn [];\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2460, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/gmail-client.ts"],"sourcesContent":["/**\n * Gmail API Client (Company-Level & Per-User / Multi-Tenant)\n *\n * CRITICAL: Reply-to addresses ALWAYS use the platform subdomain (mail.thorbis.com),\n * even when sending from personal Gmail. This ensures replies go to the company's\n * centralized inbox, not the personal Gmail account.\n *\n * Example:\n * - FROM: john@gmail.com (personal Gmail)\n * - REPLY-TO: support@acme-plumbing.mail.thorbis.com (platform subdomain)\n *\n * See: /docs/email/REPLY_TO_ARCHITECTURE.md for full details\n *\n * This module provides Gmail API integration at two levels:\n * 1. Company-Level: One Gmail account for the entire company (sending only)\n * 2. Per-User: Individual team member Gmail accounts (inbox access + sending)\n *\n * Multi-Tenant Architecture:\n * - Each company can configure their own email provider\n * - Options: 'managed' (Resend/Postmark), 'gmail', or 'disabled'\n * - Company tokens stored in company_gmail_tokens table\n * - Per-user tokens stored in user_gmail_tokens table\n *\n * Key Features:\n * - Send emails via company's Gmail API\n * - Per-user inbox access and synchronization\n * - Automatic token refresh before expiration\n * - Token validation and error handling\n * - Integration with provider monitoring\n *\n * How It Works (Company-Level):\n * 1. Company admin connects Gmail via OAuth (grants gmail.send scope)\n * 2. Tokens stored in company_gmail_tokens table\n * 3. Before sending, we check/refresh tokens\n * 4. Use Gmail API to send email as company\n *\n * How It Works (Per-User):\n * 1. Team member connects their Gmail via OAuth (grants gmail.readonly + gmail.send)\n * 2. Tokens stored in user_gmail_tokens table\n * 3. Background sync job fetches inbox emails every 5-10 minutes\n * 4. Emails stored in communications table with mailbox_owner_id\n * 5. Role-based permissions control who can see which emails\n *\n * Rate Limits (Gmail API):\n * - Consumer accounts: 100 emails/day\n * - Google Workspace: 2,000 emails/day\n * - Per-minute limit: 100 messages\n *\n * Required Scopes:\n * - Company: https://www.googleapis.com/auth/gmail.send\n * - Per-User: https://www.googleapis.com/auth/gmail.readonly, gmail.send\n *\n * Environment Variables:\n * - GOOGLE_CLIENT_ID: OAuth client ID\n * - GOOGLE_CLIENT_SECRET: OAuth client secret\n *\n * @see https://developers.google.com/gmail/api/reference/rest\n */\n\n\"use server\";\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\nimport { encryptToken, decryptToken } from \"@/lib/email/token-encryption\";\nimport { checkSyncRateLimit, acquireSyncLock, releaseSyncLock, checkApiRateLimit, validateSyncParams } from \"@/lib/email/gmail-rate-limiter\";\nimport { logGmailConnected, logGmailDisconnected, logAuditEvent, logTokenRefreshFailed, logSyncFailed } from \"@/lib/email/audit-logger\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Company email provider options\n */\nexport type CompanyEmailProvider = \"managed\" | \"gmail\" | \"disabled\";\n\n/**\n * Gmail OAuth token data structure (company-level)\n */\nexport interface CompanyGmailTokenData {\n\tcompanyId: string;\n\tgmailEmail: string;\n\tgmailDisplayName?: string;\n\taccessToken: string;\n\trefreshToken: string;\n\ttokenExpiresAt: Date;\n\tisValid: boolean;\n\tscopes: string[];\n\tconnectedBy?: string;\n\tconnectedByName?: string;\n}\n\n/**\n * Result of sending an email via Gmail\n */\nexport interface GmailSendResult {\n\tsuccess: boolean;\n\tmessageId?: string;\n\tthreadId?: string;\n\terror?: string;\n\tlabelIds?: string[];\n}\n\n/**\n * Email data for Gmail sending\n */\nexport interface GmailEmailData {\n\tto: string | string[];\n\tsubject: string;\n\thtml: string;\n\ttext?: string;\n\treplyTo?: string;\n\tcc?: string | string[];\n\tbcc?: string | string[];\n\theaders?: Record<string, string>;\n}\n\n/**\n * Token refresh response from Google\n */\ninterface GoogleTokenResponse {\n\taccess_token: string;\n\texpires_in: number;\n\ttoken_type: string;\n\tscope?: string;\n\trefresh_token?: string;\n}\n\n/**\n * Per-user Gmail token data structure\n */\nexport interface UserGmailTokenData {\n\tteamMemberId: string;\n\temailAccountId: string;\n\tgmailEmail: string;\n\taccessToken: string;\n\trefreshToken: string;\n\ttokenExpiresAt: Date;\n\tscopes: string[];\n\tsyncEnabled: boolean;\n\tlastSyncedAt?: Date;\n}\n\n/**\n * Gmail message from API\n */\nexport interface GmailMessage {\n\tid: string;\n\tthreadId: string;\n\tlabelIds: string[];\n\tsnippet: string;\n\tpayload: {\n\t\theaders: Array<{ name: string; value: string }>;\n\t\tparts?: Array<{\n\t\t\tmimeType: string;\n\t\t\tbody: { data?: string; size: number };\n\t\t\tparts?: any[];\n\t\t}>;\n\t\tbody?: { data?: string; size: number };\n\t\tmimeType: string;\n\t};\n\tinternalDate: string;\n\tsizeEstimate: number;\n}\n\n/**\n * Parsed email message\n */\nexport interface ParsedGmailMessage {\n\tgmailMessageId: string;\n\tgmailThreadId: string;\n\tfrom: string;\n\tto: string[];\n\tcc?: string[];\n\tsubject: string;\n\ttextBody?: string;\n\thtmlBody?: string;\n\treceivedAt: Date;\n\thasAttachments: boolean;\n\tlabels: string[];\n}\n\n/**\n * Inbox sync result\n */\nexport interface InboxSyncResult {\n\tsuccess: boolean;\n\tmessagesFetched: number;\n\tmessagesStored: number;\n\terrors: string[];\n\tlastSyncedAt: Date;\n}\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\nconst GOOGLE_TOKEN_URL = \"https://oauth2.googleapis.com/token\";\nconst GMAIL_API_URL = \"https://gmail.googleapis.com/gmail/v1\";\nconst GMAIL_SEND_SCOPE = \"https://www.googleapis.com/auth/gmail.send\";\nconst GMAIL_READONLY_SCOPE = \"https://www.googleapis.com/auth/gmail.readonly\";\nconst GMAIL_MODIFY_SCOPE = \"https://www.googleapis.com/auth/gmail.modify\";\nconst TOKEN_REFRESH_BUFFER_MS = 5 * 60 * 1000;\n\n// =============================================================================\n// COMPANY EMAIL PROVIDER PREFERENCE\n// =============================================================================\n\n/**\n * Get company's email provider preference\n */\nexport async function getCompanyEmailProvider(\n\tcompanyId: string\n): Promise<CompanyEmailProvider> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tconst { data } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"email_provider\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\treturn (data?.email_provider as CompanyEmailProvider) || \"managed\";\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] Error getting company email provider:\", error);\n\t\treturn \"managed\";\n\t}\n}\n\n/**\n * Set company's email provider preference\n */\nexport async function setCompanyEmailProvider(\n\tcompanyId: string,\n\tprovider: CompanyEmailProvider,\n\tupdatedByUserId?: string\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\t// If switching to Gmail, verify tokens exist\n\t\tif (provider === \"gmail\") {\n\t\t\tconst tokens = await getCompanyGmailTokens(companyId);\n\t\t\tif (!tokens || !tokens.isValid) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: \"Gmail is not connected. Please connect Gmail first.\",\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tconst { error } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.update({\n\t\t\t\temail_provider: provider,\n\t\t\t\temail_provider_updated_at: new Date().toISOString(),\n\t\t\t\temail_provider_updated_by: updatedByUserId || null,\n\t\t\t})\n\t\t\t.eq(\"id\", companyId);\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\tconsole.log(`[Gmail] Company ${companyId} email provider set to: ${provider}`);\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\treturn { success: false, error: message };\n\t}\n}\n\n// =============================================================================\n// TOKEN MANAGEMENT (COMPANY-LEVEL)\n// =============================================================================\n\n/**\n * Get Gmail tokens for a company\n */\nexport async function getCompanyGmailTokens(\n\tcompanyId: string\n): Promise<CompanyGmailTokenData | null> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"company_gmail_tokens\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.maybeSingle();\n\n\t\tif (error || !data) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst tokenData: CompanyGmailTokenData = {\n\t\t\tcompanyId: data.company_id,\n\t\t\tgmailEmail: data.gmail_email,\n\t\t\tgmailDisplayName: data.gmail_display_name,\n\t\t\taccessToken: data.access_token,\n\t\t\trefreshToken: data.refresh_token,\n\t\t\ttokenExpiresAt: new Date(data.token_expires_at),\n\t\t\tisValid: data.is_valid,\n\t\t\tscopes: data.scopes || [GMAIL_SEND_SCOPE],\n\t\t\tconnectedBy: data.connected_by,\n\t\t\tconnectedByName: data.connected_by_name,\n\t\t};\n\n\t\t// Check if token needs refresh\n\t\tif (isTokenExpiringSoon(tokenData.tokenExpiresAt)) {\n\t\t\tconsole.log(`[Gmail] Token expiring soon for company ${companyId}, refreshing...`);\n\t\t\tconst refreshed = await refreshCompanyGmailToken(companyId, tokenData.refreshToken);\n\t\t\tif (refreshed) {\n\t\t\t\treturn refreshed;\n\t\t\t}\n\t\t\tconsole.warn(\"[Gmail] Token refresh failed, using existing token\");\n\t\t}\n\n\t\treturn tokenData;\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] Error getting company tokens:\", error);\n\t\treturn null;\n\t}\n}\n\nfunction isTokenExpiringSoon(expiresAt: Date): boolean {\n\treturn expiresAt.getTime() - Date.now() < TOKEN_REFRESH_BUFFER_MS;\n}\n\n/**\n * Refresh Gmail OAuth token for a company\n */\nexport async function refreshCompanyGmailToken(\n\tcompanyId: string,\n\trefreshToken: string\n): Promise<CompanyGmailTokenData | null> {\n\ttry {\n\t\tconst clientId = process.env.GOOGLE_CLIENT_ID;\n\t\tconst clientSecret = process.env.GOOGLE_CLIENT_SECRET;\n\n\t\tif (!clientId || !clientSecret) {\n\t\t\tconsole.error(\"[Gmail] Missing GOOGLE_CLIENT_ID or GOOGLE_CLIENT_SECRET\");\n\t\t\treturn null;\n\t\t}\n\n\t\tconst response = await fetch(GOOGLE_TOKEN_URL, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n\t\t\tbody: new URLSearchParams({\n\t\t\t\tclient_id: clientId,\n\t\t\t\tclient_secret: clientSecret,\n\t\t\t\trefresh_token: refreshToken,\n\t\t\t\tgrant_type: \"refresh_token\",\n\t\t\t}),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tconst errorText = await response.text();\n\t\t\tconsole.error(`[Gmail] Token refresh failed: ${response.status}`, errorText);\n\t\t\tif (response.status === 400 || response.status === 401) {\n\t\t\t\tawait markCompanyTokenInvalid(companyId, `Refresh failed: ${response.status}`);\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\n\t\tconst tokenResponse: GoogleTokenResponse = await response.json();\n\t\tconst expiresAt = new Date(Date.now() + tokenResponse.expires_in * 1000);\n\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"company_gmail_tokens\")\n\t\t\t.update({\n\t\t\t\taccess_token: tokenResponse.access_token,\n\t\t\t\ttoken_expires_at: expiresAt.toISOString(),\n\t\t\t\t...(tokenResponse.refresh_token && { refresh_token: tokenResponse.refresh_token }),\n\t\t\t\tis_valid: true,\n\t\t\t\tlast_error: null,\n\t\t\t})\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select(\"*\")\n\t\t\t.single();\n\n\t\tif (error || !data) {\n\t\t\tconsole.error(\"[Gmail] Failed to update refreshed token:\", error?.message);\n\t\t\treturn null;\n\t\t}\n\n\t\tconsole.log(`[Gmail] Token refreshed for company ${companyId}`);\n\n\t\treturn {\n\t\t\tcompanyId: data.company_id,\n\t\t\tgmailEmail: data.gmail_email,\n\t\t\tgmailDisplayName: data.gmail_display_name,\n\t\t\taccessToken: data.access_token,\n\t\t\trefreshToken: data.refresh_token,\n\t\t\ttokenExpiresAt: new Date(data.token_expires_at),\n\t\t\tisValid: data.is_valid,\n\t\t\tscopes: data.scopes || [GMAIL_SEND_SCOPE],\n\t\t\tconnectedBy: data.connected_by,\n\t\t\tconnectedByName: data.connected_by_name,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] Token refresh error:\", error);\n\t\treturn null;\n\t}\n}\n\nasync function markCompanyTokenInvalid(companyId: string, reason: string): Promise<void> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tawait supabase\n\t\t\t.from(\"company_gmail_tokens\")\n\t\t\t.update({ is_valid: false, last_error: reason })\n\t\t\t.eq(\"company_id\", companyId);\n\t\tconsole.log(`[Gmail] Marked token invalid for company ${companyId}: ${reason}`);\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] Failed to mark token invalid:\", error);\n\t}\n}\n\n/**\n * Store Gmail OAuth tokens for a company\n */\nexport async function storeCompanyGmailTokens(\n\tcompanyId: string,\n\tgmailEmail: string,\n\tdisplayName: string | null,\n\taccessToken: string,\n\trefreshToken: string,\n\texpiresIn: number,\n\tscopes: string[],\n\tconnectedByUserId?: string,\n\tconnectedByName?: string\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tif (!scopes.includes(GMAIL_SEND_SCOPE)) {\n\t\t\treturn { success: false, error: `Missing required scope: ${GMAIL_SEND_SCOPE}` };\n\t\t}\n\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tconst expiresAt = new Date(Date.now() + expiresIn * 1000);\n\n\t\tconst { error } = await supabase.from(\"company_gmail_tokens\").upsert(\n\t\t\t{\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tgmail_email: gmailEmail,\n\t\t\t\tgmail_display_name: displayName,\n\t\t\t\taccess_token: accessToken,\n\t\t\t\trefresh_token: refreshToken,\n\t\t\t\ttoken_expires_at: expiresAt.toISOString(),\n\t\t\t\tscopes,\n\t\t\t\tis_valid: true,\n\t\t\t\tlast_error: null,\n\t\t\t\tconnected_by: connectedByUserId || null,\n\t\t\t\tconnected_by_name: connectedByName || null,\n\t\t\t},\n\t\t\t{ onConflict: \"company_id\" }\n\t\t);\n\n\t\tif (error) {\n\t\t\tconsole.error(\"[Gmail] Failed to store tokens:\", error.message);\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\tconsole.log(`[Gmail] Stored tokens for company ${companyId} (${gmailEmail})`);\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\treturn { success: false, error: message };\n\t}\n}\n\n/**\n * Disconnect Gmail from a company\n */\nexport async function disconnectCompanyGmail(\n\tcompanyId: string\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\t// Get token to revoke\n\t\tconst { data: tokenData } = await supabase\n\t\t\t.from(\"company_gmail_tokens\")\n\t\t\t.select(\"access_token\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\t// Delete from database\n\t\tconst { error } = await supabase\n\t\t\t.from(\"company_gmail_tokens\")\n\t\t\t.delete()\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\t// Reset to managed provider\n\t\tawait setCompanyEmailProvider(companyId, \"managed\");\n\n\t\t// Revoke token with Google (best effort)\n\t\tif (tokenData?.access_token) {\n\t\t\ttry {\n\t\t\t\tawait fetch(`https://oauth2.googleapis.com/revoke?token=${tokenData.access_token}`, {\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t});\n\t\t\t} catch {\n\t\t\t\tconsole.warn(\"[Gmail] Token revocation request failed (non-critical)\");\n\t\t\t}\n\t\t}\n\n\t\tconsole.log(`[Gmail] Disconnected Gmail for company ${companyId}`);\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\treturn { success: false, error: message };\n\t}\n}\n\n// =============================================================================\n// EMAIL SENDING\n// =============================================================================\n\n/**\n * Send an email via company's Gmail\n */\nexport async function sendCompanyGmailEmail(\n\tcompanyId: string,\n\temailData: GmailEmailData\n): Promise<GmailSendResult> {\n\ttry {\n\t\tconst tokens = await getCompanyGmailTokens(companyId);\n\t\tif (!tokens) {\n\t\t\treturn { success: false, error: \"Gmail not connected for this company\" };\n\t\t}\n\n\t\tif (!tokens.isValid) {\n\t\t\treturn { success: false, error: `Gmail connection invalid: ${tokens.gmailEmail}` };\n\t\t}\n\n\t\tconst mimeMessage = buildMimeMessage({\n\t\t\tfrom: tokens.gmailDisplayName\n\t\t\t\t? `${tokens.gmailDisplayName} <${tokens.gmailEmail}>`\n\t\t\t\t: tokens.gmailEmail,\n\t\t\tto: Array.isArray(emailData.to) ? emailData.to.join(\", \") : emailData.to,\n\t\t\tsubject: emailData.subject,\n\t\t\thtml: emailData.html,\n\t\t\ttext: emailData.text,\n\t\t\treplyTo: emailData.replyTo,\n\t\t\tcc: emailData.cc ? (Array.isArray(emailData.cc) ? emailData.cc.join(\", \") : emailData.cc) : undefined,\n\t\t\tbcc: emailData.bcc ? (Array.isArray(emailData.bcc) ? emailData.bcc.join(\", \") : emailData.bcc) : undefined,\n\t\t\theaders: emailData.headers,\n\t\t});\n\n\t\tconst encodedMessage = base64UrlEncode(mimeMessage);\n\n\t\tconst response = await fetch(`${GMAIL_API_URL}/users/me/messages/send`, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: {\n\t\t\t\tAuthorization: `Bearer ${tokens.accessToken}`,\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t},\n\t\t\tbody: JSON.stringify({ raw: encodedMessage }),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tconst errorData = await response.json().catch(() => ({}));\n\t\t\tconst errorMessage = errorData.error?.message || `Gmail API error: ${response.status}`;\n\t\t\tconsole.error(`[Gmail] Send failed: ${errorMessage}`);\n\t\t\tif (response.status === 401) {\n\t\t\t\tawait markCompanyTokenInvalid(companyId, \"Authentication failed\");\n\t\t\t}\n\t\t\treturn { success: false, error: errorMessage };\n\t\t}\n\n\t\tconst result = await response.json();\n\n\t\t// Update last used timestamp\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tawait supabase\n\t\t\t.from(\"company_gmail_tokens\")\n\t\t\t.update({ last_used_at: new Date().toISOString() })\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tconsole.log(`[Gmail] Sent email for company ${companyId} (ID: ${result.id})`);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.id,\n\t\t\tthreadId: result.threadId,\n\t\t\tlabelIds: result.labelIds,\n\t\t};\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\tconsole.error(\"[Gmail] Send error:\", message);\n\t\treturn { success: false, error: message };\n\t}\n}\n\n// =============================================================================\n// MIME MESSAGE BUILDING\n// =============================================================================\n\ninterface MimeMessageParts {\n\tfrom: string;\n\tto: string;\n\tsubject: string;\n\thtml: string;\n\ttext?: string;\n\treplyTo?: string;\n\tcc?: string;\n\tbcc?: string;\n\theaders?: Record<string, string>;\n}\n\nfunction buildMimeMessage(parts: MimeMessageParts): string {\n\tconst boundary = `boundary_${Date.now()}_${Math.random().toString(36).substring(7)}`;\n\n\tconst lines: string[] = [\n\t\t`From: ${parts.from}`,\n\t\t`To: ${parts.to}`,\n\t\t`Subject: =?UTF-8?B?${Buffer.from(parts.subject).toString(\"base64\")}?=`,\n\t\t\"MIME-Version: 1.0\",\n\t];\n\n\tif (parts.replyTo) lines.push(`Reply-To: ${parts.replyTo}`);\n\tif (parts.cc) lines.push(`Cc: ${parts.cc}`);\n\tif (parts.bcc) lines.push(`Bcc: ${parts.bcc}`);\n\n\tif (parts.headers) {\n\t\tfor (const [key, value] of Object.entries(parts.headers)) {\n\t\t\tlines.push(`${key}: ${value}`);\n\t\t}\n\t}\n\n\tlines.push(`Content-Type: multipart/alternative; boundary=\"${boundary}\"`);\n\tlines.push(\"\");\n\n\tconst textContent = parts.text || extractTextFromHtml(parts.html);\n\tlines.push(`--${boundary}`);\n\tlines.push(\"Content-Type: text/plain; charset=UTF-8\");\n\tlines.push(\"Content-Transfer-Encoding: base64\");\n\tlines.push(\"\");\n\tlines.push(Buffer.from(textContent).toString(\"base64\"));\n\n\tlines.push(`--${boundary}`);\n\tlines.push(\"Content-Type: text/html; charset=UTF-8\");\n\tlines.push(\"Content-Transfer-Encoding: base64\");\n\tlines.push(\"\");\n\tlines.push(Buffer.from(parts.html).toString(\"base64\"));\n\n\tlines.push(`--${boundary}--`);\n\n\treturn lines.join(\"\\r\\n\");\n}\n\nfunction extractTextFromHtml(html: string): string {\n\treturn html\n\t\t.replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, \"\")\n\t\t.replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, \"\")\n\t\t.replace(/<[^>]+>/g, \" \")\n\t\t.replace(/\\s+/g, \" \")\n\t\t.trim();\n}\n\nfunction base64UrlEncode(str: string): string {\n\treturn Buffer.from(str)\n\t\t.toString(\"base64\")\n\t\t.replace(/\\+/g, \"-\")\n\t\t.replace(/\\//g, \"_\")\n\t\t.replace(/=+$/, \"\");\n}\n\n// =============================================================================\n// HEALTH CHECK\n// =============================================================================\n\n/**\n * Check Gmail health for a company\n */\nexport async function checkCompanyGmailHealth(\n\tcompanyId: string,\n\ttestApi: boolean = false\n): Promise<{\n\tconnected: boolean;\n\temail?: string;\n\tdisplayName?: string;\n\ttokenValid: boolean;\n\ttokenExpiresAt?: Date;\n\tapiHealthy?: boolean;\n\tconnectedBy?: string;\n\terror?: string;\n}> {\n\ttry {\n\t\tconst tokens = await getCompanyGmailTokens(companyId);\n\n\t\tif (!tokens) {\n\t\t\treturn { connected: false, tokenValid: false };\n\t\t}\n\n\t\tconst result = {\n\t\t\tconnected: true,\n\t\t\temail: tokens.gmailEmail,\n\t\t\tdisplayName: tokens.gmailDisplayName,\n\t\t\ttokenValid: tokens.isValid,\n\t\t\ttokenExpiresAt: tokens.tokenExpiresAt,\n\t\t\tconnectedBy: tokens.connectedByName,\n\t\t\tapiHealthy: undefined as boolean | undefined,\n\t\t};\n\n\t\tif (testApi && tokens.isValid) {\n\t\t\ttry {\n\t\t\t\tconst response = await fetch(`${GMAIL_API_URL}/users/me/profile`, {\n\t\t\t\t\theaders: { Authorization: `Bearer ${tokens.accessToken}` },\n\t\t\t\t});\n\t\t\t\tresult.apiHealthy = response.ok;\n\t\t\t} catch {\n\t\t\t\tresult.apiHealthy = false;\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tconnected: false,\n\t\t\ttokenValid: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// PER-USER TOKEN MANAGEMENT\n// =============================================================================\n\n/**\n * Get Gmail tokens for a specific team member\n */\nexport async function getUserGmailTokens(\n\tteamMemberId: string\n): Promise<UserGmailTokenData | null> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"user_gmail_tokens\")\n\t\t\t.select(\"*, user_email_accounts!inner(email_address)\")\n\t\t\t.eq(\"team_member_id\", teamMemberId)\n\t\t\t.eq(\"sync_enabled\", true)\n\t\t\t.maybeSingle();\n\n\t\tif (error || !data) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Decrypt tokens before using (CRITICAL SECURITY)\n\t\tconst decryptedAccessToken = decryptToken(data.access_token);\n\t\tconst decryptedRefreshToken = decryptToken(data.refresh_token);\n\n\t\tconst tokenData: UserGmailTokenData = {\n\t\t\tteamMemberId: data.team_member_id,\n\t\t\temailAccountId: data.user_email_account_id,\n\t\t\tgmailEmail: data.user_email_accounts.email_address,\n\t\t\taccessToken: decryptedAccessToken,\n\t\t\trefreshToken: decryptedRefreshToken,\n\t\t\ttokenExpiresAt: new Date(data.token_expiry),\n\t\t\tscopes: data.scopes || [],\n\t\t\tsyncEnabled: data.sync_enabled,\n\t\t\tlastSyncedAt: data.last_synced_at ? new Date(data.last_synced_at) : undefined,\n\t\t};\n\n\t\t// Check if token needs refresh\n\t\tif (isTokenExpiringSoon(tokenData.tokenExpiresAt)) {\n\t\t\tconsole.log(`[Gmail] Token expiring soon for user ${teamMemberId}, refreshing...`);\n\t\t\tconst refreshed = await refreshUserGmailToken(teamMemberId, tokenData.refreshToken);\n\t\t\tif (refreshed) {\n\t\t\t\treturn refreshed;\n\t\t\t}\n\t\t\tconsole.warn(\"[Gmail] User token refresh failed, using existing token\");\n\t\t}\n\n\t\treturn tokenData;\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] Error getting user tokens:\", error);\n\t\treturn null;\n\t}\n}\n\n/**\n * Refresh Gmail OAuth token for a team member\n */\nexport async function refreshUserGmailToken(\n\tteamMemberId: string,\n\trefreshToken: string\n): Promise<UserGmailTokenData | null> {\n\ttry {\n\t\tconst clientId = process.env.GOOGLE_CLIENT_ID;\n\t\tconst clientSecret = process.env.GOOGLE_CLIENT_SECRET;\n\n\t\tif (!clientId || !clientSecret) {\n\t\t\tconsole.error(\"[Gmail] Missing GOOGLE_CLIENT_ID or GOOGLE_CLIENT_SECRET\");\n\t\t\treturn null;\n\t\t}\n\n\t\tconst response = await fetch(GOOGLE_TOKEN_URL, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n\t\t\tbody: new URLSearchParams({\n\t\t\t\tclient_id: clientId,\n\t\t\t\tclient_secret: clientSecret,\n\t\t\t\trefresh_token: refreshToken,\n\t\t\t\tgrant_type: \"refresh_token\",\n\t\t\t}),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tconst errorText = await response.text();\n\t\t\tconsole.error(`[Gmail] User token refresh failed: ${response.status}`, errorText);\n\n\t\t\t// Log token refresh failure for audit trail\n\t\t\tawait logTokenRefreshFailed(\n\t\t\t\tteamMemberId,\n\t\t\t\t\"Unknown\", // Gmail email not available here\n\t\t\t\t`Token refresh failed: ${response.status} - ${errorText}`\n\t\t\t);\n\n\t\t\tif (response.status === 400 || response.status === 401) {\n\t\t\t\tawait markUserTokenInvalid(teamMemberId, `Refresh failed: ${response.status}`);\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\n\t\tconst tokenResponse: GoogleTokenResponse = await response.json();\n\t\tconst expiresAt = new Date(Date.now() + tokenResponse.expires_in * 1000);\n\n\t\t// Encrypt refreshed tokens before storing (CRITICAL SECURITY)\n\t\tconst encryptedAccessToken = encryptToken(tokenResponse.access_token);\n\t\tconst encryptedRefreshToken = tokenResponse.refresh_token\n\t\t\t? encryptToken(tokenResponse.refresh_token)\n\t\t\t: undefined;\n\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"user_gmail_tokens\")\n\t\t\t.update({\n\t\t\t\taccess_token: encryptedAccessToken,\n\t\t\t\ttoken_expiry: expiresAt.toISOString(),\n\t\t\t\t...(encryptedRefreshToken && { refresh_token: encryptedRefreshToken }),\n\t\t\t})\n\t\t\t.eq(\"team_member_id\", teamMemberId)\n\t\t\t.select(\"*, user_email_accounts!inner(email_address)\")\n\t\t\t.single();\n\n\t\tif (error || !data) {\n\t\t\tconsole.error(\"[Gmail] Failed to update refreshed user token:\", error?.message);\n\t\t\treturn null;\n\t\t}\n\n\t\tconsole.log(`[Gmail] User token refreshed for team member ${teamMemberId}`);\n\n\t\t// Decrypt tokens for return (already encrypted in DB)\n\t\tconst decryptedAccessToken = decryptToken(data.access_token);\n\t\tconst decryptedRefreshToken = decryptToken(data.refresh_token);\n\n\t\treturn {\n\t\t\tteamMemberId: data.team_member_id,\n\t\t\temailAccountId: data.user_email_account_id,\n\t\t\tgmailEmail: data.user_email_accounts.email_address,\n\t\t\taccessToken: decryptedAccessToken,\n\t\t\trefreshToken: decryptedRefreshToken,\n\t\t\ttokenExpiresAt: new Date(data.token_expiry),\n\t\t\tscopes: data.scopes || [],\n\t\t\tsyncEnabled: data.sync_enabled,\n\t\t\tlastSyncedAt: data.last_synced_at ? new Date(data.last_synced_at) : undefined,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] User token refresh error:\", error);\n\t\treturn null;\n\t}\n}\n\nasync function markUserTokenInvalid(teamMemberId: string, reason: string): Promise<void> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tawait supabase\n\t\t\t.from(\"user_gmail_tokens\")\n\t\t\t.update({ sync_enabled: false })\n\t\t\t.eq(\"team_member_id\", teamMemberId);\n\t\tconsole.log(`[Gmail] Disabled sync for team member ${teamMemberId}: ${reason}`);\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] Failed to mark user token invalid:\", error);\n\t}\n}\n\n/**\n * Store Gmail OAuth tokens for a team member\n */\nexport async function storeUserGmailTokens(\n\tteamMemberId: string,\n\temailAccountId: string,\n\taccessToken: string,\n\trefreshToken: string,\n\texpiresIn: number,\n\tscopes: string[]\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tif (!scopes.includes(GMAIL_READONLY_SCOPE) && !scopes.includes(GMAIL_MODIFY_SCOPE)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Missing required scope: ${GMAIL_READONLY_SCOPE} or ${GMAIL_MODIFY_SCOPE}`,\n\t\t\t};\n\t\t}\n\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tconst expiresAt = new Date(Date.now() + expiresIn * 1000);\n\n\t\t// Encrypt tokens before storing (CRITICAL SECURITY)\n\t\tconst encryptedAccessToken = encryptToken(accessToken);\n\t\tconst encryptedRefreshToken = encryptToken(refreshToken);\n\n\t\tconst { error } = await supabase.from(\"user_gmail_tokens\").upsert(\n\t\t\t{\n\t\t\t\tteam_member_id: teamMemberId,\n\t\t\t\tuser_email_account_id: emailAccountId,\n\t\t\t\taccess_token: encryptedAccessToken,\n\t\t\t\trefresh_token: encryptedRefreshToken,\n\t\t\t\ttoken_expiry: expiresAt.toISOString(),\n\t\t\t\tscopes,\n\t\t\t\tsync_enabled: true,\n\t\t\t\tlast_synced_at: null,\n\t\t\t},\n\t\t\t{ onConflict: \"user_email_account_id\" }\n\t\t);\n\n\t\tif (error) {\n\t\t\tconsole.error(\"[Gmail] Failed to store user tokens:\", error.message);\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\tconsole.log(`[Gmail] Stored encrypted tokens for team member ${teamMemberId}`);\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\treturn { success: false, error: message };\n\t}\n}\n\n/**\n * Disconnect Gmail for a team member\n */\nexport async function disconnectUserGmail(\n\tteamMemberId: string\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\t// Get token to revoke\n\t\tconst { data: tokenData } = await supabase\n\t\t\t.from(\"user_gmail_tokens\")\n\t\t\t.select(\"access_token\")\n\t\t\t.eq(\"team_member_id\", teamMemberId)\n\t\t\t.single();\n\n\t\t// Delete from database\n\t\tconst { error } = await supabase\n\t\t\t.from(\"user_gmail_tokens\")\n\t\t\t.delete()\n\t\t\t.eq(\"team_member_id\", teamMemberId);\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\t// Revoke token with Google (best effort)\n\t\tif (tokenData?.access_token) {\n\t\t\ttry {\n\t\t\t\tawait fetch(`https://oauth2.googleapis.com/revoke?token=${tokenData.access_token}`, {\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t});\n\t\t\t} catch {\n\t\t\t\tconsole.warn(\"[Gmail] User token revocation request failed (non-critical)\");\n\t\t\t}\n\t\t}\n\n\t\tconsole.log(`[Gmail] Disconnected Gmail for team member ${teamMemberId}`);\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\treturn { success: false, error: message };\n\t}\n}\n\n// =============================================================================\n// INBOX FETCHING\n// =============================================================================\n\n/**\n * Fetch inbox messages for a team member\n */\nexport async function fetchUserInbox(\n\tteamMemberId: string,\n\tmaxResults: number = 50,\n\tpageToken?: string\n): Promise<{ messages: GmailMessage[]; nextPageToken?: string; error?: string }> {\n\ttry {\n\t\tconst tokens = await getUserGmailTokens(teamMemberId);\n\t\tif (!tokens) {\n\t\t\treturn { messages: [], error: \"Gmail not connected for this user\" };\n\t\t}\n\n\t\t// Build query parameters\n\t\tconst params = new URLSearchParams({\n\t\t\tmaxResults: maxResults.toString(),\n\t\t\tq: \"in:inbox\", // Only fetch inbox messages\n\t\t\t...(pageToken && { pageToken }),\n\t\t});\n\n\t\t// List messages\n\t\tconst listResponse = await fetch(\n\t\t\t`${GMAIL_API_URL}/users/me/messages?${params}`,\n\t\t\t{\n\t\t\t\theaders: { Authorization: `Bearer ${tokens.accessToken}` },\n\t\t\t}\n\t\t);\n\n\t\tif (!listResponse.ok) {\n\t\t\tconst errorText = await listResponse.text();\n\t\t\tconsole.error(`[Gmail] Inbox fetch failed: ${listResponse.status}`, errorText);\n\t\t\treturn { messages: [], error: `API error: ${listResponse.status}` };\n\t\t}\n\n\t\tconst listData = await listResponse.json();\n\t\tconst messageIds = listData.messages || [];\n\t\tconst messages: GmailMessage[] = [];\n\n\t\t// Fetch full message details for each message\n\t\tfor (const msgRef of messageIds) {\n\t\t\tconst msgResponse = await fetch(\n\t\t\t\t`${GMAIL_API_URL}/users/me/messages/${msgRef.id}`,\n\t\t\t\t{\n\t\t\t\t\theaders: { Authorization: `Bearer ${tokens.accessToken}` },\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tif (msgResponse.ok) {\n\t\t\t\tconst msgData = await msgResponse.json();\n\t\t\t\tmessages.push(msgData);\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tmessages,\n\t\t\tnextPageToken: listData.nextPageToken,\n\t\t};\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\tconsole.error(\"[Gmail] Inbox fetch error:\", message);\n\t\treturn { messages: [], error: message };\n\t}\n}\n\n/**\n * Parse Gmail message to structured format\n */\nfunction parseGmailMessage(message: GmailMessage): ParsedGmailMessage {\n\tconst headers = message.payload.headers;\n\tconst getHeader = (name: string) => headers.find(h => h.name.toLowerCase() === name.toLowerCase())?.value || \"\";\n\n\tconst from = getHeader(\"From\");\n\tconst to = getHeader(\"To\").split(\",\").map(e => e.trim()).filter(Boolean);\n\tconst cc = getHeader(\"Cc\")?.split(\",\").map(e => e.trim()).filter(Boolean);\n\tconst subject = getHeader(\"Subject\");\n\n\t// Extract body content\n\tlet textBody: string | undefined;\n\tlet htmlBody: string | undefined;\n\n\tconst extractBody = (part: any): void => {\n\t\tif (part.mimeType === \"text/plain\" && part.body?.data) {\n\t\t\ttextBody = Buffer.from(part.body.data, \"base64\").toString(\"utf-8\");\n\t\t} else if (part.mimeType === \"text/html\" && part.body?.data) {\n\t\t\thtmlBody = Buffer.from(part.body.data, \"base64\").toString(\"utf-8\");\n\t\t}\n\n\t\tif (part.parts) {\n\t\t\tpart.parts.forEach(extractBody);\n\t\t}\n\t};\n\n\tif (message.payload.parts) {\n\t\tmessage.payload.parts.forEach(extractBody);\n\t} else if (message.payload.body?.data) {\n\t\t// Single part message\n\t\tif (message.payload.mimeType === \"text/plain\") {\n\t\t\ttextBody = Buffer.from(message.payload.body.data, \"base64\").toString(\"utf-8\");\n\t\t} else if (message.payload.mimeType === \"text/html\") {\n\t\t\thtmlBody = Buffer.from(message.payload.body.data, \"base64\").toString(\"utf-8\");\n\t\t}\n\t}\n\n\treturn {\n\t\tgmailMessageId: message.id,\n\t\tgmailThreadId: message.threadId,\n\t\tfrom,\n\t\tto,\n\t\tcc,\n\t\tsubject,\n\t\ttextBody,\n\t\thtmlBody,\n\t\treceivedAt: new Date(parseInt(message.internalDate)),\n\t\thasAttachments: message.payload.parts?.some(p => p.body.size > 0 && p.mimeType.startsWith(\"attachment/\")) || false,\n\t\tlabels: message.labelIds,\n\t};\n}\n\n/**\n * Store Gmail message in communications table\n */\nexport async function storeGmailMessage(\n\tcompanyId: string,\n\tteamMemberId: string,\n\temailAccountId: string,\n\tparsedMessage: ParsedGmailMessage\n): Promise<{ success: boolean; communicationId?: string; error?: string }> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\t// Check if message already exists\n\t\tconst { data: existing } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"gmail_message_id\", parsedMessage.gmailMessageId)\n\t\t\t.maybeSingle();\n\n\t\tif (existing) {\n\t\t\treturn { success: true, communicationId: existing.id };\n\t\t}\n\n\t\t// Extract customer email from \"from\" field\n\t\tconst fromEmail = parsedMessage.from.match(/<(.+?)>/)?.[1] || parsedMessage.from;\n\n\t\t// Try to find customer by email\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"email\", fromEmail)\n\t\t\t.maybeSingle();\n\n\t\t// Insert communication\n\t\tconst { data: communication, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\ttype: \"email\",\n\t\t\t\tdirection: \"inbound\",\n\t\t\t\tstatus: \"received\",\n\t\t\t\tfrom_address: fromEmail,\n\t\t\t\tto_address: parsedMessage.to[0] || \"\",\n\t\t\t\tsubject: parsedMessage.subject,\n\t\t\t\tbody: parsedMessage.htmlBody || parsedMessage.textBody || \"\",\n\t\t\t\tcustomer_id: customer?.id || null,\n\t\t\t\tmailbox_owner_id: teamMemberId,\n\t\t\t\temail_account_id: emailAccountId,\n\t\t\t\tvisibility_scope: \"private\", // Personal inbox emails default to private\n\t\t\t\tgmail_message_id: parsedMessage.gmailMessageId,\n\t\t\t\tgmail_thread_id: parsedMessage.gmailThreadId,\n\t\t\t})\n\t\t\t.select(\"id\")\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tconsole.error(\"[Gmail] Failed to store message:\", error.message);\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\treturn { success: true, communicationId: communication.id };\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\treturn { success: false, error: message };\n\t}\n}\n\n/**\n * Sync inbox for a team member\n */\nexport async function syncUserInbox(\n\tcompanyId: string,\n\tteamMemberId: string\n): Promise<InboxSyncResult> {\n\tconst startTime = new Date();\n\tlet messagesFetched = 0;\n\tlet messagesStored = 0;\n\tconst errors: string[] = [];\n\tlet syncLock: ReturnType<typeof acquireSyncLock> = null;\n\n\ttry {\n\t\t// Check rate limit before syncing (CRITICAL SAFEGUARD)\n\t\tconst rateLimitCheck = checkSyncRateLimit(teamMemberId);\n\t\tif (!rateLimitCheck.allowed) {\n\t\t\tawait logAuditEvent(\"sync_rate_limited\", {\n\t\t\t\tteamMemberId,\n\t\t\t\tretryAfter: rateLimitCheck.retryAfter,\n\t\t\t}, \"warning\");\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tmessagesFetched: 0,\n\t\t\t\tmessagesStored: 0,\n\t\t\t\terrors: [rateLimitCheck.reason || \"Rate limit exceeded\"],\n\t\t\t\tlastSyncedAt: startTime,\n\t\t\t};\n\t\t}\n\n\t\t// Acquire sync lock to prevent concurrent syncs\n\t\tsyncLock = acquireSyncLock(teamMemberId);\n\t\tif (!syncLock) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tmessagesFetched: 0,\n\t\t\t\tmessagesStored: 0,\n\t\t\t\terrors: [\"Could not acquire sync lock - another sync may be in progress\"],\n\t\t\t\tlastSyncedAt: startTime,\n\t\t\t};\n\t\t}\n\n\t\tawait logAuditEvent(\"sync_started\", { teamMemberId }, \"info\");\n\n\t\tconst tokens = await getUserGmailTokens(teamMemberId);\n\t\tif (!tokens) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tmessagesFetched: 0,\n\t\t\t\tmessagesStored: 0,\n\t\t\t\terrors: [\"Gmail not connected\"],\n\t\t\t\tlastSyncedAt: startTime,\n\t\t\t};\n\t\t}\n\n\t\t// Fetch messages since last sync (or all if never synced)\n\t\tlet pageToken: string | undefined;\n\t\tlet hasMore = true;\n\n\t\twhile (hasMore) {\n\t\t\tconst { messages, nextPageToken, error } = await fetchUserInbox(\n\t\t\t\tteamMemberId,\n\t\t\t\t50,\n\t\t\t\tpageToken\n\t\t\t);\n\n\t\t\tif (error) {\n\t\t\t\terrors.push(error);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tmessagesFetched += messages.length;\n\n\t\t\t// Store each message\n\t\t\tfor (const message of messages) {\n\t\t\t\tconst parsed = parseGmailMessage(message);\n\t\t\t\tconst { success, error: storeError } = await storeGmailMessage(\n\t\t\t\t\tcompanyId,\n\t\t\t\t\tteamMemberId,\n\t\t\t\t\ttokens.emailAccountId,\n\t\t\t\t\tparsed\n\t\t\t\t);\n\n\t\t\t\tif (success) {\n\t\t\t\t\tmessagesStored++;\n\t\t\t\t} else if (storeError) {\n\t\t\t\t\terrors.push(storeError);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Continue to next page if available\n\t\t\tpageToken = nextPageToken;\n\t\t\thasMore = !!nextPageToken && messages.length > 0;\n\t\t}\n\n\t\t// Update last synced timestamp\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tawait supabase\n\t\t\t.from(\"user_gmail_tokens\")\n\t\t\t.update({ last_synced_at: startTime.toISOString() })\n\t\t\t.eq(\"team_member_id\", teamMemberId);\n\n\t\tconsole.log(\n\t\t\t`[Gmail] Synced ${messagesStored}/${messagesFetched} messages for team member ${teamMemberId}`\n\t\t);\n\n\t\t// Log successful sync\n\t\tawait logAuditEvent(\"sync_completed\", {\n\t\t\tteamMemberId,\n\t\t\tsyncMessageCount: messagesStored,\n\t\t}, \"info\");\n\n\t\treturn {\n\t\t\tsuccess: errors.length === 0,\n\t\t\tmessagesFetched,\n\t\t\tmessagesStored,\n\t\t\terrors,\n\t\t\tlastSyncedAt: startTime,\n\t\t};\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\terrors.push(message);\n\n\t\t// Log failed sync\n\t\tawait logAuditEvent(\"sync_failed\", {\n\t\t\tteamMemberId,\n\t\t\terror: message,\n\t\t}, \"error\");\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tmessagesFetched,\n\t\t\tmessagesStored,\n\t\t\terrors,\n\t\t\tlastSyncedAt: startTime,\n\t\t};\n\t} finally {\n\t\t// Always release sync lock (CRITICAL)\n\t\tif (syncLock) {\n\t\t\treleaseSyncLock(syncLock);\n\t\t}\n\t}\n}\n\n// =============================================================================\n// INTEGRATION AVAILABILITY CHECK\n// =============================================================================\n\n/**\n * Check if Gmail integration is available (env vars configured)\n */\nexport async function isGmailIntegrationEnabled(): Promise<boolean> {\n\treturn !!(\n\t\tprocess.env.GOOGLE_CLIENT_ID &&\n\t\tprocess.env.GOOGLE_CLIENT_SECRET &&\n\t\tprocess.env.NEXT_PUBLIC_APP_URL\n\t);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3468, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/email-provider.ts"],"sourcesContent":["/**\n * Email Provider Abstraction Layer\n *\n * This module provides a unified interface for sending emails through multiple\n * providers (Resend and Postmark) with automatic fallback support.\n *\n * Architecture:\n * \n *                     Email Provider Layer                         \n * \n *   1. Try Primary Provider (Resend)                               \n *       Success  Return result, log to monitor                  \n *       Failure  Try Fallback                                   \n *   2. Try Fallback Provider (Postmark)                            \n *       Success  Return result, log to monitor                  \n *       Failure  Return error with both provider failures       \n * \n *\n * Features:\n * - Automatic fallback when primary provider fails\n * - Health monitoring for both providers\n * - Unified response format\n * - Comprehensive logging for debugging\n * - Provider-agnostic interface for email operations\n *\n * Usage:\n * ```typescript\n * import { sendEmailWithFallback } from \"@/lib/email/email-provider\";\n *\n * const result = await sendEmailWithFallback({\n *   to: \"user@example.com\",\n *   subject: \"Welcome!\",\n *   html: \"<h1>Hello</h1>\",\n * });\n * ```\n */\n\nimport { emailConfig, isResendConfigured, resend } from \"./resend-client\";\nimport {\n\tpostmarkConfig,\n\tisPostmarkConfigured,\n\tsendPostmarkEmail,\n\tcheckPostmarkHealth,\n\ttype PostmarkResponse,\n} from \"./postmark-client\";\nimport {\n\tsendCompanyGmailEmail,\n\tgetCompanyGmailTokens,\n\tgetCompanyEmailProvider,\n\tcheckCompanyGmailHealth,\n\tisGmailIntegrationEnabled,\n\ttype CompanyEmailProvider,\n\ttype GmailSendResult,\n} from \"./gmail-client\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Supported email providers\n * - resend: Primary managed provider (high deliverability, company branding)\n * - postmark: Fallback managed provider (automatic failover)\n * - gmail: User's personal Gmail account (requires OAuth connection)\n */\nexport type EmailProvider = \"resend\" | \"postmark\" | \"gmail\";\n\n/**\n * Email send options - provider-agnostic interface\n */\n/** Attachment type for email */\nexport interface EmailAttachment {\n\tfilename: string;\n\tcontent: string; // Base64 encoded content\n\tcontentType?: string;\n}\n\nexport interface EmailSendOptions {\n\t/** Recipient email address(es) */\n\tto: string | string[];\n\t/** Email subject line */\n\tsubject: string;\n\t/** HTML body content */\n\thtml: string;\n\t/** Plain text body (optional, auto-generated if not provided) */\n\ttext?: string;\n\t/** From address (uses provider default if not specified) */\n\tfrom?: string;\n\t/** Reply-to address */\n\treplyTo?: string;\n\t/** Tags for categorization and tracking */\n\ttags?: Record<string, string>;\n\t/** Communication ID for internal tracking */\n\tcommunicationId?: string;\n\t/** Company ID - required for checking company email provider preference */\n\tcompanyId?: string;\n\t/** CC recipients */\n\tcc?: string | string[];\n\t/** BCC recipients */\n\tbcc?: string | string[];\n\t/** Email attachments */\n\tattachments?: EmailAttachment[];\n}\n\n/**\n * Result of sending an email through the provider layer\n */\nexport interface EmailProviderResult {\n\t/** Whether the email was sent successfully */\n\tsuccess: boolean;\n\t/** The provider that successfully sent the email */\n\tprovider?: EmailProvider;\n\t/** Message ID from the provider */\n\tmessageId?: string;\n\t/** Error message if failed */\n\terror?: string;\n\t/** Whether fallback was used */\n\tusedFallback?: boolean;\n\t/** Detailed results from each provider attempt */\n\tattempts: Array<{\n\t\tprovider: EmailProvider;\n\t\tsuccess: boolean;\n\t\tmessageId?: string;\n\t\terror?: string;\n\t\tlatencyMs: number;\n\t}>;\n}\n\n/**\n * Provider health status\n */\nexport interface ProviderHealthStatus {\n\tprovider: EmailProvider;\n\thealthy: boolean;\n\tlatencyMs: number;\n\tlastChecked: Date;\n\terror?: string;\n}\n\n/**\n * Combined health status for all providers\n */\nexport interface AllProvidersHealth {\n\tprimary: ProviderHealthStatus | null;\n\tfallback: ProviderHealthStatus | null;\n\trecommendedProvider: EmailProvider | null;\n}\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\n/**\n * Provider configuration\n * Determines which provider is primary and which is fallback\n */\nexport const providerConfig = {\n\t/** Primary provider - tried first */\n\tprimary: \"resend\" as EmailProvider,\n\t/** Fallback provider - used if primary fails */\n\tfallback: \"postmark\" as EmailProvider,\n\t/** Enable automatic fallback on failure */\n\tenableFallback: true,\n\t/** Log all provider operations for monitoring */\n\tenableLogging: true,\n\t/** Retry count before falling back (0 = immediate fallback) */\n\tprimaryRetries: 0,\n};\n\n// =============================================================================\n// PROVIDER AVAILABILITY\n// =============================================================================\n\n/**\n * Check if a specific provider is configured and available\n *\n * @param provider - Provider to check\n * @returns Whether the provider is available\n */\nexport function isProviderConfigured(provider: EmailProvider): boolean {\n\tswitch (provider) {\n\t\tcase \"resend\":\n\t\t\treturn isResendConfigured();\n\t\tcase \"postmark\":\n\t\t\treturn isPostmarkConfigured();\n\t\tdefault:\n\t\t\treturn false;\n\t}\n}\n\n/**\n * Get list of all configured providers\n *\n * @returns Array of configured provider names\n */\nexport function getConfiguredProviders(): EmailProvider[] {\n\tconst providers: EmailProvider[] = [];\n\n\tif (isResendConfigured()) {\n\t\tproviders.push(\"resend\");\n\t}\n\n\tif (isPostmarkConfigured()) {\n\t\tproviders.push(\"postmark\");\n\t}\n\n\treturn providers;\n}\n\n/**\n * Get the best available provider\n * Returns primary if configured, otherwise fallback\n *\n * @returns Best available provider or null if none configured\n */\nexport function getBestAvailableProvider(): EmailProvider | null {\n\tif (isProviderConfigured(providerConfig.primary)) {\n\t\treturn providerConfig.primary;\n\t}\n\n\tif (providerConfig.enableFallback && isProviderConfigured(providerConfig.fallback)) {\n\t\treturn providerConfig.fallback;\n\t}\n\n\treturn null;\n}\n\n// =============================================================================\n// EMAIL SENDING\n// =============================================================================\n\n/**\n * Send email via Resend\n *\n * @param options - Email options\n * @returns Send result\n */\nasync function sendViaResend(\n\toptions: EmailSendOptions\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\n\tif (!isResendConfigured() || !resend) {\n\t\treturn { success: false, error: \"Resend is not configured\" };\n\t}\n\n\ttry {\n\t\t// Build tags array for Resend\n\t\tconst tags: Array<{ name: string; value: string }> = [];\n\t\tif (options.tags) {\n\t\t\tfor (const [name, value] of Object.entries(options.tags)) {\n\t\t\t\ttags.push({ name, value });\n\t\t\t}\n\t\t}\n\t\tif (options.communicationId) {\n\t\t\ttags.push({ name: \"communication_id\", value: options.communicationId });\n\t\t}\n\n\t\t// Send via Resend\n\t\tconst { data, error } = await resend.emails.send({\n\t\t\tfrom: options.from || emailConfig.from,\n\t\t\tto: options.to,\n\t\t\tsubject: options.subject,\n\t\t\thtml: options.html,\n\t\t\ttext: options.text,\n\t\t\treplyTo: options.replyTo,\n\t\t\ttags: tags.length > 0 ? tags : undefined,\n\t\t});\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message || \"Resend send failed\" };\n\t\t}\n\n\t\treturn { success: true, messageId: data?.id };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Resend send failed\",\n\t\t};\n\t}\n}\n\n/**\n * Send email via Postmark\n *\n * @param options - Email options\n * @returns Send result\n */\nasync function sendViaPostmark(\n\toptions: EmailSendOptions\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\n\tif (!isPostmarkConfigured()) {\n\t\treturn { success: false, error: \"Postmark is not configured\" };\n\t}\n\n\ttry {\n\t\t// Convert tags to Postmark metadata format\n\t\tconst metadata: Record<string, string> = { ...options.tags };\n\t\tif (options.communicationId) {\n\t\t\tmetadata.communication_id = options.communicationId;\n\t\t}\n\t\tif (options.companyId) {\n\t\t\tmetadata.company_id = options.companyId;\n\t\t}\n\n\t\t// Determine tag (Postmark only supports one tag per email)\n\t\tconst tag = options.tags?.template || options.tags?.type || \"transactional\";\n\n\t\t// Send via Postmark\n\t\tconst result = await sendPostmarkEmail({\n\t\t\tto: options.to,\n\t\t\tsubject: options.subject,\n\t\t\thtml: options.html,\n\t\t\ttext: options.text,\n\t\t\tfrom: options.from || postmarkConfig.from,\n\t\t\treplyTo: options.replyTo,\n\t\t\ttag,\n\t\t\tmetadata,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn { success: false, error: result.error };\n\t\t}\n\n\t\treturn { success: true, messageId: result.data.MessageID };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Postmark send failed\",\n\t\t};\n\t}\n}\n\n/**\n * Send email via Gmail (company's connected Gmail account)\n *\n * @param companyId - Company ID with connected Gmail\n * @param options - Email options\n * @returns Send result\n */\nasync function sendViaGmail(\n\tcompanyId: string,\n\toptions: EmailSendOptions\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\n\ttry {\n\t\tconst result = await sendCompanyGmailEmail(companyId, {\n\t\t\tto: options.to,\n\t\t\tsubject: options.subject,\n\t\t\thtml: options.html,\n\t\t\ttext: options.text,\n\t\t\treplyTo: options.replyTo,\n\t\t\tcc: options.cc,\n\t\t\tbcc: options.bcc,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn { success: false, error: result.error };\n\t\t}\n\n\t\treturn { success: true, messageId: result.messageId };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Gmail send failed\",\n\t\t};\n\t}\n}\n\n/**\n * Check if Gmail is available for a company\n *\n * @param companyId - Company ID to check\n * @returns Whether Gmail is available and configured\n */\nasync function isCompanyGmailAvailable(companyId: string): Promise<boolean> {\n\ttry {\n\t\t// Check if Gmail integration is enabled globally\n\t\tif (!(await isGmailIntegrationEnabled())) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst tokens = await getCompanyGmailTokens(companyId);\n\t\treturn tokens !== null && tokens.isValid;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n/**\n * Send email with automatic fallback\n *\n * This is the main function for sending emails. It:\n * 1. Checks company's email provider preference (managed vs gmail vs disabled)\n * 2. If disabled, returns error immediately\n * 3. If Gmail preferred and available, sends via Gmail\n * 4. Otherwise, tries the primary provider (Resend)\n * 5. If primary fails and fallback is enabled, tries Postmark\n * 6. Returns detailed results including all attempts\n *\n * Provider Selection Logic (Multi-Tenant):\n * - If company preference = \"disabled\"  Return error (company has email disabled)\n * - If company preference = \"gmail\" AND valid Gmail tokens exist  Gmail\n * - If company preference = \"managed\" OR Gmail unavailable  Resend  Postmark\n *\n * @param options - Email send options\n * @returns Result with success status and attempt details\n *\n * @example\n * const result = await sendEmailWithFallback({\n *   to: \"user@example.com\",\n *   subject: \"Welcome!\",\n *   html: \"<h1>Hello</h1>\",\n *   tags: { template: \"welcome\" },\n *   companyId: \"company-123\", // Required for multi-tenant provider selection\n * });\n *\n * if (result.success) {\n *   console.log(`Sent via ${result.provider}, ID: ${result.messageId}`);\n * } else {\n *   console.error(`Failed: ${result.error}`);\n * }\n */\nexport async function sendEmailWithFallback(\n\toptions: EmailSendOptions\n): Promise<EmailProviderResult> {\n\tconst attempts: EmailProviderResult[\"attempts\"] = [];\n\tconst recipient = Array.isArray(options.to) ? options.to.join(\", \") : options.to;\n\n\t// Log the send attempt\n\tif (providerConfig.enableLogging) {\n\t\tconsole.log(`[EmailProvider] Sending email to ${recipient}, subject: \"${options.subject}\"`);\n\t}\n\n\t// ==========================================================================\n\t// COMPANY EMAIL PROVIDER CHECK (Multi-Tenant)\n\t// ==========================================================================\n\t// Each company (tenant) can choose:\n\t// - 'managed': Use our Resend/Postmark providers\n\t// - 'gmail': Use their connected Gmail account\n\t// - 'disabled': Email is disabled for this company\n\tif (options.companyId) {\n\t\tconst companyPreference = await getCompanyEmailProvider(options.companyId);\n\n\t\t// Handle disabled - company has turned off email\n\t\tif (companyPreference === \"disabled\") {\n\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\tconsole.log(`[EmailProvider] Company ${options.companyId} has email disabled`);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Email is disabled for this company\",\n\t\t\t\tusedFallback: false,\n\t\t\t\tattempts: [],\n\t\t\t};\n\t\t}\n\n\t\t// Handle Gmail preference\n\t\tif (companyPreference === \"gmail\") {\n\t\t\tconst gmailAvailable = await isCompanyGmailAvailable(options.companyId);\n\n\t\t\tif (gmailAvailable) {\n\t\t\t\tconst startTime = Date.now();\n\n\t\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\t\tconsole.log(`[EmailProvider] Company ${options.companyId} prefers Gmail, attempting Gmail send...`);\n\t\t\t\t}\n\n\t\t\t\tconst result = await sendViaGmail(options.companyId, options);\n\t\t\t\tconst latencyMs = Date.now() - startTime;\n\n\t\t\t\tattempts.push({\n\t\t\t\t\tprovider: \"gmail\",\n\t\t\t\t\tsuccess: result.success,\n\t\t\t\t\tmessageId: result.messageId,\n\t\t\t\t\terror: result.error,\n\t\t\t\t\tlatencyMs,\n\t\t\t\t});\n\n\t\t\t\tif (result.success) {\n\t\t\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t`[EmailProvider]  Gmail send succeeded in ${latencyMs}ms, messageId: ${result.messageId}`\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: true,\n\t\t\t\t\t\tprovider: \"gmail\",\n\t\t\t\t\t\tmessageId: result.messageId,\n\t\t\t\t\t\tusedFallback: false,\n\t\t\t\t\t\tattempts,\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Gmail failed - fall through to managed providers\n\t\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t`[EmailProvider]  Gmail send failed in ${latencyMs}ms: ${result.error}`\n\t\t\t\t\t);\n\t\t\t\t\tconsole.log(\"[EmailProvider] Falling back to managed providers...\");\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\t\tconsole.log(`[EmailProvider] Company ${options.companyId} prefers Gmail but no valid tokens, using managed providers`);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// ==========================================================================\n\t// MANAGED PROVIDERS: Primary (Resend)  Fallback (Postmark)\n\t// ==========================================================================\n\n\t// ==========================================================================\n\t// ATTEMPT 1: Primary Provider (Resend)\n\t// ==========================================================================\n\tif (isProviderConfigured(providerConfig.primary)) {\n\t\tconst startTime = Date.now();\n\n\t\tif (providerConfig.enableLogging) {\n\t\t\tconsole.log(`[EmailProvider] Trying primary provider: ${providerConfig.primary}`);\n\t\t}\n\n\t\tconst result =\n\t\t\tproviderConfig.primary === \"resend\"\n\t\t\t\t? await sendViaResend(options)\n\t\t\t\t: await sendViaPostmark(options);\n\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tattempts.push({\n\t\t\tprovider: providerConfig.primary,\n\t\t\tsuccess: result.success,\n\t\t\tmessageId: result.messageId,\n\t\t\terror: result.error,\n\t\t\tlatencyMs,\n\t\t});\n\n\t\t// If primary succeeded, return immediately\n\t\tif (result.success) {\n\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\tconsole.log(\n\t\t\t\t\t`[EmailProvider]  Primary provider succeeded in ${latencyMs}ms, messageId: ${result.messageId}`\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tprovider: providerConfig.primary,\n\t\t\t\tmessageId: result.messageId,\n\t\t\t\tusedFallback: false,\n\t\t\t\tattempts,\n\t\t\t};\n\t\t}\n\n\t\t// Primary failed\n\t\tif (providerConfig.enableLogging) {\n\t\t\tconsole.warn(\n\t\t\t\t`[EmailProvider]  Primary provider failed in ${latencyMs}ms: ${result.error}`\n\t\t\t);\n\t\t}\n\t} else {\n\t\tif (providerConfig.enableLogging) {\n\t\t\tconsole.warn(`[EmailProvider] Primary provider (${providerConfig.primary}) not configured`);\n\t\t}\n\t}\n\n\t// ==========================================================================\n\t// ATTEMPT 2: Fallback Provider (Postmark)\n\t// ==========================================================================\n\tif (providerConfig.enableFallback && isProviderConfigured(providerConfig.fallback)) {\n\t\tconst startTime = Date.now();\n\n\t\tif (providerConfig.enableLogging) {\n\t\t\tconsole.log(`[EmailProvider] Trying fallback provider: ${providerConfig.fallback}`);\n\t\t}\n\n\t\tconst result =\n\t\t\tproviderConfig.fallback === \"postmark\"\n\t\t\t\t? await sendViaPostmark(options)\n\t\t\t\t: await sendViaResend(options);\n\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tattempts.push({\n\t\t\tprovider: providerConfig.fallback,\n\t\t\tsuccess: result.success,\n\t\t\tmessageId: result.messageId,\n\t\t\terror: result.error,\n\t\t\tlatencyMs,\n\t\t});\n\n\t\t// If fallback succeeded, return\n\t\tif (result.success) {\n\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\tconsole.log(\n\t\t\t\t\t`[EmailProvider]  Fallback provider succeeded in ${latencyMs}ms, messageId: ${result.messageId}`\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tprovider: providerConfig.fallback,\n\t\t\t\tmessageId: result.messageId,\n\t\t\t\tusedFallback: true,\n\t\t\t\tattempts,\n\t\t\t};\n\t\t}\n\n\t\t// Fallback also failed\n\t\tif (providerConfig.enableLogging) {\n\t\t\tconsole.error(\n\t\t\t\t`[EmailProvider]  Fallback provider also failed in ${latencyMs}ms: ${result.error}`\n\t\t\t);\n\t\t}\n\t} else if (providerConfig.enableFallback) {\n\t\tif (providerConfig.enableLogging) {\n\t\t\tconsole.warn(\n\t\t\t\t`[EmailProvider] Fallback provider (${providerConfig.fallback}) not configured`\n\t\t\t);\n\t\t}\n\t}\n\n\t// ==========================================================================\n\t// ALL PROVIDERS FAILED\n\t// ==========================================================================\n\tconst errors = attempts.map((a) => `${a.provider}: ${a.error}`).join(\"; \");\n\n\tif (providerConfig.enableLogging) {\n\t\tconsole.error(`[EmailProvider]  All providers failed: ${errors}`);\n\t}\n\n\treturn {\n\t\tsuccess: false,\n\t\terror: `All email providers failed. ${errors}`,\n\t\tusedFallback: attempts.length > 1,\n\t\tattempts,\n\t};\n}\n\n// =============================================================================\n// HEALTH CHECKS\n// =============================================================================\n\n/**\n * Check health of Resend provider\n *\n * @returns Health status\n */\nasync function checkResendHealth(): Promise<ProviderHealthStatus> {\n\tconst startTime = Date.now();\n\n\tif (!isResendConfigured() || !resend) {\n\t\treturn {\n\t\t\tprovider: \"resend\",\n\t\t\thealthy: false,\n\t\t\tlatencyMs: 0,\n\t\t\tlastChecked: new Date(),\n\t\t\terror: \"Resend is not configured\",\n\t\t};\n\t}\n\n\ttry {\n\t\t// Resend doesn't have a dedicated health endpoint\n\t\t// We'll list domains as a health check (lightweight operation)\n\t\tconst response = await fetch(\"https://api.resend.com/domains\", {\n\t\t\tmethod: \"GET\",\n\t\t\theaders: {\n\t\t\t\tAuthorization: `Bearer ${process.env.RESEND_API_KEY}`,\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t},\n\t\t});\n\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tif (response.ok) {\n\t\t\tconsole.log(`[EmailProvider] Resend health check passed in ${latencyMs}ms`);\n\t\t\treturn {\n\t\t\t\tprovider: \"resend\",\n\t\t\t\thealthy: true,\n\t\t\t\tlatencyMs,\n\t\t\t\tlastChecked: new Date(),\n\t\t\t};\n\t\t}\n\n\t\tconst error = await response.text();\n\t\tconsole.error(`[EmailProvider] Resend health check failed: ${error}`);\n\t\treturn {\n\t\t\tprovider: \"resend\",\n\t\t\thealthy: false,\n\t\t\tlatencyMs,\n\t\t\tlastChecked: new Date(),\n\t\t\terror: `HTTP ${response.status}: ${error}`,\n\t\t};\n\t} catch (error) {\n\t\tconst latencyMs = Date.now() - startTime;\n\t\tconst errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n\n\t\tconsole.error(`[EmailProvider] Resend health check error: ${errorMessage}`);\n\t\treturn {\n\t\t\tprovider: \"resend\",\n\t\t\thealthy: false,\n\t\t\tlatencyMs,\n\t\t\tlastChecked: new Date(),\n\t\t\terror: errorMessage,\n\t\t};\n\t}\n}\n\n/**\n * Check health of all configured providers\n *\n * @returns Health status for all providers\n */\nexport async function checkAllProvidersHealth(): Promise<AllProvidersHealth> {\n\tconsole.log(\"[EmailProvider] Checking health of all providers...\");\n\n\tconst results: AllProvidersHealth = {\n\t\tprimary: null,\n\t\tfallback: null,\n\t\trecommendedProvider: null,\n\t};\n\n\t// Check primary (Resend)\n\tif (isProviderConfigured(\"resend\")) {\n\t\tresults.primary = await checkResendHealth();\n\t}\n\n\t// Check fallback (Postmark)\n\tif (isProviderConfigured(\"postmark\")) {\n\t\tconst postmarkHealth = await checkPostmarkHealth();\n\t\tresults.fallback = {\n\t\t\tprovider: \"postmark\",\n\t\t\thealthy: postmarkHealth.healthy,\n\t\t\tlatencyMs: postmarkHealth.latencyMs,\n\t\t\tlastChecked: new Date(),\n\t\t\terror: postmarkHealth.error,\n\t\t};\n\t}\n\n\t// Determine recommended provider based on health\n\tif (results.primary?.healthy) {\n\t\tresults.recommendedProvider = \"resend\";\n\t} else if (results.fallback?.healthy) {\n\t\tresults.recommendedProvider = \"postmark\";\n\t}\n\n\tconsole.log(\n\t\t`[EmailProvider] Health check complete. Primary: ${results.primary?.healthy ? \"healthy\" : \"unhealthy\"}, Fallback: ${results.fallback?.healthy ? \"healthy\" : \"unhealthy\"}, Recommended: ${results.recommendedProvider || \"none\"}`\n\t);\n\n\treturn results;\n}\n\n// =============================================================================\n// UTILITY FUNCTIONS\n// =============================================================================\n\n/**\n * Get display information about the email provider setup\n *\n * @returns Provider setup summary\n */\nexport function getProviderSetupInfo(): {\n\tprimaryConfigured: boolean;\n\tfallbackConfigured: boolean;\n\tfallbackEnabled: boolean;\n\tconfiguredProviders: EmailProvider[];\n\tstatus: \"fully_configured\" | \"primary_only\" | \"fallback_only\" | \"not_configured\";\n} {\n\tconst primaryConfigured = isProviderConfigured(providerConfig.primary);\n\tconst fallbackConfigured = isProviderConfigured(providerConfig.fallback);\n\tconst configuredProviders = getConfiguredProviders();\n\n\tlet status: \"fully_configured\" | \"primary_only\" | \"fallback_only\" | \"not_configured\";\n\n\tif (primaryConfigured && fallbackConfigured) {\n\t\tstatus = \"fully_configured\";\n\t} else if (primaryConfigured) {\n\t\tstatus = \"primary_only\";\n\t} else if (fallbackConfigured) {\n\t\tstatus = \"fallback_only\";\n\t} else {\n\t\tstatus = \"not_configured\";\n\t}\n\n\treturn {\n\t\tprimaryConfigured,\n\t\tfallbackConfigured,\n\t\tfallbackEnabled: providerConfig.enableFallback,\n\t\tconfiguredProviders,\n\t\tstatus,\n\t};\n}\n\n/**\n * Log a summary of the current provider configuration\n * Useful for debugging and startup diagnostics\n */\nexport function logProviderConfiguration(): void {\n\tconst info = getProviderSetupInfo();\n\n\tconsole.log(\"=\".repeat(60));\n\tconsole.log(\"[EmailProvider] Configuration Summary\");\n\tconsole.log(\"=\".repeat(60));\n\tconsole.log(`Primary Provider: ${providerConfig.primary} (${info.primaryConfigured ? \" configured\" : \" not configured\"})`);\n\tconsole.log(`Fallback Provider: ${providerConfig.fallback} (${info.fallbackConfigured ? \" configured\" : \" not configured\"})`);\n\tconsole.log(`Fallback Enabled: ${info.fallbackEnabled ? \"Yes\" : \"No\"}`);\n\tconsole.log(`Status: ${info.status}`);\n\tconsole.log(`Configured Providers: ${info.configuredProviders.join(\", \") || \"none\"}`);\n\tconsole.log(\"=\".repeat(60));\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4019, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/provider-monitor.ts"],"sourcesContent":["\"use server\";\n\n/**\n * Email Provider Monitor\n *\n * This module tracks the health and performance of email providers (Resend & Postmark).\n * It records every email send attempt and provides analytics for monitoring.\n *\n * Features:\n * - Track success/failure rates per provider\n * - Record latency metrics\n * - Store detailed error information\n * - Provide real-time health dashboards\n * - Alert on provider degradation\n *\n * Database Tables Used:\n * - email_provider_events: Individual send attempts\n * - email_provider_health: Aggregated health metrics (updated periodically)\n *\n * Usage:\n * ```typescript\n * // Record a successful send\n * await recordProviderEvent({\n *   provider: \"resend\",\n *   eventType: \"send_success\",\n *   messageId: \"abc123\",\n *   latencyMs: 150,\n * });\n *\n * // Get provider health stats\n * const stats = await getProviderStats(\"resend\", \"24h\");\n * ```\n */\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\nimport type { EmailProvider } from \"./email-provider\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Types of events we track for email providers\n */\nexport type ProviderEventType =\n\t| \"send_success\" // Email sent successfully\n\t| \"send_failure\" // Email send failed\n\t| \"health_check_success\" // Health check passed\n\t| \"health_check_failure\" // Health check failed\n\t| \"webhook_received\" // Webhook event received\n\t| \"fallback_triggered\"; // Fallback to secondary provider was used\n\n/**\n * Event data for recording provider activity\n */\nexport interface ProviderEventData {\n\t/** Which provider this event is for */\n\tprovider: EmailProvider;\n\t/** Type of event */\n\teventType: ProviderEventType;\n\t/** Message ID if applicable */\n\tmessageId?: string;\n\t/** Time taken for the operation in milliseconds */\n\tlatencyMs?: number;\n\t/** Error message if this was a failure */\n\terror?: string;\n\t/** Additional metadata */\n\tmetadata?: Record<string, unknown>;\n\t/** Company ID for multi-tenant tracking */\n\tcompanyId?: string;\n\t/** Domain ID if associated with a specific domain */\n\tdomainId?: string;\n}\n\n/**\n * Aggregated statistics for a provider\n */\nexport interface ProviderStats {\n\tprovider: EmailProvider;\n\tperiod: string;\n\ttotalEvents: number;\n\tsuccessCount: number;\n\tfailureCount: number;\n\tsuccessRate: number;\n\taverageLatencyMs: number;\n\tp95LatencyMs: number;\n\tfallbackCount: number;\n\tlastEventAt: Date | null;\n\tlastError: string | null;\n}\n\n/**\n * Real-time health status for dashboard\n */\nexport interface ProviderHealthDashboard {\n\tresend: {\n\t\tstatus: \"healthy\" | \"degraded\" | \"down\" | \"unknown\";\n\t\tsuccessRate24h: number;\n\t\tavgLatencyMs: number;\n\t\ttotalSent24h: number;\n\t\tlastError?: string;\n\t\tlastSuccessAt?: Date;\n\t};\n\tpostmark: {\n\t\tstatus: \"healthy\" | \"degraded\" | \"down\" | \"unknown\";\n\t\tsuccessRate24h: number;\n\t\tavgLatencyMs: number;\n\t\ttotalSent24h: number;\n\t\tlastError?: string;\n\t\tlastSuccessAt?: Date;\n\t};\n\toverall: {\n\t\tprimaryProvider: EmailProvider;\n\t\tfallbackProvider: EmailProvider;\n\t\tfallbackRate24h: number;\n\t\trecommendedAction?: string;\n\t};\n}\n\n// =============================================================================\n// EVENT RECORDING\n// =============================================================================\n\n/**\n * Record a provider event to the database\n *\n * This function logs every email provider interaction for monitoring.\n * Events are stored in the email_provider_events table.\n *\n * @param event - Event data to record\n * @returns Success status\n *\n * @example\n * await recordProviderEvent({\n *   provider: \"resend\",\n *   eventType: \"send_success\",\n *   messageId: \"msg_123\",\n *   latencyMs: 145,\n *   companyId: \"company_abc\",\n * });\n */\nexport async function recordProviderEvent(\n\tevent: ProviderEventData\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\t// Log to console for immediate visibility\n\t\tconst logPrefix = event.eventType.includes(\"success\") ? \"\" : \"\";\n\t\tconsole.log(\n\t\t\t`[ProviderMonitor] ${logPrefix} ${event.provider}:${event.eventType}` +\n\t\t\t\t(event.latencyMs ? ` (${event.latencyMs}ms)` : \"\") +\n\t\t\t\t(event.error ? ` - ${event.error}` : \"\")\n\t\t);\n\n\t\t// Insert event into database\n\t\tconst { error } = await supabase.from(\"email_provider_events\").insert({\n\t\t\tprovider: event.provider,\n\t\t\tevent_type: event.eventType,\n\t\t\tmessage_id: event.messageId || null,\n\t\t\tlatency_ms: event.latencyMs || null,\n\t\t\terror_message: event.error || null,\n\t\t\tmetadata: event.metadata || null,\n\t\t\tcompany_id: event.companyId || null,\n\t\t\tdomain_id: event.domainId || null,\n\t\t\tcreated_at: new Date().toISOString(),\n\t\t});\n\n\t\tif (error) {\n\t\t\t// Don't fail the main operation if monitoring fails\n\t\t\tconsole.error(`[ProviderMonitor] Failed to record event: ${error.message}`);\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\t// Monitoring should never break the main flow\n\t\tconsole.error(\n\t\t\t`[ProviderMonitor] Error recording event: ${error instanceof Error ? error.message : \"Unknown error\"}`\n\t\t);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n\n/**\n * Record a successful email send\n * Convenience wrapper for recordProviderEvent\n */\nexport async function recordSendSuccess(\n\tprovider: EmailProvider,\n\tmessageId: string,\n\tlatencyMs: number,\n\toptions?: { companyId?: string; domainId?: string; metadata?: Record<string, unknown> }\n): Promise<void> {\n\tawait recordProviderEvent({\n\t\tprovider,\n\t\teventType: \"send_success\",\n\t\tmessageId,\n\t\tlatencyMs,\n\t\t...options,\n\t});\n}\n\n/**\n * Record a failed email send\n * Convenience wrapper for recordProviderEvent\n */\nexport async function recordSendFailure(\n\tprovider: EmailProvider,\n\terror: string,\n\tlatencyMs: number,\n\toptions?: { companyId?: string; domainId?: string; metadata?: Record<string, unknown> }\n): Promise<void> {\n\tawait recordProviderEvent({\n\t\tprovider,\n\t\teventType: \"send_failure\",\n\t\terror,\n\t\tlatencyMs,\n\t\t...options,\n\t});\n}\n\n/**\n * Record when fallback provider was used\n */\nexport async function recordFallbackTriggered(\n\tprimaryProvider: EmailProvider,\n\tfallbackProvider: EmailProvider,\n\tprimaryError: string,\n\toptions?: { companyId?: string; metadata?: Record<string, unknown> }\n): Promise<void> {\n\tawait recordProviderEvent({\n\t\tprovider: primaryProvider,\n\t\teventType: \"fallback_triggered\",\n\t\terror: primaryError,\n\t\tmetadata: {\n\t\t\tfallback_provider: fallbackProvider,\n\t\t\t...options?.metadata,\n\t\t},\n\t\t...options,\n\t});\n}\n\n// =============================================================================\n// STATISTICS & ANALYTICS\n// =============================================================================\n\n/**\n * Get statistics for a specific provider\n *\n * @param provider - Provider to get stats for\n * @param period - Time period (\"1h\", \"24h\", \"7d\", \"30d\")\n * @returns Provider statistics\n */\nexport async function getProviderStats(\n\tprovider: EmailProvider,\n\tperiod: \"1h\" | \"24h\" | \"7d\" | \"30d\" = \"24h\"\n): Promise<ProviderStats | null> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\t// Calculate start time based on period\n\t\tconst now = new Date();\n\t\tconst periodMs = {\n\t\t\t\"1h\": 60 * 60 * 1000,\n\t\t\t\"24h\": 24 * 60 * 60 * 1000,\n\t\t\t\"7d\": 7 * 24 * 60 * 60 * 1000,\n\t\t\t\"30d\": 30 * 24 * 60 * 60 * 1000,\n\t\t};\n\t\tconst startTime = new Date(now.getTime() - periodMs[period]).toISOString();\n\n\t\t// Query events for this provider and period\n\t\tconst { data: events, error } = await supabase\n\t\t\t.from(\"email_provider_events\")\n\t\t\t.select(\"event_type, latency_ms, error_message, created_at\")\n\t\t\t.eq(\"provider\", provider)\n\t\t\t.gte(\"created_at\", startTime)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tconsole.error(`[ProviderMonitor] Failed to get stats: ${error.message}`);\n\t\t\treturn null;\n\t\t}\n\n\t\tif (!events || events.length === 0) {\n\t\t\treturn {\n\t\t\t\tprovider,\n\t\t\t\tperiod,\n\t\t\t\ttotalEvents: 0,\n\t\t\t\tsuccessCount: 0,\n\t\t\t\tfailureCount: 0,\n\t\t\t\tsuccessRate: 0,\n\t\t\t\taverageLatencyMs: 0,\n\t\t\t\tp95LatencyMs: 0,\n\t\t\t\tfallbackCount: 0,\n\t\t\t\tlastEventAt: null,\n\t\t\t\tlastError: null,\n\t\t\t};\n\t\t}\n\n\t\t// Calculate statistics\n\t\tconst sendEvents = events.filter(\n\t\t\t(e) => e.event_type === \"send_success\" || e.event_type === \"send_failure\"\n\t\t);\n\t\tconst successEvents = events.filter((e) => e.event_type === \"send_success\");\n\t\tconst failureEvents = events.filter((e) => e.event_type === \"send_failure\");\n\t\tconst fallbackEvents = events.filter((e) => e.event_type === \"fallback_triggered\");\n\n\t\t// Calculate latency metrics\n\t\tconst latencies = successEvents\n\t\t\t.map((e) => e.latency_ms)\n\t\t\t.filter((l): l is number => l !== null)\n\t\t\t.sort((a, b) => a - b);\n\n\t\tconst avgLatency =\n\t\t\tlatencies.length > 0\n\t\t\t\t? latencies.reduce((sum, l) => sum + l, 0) / latencies.length\n\t\t\t\t: 0;\n\n\t\tconst p95Index = Math.floor(latencies.length * 0.95);\n\t\tconst p95Latency = latencies.length > 0 ? latencies[p95Index] || latencies[latencies.length - 1] : 0;\n\n\t\t// Find last error\n\t\tconst lastFailure = failureEvents[0];\n\n\t\treturn {\n\t\t\tprovider,\n\t\t\tperiod,\n\t\t\ttotalEvents: events.length,\n\t\t\tsuccessCount: successEvents.length,\n\t\t\tfailureCount: failureEvents.length,\n\t\t\tsuccessRate:\n\t\t\t\tsendEvents.length > 0\n\t\t\t\t\t? (successEvents.length / sendEvents.length) * 100\n\t\t\t\t\t: 0,\n\t\t\taverageLatencyMs: Math.round(avgLatency),\n\t\t\tp95LatencyMs: Math.round(p95Latency),\n\t\t\tfallbackCount: fallbackEvents.length,\n\t\t\tlastEventAt: events[0] ? new Date(events[0].created_at) : null,\n\t\t\tlastError: lastFailure?.error_message || null,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\n\t\t\t`[ProviderMonitor] Error getting stats: ${error instanceof Error ? error.message : \"Unknown error\"}`\n\t\t);\n\t\treturn null;\n\t}\n}\n\n/**\n * Get health dashboard data for all providers\n *\n * @returns Dashboard data for monitoring UI\n */\nexport async function getProviderHealthDashboard(): Promise<ProviderHealthDashboard> {\n\tconsole.log(\"[ProviderMonitor] Getting health dashboard data...\");\n\n\t// Get stats for both providers\n\tconst [resendStats, postmarkStats] = await Promise.all([\n\t\tgetProviderStats(\"resend\", \"24h\"),\n\t\tgetProviderStats(\"postmark\", \"24h\"),\n\t]);\n\n\t// Determine health status based on success rate\n\tconst getStatus = (\n\t\tstats: ProviderStats | null\n\t): \"healthy\" | \"degraded\" | \"down\" | \"unknown\" => {\n\t\tif (!stats || stats.totalEvents === 0) return \"unknown\";\n\t\tif (stats.successRate >= 99) return \"healthy\";\n\t\tif (stats.successRate >= 95) return \"degraded\";\n\t\treturn \"down\";\n\t};\n\n\t// Calculate fallback rate\n\tconst totalFallbacks = (resendStats?.fallbackCount || 0) + (postmarkStats?.fallbackCount || 0);\n\tconst totalSends =\n\t\t(resendStats?.successCount || 0) +\n\t\t(resendStats?.failureCount || 0) +\n\t\t(postmarkStats?.successCount || 0) +\n\t\t(postmarkStats?.failureCount || 0);\n\tconst fallbackRate = totalSends > 0 ? (totalFallbacks / totalSends) * 100 : 0;\n\n\t// Determine recommended action\n\tlet recommendedAction: string | undefined;\n\tconst resendStatus = getStatus(resendStats);\n\tconst postmarkStatus = getStatus(postmarkStats);\n\n\tif (resendStatus === \"down\" && postmarkStatus === \"down\") {\n\t\trecommendedAction = \"CRITICAL: Both providers are down. Check API keys and provider status.\";\n\t} else if (resendStatus === \"down\") {\n\t\trecommendedAction = \"Primary provider (Resend) is down. Traffic is using fallback.\";\n\t} else if (fallbackRate > 10) {\n\t\trecommendedAction = \"High fallback rate detected. Review primary provider health.\";\n\t} else if (resendStatus === \"degraded\") {\n\t\trecommendedAction = \"Primary provider showing degraded performance. Monitor closely.\";\n\t}\n\n\treturn {\n\t\tresend: {\n\t\t\tstatus: resendStatus,\n\t\t\tsuccessRate24h: resendStats?.successRate || 0,\n\t\t\tavgLatencyMs: resendStats?.averageLatencyMs || 0,\n\t\t\ttotalSent24h: resendStats?.successCount || 0,\n\t\t\tlastError: resendStats?.lastError || undefined,\n\t\t\tlastSuccessAt: resendStats?.lastEventAt || undefined,\n\t\t},\n\t\tpostmark: {\n\t\t\tstatus: postmarkStatus,\n\t\t\tsuccessRate24h: postmarkStats?.successRate || 0,\n\t\t\tavgLatencyMs: postmarkStats?.averageLatencyMs || 0,\n\t\t\ttotalSent24h: postmarkStats?.successCount || 0,\n\t\t\tlastError: postmarkStats?.lastError || undefined,\n\t\t\tlastSuccessAt: postmarkStats?.lastEventAt || undefined,\n\t\t},\n\t\toverall: {\n\t\t\tprimaryProvider: \"resend\",\n\t\t\tfallbackProvider: \"postmark\",\n\t\t\tfallbackRate24h: fallbackRate,\n\t\t\trecommendedAction,\n\t\t},\n\t};\n}\n\n// =============================================================================\n// CLEANUP & MAINTENANCE\n// =============================================================================\n\n/**\n * Clean up old provider events\n * Should be run periodically (e.g., daily cron job)\n *\n * @param retentionDays - Number of days to retain events\n * @returns Number of deleted events\n */\nexport async function cleanupOldEvents(\n\tretentionDays: number = 30\n): Promise<{ deleted: number; error?: string }> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tconst cutoffDate = new Date();\n\t\tcutoffDate.setDate(cutoffDate.getDate() - retentionDays);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"email_provider_events\")\n\t\t\t.delete()\n\t\t\t.lt(\"created_at\", cutoffDate.toISOString())\n\t\t\t.select(\"id\");\n\n\t\tif (error) {\n\t\t\tconsole.error(`[ProviderMonitor] Cleanup failed: ${error.message}`);\n\t\t\treturn { deleted: 0, error: error.message };\n\t\t}\n\n\t\tconst deletedCount = data?.length || 0;\n\t\tconsole.log(`[ProviderMonitor] Cleaned up ${deletedCount} events older than ${retentionDays} days`);\n\n\t\treturn { deleted: deletedCount };\n\t} catch (error) {\n\t\tconst errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n\t\tconsole.error(`[ProviderMonitor] Cleanup error: ${errorMessage}`);\n\t\treturn { deleted: 0, error: errorMessage };\n\t}\n}\n\n// =============================================================================\n// ALERTING HELPERS\n// =============================================================================\n\n/**\n * Check if a provider should trigger an alert\n *\n * @param provider - Provider to check\n * @returns Alert status and reason\n */\nexport async function checkProviderAlert(\n\tprovider: EmailProvider\n): Promise<{\n\tshouldAlert: boolean;\n\tseverity: \"info\" | \"warning\" | \"critical\";\n\treason?: string;\n}> {\n\tconst stats = await getProviderStats(provider, \"1h\");\n\n\tif (!stats) {\n\t\treturn { shouldAlert: false, severity: \"info\" };\n\t}\n\n\t// No events in the last hour - might be expected during low traffic\n\tif (stats.totalEvents === 0) {\n\t\treturn { shouldAlert: false, severity: \"info\" };\n\t}\n\n\t// Critical: Success rate below 90%\n\tif (stats.successRate < 90) {\n\t\treturn {\n\t\t\tshouldAlert: true,\n\t\t\tseverity: \"critical\",\n\t\t\treason: `${provider} success rate is ${stats.successRate.toFixed(1)}% (below 90%)`,\n\t\t};\n\t}\n\n\t// Warning: Success rate below 99%\n\tif (stats.successRate < 99) {\n\t\treturn {\n\t\t\tshouldAlert: true,\n\t\t\tseverity: \"warning\",\n\t\t\treason: `${provider} success rate is ${stats.successRate.toFixed(1)}% (below 99%)`,\n\t\t};\n\t}\n\n\t// Warning: High latency\n\tif (stats.averageLatencyMs > 5000) {\n\t\treturn {\n\t\t\tshouldAlert: true,\n\t\t\tseverity: \"warning\",\n\t\t\treason: `${provider} average latency is ${stats.averageLatencyMs}ms (above 5s)`,\n\t\t};\n\t}\n\n\treturn { shouldAlert: false, severity: \"info\" };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4357, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/email-sender.ts"],"sourcesContent":["/**\n * Email Sender - Type-safe email sending utilities\n *\n * CRITICAL RULE - Reply-To Addresses:\n * ====================================\n * Reply-to ALWAYS uses the company's platform subdomain (mail.thorbis.com),\n * regardless of which email provider or sending method is used.\n *\n * Examples:\n * - FROM: notifications@acme.mail.thorbis.com  REPLY-TO: support@acme.mail.thorbis.com\n * - FROM: notifications@acme-plumbing.com (custom)  REPLY-TO: support@acme.mail.thorbis.com\n * - FROM: john@gmail.com (personal)  REPLY-TO: support@acme.mail.thorbis.com\n *\n * See: /docs/email/REPLY_TO_ARCHITECTURE.md for full details\n *\n * Features:\n * - Type-safe email sending with validation\n * - Development mode logging\n * - Error handling and logging\n * - Email logging to database\n * - Retry logic for failed sends\n * - Per-company rate limiting\n * - Deliverability monitoring\n */\n\n\"use server\";\n\nimport { render } from \"@react-email/components\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport type { ReactElement } from \"react\";\nimport { z } from \"zod\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport type { Database } from \"@/types/supabase\";\nimport { recordDeliveryEvent } from \"./deliverability-monitor\";\nimport type {\n\tEmailSendResult,\n\tEmailTemplate as EmailTemplateEnum,\n} from \"./email-types\";\nimport { emailSendSchema } from \"./email-types\";\nimport {\n\taddToSuppressionList,\n\tcheckSuppressionList,\n\trunPreSendChecks,\n} from \"./pre-send-checks\";\nimport {\n\tcheckRateLimit,\n\tgetCompanyActiveDomain,\n\tincrementEmailCounter,\n} from \"./rate-limiter\";\nimport { emailConfig, isResendConfigured, resend } from \"./resend-client\";\n\n// =============================================================================\n// MULTI-PROVIDER SUPPORT (Resend primary, Postmark fallback)\n// =============================================================================\n// Provider abstraction layer - handles automatic fallback when primary fails\nimport {\n\tsendEmailWithFallback,\n\tgetProviderSetupInfo,\n} from \"./email-provider\";\n\n// Provider monitoring - tracks success rates, latency for both providers\nimport {\n\trecordSendSuccess,\n\trecordSendFailure,\n\trecordFallbackTriggered,\n} from \"./provider-monitor\";\n\n// Attachment type for email\ntype EmailAttachment = {\n\tfilename: string;\n\tcontent: string; // Base64 encoded content\n\tcontentType?: string;\n};\n\n// Email send options\ntype SendEmailOptions = {\n\tto: string | string[];\n\tsubject: string;\n\ttemplate: ReactElement;\n\ttemplateType: EmailTemplateEnum;\n\t/** Reply-to address. Optional override.\n\t * If not provided, uses company's configured reply_to_email from company_email_domains table.\n\t * If company hasn't configured one, defaults to support@{company-subdomain}.mail.thorbis.com\n\t * This ensures replies always go to the same branded subdomain as FROM address (never custom domains) */\n\treplyTo?: string;\n\ttags?: { name: string; value: string }[];\n\tcompanyId?: string;\n\tcommunicationId?: string;\n\tfromOverride?: string;\n\t// CC/BCC recipients\n\tcc?: string | string[];\n\tbcc?: string | string[];\n\t// Attachments\n\tattachments?: EmailAttachment[];\n\t// Deliverability options\n\tisMarketingEmail?: boolean;\n\tskipPreSendChecks?: boolean; // For system emails that must go out\n\ttextContent?: string; // Plain text version for spam scoring\n\tunsubscribeUrl?: string;\n\tlistId?: string; // For List-Unsubscribe header\n};\n\n/**\n * Send email with React Email template\n *\n * Features:\n * - Validates email addresses\n * - Renders React Email template to HTML\n * - Sends via Resend\n * - Logs to database\n * - Development mode logging\n * - Rate limiting per company/domain\n * - Deliverability tracking\n */\nexport async function sendEmail({\n\tto,\n\tsubject,\n\ttemplate,\n\ttemplateType,\n\treplyTo,\n\ttags = [],\n\tcompanyId,\n\tcommunicationId,\n\tfromOverride,\n\tcc,\n\tbcc,\n\tattachments,\n\tisMarketingEmail = false,\n\tskipPreSendChecks = false,\n\ttextContent = \"\",\n\tunsubscribeUrl,\n\tlistId,\n}: SendEmailOptions): Promise<EmailSendResult> {\n\tlet activeDomainId: string | null = null;\n\tlet companyReplyTo: string | null = null;\n\tlet activeDomain: Awaited<ReturnType<typeof getCompanyActiveDomain>> = null;\n\n\ttry {\n\n\t\t// In development, log email instead of sending\n\t\tif (emailConfig.isDevelopment) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tdata: {\n\t\t\t\t\tid: `dev-mode-${Date.now()}`,\n\t\t\t\t\tmessage: \"Email logged in development mode (not actually sent)\",\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t// Check if at least one email provider is configured\n\t\t// We support Resend (primary) and Postmark (fallback)\n\t\tconst providerInfo = getProviderSetupInfo();\n\t\tif (providerInfo.status === \"not_configured\") {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Email service not configured. Please add RESEND_API_KEY or POSTMARK_API_KEY to environment variables.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\n\t\t\t`[EmailSender] Providers available: ${providerInfo.configuredProviders.join(\", \")} (status: ${providerInfo.status})`\n\t\t);\n\n\t\tconst supabase = await createClient();\n\n\t\t// Fetch company email domain to get reply-to configuration\n\t\tif (companyId) {\n\t\t\tactiveDomain = await getCompanyActiveDomain(companyId);\n\t\t\tif (!activeDomain) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: \"No active email domain configured for this company. Please set up email in settings.\",\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tactiveDomainId = activeDomain.domainId;\n\n\t\t\t// Set reply-to from company's domain configuration\n\t\t\t// If not set, construct default using the company's domain (e.g., support@acme.mail.thorbis.com)\n\t\t\t// This ensures all replies go to the same branded subdomain as the FROM address\n\t\t\tif (activeDomain.replyToEmail) {\n\t\t\t\tcompanyReplyTo = activeDomain.replyToEmail;\n\t\t\t} else {\n\t\t\t\t// Default to support@{company-domain}\n\t\t\t\tcompanyReplyTo = `support@${activeDomain.domain}`;\n\t\t\t}\n\t\t}\n\n\t\t// Determine final reply-to address\n\t\t// Priority: 1) Explicit replyTo parameter, 2) Company's configured reply-to, 3) None\n\t\tconst finalReplyTo = replyTo || companyReplyTo || undefined;\n\n\t\t// Validate email data (now with proper reply-to)\n\t\tconst validatedData = emailSendSchema.parse({\n\t\t\tto,\n\t\t\tsubject,\n\t\t\treplyTo: finalReplyTo,\n\t\t});\n\n\t\t// Normalize recipient list\n\t\tconst recipientEmails = Array.isArray(validatedData.to)\n\t\t\t? validatedData.to\n\t\t\t: [validatedData.to];\n\n\t\t// Check rate limits and run pre-send checks if companyId is provided\n\t\tif (companyId && activeDomainId) {\n\n\t\t\t// Check rate limit before incrementing\n\t\t\tconst rateLimitCheck = await checkRateLimit(activeDomain.domainId);\n\t\t\tif (!rateLimitCheck.allowed) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: rateLimitCheck.reason || \"Rate limit exceeded\",\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// Run pre-send deliverability checks (unless skipped for system emails)\n\t\t\tif (!skipPreSendChecks) {\n\t\t\t\t// Render template early to get HTML for spam check\n\t\t\t\tconst preCheckHtml = await render(template);\n\t\t\t\tconst plainText = textContent || extractTextFromHtml(preCheckHtml);\n\n\t\t\t\tconst preSendResult = await runPreSendChecks(\n\t\t\t\t\tcompanyId,\n\t\t\t\t\tactiveDomain.domainId,\n\t\t\t\t\trecipientEmails,\n\t\t\t\t\tsubject,\n\t\t\t\t\tpreCheckHtml,\n\t\t\t\t\tplainText,\n\t\t\t\t\tisMarketingEmail\n\t\t\t\t);\n\n\t\t\t\t// Block if there are critical errors\n\t\t\t\tif (!preSendResult.allowed) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: `Deliverability check failed: ${preSendResult.errors.join(\"; \")}`,\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tspamScore: preSendResult.spamScore,\n\t\t\t\t\t\t\twarnings: preSendResult.warnings,\n\t\t\t\t\t\t\tsuggestions: preSendResult.suggestions,\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Filter out suppressed recipients\n\t\t\t\tconst activeRecipients = recipientEmails.filter((email) => {\n\t\t\t\t\tconst status = preSendResult.recipientStatus?.find(\n\t\t\t\t\t\t(r) => r.email.toLowerCase() === email.toLowerCase()\n\t\t\t\t\t);\n\t\t\t\t\treturn !status?.suppressed;\n\t\t\t\t});\n\n\t\t\t\tif (activeRecipients.length === 0) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: \"All recipients are on suppression list - no emails sent\",\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Update validated data with filtered recipients\n\t\t\t\tif (activeRecipients.length < recipientEmails.length) {\n\t\t\t\t\tvalidatedData.to = activeRecipients.length === 1\n\t\t\t\t\t\t? activeRecipients[0]\n\t\t\t\t\t\t: activeRecipients;\n\t\t\t\t}\n\n\t\t\t\t// Log warnings if any (but still send)\n\t\t\t\tif (preSendResult.warnings.length > 0) {\n\t\t\t\t\tconsole.warn(\"[Email Deliverability Warnings]\", preSendResult.warnings);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Even for system emails, check suppression list\n\t\t\t\tconst suppressions = await checkSuppressionList(companyId, recipientEmails);\n\t\t\t\tconst activeRecipients = recipientEmails.filter((email) => {\n\t\t\t\t\tconst status = suppressions.get(email.toLowerCase());\n\t\t\t\t\treturn !status?.suppressed;\n\t\t\t\t});\n\n\t\t\t\tif (activeRecipients.length === 0) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: \"All recipients are on suppression list\",\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tif (activeRecipients.length < recipientEmails.length) {\n\t\t\t\t\tvalidatedData.to = activeRecipients.length === 1\n\t\t\t\t\t\t? activeRecipients[0]\n\t\t\t\t\t\t: activeRecipients;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Increment the counter (this also validates limits atomically)\n\t\t\tconst incrementResult = await incrementEmailCounter(activeDomain.domainId);\n\t\t\tif (!incrementResult.allowed) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: incrementResult.reason || \"Rate limit exceeded\",\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Determine from identity\n\t\tlet fromAddress = fromOverride || emailConfig.from;\n\t\tif (companyId && supabase) {\n\t\t\tconst override = await getCompanyEmailIdentity(supabase, companyId);\n\t\t\tif (override) {\n\t\t\t\tfromAddress = override;\n\t\t\t}\n\t\t}\n\n\t\t// Render template to HTML\n\t\tlet html = await render(template);\n\n\t\t// Add email tracking if communicationId is provided\n\t\tif (communicationId) {\n\t\t\tconst { addEmailTracking } = await import(\"./email-tracking\");\n\t\t\thtml = addEmailTracking(html, communicationId);\n\t\t}\n\n\t\tconst sendTags = [\n\t\t\t...tags,\n\t\t\t{ name: \"template\", value: templateType },\n\t\t\t{ name: \"environment\", value: process.env.NODE_ENV || \"development\" },\n\t\t];\n\n\t\tif (communicationId) {\n\t\t\tsendTags.push({ name: \"communication_id\", value: communicationId });\n\t\t}\n\n\t\t// Add company_id tag for webhook suppression list tracking\n\t\tif (companyId) {\n\t\t\tsendTags.push({ name: \"company_id\", value: companyId });\n\t\t}\n\n\t\t// Build enhanced headers for better deliverability\n\t\tconst emailHeaders: Record<string, string> = {\n\t\t\t// Precedence helps identify transactional vs marketing\n\t\t\t\"X-Priority\": \"3\", // Normal priority (1=High, 3=Normal, 5=Low)\n\t\t\t\"X-Mailer\": \"Stratos Email System\",\n\t\t};\n\n\t\t// Add List-Unsubscribe header for marketing emails (RFC 2369 compliance)\n\t\tif (isMarketingEmail && unsubscribeUrl) {\n\t\t\temailHeaders[\"List-Unsubscribe\"] = `<${unsubscribeUrl}>`;\n\t\t\temailHeaders[\"List-Unsubscribe-Post\"] = \"List-Unsubscribe=One-Click\";\n\t\t}\n\n\t\t// Add List-Id for mailing lists (helps with filtering)\n\t\tif (listId) {\n\t\t\temailHeaders[\"List-Id\"] = listId;\n\t\t}\n\n\t\t// Auto-Submitted header for transactional/automated emails\n\t\tif (!isMarketingEmail) {\n\t\t\temailHeaders[\"Auto-Submitted\"] = \"auto-generated\";\n\t\t\temailHeaders[\"Precedence\"] = \"bulk\"; // Prevents auto-replies\n\t\t}\n\n\t\t// =======================================================================\n\t\t// SEND EMAIL VIA PROVIDER LAYER (Resend  Postmark fallback)\n\t\t// =======================================================================\n\t\t// Convert tags to Record format for provider layer\n\t\tconst tagsRecord: Record<string, string> = {};\n\t\tfor (const tag of sendTags) {\n\t\t\ttagsRecord[tag.name] = tag.value;\n\t\t}\n\n\t\t// Track timing for monitoring\n\t\tconst sendStartTime = Date.now();\n\n\t\t// Send via provider layer (tries Resend first, then Postmark if Resend fails)\n\t\tconst providerResult = await sendEmailWithFallback({\n\t\t\tto: validatedData.to,\n\t\t\tsubject: validatedData.subject,\n\t\t\thtml,\n\t\t\ttext: textContent || extractTextFromHtml(html),\n\t\t\tfrom: fromAddress,\n\t\t\treplyTo: validatedData.replyTo,\n\t\t\ttags: tagsRecord,\n\t\t\tcommunicationId,\n\t\t\tcompanyId,\n\t\t\tcc,\n\t\t\tbcc,\n\t\t\tattachments,\n\t\t});\n\n\t\tconst sendLatencyMs = Date.now() - sendStartTime;\n\n\t\t// =======================================================================\n\t\t// RECORD PROVIDER MONITORING EVENTS\n\t\t// =======================================================================\n\t\t// Track success/failure for each provider attempt (for health dashboard)\n\t\tfor (const attempt of providerResult.attempts) {\n\t\t\tif (attempt.success) {\n\t\t\t\tawait recordSendSuccess(\n\t\t\t\t\tattempt.provider,\n\t\t\t\t\tattempt.messageId || \"\",\n\t\t\t\t\tattempt.latencyMs,\n\t\t\t\t\t{\n\t\t\t\t\t\tcompanyId,\n\t\t\t\t\t\tdomainId: activeDomainId || undefined,\n\t\t\t\t\t\tmetadata: { template: templateType },\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tawait recordSendFailure(\n\t\t\t\t\tattempt.provider,\n\t\t\t\t\tattempt.error || \"Unknown error\",\n\t\t\t\t\tattempt.latencyMs,\n\t\t\t\t\t{\n\t\t\t\t\t\tcompanyId,\n\t\t\t\t\t\tdomainId: activeDomainId || undefined,\n\t\t\t\t\t\tmetadata: { template: templateType },\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Record if fallback was triggered\n\t\tif (providerResult.usedFallback && providerResult.success) {\n\t\t\tconst primaryAttempt = providerResult.attempts.find((a) => a.provider === \"resend\");\n\t\t\tawait recordFallbackTriggered(\n\t\t\t\t\"resend\",\n\t\t\t\t\"postmark\",\n\t\t\t\tprimaryAttempt?.error || \"Primary failed\",\n\t\t\t\t{ companyId, metadata: { template: templateType } }\n\t\t\t);\n\t\t\tconsole.log(`[EmailSender] Used Postmark fallback after Resend failed: ${primaryAttempt?.error}`);\n\t\t}\n\n\t\t// =======================================================================\n\t\t// HANDLE RESULT\n\t\t// =======================================================================\n\t\tif (providerResult.success) {\n\t\t\t// SUCCESS: Email sent via one of the providers\n\t\t\tconsole.log(\n\t\t\t\t`[EmailSender]  Email sent via ${providerResult.provider}${providerResult.usedFallback ? \" (fallback)\" : \"\"} in ${sendLatencyMs}ms`\n\t\t\t);\n\n\t\t\t// Log successful email to database\n\t\t\ttry {\n\t\t\t\tif (supabase) {\n\t\t\t\t\tawait supabase.from(\"email_logs\").insert({\n\t\t\t\t\t\tto: Array.isArray(validatedData.to)\n\t\t\t\t\t\t\t? validatedData.to.join(\", \")\n\t\t\t\t\t\t\t: validatedData.to,\n\t\t\t\t\t\tfrom: fromAddress,\n\t\t\t\t\t\tsubject: validatedData.subject,\n\t\t\t\t\t\thtml_body: html,\n\t\t\t\t\t\tstatus: \"sent\",\n\t\t\t\t\t\tmessage_id: providerResult.messageId,\n\t\t\t\t\t\tcompany_id: companyId || null,\n\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\ttemplate: templateType,\n\t\t\t\t\t\t\ttags: sendTags,\n\t\t\t\t\t\t\tprovider: providerResult.provider,\n\t\t\t\t\t\t\tusedFallback: providerResult.usedFallback,\n\t\t\t\t\t\t\tlatencyMs: sendLatencyMs,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsent_at: new Date().toISOString(),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} catch (_logError) {\n\t\t\t\t// Don't throw - email was sent successfully even if logging failed\n\t\t\t}\n\n\t\t\t// Record delivered event for deliverability tracking\n\t\t\t// Note: This is an optimistic record; actual delivery confirmation comes via webhook\n\t\t\tif (activeDomainId) {\n\t\t\t\ttry {\n\t\t\t\t\tawait recordDeliveryEvent({\n\t\t\t\t\t\tdomainId: activeDomainId,\n\t\t\t\t\t\teventType: \"delivered\",\n\t\t\t\t\t\temailId: providerResult.messageId,\n\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\ttemplate: templateType,\n\t\t\t\t\t\t\tprovider: providerResult.provider,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t} catch (_deliverabilityError) {\n\t\t\t\t\t// Don't fail the overall operation\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tdata: {\n\t\t\t\t\tid: providerResult.messageId,\n\t\t\t\t\tmessage: `Email sent successfully via ${providerResult.provider}${providerResult.usedFallback ? \" (fallback)\" : \"\"}`,\n\t\t\t\t},\n\t\t\t};\n\t\t} else {\n\t\t\t// FAILURE: All providers failed\n\t\t\tconsole.error(`[EmailSender]  All providers failed: ${providerResult.error}`);\n\n\t\t\t// Log failed email to database for retry queue\n\t\t\ttry {\n\t\t\t\tif (supabase) {\n\t\t\t\t\tawait supabase.from(\"email_logs\").insert({\n\t\t\t\t\t\tto: Array.isArray(validatedData.to)\n\t\t\t\t\t\t\t? validatedData.to.join(\", \")\n\t\t\t\t\t\t\t: validatedData.to,\n\t\t\t\t\t\tfrom: fromAddress,\n\t\t\t\t\t\tsubject: validatedData.subject,\n\t\t\t\t\t\thtml_body: html,\n\t\t\t\t\t\tstatus: \"failed\",\n\t\t\t\t\t\terror_message: providerResult.error || \"All providers failed\",\n\t\t\t\t\t\tcompany_id: companyId || null,\n\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\ttemplate: templateType,\n\t\t\t\t\t\t\ttags: sendTags,\n\t\t\t\t\t\t\tattempts: providerResult.attempts,\n\t\t\t\t\t\t\tlatencyMs: sendLatencyMs,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tretry_count: 0,\n\t\t\t\t\t\tmax_retries: 3,\n\t\t\t\t\t\tnext_retry_at: new Date(Date.now() + 5 * 60 * 1000).toISOString(),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} catch (_logError) {}\n\n\t\t\t// Record bounce event for deliverability tracking\n\t\t\tif (activeDomainId) {\n\t\t\t\ttry {\n\t\t\t\t\tawait recordDeliveryEvent({\n\t\t\t\t\t\tdomainId: activeDomainId,\n\t\t\t\t\t\teventType: \"bounced\",\n\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\terror: providerResult.error,\n\t\t\t\t\t\t\ttemplate: templateType,\n\t\t\t\t\t\t\tattempts: providerResult.attempts.length,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t} catch (_deliverabilityError) {\n\t\t\t\t\t// Don't fail the overall operation\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: providerResult.error || \"Failed to send email (all providers failed)\",\n\t\t\t};\n\t\t}\n\t} catch (error) {\n\t\tif (error instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.issues[0]?.message || \"Invalid email data\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to send email\",\n\t\t};\n\t}\n}\n\n/**\n * Send batch emails (up to 100 at once per Resend limits)\n *\n * Features:\n * - Validates batch size\n * - Sends multiple emails\n * - Returns results for each email\n */\nasync function sendBatchEmails(\n\temails: SendEmailOptions[],\n): Promise<EmailSendResult[]> {\n\tif (emails.length > 100) {\n\t\treturn [\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Cannot send more than 100 emails at once\",\n\t\t\t},\n\t\t];\n\t}\n\n\tconst results = await Promise.all(emails.map((email) => sendEmail(email)));\n\n\treturn results;\n}\n\n/**\n * Test email configuration by sending a test email\n *\n * Features:\n * - Validates Resend configuration\n * - Sends test email to specified address\n * - Returns detailed error information\n */\nasync function testEmailConfiguration(\n\ttestEmailAddress: string,\n): Promise<EmailSendResult> {\n\ttry {\n\t\tconst validatedEmail = emailSendSchema.shape.to.parse(testEmailAddress);\n\n\t\tif (!isResendConfigured()) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Resend API key is not configured\",\n\t\t\t};\n\t\t}\n\n\t\t// Create a simple test template\n\t\tconst testTemplate = {\n\t\t\ttype: \"div\",\n\t\t\tprops: {\n\t\t\t\tchildren: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"h1\",\n\t\t\t\t\t\tprops: { children: \"Email Configuration Test\" },\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"p\",\n\t\t\t\t\t\tprops: {\n\t\t\t\t\t\t\tchildren: \"This is a test email from your Thorbis application.\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"p\",\n\t\t\t\t\t\tprops: {\n\t\t\t\t\t\t\tchildren:\n\t\t\t\t\t\t\t\t\"If you received this, your email configuration is working correctly!\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t} as any;\n\n\t\treturn await sendEmail({\n\t\t\tto: validatedEmail,\n\t\t\tsubject: \"Test Email - Thorbis Email Configuration\",\n\t\t\ttemplate: testTemplate,\n\t\t\ttemplateType: \"welcome\" as EmailTemplateEnum,\n\t\t\ttags: [{ name: \"type\", value: \"test\" }],\n\t\t});\n\t} catch (error) {\n\t\tif (error instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Invalid email address\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Configuration test failed\",\n\t\t};\n\t}\n}\n\nasync function getCompanyEmailIdentity(\n\tsupabase: SupabaseClient<Database>,\n\tcompanyId: string,\n) {\n\t// Get company name first\n\tconst { data: company } = await supabase\n\t\t.from(\"companies\")\n\t\t.select(\"name\")\n\t\t.eq(\"id\", companyId)\n\t\t.single();\n\n\tconst companyName = company?.name || \"Notification\";\n\n\t// Check company_email_domains table for active sending domain\n\t// Prioritizes custom domains over platform subdomains\n\tconst { data: domain } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"domain_name, is_platform_subdomain\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"verified\")\n\t\t.eq(\"sending_enabled\", true)\n\t\t.eq(\"is_suspended\", false)\n\t\t.order(\"is_platform_subdomain\", { ascending: true }) // Custom domains first\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.maybeSingle();\n\n\tif (domain?.domain_name) {\n\t\t// domain_name contains the full domain (e.g., company.mail.stratos.app or mail.custom.com)\n\t\treturn formatFromAddress(companyName, `notifications@${domain.domain_name}`);\n\t}\n\n\t// Fallback: Check old communication_email_settings (legacy)\n\tconst { data: settings } = await supabase\n\t\t.from(\"communication_email_settings\")\n\t\t.select(\"smtp_from_email, smtp_from_name\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.maybeSingle();\n\n\tif (settings?.smtp_from_email) {\n\t\treturn formatFromAddress(settings.smtp_from_name, settings.smtp_from_email);\n\t}\n\n\treturn null;\n}\n\nfunction formatFromAddress(name: string | null | undefined, email: string) {\n\tif (name?.trim()) {\n\t\treturn `${name} <${email}>`;\n\t}\n\treturn email;\n}\n\n/**\n * Extract plain text from HTML for spam scoring and multipart emails\n */\nfunction extractTextFromHtml(html: string): string {\n\t// Remove script and style tags with their content\n\tlet text = html.replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, \"\");\n\ttext = text.replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, \"\");\n\n\t// Replace block elements with newlines\n\ttext = text.replace(/<\\/(p|div|h[1-6]|li|br|tr)>/gi, \"\\n\");\n\ttext = text.replace(/<(br|hr)\\s*\\/?>/gi, \"\\n\");\n\n\t// Remove all remaining HTML tags\n\ttext = text.replace(/<[^>]+>/g, \" \");\n\n\t// Decode common HTML entities\n\ttext = text\n\t\t.replace(/&nbsp;/gi, \" \")\n\t\t.replace(/&amp;/gi, \"&\")\n\t\t.replace(/&lt;/gi, \"<\")\n\t\t.replace(/&gt;/gi, \">\")\n\t\t.replace(/&quot;/gi, '\"')\n\t\t.replace(/&#39;/gi, \"'\")\n\t\t.replace(/&mdash;/gi, \"\")\n\t\t.replace(/&ndash;/gi, \"\");\n\n\t// Clean up whitespace\n\ttext = text.replace(/\\s+/g, \" \").trim();\n\ttext = text.replace(/\\n\\s*\\n/g, \"\\n\\n\"); // Multiple newlines to double\n\n\treturn text;\n}\n\n/**\n * Handle bounce webhook and add to suppression list\n */\nexport async function handleBounceWebhook(\n\tcompanyId: string,\n\temail: string,\n\tbounceType: \"hard\" | \"soft\",\n\tbounceReason?: string\n): Promise<void> {\n\t// Import here to avoid circular dependency\n\tconst { addToSuppressionList, addToGlobalBounceList } = await import(\"./pre-send-checks\");\n\n\t// Add to company suppression list for hard bounces\n\tif (bounceType === \"hard\") {\n\t\tawait addToSuppressionList(companyId, email, \"bounce\", bounceReason);\n\t}\n\n\t// Add to global bounce list (hard bounces only)\n\tawait addToGlobalBounceList(email, bounceType, bounceReason);\n}\n\n/**\n * Handle complaint webhook (spam report) and add to suppression list\n */\nexport async function handleComplaintWebhook(\n\tcompanyId: string,\n\temail: string\n): Promise<void> {\n\tconst { addToSuppressionList } = await import(\"./pre-send-checks\");\n\n\t// Always suppress on complaint - user marked as spam\n\tawait addToSuppressionList(\n\t\tcompanyId,\n\t\temail,\n\t\t\"complaint\",\n\t\t\"User reported email as spam\"\n\t);\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;CAuBC;;;;;;;;;AAID;AAGA;AACA;AAEA;AAKA;AACA;AAKA;AAKA;AAEA,gFAAgF;AAChF,6DAA6D;AAC7D,gFAAgF;AAChF,6EAA6E;AAC7E;AAKA,yEAAyE;AACzE;;;;;;;;;;;;;;;;;AAqDO,eAAe,UAAU,EAC/B,EAAE,EACF,OAAO,EACP,QAAQ,EACR,YAAY,EACZ,OAAO,EACP,OAAO,EAAE,EACT,SAAS,EACT,eAAe,EACf,YAAY,EACZ,EAAE,EACF,GAAG,EACH,WAAW,EACX,mBAAmB,KAAK,EACxB,oBAAoB,KAAK,EACzB,cAAc,EAAE,EAChB,cAAc,EACd,MAAM,EACY;IAClB,IAAI,iBAAgC;IACpC,IAAI,iBAAgC;IACpC,IAAI,eAAmE;IAEvE,IAAI;QAEH,+CAA+C;QAC/C,IAAI,qKAAW,CAAC,aAAa,EAAE;YAC9B,OAAO;gBACN,SAAS;gBACT,MAAM;oBACL,IAAI,CAAC,SAAS,EAAE,KAAK,GAAG,IAAI;oBAC5B,SAAS;gBACV;YACD;QACD;QAEA,qDAAqD;QACrD,sDAAsD;QACtD,MAAM,eAAe,IAAA,+KAAoB;QACzC,IAAI,aAAa,MAAM,KAAK,kBAAkB;YAC7C,OAAO;gBACN,SAAS;gBACT,OACC;YACF;QACD;QACA,QAAQ,GAAG,CACV,CAAC,mCAAmC,EAAE,aAAa,mBAAmB,CAAC,IAAI,CAAC,MAAM,UAAU,EAAE,aAAa,MAAM,CAAC,CAAC,CAAC;QAGrH,MAAM,WAAW,MAAM,IAAA,qJAAY;QAEnC,2DAA2D;QAC3D,IAAI,WAAW;YACd,eAAe,MAAM,IAAA,+KAAsB,EAAC;YAC5C,IAAI,CAAC,cAAc;gBAClB,OAAO;oBACN,SAAS;oBACT,OAAO;gBACR;YACD;YAEA,iBAAiB,aAAa,QAAQ;YAEtC,mDAAmD;YACnD,iGAAiG;YACjG,gFAAgF;YAChF,IAAI,aAAa,YAAY,EAAE;gBAC9B,iBAAiB,aAAa,YAAY;YAC3C,OAAO;gBACN,sCAAsC;gBACtC,iBAAiB,CAAC,QAAQ,EAAE,aAAa,MAAM,EAAE;YAClD;QACD;QAEA,mCAAmC;QACnC,qFAAqF;QACrF,MAAM,eAAe,WAAW,kBAAkB;QAElD,iDAAiD;QACjD,MAAM,gBAAgB,uKAAe,CAAC,KAAK,CAAC;YAC3C;YACA;YACA,SAAS;QACV;QAEA,2BAA2B;QAC3B,MAAM,kBAAkB,MAAM,OAAO,CAAC,cAAc,EAAE,IACnD,cAAc,EAAE,GAChB;YAAC,cAAc,EAAE;SAAC;QAErB,qEAAqE;QACrE,IAAI,aAAa,gBAAgB;YAEhC,uCAAuC;YACvC,MAAM,iBAAiB,MAAM,IAAA,uKAAc,EAAC,aAAa,QAAQ;YACjE,IAAI,CAAC,eAAe,OAAO,EAAE;gBAC5B,OAAO;oBACN,SAAS;oBACT,OAAO,eAAe,MAAM,IAAI;gBACjC;YACD;YAEA,wEAAwE;YACxE,IAAI,CAAC,mBAAmB;gBACvB,mDAAmD;gBACnD,MAAM,eAAe,MAAM,IAAA,kUAAM,EAAC;gBAClC,MAAM,YAAY,eAAe,oBAAoB;gBAErD,MAAM,gBAAgB,MAAM,IAAA,+KAAgB,EAC3C,WACA,aAAa,QAAQ,EACrB,iBACA,SACA,cACA,WACA;gBAGD,qCAAqC;gBACrC,IAAI,CAAC,cAAc,OAAO,EAAE;oBAC3B,OAAO;wBACN,SAAS;wBACT,OAAO,CAAC,6BAA6B,EAAE,cAAc,MAAM,CAAC,IAAI,CAAC,OAAO;wBACxE,MAAM;4BACL,WAAW,cAAc,SAAS;4BAClC,UAAU,cAAc,QAAQ;4BAChC,aAAa,cAAc,WAAW;wBACvC;oBACD;gBACD;gBAEA,mCAAmC;gBACnC,MAAM,mBAAmB,gBAAgB,MAAM,CAAC,CAAC;oBAChD,MAAM,SAAS,cAAc,eAAe,EAAE,KAC7C,CAAC,IAAM,EAAE,KAAK,CAAC,WAAW,OAAO,MAAM,WAAW;oBAEnD,OAAO,CAAC,QAAQ;gBACjB;gBAEA,IAAI,iBAAiB,MAAM,KAAK,GAAG;oBAClC,OAAO;wBACN,SAAS;wBACT,OAAO;oBACR;gBACD;gBAEA,iDAAiD;gBACjD,IAAI,iBAAiB,MAAM,GAAG,gBAAgB,MAAM,EAAE;oBACrD,cAAc,EAAE,GAAG,iBAAiB,MAAM,KAAK,IAC5C,gBAAgB,CAAC,EAAE,GACnB;gBACJ;gBAEA,uCAAuC;gBACvC,IAAI,cAAc,QAAQ,CAAC,MAAM,GAAG,GAAG;oBACtC,QAAQ,IAAI,CAAC,mCAAmC,cAAc,QAAQ;gBACvE;YACD,OAAO;gBACN,iDAAiD;gBACjD,MAAM,eAAe,MAAM,IAAA,mLAAoB,EAAC,WAAW;gBAC3D,MAAM,mBAAmB,gBAAgB,MAAM,CAAC,CAAC;oBAChD,MAAM,SAAS,aAAa,GAAG,CAAC,MAAM,WAAW;oBACjD,OAAO,CAAC,QAAQ;gBACjB;gBAEA,IAAI,iBAAiB,MAAM,KAAK,GAAG;oBAClC,OAAO;wBACN,SAAS;wBACT,OAAO;oBACR;gBACD;gBAEA,IAAI,iBAAiB,MAAM,GAAG,gBAAgB,MAAM,EAAE;oBACrD,cAAc,EAAE,GAAG,iBAAiB,MAAM,KAAK,IAC5C,gBAAgB,CAAC,EAAE,GACnB;gBACJ;YACD;YAEA,gEAAgE;YAChE,MAAM,kBAAkB,MAAM,IAAA,8KAAqB,EAAC,aAAa,QAAQ;YACzE,IAAI,CAAC,gBAAgB,OAAO,EAAE;gBAC7B,OAAO;oBACN,SAAS;oBACT,OAAO,gBAAgB,MAAM,IAAI;gBAClC;YACD;QACD;QAEA,0BAA0B;QAC1B,IAAI,cAAc,gBAAgB,qKAAW,CAAC,IAAI;QAClD,IAAI,aAAa,UAAU;YAC1B,MAAM,WAAW,MAAM,wBAAwB,UAAU;YACzD,IAAI,UAAU;gBACb,cAAc;YACf;QACD;QAEA,0BAA0B;QAC1B,IAAI,OAAO,MAAM,IAAA,kUAAM,EAAC;QAExB,oDAAoD;QACpD,IAAI,iBAAiB;YACpB,MAAM,EAAE,gBAAgB,EAAE,GAAG;YAC7B,OAAO,iBAAiB,MAAM;QAC/B;QAEA,MAAM,WAAW;eACb;YACH;gBAAE,MAAM;gBAAY,OAAO;YAAa;YACxC;gBAAE,MAAM;gBAAe,OAAO,mDAAwB;YAAc;SACpE;QAED,IAAI,iBAAiB;YACpB,SAAS,IAAI,CAAC;gBAAE,MAAM;gBAAoB,OAAO;YAAgB;QAClE;QAEA,2DAA2D;QAC3D,IAAI,WAAW;YACd,SAAS,IAAI,CAAC;gBAAE,MAAM;gBAAc,OAAO;YAAU;QACtD;QAEA,mDAAmD;QACnD,MAAM,eAAuC;YAC5C,uDAAuD;YACvD,cAAc;YACd,YAAY;QACb;QAEA,yEAAyE;QACzE,IAAI,oBAAoB,gBAAgB;YACvC,YAAY,CAAC,mBAAmB,GAAG,CAAC,CAAC,EAAE,eAAe,CAAC,CAAC;YACxD,YAAY,CAAC,wBAAwB,GAAG;QACzC;QAEA,uDAAuD;QACvD,IAAI,QAAQ;YACX,YAAY,CAAC,UAAU,GAAG;QAC3B;QAEA,2DAA2D;QAC3D,IAAI,CAAC,kBAAkB;YACtB,YAAY,CAAC,iBAAiB,GAAG;YACjC,YAAY,CAAC,aAAa,GAAG,QAAQ,wBAAwB;QAC9D;QAEA,0EAA0E;QAC1E,6DAA6D;QAC7D,0EAA0E;QAC1E,mDAAmD;QACnD,MAAM,aAAqC,CAAC;QAC5C,KAAK,MAAM,OAAO,SAAU;YAC3B,UAAU,CAAC,IAAI,IAAI,CAAC,GAAG,IAAI,KAAK;QACjC;QAEA,8BAA8B;QAC9B,MAAM,gBAAgB,KAAK,GAAG;QAE9B,8EAA8E;QAC9E,MAAM,iBAAiB,MAAM,IAAA,gLAAqB,EAAC;YAClD,IAAI,cAAc,EAAE;YACpB,SAAS,cAAc,OAAO;YAC9B;YACA,MAAM,eAAe,oBAAoB;YACzC,MAAM;YACN,SAAS,cAAc,OAAO;YAC9B,MAAM;YACN;YACA;YACA;YACA;YACA;QACD;QAEA,MAAM,gBAAgB,KAAK,GAAG,KAAK;QAEnC,0EAA0E;QAC1E,oCAAoC;QACpC,0EAA0E;QAC1E,yEAAyE;QACzE,KAAK,MAAM,WAAW,eAAe,QAAQ,CAAE;YAC9C,IAAI,QAAQ,OAAO,EAAE;gBACpB,MAAM,IAAA,8KAAiB,EACtB,QAAQ,QAAQ,EAChB,QAAQ,SAAS,IAAI,IACrB,QAAQ,SAAS,EACjB;oBACC;oBACA,UAAU,kBAAkB;oBAC5B,UAAU;wBAAE,UAAU;oBAAa;gBACpC;YAEF,OAAO;gBACN,MAAM,IAAA,8KAAiB,EACtB,QAAQ,QAAQ,EAChB,QAAQ,KAAK,IAAI,iBACjB,QAAQ,SAAS,EACjB;oBACC;oBACA,UAAU,kBAAkB;oBAC5B,UAAU;wBAAE,UAAU;oBAAa;gBACpC;YAEF;QACD;QAEA,mCAAmC;QACnC,IAAI,eAAe,YAAY,IAAI,eAAe,OAAO,EAAE;YAC1D,MAAM,iBAAiB,eAAe,QAAQ,CAAC,IAAI,CAAC,CAAC,IAAM,EAAE,QAAQ,KAAK;YAC1E,MAAM,IAAA,oLAAuB,EAC5B,UACA,YACA,gBAAgB,SAAS,kBACzB;gBAAE;gBAAW,UAAU;oBAAE,UAAU;gBAAa;YAAE;YAEnD,QAAQ,GAAG,CAAC,CAAC,0DAA0D,EAAE,gBAAgB,OAAO;QACjG;QAEA,0EAA0E;QAC1E,gBAAgB;QAChB,0EAA0E;QAC1E,IAAI,eAAe,OAAO,EAAE;YAC3B,+CAA+C;YAC/C,QAAQ,GAAG,CACV,CAAC,+BAA+B,EAAE,eAAe,QAAQ,GAAG,eAAe,YAAY,GAAG,gBAAgB,GAAG,IAAI,EAAE,cAAc,EAAE,CAAC;YAGrI,mCAAmC;YACnC,IAAI;gBACH,IAAI,UAAU;oBACb,MAAM,SAAS,IAAI,CAAC,cAAc,MAAM,CAAC;wBACxC,IAAI,MAAM,OAAO,CAAC,cAAc,EAAE,IAC/B,cAAc,EAAE,CAAC,IAAI,CAAC,QACtB,cAAc,EAAE;wBACnB,MAAM;wBACN,SAAS,cAAc,OAAO;wBAC9B,WAAW;wBACX,QAAQ;wBACR,YAAY,eAAe,SAAS;wBACpC,YAAY,aAAa;wBACzB,UAAU;4BACT,UAAU;4BACV,MAAM;4BACN,UAAU,eAAe,QAAQ;4BACjC,cAAc,eAAe,YAAY;4BACzC,WAAW;wBACZ;wBACA,SAAS,IAAI,OAAO,WAAW;oBAChC;gBACD;YACD,EAAE,OAAO,WAAW;YACnB,mEAAmE;YACpE;YAEA,qDAAqD;YACrD,qFAAqF;YACrF,IAAI,gBAAgB;gBACnB,IAAI;oBACH,MAAM,IAAA,sLAAmB,EAAC;wBACzB,UAAU;wBACV,WAAW;wBACX,SAAS,eAAe,SAAS;wBACjC,UAAU;4BACT,UAAU;4BACV,UAAU,eAAe,QAAQ;wBAClC;oBACD;gBACD,EAAE,OAAO,sBAAsB;gBAC9B,mCAAmC;gBACpC;YACD;YAEA,OAAO;gBACN,SAAS;gBACT,MAAM;oBACL,IAAI,eAAe,SAAS;oBAC5B,SAAS,CAAC,4BAA4B,EAAE,eAAe,QAAQ,GAAG,eAAe,YAAY,GAAG,gBAAgB,IAAI;gBACrH;YACD;QACD,OAAO;YACN,gCAAgC;YAChC,QAAQ,KAAK,CAAC,CAAC,sCAAsC,EAAE,eAAe,KAAK,EAAE;YAE7E,+CAA+C;YAC/C,IAAI;gBACH,IAAI,UAAU;oBACb,MAAM,SAAS,IAAI,CAAC,cAAc,MAAM,CAAC;wBACxC,IAAI,MAAM,OAAO,CAAC,cAAc,EAAE,IAC/B,cAAc,EAAE,CAAC,IAAI,CAAC,QACtB,cAAc,EAAE;wBACnB,MAAM;wBACN,SAAS,cAAc,OAAO;wBAC9B,WAAW;wBACX,QAAQ;wBACR,eAAe,eAAe,KAAK,IAAI;wBACvC,YAAY,aAAa;wBACzB,UAAU;4BACT,UAAU;4BACV,MAAM;4BACN,UAAU,eAAe,QAAQ;4BACjC,WAAW;wBACZ;wBACA,aAAa;wBACb,aAAa;wBACb,eAAe,IAAI,KAAK,KAAK,GAAG,KAAK,IAAI,KAAK,MAAM,WAAW;oBAChE;gBACD;YACD,EAAE,OAAO,WAAW,CAAC;YAErB,kDAAkD;YAClD,IAAI,gBAAgB;gBACnB,IAAI;oBACH,MAAM,IAAA,sLAAmB,EAAC;wBACzB,UAAU;wBACV,WAAW;wBACX,UAAU;4BACT,OAAO,eAAe,KAAK;4BAC3B,UAAU;4BACV,UAAU,eAAe,QAAQ,CAAC,MAAM;wBACzC;oBACD;gBACD,EAAE,OAAO,sBAAsB;gBAC9B,mCAAmC;gBACpC;YACD;YAEA,OAAO;gBACN,SAAS;gBACT,OAAO,eAAe,KAAK,IAAI;YAChC;QACD;IACD,EAAE,OAAO,OAAO;QACf,IAAI,iBAAiB,mOAAC,CAAC,QAAQ,EAAE;YAChC,OAAO;gBACN,SAAS;gBACT,OAAO,MAAM,MAAM,CAAC,EAAE,EAAE,WAAW;YACpC;QACD;QAEA,OAAO;YACN,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACjD;IACD;AACD;AAEA;;;;;;;CAOC,GACD,eAAe,gBACd,MAA0B;IAE1B,IAAI,OAAO,MAAM,GAAG,KAAK;QACxB,OAAO;YACN;gBACC,SAAS;gBACT,OAAO;YACR;SACA;IACF;IAEA,MAAM,UAAU,MAAM,QAAQ,GAAG,CAAC,OAAO,GAAG,CAAC,CAAC,QAAU,UAAU;IAElE,OAAO;AACR;AAEA;;;;;;;CAOC,GACD,eAAe,uBACd,gBAAwB;IAExB,IAAI;QACH,MAAM,iBAAiB,uKAAe,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC;QAEtD,IAAI,CAAC,IAAA,4KAAkB,KAAI;YAC1B,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,gCAAgC;QAChC,MAAM,eAAe;YACpB,MAAM;YACN,OAAO;gBACN,UAAU;oBACT;wBACC,MAAM;wBACN,OAAO;4BAAE,UAAU;wBAA2B;oBAC/C;oBACA;wBACC,MAAM;wBACN,OAAO;4BACN,UAAU;wBACX;oBACD;oBACA;wBACC,MAAM;wBACN,OAAO;4BACN,UACC;wBACF;oBACD;iBACA;YACF;QACD;QAEA,OAAO,MAAM,UAAU;YACtB,IAAI;YACJ,SAAS;YACT,UAAU;YACV,cAAc;YACd,MAAM;gBAAC;oBAAE,MAAM;oBAAQ,OAAO;gBAAO;aAAE;QACxC;IACD,EAAE,OAAO,OAAO;QACf,IAAI,iBAAiB,mOAAC,CAAC,QAAQ,EAAE;YAChC,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C;IACD;AACD;AAEA,eAAe,wBACd,QAAkC,EAClC,SAAiB;IAEjB,yBAAyB;IACzB,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,aACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,WACT,MAAM;IAER,MAAM,cAAc,SAAS,QAAQ;IAErC,8DAA8D;IAC9D,sDAAsD;IACtD,MAAM,EAAE,MAAM,MAAM,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,yBACL,MAAM,CAAC,sCACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU,YACb,EAAE,CAAC,mBAAmB,MACtB,EAAE,CAAC,gBAAgB,OACnB,KAAK,CAAC,yBAAyB;QAAE,WAAW;IAAK,GAAG,uBAAuB;KAC3E,KAAK,CAAC,cAAc;QAAE,WAAW;IAAM,GACvC,WAAW;IAEb,IAAI,QAAQ,aAAa;QACxB,2FAA2F;QAC3F,OAAO,kBAAkB,aAAa,CAAC,cAAc,EAAE,OAAO,WAAW,EAAE;IAC5E;IAEA,4DAA4D;IAC5D,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC/B,IAAI,CAAC,gCACL,MAAM,CAAC,mCACP,EAAE,CAAC,cAAc,WACjB,WAAW;IAEb,IAAI,UAAU,iBAAiB;QAC9B,OAAO,kBAAkB,SAAS,cAAc,EAAE,SAAS,eAAe;IAC3E;IAEA,OAAO;AACR;AAEA,SAAS,kBAAkB,IAA+B,EAAE,KAAa;IACxE,IAAI,MAAM,QAAQ;QACjB,OAAO,GAAG,KAAK,EAAE,EAAE,MAAM,CAAC,CAAC;IAC5B;IACA,OAAO;AACR;AAEA;;CAEC,GACD,SAAS,oBAAoB,IAAY;IACxC,kDAAkD;IAClD,IAAI,OAAO,KAAK,OAAO,CAAC,qCAAqC;IAC7D,OAAO,KAAK,OAAO,CAAC,mCAAmC;IAEvD,uCAAuC;IACvC,OAAO,KAAK,OAAO,CAAC,iCAAiC;IACrD,OAAO,KAAK,OAAO,CAAC,qBAAqB;IAEzC,iCAAiC;IACjC,OAAO,KAAK,OAAO,CAAC,YAAY;IAEhC,8BAA8B;IAC9B,OAAO,KACL,OAAO,CAAC,YAAY,KACpB,OAAO,CAAC,WAAW,KACnB,OAAO,CAAC,UAAU,KAClB,OAAO,CAAC,UAAU,KAClB,OAAO,CAAC,YAAY,KACpB,OAAO,CAAC,WAAW,KACnB,OAAO,CAAC,aAAa,KACrB,OAAO,CAAC,aAAa;IAEvB,sBAAsB;IACtB,OAAO,KAAK,OAAO,CAAC,QAAQ,KAAK,IAAI;IACrC,OAAO,KAAK,OAAO,CAAC,YAAY,SAAS,8BAA8B;IAEvE,OAAO;AACR;AAKO,eAAe,oBACrB,SAAiB,EACjB,KAAa,EACb,UAA2B,EAC3B,YAAqB;IAErB,2CAA2C;IAC3C,MAAM,EAAE,oBAAoB,EAAE,qBAAqB,EAAE,GAAG;IAExD,mDAAmD;IACnD,IAAI,eAAe,QAAQ;QAC1B,MAAM,qBAAqB,WAAW,OAAO,UAAU;IACxD;IAEA,gDAAgD;IAChD,MAAM,sBAAsB,OAAO,YAAY;AAChD;AAKO,eAAe,uBACrB,SAAiB,EACjB,KAAa;IAEb,MAAM,EAAE,oBAAoB,EAAE,GAAG;IAEjC,qDAAqD;IACrD,MAAM,qBACL,WACA,OACA,aACA;AAEF;;;IAxpBsB;IAsnBA;IAqBA;;AA3oBA,sZAAA;AAsnBA,sZAAA;AAqBA,sZAAA"}},
    {"offset": {"line": 4949, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/verification-emails.ts"],"sourcesContent":["/**\n * Verification Email Utilities\n * Helper functions for sending onboarding verification emails\n *\n * Features:\n * - Send \"verification submitted\" email\n * - Send \"verification complete\" email\n * - Type-safe email sending\n * - Company-specific context\n */\n\n\"use server\";\n\nimport type { ReactElement } from \"react\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport VerificationCompleteEmail from \"../../../emails/templates/onboarding/verification-complete\";\nimport VerificationSubmittedEmail from \"../../../emails/templates/onboarding/verification-submitted\";\nimport { sendEmail } from \"./email-sender\";\nimport type { EmailSendResult } from \"./email-types\";\nimport { EmailTemplate } from \"./email-types\";\nimport { emailConfig } from \"./resend-client\";\n\n/**\n * Send \"Verification Submitted\" email\n * Called immediately after user submits toll-free/10DLC verification during onboarding\n *\n * @param companyId - Company UUID\n * @param recipientEmail - Email address to send to (usually company owner)\n * @param context - Additional context about the verification\n */\nexport async function sendVerificationSubmittedEmail(\n\tcompanyId: string,\n\trecipientEmail: string,\n\tcontext: {\n\t\thasTollFreeNumbers: boolean;\n\t\thas10DLCNumbers: boolean;\n\t\ttollFreeCount?: number;\n\t\tdlcCount?: number;\n\t},\n): Promise<EmailSendResult> {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\t// Fetch company details\n\t\tconst { data: company, error: companyError } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"name\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (companyError || !company) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Company not found: ${companyError?.message}`,\n\t\t\t};\n\t\t}\n\n\t\t// Fetch user details (company owner)\n\t\tconst { data: owner, error: ownerError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"full_name\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"role\", \"owner\")\n\t\t\t.single();\n\n\t\tconst contactName = owner?.full_name || \"there\";\n\n\t\t// Build dashboard URL\n\t\tconst dashboardUrl = `${emailConfig.appUrl}/dashboard`;\n\n\t\t// Create email template\n\t\tconst emailTemplate = VerificationSubmittedEmail({\n\t\t\tcompanyName: company.name,\n\t\t\tcontactName,\n\t\t\thasTollFreeNumbers: context.hasTollFreeNumbers,\n\t\t\thas10DLCNumbers: context.has10DLCNumbers,\n\t\t\ttollFreeCount: context.tollFreeCount || 0,\n\t\t\tdlcCount: context.dlcCount || 0,\n\t\t\tdashboardUrl,\n\t\t}) as ReactElement;\n\n\t\t// Send email\n\t\treturn await sendEmail({\n\t\t\tto: recipientEmail,\n\t\t\tsubject: `Messaging Verification Submitted - ${company.name}`,\n\t\t\ttemplate: emailTemplate,\n\t\t\ttemplateType: EmailTemplate.VERIFICATION_SUBMITTED,\n\t\t\tcompanyId,\n\t\t\ttags: [\n\t\t\t\t{ name: \"type\", value: \"onboarding\" },\n\t\t\t\t{ name: \"verification\", value: \"submitted\" },\n\t\t\t],\n\t\t});\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to send verification submitted email\",\n\t\t};\n\t}\n}\n\n/**\n * Send \"Verification Complete\" email\n * Called when toll-free verification is approved (or all verifications complete)\n *\n * @param companyId - Company UUID\n * @param recipientEmail - Email address to send to\n * @param verificationTypes - Array of verification types that completed ([\"toll-free\", \"10dlc\"])\n */\nasync function sendVerificationCompleteEmail(\n\tcompanyId: string,\n\trecipientEmail: string,\n\tverificationTypes: string[],\n): Promise<EmailSendResult> {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\t// Fetch company details\n\t\tconst { data: company, error: companyError } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"name\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (companyError || !company) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Company not found: ${companyError?.message}`,\n\t\t\t};\n\t\t}\n\n\t\t// Fetch user details (company owner)\n\t\tconst { data: owner } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"full_name\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"role\", \"owner\")\n\t\t\t.single();\n\n\t\tconst contactName = owner?.full_name || \"there\";\n\n\t\t// Build URLs\n\t\tconst dashboardUrl = `${emailConfig.appUrl}/dashboard`;\n\t\tconst messagingUrl = `${emailConfig.appUrl}/dashboard/communications/messaging`;\n\n\t\t// Create email template\n\t\tconst emailTemplate = VerificationCompleteEmail({\n\t\t\tcompanyName: company.name,\n\t\t\tcontactName,\n\t\t\tverificationTypes,\n\t\t\tdashboardUrl,\n\t\t\tmessagingUrl,\n\t\t}) as ReactElement;\n\n\t\t// Send email\n\t\treturn await sendEmail({\n\t\t\tto: recipientEmail,\n\t\t\tsubject: ` Messaging Approved - ${company.name}`,\n\t\t\ttemplate: emailTemplate,\n\t\t\ttemplateType: EmailTemplate.VERIFICATION_COMPLETE,\n\t\t\tcompanyId,\n\t\t\ttags: [\n\t\t\t\t{ name: \"type\", value: \"onboarding\" },\n\t\t\t\t{ name: \"verification\", value: \"complete\" },\n\t\t\t],\n\t\t});\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to send verification complete email\",\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5099, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/account-verification.ts"],"sourcesContent":["/**\n * Telnyx Account Verification\n *\n * Utilities for checking Telnyx account verification status.\n * Verification levels:\n * - Level 1: Basic identity verification (1-2 business days)\n * - Level 2: Business verification required for 10DLC (2-5 business days)\n */\n\nimport { telnyxRequest } from \"./api\";\n\nexport type VerificationLevel = \"none\" | \"level_1\" | \"level_2\";\n\nexport type VerificationStatus = {\n\tcurrentLevel: VerificationLevel;\n\tisLevel1Complete: boolean;\n\tisLevel2Complete: boolean;\n\tcanCreate10DLC: boolean;\n\trequirementsRemaining: string[];\n\testimatedCompletionDays?: number;\n};\n\n/**\n * Check the current verification level of the Telnyx account\n *\n * Note: This endpoint may not exist in Telnyx API. If it fails,\n * we'll need to infer verification status from 10DLC brand creation attempts.\n */\nexport async function checkAccountVerificationStatus(): Promise<{\n\tsuccess: boolean;\n\tdata?: VerificationStatus;\n\terror?: string;\n}> {\n\ttry {\n\t\t// Try to get account verification info\n\t\t// Note: Telnyx may not have a direct endpoint for this\n\t\tconst accountResult = await telnyxRequest<{\n\t\t\tverifications: {\n\t\t\t\tidentity_verification: { status: string; level: number };\n\t\t\t\tbusiness_verification: { status: string; level: number };\n\t\t\t};\n\t\t}>(\"/account/verifications\", {\n\t\t\tmethod: \"GET\",\n\t\t});\n\n\t\tif (accountResult.success && accountResult.data) {\n\t\t\tconst { verifications } = accountResult.data;\n\t\t\tconst level1Complete =\n\t\t\t\tverifications.identity_verification?.status === \"verified\";\n\t\t\tconst level2Complete =\n\t\t\t\tverifications.business_verification?.status === \"verified\";\n\n\t\t\tconst requirementsRemaining: string[] = [];\n\t\t\tlet estimatedDays = 0;\n\n\t\t\tif (!level1Complete) {\n\t\t\t\trequirementsRemaining.push(\n\t\t\t\t\t\"Complete Level 1 verification (ID, payment method, contact info)\",\n\t\t\t\t);\n\t\t\t\testimatedDays = Math.max(estimatedDays, 2);\n\t\t\t}\n\n\t\t\tif (!level2Complete) {\n\t\t\t\trequirementsRemaining.push(\n\t\t\t\t\t\"Complete Level 2 verification (EIN letter, business license, proof of address)\",\n\t\t\t\t);\n\t\t\t\testimatedDays = Math.max(estimatedDays, 5);\n\t\t\t}\n\n\t\t\tconst currentLevel: VerificationLevel = level2Complete\n\t\t\t\t? \"level_2\"\n\t\t\t\t: level1Complete\n\t\t\t\t\t? \"level_1\"\n\t\t\t\t\t: \"none\";\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tdata: {\n\t\t\t\t\tcurrentLevel,\n\t\t\t\t\tisLevel1Complete: level1Complete,\n\t\t\t\t\tisLevel2Complete: level2Complete,\n\t\t\t\t\tcanCreate10DLC: level2Complete,\n\t\t\t\t\trequirementsRemaining,\n\t\t\t\t\testimatedCompletionDays:\n\t\t\t\t\t\trequirementsRemaining.length > 0 ? estimatedDays : undefined,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t// If direct endpoint doesn't exist, try to infer from 10DLC brand creation\n\t\t// This will fail with 403 if not verified\n\t\tconst brandTestResult = await telnyxRequest<{ id: string }>(\n\t\t\t\"/10dlc/brand\",\n\t\t\t{\n\t\t\t\tmethod: \"GET\",\n\t\t\t},\n\t\t);\n\n\t\tif (brandTestResult.success) {\n\t\t\t// If we can access brands, Level 2 is complete\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tdata: {\n\t\t\t\t\tcurrentLevel: \"level_2\",\n\t\t\t\t\tisLevel1Complete: true,\n\t\t\t\t\tisLevel2Complete: true,\n\t\t\t\t\tcanCreate10DLC: true,\n\t\t\t\t\trequirementsRemaining: [],\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t// Check the error to determine verification level\n\t\tif (\n\t\t\tbrandTestResult.error?.includes(\"403\") ||\n\t\t\tbrandTestResult.error?.includes(\"verification\")\n\t\t) {\n\t\t\t// 403 means account exists but not verified for 10DLC\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tdata: {\n\t\t\t\t\tcurrentLevel: \"level_1\",\n\t\t\t\t\tisLevel1Complete: true,\n\t\t\t\t\tisLevel2Complete: false,\n\t\t\t\t\tcanCreate10DLC: false,\n\t\t\t\t\trequirementsRemaining: [\n\t\t\t\t\t\t\"Complete Level 2 verification (EIN letter, business license, proof of address)\",\n\t\t\t\t\t],\n\t\t\t\t\testimatedCompletionDays: 5,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t// Unknown state - assume no verification\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tcurrentLevel: \"none\",\n\t\t\t\tisLevel1Complete: false,\n\t\t\t\tisLevel2Complete: false,\n\t\t\t\tcanCreate10DLC: false,\n\t\t\t\trequirementsRemaining: [\n\t\t\t\t\t\"Complete Level 1 verification (ID, payment method, contact info)\",\n\t\t\t\t\t\"Complete Level 2 verification (EIN letter, business license, proof of address)\",\n\t\t\t\t],\n\t\t\t\testimatedCompletionDays: 7,\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to check verification status\",\n\t\t};\n\t}\n}\n\n/**\n * Get verification requirements based on current level\n */\nexport function getVerificationRequirements(currentLevel: VerificationLevel): {\n\tlevel1: { required: boolean; items: string[] };\n\tlevel2: { required: boolean; items: string[] };\n} {\n\treturn {\n\t\tlevel1: {\n\t\t\trequired: currentLevel === \"none\",\n\t\t\titems: [\n\t\t\t\t\"Valid government-issued ID (Driver's License, Passport, etc.)\",\n\t\t\t\t\"Payment method (Credit card or bank account)\",\n\t\t\t\t\"Phone number verification\",\n\t\t\t\t\"Email verification\",\n\t\t\t\t\"Business address confirmation\",\n\t\t\t],\n\t\t},\n\t\tlevel2: {\n\t\t\trequired: currentLevel === \"none\" || currentLevel === \"level_1\",\n\t\t\titems: [\n\t\t\t\t\"IRS EIN Confirmation Letter (CP 575 or 147C)\",\n\t\t\t\t\"Business License or Articles of Incorporation\",\n\t\t\t\t\"Proof of Business Address (Utility bill, lease agreement)\",\n\t\t\t\t\"Government-issued ID for business representative\",\n\t\t\t\t\"Tax documents (W-9 or recent tax return)\",\n\t\t\t],\n\t\t},\n\t};\n}\n\n/**\n * Get next steps based on verification status\n */\nexport function getNextSteps(\n\tstatus: VerificationStatus,\n): Array<{ step: string; action: string; url?: string }> {\n\tconst steps: Array<{ step: string; action: string; url?: string }> = [];\n\n\tif (!status.isLevel1Complete) {\n\t\tsteps.push({\n\t\t\tstep: \"Complete Level 1 Verification\",\n\t\t\taction:\n\t\t\t\t\"Visit Telnyx Portal  Account  Public Profile and complete identity verification\",\n\t\t\turl: \"https://portal.telnyx.com/#/app/account/public-profile\",\n\t\t});\n\t}\n\n\tif (!status.isLevel2Complete && status.isLevel1Complete) {\n\t\tsteps.push({\n\t\t\tstep: \"Complete Level 2 Verification\",\n\t\t\taction:\n\t\t\t\t\"Visit Telnyx Portal  Account  Verifications and upload business documents\",\n\t\t\turl: \"https://portal.telnyx.com/#/app/account/verifications\",\n\t\t});\n\t}\n\n\tif (status.canCreate10DLC) {\n\t\tsteps.push({\n\t\t\tstep: \"Create 10DLC Brand & Campaign\",\n\t\t\taction:\n\t\t\t\t\"Run automated setup to create 10DLC brand and campaign (fully automated)\",\n\t\t\turl: \"/test-telnyx-setup\",\n\t\t});\n\t}\n\n\treturn steps;\n}\n"],"names":[],"mappings":"AAAA;;;;;;;CAOC;;;;;;;;AAED;;AAmBO,eAAe;IAKrB,IAAI;QACH,uCAAuC;QACvC,uDAAuD;QACvD,MAAM,gBAAgB,MAAM,IAAA,2JAAa,EAKtC,0BAA0B;YAC5B,QAAQ;QACT;QAEA,IAAI,cAAc,OAAO,IAAI,cAAc,IAAI,EAAE;YAChD,MAAM,EAAE,aAAa,EAAE,GAAG,cAAc,IAAI;YAC5C,MAAM,iBACL,cAAc,qBAAqB,EAAE,WAAW;YACjD,MAAM,iBACL,cAAc,qBAAqB,EAAE,WAAW;YAEjD,MAAM,wBAAkC,EAAE;YAC1C,IAAI,gBAAgB;YAEpB,IAAI,CAAC,gBAAgB;gBACpB,sBAAsB,IAAI,CACzB;gBAED,gBAAgB,KAAK,GAAG,CAAC,eAAe;YACzC;YAEA,IAAI,CAAC,gBAAgB;gBACpB,sBAAsB,IAAI,CACzB;gBAED,gBAAgB,KAAK,GAAG,CAAC,eAAe;YACzC;YAEA,MAAM,eAAkC,iBACrC,YACA,iBACC,YACA;YAEJ,OAAO;gBACN,SAAS;gBACT,MAAM;oBACL;oBACA,kBAAkB;oBAClB,kBAAkB;oBAClB,gBAAgB;oBAChB;oBACA,yBACC,sBAAsB,MAAM,GAAG,IAAI,gBAAgB;gBACrD;YACD;QACD;QAEA,2EAA2E;QAC3E,0CAA0C;QAC1C,MAAM,kBAAkB,MAAM,IAAA,2JAAa,EAC1C,gBACA;YACC,QAAQ;QACT;QAGD,IAAI,gBAAgB,OAAO,EAAE;YAC5B,+CAA+C;YAC/C,OAAO;gBACN,SAAS;gBACT,MAAM;oBACL,cAAc;oBACd,kBAAkB;oBAClB,kBAAkB;oBAClB,gBAAgB;oBAChB,uBAAuB,EAAE;gBAC1B;YACD;QACD;QAEA,kDAAkD;QAClD,IACC,gBAAgB,KAAK,EAAE,SAAS,UAChC,gBAAgB,KAAK,EAAE,SAAS,iBAC/B;YACD,sDAAsD;YACtD,OAAO;gBACN,SAAS;gBACT,MAAM;oBACL,cAAc;oBACd,kBAAkB;oBAClB,kBAAkB;oBAClB,gBAAgB;oBAChB,uBAAuB;wBACtB;qBACA;oBACD,yBAAyB;gBAC1B;YACD;QACD;QAEA,yCAAyC;QACzC,OAAO;YACN,SAAS;YACT,MAAM;gBACL,cAAc;gBACd,kBAAkB;gBAClB,kBAAkB;gBAClB,gBAAgB;gBAChB,uBAAuB;oBACtB;oBACA;iBACA;gBACD,yBAAyB;YAC1B;QACD;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAKO,SAAS,4BAA4B,YAA+B;IAI1E,OAAO;QACN,QAAQ;YACP,UAAU,iBAAiB;YAC3B,OAAO;gBACN;gBACA;gBACA;gBACA;gBACA;aACA;QACF;QACA,QAAQ;YACP,UAAU,iBAAiB,UAAU,iBAAiB;YACtD,OAAO;gBACN;gBACA;gBACA;gBACA;gBACA;aACA;QACF;IACD;AACD;AAKO,SAAS,aACf,MAA0B;IAE1B,MAAM,QAA+D,EAAE;IAEvE,IAAI,CAAC,OAAO,gBAAgB,EAAE;QAC7B,MAAM,IAAI,CAAC;YACV,MAAM;YACN,QACC;YACD,KAAK;QACN;IACD;IAEA,IAAI,CAAC,OAAO,gBAAgB,IAAI,OAAO,gBAAgB,EAAE;QACxD,MAAM,IAAI,CAAC;YACV,MAAM;YACN,QACC;YACD,KAAK;QACN;IACD;IAEA,IAAI,OAAO,cAAc,EAAE;QAC1B,MAAM,IAAI,CAAC;YACV,MAAM;YACN,QACC;YACD,KAAK;QACN;IACD;IAEA,OAAO;AACR"}},
    {"offset": {"line": 5260, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/email-service.ts"],"sourcesContent":["\"use server\";\n\nimport { createClient } from \"@/lib/supabase/server\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\n\nexport type CompanyEmail = {\n\tid: string;\n\tfrom_address: string | null;\n\tfrom_name: string | null;\n\tto_address: string | null;\n\tsubject: string | null;\n\tbody: string | null;\n\tbody_html: string | null;\n\tcreated_at: string;\n\tread_at: string | null;\n\tdirection: \"inbound\" | \"outbound\";\n\tcustomer_id: string | null;\n\tcustomer?: {\n\t\tid: string;\n\t\tfirst_name: string | null;\n\t\tlast_name: string | null;\n\t\tdisplay_name: string | null;\n\t\temail: string | null;\n\t\tphone: string | null;\n\t\tcompany_name: string | null;\n\t} | null;\n\tsent_at: string | null;\n\tdelivered_at: string | null;\n\topened_at: string | null;\n\tclicked_at: string | null;\n\topen_count: number | null;\n\tclick_count: number | null;\n\tstatus: string;\n\ttags?: string[] | null;\n\tcategory?: string | null;\n\tprovider_metadata?: Record<string, unknown> | null;\n};\n\nexport type EmailFolder = \n\t| \"inbox\" \n\t| \"drafts\" \n\t| \"sent\" \n\t| \"archive\" \n\t| \"snoozed\" \n\t| \"spam\" \n\t| \"trash\" \n\t| \"bin\"\n\t| \"starred\"\n\t| string; // For labels\n\ntype GetCompanyEmailsInput = {\n\tlimit?: number;\n\toffset?: number;\n\ttype?: \"sent\" | \"received\" | \"all\";\n\tfolder?: EmailFolder;\n\tlabel?: string; // For label filtering\n\tsearch?: string;\n\tsortBy?: \"created_at\" | \"sent_at\" | \"subject\";\n\tsortOrder?: \"asc\" | \"desc\";\n};\n\nexport type GetCompanyEmailsResult = {\n\temails: CompanyEmail[];\n\ttotal: number;\n\thasMore: boolean;\n};\n\nexport async function getCompanyEmails(\n\tcompanyId: string,\n\tinput: GetCompanyEmailsInput = {},\n): Promise<GetCompanyEmailsResult> {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn { emails: [], total: 0, hasMore: false };\n\t}\n\n\tconst {\n\t\tlimit = 50,\n\t\toffset = 0,\n\t\ttype = \"all\",\n\t\tfolder,\n\t\tlabel,\n\t\tsearch,\n\t\tsortBy = \"created_at\",\n\t\tsortOrder = \"desc\",\n\t} = input;\n\n\t// Build the query - get all emails, we'll filter by channel in memory\n\t// Note: Using left join for customer to avoid filtering out emails without customers\n\tlet query = supabase\n\t\t.from(\"communications\")\n\t\t.select(\n\t\t\t`\n\t\t\tid,\n\t\t\tfrom_address,\n\t\t\tfrom_name,\n\t\t\tto_address,\n\t\t\tsubject,\n\t\t\tbody,\n\t\t\tbody_html,\n\t\t\tcreated_at,\n\t\t\tread_at,\n\t\t\tdirection,\n\t\t\tcustomer_id,\n\t\t\tcustomer:customers!left(id, first_name, last_name, display_name, email, phone, company_name),\n\t\t\tsent_at,\n\t\t\tdelivered_at,\n\t\t\topened_at,\n\t\t\tclicked_at,\n\t\t\topen_count,\n\t\t\tclick_count,\n\t\t\tstatus,\n\t\t\tchannel,\n\t\t\tprovider_metadata,\n\t\t\tis_archived,\n\t\t\tsnoozed_until,\n\t\t\tcategory,\n\t\t\ttags\n\t\t`,\n\t\t\t{ count: \"exact\" },\n\t\t)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"type\", \"email\");\n\n\t// Apply folder filtering\n\tif (folder) {\n\t\tswitch (folder) {\n\t\t\tcase \"inbox\":\n\t\t\t\t// Inbox: inbound, not archived, not deleted, not draft, not spam, not snoozed (or snooze expired)\n\t\t\t\tquery = query\n\t\t\t\t\t.eq(\"direction\", \"inbound\")\n\t\t\t\t\t.eq(\"is_archived\", false)\n\t\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t\t.neq(\"status\", \"draft\")\n\t\t\t\t\t.or(\"category.is.null,category.neq.spam\")\n\t\t\t\t\t.or(\"snoozed_until.is.null,snoozed_until.lt.now()\");\n\t\t\t\tbreak;\n\t\t\tcase \"drafts\":\n\t\t\t\t// Drafts: status is draft, not deleted\n\t\t\t\tquery = query.eq(\"status\", \"draft\").is(\"deleted_at\", null);\n\t\t\t\tbreak;\n\t\t\tcase \"sent\":\n\t\t\t\t// Sent: outbound, not archived, not deleted\n\t\t\t\tquery = query\n\t\t\t\t\t.eq(\"direction\", \"outbound\")\n\t\t\t\t\t.eq(\"is_archived\", false)\n\t\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t\t.neq(\"status\", \"draft\");\n\t\t\t\tbreak;\n\t\t\tcase \"archive\":\n\t\t\t\t// Archive: is_archived = true, not deleted\n\t\t\t\tquery = query.eq(\"is_archived\", true).is(\"deleted_at\", null);\n\t\t\t\tbreak;\n\t\t\tcase \"snoozed\":\n\t\t\t\t// Snoozed: snoozed_until is not null and in the future, not deleted\n\t\t\t\tquery = query\n\t\t\t\t\t.not(\"snoozed_until\", \"is\", null)\n\t\t\t\t\t.gt(\"snoozed_until\", new Date().toISOString())\n\t\t\t\t\t.is(\"deleted_at\", null);\n\t\t\t\tbreak;\n\t\t\tcase \"spam\":\n\t\t\t\t// Spam: category = 'spam' or tags contains 'spam', not deleted\n\t\t\t\t// Use separate queries and combine in memory, or use OR with proper syntax\n\t\t\t\tquery = query\n\t\t\t\t\t.or(\"category.eq.spam\")\n\t\t\t\t\t.is(\"deleted_at\", null);\n\t\t\t\t// Note: Tags filtering for spam will be done in memory after fetch\n\t\t\t\tbreak;\n\t\t\tcase \"trash\":\n\t\t\tcase \"bin\":\n\t\t\t\t// Trash/Bin: deleted_at is not null\n\t\t\t\tquery = query.not(\"deleted_at\", \"is\", null);\n\t\t\t\tbreak;\n\t\t\tcase \"starred\":\n\t\t\t\t// Starred: tags contains 'starred', not deleted\n\t\t\t\t// Note: We'll filter by tags in memory after fetch due to JSONB query limitations\n\t\t\t\tquery = query\n\t\t\t\t\t.is(\"deleted_at\", null);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\t// Custom folder or label filtering - will be done in memory after fetch\n\t\t\t\t// (JSONB array containment not supported by PostgREST cs operator)\n\t\t\t\tquery = query.is(\"deleted_at\", null);\n\t\t\t\tbreak;\n\t\t}\n\t} else {\n\t\t// Default: exclude deleted emails\n\t\tquery = query.is(\"deleted_at\", null);\n\t}\n\n\t// Filter by direction (if not already filtered by folder)\n\tif (!folder || (folder !== \"inbox\" && folder !== \"sent\" && folder !== \"drafts\")) {\n\t\tif (type === \"sent\") {\n\t\t\tquery = query.eq(\"direction\", \"outbound\");\n\t\t} else if (type === \"received\") {\n\t\t\tquery = query.eq(\"direction\", \"inbound\");\n\t\t}\n\t\t// Note: type === \"all\" doesn't filter by direction\n\t}\n\n\t// Search filter\n\tif (search) {\n\t\tquery = query.or(\n\t\t\t`subject.ilike.%${search}%,body.ilike.%${search}%,from_address.ilike.%${search}%,to_address.ilike.%${search}%`,\n\t\t);\n\t}\n\n\t// Sort\n\tquery = query.order(sortBy, { ascending: sortOrder === \"asc\" });\n\n\t// Pagination\n\tquery = query.range(offset, offset + limit - 1);\n\n\tconst { data, error, count } = await query;\n\n\tif (error) {\n\t\tconsole.error(\" Error fetching emails:\", error);\n\t\tconsole.error(\"   Company ID:\", companyId);\n\t\tconsole.error(\"   Query filters:\", { type: \"email\", direction: type });\n\t\tconsole.error(\"   Full error details:\", JSON.stringify(error, null, 2));\n\t\treturn { emails: [], total: 0, hasMore: false };\n\t}\n\n\t// Normalize customer data and filter out channel field\n\tlet emails: CompanyEmail[] = (data || []).map((email: any) => {\n\t\tconst customer = Array.isArray(email.customer)\n\t\t\t? email.customer[0] ?? null\n\t\t\t: email.customer ?? null;\n\n\t\t// Remove channel from the returned object as it's not part of CompanyEmail type\n\t\tconst { channel, ...emailData } = email;\n\n\t\treturn {\n\t\t\t...emailData,\n\t\t\tcustomer,\n\t\t};\n\t});\n\n\t// Post-process spam filtering\n\tif (folder === \"spam\") {\n\t\t// Show only spam emails\n\t\temails = emails.filter((email: any) => {\n\t\t\tconst tags = (email.tags as string[]) || [];\n\t\t\treturn email.category === \"spam\" || tags.includes(\"spam\");\n\t\t});\n\t\t// Update count for spam after filtering\n\t\tconst spamCount = emails.length;\n\t\treturn {\n\t\t\temails,\n\t\t\ttotal: spamCount,\n\t\t\thasMore: spamCount >= limit,\n\t\t};\n\t} else if (folder !== \"archive\") {\n\t\t// Exclude spam emails from all folders EXCEPT spam and archive\n\t\t// Archive should show ALL archived emails regardless of spam status\n\t\temails = emails.filter((email: any) => {\n\t\t\tconst tags = (email.tags as string[]) || [];\n\t\t\tconst isSpam = email.category === \"spam\" || tags.includes(\"spam\");\n\t\t\treturn !isSpam; // Exclude spam from non-spam, non-archive folders\n\t\t});\n\t}\n\n\t// Post-process starred filtering (if folder is starred)\n\tif (folder === \"starred\") {\n\t\temails = emails.filter((email: any) => {\n\t\t\tconst tags = (email.tags as string[]) || [];\n\t\t\treturn tags.includes(\"starred\");\n\t\t});\n\t\t// Update count for starred after filtering\n\t\tconst starredCount = emails.length;\n\t\treturn {\n\t\t\temails,\n\t\t\ttotal: starredCount,\n\t\t\thasMore: starredCount >= limit,\n\t\t};\n\t}\n\n\t// Post-process custom folder/label filtering (JSONB array containment not supported by PostgREST)\n\tconst standardFolders = [\"inbox\", \"spam\", \"starred\", \"sent\", \"drafts\", \"archive\", \"snoozed\", \"trash\", \"bin\"];\n\tconst folderName = label || folder;\n\tif (folderName && !standardFolders.includes(folderName)) {\n\t\temails = emails.filter((email: any) => {\n\t\t\tconst tags = (email.tags as string[]) || [];\n\t\t\treturn tags.includes(folderName);\n\t\t});\n\t\tconst customCount = emails.length;\n\t\treturn {\n\t\t\temails,\n\t\t\ttotal: customCount,\n\t\t\thasMore: customCount >= limit,\n\t\t};\n\t}\n\n\treturn {\n\t\temails,\n\t\ttotal: count || 0,\n\t\thasMore: (count || 0) > offset + limit,\n\t};\n}\n\nexport async function getEmailThreads(\n\tcompanyId: string,\n\tinput: {\n\t\tlimit?: number;\n\t\toffset?: number;\n\t\tsearch?: string;\n\t} = {},\n): Promise<{ threads: CompanyEmail[]; total: number; hasMore: boolean }> {\n\t// For now, return emails grouped by thread\n\t// This is a simplified implementation\n\tconst result = await getCompanyEmails(companyId, {\n\t\t...input,\n\t\ttype: \"all\",\n\t\tsortBy: \"created_at\",\n\t\tsortOrder: \"desc\",\n\t});\n\n\treturn {\n\t\tthreads: result.emails,\n\t\ttotal: result.total,\n\t\thasMore: result.hasMore,\n\t};\n}\n\nexport async function getEmailById(\n\tcompanyId: string,\n\temailId: string,\n): Promise<CompanyEmail | null> {\n\tconst supabase = await createClient();\n\n\tif (!supabase || !companyId) {\n\t\treturn null;\n\t}\n\n\tconst { data, error } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\n\t\t\t`\n\t\t\tid,\n\t\t\tfrom_address,\n\t\t\tfrom_name,\n\t\t\tto_address,\n\t\t\tsubject,\n\t\t\tbody,\n\t\t\tbody_html,\n\t\t\tcreated_at,\n\t\t\tread_at,\n\t\t\tdirection,\n\t\t\tcustomer_id,\n\t\t\tcustomer:customers(id, first_name, last_name, display_name, email, phone, company_name),\n\t\t\tsent_at,\n\t\t\tdelivered_at,\n\t\t\tstatus\n\t\t`,\n\t\t)\n\t\t.eq(\"id\", emailId)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"channel\", \"resend\")\n\t\t.eq(\"type\", \"email\")\n\t\t.single();\n\n\tif (error || !data) {\n\t\treturn null;\n\t}\n\n\tconst customer = Array.isArray(data.customer)\n\t\t? data.customer[0] ?? null\n\t\t: data.customer ?? null;\n\n\treturn {\n\t\t...data,\n\t\tcustomer,\n\t};\n}\n\nexport async function markEmailAsRead(\n\tcompanyId: string,\n\temailId: string,\n): Promise<boolean> {\n\tconst supabase = await createClient();\n\n\tif (!supabase || !companyId) {\n\t\tconsole.error(\" markEmailAsRead: Missing supabase or companyId\");\n\t\treturn false;\n\t}\n\n\t// First, check if the email exists and get its current state\n\tconst { data: existingEmail, error: checkError } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\"id, company_id, type, read_at\")\n\t\t.eq(\"id\", emailId)\n\t\t.single();\n\n\tif (checkError) {\n\t\tconsole.error(\" markEmailAsRead: Email not found:\", { emailId, error: checkError });\n\t\treturn false;\n\t}\n\n\tif (!existingEmail) {\n\t\tconsole.error(\" markEmailAsRead: Email not found:\", emailId);\n\t\treturn false;\n\t}\n\n\t// Verify company_id matches\n\tif (existingEmail.company_id !== companyId) {\n\t\tconsole.error(\" markEmailAsRead: Company ID mismatch:\", { \n\t\t\temailId, \n\t\t\temailCompanyId: existingEmail.company_id, \n\t\t\trequestedCompanyId: companyId \n\t\t});\n\t\treturn false;\n\t}\n\n\t// Verify type is email\n\tif (existingEmail.type !== \"email\") {\n\t\tconsole.error(\" markEmailAsRead: Type mismatch:\", { \n\t\t\temailId, \n\t\t\ttype: existingEmail.type \n\t\t});\n\t\treturn false;\n\t}\n\n\t// If already read, return success\n\tif (existingEmail.read_at) {\n\t\treturn true;\n\t}\n\n\tconst readAt = new Date().toISOString();\n\t\n\t// Try update without .single() first to see if it affects any rows\n\tconst { data: updateData, error: updateError, count } = await supabase\n\t\t.from(\"communications\")\n\t\t.update({ read_at: readAt })\n\t\t.eq(\"id\", emailId)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"type\", \"email\")\n\t\t.select(\"id, read_at\");\n\n\tif (updateError) {\n\t\tconsole.error(\" markEmailAsRead update error:\", { \n\t\t\temailId, \n\t\t\tcompanyId,\n\t\t\terror: updateError, \n\t\t\terrorCode: updateError.code, \n\t\t\terrorMessage: updateError.message,\n\t\t\terrorDetails: updateError.details,\n\t\t\terrorHint: updateError.hint\n\t\t});\n\t\treturn false;\n\t}\n\n\tif (!updateData || updateData.length === 0) {\n\t\tconsole.error(\" markEmailAsRead: No rows updated\", { \n\t\t\temailId, \n\t\t\tcompanyId,\n\t\t\tcount,\n\t\t\texistingEmail: existingEmail \n\t\t});\n\t\t// This could mean RLS policy blocked it or the filters didn't match\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nexport async function getEmailStats(): Promise<{\n\ttotalEmails: number;\n\tsentEmails: number;\n\treceivedEmails: number;\n\tunreadEmails: number;\n\tthreadsCount: number;\n}> {\n\tconst supabase = await createClient();\n\tconst companyId = await getActiveCompanyId();\n\n\tif (!supabase || !companyId) {\n\t\treturn {\n\t\t\ttotalEmails: 0,\n\t\t\tsentEmails: 0,\n\t\t\treceivedEmails: 0,\n\t\t\tunreadEmails: 0,\n\t\t\tthreadsCount: 0,\n\t\t};\n\t}\n\n\t// Get total emails\n\tconst { count: totalCount } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\"*\", { count: \"exact\", head: true })\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"channel\", \"resend\")\n\t\t.eq(\"type\", \"email\")\n\t\t.is(\"deleted_at\", null);\n\n\t// Get sent emails\n\tconst { count: sentCount } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\"*\", { count: \"exact\", head: true })\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"channel\", \"resend\")\n\t\t.eq(\"type\", \"email\")\n\t\t.eq(\"direction\", \"outbound\")\n\t\t.is(\"deleted_at\", null);\n\n\t// Get received emails\n\tconst { count: receivedCount } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\"*\", { count: \"exact\", head: true })\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"channel\", \"resend\")\n\t\t.eq(\"type\", \"email\")\n\t\t.eq(\"direction\", \"inbound\")\n\t\t.is(\"deleted_at\", null);\n\n\t// Get unread emails\n\tconst { count: unreadCount } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\"*\", { count: \"exact\", head: true })\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"channel\", \"resend\")\n\t\t.eq(\"type\", \"email\")\n\t\t.eq(\"direction\", \"inbound\")\n\t\t.is(\"read_at\", null)\n\t\t.is(\"deleted_at\", null);\n\n\t// For threads, we'll use a simple count of unique subjects\n\t// This is a simplified implementation\n\tconst threadsCount = totalCount || 0;\n\n\treturn {\n\t\ttotalEmails: totalCount || 0,\n\t\tsentEmails: sentCount || 0,\n\t\treceivedEmails: receivedCount || 0,\n\t\tunreadEmails: unreadCount || 0,\n\t\tthreadsCount,\n\t};\n}\n\nexport type ArchiveAllEmailsResult = {\n\tsuccess: boolean;\n\tcount: number;\n\terror?: string;\n};\n\nexport async function archiveAllEmails(\n\tcompanyId: string,\n\tfolder?: EmailFolder,\n): Promise<ArchiveAllEmailsResult> {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn { success: false, count: 0, error: \"Database connection failed\" };\n\t}\n\n\tif (!companyId) {\n\t\treturn { success: false, count: 0, error: \"Missing company ID\" };\n\t}\n\n\tconst buildArchiveQuery = () =>\n\t\tsupabase\n\t\t\t.from(\"communications\")\n\t\t\t.update({ is_archived: true })\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"type\", \"email\");\n\n\ttype ArchiveQuery = ReturnType<typeof buildArchiveQuery>;\n\n\tconst runArchive = async (queryBuilder: ArchiveQuery) => {\n\t\tconst { data, error, count } = await queryBuilder.select(\"id\", { count: \"exact\" });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn data?.length ?? count ?? 0;\n\t};\n\n\tconst folderName = folder?.trim();\n\tconst normalizedFolder = folderName?.toLowerCase();\n\n\ttry {\n\t\tswitch (normalizedFolder || \"inbox\") {\n\t\t\tcase \"inbox\": {\n\t\t\t\t// Inbox: inbound, not archived, not draft, not spam, not snoozed (or snooze expired)\n\t\t\t\tconst archived = await runArchive(\n\t\t\t\t\tbuildArchiveQuery()\n\t\t\t\t\t\t.eq(\"direction\", \"inbound\")\n\t\t\t\t\t\t.eq(\"is_archived\", false)\n\t\t\t\t\t\t.neq(\"status\", \"draft\")\n\t\t\t\t\t\t.or(\"category.is.null,category.neq.spam\")\n\t\t\t\t\t\t.or(`snoozed_until.is.null,snoozed_until.lt.${new Date().toISOString()}`)\n\t\t\t\t\t\t.is(\"deleted_at\", null),\n\t\t\t\t);\n\t\t\t\treturn { success: true, count: archived };\n\t\t\t}\n\t\t\tcase \"drafts\": {\n\t\t\t\tconst archived = await runArchive(\n\t\t\t\t\tbuildArchiveQuery().eq(\"status\", \"draft\").is(\"deleted_at\", null),\n\t\t\t\t);\n\t\t\t\treturn { success: true, count: archived };\n\t\t\t}\n\t\t\tcase \"sent\": {\n\t\t\t\tconst archived = await runArchive(\n\t\t\t\t\tbuildArchiveQuery()\n\t\t\t\t\t\t.eq(\"direction\", \"outbound\")\n\t\t\t\t\t\t.eq(\"is_archived\", false)\n\t\t\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t\t\t.neq(\"status\", \"draft\"),\n\t\t\t\t);\n\t\t\t\treturn { success: true, count: archived };\n\t\t\t}\n\t\t\tcase \"archive\": {\n\t\t\t\tconst archived = await runArchive(\n\t\t\t\t\tbuildArchiveQuery().eq(\"is_archived\", true).is(\"deleted_at\", null),\n\t\t\t\t);\n\t\t\t\treturn { success: true, count: archived };\n\t\t\t}\n\t\t\tcase \"snoozed\": {\n\t\t\t\tconst archived = await runArchive(\n\t\t\t\t\tbuildArchiveQuery()\n\t\t\t\t\t\t.not(\"snoozed_until\", \"is\", null)\n\t\t\t\t\t\t.gt(\"snoozed_until\", new Date().toISOString())\n\t\t\t\t\t\t.is(\"deleted_at\", null),\n\t\t\t\t);\n\t\t\t\treturn { success: true, count: archived };\n\t\t\t}\n\t\t\tcase \"spam\": {\n\t\t\t\tconst categorized = await runArchive(\n\t\t\t\t\tbuildArchiveQuery().eq(\"category\", \"spam\").is(\"deleted_at\", null),\n\t\t\t\t);\n\t\t\t\t// For spam tagged emails, fetch IDs first then update (JSONB filtering not supported)\n\t\t\t\tconst { data: spamTaggedEmails } = await supabase\n\t\t\t\t\t.from(\"communications\")\n\t\t\t\t\t.select(\"id, tags\")\n\t\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t\t.eq(\"type\", \"email\")\n\t\t\t\t\t.neq(\"category\", \"spam\")\n\t\t\t\t\t.is(\"deleted_at\", null);\n\t\t\t\tconst spamTaggedIds = (spamTaggedEmails ?? [])\n\t\t\t\t\t.filter(e => Array.isArray(e.tags) && (e.tags as string[]).includes(\"spam\"))\n\t\t\t\t\t.map(e => e.id);\n\t\t\t\tlet taggedCount = 0;\n\t\t\t\tif (spamTaggedIds.length > 0) {\n\t\t\t\t\tconst { data } = await supabase\n\t\t\t\t\t\t.from(\"communications\")\n\t\t\t\t\t\t.update({ is_archived: true })\n\t\t\t\t\t\t.in(\"id\", spamTaggedIds)\n\t\t\t\t\t\t.select(\"id\");\n\t\t\t\t\ttaggedCount = data?.length ?? 0;\n\t\t\t\t}\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\tcount: categorized + taggedCount,\n\t\t\t\t};\n\t\t\t}\n\t\t\tcase \"trash\":\n\t\t\tcase \"bin\": {\n\t\t\t\tconst archived = await runArchive(buildArchiveQuery().not(\"deleted_at\", \"is\", null));\n\t\t\t\treturn { success: true, count: archived };\n\t\t\t}\n\t\t\tcase \"starred\": {\n\t\t\t\t// Fetch starred email IDs first then update (JSONB filtering not supported)\n\t\t\t\tconst { data: starredEmails } = await supabase\n\t\t\t\t\t.from(\"communications\")\n\t\t\t\t\t.select(\"id, tags\")\n\t\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t\t.eq(\"type\", \"email\")\n\t\t\t\t\t.is(\"deleted_at\", null);\n\t\t\t\tconst starredIds = (starredEmails ?? [])\n\t\t\t\t\t.filter(e => Array.isArray(e.tags) && (e.tags as string[]).includes(\"starred\"))\n\t\t\t\t\t.map(e => e.id);\n\t\t\t\tlet starredCount = 0;\n\t\t\t\tif (starredIds.length > 0) {\n\t\t\t\t\tconst { data } = await supabase\n\t\t\t\t\t\t.from(\"communications\")\n\t\t\t\t\t\t.update({ is_archived: true })\n\t\t\t\t\t\t.in(\"id\", starredIds)\n\t\t\t\t\t\t.select(\"id\");\n\t\t\t\t\tstarredCount = data?.length ?? 0;\n\t\t\t\t}\n\t\t\t\treturn { success: true, count: starredCount };\n\t\t\t}\n\t\t\tdefault: {\n\t\t\t\t// Custom folder - fetch IDs first then update (JSONB filtering not supported)\n\t\t\t\tconst { data: customEmails } = await supabase\n\t\t\t\t\t.from(\"communications\")\n\t\t\t\t\t.select(\"id, tags\")\n\t\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t\t.eq(\"type\", \"email\")\n\t\t\t\t\t.is(\"deleted_at\", null);\n\t\t\t\tconst customIds = (customEmails ?? [])\n\t\t\t\t\t.filter(e => Array.isArray(e.tags) && folderName && (e.tags as string[]).includes(folderName))\n\t\t\t\t\t.map(e => e.id);\n\t\t\t\tlet customCount = 0;\n\t\t\t\tif (customIds.length > 0) {\n\t\t\t\t\tconst { data } = await supabase\n\t\t\t\t\t\t.from(\"communications\")\n\t\t\t\t\t\t.update({ is_archived: true })\n\t\t\t\t\t\t.in(\"id\", customIds)\n\t\t\t\t\t\t.select(\"id\");\n\t\t\t\t\tcustomCount = data?.length ?? 0;\n\t\t\t\t}\n\t\t\t\treturn { success: true, count: customCount };\n\t\t\t}\n\t\t}\n\t} catch (error) {\n\t\tconsole.error(\" archiveAllEmails error:\", { companyId, folder, error });\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tcount: 0,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5808, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/notifications/types.ts"],"sourcesContent":["/**\n * Notification Types and Schemas\n *\n * Zod schemas and TypeScript types for the notifications system.\n * Separated from server actions to comply with Next.js \"use server\" restrictions.\n */\n\nimport { z } from \"zod\";\n\n// ============================================================================\n// SCHEMAS\n// ============================================================================\n\nconst NotificationTypeSchema = z.enum([\n\t\"message\",\n\t\"alert\",\n\t\"payment\",\n\t\"job\",\n\t\"team\",\n\t\"system\",\n]);\n\nconst NotificationPrioritySchema = z.enum([\n\t\"low\",\n\t\"medium\",\n\t\"high\",\n\t\"urgent\",\n]);\n\nexport const CreateNotificationSchema = z.object({\n\tuserId: z.string().uuid(\"Invalid user ID\"),\n\tcompanyId: z.string().uuid(\"Invalid company ID\"),\n\ttype: NotificationTypeSchema,\n\tpriority: NotificationPrioritySchema.default(\"medium\"),\n\ttitle: z.string().min(1, \"Title is required\").max(200),\n\tmessage: z.string().min(1, \"Message is required\").max(500),\n\tactionUrl: z.string().url().optional().or(z.literal(\"\")),\n\tactionLabel: z.string().max(50).optional(),\n\tmetadata: z.record(z.string(), z.any()).optional(),\n});\n\nexport const GetNotificationsSchema = z.object({\n\tlimit: z.number().int().min(1).max(100).default(50),\n\toffset: z.number().int().min(0).default(0),\n\tunreadOnly: z.boolean().default(false),\n\ttype: NotificationTypeSchema.optional(),\n\tpriority: NotificationPrioritySchema.optional(),\n});\n\nexport const NotificationPreferenceSchema = z.object({\n\tchannel: z.enum([\"in_app\", \"email\", \"sms\", \"push\"]),\n\teventType: z.string(),\n\tenabled: z.boolean(),\n});\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\nexport type NotificationType = z.infer<typeof NotificationTypeSchema>;\nexport type NotificationPriority = z.infer<typeof NotificationPrioritySchema>;\nexport type CreateNotificationInput = z.infer<typeof CreateNotificationSchema>;\nexport type GetNotificationsInput = z.infer<typeof GetNotificationsSchema>;\nexport type NotificationPreference = z.infer<\n\ttypeof NotificationPreferenceSchema\n>;\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;AAED;;AAEA,+EAA+E;AAC/E,UAAU;AACV,+EAA+E;AAE/E,MAAM,yBAAyB,mOAAC,CAAC,IAAI,CAAC;IACrC;IACA;IACA;IACA;IACA;IACA;CACA;AAED,MAAM,6BAA6B,mOAAC,CAAC,IAAI,CAAC;IACzC;IACA;IACA;IACA;CACA;AAEM,MAAM,2BAA2B,mOAAC,CAAC,MAAM,CAAC;IAChD,QAAQ,mOAAC,CAAC,MAAM,GAAG,IAAI,CAAC;IACxB,WAAW,mOAAC,CAAC,MAAM,GAAG,IAAI,CAAC;IAC3B,MAAM;IACN,UAAU,2BAA2B,OAAO,CAAC;IAC7C,OAAO,mOAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,qBAAqB,GAAG,CAAC;IAClD,SAAS,mOAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,uBAAuB,GAAG,CAAC;IACtD,WAAW,mOAAC,CAAC,MAAM,GAAG,GAAG,GAAG,QAAQ,GAAG,EAAE,CAAC,mOAAC,CAAC,OAAO,CAAC;IACpD,aAAa,mOAAC,CAAC,MAAM,GAAG,GAAG,CAAC,IAAI,QAAQ;IACxC,UAAU,mOAAC,CAAC,MAAM,CAAC,mOAAC,CAAC,MAAM,IAAI,mOAAC,CAAC,GAAG,IAAI,QAAQ;AACjD;AAEO,MAAM,yBAAyB,mOAAC,CAAC,MAAM,CAAC;IAC9C,OAAO,mOAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,KAAK,OAAO,CAAC;IAChD,QAAQ,mOAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,OAAO,CAAC;IACxC,YAAY,mOAAC,CAAC,OAAO,GAAG,OAAO,CAAC;IAChC,MAAM,uBAAuB,QAAQ;IACrC,UAAU,2BAA2B,QAAQ;AAC9C;AAEO,MAAM,+BAA+B,mOAAC,CAAC,MAAM,CAAC;IACpD,SAAS,mOAAC,CAAC,IAAI,CAAC;QAAC;QAAU;QAAS;QAAO;KAAO;IAClD,WAAW,mOAAC,CAAC,MAAM;IACnB,SAAS,mOAAC,CAAC,OAAO;AACnB"}},
    {"offset": {"line": 5872, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/auth/tokens.ts"],"sourcesContent":["// Re-export from @stratos/auth package for backwards compatibility\nexport * from \"@stratos/auth/tokens\";\n"],"names":[],"mappings":"AAAA,mEAAmE;;AACnE"}},
    {"offset": {"line": 5880, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/security/csrf.ts"],"sourcesContent":["/**\n * CSRF Protection\n *\n * Cross-Site Request Forgery (CSRF) protection for Server Actions.\n * Generates and validates tokens to prevent unauthorized form submissions.\n *\n * How it works:\n * 1. Server generates a random CSRF token and stores it in HTTP-only cookie\n * 2. Token is also included in form as hidden field or header\n * 3. On form submission, server compares cookie token with submitted token\n * 4. Tokens must match exactly or request is rejected\n *\n * Usage in Server Actions:\n * ```typescript\n * export async function updateSettings(formData: FormData) {\n *   await verifyCSRFToken(formData);\n *   // Your logic here\n * }\n * ```\n *\n * Usage in Forms:\n * ```tsx\n * <form action={updateSettings}>\n *   <CSRFTokenInput />\n *   <input name=\"setting\" />\n *   <button type=\"submit\">Save</button>\n * </form>\n * ```\n */\n\nimport { randomBytes } from \"node:crypto\";\nimport { cookies, headers } from \"next/headers\";\n\nconst CSRF_TOKEN_COOKIE = \"csrf_token\";\nconst CSRF_HEADER = \"x-csrf-token\";\nconst CSRF_FORM_FIELD = \"csrf_token\";\n\n/**\n * CSRF Error\n */\nclass CSRFError extends Error {\n\tconstructor(message: string) {\n\t\tsuper(message);\n\t\tthis.name = \"CSRFError\";\n\t}\n}\n\n/**\n * Generate CSRF Token\n *\n * Creates a secure random token and stores it in an HTTP-only cookie.\n * Call this in Server Components or Server Actions to initialize CSRF protection.\n *\n * @returns The generated CSRF token (for including in forms)\n */\nasync function generateCSRFToken(): Promise<string> {\n\tconst token = randomBytes(32).toString(\"hex\");\n\tconst cookieStore = await cookies();\n\n\tcookieStore.set(CSRF_TOKEN_COOKIE, token, {\n\t\thttpOnly: true,\n\t\tsecure: process.env.NODE_ENV === \"production\",\n\t\tsameSite: \"strict\",\n\t\tmaxAge: 60 * 60 * 24, // 24 hours\n\t\tpath: \"/\",\n\t});\n\n\treturn token;\n}\n\n/**\n * Get Current CSRF Token\n *\n * Gets the CSRF token from cookies without generating a new one.\n * Generates a new token if none exists.\n *\n * @returns Current CSRF token or new token if none exists\n */\nasync function getCSRFToken(): Promise<string> {\n\tconst cookieStore = await cookies();\n\tconst existingToken = cookieStore.get(CSRF_TOKEN_COOKIE)?.value;\n\n\tif (existingToken) {\n\t\treturn existingToken;\n\t}\n\n\t// Generate new token if none exists\n\treturn generateCSRFToken();\n}\n\n/**\n * Verify CSRF Token\n *\n * Validates the CSRF token from request against the cookie.\n * Supports both header-based and form field-based tokens.\n *\n * @param formData - Optional FormData containing the CSRF token\n * @throws CSRFError if validation fails\n *\n * @example\n * // In Server Action\n * export async function updateUser(formData: FormData) {\n *   await verifyCSRFToken(formData);\n *   // Your logic here\n * }\n */\nasync function verifyCSRFToken(formData?: FormData): Promise<void> {\n\tconst cookieStore = await cookies();\n\tconst headersList = await headers();\n\n\tconst cookieToken = cookieStore.get(CSRF_TOKEN_COOKIE)?.value;\n\n\t// Get token from header or form field\n\tlet submittedToken: string | null = null;\n\n\t// Check header first (for fetch requests)\n\tsubmittedToken = headersList.get(CSRF_HEADER);\n\n\t// Fall back to form field (for form submissions)\n\tif (!submittedToken && formData) {\n\t\tsubmittedToken = formData.get(CSRF_FORM_FIELD) as string | null;\n\t}\n\n\t// Validate\n\tif (!cookieToken) {\n\t\tthrow new CSRFError(\n\t\t\t\"CSRF token missing from cookies. Please refresh the page and try again.\",\n\t\t);\n\t}\n\n\tif (!submittedToken) {\n\t\tthrow new CSRFError(\n\t\t\t\"CSRF token missing from request. Please ensure the form includes a CSRF token.\",\n\t\t);\n\t}\n\n\t// Constant-time comparison to prevent timing attacks\n\tif (!constantTimeCompare(cookieToken, submittedToken)) {\n\t\tthrow new CSRFError(\n\t\t\t\"Invalid CSRF token. This request may be forged. Please refresh the page and try again.\",\n\t\t);\n\t}\n}\n\n/**\n * Constant-Time String Comparison\n *\n * Compares two strings in constant time to prevent timing attacks.\n * Always compares the full length even if strings don't match.\n *\n * @param a - First string\n * @param b - Second string\n * @returns true if strings are equal, false otherwise\n */\nfunction constantTimeCompare(a: string, b: string): boolean {\n\t// If lengths don't match, still do comparison to prevent timing leak\n\tif (a.length !== b.length) {\n\t\treturn false;\n\t}\n\n\tlet result = 0;\n\tfor (let i = 0; i < a.length; i++) {\n\t\tresult |= a.charCodeAt(i) ^ b.charCodeAt(i);\n\t}\n\n\treturn result === 0;\n}\n\n/**\n * CSRF Protection Wrapper for Server Actions\n *\n * Wraps a Server Action to automatically verify CSRF token.\n *\n * @param fn - Server Action function to wrap\n * @returns Wrapped function with CSRF protection\n *\n * @example\n * ```typescript\n * export const updateSettings = withCSRFProtection(\n *   async (formData: FormData) => {\n *     // Your logic here - CSRF already verified\n *   }\n * );\n * ```\n */\nfunction withCSRFProtection<T extends any[], R>(\n\tfn: (...args: T) => Promise<R>,\n): (...args: T) => Promise<R> {\n\treturn async (...args: T): Promise<R> => {\n\t\t// Check if first argument is FormData\n\t\tconst formData = args[0] instanceof FormData ? args[0] : undefined;\n\n\t\tawait verifyCSRFToken(formData);\n\t\treturn fn(...args);\n\t};\n}\n\n/**\n * Rotate CSRF Token\n *\n * Generates a new CSRF token, invalidating the old one.\n * Use this after successful form submission or periodically for extra security.\n *\n * @returns New CSRF token\n */\nasync function rotateCSRFToken(): Promise<string> {\n\treturn generateCSRFToken();\n}\n\n/**\n * Clear CSRF Token\n *\n * Removes the CSRF token cookie.\n * Use this on logout.\n */\nexport async function clearCSRFToken(): Promise<void> {\n\tconst cookieStore = await cookies();\n\tcookieStore.delete(CSRF_TOKEN_COOKIE);\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;CA4BC;;;;AAED;AACA;;;AAEA,MAAM,oBAAoB;AAC1B,MAAM,cAAc;AACpB,MAAM,kBAAkB;AAExB;;CAEC,GACD,MAAM,kBAAkB;IACvB,YAAY,OAAe,CAAE;QAC5B,KAAK,CAAC;QACN,IAAI,CAAC,IAAI,GAAG;IACb;AACD;AAEA;;;;;;;CAOC,GACD,eAAe;IACd,MAAM,QAAQ,IAAA,oIAAW,EAAC,IAAI,QAAQ,CAAC;IACvC,MAAM,cAAc,MAAM,IAAA,iTAAO;IAEjC,YAAY,GAAG,CAAC,mBAAmB,OAAO;QACzC,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ,KAAK,KAAK;QAClB,MAAM;IACP;IAEA,OAAO;AACR;AAEA;;;;;;;CAOC,GACD,eAAe;IACd,MAAM,cAAc,MAAM,IAAA,iTAAO;IACjC,MAAM,gBAAgB,YAAY,GAAG,CAAC,oBAAoB;IAE1D,IAAI,eAAe;QAClB,OAAO;IACR;IAEA,oCAAoC;IACpC,OAAO;AACR;AAEA;;;;;;;;;;;;;;;CAeC,GACD,eAAe,gBAAgB,QAAmB;IACjD,MAAM,cAAc,MAAM,IAAA,iTAAO;IACjC,MAAM,cAAc,MAAM,IAAA,iTAAO;IAEjC,MAAM,cAAc,YAAY,GAAG,CAAC,oBAAoB;IAExD,sCAAsC;IACtC,IAAI,iBAAgC;IAEpC,0CAA0C;IAC1C,iBAAiB,YAAY,GAAG,CAAC;IAEjC,iDAAiD;IACjD,IAAI,CAAC,kBAAkB,UAAU;QAChC,iBAAiB,SAAS,GAAG,CAAC;IAC/B;IAEA,WAAW;IACX,IAAI,CAAC,aAAa;QACjB,MAAM,IAAI,UACT;IAEF;IAEA,IAAI,CAAC,gBAAgB;QACpB,MAAM,IAAI,UACT;IAEF;IAEA,qDAAqD;IACrD,IAAI,CAAC,oBAAoB,aAAa,iBAAiB;QACtD,MAAM,IAAI,UACT;IAEF;AACD;AAEA;;;;;;;;;CASC,GACD,SAAS,oBAAoB,CAAS,EAAE,CAAS;IAChD,qEAAqE;IACrE,IAAI,EAAE,MAAM,KAAK,EAAE,MAAM,EAAE;QAC1B,OAAO;IACR;IAEA,IAAI,SAAS;IACb,IAAK,IAAI,IAAI,GAAG,IAAI,EAAE,MAAM,EAAE,IAAK;QAClC,UAAU,EAAE,UAAU,CAAC,KAAK,EAAE,UAAU,CAAC;IAC1C;IAEA,OAAO,WAAW;AACnB;AAEA;;;;;;;;;;;;;;;;CAgBC,GACD,SAAS,mBACR,EAA8B;IAE9B,OAAO,OAAO,GAAG;QAChB,sCAAsC;QACtC,MAAM,WAAW,IAAI,CAAC,EAAE,YAAY,WAAW,IAAI,CAAC,EAAE,GAAG;QAEzD,MAAM,gBAAgB;QACtB,OAAO,MAAM;IACd;AACD;AAEA;;;;;;;CAOC,GACD,eAAe;IACd,OAAO;AACR;AAQO,eAAe;IACrB,MAAM,cAAc,MAAM,IAAA,iTAAO;IACjC,YAAY,MAAM,CAAC;AACpB"}},
    {"offset": {"line": 6063, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/security/rate-limit.ts"],"sourcesContent":["/**\n * Rate Limiting Utilities\n *\n * Provides rate limiting for authentication and API endpoints to prevent:\n * - Brute force password attacks\n * - Account enumeration\n * - Email spam/flooding\n * - DDoS attacks\n *\n * Implementation:\n * - Uses in-memory LRU cache for development/small scale\n * - Can be easily swapped with Redis/Upstash for production\n * - Sliding window algorithm for accurate rate limiting\n * - Per-identifier tracking (email, IP, user ID)\n */\n\n// Simple in-memory rate limiter using LRU cache\n// For production, replace with @upstash/ratelimit + @upstash/redis\nclass InMemoryRateLimiter {\n\tprivate requests: Map<\n\t\tstring,\n\t\t{ count: number; resetAt: number; requests: number[] }\n\t>;\n\tprivate readonly maxRequests: number;\n\tprivate readonly windowMs: number;\n\n\tconstructor(maxRequests: number, windowMs: number) {\n\t\tthis.requests = new Map();\n\t\tthis.maxRequests = maxRequests;\n\t\tthis.windowMs = windowMs;\n\n\t\t// Cleanup old entries every minute\n\t\tsetInterval(() => this.cleanup(), 60_000);\n\t}\n\n\tasync limit(identifier: string): Promise<{\n\t\tsuccess: boolean;\n\t\tlimit: number;\n\t\tremaining: number;\n\t\treset: number;\n\t}> {\n\t\tconst now = Date.now();\n\t\tconst key = identifier;\n\n\t\tlet record = this.requests.get(key);\n\n\t\t// Initialize if doesn't exist\n\t\tif (!record) {\n\t\t\trecord = {\n\t\t\t\tcount: 0,\n\t\t\t\tresetAt: now + this.windowMs,\n\t\t\t\trequests: [],\n\t\t\t};\n\t\t\tthis.requests.set(key, record);\n\t\t}\n\n\t\t// Remove requests outside the sliding window\n\t\trecord.requests = record.requests.filter(\n\t\t\t(timestamp) => timestamp > now - this.windowMs,\n\t\t);\n\n\t\t// Check if limit exceeded\n\t\tif (record.requests.length >= this.maxRequests) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tlimit: this.maxRequests,\n\t\t\t\tremaining: 0,\n\t\t\t\treset: Math.min(...record.requests) + this.windowMs,\n\t\t\t};\n\t\t}\n\n\t\t// Add new request\n\t\trecord.requests.push(now);\n\t\trecord.count = record.requests.length;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tlimit: this.maxRequests,\n\t\t\tremaining: this.maxRequests - record.count,\n\t\t\treset: now + this.windowMs,\n\t\t};\n\t}\n\n\tprivate cleanup() {\n\t\tconst now = Date.now();\n\t\tfor (const [key, record] of this.requests.entries()) {\n\t\t\trecord.requests = record.requests.filter(\n\t\t\t\t(timestamp) => timestamp > now - this.windowMs,\n\t\t\t);\n\t\t\tif (record.requests.length === 0) {\n\t\t\t\tthis.requests.delete(key);\n\t\t\t}\n\t\t}\n\t}\n\n\treset(identifier: string) {\n\t\tthis.requests.delete(identifier);\n\t}\n\n\tclear() {\n\t\tthis.requests.clear();\n\t}\n}\n\n// Rate limiter instances for different operations\nconst authRateLimiterInstance = new InMemoryRateLimiter(\n\t5, // 5 requests\n\t15 * 60 * 1000, // per 15 minutes\n);\n\nconst apiRateLimiterInstance = new InMemoryRateLimiter(\n\t100, // 100 requests\n\t60 * 1000, // per 1 minute\n);\n\nconst passwordResetRateLimiterInstance = new InMemoryRateLimiter(\n\t3, // 3 requests\n\t60 * 60 * 1000, // per 1 hour\n);\n\n/**\n * Auth Rate Limiter\n *\n * Use for: Sign in, Sign up, OAuth\n * Limit: 5 requests per 15 minutes per identifier\n */\nexport const authRateLimiter = {\n\tlimit: (identifier: string) => authRateLimiterInstance.limit(identifier),\n\treset: (identifier: string) => authRateLimiterInstance.reset(identifier),\n};\n\n/**\n * API Rate Limiter\n *\n * Use for: General API endpoints\n * Limit: 100 requests per minute per identifier\n */\nconst apiRateLimiter = {\n\tlimit: (identifier: string) => apiRateLimiterInstance.limit(identifier),\n\treset: (identifier: string) => apiRateLimiterInstance.reset(identifier),\n};\n\n/**\n * Password Reset Rate Limiter\n *\n * Use for: Password reset requests\n * Limit: 3 requests per hour per identifier\n */\nexport const passwordResetRateLimiter = {\n\tlimit: (identifier: string) =>\n\t\tpasswordResetRateLimiterInstance.limit(identifier),\n\treset: (identifier: string) =>\n\t\tpasswordResetRateLimiterInstance.reset(identifier),\n};\n\n/**\n * Rate Limit Error\n */\nexport class RateLimitError extends Error {\n\tconstructor(\n\t\tmessage: string,\n\t\tpublic limit: number,\n\t\tpublic remaining: number,\n\t\tpublic reset: number,\n\t) {\n\t\tsuper(message);\n\t\tthis.name = \"RateLimitError\";\n\t}\n}\n\n/**\n * Check Rate Limit\n *\n * Throws RateLimitError if rate limit exceeded.\n *\n * @param identifier - Unique identifier (email, IP, user ID)\n * @param limiter - Rate limiter instance to use\n */\nexport async function checkRateLimit(\n\tidentifier: string,\n\tlimiter: typeof authRateLimiter = apiRateLimiter,\n): Promise<void> {\n\tconst { success, limit, remaining, reset } = await limiter.limit(identifier);\n\n\tif (!success) {\n\t\tconst resetDate = new Date(reset);\n\t\tthrow new RateLimitError(\n\t\t\t`Too many requests. Please try again after ${resetDate.toLocaleTimeString()}.`,\n\t\t\tlimit,\n\t\t\tremaining,\n\t\t\treset,\n\t\t);\n\t}\n}\n\n/**\n * Get Client IP Address\n *\n * Extracts IP from request headers for rate limiting.\n * Supports various proxy headers.\n */\nfunction getClientIP(request: Request): string {\n\tconst headers = new Headers(request.headers);\n\n\t// Check common proxy headers\n\tconst forwarded = headers.get(\"x-forwarded-for\");\n\tif (forwarded) {\n\t\treturn forwarded.split(\",\")[0].trim();\n\t}\n\n\tconst realIP = headers.get(\"x-real-ip\");\n\tif (realIP) {\n\t\treturn realIP;\n\t}\n\n\tconst cfIP = headers.get(\"cf-connecting-ip\"); // Cloudflare\n\tif (cfIP) {\n\t\treturn cfIP;\n\t}\n\n\t// Fallback to unknown\n\treturn \"unknown\";\n}\n\n/**\n * Production Setup Instructions\n *\n * For production, replace in-memory limiter with Redis:\n *\n * 1. Install dependencies:\n *    ```bash\n *    pnpm add @upstash/ratelimit @upstash/redis\n *    ```\n *\n * 2. Update this file:\n *    ```typescript\n *    import { Ratelimit } from \"@upstash/ratelimit\";\n *    import { Redis } from \"@upstash/redis\";\n *\n *    const redis = new Redis({\n *      url: process.env.UPSTASH_REDIS_REST_URL!,\n *      token: process.env.UPSTASH_REDIS_REST_TOKEN!,\n *    });\n *\n *    export const authRateLimiter = new Ratelimit({\n *      redis,\n *      limiter: Ratelimit.slidingWindow(5, \"15 m\"),\n *      analytics: true,\n *      prefix: \"ratelimit:auth\",\n *    });\n *    ```\n *\n * 3. Add environment variables:\n *    ```\n *    UPSTASH_REDIS_REST_URL=https://...\n *    UPSTASH_REDIS_REST_TOKEN=...\n *    ```\n */\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6247, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/search/full-text-search.ts"],"sourcesContent":["/**\n * Full-Text Search Utilities\n *\n * Provides enterprise-grade PostgreSQL full-text search with:\n * - Weighted ranking (ts_rank) for best match results\n * - Multi-field search across all relevant columns\n * - Fuzzy matching with pg_trgm for typo tolerance\n * - Company-scoped security (RLS enforced)\n *\n * Performance:\n * - Uses GIN indexes for sub-millisecond search\n * - Searches millions of records efficiently\n * - Returns top 50 results by default (configurable)\n *\n * Search Features:\n * - Multi-word queries: \"john plumber\" matches both words\n * - Phrase search: Use quotes for exact phrases\n * - Fuzzy matching: Handles typos and variations\n * - Weighted fields: Name matches rank higher than notes\n */\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\n\n/**\n * Search result with ranking score\n */\nexport type SearchResult<T> = T & {\n\tsearch_rank?: number;\n\tsearch_similarity?: number;\n};\n\n/**\n * Search options for customization\n */\nexport type SearchOptions = {\n\tlimit?: number;\n\toffset?: number;\n\tminSimilarity?: number; // 0-1, default 0.3\n\tuseFullTextSearch?: boolean; // Default true\n\tuseFuzzyMatch?: boolean; // Default true\n\torderBy?: string; // Additional ordering after rank\n};\n\n/**\n * Search customers with full-text search and ranking\n *\n * Searches across: first_name, last_name, display_name, email, phone, company_name, address\n * Returns results ordered by relevance (best matches first)\n *\n * @example\n * const results = await searchCustomersFullText(supabase, companyId, \"john plumber\");\n * // Returns customers matching \"john\" AND \"plumber\" ranked by relevance\n */\nexport async function searchCustomersFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst {\n\t\tlimit = 50,\n\t\toffset = 0,\n\t\tminSimilarity = 0.3,\n\t\tuseFullTextSearch = true,\n\t\tuseFuzzyMatch = true,\n\t} = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_customers_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search if full-text search not available or fails\n\tconst { data } = await supabase\n\t\t.from(\"customers\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.or(\n\t\t\t`display_name.ilike.%${query}%,email.ilike.%${query}%,phone.ilike.%${query}%,company_name.ilike.%${query}%,address.ilike.%${query}%,city.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"display_name\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search jobs with full-text search and ranking\n *\n * Searches across: job_number, title, description, notes, job_type, status, priority\n * Returns results ordered by relevance\n */\nexport async function searchJobsFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 50, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_jobs_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"jobs\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.or(\n\t\t\t`job_number.ilike.%${query}%,title.ilike.%${query}%,description.ilike.%${query}%,notes.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search properties with full-text search and ranking\n *\n * Searches across: name, address, city, state, zip_code, notes\n * Returns results ordered by relevance\n */\nasync function searchPropertiesFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 50, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_properties_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"properties\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.or(\n\t\t\t`name.ilike.%${query}%,address.ilike.%${query}%,city.ilike.%${query}%,state.ilike.%${query}%,zip_code.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"address\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search price book items with full-text search and ranking\n *\n * Searches across: name, sku, supplier_sku, description, category, subcategory\n * Returns results ordered by relevance\n */\nasync function searchPriceBookItemsFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 100, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\n\t\t\t\"search_price_book_items_ranked\",\n\t\t\t{\n\t\t\t\tcompany_id_param: companyId,\n\t\t\t\tsearch_query: query,\n\t\t\t\tresult_limit: limit,\n\t\t\t\tresult_offset: offset,\n\t\t\t},\n\t\t);\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"price_book_items\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.or(\n\t\t\t`name.ilike.%${query}%,sku.ilike.%${query}%,supplier_sku.ilike.%${query}%,description.ilike.%${query}%,category.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"name\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search equipment with full-text search and ranking\n *\n * Searches across: equipment_number, name, type, manufacturer, model, serial_number\n * Returns results ordered by relevance\n */\nasync function searchEquipmentFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 50, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_equipment_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"equipment\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.or(\n\t\t\t`equipment_number.ilike.%${query}%,name.ilike.%${query}%,type.ilike.%${query}%,manufacturer.ilike.%${query}%,model.ilike.%${query}%,serial_number.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"name\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Universal search function - searches across ALL entities\n *\n * Returns combined results from customers, jobs, properties, equipment, etc.\n * Useful for global search functionality\n */\nexport async function searchAllEntities(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<{\n\tcustomers: SearchResult<any>[];\n\tjobs: SearchResult<any>[];\n\tproperties: SearchResult<any>[];\n\tequipment: SearchResult<any>[];\n\tpriceBookItems: SearchResult<any>[];\n}> {\n\tconst defaultLimit = options.limit || 10; // Limit per entity\n\n\tconst [customers, jobs, properties, equipment, priceBookItems] =\n\t\tawait Promise.all([\n\t\t\tsearchCustomersFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchJobsFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchPropertiesFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchEquipmentFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchPriceBookItemsFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t]);\n\n\treturn {\n\t\tcustomers,\n\t\tjobs,\n\t\tproperties,\n\t\tequipment,\n\t\tpriceBookItems,\n\t};\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6445, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/services/google-custom-search-service.ts"],"sourcesContent":["/**\n * Google Custom Search Service\n *\n * Provides web search capabilities for the AI agent:\n * - General web search\n * - News search\n * - Image search\n * - Site-specific search\n *\n * API: Google Custom Search JSON API\n * Free Tier: 100 queries/day free, then $5/1000 queries\n * Docs: https://developers.google.com/custom-search/v1/overview\n *\n * Setup:\n * 1. Enable Custom Search API in Google Cloud Console\n * 2. Create a Programmable Search Engine at https://programmablesearchengine.google.com/\n * 3. Get your Search Engine ID (cx parameter)\n * 4. Set GOOGLE_SEARCH_ENGINE_ID in environment\n */\n\nimport { z } from \"zod\";\n\nconst USER_AGENT = \"Stratos-FMS/1.0 (support@stratos.app)\";\n\n// Zod schemas for type safety\nconst SearchResultSchema = z.object({\n\ttitle: z.string(),\n\tlink: z.string().url(),\n\tsnippet: z.string(),\n\tdisplayLink: z.string(),\n\tformattedUrl: z.string().optional(),\n\tpagemap: z\n\t\t.object({\n\t\t\tcse_thumbnail: z\n\t\t\t\t.array(\n\t\t\t\t\tz.object({\n\t\t\t\t\t\tsrc: z.string(),\n\t\t\t\t\t\twidth: z.string().optional(),\n\t\t\t\t\t\theight: z.string().optional(),\n\t\t\t\t\t})\n\t\t\t\t)\n\t\t\t\t.optional(),\n\t\t\tmetatags: z\n\t\t\t\t.array(\n\t\t\t\t\tz.record(z.string())\n\t\t\t\t)\n\t\t\t\t.optional(),\n\t\t})\n\t\t.optional(),\n});\n\nconst SearchResponseSchema = z.object({\n\tresults: z.array(SearchResultSchema),\n\ttotalResults: z.number(),\n\tsearchTime: z.number(),\n\tquery: z.string(),\n\tsearchType: z.enum([\"web\", \"news\", \"image\"]),\n\tnextPageToken: z.string().optional(),\n});\n\nexport type SearchResult = z.infer<typeof SearchResultSchema>;\nexport type SearchResponse = z.infer<typeof SearchResponseSchema>;\n\n/**\n * Search options\n */\nexport interface SearchOptions {\n\t/** Number of results to return (max 10 per request) */\n\tnum?: number;\n\t/** Starting index for pagination (1-based) */\n\tstart?: number;\n\t/** Restrict to specific site (e.g., \"reddit.com\") */\n\tsiteSearch?: string;\n\t/** Exclude results from site */\n\tsiteSearchExclude?: string;\n\t/** Date restriction: d[number], w[number], m[number], y[number] */\n\tdateRestrict?: string;\n\t/** Safe search level */\n\tsafe?: \"off\" | \"medium\" | \"high\";\n\t/** Filter adult content */\n\tfilter?: \"0\" | \"1\";\n\t/** Country to search from (ISO 3166-1 alpha-2) */\n\tgl?: string;\n\t/** Language of results (ISO 639-1) */\n\tlr?: string;\n\t/** Sort by date (if supported) */\n\tsort?: \"date\" | \"relevance\";\n}\n\nconst CACHE_TTL_MS = 1000 * 60 * 15; // 15 minutes\n\n// biome-ignore lint/suspicious/noConsole: Backend service logging is acceptable\nclass GoogleCustomSearchService {\n\tprivate readonly apiKey: string | undefined;\n\tprivate readonly searchEngineId: string | undefined;\n\tprivate readonly cache: Map<string, { data: SearchResponse; timestamp: number }> = new Map();\n\tprivate readonly cacheTTL = CACHE_TTL_MS;\n\n\tconstructor() {\n\t\t// Use unified GOOGLE_API_KEY for all Google services\n\t\tthis.apiKey =\n\t\t\tprocess.env.GOOGLE_API_KEY ||\n\t\t\tprocess.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY ||\n\t\t\tprocess.env.GOOGLE_MAPS_API_KEY;\n\t\tthis.searchEngineId =\n\t\t\tprocess.env.GOOGLE_SEARCH_ENGINE_ID ||\n\t\t\tprocess.env.GOOGLE_CSE_ID ||\n\t\t\tprocess.env.NEXT_PUBLIC_GOOGLE_SEARCH_ENGINE_ID;\n\t}\n\n\t/**\n\t * Perform a web search\n\t */\n\tasync search(query: string, options: SearchOptions = {}): Promise<SearchResponse | null> {\n\t\tif (!this.apiKey || !this.searchEngineId) {\n\t\t\tconsole.warn(\"Google Custom Search not configured: missing API key or Search Engine ID\");\n\t\t\treturn null;\n\t\t}\n\n\t\tconst cacheKey = this.getCacheKey(query, options, \"web\");\n\t\tconst cached = this.cache.get(cacheKey);\n\n\t\tif (cached && Date.now() - cached.timestamp < this.cacheTTL) {\n\t\t\treturn cached.data;\n\t\t}\n\n\t\ttry {\n\t\t\tconst params = this.buildParams(query, options);\n\t\t\tconst url = `https://www.googleapis.com/customsearch/v1?${params.toString()}`;\n\n\t\t\tconst response = await fetch(url, {\n\t\t\t\theaders: { \"User-Agent\": USER_AGENT },\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst error = await response.json();\n\t\t\t\tconsole.error(\"Google Custom Search error:\", error);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst data = await response.json();\n\t\t\tconst searchResponse = this.parseResponse(data, query, \"web\");\n\n\t\t\tthis.cache.set(cacheKey, { data: searchResponse, timestamp: Date.now() });\n\t\t\treturn searchResponse;\n\t\t} catch (error) {\n\t\t\tconsole.error(\"Google Custom Search failed:\", error);\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Search for news articles\n\t * Uses date restriction to get recent results\n\t */\n\tasync searchNews(\n\t\tquery: string,\n\t\toptions: SearchOptions & { daysBack?: number } = {}\n\t): Promise<SearchResponse | null> {\n\t\tconst { daysBack = 7, ...searchOptions } = options;\n\n\t\t// Add date restriction for recent news\n\t\tconst newsOptions: SearchOptions = {\n\t\t\t...searchOptions,\n\t\t\tdateRestrict: `d${daysBack}`,\n\t\t\tsort: \"date\",\n\t\t};\n\n\t\tconst cacheKey = this.getCacheKey(query, newsOptions, \"news\");\n\t\tconst cached = this.cache.get(cacheKey);\n\n\t\tif (cached && Date.now() - cached.timestamp < this.cacheTTL) {\n\t\t\treturn cached.data;\n\t\t}\n\n\t\tconst result = await this.search(query, newsOptions);\n\t\tif (result) {\n\t\t\tresult.searchType = \"news\";\n\t\t\tthis.cache.set(cacheKey, { data: result, timestamp: Date.now() });\n\t\t}\n\t\treturn result;\n\t}\n\n\t/**\n\t * Search for images\n\t */\n\tasync searchImages(query: string, options: SearchOptions = {}): Promise<SearchResponse | null> {\n\t\tif (!this.apiKey || !this.searchEngineId) {\n\t\t\tconsole.warn(\"Google Custom Search not configured\");\n\t\t\treturn null;\n\t\t}\n\n\t\tconst cacheKey = this.getCacheKey(query, options, \"image\");\n\t\tconst cached = this.cache.get(cacheKey);\n\n\t\tif (cached && Date.now() - cached.timestamp < this.cacheTTL) {\n\t\t\treturn cached.data;\n\t\t}\n\n\t\ttry {\n\t\t\tconst params = this.buildParams(query, options);\n\t\t\tparams.set(\"searchType\", \"image\");\n\n\t\t\tconst url = `https://www.googleapis.com/customsearch/v1?${params.toString()}`;\n\n\t\t\tconst response = await fetch(url, {\n\t\t\t\theaders: { \"User-Agent\": USER_AGENT },\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst error = await response.json();\n\t\t\t\tconsole.error(\"Google Image Search error:\", error);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst data = await response.json();\n\t\t\tconst searchResponse = this.parseImageResponse(data, query);\n\n\t\t\tthis.cache.set(cacheKey, { data: searchResponse, timestamp: Date.now() });\n\t\t\treturn searchResponse;\n\t\t} catch (error) {\n\t\t\tconsole.error(\"Google Image Search failed:\", error);\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Search within a specific site\n\t */\n\tasync searchSite(\n\t\tquery: string,\n\t\tsite: string,\n\t\toptions: SearchOptions = {}\n\t): Promise<SearchResponse | null> {\n\t\treturn this.search(query, {\n\t\t\t...options,\n\t\t\tsiteSearch: site,\n\t\t});\n\t}\n\n\t/**\n\t * Search for technical/documentation content\n\t * Focuses on official docs, Stack Overflow, GitHub\n\t */\n\tasync searchTechnical(query: string, options: SearchOptions = {}): Promise<SearchResponse | null> {\n\t\t// Append technical terms to improve results\n\t\tconst technicalQuery = `${query} documentation OR tutorial OR guide`;\n\t\treturn this.search(technicalQuery, options);\n\t}\n\n\t/**\n\t * Build URL params for API request\n\t */\n\tprivate buildParams(query: string, options: SearchOptions): URLSearchParams {\n\t\tconst params = new URLSearchParams({\n\t\t\tkey: this.apiKey!,\n\t\t\tcx: this.searchEngineId!,\n\t\t\tq: query,\n\t\t});\n\n\t\tif (options.num) params.set(\"num\", String(Math.min(options.num, 10)));\n\t\tif (options.start) params.set(\"start\", String(options.start));\n\t\tif (options.siteSearch) params.set(\"siteSearch\", options.siteSearch);\n\t\tif (options.siteSearchExclude) {\n\t\t\tparams.set(\"siteSearch\", options.siteSearchExclude);\n\t\t\tparams.set(\"siteSearchFilter\", \"e\");\n\t\t}\n\t\tif (options.dateRestrict) params.set(\"dateRestrict\", options.dateRestrict);\n\t\tif (options.safe) params.set(\"safe\", options.safe);\n\t\tif (options.filter) params.set(\"filter\", options.filter);\n\t\tif (options.gl) params.set(\"gl\", options.gl);\n\t\tif (options.lr) params.set(\"lr\", options.lr);\n\t\tif (options.sort === \"date\") params.set(\"sort\", \"date\");\n\n\t\treturn params;\n\t}\n\n\t/**\n\t * Parse API response into our schema\n\t */\n\tprivate parseResponse(\n\t\tdata: Record<string, unknown>,\n\t\tquery: string,\n\t\tsearchType: \"web\" | \"news\" | \"image\"\n\t): SearchResponse {\n\t\tconst items = (data.items as Array<Record<string, unknown>>) || [];\n\t\tconst searchInfo = data.searchInformation as { totalResults?: string; searchTime?: number } | undefined;\n\n\t\treturn {\n\t\t\tresults: items.map((item) => ({\n\t\t\t\ttitle: (item.title as string) || \"\",\n\t\t\t\tlink: (item.link as string) || \"\",\n\t\t\t\tsnippet: (item.snippet as string) || \"\",\n\t\t\t\tdisplayLink: (item.displayLink as string) || \"\",\n\t\t\t\tformattedUrl: item.formattedUrl as string | undefined,\n\t\t\t\tpagemap: item.pagemap as SearchResult[\"pagemap\"],\n\t\t\t})),\n\t\t\ttotalResults: Number.parseInt(searchInfo?.totalResults || \"0\", 10),\n\t\t\tsearchTime: searchInfo?.searchTime || 0,\n\t\t\tquery,\n\t\t\tsearchType,\n\t\t\tnextPageToken: data.queries\n\t\t\t\t? ((data.queries as Record<string, Array<{ startIndex: number }>>).nextPage?.[0]?.startIndex?.toString())\n\t\t\t\t: undefined,\n\t\t};\n\t}\n\n\t/**\n\t * Parse image search response\n\t */\n\tprivate parseImageResponse(data: Record<string, unknown>, query: string): SearchResponse {\n\t\tconst items = (data.items as Array<Record<string, unknown>>) || [];\n\t\tconst searchInfo = data.searchInformation as { totalResults?: string; searchTime?: number } | undefined;\n\n\t\treturn {\n\t\t\tresults: items.map((item) => ({\n\t\t\t\ttitle: (item.title as string) || \"\",\n\t\t\t\tlink: (item.link as string) || \"\",\n\t\t\t\tsnippet: (item.snippet as string) || \"\",\n\t\t\t\tdisplayLink: (item.displayLink as string) || \"\",\n\t\t\t\tformattedUrl: (item.image as { contextLink?: string })?.contextLink,\n\t\t\t\tpagemap: {\n\t\t\t\t\tcse_thumbnail: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tsrc: (item.image as { thumbnailLink?: string })?.thumbnailLink || (item.link as string),\n\t\t\t\t\t\t\twidth: String((item.image as { thumbnailWidth?: number })?.thumbnailWidth || \"\"),\n\t\t\t\t\t\t\theight: String((item.image as { thumbnailHeight?: number })?.thumbnailHeight || \"\"),\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t})),\n\t\t\ttotalResults: Number.parseInt(searchInfo?.totalResults || \"0\", 10),\n\t\t\tsearchTime: searchInfo?.searchTime || 0,\n\t\t\tquery,\n\t\t\tsearchType: \"image\",\n\t\t};\n\t}\n\n\t/**\n\t * Generate cache key\n\t */\n\tprivate getCacheKey(query: string, options: SearchOptions, type: string): string {\n\t\treturn `search:${type}:${query}:${JSON.stringify(options)}`;\n\t}\n\n\t/**\n\t * Check if service is configured\n\t */\n\tisConfigured(): boolean {\n\t\treturn !!this.apiKey && !!this.searchEngineId;\n\t}\n\n\t/**\n\t * Get configuration status details\n\t */\n\tgetConfigStatus(): { configured: boolean; hasApiKey: boolean; hasSearchEngineId: boolean } {\n\t\treturn {\n\t\t\tconfigured: this.isConfigured(),\n\t\t\thasApiKey: !!this.apiKey,\n\t\t\thasSearchEngineId: !!this.searchEngineId,\n\t\t};\n\t}\n\n\t/**\n\t * Clear the cache\n\t */\n\tclearCache(): void {\n\t\tthis.cache.clear();\n\t}\n}\n\nexport const googleCustomSearchService = new GoogleCustomSearchService();\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;;;;CAkBC;;;;AAED;;AAEA,MAAM,aAAa;AAEnB,8BAA8B;AAC9B,MAAM,qBAAqB,mOAAC,CAAC,MAAM,CAAC;IACnC,OAAO,mOAAC,CAAC,MAAM;IACf,MAAM,mOAAC,CAAC,MAAM,GAAG,GAAG;IACpB,SAAS,mOAAC,CAAC,MAAM;IACjB,aAAa,mOAAC,CAAC,MAAM;IACrB,cAAc,mOAAC,CAAC,MAAM,GAAG,QAAQ;IACjC,SAAS,mOAAC,CACR,MAAM,CAAC;QACP,eAAe,mOAAC,CACd,KAAK,CACL,mOAAC,CAAC,MAAM,CAAC;YACR,KAAK,mOAAC,CAAC,MAAM;YACb,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ;YAC1B,QAAQ,mOAAC,CAAC,MAAM,GAAG,QAAQ;QAC5B,IAEA,QAAQ;QACV,UAAU,mOAAC,CACT,KAAK,CACL,mOAAC,CAAC,MAAM,CAAC,mOAAC,CAAC,MAAM,KAEjB,QAAQ;IACX,GACC,QAAQ;AACX;AAEA,MAAM,uBAAuB,mOAAC,CAAC,MAAM,CAAC;IACrC,SAAS,mOAAC,CAAC,KAAK,CAAC;IACjB,cAAc,mOAAC,CAAC,MAAM;IACtB,YAAY,mOAAC,CAAC,MAAM;IACpB,OAAO,mOAAC,CAAC,MAAM;IACf,YAAY,mOAAC,CAAC,IAAI,CAAC;QAAC;QAAO;QAAQ;KAAQ;IAC3C,eAAe,mOAAC,CAAC,MAAM,GAAG,QAAQ;AACnC;AA+BA,MAAM,eAAe,OAAO,KAAK,IAAI,aAAa;AAElD,gFAAgF;AAChF,MAAM;IACY,OAA2B;IAC3B,eAAmC;IACnC,QAAkE,IAAI,MAAM;IAC5E,WAAW,aAAa;IAEzC,aAAc;QACb,qDAAqD;QACrD,IAAI,CAAC,MAAM,GACV,QAAQ,GAAG,CAAC,cAAc,mFAE1B,QAAQ,GAAG,CAAC,mBAAmB;QAChC,IAAI,CAAC,cAAc,GAClB,QAAQ,GAAG,CAAC,uBAAuB,IACnC,QAAQ,GAAG,CAAC,aAAa,IACzB,QAAQ,GAAG,CAAC,mCAAmC;IACjD;IAEA;;EAEC,GACD,MAAM,OAAO,KAAa,EAAE,UAAyB,CAAC,CAAC,EAAkC;QACxF,IAAI,CAAC,IAAI,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,cAAc,EAAE;YACzC,QAAQ,IAAI,CAAC;YACb,OAAO;QACR;QAEA,MAAM,WAAW,IAAI,CAAC,WAAW,CAAC,OAAO,SAAS;QAClD,MAAM,SAAS,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC;QAE9B,IAAI,UAAU,KAAK,GAAG,KAAK,OAAO,SAAS,GAAG,IAAI,CAAC,QAAQ,EAAE;YAC5D,OAAO,OAAO,IAAI;QACnB;QAEA,IAAI;YACH,MAAM,SAAS,IAAI,CAAC,WAAW,CAAC,OAAO;YACvC,MAAM,MAAM,CAAC,2CAA2C,EAAE,OAAO,QAAQ,IAAI;YAE7E,MAAM,WAAW,MAAM,MAAM,KAAK;gBACjC,SAAS;oBAAE,cAAc;gBAAW;YACrC;YAEA,IAAI,CAAC,SAAS,EAAE,EAAE;gBACjB,MAAM,QAAQ,MAAM,SAAS,IAAI;gBACjC,QAAQ,KAAK,CAAC,+BAA+B;gBAC7C,OAAO;YACR;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,MAAM,iBAAiB,IAAI,CAAC,aAAa,CAAC,MAAM,OAAO;YAEvD,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,UAAU;gBAAE,MAAM;gBAAgB,WAAW,KAAK,GAAG;YAAG;YACvE,OAAO;QACR,EAAE,OAAO,OAAO;YACf,QAAQ,KAAK,CAAC,gCAAgC;YAC9C,OAAO;QACR;IACD;IAEA;;;EAGC,GACD,MAAM,WACL,KAAa,EACb,UAAiD,CAAC,CAAC,EAClB;QACjC,MAAM,EAAE,WAAW,CAAC,EAAE,GAAG,eAAe,GAAG;QAE3C,uCAAuC;QACvC,MAAM,cAA6B;YAClC,GAAG,aAAa;YAChB,cAAc,CAAC,CAAC,EAAE,UAAU;YAC5B,MAAM;QACP;QAEA,MAAM,WAAW,IAAI,CAAC,WAAW,CAAC,OAAO,aAAa;QACtD,MAAM,SAAS,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC;QAE9B,IAAI,UAAU,KAAK,GAAG,KAAK,OAAO,SAAS,GAAG,IAAI,CAAC,QAAQ,EAAE;YAC5D,OAAO,OAAO,IAAI;QACnB;QAEA,MAAM,SAAS,MAAM,IAAI,CAAC,MAAM,CAAC,OAAO;QACxC,IAAI,QAAQ;YACX,OAAO,UAAU,GAAG;YACpB,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,UAAU;gBAAE,MAAM;gBAAQ,WAAW,KAAK,GAAG;YAAG;QAChE;QACA,OAAO;IACR;IAEA;;EAEC,GACD,MAAM,aAAa,KAAa,EAAE,UAAyB,CAAC,CAAC,EAAkC;QAC9F,IAAI,CAAC,IAAI,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,cAAc,EAAE;YACzC,QAAQ,IAAI,CAAC;YACb,OAAO;QACR;QAEA,MAAM,WAAW,IAAI,CAAC,WAAW,CAAC,OAAO,SAAS;QAClD,MAAM,SAAS,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC;QAE9B,IAAI,UAAU,KAAK,GAAG,KAAK,OAAO,SAAS,GAAG,IAAI,CAAC,QAAQ,EAAE;YAC5D,OAAO,OAAO,IAAI;QACnB;QAEA,IAAI;YACH,MAAM,SAAS,IAAI,CAAC,WAAW,CAAC,OAAO;YACvC,OAAO,GAAG,CAAC,cAAc;YAEzB,MAAM,MAAM,CAAC,2CAA2C,EAAE,OAAO,QAAQ,IAAI;YAE7E,MAAM,WAAW,MAAM,MAAM,KAAK;gBACjC,SAAS;oBAAE,cAAc;gBAAW;YACrC;YAEA,IAAI,CAAC,SAAS,EAAE,EAAE;gBACjB,MAAM,QAAQ,MAAM,SAAS,IAAI;gBACjC,QAAQ,KAAK,CAAC,8BAA8B;gBAC5C,OAAO;YACR;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,MAAM,iBAAiB,IAAI,CAAC,kBAAkB,CAAC,MAAM;YAErD,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,UAAU;gBAAE,MAAM;gBAAgB,WAAW,KAAK,GAAG;YAAG;YACvE,OAAO;QACR,EAAE,OAAO,OAAO;YACf,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,OAAO;QACR;IACD;IAEA;;EAEC,GACD,MAAM,WACL,KAAa,EACb,IAAY,EACZ,UAAyB,CAAC,CAAC,EACM;QACjC,OAAO,IAAI,CAAC,MAAM,CAAC,OAAO;YACzB,GAAG,OAAO;YACV,YAAY;QACb;IACD;IAEA;;;EAGC,GACD,MAAM,gBAAgB,KAAa,EAAE,UAAyB,CAAC,CAAC,EAAkC;QACjG,4CAA4C;QAC5C,MAAM,iBAAiB,GAAG,MAAM,mCAAmC,CAAC;QACpE,OAAO,IAAI,CAAC,MAAM,CAAC,gBAAgB;IACpC;IAEA;;EAEC,GACD,AAAQ,YAAY,KAAa,EAAE,OAAsB,EAAmB;QAC3E,MAAM,SAAS,IAAI,gBAAgB;YAClC,KAAK,IAAI,CAAC,MAAM;YAChB,IAAI,IAAI,CAAC,cAAc;YACvB,GAAG;QACJ;QAEA,IAAI,QAAQ,GAAG,EAAE,OAAO,GAAG,CAAC,OAAO,OAAO,KAAK,GAAG,CAAC,QAAQ,GAAG,EAAE;QAChE,IAAI,QAAQ,KAAK,EAAE,OAAO,GAAG,CAAC,SAAS,OAAO,QAAQ,KAAK;QAC3D,IAAI,QAAQ,UAAU,EAAE,OAAO,GAAG,CAAC,cAAc,QAAQ,UAAU;QACnE,IAAI,QAAQ,iBAAiB,EAAE;YAC9B,OAAO,GAAG,CAAC,cAAc,QAAQ,iBAAiB;YAClD,OAAO,GAAG,CAAC,oBAAoB;QAChC;QACA,IAAI,QAAQ,YAAY,EAAE,OAAO,GAAG,CAAC,gBAAgB,QAAQ,YAAY;QACzE,IAAI,QAAQ,IAAI,EAAE,OAAO,GAAG,CAAC,QAAQ,QAAQ,IAAI;QACjD,IAAI,QAAQ,MAAM,EAAE,OAAO,GAAG,CAAC,UAAU,QAAQ,MAAM;QACvD,IAAI,QAAQ,EAAE,EAAE,OAAO,GAAG,CAAC,MAAM,QAAQ,EAAE;QAC3C,IAAI,QAAQ,EAAE,EAAE,OAAO,GAAG,CAAC,MAAM,QAAQ,EAAE;QAC3C,IAAI,QAAQ,IAAI,KAAK,QAAQ,OAAO,GAAG,CAAC,QAAQ;QAEhD,OAAO;IACR;IAEA;;EAEC,GACD,AAAQ,cACP,IAA6B,EAC7B,KAAa,EACb,UAAoC,EACnB;QACjB,MAAM,QAAQ,AAAC,KAAK,KAAK,IAAuC,EAAE;QAClE,MAAM,aAAa,KAAK,iBAAiB;QAEzC,OAAO;YACN,SAAS,MAAM,GAAG,CAAC,CAAC,OAAS,CAAC;oBAC7B,OAAO,AAAC,KAAK,KAAK,IAAe;oBACjC,MAAM,AAAC,KAAK,IAAI,IAAe;oBAC/B,SAAS,AAAC,KAAK,OAAO,IAAe;oBACrC,aAAa,AAAC,KAAK,WAAW,IAAe;oBAC7C,cAAc,KAAK,YAAY;oBAC/B,SAAS,KAAK,OAAO;gBACtB,CAAC;YACD,cAAc,OAAO,QAAQ,CAAC,YAAY,gBAAgB,KAAK;YAC/D,YAAY,YAAY,cAAc;YACtC;YACA;YACA,eAAe,KAAK,OAAO,GACvB,AAAC,KAAK,OAAO,CAAmD,QAAQ,EAAE,CAAC,EAAE,EAAE,YAAY,aAC5F;QACJ;IACD;IAEA;;EAEC,GACD,AAAQ,mBAAmB,IAA6B,EAAE,KAAa,EAAkB;QACxF,MAAM,QAAQ,AAAC,KAAK,KAAK,IAAuC,EAAE;QAClE,MAAM,aAAa,KAAK,iBAAiB;QAEzC,OAAO;YACN,SAAS,MAAM,GAAG,CAAC,CAAC,OAAS,CAAC;oBAC7B,OAAO,AAAC,KAAK,KAAK,IAAe;oBACjC,MAAM,AAAC,KAAK,IAAI,IAAe;oBAC/B,SAAS,AAAC,KAAK,OAAO,IAAe;oBACrC,aAAa,AAAC,KAAK,WAAW,IAAe;oBAC7C,cAAe,KAAK,KAAK,EAA+B;oBACxD,SAAS;wBACR,eAAe;4BACd;gCACC,KAAK,AAAC,KAAK,KAAK,EAAiC,iBAAkB,KAAK,IAAI;gCAC5E,OAAO,OAAO,AAAC,KAAK,KAAK,EAAkC,kBAAkB;gCAC7E,QAAQ,OAAO,AAAC,KAAK,KAAK,EAAmC,mBAAmB;4BACjF;yBACA;oBACF;gBACD,CAAC;YACD,cAAc,OAAO,QAAQ,CAAC,YAAY,gBAAgB,KAAK;YAC/D,YAAY,YAAY,cAAc;YACtC;YACA,YAAY;QACb;IACD;IAEA;;EAEC,GACD,AAAQ,YAAY,KAAa,EAAE,OAAsB,EAAE,IAAY,EAAU;QAChF,OAAO,CAAC,OAAO,EAAE,KAAK,CAAC,EAAE,MAAM,CAAC,EAAE,KAAK,SAAS,CAAC,UAAU;IAC5D;IAEA;;EAEC,GACD,eAAwB;QACvB,OAAO,CAAC,CAAC,IAAI,CAAC,MAAM,IAAI,CAAC,CAAC,IAAI,CAAC,cAAc;IAC9C;IAEA;;EAEC,GACD,kBAA2F;QAC1F,OAAO;YACN,YAAY,IAAI,CAAC,YAAY;YAC7B,WAAW,CAAC,CAAC,IAAI,CAAC,MAAM;YACxB,mBAAmB,CAAC,CAAC,IAAI,CAAC,cAAc;QACzC;IACD;IAEA;;EAEC,GACD,aAAmB;QAClB,IAAI,CAAC,KAAK,CAAC,KAAK;IACjB;AACD;AAEO,MAAM,4BAA4B,IAAI"}},
    {"offset": {"line": 6729, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/ai/agent-tools.ts"],"sourcesContent":["/**\n * AI Agent Tools - Comprehensive tool definitions for the AI Manager\n * Integrates with database, Resend, Telnyx, and financial systems\n */\n\nimport { tool } from \"ai\";\nimport { z } from \"zod\";\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\nimport {\n\tsearchCustomersFullText,\n\tsearchJobsFullText,\n\tsearchAllEntities,\n} from \"@/lib/search/full-text-search\";\nimport { googleCustomSearchService } from \"@/lib/services/google-custom-search-service\";\n\n// Tool categories for permission checking\nexport type ToolCategory = \"communication\" | \"financial\" | \"scheduling\" | \"customer\" | \"reporting\" | \"system\" | \"team\" | \"vendor\" | \"notification\" | \"property\" | \"equipment\";\n\n// ============================================================================\n// UNIVERSAL DATABASE ACCESS TOOLS\n// ============================================================================\n\nexport const listDatabaseTablesTool = tool({\n\tdescription: \"List all available database tables and their purposes. Use this to understand what data is available.\",\n\tparameters: z.object({}),\n\texecute: async () => {\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\ttables: [\n\t\t\t\t{ name: \"customers\", description: \"Customer records with contact info, revenue, and status\" },\n\t\t\t\t{ name: \"team_members\", description: \"Employee/staff records with roles, contact info, and assignments\" },\n\t\t\t\t{ name: \"vendors\", description: \"Supplier/vendor records with contact and payment info\" },\n\t\t\t\t{ name: \"jobs\", description: \"Work orders and service jobs with status, scheduling, and costs\" },\n\t\t\t\t{ name: \"appointments\", description: \"Scheduled appointments and service calls\" },\n\t\t\t\t{ name: \"invoices\", description: \"Customer invoices with line items and payment status\" },\n\t\t\t\t{ name: \"estimates\", description: \"Price estimates/quotes for customers\" },\n\t\t\t\t{ name: \"contracts\", description: \"Service contracts and agreements\" },\n\t\t\t\t{ name: \"payments\", description: \"Payment records and transactions\" },\n\t\t\t\t{ name: \"properties\", description: \"Customer properties/service locations\" },\n\t\t\t\t{ name: \"equipment\", description: \"Equipment and assets at properties\" },\n\t\t\t\t{ name: \"communications\", description: \"Email, SMS, and call history\" },\n\t\t\t\t{ name: \"price_book_items\", description: \"Service and product pricing catalog\" },\n\t\t\t\t{ name: \"materials\", description: \"Materials and parts inventory\" },\n\t\t\t\t{ name: \"purchase_orders\", description: \"Orders placed with vendors\" },\n\t\t\t\t{ name: \"time_entries\", description: \"Time tracking for jobs and employees\" },\n\t\t\t\t{ name: \"expenses\", description: \"Business expenses and costs\" },\n\t\t\t\t{ name: \"service_agreements\", description: \"Recurring service agreements\" },\n\t\t\t\t{ name: \"maintenance_plans\", description: \"Equipment maintenance schedules\" },\n\t\t\t\t{ name: \"notes\", description: \"Notes attached to various records\" },\n\t\t\t\t{ name: \"tags\", description: \"Tags/labels for organizing records\" },\n\t\t\t\t{ name: \"finance_virtual_buckets\", description: \"Financial savings goals and allocations\" },\n\t\t\t\t{ name: \"scheduled_notifications\", description: \"Scheduled reminders and notifications\" },\n\t\t\t],\n\t\t};\n\t},\n});\n\nexport const queryDatabaseTool = tool({\n\tdescription: \"Query any database table to retrieve records. Use this for flexible data access when specific tools don't cover your needs.\",\n\tparameters: z.object({\n\t\ttable: z.string().describe(\"Table name to query (e.g., 'customers', 'jobs', 'invoices')\"),\n\t\tselect: z.string().optional().default(\"*\").describe(\"Columns to select (comma-separated or * for all)\"),\n\t\tfilters: z.array(z.object({\n\t\t\tcolumn: z.string(),\n\t\t\toperator: z.enum([\"eq\", \"neq\", \"gt\", \"gte\", \"lt\", \"lte\", \"like\", \"ilike\", \"in\", \"is\"]),\n\t\t\tvalue: z.union([z.string(), z.number(), z.boolean(), z.null(), z.array(z.string())]),\n\t\t})).optional().describe(\"Filters to apply\"),\n\t\torderBy: z.object({\n\t\t\tcolumn: z.string(),\n\t\t\tascending: z.boolean().default(false),\n\t\t}).optional().describe(\"Sort order\"),\n\t\tlimit: z.number().optional().default(50).describe(\"Max records to return\"),\n\t\toffset: z.number().optional().default(0).describe(\"Records to skip for pagination\"),\n\t}),\n\texecute: async ({ table, select, filters, orderBy, limit, offset }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\t// Security: Only allow access to business tables\n\t\tconst allowedTables = [\n\t\t\t\"customers\", \"team_members\", \"vendors\", \"jobs\", \"appointments\", \"invoices\",\n\t\t\t\"estimates\", \"contracts\", \"payments\", \"properties\", \"equipment\", \"communications\",\n\t\t\t\"price_book_items\", \"materials\", \"purchase_orders\", \"time_entries\", \"expenses\",\n\t\t\t\"service_agreements\", \"maintenance_plans\", \"notes\", \"tags\", \"finance_virtual_buckets\",\n\t\t\t\"scheduled_notifications\", \"job_line_items\", \"invoice_line_items\", \"estimate_line_items\",\n\t\t];\n\n\t\tif (!allowedTables.includes(table)) {\n\t\t\treturn { success: false, error: `Table '${table}' is not accessible. Available: ${allowedTables.join(\", \")}` };\n\t\t}\n\n\t\tlet query = supabase.from(table).select(select);\n\n\t\t// Always filter by company_id for security\n\t\tquery = query.eq(\"company_id\", companyId);\n\n\t\t// Apply filters\n\t\tif (filters) {\n\t\t\tfor (const filter of filters) {\n\t\t\t\tswitch (filter.operator) {\n\t\t\t\t\tcase \"eq\": query = query.eq(filter.column, filter.value); break;\n\t\t\t\t\tcase \"neq\": query = query.neq(filter.column, filter.value); break;\n\t\t\t\t\tcase \"gt\": query = query.gt(filter.column, filter.value); break;\n\t\t\t\t\tcase \"gte\": query = query.gte(filter.column, filter.value); break;\n\t\t\t\t\tcase \"lt\": query = query.lt(filter.column, filter.value); break;\n\t\t\t\t\tcase \"lte\": query = query.lte(filter.column, filter.value); break;\n\t\t\t\t\tcase \"like\": query = query.like(filter.column, filter.value as string); break;\n\t\t\t\t\tcase \"ilike\": query = query.ilike(filter.column, filter.value as string); break;\n\t\t\t\t\tcase \"in\": query = query.in(filter.column, filter.value as string[]); break;\n\t\t\t\t\tcase \"is\": query = query.is(filter.column, filter.value); break;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Apply ordering\n\t\tif (orderBy) {\n\t\t\tquery = query.order(orderBy.column, { ascending: orderBy.ascending });\n\t\t}\n\n\t\t// Apply pagination\n\t\tquery = query.range(offset, offset + limit - 1);\n\n\t\tconst { data, error, count } = await query;\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, data, count: data?.length || 0, table };\n\t},\n});\n\nexport const getRecordByIdTool = tool({\n\tdescription: \"Get a specific record by its ID from any table. Use when you need full details of a known record.\",\n\tparameters: z.object({\n\t\ttable: z.string().describe(\"Table name\"),\n\t\tid: z.string().uuid().describe(\"Record UUID\"),\n\t\tselect: z.string().optional().default(\"*\").describe(\"Columns to select\"),\n\t}),\n\texecute: async ({ table, id, select }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst allowedTables = [\n\t\t\t\"customers\", \"team_members\", \"vendors\", \"jobs\", \"appointments\", \"invoices\",\n\t\t\t\"estimates\", \"contracts\", \"payments\", \"properties\", \"equipment\", \"communications\",\n\t\t\t\"price_book_items\", \"materials\", \"purchase_orders\", \"time_entries\", \"expenses\",\n\t\t\t\"service_agreements\", \"maintenance_plans\", \"notes\", \"finance_virtual_buckets\",\n\t\t];\n\n\t\tif (!allowedTables.includes(table)) {\n\t\t\treturn { success: false, error: `Table '${table}' is not accessible` };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(table)\n\t\t\t.select(select)\n\t\t\t.eq(\"id\", id)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, record: data, table };\n\t},\n});\n\nexport const getRelatedRecordsTool = tool({\n\tdescription: \"Get records related to a specific entity (e.g., all jobs for a customer, all invoices for a job).\",\n\tparameters: z.object({\n\t\tparentTable: z.string().describe(\"Parent table (e.g., 'customers')\"),\n\t\tparentId: z.string().uuid().describe(\"Parent record ID\"),\n\t\tchildTable: z.string().describe(\"Related table to query (e.g., 'jobs')\"),\n\t\tforeignKey: z.string().describe(\"Foreign key column in child table (e.g., 'customer_id')\"),\n\t\tselect: z.string().optional().default(\"*\"),\n\t\tlimit: z.number().optional().default(50),\n\t}),\n\texecute: async ({ parentTable, parentId, childTable, foreignKey, select, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(childTable)\n\t\t\t.select(select)\n\t\t\t.eq(foreignKey, parentId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.limit(limit);\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, data, count: data?.length || 0, parentTable, childTable };\n\t},\n});\n\nexport const getCompanyOverviewTool = tool({\n\tdescription: \"Get a comprehensive overview of the entire company including counts and summaries from all major tables.\",\n\tparameters: z.object({}),\n\texecute: async (_params, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst [\n\t\t\tcustomersResult,\n\t\t\tteamResult,\n\t\t\tvendorsResult,\n\t\t\tjobsResult,\n\t\t\tinvoicesResult,\n\t\t\testimatesResult,\n\t\t\tcontractsResult,\n\t\t\tpropertiesResult,\n\t\t\tequipmentResult,\n\t\t\tappointmentsResult,\n\t\t] = await Promise.all([\n\t\t\tsupabase.from(\"customers\").select(\"id, status\", { count: \"exact\" }).eq(\"company_id\", companyId),\n\t\t\tsupabase.from(\"team_members\").select(\"id, status, role\", { count: \"exact\" }).eq(\"company_id\", companyId),\n\t\t\tsupabase.from(\"vendors\").select(\"id, status\", { count: \"exact\" }).eq(\"company_id\", companyId),\n\t\t\tsupabase.from(\"jobs\").select(\"id, status, total_amount\", { count: \"exact\" }).eq(\"company_id\", companyId),\n\t\t\tsupabase.from(\"invoices\").select(\"id, status, total_amount, balance_amount\", { count: \"exact\" }).eq(\"company_id\", companyId),\n\t\t\tsupabase.from(\"estimates\").select(\"id, status, total_amount\", { count: \"exact\" }).eq(\"company_id\", companyId),\n\t\t\tsupabase.from(\"contracts\").select(\"id, status, total_value\", { count: \"exact\" }).eq(\"company_id\", companyId),\n\t\t\tsupabase.from(\"properties\").select(\"id\", { count: \"exact\" }).eq(\"company_id\", companyId),\n\t\t\tsupabase.from(\"equipment\").select(\"id\", { count: \"exact\" }).eq(\"company_id\", companyId),\n\t\t\tsupabase.from(\"appointments\").select(\"id, status\", { count: \"exact\" }).eq(\"company_id\", companyId),\n\t\t]);\n\n\t\t// Calculate summaries\n\t\tconst activeCustomers = customersResult.data?.filter(c => c.status === \"active\").length || 0;\n\t\tconst activeTeam = teamResult.data?.filter(t => t.status === \"active\").length || 0;\n\t\tconst openJobs = jobsResult.data?.filter(j => [\"pending\", \"scheduled\", \"in_progress\"].includes(j.status)).length || 0;\n\t\tconst completedJobs = jobsResult.data?.filter(j => j.status === \"completed\").length || 0;\n\t\tconst pendingInvoices = invoicesResult.data?.filter(i => [\"sent\", \"viewed\"].includes(i.status)).length || 0;\n\t\tconst overdueBalance = invoicesResult.data?.filter(i => i.balance_amount > 0).reduce((s, i) => s + i.balance_amount, 0) || 0;\n\t\tconst pendingEstimates = estimatesResult.data?.filter(e => [\"sent\", \"viewed\"].includes(e.status)).length || 0;\n\t\tconst activeContracts = contractsResult.data?.filter(c => c.status === \"active\").length || 0;\n\n\t\t// Team role breakdown\n\t\tconst roleBreakdown: Record<string, number> = {};\n\t\tteamResult.data?.forEach(t => {\n\t\t\troleBreakdown[t.role || \"unassigned\"] = (roleBreakdown[t.role || \"unassigned\"] || 0) + 1;\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\toverview: {\n\t\t\t\tcustomers: {\n\t\t\t\t\ttotal: customersResult.count || 0,\n\t\t\t\t\tactive: activeCustomers,\n\t\t\t\t},\n\t\t\t\tteam: {\n\t\t\t\t\ttotal: teamResult.count || 0,\n\t\t\t\t\tactive: activeTeam,\n\t\t\t\t\tbyRole: roleBreakdown,\n\t\t\t\t},\n\t\t\t\tvendors: {\n\t\t\t\t\ttotal: vendorsResult.count || 0,\n\t\t\t\t},\n\t\t\t\tjobs: {\n\t\t\t\t\ttotal: jobsResult.count || 0,\n\t\t\t\t\topen: openJobs,\n\t\t\t\t\tcompleted: completedJobs,\n\t\t\t\t},\n\t\t\t\tinvoices: {\n\t\t\t\t\ttotal: invoicesResult.count || 0,\n\t\t\t\t\tpending: pendingInvoices,\n\t\t\t\t\toutstandingBalance: overdueBalance / 100,\n\t\t\t\t},\n\t\t\t\testimates: {\n\t\t\t\t\ttotal: estimatesResult.count || 0,\n\t\t\t\t\tpending: pendingEstimates,\n\t\t\t\t},\n\t\t\t\tcontracts: {\n\t\t\t\t\ttotal: contractsResult.count || 0,\n\t\t\t\t\tactive: activeContracts,\n\t\t\t\t},\n\t\t\t\tproperties: {\n\t\t\t\t\ttotal: propertiesResult.count || 0,\n\t\t\t\t},\n\t\t\t\tequipment: {\n\t\t\t\t\ttotal: equipmentResult.count || 0,\n\t\t\t\t},\n\t\t\t\tappointments: {\n\t\t\t\t\ttotal: appointmentsResult.count || 0,\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\t},\n});\n\nexport const searchAllEntitesTool = tool({\n\tdescription: \"Search across multiple tables simultaneously using full-text search with relevance ranking. Use for broad searches when you don't know which entity type contains the information.\",\n\tparameters: z.object({\n\t\tquery: z.string().describe(\"Search term - supports multi-word queries and typo tolerance\"),\n\t\tlimit: z.number().optional().default(10).describe(\"Results per table\"),\n\t}),\n\texecute: async ({ query, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\t// Use unified full-text search for better performance and relevance\n\t\tconst searchResults = await searchAllEntities(supabase, companyId, query, { limit });\n\n\t\t// Format results for AI consumption\n\t\tconst results: Record<string, unknown[]> = {};\n\t\tif (searchResults.customers.length > 0) results.customers = searchResults.customers;\n\t\tif (searchResults.jobs.length > 0) results.jobs = searchResults.jobs;\n\t\tif (searchResults.properties.length > 0) results.properties = searchResults.properties;\n\t\tif (searchResults.equipment.length > 0) results.equipment = searchResults.equipment;\n\t\tif (searchResults.priceBookItems.length > 0) results.priceBookItems = searchResults.priceBookItems;\n\n\t\tconst totalResults = Object.values(results).reduce((sum, arr) => sum + arr.length, 0);\n\n\t\treturn { success: true, results, totalResults, query };\n\t},\n});\n\n// ============================================================================\n// CUSTOMER TOOLS\n// ============================================================================\n\nexport const searchCustomersTool = tool({\n\tdescription: \"Search for customers by name, email, phone, or address using full-text search with relevance ranking. Supports multi-word queries and typo tolerance.\",\n\tparameters: z.object({\n\t\tquery: z.string().describe(\"Search query - can be name, email, phone, or address\"),\n\t\tlimit: z.number().optional().default(10).describe(\"Maximum results to return\"),\n\t}),\n\texecute: async ({ query, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\t// Use full-text search for better performance and relevance\n\t\tconst customers = await searchCustomersFullText(supabase, companyId, query, { limit });\n\n\t\treturn { success: true, customers, count: customers.length };\n\t},\n});\n\nexport const getCustomerDetailsTool = tool({\n\tdescription: \"Get detailed information about a specific customer including their jobs, invoices, and communication history\",\n\tparameters: z.object({\n\t\tcustomerId: z.string().uuid().describe(\"The UUID of the customer\"),\n\t}),\n\texecute: async ({ customerId }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst [customerResult, jobsResult, invoicesResult] = await Promise.all([\n\t\t\tsupabase\n\t\t\t\t.from(\"customers\")\n\t\t\t\t.select(\"*\")\n\t\t\t\t.eq(\"id\", customerId)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.single(),\n\t\t\tsupabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\"id, title, status, total_amount, scheduled_start\")\n\t\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t\t.limit(5),\n\t\t\tsupabase\n\t\t\t\t.from(\"invoices\")\n\t\t\t\t.select(\"id, invoice_number, status, total_amount, balance_amount, due_date\")\n\t\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t\t.limit(5),\n\t\t]);\n\n\t\tif (customerResult.error) return { success: false, error: customerResult.error.message };\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcustomer: customerResult.data,\n\t\t\trecentJobs: jobsResult.data || [],\n\t\t\trecentInvoices: invoicesResult.data || [],\n\t\t};\n\t},\n});\n\nexport const createCustomerTool = tool({\n\tdescription: \"Create a new customer in the system. Use this when a new customer contacts the business.\",\n\tparameters: z.object({\n\t\tfirstName: z.string().describe(\"Customer's first name\"),\n\t\tlastName: z.string().describe(\"Customer's last name\"),\n\t\temail: z.string().email().describe(\"Customer's email address\"),\n\t\tphone: z.string().describe(\"Customer's phone number\"),\n\t\taddress: z.string().optional().describe(\"Street address\"),\n\t\tcity: z.string().optional().describe(\"City\"),\n\t\tstate: z.string().optional().describe(\"State\"),\n\t\tzipCode: z.string().optional().describe(\"ZIP code\"),\n\t\tsource: z.string().optional().describe(\"How the customer found us (referral, google, etc.)\"),\n\t}),\n\texecute: async (params, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tfirst_name: params.firstName,\n\t\t\t\tlast_name: params.lastName,\n\t\t\t\tdisplay_name: `${params.firstName} ${params.lastName}`,\n\t\t\t\temail: params.email,\n\t\t\t\tphone: params.phone,\n\t\t\t\taddress: params.address,\n\t\t\t\tcity: params.city,\n\t\t\t\tstate: params.state,\n\t\t\t\tzip_code: params.zipCode,\n\t\t\t\tsource: params.source,\n\t\t\t\tstatus: \"active\",\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, customer: data, message: `Created customer ${data.display_name}` };\n\t},\n});\n\nexport const updateCustomerTool = tool({\n\tdescription: \"Update customer information\",\n\tparameters: z.object({\n\t\tcustomerId: z.string().uuid().describe(\"Customer ID to update\"),\n\t\tupdates: z.object({\n\t\t\tfirstName: z.string().optional(),\n\t\t\tlastName: z.string().optional(),\n\t\t\temail: z.string().email().optional(),\n\t\t\tphone: z.string().optional(),\n\t\t\taddress: z.string().optional(),\n\t\t\tcity: z.string().optional(),\n\t\t\tstate: z.string().optional(),\n\t\t\tzipCode: z.string().optional(),\n\t\t\tnotes: z.string().optional(),\n\t\t}).describe(\"Fields to update\"),\n\t}),\n\texecute: async ({ customerId, updates }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst updateData: Record<string, unknown> = {};\n\t\tif (updates.firstName) updateData.first_name = updates.firstName;\n\t\tif (updates.lastName) updateData.last_name = updates.lastName;\n\t\tif (updates.email) updateData.email = updates.email;\n\t\tif (updates.phone) updateData.phone = updates.phone;\n\t\tif (updates.address) updateData.address = updates.address;\n\t\tif (updates.city) updateData.city = updates.city;\n\t\tif (updates.state) updateData.state = updates.state;\n\t\tif (updates.zipCode) updateData.zip_code = updates.zipCode;\n\t\tif (updates.notes) updateData.notes = updates.notes;\n\n\t\tif (updates.firstName || updates.lastName) {\n\t\t\tupdateData.display_name = `${updates.firstName || \"\"} ${updates.lastName || \"\"}`.trim();\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update(updateData)\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, customer: data };\n\t},\n});\n\n// ============================================================================\n// TEAM MEMBER TOOLS\n// ============================================================================\n\nexport const searchTeamMembersTool = tool({\n\tdescription: \"Search for team members by name, role, or department. Use this to find employees to assign or contact.\",\n\tparameters: z.object({\n\t\tquery: z.string().optional().describe(\"Search query - name or email\"),\n\t\trole: z.string().optional().describe(\"Filter by role (technician, admin, manager, etc.)\"),\n\t\tlimit: z.number().optional().default(20),\n\t}),\n\texecute: async ({ query, role, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tlet queryBuilder = supabase\n\t\t\t.from(\"team_members\")\n\t\t\t.select(\"id, first_name, last_name, email, phone, role, department, status, hire_date, avatar_url\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"active\");\n\n\t\tif (query) {\n\t\t\tqueryBuilder = queryBuilder.or(`first_name.ilike.%${query}%,last_name.ilike.%${query}%,email.ilike.%${query}%`);\n\t\t}\n\t\tif (role) queryBuilder = queryBuilder.eq(\"role\", role);\n\n\t\tconst { data, error } = await queryBuilder.limit(limit);\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, teamMembers: data, count: data?.length || 0 };\n\t},\n});\n\nexport const getTeamMemberDetailsTool = tool({\n\tdescription: \"Get detailed information about a team member including their schedule and performance\",\n\tparameters: z.object({\n\t\tteamMemberId: z.string().uuid().describe(\"The team member's ID\"),\n\t}),\n\texecute: async ({ teamMemberId }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst [memberResult, jobsResult] = await Promise.all([\n\t\t\tsupabase\n\t\t\t\t.from(\"team_members\")\n\t\t\t\t.select(\"*\")\n\t\t\t\t.eq(\"id\", teamMemberId)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.single(),\n\t\t\tsupabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\"id, title, status, scheduled_start, total_amount\")\n\t\t\t\t.eq(\"assigned_to\", teamMemberId)\n\t\t\t\t.order(\"scheduled_start\", { ascending: false })\n\t\t\t\t.limit(10),\n\t\t]);\n\n\t\tif (memberResult.error) return { success: false, error: memberResult.error.message };\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tteamMember: memberResult.data,\n\t\t\trecentJobs: jobsResult.data || [],\n\t\t};\n\t},\n});\n\nexport const sendTeamEmailTool = tool({\n\tdescription: \"Send an email to a team member for internal communication, assignments, or updates.\",\n\tparameters: z.object({\n\t\tteamMemberId: z.string().uuid().describe(\"Team member ID to send email to\"),\n\t\tsubject: z.string().describe(\"Email subject\"),\n\t\tbody: z.string().describe(\"Email body (HTML supported)\"),\n\t}),\n\texecute: async ({ teamMemberId, subject, body }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\t// Get team member email\n\t\tconst { data: member } = await supabase\n\t\t\t.from(\"team_members\")\n\t\t\t.select(\"email, first_name, last_name\")\n\t\t\t.eq(\"id\", teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!member?.email) return { success: false, error: \"Team member email not found\" };\n\n\t\tconst { resend } = await import(\"@/lib/email/resend-client\");\n\t\tif (!resend) return { success: false, error: \"Email service not configured\" };\n\n\t\tconst { data, error } = await resend.emails.send({\n\t\t\tfrom: process.env.RESEND_FROM_EMAIL || \"noreply@thorbis.com\",\n\t\t\tto: member.email,\n\t\t\tsubject,\n\t\t\thtml: body,\n\t\t});\n\n\t\tif (error) return { success: false, error: error.message };\n\n\t\treturn { success: true, messageId: data?.id, message: `Email sent to ${member.first_name} ${member.last_name}` };\n\t},\n});\n\nexport const sendTeamSmsTool = tool({\n\tdescription: \"Send an SMS to a team member for urgent updates or assignments.\",\n\tparameters: z.object({\n\t\tteamMemberId: z.string().uuid().describe(\"Team member ID\"),\n\t\tmessage: z.string().max(160).describe(\"SMS message (max 160 chars)\"),\n\t}),\n\texecute: async ({ teamMemberId, message }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst { data: member } = await supabase\n\t\t\t.from(\"team_members\")\n\t\t\t.select(\"phone, first_name, last_name\")\n\t\t\t.eq(\"id\", teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!member?.phone) return { success: false, error: \"Team member phone not found\" };\n\n\t\tconst { data: phoneNumber } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"phone_number\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"is_primary\", true)\n\t\t\t.single();\n\n\t\tif (!phoneNumber) return { success: false, error: \"No company phone configured\" };\n\n\t\tconst { sendSMS } = await import(\"@/lib/telnyx/messaging\");\n\t\tconst result = await sendSMS({\n\t\t\tfrom: phoneNumber.phone_number,\n\t\t\tto: member.phone,\n\t\t\ttext: message,\n\t\t});\n\n\t\tif (!result.success) return { success: false, error: result.error };\n\n\t\treturn { success: true, messageId: result.messageId, message: `SMS sent to ${member.first_name} ${member.last_name}` };\n\t},\n});\n\n// ============================================================================\n// VENDOR TOOLS\n// ============================================================================\n\nexport const searchVendorsTool = tool({\n\tdescription: \"Search for vendors/suppliers by name, category, or status\",\n\tparameters: z.object({\n\t\tquery: z.string().optional().describe(\"Search query - name or contact\"),\n\t\tcategory: z.string().optional().describe(\"Vendor category (supplies, equipment, parts, etc.)\"),\n\t\tlimit: z.number().optional().default(20),\n\t}),\n\texecute: async ({ query, category, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tlet queryBuilder = supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.select(\"id, name, contact_name, email, phone, category, status, account_number, payment_terms\")\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (query) queryBuilder = queryBuilder.or(`name.ilike.%${query}%,contact_name.ilike.%${query}%`);\n\t\tif (category) queryBuilder = queryBuilder.eq(\"category\", category);\n\n\t\tconst { data, error } = await queryBuilder.limit(limit);\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, vendors: data, count: data?.length || 0 };\n\t},\n});\n\nexport const getVendorDetailsTool = tool({\n\tdescription: \"Get detailed information about a vendor including purchase history\",\n\tparameters: z.object({\n\t\tvendorId: z.string().uuid().describe(\"Vendor ID\"),\n\t}),\n\texecute: async ({ vendorId }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst [vendorResult, purchasesResult] = await Promise.all([\n\t\t\tsupabase\n\t\t\t\t.from(\"vendors\")\n\t\t\t\t.select(\"*\")\n\t\t\t\t.eq(\"id\", vendorId)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.single(),\n\t\t\tsupabase\n\t\t\t\t.from(\"purchase_orders\")\n\t\t\t\t.select(\"id, po_number, status, total_amount, order_date\")\n\t\t\t\t.eq(\"vendor_id\", vendorId)\n\t\t\t\t.order(\"order_date\", { ascending: false })\n\t\t\t\t.limit(10),\n\t\t]);\n\n\t\tif (vendorResult.error) return { success: false, error: vendorResult.error.message };\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tvendor: vendorResult.data,\n\t\t\trecentPurchases: purchasesResult.data || [],\n\t\t};\n\t},\n});\n\nexport const sendVendorEmailTool = tool({\n\tdescription: \"Send an email to a vendor for orders, inquiries, or communication.\",\n\tparameters: z.object({\n\t\tvendorId: z.string().uuid().describe(\"Vendor ID\"),\n\t\tsubject: z.string().describe(\"Email subject\"),\n\t\tbody: z.string().describe(\"Email body\"),\n\t}),\n\texecute: async ({ vendorId, subject, body }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst { data: vendor } = await supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.select(\"email, name, contact_name\")\n\t\t\t.eq(\"id\", vendorId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!vendor?.email) return { success: false, error: \"Vendor email not found\" };\n\n\t\tconst { resend } = await import(\"@/lib/email/resend-client\");\n\t\tif (!resend) return { success: false, error: \"Email service not configured\" };\n\n\t\tconst { data, error } = await resend.emails.send({\n\t\t\tfrom: process.env.RESEND_FROM_EMAIL || \"noreply@thorbis.com\",\n\t\t\tto: vendor.email,\n\t\t\tsubject,\n\t\t\thtml: body,\n\t\t});\n\n\t\tif (error) return { success: false, error: error.message };\n\n\t\treturn { success: true, messageId: data?.id, message: `Email sent to ${vendor.name}` };\n\t},\n});\n\nexport const sendVendorSmsTool = tool({\n\tdescription: \"Send an SMS to a vendor contact for urgent communication.\",\n\tparameters: z.object({\n\t\tvendorId: z.string().uuid().describe(\"Vendor ID\"),\n\t\tmessage: z.string().max(160).describe(\"SMS message\"),\n\t}),\n\texecute: async ({ vendorId, message }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst { data: vendor } = await supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.select(\"phone, name\")\n\t\t\t.eq(\"id\", vendorId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!vendor?.phone) return { success: false, error: \"Vendor phone not found\" };\n\n\t\tconst { data: phoneNumber } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"phone_number\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"is_primary\", true)\n\t\t\t.single();\n\n\t\tif (!phoneNumber) return { success: false, error: \"No company phone configured\" };\n\n\t\tconst { sendSMS } = await import(\"@/lib/telnyx/messaging\");\n\t\tconst result = await sendSMS({\n\t\t\tfrom: phoneNumber.phone_number,\n\t\t\tto: vendor.phone,\n\t\t\ttext: message,\n\t\t});\n\n\t\tif (!result.success) return { success: false, error: result.error };\n\n\t\treturn { success: true, messageId: result.messageId, message: `SMS sent to ${vendor.name}` };\n\t},\n});\n\n// ============================================================================\n// PROPERTY & EQUIPMENT TOOLS\n// ============================================================================\n\nexport const searchPropertiesTool = tool({\n\tdescription: \"Search for service properties by address, customer, or type\",\n\tparameters: z.object({\n\t\tquery: z.string().optional().describe(\"Address or property name search\"),\n\t\tcustomerId: z.string().uuid().optional().describe(\"Filter by customer\"),\n\t\tpropertyType: z.string().optional().describe(\"Property type (residential, commercial, etc.)\"),\n\t\tlimit: z.number().optional().default(20),\n\t}),\n\texecute: async ({ query, customerId, propertyType, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tlet queryBuilder = supabase\n\t\t\t.from(\"properties\")\n\t\t\t.select(\"id, name, address, city, state, zip_code, property_type, customer:customers(display_name)\")\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (query) queryBuilder = queryBuilder.or(`address.ilike.%${query}%,name.ilike.%${query}%`);\n\t\tif (customerId) queryBuilder = queryBuilder.eq(\"customer_id\", customerId);\n\t\tif (propertyType) queryBuilder = queryBuilder.eq(\"property_type\", propertyType);\n\n\t\tconst { data, error } = await queryBuilder.limit(limit);\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, properties: data, count: data?.length || 0 };\n\t},\n});\n\nexport const getPropertyDetailsTool = tool({\n\tdescription: \"Get detailed property information including equipment and service history\",\n\tparameters: z.object({\n\t\tpropertyId: z.string().uuid().describe(\"Property ID\"),\n\t}),\n\texecute: async ({ propertyId }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst [propertyResult, equipmentResult, jobsResult] = await Promise.all([\n\t\t\tsupabase\n\t\t\t\t.from(\"properties\")\n\t\t\t\t.select(\"*, customer:customers(display_name, phone, email)\")\n\t\t\t\t.eq(\"id\", propertyId)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.single(),\n\t\t\tsupabase\n\t\t\t\t.from(\"equipment\")\n\t\t\t\t.select(\"id, name, model, serial_number, install_date, warranty_expiry, last_service_date\")\n\t\t\t\t.eq(\"property_id\", propertyId)\n\t\t\t\t.limit(20),\n\t\t\tsupabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\"id, title, status, scheduled_start, completed_at\")\n\t\t\t\t.eq(\"property_id\", propertyId)\n\t\t\t\t.order(\"scheduled_start\", { ascending: false })\n\t\t\t\t.limit(10),\n\t\t]);\n\n\t\tif (propertyResult.error) return { success: false, error: propertyResult.error.message };\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tproperty: propertyResult.data,\n\t\t\tequipment: equipmentResult.data || [],\n\t\t\tserviceHistory: jobsResult.data || [],\n\t\t};\n\t},\n});\n\nexport const searchEquipmentTool = tool({\n\tdescription: \"Search for equipment/assets by type, customer, or model\",\n\tparameters: z.object({\n\t\tquery: z.string().optional().describe(\"Equipment name, model, or serial number\"),\n\t\tcustomerId: z.string().uuid().optional(),\n\t\tequipmentType: z.string().optional().describe(\"Equipment type (HVAC, plumbing, electrical, etc.)\"),\n\t\tlimit: z.number().optional().default(20),\n\t}),\n\texecute: async ({ query, customerId, equipmentType, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tlet queryBuilder = supabase\n\t\t\t.from(\"equipment\")\n\t\t\t.select(\"id, name, model, serial_number, equipment_type, install_date, warranty_expiry, last_service_date, property:properties(address, customer:customers(display_name))\")\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (query) queryBuilder = queryBuilder.or(`name.ilike.%${query}%,model.ilike.%${query}%,serial_number.ilike.%${query}%`);\n\t\tif (equipmentType) queryBuilder = queryBuilder.eq(\"equipment_type\", equipmentType);\n\n\t\tconst { data, error } = await queryBuilder.limit(limit);\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, equipment: data, count: data?.length || 0 };\n\t},\n});\n\nexport const getMaintenanceDueTool = tool({\n\tdescription: \"Get equipment that is due or overdue for maintenance service\",\n\tparameters: z.object({\n\t\tdaysAhead: z.number().optional().default(30).describe(\"Look ahead days for upcoming maintenance\"),\n\t}),\n\texecute: async ({ daysAhead }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tconst futureDate = new Date(Date.now() + daysAhead * 24 * 60 * 60 * 1000);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"equipment\")\n\t\t\t.select(\"id, name, model, last_service_date, next_service_date, property:properties(address, customer:customers(display_name, phone, email))\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.lte(\"next_service_date\", futureDate.toISOString())\n\t\t\t.order(\"next_service_date\", { ascending: true })\n\t\t\t.limit(50);\n\n\t\tif (error) return { success: false, error: error.message };\n\n\t\tconst overdue = data?.filter((e) => new Date(e.next_service_date) < new Date()) || [];\n\t\tconst upcoming = data?.filter((e) => new Date(e.next_service_date) >= new Date()) || [];\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\toverdue,\n\t\t\tupcoming,\n\t\t\toverdueCount: overdue.length,\n\t\t\tupcomingCount: upcoming.length,\n\t\t};\n\t},\n});\n\n// ============================================================================\n// JOB/SCHEDULING TOOLS\n// ============================================================================\n\nexport const searchJobsTool = tool({\n\tdescription: \"Search for jobs by title, job number, description, or status using full-text search with relevance ranking. Supports multi-word queries and typo tolerance.\",\n\tparameters: z.object({\n\t\tquery: z.string().optional().describe(\"Search query - searches job number, title, description\"),\n\t\tstatus: z.enum([\"pending\", \"scheduled\", \"in_progress\", \"completed\", \"cancelled\"]).optional(),\n\t\tcustomerId: z.string().uuid().optional(),\n\t\tlimit: z.number().optional().default(10),\n\t}),\n\texecute: async ({ query, status, customerId, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\t// Use full-text search if there's a query\n\t\tif (query && !status && !customerId) {\n\t\t\tconst jobs = await searchJobsFullText(supabase, companyId, query, { limit });\n\t\t\treturn { success: true, jobs, count: jobs.length };\n\t\t}\n\n\t\t// Fall back to filtered query when status/customerId filters are used\n\t\tlet queryBuilder = supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id, job_number, title, status, total_amount, scheduled_start, scheduled_end, customer:customers(display_name, phone)\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null);\n\n\t\tif (query) queryBuilder = queryBuilder.or(`title.ilike.%${query}%,job_number.ilike.%${query}%`);\n\t\tif (status) queryBuilder = queryBuilder.eq(\"status\", status);\n\t\tif (customerId) queryBuilder = queryBuilder.eq(\"customer_id\", customerId);\n\n\t\tconst { data, error } = await queryBuilder.order(\"scheduled_start\", { ascending: false }).limit(limit);\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, jobs: data, count: data?.length || 0 };\n\t},\n});\n\nexport const createAppointmentTool = tool({\n\tdescription: \"Schedule a new appointment for a customer. Use this to book service calls or consultations.\",\n\tparameters: z.object({\n\t\tcustomerId: z.string().uuid().describe(\"Customer to schedule for\"),\n\t\tpropertyId: z.string().uuid().describe(\"Property where service will be performed\"),\n\t\ttitle: z.string().describe(\"Appointment title/description\"),\n\t\tstartTime: z.string().describe(\"Start time in ISO format (YYYY-MM-DDTHH:mm:ss)\"),\n\t\tduration: z.number().describe(\"Duration in minutes\"),\n\t\ttype: z.enum([\"service\", \"consultation\", \"estimate\", \"follow_up\"]).default(\"service\"),\n\t\tnotes: z.string().optional().describe(\"Additional notes for the technician\"),\n\t}),\n\texecute: async (params, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tconst startDate = new Date(params.startTime);\n\t\tconst endDate = new Date(startDate.getTime() + params.duration * 60000);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tproperty_id: params.propertyId,\n\t\t\t\ttitle: params.title,\n\t\t\t\tstart_time: startDate.toISOString(),\n\t\t\t\tend_time: endDate.toISOString(),\n\t\t\t\tduration: params.duration,\n\t\t\t\ttype: params.type,\n\t\t\t\tnotes: params.notes,\n\t\t\t\tstatus: \"scheduled\",\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, appointment: data, message: `Scheduled appointment for ${startDate.toLocaleString()}` };\n\t},\n});\n\nexport const getAvailableSlotsTool = tool({\n\tdescription: \"Find available appointment slots for scheduling. Returns available time windows.\",\n\tparameters: z.object({\n\t\tdate: z.string().describe(\"Date to check (YYYY-MM-DD)\"),\n\t\tduration: z.number().default(60).describe(\"Required duration in minutes\"),\n\t}),\n\texecute: async ({ date, duration }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tconst targetDate = new Date(date);\n\t\tconst dayStart = new Date(targetDate.setHours(8, 0, 0, 0));\n\t\tconst dayEnd = new Date(targetDate.setHours(18, 0, 0, 0));\n\n\t\t// Get existing appointments for that day\n\t\tconst { data: appointments } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.select(\"start_time, end_time\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"start_time\", dayStart.toISOString())\n\t\t\t.lte(\"start_time\", dayEnd.toISOString())\n\t\t\t.neq(\"status\", \"cancelled\");\n\n\t\t// Calculate available slots (simplified)\n\t\tconst availableSlots = [];\n\t\tlet currentTime = dayStart;\n\n\t\twhile (currentTime < dayEnd) {\n\t\t\tconst slotEnd = new Date(currentTime.getTime() + duration * 60000);\n\t\t\tconst hasConflict = appointments?.some((apt) => {\n\t\t\t\tconst aptStart = new Date(apt.start_time);\n\t\t\t\tconst aptEnd = new Date(apt.end_time);\n\t\t\t\treturn currentTime < aptEnd && slotEnd > aptStart;\n\t\t\t});\n\n\t\t\tif (!hasConflict && slotEnd <= dayEnd) {\n\t\t\t\tavailableSlots.push({\n\t\t\t\t\tstart: currentTime.toISOString(),\n\t\t\t\t\tend: slotEnd.toISOString(),\n\t\t\t\t});\n\t\t\t}\n\t\t\tcurrentTime = new Date(currentTime.getTime() + 30 * 60000); // 30-minute increments\n\t\t}\n\n\t\treturn { success: true, availableSlots, date };\n\t},\n});\n\n// ============================================================================\n// INVOICE/FINANCIAL TOOLS\n// ============================================================================\n\nexport const searchInvoicesTool = tool({\n\tdescription: \"Search for invoices by number, customer, or status\",\n\tparameters: z.object({\n\t\tquery: z.string().optional(),\n\t\tstatus: z.enum([\"draft\", \"sent\", \"viewed\", \"paid\", \"overdue\", \"cancelled\"]).optional(),\n\t\tcustomerId: z.string().uuid().optional(),\n\t\tlimit: z.number().optional().default(10),\n\t}),\n\texecute: async ({ query, status, customerId, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tlet queryBuilder = supabase\n\t\t\t.from(\"invoices\")\n\t\t\t.select(\"id, invoice_number, title, status, total_amount, balance_amount, due_date, customer:customers(display_name)\")\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (query) queryBuilder = queryBuilder.ilike(\"invoice_number\", `%${query}%`);\n\t\tif (status) queryBuilder = queryBuilder.eq(\"status\", status);\n\t\tif (customerId) queryBuilder = queryBuilder.eq(\"customer_id\", customerId);\n\n\t\tconst { data, error } = await queryBuilder.order(\"created_at\", { ascending: false }).limit(limit);\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, invoices: data, count: data?.length || 0 };\n\t},\n});\n\nexport const createInvoiceTool = tool({\n\tdescription: \"Create a new invoice for a customer\",\n\tparameters: z.object({\n\t\tcustomerId: z.string().uuid().describe(\"Customer to invoice\"),\n\t\ttitle: z.string().describe(\"Invoice title/description\"),\n\t\tlineItems: z.array(z.object({\n\t\t\tdescription: z.string(),\n\t\t\tquantity: z.number(),\n\t\t\tunitPrice: z.number().describe(\"Price in cents\"),\n\t\t})).describe(\"Line items for the invoice\"),\n\t\tdueDate: z.string().optional().describe(\"Due date (YYYY-MM-DD)\"),\n\t\tnotes: z.string().optional(),\n\t}),\n\texecute: async (params, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\t// Calculate totals\n\t\tconst subtotal = params.lineItems.reduce((sum, item) => sum + item.quantity * item.unitPrice, 0);\n\t\tconst taxAmount = Math.round(subtotal * 0.08); // 8% tax example\n\t\tconst totalAmount = subtotal + taxAmount;\n\n\t\t// Generate invoice number\n\t\tconst invoiceNumber = `INV-${Date.now().toString(36).toUpperCase()}`;\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"invoices\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tinvoice_number: invoiceNumber,\n\t\t\t\ttitle: params.title,\n\t\t\t\tline_items: params.lineItems,\n\t\t\t\tsubtotal,\n\t\t\t\ttax_amount: taxAmount,\n\t\t\t\ttotal_amount: totalAmount,\n\t\t\t\tbalance_amount: totalAmount,\n\t\t\t\tdue_date: params.dueDate ? new Date(params.dueDate).toISOString() : null,\n\t\t\t\tnotes: params.notes,\n\t\t\t\tstatus: \"draft\",\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tinvoice: data,\n\t\t\tmessage: `Created invoice ${invoiceNumber} for $${(totalAmount / 100).toFixed(2)}`,\n\t\t};\n\t},\n});\n\nexport const getFinancialSummaryTool = tool({\n\tdescription: \"Get a financial summary including revenue, outstanding balances, and trends. Use this to provide business advice.\",\n\tparameters: z.object({\n\t\tperiod: z.enum([\"today\", \"week\", \"month\", \"quarter\", \"year\"]).default(\"month\"),\n\t}),\n\texecute: async ({ period }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst now = new Date();\n\t\tlet startDate: Date;\n\n\t\tswitch (period) {\n\t\t\tcase \"today\":\n\t\t\t\tstartDate = new Date(now.setHours(0, 0, 0, 0));\n\t\t\t\tbreak;\n\t\t\tcase \"week\":\n\t\t\t\tstartDate = new Date(now.setDate(now.getDate() - 7));\n\t\t\t\tbreak;\n\t\t\tcase \"month\":\n\t\t\t\tstartDate = new Date(now.setMonth(now.getMonth() - 1));\n\t\t\t\tbreak;\n\t\t\tcase \"quarter\":\n\t\t\t\tstartDate = new Date(now.setMonth(now.getMonth() - 3));\n\t\t\t\tbreak;\n\t\t\tcase \"year\":\n\t\t\t\tstartDate = new Date(now.setFullYear(now.getFullYear() - 1));\n\t\t\t\tbreak;\n\t\t}\n\n\t\tconst [invoicesResult, paymentsResult, overdueResult] = await Promise.all([\n\t\t\tsupabase\n\t\t\t\t.from(\"invoices\")\n\t\t\t\t.select(\"total_amount, paid_amount, balance_amount, status\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.gte(\"created_at\", startDate.toISOString()),\n\t\t\tsupabase\n\t\t\t\t.from(\"payments\")\n\t\t\t\t.select(\"amount\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"status\", \"completed\")\n\t\t\t\t.gte(\"created_at\", startDate.toISOString()),\n\t\t\tsupabase\n\t\t\t\t.from(\"invoices\")\n\t\t\t\t.select(\"id, invoice_number, balance_amount, due_date, customer:customers(display_name)\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"status\", \"sent\")\n\t\t\t\t.lt(\"due_date\", new Date().toISOString())\n\t\t\t\t.gt(\"balance_amount\", 0),\n\t\t]);\n\n\t\tconst totalInvoiced = invoicesResult.data?.reduce((sum, inv) => sum + inv.total_amount, 0) || 0;\n\t\tconst totalCollected = paymentsResult.data?.reduce((sum, pay) => sum + pay.amount, 0) || 0;\n\t\tconst totalOutstanding = invoicesResult.data?.reduce((sum, inv) => sum + inv.balance_amount, 0) || 0;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tperiod,\n\t\t\tsummary: {\n\t\t\t\ttotalInvoiced: totalInvoiced / 100,\n\t\t\t\ttotalCollected: totalCollected / 100,\n\t\t\t\ttotalOutstanding: totalOutstanding / 100,\n\t\t\t\tinvoiceCount: invoicesResult.data?.length || 0,\n\t\t\t\tcollectionRate: totalInvoiced > 0 ? ((totalCollected / totalInvoiced) * 100).toFixed(1) : 0,\n\t\t\t},\n\t\t\toverdueInvoices: overdueResult.data || [],\n\t\t};\n\t},\n});\n\nexport const getVirtualBucketsTool = tool({\n\tdescription: \"Get virtual financial buckets for the company. These are savings goals and fund allocations.\",\n\tparameters: z.object({}),\n\texecute: async (_params, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"finance_virtual_buckets\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"is_active\", true);\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, buckets: data };\n\t},\n});\n\nexport const transferToBucketTool = tool({\n\tdescription: \"Transfer funds to a virtual bucket for savings goals. This is for financial planning.\",\n\tparameters: z.object({\n\t\tbucketId: z.string().uuid().describe(\"Target bucket ID\"),\n\t\tamount: z.number().describe(\"Amount to transfer in cents\"),\n\t\tnote: z.string().optional().describe(\"Note for the transfer\"),\n\t}),\n\texecute: async ({ bucketId, amount, note }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\t// Update bucket balance\n\t\tconst { data: bucket, error: fetchError } = await supabase\n\t\t\t.from(\"finance_virtual_buckets\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"id\", bucketId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (fetchError || !bucket) return { success: false, error: \"Bucket not found\" };\n\n\t\tconst newBalance = (bucket.current_balance || 0) + amount;\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"finance_virtual_buckets\")\n\t\t\t.update({\n\t\t\t\tcurrent_balance: newBalance,\n\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t})\n\t\t\t.eq(\"id\", bucketId);\n\n\t\tif (updateError) return { success: false, error: updateError.message };\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: `Transferred $${(amount / 100).toFixed(2)} to ${bucket.name}. New balance: $${(newBalance / 100).toFixed(2)}`,\n\t\t\tbucket: { ...bucket, current_balance: newBalance },\n\t\t};\n\t},\n});\n\n// ============================================================================\n// COMMUNICATION TOOLS\n// ============================================================================\n\nexport const sendEmailTool = tool({\n\tdescription: \"Send an email to a customer. Use this for follow-ups, reminders, or responding to inquiries.\",\n\tparameters: z.object({\n\t\tto: z.string().email().describe(\"Recipient email address\"),\n\t\tsubject: z.string().describe(\"Email subject line\"),\n\t\tbody: z.string().describe(\"Email body content (HTML supported)\"),\n\t\tcustomerId: z.string().uuid().optional().describe(\"Associated customer ID for tracking\"),\n\t}),\n\texecute: async (params, { companyId }: { companyId: string }) => {\n\t\t// Import Resend dynamically to avoid issues\n\t\tconst { resend } = await import(\"@/lib/email/resend-client\");\n\n\t\tif (!resend) {\n\t\t\treturn { success: false, error: \"Email service not configured\" };\n\t\t}\n\n\t\tconst { data, error } = await resend.emails.send({\n\t\t\tfrom: process.env.RESEND_FROM_EMAIL || \"noreply@thorbis.com\",\n\t\t\tto: params.to,\n\t\t\tsubject: params.subject,\n\t\t\thtml: params.body,\n\t\t});\n\n\t\tif (error) return { success: false, error: error.message };\n\n\t\t// Log communication\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tawait supabase.from(\"communications\").insert({\n\t\t\tcompany_id: companyId,\n\t\t\tcustomer_id: params.customerId,\n\t\t\ttype: \"email\",\n\t\t\tdirection: \"outbound\",\n\t\t\tto_address: params.to,\n\t\t\tsubject: params.subject,\n\t\t\tbody: params.body,\n\t\t\tbody_html: params.body,\n\t\t\tstatus: \"sent\",\n\t\t\tsent_at: new Date().toISOString(),\n\t\t\tprovider_message_id: data?.id,\n\t\t});\n\n\t\treturn { success: true, messageId: data?.id, message: `Email sent to ${params.to}` };\n\t},\n});\n\nexport const sendSmsTool = tool({\n\tdescription: \"Send an SMS text message to a customer. Use for appointment reminders or quick updates.\",\n\tparameters: z.object({\n\t\tto: z.string().describe(\"Phone number (format: +1XXXXXXXXXX)\"),\n\t\tmessage: z.string().max(160).describe(\"Message content (max 160 characters)\"),\n\t\tcustomerId: z.string().uuid().optional().describe(\"Associated customer ID\"),\n\t}),\n\texecute: async (params, { companyId }: { companyId: string }) => {\n\t\t// Get company phone number\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tconst { data: phoneNumber } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"phone_number, telnyx_connection_id\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"is_primary\", true)\n\t\t\t.single();\n\n\t\tif (!phoneNumber) {\n\t\t\treturn { success: false, error: \"No phone number configured for company\" };\n\t\t}\n\n\t\t// Send via Telnyx\n\t\tconst { sendSMS } = await import(\"@/lib/telnyx/messaging\");\n\t\tconst result = await sendSMS({\n\t\t\tfrom: phoneNumber.phone_number,\n\t\t\tto: params.to,\n\t\t\ttext: params.message,\n\t\t});\n\n\t\tif (!result.success) return { success: false, error: result.error };\n\n\t\t// Log communication\n\t\tawait supabase.from(\"communications\").insert({\n\t\t\tcompany_id: companyId,\n\t\t\tcustomer_id: params.customerId,\n\t\t\ttype: \"sms\",\n\t\t\tdirection: \"outbound\",\n\t\t\tto_address: params.to,\n\t\t\tbody: params.message,\n\t\t\tstatus: \"sent\",\n\t\t\tsent_at: new Date().toISOString(),\n\t\t\ttelnyx_message_id: result.messageId,\n\t\t});\n\n\t\treturn { success: true, messageId: result.messageId, message: `SMS sent to ${params.to}` };\n\t},\n});\n\nexport const initiateCallTool = tool({\n\tdescription: \"Initiate a phone call to a customer. The call will be connected through the business phone system.\",\n\tparameters: z.object({\n\t\tto: z.string().describe(\"Phone number to call (format: +1XXXXXXXXXX)\"),\n\t\tcustomerId: z.string().uuid().optional().describe(\"Associated customer ID\"),\n\t\treason: z.string().optional().describe(\"Reason for the call (for logging)\"),\n\t}),\n\texecute: async (params, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\t// Get company phone configuration\n\t\tconst { data: phoneNumber } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"phone_number, telnyx_connection_id\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"is_primary\", true)\n\t\t\t.single();\n\n\t\tif (!phoneNumber) {\n\t\t\treturn { success: false, error: \"No phone number configured\" };\n\t\t}\n\n\t\t// Initiate call via Telnyx\n\t\tconst { initiateCall } = await import(\"@/lib/telnyx/calls\");\n\t\tconst result = await initiateCall({\n\t\t\tconnectionId: phoneNumber.telnyx_connection_id,\n\t\t\tfrom: phoneNumber.phone_number,\n\t\t\tto: params.to,\n\t\t});\n\n\t\tif (!result.success) return { success: false, error: result.error };\n\n\t\t// Log communication\n\t\tawait supabase.from(\"communications\").insert({\n\t\t\tcompany_id: companyId,\n\t\t\tcustomer_id: params.customerId,\n\t\t\ttype: \"call\",\n\t\t\tdirection: \"outbound\",\n\t\t\tto_address: params.to,\n\t\t\tfrom_address: phoneNumber.phone_number,\n\t\t\tbody: params.reason || \"Outbound call\",\n\t\t\tstatus: \"pending\",\n\t\t\ttelnyx_call_control_id: result.callControlId,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcallControlId: result.callControlId,\n\t\t\tmessage: `Call initiated to ${params.to}`,\n\t\t};\n\t},\n});\n\nexport const getCommunicationHistoryTool = tool({\n\tdescription: \"Get communication history with a customer (calls, texts, emails)\",\n\tparameters: z.object({\n\t\tcustomerId: z.string().uuid().describe(\"Customer ID to get history for\"),\n\t\ttype: z.enum([\"all\", \"email\", \"sms\", \"call\"]).optional().default(\"all\"),\n\t\tlimit: z.number().optional().default(20),\n\t}),\n\texecute: async ({ customerId, type, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tlet queryBuilder = supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"customer_id\", customerId);\n\n\t\tif (type !== \"all\") queryBuilder = queryBuilder.eq(\"type\", type);\n\n\t\tconst { data, error } = await queryBuilder\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, communications: data };\n\t},\n});\n\n// ============================================================================\n// REPORTING/ANALYTICS TOOLS\n// ============================================================================\n\nexport const getDashboardMetricsTool = tool({\n\tdescription: \"Get key business metrics for the dashboard. Use this to provide business insights and recommendations.\",\n\tparameters: z.object({}),\n\texecute: async (_params, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tconst now = new Date();\n\t\tconst thirtyDaysAgo = new Date(now.setDate(now.getDate() - 30));\n\n\t\tconst [customersResult, jobsResult, invoicesResult] = await Promise.all([\n\t\t\tsupabase\n\t\t\t\t.from(\"customers\")\n\t\t\t\t.select(\"id\", { count: \"exact\", head: true })\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"status\", \"active\"),\n\t\t\tsupabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\"id, status, total_amount\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.gte(\"created_at\", thirtyDaysAgo.toISOString()),\n\t\t\tsupabase\n\t\t\t\t.from(\"invoices\")\n\t\t\t\t.select(\"id, total_amount, balance_amount, status\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.gte(\"created_at\", thirtyDaysAgo.toISOString()),\n\t\t]);\n\n\t\tconst completedJobs = jobsResult.data?.filter((j) => j.status === \"completed\") || [];\n\t\tconst overdueInvoices = invoicesResult.data?.filter((i) => i.status === \"sent\" && i.balance_amount > 0) || [];\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmetrics: {\n\t\t\t\tactiveCustomers: customersResult.count || 0,\n\t\t\t\tjobsLast30Days: jobsResult.data?.length || 0,\n\t\t\t\tcompletedJobsLast30Days: completedJobs.length,\n\t\t\t\tjobCompletionRate: jobsResult.data?.length\n\t\t\t\t\t? ((completedJobs.length / jobsResult.data.length) * 100).toFixed(1)\n\t\t\t\t\t: 0,\n\t\t\t\tinvoicesLast30Days: invoicesResult.data?.length || 0,\n\t\t\t\toverdueInvoiceCount: overdueInvoices.length,\n\t\t\t\ttotalOutstanding: overdueInvoices.reduce((sum, i) => sum + i.balance_amount, 0) / 100,\n\t\t\t},\n\t\t};\n\t},\n});\n\nexport const getProactiveInsightsTool = tool({\n\tdescription: \"Get proactive business insights and recommendations. Use this to help owners make decisions.\",\n\tparameters: z.object({}),\n\texecute: async (_params, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\t// Get various insights\n\t\tconst [overdueResult, inactiveCustomersResult, upcomingAppointmentsResult] = await Promise.all([\n\t\t\t// Overdue invoices\n\t\t\tsupabase\n\t\t\t\t.from(\"invoices\")\n\t\t\t\t.select(\"id, invoice_number, balance_amount, due_date, customer:customers(display_name, phone, email)\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"status\", \"sent\")\n\t\t\t\t.lt(\"due_date\", new Date().toISOString())\n\t\t\t\t.gt(\"balance_amount\", 0)\n\t\t\t\t.limit(5),\n\t\t\t// Customers inactive for 90+ days\n\t\t\tsupabase\n\t\t\t\t.from(\"customers\")\n\t\t\t\t.select(\"id, display_name, phone, email, last_job_date\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"status\", \"active\")\n\t\t\t\t.lt(\"last_job_date\", new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString())\n\t\t\t\t.limit(5),\n\t\t\t// Tomorrow's appointments\n\t\t\tsupabase\n\t\t\t\t.from(\"appointments\")\n\t\t\t\t.select(\"id, title, start_time, customer:customers(display_name, phone)\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"status\", \"scheduled\")\n\t\t\t\t.gte(\"start_time\", new Date().toISOString())\n\t\t\t\t.lt(\"start_time\", new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString())\n\t\t\t\t.limit(10),\n\t\t]);\n\n\t\tconst insights = [];\n\n\t\tif (overdueResult.data && overdueResult.data.length > 0) {\n\t\t\tconst totalOverdue = overdueResult.data.reduce((sum, inv) => sum + inv.balance_amount, 0);\n\t\t\tinsights.push({\n\t\t\t\ttype: \"overdue_invoices\",\n\t\t\t\tseverity: \"high\",\n\t\t\t\ttitle: `${overdueResult.data.length} overdue invoices totaling $${(totalOverdue / 100).toFixed(2)}`,\n\t\t\t\trecommendation: \"Consider sending payment reminders or initiating collection calls\",\n\t\t\t\tdata: overdueResult.data,\n\t\t\t});\n\t\t}\n\n\t\tif (inactiveCustomersResult.data && inactiveCustomersResult.data.length > 0) {\n\t\t\tinsights.push({\n\t\t\t\ttype: \"inactive_customers\",\n\t\t\t\tseverity: \"medium\",\n\t\t\t\ttitle: `${inactiveCustomersResult.data.length} customers haven't had service in 90+ days`,\n\t\t\t\trecommendation: \"Send re-engagement emails or offer maintenance service promotions\",\n\t\t\t\tdata: inactiveCustomersResult.data,\n\t\t\t});\n\t\t}\n\n\t\tif (upcomingAppointmentsResult.data && upcomingAppointmentsResult.data.length > 0) {\n\t\t\tinsights.push({\n\t\t\t\ttype: \"upcoming_appointments\",\n\t\t\t\tseverity: \"info\",\n\t\t\t\ttitle: `${upcomingAppointmentsResult.data.length} appointments scheduled for tomorrow`,\n\t\t\t\trecommendation: \"Consider sending reminder messages to customers\",\n\t\t\t\tdata: upcomingAppointmentsResult.data,\n\t\t\t});\n\t\t}\n\n\t\treturn { success: true, insights };\n\t},\n});\n\n// ============================================================================\n// REMINDER/NOTIFICATION TOOLS\n// ============================================================================\n\nexport const scheduleReminderTool = tool({\n\tdescription: \"Schedule a reminder email or SMS to be sent at a specific time. Use for appointment reminders, payment reminders, or follow-ups.\",\n\tparameters: z.object({\n\t\trecipientType: z.enum([\"customer\", \"team_member\", \"vendor\"]).describe(\"Type of recipient\"),\n\t\trecipientId: z.string().uuid().describe(\"ID of the recipient\"),\n\t\tchannel: z.enum([\"email\", \"sms\", \"both\"]).describe(\"Communication channel\"),\n\t\tsubject: z.string().optional().describe(\"Email subject (for email channel)\"),\n\t\tmessage: z.string().describe(\"Message content\"),\n\t\tsendAt: z.string().describe(\"When to send (ISO format)\"),\n\t\trelatedTo: z.object({\n\t\t\ttype: z.enum([\"job\", \"invoice\", \"appointment\", \"estimate\"]).optional(),\n\t\t\tid: z.string().uuid().optional(),\n\t\t}).optional().describe(\"Related entity\"),\n\t}),\n\texecute: async (params, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\t// Get recipient details based on type\n\t\tlet recipientEmail: string | null = null;\n\t\tlet recipientPhone: string | null = null;\n\t\tlet recipientName = \"\";\n\n\t\tif (params.recipientType === \"customer\") {\n\t\t\tconst { data } = await supabase\n\t\t\t\t.from(\"customers\")\n\t\t\t\t.select(\"email, phone, display_name\")\n\t\t\t\t.eq(\"id\", params.recipientId)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.single();\n\t\t\tif (data) {\n\t\t\t\trecipientEmail = data.email;\n\t\t\t\trecipientPhone = data.phone;\n\t\t\t\trecipientName = data.display_name;\n\t\t\t}\n\t\t} else if (params.recipientType === \"team_member\") {\n\t\t\tconst { data } = await supabase\n\t\t\t\t.from(\"team_members\")\n\t\t\t\t.select(\"email, phone, first_name, last_name\")\n\t\t\t\t.eq(\"id\", params.recipientId)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.single();\n\t\t\tif (data) {\n\t\t\t\trecipientEmail = data.email;\n\t\t\t\trecipientPhone = data.phone;\n\t\t\t\trecipientName = `${data.first_name} ${data.last_name}`;\n\t\t\t}\n\t\t} else if (params.recipientType === \"vendor\") {\n\t\t\tconst { data } = await supabase\n\t\t\t\t.from(\"vendors\")\n\t\t\t\t.select(\"email, phone, name\")\n\t\t\t\t.eq(\"id\", params.recipientId)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.single();\n\t\t\tif (data) {\n\t\t\t\trecipientEmail = data.email;\n\t\t\t\trecipientPhone = data.phone;\n\t\t\t\trecipientName = data.name;\n\t\t\t}\n\t\t}\n\n\t\tif (!recipientEmail && !recipientPhone) {\n\t\t\treturn { success: false, error: \"Recipient contact information not found\" };\n\t\t}\n\n\t\t// Create scheduled notification\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"scheduled_notifications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\trecipient_type: params.recipientType,\n\t\t\t\trecipient_id: params.recipientId,\n\t\t\t\trecipient_name: recipientName,\n\t\t\t\trecipient_email: recipientEmail,\n\t\t\t\trecipient_phone: recipientPhone,\n\t\t\t\tchannel: params.channel,\n\t\t\t\tsubject: params.subject,\n\t\t\t\tmessage: params.message,\n\t\t\t\tscheduled_at: params.sendAt,\n\t\t\t\trelated_type: params.relatedTo?.type,\n\t\t\t\trelated_id: params.relatedTo?.id,\n\t\t\t\tstatus: \"scheduled\",\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) return { success: false, error: error.message };\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\treminder: data,\n\t\t\tmessage: `Reminder scheduled for ${recipientName} at ${new Date(params.sendAt).toLocaleString()}`,\n\t\t};\n\t},\n});\n\nexport const cancelReminderTool = tool({\n\tdescription: \"Cancel a scheduled reminder\",\n\tparameters: z.object({\n\t\treminderId: z.string().uuid().describe(\"ID of the reminder to cancel\"),\n\t}),\n\texecute: async ({ reminderId }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"scheduled_notifications\")\n\t\t\t.update({ status: \"cancelled\" })\n\t\t\t.eq(\"id\", reminderId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, message: \"Reminder cancelled successfully\" };\n\t},\n});\n\nexport const getScheduledRemindersTool = tool({\n\tdescription: \"Get list of scheduled reminders for a customer, job, or entity\",\n\tparameters: z.object({\n\t\trecipientType: z.enum([\"customer\", \"team_member\", \"vendor\"]).optional(),\n\t\trecipientId: z.string().uuid().optional(),\n\t\trelatedType: z.enum([\"job\", \"invoice\", \"appointment\", \"estimate\"]).optional(),\n\t\trelatedId: z.string().uuid().optional(),\n\t\tstatus: z.enum([\"scheduled\", \"sent\", \"cancelled\", \"failed\"]).optional().default(\"scheduled\"),\n\t}),\n\texecute: async (params, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tlet queryBuilder = supabase\n\t\t\t.from(\"scheduled_notifications\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (params.recipientType) queryBuilder = queryBuilder.eq(\"recipient_type\", params.recipientType);\n\t\tif (params.recipientId) queryBuilder = queryBuilder.eq(\"recipient_id\", params.recipientId);\n\t\tif (params.relatedType) queryBuilder = queryBuilder.eq(\"related_type\", params.relatedType);\n\t\tif (params.relatedId) queryBuilder = queryBuilder.eq(\"related_id\", params.relatedId);\n\t\tif (params.status) queryBuilder = queryBuilder.eq(\"status\", params.status);\n\n\t\tconst { data, error } = await queryBuilder.order(\"scheduled_at\", { ascending: true });\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, reminders: data, count: data?.length || 0 };\n\t},\n});\n\nexport const sendImmediateNotificationTool = tool({\n\tdescription: \"Send an immediate notification to a customer, team member, or vendor. Use for urgent updates.\",\n\tparameters: z.object({\n\t\trecipientType: z.enum([\"customer\", \"team_member\", \"vendor\"]).describe(\"Type of recipient\"),\n\t\trecipientId: z.string().uuid().describe(\"ID of the recipient\"),\n\t\tchannel: z.enum([\"email\", \"sms\", \"both\"]).describe(\"Communication channel\"),\n\t\tsubject: z.string().optional().describe(\"Email subject\"),\n\t\tmessage: z.string().describe(\"Message content\"),\n\t\tpriority: z.enum([\"normal\", \"high\", \"urgent\"]).optional().default(\"normal\"),\n\t}),\n\texecute: async (params, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tconst results: { email?: { success: boolean; messageId?: string; error?: string }; sms?: { success: boolean; messageId?: string; error?: string } } = {};\n\n\t\t// Get recipient details\n\t\tlet recipientEmail: string | null = null;\n\t\tlet recipientPhone: string | null = null;\n\t\tlet recipientName = \"\";\n\n\t\tif (params.recipientType === \"customer\") {\n\t\t\tconst { data } = await supabase.from(\"customers\").select(\"email, phone, display_name\").eq(\"id\", params.recipientId).single();\n\t\t\tif (data) { recipientEmail = data.email; recipientPhone = data.phone; recipientName = data.display_name; }\n\t\t} else if (params.recipientType === \"team_member\") {\n\t\t\tconst { data } = await supabase.from(\"team_members\").select(\"email, phone, first_name, last_name\").eq(\"id\", params.recipientId).single();\n\t\t\tif (data) { recipientEmail = data.email; recipientPhone = data.phone; recipientName = `${data.first_name} ${data.last_name}`; }\n\t\t} else if (params.recipientType === \"vendor\") {\n\t\t\tconst { data } = await supabase.from(\"vendors\").select(\"email, phone, name\").eq(\"id\", params.recipientId).single();\n\t\t\tif (data) { recipientEmail = data.email; recipientPhone = data.phone; recipientName = data.name; }\n\t\t}\n\n\t\t// Send email if requested\n\t\tif ((params.channel === \"email\" || params.channel === \"both\") && recipientEmail) {\n\t\t\tconst { resend } = await import(\"@/lib/email/resend-client\");\n\t\t\tif (resend) {\n\t\t\t\tconst { data, error } = await resend.emails.send({\n\t\t\t\t\tfrom: process.env.RESEND_FROM_EMAIL || \"noreply@thorbis.com\",\n\t\t\t\t\tto: recipientEmail,\n\t\t\t\t\tsubject: params.subject || \"Notification\",\n\t\t\t\t\thtml: params.message,\n\t\t\t\t});\n\t\t\t\tresults.email = error ? { success: false, error: error.message } : { success: true, messageId: data?.id };\n\t\t\t}\n\t\t}\n\n\t\t// Send SMS if requested\n\t\tif ((params.channel === \"sms\" || params.channel === \"both\") && recipientPhone) {\n\t\t\tconst { data: phoneNumber } = await supabase.from(\"phone_numbers\").select(\"phone_number\").eq(\"company_id\", companyId).eq(\"is_primary\", true).single();\n\t\t\tif (phoneNumber) {\n\t\t\t\tconst { sendSMS } = await import(\"@/lib/telnyx/messaging\");\n\t\t\t\tconst result = await sendSMS({ from: phoneNumber.phone_number, to: recipientPhone, text: params.message.slice(0, 160) });\n\t\t\t\tresults.sms = result.success ? { success: true, messageId: result.messageId } : { success: false, error: result.error };\n\t\t\t}\n\t\t}\n\n\t\treturn { success: true, results, message: `Notification sent to ${recipientName}` };\n\t},\n});\n\n// ============================================================================\n// ENHANCED REPORTING TOOLS\n// ============================================================================\n\nexport const getJobCostingReportTool = tool({\n\tdescription: \"Get detailed job costing report including labor, materials, and profit margins\",\n\tparameters: z.object({\n\t\tjobId: z.string().uuid().optional().describe(\"Specific job ID, or omit for summary\"),\n\t\tperiod: z.enum([\"week\", \"month\", \"quarter\", \"year\"]).optional().default(\"month\"),\n\t\tlimit: z.number().optional().default(20),\n\t}),\n\texecute: async ({ jobId, period, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tif (jobId) {\n\t\t\t// Single job costing\n\t\t\tconst { data: job, error } = await supabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\"*, customer:customers(display_name), line_items, labor_cost, material_cost, total_amount\")\n\t\t\t\t.eq(\"id\", jobId)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.single();\n\n\t\t\tif (error) return { success: false, error: error.message };\n\n\t\t\tconst laborCost = job?.labor_cost || 0;\n\t\t\tconst materialCost = job?.material_cost || 0;\n\t\t\tconst totalRevenue = job?.total_amount || 0;\n\t\t\tconst profit = totalRevenue - laborCost - materialCost;\n\t\t\tconst margin = totalRevenue > 0 ? (profit / totalRevenue) * 100 : 0;\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tjob: {\n\t\t\t\t\t...job,\n\t\t\t\t\tcosting: {\n\t\t\t\t\t\tlaborCost: laborCost / 100,\n\t\t\t\t\t\tmaterialCost: materialCost / 100,\n\t\t\t\t\t\ttotalCost: (laborCost + materialCost) / 100,\n\t\t\t\t\t\trevenue: totalRevenue / 100,\n\t\t\t\t\t\tprofit: profit / 100,\n\t\t\t\t\t\tmarginPercent: margin.toFixed(1),\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t// Period summary\n\t\tconst now = new Date();\n\t\tlet startDate: Date;\n\t\tswitch (period) {\n\t\t\tcase \"week\": startDate = new Date(now.setDate(now.getDate() - 7)); break;\n\t\t\tcase \"month\": startDate = new Date(now.setMonth(now.getMonth() - 1)); break;\n\t\t\tcase \"quarter\": startDate = new Date(now.setMonth(now.getMonth() - 3)); break;\n\t\t\tcase \"year\": startDate = new Date(now.setFullYear(now.getFullYear() - 1)); break;\n\t\t}\n\n\t\tconst { data: jobs } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id, title, labor_cost, material_cost, total_amount, status, completed_at, customer:customers(display_name)\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"completed\")\n\t\t\t.gte(\"completed_at\", startDate.toISOString())\n\t\t\t.order(\"completed_at\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tconst summary = {\n\t\t\ttotalJobs: jobs?.length || 0,\n\t\t\ttotalRevenue: (jobs?.reduce((s, j) => s + (j.total_amount || 0), 0) || 0) / 100,\n\t\t\ttotalLaborCost: (jobs?.reduce((s, j) => s + (j.labor_cost || 0), 0) || 0) / 100,\n\t\t\ttotalMaterialCost: (jobs?.reduce((s, j) => s + (j.material_cost || 0), 0) || 0) / 100,\n\t\t\ttotalProfit: 0,\n\t\t\taverageMargin: 0,\n\t\t};\n\t\tsummary.totalProfit = summary.totalRevenue - summary.totalLaborCost - summary.totalMaterialCost;\n\t\tsummary.averageMargin = summary.totalRevenue > 0 ? (summary.totalProfit / summary.totalRevenue) * 100 : 0;\n\n\t\treturn { success: true, period, summary, jobs };\n\t},\n});\n\nexport const getRevenueBreakdownTool = tool({\n\tdescription: \"Get revenue breakdown by customer, service type, or time period\",\n\tparameters: z.object({\n\t\tgroupBy: z.enum([\"customer\", \"service_type\", \"month\", \"week\"]).default(\"month\"),\n\t\tperiod: z.enum([\"month\", \"quarter\", \"year\"]).default(\"quarter\"),\n\t\tlimit: z.number().optional().default(20),\n\t}),\n\texecute: async ({ groupBy, period, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst now = new Date();\n\t\tlet startDate: Date;\n\t\tswitch (period) {\n\t\t\tcase \"month\": startDate = new Date(now.setMonth(now.getMonth() - 1)); break;\n\t\t\tcase \"quarter\": startDate = new Date(now.setMonth(now.getMonth() - 3)); break;\n\t\t\tcase \"year\": startDate = new Date(now.setFullYear(now.getFullYear() - 1)); break;\n\t\t}\n\n\t\tconst { data: invoices } = await supabase\n\t\t\t.from(\"invoices\")\n\t\t\t.select(\"id, total_amount, paid_amount, created_at, customer:customers(id, display_name), job:jobs(service_type)\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"paid\")\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\t// Group data\n\t\tconst breakdown: Record<string, { label: string; revenue: number; count: number }> = {};\n\n\t\tinvoices?.forEach((inv) => {\n\t\t\tlet key = \"\";\n\t\t\tlet label = \"\";\n\n\t\t\tif (groupBy === \"customer\") {\n\t\t\t\tkey = inv.customer?.id || \"unknown\";\n\t\t\t\tlabel = inv.customer?.display_name || \"Unknown\";\n\t\t\t} else if (groupBy === \"service_type\") {\n\t\t\t\tkey = inv.job?.service_type || \"general\";\n\t\t\t\tlabel = inv.job?.service_type || \"General\";\n\t\t\t} else if (groupBy === \"month\") {\n\t\t\t\tconst date = new Date(inv.created_at);\n\t\t\t\tkey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, \"0\")}`;\n\t\t\t\tlabel = date.toLocaleDateString(\"en-US\", { year: \"numeric\", month: \"short\" });\n\t\t\t} else if (groupBy === \"week\") {\n\t\t\t\tconst date = new Date(inv.created_at);\n\t\t\t\tconst weekStart = new Date(date.setDate(date.getDate() - date.getDay()));\n\t\t\t\tkey = weekStart.toISOString().split(\"T\")[0];\n\t\t\t\tlabel = `Week of ${weekStart.toLocaleDateString()}`;\n\t\t\t}\n\n\t\t\tif (!breakdown[key]) breakdown[key] = { label, revenue: 0, count: 0 };\n\t\t\tbreakdown[key].revenue += (inv.paid_amount || 0) / 100;\n\t\t\tbreakdown[key].count += 1;\n\t\t});\n\n\t\tconst results = Object.values(breakdown).sort((a, b) => b.revenue - a.revenue).slice(0, limit);\n\t\tconst totalRevenue = results.reduce((s, r) => s + r.revenue, 0);\n\n\t\treturn { success: true, groupBy, period, breakdown: results, totalRevenue };\n\t},\n});\n\nexport const getARAgingReportTool = tool({\n\tdescription: \"Get accounts receivable aging report showing outstanding invoices by age (30/60/90+ days)\",\n\tparameters: z.object({}),\n\texecute: async (_params, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tconst now = new Date();\n\n\t\tconst { data: invoices } = await supabase\n\t\t\t.from(\"invoices\")\n\t\t\t.select(\"id, invoice_number, balance_amount, due_date, created_at, customer:customers(display_name, phone, email)\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.in(\"status\", [\"sent\", \"viewed\"])\n\t\t\t.gt(\"balance_amount\", 0);\n\n\t\tconst aging = {\n\t\t\tcurrent: { amount: 0, count: 0, invoices: [] as typeof invoices },\n\t\t\tdays30: { amount: 0, count: 0, invoices: [] as typeof invoices },\n\t\t\tdays60: { amount: 0, count: 0, invoices: [] as typeof invoices },\n\t\t\tdays90Plus: { amount: 0, count: 0, invoices: [] as typeof invoices },\n\t\t};\n\n\t\tinvoices?.forEach((inv) => {\n\t\t\tconst dueDate = new Date(inv.due_date);\n\t\t\tconst daysOverdue = Math.floor((now.getTime() - dueDate.getTime()) / (1000 * 60 * 60 * 24));\n\n\t\t\tif (daysOverdue <= 0) {\n\t\t\t\taging.current.amount += inv.balance_amount;\n\t\t\t\taging.current.count += 1;\n\t\t\t\taging.current.invoices?.push(inv);\n\t\t\t} else if (daysOverdue <= 30) {\n\t\t\t\taging.days30.amount += inv.balance_amount;\n\t\t\t\taging.days30.count += 1;\n\t\t\t\taging.days30.invoices?.push(inv);\n\t\t\t} else if (daysOverdue <= 60) {\n\t\t\t\taging.days60.amount += inv.balance_amount;\n\t\t\t\taging.days60.count += 1;\n\t\t\t\taging.days60.invoices?.push(inv);\n\t\t\t} else {\n\t\t\t\taging.days90Plus.amount += inv.balance_amount;\n\t\t\t\taging.days90Plus.count += 1;\n\t\t\t\taging.days90Plus.invoices?.push(inv);\n\t\t\t}\n\t\t});\n\n\t\t// Convert to dollars\n\t\tObject.keys(aging).forEach((key) => {\n\t\t\taging[key as keyof typeof aging].amount = aging[key as keyof typeof aging].amount / 100;\n\t\t});\n\n\t\tconst totalOutstanding = aging.current.amount + aging.days30.amount + aging.days60.amount + aging.days90Plus.amount;\n\n\t\treturn { success: true, aging, totalOutstanding, totalInvoices: invoices?.length || 0 };\n\t},\n});\n\nexport const getTeamPerformanceReportTool = tool({\n\tdescription: \"Get team member performance metrics including jobs completed, revenue generated, and ratings\",\n\tparameters: z.object({\n\t\tteamMemberId: z.string().uuid().optional().describe(\"Specific team member, or omit for all\"),\n\t\tperiod: z.enum([\"week\", \"month\", \"quarter\", \"year\"]).default(\"month\"),\n\t}),\n\texecute: async ({ teamMemberId, period }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst now = new Date();\n\t\tlet startDate: Date;\n\t\tswitch (period) {\n\t\t\tcase \"week\": startDate = new Date(now.setDate(now.getDate() - 7)); break;\n\t\t\tcase \"month\": startDate = new Date(now.setMonth(now.getMonth() - 1)); break;\n\t\t\tcase \"quarter\": startDate = new Date(now.setMonth(now.getMonth() - 3)); break;\n\t\t\tcase \"year\": startDate = new Date(now.setFullYear(now.getFullYear() - 1)); break;\n\t\t}\n\n\t\tlet queryBuilder = supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id, assigned_to, status, total_amount, completed_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (teamMemberId) queryBuilder = queryBuilder.eq(\"assigned_to\", teamMemberId);\n\n\t\tconst { data: jobs } = await queryBuilder;\n\t\tconst { data: teamMembers } = await supabase\n\t\t\t.from(\"team_members\")\n\t\t\t.select(\"id, first_name, last_name, role\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"active\");\n\n\t\t// Aggregate by team member\n\t\tconst performance: Record<string, {\n\t\t\tname: string;\n\t\t\trole: string;\n\t\t\tjobsAssigned: number;\n\t\t\tjobsCompleted: number;\n\t\t\tcompletionRate: number;\n\t\t\trevenue: number;\n\t\t}> = {};\n\n\t\tteamMembers?.forEach((tm) => {\n\t\t\tperformance[tm.id] = {\n\t\t\t\tname: `${tm.first_name} ${tm.last_name}`,\n\t\t\t\trole: tm.role,\n\t\t\t\tjobsAssigned: 0,\n\t\t\t\tjobsCompleted: 0,\n\t\t\t\tcompletionRate: 0,\n\t\t\t\trevenue: 0,\n\t\t\t};\n\t\t});\n\n\t\tjobs?.forEach((job) => {\n\t\t\tif (job.assigned_to && performance[job.assigned_to]) {\n\t\t\t\tperformance[job.assigned_to].jobsAssigned += 1;\n\t\t\t\tif (job.status === \"completed\") {\n\t\t\t\t\tperformance[job.assigned_to].jobsCompleted += 1;\n\t\t\t\t\tperformance[job.assigned_to].revenue += (job.total_amount || 0) / 100;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// Calculate completion rates\n\t\tObject.values(performance).forEach((p) => {\n\t\t\tp.completionRate = p.jobsAssigned > 0 ? (p.jobsCompleted / p.jobsAssigned) * 100 : 0;\n\t\t});\n\n\t\tconst results = Object.values(performance).sort((a, b) => b.revenue - a.revenue);\n\n\t\treturn { success: true, period, performance: results };\n\t},\n});\n\nexport const getCustomerLifetimeValueTool = tool({\n\tdescription: \"Get customer lifetime value (CLV) analysis showing total revenue and engagement per customer\",\n\tparameters: z.object({\n\t\tcustomerId: z.string().uuid().optional().describe(\"Specific customer, or omit for top customers\"),\n\t\tlimit: z.number().optional().default(20),\n\t}),\n\texecute: async ({ customerId, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tif (customerId) {\n\t\t\t// Single customer CLV\n\t\t\tconst [customerResult, invoicesResult, jobsResult] = await Promise.all([\n\t\t\t\tsupabase.from(\"customers\").select(\"*\").eq(\"id\", customerId).eq(\"company_id\", companyId).single(),\n\t\t\t\tsupabase.from(\"invoices\").select(\"total_amount, paid_amount, status, created_at\").eq(\"customer_id\", customerId),\n\t\t\t\tsupabase.from(\"jobs\").select(\"id, status, completed_at\").eq(\"customer_id\", customerId),\n\t\t\t]);\n\n\t\t\tif (customerResult.error) return { success: false, error: customerResult.error.message };\n\n\t\t\tconst totalRevenue = (invoicesResult.data?.filter((i) => i.status === \"paid\").reduce((s, i) => s + (i.paid_amount || 0), 0) || 0) / 100;\n\t\t\tconst jobCount = jobsResult.data?.length || 0;\n\t\t\tconst firstInvoice = invoicesResult.data?.sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime())[0];\n\t\t\tconst customerSince = firstInvoice ? new Date(firstInvoice.created_at) : new Date(customerResult.data.created_at);\n\t\t\tconst monthsAsCustomer = Math.max(1, Math.floor((Date.now() - customerSince.getTime()) / (1000 * 60 * 60 * 24 * 30)));\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tcustomer: customerResult.data,\n\t\t\t\tclv: {\n\t\t\t\t\ttotalRevenue,\n\t\t\t\t\tjobCount,\n\t\t\t\t\taverageJobValue: jobCount > 0 ? totalRevenue / jobCount : 0,\n\t\t\t\t\tcustomerSince: customerSince.toISOString(),\n\t\t\t\t\tmonthsAsCustomer,\n\t\t\t\t\tmonthlyAverageRevenue: totalRevenue / monthsAsCustomer,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t// Top customers by CLV\n\t\tconst { data: customers } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, display_name, total_revenue, job_count, created_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.order(\"total_revenue\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tconst clvData = customers?.map((c) => ({\n\t\t\t...c,\n\t\t\ttotalRevenue: (c.total_revenue || 0) / 100,\n\t\t\taverageJobValue: c.job_count > 0 ? (c.total_revenue || 0) / 100 / c.job_count : 0,\n\t\t}));\n\n\t\treturn { success: true, topCustomers: clvData };\n\t},\n});\n\n// ============================================================================\n// ESTIMATE & CONTRACT TOOLS\n// ============================================================================\n\nexport const searchEstimatesTool = tool({\n\tdescription: \"Search for estimates by customer, status, or amount\",\n\tparameters: z.object({\n\t\tquery: z.string().optional(),\n\t\tstatus: z.enum([\"draft\", \"sent\", \"viewed\", \"approved\", \"rejected\", \"expired\"]).optional(),\n\t\tcustomerId: z.string().uuid().optional(),\n\t\tlimit: z.number().optional().default(20),\n\t}),\n\texecute: async ({ query, status, customerId, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tlet queryBuilder = supabase\n\t\t\t.from(\"estimates\")\n\t\t\t.select(\"id, estimate_number, title, status, total_amount, valid_until, customer:customers(display_name)\")\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (query) queryBuilder = queryBuilder.ilike(\"estimate_number\", `%${query}%`);\n\t\tif (status) queryBuilder = queryBuilder.eq(\"status\", status);\n\t\tif (customerId) queryBuilder = queryBuilder.eq(\"customer_id\", customerId);\n\n\t\tconst { data, error } = await queryBuilder.order(\"created_at\", { ascending: false }).limit(limit);\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, estimates: data, count: data?.length || 0 };\n\t},\n});\n\nexport const searchContractsTool = tool({\n\tdescription: \"Search for contracts by customer, status, or type\",\n\tparameters: z.object({\n\t\tquery: z.string().optional(),\n\t\tstatus: z.enum([\"draft\", \"sent\", \"active\", \"expired\", \"cancelled\"]).optional(),\n\t\tcustomerId: z.string().uuid().optional(),\n\t\tlimit: z.number().optional().default(20),\n\t}),\n\texecute: async ({ query, status, customerId, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tlet queryBuilder = supabase\n\t\t\t.from(\"contracts\")\n\t\t\t.select(\"id, contract_number, title, status, total_value, start_date, end_date, customer:customers(display_name)\")\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (query) queryBuilder = queryBuilder.ilike(\"contract_number\", `%${query}%`);\n\t\tif (status) queryBuilder = queryBuilder.eq(\"status\", status);\n\t\tif (customerId) queryBuilder = queryBuilder.eq(\"customer_id\", customerId);\n\n\t\tconst { data, error } = await queryBuilder.order(\"created_at\", { ascending: false }).limit(limit);\n\n\t\tif (error) return { success: false, error: error.message };\n\t\treturn { success: true, contracts: data, count: data?.length || 0 };\n\t},\n});\n\n// ============================================================================\n// EXPORT ALL TOOLS\n// ============================================================================\n\nexport const aiAgentTools = {\n\t// Universal Database Access tools\n\tlistDatabaseTables: listDatabaseTablesTool,\n\tqueryDatabase: queryDatabaseTool,\n\tgetRecordById: getRecordByIdTool,\n\tgetRelatedRecords: getRelatedRecordsTool,\n\tgetCompanyOverview: getCompanyOverviewTool,\n\tsearchAllEntities: searchAllEntitesTool,\n\n\t// Customer tools\n\tsearchCustomers: searchCustomersTool,\n\tgetCustomerDetails: getCustomerDetailsTool,\n\tcreateCustomer: createCustomerTool,\n\tupdateCustomer: updateCustomerTool,\n\n\t// Team Member tools\n\tsearchTeamMembers: searchTeamMembersTool,\n\tgetTeamMemberDetails: getTeamMemberDetailsTool,\n\tsendTeamEmail: sendTeamEmailTool,\n\tsendTeamSms: sendTeamSmsTool,\n\n\t// Vendor tools\n\tsearchVendors: searchVendorsTool,\n\tgetVendorDetails: getVendorDetailsTool,\n\tsendVendorEmail: sendVendorEmailTool,\n\tsendVendorSms: sendVendorSmsTool,\n\n\t// Property & Equipment tools\n\tsearchProperties: searchPropertiesTool,\n\tgetPropertyDetails: getPropertyDetailsTool,\n\tsearchEquipment: searchEquipmentTool,\n\tgetMaintenanceDue: getMaintenanceDueTool,\n\n\t// Job/Scheduling tools\n\tsearchJobs: searchJobsTool,\n\tcreateAppointment: createAppointmentTool,\n\tgetAvailableSlots: getAvailableSlotsTool,\n\n\t// Invoice/Financial tools\n\tsearchInvoices: searchInvoicesTool,\n\tcreateInvoice: createInvoiceTool,\n\tgetFinancialSummary: getFinancialSummaryTool,\n\tgetVirtualBuckets: getVirtualBucketsTool,\n\ttransferToBucket: transferToBucketTool,\n\n\t// Communication tools\n\tsendEmail: sendEmailTool,\n\tsendSms: sendSmsTool,\n\tinitiateCall: initiateCallTool,\n\tgetCommunicationHistory: getCommunicationHistoryTool,\n\n\t// Reminder/Notification tools\n\tscheduleReminder: scheduleReminderTool,\n\tcancelReminder: cancelReminderTool,\n\tgetScheduledReminders: getScheduledRemindersTool,\n\tsendImmediateNotification: sendImmediateNotificationTool,\n\n\t// Enhanced Reporting tools\n\tgetJobCostingReport: getJobCostingReportTool,\n\tgetRevenueBreakdown: getRevenueBreakdownTool,\n\tgetARAgingReport: getARAgingReportTool,\n\tgetTeamPerformanceReport: getTeamPerformanceReportTool,\n\tgetCustomerLifetimeValue: getCustomerLifetimeValueTool,\n\tgetDashboardMetrics: getDashboardMetricsTool,\n\tgetProactiveInsights: getProactiveInsightsTool,\n\n\t// Estimate & Contract tools\n\tsearchEstimates: searchEstimatesTool,\n\tsearchContracts: searchContractsTool,\n};\n\n// Tool category mapping for permission checking\nexport const toolCategories: Record<string, ToolCategory> = {\n\t// Universal Database Access (read-only, reporting category)\n\tlistDatabaseTables: \"reporting\",\n\tqueryDatabase: \"reporting\",\n\tgetRecordById: \"reporting\",\n\tgetRelatedRecords: \"reporting\",\n\tgetCompanyOverview: \"reporting\",\n\tsearchAllEntities: \"reporting\",\n\n\t// Customer\n\tsearchCustomers: \"customer\",\n\tgetCustomerDetails: \"customer\",\n\tcreateCustomer: \"customer\",\n\tupdateCustomer: \"customer\",\n\n\t// Team\n\tsearchTeamMembers: \"team\",\n\tgetTeamMemberDetails: \"team\",\n\tsendTeamEmail: \"team\",\n\tsendTeamSms: \"team\",\n\n\t// Vendor\n\tsearchVendors: \"vendor\",\n\tgetVendorDetails: \"vendor\",\n\tsendVendorEmail: \"vendor\",\n\tsendVendorSms: \"vendor\",\n\n\t// Property & Equipment\n\tsearchProperties: \"property\",\n\tgetPropertyDetails: \"property\",\n\tsearchEquipment: \"equipment\",\n\tgetMaintenanceDue: \"equipment\",\n\n\t// Scheduling\n\tsearchJobs: \"scheduling\",\n\tcreateAppointment: \"scheduling\",\n\tgetAvailableSlots: \"scheduling\",\n\n\t// Financial\n\tsearchInvoices: \"financial\",\n\tcreateInvoice: \"financial\",\n\tgetFinancialSummary: \"reporting\",\n\tgetVirtualBuckets: \"financial\",\n\ttransferToBucket: \"financial\",\n\n\t// Communication\n\tsendEmail: \"communication\",\n\tsendSms: \"communication\",\n\tinitiateCall: \"communication\",\n\tgetCommunicationHistory: \"communication\",\n\n\t// Notifications\n\tscheduleReminder: \"notification\",\n\tcancelReminder: \"notification\",\n\tgetScheduledReminders: \"notification\",\n\tsendImmediateNotification: \"notification\",\n\n\t// Reporting\n\tgetJobCostingReport: \"reporting\",\n\tgetRevenueBreakdown: \"reporting\",\n\tgetARAgingReport: \"reporting\",\n\tgetTeamPerformanceReport: \"reporting\",\n\tgetCustomerLifetimeValue: \"reporting\",\n\tgetDashboardMetrics: \"reporting\",\n\tgetProactiveInsights: \"reporting\",\n\n\t// Estimates & Contracts\n\tsearchEstimates: \"financial\",\n\tsearchContracts: \"financial\",\n};\n\n// ============================================================================\n// DESTRUCTIVE TOOLS - Require Owner Approval\n// These tools perform actions that cannot be easily undone or have significant impact\n// ============================================================================\n\nexport type DestructiveActionType =\n\t| \"delete\"\n\t| \"bulk_update\"\n\t| \"bulk_delete\"\n\t| \"archive\"\n\t| \"financial\"\n\t| \"send_communication\";\n\nexport type RiskLevel = \"low\" | \"medium\" | \"high\" | \"critical\";\n\nexport interface DestructiveToolMetadata {\n\tisDestructive: true;\n\tactionType: DestructiveActionType;\n\triskLevel: RiskLevel;\n\trequiresOwnerApproval: boolean;\n\tdescription: string;\n\taffectedEntityType: string;\n}\n\n// ============================================================================\n// SEMANTIC MEMORY TOOLS\n// ============================================================================\n\n/**\n * Store a fact or preference about an entity (customer, job, property, etc.)\n * This enables long-term semantic memory across conversations.\n */\nexport const storeMemoryTool = tool({\n\tdescription: \"Store a fact, preference, or important information about an entity (customer, job, property, etc.) for future reference. Use this to remember important details that should persist across conversations.\",\n\tparameters: z.object({\n\t\tcontent: z.string().describe(\"The fact or information to remember\"),\n\t\tmemoryType: z.enum([\"fact\", \"preference\", \"interaction\", \"context\", \"entity\", \"procedure\", \"feedback\"]).describe(\"Type of memory\"),\n\t\tentityType: z.enum([\"customer\", \"job\", \"property\", \"equipment\", \"invoice\", \"estimate\", \"team_member\"]).optional().describe(\"Type of entity this memory relates to\"),\n\t\tentityId: z.string().uuid().optional().describe(\"ID of the related entity\"),\n\t\timportance: z.enum([\"low\", \"medium\", \"high\"]).default(\"medium\").describe(\"How important is this memory\"),\n\t\ttags: z.array(z.string()).optional().describe(\"Tags to categorize the memory\"),\n\t}),\n\texecute: async ({ content, memoryType, entityType, entityId, importance, tags }, { companyId, userId }: { companyId: string; userId?: string }) => {\n\t\tconst { storeMemory } = await import(\"./memory-service\");\n\n\t\tconst importanceScore = { low: 0.3, medium: 0.6, high: 0.9 }[importance];\n\n\t\tconst memoryId = await storeMemory(companyId, userId || \"system\", {\n\t\t\tcontent,\n\t\t\tmemoryType,\n\t\t\tentityType,\n\t\t\tentityId,\n\t\t\timportance: importanceScore,\n\t\t\ttags,\n\t\t\tsourceType: \"agent\",\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: `Memory stored successfully`,\n\t\t\tmemoryId,\n\t\t\tsummary: `Remembered: \"${content.substring(0, 50)}...\"`,\n\t\t};\n\t},\n});\n\n/**\n * Search semantic memories using natural language\n */\nexport const searchMemoriesTool = tool({\n\tdescription: \"Search through stored memories using natural language. Use this to recall facts, preferences, or context about customers, jobs, or other entities.\",\n\tparameters: z.object({\n\t\tquery: z.string().describe(\"Natural language search query (e.g., 'customer preferences for Johnson family')\"),\n\t\tentityType: z.enum([\"customer\", \"job\", \"property\", \"equipment\", \"invoice\", \"estimate\", \"team_member\"]).optional().describe(\"Filter to specific entity type\"),\n\t\tentityId: z.string().uuid().optional().describe(\"Filter to specific entity\"),\n\t\tmemoryTypes: z.array(z.enum([\"fact\", \"preference\", \"interaction\", \"context\", \"entity\", \"procedure\", \"feedback\"])).optional().describe(\"Filter by memory types\"),\n\t\tlimit: z.number().optional().default(5).describe(\"Max memories to return\"),\n\t}),\n\texecute: async ({ query, entityType, entityId, memoryTypes, limit }, { companyId }: { companyId: string }) => {\n\t\tconst { searchMemories } = await import(\"./memory-service\");\n\n\t\tconst results = await searchMemories(companyId, query, {\n\t\t\tentityType,\n\t\t\tentityId,\n\t\t\tmemoryTypes,\n\t\t\tlimit,\n\t\t\tminSimilarity: 0.5,\n\t\t});\n\n\t\tif (results.length === 0) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tmessage: \"No relevant memories found\",\n\t\t\t\tmemories: [],\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: `Found ${results.length} relevant memories`,\n\t\t\tmemories: results.map(m => ({\n\t\t\t\tcontent: m.content,\n\t\t\t\ttype: m.memoryType,\n\t\t\t\trelevance: Math.round(m.similarity * 100) + \"%\",\n\t\t\t\tentityType: m.entityType,\n\t\t\t\tcreatedAt: m.createdAt,\n\t\t\t})),\n\t\t};\n\t},\n});\n\n/**\n * Get all memories for a specific entity\n */\nexport const getEntityMemoriesTool = tool({\n\tdescription: \"Retrieve all stored memories about a specific entity (customer, job, property, etc.). Use this before interacting with a customer or job to get full context.\",\n\tparameters: z.object({\n\t\tentityType: z.enum([\"customer\", \"job\", \"property\", \"equipment\", \"invoice\", \"estimate\", \"team_member\"]).describe(\"Type of entity\"),\n\t\tentityId: z.string().uuid().describe(\"Entity ID\"),\n\t\tmemoryTypes: z.array(z.enum([\"fact\", \"preference\", \"interaction\", \"context\", \"entity\", \"procedure\", \"feedback\"])).optional().describe(\"Filter by memory types\"),\n\t\tlimit: z.number().optional().default(20).describe(\"Max memories to return\"),\n\t}),\n\texecute: async ({ entityType, entityId, memoryTypes, limit }, { companyId }: { companyId: string }) => {\n\t\tconst { getEntityMemories } = await import(\"./memory-service\");\n\n\t\tconst memories = await getEntityMemories(companyId, entityType, entityId, {\n\t\t\ttypes: memoryTypes,\n\t\t\tlimit,\n\t\t});\n\n\t\tif (memories.length === 0) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tmessage: `No memories stored for this ${entityType}`,\n\t\t\t\tmemories: [],\n\t\t\t};\n\t\t}\n\n\t\t// Group by type for better presentation\n\t\tconst grouped: Record<string, Array<{ content: string; importance: number }>> = {};\n\t\tfor (const m of memories) {\n\t\t\tif (!grouped[m.memory_type]) grouped[m.memory_type] = [];\n\t\t\tgrouped[m.memory_type].push({\n\t\t\t\tcontent: m.content,\n\t\t\t\timportance: m.importance,\n\t\t\t});\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: `Found ${memories.length} memories for ${entityType}`,\n\t\t\tmemoriesByType: grouped,\n\t\t\ttotalCount: memories.length,\n\t\t};\n\t},\n});\n\n/**\n * Recall relevant context for current conversation\n */\nexport const recallContextTool = tool({\n\tdescription: \"Automatically recall relevant memories and context based on what's being discussed. Use this at the start of conversations or when switching topics to get background information.\",\n\tparameters: z.object({\n\t\ttopic: z.string().describe(\"The current topic or context (e.g., 'scheduling job for Smith residence', 'invoice payment issue')\"),\n\t\tcustomerName: z.string().optional().describe(\"Customer name if known\"),\n\t\tjobId: z.string().uuid().optional().describe(\"Job ID if discussing a specific job\"),\n\t}),\n\texecute: async ({ topic, customerName, jobId }, { companyId }: { companyId: string }) => {\n\t\tconst { searchMemories } = await import(\"./memory-service\");\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst context: {\n\t\t\tmemories: Array<{ content: string; type: string; relevance: string }>;\n\t\t\tcustomer?: { id: string; name: string; notes?: string };\n\t\t\tjob?: { id: string; title: string; status: string };\n\t\t} = {\n\t\t\tmemories: [],\n\t\t};\n\n\t\t// Search for relevant memories\n\t\tconst memories = await searchMemories(companyId, topic, {\n\t\t\tlimit: 5,\n\t\t\tminSimilarity: 0.4,\n\t\t});\n\n\t\tcontext.memories = memories.map(m => ({\n\t\t\tcontent: m.content,\n\t\t\ttype: m.memoryType,\n\t\t\trelevance: Math.round(m.similarity * 100) + \"%\",\n\t\t}));\n\n\t\t// If customer name provided, try to find them\n\t\tif (customerName) {\n\t\t\tconst { data: customer } = await supabase\n\t\t\t\t.from(\"customers\")\n\t\t\t\t.select(\"id, name, notes\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.ilike(\"name\", `%${customerName}%`)\n\t\t\t\t.limit(1)\n\t\t\t\t.single();\n\n\t\t\tif (customer) {\n\t\t\t\tcontext.customer = customer;\n\n\t\t\t\t// Get customer-specific memories\n\t\t\t\tconst customerMemories = await searchMemories(companyId, `${customerName} customer preferences`, {\n\t\t\t\t\tentityType: \"customer\",\n\t\t\t\t\tentityId: customer.id,\n\t\t\t\t\tlimit: 3,\n\t\t\t\t});\n\n\t\t\t\tfor (const m of customerMemories) {\n\t\t\t\t\tif (!context.memories.some(cm => cm.content === m.content)) {\n\t\t\t\t\t\tcontext.memories.push({\n\t\t\t\t\t\t\tcontent: m.content,\n\t\t\t\t\t\t\ttype: m.memoryType,\n\t\t\t\t\t\t\trelevance: Math.round(m.similarity * 100) + \"%\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// If job ID provided, get job details\n\t\tif (jobId) {\n\t\t\tconst { data: job } = await supabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\"id, title, status, description\")\n\t\t\t\t.eq(\"id\", jobId)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.single();\n\n\t\t\tif (job) {\n\t\t\t\tcontext.job = { id: job.id, title: job.title, status: job.status };\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\ttopic,\n\t\t\tcontext,\n\t\t\tsummary: context.memories.length > 0\n\t\t\t\t? `Found ${context.memories.length} relevant memories for context`\n\t\t\t\t: \"No specific memories found, but retrieved available entity info\",\n\t\t};\n\t},\n});\n\n// ============================================================================\n// COMMUNICATION LEARNING TOOLS\n// ============================================================================\n\n/**\n * Search across all communications (calls, emails, SMS) using full-text search\n */\nexport const searchCommunicationsFullTextTool = tool({\n\tdescription: \"Search across all customer communications (calls, emails, SMS) to find specific conversations, topics, or issues discussed. Great for finding 'what did the customer say about...'\",\n\tparameters: z.object({\n\t\tquery: z.string().describe(\"Search query (e.g., 'water heater issue', 'preferred time morning')\"),\n\t\tchannel: z.enum([\"email\", \"sms\", \"call\", \"all\"]).optional().default(\"all\").describe(\"Filter by communication channel\"),\n\t\tcustomerId: z.string().uuid().optional().describe(\"Filter to specific customer\"),\n\t\tdirection: z.enum([\"inbound\", \"outbound\", \"all\"]).optional().default(\"all\").describe(\"Filter by direction\"),\n\t\tlimit: z.number().optional().default(10).describe(\"Max results\"),\n\t}),\n\texecute: async ({ query, channel, customerId, direction, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tlet dbQuery = supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(`\n\t\t\t\tid, type, channel, direction, subject, body_plain,\n\t\t\t\tcall_transcript, call_sentiment, from_name, to_name,\n\t\t\t\tcustomer_id, created_at,\n\t\t\t\tcustomer:customers(id, name)\n\t\t\t`)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\t// Apply filters\n\t\tif (channel !== \"all\") {\n\t\t\tdbQuery = dbQuery.eq(\"channel\", channel);\n\t\t}\n\t\tif (customerId) {\n\t\t\tdbQuery = dbQuery.eq(\"customer_id\", customerId);\n\t\t}\n\t\tif (direction !== \"all\") {\n\t\t\tdbQuery = dbQuery.eq(\"direction\", direction);\n\t\t}\n\n\t\t// Full-text search on body and transcript\n\t\tdbQuery = dbQuery.or(`body_plain.ilike.%${query}%,call_transcript.ilike.%${query}%,subject.ilike.%${query}%`);\n\n\t\tconst { data, error } = await dbQuery;\n\n\t\tif (error) return { success: false, error: error.message };\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: `Found ${data?.length || 0} communications matching \"${query}\"`,\n\t\t\tresults: data?.map(c => ({\n\t\t\t\tid: c.id,\n\t\t\t\tchannel: c.channel,\n\t\t\t\tdirection: c.direction,\n\t\t\t\tsubject: c.subject,\n\t\t\t\tpreview: (c.body_plain || c.call_transcript || \"\").substring(0, 200),\n\t\t\t\tsentiment: c.call_sentiment,\n\t\t\t\tcustomerName: c.customer?.name,\n\t\t\t\tdate: c.created_at,\n\t\t\t})),\n\t\t};\n\t},\n});\n\n/**\n * Get call transcript with AI-extracted insights\n */\nexport const getCallTranscriptTool = tool({\n\tdescription: \"Get the full transcript of a phone call along with extracted insights. Use when you need to review what was discussed in a specific call.\",\n\tparameters: z.object({\n\t\tcommunicationId: z.string().uuid().describe(\"The communication ID of the call\"),\n\t}),\n\texecute: async ({ communicationId }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(`\n\t\t\t\tid, type, channel, direction, call_duration, call_transcript,\n\t\t\t\tcall_sentiment, call_recording_url, from_name, to_name,\n\t\t\t\tcustomer_id, created_at,\n\t\t\t\tcustomer:customers(id, name, email, phone)\n\t\t\t`)\n\t\t\t.eq(\"id\", communicationId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error) return { success: false, error: error.message };\n\t\tif (!data?.call_transcript) {\n\t\t\treturn { success: false, error: \"No transcript available for this communication\" };\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcall: {\n\t\t\t\tid: data.id,\n\t\t\t\tdirection: data.direction,\n\t\t\t\tduration: data.call_duration ? `${Math.floor(data.call_duration / 60)}m ${data.call_duration % 60}s` : \"Unknown\",\n\t\t\t\tsentiment: data.call_sentiment,\n\t\t\t\tcustomerName: data.customer?.name,\n\t\t\t\tdate: data.created_at,\n\t\t\t\ttranscript: data.call_transcript,\n\t\t\t\thasRecording: !!data.call_recording_url,\n\t\t\t},\n\t\t};\n\t},\n});\n\n/**\n * Search voicemail transcriptions\n */\nexport const searchVoicemailTranscriptsTool = tool({\n\tdescription: \"Search through voicemail transcriptions to find messages about specific topics or from specific customers.\",\n\tparameters: z.object({\n\t\tquery: z.string().optional().describe(\"Search query for transcription content\"),\n\t\tcustomerId: z.string().uuid().optional().describe(\"Filter to specific customer\"),\n\t\turgentOnly: z.boolean().optional().default(false).describe(\"Only show urgent voicemails\"),\n\t\tunreadOnly: z.boolean().optional().default(false).describe(\"Only show unread voicemails\"),\n\t\tlimit: z.number().optional().default(10).describe(\"Max results\"),\n\t}),\n\texecute: async ({ query, customerId, urgentOnly, unreadOnly, limit }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tlet dbQuery = supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.select(`\n\t\t\t\tid, from_number, duration, transcription, transcription_confidence,\n\t\t\t\tis_read, is_urgent, received_at, customer_id,\n\t\t\t\tcustomer:customers(id, name)\n\t\t\t`)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"received_at\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tif (customerId) {\n\t\t\tdbQuery = dbQuery.eq(\"customer_id\", customerId);\n\t\t}\n\t\tif (urgentOnly) {\n\t\t\tdbQuery = dbQuery.eq(\"is_urgent\", true);\n\t\t}\n\t\tif (unreadOnly) {\n\t\t\tdbQuery = dbQuery.eq(\"is_read\", false);\n\t\t}\n\t\tif (query) {\n\t\t\tdbQuery = dbQuery.ilike(\"transcription\", `%${query}%`);\n\t\t}\n\n\t\tconst { data, error } = await dbQuery;\n\n\t\tif (error) return { success: false, error: error.message };\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: `Found ${data?.length || 0} voicemails`,\n\t\t\tvoicemails: data?.map(v => ({\n\t\t\t\tid: v.id,\n\t\t\t\tfrom: v.from_number,\n\t\t\t\tcustomerName: v.customer?.name,\n\t\t\t\tduration: v.duration ? `${Math.floor(v.duration / 60)}m ${v.duration % 60}s` : \"Unknown\",\n\t\t\t\ttranscription: v.transcription,\n\t\t\t\tconfidence: v.transcription_confidence,\n\t\t\t\tisUrgent: v.is_urgent,\n\t\t\t\tisRead: v.is_read,\n\t\t\t\treceivedAt: v.received_at,\n\t\t\t})),\n\t\t};\n\t},\n});\n\n/**\n * Get all recent communications for a customer\n */\nexport const getCustomerCommunicationHistoryTool = tool({\n\tdescription: \"Get the complete communication history for a customer including calls, emails, SMS, and voicemails. Use this to understand the full context of a customer relationship.\",\n\tparameters: z.object({\n\t\tcustomerId: z.string().uuid().describe(\"Customer UUID\"),\n\t\tdays: z.number().optional().default(90).describe(\"Look back this many days\"),\n\t\tincludeTranscripts: z.boolean().optional().default(false).describe(\"Include full call transcripts\"),\n\t}),\n\texecute: async ({ customerId, days, includeTranscripts }, { companyId }: { companyId: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\t\tconst cutoffDate = new Date();\n\t\tcutoffDate.setDate(cutoffDate.getDate() - days);\n\n\t\t// Get communications\n\t\tconst { data: comms, error: commsError } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(`\n\t\t\t\tid, type, channel, direction, subject, body_plain,\n\t\t\t\tcall_transcript, call_sentiment, call_duration,\n\t\t\t\tfrom_name, to_name, created_at, status\n\t\t\t`)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.gte(\"created_at\", cutoffDate.toISOString())\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\t// Get voicemails\n\t\tconst { data: voicemails, error: vmError } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.select(\"id, from_number, duration, transcription, is_urgent, received_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.gte(\"received_at\", cutoffDate.toISOString())\n\t\t\t.order(\"received_at\", { ascending: false });\n\n\t\tif (commsError) return { success: false, error: commsError.message };\n\n\t\t// Summarize by channel\n\t\tconst summary = {\n\t\t\temails: comms?.filter(c => c.channel === \"email\").length || 0,\n\t\t\tcalls: comms?.filter(c => c.channel === \"call\").length || 0,\n\t\t\tsms: comms?.filter(c => c.channel === \"sms\").length || 0,\n\t\t\tvoicemails: voicemails?.length || 0,\n\t\t};\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcustomerId,\n\t\t\tperiod: `Last ${days} days`,\n\t\t\tsummary,\n\t\t\tcommunications: comms?.map(c => ({\n\t\t\t\tid: c.id,\n\t\t\t\tchannel: c.channel,\n\t\t\t\tdirection: c.direction,\n\t\t\t\tsubject: c.subject,\n\t\t\t\tpreview: includeTranscripts\n\t\t\t\t\t? (c.body_plain || c.call_transcript || \"\").substring(0, 500)\n\t\t\t\t\t: (c.body_plain || c.call_transcript || \"\").substring(0, 100),\n\t\t\t\tsentiment: c.call_sentiment,\n\t\t\t\tdate: c.created_at,\n\t\t\t})),\n\t\t\tvoicemails: voicemails?.map(v => ({\n\t\t\t\tid: v.id,\n\t\t\t\tduration: v.duration,\n\t\t\t\ttranscription: v.transcription?.substring(0, 200),\n\t\t\t\tisUrgent: v.is_urgent,\n\t\t\t\tdate: v.received_at,\n\t\t\t})),\n\t\t};\n\t},\n});\n\n/**\n * Extract and store insights from a communication\n */\nexport const extractCommunicationInsightsTool = tool({\n\tdescription: \"Analyze a communication (call, email, SMS) and extract key insights like customer preferences, issues, sentiment. Automatically stores insights in memory for future reference.\",\n\tparameters: z.object({\n\t\tcommunicationId: z.string().uuid().describe(\"Communication ID to analyze\"),\n\t\tinsightTypes: z.array(z.enum([\"preference\", \"issue\", \"sentiment\", \"action_item\", \"feedback\"])).optional().describe(\"Types of insights to extract\"),\n\t}),\n\texecute: async ({ communicationId, insightTypes }, { companyId, userId }: { companyId: string; userId?: string }) => {\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\t// Get the communication\n\t\tconst { data: comm, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(`\n\t\t\t\tid, channel, direction, subject, body_plain, call_transcript,\n\t\t\t\tcall_sentiment, customer_id,\n\t\t\t\tcustomer:customers(id, name)\n\t\t\t`)\n\t\t\t.eq(\"id\", communicationId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error || !comm) {\n\t\t\treturn { success: false, error: \"Communication not found\" };\n\t\t}\n\n\t\tconst content = comm.body_plain || comm.call_transcript || \"\";\n\t\tif (!content) {\n\t\t\treturn { success: false, error: \"No content to analyze\" };\n\t\t}\n\n\t\t// Extract insights using pattern matching (basic implementation)\n\t\tconst insights: Array<{ type: string; content: string; importance: string }> = [];\n\n\t\t// Look for preferences (morning, afternoon, specific days, etc.)\n\t\tconst preferencePatterns = [\n\t\t\t/prefer[s]?\\s+(morning|afternoon|evening|weekend|monday|tuesday|wednesday|thursday|friday)/gi,\n\t\t\t/best\\s+time[s]?\\s+(?:is|are|would be)\\s+([^.]+)/gi,\n\t\t\t/don'?t\\s+(?:like|want|prefer)\\s+([^.]+)/gi,\n\t\t];\n\n\t\tfor (const pattern of preferencePatterns) {\n\t\t\tconst matches = content.matchAll(pattern);\n\t\t\tfor (const match of matches) {\n\t\t\t\tinsights.push({\n\t\t\t\t\ttype: \"preference\",\n\t\t\t\t\tcontent: `Customer prefers: ${match[0]}`,\n\t\t\t\t\timportance: \"medium\",\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Look for issues/complaints\n\t\tconst issuePatterns = [\n\t\t\t/problem[s]?\\s+with\\s+([^.]+)/gi,\n\t\t\t/issue[s]?\\s+with\\s+([^.]+)/gi,\n\t\t\t/not\\s+working\\s+([^.]+)/gi,\n\t\t\t/broken\\s+([^.]+)/gi,\n\t\t];\n\n\t\tfor (const pattern of issuePatterns) {\n\t\t\tconst matches = content.matchAll(pattern);\n\t\t\tfor (const match of matches) {\n\t\t\t\tinsights.push({\n\t\t\t\t\ttype: \"issue\",\n\t\t\t\t\tcontent: `Reported issue: ${match[0]}`,\n\t\t\t\t\timportance: \"high\",\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Store insights in memory if customer is linked\n\t\tif (comm.customer_id && insights.length > 0) {\n\t\t\tconst { storeMemory } = await import(\"./memory-service\");\n\n\t\t\tfor (const insight of insights) {\n\t\t\t\tawait storeMemory(companyId, userId || \"system\", {\n\t\t\t\t\tcontent: insight.content,\n\t\t\t\t\tmemoryType: insight.type as \"preference\" | \"feedback\",\n\t\t\t\t\tentityType: \"customer\",\n\t\t\t\t\tentityId: comm.customer_id,\n\t\t\t\t\timportance: insight.importance === \"high\" ? 0.9 : 0.6,\n\t\t\t\t\tsourceType: \"communication\",\n\t\t\t\t\tsourceChatId: communicationId,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcommunicationId,\n\t\t\tchannel: comm.channel,\n\t\t\tcustomerName: comm.customer?.name,\n\t\t\textractedInsights: insights,\n\t\t\tstoredToMemory: insights.length > 0 && !!comm.customer_id,\n\t\t\tsentiment: comm.call_sentiment,\n\t\t};\n\t},\n});\n\n// =============================================================================\n// EXTERNAL DATA TOOLS - Weather, Traffic, GPS, Maps\n// =============================================================================\n\n/**\n * Get weather forecast and alerts for a location\n *\n * Uses the NWS (National Weather Service) API to get:\n * - 7-day forecast\n * - Hourly forecast\n * - Active weather alerts\n * - Severe weather warnings\n */\nexport const getWeatherForLocationTool = tool({\n\tdescription: `Get weather forecast and alerts for a specific location. Provides 7-day forecast, hourly conditions, and any active weather alerts. Use this when:\n- Scheduling outdoor jobs\n- Checking if weather is suitable for work\n- Planning technician routes\n- Informing customers about weather delays\n\nReturns forecast periods, temperature, wind, precipitation chances, and any severe weather alerts.`,\n\tparameters: z.object({\n\t\tlat: z.number().describe(\"Latitude of the location\"),\n\t\tlon: z.number().describe(\"Longitude of the location\"),\n\t\tincludeHourly: z\n\t\t\t.boolean()\n\t\t\t.optional()\n\t\t\t.default(true)\n\t\t\t.describe(\"Include hourly forecast for next 24 hours\"),\n\t}),\n\texecute: async ({ lat, lon, includeHourly }) => {\n\t\tconst { weatherService } = await import(\"../services/weather-service\");\n\n\t\tconst weather = await weatherService.getWeatherData(lat, lon);\n\n\t\tif (!weather) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Unable to fetch weather data for this location\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tlocation: weather.location,\n\t\t\tcurrentConditions: weather.hourly?.periods?.[0] || null,\n\t\t\tforecast: weather.forecast?.periods?.slice(0, 7) || [],\n\t\t\thourly: includeHourly\n\t\t\t\t? weather.hourly?.periods?.slice(0, 12) || []\n\t\t\t\t: [],\n\t\t\talerts: weather.alerts,\n\t\t\thasActiveAlerts: weather.hasActiveAlerts,\n\t\t\thighestSeverity: weather.highestSeverity,\n\t\t\tenrichedAt: weather.enrichedAt,\n\t\t};\n\t},\n});\n\n/**\n * Check if weather is suitable for outdoor work\n *\n * Analyzes weather conditions and alerts to determine if\n * it's safe and practical to do outdoor work\n */\nexport const checkWeatherForJobTool = tool({\n\tdescription: `Check if weather conditions are suitable for outdoor field service work at a specific location. Considers:\n- Severe weather alerts\n- Precipitation (rain, snow, storms)\n- Extreme temperatures (freezing or excessive heat)\n- Wind conditions\n\nReturns a clear recommendation on whether to proceed with outdoor work.`,\n\tparameters: z.object({\n\t\tlat: z.number().describe(\"Latitude of the job location\"),\n\t\tlon: z.number().describe(\"Longitude of the job location\"),\n\t\tjobType: z\n\t\t\t.string()\n\t\t\t.optional()\n\t\t\t.describe(\"Type of job (e.g., 'roofing', 'HVAC outdoor', 'landscaping')\"),\n\t}),\n\texecute: async ({ lat, lon, jobType }) => {\n\t\tconst { weatherService } = await import(\"../services/weather-service\");\n\n\t\tconst weather = await weatherService.getWeatherData(lat, lon);\n\n\t\tif (!weather) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tsuitable: null,\n\t\t\t\terror: \"Unable to fetch weather data\",\n\t\t\t};\n\t\t}\n\n\t\tconst suitability = weatherService.isSuitableForOutdoorWork(weather);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tsuitable: suitability.suitable,\n\t\t\treason: suitability.reason || \"Weather conditions are acceptable for outdoor work\",\n\t\t\tcurrentConditions: weather.hourly?.periods?.[0]\n\t\t\t\t? {\n\t\t\t\t\t\ttemperature: weather.hourly.periods[0].temperature,\n\t\t\t\t\t\ttemperatureUnit: weather.hourly.periods[0].temperatureUnit,\n\t\t\t\t\t\tshortForecast: weather.hourly.periods[0].shortForecast,\n\t\t\t\t\t\twindSpeed: weather.hourly.periods[0].windSpeed,\n\t\t\t\t\t}\n\t\t\t\t: null,\n\t\t\talerts: weather.alerts.map((a) => ({\n\t\t\t\tevent: a.event,\n\t\t\t\tseverity: a.severity,\n\t\t\t\theadline: a.headline,\n\t\t\t})),\n\t\t\tjobType,\n\t\t\trecommendation: suitability.suitable\n\t\t\t\t? \"Proceed with outdoor work\"\n\t\t\t\t: `Consider rescheduling: ${suitability.reason}`,\n\t\t};\n\t},\n});\n\n/**\n * Get active weather alerts only (faster than full forecast)\n */\nexport const getWeatherAlertsTool = tool({\n\tdescription: `Quickly check for active weather alerts at a location without fetching the full forecast. Use this for:\n- Quick safety checks\n- Emergency notifications\n- Batch checking multiple job sites\n\nReturns only alert information (faster than full weather data).`,\n\tparameters: z.object({\n\t\tlat: z.number().describe(\"Latitude\"),\n\t\tlon: z.number().describe(\"Longitude\"),\n\t}),\n\texecute: async ({ lat, lon }) => {\n\t\tconst { weatherService } = await import(\"../services/weather-service\");\n\n\t\tconst alerts = await weatherService.getActiveAlerts(lat, lon);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\thasAlerts: alerts.length > 0,\n\t\t\talertCount: alerts.length,\n\t\t\talerts: alerts.map((a) => ({\n\t\t\t\tevent: a.event,\n\t\t\t\tseverity: a.severity,\n\t\t\t\turgency: a.urgency,\n\t\t\t\theadline: a.headline,\n\t\t\t\tinstruction: a.instruction,\n\t\t\t\texpires: a.expires,\n\t\t\t})),\n\t\t};\n\t},\n});\n\n/**\n * Get traffic conditions and incidents along a route\n *\n * Uses Google Maps API to check for traffic incidents,\n * construction, accidents, and congestion\n */\nexport const getTrafficConditionsTool = tool({\n\tdescription: `Get real-time traffic conditions and incidents near a job location or along a route. Detects:\n- Traffic accidents/crashes\n- Road construction\n- Road closures\n- Police activity\n- Congestion levels\n\nUseful for:\n- Planning technician dispatch\n- Estimating arrival times\n- Routing around incidents\n- Notifying customers of delays`,\n\tparameters: z.object({\n\t\tdestinationLat: z.number().describe(\"Latitude of the destination/job site\"),\n\t\tdestinationLon: z.number().describe(\"Longitude of the destination/job site\"),\n\t\toriginLat: z\n\t\t\t.number()\n\t\t\t.optional()\n\t\t\t.describe(\"Latitude of origin (e.g., shop/office) to check route\"),\n\t\toriginLon: z\n\t\t\t.number()\n\t\t\t.optional()\n\t\t\t.describe(\"Longitude of origin to check route\"),\n\t}),\n\texecute: async ({ destinationLat, destinationLon, originLat, originLon }) => {\n\t\tconst { trafficService } = await import(\"../services/traffic-service\");\n\n\t\tconst traffic = await trafficService.getTrafficIncidents(\n\t\t\tdestinationLat,\n\t\t\tdestinationLon,\n\t\t\toriginLat,\n\t\t\toriginLon\n\t\t);\n\n\t\tif (!traffic) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Unable to fetch traffic data. Check Google Maps API configuration.\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\ttotalIncidents: traffic.totalIncidents,\n\t\t\tnearbyIncidents: traffic.nearbyIncidents,\n\t\t\trouteAffectingIncidents: traffic.routeAffectingIncidents,\n\t\t\tincidents: traffic.incidents.map((i) => ({\n\t\t\t\ttype: i.type,\n\t\t\t\tseverity: i.severity,\n\t\t\t\tdescription: i.description,\n\t\t\t\tdistance: i.distance,\n\t\t\t\taffectsRoute: i.affectsRoute,\n\t\t\t})),\n\t\t\trecommendation:\n\t\t\t\ttraffic.routeAffectingIncidents > 0\n\t\t\t\t\t? `${traffic.routeAffectingIncidents} incident(s) may affect travel time`\n\t\t\t\t\t: \"No significant traffic issues detected\",\n\t\t\tenrichedAt: traffic.enrichedAt,\n\t\t};\n\t},\n});\n\n/**\n * Geocode an address to GPS coordinates\n *\n * Converts a street address to latitude/longitude coordinates\n */\nexport const geocodeAddressTool = tool({\n\tdescription: `Convert a street address to GPS coordinates (latitude/longitude). Use this when:\n- You have an address but need coordinates for weather/traffic lookup\n- Verifying an address is valid\n- Getting standardized/formatted address\n\nReturns coordinates and Google's formatted version of the address.`,\n\tparameters: z.object({\n\t\taddress: z.string().describe(\"Street address (e.g., '123 Main St')\"),\n\t\tcity: z.string().describe(\"City name\"),\n\t\tstate: z.string().describe(\"State (e.g., 'CA' or 'California')\"),\n\t\tzipCode: z.string().describe(\"ZIP code\"),\n\t\tcountry: z.string().optional().default(\"USA\").describe(\"Country (defaults to USA)\"),\n\t}),\n\texecute: async ({ address, city, state, zipCode, country }) => {\n\t\tconst { geocodeAddressSilent } = await import(\"../services/geocoding\");\n\n\t\tconst result = await geocodeAddressSilent(address, city, state, zipCode, country);\n\n\t\tif (!result) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Unable to geocode address. The address may be invalid or geocoding service unavailable.\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcoordinates: {\n\t\t\t\tlat: result.lat,\n\t\t\t\tlon: result.lon,\n\t\t\t},\n\t\t\tformattedAddress: result.formattedAddress,\n\t\t};\n\t},\n});\n\n/**\n * Get property weather and conditions summary\n *\n * Combines multiple data sources to give a complete picture\n * of conditions at a property/job site\n */\nexport const getPropertyConditionsTool = tool({\n\tdescription: `Get a comprehensive conditions summary for a property/job site including weather, traffic, and alerts. This is the \"one-stop\" tool for checking all external conditions before dispatching or scheduling.\n\nCombines:\n- Current and forecast weather\n- Weather alerts\n- Traffic conditions (if shop coordinates provided)\n- Work suitability assessment`,\n\tparameters: z.object({\n\t\tpropertyLat: z.number().describe(\"Latitude of the property\"),\n\t\tpropertyLon: z.number().describe(\"Longitude of the property\"),\n\t\tshopLat: z.number().optional().describe(\"Shop/office latitude for traffic routing\"),\n\t\tshopLon: z.number().optional().describe(\"Shop/office longitude for traffic routing\"),\n\t\tjobType: z\n\t\t\t.string()\n\t\t\t.optional()\n\t\t\t.describe(\"Type of job being performed (for work suitability)\"),\n\t}),\n\texecute: async ({ propertyLat, propertyLon, shopLat, shopLon, jobType }) => {\n\t\tconst { weatherService } = await import(\"../services/weather-service\");\n\t\tconst { trafficService } = await import(\"../services/traffic-service\");\n\n\t\t// Fetch weather and traffic in parallel\n\t\tconst [weather, traffic] = await Promise.all([\n\t\t\tweatherService.getWeatherData(propertyLat, propertyLon),\n\t\t\tshopLat && shopLon\n\t\t\t\t? trafficService.getTrafficIncidents(propertyLat, propertyLon, shopLat, shopLon)\n\t\t\t\t: Promise.resolve(null),\n\t\t]);\n\n\t\tconst result: Record<string, unknown> = {\n\t\t\tsuccess: true,\n\t\t\tpropertyLocation: { lat: propertyLat, lon: propertyLon },\n\t\t};\n\n\t\t// Weather conditions\n\t\tif (weather) {\n\t\t\tconst suitability = weatherService.isSuitableForOutdoorWork(weather);\n\t\t\tresult.weather = {\n\t\t\t\tcurrent: weather.hourly?.periods?.[0]\n\t\t\t\t\t? {\n\t\t\t\t\t\t\ttemperature: weather.hourly.periods[0].temperature,\n\t\t\t\t\t\t\ttemperatureUnit: weather.hourly.periods[0].temperatureUnit,\n\t\t\t\t\t\t\tconditions: weather.hourly.periods[0].shortForecast,\n\t\t\t\t\t\t\twind: weather.hourly.periods[0].windSpeed,\n\t\t\t\t\t\t}\n\t\t\t\t\t: null,\n\t\t\t\tforecast: weather.forecast?.periods?.slice(0, 3).map((p) => ({\n\t\t\t\t\tname: p.name,\n\t\t\t\t\ttemperature: p.temperature,\n\t\t\t\t\tshortForecast: p.shortForecast,\n\t\t\t\t})),\n\t\t\t\talerts: weather.alerts.map((a) => ({\n\t\t\t\t\tevent: a.event,\n\t\t\t\t\tseverity: a.severity,\n\t\t\t\t\theadline: a.headline,\n\t\t\t\t})),\n\t\t\t\thasAlerts: weather.hasActiveAlerts,\n\t\t\t\thighestAlertSeverity: weather.highestSeverity,\n\t\t\t};\n\t\t\tresult.workSuitability = {\n\t\t\t\tsuitable: suitability.suitable,\n\t\t\t\treason: suitability.reason || \"Conditions acceptable\",\n\t\t\t\tjobType,\n\t\t\t};\n\t\t} else {\n\t\t\tresult.weather = { error: \"Weather data unavailable\" };\n\t\t\tresult.workSuitability = { suitable: null, reason: \"Unable to assess\" };\n\t\t}\n\n\t\t// Traffic conditions\n\t\tif (traffic) {\n\t\t\tresult.traffic = {\n\t\t\t\ttotalIncidents: traffic.totalIncidents,\n\t\t\t\trouteAffecting: traffic.routeAffectingIncidents,\n\t\t\t\tincidents: traffic.incidents.slice(0, 5).map((i) => ({\n\t\t\t\t\ttype: i.type,\n\t\t\t\t\tseverity: i.severity,\n\t\t\t\t\tdescription: i.description,\n\t\t\t\t})),\n\t\t\t};\n\t\t} else if (shopLat && shopLon) {\n\t\t\tresult.traffic = { error: \"Traffic data unavailable\" };\n\t\t}\n\n\t\t// Overall recommendation\n\t\tconst issues: string[] = [];\n\t\tif (weather?.hasActiveAlerts) {\n\t\t\tissues.push(`Weather alert: ${weather.highestSeverity}`);\n\t\t}\n\t\tif (weather && !weatherService.isSuitableForOutdoorWork(weather).suitable) {\n\t\t\tissues.push(\"Weather not suitable for outdoor work\");\n\t\t}\n\t\tif (traffic && traffic.routeAffectingIncidents > 0) {\n\t\t\tissues.push(`${traffic.routeAffectingIncidents} traffic incident(s) on route`);\n\t\t}\n\n\t\tresult.overallStatus = issues.length === 0 ? \"good\" : \"caution\";\n\t\tresult.issues = issues;\n\t\tresult.recommendation =\n\t\t\tissues.length === 0\n\t\t\t\t? \"Conditions look good for this job\"\n\t\t\t\t: `Review before proceeding: ${issues.join(\"; \")}`;\n\n\t\treturn result;\n\t},\n});\n\n// =============================================================================\n// CODE SEARCH TOOLS - Building, Plumbing, Electrical Codes\n// =============================================================================\n\n/**\n * Common building code references by trade type\n * This is a knowledge base that can be enhanced with actual API integrations\n */\nconst codeReferences = {\n\tplumbing: {\n\t\tname: \"Uniform Plumbing Code (UPC) / International Plumbing Code (IPC)\",\n\t\tcommonRequirements: [\n\t\t\t\"Drain pipe slope: 1/4 inch per foot minimum\",\n\t\t\t\"Vent pipes must extend through roof\",\n\t\t\t\"P-traps required on all fixtures\",\n\t\t\t\"Water heater T&P relief valve required\",\n\t\t\t\"Backflow prevention on potable water\",\n\t\t\t\"Minimum fixture unit calculations for pipe sizing\",\n\t\t\t\"Air gap requirements for indirect waste\",\n\t\t],\n\t\tpermitTriggers: [\n\t\t\t\"New water heater installation\",\n\t\t\t\"Moving or adding fixtures\",\n\t\t\t\"New water/sewer line connections\",\n\t\t\t\"Gas line work\",\n\t\t\t\"Sewer line replacement\",\n\t\t],\n\t},\n\telectrical: {\n\t\tname: \"National Electrical Code (NEC)\",\n\t\tcommonRequirements: [\n\t\t\t\"GFCI required in kitchens, bathrooms, garages, outdoors\",\n\t\t\t\"AFCI required in bedrooms and living areas\",\n\t\t\t\"Smoke detectors on every floor and bedroom\",\n\t\t\t\"Panel accessibility clearance: 36 inches\",\n\t\t\t\"Wire sizing based on amperage load\",\n\t\t\t\"Grounding requirements for all circuits\",\n\t\t\t\"Box fill calculations for junction boxes\",\n\t\t],\n\t\tpermitTriggers: [\n\t\t\t\"New circuits or subpanels\",\n\t\t\t\"Service upgrade\",\n\t\t\t\"Adding outlets or switches\",\n\t\t\t\"Electric vehicle charger installation\",\n\t\t\t\"Generator installation\",\n\t\t],\n\t},\n\thvac: {\n\t\tname: \"International Mechanical Code (IMC)\",\n\t\tcommonRequirements: [\n\t\t\t\"Proper equipment sizing (Manual J calculation)\",\n\t\t\t\"Ductwork sizing (Manual D calculation)\",\n\t\t\t\"Combustion air requirements for gas appliances\",\n\t\t\t\"Clearances from combustible materials\",\n\t\t\t\"Condensate drain requirements\",\n\t\t\t\"Refrigerant line sizing and insulation\",\n\t\t\t\"Energy efficiency minimums (SEER ratings)\",\n\t\t],\n\t\tpermitTriggers: [\n\t\t\t\"New HVAC system installation\",\n\t\t\t\"Equipment replacement (like-for-like may be exempt)\",\n\t\t\t\"Ductwork modifications\",\n\t\t\t\"Gas line work\",\n\t\t\t\"Mini-split installation\",\n\t\t],\n\t},\n\tgeneral: {\n\t\tname: \"International Building Code (IBC) / International Residential Code (IRC)\",\n\t\tcommonRequirements: [\n\t\t\t\"Egress window requirements for bedrooms\",\n\t\t\t\"Stair rise/run specifications (7.75 in max rise, 10 in min run)\",\n\t\t\t\"Handrail requirements (34-38 inches height)\",\n\t\t\t\"Smoke and CO detector placement\",\n\t\t\t\"Fire-rated assemblies where required\",\n\t\t\t\"Structural load calculations\",\n\t\t],\n\t\tpermitTriggers: [\n\t\t\t\"Structural modifications\",\n\t\t\t\"Adding/removing walls\",\n\t\t\t\"Roof replacement (varies by jurisdiction)\",\n\t\t\t\"Window/door changes\",\n\t\t\t\"Additions or conversions\",\n\t\t],\n\t},\n\troofing: {\n\t\tname: \"International Building Code (IBC) - Roofing Section\",\n\t\tcommonRequirements: [\n\t\t\t\"Minimum roof slope requirements by material\",\n\t\t\t\"Underlayment requirements\",\n\t\t\t\"Ice and water shield in cold climates\",\n\t\t\t\"Flashing requirements at penetrations\",\n\t\t\t\"Ventilation requirements (1:150 or 1:300 ratio)\",\n\t\t\t\"Fire-rated materials in certain zones\",\n\t\t],\n\t\tpermitTriggers: [\n\t\t\t\"Complete re-roof (varies by jurisdiction)\",\n\t\t\t\"Structural repairs\",\n\t\t\t\"Adding skylights or vents\",\n\t\t\t\"Changing roofing material type\",\n\t\t],\n\t},\n};\n\n/**\n * Search building codes by trade type and work description\n */\nexport const searchBuildingCodesTool = tool({\n\tdescription: `Search for relevant building code requirements based on the type of work being performed. Returns common code requirements, permit triggers, and best practices for:\n- Plumbing (UPC/IPC)\n- Electrical (NEC)\n- HVAC (IMC)\n- General construction (IBC/IRC)\n- Roofing\n\nUse this to help technicians understand code requirements before starting work.`,\n\tparameters: z.object({\n\t\ttradeType: z\n\t\t\t.enum([\"plumbing\", \"electrical\", \"hvac\", \"general\", \"roofing\"])\n\t\t\t.describe(\"The trade or type of work\"),\n\t\tworkDescription: z\n\t\t\t.string()\n\t\t\t.optional()\n\t\t\t.describe(\"Specific description of the work being performed\"),\n\t\tstate: z\n\t\t\t.string()\n\t\t\t.optional()\n\t\t\t.describe(\"State abbreviation (codes vary by jurisdiction)\"),\n\t}),\n\texecute: async ({ tradeType, workDescription, state }) => {\n\t\tconst codeInfo = codeReferences[tradeType];\n\n\t\t// Build relevance context\n\t\tconst relevantRequirements: string[] = [];\n\t\tif (workDescription) {\n\t\t\tconst desc = workDescription.toLowerCase();\n\n\t\t\t// Filter requirements based on work description keywords\n\t\t\tfor (const req of codeInfo.commonRequirements) {\n\t\t\t\tconst reqLower = req.toLowerCase();\n\t\t\t\t// Simple relevance matching\n\t\t\t\tconst keywords = desc.split(/\\s+/);\n\t\t\t\tif (keywords.some((kw) => kw.length > 3 && reqLower.includes(kw))) {\n\t\t\t\t\trelevantRequirements.push(req);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\ttradeType,\n\t\t\tcodeName: codeInfo.name,\n\t\t\tcommonRequirements: codeInfo.commonRequirements,\n\t\t\trelevantToWork:\n\t\t\t\trelevantRequirements.length > 0 ? relevantRequirements : null,\n\t\t\tpermitTriggers: codeInfo.permitTriggers,\n\t\t\tjurisdictionNote: state\n\t\t\t\t? `Note: Requirements may vary in ${state}. Always verify with local building department.`\n\t\t\t\t: \"Requirements vary by jurisdiction. Always verify with local building department.\",\n\t\t\tdisclaimer:\n\t\t\t\t\"This is general guidance only. Consult actual code books and local jurisdiction for specific requirements.\",\n\t\t};\n\t},\n});\n\n/**\n * Get permit requirements for a specific type of work\n */\nexport const getPermitRequirementsTool = tool({\n\tdescription: `Determine if a permit is likely required for specific work and what type of permit. Helps field service companies understand when to pull permits and advise customers.\n\nReturns:\n- Whether permit is typically required\n- Type of permit needed\n- Common exceptions\n- Inspection requirements`,\n\tparameters: z.object({\n\t\tworkType: z.string().describe(\"Type of work being performed (e.g., 'water heater replacement', 'outlet installation')\"),\n\t\tpropertyType: z\n\t\t\t.enum([\"residential\", \"commercial\"])\n\t\t\t.optional()\n\t\t\t.default(\"residential\"),\n\t\tcity: z.string().optional().describe(\"City for jurisdiction-specific guidance\"),\n\t\tstate: z.string().optional().describe(\"State abbreviation\"),\n\t}),\n\texecute: async ({ workType, propertyType, city, state }) => {\n\t\tconst workLower = workType.toLowerCase();\n\n\t\t// Analyze work type to determine permit requirements\n\t\tlet permitRequired = false;\n\t\tlet permitType = \"unknown\";\n\t\tlet confidence = \"medium\";\n\t\tconst notes: string[] = [];\n\t\tconst inspections: string[] = [];\n\n\t\t// Electrical work\n\t\tif (\n\t\t\tworkLower.includes(\"outlet\") ||\n\t\t\tworkLower.includes(\"circuit\") ||\n\t\t\tworkLower.includes(\"panel\") ||\n\t\t\tworkLower.includes(\"electrical\") ||\n\t\t\tworkLower.includes(\"wire\") ||\n\t\t\tworkLower.includes(\"ev charger\")\n\t\t) {\n\t\t\tpermitRequired = true;\n\t\t\tpermitType = \"electrical\";\n\t\t\tinspections.push(\"Rough-in inspection\", \"Final inspection\");\n\t\t\tif (workLower.includes(\"panel\") || workLower.includes(\"service\")) {\n\t\t\t\tnotes.push(\"Service upgrades typically require utility coordination\");\n\t\t\t}\n\t\t}\n\n\t\t// Plumbing work\n\t\tif (\n\t\t\tworkLower.includes(\"water heater\") ||\n\t\t\tworkLower.includes(\"plumbing\") ||\n\t\t\tworkLower.includes(\"sewer\") ||\n\t\t\tworkLower.includes(\"drain\") ||\n\t\t\tworkLower.includes(\"fixture\")\n\t\t) {\n\t\t\tpermitRequired = true;\n\t\t\tpermitType = \"plumbing\";\n\t\t\tinspections.push(\"Rough-in inspection\", \"Final inspection\");\n\t\t\tif (workLower.includes(\"water heater\")) {\n\t\t\t\tnotes.push(\"Water heater permits often include gas and electrical inspections\");\n\t\t\t\tconfidence = \"high\";\n\t\t\t}\n\t\t}\n\n\t\t// HVAC work\n\t\tif (\n\t\t\tworkLower.includes(\"hvac\") ||\n\t\t\tworkLower.includes(\"furnace\") ||\n\t\t\tworkLower.includes(\"air condition\") ||\n\t\t\tworkLower.includes(\"ac \") ||\n\t\t\tworkLower.includes(\"heat pump\") ||\n\t\t\tworkLower.includes(\"mini-split\")\n\t\t) {\n\t\t\tpermitRequired = true;\n\t\t\tpermitType = \"mechanical\";\n\t\t\tinspections.push(\"Final inspection\");\n\t\t\tnotes.push(\"EPA certification required for refrigerant handling\");\n\t\t}\n\n\t\t// Roofing\n\t\tif (workLower.includes(\"roof\") || workLower.includes(\"re-roof\")) {\n\t\t\tpermitRequired = true;\n\t\t\tpermitType = \"building/roofing\";\n\t\t\tinspections.push(\"Final inspection\");\n\t\t\tnotes.push(\"Requirements vary significantly by jurisdiction - some exempt repairs under certain square footage\");\n\t\t\tconfidence = \"low\";\n\t\t}\n\n\t\t// Gas work\n\t\tif (\n\t\t\tworkLower.includes(\"gas line\") ||\n\t\t\tworkLower.includes(\"gas pipe\")\n\t\t) {\n\t\t\tpermitRequired = true;\n\t\t\tpermitType = \"gas/plumbing\";\n\t\t\tinspections.push(\"Pressure test inspection\", \"Final inspection\");\n\t\t\tnotes.push(\"Gas work requires licensed gas fitter in most jurisdictions\");\n\t\t\tconfidence = \"high\";\n\t\t}\n\n\t\t// Minor repairs generally don't require permits\n\t\tif (\n\t\t\tworkLower.includes(\"repair\") &&\n\t\t\t!workLower.includes(\"replace\") &&\n\t\t\t!workLower.includes(\"install\")\n\t\t) {\n\t\t\tpermitRequired = false;\n\t\t\tnotes.push(\"Minor repairs typically exempt, but verify with local jurisdiction\");\n\t\t\tconfidence = \"low\";\n\t\t}\n\n\t\t// Like-for-like replacements\n\t\tif (workLower.includes(\"like for like\") || workLower.includes(\"same location\")) {\n\t\t\tnotes.push(\"Like-for-like replacements may be exempt in some jurisdictions\");\n\t\t\tconfidence = \"low\";\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tworkType,\n\t\t\tpropertyType,\n\t\t\tlocation: city && state ? `${city}, ${state}` : state || \"Not specified\",\n\t\t\tpermitRequired,\n\t\t\tpermitType: permitRequired ? permitType : null,\n\t\t\tconfidence,\n\t\t\ttypicalInspections: permitRequired ? inspections : [],\n\t\t\tnotes,\n\t\t\trecommendations: permitRequired\n\t\t\t\t? [\n\t\t\t\t\t\t\"Contact local building department for specific requirements\",\n\t\t\t\t\t\t\"Have contractor license number ready\",\n\t\t\t\t\t\t\"Allow 1-3 business days for permit processing\",\n\t\t\t\t\t\t\"Schedule inspections in advance\",\n\t\t\t\t\t]\n\t\t\t\t: [\n\t\t\t\t\t\t\"Document work performed for records\",\n\t\t\t\t\t\t\"When in doubt, contact local building department\",\n\t\t\t\t\t],\n\t\t\tdisclaimer:\n\t\t\t\t\"Permit requirements vary by jurisdiction. Always verify with local building department.\",\n\t\t};\n\t},\n});\n\n/**\n * Get safety and code compliance checklist for a job type\n */\nexport const getCodeComplianceChecklistTool = tool({\n\tdescription: `Generate a code compliance and safety checklist for a specific type of job. Helps technicians ensure they're meeting code requirements during installation or repair.\n\nReturns a checklist of items to verify for code compliance.`,\n\tparameters: z.object({\n\t\tjobType: z.string().describe(\"Type of job (e.g., 'water heater installation', 'panel upgrade', 'AC replacement')\"),\n\t\tincludesSafety: z\n\t\t\t.boolean()\n\t\t\t.optional()\n\t\t\t.default(true)\n\t\t\t.describe(\"Include safety checklist items\"),\n\t}),\n\texecute: async ({ jobType, includesSafety }) => {\n\t\tconst jobLower = jobType.toLowerCase();\n\t\tconst checklist: Array<{ category: string; items: string[] }> = [];\n\n\t\t// Water heater specific\n\t\tif (\n\t\t\tjobLower.includes(\"water heater\") ||\n\t\t\tjobLower.includes(\"hot water\")\n\t\t) {\n\t\t\tchecklist.push({\n\t\t\t\tcategory: \"Temperature & Pressure Relief\",\n\t\t\t\titems: [\n\t\t\t\t\t\"T&P relief valve installed in top 6 inches of tank\",\n\t\t\t\t\t\"Discharge pipe routes to within 6 inches of floor\",\n\t\t\t\t\t\"Discharge pipe same size as valve outlet\",\n\t\t\t\t\t\"No valves or restrictions in discharge line\",\n\t\t\t\t],\n\t\t\t});\n\t\t\tchecklist.push({\n\t\t\t\tcategory: \"Seismic & Stability\",\n\t\t\t\titems: [\n\t\t\t\t\t\"Seismic straps installed (required in seismic zones)\",\n\t\t\t\t\t\"Unit stable and level\",\n\t\t\t\t\t\"Proper clearances maintained\",\n\t\t\t\t],\n\t\t\t});\n\t\t\tchecklist.push({\n\t\t\t\tcategory: \"Connections\",\n\t\t\t\titems: [\n\t\t\t\t\t\"Proper venting for gas units (draft hood, flue)\",\n\t\t\t\t\t\"Gas shutoff valve accessible\",\n\t\t\t\t\t\"Sediment trap on gas line\",\n\t\t\t\t\t\"Dielectric unions on water connections\",\n\t\t\t\t\t\"Expansion tank installed if closed system\",\n\t\t\t\t],\n\t\t\t});\n\t\t}\n\n\t\t// Electrical panel/service\n\t\tif (\n\t\t\tjobLower.includes(\"panel\") ||\n\t\t\tjobLower.includes(\"electrical\") ||\n\t\t\tjobLower.includes(\"breaker\")\n\t\t) {\n\t\t\tchecklist.push({\n\t\t\t\tcategory: \"Panel Requirements\",\n\t\t\t\titems: [\n\t\t\t\t\t\"36-inch clearance in front of panel\",\n\t\t\t\t\t\"30-inch width clearance\",\n\t\t\t\t\t\"78-inch height clearance\",\n\t\t\t\t\t\"Panel cover intact and secured\",\n\t\t\t\t\t\"All breakers labeled\",\n\t\t\t\t\t\"No exposed conductors\",\n\t\t\t\t],\n\t\t\t});\n\t\t\tchecklist.push({\n\t\t\t\tcategory: \"Grounding & Bonding\",\n\t\t\t\titems: [\n\t\t\t\t\t\"Ground rod(s) installed\",\n\t\t\t\t\t\"Bonding jumper at water heater\",\n\t\t\t\t\t\"CSST gas line bonded (if applicable)\",\n\t\t\t\t\t\"Grounding electrode conductor sized properly\",\n\t\t\t\t],\n\t\t\t});\n\t\t}\n\n\t\t// HVAC\n\t\tif (\n\t\t\tjobLower.includes(\"hvac\") ||\n\t\t\tjobLower.includes(\"furnace\") ||\n\t\t\tjobLower.includes(\"ac\") ||\n\t\t\tjobLower.includes(\"heat pump\")\n\t\t) {\n\t\t\tchecklist.push({\n\t\t\t\tcategory: \"Equipment Installation\",\n\t\t\t\titems: [\n\t\t\t\t\t\"Clearances from combustibles maintained\",\n\t\t\t\t\t\"Condensate drain properly routed\",\n\t\t\t\t\t\"Secondary drain pan with float switch (if in attic)\",\n\t\t\t\t\t\"Filter access provided\",\n\t\t\t\t\t\"Disconnect within sight of unit\",\n\t\t\t\t],\n\t\t\t});\n\t\t\tchecklist.push({\n\t\t\t\tcategory: \"Ductwork & Airflow\",\n\t\t\t\titems: [\n\t\t\t\t\t\"Supply and return balanced\",\n\t\t\t\t\t\"Duct connections sealed\",\n\t\t\t\t\t\"No kinks in flex duct\",\n\t\t\t\t\t\"Adequate return air\",\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (jobLower.includes(\"gas\") || jobLower.includes(\"furnace\")) {\n\t\t\t\tchecklist.push({\n\t\t\t\t\tcategory: \"Gas & Combustion\",\n\t\t\t\t\titems: [\n\t\t\t\t\t\t\"Combustion air adequate\",\n\t\t\t\t\t\t\"Gas pressure verified\",\n\t\t\t\t\t\t\"CO testing performed\",\n\t\t\t\t\t\t\"Heat exchanger inspected\",\n\t\t\t\t\t],\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Safety checklist\n\t\tif (includesSafety) {\n\t\t\tchecklist.push({\n\t\t\t\tcategory: \"General Safety\",\n\t\t\t\titems: [\n\t\t\t\t\t\"Work area secured and clean\",\n\t\t\t\t\t\"PPE used appropriately\",\n\t\t\t\t\t\"All utilities verified off before work\",\n\t\t\t\t\t\"Test equipment calibrated\",\n\t\t\t\t\t\"Customer informed of work\",\n\t\t\t\t],\n\t\t\t});\n\t\t}\n\n\t\t// If no specific checklist matched, provide general\n\t\tif (checklist.length === (includesSafety ? 1 : 0)) {\n\t\t\tchecklist.unshift({\n\t\t\t\tcategory: \"General Code Compliance\",\n\t\t\t\titems: [\n\t\t\t\t\t\"Work matches permit scope (if applicable)\",\n\t\t\t\t\t\"Materials meet code requirements\",\n\t\t\t\t\t\"Manufacturer installation instructions followed\",\n\t\t\t\t\t\"All connections secure\",\n\t\t\t\t\t\"System tested and operational\",\n\t\t\t\t\t\"Area cleaned up\",\n\t\t\t\t],\n\t\t\t});\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tjobType,\n\t\t\tchecklist,\n\t\t\ttotalItems: checklist.reduce((sum, cat) => sum + cat.items.length, 0),\n\t\t\treminder:\n\t\t\t\t\"Document completion of each item. Photos recommended for permit inspections.\",\n\t\t\tdisclaimer:\n\t\t\t\t\"This checklist is general guidance. Refer to local codes and manufacturer instructions.\",\n\t\t};\n\t},\n});\n\n// =============================================================================\n// PROACTIVE LEARNING SYSTEM - Auto-learn from customer interactions\n// =============================================================================\n\n/**\n * Analyze recent communications to extract learnings\n *\n * Scans recent communications and extracts insights that can be stored\n * to memory for future reference\n */\nexport const analyzeRecentCommunicationsTool = tool({\n\tdescription: `Proactively analyze recent customer communications to extract insights and learnings. Scans the last N days of communications and identifies:\n- Customer preferences mentioned in calls/emails\n- Common issues or complaints\n- Positive feedback and compliments\n- Service requests patterns\n- Emergency situations or urgent needs\n\nUse this for periodic learning runs to build customer knowledge.`,\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company ID\"),\n\t\tdaysBack: z\n\t\t\t.number()\n\t\t\t.optional()\n\t\t\t.default(7)\n\t\t\t.describe(\"Number of days to look back\"),\n\t\tlimit: z\n\t\t\t.number()\n\t\t\t.optional()\n\t\t\t.default(50)\n\t\t\t.describe(\"Maximum communications to analyze\"),\n\t\tfocusArea: z\n\t\t\t.enum([\"all\", \"preferences\", \"issues\", \"feedback\", \"urgent\"])\n\t\t\t.optional()\n\t\t\t.default(\"all\")\n\t\t\t.describe(\"Focus on specific type of insights\"),\n\t}),\n\texecute: async ({ companyId, daysBack, limit, focusArea }) => {\n\t\tconst { createServiceSupabaseClient } = await import(\n\t\t\t\"@/lib/supabase/service-client\"\n\t\t);\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - daysBack);\n\n\t\t// Get recent communications with transcripts\n\t\tconst { data: comms, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\n\t\t\t\t`\n\t\t\t\tid,\n\t\t\t\tchannel,\n\t\t\t\tdirection,\n\t\t\t\tcall_transcript,\n\t\t\t\tcall_sentiment,\n\t\t\t\tbody_plain,\n\t\t\t\tcustomer_id,\n\t\t\t\tcreated_at,\n\t\t\t\tcustomer:customers!customer_id(id, name)\n\t\t\t`\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t.not(\"call_transcript\", \"is\", null)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tif (error || !comms) {\n\t\t\treturn { success: false, error: error?.message || \"No communications found\" };\n\t\t}\n\n\t\tconst insights: Array<{\n\t\t\tcustomerId: string | null;\n\t\t\tcustomerName: string | null;\n\t\t\ttype: string;\n\t\t\tcontent: string;\n\t\t\tsource: string;\n\t\t\timportance: \"low\" | \"medium\" | \"high\";\n\t\t}> = [];\n\n\t\t// Pattern matching for different insight types\n\t\tconst patterns = {\n\t\t\tpreferences: [\n\t\t\t\t/prefer[s]?\\s+([^.]+)/gi,\n\t\t\t\t/like[s]?\\s+([^.]+)/gi,\n\t\t\t\t/want[s]?\\s+([^.]+)/gi,\n\t\t\t\t/always\\s+([^.]+)/gi,\n\t\t\t\t/please\\s+([^.]+)/gi,\n\t\t\t],\n\t\t\tissues: [\n\t\t\t\t/problem[s]?\\s+with\\s+([^.]+)/gi,\n\t\t\t\t/issue[s]?\\s+with\\s+([^.]+)/gi,\n\t\t\t\t/not\\s+working\\s+([^.]+)/gi,\n\t\t\t\t/broken\\s+([^.]+)/gi,\n\t\t\t\t/complaint[s]?\\s+about\\s+([^.]+)/gi,\n\t\t\t\t/frustrated\\s+([^.]+)/gi,\n\t\t\t],\n\t\t\tfeedback: [\n\t\t\t\t/great\\s+([^.]+)/gi,\n\t\t\t\t/excellent\\s+([^.]+)/gi,\n\t\t\t\t/thank\\s+you\\s+for\\s+([^.]+)/gi,\n\t\t\t\t/appreciate\\s+([^.]+)/gi,\n\t\t\t\t/happy\\s+with\\s+([^.]+)/gi,\n\t\t\t],\n\t\t\turgent: [\n\t\t\t\t/emergency\\s+([^.]+)/gi,\n\t\t\t\t/urgent\\s+([^.]+)/gi,\n\t\t\t\t/asap\\s+([^.]+)/gi,\n\t\t\t\t/right\\s+away\\s+([^.]+)/gi,\n\t\t\t\t/immediately\\s+([^.]+)/gi,\n\t\t\t],\n\t\t};\n\n\t\tfor (const comm of comms) {\n\t\t\tconst content = comm.call_transcript || comm.body_plain || \"\";\n\t\t\tif (!content) continue;\n\n\t\t\tconst customer = comm.customer as { id: string; name: string } | null;\n\n\t\t\t// Extract insights based on focus area\n\t\t\tconst areasToScan =\n\t\t\t\tfocusArea === \"all\"\n\t\t\t\t\t? (Object.keys(patterns) as Array<keyof typeof patterns>)\n\t\t\t\t\t: [focusArea as keyof typeof patterns];\n\n\t\t\tfor (const area of areasToScan) {\n\t\t\t\tfor (const pattern of patterns[area] || []) {\n\t\t\t\t\tconst matches = content.matchAll(pattern);\n\t\t\t\t\tfor (const match of matches) {\n\t\t\t\t\t\tinsights.push({\n\t\t\t\t\t\t\tcustomerId: comm.customer_id,\n\t\t\t\t\t\t\tcustomerName: customer?.name || null,\n\t\t\t\t\t\t\ttype: area,\n\t\t\t\t\t\t\tcontent: match[0],\n\t\t\t\t\t\t\tsource: `${comm.channel} on ${new Date(comm.created_at).toLocaleDateString()}`,\n\t\t\t\t\t\t\timportance: area === \"urgent\" || area === \"issues\" ? \"high\" : \"medium\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Also flag negative sentiment calls\n\t\t\tif (\n\t\t\t\tcomm.call_sentiment &&\n\t\t\t\t[\"negative\", \"very_negative\"].includes(comm.call_sentiment)\n\t\t\t) {\n\t\t\t\tinsights.push({\n\t\t\t\t\tcustomerId: comm.customer_id,\n\t\t\t\t\tcustomerName: customer?.name || null,\n\t\t\t\t\ttype: \"sentiment\",\n\t\t\t\t\tcontent: `Negative sentiment detected in ${comm.channel} communication`,\n\t\t\t\t\tsource: `${comm.channel} on ${new Date(comm.created_at).toLocaleDateString()}`,\n\t\t\t\t\timportance: \"high\",\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcommunicationsAnalyzed: comms.length,\n\t\t\tdaysBack,\n\t\t\tfocusArea,\n\t\t\tinsightsFound: insights.length,\n\t\t\tinsights: insights.slice(0, 100), // Limit response size\n\t\t\tsummary: {\n\t\t\t\tbyType: {\n\t\t\t\t\tpreferences: insights.filter((i) => i.type === \"preferences\").length,\n\t\t\t\t\tissues: insights.filter((i) => i.type === \"issues\").length,\n\t\t\t\t\tfeedback: insights.filter((i) => i.type === \"feedback\").length,\n\t\t\t\t\turgent: insights.filter((i) => i.type === \"urgent\").length,\n\t\t\t\t\tsentiment: insights.filter((i) => i.type === \"sentiment\").length,\n\t\t\t\t},\n\t\t\t\thighImportance: insights.filter((i) => i.importance === \"high\").length,\n\t\t\t},\n\t\t};\n\t},\n});\n\n/**\n * Learn from completed jobs to improve future recommendations\n */\nexport const learnFromCompletedJobsTool = tool({\n\tdescription: `Analyze completed jobs to learn patterns about:\n- Common job durations by type\n- Frequently used materials\n- Customer satisfaction indicators\n- Technician performance patterns\n- Seasonal job patterns\n\nHelps improve scheduling and resource allocation.`,\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company ID\"),\n\t\tdaysBack: z\n\t\t\t.number()\n\t\t\t.optional()\n\t\t\t.default(30)\n\t\t\t.describe(\"Days to look back\"),\n\t\tjobType: z\n\t\t\t.string()\n\t\t\t.optional()\n\t\t\t.describe(\"Filter by job type\"),\n\t}),\n\texecute: async ({ companyId, daysBack, jobType }) => {\n\t\tconst { createServiceSupabaseClient } = await import(\n\t\t\t\"@/lib/supabase/service-client\"\n\t\t);\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - daysBack);\n\n\t\tlet query = supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\n\t\t\t\t`\n\t\t\t\tid,\n\t\t\t\ttitle,\n\t\t\t\tjob_type,\n\t\t\t\tstatus,\n\t\t\t\tscheduled_start,\n\t\t\t\tscheduled_end,\n\t\t\t\tactual_start,\n\t\t\t\tactual_end,\n\t\t\t\ttotal_amount,\n\t\t\t\tcustomer:customers!customer_id(name),\n\t\t\t\tproperty:properties!property_id(address_line1, city)\n\t\t\t`\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"completed\")\n\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(100);\n\n\t\tif (jobType) {\n\t\t\tquery = query.eq(\"job_type\", jobType);\n\t\t}\n\n\t\tconst { data: jobs, error } = await query;\n\n\t\tif (error || !jobs) {\n\t\t\treturn { success: false, error: error?.message || \"No jobs found\" };\n\t\t}\n\n\t\t// Analyze job patterns\n\t\tconst durationAnalysis: Record<string, number[]> = {};\n\t\tconst revenueAnalysis: Record<string, number[]> = {};\n\t\tconst accuracyAnalysis: Array<{\n\t\t\tjobType: string;\n\t\t\tscheduledMinutes: number;\n\t\t\tactualMinutes: number;\n\t\t\taccuracy: number;\n\t\t}> = [];\n\n\t\tfor (const job of jobs) {\n\t\t\tconst type = job.job_type || \"unknown\";\n\n\t\t\t// Duration analysis\n\t\t\tif (job.actual_start && job.actual_end) {\n\t\t\t\tconst actualMinutes =\n\t\t\t\t\t(new Date(job.actual_end).getTime() -\n\t\t\t\t\t\tnew Date(job.actual_start).getTime()) /\n\t\t\t\t\t60000;\n\t\t\t\tif (!durationAnalysis[type]) durationAnalysis[type] = [];\n\t\t\t\tdurationAnalysis[type].push(actualMinutes);\n\n\t\t\t\t// Scheduling accuracy\n\t\t\t\tif (job.scheduled_start && job.scheduled_end) {\n\t\t\t\t\tconst scheduledMinutes =\n\t\t\t\t\t\t(new Date(job.scheduled_end).getTime() -\n\t\t\t\t\t\t\tnew Date(job.scheduled_start).getTime()) /\n\t\t\t\t\t\t60000;\n\t\t\t\t\taccuracyAnalysis.push({\n\t\t\t\t\t\tjobType: type,\n\t\t\t\t\t\tscheduledMinutes,\n\t\t\t\t\t\tactualMinutes,\n\t\t\t\t\t\taccuracy: Math.min(scheduledMinutes / actualMinutes, actualMinutes / scheduledMinutes) * 100,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Revenue analysis\n\t\t\tif (job.total_amount) {\n\t\t\t\tif (!revenueAnalysis[type]) revenueAnalysis[type] = [];\n\t\t\t\trevenueAnalysis[type].push(job.total_amount);\n\t\t\t}\n\t\t}\n\n\t\t// Calculate averages\n\t\tconst durationSummary: Record<\n\t\t\tstring,\n\t\t\t{ avg: number; min: number; max: number; count: number }\n\t\t> = {};\n\t\tfor (const [type, durations] of Object.entries(durationAnalysis)) {\n\t\t\tconst avg = durations.reduce((a, b) => a + b, 0) / durations.length;\n\t\t\tdurationSummary[type] = {\n\t\t\t\tavg: Math.round(avg),\n\t\t\t\tmin: Math.round(Math.min(...durations)),\n\t\t\t\tmax: Math.round(Math.max(...durations)),\n\t\t\t\tcount: durations.length,\n\t\t\t};\n\t\t}\n\n\t\tconst revenueSummary: Record<\n\t\t\tstring,\n\t\t\t{ avg: number; min: number; max: number; count: number }\n\t\t> = {};\n\t\tfor (const [type, amounts] of Object.entries(revenueAnalysis)) {\n\t\t\tconst avg = amounts.reduce((a, b) => a + b, 0) / amounts.length;\n\t\t\trevenueSummary[type] = {\n\t\t\t\tavg: Math.round(avg * 100) / 100,\n\t\t\t\tmin: Math.min(...amounts),\n\t\t\t\tmax: Math.max(...amounts),\n\t\t\t\tcount: amounts.length,\n\t\t\t};\n\t\t}\n\n\t\t// Scheduling accuracy summary\n\t\tconst avgAccuracy =\n\t\t\taccuracyAnalysis.length > 0\n\t\t\t\t? accuracyAnalysis.reduce((sum, a) => sum + a.accuracy, 0) /\n\t\t\t\t\taccuracyAnalysis.length\n\t\t\t\t: null;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tjobsAnalyzed: jobs.length,\n\t\t\tdaysBack,\n\t\t\tinsights: {\n\t\t\t\tdurationByType: durationSummary,\n\t\t\t\trevenueByType: revenueSummary,\n\t\t\t\tschedulingAccuracy: avgAccuracy\n\t\t\t\t\t? `${Math.round(avgAccuracy)}% average accuracy`\n\t\t\t\t\t: \"Insufficient data\",\n\t\t\t},\n\t\t\trecommendations: Object.entries(durationSummary).map(([type, stats]) => ({\n\t\t\t\tjobType: type,\n\t\t\t\trecommendedDuration: stats.avg,\n\t\t\t\tnote:\n\t\t\t\t\tstats.max > stats.avg * 1.5\n\t\t\t\t\t\t? `Consider allocating buffer time - some ${type} jobs take up to ${stats.max} minutes`\n\t\t\t\t\t\t: null,\n\t\t\t})),\n\t\t};\n\t},\n});\n\n/**\n * Build customer profile from all available data\n */\nexport const buildCustomerProfileTool = tool({\n\tdescription: `Build a comprehensive customer profile by aggregating all available data:\n- Communication history and sentiment\n- Job history and preferences\n- Payment history\n- Property information\n- Stored memories and notes\n\nUse this to prepare for customer interactions or to understand customer value.`,\n\tparameters: z.object({\n\t\tcustomerId: z.string().describe(\"Customer UUID\"),\n\t\tcompanyId: z.string().describe(\"Company ID\"),\n\t}),\n\texecute: async ({ customerId, companyId }) => {\n\t\tconst { createServiceSupabaseClient } = await import(\n\t\t\t\"@/lib/supabase/service-client\"\n\t\t);\n\t\tconst supabase = createServiceSupabaseClient();\n\n\t\t// Fetch all customer data in parallel\n\t\tconst [\n\t\t\tcustomerResult,\n\t\t\tjobsResult,\n\t\t\tcommsResult,\n\t\t\tinvoicesResult,\n\t\t\tmemoriesResult,\n\t\t] = await Promise.all([\n\t\t\tsupabase\n\t\t\t\t.from(\"customers\")\n\t\t\t\t.select(\"*\")\n\t\t\t\t.eq(\"id\", customerId)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.single(),\n\t\t\tsupabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\"id, title, job_type, status, total_amount, created_at\")\n\t\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t\t.limit(20),\n\t\t\tsupabase\n\t\t\t\t.from(\"communications\")\n\t\t\t\t.select(\"id, channel, direction, call_sentiment, created_at\")\n\t\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t\t.limit(50),\n\t\t\tsupabase\n\t\t\t\t.from(\"invoices\")\n\t\t\t\t.select(\"id, status, total, paid_amount, created_at\")\n\t\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t\t.limit(20),\n\t\t\tsupabase\n\t\t\t\t.from(\"ai_memory\")\n\t\t\t\t.select(\"content, memory_type, importance, created_at\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"entity_id\", customerId)\n\t\t\t\t.eq(\"entity_type\", \"customer\")\n\t\t\t\t.order(\"importance\", { ascending: false })\n\t\t\t\t.limit(20),\n\t\t]);\n\n\t\tconst customer = customerResult.data;\n\t\tconst jobs = jobsResult.data || [];\n\t\tconst comms = commsResult.data || [];\n\t\tconst invoices = invoicesResult.data || [];\n\t\tconst memories = memoriesResult.data || [];\n\n\t\tif (!customer) {\n\t\t\treturn { success: false, error: \"Customer not found\" };\n\t\t}\n\n\t\t// Analyze job history\n\t\tconst completedJobs = jobs.filter((j) => j.status === \"completed\");\n\t\tconst totalRevenue = jobs.reduce((sum, j) => sum + (j.total_amount || 0), 0);\n\t\tconst jobTypes = [...new Set(jobs.map((j) => j.job_type).filter(Boolean))];\n\n\t\t// Analyze communication sentiment\n\t\tconst sentiments = comms\n\t\t\t.map((c) => c.call_sentiment)\n\t\t\t.filter(Boolean);\n\t\tconst negativeSentiments = sentiments.filter(\n\t\t\t(s) => s === \"negative\" || s === \"very_negative\"\n\t\t).length;\n\t\tconst positiveSentiments = sentiments.filter(\n\t\t\t(s) => s === \"positive\" || s === \"very_positive\"\n\t\t).length;\n\n\t\t// Analyze payment behavior\n\t\tconst paidInvoices = invoices.filter((i) => i.status === \"paid\");\n\t\tconst overdueInvoices = invoices.filter((i) => i.status === \"overdue\");\n\t\tconst totalOwed = invoices\n\t\t\t.filter((i) => i.status !== \"paid\")\n\t\t\t.reduce((sum, i) => sum + ((i.total || 0) - (i.paid_amount || 0)), 0);\n\n\t\t// Customer tier based on revenue and history\n\t\tlet tier: \"new\" | \"regular\" | \"vip\" | \"at_risk\" = \"new\";\n\t\tif (completedJobs.length >= 5 && totalRevenue > 5000) {\n\t\t\ttier = \"vip\";\n\t\t} else if (completedJobs.length >= 2) {\n\t\t\ttier = \"regular\";\n\t\t}\n\t\tif (negativeSentiments > positiveSentiments || overdueInvoices.length > 2) {\n\t\t\ttier = \"at_risk\";\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcustomer: {\n\t\t\t\tid: customer.id,\n\t\t\t\tname: customer.name,\n\t\t\t\temail: customer.email,\n\t\t\t\tphone: customer.phone,\n\t\t\t\tcreatedAt: customer.created_at,\n\t\t\t},\n\t\t\ttier,\n\t\t\tjobHistory: {\n\t\t\t\ttotalJobs: jobs.length,\n\t\t\t\tcompletedJobs: completedJobs.length,\n\t\t\t\ttotalRevenue,\n\t\t\t\tcommonJobTypes: jobTypes,\n\t\t\t\trecentJobs: jobs.slice(0, 5).map((j) => ({\n\t\t\t\t\ttitle: j.title,\n\t\t\t\t\ttype: j.job_type,\n\t\t\t\t\tstatus: j.status,\n\t\t\t\t\tamount: j.total_amount,\n\t\t\t\t})),\n\t\t\t},\n\t\t\tcommunicationHistory: {\n\t\t\t\ttotalInteractions: comms.length,\n\t\t\t\tchannelBreakdown: {\n\t\t\t\t\tcalls: comms.filter((c) => c.channel === \"phone\").length,\n\t\t\t\t\temails: comms.filter((c) => c.channel === \"email\").length,\n\t\t\t\t\tsms: comms.filter((c) => c.channel === \"sms\").length,\n\t\t\t\t},\n\t\t\t\tsentimentSummary: {\n\t\t\t\t\tpositive: positiveSentiments,\n\t\t\t\t\tnegative: negativeSentiments,\n\t\t\t\t\tneutral: sentiments.length - positiveSentiments - negativeSentiments,\n\t\t\t\t},\n\t\t\t},\n\t\t\tfinancials: {\n\t\t\t\ttotalInvoices: invoices.length,\n\t\t\t\tpaidInvoices: paidInvoices.length,\n\t\t\t\toverdueInvoices: overdueInvoices.length,\n\t\t\t\tcurrentBalance: totalOwed,\n\t\t\t\tpaymentHealth:\n\t\t\t\t\toverdueInvoices.length === 0\n\t\t\t\t\t\t? \"good\"\n\t\t\t\t\t\t: overdueInvoices.length < 3\n\t\t\t\t\t\t\t? \"fair\"\n\t\t\t\t\t\t\t: \"poor\",\n\t\t\t},\n\t\t\tmemories: memories.map((m) => ({\n\t\t\t\tcontent: m.content,\n\t\t\t\ttype: m.memory_type,\n\t\t\t\timportance: m.importance,\n\t\t\t})),\n\t\t\trecommendations:\n\t\t\t\ttier === \"at_risk\"\n\t\t\t\t\t? [\n\t\t\t\t\t\t\t\"Review recent negative interactions\",\n\t\t\t\t\t\t\t\"Consider follow-up call to address concerns\",\n\t\t\t\t\t\t\t\"Check for outstanding payment issues\",\n\t\t\t\t\t\t]\n\t\t\t\t\t: tier === \"vip\"\n\t\t\t\t\t\t? [\n\t\t\t\t\t\t\t\t\"Prioritize this customer's requests\",\n\t\t\t\t\t\t\t\t\"Consider loyalty discount or perks\",\n\t\t\t\t\t\t\t\t\"Proactive maintenance reminders\",\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t: [\"Standard service approach\", \"Opportunity to build relationship\"],\n\t\t};\n\t},\n});\n\n// ============================================================================\n// ROUTE OPTIMIZATION TOOLS\n// Integration with routing-service.ts for directions and supplier finding\n// ============================================================================\n\n/**\n * Get driving route between two or more locations\n */\nexport const getRouteTool = tool({\n\tdescription:\n\t\t\"Calculate optimal driving route between locations with distance and duration\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\twaypoints: z\n\t\t\t.array(\n\t\t\t\tz.object({\n\t\t\t\t\taddress: z.string().describe(\"Full address\"),\n\t\t\t\t\tlat: z.number().optional().describe(\"Latitude if known\"),\n\t\t\t\t\tlng: z.number().optional().describe(\"Longitude if known\"),\n\t\t\t\t})\n\t\t\t)\n\t\t\t.min(2)\n\t\t\t.describe(\"Array of waypoints (minimum 2: origin and destination)\"),\n\t\toptimizeOrder: z\n\t\t\t.boolean()\n\t\t\t.optional()\n\t\t\t.default(false)\n\t\t\t.describe(\"Whether to optimize waypoint order for shortest route\"),\n\t}),\n\texecute: async ({ waypoints }) => {\n\t\t// Geocode any waypoints without coordinates\n\t\tconst geocodedWaypoints = await Promise.all(\n\t\t\twaypoints.map(async (wp) => {\n\t\t\t\tif (wp.lat && wp.lng) {\n\t\t\t\t\treturn { ...wp, coordinates: [wp.lng, wp.lat] as [number, number] };\n\t\t\t\t}\n\t\t\t\t// Use geocoding service (Nominatim requires User-Agent per ToS)\n\t\t\t\tconst geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(wp.address)}&limit=1`;\n\t\t\t\ttry {\n\t\t\t\t\tconst response = await fetch(geocodeUrl, {\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\"User-Agent\": \"Stratos-FSM/1.0 (https://stratos.app; support@stratos.app)\",\n\t\t\t\t\t\t\t\"Accept\": \"application/json\",\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tif (!response.ok) {\n\t\t\t\t\t\tconsole.warn(`Geocoding failed for ${wp.address}: ${response.status}`);\n\t\t\t\t\t\treturn { ...wp, coordinates: null };\n\t\t\t\t\t}\n\t\t\t\t\tconst data = await response.json();\n\t\t\t\t\tif (data.length > 0) {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t...wp,\n\t\t\t\t\t\t\tcoordinates: [\n\t\t\t\t\t\t\t\tparseFloat(data[0].lon),\n\t\t\t\t\t\t\t\tparseFloat(data[0].lat),\n\t\t\t\t\t\t\t] as [number, number],\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.warn(`Geocoding error for ${wp.address}:`, error);\n\t\t\t\t}\n\t\t\t\treturn { ...wp, coordinates: null };\n\t\t\t})\n\t\t);\n\n\t\tconst validWaypoints = geocodedWaypoints.filter((wp) => wp.coordinates);\n\t\tif (validWaypoints.length < 2) {\n\t\t\treturn { error: \"Could not geocode enough waypoints for routing\" };\n\t\t}\n\n\t\t// Get route from OpenRouteService (if API key available)\n\t\tconst apiKey = process.env.OPENROUTESERVICE_API_KEY;\n\t\tif (apiKey) {\n\t\t\ttry {\n\t\t\t\tconst coordinates = validWaypoints.map((wp) => wp.coordinates);\n\t\t\t\tconst response = await fetch(\n\t\t\t\t\t\"https://api.openrouteservice.org/v2/directions/driving-car/geojson\",\n\t\t\t\t\t{\n\t\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\tAuthorization: apiKey,\n\t\t\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\tbody: JSON.stringify({ coordinates, instructions: true }),\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\tconst routeData = await response.json();\n\n\t\t\t\tif (routeData.features?.[0]) {\n\t\t\t\t\tconst feature = routeData.features[0];\n\t\t\t\t\treturn {\n\t\t\t\t\t\tdistance_km: (feature.properties.summary.distance / 1000).toFixed(1),\n\t\t\t\t\t\tduration_minutes: Math.round(feature.properties.summary.duration / 60),\n\t\t\t\t\t\twaypoints: validWaypoints.map((wp) => wp.address),\n\t\t\t\t\t\tgeometry: feature.geometry,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Fall through to estimate\n\t\t\t}\n\t\t}\n\n\t\t// Fallback: Calculate straight-line distance estimate\n\t\tconst coords = validWaypoints.map((wp) => wp.coordinates!);\n\t\tlet totalDistance = 0;\n\t\tfor (let i = 0; i < coords.length - 1; i++) {\n\t\t\tconst [lon1, lat1] = coords[i];\n\t\t\tconst [lon2, lat2] = coords[i + 1];\n\t\t\tconst R = 6371;\n\t\t\tconst dLat = ((lat2 - lat1) * Math.PI) / 180;\n\t\t\tconst dLon = ((lon2 - lon1) * Math.PI) / 180;\n\t\t\tconst a =\n\t\t\t\tMath.sin(dLat / 2) * Math.sin(dLat / 2) +\n\t\t\t\tMath.cos((lat1 * Math.PI) / 180) *\n\t\t\t\t\tMath.cos((lat2 * Math.PI) / 180) *\n\t\t\t\t\tMath.sin(dLon / 2) *\n\t\t\t\t\tMath.sin(dLon / 2);\n\t\t\tconst c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\t\t\ttotalDistance += R * c;\n\t\t}\n\n\t\tconst drivingDistance = totalDistance * 1.3;\n\t\tconst durationMinutes = Math.round((drivingDistance / 50) * 60);\n\n\t\treturn {\n\t\t\tdistance_km: drivingDistance.toFixed(1),\n\t\t\tduration_minutes: durationMinutes,\n\t\t\twaypoints: validWaypoints.map((wp) => wp.address),\n\t\t\tnote: \"Estimated based on straight-line distance\",\n\t\t};\n\t},\n});\n\n/**\n * Find nearby suppliers (plumbing supply, electrical supply, etc.)\n */\nexport const findNearbySuppliersTool = tool({\n\tdescription: \"Find nearby supply stores for parts (plumbing, electrical, HVAC, hardware)\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\tlocation: z.object({\n\t\t\tlat: z.number().describe(\"Latitude\"),\n\t\t\tlng: z.number().describe(\"Longitude\"),\n\t\t}),\n\t\tsupplyType: z\n\t\t\t.enum([\"plumbing\", \"electrical\", \"hvac\", \"hardware\", \"all\"])\n\t\t\t.default(\"all\"),\n\t\tradiusKm: z.number().optional().default(10),\n\t}),\n\texecute: async ({ location, supplyType, radiusKm }) => {\n\t\tconst typeFilters: Record<string, string> = {\n\t\t\tplumbing: '[\"shop\"=\"trade\"][\"trade\"~\"plumbing|bathroom\"]',\n\t\t\telectrical: '[\"shop\"=\"trade\"][\"trade\"~\"electrical\"]',\n\t\t\thvac: '[\"shop\"=\"trade\"][\"trade\"~\"hvac|air_conditioning\"]',\n\t\t\thardware: '[\"shop\"=\"doityourself\"]',\n\t\t\tall: '[\"shop\"~\"trade|doityourself|hardware\"]',\n\t\t};\n\n\t\tconst filter = typeFilters[supplyType];\n\t\tconst query = `[out:json][timeout:25];(node${filter}(around:${radiusKm * 1000},${location.lat},${location.lng});way${filter}(around:${radiusKm * 1000},${location.lat},${location.lng}););out center;`;\n\n\t\ttry {\n\t\t\tconst response = await fetch(\"https://overpass-api.de/api/interpreter\", {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\tbody: query,\n\t\t\t});\n\t\t\tconst data = await response.json();\n\n\t\t\tconst suppliers = data.elements\n\t\t\t\t.map((el: { tags?: { name?: string; phone?: string; website?: string }; lat?: number; lon?: number; center?: { lat: number; lon: number } }) => ({\n\t\t\t\t\tname: el.tags?.name || \"Unknown Supplier\",\n\t\t\t\t\tphone: el.tags?.phone,\n\t\t\t\t\twebsite: el.tags?.website,\n\t\t\t\t\tlat: el.lat || el.center?.lat,\n\t\t\t\t\tlng: el.lon || el.center?.lon,\n\t\t\t\t}))\n\t\t\t\t.filter((s: { name: string }) => s.name !== \"Unknown Supplier\")\n\t\t\t\t.slice(0, 10);\n\n\t\t\treturn { suppliers, searchRadius: radiusKm, supplyType };\n\t\t} catch {\n\t\t\treturn { error: \"Failed to search for suppliers\" };\n\t\t}\n\t},\n});\n\n// ============================================================================\n// INVENTORY & PARTS TOOLS\n// ============================================================================\n\n/**\n * Search inventory for parts\n */\nexport const searchInventoryTool = tool({\n\tdescription: \"Search company inventory for parts by name, SKU, or category\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\tquery: z.string().describe(\"Search query\"),\n\t\tcategory: z.string().optional(),\n\t\tinStockOnly: z.boolean().optional().default(false),\n\t}),\n\texecute: async ({ companyId, query, category, inStockOnly }) => {\n\t\tconst supabase = await createClient();\n\n\t\tlet dbQuery = supabase\n\t\t\t.from(\"inventory\")\n\t\t\t.select(\"id, sku, name, description, category, quantity_on_hand, quantity_reserved, reorder_point, unit_cost, unit_price, location\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.or(`name.ilike.%${query}%,sku.ilike.%${query}%,description.ilike.%${query}%`);\n\n\t\tif (category) dbQuery = dbQuery.eq(\"category\", category);\n\t\tif (inStockOnly) dbQuery = dbQuery.gt(\"quantity_on_hand\", 0);\n\n\t\tconst { data, error } = await dbQuery.order(\"name\").limit(20);\n\t\tif (error) return { error: error.message };\n\n\t\treturn {\n\t\t\titems: data.map((item) => ({\n\t\t\t\t...item,\n\t\t\t\tavailable: item.quantity_on_hand - (item.quantity_reserved || 0),\n\t\t\t\tneedsReorder: item.quantity_on_hand <= (item.reorder_point || 0),\n\t\t\t})),\n\t\t\ttotal: data.length,\n\t\t};\n\t},\n});\n\n/**\n * Check parts availability for a job\n */\nexport const checkPartsAvailabilityTool = tool({\n\tdescription: \"Check if required parts are available in inventory for a job\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\tparts: z.array(\n\t\t\tz.object({\n\t\t\t\titemId: z.string().optional(),\n\t\t\t\tsku: z.string().optional(),\n\t\t\t\tname: z.string().optional(),\n\t\t\t\tquantity: z.number(),\n\t\t\t})\n\t\t),\n\t}),\n\texecute: async ({ companyId, parts }) => {\n\t\tif (!parts.length) {\n\t\t\treturn { error: \"At least one part is required\" };\n\t\t}\n\n\t\tconst supabase = await createClient();\n\n\t\t// Batch lookup: collect IDs and SKUs for a single query\n\t\tconst itemIds = parts.filter((p) => p.itemId).map((p) => p.itemId!);\n\t\tconst skus = parts.filter((p) => p.sku && !p.itemId).map((p) => p.sku!);\n\n\t\t// Fetch all matching inventory items in one query\n\t\tlet inventoryQuery = supabase\n\t\t\t.from(\"inventory\")\n\t\t\t.select(\"id, sku, name, quantity_on_hand, quantity_reserved, unit_cost, unit_price\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null);\n\n\t\t// Build OR conditions for batch lookup\n\t\tconst orConditions: string[] = [];\n\t\tif (itemIds.length > 0) {\n\t\t\torConditions.push(`id.in.(${itemIds.join(\",\")})`);\n\t\t}\n\t\tif (skus.length > 0) {\n\t\t\torConditions.push(`sku.in.(${skus.join(\",\")})`);\n\t\t}\n\n\t\tlet inventoryItems: { id: string; sku: string | null; name: string; quantity_on_hand: number; quantity_reserved: number | null; unit_cost: number | null; unit_price: number | null }[] = [];\n\n\t\tif (orConditions.length > 0) {\n\t\t\tconst { data } = await inventoryQuery.or(orConditions.join(\",\"));\n\t\t\tinventoryItems = data || [];\n\t\t}\n\n\t\t// For name-based lookups, we still need individual queries (fuzzy match)\n\t\tconst nameOnlyParts = parts.filter((p) => !p.itemId && !p.sku && p.name);\n\t\tif (nameOnlyParts.length > 0) {\n\t\t\tconst nameResults = await Promise.all(\n\t\t\t\tnameOnlyParts.map(async (part) => {\n\t\t\t\t\tconst { data } = await supabase\n\t\t\t\t\t\t.from(\"inventory\")\n\t\t\t\t\t\t.select(\"id, sku, name, quantity_on_hand, quantity_reserved, unit_cost, unit_price\")\n\t\t\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t\t\t.ilike(\"name\", `%${part.name}%`)\n\t\t\t\t\t\t.limit(1)\n\t\t\t\t\t\t.single();\n\t\t\t\t\treturn data;\n\t\t\t\t})\n\t\t\t);\n\t\t\tinventoryItems.push(...nameResults.filter((r): r is NonNullable<typeof r> => r !== null));\n\t\t}\n\n\t\t// Map results to parts\n\t\tconst results = parts.map((part) => {\n\t\t\tconst item = inventoryItems.find(\n\t\t\t\t(inv) =>\n\t\t\t\t\t(part.itemId && inv.id === part.itemId) ||\n\t\t\t\t\t(part.sku && inv.sku === part.sku) ||\n\t\t\t\t\t(part.name && inv.name.toLowerCase().includes(part.name.toLowerCase()))\n\t\t\t);\n\n\t\t\tif (!item) {\n\t\t\t\treturn { ...part, found: false, available: 0, canFulfill: false };\n\t\t\t}\n\n\t\t\tconst available = item.quantity_on_hand - (item.quantity_reserved || 0);\n\t\t\treturn {\n\t\t\t\titemId: item.id,\n\t\t\t\tsku: item.sku,\n\t\t\t\tname: item.name,\n\t\t\t\tfound: true,\n\t\t\t\tavailable,\n\t\t\t\tneeded: part.quantity,\n\t\t\t\tcanFulfill: available >= part.quantity,\n\t\t\t\tunitPrice: item.unit_price,\n\t\t\t\ttotalPrice: (item.unit_price || 0) * part.quantity,\n\t\t\t};\n\t\t});\n\n\t\treturn {\n\t\t\tallPartsAvailable: results.every((r) => r.canFulfill),\n\t\t\tparts: results,\n\t\t\tmissingParts: results.filter((r) => !r.canFulfill),\n\t\t\ttotalEstimatedPrice: results.reduce((sum, r) => sum + (r.totalPrice || 0), 0),\n\t\t};\n\t},\n});\n\n/**\n * Get low stock alerts\n */\nexport const getLowStockAlertsTool = tool({\n\tdescription: \"Get inventory items at or below reorder point\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\tcategory: z.string().optional(),\n\t\tlimit: z.number().optional().default(50).describe(\"Max items to return\"),\n\t}),\n\texecute: async ({ companyId, category, limit }) => {\n\t\tconst supabase = await createClient();\n\n\t\t// Use a raw filter to get only items where quantity <= reorder_point\n\t\tlet query = supabase\n\t\t\t.from(\"inventory\")\n\t\t\t.select(\"id, sku, name, category, quantity_on_hand, reorder_point, reorder_quantity, unit_cost\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.not(\"reorder_point\", \"is\", null);\n\n\t\tif (category) query = query.eq(\"category\", category);\n\n\t\tconst { data, error } = await query.order(\"quantity_on_hand\", { ascending: true }).limit(limit * 2);\n\t\tif (error) return { error: error.message };\n\n\t\t// Filter for items at or below reorder point and limit\n\t\tconst lowStockItems = data\n\t\t\t.filter((item) => item.quantity_on_hand <= (item.reorder_point || 0))\n\t\t\t.slice(0, limit)\n\t\t\t.map((item) => ({\n\t\t\t\t...item,\n\t\t\t\tshortfall: (item.reorder_point || 0) - item.quantity_on_hand,\n\t\t\t\tsuggestedOrderQty: item.reorder_quantity || 10,\n\t\t\t\turgency: item.quantity_on_hand === 0 ? \"critical\" : item.quantity_on_hand <= (item.reorder_point || 0) / 2 ? \"high\" : \"normal\",\n\t\t\t}));\n\n\t\treturn {\n\t\t\tlowStockCount: lowStockItems.length,\n\t\t\titems: lowStockItems,\n\t\t\tcriticalCount: lowStockItems.filter((i) => i.urgency === \"critical\").length,\n\t\t};\n\t},\n});\n\n// ============================================================================\n// EQUIPMENT HISTORY TOOLS\n// ============================================================================\n\n/**\n * Get equipment at a property\n */\nexport const getPropertyEquipmentTool = tool({\n\tdescription: \"Get list of equipment installed at a customer's property\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\tpropertyId: z.string().optional(),\n\t\tcustomerId: z.string().optional(),\n\t}),\n\texecute: async ({ companyId, propertyId, customerId }) => {\n\t\t// Validate: at least one filter is required\n\t\tif (!propertyId && !customerId) {\n\t\t\treturn { error: \"Either propertyId or customerId is required\" };\n\t\t}\n\n\t\tconst supabase = await createClient();\n\n\t\tlet query = supabase\n\t\t\t.from(\"equipment\")\n\t\t\t.select(\"id, name, model_number, serial_number, manufacturer, install_date, warranty_expiry, last_service_date, next_service_due, status, notes\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null);\n\n\t\tif (propertyId) {\n\t\t\tquery = query.eq(\"property_id\", propertyId);\n\t\t} else if (customerId) {\n\t\t\tconst { data: properties } = await supabase\n\t\t\t\t.from(\"properties\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t\t.is(\"deleted_at\", null);\n\t\t\tif (!properties?.length) {\n\t\t\t\treturn { equipment: [], total: 0, message: \"No properties found for this customer\" };\n\t\t\t}\n\t\t\tquery = query.in(\"property_id\", properties.map((p) => p.id));\n\t\t}\n\n\t\tconst { data, error } = await query.order(\"name\").limit(100);\n\t\tif (error) return { error: error.message };\n\n\t\tconst now = new Date();\n\t\treturn {\n\t\t\tequipment: data.map((eq) => ({\n\t\t\t\t...eq,\n\t\t\t\twarrantyStatus: eq.warranty_expiry\n\t\t\t\t\t? new Date(eq.warranty_expiry) > now ? \"active\" : \"expired\"\n\t\t\t\t\t: \"unknown\",\n\t\t\t\tserviceDue: eq.next_service_due ? new Date(eq.next_service_due) <= now : false,\n\t\t\t})),\n\t\t\ttotal: data.length,\n\t\t};\n\t},\n});\n\n/**\n * Get service history for specific equipment\n */\nexport const getEquipmentServiceHistoryTool = tool({\n\tdescription: \"Get service history for a specific piece of equipment\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\tequipmentId: z.string().describe(\"Equipment UUID\"),\n\t\tlimit: z.number().optional().default(10),\n\t}),\n\texecute: async ({ companyId, equipmentId, limit }) => {\n\t\tconst supabase = await createClient();\n\n\t\tconst { data: equipment } = await supabase\n\t\t\t.from(\"equipment\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"id\", equipmentId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!equipment) return { error: \"Equipment not found\" };\n\n\t\tconst { data: serviceHistory } = await supabase\n\t\t\t.from(\"job_equipment\")\n\t\t\t.select(\"job:jobs(id, title, status, completed_at), notes, work_performed, created_at\")\n\t\t\t.eq(\"equipment_id\", equipmentId)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\treturn {\n\t\t\tequipment: {\n\t\t\t\tid: equipment.id,\n\t\t\t\tname: equipment.name,\n\t\t\t\tmodel: equipment.model_number,\n\t\t\t\tserial: equipment.serial_number,\n\t\t\t},\n\t\t\tserviceHistory: serviceHistory || [],\n\t\t\ttotalServices: serviceHistory?.length || 0,\n\t\t};\n\t},\n});\n\n/**\n * Check equipment warranty status\n */\nexport const checkEquipmentWarrantyTool = tool({\n\tdescription: \"Check warranty status for equipment\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\tequipmentId: z.string().describe(\"Equipment UUID\"),\n\t}),\n\texecute: async ({ companyId, equipmentId }) => {\n\t\tconst supabase = await createClient();\n\n\t\tconst { data: equipment, error } = await supabase\n\t\t\t.from(\"equipment\")\n\t\t\t.select(\"id, name, model_number, serial_number, warranty_expiry, warranty_type, warranty_notes\")\n\t\t\t.eq(\"id\", equipmentId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error || !equipment) return { error: \"Equipment not found\" };\n\n\t\tconst now = new Date();\n\t\tconst warrantyEnd = equipment.warranty_expiry ? new Date(equipment.warranty_expiry) : null;\n\t\tlet status: \"active\" | \"expired\" | \"expiring_soon\" | \"unknown\" = \"unknown\";\n\t\tlet daysRemaining = null;\n\n\t\tif (warrantyEnd) {\n\t\t\tdaysRemaining = Math.ceil((warrantyEnd.getTime() - now.getTime()) / (24 * 60 * 60 * 1000));\n\t\t\tstatus = daysRemaining < 0 ? \"expired\" : daysRemaining <= 30 ? \"expiring_soon\" : \"active\";\n\t\t}\n\n\t\treturn {\n\t\t\tequipment: { name: equipment.name, model: equipment.model_number, serial: equipment.serial_number },\n\t\t\twarranty: {\n\t\t\t\tstatus,\n\t\t\t\texpiryDate: equipment.warranty_expiry,\n\t\t\t\tdaysRemaining: daysRemaining && daysRemaining > 0 ? daysRemaining : 0,\n\t\t\t\ttype: equipment.warranty_type,\n\t\t\t},\n\t\t};\n\t},\n});\n\n// ============================================================================\n// TECHNICIAN MATCHING TOOLS\n// ============================================================================\n\n/**\n * Find technicians by skills\n */\nexport const findTechniciansBySkillsTool = tool({\n\tdescription: \"Find available technicians with specific skills or certifications\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\tskills: z.array(z.string()).optional(),\n\t\tcertifications: z.array(z.string()).optional(),\n\t\tdate: z.string().optional().describe(\"Date to check availability\"),\n\t}),\n\texecute: async ({ companyId, skills, certifications, date }) => {\n\t\ttry {\n\t\t\tconst supabase = await createClient();\n\n\t\t\tconst { data: members, error } = await supabase\n\t\t\t\t.from(\"company_memberships\")\n\t\t\t\t.select(\"id, role, skills, certifications, service_areas, user:users(id, first_name, last_name, email)\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"role\", \"technician\");\n\n\t\t\tif (error) return { error: error.message };\n\n\t\t\tlet filtered = members;\n\t\t\tif (skills?.length) {\n\t\t\t\tfiltered = filtered.filter((m) =>\n\t\t\t\t\tskills.some((skill) =>\n\t\t\t\t\t\t((m.skills as string[]) || []).map((s) => s.toLowerCase()).includes(skill.toLowerCase())\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t}\n\t\t\tif (certifications?.length) {\n\t\t\t\tfiltered = filtered.filter((m) =>\n\t\t\t\t\tcertifications.some((cert) =>\n\t\t\t\t\t\t((m.certifications as string[]) || []).map((c) => c.toLowerCase()).includes(cert.toLowerCase())\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (date) {\n\t\t\t\tconst dayStart = new Date(date);\n\t\t\t\tdayStart.setHours(0, 0, 0, 0);\n\t\t\t\tconst dayEnd = new Date(date);\n\t\t\t\tdayEnd.setHours(23, 59, 59, 999);\n\n\t\t\t\tconst { data: assignments } = await supabase\n\t\t\t\t\t.from(\"jobs\")\n\t\t\t\t\t.select(\"assigned_to\")\n\t\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t\t.in(\"assigned_to\", filtered.map((m) => m.id))\n\t\t\t\t\t.gte(\"scheduled_start\", dayStart.toISOString())\n\t\t\t\t\t.lte(\"scheduled_start\", dayEnd.toISOString());\n\n\t\t\t\tconst jobCounts: Record<string, number> = {};\n\t\t\t\tassignments?.forEach((a) => {\n\t\t\t\t\tif (a.assigned_to) jobCounts[a.assigned_to] = (jobCounts[a.assigned_to] || 0) + 1;\n\t\t\t\t});\n\n\t\t\t\tfiltered = filtered.map((m) => ({\n\t\t\t\t\t...m,\n\t\t\t\t\tjobsOnDate: jobCounts[m.id] || 0,\n\t\t\t\t\tavailability: (jobCounts[m.id] || 0) === 0 ? \"available\" : (jobCounts[m.id] || 0) < 4 ? \"partially_booked\" : \"fully_booked\",\n\t\t\t\t}));\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttechnicians: filtered.map((m) => ({\n\t\t\t\t\tid: m.id,\n\t\t\t\t\tname: `${(m.user as { first_name: string; last_name: string })?.first_name} ${(m.user as { first_name: string; last_name: string })?.last_name}`,\n\t\t\t\t\tskills: m.skills,\n\t\t\t\t\tcertifications: m.certifications,\n\t\t\t\t\tavailability: (m as { availability?: string }).availability,\n\t\t\t\t})),\n\t\t\t\ttotal: filtered.length,\n\t\t\t};\n\t\t} catch (err) {\n\t\t\treturn { error: err instanceof Error ? err.message : \"Failed to find technicians\" };\n\t\t}\n\t},\n});\n\n/**\n * Get technician workload\n */\nexport const getTechnicianWorkloadTool = tool({\n\tdescription: \"Get a technician's current workload and schedule\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\ttechnicianId: z.string().describe(\"Technician membership UUID\"),\n\t\tstartDate: z.string(),\n\t\tendDate: z.string(),\n\t}),\n\texecute: async ({ companyId, technicianId, startDate, endDate }) => {\n\t\ttry {\n\t\t\tconst supabase = await createClient();\n\n\t\t\tconst { data: tech } = await supabase\n\t\t\t\t.from(\"company_memberships\")\n\t\t\t\t.select(\"id, user:users(first_name, last_name)\")\n\t\t\t\t.eq(\"id\", technicianId)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.single();\n\n\t\t\tif (!tech) return { error: \"Technician not found\" };\n\n\t\t\tconst { data: jobs } = await supabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\"id, title, status, scheduled_start, scheduled_end, customer:customers(name)\")\n\t\t\t\t.eq(\"assigned_to\", technicianId)\n\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t.gte(\"scheduled_start\", startDate)\n\t\t\t\t.lte(\"scheduled_start\", endDate)\n\t\t\t\t.order(\"scheduled_start\");\n\n\t\t\treturn {\n\t\t\t\ttechnician: { id: tech.id, name: `${(tech.user as { first_name: string; last_name: string })?.first_name} ${(tech.user as { first_name: string; last_name: string })?.last_name}` },\n\t\t\t\tsummary: {\n\t\t\t\t\ttotalJobs: jobs?.length || 0,\n\t\t\t\t\tcompleted: jobs?.filter((j) => j.status === \"completed\").length || 0,\n\t\t\t\t\tscheduled: jobs?.filter((j) => j.status === \"scheduled\").length || 0,\n\t\t\t\t},\n\t\t\t\tjobs: jobs?.map((j) => ({\n\t\t\t\t\tid: j.id,\n\t\t\t\t\ttitle: j.title,\n\t\t\t\t\tstatus: j.status,\n\t\t\t\t\tscheduledStart: j.scheduled_start,\n\t\t\t\t\tcustomer: (j.customer as { name: string })?.name,\n\t\t\t\t})) || [],\n\t\t\t};\n\t\t} catch (err) {\n\t\t\treturn { error: err instanceof Error ? err.message : \"Failed to get technician workload\" };\n\t\t}\n\t},\n});\n\n// ============================================================================\n// PRICING & ESTIMATION TOOLS\n// ============================================================================\n\n/**\n * Search price book for services\n */\nexport const searchPriceBookTool = tool({\n\tdescription: \"Search price book for services, parts, and flat-rate pricing\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\tquery: z.string(),\n\t\tcategory: z.string().optional(),\n\t}),\n\texecute: async ({ companyId, query, category }) => {\n\t\tconst supabase = await createClient();\n\n\t\tlet dbQuery = supabase\n\t\t\t.from(\"price_book_items\")\n\t\t\t.select(\"id, name, description, category, sku, unit_price, cost, is_active\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"is_active\", true)\n\t\t\t.or(`name.ilike.%${query}%,description.ilike.%${query}%,sku.ilike.%${query}%`);\n\n\t\tif (category) dbQuery = dbQuery.eq(\"category\", category);\n\t\tconst { data, error } = await dbQuery.order(\"name\").limit(20);\n\t\tif (error) return { error: error.message };\n\n\t\treturn {\n\t\t\titems: data.map((item) => ({\n\t\t\t\t...item,\n\t\t\t\tprofit: item.unit_price - (item.cost || 0),\n\t\t\t})),\n\t\t\ttotal: data.length,\n\t\t};\n\t},\n});\n\n/**\n * Calculate estimate from price book items\n */\nexport const calculateEstimateTool = tool({\n\tdescription: \"Calculate an estimate total from price book items\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\titems: z.array(\n\t\t\tz.object({\n\t\t\t\tpriceBookItemId: z.string().optional(),\n\t\t\t\tname: z.string().optional(),\n\t\t\t\tquantity: z.number().default(1),\n\t\t\t\tcustomPrice: z.number().optional(),\n\t\t\t})\n\t\t),\n\t\tdiscount: z.object({ type: z.enum([\"percentage\", \"fixed\"]), value: z.number() }).optional(),\n\t\ttaxRate: z.number().optional(),\n\t}),\n\texecute: async ({ companyId, items, discount, taxRate }) => {\n\t\tconst supabase = await createClient();\n\n\t\tconst priceBookIds = items.filter((i) => i.priceBookItemId).map((i) => i.priceBookItemId);\n\t\tlet priceBookItems: { id: string; name: string; unit_price: number; cost: number | null }[] = [];\n\t\tif (priceBookIds.length > 0) {\n\t\t\tconst { data } = await supabase.from(\"price_book_items\").select(\"id, name, unit_price, cost\").in(\"id\", priceBookIds);\n\t\t\tpriceBookItems = data || [];\n\t\t}\n\n\t\tconst lineItems = items.map((item) => {\n\t\t\tconst pbItem = priceBookItems.find((p) => p.id === item.priceBookItemId);\n\t\t\tconst unitPrice = item.customPrice || pbItem?.unit_price || 0;\n\t\t\treturn {\n\t\t\t\tname: item.name || pbItem?.name || \"Unknown Item\",\n\t\t\t\tquantity: item.quantity,\n\t\t\t\tunitPrice,\n\t\t\t\tlineTotal: unitPrice * item.quantity,\n\t\t\t};\n\t\t});\n\n\t\tconst subtotal = lineItems.reduce((sum, item) => sum + item.lineTotal, 0);\n\t\tlet discountAmount = 0;\n\t\tif (discount) {\n\t\t\tdiscountAmount = discount.type === \"percentage\" ? subtotal * (discount.value / 100) : discount.value;\n\t\t}\n\t\tconst afterDiscount = subtotal - discountAmount;\n\t\tconst taxAmount = afterDiscount * ((taxRate || 0) / 100);\n\n\t\treturn {\n\t\t\tlineItems,\n\t\t\tsubtotal,\n\t\t\tdiscount: discountAmount > 0 ? { ...discount, amount: discountAmount } : null,\n\t\t\ttax: { rate: taxRate || 0, amount: taxAmount },\n\t\t\tgrandTotal: afterDiscount + taxAmount,\n\t\t};\n\t},\n});\n\n// ============================================================================\n// SMART SCHEDULING TOOLS\n// ============================================================================\n\n/**\n * Suggest best technician for a job\n */\nexport const suggestTechnicianForJobTool = tool({\n\tdescription: \"Suggest the best technician for a job based on skills, location, and availability\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\tjobType: z.string(),\n\t\trequiredSkills: z.array(z.string()).optional(),\n\t\tpreferredDate: z.string(),\n\t}),\n\texecute: async ({ companyId, jobType, requiredSkills, preferredDate }) => {\n\t\ttry {\n\t\t\tconst supabase = await createClient();\n\n\t\t\tconst { data: technicians } = await supabase\n\t\t\t\t.from(\"company_memberships\")\n\t\t\t\t.select(\"id, skills, preferred_job_types, user:users(first_name, last_name)\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"role\", \"technician\");\n\n\t\t\tif (!technicians?.length) return { error: \"No technicians found\" };\n\n\t\t\tconst dayStart = new Date(preferredDate);\n\t\t\tdayStart.setHours(0, 0, 0, 0);\n\t\t\tconst dayEnd = new Date(preferredDate);\n\t\t\tdayEnd.setHours(23, 59, 59, 999);\n\n\t\t\tconst { data: existingJobs } = await supabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\"assigned_to\")\n\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t.in(\"assigned_to\", technicians.map((t) => t.id))\n\t\t\t\t.gte(\"scheduled_start\", dayStart.toISOString())\n\t\t\t\t.lte(\"scheduled_start\", dayEnd.toISOString());\n\n\t\t\tconst jobCounts: Record<string, number> = {};\n\t\t\texistingJobs?.forEach((j) => {\n\t\t\t\tif (j.assigned_to) jobCounts[j.assigned_to] = (jobCounts[j.assigned_to] || 0) + 1;\n\t\t\t});\n\n\t\t\tconst scored = technicians.map((tech) => {\n\t\t\t\tlet score = 0;\n\t\t\t\tconst reasons: string[] = [];\n\n\t\t\t\tconst techSkills = ((tech.skills as string[]) || []).map((s) => s.toLowerCase());\n\t\t\t\tconst matchedSkills = (requiredSkills || []).filter((s) => techSkills.includes(s.toLowerCase()));\n\t\t\t\tif (matchedSkills.length > 0) {\n\t\t\t\t\tscore += 40 * (matchedSkills.length / (requiredSkills?.length || 1));\n\t\t\t\t\treasons.push(`Matches ${matchedSkills.length} skills`);\n\t\t\t\t}\n\n\t\t\t\tconst preferredTypes = ((tech.preferred_job_types as string[]) || []).map((t) => t.toLowerCase());\n\t\t\t\tif (preferredTypes.includes(jobType.toLowerCase())) {\n\t\t\t\t\tscore += 20;\n\t\t\t\t\treasons.push(\"Prefers this job type\");\n\t\t\t\t}\n\n\t\t\t\tconst techJobs = jobCounts[tech.id] || 0;\n\t\t\t\tif (techJobs === 0) { score += 30; reasons.push(\"Fully available\"); }\n\t\t\t\telse if (techJobs < 3) { score += 15; reasons.push(`${techJobs} jobs scheduled`); }\n\n\t\t\t\treturn {\n\t\t\t\t\tid: tech.id,\n\t\t\t\t\tname: `${(tech.user as { first_name: string; last_name: string })?.first_name} ${(tech.user as { first_name: string; last_name: string })?.last_name}`,\n\t\t\t\t\tscore: Math.round(score),\n\t\t\t\t\treasons,\n\t\t\t\t\tjobsOnDate: techJobs,\n\t\t\t\t};\n\t\t\t});\n\n\t\t\tscored.sort((a, b) => b.score - a.score);\n\t\t\treturn { recommendations: scored.slice(0, 5), bestMatch: scored[0] };\n\t\t} catch (err) {\n\t\t\treturn { error: err instanceof Error ? err.message : \"Failed to suggest technician\" };\n\t\t}\n\t},\n});\n\n/**\n * Optimize job order for a technician's day\n */\nexport const optimizeJobOrderTool = tool({\n\tdescription: \"Optimize the order of jobs for a technician to minimize travel time\",\n\tparameters: z.object({\n\t\tcompanyId: z.string().describe(\"Company UUID\"),\n\t\ttechnicianId: z.string(),\n\t\tdate: z.string(),\n\t}),\n\texecute: async ({ technicianId, date }) => {\n\t\ttry {\n\t\t\tconst supabase = await createClient();\n\n\t\t\tconst dayStart = new Date(date);\n\t\t\tdayStart.setHours(0, 0, 0, 0);\n\t\t\tconst dayEnd = new Date(date);\n\t\t\tdayEnd.setHours(23, 59, 59, 999);\n\n\t\t\tconst { data: jobs } = await supabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\"id, title, scheduled_start, priority, property:properties(address, city, latitude, longitude)\")\n\t\t\t\t.eq(\"assigned_to\", technicianId)\n\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t.gte(\"scheduled_start\", dayStart.toISOString())\n\t\t\t\t.lte(\"scheduled_start\", dayEnd.toISOString())\n\t\t\t\t.order(\"scheduled_start\");\n\n\t\t\tif (!jobs || jobs.length < 2) return { message: \"Not enough jobs to optimize\", jobs: jobs || [] };\n\n\t\t\tconst jobsWithCoords = jobs\n\t\t\t\t.filter((j) => (j.property as { latitude: number; longitude: number })?.latitude)\n\t\t\t\t.map((j) => ({\n\t\t\t\t\t...j,\n\t\t\t\t\tlat: (j.property as { latitude: number })?.latitude,\n\t\t\t\t\tlng: (j.property as { longitude: number })?.longitude,\n\t\t\t\t}));\n\n\t\t\tif (jobsWithCoords.length < 2) return { message: \"Not enough jobs with location data\", jobs };\n\n\t\t\t// Simple nearest-neighbor optimization\n\t\t\tconst optimized: typeof jobsWithCoords = [];\n\t\t\tconst remaining = [...jobsWithCoords];\n\t\t\tlet current = { lat: jobsWithCoords[0].lat, lng: jobsWithCoords[0].lng };\n\n\t\t\twhile (remaining.length > 0) {\n\t\t\t\tlet nearestIdx = 0;\n\t\t\t\tlet nearestDist = Infinity;\n\t\t\t\tremaining.forEach((job, idx) => {\n\t\t\t\t\tconst dist = Math.sqrt(Math.pow(job.lat - current.lat, 2) + Math.pow(job.lng - current.lng, 2));\n\t\t\t\t\tconst priorityBonus = job.priority === \"high\" ? 0.8 : 1;\n\t\t\t\t\tif (dist * priorityBonus < nearestDist) {\n\t\t\t\t\t\tnearestDist = dist * priorityBonus;\n\t\t\t\t\t\tnearestIdx = idx;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tconst next = remaining.splice(nearestIdx, 1)[0];\n\t\t\t\toptimized.push(next);\n\t\t\t\tcurrent = { lat: next.lat, lng: next.lng };\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\toptimizedOrder: optimized.map((j, idx) => ({\n\t\t\t\t\torder: idx + 1,\n\t\t\t\t\tjobId: j.id,\n\t\t\t\t\ttitle: j.title,\n\t\t\t\t\taddress: `${(j.property as { address: string; city: string })?.address}, ${(j.property as { address: string; city: string })?.city}`,\n\t\t\t\t})),\n\t\t\t\tjobCount: optimized.length,\n\t\t\t};\n\t\t} catch (err) {\n\t\t\treturn { error: err instanceof Error ? err.message : \"Failed to optimize job order\" };\n\t\t}\n\t},\n});\n\n// ============================================================================\n// WEB SEARCH & RESEARCH TOOLS\n// ============================================================================\n\n/**\n * Web search tool - Search the web for information\n * Use this for general questions, industry news, regulations, pricing research, etc.\n */\nexport const webSearchTool = tool({\n\tdescription: \"Search the web for information. Use this to find answers to questions, research topics, look up current events, regulations, industry news, competitor information, or any general knowledge questions.\",\n\tparameters: z.object({\n\t\tquery: z.string().describe(\"The search query - be specific and include relevant keywords\"),\n\t\tnumResults: z.number().optional().default(5).describe(\"Number of results to return (1-10)\"),\n\t\tdateRestrict: z.string().optional().describe(\"Limit to recent results: d7 (7 days), m1 (1 month), y1 (1 year)\"),\n\t}),\n\texecute: async ({ query, numResults, dateRestrict }) => {\n\t\tif (!googleCustomSearchService.isConfigured()) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Web search is not configured. Please set GOOGLE_API_KEY and GOOGLE_SEARCH_ENGINE_ID.\",\n\t\t\t\tconfigStatus: googleCustomSearchService.getConfigStatus(),\n\t\t\t};\n\t\t}\n\n\t\tconst results = await googleCustomSearchService.search(query, {\n\t\t\tnum: Math.min(numResults, 10),\n\t\t\tdateRestrict,\n\t\t});\n\n\t\tif (!results) {\n\t\t\treturn { success: false, error: \"Search failed. Please try again.\" };\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tquery,\n\t\t\ttotalResults: results.totalResults,\n\t\t\tsearchTime: results.searchTime,\n\t\t\tresults: results.results.map((r) => ({\n\t\t\t\ttitle: r.title,\n\t\t\t\turl: r.link,\n\t\t\t\tsnippet: r.snippet,\n\t\t\t\tsource: r.displayLink,\n\t\t\t})),\n\t\t};\n\t},\n});\n\n/**\n * Web search for news - Search for recent news articles\n * Use this for industry news, current events, company news, etc.\n */\nexport const webSearchNewsTool = tool({\n\tdescription: \"Search for recent news articles. Use this for industry news, current events, company updates, regulation changes, or any time-sensitive information.\",\n\tparameters: z.object({\n\t\tquery: z.string().describe(\"The news search query - include topic and relevant keywords\"),\n\t\tdaysBack: z.number().optional().default(7).describe(\"How many days back to search (1-30)\"),\n\t\tnumResults: z.number().optional().default(5).describe(\"Number of results to return (1-10)\"),\n\t}),\n\texecute: async ({ query, daysBack, numResults }) => {\n\t\tif (!googleCustomSearchService.isConfigured()) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Web search is not configured. Please set GOOGLE_API_KEY and GOOGLE_SEARCH_ENGINE_ID.\",\n\t\t\t};\n\t\t}\n\n\t\tconst results = await googleCustomSearchService.searchNews(query, {\n\t\t\tdaysBack: Math.min(daysBack, 30),\n\t\t\tnum: Math.min(numResults, 10),\n\t\t});\n\n\t\tif (!results) {\n\t\t\treturn { success: false, error: \"News search failed. Please try again.\" };\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tquery,\n\t\t\tsearchType: \"news\",\n\t\t\tdaysBack,\n\t\t\ttotalResults: results.totalResults,\n\t\t\tresults: results.results.map((r) => ({\n\t\t\t\ttitle: r.title,\n\t\t\t\turl: r.link,\n\t\t\t\tsnippet: r.snippet,\n\t\t\t\tsource: r.displayLink,\n\t\t\t})),\n\t\t};\n\t},\n});\n\n/**\n * Technical/documentation search - Search for technical documentation, guides, and tutorials\n * Use this for code examples, API documentation, how-to guides, etc.\n */\nexport const webSearchTechnicalTool = tool({\n\tdescription: \"Search for technical documentation, guides, tutorials, and code examples. Use this when looking for how to do something technical, API documentation, troubleshooting guides, or code references.\",\n\tparameters: z.object({\n\t\tquery: z.string().describe(\"The technical search query - include technology names and specific topics\"),\n\t\tnumResults: z.number().optional().default(5).describe(\"Number of results to return (1-10)\"),\n\t}),\n\texecute: async ({ query, numResults }) => {\n\t\tif (!googleCustomSearchService.isConfigured()) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Web search is not configured. Please set GOOGLE_API_KEY and GOOGLE_SEARCH_ENGINE_ID.\",\n\t\t\t};\n\t\t}\n\n\t\tconst results = await googleCustomSearchService.searchTechnical(query, {\n\t\t\tnum: Math.min(numResults, 10),\n\t\t});\n\n\t\tif (!results) {\n\t\t\treturn { success: false, error: \"Technical search failed. Please try again.\" };\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tquery,\n\t\t\tsearchType: \"technical\",\n\t\t\ttotalResults: results.totalResults,\n\t\t\tresults: results.results.map((r) => ({\n\t\t\t\ttitle: r.title,\n\t\t\t\turl: r.link,\n\t\t\t\tsnippet: r.snippet,\n\t\t\t\tsource: r.displayLink,\n\t\t\t})),\n\t\t};\n\t},\n});\n\n/**\n * Site-specific search - Search within a specific website\n * Use this to find information within a particular domain (e.g., manufacturer sites, gov sites)\n */\nexport const webSearchSiteTool = tool({\n\tdescription: \"Search within a specific website. Use this to find information on a particular site like manufacturer documentation, government sites, or specific company websites.\",\n\tparameters: z.object({\n\t\tquery: z.string().describe(\"The search query\"),\n\t\tsite: z.string().describe(\"The domain to search within (e.g., 'epa.gov', 'osha.gov', 'lennox.com')\"),\n\t\tnumResults: z.number().optional().default(5).describe(\"Number of results to return (1-10)\"),\n\t}),\n\texecute: async ({ query, site, numResults }) => {\n\t\tif (!googleCustomSearchService.isConfigured()) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Web search is not configured. Please set GOOGLE_API_KEY and GOOGLE_SEARCH_ENGINE_ID.\",\n\t\t\t};\n\t\t}\n\n\t\tconst results = await googleCustomSearchService.searchSite(query, site, {\n\t\t\tnum: Math.min(numResults, 10),\n\t\t});\n\n\t\tif (!results) {\n\t\t\treturn { success: false, error: \"Site search failed. Please try again.\" };\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tquery,\n\t\t\tsite,\n\t\t\ttotalResults: results.totalResults,\n\t\t\tresults: results.results.map((r) => ({\n\t\t\t\ttitle: r.title,\n\t\t\t\turl: r.link,\n\t\t\t\tsnippet: r.snippet,\n\t\t\t})),\n\t\t};\n\t},\n});\n\n/**\n * Maps tool names to their destructive metadata.\n * Tools marked as destructive will be intercepted and require owner approval.\n */\nexport const destructiveTools: Record<string, DestructiveToolMetadata> = {\n\t// Communication tools - sending messages to external parties\n\tsendEmail: {\n\t\tisDestructive: true,\n\t\tactionType: \"send_communication\",\n\t\triskLevel: \"high\",\n\t\trequiresOwnerApproval: true,\n\t\tdescription: \"Sends an email to a customer on behalf of your company\",\n\t\taffectedEntityType: \"customer\",\n\t},\n\tsendSms: {\n\t\tisDestructive: true,\n\t\tactionType: \"send_communication\",\n\t\triskLevel: \"high\",\n\t\trequiresOwnerApproval: true,\n\t\tdescription: \"Sends an SMS message to a customer on behalf of your company\",\n\t\taffectedEntityType: \"customer\",\n\t},\n\tinitiateCall: {\n\t\tisDestructive: true,\n\t\tactionType: \"send_communication\",\n\t\triskLevel: \"critical\",\n\t\trequiresOwnerApproval: true,\n\t\tdescription: \"Initiates a phone call to a customer\",\n\t\taffectedEntityType: \"customer\",\n\t},\n\tsendTeamEmail: {\n\t\tisDestructive: true,\n\t\tactionType: \"send_communication\",\n\t\triskLevel: \"medium\",\n\t\trequiresOwnerApproval: true,\n\t\tdescription: \"Sends an internal email to a team member\",\n\t\taffectedEntityType: \"team_member\",\n\t},\n\tsendTeamSms: {\n\t\tisDestructive: true,\n\t\tactionType: \"send_communication\",\n\t\triskLevel: \"medium\",\n\t\trequiresOwnerApproval: true,\n\t\tdescription: \"Sends an SMS to a team member\",\n\t\taffectedEntityType: \"team_member\",\n\t},\n\tsendVendorEmail: {\n\t\tisDestructive: true,\n\t\tactionType: \"send_communication\",\n\t\triskLevel: \"high\",\n\t\trequiresOwnerApproval: true,\n\t\tdescription: \"Sends an email to a vendor on behalf of your company\",\n\t\taffectedEntityType: \"vendor\",\n\t},\n\tsendVendorSms: {\n\t\tisDestructive: true,\n\t\tactionType: \"send_communication\",\n\t\triskLevel: \"high\",\n\t\trequiresOwnerApproval: true,\n\t\tdescription: \"Sends an SMS to a vendor on behalf of your company\",\n\t\taffectedEntityType: \"vendor\",\n\t},\n\tsendImmediateNotification: {\n\t\tisDestructive: true,\n\t\tactionType: \"send_communication\",\n\t\triskLevel: \"high\",\n\t\trequiresOwnerApproval: true,\n\t\tdescription: \"Sends an immediate notification to a recipient\",\n\t\taffectedEntityType: \"notification\",\n\t},\n\n\t// Financial tools - money movement and financial records\n\tcreateInvoice: {\n\t\tisDestructive: true,\n\t\tactionType: \"financial\",\n\t\triskLevel: \"high\",\n\t\trequiresOwnerApproval: true,\n\t\tdescription: \"Creates a new invoice that will be sent to a customer\",\n\t\taffectedEntityType: \"invoice\",\n\t},\n\ttransferToBucket: {\n\t\tisDestructive: true,\n\t\tactionType: \"financial\",\n\t\triskLevel: \"critical\",\n\t\trequiresOwnerApproval: true,\n\t\tdescription: \"Transfers funds between financial buckets\",\n\t\taffectedEntityType: \"finance_bucket\",\n\t},\n\n\t// Scheduling tools - affects customer commitments\n\tcreateAppointment: {\n\t\tisDestructive: true,\n\t\tactionType: \"bulk_update\",\n\t\triskLevel: \"medium\",\n\t\trequiresOwnerApproval: true,\n\t\tdescription: \"Creates a new appointment which commits company resources\",\n\t\taffectedEntityType: \"appointment\",\n\t},\n\tcancelReminder: {\n\t\tisDestructive: true,\n\t\tactionType: \"delete\",\n\t\triskLevel: \"low\",\n\t\trequiresOwnerApproval: true,\n\t\tdescription: \"Cancels a scheduled reminder\",\n\t\taffectedEntityType: \"reminder\",\n\t},\n\n\t// Data modification tools\n\tupdateCustomer: {\n\t\tisDestructive: true,\n\t\tactionType: \"bulk_update\",\n\t\triskLevel: \"medium\",\n\t\trequiresOwnerApproval: true,\n\t\tdescription: \"Modifies customer record information\",\n\t\taffectedEntityType: \"customer\",\n\t},\n};\n\n/**\n * Check if a tool is destructive and requires owner approval\n */\nexport function isDestructiveTool(toolName: string): boolean {\n\treturn toolName in destructiveTools;\n}\n\n/**\n * Get the metadata for a destructive tool\n */\nexport function getDestructiveToolMetadata(toolName: string): DestructiveToolMetadata | null {\n\treturn destructiveTools[toolName] || null;\n}\n\n/**\n * Get all destructive tool names\n */\nexport function getDestructiveToolNames(): string[] {\n\treturn Object.keys(destructiveTools);\n}\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAED;AACA;AACA;AACA;AAKA;;;;;;AASO,MAAM,yBAAyB,IAAA,4RAAI,EAAC;IAC1C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC,CAAC;IACtB,SAAS;QACR,OAAO;YACN,SAAS;YACT,QAAQ;gBACP;oBAAE,MAAM;oBAAa,aAAa;gBAA0D;gBAC5F;oBAAE,MAAM;oBAAgB,aAAa;gBAAmE;gBACxG;oBAAE,MAAM;oBAAW,aAAa;gBAAwD;gBACxF;oBAAE,MAAM;oBAAQ,aAAa;gBAAkE;gBAC/F;oBAAE,MAAM;oBAAgB,aAAa;gBAA2C;gBAChF;oBAAE,MAAM;oBAAY,aAAa;gBAAuD;gBACxF;oBAAE,MAAM;oBAAa,aAAa;gBAAuC;gBACzE;oBAAE,MAAM;oBAAa,aAAa;gBAAmC;gBACrE;oBAAE,MAAM;oBAAY,aAAa;gBAAmC;gBACpE;oBAAE,MAAM;oBAAc,aAAa;gBAAwC;gBAC3E;oBAAE,MAAM;oBAAa,aAAa;gBAAqC;gBACvE;oBAAE,MAAM;oBAAkB,aAAa;gBAA+B;gBACtE;oBAAE,MAAM;oBAAoB,aAAa;gBAAsC;gBAC/E;oBAAE,MAAM;oBAAa,aAAa;gBAAgC;gBAClE;oBAAE,MAAM;oBAAmB,aAAa;gBAA6B;gBACrE;oBAAE,MAAM;oBAAgB,aAAa;gBAAuC;gBAC5E;oBAAE,MAAM;oBAAY,aAAa;gBAA8B;gBAC/D;oBAAE,MAAM;oBAAsB,aAAa;gBAA+B;gBAC1E;oBAAE,MAAM;oBAAqB,aAAa;gBAAkC;gBAC5E;oBAAE,MAAM;oBAAS,aAAa;gBAAoC;gBAClE;oBAAE,MAAM;oBAAQ,aAAa;gBAAqC;gBAClE;oBAAE,MAAM;oBAA2B,aAAa;gBAA0C;gBAC1F;oBAAE,MAAM;oBAA2B,aAAa;gBAAwC;aACxF;QACF;IACD;AACD;AAEO,MAAM,oBAAoB,IAAA,4RAAI,EAAC;IACrC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,QAAQ,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,KAAK,QAAQ,CAAC;QACpD,SAAS,mOAAC,CAAC,KAAK,CAAC,mOAAC,CAAC,MAAM,CAAC;YACzB,QAAQ,mOAAC,CAAC,MAAM;YAChB,UAAU,mOAAC,CAAC,IAAI,CAAC;gBAAC;gBAAM;gBAAO;gBAAM;gBAAO;gBAAM;gBAAO;gBAAQ;gBAAS;gBAAM;aAAK;YACrF,OAAO,mOAAC,CAAC,KAAK,CAAC;gBAAC,mOAAC,CAAC,MAAM;gBAAI,mOAAC,CAAC,MAAM;gBAAI,mOAAC,CAAC,OAAO;gBAAI,mOAAC,CAAC,IAAI;gBAAI,mOAAC,CAAC,KAAK,CAAC,mOAAC,CAAC,MAAM;aAAI;QACpF,IAAI,QAAQ,GAAG,QAAQ,CAAC;QACxB,SAAS,mOAAC,CAAC,MAAM,CAAC;YACjB,QAAQ,mOAAC,CAAC,MAAM;YAChB,WAAW,mOAAC,CAAC,OAAO,GAAG,OAAO,CAAC;QAChC,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACvB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,IAAI,QAAQ,CAAC;QAClD,QAAQ,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,GAAG,QAAQ,CAAC;IACnD;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,EAAE,EAAE,SAAS,EAAyB;QACvG,MAAM,WAAW,IAAA,+KAA2B;QAE5C,iDAAiD;QACjD,MAAM,gBAAgB;YACrB;YAAa;YAAgB;YAAW;YAAQ;YAAgB;YAChE;YAAa;YAAa;YAAY;YAAc;YAAa;YACjE;YAAoB;YAAa;YAAmB;YAAgB;YACpE;YAAsB;YAAqB;YAAS;YAAQ;YAC5D;YAA2B;YAAkB;YAAsB;SACnE;QAED,IAAI,CAAC,cAAc,QAAQ,CAAC,QAAQ;YACnC,OAAO;gBAAE,SAAS;gBAAO,OAAO,CAAC,OAAO,EAAE,MAAM,gCAAgC,EAAE,cAAc,IAAI,CAAC,OAAO;YAAC;QAC9G;QAEA,IAAI,QAAQ,SAAS,IAAI,CAAC,OAAO,MAAM,CAAC;QAExC,2CAA2C;QAC3C,QAAQ,MAAM,EAAE,CAAC,cAAc;QAE/B,gBAAgB;QAChB,IAAI,SAAS;YACZ,KAAK,MAAM,UAAU,QAAS;gBAC7B,OAAQ,OAAO,QAAQ;oBACtB,KAAK;wBAAM,QAAQ,MAAM,EAAE,CAAC,OAAO,MAAM,EAAE,OAAO,KAAK;wBAAG;oBAC1D,KAAK;wBAAO,QAAQ,MAAM,GAAG,CAAC,OAAO,MAAM,EAAE,OAAO,KAAK;wBAAG;oBAC5D,KAAK;wBAAM,QAAQ,MAAM,EAAE,CAAC,OAAO,MAAM,EAAE,OAAO,KAAK;wBAAG;oBAC1D,KAAK;wBAAO,QAAQ,MAAM,GAAG,CAAC,OAAO,MAAM,EAAE,OAAO,KAAK;wBAAG;oBAC5D,KAAK;wBAAM,QAAQ,MAAM,EAAE,CAAC,OAAO,MAAM,EAAE,OAAO,KAAK;wBAAG;oBAC1D,KAAK;wBAAO,QAAQ,MAAM,GAAG,CAAC,OAAO,MAAM,EAAE,OAAO,KAAK;wBAAG;oBAC5D,KAAK;wBAAQ,QAAQ,MAAM,IAAI,CAAC,OAAO,MAAM,EAAE,OAAO,KAAK;wBAAa;oBACxE,KAAK;wBAAS,QAAQ,MAAM,KAAK,CAAC,OAAO,MAAM,EAAE,OAAO,KAAK;wBAAa;oBAC1E,KAAK;wBAAM,QAAQ,MAAM,EAAE,CAAC,OAAO,MAAM,EAAE,OAAO,KAAK;wBAAe;oBACtE,KAAK;wBAAM,QAAQ,MAAM,EAAE,CAAC,OAAO,MAAM,EAAE,OAAO,KAAK;wBAAG;gBAC3D;YACD;QACD;QAEA,iBAAiB;QACjB,IAAI,SAAS;YACZ,QAAQ,MAAM,KAAK,CAAC,QAAQ,MAAM,EAAE;gBAAE,WAAW,QAAQ,SAAS;YAAC;QACpE;QAEA,mBAAmB;QACnB,QAAQ,MAAM,KAAK,CAAC,QAAQ,SAAS,QAAQ;QAE7C,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG,MAAM;QAErC,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM;YAAM,OAAO,MAAM,UAAU;YAAG;QAAM;IAC/D;AACD;AAEO,MAAM,oBAAoB,IAAA,4RAAI,EAAC;IACrC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,IAAI,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QAC/B,QAAQ,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,KAAK,QAAQ,CAAC;IACrD;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,EAAE,EAAE,MAAM,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC1E,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,gBAAgB;YACrB;YAAa;YAAgB;YAAW;YAAQ;YAAgB;YAChE;YAAa;YAAa;YAAY;YAAc;YAAa;YACjE;YAAoB;YAAa;YAAmB;YAAgB;YACpE;YAAsB;YAAqB;YAAS;SACpD;QAED,IAAI,CAAC,cAAc,QAAQ,CAAC,QAAQ;YACnC,OAAO;gBAAE,SAAS;gBAAO,OAAO,CAAC,OAAO,EAAE,MAAM,mBAAmB,CAAC;YAAC;QACtE;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,OACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,IACT,EAAE,CAAC,cAAc,WACjB,MAAM;QAER,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,QAAQ;YAAM;QAAM;IAC7C;AACD;AAEO,MAAM,wBAAwB,IAAA,4RAAI,EAAC;IACzC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,aAAa,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QACjC,UAAU,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACrC,YAAY,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAChC,YAAY,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAChC,QAAQ,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;QACtC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,WAAW,EAAE,QAAQ,EAAE,UAAU,EAAE,UAAU,EAAE,MAAM,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QACrH,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,YACL,MAAM,CAAC,QACP,EAAE,CAAC,YAAY,UACf,EAAE,CAAC,cAAc,WACjB,KAAK,CAAC;QAER,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM;YAAM,OAAO,MAAM,UAAU;YAAG;YAAa;QAAW;IACjF;AACD;AAEO,MAAM,yBAAyB,IAAA,4RAAI,EAAC;IAC1C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC,CAAC;IACtB,SAAS,OAAO,SAAS,EAAE,SAAS,EAAyB;QAC5D,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,CACL,iBACA,YACA,eACA,YACA,gBACA,iBACA,iBACA,kBACA,iBACA,mBACA,GAAG,MAAM,QAAQ,GAAG,CAAC;YACrB,SAAS,IAAI,CAAC,aAAa,MAAM,CAAC,cAAc;gBAAE,OAAO;YAAQ,GAAG,EAAE,CAAC,cAAc;YACrF,SAAS,IAAI,CAAC,gBAAgB,MAAM,CAAC,oBAAoB;gBAAE,OAAO;YAAQ,GAAG,EAAE,CAAC,cAAc;YAC9F,SAAS,IAAI,CAAC,WAAW,MAAM,CAAC,cAAc;gBAAE,OAAO;YAAQ,GAAG,EAAE,CAAC,cAAc;YACnF,SAAS,IAAI,CAAC,QAAQ,MAAM,CAAC,4BAA4B;gBAAE,OAAO;YAAQ,GAAG,EAAE,CAAC,cAAc;YAC9F,SAAS,IAAI,CAAC,YAAY,MAAM,CAAC,4CAA4C;gBAAE,OAAO;YAAQ,GAAG,EAAE,CAAC,cAAc;YAClH,SAAS,IAAI,CAAC,aAAa,MAAM,CAAC,4BAA4B;gBAAE,OAAO;YAAQ,GAAG,EAAE,CAAC,cAAc;YACnG,SAAS,IAAI,CAAC,aAAa,MAAM,CAAC,2BAA2B;gBAAE,OAAO;YAAQ,GAAG,EAAE,CAAC,cAAc;YAClG,SAAS,IAAI,CAAC,cAAc,MAAM,CAAC,MAAM;gBAAE,OAAO;YAAQ,GAAG,EAAE,CAAC,cAAc;YAC9E,SAAS,IAAI,CAAC,aAAa,MAAM,CAAC,MAAM;gBAAE,OAAO;YAAQ,GAAG,EAAE,CAAC,cAAc;YAC7E,SAAS,IAAI,CAAC,gBAAgB,MAAM,CAAC,cAAc;gBAAE,OAAO;YAAQ,GAAG,EAAE,CAAC,cAAc;SACxF;QAED,sBAAsB;QACtB,MAAM,kBAAkB,gBAAgB,IAAI,EAAE,OAAO,CAAA,IAAK,EAAE,MAAM,KAAK,UAAU,UAAU;QAC3F,MAAM,aAAa,WAAW,IAAI,EAAE,OAAO,CAAA,IAAK,EAAE,MAAM,KAAK,UAAU,UAAU;QACjF,MAAM,WAAW,WAAW,IAAI,EAAE,OAAO,CAAA,IAAK;gBAAC;gBAAW;gBAAa;aAAc,CAAC,QAAQ,CAAC,EAAE,MAAM,GAAG,UAAU;QACpH,MAAM,gBAAgB,WAAW,IAAI,EAAE,OAAO,CAAA,IAAK,EAAE,MAAM,KAAK,aAAa,UAAU;QACvF,MAAM,kBAAkB,eAAe,IAAI,EAAE,OAAO,CAAA,IAAK;gBAAC;gBAAQ;aAAS,CAAC,QAAQ,CAAC,EAAE,MAAM,GAAG,UAAU;QAC1G,MAAM,iBAAiB,eAAe,IAAI,EAAE,OAAO,CAAA,IAAK,EAAE,cAAc,GAAG,GAAG,OAAO,CAAC,GAAG,IAAM,IAAI,EAAE,cAAc,EAAE,MAAM;QAC3H,MAAM,mBAAmB,gBAAgB,IAAI,EAAE,OAAO,CAAA,IAAK;gBAAC;gBAAQ;aAAS,CAAC,QAAQ,CAAC,EAAE,MAAM,GAAG,UAAU;QAC5G,MAAM,kBAAkB,gBAAgB,IAAI,EAAE,OAAO,CAAA,IAAK,EAAE,MAAM,KAAK,UAAU,UAAU;QAE3F,sBAAsB;QACtB,MAAM,gBAAwC,CAAC;QAC/C,WAAW,IAAI,EAAE,QAAQ,CAAA;YACxB,aAAa,CAAC,EAAE,IAAI,IAAI,aAAa,GAAG,CAAC,aAAa,CAAC,EAAE,IAAI,IAAI,aAAa,IAAI,CAAC,IAAI;QACxF;QAEA,OAAO;YACN,SAAS;YACT,UAAU;gBACT,WAAW;oBACV,OAAO,gBAAgB,KAAK,IAAI;oBAChC,QAAQ;gBACT;gBACA,MAAM;oBACL,OAAO,WAAW,KAAK,IAAI;oBAC3B,QAAQ;oBACR,QAAQ;gBACT;gBACA,SAAS;oBACR,OAAO,cAAc,KAAK,IAAI;gBAC/B;gBACA,MAAM;oBACL,OAAO,WAAW,KAAK,IAAI;oBAC3B,MAAM;oBACN,WAAW;gBACZ;gBACA,UAAU;oBACT,OAAO,eAAe,KAAK,IAAI;oBAC/B,SAAS;oBACT,oBAAoB,iBAAiB;gBACtC;gBACA,WAAW;oBACV,OAAO,gBAAgB,KAAK,IAAI;oBAChC,SAAS;gBACV;gBACA,WAAW;oBACV,OAAO,gBAAgB,KAAK,IAAI;oBAChC,QAAQ;gBACT;gBACA,YAAY;oBACX,OAAO,iBAAiB,KAAK,IAAI;gBAClC;gBACA,WAAW;oBACV,OAAO,gBAAgB,KAAK,IAAI;gBACjC;gBACA,cAAc;oBACb,OAAO,mBAAmB,KAAK,IAAI;gBACpC;YACD;QACD;IACD;AACD;AAEO,MAAM,uBAAuB,IAAA,4RAAI,EAAC;IACxC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,IAAI,QAAQ,CAAC;IACnD;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QACrE,MAAM,WAAW,IAAA,+KAA2B;QAE5C,oEAAoE;QACpE,MAAM,gBAAgB,MAAM,IAAA,kLAAiB,EAAC,UAAU,WAAW,OAAO;YAAE;QAAM;QAElF,oCAAoC;QACpC,MAAM,UAAqC,CAAC;QAC5C,IAAI,cAAc,SAAS,CAAC,MAAM,GAAG,GAAG,QAAQ,SAAS,GAAG,cAAc,SAAS;QACnF,IAAI,cAAc,IAAI,CAAC,MAAM,GAAG,GAAG,QAAQ,IAAI,GAAG,cAAc,IAAI;QACpE,IAAI,cAAc,UAAU,CAAC,MAAM,GAAG,GAAG,QAAQ,UAAU,GAAG,cAAc,UAAU;QACtF,IAAI,cAAc,SAAS,CAAC,MAAM,GAAG,GAAG,QAAQ,SAAS,GAAG,cAAc,SAAS;QACnF,IAAI,cAAc,cAAc,CAAC,MAAM,GAAG,GAAG,QAAQ,cAAc,GAAG,cAAc,cAAc;QAElG,MAAM,eAAe,OAAO,MAAM,CAAC,SAAS,MAAM,CAAC,CAAC,KAAK,MAAQ,MAAM,IAAI,MAAM,EAAE;QAEnF,OAAO;YAAE,SAAS;YAAM;YAAS;YAAc;QAAM;IACtD;AACD;AAMO,MAAM,sBAAsB,IAAA,4RAAI,EAAC;IACvC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,IAAI,QAAQ,CAAC;IACnD;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QACrE,MAAM,WAAW,IAAA,+KAA2B;QAE5C,4DAA4D;QAC5D,MAAM,YAAY,MAAM,IAAA,wLAAuB,EAAC,UAAU,WAAW,OAAO;YAAE;QAAM;QAEpF,OAAO;YAAE,SAAS;YAAM;YAAW,OAAO,UAAU,MAAM;QAAC;IAC5D;AACD;AAEO,MAAM,yBAAyB,IAAA,4RAAI,EAAC;IAC1C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;IACxC;IACA,SAAS,OAAO,EAAE,UAAU,EAAE,EAAE,EAAE,SAAS,EAAyB;QACnE,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,CAAC,gBAAgB,YAAY,eAAe,GAAG,MAAM,QAAQ,GAAG,CAAC;YACtE,SACE,IAAI,CAAC,aACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,YACT,EAAE,CAAC,cAAc,WACjB,MAAM;YACR,SACE,IAAI,CAAC,QACL,MAAM,CAAC,oDACP,EAAE,CAAC,eAAe,YAClB,KAAK,CAAC,cAAc;gBAAE,WAAW;YAAM,GACvC,KAAK,CAAC;YACR,SACE,IAAI,CAAC,YACL,MAAM,CAAC,sEACP,EAAE,CAAC,eAAe,YAClB,KAAK,CAAC,cAAc;gBAAE,WAAW;YAAM,GACvC,KAAK,CAAC;SACR;QAED,IAAI,eAAe,KAAK,EAAE,OAAO;YAAE,SAAS;YAAO,OAAO,eAAe,KAAK,CAAC,OAAO;QAAC;QAEvF,OAAO;YACN,SAAS;YACT,UAAU,eAAe,IAAI;YAC7B,YAAY,WAAW,IAAI,IAAI,EAAE;YACjC,gBAAgB,eAAe,IAAI,IAAI,EAAE;QAC1C;IACD;AACD;AAEO,MAAM,qBAAqB,IAAA,4RAAI,EAAC;IACtC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,UAAU,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC9B,OAAO,mOAAC,CAAC,MAAM,GAAG,KAAK,GAAG,QAAQ,CAAC;QACnC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACxC,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACrC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACtC,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACxC,QAAQ,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IACxC;IACA,SAAS,OAAO,QAAQ,EAAE,SAAS,EAAyB;QAC3D,MAAM,WAAW,IAAA,+KAA2B;QAC5C,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,aACL,MAAM,CAAC;YACP,YAAY;YACZ,YAAY,OAAO,SAAS;YAC5B,WAAW,OAAO,QAAQ;YAC1B,cAAc,GAAG,OAAO,SAAS,CAAC,CAAC,EAAE,OAAO,QAAQ,EAAE;YACtD,OAAO,OAAO,KAAK;YACnB,OAAO,OAAO,KAAK;YACnB,SAAS,OAAO,OAAO;YACvB,MAAM,OAAO,IAAI;YACjB,OAAO,OAAO,KAAK;YACnB,UAAU,OAAO,OAAO;YACxB,QAAQ,OAAO,MAAM;YACrB,QAAQ;QACT,GACC,MAAM,GACN,MAAM;QAER,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,UAAU;YAAM,SAAS,CAAC,iBAAiB,EAAE,KAAK,YAAY,EAAE;QAAC;IAC1F;AACD;AAEO,MAAM,qBAAqB,IAAA,4RAAI,EAAC;IACtC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACvC,SAAS,mOAAC,CAAC,MAAM,CAAC;YACjB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ;YAC9B,UAAU,mOAAC,CAAC,MAAM,GAAG,QAAQ;YAC7B,OAAO,mOAAC,CAAC,MAAM,GAAG,KAAK,GAAG,QAAQ;YAClC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ;YAC1B,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ;YAC5B,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ;YACzB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ;YAC1B,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ;YAC5B,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ;QAC3B,GAAG,QAAQ,CAAC;IACb;IACA,SAAS,OAAO,EAAE,UAAU,EAAE,OAAO,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC5E,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,aAAsC,CAAC;QAC7C,IAAI,QAAQ,SAAS,EAAE,WAAW,UAAU,GAAG,QAAQ,SAAS;QAChE,IAAI,QAAQ,QAAQ,EAAE,WAAW,SAAS,GAAG,QAAQ,QAAQ;QAC7D,IAAI,QAAQ,KAAK,EAAE,WAAW,KAAK,GAAG,QAAQ,KAAK;QACnD,IAAI,QAAQ,KAAK,EAAE,WAAW,KAAK,GAAG,QAAQ,KAAK;QACnD,IAAI,QAAQ,OAAO,EAAE,WAAW,OAAO,GAAG,QAAQ,OAAO;QACzD,IAAI,QAAQ,IAAI,EAAE,WAAW,IAAI,GAAG,QAAQ,IAAI;QAChD,IAAI,QAAQ,KAAK,EAAE,WAAW,KAAK,GAAG,QAAQ,KAAK;QACnD,IAAI,QAAQ,OAAO,EAAE,WAAW,QAAQ,GAAG,QAAQ,OAAO;QAC1D,IAAI,QAAQ,KAAK,EAAE,WAAW,KAAK,GAAG,QAAQ,KAAK;QAEnD,IAAI,QAAQ,SAAS,IAAI,QAAQ,QAAQ,EAAE;YAC1C,WAAW,YAAY,GAAG,GAAG,QAAQ,SAAS,IAAI,GAAG,CAAC,EAAE,QAAQ,QAAQ,IAAI,IAAI,CAAC,IAAI;QACtF;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,aACL,MAAM,CAAC,YACP,EAAE,CAAC,MAAM,YACT,EAAE,CAAC,cAAc,WACjB,MAAM,GACN,MAAM;QAER,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,UAAU;QAAK;IACxC;AACD;AAMO,MAAM,wBAAwB,IAAA,4RAAI,EAAC;IACzC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACtC,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACrC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,IAAI,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC3E,MAAM,WAAW,IAAA,+KAA2B;QAC5C,IAAI,eAAe,SACjB,IAAI,CAAC,gBACL,MAAM,CAAC,4FACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU;QAEf,IAAI,OAAO;YACV,eAAe,aAAa,EAAE,CAAC,CAAC,kBAAkB,EAAE,MAAM,mBAAmB,EAAE,MAAM,eAAe,EAAE,MAAM,CAAC,CAAC;QAC/G;QACA,IAAI,MAAM,eAAe,aAAa,EAAE,CAAC,QAAQ;QAEjD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,aAAa,KAAK,CAAC;QAEjD,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,aAAa;YAAM,OAAO,MAAM,UAAU;QAAE;IACrE;AACD;AAEO,MAAM,2BAA2B,IAAA,4RAAI,EAAC;IAC5C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,cAAc,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;IAC1C;IACA,SAAS,OAAO,EAAE,YAAY,EAAE,EAAE,EAAE,SAAS,EAAyB;QACrE,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,CAAC,cAAc,WAAW,GAAG,MAAM,QAAQ,GAAG,CAAC;YACpD,SACE,IAAI,CAAC,gBACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,cACT,EAAE,CAAC,cAAc,WACjB,MAAM;YACR,SACE,IAAI,CAAC,QACL,MAAM,CAAC,oDACP,EAAE,CAAC,eAAe,cAClB,KAAK,CAAC,mBAAmB;gBAAE,WAAW;YAAM,GAC5C,KAAK,CAAC;SACR;QAED,IAAI,aAAa,KAAK,EAAE,OAAO;YAAE,SAAS;YAAO,OAAO,aAAa,KAAK,CAAC,OAAO;QAAC;QAEnF,OAAO;YACN,SAAS;YACT,YAAY,aAAa,IAAI;YAC7B,YAAY,WAAW,IAAI,IAAI,EAAE;QAClC;IACD;AACD;AAEO,MAAM,oBAAoB,IAAA,4RAAI,EAAC;IACrC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,cAAc,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACzC,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC7B,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC3B;IACA,SAAS,OAAO,EAAE,YAAY,EAAE,OAAO,EAAE,IAAI,EAAE,EAAE,EAAE,SAAS,EAAyB;QACpF,MAAM,WAAW,IAAA,+KAA2B;QAE5C,wBAAwB;QACxB,MAAM,EAAE,MAAM,MAAM,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,gBACL,MAAM,CAAC,gCACP,EAAE,CAAC,MAAM,cACT,EAAE,CAAC,cAAc,WACjB,MAAM;QAER,IAAI,CAAC,QAAQ,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO;QAA8B;QAElF,MAAM,EAAE,MAAM,EAAE,GAAG;QACnB,IAAI,CAAC,QAAQ,OAAO;YAAE,SAAS;YAAO,OAAO;QAA+B;QAE5E,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,OAAO,MAAM,CAAC,IAAI,CAAC;YAChD,MAAM,QAAQ,GAAG,CAAC,iBAAiB,IAAI;YACvC,IAAI,OAAO,KAAK;YAChB;YACA,MAAM;QACP;QAEA,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QAEzD,OAAO;YAAE,SAAS;YAAM,WAAW,MAAM;YAAI,SAAS,CAAC,cAAc,EAAE,OAAO,UAAU,CAAC,CAAC,EAAE,OAAO,SAAS,EAAE;QAAC;IAChH;AACD;AAEO,MAAM,kBAAkB,IAAA,4RAAI,EAAC;IACnC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,cAAc,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACzC,SAAS,mOAAC,CAAC,MAAM,GAAG,GAAG,CAAC,KAAK,QAAQ,CAAC;IACvC;IACA,SAAS,OAAO,EAAE,YAAY,EAAE,OAAO,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC9E,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,EAAE,MAAM,MAAM,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,gBACL,MAAM,CAAC,gCACP,EAAE,CAAC,MAAM,cACT,EAAE,CAAC,cAAc,WACjB,MAAM;QAER,IAAI,CAAC,QAAQ,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO;QAA8B;QAElF,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,iBACL,MAAM,CAAC,gBACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,cAAc,MACjB,MAAM;QAER,IAAI,CAAC,aAAa,OAAO;YAAE,SAAS;YAAO,OAAO;QAA8B;QAEhF,MAAM,EAAE,OAAO,EAAE,GAAG;QACpB,MAAM,SAAS,MAAM,QAAQ;YAC5B,MAAM,YAAY,YAAY;YAC9B,IAAI,OAAO,KAAK;YAChB,MAAM;QACP;QAEA,IAAI,CAAC,OAAO,OAAO,EAAE,OAAO;YAAE,SAAS;YAAO,OAAO,OAAO,KAAK;QAAC;QAElE,OAAO;YAAE,SAAS;YAAM,WAAW,OAAO,SAAS;YAAE,SAAS,CAAC,YAAY,EAAE,OAAO,UAAU,CAAC,CAAC,EAAE,OAAO,SAAS,EAAE;QAAC;IACtH;AACD;AAMO,MAAM,oBAAoB,IAAA,4RAAI,EAAC;IACrC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACtC,UAAU,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACzC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,QAAQ,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC/E,MAAM,WAAW,IAAA,+KAA2B;QAC5C,IAAI,eAAe,SACjB,IAAI,CAAC,WACL,MAAM,CAAC,yFACP,EAAE,CAAC,cAAc;QAEnB,IAAI,OAAO,eAAe,aAAa,EAAE,CAAC,CAAC,YAAY,EAAE,MAAM,sBAAsB,EAAE,MAAM,CAAC,CAAC;QAC/F,IAAI,UAAU,eAAe,aAAa,EAAE,CAAC,YAAY;QAEzD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,aAAa,KAAK,CAAC;QAEjD,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,SAAS;YAAM,OAAO,MAAM,UAAU;QAAE;IACjE;AACD;AAEO,MAAM,uBAAuB,IAAA,4RAAI,EAAC;IACxC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,UAAU,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,QAAQ,EAAE,EAAE,EAAE,SAAS,EAAyB;QACjE,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,CAAC,cAAc,gBAAgB,GAAG,MAAM,QAAQ,GAAG,CAAC;YACzD,SACE,IAAI,CAAC,WACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,UACT,EAAE,CAAC,cAAc,WACjB,MAAM;YACR,SACE,IAAI,CAAC,mBACL,MAAM,CAAC,mDACP,EAAE,CAAC,aAAa,UAChB,KAAK,CAAC,cAAc;gBAAE,WAAW;YAAM,GACvC,KAAK,CAAC;SACR;QAED,IAAI,aAAa,KAAK,EAAE,OAAO;YAAE,SAAS;YAAO,OAAO,aAAa,KAAK,CAAC,OAAO;QAAC;QAEnF,OAAO;YACN,SAAS;YACT,QAAQ,aAAa,IAAI;YACzB,iBAAiB,gBAAgB,IAAI,IAAI,EAAE;QAC5C;IACD;AACD;AAEO,MAAM,sBAAsB,IAAA,4RAAI,EAAC;IACvC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,UAAU,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACrC,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC7B,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC3B;IACA,SAAS,OAAO,EAAE,QAAQ,EAAE,OAAO,EAAE,IAAI,EAAE,EAAE,EAAE,SAAS,EAAyB;QAChF,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,EAAE,MAAM,MAAM,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,WACL,MAAM,CAAC,6BACP,EAAE,CAAC,MAAM,UACT,EAAE,CAAC,cAAc,WACjB,MAAM;QAER,IAAI,CAAC,QAAQ,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO;QAAyB;QAE7E,MAAM,EAAE,MAAM,EAAE,GAAG;QACnB,IAAI,CAAC,QAAQ,OAAO;YAAE,SAAS;YAAO,OAAO;QAA+B;QAE5E,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,OAAO,MAAM,CAAC,IAAI,CAAC;YAChD,MAAM,QAAQ,GAAG,CAAC,iBAAiB,IAAI;YACvC,IAAI,OAAO,KAAK;YAChB;YACA,MAAM;QACP;QAEA,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QAEzD,OAAO;YAAE,SAAS;YAAM,WAAW,MAAM;YAAI,SAAS,CAAC,cAAc,EAAE,OAAO,IAAI,EAAE;QAAC;IACtF;AACD;AAEO,MAAM,oBAAoB,IAAA,4RAAI,EAAC;IACrC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,UAAU,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACrC,SAAS,mOAAC,CAAC,MAAM,GAAG,GAAG,CAAC,KAAK,QAAQ,CAAC;IACvC;IACA,SAAS,OAAO,EAAE,QAAQ,EAAE,OAAO,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC1E,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,EAAE,MAAM,MAAM,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,WACL,MAAM,CAAC,eACP,EAAE,CAAC,MAAM,UACT,EAAE,CAAC,cAAc,WACjB,MAAM;QAER,IAAI,CAAC,QAAQ,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO;QAAyB;QAE7E,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,iBACL,MAAM,CAAC,gBACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,cAAc,MACjB,MAAM;QAER,IAAI,CAAC,aAAa,OAAO;YAAE,SAAS;YAAO,OAAO;QAA8B;QAEhF,MAAM,EAAE,OAAO,EAAE,GAAG;QACpB,MAAM,SAAS,MAAM,QAAQ;YAC5B,MAAM,YAAY,YAAY;YAC9B,IAAI,OAAO,KAAK;YAChB,MAAM;QACP;QAEA,IAAI,CAAC,OAAO,OAAO,EAAE,OAAO;YAAE,SAAS;YAAO,OAAO,OAAO,KAAK;QAAC;QAElE,OAAO;YAAE,SAAS;YAAM,WAAW,OAAO,SAAS;YAAE,SAAS,CAAC,YAAY,EAAE,OAAO,IAAI,EAAE;QAAC;IAC5F;AACD;AAMO,MAAM,uBAAuB,IAAA,4RAAI,EAAC;IACxC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACtC,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,GAAG,QAAQ,CAAC;QAClD,cAAc,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QAC7C,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,UAAU,EAAE,YAAY,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC/F,MAAM,WAAW,IAAA,+KAA2B;QAC5C,IAAI,eAAe,SACjB,IAAI,CAAC,cACL,MAAM,CAAC,6FACP,EAAE,CAAC,cAAc;QAEnB,IAAI,OAAO,eAAe,aAAa,EAAE,CAAC,CAAC,eAAe,EAAE,MAAM,cAAc,EAAE,MAAM,CAAC,CAAC;QAC1F,IAAI,YAAY,eAAe,aAAa,EAAE,CAAC,eAAe;QAC9D,IAAI,cAAc,eAAe,aAAa,EAAE,CAAC,iBAAiB;QAElE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,aAAa,KAAK,CAAC;QAEjD,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,YAAY;YAAM,OAAO,MAAM,UAAU;QAAE;IACpE;AACD;AAEO,MAAM,yBAAyB,IAAA,4RAAI,EAAC;IAC1C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;IACxC;IACA,SAAS,OAAO,EAAE,UAAU,EAAE,EAAE,EAAE,SAAS,EAAyB;QACnE,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,CAAC,gBAAgB,iBAAiB,WAAW,GAAG,MAAM,QAAQ,GAAG,CAAC;YACvE,SACE,IAAI,CAAC,cACL,MAAM,CAAC,qDACP,EAAE,CAAC,MAAM,YACT,EAAE,CAAC,cAAc,WACjB,MAAM;YACR,SACE,IAAI,CAAC,aACL,MAAM,CAAC,oFACP,EAAE,CAAC,eAAe,YAClB,KAAK,CAAC;YACR,SACE,IAAI,CAAC,QACL,MAAM,CAAC,oDACP,EAAE,CAAC,eAAe,YAClB,KAAK,CAAC,mBAAmB;gBAAE,WAAW;YAAM,GAC5C,KAAK,CAAC;SACR;QAED,IAAI,eAAe,KAAK,EAAE,OAAO;YAAE,SAAS;YAAO,OAAO,eAAe,KAAK,CAAC,OAAO;QAAC;QAEvF,OAAO;YACN,SAAS;YACT,UAAU,eAAe,IAAI;YAC7B,WAAW,gBAAgB,IAAI,IAAI,EAAE;YACrC,gBAAgB,WAAW,IAAI,IAAI,EAAE;QACtC;IACD;AACD;AAEO,MAAM,sBAAsB,IAAA,4RAAI,EAAC;IACvC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACtC,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ;QACtC,eAAe,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QAC9C,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,UAAU,EAAE,aAAa,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QAChG,MAAM,WAAW,IAAA,+KAA2B;QAC5C,IAAI,eAAe,SACjB,IAAI,CAAC,aACL,MAAM,CAAC,oKACP,EAAE,CAAC,cAAc;QAEnB,IAAI,OAAO,eAAe,aAAa,EAAE,CAAC,CAAC,YAAY,EAAE,MAAM,eAAe,EAAE,MAAM,uBAAuB,EAAE,MAAM,CAAC,CAAC;QACvH,IAAI,eAAe,eAAe,aAAa,EAAE,CAAC,kBAAkB;QAEpE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,aAAa,KAAK,CAAC;QAEjD,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,WAAW;YAAM,OAAO,MAAM,UAAU;QAAE;IACnE;AACD;AAEO,MAAM,wBAAwB,IAAA,4RAAI,EAAC;IACzC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,IAAI,QAAQ,CAAC;IACvD;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,EAAE,EAAE,SAAS,EAAyB;QAClE,MAAM,WAAW,IAAA,+KAA2B;QAC5C,MAAM,aAAa,IAAI,KAAK,KAAK,GAAG,KAAK,YAAY,KAAK,KAAK,KAAK;QAEpE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,aACL,MAAM,CAAC,uIACP,EAAE,CAAC,cAAc,WACjB,GAAG,CAAC,qBAAqB,WAAW,WAAW,IAC/C,KAAK,CAAC,qBAAqB;YAAE,WAAW;QAAK,GAC7C,KAAK,CAAC;QAER,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QAEzD,MAAM,UAAU,MAAM,OAAO,CAAC,IAAM,IAAI,KAAK,EAAE,iBAAiB,IAAI,IAAI,WAAW,EAAE;QACrF,MAAM,WAAW,MAAM,OAAO,CAAC,IAAM,IAAI,KAAK,EAAE,iBAAiB,KAAK,IAAI,WAAW,EAAE;QAEvF,OAAO;YACN,SAAS;YACT;YACA;YACA,cAAc,QAAQ,MAAM;YAC5B,eAAe,SAAS,MAAM;QAC/B;IACD;AACD;AAMO,MAAM,iBAAiB,IAAA,4RAAI,EAAC;IAClC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACtC,QAAQ,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAW;YAAa;YAAe;YAAa;SAAY,EAAE,QAAQ;QAC1F,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ;QACtC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,UAAU,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QACzF,MAAM,WAAW,IAAA,+KAA2B;QAE5C,0CAA0C;QAC1C,IAAI,SAAS,CAAC,UAAU,CAAC,YAAY;YACpC,MAAM,OAAO,MAAM,IAAA,mLAAkB,EAAC,UAAU,WAAW,OAAO;gBAAE;YAAM;YAC1E,OAAO;gBAAE,SAAS;gBAAM;gBAAM,OAAO,KAAK,MAAM;YAAC;QAClD;QAEA,sEAAsE;QACtE,IAAI,eAAe,SACjB,IAAI,CAAC,QACL,MAAM,CAAC,wHACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,cAAc;QAEnB,IAAI,OAAO,eAAe,aAAa,EAAE,CAAC,CAAC,aAAa,EAAE,MAAM,oBAAoB,EAAE,MAAM,CAAC,CAAC;QAC9F,IAAI,QAAQ,eAAe,aAAa,EAAE,CAAC,UAAU;QACrD,IAAI,YAAY,eAAe,aAAa,EAAE,CAAC,eAAe;QAE9D,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,aAAa,KAAK,CAAC,mBAAmB;YAAE,WAAW;QAAM,GAAG,KAAK,CAAC;QAEhG,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,MAAM;YAAM,OAAO,MAAM,UAAU;QAAE;IAC9D;AACD;AAEO,MAAM,wBAAwB,IAAA,4RAAI,EAAC;IACzC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACvC,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACvC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,UAAU,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC9B,MAAM,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAW;YAAgB;YAAY;SAAY,EAAE,OAAO,CAAC;QAC3E,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IACvC;IACA,SAAS,OAAO,QAAQ,EAAE,SAAS,EAAyB;QAC3D,MAAM,WAAW,IAAA,+KAA2B;QAC5C,MAAM,YAAY,IAAI,KAAK,OAAO,SAAS;QAC3C,MAAM,UAAU,IAAI,KAAK,UAAU,OAAO,KAAK,OAAO,QAAQ,GAAG;QAEjE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,gBACL,MAAM,CAAC;YACP,YAAY;YACZ,aAAa,OAAO,UAAU;YAC9B,aAAa,OAAO,UAAU;YAC9B,OAAO,OAAO,KAAK;YACnB,YAAY,UAAU,WAAW;YACjC,UAAU,QAAQ,WAAW;YAC7B,UAAU,OAAO,QAAQ;YACzB,MAAM,OAAO,IAAI;YACjB,OAAO,OAAO,KAAK;YACnB,QAAQ;QACT,GACC,MAAM,GACN,MAAM;QAER,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,aAAa;YAAM,SAAS,CAAC,0BAA0B,EAAE,UAAU,cAAc,IAAI;QAAC;IAC/G;AACD;AAEO,MAAM,wBAAwB,IAAA,4RAAI,EAAC;IACzC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC1B,UAAU,mOAAC,CAAC,MAAM,GAAG,OAAO,CAAC,IAAI,QAAQ,CAAC;IAC3C;IACA,SAAS,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,EAAE,EAAE,SAAS,EAAyB;QACvE,MAAM,WAAW,IAAA,+KAA2B;QAC5C,MAAM,aAAa,IAAI,KAAK;QAC5B,MAAM,WAAW,IAAI,KAAK,WAAW,QAAQ,CAAC,GAAG,GAAG,GAAG;QACvD,MAAM,SAAS,IAAI,KAAK,WAAW,QAAQ,CAAC,IAAI,GAAG,GAAG;QAEtD,yCAAyC;QACzC,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,gBACL,MAAM,CAAC,wBACP,EAAE,CAAC,cAAc,WACjB,GAAG,CAAC,cAAc,SAAS,WAAW,IACtC,GAAG,CAAC,cAAc,OAAO,WAAW,IACpC,GAAG,CAAC,UAAU;QAEhB,yCAAyC;QACzC,MAAM,iBAAiB,EAAE;QACzB,IAAI,cAAc;QAElB,MAAO,cAAc,OAAQ;YAC5B,MAAM,UAAU,IAAI,KAAK,YAAY,OAAO,KAAK,WAAW;YAC5D,MAAM,cAAc,cAAc,KAAK,CAAC;gBACvC,MAAM,WAAW,IAAI,KAAK,IAAI,UAAU;gBACxC,MAAM,SAAS,IAAI,KAAK,IAAI,QAAQ;gBACpC,OAAO,cAAc,UAAU,UAAU;YAC1C;YAEA,IAAI,CAAC,eAAe,WAAW,QAAQ;gBACtC,eAAe,IAAI,CAAC;oBACnB,OAAO,YAAY,WAAW;oBAC9B,KAAK,QAAQ,WAAW;gBACzB;YACD;YACA,cAAc,IAAI,KAAK,YAAY,OAAO,KAAK,KAAK,QAAQ,uBAAuB;QACpF;QAEA,OAAO;YAAE,SAAS;YAAM;YAAgB;QAAK;IAC9C;AACD;AAMO,MAAM,qBAAqB,IAAA,4RAAI,EAAC;IACtC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ;QAC1B,QAAQ,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAS;YAAQ;YAAU;YAAQ;YAAW;SAAY,EAAE,QAAQ;QACpF,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ;QACtC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,UAAU,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QACzF,MAAM,WAAW,IAAA,+KAA2B;QAC5C,IAAI,eAAe,SACjB,IAAI,CAAC,YACL,MAAM,CAAC,+GACP,EAAE,CAAC,cAAc;QAEnB,IAAI,OAAO,eAAe,aAAa,KAAK,CAAC,kBAAkB,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC;QAC3E,IAAI,QAAQ,eAAe,aAAa,EAAE,CAAC,UAAU;QACrD,IAAI,YAAY,eAAe,aAAa,EAAE,CAAC,eAAe;QAE9D,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,aAAa,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GAAG,KAAK,CAAC;QAE3F,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,UAAU;YAAM,OAAO,MAAM,UAAU;QAAE;IAClE;AACD;AAEO,MAAM,oBAAoB,IAAA,4RAAI,EAAC;IACrC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACvC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,WAAW,mOAAC,CAAC,KAAK,CAAC,mOAAC,CAAC,MAAM,CAAC;YAC3B,aAAa,mOAAC,CAAC,MAAM;YACrB,UAAU,mOAAC,CAAC,MAAM;YAClB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAChC,IAAI,QAAQ,CAAC;QACb,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACxC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ;IAC3B;IACA,SAAS,OAAO,QAAQ,EAAE,SAAS,EAAyB;QAC3D,MAAM,WAAW,IAAA,+KAA2B;QAE5C,mBAAmB;QACnB,MAAM,WAAW,OAAO,SAAS,CAAC,MAAM,CAAC,CAAC,KAAK,OAAS,MAAM,KAAK,QAAQ,GAAG,KAAK,SAAS,EAAE;QAC9F,MAAM,YAAY,KAAK,KAAK,CAAC,WAAW,OAAO,iBAAiB;QAChE,MAAM,cAAc,WAAW;QAE/B,0BAA0B;QAC1B,MAAM,gBAAgB,CAAC,IAAI,EAAE,KAAK,GAAG,GAAG,QAAQ,CAAC,IAAI,WAAW,IAAI;QAEpE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,YACL,MAAM,CAAC;YACP,YAAY;YACZ,aAAa,OAAO,UAAU;YAC9B,gBAAgB;YAChB,OAAO,OAAO,KAAK;YACnB,YAAY,OAAO,SAAS;YAC5B;YACA,YAAY;YACZ,cAAc;YACd,gBAAgB;YAChB,UAAU,OAAO,OAAO,GAAG,IAAI,KAAK,OAAO,OAAO,EAAE,WAAW,KAAK;YACpE,OAAO,OAAO,KAAK;YACnB,QAAQ;QACT,GACC,MAAM,GACN,MAAM;QAER,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YACN,SAAS;YACT,SAAS;YACT,SAAS,CAAC,gBAAgB,EAAE,cAAc,MAAM,EAAE,CAAC,cAAc,GAAG,EAAE,OAAO,CAAC,IAAI;QACnF;IACD;AACD;AAEO,MAAM,0BAA0B,IAAA,4RAAI,EAAC;IAC3C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,QAAQ,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAS;YAAQ;YAAS;YAAW;SAAO,EAAE,OAAO,CAAC;IACvE;IACA,SAAS,OAAO,EAAE,MAAM,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC/D,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,MAAM,IAAI;QAChB,IAAI;QAEJ,OAAQ;YACP,KAAK;gBACJ,YAAY,IAAI,KAAK,IAAI,QAAQ,CAAC,GAAG,GAAG,GAAG;gBAC3C;YACD,KAAK;gBACJ,YAAY,IAAI,KAAK,IAAI,OAAO,CAAC,IAAI,OAAO,KAAK;gBACjD;YACD,KAAK;gBACJ,YAAY,IAAI,KAAK,IAAI,QAAQ,CAAC,IAAI,QAAQ,KAAK;gBACnD;YACD,KAAK;gBACJ,YAAY,IAAI,KAAK,IAAI,QAAQ,CAAC,IAAI,QAAQ,KAAK;gBACnD;YACD,KAAK;gBACJ,YAAY,IAAI,KAAK,IAAI,WAAW,CAAC,IAAI,WAAW,KAAK;gBACzD;QACF;QAEA,MAAM,CAAC,gBAAgB,gBAAgB,cAAc,GAAG,MAAM,QAAQ,GAAG,CAAC;YACzE,SACE,IAAI,CAAC,YACL,MAAM,CAAC,qDACP,EAAE,CAAC,cAAc,WACjB,GAAG,CAAC,cAAc,UAAU,WAAW;YACzC,SACE,IAAI,CAAC,YACL,MAAM,CAAC,UACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU,aACb,GAAG,CAAC,cAAc,UAAU,WAAW;YACzC,SACE,IAAI,CAAC,YACL,MAAM,CAAC,kFACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU,QACb,EAAE,CAAC,YAAY,IAAI,OAAO,WAAW,IACrC,EAAE,CAAC,kBAAkB;SACvB;QAED,MAAM,gBAAgB,eAAe,IAAI,EAAE,OAAO,CAAC,KAAK,MAAQ,MAAM,IAAI,YAAY,EAAE,MAAM;QAC9F,MAAM,iBAAiB,eAAe,IAAI,EAAE,OAAO,CAAC,KAAK,MAAQ,MAAM,IAAI,MAAM,EAAE,MAAM;QACzF,MAAM,mBAAmB,eAAe,IAAI,EAAE,OAAO,CAAC,KAAK,MAAQ,MAAM,IAAI,cAAc,EAAE,MAAM;QAEnG,OAAO;YACN,SAAS;YACT;YACA,SAAS;gBACR,eAAe,gBAAgB;gBAC/B,gBAAgB,iBAAiB;gBACjC,kBAAkB,mBAAmB;gBACrC,cAAc,eAAe,IAAI,EAAE,UAAU;gBAC7C,gBAAgB,gBAAgB,IAAI,CAAC,AAAC,iBAAiB,gBAAiB,GAAG,EAAE,OAAO,CAAC,KAAK;YAC3F;YACA,iBAAiB,cAAc,IAAI,IAAI,EAAE;QAC1C;IACD;AACD;AAEO,MAAM,wBAAwB,IAAA,4RAAI,EAAC;IACzC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC,CAAC;IACtB,SAAS,OAAO,SAAS,EAAE,SAAS,EAAyB;QAC5D,MAAM,WAAW,IAAA,+KAA2B;QAC5C,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,2BACL,MAAM,CAAC,KACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,aAAa;QAElB,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,SAAS;QAAK;IACvC;AACD;AAEO,MAAM,uBAAuB,IAAA,4RAAI,EAAC;IACxC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,UAAU,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACrC,QAAQ,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC5B,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,QAAQ,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC/E,MAAM,WAAW,IAAA,+KAA2B;QAE5C,wBAAwB;QACxB,MAAM,EAAE,MAAM,MAAM,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAChD,IAAI,CAAC,2BACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,UACT,EAAE,CAAC,cAAc,WACjB,MAAM;QAER,IAAI,cAAc,CAAC,QAAQ,OAAO;YAAE,SAAS;YAAO,OAAO;QAAmB;QAE9E,MAAM,aAAa,CAAC,OAAO,eAAe,IAAI,CAAC,IAAI;QACnD,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,2BACL,MAAM,CAAC;YACP,iBAAiB;YACjB,YAAY,IAAI,OAAO,WAAW;QACnC,GACC,EAAE,CAAC,MAAM;QAEX,IAAI,aAAa,OAAO;YAAE,SAAS;YAAO,OAAO,YAAY,OAAO;QAAC;QAErE,OAAO;YACN,SAAS;YACT,SAAS,CAAC,aAAa,EAAE,CAAC,SAAS,GAAG,EAAE,OAAO,CAAC,GAAG,IAAI,EAAE,OAAO,IAAI,CAAC,gBAAgB,EAAE,CAAC,aAAa,GAAG,EAAE,OAAO,CAAC,IAAI;YACtH,QAAQ;gBAAE,GAAG,MAAM;gBAAE,iBAAiB;YAAW;QAClD;IACD;AACD;AAMO,MAAM,gBAAgB,IAAA,4RAAI,EAAC;IACjC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,IAAI,mOAAC,CAAC,MAAM,GAAG,KAAK,GAAG,QAAQ,CAAC;QAChC,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC7B,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC1B,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,GAAG,QAAQ,CAAC;IACnD;IACA,SAAS,OAAO,QAAQ,EAAE,SAAS,EAAyB;QAC3D,4CAA4C;QAC5C,MAAM,EAAE,MAAM,EAAE,GAAG;QAEnB,IAAI,CAAC,QAAQ;YACZ,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAA+B;QAChE;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,OAAO,MAAM,CAAC,IAAI,CAAC;YAChD,MAAM,QAAQ,GAAG,CAAC,iBAAiB,IAAI;YACvC,IAAI,OAAO,EAAE;YACb,SAAS,OAAO,OAAO;YACvB,MAAM,OAAO,IAAI;QAClB;QAEA,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QAEzD,oBAAoB;QACpB,MAAM,WAAW,IAAA,+KAA2B;QAC5C,MAAM,SAAS,IAAI,CAAC,kBAAkB,MAAM,CAAC;YAC5C,YAAY;YACZ,aAAa,OAAO,UAAU;YAC9B,MAAM;YACN,WAAW;YACX,YAAY,OAAO,EAAE;YACrB,SAAS,OAAO,OAAO;YACvB,MAAM,OAAO,IAAI;YACjB,WAAW,OAAO,IAAI;YACtB,QAAQ;YACR,SAAS,IAAI,OAAO,WAAW;YAC/B,qBAAqB,MAAM;QAC5B;QAEA,OAAO;YAAE,SAAS;YAAM,WAAW,MAAM;YAAI,SAAS,CAAC,cAAc,EAAE,OAAO,EAAE,EAAE;QAAC;IACpF;AACD;AAEO,MAAM,cAAc,IAAA,4RAAI,EAAC;IAC/B,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,IAAI,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QACxB,SAAS,mOAAC,CAAC,MAAM,GAAG,GAAG,CAAC,KAAK,QAAQ,CAAC;QACtC,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,GAAG,QAAQ,CAAC;IACnD;IACA,SAAS,OAAO,QAAQ,EAAE,SAAS,EAAyB;QAC3D,2BAA2B;QAC3B,MAAM,WAAW,IAAA,+KAA2B;QAC5C,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,iBACL,MAAM,CAAC,sCACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,cAAc,MACjB,MAAM;QAER,IAAI,CAAC,aAAa;YACjB,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAyC;QAC1E;QAEA,kBAAkB;QAClB,MAAM,EAAE,OAAO,EAAE,GAAG;QACpB,MAAM,SAAS,MAAM,QAAQ;YAC5B,MAAM,YAAY,YAAY;YAC9B,IAAI,OAAO,EAAE;YACb,MAAM,OAAO,OAAO;QACrB;QAEA,IAAI,CAAC,OAAO,OAAO,EAAE,OAAO;YAAE,SAAS;YAAO,OAAO,OAAO,KAAK;QAAC;QAElE,oBAAoB;QACpB,MAAM,SAAS,IAAI,CAAC,kBAAkB,MAAM,CAAC;YAC5C,YAAY;YACZ,aAAa,OAAO,UAAU;YAC9B,MAAM;YACN,WAAW;YACX,YAAY,OAAO,EAAE;YACrB,MAAM,OAAO,OAAO;YACpB,QAAQ;YACR,SAAS,IAAI,OAAO,WAAW;YAC/B,mBAAmB,OAAO,SAAS;QACpC;QAEA,OAAO;YAAE,SAAS;YAAM,WAAW,OAAO,SAAS;YAAE,SAAS,CAAC,YAAY,EAAE,OAAO,EAAE,EAAE;QAAC;IAC1F;AACD;AAEO,MAAM,mBAAmB,IAAA,4RAAI,EAAC;IACpC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,IAAI,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QACxB,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,GAAG,QAAQ,CAAC;QAClD,QAAQ,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IACxC;IACA,SAAS,OAAO,QAAQ,EAAE,SAAS,EAAyB;QAC3D,MAAM,WAAW,IAAA,+KAA2B;QAE5C,kCAAkC;QAClC,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,iBACL,MAAM,CAAC,sCACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,cAAc,MACjB,MAAM;QAER,IAAI,CAAC,aAAa;YACjB,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAA6B;QAC9D;QAEA,2BAA2B;QAC3B,MAAM,EAAE,YAAY,EAAE,GAAG;QACzB,MAAM,SAAS,MAAM,aAAa;YACjC,cAAc,YAAY,oBAAoB;YAC9C,MAAM,YAAY,YAAY;YAC9B,IAAI,OAAO,EAAE;QACd;QAEA,IAAI,CAAC,OAAO,OAAO,EAAE,OAAO;YAAE,SAAS;YAAO,OAAO,OAAO,KAAK;QAAC;QAElE,oBAAoB;QACpB,MAAM,SAAS,IAAI,CAAC,kBAAkB,MAAM,CAAC;YAC5C,YAAY;YACZ,aAAa,OAAO,UAAU;YAC9B,MAAM;YACN,WAAW;YACX,YAAY,OAAO,EAAE;YACrB,cAAc,YAAY,YAAY;YACtC,MAAM,OAAO,MAAM,IAAI;YACvB,QAAQ;YACR,wBAAwB,OAAO,aAAa;QAC7C;QAEA,OAAO;YACN,SAAS;YACT,eAAe,OAAO,aAAa;YACnC,SAAS,CAAC,kBAAkB,EAAE,OAAO,EAAE,EAAE;QAC1C;IACD;AACD;AAEO,MAAM,8BAA8B,IAAA,4RAAI,EAAC;IAC/C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACvC,MAAM,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAO;YAAS;YAAO;SAAO,EAAE,QAAQ,GAAG,OAAO,CAAC;QACjE,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,UAAU,EAAE,IAAI,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QAChF,MAAM,WAAW,IAAA,+KAA2B;QAC5C,IAAI,eAAe,SACjB,IAAI,CAAC,kBACL,MAAM,CAAC,KACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,eAAe;QAEpB,IAAI,SAAS,OAAO,eAAe,aAAa,EAAE,CAAC,QAAQ;QAE3D,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,aAC5B,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC;QAER,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,gBAAgB;QAAK;IAC9C;AACD;AAMO,MAAM,0BAA0B,IAAA,4RAAI,EAAC;IAC3C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC,CAAC;IACtB,SAAS,OAAO,SAAS,EAAE,SAAS,EAAyB;QAC5D,MAAM,WAAW,IAAA,+KAA2B;QAC5C,MAAM,MAAM,IAAI;QAChB,MAAM,gBAAgB,IAAI,KAAK,IAAI,OAAO,CAAC,IAAI,OAAO,KAAK;QAE3D,MAAM,CAAC,iBAAiB,YAAY,eAAe,GAAG,MAAM,QAAQ,GAAG,CAAC;YACvE,SACE,IAAI,CAAC,aACL,MAAM,CAAC,MAAM;gBAAE,OAAO;gBAAS,MAAM;YAAK,GAC1C,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU;YACf,SACE,IAAI,CAAC,QACL,MAAM,CAAC,4BACP,EAAE,CAAC,cAAc,WACjB,GAAG,CAAC,cAAc,cAAc,WAAW;YAC7C,SACE,IAAI,CAAC,YACL,MAAM,CAAC,4CACP,EAAE,CAAC,cAAc,WACjB,GAAG,CAAC,cAAc,cAAc,WAAW;SAC7C;QAED,MAAM,gBAAgB,WAAW,IAAI,EAAE,OAAO,CAAC,IAAM,EAAE,MAAM,KAAK,gBAAgB,EAAE;QACpF,MAAM,kBAAkB,eAAe,IAAI,EAAE,OAAO,CAAC,IAAM,EAAE,MAAM,KAAK,UAAU,EAAE,cAAc,GAAG,MAAM,EAAE;QAE7G,OAAO;YACN,SAAS;YACT,SAAS;gBACR,iBAAiB,gBAAgB,KAAK,IAAI;gBAC1C,gBAAgB,WAAW,IAAI,EAAE,UAAU;gBAC3C,yBAAyB,cAAc,MAAM;gBAC7C,mBAAmB,WAAW,IAAI,EAAE,SACjC,CAAC,AAAC,cAAc,MAAM,GAAG,WAAW,IAAI,CAAC,MAAM,GAAI,GAAG,EAAE,OAAO,CAAC,KAChE;gBACH,oBAAoB,eAAe,IAAI,EAAE,UAAU;gBACnD,qBAAqB,gBAAgB,MAAM;gBAC3C,kBAAkB,gBAAgB,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,cAAc,EAAE,KAAK;YACnF;QACD;IACD;AACD;AAEO,MAAM,2BAA2B,IAAA,4RAAI,EAAC;IAC5C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC,CAAC;IACtB,SAAS,OAAO,SAAS,EAAE,SAAS,EAAyB;QAC5D,MAAM,WAAW,IAAA,+KAA2B;QAE5C,uBAAuB;QACvB,MAAM,CAAC,eAAe,yBAAyB,2BAA2B,GAAG,MAAM,QAAQ,GAAG,CAAC;YAC9F,mBAAmB;YACnB,SACE,IAAI,CAAC,YACL,MAAM,CAAC,gGACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU,QACb,EAAE,CAAC,YAAY,IAAI,OAAO,WAAW,IACrC,EAAE,CAAC,kBAAkB,GACrB,KAAK,CAAC;YACR,kCAAkC;YAClC,SACE,IAAI,CAAC,aACL,MAAM,CAAC,iDACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU,UACb,EAAE,CAAC,iBAAiB,IAAI,KAAK,KAAK,GAAG,KAAK,KAAK,KAAK,KAAK,KAAK,MAAM,WAAW,IAC/E,KAAK,CAAC;YACR,0BAA0B;YAC1B,SACE,IAAI,CAAC,gBACL,MAAM,CAAC,kEACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU,aACb,GAAG,CAAC,cAAc,IAAI,OAAO,WAAW,IACxC,EAAE,CAAC,cAAc,IAAI,KAAK,KAAK,GAAG,KAAK,KAAK,KAAK,KAAK,MAAM,WAAW,IACvE,KAAK,CAAC;SACR;QAED,MAAM,WAAW,EAAE;QAEnB,IAAI,cAAc,IAAI,IAAI,cAAc,IAAI,CAAC,MAAM,GAAG,GAAG;YACxD,MAAM,eAAe,cAAc,IAAI,CAAC,MAAM,CAAC,CAAC,KAAK,MAAQ,MAAM,IAAI,cAAc,EAAE;YACvF,SAAS,IAAI,CAAC;gBACb,MAAM;gBACN,UAAU;gBACV,OAAO,GAAG,cAAc,IAAI,CAAC,MAAM,CAAC,4BAA4B,EAAE,CAAC,eAAe,GAAG,EAAE,OAAO,CAAC,IAAI;gBACnG,gBAAgB;gBAChB,MAAM,cAAc,IAAI;YACzB;QACD;QAEA,IAAI,wBAAwB,IAAI,IAAI,wBAAwB,IAAI,CAAC,MAAM,GAAG,GAAG;YAC5E,SAAS,IAAI,CAAC;gBACb,MAAM;gBACN,UAAU;gBACV,OAAO,GAAG,wBAAwB,IAAI,CAAC,MAAM,CAAC,0CAA0C,CAAC;gBACzF,gBAAgB;gBAChB,MAAM,wBAAwB,IAAI;YACnC;QACD;QAEA,IAAI,2BAA2B,IAAI,IAAI,2BAA2B,IAAI,CAAC,MAAM,GAAG,GAAG;YAClF,SAAS,IAAI,CAAC;gBACb,MAAM;gBACN,UAAU;gBACV,OAAO,GAAG,2BAA2B,IAAI,CAAC,MAAM,CAAC,oCAAoC,CAAC;gBACtF,gBAAgB;gBAChB,MAAM,2BAA2B,IAAI;YACtC;QACD;QAEA,OAAO;YAAE,SAAS;YAAM;QAAS;IAClC;AACD;AAMO,MAAM,uBAAuB,IAAA,4RAAI,EAAC;IACxC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,eAAe,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAY;YAAe;SAAS,EAAE,QAAQ,CAAC;QACtE,aAAa,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACxC,SAAS,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAS;YAAO;SAAO,EAAE,QAAQ,CAAC;QACnD,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACxC,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC7B,QAAQ,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC5B,WAAW,mOAAC,CAAC,MAAM,CAAC;YACnB,MAAM,mOAAC,CAAC,IAAI,CAAC;gBAAC;gBAAO;gBAAW;gBAAe;aAAW,EAAE,QAAQ;YACpE,IAAI,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ;QAC/B,GAAG,QAAQ,GAAG,QAAQ,CAAC;IACxB;IACA,SAAS,OAAO,QAAQ,EAAE,SAAS,EAAyB;QAC3D,MAAM,WAAW,IAAA,+KAA2B;QAE5C,sCAAsC;QACtC,IAAI,iBAAgC;QACpC,IAAI,iBAAgC;QACpC,IAAI,gBAAgB;QAEpB,IAAI,OAAO,aAAa,KAAK,YAAY;YACxC,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,aACL,MAAM,CAAC,8BACP,EAAE,CAAC,MAAM,OAAO,WAAW,EAC3B,EAAE,CAAC,cAAc,WACjB,MAAM;YACR,IAAI,MAAM;gBACT,iBAAiB,KAAK,KAAK;gBAC3B,iBAAiB,KAAK,KAAK;gBAC3B,gBAAgB,KAAK,YAAY;YAClC;QACD,OAAO,IAAI,OAAO,aAAa,KAAK,eAAe;YAClD,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,gBACL,MAAM,CAAC,uCACP,EAAE,CAAC,MAAM,OAAO,WAAW,EAC3B,EAAE,CAAC,cAAc,WACjB,MAAM;YACR,IAAI,MAAM;gBACT,iBAAiB,KAAK,KAAK;gBAC3B,iBAAiB,KAAK,KAAK;gBAC3B,gBAAgB,GAAG,KAAK,UAAU,CAAC,CAAC,EAAE,KAAK,SAAS,EAAE;YACvD;QACD,OAAO,IAAI,OAAO,aAAa,KAAK,UAAU;YAC7C,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,WACL,MAAM,CAAC,sBACP,EAAE,CAAC,MAAM,OAAO,WAAW,EAC3B,EAAE,CAAC,cAAc,WACjB,MAAM;YACR,IAAI,MAAM;gBACT,iBAAiB,KAAK,KAAK;gBAC3B,iBAAiB,KAAK,KAAK;gBAC3B,gBAAgB,KAAK,IAAI;YAC1B;QACD;QAEA,IAAI,CAAC,kBAAkB,CAAC,gBAAgB;YACvC,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAA0C;QAC3E;QAEA,gCAAgC;QAChC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,2BACL,MAAM,CAAC;YACP,YAAY;YACZ,gBAAgB,OAAO,aAAa;YACpC,cAAc,OAAO,WAAW;YAChC,gBAAgB;YAChB,iBAAiB;YACjB,iBAAiB;YACjB,SAAS,OAAO,OAAO;YACvB,SAAS,OAAO,OAAO;YACvB,SAAS,OAAO,OAAO;YACvB,cAAc,OAAO,MAAM;YAC3B,cAAc,OAAO,SAAS,EAAE;YAChC,YAAY,OAAO,SAAS,EAAE;YAC9B,QAAQ;QACT,GACC,MAAM,GACN,MAAM;QAER,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QAEzD,OAAO;YACN,SAAS;YACT,UAAU;YACV,SAAS,CAAC,uBAAuB,EAAE,cAAc,IAAI,EAAE,IAAI,KAAK,OAAO,MAAM,EAAE,cAAc,IAAI;QAClG;IACD;AACD;AAEO,MAAM,qBAAqB,IAAA,4RAAI,EAAC;IACtC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;IACxC;IACA,SAAS,OAAO,EAAE,UAAU,EAAE,EAAE,EAAE,SAAS,EAAyB;QACnE,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACtB,IAAI,CAAC,2BACL,MAAM,CAAC;YAAE,QAAQ;QAAY,GAC7B,EAAE,CAAC,MAAM,YACT,EAAE,CAAC,cAAc;QAEnB,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,SAAS;QAAkC;IACpE;AACD;AAEO,MAAM,4BAA4B,IAAA,4RAAI,EAAC;IAC7C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,eAAe,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAY;YAAe;SAAS,EAAE,QAAQ;QACrE,aAAa,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ;QACvC,aAAa,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAO;YAAW;YAAe;SAAW,EAAE,QAAQ;QAC3E,WAAW,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ;QACrC,QAAQ,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAa;YAAQ;YAAa;SAAS,EAAE,QAAQ,GAAG,OAAO,CAAC;IACjF;IACA,SAAS,OAAO,QAAQ,EAAE,SAAS,EAAyB;QAC3D,MAAM,WAAW,IAAA,+KAA2B;QAC5C,IAAI,eAAe,SACjB,IAAI,CAAC,2BACL,MAAM,CAAC,KACP,EAAE,CAAC,cAAc;QAEnB,IAAI,OAAO,aAAa,EAAE,eAAe,aAAa,EAAE,CAAC,kBAAkB,OAAO,aAAa;QAC/F,IAAI,OAAO,WAAW,EAAE,eAAe,aAAa,EAAE,CAAC,gBAAgB,OAAO,WAAW;QACzF,IAAI,OAAO,WAAW,EAAE,eAAe,aAAa,EAAE,CAAC,gBAAgB,OAAO,WAAW;QACzF,IAAI,OAAO,SAAS,EAAE,eAAe,aAAa,EAAE,CAAC,cAAc,OAAO,SAAS;QACnF,IAAI,OAAO,MAAM,EAAE,eAAe,aAAa,EAAE,CAAC,UAAU,OAAO,MAAM;QAEzE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,aAAa,KAAK,CAAC,gBAAgB;YAAE,WAAW;QAAK;QAEnF,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,WAAW;YAAM,OAAO,MAAM,UAAU;QAAE;IACnE;AACD;AAEO,MAAM,gCAAgC,IAAA,4RAAI,EAAC;IACjD,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,eAAe,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAY;YAAe;SAAS,EAAE,QAAQ,CAAC;QACtE,aAAa,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACxC,SAAS,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAS;YAAO;SAAO,EAAE,QAAQ,CAAC;QACnD,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACxC,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC7B,UAAU,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAU;YAAQ;SAAS,EAAE,QAAQ,GAAG,OAAO,CAAC;IACnE;IACA,SAAS,OAAO,QAAQ,EAAE,SAAS,EAAyB;QAC3D,MAAM,WAAW,IAAA,+KAA2B;QAC5C,MAAM,UAAgJ,CAAC;QAEvJ,wBAAwB;QACxB,IAAI,iBAAgC;QACpC,IAAI,iBAAgC;QACpC,IAAI,gBAAgB;QAEpB,IAAI,OAAO,aAAa,KAAK,YAAY;YACxC,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,aAAa,MAAM,CAAC,8BAA8B,EAAE,CAAC,MAAM,OAAO,WAAW,EAAE,MAAM;YAC1H,IAAI,MAAM;gBAAE,iBAAiB,KAAK,KAAK;gBAAE,iBAAiB,KAAK,KAAK;gBAAE,gBAAgB,KAAK,YAAY;YAAE;QAC1G,OAAO,IAAI,OAAO,aAAa,KAAK,eAAe;YAClD,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,gBAAgB,MAAM,CAAC,uCAAuC,EAAE,CAAC,MAAM,OAAO,WAAW,EAAE,MAAM;YACtI,IAAI,MAAM;gBAAE,iBAAiB,KAAK,KAAK;gBAAE,iBAAiB,KAAK,KAAK;gBAAE,gBAAgB,GAAG,KAAK,UAAU,CAAC,CAAC,EAAE,KAAK,SAAS,EAAE;YAAE;QAC/H,OAAO,IAAI,OAAO,aAAa,KAAK,UAAU;YAC7C,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,WAAW,MAAM,CAAC,sBAAsB,EAAE,CAAC,MAAM,OAAO,WAAW,EAAE,MAAM;YAChH,IAAI,MAAM;gBAAE,iBAAiB,KAAK,KAAK;gBAAE,iBAAiB,KAAK,KAAK;gBAAE,gBAAgB,KAAK,IAAI;YAAE;QAClG;QAEA,0BAA0B;QAC1B,IAAI,CAAC,OAAO,OAAO,KAAK,WAAW,OAAO,OAAO,KAAK,MAAM,KAAK,gBAAgB;YAChF,MAAM,EAAE,MAAM,EAAE,GAAG;YACnB,IAAI,QAAQ;gBACX,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,OAAO,MAAM,CAAC,IAAI,CAAC;oBAChD,MAAM,QAAQ,GAAG,CAAC,iBAAiB,IAAI;oBACvC,IAAI;oBACJ,SAAS,OAAO,OAAO,IAAI;oBAC3B,MAAM,OAAO,OAAO;gBACrB;gBACA,QAAQ,KAAK,GAAG,QAAQ;oBAAE,SAAS;oBAAO,OAAO,MAAM,OAAO;gBAAC,IAAI;oBAAE,SAAS;oBAAM,WAAW,MAAM;gBAAG;YACzG;QACD;QAEA,wBAAwB;QACxB,IAAI,CAAC,OAAO,OAAO,KAAK,SAAS,OAAO,OAAO,KAAK,MAAM,KAAK,gBAAgB;YAC9E,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,iBAAiB,MAAM,CAAC,gBAAgB,EAAE,CAAC,cAAc,WAAW,EAAE,CAAC,cAAc,MAAM,MAAM;YACnJ,IAAI,aAAa;gBAChB,MAAM,EAAE,OAAO,EAAE,GAAG;gBACpB,MAAM,SAAS,MAAM,QAAQ;oBAAE,MAAM,YAAY,YAAY;oBAAE,IAAI;oBAAgB,MAAM,OAAO,OAAO,CAAC,KAAK,CAAC,GAAG;gBAAK;gBACtH,QAAQ,GAAG,GAAG,OAAO,OAAO,GAAG;oBAAE,SAAS;oBAAM,WAAW,OAAO,SAAS;gBAAC,IAAI;oBAAE,SAAS;oBAAO,OAAO,OAAO,KAAK;gBAAC;YACvH;QACD;QAEA,OAAO;YAAE,SAAS;YAAM;YAAS,SAAS,CAAC,qBAAqB,EAAE,eAAe;QAAC;IACnF;AACD;AAMO,MAAM,0BAA0B,IAAA,4RAAI,EAAC;IAC3C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,GAAG,QAAQ,CAAC;QAC7C,QAAQ,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAQ;YAAS;YAAW;SAAO,EAAE,QAAQ,GAAG,OAAO,CAAC;QACxE,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC7E,MAAM,WAAW,IAAA,+KAA2B;QAE5C,IAAI,OAAO;YACV,qBAAqB;YACrB,MAAM,EAAE,MAAM,GAAG,EAAE,KAAK,EAAE,GAAG,MAAM,SACjC,IAAI,CAAC,QACL,MAAM,CAAC,4FACP,EAAE,CAAC,MAAM,OACT,EAAE,CAAC,cAAc,WACjB,MAAM;YAER,IAAI,OAAO,OAAO;gBAAE,SAAS;gBAAO,OAAO,MAAM,OAAO;YAAC;YAEzD,MAAM,YAAY,KAAK,cAAc;YACrC,MAAM,eAAe,KAAK,iBAAiB;YAC3C,MAAM,eAAe,KAAK,gBAAgB;YAC1C,MAAM,SAAS,eAAe,YAAY;YAC1C,MAAM,SAAS,eAAe,IAAI,AAAC,SAAS,eAAgB,MAAM;YAElE,OAAO;gBACN,SAAS;gBACT,KAAK;oBACJ,GAAG,GAAG;oBACN,SAAS;wBACR,WAAW,YAAY;wBACvB,cAAc,eAAe;wBAC7B,WAAW,CAAC,YAAY,YAAY,IAAI;wBACxC,SAAS,eAAe;wBACxB,QAAQ,SAAS;wBACjB,eAAe,OAAO,OAAO,CAAC;oBAC/B;gBACD;YACD;QACD;QAEA,iBAAiB;QACjB,MAAM,MAAM,IAAI;QAChB,IAAI;QACJ,OAAQ;YACP,KAAK;gBAAQ,YAAY,IAAI,KAAK,IAAI,OAAO,CAAC,IAAI,OAAO,KAAK;gBAAK;YACnE,KAAK;gBAAS,YAAY,IAAI,KAAK,IAAI,QAAQ,CAAC,IAAI,QAAQ,KAAK;gBAAK;YACtE,KAAK;gBAAW,YAAY,IAAI,KAAK,IAAI,QAAQ,CAAC,IAAI,QAAQ,KAAK;gBAAK;YACxE,KAAK;gBAAQ,YAAY,IAAI,KAAK,IAAI,WAAW,CAAC,IAAI,WAAW,KAAK;gBAAK;QAC5E;QAEA,MAAM,EAAE,MAAM,IAAI,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,QACL,MAAM,CAAC,8GACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU,aACb,GAAG,CAAC,gBAAgB,UAAU,WAAW,IACzC,KAAK,CAAC,gBAAgB;YAAE,WAAW;QAAM,GACzC,KAAK,CAAC;QAER,MAAM,UAAU;YACf,WAAW,MAAM,UAAU;YAC3B,cAAc,CAAC,MAAM,OAAO,CAAC,GAAG,IAAM,IAAI,CAAC,EAAE,YAAY,IAAI,CAAC,GAAG,MAAM,CAAC,IAAI;YAC5E,gBAAgB,CAAC,MAAM,OAAO,CAAC,GAAG,IAAM,IAAI,CAAC,EAAE,UAAU,IAAI,CAAC,GAAG,MAAM,CAAC,IAAI;YAC5E,mBAAmB,CAAC,MAAM,OAAO,CAAC,GAAG,IAAM,IAAI,CAAC,EAAE,aAAa,IAAI,CAAC,GAAG,MAAM,CAAC,IAAI;YAClF,aAAa;YACb,eAAe;QAChB;QACA,QAAQ,WAAW,GAAG,QAAQ,YAAY,GAAG,QAAQ,cAAc,GAAG,QAAQ,iBAAiB;QAC/F,QAAQ,aAAa,GAAG,QAAQ,YAAY,GAAG,IAAI,AAAC,QAAQ,WAAW,GAAG,QAAQ,YAAY,GAAI,MAAM;QAExG,OAAO;YAAE,SAAS;YAAM;YAAQ;YAAS;QAAK;IAC/C;AACD;AAEO,MAAM,0BAA0B,IAAA,4RAAI,EAAC;IAC3C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,SAAS,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAY;YAAgB;YAAS;SAAO,EAAE,OAAO,CAAC;QACvE,QAAQ,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAS;YAAW;SAAO,EAAE,OAAO,CAAC;QACrD,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,OAAO,EAAE,MAAM,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC/E,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,MAAM,IAAI;QAChB,IAAI;QACJ,OAAQ;YACP,KAAK;gBAAS,YAAY,IAAI,KAAK,IAAI,QAAQ,CAAC,IAAI,QAAQ,KAAK;gBAAK;YACtE,KAAK;gBAAW,YAAY,IAAI,KAAK,IAAI,QAAQ,CAAC,IAAI,QAAQ,KAAK;gBAAK;YACxE,KAAK;gBAAQ,YAAY,IAAI,KAAK,IAAI,WAAW,CAAC,IAAI,WAAW,KAAK;gBAAK;QAC5E;QAEA,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC/B,IAAI,CAAC,YACL,MAAM,CAAC,2GACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU,QACb,GAAG,CAAC,cAAc,UAAU,WAAW;QAEzC,aAAa;QACb,MAAM,YAA+E,CAAC;QAEtF,UAAU,QAAQ,CAAC;YAClB,IAAI,MAAM;YACV,IAAI,QAAQ;YAEZ,IAAI,YAAY,YAAY;gBAC3B,MAAM,IAAI,QAAQ,EAAE,MAAM;gBAC1B,QAAQ,IAAI,QAAQ,EAAE,gBAAgB;YACvC,OAAO,IAAI,YAAY,gBAAgB;gBACtC,MAAM,IAAI,GAAG,EAAE,gBAAgB;gBAC/B,QAAQ,IAAI,GAAG,EAAE,gBAAgB;YAClC,OAAO,IAAI,YAAY,SAAS;gBAC/B,MAAM,OAAO,IAAI,KAAK,IAAI,UAAU;gBACpC,MAAM,GAAG,KAAK,WAAW,GAAG,CAAC,EAAE,CAAC,KAAK,QAAQ,KAAK,CAAC,EAAE,QAAQ,GAAG,QAAQ,CAAC,GAAG,MAAM;gBAClF,QAAQ,KAAK,kBAAkB,CAAC,SAAS;oBAAE,MAAM;oBAAW,OAAO;gBAAQ;YAC5E,OAAO,IAAI,YAAY,QAAQ;gBAC9B,MAAM,OAAO,IAAI,KAAK,IAAI,UAAU;gBACpC,MAAM,YAAY,IAAI,KAAK,KAAK,OAAO,CAAC,KAAK,OAAO,KAAK,KAAK,MAAM;gBACpE,MAAM,UAAU,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;gBAC3C,QAAQ,CAAC,QAAQ,EAAE,UAAU,kBAAkB,IAAI;YACpD;YAEA,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,SAAS,CAAC,IAAI,GAAG;gBAAE;gBAAO,SAAS;gBAAG,OAAO;YAAE;YACpE,SAAS,CAAC,IAAI,CAAC,OAAO,IAAI,CAAC,IAAI,WAAW,IAAI,CAAC,IAAI;YACnD,SAAS,CAAC,IAAI,CAAC,KAAK,IAAI;QACzB;QAEA,MAAM,UAAU,OAAO,MAAM,CAAC,WAAW,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,OAAO,GAAG,EAAE,OAAO,EAAE,KAAK,CAAC,GAAG;QACxF,MAAM,eAAe,QAAQ,MAAM,CAAC,CAAC,GAAG,IAAM,IAAI,EAAE,OAAO,EAAE;QAE7D,OAAO;YAAE,SAAS;YAAM;YAAS;YAAQ,WAAW;YAAS;QAAa;IAC3E;AACD;AAEO,MAAM,uBAAuB,IAAA,4RAAI,EAAC;IACxC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC,CAAC;IACtB,SAAS,OAAO,SAAS,EAAE,SAAS,EAAyB;QAC5D,MAAM,WAAW,IAAA,+KAA2B;QAC5C,MAAM,MAAM,IAAI;QAEhB,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC/B,IAAI,CAAC,YACL,MAAM,CAAC,4GACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU;YAAC;YAAQ;SAAS,EAC/B,EAAE,CAAC,kBAAkB;QAEvB,MAAM,QAAQ;YACb,SAAS;gBAAE,QAAQ;gBAAG,OAAO;gBAAG,UAAU,EAAE;YAAoB;YAChE,QAAQ;gBAAE,QAAQ;gBAAG,OAAO;gBAAG,UAAU,EAAE;YAAoB;YAC/D,QAAQ;gBAAE,QAAQ;gBAAG,OAAO;gBAAG,UAAU,EAAE;YAAoB;YAC/D,YAAY;gBAAE,QAAQ;gBAAG,OAAO;gBAAG,UAAU,EAAE;YAAoB;QACpE;QAEA,UAAU,QAAQ,CAAC;YAClB,MAAM,UAAU,IAAI,KAAK,IAAI,QAAQ;YACrC,MAAM,cAAc,KAAK,KAAK,CAAC,CAAC,IAAI,OAAO,KAAK,QAAQ,OAAO,EAAE,IAAI,CAAC,OAAO,KAAK,KAAK,EAAE;YAEzF,IAAI,eAAe,GAAG;gBACrB,MAAM,OAAO,CAAC,MAAM,IAAI,IAAI,cAAc;gBAC1C,MAAM,OAAO,CAAC,KAAK,IAAI;gBACvB,MAAM,OAAO,CAAC,QAAQ,EAAE,KAAK;YAC9B,OAAO,IAAI,eAAe,IAAI;gBAC7B,MAAM,MAAM,CAAC,MAAM,IAAI,IAAI,cAAc;gBACzC,MAAM,MAAM,CAAC,KAAK,IAAI;gBACtB,MAAM,MAAM,CAAC,QAAQ,EAAE,KAAK;YAC7B,OAAO,IAAI,eAAe,IAAI;gBAC7B,MAAM,MAAM,CAAC,MAAM,IAAI,IAAI,cAAc;gBACzC,MAAM,MAAM,CAAC,KAAK,IAAI;gBACtB,MAAM,MAAM,CAAC,QAAQ,EAAE,KAAK;YAC7B,OAAO;gBACN,MAAM,UAAU,CAAC,MAAM,IAAI,IAAI,cAAc;gBAC7C,MAAM,UAAU,CAAC,KAAK,IAAI;gBAC1B,MAAM,UAAU,CAAC,QAAQ,EAAE,KAAK;YACjC;QACD;QAEA,qBAAqB;QACrB,OAAO,IAAI,CAAC,OAAO,OAAO,CAAC,CAAC;YAC3B,KAAK,CAAC,IAA0B,CAAC,MAAM,GAAG,KAAK,CAAC,IAA0B,CAAC,MAAM,GAAG;QACrF;QAEA,MAAM,mBAAmB,MAAM,OAAO,CAAC,MAAM,GAAG,MAAM,MAAM,CAAC,MAAM,GAAG,MAAM,MAAM,CAAC,MAAM,GAAG,MAAM,UAAU,CAAC,MAAM;QAEnH,OAAO;YAAE,SAAS;YAAM;YAAO;YAAkB,eAAe,UAAU,UAAU;QAAE;IACvF;AACD;AAEO,MAAM,+BAA+B,IAAA,4RAAI,EAAC;IAChD,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,cAAc,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACpD,QAAQ,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAQ;YAAS;YAAW;SAAO,EAAE,OAAO,CAAC;IAC9D;IACA,SAAS,OAAO,EAAE,YAAY,EAAE,MAAM,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC7E,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,MAAM,IAAI;QAChB,IAAI;QACJ,OAAQ;YACP,KAAK;gBAAQ,YAAY,IAAI,KAAK,IAAI,OAAO,CAAC,IAAI,OAAO,KAAK;gBAAK;YACnE,KAAK;gBAAS,YAAY,IAAI,KAAK,IAAI,QAAQ,CAAC,IAAI,QAAQ,KAAK;gBAAK;YACtE,KAAK;gBAAW,YAAY,IAAI,KAAK,IAAI,QAAQ,CAAC,IAAI,QAAQ,KAAK;gBAAK;YACxE,KAAK;gBAAQ,YAAY,IAAI,KAAK,IAAI,WAAW,CAAC,IAAI,WAAW,KAAK;gBAAK;QAC5E;QAEA,IAAI,eAAe,SACjB,IAAI,CAAC,QACL,MAAM,CAAC,uDACP,EAAE,CAAC,cAAc,WACjB,GAAG,CAAC,cAAc,UAAU,WAAW;QAEzC,IAAI,cAAc,eAAe,aAAa,EAAE,CAAC,eAAe;QAEhE,MAAM,EAAE,MAAM,IAAI,EAAE,GAAG,MAAM;QAC7B,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,gBACL,MAAM,CAAC,mCACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU;QAEf,2BAA2B;QAC3B,MAAM,cAOD,CAAC;QAEN,aAAa,QAAQ,CAAC;YACrB,WAAW,CAAC,GAAG,EAAE,CAAC,GAAG;gBACpB,MAAM,GAAG,GAAG,UAAU,CAAC,CAAC,EAAE,GAAG,SAAS,EAAE;gBACxC,MAAM,GAAG,IAAI;gBACb,cAAc;gBACd,eAAe;gBACf,gBAAgB;gBAChB,SAAS;YACV;QACD;QAEA,MAAM,QAAQ,CAAC;YACd,IAAI,IAAI,WAAW,IAAI,WAAW,CAAC,IAAI,WAAW,CAAC,EAAE;gBACpD,WAAW,CAAC,IAAI,WAAW,CAAC,CAAC,YAAY,IAAI;gBAC7C,IAAI,IAAI,MAAM,KAAK,aAAa;oBAC/B,WAAW,CAAC,IAAI,WAAW,CAAC,CAAC,aAAa,IAAI;oBAC9C,WAAW,CAAC,IAAI,WAAW,CAAC,CAAC,OAAO,IAAI,CAAC,IAAI,YAAY,IAAI,CAAC,IAAI;gBACnE;YACD;QACD;QAEA,6BAA6B;QAC7B,OAAO,MAAM,CAAC,aAAa,OAAO,CAAC,CAAC;YACnC,EAAE,cAAc,GAAG,EAAE,YAAY,GAAG,IAAI,AAAC,EAAE,aAAa,GAAG,EAAE,YAAY,GAAI,MAAM;QACpF;QAEA,MAAM,UAAU,OAAO,MAAM,CAAC,aAAa,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,OAAO,GAAG,EAAE,OAAO;QAE/E,OAAO;YAAE,SAAS;YAAM;YAAQ,aAAa;QAAQ;IACtD;AACD;AAEO,MAAM,+BAA+B,IAAA,4RAAI,EAAC;IAChD,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,GAAG,QAAQ,CAAC;QAClD,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,UAAU,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC1E,MAAM,WAAW,IAAA,+KAA2B;QAE5C,IAAI,YAAY;YACf,sBAAsB;YACtB,MAAM,CAAC,gBAAgB,gBAAgB,WAAW,GAAG,MAAM,QAAQ,GAAG,CAAC;gBACtE,SAAS,IAAI,CAAC,aAAa,MAAM,CAAC,KAAK,EAAE,CAAC,MAAM,YAAY,EAAE,CAAC,cAAc,WAAW,MAAM;gBAC9F,SAAS,IAAI,CAAC,YAAY,MAAM,CAAC,iDAAiD,EAAE,CAAC,eAAe;gBACpG,SAAS,IAAI,CAAC,QAAQ,MAAM,CAAC,4BAA4B,EAAE,CAAC,eAAe;aAC3E;YAED,IAAI,eAAe,KAAK,EAAE,OAAO;gBAAE,SAAS;gBAAO,OAAO,eAAe,KAAK,CAAC,OAAO;YAAC;YAEvF,MAAM,eAAe,CAAC,eAAe,IAAI,EAAE,OAAO,CAAC,IAAM,EAAE,MAAM,KAAK,QAAQ,OAAO,CAAC,GAAG,IAAM,IAAI,CAAC,EAAE,WAAW,IAAI,CAAC,GAAG,MAAM,CAAC,IAAI;YACpI,MAAM,WAAW,WAAW,IAAI,EAAE,UAAU;YAC5C,MAAM,eAAe,eAAe,IAAI,EAAE,KAAK,CAAC,GAAG,IAAM,IAAI,KAAK,EAAE,UAAU,EAAE,OAAO,KAAK,IAAI,KAAK,EAAE,UAAU,EAAE,OAAO,GAAG,CAAC,EAAE;YAChI,MAAM,gBAAgB,eAAe,IAAI,KAAK,aAAa,UAAU,IAAI,IAAI,KAAK,eAAe,IAAI,CAAC,UAAU;YAChH,MAAM,mBAAmB,KAAK,GAAG,CAAC,GAAG,KAAK,KAAK,CAAC,CAAC,KAAK,GAAG,KAAK,cAAc,OAAO,EAAE,IAAI,CAAC,OAAO,KAAK,KAAK,KAAK,EAAE;YAElH,OAAO;gBACN,SAAS;gBACT,UAAU,eAAe,IAAI;gBAC7B,KAAK;oBACJ;oBACA;oBACA,iBAAiB,WAAW,IAAI,eAAe,WAAW;oBAC1D,eAAe,cAAc,WAAW;oBACxC;oBACA,uBAAuB,eAAe;gBACvC;YACD;QACD;QAEA,uBAAuB;QACvB,MAAM,EAAE,MAAM,SAAS,EAAE,GAAG,MAAM,SAChC,IAAI,CAAC,aACL,MAAM,CAAC,0DACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU,UACb,KAAK,CAAC,iBAAiB;YAAE,WAAW;QAAM,GAC1C,KAAK,CAAC;QAER,MAAM,UAAU,WAAW,IAAI,CAAC,IAAM,CAAC;gBACtC,GAAG,CAAC;gBACJ,cAAc,CAAC,EAAE,aAAa,IAAI,CAAC,IAAI;gBACvC,iBAAiB,EAAE,SAAS,GAAG,IAAI,CAAC,EAAE,aAAa,IAAI,CAAC,IAAI,MAAM,EAAE,SAAS,GAAG;YACjF,CAAC;QAED,OAAO;YAAE,SAAS;YAAM,cAAc;QAAQ;IAC/C;AACD;AAMO,MAAM,sBAAsB,IAAA,4RAAI,EAAC;IACvC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ;QAC1B,QAAQ,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAS;YAAQ;YAAU;YAAY;YAAY;SAAU,EAAE,QAAQ;QACvF,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ;QACtC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,UAAU,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QACzF,MAAM,WAAW,IAAA,+KAA2B;QAC5C,IAAI,eAAe,SACjB,IAAI,CAAC,aACL,MAAM,CAAC,mGACP,EAAE,CAAC,cAAc;QAEnB,IAAI,OAAO,eAAe,aAAa,KAAK,CAAC,mBAAmB,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC;QAC5E,IAAI,QAAQ,eAAe,aAAa,EAAE,CAAC,UAAU;QACrD,IAAI,YAAY,eAAe,aAAa,EAAE,CAAC,eAAe;QAE9D,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,aAAa,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GAAG,KAAK,CAAC;QAE3F,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,WAAW;YAAM,OAAO,MAAM,UAAU;QAAE;IACnE;AACD;AAEO,MAAM,sBAAsB,IAAA,4RAAI,EAAC;IACvC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ;QAC1B,QAAQ,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAS;YAAQ;YAAU;YAAW;SAAY,EAAE,QAAQ;QAC5E,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ;QACtC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,UAAU,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QACzF,MAAM,WAAW,IAAA,+KAA2B;QAC5C,IAAI,eAAe,SACjB,IAAI,CAAC,aACL,MAAM,CAAC,2GACP,EAAE,CAAC,cAAc;QAEnB,IAAI,OAAO,eAAe,aAAa,KAAK,CAAC,mBAAmB,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC;QAC5E,IAAI,QAAQ,eAAe,aAAa,EAAE,CAAC,UAAU;QACrD,IAAI,YAAY,eAAe,aAAa,EAAE,CAAC,eAAe;QAE9D,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,aAAa,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GAAG,KAAK,CAAC;QAE3F,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,OAAO;YAAE,SAAS;YAAM,WAAW;YAAM,OAAO,MAAM,UAAU;QAAE;IACnE;AACD;AAMO,MAAM,eAAe;IAC3B,kCAAkC;IAClC,oBAAoB;IACpB,eAAe;IACf,eAAe;IACf,mBAAmB;IACnB,oBAAoB;IACpB,mBAAmB;IAEnB,iBAAiB;IACjB,iBAAiB;IACjB,oBAAoB;IACpB,gBAAgB;IAChB,gBAAgB;IAEhB,oBAAoB;IACpB,mBAAmB;IACnB,sBAAsB;IACtB,eAAe;IACf,aAAa;IAEb,eAAe;IACf,eAAe;IACf,kBAAkB;IAClB,iBAAiB;IACjB,eAAe;IAEf,6BAA6B;IAC7B,kBAAkB;IAClB,oBAAoB;IACpB,iBAAiB;IACjB,mBAAmB;IAEnB,uBAAuB;IACvB,YAAY;IACZ,mBAAmB;IACnB,mBAAmB;IAEnB,0BAA0B;IAC1B,gBAAgB;IAChB,eAAe;IACf,qBAAqB;IACrB,mBAAmB;IACnB,kBAAkB;IAElB,sBAAsB;IACtB,WAAW;IACX,SAAS;IACT,cAAc;IACd,yBAAyB;IAEzB,8BAA8B;IAC9B,kBAAkB;IAClB,gBAAgB;IAChB,uBAAuB;IACvB,2BAA2B;IAE3B,2BAA2B;IAC3B,qBAAqB;IACrB,qBAAqB;IACrB,kBAAkB;IAClB,0BAA0B;IAC1B,0BAA0B;IAC1B,qBAAqB;IACrB,sBAAsB;IAEtB,4BAA4B;IAC5B,iBAAiB;IACjB,iBAAiB;AAClB;AAGO,MAAM,iBAA+C;IAC3D,4DAA4D;IAC5D,oBAAoB;IACpB,eAAe;IACf,eAAe;IACf,mBAAmB;IACnB,oBAAoB;IACpB,mBAAmB;IAEnB,WAAW;IACX,iBAAiB;IACjB,oBAAoB;IACpB,gBAAgB;IAChB,gBAAgB;IAEhB,OAAO;IACP,mBAAmB;IACnB,sBAAsB;IACtB,eAAe;IACf,aAAa;IAEb,SAAS;IACT,eAAe;IACf,kBAAkB;IAClB,iBAAiB;IACjB,eAAe;IAEf,uBAAuB;IACvB,kBAAkB;IAClB,oBAAoB;IACpB,iBAAiB;IACjB,mBAAmB;IAEnB,aAAa;IACb,YAAY;IACZ,mBAAmB;IACnB,mBAAmB;IAEnB,YAAY;IACZ,gBAAgB;IAChB,eAAe;IACf,qBAAqB;IACrB,mBAAmB;IACnB,kBAAkB;IAElB,gBAAgB;IAChB,WAAW;IACX,SAAS;IACT,cAAc;IACd,yBAAyB;IAEzB,gBAAgB;IAChB,kBAAkB;IAClB,gBAAgB;IAChB,uBAAuB;IACvB,2BAA2B;IAE3B,YAAY;IACZ,qBAAqB;IACrB,qBAAqB;IACrB,kBAAkB;IAClB,0BAA0B;IAC1B,0BAA0B;IAC1B,qBAAqB;IACrB,sBAAsB;IAEtB,wBAAwB;IACxB,iBAAiB;IACjB,iBAAiB;AAClB;AAkCO,MAAM,kBAAkB,IAAA,4RAAI,EAAC;IACnC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC7B,YAAY,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAQ;YAAc;YAAe;YAAW;YAAU;YAAa;SAAW,EAAE,QAAQ,CAAC;QACjH,YAAY,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAY;YAAO;YAAY;YAAa;YAAW;YAAY;SAAc,EAAE,QAAQ,GAAG,QAAQ,CAAC;QAC3H,UAAU,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,GAAG,QAAQ,CAAC;QAChD,YAAY,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAO;YAAU;SAAO,EAAE,OAAO,CAAC,UAAU,QAAQ,CAAC;QACzE,MAAM,mOAAC,CAAC,KAAK,CAAC,mOAAC,CAAC,MAAM,IAAI,QAAQ,GAAG,QAAQ,CAAC;IAC/C;IACA,SAAS,OAAO,EAAE,OAAO,EAAE,UAAU,EAAE,UAAU,EAAE,QAAQ,EAAE,UAAU,EAAE,IAAI,EAAE,EAAE,EAAE,SAAS,EAAE,MAAM,EAA0C;QAC7I,MAAM,EAAE,WAAW,EAAE,GAAG;QAExB,MAAM,kBAAkB;YAAE,KAAK;YAAK,QAAQ;YAAK,MAAM;QAAI,CAAC,CAAC,WAAW;QAExE,MAAM,WAAW,MAAM,YAAY,WAAW,UAAU,UAAU;YACjE;YACA;YACA;YACA;YACA,YAAY;YACZ;YACA,YAAY;QACb;QAEA,OAAO;YACN,SAAS;YACT,SAAS,CAAC,0BAA0B,CAAC;YACrC;YACA,SAAS,CAAC,aAAa,EAAE,QAAQ,SAAS,CAAC,GAAG,IAAI,IAAI,CAAC;QACxD;IACD;AACD;AAKO,MAAM,qBAAqB,IAAA,4RAAI,EAAC;IACtC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,YAAY,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAY;YAAO;YAAY;YAAa;YAAW;YAAY;SAAc,EAAE,QAAQ,GAAG,QAAQ,CAAC;QAC3H,UAAU,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,GAAG,QAAQ,CAAC;QAChD,aAAa,mOAAC,CAAC,KAAK,CAAC,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAQ;YAAc;YAAe;YAAW;YAAU;YAAa;SAAW,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACtI,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,GAAG,QAAQ,CAAC;IAClD;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,UAAU,EAAE,QAAQ,EAAE,WAAW,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QACxG,MAAM,EAAE,cAAc,EAAE,GAAG;QAE3B,MAAM,UAAU,MAAM,eAAe,WAAW,OAAO;YACtD;YACA;YACA;YACA;YACA,eAAe;QAChB;QAEA,IAAI,QAAQ,MAAM,KAAK,GAAG;YACzB,OAAO;gBACN,SAAS;gBACT,SAAS;gBACT,UAAU,EAAE;YACb;QACD;QAEA,OAAO;YACN,SAAS;YACT,SAAS,CAAC,MAAM,EAAE,QAAQ,MAAM,CAAC,kBAAkB,CAAC;YACpD,UAAU,QAAQ,GAAG,CAAC,CAAA,IAAK,CAAC;oBAC3B,SAAS,EAAE,OAAO;oBAClB,MAAM,EAAE,UAAU;oBAClB,WAAW,KAAK,KAAK,CAAC,EAAE,UAAU,GAAG,OAAO;oBAC5C,YAAY,EAAE,UAAU;oBACxB,WAAW,EAAE,SAAS;gBACvB,CAAC;QACF;IACD;AACD;AAKO,MAAM,wBAAwB,IAAA,4RAAI,EAAC;IACzC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,YAAY,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAY;YAAO;YAAY;YAAa;YAAW;YAAY;SAAc,EAAE,QAAQ,CAAC;QAChH,UAAU,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACrC,aAAa,mOAAC,CAAC,KAAK,CAAC,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAQ;YAAc;YAAe;YAAW;YAAU;YAAa;SAAW,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACtI,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,IAAI,QAAQ,CAAC;IACnD;IACA,SAAS,OAAO,EAAE,UAAU,EAAE,QAAQ,EAAE,WAAW,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QACjG,MAAM,EAAE,iBAAiB,EAAE,GAAG;QAE9B,MAAM,WAAW,MAAM,kBAAkB,WAAW,YAAY,UAAU;YACzE,OAAO;YACP;QACD;QAEA,IAAI,SAAS,MAAM,KAAK,GAAG;YAC1B,OAAO;gBACN,SAAS;gBACT,SAAS,CAAC,4BAA4B,EAAE,YAAY;gBACpD,UAAU,EAAE;YACb;QACD;QAEA,wCAAwC;QACxC,MAAM,UAA0E,CAAC;QACjF,KAAK,MAAM,KAAK,SAAU;YACzB,IAAI,CAAC,OAAO,CAAC,EAAE,WAAW,CAAC,EAAE,OAAO,CAAC,EAAE,WAAW,CAAC,GAAG,EAAE;YACxD,OAAO,CAAC,EAAE,WAAW,CAAC,CAAC,IAAI,CAAC;gBAC3B,SAAS,EAAE,OAAO;gBAClB,YAAY,EAAE,UAAU;YACzB;QACD;QAEA,OAAO;YACN,SAAS;YACT,SAAS,CAAC,MAAM,EAAE,SAAS,MAAM,CAAC,cAAc,EAAE,YAAY;YAC9D,gBAAgB;YAChB,YAAY,SAAS,MAAM;QAC5B;IACD;AACD;AAKO,MAAM,oBAAoB,IAAA,4RAAI,EAAC;IACrC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,cAAc,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QAC7C,OAAO,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,GAAG,QAAQ,CAAC;IAC9C;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,YAAY,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QACnF,MAAM,EAAE,cAAc,EAAE,GAAG;QAC3B,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,UAIF;YACH,UAAU,EAAE;QACb;QAEA,+BAA+B;QAC/B,MAAM,WAAW,MAAM,eAAe,WAAW,OAAO;YACvD,OAAO;YACP,eAAe;QAChB;QAEA,QAAQ,QAAQ,GAAG,SAAS,GAAG,CAAC,CAAA,IAAK,CAAC;gBACrC,SAAS,EAAE,OAAO;gBAClB,MAAM,EAAE,UAAU;gBAClB,WAAW,KAAK,KAAK,CAAC,EAAE,UAAU,GAAG,OAAO;YAC7C,CAAC;QAED,8CAA8C;QAC9C,IAAI,cAAc;YACjB,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC/B,IAAI,CAAC,aACL,MAAM,CAAC,mBACP,EAAE,CAAC,cAAc,WACjB,KAAK,CAAC,QAAQ,CAAC,CAAC,EAAE,aAAa,CAAC,CAAC,EACjC,KAAK,CAAC,GACN,MAAM;YAER,IAAI,UAAU;gBACb,QAAQ,QAAQ,GAAG;gBAEnB,iCAAiC;gBACjC,MAAM,mBAAmB,MAAM,eAAe,WAAW,GAAG,aAAa,qBAAqB,CAAC,EAAE;oBAChG,YAAY;oBACZ,UAAU,SAAS,EAAE;oBACrB,OAAO;gBACR;gBAEA,KAAK,MAAM,KAAK,iBAAkB;oBACjC,IAAI,CAAC,QAAQ,QAAQ,CAAC,IAAI,CAAC,CAAA,KAAM,GAAG,OAAO,KAAK,EAAE,OAAO,GAAG;wBAC3D,QAAQ,QAAQ,CAAC,IAAI,CAAC;4BACrB,SAAS,EAAE,OAAO;4BAClB,MAAM,EAAE,UAAU;4BAClB,WAAW,KAAK,KAAK,CAAC,EAAE,UAAU,GAAG,OAAO;wBAC7C;oBACD;gBACD;YACD;QACD;QAEA,sCAAsC;QACtC,IAAI,OAAO;YACV,MAAM,EAAE,MAAM,GAAG,EAAE,GAAG,MAAM,SAC1B,IAAI,CAAC,QACL,MAAM,CAAC,kCACP,EAAE,CAAC,MAAM,OACT,EAAE,CAAC,cAAc,WACjB,MAAM;YAER,IAAI,KAAK;gBACR,QAAQ,GAAG,GAAG;oBAAE,IAAI,IAAI,EAAE;oBAAE,OAAO,IAAI,KAAK;oBAAE,QAAQ,IAAI,MAAM;gBAAC;YAClE;QACD;QAEA,OAAO;YACN,SAAS;YACT;YACA;YACA,SAAS,QAAQ,QAAQ,CAAC,MAAM,GAAG,IAChC,CAAC,MAAM,EAAE,QAAQ,QAAQ,CAAC,MAAM,CAAC,8BAA8B,CAAC,GAChE;QACJ;IACD;AACD;AASO,MAAM,mCAAmC,IAAA,4RAAI,EAAC;IACpD,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,SAAS,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAS;YAAO;YAAQ;SAAM,EAAE,QAAQ,GAAG,OAAO,CAAC,OAAO,QAAQ,CAAC;QACpF,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,GAAG,QAAQ,CAAC;QAClD,WAAW,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAW;YAAY;SAAM,EAAE,QAAQ,GAAG,OAAO,CAAC,OAAO,QAAQ,CAAC;QACrF,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,IAAI,QAAQ,CAAC;IACnD;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,UAAU,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QACrG,MAAM,WAAW,IAAA,+KAA2B;QAE5C,IAAI,UAAU,SACZ,IAAI,CAAC,kBACL,MAAM,CAAC,CAAC;;;;;GAKT,CAAC,EACA,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,cAAc,MACjB,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC;QAER,gBAAgB;QAChB,IAAI,YAAY,OAAO;YACtB,UAAU,QAAQ,EAAE,CAAC,WAAW;QACjC;QACA,IAAI,YAAY;YACf,UAAU,QAAQ,EAAE,CAAC,eAAe;QACrC;QACA,IAAI,cAAc,OAAO;YACxB,UAAU,QAAQ,EAAE,CAAC,aAAa;QACnC;QAEA,0CAA0C;QAC1C,UAAU,QAAQ,EAAE,CAAC,CAAC,kBAAkB,EAAE,MAAM,yBAAyB,EAAE,MAAM,iBAAiB,EAAE,MAAM,CAAC,CAAC;QAE5G,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM;QAE9B,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QAEzD,OAAO;YACN,SAAS;YACT,SAAS,CAAC,MAAM,EAAE,MAAM,UAAU,EAAE,0BAA0B,EAAE,MAAM,CAAC,CAAC;YACxE,SAAS,MAAM,IAAI,CAAA,IAAK,CAAC;oBACxB,IAAI,EAAE,EAAE;oBACR,SAAS,EAAE,OAAO;oBAClB,WAAW,EAAE,SAAS;oBACtB,SAAS,EAAE,OAAO;oBAClB,SAAS,CAAC,EAAE,UAAU,IAAI,EAAE,eAAe,IAAI,EAAE,EAAE,SAAS,CAAC,GAAG;oBAChE,WAAW,EAAE,cAAc;oBAC3B,cAAc,EAAE,QAAQ,EAAE;oBAC1B,MAAM,EAAE,UAAU;gBACnB,CAAC;QACF;IACD;AACD;AAKO,MAAM,wBAAwB,IAAA,4RAAI,EAAC;IACzC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,iBAAiB,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;IAC7C;IACA,SAAS,OAAO,EAAE,eAAe,EAAE,EAAE,EAAE,SAAS,EAAyB;QACxE,MAAM,WAAW,IAAA,+KAA2B;QAE5C,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,kBACL,MAAM,CAAC,CAAC;;;;;GAKT,CAAC,EACA,EAAE,CAAC,MAAM,iBACT,EAAE,CAAC,cAAc,WACjB,MAAM;QAER,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QACzD,IAAI,CAAC,MAAM,iBAAiB;YAC3B,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAiD;QAClF;QAEA,OAAO;YACN,SAAS;YACT,MAAM;gBACL,IAAI,KAAK,EAAE;gBACX,WAAW,KAAK,SAAS;gBACzB,UAAU,KAAK,aAAa,GAAG,GAAG,KAAK,KAAK,CAAC,KAAK,aAAa,GAAG,IAAI,EAAE,EAAE,KAAK,aAAa,GAAG,GAAG,CAAC,CAAC,GAAG;gBACvG,WAAW,KAAK,cAAc;gBAC9B,cAAc,KAAK,QAAQ,EAAE;gBAC7B,MAAM,KAAK,UAAU;gBACrB,YAAY,KAAK,eAAe;gBAChC,cAAc,CAAC,CAAC,KAAK,kBAAkB;YACxC;QACD;IACD;AACD;AAKO,MAAM,iCAAiC,IAAA,4RAAI,EAAC;IAClD,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACtC,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,GAAG,QAAQ,CAAC;QAClD,YAAY,mOAAC,CAAC,OAAO,GAAG,QAAQ,GAAG,OAAO,CAAC,OAAO,QAAQ,CAAC;QAC3D,YAAY,mOAAC,CAAC,OAAO,GAAG,QAAQ,GAAG,OAAO,CAAC,OAAO,QAAQ,CAAC;QAC3D,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,IAAI,QAAQ,CAAC;IACnD;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,UAAU,EAAE,UAAU,EAAE,UAAU,EAAE,KAAK,EAAE,EAAE,EAAE,SAAS,EAAyB;QACzG,MAAM,WAAW,IAAA,+KAA2B;QAE5C,IAAI,UAAU,SACZ,IAAI,CAAC,cACL,MAAM,CAAC,CAAC;;;;GAIT,CAAC,EACA,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,cAAc,MACjB,KAAK,CAAC,eAAe;YAAE,WAAW;QAAM,GACxC,KAAK,CAAC;QAER,IAAI,YAAY;YACf,UAAU,QAAQ,EAAE,CAAC,eAAe;QACrC;QACA,IAAI,YAAY;YACf,UAAU,QAAQ,EAAE,CAAC,aAAa;QACnC;QACA,IAAI,YAAY;YACf,UAAU,QAAQ,EAAE,CAAC,WAAW;QACjC;QACA,IAAI,OAAO;YACV,UAAU,QAAQ,KAAK,CAAC,iBAAiB,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC;QACtD;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM;QAE9B,IAAI,OAAO,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC;QAEzD,OAAO;YACN,SAAS;YACT,SAAS,CAAC,MAAM,EAAE,MAAM,UAAU,EAAE,WAAW,CAAC;YAChD,YAAY,MAAM,IAAI,CAAA,IAAK,CAAC;oBAC3B,IAAI,EAAE,EAAE;oBACR,MAAM,EAAE,WAAW;oBACnB,cAAc,EAAE,QAAQ,EAAE;oBAC1B,UAAU,EAAE,QAAQ,GAAG,GAAG,KAAK,KAAK,CAAC,EAAE,QAAQ,GAAG,IAAI,EAAE,EAAE,EAAE,QAAQ,GAAG,GAAG,CAAC,CAAC,GAAG;oBAC/E,eAAe,EAAE,aAAa;oBAC9B,YAAY,EAAE,wBAAwB;oBACtC,UAAU,EAAE,SAAS;oBACrB,QAAQ,EAAE,OAAO;oBACjB,YAAY,EAAE,WAAW;gBAC1B,CAAC;QACF;IACD;AACD;AAKO,MAAM,sCAAsC,IAAA,4RAAI,EAAC;IACvD,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,YAAY,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QACvC,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,IAAI,QAAQ,CAAC;QACjD,oBAAoB,mOAAC,CAAC,OAAO,GAAG,QAAQ,GAAG,OAAO,CAAC,OAAO,QAAQ,CAAC;IACpE;IACA,SAAS,OAAO,EAAE,UAAU,EAAE,IAAI,EAAE,kBAAkB,EAAE,EAAE,EAAE,SAAS,EAAyB;QAC7F,MAAM,WAAW,IAAA,+KAA2B;QAC5C,MAAM,aAAa,IAAI;QACvB,WAAW,OAAO,CAAC,WAAW,OAAO,KAAK;QAE1C,qBAAqB;QACrB,MAAM,EAAE,MAAM,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC/C,IAAI,CAAC,kBACL,MAAM,CAAC,CAAC;;;;GAIT,CAAC,EACA,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,eAAe,YAClB,EAAE,CAAC,cAAc,MACjB,GAAG,CAAC,cAAc,WAAW,WAAW,IACxC,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM;QAEzC,iBAAiB;QACjB,MAAM,EAAE,MAAM,UAAU,EAAE,OAAO,OAAO,EAAE,GAAG,MAAM,SACjD,IAAI,CAAC,cACL,MAAM,CAAC,oEACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,eAAe,YAClB,EAAE,CAAC,cAAc,MACjB,GAAG,CAAC,eAAe,WAAW,WAAW,IACzC,KAAK,CAAC,eAAe;YAAE,WAAW;QAAM;QAE1C,IAAI,YAAY,OAAO;YAAE,SAAS;YAAO,OAAO,WAAW,OAAO;QAAC;QAEnE,uBAAuB;QACvB,MAAM,UAAU;YACf,QAAQ,OAAO,OAAO,CAAA,IAAK,EAAE,OAAO,KAAK,SAAS,UAAU;YAC5D,OAAO,OAAO,OAAO,CAAA,IAAK,EAAE,OAAO,KAAK,QAAQ,UAAU;YAC1D,KAAK,OAAO,OAAO,CAAA,IAAK,EAAE,OAAO,KAAK,OAAO,UAAU;YACvD,YAAY,YAAY,UAAU;QACnC;QAEA,OAAO;YACN,SAAS;YACT;YACA,QAAQ,CAAC,KAAK,EAAE,KAAK,KAAK,CAAC;YAC3B;YACA,gBAAgB,OAAO,IAAI,CAAA,IAAK,CAAC;oBAChC,IAAI,EAAE,EAAE;oBACR,SAAS,EAAE,OAAO;oBAClB,WAAW,EAAE,SAAS;oBACtB,SAAS,EAAE,OAAO;oBAClB,SAAS,qBACN,CAAC,EAAE,UAAU,IAAI,EAAE,eAAe,IAAI,EAAE,EAAE,SAAS,CAAC,GAAG,OACvD,CAAC,EAAE,UAAU,IAAI,EAAE,eAAe,IAAI,EAAE,EAAE,SAAS,CAAC,GAAG;oBAC1D,WAAW,EAAE,cAAc;oBAC3B,MAAM,EAAE,UAAU;gBACnB,CAAC;YACD,YAAY,YAAY,IAAI,CAAA,IAAK,CAAC;oBACjC,IAAI,EAAE,EAAE;oBACR,UAAU,EAAE,QAAQ;oBACpB,eAAe,EAAE,aAAa,EAAE,UAAU,GAAG;oBAC7C,UAAU,EAAE,SAAS;oBACrB,MAAM,EAAE,WAAW;gBACpB,CAAC;QACF;IACD;AACD;AAKO,MAAM,mCAAmC,IAAA,4RAAI,EAAC;IACpD,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,iBAAiB,mOAAC,CAAC,MAAM,GAAG,IAAI,GAAG,QAAQ,CAAC;QAC5C,cAAc,mOAAC,CAAC,KAAK,CAAC,mOAAC,CAAC,IAAI,CAAC;YAAC;YAAc;YAAS;YAAa;YAAe;SAAW,GAAG,QAAQ,GAAG,QAAQ,CAAC;IACpH;IACA,SAAS,OAAO,EAAE,eAAe,EAAE,YAAY,EAAE,EAAE,EAAE,SAAS,EAAE,MAAM,EAA0C;QAC/G,MAAM,WAAW,IAAA,+KAA2B;QAE5C,wBAAwB;QACxB,MAAM,EAAE,MAAM,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,kBACL,MAAM,CAAC,CAAC;;;;GAIT,CAAC,EACA,EAAE,CAAC,MAAM,iBACT,EAAE,CAAC,cAAc,WACjB,MAAM;QAER,IAAI,SAAS,CAAC,MAAM;YACnB,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAA0B;QAC3D;QAEA,MAAM,UAAU,KAAK,UAAU,IAAI,KAAK,eAAe,IAAI;QAC3D,IAAI,CAAC,SAAS;YACb,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAwB;QACzD;QAEA,iEAAiE;QACjE,MAAM,WAAyE,EAAE;QAEjF,iEAAiE;QACjE,MAAM,qBAAqB;YAC1B;YACA;YACA;SACA;QAED,KAAK,MAAM,WAAW,mBAAoB;YACzC,MAAM,UAAU,QAAQ,QAAQ,CAAC;YACjC,KAAK,MAAM,SAAS,QAAS;gBAC5B,SAAS,IAAI,CAAC;oBACb,MAAM;oBACN,SAAS,CAAC,kBAAkB,EAAE,KAAK,CAAC,EAAE,EAAE;oBACxC,YAAY;gBACb;YACD;QACD;QAEA,6BAA6B;QAC7B,MAAM,gBAAgB;YACrB;YACA;YACA;YACA;SACA;QAED,KAAK,MAAM,WAAW,cAAe;YACpC,MAAM,UAAU,QAAQ,QAAQ,CAAC;YACjC,KAAK,MAAM,SAAS,QAAS;gBAC5B,SAAS,IAAI,CAAC;oBACb,MAAM;oBACN,SAAS,CAAC,gBAAgB,EAAE,KAAK,CAAC,EAAE,EAAE;oBACtC,YAAY;gBACb;YACD;QACD;QAEA,iDAAiD;QACjD,IAAI,KAAK,WAAW,IAAI,SAAS,MAAM,GAAG,GAAG;YAC5C,MAAM,EAAE,WAAW,EAAE,GAAG;YAExB,KAAK,MAAM,WAAW,SAAU;gBAC/B,MAAM,YAAY,WAAW,UAAU,UAAU;oBAChD,SAAS,QAAQ,OAAO;oBACxB,YAAY,QAAQ,IAAI;oBACxB,YAAY;oBACZ,UAAU,KAAK,WAAW;oBAC1B,YAAY,QAAQ,UAAU,KAAK,SAAS,MAAM;oBAClD,YAAY;oBACZ,cAAc;gBACf;YACD;QACD;QAEA,OAAO;YACN,SAAS;YACT;YACA,SAAS,KAAK,OAAO;YACrB,cAAc,KAAK,QAAQ,EAAE;YAC7B,mBAAmB;YACnB,gBAAgB,SAAS,MAAM,GAAG,KAAK,CAAC,CAAC,KAAK,WAAW;YACzD,WAAW,KAAK,cAAc;QAC/B;IACD;AACD;AAeO,MAAM,4BAA4B,IAAA,4RAAI,EAAC;IAC7C,aAAa,CAAC;;;;;;kGAMmF,CAAC;IAClG,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,KAAK,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QACzB,KAAK,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QACzB,eAAe,mOAAC,CACd,OAAO,GACP,QAAQ,GACR,OAAO,CAAC,MACR,QAAQ,CAAC;IACZ;IACA,SAAS,OAAO,EAAE,GAAG,EAAE,GAAG,EAAE,aAAa,EAAE;QAC1C,MAAM,EAAE,cAAc,EAAE,GAAG;QAE3B,MAAM,UAAU,MAAM,eAAe,cAAc,CAAC,KAAK;QAEzD,IAAI,CAAC,SAAS;YACb,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,OAAO;YACN,SAAS;YACT,UAAU,QAAQ,QAAQ;YAC1B,mBAAmB,QAAQ,MAAM,EAAE,SAAS,CAAC,EAAE,IAAI;YACnD,UAAU,QAAQ,QAAQ,EAAE,SAAS,MAAM,GAAG,MAAM,EAAE;YACtD,QAAQ,gBACL,QAAQ,MAAM,EAAE,SAAS,MAAM,GAAG,OAAO,EAAE,GAC3C,EAAE;YACL,QAAQ,QAAQ,MAAM;YACtB,iBAAiB,QAAQ,eAAe;YACxC,iBAAiB,QAAQ,eAAe;YACxC,YAAY,QAAQ,UAAU;QAC/B;IACD;AACD;AAQO,MAAM,yBAAyB,IAAA,4RAAI,EAAC;IAC1C,aAAa,CAAC;;;;;;uEAMwD,CAAC;IACvE,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,KAAK,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QACzB,KAAK,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QACzB,SAAS,mOAAC,CACR,MAAM,GACN,QAAQ,GACR,QAAQ,CAAC;IACZ;IACA,SAAS,OAAO,EAAE,GAAG,EAAE,GAAG,EAAE,OAAO,EAAE;QACpC,MAAM,EAAE,cAAc,EAAE,GAAG;QAE3B,MAAM,UAAU,MAAM,eAAe,cAAc,CAAC,KAAK;QAEzD,IAAI,CAAC,SAAS;YACb,OAAO;gBACN,SAAS;gBACT,UAAU;gBACV,OAAO;YACR;QACD;QAEA,MAAM,cAAc,eAAe,wBAAwB,CAAC;QAE5D,OAAO;YACN,SAAS;YACT,UAAU,YAAY,QAAQ;YAC9B,QAAQ,YAAY,MAAM,IAAI;YAC9B,mBAAmB,QAAQ,MAAM,EAAE,SAAS,CAAC,EAAE,GAC5C;gBACA,aAAa,QAAQ,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,WAAW;gBAClD,iBAAiB,QAAQ,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,eAAe;gBAC1D,eAAe,QAAQ,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,aAAa;gBACtD,WAAW,QAAQ,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,SAAS;YAC/C,IACC;YACH,QAAQ,QAAQ,MAAM,CAAC,GAAG,CAAC,CAAC,IAAM,CAAC;oBAClC,OAAO,EAAE,KAAK;oBACd,UAAU,EAAE,QAAQ;oBACpB,UAAU,EAAE,QAAQ;gBACrB,CAAC;YACD;YACA,gBAAgB,YAAY,QAAQ,GACjC,8BACA,CAAC,uBAAuB,EAAE,YAAY,MAAM,EAAE;QAClD;IACD;AACD;AAKO,MAAM,uBAAuB,IAAA,4RAAI,EAAC;IACxC,aAAa,CAAC;;;;;+DAKgD,CAAC;IAC/D,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,KAAK,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QACzB,KAAK,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC1B;IACA,SAAS,OAAO,EAAE,GAAG,EAAE,GAAG,EAAE;QAC3B,MAAM,EAAE,cAAc,EAAE,GAAG;QAE3B,MAAM,SAAS,MAAM,eAAe,eAAe,CAAC,KAAK;QAEzD,OAAO;YACN,SAAS;YACT,WAAW,OAAO,MAAM,GAAG;YAC3B,YAAY,OAAO,MAAM;YACzB,QAAQ,OAAO,GAAG,CAAC,CAAC,IAAM,CAAC;oBAC1B,OAAO,EAAE,KAAK;oBACd,UAAU,EAAE,QAAQ;oBACpB,SAAS,EAAE,OAAO;oBAClB,UAAU,EAAE,QAAQ;oBACpB,aAAa,EAAE,WAAW;oBAC1B,SAAS,EAAE,OAAO;gBACnB,CAAC;QACF;IACD;AACD;AAQO,MAAM,2BAA2B,IAAA,4RAAI,EAAC;IAC5C,aAAa,CAAC;;;;;;;;;;;+BAWgB,CAAC;IAC/B,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,gBAAgB,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QACpC,gBAAgB,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QACpC,WAAW,mOAAC,CACV,MAAM,GACN,QAAQ,GACR,QAAQ,CAAC;QACX,WAAW,mOAAC,CACV,MAAM,GACN,QAAQ,GACR,QAAQ,CAAC;IACZ;IACA,SAAS,OAAO,EAAE,cAAc,EAAE,cAAc,EAAE,SAAS,EAAE,SAAS,EAAE;QACvE,MAAM,EAAE,cAAc,EAAE,GAAG;QAE3B,MAAM,UAAU,MAAM,eAAe,mBAAmB,CACvD,gBACA,gBACA,WACA;QAGD,IAAI,CAAC,SAAS;YACb,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,OAAO;YACN,SAAS;YACT,gBAAgB,QAAQ,cAAc;YACtC,iBAAiB,QAAQ,eAAe;YACxC,yBAAyB,QAAQ,uBAAuB;YACxD,WAAW,QAAQ,SAAS,CAAC,GAAG,CAAC,CAAC,IAAM,CAAC;oBACxC,MAAM,EAAE,IAAI;oBACZ,UAAU,EAAE,QAAQ;oBACpB,aAAa,EAAE,WAAW;oBAC1B,UAAU,EAAE,QAAQ;oBACpB,cAAc,EAAE,YAAY;gBAC7B,CAAC;YACD,gBACC,QAAQ,uBAAuB,GAAG,IAC/B,GAAG,QAAQ,uBAAuB,CAAC,mCAAmC,CAAC,GACvE;YACJ,YAAY,QAAQ,UAAU;QAC/B;IACD;AACD;AAOO,MAAM,qBAAqB,IAAA,4RAAI,EAAC;IACtC,aAAa,CAAC;;;;;kEAKmD,CAAC;IAClE,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC7B,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC1B,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC7B,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,OAAO,QAAQ,CAAC;IACxD;IACA,SAAS,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,OAAO,EAAE;QACzD,MAAM,EAAE,oBAAoB,EAAE,GAAG;QAEjC,MAAM,SAAS,MAAM,qBAAqB,SAAS,MAAM,OAAO,SAAS;QAEzE,IAAI,CAAC,QAAQ;YACZ,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,OAAO;YACN,SAAS;YACT,aAAa;gBACZ,KAAK,OAAO,GAAG;gBACf,KAAK,OAAO,GAAG;YAChB;YACA,kBAAkB,OAAO,gBAAgB;QAC1C;IACD;AACD;AAQO,MAAM,4BAA4B,IAAA,4RAAI,EAAC;IAC7C,aAAa,CAAC;;;;;;6BAMc,CAAC;IAC7B,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,aAAa,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QACjC,aAAa,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QACjC,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACxC,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACxC,SAAS,mOAAC,CACR,MAAM,GACN,QAAQ,GACR,QAAQ,CAAC;IACZ;IACA,SAAS,OAAO,EAAE,WAAW,EAAE,WAAW,EAAE,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE;QACtE,MAAM,EAAE,cAAc,EAAE,GAAG;QAC3B,MAAM,EAAE,cAAc,EAAE,GAAG;QAE3B,wCAAwC;QACxC,MAAM,CAAC,SAAS,QAAQ,GAAG,MAAM,QAAQ,GAAG,CAAC;YAC5C,eAAe,cAAc,CAAC,aAAa;YAC3C,WAAW,UACR,eAAe,mBAAmB,CAAC,aAAa,aAAa,SAAS,WACtE,QAAQ,OAAO,CAAC;SACnB;QAED,MAAM,SAAkC;YACvC,SAAS;YACT,kBAAkB;gBAAE,KAAK;gBAAa,KAAK;YAAY;QACxD;QAEA,qBAAqB;QACrB,IAAI,SAAS;YACZ,MAAM,cAAc,eAAe,wBAAwB,CAAC;YAC5D,OAAO,OAAO,GAAG;gBAChB,SAAS,QAAQ,MAAM,EAAE,SAAS,CAAC,EAAE,GAClC;oBACA,aAAa,QAAQ,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,WAAW;oBAClD,iBAAiB,QAAQ,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,eAAe;oBAC1D,YAAY,QAAQ,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,aAAa;oBACnD,MAAM,QAAQ,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,SAAS;gBAC1C,IACC;gBACH,UAAU,QAAQ,QAAQ,EAAE,SAAS,MAAM,GAAG,GAAG,IAAI,CAAC,IAAM,CAAC;wBAC5D,MAAM,EAAE,IAAI;wBACZ,aAAa,EAAE,WAAW;wBAC1B,eAAe,EAAE,aAAa;oBAC/B,CAAC;gBACD,QAAQ,QAAQ,MAAM,CAAC,GAAG,CAAC,CAAC,IAAM,CAAC;wBAClC,OAAO,EAAE,KAAK;wBACd,UAAU,EAAE,QAAQ;wBACpB,UAAU,EAAE,QAAQ;oBACrB,CAAC;gBACD,WAAW,QAAQ,eAAe;gBAClC,sBAAsB,QAAQ,eAAe;YAC9C;YACA,OAAO,eAAe,GAAG;gBACxB,UAAU,YAAY,QAAQ;gBAC9B,QAAQ,YAAY,MAAM,IAAI;gBAC9B;YACD;QACD,OAAO;YACN,OAAO,OAAO,GAAG;gBAAE,OAAO;YAA2B;YACrD,OAAO,eAAe,GAAG;gBAAE,UAAU;gBAAM,QAAQ;YAAmB;QACvE;QAEA,qBAAqB;QACrB,IAAI,SAAS;YACZ,OAAO,OAAO,GAAG;gBAChB,gBAAgB,QAAQ,cAAc;gBACtC,gBAAgB,QAAQ,uBAAuB;gBAC/C,WAAW,QAAQ,SAAS,CAAC,KAAK,CAAC,GAAG,GAAG,GAAG,CAAC,CAAC,IAAM,CAAC;wBACpD,MAAM,EAAE,IAAI;wBACZ,UAAU,EAAE,QAAQ;wBACpB,aAAa,EAAE,WAAW;oBAC3B,CAAC;YACF;QACD,OAAO,IAAI,WAAW,SAAS;YAC9B,OAAO,OAAO,GAAG;gBAAE,OAAO;YAA2B;QACtD;QAEA,yBAAyB;QACzB,MAAM,SAAmB,EAAE;QAC3B,IAAI,SAAS,iBAAiB;YAC7B,OAAO,IAAI,CAAC,CAAC,eAAe,EAAE,QAAQ,eAAe,EAAE;QACxD;QACA,IAAI,WAAW,CAAC,eAAe,wBAAwB,CAAC,SAAS,QAAQ,EAAE;YAC1E,OAAO,IAAI,CAAC;QACb;QACA,IAAI,WAAW,QAAQ,uBAAuB,GAAG,GAAG;YACnD,OAAO,IAAI,CAAC,GAAG,QAAQ,uBAAuB,CAAC,6BAA6B,CAAC;QAC9E;QAEA,OAAO,aAAa,GAAG,OAAO,MAAM,KAAK,IAAI,SAAS;QACtD,OAAO,MAAM,GAAG;QAChB,OAAO,cAAc,GACpB,OAAO,MAAM,KAAK,IACf,sCACA,CAAC,0BAA0B,EAAE,OAAO,IAAI,CAAC,OAAO;QAEpD,OAAO;IACR;AACD;AAEA,gFAAgF;AAChF,2DAA2D;AAC3D,gFAAgF;AAEhF;;;CAGC,GACD,MAAM,iBAAiB;IACtB,UAAU;QACT,MAAM;QACN,oBAAoB;YACnB;YACA;YACA;YACA;YACA;YACA;YACA;SACA;QACD,gBAAgB;YACf;YACA;YACA;YACA;YACA;SACA;IACF;IACA,YAAY;QACX,MAAM;QACN,oBAAoB;YACnB;YACA;YACA;YACA;YACA;YACA;YACA;SACA;QACD,gBAAgB;YACf;YACA;YACA;YACA;YACA;SACA;IACF;IACA,MAAM;QACL,MAAM;QACN,oBAAoB;YACnB;YACA;YACA;YACA;YACA;YACA;YACA;SACA;QACD,gBAAgB;YACf;YACA;YACA;YACA;YACA;SACA;IACF;IACA,SAAS;QACR,MAAM;QACN,oBAAoB;YACnB;YACA;YACA;YACA;YACA;YACA;SACA;QACD,gBAAgB;YACf;YACA;YACA;YACA;YACA;SACA;IACF;IACA,SAAS;QACR,MAAM;QACN,oBAAoB;YACnB;YACA;YACA;YACA;YACA;YACA;SACA;QACD,gBAAgB;YACf;YACA;YACA;YACA;SACA;IACF;AACD;AAKO,MAAM,0BAA0B,IAAA,4RAAI,EAAC;IAC3C,aAAa,CAAC;;;;;;;+EAOgE,CAAC;IAC/E,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CACV,IAAI,CAAC;YAAC;YAAY;YAAc;YAAQ;YAAW;SAAU,EAC7D,QAAQ,CAAC;QACX,iBAAiB,mOAAC,CAChB,MAAM,GACN,QAAQ,GACR,QAAQ,CAAC;QACX,OAAO,mOAAC,CACN,MAAM,GACN,QAAQ,GACR,QAAQ,CAAC;IACZ;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,eAAe,EAAE,KAAK,EAAE;QACpD,MAAM,WAAW,cAAc,CAAC,UAAU;QAE1C,0BAA0B;QAC1B,MAAM,uBAAiC,EAAE;QACzC,IAAI,iBAAiB;YACpB,MAAM,OAAO,gBAAgB,WAAW;YAExC,yDAAyD;YACzD,KAAK,MAAM,OAAO,SAAS,kBAAkB,CAAE;gBAC9C,MAAM,WAAW,IAAI,WAAW;gBAChC,4BAA4B;gBAC5B,MAAM,WAAW,KAAK,KAAK,CAAC;gBAC5B,IAAI,SAAS,IAAI,CAAC,CAAC,KAAO,GAAG,MAAM,GAAG,KAAK,SAAS,QAAQ,CAAC,MAAM;oBAClE,qBAAqB,IAAI,CAAC;gBAC3B;YACD;QACD;QAEA,OAAO;YACN,SAAS;YACT;YACA,UAAU,SAAS,IAAI;YACvB,oBAAoB,SAAS,kBAAkB;YAC/C,gBACC,qBAAqB,MAAM,GAAG,IAAI,uBAAuB;YAC1D,gBAAgB,SAAS,cAAc;YACvC,kBAAkB,QACf,CAAC,+BAA+B,EAAE,MAAM,+CAA+C,CAAC,GACxF;YACH,YACC;QACF;IACD;AACD;AAKO,MAAM,4BAA4B,IAAA,4RAAI,EAAC;IAC7C,aAAa,CAAC;;;;;;yBAMU,CAAC;IACzB,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,UAAU,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC9B,cAAc,mOAAC,CACb,IAAI,CAAC;YAAC;YAAe;SAAa,EAClC,QAAQ,GACR,OAAO,CAAC;QACV,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACrC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IACvC;IACA,SAAS,OAAO,EAAE,QAAQ,EAAE,YAAY,EAAE,IAAI,EAAE,KAAK,EAAE;QACtD,MAAM,YAAY,SAAS,WAAW;QAEtC,qDAAqD;QACrD,IAAI,iBAAiB;QACrB,IAAI,aAAa;QACjB,IAAI,aAAa;QACjB,MAAM,QAAkB,EAAE;QAC1B,MAAM,cAAwB,EAAE;QAEhC,kBAAkB;QAClB,IACC,UAAU,QAAQ,CAAC,aACnB,UAAU,QAAQ,CAAC,cACnB,UAAU,QAAQ,CAAC,YACnB,UAAU,QAAQ,CAAC,iBACnB,UAAU,QAAQ,CAAC,WACnB,UAAU,QAAQ,CAAC,eAClB;YACD,iBAAiB;YACjB,aAAa;YACb,YAAY,IAAI,CAAC,uBAAuB;YACxC,IAAI,UAAU,QAAQ,CAAC,YAAY,UAAU,QAAQ,CAAC,YAAY;gBACjE,MAAM,IAAI,CAAC;YACZ;QACD;QAEA,gBAAgB;QAChB,IACC,UAAU,QAAQ,CAAC,mBACnB,UAAU,QAAQ,CAAC,eACnB,UAAU,QAAQ,CAAC,YACnB,UAAU,QAAQ,CAAC,YACnB,UAAU,QAAQ,CAAC,YAClB;YACD,iBAAiB;YACjB,aAAa;YACb,YAAY,IAAI,CAAC,uBAAuB;YACxC,IAAI,UAAU,QAAQ,CAAC,iBAAiB;gBACvC,MAAM,IAAI,CAAC;gBACX,aAAa;YACd;QACD;QAEA,YAAY;QACZ,IACC,UAAU,QAAQ,CAAC,WACnB,UAAU,QAAQ,CAAC,cACnB,UAAU,QAAQ,CAAC,oBACnB,UAAU,QAAQ,CAAC,UACnB,UAAU,QAAQ,CAAC,gBACnB,UAAU,QAAQ,CAAC,eAClB;YACD,iBAAiB;YACjB,aAAa;YACb,YAAY,IAAI,CAAC;YACjB,MAAM,IAAI,CAAC;QACZ;QAEA,UAAU;QACV,IAAI,UAAU,QAAQ,CAAC,WAAW,UAAU,QAAQ,CAAC,YAAY;YAChE,iBAAiB;YACjB,aAAa;YACb,YAAY,IAAI,CAAC;YACjB,MAAM,IAAI,CAAC;YACX,aAAa;QACd;QAEA,WAAW;QACX,IACC,UAAU,QAAQ,CAAC,eACnB,UAAU,QAAQ,CAAC,aAClB;YACD,iBAAiB;YACjB,aAAa;YACb,YAAY,IAAI,CAAC,4BAA4B;YAC7C,MAAM,IAAI,CAAC;YACX,aAAa;QACd;QAEA,gDAAgD;QAChD,IACC,UAAU,QAAQ,CAAC,aACnB,CAAC,UAAU,QAAQ,CAAC,cACpB,CAAC,UAAU,QAAQ,CAAC,YACnB;YACD,iBAAiB;YACjB,MAAM,IAAI,CAAC;YACX,aAAa;QACd;QAEA,6BAA6B;QAC7B,IAAI,UAAU,QAAQ,CAAC,oBAAoB,UAAU,QAAQ,CAAC,kBAAkB;YAC/E,MAAM,IAAI,CAAC;YACX,aAAa;QACd;QAEA,OAAO;YACN,SAAS;YACT;YACA;YACA,UAAU,QAAQ,QAAQ,GAAG,KAAK,EAAE,EAAE,OAAO,GAAG,SAAS;YACzD;YACA,YAAY,iBAAiB,aAAa;YAC1C;YACA,oBAAoB,iBAAiB,cAAc,EAAE;YACrD;YACA,iBAAiB,iBACd;gBACA;gBACA;gBACA;gBACA;aACA,GACA;gBACA;gBACA;aACA;YACH,YACC;QACF;IACD;AACD;AAKO,MAAM,iCAAiC,IAAA,4RAAI,EAAC;IAClD,aAAa,CAAC;;2DAE4C,CAAC;IAC3D,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC7B,gBAAgB,mOAAC,CACf,OAAO,GACP,QAAQ,GACR,OAAO,CAAC,MACR,QAAQ,CAAC;IACZ;IACA,SAAS,OAAO,EAAE,OAAO,EAAE,cAAc,EAAE;QAC1C,MAAM,WAAW,QAAQ,WAAW;QACpC,MAAM,YAA0D,EAAE;QAElE,wBAAwB;QACxB,IACC,SAAS,QAAQ,CAAC,mBAClB,SAAS,QAAQ,CAAC,cACjB;YACD,UAAU,IAAI,CAAC;gBACd,UAAU;gBACV,OAAO;oBACN;oBACA;oBACA;oBACA;iBACA;YACF;YACA,UAAU,IAAI,CAAC;gBACd,UAAU;gBACV,OAAO;oBACN;oBACA;oBACA;iBACA;YACF;YACA,UAAU,IAAI,CAAC;gBACd,UAAU;gBACV,OAAO;oBACN;oBACA;oBACA;oBACA;oBACA;iBACA;YACF;QACD;QAEA,2BAA2B;QAC3B,IACC,SAAS,QAAQ,CAAC,YAClB,SAAS,QAAQ,CAAC,iBAClB,SAAS,QAAQ,CAAC,YACjB;YACD,UAAU,IAAI,CAAC;gBACd,UAAU;gBACV,OAAO;oBACN;oBACA;oBACA;oBACA;oBACA;oBACA;iBACA;YACF;YACA,UAAU,IAAI,CAAC;gBACd,UAAU;gBACV,OAAO;oBACN;oBACA;oBACA;oBACA;iBACA;YACF;QACD;QAEA,OAAO;QACP,IACC,SAAS,QAAQ,CAAC,WAClB,SAAS,QAAQ,CAAC,cAClB,SAAS,QAAQ,CAAC,SAClB,SAAS,QAAQ,CAAC,cACjB;YACD,UAAU,IAAI,CAAC;gBACd,UAAU;gBACV,OAAO;oBACN;oBACA;oBACA;oBACA;oBACA;iBACA;YACF;YACA,UAAU,IAAI,CAAC;gBACd,UAAU;gBACV,OAAO;oBACN;oBACA;oBACA;oBACA;iBACA;YACF;YACA,IAAI,SAAS,QAAQ,CAAC,UAAU,SAAS,QAAQ,CAAC,YAAY;gBAC7D,UAAU,IAAI,CAAC;oBACd,UAAU;oBACV,OAAO;wBACN;wBACA;wBACA;wBACA;qBACA;gBACF;YACD;QACD;QAEA,mBAAmB;QACnB,IAAI,gBAAgB;YACnB,UAAU,IAAI,CAAC;gBACd,UAAU;gBACV,OAAO;oBACN;oBACA;oBACA;oBACA;oBACA;iBACA;YACF;QACD;QAEA,oDAAoD;QACpD,IAAI,UAAU,MAAM,KAAK,CAAC,iBAAiB,IAAI,CAAC,GAAG;YAClD,UAAU,OAAO,CAAC;gBACjB,UAAU;gBACV,OAAO;oBACN;oBACA;oBACA;oBACA;oBACA;oBACA;iBACA;YACF;QACD;QAEA,OAAO;YACN,SAAS;YACT;YACA;YACA,YAAY,UAAU,MAAM,CAAC,CAAC,KAAK,MAAQ,MAAM,IAAI,KAAK,CAAC,MAAM,EAAE;YACnE,UACC;YACD,YACC;QACF;IACD;AACD;AAYO,MAAM,kCAAkC,IAAA,4RAAI,EAAC;IACnD,aAAa,CAAC;;;;;;;gEAOiD,CAAC;IAChE,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,UAAU,mOAAC,CACT,MAAM,GACN,QAAQ,GACR,OAAO,CAAC,GACR,QAAQ,CAAC;QACX,OAAO,mOAAC,CACN,MAAM,GACN,QAAQ,GACR,OAAO,CAAC,IACR,QAAQ,CAAC;QACX,WAAW,mOAAC,CACV,IAAI,CAAC;YAAC;YAAO;YAAe;YAAU;YAAY;SAAS,EAC3D,QAAQ,GACR,OAAO,CAAC,OACR,QAAQ,CAAC;IACZ;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,QAAQ,EAAE,KAAK,EAAE,SAAS,EAAE;QACxD,MAAM,EAAE,2BAA2B,EAAE,GAAG;QAGxC,MAAM,WAAW;QAEjB,MAAM,YAAY,IAAI;QACtB,UAAU,OAAO,CAAC,UAAU,OAAO,KAAK;QAExC,6CAA6C;QAC7C,MAAM,EAAE,MAAM,KAAK,EAAE,KAAK,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,kBACL,MAAM,CACN,CAAC;;;;;;;;;;GAUF,CAAC,EAEA,EAAE,CAAC,cAAc,WACjB,GAAG,CAAC,cAAc,UAAU,WAAW,IACvC,GAAG,CAAC,mBAAmB,MAAM,MAC7B,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC;QAER,IAAI,SAAS,CAAC,OAAO;YACpB,OAAO;gBAAE,SAAS;gBAAO,OAAO,OAAO,WAAW;YAA0B;QAC7E;QAEA,MAAM,WAOD,EAAE;QAEP,+CAA+C;QAC/C,MAAM,WAAW;YAChB,aAAa;gBACZ;gBACA;gBACA;gBACA;gBACA;aACA;YACD,QAAQ;gBACP;gBACA;gBACA;gBACA;gBACA;gBACA;aACA;YACD,UAAU;gBACT;gBACA;gBACA;gBACA;gBACA;aACA;YACD,QAAQ;gBACP;gBACA;gBACA;gBACA;gBACA;aACA;QACF;QAEA,KAAK,MAAM,QAAQ,MAAO;YACzB,MAAM,UAAU,KAAK,eAAe,IAAI,KAAK,UAAU,IAAI;YAC3D,IAAI,CAAC,SAAS;YAEd,MAAM,WAAW,KAAK,QAAQ;YAE9B,uCAAuC;YACvC,MAAM,cACL,cAAc,QACV,OAAO,IAAI,CAAC,YACb;gBAAC;aAAmC;YAExC,KAAK,MAAM,QAAQ,YAAa;gBAC/B,KAAK,MAAM,WAAW,QAAQ,CAAC,KAAK,IAAI,EAAE,CAAE;oBAC3C,MAAM,UAAU,QAAQ,QAAQ,CAAC;oBACjC,KAAK,MAAM,SAAS,QAAS;wBAC5B,SAAS,IAAI,CAAC;4BACb,YAAY,KAAK,WAAW;4BAC5B,cAAc,UAAU,QAAQ;4BAChC,MAAM;4BACN,SAAS,KAAK,CAAC,EAAE;4BACjB,QAAQ,GAAG,KAAK,OAAO,CAAC,IAAI,EAAE,IAAI,KAAK,KAAK,UAAU,EAAE,kBAAkB,IAAI;4BAC9E,YAAY,SAAS,YAAY,SAAS,WAAW,SAAS;wBAC/D;oBACD;gBACD;YACD;YAEA,qCAAqC;YACrC,IACC,KAAK,cAAc,IACnB;gBAAC;gBAAY;aAAgB,CAAC,QAAQ,CAAC,KAAK,cAAc,GACzD;gBACD,SAAS,IAAI,CAAC;oBACb,YAAY,KAAK,WAAW;oBAC5B,cAAc,UAAU,QAAQ;oBAChC,MAAM;oBACN,SAAS,CAAC,+BAA+B,EAAE,KAAK,OAAO,CAAC,cAAc,CAAC;oBACvE,QAAQ,GAAG,KAAK,OAAO,CAAC,IAAI,EAAE,IAAI,KAAK,KAAK,UAAU,EAAE,kBAAkB,IAAI;oBAC9E,YAAY;gBACb;YACD;QACD;QAEA,OAAO;YACN,SAAS;YACT,wBAAwB,MAAM,MAAM;YACpC;YACA;YACA,eAAe,SAAS,MAAM;YAC9B,UAAU,SAAS,KAAK,CAAC,GAAG;YAC5B,SAAS;gBACR,QAAQ;oBACP,aAAa,SAAS,MAAM,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK,eAAe,MAAM;oBACpE,QAAQ,SAAS,MAAM,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK,UAAU,MAAM;oBAC1D,UAAU,SAAS,MAAM,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK,YAAY,MAAM;oBAC9D,QAAQ,SAAS,MAAM,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK,UAAU,MAAM;oBAC1D,WAAW,SAAS,MAAM,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK,aAAa,MAAM;gBACjE;gBACA,gBAAgB,SAAS,MAAM,CAAC,CAAC,IAAM,EAAE,UAAU,KAAK,QAAQ,MAAM;YACvE;QACD;IACD;AACD;AAKO,MAAM,6BAA6B,IAAA,4RAAI,EAAC;IAC9C,aAAa,CAAC;;;;;;;iDAOkC,CAAC;IACjD,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,UAAU,mOAAC,CACT,MAAM,GACN,QAAQ,GACR,OAAO,CAAC,IACR,QAAQ,CAAC;QACX,SAAS,mOAAC,CACR,MAAM,GACN,QAAQ,GACR,QAAQ,CAAC;IACZ;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,QAAQ,EAAE,OAAO,EAAE;QAC/C,MAAM,EAAE,2BAA2B,EAAE,GAAG;QAGxC,MAAM,WAAW;QAEjB,MAAM,YAAY,IAAI;QACtB,UAAU,OAAO,CAAC,UAAU,OAAO,KAAK;QAExC,IAAI,QAAQ,SACV,IAAI,CAAC,QACL,MAAM,CACN,CAAC;;;;;;;;;;;;GAYF,CAAC,EAEA,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,UAAU,aACb,GAAG,CAAC,cAAc,UAAU,WAAW,IACvC,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC;QAER,IAAI,SAAS;YACZ,QAAQ,MAAM,EAAE,CAAC,YAAY;QAC9B;QAEA,MAAM,EAAE,MAAM,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM;QAEpC,IAAI,SAAS,CAAC,MAAM;YACnB,OAAO;gBAAE,SAAS;gBAAO,OAAO,OAAO,WAAW;YAAgB;QACnE;QAEA,uBAAuB;QACvB,MAAM,mBAA6C,CAAC;QACpD,MAAM,kBAA4C,CAAC;QACnD,MAAM,mBAKD,EAAE;QAEP,KAAK,MAAM,OAAO,KAAM;YACvB,MAAM,OAAO,IAAI,QAAQ,IAAI;YAE7B,oBAAoB;YACpB,IAAI,IAAI,YAAY,IAAI,IAAI,UAAU,EAAE;gBACvC,MAAM,gBACL,CAAC,IAAI,KAAK,IAAI,UAAU,EAAE,OAAO,KAChC,IAAI,KAAK,IAAI,YAAY,EAAE,OAAO,EAAE,IACrC;gBACD,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAAE,gBAAgB,CAAC,KAAK,GAAG,EAAE;gBACxD,gBAAgB,CAAC,KAAK,CAAC,IAAI,CAAC;gBAE5B,sBAAsB;gBACtB,IAAI,IAAI,eAAe,IAAI,IAAI,aAAa,EAAE;oBAC7C,MAAM,mBACL,CAAC,IAAI,KAAK,IAAI,aAAa,EAAE,OAAO,KACnC,IAAI,KAAK,IAAI,eAAe,EAAE,OAAO,EAAE,IACxC;oBACD,iBAAiB,IAAI,CAAC;wBACrB,SAAS;wBACT;wBACA;wBACA,UAAU,KAAK,GAAG,CAAC,mBAAmB,eAAe,gBAAgB,oBAAoB;oBAC1F;gBACD;YACD;YAEA,mBAAmB;YACnB,IAAI,IAAI,YAAY,EAAE;gBACrB,IAAI,CAAC,eAAe,CAAC,KAAK,EAAE,eAAe,CAAC,KAAK,GAAG,EAAE;gBACtD,eAAe,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,YAAY;YAC5C;QACD;QAEA,qBAAqB;QACrB,MAAM,kBAGF,CAAC;QACL,KAAK,MAAM,CAAC,MAAM,UAAU,IAAI,OAAO,OAAO,CAAC,kBAAmB;YACjE,MAAM,MAAM,UAAU,MAAM,CAAC,CAAC,GAAG,IAAM,IAAI,GAAG,KAAK,UAAU,MAAM;YACnE,eAAe,CAAC,KAAK,GAAG;gBACvB,KAAK,KAAK,KAAK,CAAC;gBAChB,KAAK,KAAK,KAAK,CAAC,KAAK,GAAG,IAAI;gBAC5B,KAAK,KAAK,KAAK,CAAC,KAAK,GAAG,IAAI;gBAC5B,OAAO,UAAU,MAAM;YACxB;QACD;QAEA,MAAM,iBAGF,CAAC;QACL,KAAK,MAAM,CAAC,MAAM,QAAQ,IAAI,OAAO,OAAO,CAAC,iBAAkB;YAC9D,MAAM,MAAM,QAAQ,MAAM,CAAC,CAAC,GAAG,IAAM,IAAI,GAAG,KAAK,QAAQ,MAAM;YAC/D,cAAc,CAAC,KAAK,GAAG;gBACtB,KAAK,KAAK,KAAK,CAAC,MAAM,OAAO;gBAC7B,KAAK,KAAK,GAAG,IAAI;gBACjB,KAAK,KAAK,GAAG,IAAI;gBACjB,OAAO,QAAQ,MAAM;YACtB;QACD;QAEA,8BAA8B;QAC9B,MAAM,cACL,iBAAiB,MAAM,GAAG,IACvB,iBAAiB,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,QAAQ,EAAE,KACvD,iBAAiB,MAAM,GACtB;QAEJ,OAAO;YACN,SAAS;YACT,cAAc,KAAK,MAAM;YACzB;YACA,UAAU;gBACT,gBAAgB;gBAChB,eAAe;gBACf,oBAAoB,cACjB,GAAG,KAAK,KAAK,CAAC,aAAa,kBAAkB,CAAC,GAC9C;YACJ;YACA,iBAAiB,OAAO,OAAO,CAAC,iBAAiB,GAAG,CAAC,CAAC,CAAC,MAAM,MAAM,GAAK,CAAC;oBACxE,SAAS;oBACT,qBAAqB,MAAM,GAAG;oBAC9B,MACC,MAAM,GAAG,GAAG,MAAM,GAAG,GAAG,MACrB,CAAC,uCAAuC,EAAE,KAAK,iBAAiB,EAAE,MAAM,GAAG,CAAC,QAAQ,CAAC,GACrF;gBACL,CAAC;QACF;IACD;AACD;AAKO,MAAM,2BAA2B,IAAA,4RAAI,EAAC;IAC5C,aAAa,CAAC;;;;;;;8EAO+D,CAAC;IAC9E,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,YAAY,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAChC,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAChC;IACA,SAAS,OAAO,EAAE,UAAU,EAAE,SAAS,EAAE;QACxC,MAAM,EAAE,2BAA2B,EAAE,GAAG;QAGxC,MAAM,WAAW;QAEjB,sCAAsC;QACtC,MAAM,CACL,gBACA,YACA,aACA,gBACA,eACA,GAAG,MAAM,QAAQ,GAAG,CAAC;YACrB,SACE,IAAI,CAAC,aACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,YACT,EAAE,CAAC,cAAc,WACjB,MAAM;YACR,SACE,IAAI,CAAC,QACL,MAAM,CAAC,yDACP,EAAE,CAAC,eAAe,YAClB,KAAK,CAAC,cAAc;gBAAE,WAAW;YAAM,GACvC,KAAK,CAAC;YACR,SACE,IAAI,CAAC,kBACL,MAAM,CAAC,sDACP,EAAE,CAAC,eAAe,YAClB,KAAK,CAAC,cAAc;gBAAE,WAAW;YAAM,GACvC,KAAK,CAAC;YACR,SACE,IAAI,CAAC,YACL,MAAM,CAAC,8CACP,EAAE,CAAC,eAAe,YAClB,KAAK,CAAC,cAAc;gBAAE,WAAW;YAAM,GACvC,KAAK,CAAC;YACR,SACE,IAAI,CAAC,aACL,MAAM,CAAC,gDACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,aAAa,YAChB,EAAE,CAAC,eAAe,YAClB,KAAK,CAAC,cAAc;gBAAE,WAAW;YAAM,GACvC,KAAK,CAAC;SACR;QAED,MAAM,WAAW,eAAe,IAAI;QACpC,MAAM,OAAO,WAAW,IAAI,IAAI,EAAE;QAClC,MAAM,QAAQ,YAAY,IAAI,IAAI,EAAE;QACpC,MAAM,WAAW,eAAe,IAAI,IAAI,EAAE;QAC1C,MAAM,WAAW,eAAe,IAAI,IAAI,EAAE;QAE1C,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAqB;QACtD;QAEA,sBAAsB;QACtB,MAAM,gBAAgB,KAAK,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,KAAK;QACtD,MAAM,eAAe,KAAK,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,CAAC,EAAE,YAAY,IAAI,CAAC,GAAG;QAC1E,MAAM,WAAW;eAAI,IAAI,IAAI,KAAK,GAAG,CAAC,CAAC,IAAM,EAAE,QAAQ,EAAE,MAAM,CAAC;SAAU;QAE1E,kCAAkC;QAClC,MAAM,aAAa,MACjB,GAAG,CAAC,CAAC,IAAM,EAAE,cAAc,EAC3B,MAAM,CAAC;QACT,MAAM,qBAAqB,WAAW,MAAM,CAC3C,CAAC,IAAM,MAAM,cAAc,MAAM,iBAChC,MAAM;QACR,MAAM,qBAAqB,WAAW,MAAM,CAC3C,CAAC,IAAM,MAAM,cAAc,MAAM,iBAChC,MAAM;QAER,2BAA2B;QAC3B,MAAM,eAAe,SAAS,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,KAAK;QACzD,MAAM,kBAAkB,SAAS,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,KAAK;QAC5D,MAAM,YAAY,SAChB,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,KAAK,QAC3B,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,CAAC,CAAC,EAAE,KAAK,IAAI,CAAC,IAAI,CAAC,EAAE,WAAW,IAAI,CAAC,CAAC,GAAG;QAEpE,6CAA6C;QAC7C,IAAI,OAA8C;QAClD,IAAI,cAAc,MAAM,IAAI,KAAK,eAAe,MAAM;YACrD,OAAO;QACR,OAAO,IAAI,cAAc,MAAM,IAAI,GAAG;YACrC,OAAO;QACR;QACA,IAAI,qBAAqB,sBAAsB,gBAAgB,MAAM,GAAG,GAAG;YAC1E,OAAO;QACR;QAEA,OAAO;YACN,SAAS;YACT,UAAU;gBACT,IAAI,SAAS,EAAE;gBACf,MAAM,SAAS,IAAI;gBACnB,OAAO,SAAS,KAAK;gBACrB,OAAO,SAAS,KAAK;gBACrB,WAAW,SAAS,UAAU;YAC/B;YACA;YACA,YAAY;gBACX,WAAW,KAAK,MAAM;gBACtB,eAAe,cAAc,MAAM;gBACnC;gBACA,gBAAgB;gBAChB,YAAY,KAAK,KAAK,CAAC,GAAG,GAAG,GAAG,CAAC,CAAC,IAAM,CAAC;wBACxC,OAAO,EAAE,KAAK;wBACd,MAAM,EAAE,QAAQ;wBAChB,QAAQ,EAAE,MAAM;wBAChB,QAAQ,EAAE,YAAY;oBACvB,CAAC;YACF;YACA,sBAAsB;gBACrB,mBAAmB,MAAM,MAAM;gBAC/B,kBAAkB;oBACjB,OAAO,MAAM,MAAM,CAAC,CAAC,IAAM,EAAE,OAAO,KAAK,SAAS,MAAM;oBACxD,QAAQ,MAAM,MAAM,CAAC,CAAC,IAAM,EAAE,OAAO,KAAK,SAAS,MAAM;oBACzD,KAAK,MAAM,MAAM,CAAC,CAAC,IAAM,EAAE,OAAO,KAAK,OAAO,MAAM;gBACrD;gBACA,kBAAkB;oBACjB,UAAU;oBACV,UAAU;oBACV,SAAS,WAAW,MAAM,GAAG,qBAAqB;gBACnD;YACD;YACA,YAAY;gBACX,eAAe,SAAS,MAAM;gBAC9B,cAAc,aAAa,MAAM;gBACjC,iBAAiB,gBAAgB,MAAM;gBACvC,gBAAgB;gBAChB,eACC,gBAAgB,MAAM,KAAK,IACxB,SACA,gBAAgB,MAAM,GAAG,IACxB,SACA;YACN;YACA,UAAU,SAAS,GAAG,CAAC,CAAC,IAAM,CAAC;oBAC9B,SAAS,EAAE,OAAO;oBAClB,MAAM,EAAE,WAAW;oBACnB,YAAY,EAAE,UAAU;gBACzB,CAAC;YACD,iBACC,SAAS,YACN;gBACA;gBACA;gBACA;aACA,GACA,SAAS,QACR;gBACA;gBACA;gBACA;aACA,GACA;gBAAC;gBAA6B;aAAoC;QACxE;IACD;AACD;AAUO,MAAM,eAAe,IAAA,4RAAI,EAAC;IAChC,aACC;IACD,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,WAAW,mOAAC,CACV,KAAK,CACL,mOAAC,CAAC,MAAM,CAAC;YACR,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;YAC7B,KAAK,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;YACpC,KAAK,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;QACrC,IAEA,GAAG,CAAC,GACJ,QAAQ,CAAC;QACX,eAAe,mOAAC,CACd,OAAO,GACP,QAAQ,GACR,OAAO,CAAC,OACR,QAAQ,CAAC;IACZ;IACA,SAAS,OAAO,EAAE,SAAS,EAAE;QAC5B,4CAA4C;QAC5C,MAAM,oBAAoB,MAAM,QAAQ,GAAG,CAC1C,UAAU,GAAG,CAAC,OAAO;YACpB,IAAI,GAAG,GAAG,IAAI,GAAG,GAAG,EAAE;gBACrB,OAAO;oBAAE,GAAG,EAAE;oBAAE,aAAa;wBAAC,GAAG,GAAG;wBAAE,GAAG,GAAG;qBAAC;gBAAqB;YACnE;YACA,gEAAgE;YAChE,MAAM,aAAa,CAAC,yDAAyD,EAAE,mBAAmB,GAAG,OAAO,EAAE,QAAQ,CAAC;YACvH,IAAI;gBACH,MAAM,WAAW,MAAM,MAAM,YAAY;oBACxC,SAAS;wBACR,cAAc;wBACd,UAAU;oBACX;gBACD;gBACA,IAAI,CAAC,SAAS,EAAE,EAAE;oBACjB,QAAQ,IAAI,CAAC,CAAC,qBAAqB,EAAE,GAAG,OAAO,CAAC,EAAE,EAAE,SAAS,MAAM,EAAE;oBACrE,OAAO;wBAAE,GAAG,EAAE;wBAAE,aAAa;oBAAK;gBACnC;gBACA,MAAM,OAAO,MAAM,SAAS,IAAI;gBAChC,IAAI,KAAK,MAAM,GAAG,GAAG;oBACpB,OAAO;wBACN,GAAG,EAAE;wBACL,aAAa;4BACZ,WAAW,IAAI,CAAC,EAAE,CAAC,GAAG;4BACtB,WAAW,IAAI,CAAC,EAAE,CAAC,GAAG;yBACtB;oBACF;gBACD;YACD,EAAE,OAAO,OAAO;gBACf,QAAQ,IAAI,CAAC,CAAC,oBAAoB,EAAE,GAAG,OAAO,CAAC,CAAC,CAAC,EAAE;YACpD;YACA,OAAO;gBAAE,GAAG,EAAE;gBAAE,aAAa;YAAK;QACnC;QAGD,MAAM,iBAAiB,kBAAkB,MAAM,CAAC,CAAC,KAAO,GAAG,WAAW;QACtE,IAAI,eAAe,MAAM,GAAG,GAAG;YAC9B,OAAO;gBAAE,OAAO;YAAiD;QAClE;QAEA,yDAAyD;QACzD,MAAM,SAAS,QAAQ,GAAG,CAAC,wBAAwB;QACnD,IAAI,QAAQ;YACX,IAAI;gBACH,MAAM,cAAc,eAAe,GAAG,CAAC,CAAC,KAAO,GAAG,WAAW;gBAC7D,MAAM,WAAW,MAAM,MACtB,sEACA;oBACC,QAAQ;oBACR,SAAS;wBACR,eAAe;wBACf,gBAAgB;oBACjB;oBACA,MAAM,KAAK,SAAS,CAAC;wBAAE;wBAAa,cAAc;oBAAK;gBACxD;gBAED,MAAM,YAAY,MAAM,SAAS,IAAI;gBAErC,IAAI,UAAU,QAAQ,EAAE,CAAC,EAAE,EAAE;oBAC5B,MAAM,UAAU,UAAU,QAAQ,CAAC,EAAE;oBACrC,OAAO;wBACN,aAAa,CAAC,QAAQ,UAAU,CAAC,OAAO,CAAC,QAAQ,GAAG,IAAI,EAAE,OAAO,CAAC;wBAClE,kBAAkB,KAAK,KAAK,CAAC,QAAQ,UAAU,CAAC,OAAO,CAAC,QAAQ,GAAG;wBACnE,WAAW,eAAe,GAAG,CAAC,CAAC,KAAO,GAAG,OAAO;wBAChD,UAAU,QAAQ,QAAQ;oBAC3B;gBACD;YACD,EAAE,OAAM;YACP,2BAA2B;YAC5B;QACD;QAEA,sDAAsD;QACtD,MAAM,SAAS,eAAe,GAAG,CAAC,CAAC,KAAO,GAAG,WAAW;QACxD,IAAI,gBAAgB;QACpB,IAAK,IAAI,IAAI,GAAG,IAAI,OAAO,MAAM,GAAG,GAAG,IAAK;YAC3C,MAAM,CAAC,MAAM,KAAK,GAAG,MAAM,CAAC,EAAE;YAC9B,MAAM,CAAC,MAAM,KAAK,GAAG,MAAM,CAAC,IAAI,EAAE;YAClC,MAAM,IAAI;YACV,MAAM,OAAO,AAAC,CAAC,OAAO,IAAI,IAAI,KAAK,EAAE,GAAI;YACzC,MAAM,OAAO,AAAC,CAAC,OAAO,IAAI,IAAI,KAAK,EAAE,GAAI;YACzC,MAAM,IACL,KAAK,GAAG,CAAC,OAAO,KAAK,KAAK,GAAG,CAAC,OAAO,KACrC,KAAK,GAAG,CAAC,AAAC,OAAO,KAAK,EAAE,GAAI,OAC3B,KAAK,GAAG,CAAC,AAAC,OAAO,KAAK,EAAE,GAAI,OAC5B,KAAK,GAAG,CAAC,OAAO,KAChB,KAAK,GAAG,CAAC,OAAO;YAClB,MAAM,IAAI,IAAI,KAAK,KAAK,CAAC,KAAK,IAAI,CAAC,IAAI,KAAK,IAAI,CAAC,IAAI;YACrD,iBAAiB,IAAI;QACtB;QAEA,MAAM,kBAAkB,gBAAgB;QACxC,MAAM,kBAAkB,KAAK,KAAK,CAAC,AAAC,kBAAkB,KAAM;QAE5D,OAAO;YACN,aAAa,gBAAgB,OAAO,CAAC;YACrC,kBAAkB;YAClB,WAAW,eAAe,GAAG,CAAC,CAAC,KAAO,GAAG,OAAO;YAChD,MAAM;QACP;IACD;AACD;AAKO,MAAM,0BAA0B,IAAA,4RAAI,EAAC;IAC3C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,UAAU,mOAAC,CAAC,MAAM,CAAC;YAClB,KAAK,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;YACzB,KAAK,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC1B;QACA,YAAY,mOAAC,CACX,IAAI,CAAC;YAAC;YAAY;YAAc;YAAQ;YAAY;SAAM,EAC1D,OAAO,CAAC;QACV,UAAU,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACzC;IACA,SAAS,OAAO,EAAE,QAAQ,EAAE,UAAU,EAAE,QAAQ,EAAE;QACjD,MAAM,cAAsC;YAC3C,UAAU;YACV,YAAY;YACZ,MAAM;YACN,UAAU;YACV,KAAK;QACN;QAEA,MAAM,SAAS,WAAW,CAAC,WAAW;QACtC,MAAM,QAAQ,CAAC,4BAA4B,EAAE,OAAO,QAAQ,EAAE,WAAW,KAAK,CAAC,EAAE,SAAS,GAAG,CAAC,CAAC,EAAE,SAAS,GAAG,CAAC,KAAK,EAAE,OAAO,QAAQ,EAAE,WAAW,KAAK,CAAC,EAAE,SAAS,GAAG,CAAC,CAAC,EAAE,SAAS,GAAG,CAAC,eAAe,CAAC;QAEtM,IAAI;YACH,MAAM,WAAW,MAAM,MAAM,2CAA2C;gBACvE,QAAQ;gBACR,MAAM;YACP;YACA,MAAM,OAAO,MAAM,SAAS,IAAI;YAEhC,MAAM,YAAY,KAAK,QAAQ,CAC7B,GAAG,CAAC,CAAC,KAA0I,CAAC;oBAChJ,MAAM,GAAG,IAAI,EAAE,QAAQ;oBACvB,OAAO,GAAG,IAAI,EAAE;oBAChB,SAAS,GAAG,IAAI,EAAE;oBAClB,KAAK,GAAG,GAAG,IAAI,GAAG,MAAM,EAAE;oBAC1B,KAAK,GAAG,GAAG,IAAI,GAAG,MAAM,EAAE;gBAC3B,CAAC,GACA,MAAM,CAAC,CAAC,IAAwB,EAAE,IAAI,KAAK,oBAC3C,KAAK,CAAC,GAAG;YAEX,OAAO;gBAAE;gBAAW,cAAc;gBAAU;YAAW;QACxD,EAAE,OAAM;YACP,OAAO;gBAAE,OAAO;YAAiC;QAClD;IACD;AACD;AASO,MAAM,sBAAsB,IAAA,4RAAI,EAAC;IACvC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,UAAU,mOAAC,CAAC,MAAM,GAAG,QAAQ;QAC7B,aAAa,mOAAC,CAAC,OAAO,GAAG,QAAQ,GAAG,OAAO,CAAC;IAC7C;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,QAAQ,EAAE,WAAW,EAAE;QAC1D,MAAM,WAAW,MAAM;QAEvB,IAAI,UAAU,SACZ,IAAI,CAAC,aACL,MAAM,CAAC,6HACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,CAAC,YAAY,EAAE,MAAM,aAAa,EAAE,MAAM,qBAAqB,EAAE,MAAM,CAAC,CAAC;QAE9E,IAAI,UAAU,UAAU,QAAQ,EAAE,CAAC,YAAY;QAC/C,IAAI,aAAa,UAAU,QAAQ,EAAE,CAAC,oBAAoB;QAE1D,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,QAAQ,KAAK,CAAC,QAAQ,KAAK,CAAC;QAC1D,IAAI,OAAO,OAAO;YAAE,OAAO,MAAM,OAAO;QAAC;QAEzC,OAAO;YACN,OAAO,KAAK,GAAG,CAAC,CAAC,OAAS,CAAC;oBAC1B,GAAG,IAAI;oBACP,WAAW,KAAK,gBAAgB,GAAG,CAAC,KAAK,iBAAiB,IAAI,CAAC;oBAC/D,cAAc,KAAK,gBAAgB,IAAI,CAAC,KAAK,aAAa,IAAI,CAAC;gBAChE,CAAC;YACD,OAAO,KAAK,MAAM;QACnB;IACD;AACD;AAKO,MAAM,6BAA6B,IAAA,4RAAI,EAAC;IAC9C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,OAAO,mOAAC,CAAC,KAAK,CACb,mOAAC,CAAC,MAAM,CAAC;YACR,QAAQ,mOAAC,CAAC,MAAM,GAAG,QAAQ;YAC3B,KAAK,mOAAC,CAAC,MAAM,GAAG,QAAQ;YACxB,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ;YACzB,UAAU,mOAAC,CAAC,MAAM;QACnB;IAEF;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE;QACnC,IAAI,CAAC,MAAM,MAAM,EAAE;YAClB,OAAO;gBAAE,OAAO;YAAgC;QACjD;QAEA,MAAM,WAAW,MAAM;QAEvB,wDAAwD;QACxD,MAAM,UAAU,MAAM,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,EAAE,GAAG,CAAC,CAAC,IAAM,EAAE,MAAM;QACjE,MAAM,OAAO,MAAM,MAAM,CAAC,CAAC,IAAM,EAAE,GAAG,IAAI,CAAC,EAAE,MAAM,EAAE,GAAG,CAAC,CAAC,IAAM,EAAE,GAAG;QAErE,kDAAkD;QAClD,IAAI,iBAAiB,SACnB,IAAI,CAAC,aACL,MAAM,CAAC,6EACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,cAAc;QAEnB,uCAAuC;QACvC,MAAM,eAAyB,EAAE;QACjC,IAAI,QAAQ,MAAM,GAAG,GAAG;YACvB,aAAa,IAAI,CAAC,CAAC,OAAO,EAAE,QAAQ,IAAI,CAAC,KAAK,CAAC,CAAC;QACjD;QACA,IAAI,KAAK,MAAM,GAAG,GAAG;YACpB,aAAa,IAAI,CAAC,CAAC,QAAQ,EAAE,KAAK,IAAI,CAAC,KAAK,CAAC,CAAC;QAC/C;QAEA,IAAI,iBAAsL,EAAE;QAE5L,IAAI,aAAa,MAAM,GAAG,GAAG;YAC5B,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,eAAe,EAAE,CAAC,aAAa,IAAI,CAAC;YAC3D,iBAAiB,QAAQ,EAAE;QAC5B;QAEA,yEAAyE;QACzE,MAAM,gBAAgB,MAAM,MAAM,CAAC,CAAC,IAAM,CAAC,EAAE,MAAM,IAAI,CAAC,EAAE,GAAG,IAAI,EAAE,IAAI;QACvE,IAAI,cAAc,MAAM,GAAG,GAAG;YAC7B,MAAM,cAAc,MAAM,QAAQ,GAAG,CACpC,cAAc,GAAG,CAAC,OAAO;gBACxB,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,aACL,MAAM,CAAC,6EACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,cAAc,MACjB,KAAK,CAAC,QAAQ,CAAC,CAAC,EAAE,KAAK,IAAI,CAAC,CAAC,CAAC,EAC9B,KAAK,CAAC,GACN,MAAM;gBACR,OAAO;YACR;YAED,eAAe,IAAI,IAAI,YAAY,MAAM,CAAC,CAAC,IAAkC,MAAM;QACpF;QAEA,uBAAuB;QACvB,MAAM,UAAU,MAAM,GAAG,CAAC,CAAC;YAC1B,MAAM,OAAO,eAAe,IAAI,CAC/B,CAAC,MACA,AAAC,KAAK,MAAM,IAAI,IAAI,EAAE,KAAK,KAAK,MAAM,IACrC,KAAK,GAAG,IAAI,IAAI,GAAG,KAAK,KAAK,GAAG,IAChC,KAAK,IAAI,IAAI,IAAI,IAAI,CAAC,WAAW,GAAG,QAAQ,CAAC,KAAK,IAAI,CAAC,WAAW;YAGrE,IAAI,CAAC,MAAM;gBACV,OAAO;oBAAE,GAAG,IAAI;oBAAE,OAAO;oBAAO,WAAW;oBAAG,YAAY;gBAAM;YACjE;YAEA,MAAM,YAAY,KAAK,gBAAgB,GAAG,CAAC,KAAK,iBAAiB,IAAI,CAAC;YACtE,OAAO;gBACN,QAAQ,KAAK,EAAE;gBACf,KAAK,KAAK,GAAG;gBACb,MAAM,KAAK,IAAI;gBACf,OAAO;gBACP;gBACA,QAAQ,KAAK,QAAQ;gBACrB,YAAY,aAAa,KAAK,QAAQ;gBACtC,WAAW,KAAK,UAAU;gBAC1B,YAAY,CAAC,KAAK,UAAU,IAAI,CAAC,IAAI,KAAK,QAAQ;YACnD;QACD;QAEA,OAAO;YACN,mBAAmB,QAAQ,KAAK,CAAC,CAAC,IAAM,EAAE,UAAU;YACpD,OAAO;YACP,cAAc,QAAQ,MAAM,CAAC,CAAC,IAAM,CAAC,EAAE,UAAU;YACjD,qBAAqB,QAAQ,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,CAAC,EAAE,UAAU,IAAI,CAAC,GAAG;QAC5E;IACD;AACD;AAKO,MAAM,wBAAwB,IAAA,4RAAI,EAAC;IACzC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,UAAU,mOAAC,CAAC,MAAM,GAAG,QAAQ;QAC7B,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,IAAI,QAAQ,CAAC;IACnD;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,QAAQ,EAAE,KAAK,EAAE;QAC7C,MAAM,WAAW,MAAM;QAEvB,qEAAqE;QACrE,IAAI,QAAQ,SACV,IAAI,CAAC,aACL,MAAM,CAAC,yFACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,cAAc,MACjB,GAAG,CAAC,iBAAiB,MAAM;QAE7B,IAAI,UAAU,QAAQ,MAAM,EAAE,CAAC,YAAY;QAE3C,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,MAAM,KAAK,CAAC,oBAAoB;YAAE,WAAW;QAAK,GAAG,KAAK,CAAC,QAAQ;QACjG,IAAI,OAAO,OAAO;YAAE,OAAO,MAAM,OAAO;QAAC;QAEzC,uDAAuD;QACvD,MAAM,gBAAgB,KACpB,MAAM,CAAC,CAAC,OAAS,KAAK,gBAAgB,IAAI,CAAC,KAAK,aAAa,IAAI,CAAC,GAClE,KAAK,CAAC,GAAG,OACT,GAAG,CAAC,CAAC,OAAS,CAAC;gBACf,GAAG,IAAI;gBACP,WAAW,CAAC,KAAK,aAAa,IAAI,CAAC,IAAI,KAAK,gBAAgB;gBAC5D,mBAAmB,KAAK,gBAAgB,IAAI;gBAC5C,SAAS,KAAK,gBAAgB,KAAK,IAAI,aAAa,KAAK,gBAAgB,IAAI,CAAC,KAAK,aAAa,IAAI,CAAC,IAAI,IAAI,SAAS;YACvH,CAAC;QAEF,OAAO;YACN,eAAe,cAAc,MAAM;YACnC,OAAO;YACP,eAAe,cAAc,MAAM,CAAC,CAAC,IAAM,EAAE,OAAO,KAAK,YAAY,MAAM;QAC5E;IACD;AACD;AASO,MAAM,2BAA2B,IAAA,4RAAI,EAAC;IAC5C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,YAAY,mOAAC,CAAC,MAAM,GAAG,QAAQ;QAC/B,YAAY,mOAAC,CAAC,MAAM,GAAG,QAAQ;IAChC;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,UAAU,EAAE,UAAU,EAAE;QACpD,4CAA4C;QAC5C,IAAI,CAAC,cAAc,CAAC,YAAY;YAC/B,OAAO;gBAAE,OAAO;YAA8C;QAC/D;QAEA,MAAM,WAAW,MAAM;QAEvB,IAAI,QAAQ,SACV,IAAI,CAAC,aACL,MAAM,CAAC,0IACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,cAAc;QAEnB,IAAI,YAAY;YACf,QAAQ,MAAM,EAAE,CAAC,eAAe;QACjC,OAAO,IAAI,YAAY;YACtB,MAAM,EAAE,MAAM,UAAU,EAAE,GAAG,MAAM,SACjC,IAAI,CAAC,cACL,MAAM,CAAC,MACP,EAAE,CAAC,eAAe,YAClB,EAAE,CAAC,cAAc;YACnB,IAAI,CAAC,YAAY,QAAQ;gBACxB,OAAO;oBAAE,WAAW,EAAE;oBAAE,OAAO;oBAAG,SAAS;gBAAwC;YACpF;YACA,QAAQ,MAAM,EAAE,CAAC,eAAe,WAAW,GAAG,CAAC,CAAC,IAAM,EAAE,EAAE;QAC3D;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,MAAM,KAAK,CAAC,QAAQ,KAAK,CAAC;QACxD,IAAI,OAAO,OAAO;YAAE,OAAO,MAAM,OAAO;QAAC;QAEzC,MAAM,MAAM,IAAI;QAChB,OAAO;YACN,WAAW,KAAK,GAAG,CAAC,CAAC,KAAO,CAAC;oBAC5B,GAAG,EAAE;oBACL,gBAAgB,GAAG,eAAe,GAC/B,IAAI,KAAK,GAAG,eAAe,IAAI,MAAM,WAAW,YAChD;oBACH,YAAY,GAAG,gBAAgB,GAAG,IAAI,KAAK,GAAG,gBAAgB,KAAK,MAAM;gBAC1E,CAAC;YACD,OAAO,KAAK,MAAM;QACnB;IACD;AACD;AAKO,MAAM,iCAAiC,IAAA,4RAAI,EAAC;IAClD,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,aAAa,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QACjC,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,WAAW,EAAE,KAAK,EAAE;QAChD,MAAM,WAAW,MAAM;QAEvB,MAAM,EAAE,MAAM,SAAS,EAAE,GAAG,MAAM,SAChC,IAAI,CAAC,aACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,aACT,EAAE,CAAC,cAAc,WACjB,MAAM;QAER,IAAI,CAAC,WAAW,OAAO;YAAE,OAAO;QAAsB;QAEtD,MAAM,EAAE,MAAM,cAAc,EAAE,GAAG,MAAM,SACrC,IAAI,CAAC,iBACL,MAAM,CAAC,gFACP,EAAE,CAAC,gBAAgB,aACnB,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC;QAER,OAAO;YACN,WAAW;gBACV,IAAI,UAAU,EAAE;gBAChB,MAAM,UAAU,IAAI;gBACpB,OAAO,UAAU,YAAY;gBAC7B,QAAQ,UAAU,aAAa;YAChC;YACA,gBAAgB,kBAAkB,EAAE;YACpC,eAAe,gBAAgB,UAAU;QAC1C;IACD;AACD;AAKO,MAAM,6BAA6B,IAAA,4RAAI,EAAC;IAC9C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,aAAa,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAClC;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,WAAW,EAAE;QACzC,MAAM,WAAW,MAAM;QAEvB,MAAM,EAAE,MAAM,SAAS,EAAE,KAAK,EAAE,GAAG,MAAM,SACvC,IAAI,CAAC,aACL,MAAM,CAAC,yFACP,EAAE,CAAC,MAAM,aACT,EAAE,CAAC,cAAc,WACjB,MAAM;QAER,IAAI,SAAS,CAAC,WAAW,OAAO;YAAE,OAAO;QAAsB;QAE/D,MAAM,MAAM,IAAI;QAChB,MAAM,cAAc,UAAU,eAAe,GAAG,IAAI,KAAK,UAAU,eAAe,IAAI;QACtF,IAAI,SAA6D;QACjE,IAAI,gBAAgB;QAEpB,IAAI,aAAa;YAChB,gBAAgB,KAAK,IAAI,CAAC,CAAC,YAAY,OAAO,KAAK,IAAI,OAAO,EAAE,IAAI,CAAC,KAAK,KAAK,KAAK,IAAI;YACxF,SAAS,gBAAgB,IAAI,YAAY,iBAAiB,KAAK,kBAAkB;QAClF;QAEA,OAAO;YACN,WAAW;gBAAE,MAAM,UAAU,IAAI;gBAAE,OAAO,UAAU,YAAY;gBAAE,QAAQ,UAAU,aAAa;YAAC;YAClG,UAAU;gBACT;gBACA,YAAY,UAAU,eAAe;gBACrC,eAAe,iBAAiB,gBAAgB,IAAI,gBAAgB;gBACpE,MAAM,UAAU,aAAa;YAC9B;QACD;IACD;AACD;AASO,MAAM,8BAA8B,IAAA,4RAAI,EAAC;IAC/C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,QAAQ,mOAAC,CAAC,KAAK,CAAC,mOAAC,CAAC,MAAM,IAAI,QAAQ;QACpC,gBAAgB,mOAAC,CAAC,KAAK,CAAC,mOAAC,CAAC,MAAM,IAAI,QAAQ;QAC5C,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IACtC;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,MAAM,EAAE,cAAc,EAAE,IAAI,EAAE;QAC1D,IAAI;YACH,MAAM,WAAW,MAAM;YAEvB,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,SACrC,IAAI,CAAC,uBACL,MAAM,CAAC,iGACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,QAAQ;YAEb,IAAI,OAAO,OAAO;gBAAE,OAAO,MAAM,OAAO;YAAC;YAEzC,IAAI,WAAW;YACf,IAAI,QAAQ,QAAQ;gBACnB,WAAW,SAAS,MAAM,CAAC,CAAC,IAC3B,OAAO,IAAI,CAAC,CAAC,QACZ,CAAC,AAAC,EAAE,MAAM,IAAiB,EAAE,EAAE,GAAG,CAAC,CAAC,IAAM,EAAE,WAAW,IAAI,QAAQ,CAAC,MAAM,WAAW;YAGxF;YACA,IAAI,gBAAgB,QAAQ;gBAC3B,WAAW,SAAS,MAAM,CAAC,CAAC,IAC3B,eAAe,IAAI,CAAC,CAAC,OACpB,CAAC,AAAC,EAAE,cAAc,IAAiB,EAAE,EAAE,GAAG,CAAC,CAAC,IAAM,EAAE,WAAW,IAAI,QAAQ,CAAC,KAAK,WAAW;YAG/F;YAEA,IAAI,MAAM;gBACT,MAAM,WAAW,IAAI,KAAK;gBAC1B,SAAS,QAAQ,CAAC,GAAG,GAAG,GAAG;gBAC3B,MAAM,SAAS,IAAI,KAAK;gBACxB,OAAO,QAAQ,CAAC,IAAI,IAAI,IAAI;gBAE5B,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,QACL,MAAM,CAAC,eACP,EAAE,CAAC,cAAc,MACjB,EAAE,CAAC,eAAe,SAAS,GAAG,CAAC,CAAC,IAAM,EAAE,EAAE,GAC1C,GAAG,CAAC,mBAAmB,SAAS,WAAW,IAC3C,GAAG,CAAC,mBAAmB,OAAO,WAAW;gBAE3C,MAAM,YAAoC,CAAC;gBAC3C,aAAa,QAAQ,CAAC;oBACrB,IAAI,EAAE,WAAW,EAAE,SAAS,CAAC,EAAE,WAAW,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE,WAAW,CAAC,IAAI,CAAC,IAAI;gBACjF;gBAEA,WAAW,SAAS,GAAG,CAAC,CAAC,IAAM,CAAC;wBAC/B,GAAG,CAAC;wBACJ,YAAY,SAAS,CAAC,EAAE,EAAE,CAAC,IAAI;wBAC/B,cAAc,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,IAAI,CAAC,MAAM,IAAI,cAAc,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,IAAI,qBAAqB;oBAC9G,CAAC;YACF;YAEA,OAAO;gBACN,aAAa,SAAS,GAAG,CAAC,CAAC,IAAM,CAAC;wBACjC,IAAI,EAAE,EAAE;wBACR,MAAM,GAAI,EAAE,IAAI,EAAgD,WAAW,CAAC,EAAG,EAAE,IAAI,EAAgD,WAAW;wBAChJ,QAAQ,EAAE,MAAM;wBAChB,gBAAgB,EAAE,cAAc;wBAChC,cAAc,AAAC,EAAgC,YAAY;oBAC5D,CAAC;gBACD,OAAO,SAAS,MAAM;YACvB;QACD,EAAE,OAAO,KAAK;YACb,OAAO;gBAAE,OAAO,eAAe,QAAQ,IAAI,OAAO,GAAG;YAA6B;QACnF;IACD;AACD;AAKO,MAAM,4BAA4B,IAAA,4RAAI,EAAC;IAC7C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,cAAc,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAClC,WAAW,mOAAC,CAAC,MAAM;QACnB,SAAS,mOAAC,CAAC,MAAM;IAClB;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,YAAY,EAAE,SAAS,EAAE,OAAO,EAAE;QAC9D,IAAI;YACH,MAAM,WAAW,MAAM;YAEvB,MAAM,EAAE,MAAM,IAAI,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,uBACL,MAAM,CAAC,yCACP,EAAE,CAAC,MAAM,cACT,EAAE,CAAC,cAAc,WACjB,MAAM;YAER,IAAI,CAAC,MAAM,OAAO;gBAAE,OAAO;YAAuB;YAElD,MAAM,EAAE,MAAM,IAAI,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,QACL,MAAM,CAAC,+EACP,EAAE,CAAC,eAAe,cAClB,EAAE,CAAC,cAAc,MACjB,GAAG,CAAC,mBAAmB,WACvB,GAAG,CAAC,mBAAmB,SACvB,KAAK,CAAC;YAER,OAAO;gBACN,YAAY;oBAAE,IAAI,KAAK,EAAE;oBAAE,MAAM,GAAI,KAAK,IAAI,EAAgD,WAAW,CAAC,EAAG,KAAK,IAAI,EAAgD,WAAW;gBAAC;gBAClL,SAAS;oBACR,WAAW,MAAM,UAAU;oBAC3B,WAAW,MAAM,OAAO,CAAC,IAAM,EAAE,MAAM,KAAK,aAAa,UAAU;oBACnE,WAAW,MAAM,OAAO,CAAC,IAAM,EAAE,MAAM,KAAK,aAAa,UAAU;gBACpE;gBACA,MAAM,MAAM,IAAI,CAAC,IAAM,CAAC;wBACvB,IAAI,EAAE,EAAE;wBACR,OAAO,EAAE,KAAK;wBACd,QAAQ,EAAE,MAAM;wBAChB,gBAAgB,EAAE,eAAe;wBACjC,UAAW,EAAE,QAAQ,EAAuB;oBAC7C,CAAC,MAAM,EAAE;YACV;QACD,EAAE,OAAO,KAAK;YACb,OAAO;gBAAE,OAAO,eAAe,QAAQ,IAAI,OAAO,GAAG;YAAoC;QAC1F;IACD;AACD;AASO,MAAM,sBAAsB,IAAA,4RAAI,EAAC;IACvC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,OAAO,mOAAC,CAAC,MAAM;QACf,UAAU,mOAAC,CAAC,MAAM,GAAG,QAAQ;IAC9B;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,QAAQ,EAAE;QAC7C,MAAM,WAAW,MAAM;QAEvB,IAAI,UAAU,SACZ,IAAI,CAAC,oBACL,MAAM,CAAC,qEACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,aAAa,MAChB,EAAE,CAAC,CAAC,YAAY,EAAE,MAAM,qBAAqB,EAAE,MAAM,aAAa,EAAE,MAAM,CAAC,CAAC;QAE9E,IAAI,UAAU,UAAU,QAAQ,EAAE,CAAC,YAAY;QAC/C,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,QAAQ,KAAK,CAAC,QAAQ,KAAK,CAAC;QAC1D,IAAI,OAAO,OAAO;YAAE,OAAO,MAAM,OAAO;QAAC;QAEzC,OAAO;YACN,OAAO,KAAK,GAAG,CAAC,CAAC,OAAS,CAAC;oBAC1B,GAAG,IAAI;oBACP,QAAQ,KAAK,UAAU,GAAG,CAAC,KAAK,IAAI,IAAI,CAAC;gBAC1C,CAAC;YACD,OAAO,KAAK,MAAM;QACnB;IACD;AACD;AAKO,MAAM,wBAAwB,IAAA,4RAAI,EAAC;IACzC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,OAAO,mOAAC,CAAC,KAAK,CACb,mOAAC,CAAC,MAAM,CAAC;YACR,iBAAiB,mOAAC,CAAC,MAAM,GAAG,QAAQ;YACpC,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ;YACzB,UAAU,mOAAC,CAAC,MAAM,GAAG,OAAO,CAAC;YAC7B,aAAa,mOAAC,CAAC,MAAM,GAAG,QAAQ;QACjC;QAED,UAAU,mOAAC,CAAC,MAAM,CAAC;YAAE,MAAM,mOAAC,CAAC,IAAI,CAAC;gBAAC;gBAAc;aAAQ;YAAG,OAAO,mOAAC,CAAC,MAAM;QAAG,GAAG,QAAQ;QACzF,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ;IAC7B;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,QAAQ,EAAE,OAAO,EAAE;QACtD,MAAM,WAAW,MAAM;QAEvB,MAAM,eAAe,MAAM,MAAM,CAAC,CAAC,IAAM,EAAE,eAAe,EAAE,GAAG,CAAC,CAAC,IAAM,EAAE,eAAe;QACxF,IAAI,iBAA0F,EAAE;QAChG,IAAI,aAAa,MAAM,GAAG,GAAG;YAC5B,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,oBAAoB,MAAM,CAAC,8BAA8B,EAAE,CAAC,MAAM;YACvG,iBAAiB,QAAQ,EAAE;QAC5B;QAEA,MAAM,YAAY,MAAM,GAAG,CAAC,CAAC;YAC5B,MAAM,SAAS,eAAe,IAAI,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK,KAAK,eAAe;YACvE,MAAM,YAAY,KAAK,WAAW,IAAI,QAAQ,cAAc;YAC5D,OAAO;gBACN,MAAM,KAAK,IAAI,IAAI,QAAQ,QAAQ;gBACnC,UAAU,KAAK,QAAQ;gBACvB;gBACA,WAAW,YAAY,KAAK,QAAQ;YACrC;QACD;QAEA,MAAM,WAAW,UAAU,MAAM,CAAC,CAAC,KAAK,OAAS,MAAM,KAAK,SAAS,EAAE;QACvE,IAAI,iBAAiB;QACrB,IAAI,UAAU;YACb,iBAAiB,SAAS,IAAI,KAAK,eAAe,WAAW,CAAC,SAAS,KAAK,GAAG,GAAG,IAAI,SAAS,KAAK;QACrG;QACA,MAAM,gBAAgB,WAAW;QACjC,MAAM,YAAY,gBAAgB,CAAC,CAAC,WAAW,CAAC,IAAI,GAAG;QAEvD,OAAO;YACN;YACA;YACA,UAAU,iBAAiB,IAAI;gBAAE,GAAG,QAAQ;gBAAE,QAAQ;YAAe,IAAI;YACzE,KAAK;gBAAE,MAAM,WAAW;gBAAG,QAAQ;YAAU;YAC7C,YAAY,gBAAgB;QAC7B;IACD;AACD;AASO,MAAM,8BAA8B,IAAA,4RAAI,EAAC;IAC/C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,SAAS,mOAAC,CAAC,MAAM;QACjB,gBAAgB,mOAAC,CAAC,KAAK,CAAC,mOAAC,CAAC,MAAM,IAAI,QAAQ;QAC5C,eAAe,mOAAC,CAAC,MAAM;IACxB;IACA,SAAS,OAAO,EAAE,SAAS,EAAE,OAAO,EAAE,cAAc,EAAE,aAAa,EAAE;QACpE,IAAI;YACH,MAAM,WAAW,MAAM;YAEvB,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,uBACL,MAAM,CAAC,sEACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,QAAQ;YAEb,IAAI,CAAC,aAAa,QAAQ,OAAO;gBAAE,OAAO;YAAuB;YAEjE,MAAM,WAAW,IAAI,KAAK;YAC1B,SAAS,QAAQ,CAAC,GAAG,GAAG,GAAG;YAC3B,MAAM,SAAS,IAAI,KAAK;YACxB,OAAO,QAAQ,CAAC,IAAI,IAAI,IAAI;YAE5B,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,QACL,MAAM,CAAC,eACP,EAAE,CAAC,cAAc,MACjB,EAAE,CAAC,eAAe,YAAY,GAAG,CAAC,CAAC,IAAM,EAAE,EAAE,GAC7C,GAAG,CAAC,mBAAmB,SAAS,WAAW,IAC3C,GAAG,CAAC,mBAAmB,OAAO,WAAW;YAE3C,MAAM,YAAoC,CAAC;YAC3C,cAAc,QAAQ,CAAC;gBACtB,IAAI,EAAE,WAAW,EAAE,SAAS,CAAC,EAAE,WAAW,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE,WAAW,CAAC,IAAI,CAAC,IAAI;YACjF;YAEA,MAAM,SAAS,YAAY,GAAG,CAAC,CAAC;gBAC/B,IAAI,QAAQ;gBACZ,MAAM,UAAoB,EAAE;gBAE5B,MAAM,aAAa,CAAC,AAAC,KAAK,MAAM,IAAiB,EAAE,EAAE,GAAG,CAAC,CAAC,IAAM,EAAE,WAAW;gBAC7E,MAAM,gBAAgB,CAAC,kBAAkB,EAAE,EAAE,MAAM,CAAC,CAAC,IAAM,WAAW,QAAQ,CAAC,EAAE,WAAW;gBAC5F,IAAI,cAAc,MAAM,GAAG,GAAG;oBAC7B,SAAS,KAAK,CAAC,cAAc,MAAM,GAAG,CAAC,gBAAgB,UAAU,CAAC,CAAC;oBACnE,QAAQ,IAAI,CAAC,CAAC,QAAQ,EAAE,cAAc,MAAM,CAAC,OAAO,CAAC;gBACtD;gBAEA,MAAM,iBAAiB,CAAC,AAAC,KAAK,mBAAmB,IAAiB,EAAE,EAAE,GAAG,CAAC,CAAC,IAAM,EAAE,WAAW;gBAC9F,IAAI,eAAe,QAAQ,CAAC,QAAQ,WAAW,KAAK;oBACnD,SAAS;oBACT,QAAQ,IAAI,CAAC;gBACd;gBAEA,MAAM,WAAW,SAAS,CAAC,KAAK,EAAE,CAAC,IAAI;gBACvC,IAAI,aAAa,GAAG;oBAAE,SAAS;oBAAI,QAAQ,IAAI,CAAC;gBAAoB,OAC/D,IAAI,WAAW,GAAG;oBAAE,SAAS;oBAAI,QAAQ,IAAI,CAAC,GAAG,SAAS,eAAe,CAAC;gBAAG;gBAElF,OAAO;oBACN,IAAI,KAAK,EAAE;oBACX,MAAM,GAAI,KAAK,IAAI,EAAgD,WAAW,CAAC,EAAG,KAAK,IAAI,EAAgD,WAAW;oBACtJ,OAAO,KAAK,KAAK,CAAC;oBAClB;oBACA,YAAY;gBACb;YACD;YAEA,OAAO,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,KAAK,GAAG,EAAE,KAAK;YACvC,OAAO;gBAAE,iBAAiB,OAAO,KAAK,CAAC,GAAG;gBAAI,WAAW,MAAM,CAAC,EAAE;YAAC;QACpE,EAAE,OAAO,KAAK;YACb,OAAO;gBAAE,OAAO,eAAe,QAAQ,IAAI,OAAO,GAAG;YAA+B;QACrF;IACD;AACD;AAKO,MAAM,uBAAuB,IAAA,4RAAI,EAAC;IACxC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,WAAW,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC/B,cAAc,mOAAC,CAAC,MAAM;QACtB,MAAM,mOAAC,CAAC,MAAM;IACf;IACA,SAAS,OAAO,EAAE,YAAY,EAAE,IAAI,EAAE;QACrC,IAAI;YACH,MAAM,WAAW,MAAM;YAEvB,MAAM,WAAW,IAAI,KAAK;YAC1B,SAAS,QAAQ,CAAC,GAAG,GAAG,GAAG;YAC3B,MAAM,SAAS,IAAI,KAAK;YACxB,OAAO,QAAQ,CAAC,IAAI,IAAI,IAAI;YAE5B,MAAM,EAAE,MAAM,IAAI,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,QACL,MAAM,CAAC,iGACP,EAAE,CAAC,eAAe,cAClB,EAAE,CAAC,cAAc,MACjB,GAAG,CAAC,mBAAmB,SAAS,WAAW,IAC3C,GAAG,CAAC,mBAAmB,OAAO,WAAW,IACzC,KAAK,CAAC;YAER,IAAI,CAAC,QAAQ,KAAK,MAAM,GAAG,GAAG,OAAO;gBAAE,SAAS;gBAA+B,MAAM,QAAQ,EAAE;YAAC;YAEhG,MAAM,iBAAiB,KACrB,MAAM,CAAC,CAAC,IAAO,EAAE,QAAQ,EAA8C,UACvE,GAAG,CAAC,CAAC,IAAM,CAAC;oBACZ,GAAG,CAAC;oBACJ,KAAM,EAAE,QAAQ,EAA2B;oBAC3C,KAAM,EAAE,QAAQ,EAA4B;gBAC7C,CAAC;YAEF,IAAI,eAAe,MAAM,GAAG,GAAG,OAAO;gBAAE,SAAS;gBAAsC;YAAK;YAE5F,uCAAuC;YACvC,MAAM,YAAmC,EAAE;YAC3C,MAAM,YAAY;mBAAI;aAAe;YACrC,IAAI,UAAU;gBAAE,KAAK,cAAc,CAAC,EAAE,CAAC,GAAG;gBAAE,KAAK,cAAc,CAAC,EAAE,CAAC,GAAG;YAAC;YAEvE,MAAO,UAAU,MAAM,GAAG,EAAG;gBAC5B,IAAI,aAAa;gBACjB,IAAI,cAAc;gBAClB,UAAU,OAAO,CAAC,CAAC,KAAK;oBACvB,MAAM,OAAO,KAAK,IAAI,CAAC,KAAK,GAAG,CAAC,IAAI,GAAG,GAAG,QAAQ,GAAG,EAAE,KAAK,KAAK,GAAG,CAAC,IAAI,GAAG,GAAG,QAAQ,GAAG,EAAE;oBAC5F,MAAM,gBAAgB,IAAI,QAAQ,KAAK,SAAS,MAAM;oBACtD,IAAI,OAAO,gBAAgB,aAAa;wBACvC,cAAc,OAAO;wBACrB,aAAa;oBACd;gBACD;gBACA,MAAM,OAAO,UAAU,MAAM,CAAC,YAAY,EAAE,CAAC,EAAE;gBAC/C,UAAU,IAAI,CAAC;gBACf,UAAU;oBAAE,KAAK,KAAK,GAAG;oBAAE,KAAK,KAAK,GAAG;gBAAC;YAC1C;YAEA,OAAO;gBACN,gBAAgB,UAAU,GAAG,CAAC,CAAC,GAAG,MAAQ,CAAC;wBAC1C,OAAO,MAAM;wBACb,OAAO,EAAE,EAAE;wBACX,OAAO,EAAE,KAAK;wBACd,SAAS,GAAI,EAAE,QAAQ,EAAwC,QAAQ,EAAE,EAAG,EAAE,QAAQ,EAAwC,MAAM;oBACrI,CAAC;gBACD,UAAU,UAAU,MAAM;YAC3B;QACD,EAAE,OAAO,KAAK;YACb,OAAO;gBAAE,OAAO,eAAe,QAAQ,IAAI,OAAO,GAAG;YAA+B;QACrF;IACD;AACD;AAUO,MAAM,gBAAgB,IAAA,4RAAI,EAAC;IACjC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,YAAY,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,GAAG,QAAQ,CAAC;QACtD,cAAc,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IAC9C;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,UAAU,EAAE,YAAY,EAAE;QAClD,IAAI,CAAC,2MAAyB,CAAC,YAAY,IAAI;YAC9C,OAAO;gBACN,SAAS;gBACT,OAAO;gBACP,cAAc,2MAAyB,CAAC,eAAe;YACxD;QACD;QAEA,MAAM,UAAU,MAAM,2MAAyB,CAAC,MAAM,CAAC,OAAO;YAC7D,KAAK,KAAK,GAAG,CAAC,YAAY;YAC1B;QACD;QAEA,IAAI,CAAC,SAAS;YACb,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAmC;QACpE;QAEA,OAAO;YACN,SAAS;YACT;YACA,cAAc,QAAQ,YAAY;YAClC,YAAY,QAAQ,UAAU;YAC9B,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC,CAAC,IAAM,CAAC;oBACpC,OAAO,EAAE,KAAK;oBACd,KAAK,EAAE,IAAI;oBACX,SAAS,EAAE,OAAO;oBAClB,QAAQ,EAAE,WAAW;gBACtB,CAAC;QACF;IACD;AACD;AAMO,MAAM,oBAAoB,IAAA,4RAAI,EAAC;IACrC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,UAAU,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,GAAG,QAAQ,CAAC;QACpD,YAAY,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,GAAG,QAAQ,CAAC;IACvD;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,QAAQ,EAAE,UAAU,EAAE;QAC9C,IAAI,CAAC,2MAAyB,CAAC,YAAY,IAAI;YAC9C,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,MAAM,UAAU,MAAM,2MAAyB,CAAC,UAAU,CAAC,OAAO;YACjE,UAAU,KAAK,GAAG,CAAC,UAAU;YAC7B,KAAK,KAAK,GAAG,CAAC,YAAY;QAC3B;QAEA,IAAI,CAAC,SAAS;YACb,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAwC;QACzE;QAEA,OAAO;YACN,SAAS;YACT;YACA,YAAY;YACZ;YACA,cAAc,QAAQ,YAAY;YAClC,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC,CAAC,IAAM,CAAC;oBACpC,OAAO,EAAE,KAAK;oBACd,KAAK,EAAE,IAAI;oBACX,SAAS,EAAE,OAAO;oBAClB,QAAQ,EAAE,WAAW;gBACtB,CAAC;QACF;IACD;AACD;AAMO,MAAM,yBAAyB,IAAA,4RAAI,EAAC;IAC1C,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,YAAY,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,GAAG,QAAQ,CAAC;IACvD;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,UAAU,EAAE;QACpC,IAAI,CAAC,2MAAyB,CAAC,YAAY,IAAI;YAC9C,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,MAAM,UAAU,MAAM,2MAAyB,CAAC,eAAe,CAAC,OAAO;YACtE,KAAK,KAAK,GAAG,CAAC,YAAY;QAC3B;QAEA,IAAI,CAAC,SAAS;YACb,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAA6C;QAC9E;QAEA,OAAO;YACN,SAAS;YACT;YACA,YAAY;YACZ,cAAc,QAAQ,YAAY;YAClC,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC,CAAC,IAAM,CAAC;oBACpC,OAAO,EAAE,KAAK;oBACd,KAAK,EAAE,IAAI;oBACX,SAAS,EAAE,OAAO;oBAClB,QAAQ,EAAE,WAAW;gBACtB,CAAC;QACF;IACD;AACD;AAMO,MAAM,oBAAoB,IAAA,4RAAI,EAAC;IACrC,aAAa;IACb,YAAY,mOAAC,CAAC,MAAM,CAAC;QACpB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC3B,MAAM,mOAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;QAC1B,YAAY,mOAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,CAAC,GAAG,QAAQ,CAAC;IACvD;IACA,SAAS,OAAO,EAAE,KAAK,EAAE,IAAI,EAAE,UAAU,EAAE;QAC1C,IAAI,CAAC,2MAAyB,CAAC,YAAY,IAAI;YAC9C,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,MAAM,UAAU,MAAM,2MAAyB,CAAC,UAAU,CAAC,OAAO,MAAM;YACvE,KAAK,KAAK,GAAG,CAAC,YAAY;QAC3B;QAEA,IAAI,CAAC,SAAS;YACb,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAwC;QACzE;QAEA,OAAO;YACN,SAAS;YACT;YACA;YACA,cAAc,QAAQ,YAAY;YAClC,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC,CAAC,IAAM,CAAC;oBACpC,OAAO,EAAE,KAAK;oBACd,KAAK,EAAE,IAAI;oBACX,SAAS,EAAE,OAAO;gBACnB,CAAC;QACF;IACD;AACD;AAMO,MAAM,mBAA4D;IACxE,6DAA6D;IAC7D,WAAW;QACV,eAAe;QACf,YAAY;QACZ,WAAW;QACX,uBAAuB;QACvB,aAAa;QACb,oBAAoB;IACrB;IACA,SAAS;QACR,eAAe;QACf,YAAY;QACZ,WAAW;QACX,uBAAuB;QACvB,aAAa;QACb,oBAAoB;IACrB;IACA,cAAc;QACb,eAAe;QACf,YAAY;QACZ,WAAW;QACX,uBAAuB;QACvB,aAAa;QACb,oBAAoB;IACrB;IACA,eAAe;QACd,eAAe;QACf,YAAY;QACZ,WAAW;QACX,uBAAuB;QACvB,aAAa;QACb,oBAAoB;IACrB;IACA,aAAa;QACZ,eAAe;QACf,YAAY;QACZ,WAAW;QACX,uBAAuB;QACvB,aAAa;QACb,oBAAoB;IACrB;IACA,iBAAiB;QAChB,eAAe;QACf,YAAY;QACZ,WAAW;QACX,uBAAuB;QACvB,aAAa;QACb,oBAAoB;IACrB;IACA,eAAe;QACd,eAAe;QACf,YAAY;QACZ,WAAW;QACX,uBAAuB;QACvB,aAAa;QACb,oBAAoB;IACrB;IACA,2BAA2B;QAC1B,eAAe;QACf,YAAY;QACZ,WAAW;QACX,uBAAuB;QACvB,aAAa;QACb,oBAAoB;IACrB;IAEA,yDAAyD;IACzD,eAAe;QACd,eAAe;QACf,YAAY;QACZ,WAAW;QACX,uBAAuB;QACvB,aAAa;QACb,oBAAoB;IACrB;IACA,kBAAkB;QACjB,eAAe;QACf,YAAY;QACZ,WAAW;QACX,uBAAuB;QACvB,aAAa;QACb,oBAAoB;IACrB;IAEA,kDAAkD;IAClD,mBAAmB;QAClB,eAAe;QACf,YAAY;QACZ,WAAW;QACX,uBAAuB;QACvB,aAAa;QACb,oBAAoB;IACrB;IACA,gBAAgB;QACf,eAAe;QACf,YAAY;QACZ,WAAW;QACX,uBAAuB;QACvB,aAAa;QACb,oBAAoB;IACrB;IAEA,0BAA0B;IAC1B,gBAAgB;QACf,eAAe;QACf,YAAY;QACZ,WAAW;QACX,uBAAuB;QACvB,aAAa;QACb,oBAAoB;IACrB;AACD;AAKO,SAAS,kBAAkB,QAAgB;IACjD,OAAO,YAAY;AACpB;AAKO,SAAS,2BAA2B,QAAgB;IAC1D,OAAO,gBAAgB,CAAC,SAAS,IAAI;AACtC;AAKO,SAAS;IACf,OAAO,OAAO,IAAI,CAAC;AACpB"}},
    {"offset": {"line": 11763, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/ai/action-approval.ts"],"sourcesContent":["/**\n * AI Action Approval Service\n *\n * Handles owner-only approval workflow for destructive AI actions.\n * Ensures no destructive action can execute without explicit owner permission.\n */\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\nimport {\n\tisDestructiveTool,\n\tgetDestructiveToolMetadata,\n\ttype DestructiveToolMetadata,\n\ttype DestructiveActionType,\n\ttype RiskLevel,\n} from \"./agent-tools\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface PendingAction {\n\tid: string;\n\tcompanyId: string;\n\tchatId: string;\n\tmessageId: string;\n\tuserId: string;\n\ttoolName: string;\n\ttoolArgs: Record<string, unknown>;\n\tactionType: DestructiveActionType;\n\taffectedEntityType: string;\n\taffectedEntityIds: string[];\n\taffectedCount: number;\n\triskLevel: RiskLevel;\n\tstatus: \"pending\" | \"approved\" | \"rejected\" | \"expired\" | \"executed\" | \"failed\";\n\tapprovedBy?: string;\n\tapprovedAt?: string;\n\trejectionReason?: string;\n\texecutedAt?: string;\n\texecutionResult?: Record<string, unknown>;\n\texecutionError?: string;\n\texpiresAt: string;\n\tcreatedAt: string;\n}\n\nexport interface CreatePendingActionInput {\n\tcompanyId: string;\n\tchatId: string;\n\tmessageId: string;\n\tuserId: string;\n\ttoolName: string;\n\ttoolArgs: Record<string, unknown>;\n\taffectedEntityIds?: string[];\n}\n\nexport interface ApprovalResult {\n\tsuccess: boolean;\n\terror?: string;\n\tactionId?: string;\n\ttoolName?: string;\n\ttoolArgs?: Record<string, unknown>;\n}\n\n// ============================================================================\n// Owner Verification\n// ============================================================================\n\n/**\n * Check if a user is the owner of a company\n * Uses the database function for consistency with RLS\n */\nexport async function isCompanyOwner(\n\tcompanyId: string,\n\tuserId: string\n): Promise<boolean> {\n\tconst supabase = createServiceSupabaseClient();\n\n\tconst { data, error } = await supabase.rpc(\"is_company_owner\", {\n\t\tp_company_id: companyId,\n\t\tp_user_id: userId,\n\t});\n\n\tif (error) {\n\t\tconsole.error(\"Error checking owner status:\", error);\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Get the owner(s) of a company\n */\nexport async function getCompanyOwners(companyId: string): Promise<Array<{\n\tuserId: string;\n\temail: string;\n\tfirstName: string;\n\tlastName: string;\n}>> {\n\tconst supabase = createServiceSupabaseClient();\n\n\tconst { data, error } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(`\n\t\t\tuser_id,\n\t\t\tusers!company_memberships_users_id_fkey (\n\t\t\t\temail,\n\t\t\t\tname\n\t\t\t)\n\t\t`)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"role\", \"owner\");\n\n\tif (error) {\n\t\tconsole.error(\"Error fetching company owners:\", error);\n\t\treturn [];\n\t}\n\n\treturn (data || []).map((row) => {\n\t\tconst user = row.users as { email: string; name: string } | null;\n\t\tconst nameParts = (user?.name || \"\").split(\" \");\n\t\treturn {\n\t\t\tuserId: row.user_id,\n\t\t\temail: user?.email || \"\",\n\t\t\tfirstName: nameParts[0] || \"\",\n\t\t\tlastName: nameParts.slice(1).join(\" \") || \"\",\n\t\t};\n\t});\n}\n\n// ============================================================================\n// Pending Action Management\n// ============================================================================\n\n/**\n * Create a pending action that requires owner approval\n * Returns the pending action ID for tracking\n */\nexport async function createPendingAction(\n\tinput: CreatePendingActionInput\n): Promise<{ success: boolean; pendingActionId?: string; error?: string }> {\n\tconst supabase = createServiceSupabaseClient();\n\n\t// Get metadata about this destructive tool\n\tconst metadata = getDestructiveToolMetadata(input.toolName);\n\tif (!metadata) {\n\t\treturn { success: false, error: `Tool '${input.toolName}' is not registered as destructive` };\n\t}\n\n\t// Calculate expiration (24 hours from now)\n\tconst expiresAt = new Date();\n\texpiresAt.setHours(expiresAt.getHours() + 24);\n\n\t// Create the pending action record\n\tconst { data, error } = await supabase\n\t\t.from(\"ai_pending_actions\")\n\t\t.insert({\n\t\t\tcompany_id: input.companyId,\n\t\t\tchat_id: input.chatId,\n\t\t\tmessage_id: input.messageId,\n\t\t\tuser_id: input.userId,\n\t\t\ttool_name: input.toolName,\n\t\t\ttool_args: input.toolArgs,\n\t\t\taction_type: metadata.actionType,\n\t\t\taction_title: `AI wants to: ${metadata.description}`,\n\t\t\taction_summary: generateActionSummary(input.toolName, input.toolArgs, metadata),\n\t\t\taction_details: {\n\t\t\t\ttoolName: input.toolName,\n\t\t\t\ttoolArgs: input.toolArgs,\n\t\t\t\tmetadata,\n\t\t\t},\n\t\t\taffected_entity_type: metadata.affectedEntityType,\n\t\t\taffected_entity_ids: input.affectedEntityIds || [],\n\t\t\taffected_count: input.affectedEntityIds?.length || 1,\n\t\t\trisk_level: metadata.riskLevel,\n\t\t\tstatus: \"pending\",\n\t\t\turgency: metadata.riskLevel === \"critical\" ? \"high\" : metadata.riskLevel === \"high\" ? \"medium\" : \"low\",\n\t\t\texpires_at: expiresAt.toISOString(),\n\t\t\t// Required by existing schema\n\t\t\taction_log_id: crypto.randomUUID(),\n\t\t})\n\t\t.select(\"id\")\n\t\t.single();\n\n\tif (error) {\n\t\tconsole.error(\"Error creating pending action:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true, pendingActionId: data.id };\n}\n\n/**\n * Generate a human-readable summary of the action\n */\nfunction generateActionSummary(\n\ttoolName: string,\n\ttoolArgs: Record<string, unknown>,\n\tmetadata: DestructiveToolMetadata\n): string {\n\tconst parts: string[] = [metadata.description];\n\n\t// Add relevant details from toolArgs\n\tif (toolArgs.to || toolArgs.recipient) {\n\t\tparts.push(`Recipient: ${toolArgs.to || toolArgs.recipient}`);\n\t}\n\tif (toolArgs.subject) {\n\t\tparts.push(`Subject: \"${toolArgs.subject}\"`);\n\t}\n\tif (toolArgs.customerId) {\n\t\tparts.push(`Customer ID: ${toolArgs.customerId}`);\n\t}\n\tif (toolArgs.amount) {\n\t\tparts.push(`Amount: $${(toolArgs.amount as number) / 100}`);\n\t}\n\n\treturn parts.join(\" | \");\n}\n\n/**\n * Get all pending actions for a chat session\n */\nexport async function getPendingActionsForChat(\n\tcompanyId: string,\n\tchatId: string\n): Promise<PendingAction[]> {\n\tconst supabase = createServiceSupabaseClient();\n\n\tconst { data, error } = await supabase\n\t\t.from(\"ai_pending_actions\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"chat_id\", chatId)\n\t\t.eq(\"status\", \"pending\")\n\t\t.order(\"created_at\", { ascending: false });\n\n\tif (error) {\n\t\tconsole.error(\"Error fetching pending actions:\", error);\n\t\treturn [];\n\t}\n\n\treturn (data || []).map(mapDbToPendingAction);\n}\n\n/**\n * Get all pending actions for a company (for owner dashboard)\n */\nexport async function getPendingActionsForCompany(\n\tcompanyId: string,\n\toptions?: {\n\t\tstatus?: \"pending\" | \"approved\" | \"rejected\" | \"expired\";\n\t\tlimit?: number;\n\t}\n): Promise<PendingAction[]> {\n\tconst supabase = createServiceSupabaseClient();\n\n\tlet query = supabase\n\t\t.from(\"ai_pending_actions\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.order(\"created_at\", { ascending: false });\n\n\tif (options?.status) {\n\t\tquery = query.eq(\"status\", options.status);\n\t}\n\n\tif (options?.limit) {\n\t\tquery = query.limit(options.limit);\n\t}\n\n\tconst { data, error } = await query;\n\n\tif (error) {\n\t\tconsole.error(\"Error fetching pending actions:\", error);\n\t\treturn [];\n\t}\n\n\treturn (data || []).map(mapDbToPendingAction);\n}\n\n/**\n * Get a specific pending action by ID\n */\nexport async function getPendingAction(\n\tcompanyId: string,\n\tactionId: string\n): Promise<PendingAction | null> {\n\tconst supabase = createServiceSupabaseClient();\n\n\tconst { data, error } = await supabase\n\t\t.from(\"ai_pending_actions\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"id\", actionId)\n\t\t.single();\n\n\tif (error) {\n\t\tconsole.error(\"Error fetching pending action:\", error);\n\t\treturn null;\n\t}\n\n\treturn mapDbToPendingAction(data);\n}\n\n// ============================================================================\n// Approval/Rejection (Owner-Only)\n// ============================================================================\n\n/**\n * Approve a pending action - OWNER ONLY\n * Uses the database function which enforces owner check\n */\nexport async function approveAction(\n\tactionId: string,\n\tapproverId: string\n): Promise<ApprovalResult> {\n\tconst supabase = createServiceSupabaseClient();\n\n\tconst { data, error } = await supabase.rpc(\"approve_pending_action\", {\n\t\tp_action_id: actionId,\n\t\tp_approver_id: approverId,\n\t});\n\n\tif (error) {\n\t\tconsole.error(\"Error approving action:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\tconst result = data as ApprovalResult;\n\treturn result;\n}\n\n/**\n * Reject a pending action - OWNER ONLY\n * Uses the database function which enforces owner check\n */\nexport async function rejectAction(\n\tactionId: string,\n\trejectorId: string,\n\treason?: string\n): Promise<ApprovalResult> {\n\tconst supabase = createServiceSupabaseClient();\n\n\tconst { data, error } = await supabase.rpc(\"reject_pending_action\", {\n\t\tp_action_id: actionId,\n\t\tp_rejector_id: rejectorId,\n\t\tp_reason: reason || null,\n\t});\n\n\tif (error) {\n\t\tconsole.error(\"Error rejecting action:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\tconst result = data as ApprovalResult;\n\treturn result;\n}\n\n// ============================================================================\n// Execution After Approval\n// ============================================================================\n\n/**\n * Mark an approved action as executed\n */\nexport async function markActionExecuted(\n\tcompanyId: string,\n\tactionId: string,\n\tresult: Record<string, unknown>\n): Promise<boolean> {\n\tconst supabase = createServiceSupabaseClient();\n\n\tconst { error } = await supabase\n\t\t.from(\"ai_pending_actions\")\n\t\t.update({\n\t\t\tstatus: \"executed\",\n\t\t\texecuted_at: new Date().toISOString(),\n\t\t\texecution_result: result,\n\t\t\tupdated_at: new Date().toISOString(),\n\t\t})\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"id\", actionId)\n\t\t.eq(\"status\", \"approved\"); // Can only execute approved actions\n\n\tif (error) {\n\t\tconsole.error(\"Error marking action as executed:\", error);\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\n/**\n * Mark an approved action as failed\n */\nexport async function markActionFailed(\n\tcompanyId: string,\n\tactionId: string,\n\terrorMessage: string\n): Promise<boolean> {\n\tconst supabase = createServiceSupabaseClient();\n\n\tconst { error } = await supabase\n\t\t.from(\"ai_pending_actions\")\n\t\t.update({\n\t\t\tstatus: \"failed\",\n\t\t\texecution_error: errorMessage,\n\t\t\tupdated_at: new Date().toISOString(),\n\t\t})\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"id\", actionId)\n\t\t.eq(\"status\", \"approved\");\n\n\tif (error) {\n\t\tconsole.error(\"Error marking action as failed:\", error);\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\n// ============================================================================\n// Expiration Handling\n// ============================================================================\n\n/**\n * Expire old pending actions (called by cron or on access)\n */\nexport async function expireOldActions(companyId: string): Promise<number> {\n\tconst supabase = createServiceSupabaseClient();\n\n\tconst { data, error } = await supabase\n\t\t.from(\"ai_pending_actions\")\n\t\t.update({\n\t\t\tstatus: \"expired\",\n\t\t\tupdated_at: new Date().toISOString(),\n\t\t})\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"pending\")\n\t\t.lt(\"expires_at\", new Date().toISOString())\n\t\t.select(\"id\");\n\n\tif (error) {\n\t\tconsole.error(\"Error expiring old actions:\", error);\n\t\treturn 0;\n\t}\n\n\treturn data?.length || 0;\n}\n\n// ============================================================================\n// Tool Interception Helper\n// ============================================================================\n\n/**\n * Check if a tool call should be intercepted for owner approval\n * Returns the pending action details if interception is needed\n */\nexport async function shouldInterceptTool(\n\ttoolName: string,\n\ttoolArgs: Record<string, unknown>,\n\tcontext: {\n\t\tcompanyId: string;\n\t\tchatId: string;\n\t\tmessageId: string;\n\t\tuserId: string;\n\t}\n): Promise<{\n\tintercept: boolean;\n\tpendingActionId?: string;\n\tmetadata?: DestructiveToolMetadata;\n\terror?: string;\n}> {\n\t// Check if tool is destructive\n\tif (!isDestructiveTool(toolName)) {\n\t\treturn { intercept: false };\n\t}\n\n\tconst metadata = getDestructiveToolMetadata(toolName);\n\tif (!metadata || !metadata.requiresOwnerApproval) {\n\t\treturn { intercept: false };\n\t}\n\n\t// Check if user is already an owner (owners can self-approve in UI)\n\tconst isOwner = await isCompanyOwner(context.companyId, context.userId);\n\n\t// Even owners need to see the dialog and explicitly approve\n\t// This ensures conscious decision-making for destructive actions\n\n\t// Create pending action\n\tconst result = await createPendingAction({\n\t\tcompanyId: context.companyId,\n\t\tchatId: context.chatId,\n\t\tmessageId: context.messageId,\n\t\tuserId: context.userId,\n\t\ttoolName,\n\t\ttoolArgs,\n\t});\n\n\tif (!result.success) {\n\t\treturn { intercept: true, error: result.error, metadata };\n\t}\n\n\treturn {\n\t\tintercept: true,\n\t\tpendingActionId: result.pendingActionId,\n\t\tmetadata,\n\t};\n}\n\n// ============================================================================\n// Helpers\n// ============================================================================\n\nfunction mapDbToPendingAction(row: Record<string, unknown>): PendingAction {\n\treturn {\n\t\tid: row.id as string,\n\t\tcompanyId: row.company_id as string,\n\t\tchatId: row.chat_id as string,\n\t\tmessageId: row.message_id as string,\n\t\tuserId: row.user_id as string,\n\t\ttoolName: row.tool_name as string,\n\t\ttoolArgs: (row.tool_args as Record<string, unknown>) || {},\n\t\tactionType: row.action_type as DestructiveActionType,\n\t\taffectedEntityType: row.affected_entity_type as string,\n\t\taffectedEntityIds: (row.affected_entity_ids as string[]) || [],\n\t\taffectedCount: (row.affected_count as number) || 1,\n\t\triskLevel: (row.risk_level as RiskLevel) || \"medium\",\n\t\tstatus: row.status as PendingAction[\"status\"],\n\t\tapprovedBy: row.approved_by as string | undefined,\n\t\tapprovedAt: row.approved_at as string | undefined,\n\t\trejectionReason: row.rejection_reason as string | undefined,\n\t\texecutedAt: row.executed_at as string | undefined,\n\t\texecutionResult: row.execution_result as Record<string, unknown> | undefined,\n\t\texecutionError: row.execution_error as string | undefined,\n\t\texpiresAt: row.expires_at as string,\n\t\tcreatedAt: row.created_at as string,\n\t};\n}\n\n// ============================================================================\n// Exports for use in AI chat route and UI\n// ============================================================================\n\nexport {\n\tisDestructiveTool,\n\tgetDestructiveToolMetadata,\n\ttype DestructiveToolMetadata,\n\ttype DestructiveActionType,\n\ttype RiskLevel,\n} from \"./agent-tools\";\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 12088, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/services/geocoding.ts"],"sourcesContent":["/**\n * Google Geocoding API Utility\n *\n * Automatically acquires GPS coordinates (lat/lon) from addresses\n * Used during customer creation, property creation, and company onboarding\n */\n\ntype GeocodeResult = {\n\tlat: number;\n\tlon: number;\n\tformattedAddress?: string;\n};\n\ntype GeocodeResponse = {\n\tsuccess: boolean;\n\tcoordinates?: GeocodeResult;\n\terror?: string;\n};\n\n/**\n * Geocode an address to get GPS coordinates\n *\n * @param address - Street address\n * @param city - City\n * @param state - State\n * @param zipCode - ZIP code\n * @param country - Country (defaults to \"USA\")\n * @returns Coordinates {lat, lon} or null if geocoding fails\n */\nasync function geocodeAddress(\n\taddress: string,\n\tcity: string,\n\tstate: string,\n\tzipCode: string,\n\tcountry = \"USA\",\n): Promise<GeocodeResponse> {\n\ttry {\n\t\t// Build full address string\n\t\tconst fullAddress = `${address}, ${city}, ${state} ${zipCode}, ${country}`;\n\n\t\t// Get API key from environment\n\t\tconst apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY;\n\n\t\tif (!apiKey) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Geocoding API key not configured\",\n\t\t\t};\n\t\t}\n\n\t\t// Call Google Geocoding API\n\t\tconst encodedAddress = encodeURIComponent(fullAddress);\n\t\tconst url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodedAddress}&key=${apiKey}`;\n\n\t\tconst response = await fetch(url);\n\n\t\tif (!response.ok) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Geocoding failed with status ${response.status}`,\n\t\t\t};\n\t\t}\n\n\t\tconst data = await response.json();\n\n\t\t// Check if we got results\n\t\tif (data.status === \"OK\" && data.results && data.results.length > 0) {\n\t\t\tconst location = data.results[0].geometry.location;\n\t\t\tconst formattedAddress = data.results[0].formatted_address;\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tcoordinates: {\n\t\t\t\t\tlat: location.lat,\n\t\t\t\t\tlon: location.lng,\n\t\t\t\t\tformattedAddress,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\t\tif (data.status === \"ZERO_RESULTS\") {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Address not found\",\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: data.error_message || `Geocoding failed: ${data.status}`,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown geocoding error\",\n\t\t};\n\t}\n}\n\n/**\n * Geocode an address silently in the background\n * Does not throw errors - returns null on failure\n *\n * Useful for non-critical geocoding where we don't want to block\n * the main operation if geocoding fails\n */\nexport async function geocodeAddressSilent(\n\taddress: string,\n\tcity: string,\n\tstate: string,\n\tzipCode: string,\n\tcountry = \"USA\",\n): Promise<GeocodeResult | null> {\n\ttry {\n\t\tconst result = await geocodeAddress(address, city, state, zipCode, country);\n\t\treturn result.success && result.coordinates ? result.coordinates : null;\n\t} catch (_error) {\n\t\treturn null;\n\t}\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAcD;;;;;;;;;CASC,GACD,eAAe,eACd,OAAe,EACf,IAAY,EACZ,KAAa,EACb,OAAe,EACf,UAAU,KAAK;IAEf,IAAI;QACH,4BAA4B;QAC5B,MAAM,cAAc,GAAG,QAAQ,EAAE,EAAE,KAAK,EAAE,EAAE,MAAM,CAAC,EAAE,QAAQ,EAAE,EAAE,SAAS;QAE1E,+BAA+B;QAC/B,MAAM;QAEN;;QAOA,4BAA4B;QAC5B,MAAM,iBAAiB,mBAAmB;QAC1C,MAAM,MAAM,CAAC,0DAA0D,EAAE,eAAe,KAAK,EAAE,QAAQ;QAEvG,MAAM,WAAW,MAAM,MAAM;QAE7B,IAAI,CAAC,SAAS,EAAE,EAAE;YACjB,OAAO;gBACN,SAAS;gBACT,OAAO,CAAC,6BAA6B,EAAE,SAAS,MAAM,EAAE;YACzD;QACD;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAEhC,0BAA0B;QAC1B,IAAI,KAAK,MAAM,KAAK,QAAQ,KAAK,OAAO,IAAI,KAAK,OAAO,CAAC,MAAM,GAAG,GAAG;YACpE,MAAM,WAAW,KAAK,OAAO,CAAC,EAAE,CAAC,QAAQ,CAAC,QAAQ;YAClD,MAAM,mBAAmB,KAAK,OAAO,CAAC,EAAE,CAAC,iBAAiB;YAE1D,OAAO;gBACN,SAAS;gBACT,aAAa;oBACZ,KAAK,SAAS,GAAG;oBACjB,KAAK,SAAS,GAAG;oBACjB;gBACD;YACD;QACD;QACA,IAAI,KAAK,MAAM,KAAK,gBAAgB;YACnC,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QACA,OAAO;YACN,SAAS;YACT,OAAO,KAAK,aAAa,IAAI,CAAC,kBAAkB,EAAE,KAAK,MAAM,EAAE;QAChE;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACjD;IACD;AACD;AASO,eAAe,qBACrB,OAAe,EACf,IAAY,EACZ,KAAa,EACb,OAAe,EACf,UAAU,KAAK;IAEf,IAAI;QACH,MAAM,SAAS,MAAM,eAAe,SAAS,MAAM,OAAO,SAAS;QACnE,OAAO,OAAO,OAAO,IAAI,OAAO,WAAW,GAAG,OAAO,WAAW,GAAG;IACpE,EAAE,OAAO,QAAQ;QAChB,OAAO;IACR;AACD"}},
    {"offset": {"line": 12167, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/communication/sms-service.ts"],"sourcesContent":["/**\n * SMS Service\n * \n * Handles fetching and managing SMS messages from the communications table\n * Similar structure to email-service.ts but for SMS type communications\n */\n\nimport { createClient } from \"@/lib/supabase/server\";\nimport type { TypedSupabaseClient } from \"@/types/supabase\";\n\nexport type CompanySms = {\n\tid: string;\n\tfrom_address: string | null;\n\tfrom_name: string | null;\n\tto_address: string | null;\n\tbody: string;\n\tbody_html: string | null;\n\tcreated_at: string;\n\tread_at: string | null;\n\tdirection: \"inbound\" | \"outbound\";\n\tcustomer_id: string | null;\n\tcustomer?: {\n\t\tid: string;\n\t\tfirst_name: string | null;\n\t\tlast_name: string | null;\n\t\tdisplay_name: string | null;\n\t\temail: string | null;\n\t\tphone: string | null;\n\t\tcompany_name: string | null;\n\t} | null;\n\tsent_at: string | null;\n\tdelivered_at: string | null;\n\tstatus: string;\n\tchannel: string | null;\n\tprovider_metadata: Record<string, unknown> | null;\n\tis_archived: boolean;\n\tsnoozed_until: string | null;\n\tcategory: string | null;\n\ttags: string[] | null;\n\ttelnyx_message_id: string | null;\n};\n\nexport type GetCompanySmsInput = {\n\tlimit?: number;\n\toffset?: number;\n\ttype?: \"sent\" | \"received\" | \"all\";\n\tfolder?: \"inbox\" | \"sent\" | \"archive\" | \"trash\" | \"bin\";\n\tlabel?: string;\n\tsearch?: string | null;\n\tsortBy?: \"created_at\" | \"sent_at\";\n\tsortOrder?: \"asc\" | \"desc\";\n};\n\nexport type GetCompanySmsResult = {\n\tsms: CompanySms[];\n\ttotal: number;\n\thasMore: boolean;\n};\n\nexport async function getCompanySms(\n\tcompanyId: string,\n\tinput: GetCompanySmsInput = {},\n): Promise<GetCompanySmsResult> {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn { sms: [], total: 0, hasMore: false };\n\t}\n\n\tconst {\n\t\tlimit = 50,\n\t\toffset = 0,\n\t\ttype = \"all\",\n\t\tfolder,\n\t\tlabel,\n\t\tsearch,\n\t\tsortBy = \"created_at\",\n\t\tsortOrder = \"desc\",\n\t} = input;\n\n\t// Build the query - get all SMS messages\n\tlet query = supabase\n\t\t.from(\"communications\")\n\t\t.select(\n\t\t\t`\n\t\t\tid,\n\t\t\tfrom_address,\n\t\t\tfrom_name,\n\t\t\tto_address,\n\t\t\tbody,\n\t\t\tbody_html,\n\t\t\tcreated_at,\n\t\t\tread_at,\n\t\t\tdirection,\n\t\t\tcustomer_id,\n\t\t\tcustomer:customers!left(id, first_name, last_name, display_name, email, phone, company_name),\n\t\t\tsent_at,\n\t\t\tdelivered_at,\n\t\t\tstatus,\n\t\t\tchannel,\n\t\t\tprovider_metadata,\n\t\t\tis_archived,\n\t\t\tsnoozed_until,\n\t\t\tcategory,\n\t\t\ttags,\n\t\t\ttelnyx_message_id\n\t\t`,\n\t\t\t{ count: \"exact\" },\n\t\t)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"type\", \"sms\");\n\n\t// Apply folder filtering\n\tif (folder) {\n\t\tswitch (folder) {\n\t\t\tcase \"inbox\":\n\t\t\t\t// Inbox: inbound, not archived, not deleted, not snoozed (or snooze expired)\n\t\t\t\tquery = query\n\t\t\t\t\t.eq(\"direction\", \"inbound\")\n\t\t\t\t\t.eq(\"is_archived\", false)\n\t\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t\t.or(\"snoozed_until.is.null,snoozed_until.lt.now()\");\n\t\t\t\tbreak;\n\t\t\tcase \"sent\":\n\t\t\t\t// Sent: outbound, not archived, not deleted\n\t\t\t\tquery = query\n\t\t\t\t\t.eq(\"direction\", \"outbound\")\n\t\t\t\t\t.eq(\"is_archived\", false)\n\t\t\t\t\t.is(\"deleted_at\", null);\n\t\t\t\tbreak;\n\t\t\tcase \"archive\":\n\t\t\t\t// Archive: is_archived = true, not deleted\n\t\t\t\tquery = query.eq(\"is_archived\", true).is(\"deleted_at\", null);\n\t\t\t\tbreak;\n\t\t\tcase \"trash\":\n\t\t\tcase \"bin\":\n\t\t\t\t// Trash: deleted_at is not null\n\t\t\t\tquery = query.not(\"deleted_at\", \"is\", null);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\t// Custom folder or label filtering - done in memory after fetch\n\t\t\t\t// (JSONB array containment not supported by PostgREST cs operator)\n\t\t\t\tquery = query.is(\"deleted_at\", null);\n\t\t\t\tbreak;\n\t\t}\n\t} else {\n\t\t// Default: exclude deleted SMS\n\t\tquery = query.is(\"deleted_at\", null);\n\t}\n\n\t// Apply direction filter\n\tif (type === \"sent\") {\n\t\tquery = query.eq(\"direction\", \"outbound\");\n\t} else if (type === \"received\") {\n\t\tquery = query.eq(\"direction\", \"inbound\");\n\t}\n\n\t// Apply search filter\n\tif (search) {\n\t\tconst searchLower = search.toLowerCase();\n\t\tquery = query.or(\n\t\t\t`from_address.ilike.%${searchLower}%,to_address.ilike.%${searchLower}%,body.ilike.%${searchLower}%`,\n\t\t);\n\t}\n\n\t// Apply sorting\n\tconst ascending = sortOrder === \"asc\";\n\tif (sortBy === \"sent_at\") {\n\t\tquery = query.order(\"sent_at\", { ascending, nullsFirst: false });\n\t} else {\n\t\tquery = query.order(\"created_at\", { ascending });\n\t}\n\n\t// Apply pagination\n\tquery = query.range(offset, offset + limit - 1);\n\n\tconst { data, error, count } = await query;\n\n\tif (error) {\n\t\tconsole.error(\"Error fetching SMS messages:\", error);\n\t\treturn { sms: [], total: 0, hasMore: false };\n\t}\n\n\tlet sms = (data || []).map((msg) => ({\n\t\t...msg,\n\t\ttags: (msg.tags as string[]) || null,\n\t\tprovider_metadata: (msg.provider_metadata as Record<string, unknown>) || null,\n\t})) as CompanySms[];\n\n\t// Post-process custom folder/label filtering (JSONB array containment not supported by PostgREST)\n\tconst standardFolders = [\"inbox\", \"sent\", \"archive\", \"trash\", \"bin\"];\n\tconst folderName = label || folder;\n\tif (folderName && !standardFolders.includes(folderName)) {\n\t\tsms = sms.filter((msg) => {\n\t\t\tconst msgTags = msg.tags || [];\n\t\t\treturn Array.isArray(msgTags) && msgTags.includes(folderName);\n\t\t});\n\t\treturn {\n\t\t\tsms,\n\t\t\ttotal: sms.length,\n\t\t\thasMore: false,\n\t\t};\n\t}\n\n\tconst total = count || 0;\n\tconst hasMore = offset + sms.length < total;\n\n\treturn {\n\t\tsms,\n\t\ttotal,\n\t\thasMore,\n\t};\n}\n\nexport async function getSmsById(\n\tcompanyId: string,\n\tsmsId: string,\n): Promise<CompanySms | null> {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn null;\n\t}\n\n\tconst { data, error } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\n\t\t\t`\n\t\t\tid,\n\t\t\tfrom_address,\n\t\t\tfrom_name,\n\t\t\tto_address,\n\t\t\tbody,\n\t\t\tbody_html,\n\t\t\tcreated_at,\n\t\t\tread_at,\n\t\t\tdirection,\n\t\t\tcustomer_id,\n\t\t\tcustomer:customers!left(id, first_name, last_name, display_name, email, phone, company_name),\n\t\t\tsent_at,\n\t\t\tdelivered_at,\n\t\t\tstatus,\n\t\t\tchannel,\n\t\t\tprovider_metadata,\n\t\t\tis_archived,\n\t\t\tsnoozed_until,\n\t\t\tcategory,\n\t\t\ttags,\n\t\t\ttelnyx_message_id\n\t\t`,\n\t\t)\n\t\t.eq(\"id\", smsId)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"type\", \"sms\")\n\t\t.single();\n\n\tif (error || !data) {\n\t\treturn null;\n\t}\n\n\treturn {\n\t\t...data,\n\t\ttags: (data.tags as string[]) || null,\n\t\tprovider_metadata: (data.provider_metadata as Record<string, unknown>) || null,\n\t} as CompanySms;\n}\n\nexport async function markSmsAsRead(\n\tcompanyId: string,\n\tsmsId: string,\n): Promise<boolean> {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\tconsole.error(\" markSmsAsRead: Missing supabase\");\n\t\treturn false;\n\t}\n\n\tconst readAt = new Date().toISOString();\n\tconst { data, error } = await supabase\n\t\t.from(\"communications\")\n\t\t.update({ read_at: readAt })\n\t\t.eq(\"id\", smsId)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"type\", \"sms\")\n\t\t.select(\"id, read_at\")\n\t\t.single();\n\n\tif (error) {\n\t\tconsole.error(\" markSmsAsRead error:\", error);\n\t\treturn false;\n\t}\n\n\tif (!data) {\n\t\tconsole.error(\" markSmsAsRead: No data returned\");\n\t\treturn false;\n\t}\n\n\tconsole.log(\" markSmsAsRead success:\", { smsId, read_at: data.read_at });\n\treturn true;\n}\n\n/**\n * Get all SMS messages for a conversation thread (by phone number)\n */\nexport async function getSmsConversation(\n\tcompanyId: string,\n\tphoneNumber: string,\n): Promise<CompanySms[]> {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn [];\n\t}\n\n\t// Normalize phone number for matching\n\tconst normalizePhone = (phone: string) => {\n\t\tconst digits = phone.replace(/[^0-9]/g, \"\");\n\t\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\t\treturn `+${digits}`;\n\t\t}\n\t\tif (digits.length === 10) {\n\t\t\treturn `+1${digits}`;\n\t\t}\n\t\treturn phone.startsWith(\"+\") ? phone : `+${phone}`;\n\t};\n\n\tconst normalizedPhone = normalizePhone(phoneNumber);\n\n\t// Fetch all messages where this phone number is either from or to\n\tconst { data, error } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\n\t\t\t`\n\t\t\tid,\n\t\t\tfrom_address,\n\t\t\tfrom_name,\n\t\t\tto_address,\n\t\t\tbody,\n\t\t\tbody_html,\n\t\t\tcreated_at,\n\t\t\tread_at,\n\t\t\tdirection,\n\t\t\tcustomer_id,\n\t\t\tcustomer:customers!left(id, first_name, last_name, display_name, email, phone, company_name),\n\t\t\tsent_at,\n\t\t\tdelivered_at,\n\t\t\tstatus,\n\t\t\tchannel,\n\t\t\tprovider_metadata,\n\t\t\tis_archived,\n\t\t\tsnoozed_until,\n\t\t\tcategory,\n\t\t\ttags,\n\t\t\ttelnyx_message_id\n\t\t`,\n\t\t)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"type\", \"sms\")\n\t\t.is(\"deleted_at\", null)\n\t\t.or(`from_address.eq.${normalizedPhone},to_address.eq.${normalizedPhone}`)\n\t\t.order(\"created_at\", { ascending: true });\n\n\tif (error) {\n\t\tconsole.error(\"Error fetching SMS conversation:\", error);\n\t\treturn [];\n\t}\n\n\treturn (data || []).map((msg) => ({\n\t\t...msg,\n\t\ttags: (msg.tags as string[]) || null,\n\t\tprovider_metadata: (msg.provider_metadata as Record<string, unknown>) || null,\n\t})) as CompanySms[];\n}\n\n/**\n * Mark all unread messages in an SMS conversation as read\n */\nexport async function markSmsConversationAsRead(\n\tcompanyId: string,\n\tphoneNumber: string,\n): Promise<boolean> {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn false;\n\t}\n\n\t// Normalize phone number for matching\n\tconst normalizePhone = (phone: string) => {\n\t\tconst digits = phone.replace(/[^0-9]/g, \"\");\n\t\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\t\treturn `+${digits}`;\n\t\t}\n\t\tif (digits.length === 10) {\n\t\t\treturn `+1${digits}`;\n\t\t}\n\t\treturn phone.startsWith(\"+\") ? phone : `+${phone}`;\n\t};\n\n\tconst normalizedPhone = normalizePhone(phoneNumber);\n\n\t// Mark all unread inbound messages in this conversation as read\n\tconst readAt = new Date().toISOString();\n\tconst { data, error } = await supabase\n\t\t.from(\"communications\")\n\t\t.update({ read_at: readAt })\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"type\", \"sms\")\n\t\t.eq(\"direction\", \"inbound\")\n\t\t.is(\"read_at\", null)\n\t\t.is(\"deleted_at\", null)\n\t\t.or(`from_address.eq.${normalizedPhone},to_address.eq.${normalizedPhone}`)\n\t\t.select(\"id, read_at\");\n\n\tif (error) {\n\t\tconsole.error(\" markSmsConversationAsRead error:\", error);\n\t\treturn false;\n\t}\n\n\tconsole.log(` markSmsConversationAsRead success: Marked ${data?.length || 0} messages as read`);\n\treturn true;\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 12466, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/validations/database-schemas.ts"],"sourcesContent":["/**\n * Zod Validation Schemas for Database Tables\n *\n * Provides type-safe validation for all database operations.\n * Use these schemas to validate user input before database operations.\n *\n * Usage:\n * ```typescript\n * import { customerInsertSchema } from \"@/lib/validations/database-schemas\";\n *\n * const result = customerInsertSchema.safeParse(formData);\n * if (!result.success) {\n *   console.error(result.error);\n * }\n * ```\n */\n\nimport { z } from \"zod\";\n\n// ============================================================================\n// CUSTOMERS\n// ============================================================================\n\nconst customerInsertSchema = z.object({\n\tcompany_id: z.string().uuid(),\n\tuser_id: z.string().uuid().optional().nullable(),\n\ttype: z\n\t\t.enum([\"residential\", \"commercial\", \"industrial\"])\n\t\t.default(\"residential\"),\n\tfirst_name: z.string().min(1, \"First name is required\").max(100),\n\tlast_name: z.string().min(1, \"Last name is required\").max(100),\n\tcompany_name: z.string().max(200).optional().nullable(),\n\temail: z.string().email(\"Invalid email address\").optional().nullable(),\n\tphone: z.string().max(20).optional().nullable(),\n\talternate_phone: z.string().max(20).optional().nullable(),\n\taddress: z.string().max(500).optional().nullable(),\n\tcity: z.string().max(100).optional().nullable(),\n\tstate: z.string().max(2).optional().nullable(),\n\tzip: z.string().max(10).optional().nullable(),\n\tlatitude: z.number().optional().nullable(),\n\tlongitude: z.number().optional().nullable(),\n\tstatus: z.enum([\"active\", \"inactive\", \"blocked\"]).default(\"active\"),\n\tsource: z.string().max(100).optional().nullable(),\n\treferred_by: z.string().uuid().optional().nullable(),\n\tnotes: z.string().optional().nullable(),\n\ttags: z.array(z.string()).optional().nullable(),\n\ttotal_revenue: z.number().int().default(0),\n\ttotal_jobs: z.number().int().default(0),\n\toutstanding_balance: z.number().int().default(0),\n\tlifetime_value: z.number().int().default(0),\n\taverage_job_value: z.number().int().default(0),\n\tlast_job_date: z.date().optional().nullable(),\n\tnext_service_due: z.date().optional().nullable(),\n\tportal_enabled: z.boolean().default(false),\n\tportal_invited_at: z.date().optional().nullable(),\n\tportal_last_login: z.date().optional().nullable(),\n\tbilling_same_as_service: z.boolean().default(true),\n\tbilling_address: z.string().max(500).optional().nullable(),\n\tbilling_city: z.string().max(100).optional().nullable(),\n\tbilling_state: z.string().max(2).optional().nullable(),\n\tbilling_zip: z.string().max(10).optional().nullable(),\n\ttax_exempt: z.boolean().default(false),\n\ttax_id: z.string().max(50).optional().nullable(),\n\tpreferred_contact_method: z\n\t\t.enum([\"email\", \"phone\", \"sms\", \"any\"])\n\t\t.optional()\n\t\t.nullable(),\n\tdo_not_disturb: z.boolean().default(false),\n\tmarketing_opt_in: z.boolean().default(true),\n});\n\nconst customerUpdateSchema = customerInsertSchema\n\t.partial()\n\t.omit({ company_id: true });\n\nconst customerSelectSchema = customerInsertSchema.extend({\n\tid: z.string().uuid(),\n\tcreated_at: z.date(),\n\tupdated_at: z.date(),\n\tdeleted_at: z.date().nullable(),\n\tdeleted_by: z.string().uuid().nullable(),\n});\n\n// ============================================================================\n// COMMUNICATIONS\n// ============================================================================\n\nconst communicationInsertSchema = z.object({\n\tcompany_id: z.string().uuid(),\n\tcustomer_id: z.string().uuid().optional().nullable(),\n\tjob_id: z.string().uuid().optional().nullable(),\n\tinvoice_id: z.string().uuid().optional().nullable(),\n\tuser_id: z.string().uuid().optional().nullable(),\n\ttype: z.enum([\"email\", \"sms\", \"phone\", \"chat\", \"note\"]),\n\tdirection: z.enum([\"inbound\", \"outbound\"]),\n\tstatus: z\n\t\t.enum([\"draft\", \"queued\", \"sending\", \"sent\", \"delivered\", \"failed\", \"read\"])\n\t\t.default(\"draft\"),\n\tsubject: z.string().max(500).optional().nullable(),\n\tbody: z.string().optional().nullable(),\n\tfrom_email: z.string().email().optional().nullable(),\n\tto_email: z.string().email().optional().nullable(),\n\tfrom_phone: z.string().max(20).optional().nullable(),\n\tto_phone: z.string().max(20).optional().nullable(),\n\tcc: z.array(z.string().email()).optional().nullable(),\n\tbcc: z.array(z.string().email()).optional().nullable(),\n\tthread_id: z.string().uuid().optional().nullable(),\n\tparent_id: z.string().uuid().optional().nullable(),\n\tscheduled_for: z.date().optional().nullable(),\n\tsent_at: z.date().optional().nullable(),\n\tdelivered_at: z.date().optional().nullable(),\n\tread_at: z.date().optional().nullable(),\n\tfailed_at: z.date().optional().nullable(),\n\tfailure_reason: z.string().optional().nullable(),\n\tretry_count: z.number().int().default(0),\n\topen_count: z.number().int().default(0),\n\tclick_count: z.number().int().default(0),\n\tcall_duration: z.number().int().optional().nullable(),\n\tcall_recording_url: z.string().url().optional().nullable(),\n\tcall_transcription: z.string().optional().nullable(),\n\tinternal_note: z.boolean().default(false),\n\tpinned: z.boolean().default(false),\n\ttags: z.array(z.string()).optional().nullable(),\n\tmetadata: z.record(z.string(), z.unknown()).optional().nullable(),\n});\n\nconst communicationUpdateSchema = communicationInsertSchema\n\t.partial()\n\t.omit({ company_id: true });\n\nconst communicationSelectSchema = communicationInsertSchema.extend({\n\tid: z.string().uuid(),\n\tcreated_at: z.date(),\n\tupdated_at: z.date(),\n\tdeleted_at: z.date().nullable(),\n\tdeleted_by: z.string().uuid().nullable(),\n});\n\n// ============================================================================\n// PAYMENTS\n// ============================================================================\n\nexport const paymentInsertSchema = z.object({\n\tcompany_id: z.string().uuid(),\n\tcustomer_id: z.string().uuid(),\n\tinvoice_id: z.string().uuid().optional().nullable(),\n\tjob_id: z.string().uuid().optional().nullable(),\n\tpayment_number: z.string().min(1, \"Payment number is required\").max(50),\n\tamount: z.number().int().min(1, \"Amount must be greater than 0\"), // In cents\n\tcurrency: z.string().length(3).default(\"USD\"),\n\tpayment_method: z.enum([\n\t\t\"cash\",\n\t\t\"check\",\n\t\t\"credit_card\",\n\t\t\"debit_card\",\n\t\t\"ach\",\n\t\t\"wire\",\n\t\t\"venmo\",\n\t\t\"paypal\",\n\t\t\"other\",\n\t]),\n\tpayment_type: z.enum([\"payment\", \"refund\", \"credit\"]).default(\"payment\"),\n\tstatus: z\n\t\t.enum([\n\t\t\t\"pending\",\n\t\t\t\"processing\",\n\t\t\t\"completed\",\n\t\t\t\"failed\",\n\t\t\t\"refunded\",\n\t\t\t\"partially_refunded\",\n\t\t\t\"cancelled\",\n\t\t])\n\t\t.default(\"pending\"),\n\tcard_brand: z\n\t\t.enum([\"visa\", \"mastercard\", \"amex\", \"discover\"])\n\t\t.optional()\n\t\t.nullable(),\n\tcard_last4: z.string().length(4).optional().nullable(),\n\tcard_exp_month: z.number().int().min(1).max(12).optional().nullable(),\n\tcard_exp_year: z.number().int().min(2024).optional().nullable(),\n\tcheck_number: z.string().max(50).optional().nullable(),\n\ttransaction_id: z.string().max(200).optional().nullable(),\n\tprocessor: z.string().max(50).optional().nullable(),\n\tprocessor_name: z.string().max(50).optional().nullable(),\n\tprocessor_transaction_id: z.string().max(200).optional().nullable(),\n\tprocessor_fee: z.number().int().default(0),\n\tnet_amount: z.number().int().default(0),\n\tprocessor_metadata: z.record(z.string(), z.unknown()).optional().nullable(),\n\tprocessor_response: z.record(z.string(), z.unknown()).optional().nullable(),\n\trefunded_amount: z.number().int().default(0),\n\toriginal_payment_id: z.string().uuid().optional().nullable(),\n\trefund_reason: z.string().optional().nullable(),\n\tnotes: z.string().optional().nullable(),\n\tis_reconciled: z.boolean().default(false),\n\treconciled_at: z.date().optional().nullable(),\n\treconciled_by: z.string().uuid().optional().nullable(),\n\tdeposit_date: z.date().optional().nullable(),\n\tbank_account_id: z.string().uuid().optional().nullable(),\n\tprocessed_at: z.date().optional().nullable(),\n\tprocessed_by: z.string().uuid().optional().nullable(),\n});\n\nexport const paymentUpdateSchema = paymentInsertSchema\n\t.partial()\n\t.omit({ company_id: true, payment_number: true });\n\nconst paymentSelectSchema = paymentInsertSchema.extend({\n\tid: z.string().uuid(),\n\tcreated_at: z.date(),\n\tupdated_at: z.date(),\n\tdeleted_at: z.date().nullable(),\n\tdeleted_by: z.string().uuid().nullable(),\n});\n\n// ============================================================================\n// EQUIPMENT\n// ============================================================================\n\nconst equipmentInsertSchema = z.object({\n\tcompany_id: z.string().uuid(),\n\tcustomer_id: z.string().uuid(),\n\tproperty_id: z.string().uuid().optional().nullable(),\n\tequipment_number: z.string().min(1, \"Equipment number is required\").max(50),\n\ttype: z.enum([\"hvac\", \"plumbing\", \"electrical\", \"appliance\", \"other\"]),\n\tcategory: z.string().max(100).optional().nullable(),\n\tmanufacturer: z.string().max(100).optional().nullable(),\n\tmodel: z.string().max(100).optional().nullable(),\n\tserial_number: z.string().max(100).optional().nullable(),\n\tyear: z.number().int().min(1900).max(2100).optional().nullable(),\n\tinstall_date: z.date().optional().nullable(),\n\tlocation: z.string().max(200).optional().nullable(),\n\tsize: z.string().max(50).optional().nullable(),\n\tcapacity: z.string().max(50).optional().nullable(),\n\tfuel_type: z.string().max(50).optional().nullable(),\n\tefficiency_rating: z.string().max(50).optional().nullable(),\n\twarranty_expiration: z.date().optional().nullable(),\n\tis_under_warranty: z.boolean().default(false),\n\twarranty_provider: z.string().max(100).optional().nullable(),\n\twarranty_notes: z.string().optional().nullable(),\n\tpurchase_price: z.number().int().optional().nullable(),\n\tcurrent_value: z.number().int().optional().nullable(),\n\tstatus: z\n\t\t.enum([\"active\", \"inactive\", \"retired\", \"warranty\", \"needs_service\"])\n\t\t.default(\"active\"),\n\tcondition: z\n\t\t.enum([\"excellent\", \"good\", \"fair\", \"poor\"])\n\t\t.optional()\n\t\t.nullable(),\n\tlast_service_date: z.date().optional().nullable(),\n\tnext_service_due: z.date().optional().nullable(),\n\tservice_interval_months: z.number().int().optional().nullable(),\n\tservice_plan_id: z.string().uuid().optional().nullable(),\n\tnotes: z.string().optional().nullable(),\n\ttags: z.array(z.string()).optional().nullable(),\n\tmetadata: z.record(z.string(), z.unknown()).optional().nullable(),\n});\n\nconst equipmentUpdateSchema = equipmentInsertSchema\n\t.partial()\n\t.omit({ company_id: true, equipment_number: true });\n\nconst equipmentSelectSchema = equipmentInsertSchema.extend({\n\tid: z.string().uuid(),\n\tcreated_at: z.date(),\n\tupdated_at: z.date(),\n\tdeleted_at: z.date().nullable(),\n\tdeleted_by: z.string().uuid().nullable(),\n});\n\n// ============================================================================\n// SCHEDULES\n// ============================================================================\n\nconst scheduleInsertSchema = z.object({\n\tcompany_id: z.string().uuid(),\n\tcustomer_id: z.string().uuid().optional().nullable(),\n\tjob_id: z.string().uuid().optional().nullable(),\n\tassigned_to: z.string().uuid().optional().nullable(),\n\ttype: z\n\t\t.enum([\"appointment\", \"task\", \"event\", \"block\", \"callback\"])\n\t\t.default(\"appointment\"),\n\ttitle: z.string().min(1, \"Title is required\").max(200),\n\tdescription: z.string().optional().nullable(),\n\tstart_time: z.date(),\n\tend_time: z.date(),\n\tduration: z.number().int().min(15), // In minutes\n\tall_day: z.boolean().default(false),\n\tstatus: z\n\t\t.enum([\n\t\t\t\"scheduled\",\n\t\t\t\"confirmed\",\n\t\t\t\"in_progress\",\n\t\t\t\"completed\",\n\t\t\t\"cancelled\",\n\t\t\t\"no_show\",\n\t\t])\n\t\t.default(\"scheduled\"),\n\tpriority: z.enum([\"low\", \"normal\", \"high\", \"urgent\"]).default(\"normal\"),\n\tlocation: z.string().max(500).optional().nullable(),\n\tlatitude: z.number().optional().nullable(),\n\tlongitude: z.number().optional().nullable(),\n\tis_recurring: z.boolean().default(false),\n\trecurrence_rule: z.record(z.string(), z.unknown()).optional().nullable(),\n\tparent_schedule_id: z.string().uuid().optional().nullable(),\n\tcolor: z.string().max(7).optional().nullable(),\n\treminder_enabled: z.boolean().default(true),\n\treminder_sent: z.boolean().default(false),\n\treminder_hours_before: z.number().int().default(24),\n\tnotes: z.string().optional().nullable(),\n\ttags: z.array(z.string()).optional().nullable(),\n\tmetadata: z.record(z.string(), z.unknown()).optional().nullable(),\n\t// Dispatch and completion tracking\n\tdispatch_time: z.union([z.date(), z.string()]).optional().nullable(),\n\tactual_start_time: z.union([z.date(), z.string()]).optional().nullable(),\n\tactual_end_time: z.union([z.date(), z.string()]).optional().nullable(),\n\tactual_duration: z.number().int().optional().nullable(),\n});\n\nconst scheduleUpdateSchema = scheduleInsertSchema\n\t.partial()\n\t.omit({ company_id: true });\n\nconst scheduleSelectSchema = scheduleInsertSchema.extend({\n\tid: z.string().uuid(),\n\tcreated_at: z.date(),\n\tupdated_at: z.date(),\n\tdeleted_at: z.date().nullable(),\n\tdeleted_by: z.string().uuid().nullable(),\n});\n\n// ============================================================================\n// TAGS\n// ============================================================================\n\nconst tagInsertSchema = z.object({\n\tcompany_id: z.string().uuid(),\n\tname: z.string().min(1, \"Tag name is required\").max(50),\n\tslug: z.string().min(1).max(60),\n\tdescription: z.string().max(500).optional().nullable(),\n\tcategory: z\n\t\t.enum([\"customer\", \"job\", \"equipment\", \"communication\", \"general\"])\n\t\t.optional()\n\t\t.nullable(),\n\tcolor: z\n\t\t.string()\n\t\t.regex(/^#[0-9A-Fa-f]{6}$/, \"Invalid hex color\")\n\t\t.optional()\n\t\t.nullable(),\n\ticon: z.string().max(50).optional().nullable(),\n\tusage_count: z.number().int().default(0),\n\tis_system: z.boolean().default(false),\n\tis_active: z.boolean().default(true),\n});\n\nconst tagUpdateSchema = tagInsertSchema\n\t.partial()\n\t.omit({ company_id: true, slug: true });\n\nconst tagSelectSchema = tagInsertSchema.extend({\n\tid: z.string().uuid(),\n\tcreated_at: z.date(),\n\tupdated_at: z.date(),\n});\n\n// ============================================================================\n// ATTACHMENTS\n// ============================================================================\n\nconst attachmentInsertSchema = z.object({\n\tcompany_id: z.string().uuid(),\n\tentity_type: z.enum([\n\t\t\"job\",\n\t\t\"customer\",\n\t\t\"invoice\",\n\t\t\"equipment\",\n\t\t\"communication\",\n\t\t\"estimate\",\n\t\t\"other\",\n\t]),\n\tentity_id: z.string().uuid(),\n\tfile_name: z.string().min(1, \"File name is required\").max(255),\n\tfile_size: z.number().int().min(1, \"File size must be greater than 0\"),\n\tmime_type: z.string().min(1, \"MIME type is required\").max(100),\n\tstorage_url: z.string().url(\"Invalid storage URL\"),\n\tstorage_path: z.string().max(500).optional().nullable(),\n\tbucket: z.string().max(100).optional().nullable(),\n\tis_image: z.boolean().default(false),\n\tis_document: z.boolean().default(false),\n\tis_public: z.boolean().default(false),\n\tthumbnail_url: z.string().url().optional().nullable(),\n\twidth: z.number().int().optional().nullable(),\n\theight: z.number().int().optional().nullable(),\n\talt_text: z.string().max(200).optional().nullable(),\n\tdescription: z.string().max(500).optional().nullable(),\n\ttags: z.array(z.string()).optional().nullable(),\n\tuploaded_by: z.string().uuid().optional().nullable(),\n\tuploaded_at: z.date().optional().nullable(),\n});\n\nconst attachmentUpdateSchema = attachmentInsertSchema\n\t.partial()\n\t.omit({ company_id: true, entity_type: true, entity_id: true });\n\nconst attachmentSelectSchema = attachmentInsertSchema.extend({\n\tid: z.string().uuid(),\n\tcreated_at: z.date(),\n\tupdated_at: z.date(),\n\tdeleted_at: z.date().nullable(),\n\tdeleted_by: z.string().uuid().nullable(),\n});\n\n// ============================================================================\n// HELPER TYPES\n// ============================================================================\n\nexport type CustomerInsert = z.infer<typeof customerInsertSchema>;\nexport type CustomerUpdate = z.infer<typeof customerUpdateSchema>;\nexport type CustomerSelect = z.infer<typeof customerSelectSchema>;\n\nexport type CommunicationInsert = z.infer<typeof communicationInsertSchema>;\nexport type CommunicationUpdate = z.infer<typeof communicationUpdateSchema>;\nexport type CommunicationSelect = z.infer<typeof communicationSelectSchema>;\n\nexport type PaymentInsert = z.infer<typeof paymentInsertSchema>;\nexport type PaymentUpdate = z.infer<typeof paymentUpdateSchema>;\nexport type PaymentSelect = z.infer<typeof paymentSelectSchema>;\n\nexport type EquipmentInsert = z.infer<typeof equipmentInsertSchema>;\nexport type EquipmentUpdate = z.infer<typeof equipmentUpdateSchema>;\nexport type EquipmentSelect = z.infer<typeof equipmentSelectSchema>;\n\nexport type ScheduleInsert = z.infer<typeof scheduleInsertSchema>;\nexport type ScheduleUpdate = z.infer<typeof scheduleUpdateSchema>;\nexport type ScheduleSelect = z.infer<typeof scheduleSelectSchema>;\n\nexport type TagInsert = z.infer<typeof tagInsertSchema>;\nexport type TagUpdate = z.infer<typeof tagUpdateSchema>;\nexport type TagSelect = z.infer<typeof tagSelectSchema>;\n\nexport type AttachmentInsert = z.infer<typeof attachmentInsertSchema>;\nexport type AttachmentUpdate = z.infer<typeof attachmentUpdateSchema>;\nexport type AttachmentSelect = z.infer<typeof attachmentSelectSchema>;\n\n// ============================================================================\n// JOB TIME ENTRIES\n// ============================================================================\n\nconst jobTimeEntryInsertSchema = z.object({\n\tjob_id: z.string().uuid(),\n\tcompany_id: z.string().uuid(),\n\tuser_id: z.string().uuid(),\n\tclock_in: z.date(),\n\tclock_out: z.date().optional().nullable(),\n\tbreak_minutes: z.number().int().min(0).max(1439).default(0),\n\tclock_in_location: z\n\t\t.object({\n\t\t\tlat: z.number(),\n\t\t\tlng: z.number(),\n\t\t\taccuracy: z.number().optional(),\n\t\t\taddress: z.string().optional(),\n\t\t})\n\t\t.optional()\n\t\t.nullable(),\n\tclock_out_location: z\n\t\t.object({\n\t\t\tlat: z.number(),\n\t\t\tlng: z.number(),\n\t\t\taccuracy: z.number().optional(),\n\t\t\taddress: z.string().optional(),\n\t\t})\n\t\t.optional()\n\t\t.nullable(),\n\tgps_verified: z.boolean().default(false),\n\tentry_type: z.enum([\"manual\", \"auto\", \"gps\"]).default(\"manual\"),\n\tnotes: z.string().optional().nullable(),\n\tis_overtime: z.boolean().default(false),\n\tis_billable: z.boolean().default(true),\n\thourly_rate: z.number().int().optional().nullable(),\n\tmetadata: z.any().optional().nullable(),\n});\n\nconst jobTimeEntryUpdateSchema = jobTimeEntryInsertSchema\n\t.partial()\n\t.omit({ job_id: true, company_id: true, user_id: true });\n\nconst jobTimeEntrySelectSchema = jobTimeEntryInsertSchema.extend({\n\tid: z.string().uuid(),\n\ttotal_hours: z.number().optional().nullable(),\n\tcreated_at: z.date(),\n\tupdated_at: z.date(),\n});\n\n// ============================================================================\n// JOB PHOTOS\n// ============================================================================\n\nconst jobPhotoInsertSchema = z.object({\n\tjob_id: z.string().uuid(),\n\tcompany_id: z.string().uuid(),\n\tuploaded_by: z.string().uuid(),\n\tstorage_path: z.string().min(1, \"Storage path is required\"),\n\tthumbnail_path: z.string().optional().nullable(),\n\tfile_name: z.string().min(1, \"File name is required\").max(255),\n\tfile_size: z.number().int().min(1).max(52_428_800), // 50MB max\n\tmime_type: z.string().optional().nullable(),\n\tcategory: z.enum([\n\t\t\"before\",\n\t\t\"during\",\n\t\t\"after\",\n\t\t\"issue\",\n\t\t\"equipment\",\n\t\t\"completion\",\n\t\t\"other\",\n\t]),\n\tsubcategory: z.string().max(100).optional().nullable(),\n\ttitle: z.string().max(200).optional().nullable(),\n\tdescription: z.string().optional().nullable(),\n\tis_customer_visible: z.boolean().default(true),\n\tis_required_photo: z.boolean().default(false),\n\tphoto_location: z\n\t\t.object({\n\t\t\tlat: z.number(),\n\t\t\tlng: z.number(),\n\t\t\taccuracy: z.number().optional(),\n\t\t\taddress: z.string().optional(),\n\t\t})\n\t\t.optional()\n\t\t.nullable(),\n\ttaken_at: z.date().optional().nullable(),\n\tdevice_info: z.any().optional().nullable(),\n\texif_data: z.any().optional().nullable(),\n\tannotations: z.array(z.any()).optional().nullable(),\n\ttags: z.array(z.string()).optional().nullable(),\n\tdisplay_order: z.number().int().default(0),\n\tmetadata: z.any().optional().nullable(),\n});\n\nconst jobPhotoUpdateSchema = jobPhotoInsertSchema\n\t.partial()\n\t.omit({ job_id: true, company_id: true, uploaded_by: true });\n\nconst jobPhotoSelectSchema = jobPhotoInsertSchema.extend({\n\tid: z.string().uuid(),\n\tcreated_at: z.date(),\n\tupdated_at: z.date(),\n});\n\n// ============================================================================\n// JOB WORKFLOW STAGES\n// ============================================================================\n\nconst jobWorkflowStageInsertSchema = z.object({\n\tcompany_id: z.string().uuid(),\n\tstage_name: z.string().min(1, \"Stage name is required\").max(100),\n\tstage_key: z.string().min(1, \"Stage key is required\").max(100),\n\tdisplay_order: z.number().int().min(0).default(0),\n\tstage_color: z.string().max(20).optional().nullable(),\n\tstage_icon: z.string().max(50).optional().nullable(),\n\tis_start_stage: z.boolean().default(false),\n\tis_end_stage: z.boolean().default(false),\n\trequires_approval: z.boolean().default(false),\n\tapproval_roles: z.array(z.any()).optional().nullable(),\n\trequired_fields: z.array(z.string()).optional().nullable(),\n\trequired_photos_count: z.number().int().min(0).default(0),\n\trequired_time_entry: z.boolean().default(false),\n\tauto_send_email: z.boolean().default(false),\n\temail_template_id: z.string().uuid().optional().nullable(),\n\tauto_send_sms: z.boolean().default(false),\n\tsms_template_id: z.string().uuid().optional().nullable(),\n\tauto_create_invoice: z.boolean().default(false),\n\tallowed_next_stages: z.array(z.string()).optional().nullable(),\n\tindustry_type: z.string().max(50).optional().nullable(),\n\tis_active: z.boolean().default(true),\n\tmetadata: z.any().optional().nullable(),\n});\n\nconst jobWorkflowStageUpdateSchema = jobWorkflowStageInsertSchema\n\t.partial()\n\t.omit({ company_id: true });\n\nconst jobWorkflowStageSelectSchema = jobWorkflowStageInsertSchema.extend(\n\t{\n\t\tid: z.string().uuid(),\n\t\tcreated_at: z.date(),\n\t\tupdated_at: z.date(),\n\t},\n);\n\n// ============================================================================\n// JOB SIGNATURES\n// ============================================================================\n\nconst jobSignatureInsertSchema = z.object({\n\tjob_id: z.string().uuid(),\n\tcompany_id: z.string().uuid(),\n\tsignature_type: z.enum([\n\t\t\"customer\",\n\t\t\"technician\",\n\t\t\"inspector\",\n\t\t\"supervisor\",\n\t\t\"other\",\n\t]),\n\tsigner_name: z.string().min(1, \"Signer name is required\").max(200),\n\tsigner_email: z.string().email().optional().nullable(),\n\tsigner_phone: z.string().max(20).optional().nullable(),\n\tsigner_role: z.string().max(100).optional().nullable(),\n\tsignature_data_url: z.string().min(1, \"Signature data is required\"),\n\tsignature_hash: z.string().optional().nullable(),\n\tsigned_at: z.date().default(() => new Date()),\n\tsigned_location: z\n\t\t.object({\n\t\t\tlat: z.number(),\n\t\t\tlng: z.number(),\n\t\t\taccuracy: z.number().optional(),\n\t\t\taddress: z.string().optional(),\n\t\t})\n\t\t.optional()\n\t\t.nullable(),\n\tip_address: z.string().max(45).optional().nullable(),\n\tuser_agent: z.string().optional().nullable(),\n\tdevice_info: z.any().optional().nullable(),\n\tdocument_type: z.enum([\n\t\t\"job_completion\",\n\t\t\"estimate\",\n\t\t\"change_order\",\n\t\t\"work_authorization\",\n\t\t\"inspection\",\n\t\t\"other\",\n\t]),\n\tdocument_content: z.any().optional().nullable(),\n\tagreement_text: z.string().optional().nullable(),\n\tis_verified: z.boolean().default(false),\n\tverified_at: z.date().optional().nullable(),\n\tverified_by: z.string().uuid().optional().nullable(),\n\tmetadata: z.any().optional().nullable(),\n});\n\nconst jobSignatureUpdateSchema = jobSignatureInsertSchema\n\t.partial()\n\t.omit({ job_id: true, company_id: true });\n\nconst jobSignatureSelectSchema = jobSignatureInsertSchema.extend({\n\tid: z.string().uuid(),\n\tcreated_at: z.date(),\n});\n\n// ============================================================================\n// ENHANCED JOBS SCHEMA\n// ============================================================================\n\n/**\n * Job Insert Schema - REFACTORED\n *\n * After domain table refactoring, this schema only includes core job fields.\n * Domain-specific fields have been moved to separate tables and schemas:\n * - job_financial - Financial data\n * - job_workflow - Workflow/template data\n * - job_time_tracking - Time tracking data\n * - job_customer_approval - Customer signatures/approval\n * - job_equipment_service - Equipment service tracking\n * - job_dispatch - Dispatch/routing data\n * - job_quality - Quality metrics\n * - job_safety - Safety/compliance data\n * - job_ai_enrichment - AI analysis\n * - job_multi_entity - Multi-customer/property support\n *\n * See /src/lib/validations/job-domain-schemas.ts for domain schemas\n */\nconst jobInsertSchema = z.object({\n\t// Core identity\n\tcompany_id: z.string().uuid(),\n\tjob_number: z.string().min(1, \"Job number is required\").max(50),\n\ttitle: z.string().min(1, \"Title is required\").max(200),\n\tdescription: z.string().optional().nullable(),\n\n\t// Classification\n\tstatus: z\n\t\t.enum([\n\t\t\t\"quoted\",\n\t\t\t\"scheduled\",\n\t\t\t\"in_progress\",\n\t\t\t\"on_hold\",\n\t\t\t\"completed\",\n\t\t\t\"cancelled\",\n\t\t\t\"archived\",\n\t\t])\n\t\t.default(\"quoted\"),\n\tpriority: z.enum([\"low\", \"medium\", \"high\", \"urgent\"]).default(\"medium\"),\n\tjob_type: z.string().max(100).optional().nullable(),\n\tservice_type: z.string().max(100).optional().nullable(),\n\n\t// Primary relationships\n\tproperty_id: z.string().uuid().optional().nullable(),\n\tcustomer_id: z.string().uuid().optional().nullable(),\n\tassigned_to: z.string().uuid().optional().nullable(),\n\n\t// Scheduling (core scheduling only - actual times moved to job_time_tracking)\n\tscheduled_start: z.date().optional().nullable(),\n\tscheduled_end: z.date().optional().nullable(),\n\n\t// Flexible data\n\tnotes: z.string().optional().nullable(),\n\tmetadata: z.any().optional().nullable(),\n});\n\nconst jobUpdateSchema = jobInsertSchema\n\t.partial()\n\t.omit({ company_id: true });\n\nconst jobSelectSchema = jobInsertSchema.extend({\n\tid: z.string().uuid(),\n\tcreated_at: z.date(),\n\tupdated_at: z.date(),\n\tdeleted_at: z.date().nullable(),\n\tarchived_at: z.date().nullable(),\n\tsearch_vector: z.any().nullable(),\n});\n\n// ============================================================================\n// HELPER TYPES\n// ============================================================================\n\nexport type JobTimeEntryInsert = z.infer<typeof jobTimeEntryInsertSchema>;\nexport type JobTimeEntryUpdate = z.infer<typeof jobTimeEntryUpdateSchema>;\nexport type JobTimeEntrySelect = z.infer<typeof jobTimeEntrySelectSchema>;\n\nexport type JobPhotoInsert = z.infer<typeof jobPhotoInsertSchema>;\nexport type JobPhotoUpdate = z.infer<typeof jobPhotoUpdateSchema>;\nexport type JobPhotoSelect = z.infer<typeof jobPhotoSelectSchema>;\n\nexport type JobWorkflowStageInsert = z.infer<\n\ttypeof jobWorkflowStageInsertSchema\n>;\nexport type JobWorkflowStageUpdate = z.infer<\n\ttypeof jobWorkflowStageUpdateSchema\n>;\nexport type JobWorkflowStageSelect = z.infer<\n\ttypeof jobWorkflowStageSelectSchema\n>;\n\nexport type JobSignatureInsert = z.infer<typeof jobSignatureInsertSchema>;\nexport type JobSignatureUpdate = z.infer<typeof jobSignatureUpdateSchema>;\nexport type JobSignatureSelect = z.infer<typeof jobSignatureSelectSchema>;\n\nexport type JobInsert = z.infer<typeof jobInsertSchema>;\nexport type JobUpdate = z.infer<typeof jobUpdateSchema>;\nexport type JobSelect = z.infer<typeof jobSelectSchema>;\n\n// ============================================================================\n// VENDORS\n// ============================================================================\n\nexport const vendorInsertSchema = z.object({\n\tcompany_id: z.string().uuid(),\n\tname: z.string().min(1, \"Vendor name is required\").max(200),\n\tdisplay_name: z.string().min(1, \"Display name is required\").max(200),\n\tvendor_number: z.string().min(1, \"Vendor number is required\").max(50),\n\temail: z.string().email(\"Invalid email address\").optional().nullable(),\n\tphone: z.string().max(20).optional().nullable(),\n\tsecondary_phone: z.string().max(20).optional().nullable(),\n\twebsite: z.string().url(\"Invalid URL\").optional().nullable(),\n\taddress: z.string().max(500).optional().nullable(),\n\taddress2: z.string().max(500).optional().nullable(),\n\tcity: z.string().max(100).optional().nullable(),\n\tstate: z.string().max(100).optional().nullable(),\n\tzip_code: z.string().max(20).optional().nullable(),\n\tcountry: z.string().max(100).default(\"USA\"),\n\ttax_id: z.string().max(50).optional().nullable(),\n\tpayment_terms: z\n\t\t.enum([\"net_15\", \"net_30\", \"net_60\", \"due_on_receipt\", \"custom\"])\n\t\t.default(\"net_30\"),\n\tcredit_limit: z.number().int().min(0).default(0), // In cents\n\tpreferred_payment_method: z\n\t\t.enum([\"check\", \"ach\", \"credit_card\", \"wire\"])\n\t\t.optional()\n\t\t.nullable(),\n\tcategory: z\n\t\t.enum([\n\t\t\t\"supplier\",\n\t\t\t\"distributor\",\n\t\t\t\"manufacturer\",\n\t\t\t\"service_provider\",\n\t\t\t\"other\",\n\t\t])\n\t\t.optional()\n\t\t.nullable(),\n\ttags: z.array(z.string()).optional().nullable(),\n\tstatus: z.enum([\"active\", \"inactive\"]).default(\"active\"),\n\tnotes: z.string().optional().nullable(),\n\tinternal_notes: z.string().optional().nullable(),\n\tcustom_fields: z.record(z.string(), z.any()).optional().nullable(),\n});\n\nexport const vendorUpdateSchema = vendorInsertSchema\n\t.partial()\n\t.omit({ company_id: true });\n\nconst vendorSelectSchema = vendorInsertSchema.extend({\n\tid: z.string().uuid(),\n\tcreated_at: z.date(),\n\tupdated_at: z.date(),\n\tdeleted_at: z.date().optional().nullable(),\n\tdeleted_by: z.string().uuid().optional().nullable(),\n});\n\n// ============================================================================\n// PURCHASE ORDERS\n// ============================================================================\n\nconst purchaseOrderLineItemSchema = z.object({\n\tid: z.string().uuid().optional(),\n\tdescription: z.string().min(1, \"Description is required\"),\n\tquantity: z.number().positive(\"Quantity must be positive\"),\n\tunit_price: z.number().nonnegative(\"Unit price must be non-negative\"), // In cents\n\ttotal: z.number().nonnegative(\"Total must be non-negative\"), // In cents\n});\n\nexport const purchaseOrderInsertSchema = z.object({\n\tcompany_id: z.string().uuid(),\n\tjob_id: z.string().uuid().optional().nullable(),\n\testimate_id: z.string().uuid().optional().nullable(),\n\tinvoice_id: z.string().uuid().optional().nullable(),\n\trequested_by: z.string().uuid(),\n\tapproved_by: z.string().uuid().optional().nullable(),\n\tvendor_id: z.string().uuid().optional().nullable(),\n\tvendor: z.string().min(1, \"Vendor name is required\").max(200),\n\tvendor_email: z.string().email(\"Invalid email address\").optional().nullable(),\n\tvendor_phone: z.string().max(20).optional().nullable(),\n\tpo_number: z.string().min(1, \"PO number is required\").max(100),\n\ttitle: z.string().min(1, \"Title is required\").max(200),\n\tdescription: z.string().optional().nullable(),\n\tstatus: z\n\t\t.enum([\n\t\t\t\"draft\",\n\t\t\t\"pending_approval\",\n\t\t\t\"approved\",\n\t\t\t\"ordered\",\n\t\t\t\"partially_received\",\n\t\t\t\"received\",\n\t\t\t\"cancelled\",\n\t\t])\n\t\t.default(\"draft\"),\n\tpriority: z.enum([\"low\", \"normal\", \"high\", \"urgent\"]).default(\"normal\"),\n\tline_items: z\n\t\t.array(purchaseOrderLineItemSchema)\n\t\t.min(1, \"At least one line item is required\"),\n\tsubtotal: z.number().int().nonnegative().default(0), // In cents\n\ttax_amount: z.number().int().nonnegative().default(0), // In cents\n\tshipping_amount: z.number().int().nonnegative().default(0), // In cents\n\ttotal_amount: z.number().int().nonnegative().default(0), // In cents\n\texpected_delivery: z.date().optional().nullable(),\n\tactual_delivery: z.date().optional().nullable(),\n\tdelivery_address: z.string().max(500).optional().nullable(),\n\tnotes: z.string().optional().nullable(),\n\tinternal_notes: z.string().optional().nullable(),\n\tauto_generated: z.boolean().default(false),\n});\n\nconst purchaseOrderUpdateSchema = purchaseOrderInsertSchema\n\t.partial()\n\t.omit({ company_id: true });\n\nconst purchaseOrderSelectSchema = purchaseOrderInsertSchema.extend({\n\tid: z.string().uuid(),\n\tcreated_at: z.date(),\n\tupdated_at: z.date(),\n\tapproved_at: z.date().optional().nullable(),\n\tordered_at: z.date().optional().nullable(),\n\treceived_at: z.date().optional().nullable(),\n});\n\n// ============================================================================\n// HELPER TYPES\n// ============================================================================\n\nexport type VendorInsert = z.infer<typeof vendorInsertSchema>;\nexport type VendorUpdate = z.infer<typeof vendorUpdateSchema>;\nexport type VendorSelect = z.infer<typeof vendorSelectSchema>;\n\nexport type PurchaseOrderLineItem = z.infer<typeof purchaseOrderLineItemSchema>;\nexport type PurchaseOrderInsert = z.infer<typeof purchaseOrderInsertSchema>;\nexport type PurchaseOrderUpdate = z.infer<typeof purchaseOrderUpdateSchema>;\nexport type PurchaseOrderSelect = z.infer<typeof purchaseOrderSelectSchema>;\n"],"names":[],"mappings":"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"}}]
}