{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/roles.ts"],"sourcesContent":["/**\n * Role Actions - Server Actions\n *\n * Server-side actions for role management and permission checks.\n * Uses Supabase RLS and database functions for security.\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport {\n\tgetUserRole,\n\thasPermission,\n\thasRole,\n\tisCompanyOwner,\n\ttype Permission,\n\ttype UserRole,\n} from \"@/lib/auth/permissions\";\nimport { withErrorHandling } from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// ============================================================================\n// Validation Schemas\n// ============================================================================\n\nconst updateRoleSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tnewRole: z.enum([\n\t\t\"owner\",\n\t\t\"admin\",\n\t\t\"manager\",\n\t\t\"dispatcher\",\n\t\t\"technician\",\n\t\t\"csr\",\n\t]),\n\treason: z.string().optional(),\n});\n\nconst updatePermissionsSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tpermissions: z.record(z.string(), z.boolean()),\n});\n\n// ============================================================================\n// Query Actions\n// ============================================================================\n\n/**\n * Get current user's role in active company\n *\n * @returns User's role or null\n *\n * @example\n * ```typescript\n * const role = await getCurrentUserRole();\n * if (role.success && role.data === \"manager\") {\n *   // Show manager dashboard\n * }\n * ```\n */\nexport async function getCurrentUserRole() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst role = await getUserRole(supabase, user.id, companyId);\n\n\t\treturn role;\n\t});\n}\n\n/**\n * Check if current user has a specific permission\n *\n * @param permission - Permission to check\n * @returns true if user has permission\n *\n * @example\n * ```typescript\n * const result = await checkPermission(\"delete_jobs\");\n * if (!result.success || !result.data) {\n *   return { error: \"Access denied\" };\n * }\n * ```\n */\nasync function checkPermission(permission: Permission) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasPerm = await hasPermission(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t\tpermission,\n\t\t\tcompanyId,\n\t\t);\n\n\t\treturn hasPerm;\n\t});\n}\n\n/**\n * Check if current user has a specific role\n *\n * @param role - Role to check\n * @returns true if user has role\n *\n * @example\n * ```typescript\n * const result = await checkRole(\"manager\");\n * if (!result.success || !result.data) {\n *   redirect(\"/dashboard\");\n * }\n * ```\n */\nasync function checkRole(role: UserRole) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasRoleResult = await hasRole(supabase, user.id, role, companyId);\n\n\t\treturn hasRoleResult;\n\t});\n}\n\n/**\n * Check if current user is company owner\n *\n * @returns true if user is owner\n */\nasync function checkIsOwner() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\n\t\treturn isOwner;\n\t});\n}\n\n// ============================================================================\n// Mutation Actions\n// ============================================================================\n\n/**\n * Update team member's role\n * Only owners and admins can change roles\n *\n * @param input - Team member ID, new role, and optional reason\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberRole({\n *   teamMemberId: \"123...\",\n *   newRole: \"manager\",\n *   reason: \"Promoted to management\"\n * });\n * ```\n */\nasync function updateTeamMemberRole(\n\tinput: z.infer<typeof updateRoleSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updateRoleSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission - only owners and admins can change roles\n\t\tconst canManageRoles =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManageRoles) {\n\t\t\tthrow new Error(\"Only owners and admins can change roles\");\n\t\t}\n\n\t\t// Get current role for audit log\n\t\tconst { data: currentMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"role\")\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!currentMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Update role\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ role: validated.newRole })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\t// Log role change\n\t\tawait supabase.from(\"role_change_log\").insert({\n\t\t\tteam_member_id: validated.teamMemberId,\n\t\t\tchanged_by: user.id,\n\t\t\told_role: currentMember.role,\n\t\t\tnew_role: validated.newRole,\n\t\t\treason: validated.reason,\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Update team member's custom permissions\n * Only owners and admins can change permissions\n *\n * @param input - Team member ID and permissions object\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberPermissions({\n *   teamMemberId: \"123...\",\n *   permissions: {\n *     \"delete_jobs\": true,\n *     \"approve_estimates\": true\n *   }\n * });\n * ```\n */\nasync function updateTeamMemberPermissions(\n\tinput: z.infer<typeof updatePermissionsSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updatePermissionsSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission\n\t\tconst canManagePermissions =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManagePermissions) {\n\t\t\tthrow new Error(\"Only owners and admins can change permissions\");\n\t\t}\n\n\t\t// Update permissions\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ permissions: validated.permissions })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Get team members with their roles\n *\n * @returns List of team members with roles\n */\nasync function getTeamMembersWithRoles() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        users (\n          id,\n          name,\n          email,\n          avatar\n        )\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n// ============================================================================\n// Owner Protection Actions\n// ============================================================================\n\n/**\n * Transfer company ownership to another team member\n * Requires password verification and extensive validation\n *\n * @param input - Transfer details including new owner, password, and reason\n * @returns Transfer ID for audit\n *\n * @example\n * ```typescript\n * const result = await transferOwnership({\n *   newOwnerId: \"user-uuid\",\n *   password: \"current-password\",\n *   reason: \"Retiring from business\"\n * });\n * ```\n */\nasync function transferOwnership(input: {\n\tnewOwnerId: string;\n\tpassword: string;\n\treason?: string;\n\tipAddress?: string;\n\tuserAgent?: string;\n}) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Verify user is current owner\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\t\tif (!isOwner) {\n\t\t\tthrow new Error(\"Only the current owner can transfer ownership\");\n\t\t}\n\n\t\t// Verify password\n\t\tconst { error: signInError } = await supabase.auth.signInWithPassword({\n\t\t\temail: user.email || \"\",\n\t\t\tpassword: input.password,\n\t\t});\n\n\t\tif (signInError) {\n\t\t\tthrow new Error(\"Password verification failed\");\n\t\t}\n\n\t\t// Call database function to transfer ownership\n\t\tconst { data: transferId, error } = await supabase.rpc(\n\t\t\t\"transfer_company_ownership\",\n\t\t\t{\n\t\t\t\tp_company_id: companyId,\n\t\t\t\tp_current_owner_id: user.id,\n\t\t\t\tp_new_owner_id: input.newOwnerId,\n\t\t\t\tp_reason: input.reason,\n\t\t\t\tp_ip_address: input.ipAddress,\n\t\t\t\tp_user_agent: input.userAgent,\n\t\t\t},\n\t\t);\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message || \"Failed to transfer ownership\");\n\t\t}\n\n\t\t// Revalidate all relevant paths\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard\");\n\n\t\treturn transferId;\n\t});\n}\n\n/**\n * Get ownership transfer history for the company\n * Shows audit trail of all ownership changes\n *\n * @returns List of ownership transfers\n */\nasync function getOwnershipTransferHistory() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\t// Only owners and admins can view transfer history\n\t\tconst canView =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canView) {\n\t\t\tthrow new Error(\"Only owners and admins can view transfer history\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"ownership_transfers\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        previous_owner:users!ownership_transfers_previous_owner_id_fkey(id, name, email),\n        new_owner:users!ownership_transfers_new_owner_id_fkey(id, name, email),\n        initiated_by_user:users!ownership_transfers_initiated_by_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n/**\n * Check if a team member can be deleted\n * Prevents deletion of company owner\n *\n * @param teamMemberId - Team member to check\n * @returns Object with canDelete boolean and reason if not allowed\n */\nexport async function canDeleteTeamMember(teamMemberId: string) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Get team member details\n\t\tconst { data: teamMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"user_id, role\")\n\t\t\t.eq(\"id\", teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error || !teamMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Check if user is company owner\n\t\tconst { data: company } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"owner_id\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (company && company.owner_id === teamMember.user_id) {\n\t\t\treturn {\n\t\t\t\tcanDelete: false,\n\t\t\t\treason:\n\t\t\t\t\t\"Cannot delete company owner. Transfer ownership first before removing this team member.\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tcanDelete: true,\n\t\t};\n\t});\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 440, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/ten-dlc-registration.ts"],"sourcesContent":["\"use server\";\n\nimport { sendVerificationSubmittedEmail } from \"@/lib/email/verification-emails\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\nimport {\n\tcheckAccountVerificationStatus,\n\tgetNextSteps,\n\tgetVerificationRequirements,\n\ttype VerificationStatus,\n} from \"@/lib/telnyx/account-verification\";\nimport {\n\tattachNumberToCampaign,\n\tcreateTenDlcBrand,\n\tcreateTenDlcCampaign,\n\tgetTenDlcBrand,\n\tgetTenDlcCampaign,\n\ttype TenDlcBrandPayload,\n\ttype TenDlcCampaignPayload,\n} from \"@/lib/telnyx/ten-dlc\";\n\ntype RegistrationResult = {\n\tsuccess: boolean;\n\tbrandId?: string;\n\tcampaignId?: string;\n\terror?: string;\n\tlog: string[];\n};\n\n/**\n * Automated 10DLC registration for a company\n *\n * This function:\n * 1. Fetches company data from database\n * 2. Creates a 10DLC brand with Telnyx\n * 3. Waits for brand approval (polls status)\n * 4. Creates a 10DLC campaign\n * 5. Waits for campaign approval\n * 6. Attaches all company phone numbers to the campaign\n * 7. Updates company_telnyx_settings with brand and campaign IDs\n */\nexport async function registerCompanyFor10DLC(\n\tcompanyId: string,\n): Promise<RegistrationResult> {\n\tconst log: string[] = [];\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Failed to create Supabase client\",\n\t\t\tlog,\n\t\t};\n\t}\n\n\ttry {\n\t\t// 1. Fetch company data\n\t\tlog.push(\"Fetching company data...\");\n\t\tconst { data: company, error: companyError } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\n\t\t\t\t`\n\t\t\t\tid,\n\t\t\t\tname,\n\t\t\t\tein,\n\t\t\t\twebsite,\n\t\t\t\tindustry,\n\t\t\t\taddress,\n\t\t\t\tcity,\n\t\t\t\tstate,\n\t\t\t\tzip_code,\n\t\t\t\tphone,\n\t\t\t\temail,\n\t\t\t\tsupport_email,\n\t\t\t\tsupport_phone\n\t\t\t`,\n\t\t\t)\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (companyError || !company) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Company not found: ${companyError?.message}`,\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\t// Validate required fields\n\t\tif (!company.ein) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company EIN is required for 10DLC registration. Please add the company's Tax ID.\",\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\tif (\n\t\t\t!company.address ||\n\t\t\t!company.city ||\n\t\t\t!company.state ||\n\t\t\t!company.zip_code\n\t\t) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company address is incomplete. Please add full address, city, state, and ZIP code.\",\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\tconst contactEmail = company.email || company.support_email;\n\t\tconst contactPhone = company.phone || company.support_phone;\n\n\t\tif (!contactEmail || !contactPhone) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company contact email and phone are required for 10DLC registration.\",\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\t// CRITICAL: Verify email domain before 10DLC registration\n\t\tlog.push(\"Verifying company email domain...\");\n\n\t\tconst supabaseService = await createServiceSupabaseClient();\n\t\tif (!supabaseService) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Database service client failed\",\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\tconst { data: verifiedDomain } = await supabaseService\n\t\t\t.from(\"company_email_domains\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"verified\")\n\t\t\t.single();\n\n\t\tif (!verifiedDomain) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company email domain must be verified before 10DLC registration. TCR (The Campaign Registry) requires a verified business email domain with proper SPF/DKIM/DMARC records. Please complete email domain setup in the onboarding steps.\",\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\t// Use domain email for TCR registration\n\t\tconst fullDomain = verifiedDomain.subdomain\n\t\t\t? `${verifiedDomain.subdomain}.${verifiedDomain.domain_name}`\n\t\t\t: verifiedDomain.domain_name;\n\n\t\tconst domainEmail = `admin@${fullDomain}`;\n\t\tlog.push(`Email domain verified: ${fullDomain}`);\n\n\t\t// Normalize phone to E.164 format (Telnyx requirement)\n\t\tconst normalizeToE164 = (phone: string): string => {\n\t\t\t// Remove all non-digit characters\n\t\t\tconst digits = phone.replace(/\\D/g, \"\");\n\t\t\t// Ensure it starts with country code (default to US +1)\n\t\t\tif (digits.length === 10) {\n\t\t\t\treturn `+1${digits}`;\n\t\t\t}\n\t\t\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\t\t\treturn `+${digits}`;\n\t\t\t}\n\t\t\t// Already has country code\n\t\t\treturn `+${digits}`;\n\t\t};\n\n\t\tconst normalizedPhone = normalizeToE164(contactPhone);\n\n\t\t// 2. Check if already registered\n\t\tlog.push(\"Checking existing 10DLC registration...\");\n\t\tconst { data: settings } = await supabase\n\t\t\t.from(\"company_telnyx_settings\")\n\t\t\t.select(\"ten_dlc_brand_id, ten_dlc_campaign_id\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (settings?.ten_dlc_brand_id && settings?.ten_dlc_campaign_id) {\n\t\t\tlog.push(\"Company already has 10DLC registration\");\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tbrandId: settings.ten_dlc_brand_id,\n\t\t\t\tcampaignId: settings.ten_dlc_campaign_id,\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\t// 3. Create 10DLC Brand\n\t\tlog.push(\"Creating 10DLC brand with Telnyx...\");\n\t\tconst brandPayload: TenDlcBrandPayload = {\n\t\t\tentityType: \"PRIVATE_PROFIT\", // Default - could be made configurable\n\t\t\tdisplayName: company.name || \"Unknown Company\",\n\t\t\tcompanyName: company.name || \"Unknown Company\",\n\t\t\tfirstName: \"Business\", // No separate first/last name fields in companies table\n\t\t\tlastName: \"Owner\",\n\t\t\tein: company.ein,\n\t\t\tphone: normalizedPhone, // E.164 format required by Telnyx\n\t\t\tstreet: company.address || \"\",\n\t\t\tcity: company.city || \"\",\n\t\t\tstate: company.state || \"\",\n\t\t\tpostalCode: company.zip_code || \"\",\n\t\t\tcountry: \"US\",\n\t\t\temail: contactEmail,\n\t\t\twebsite: company.website,\n\t\t\tvertical: determineVertical(company.industry),\n\t\t\tbusinessContactEmail: contactEmail,\n\t\t\t// ISV/Reseller identification - Stratos is the platform\n\t\t\tisReseller: true,\n\t\t};\n\n\t\tconst brandResult = await createTenDlcBrand(brandPayload);\n\n\t\tif (!brandResult.success || !brandResult.data?.brandId) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Failed to create 10DLC brand: ${brandResult.error}`,\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\tconst brandId = brandResult.data.brandId;\n\t\tlog.push(`Brand created: ${brandId}`);\n\n\t\t// 4. Poll brand status until approved (max 60 seconds)\n\t\tlog.push(\"Waiting for brand approval...\");\n\t\tconst brandApprovalResult = await pollForApproval(\n\t\t\t() => getTenDlcBrand(brandId),\n\t\t\t60,\n\t\t);\n\n\t\tif (!brandApprovalResult.approved) {\n\t\t\tlog.push(\n\t\t\t\t`Brand approval failed: ${brandApprovalResult.failureReason || \"Unknown reason\"}`,\n\t\t\t);\n\n\t\t\t// Check if failure was due to email validation (fail fast)\n\t\t\tif (brandApprovalResult.failureReason?.toLowerCase().includes(\"email\")) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror:\n\t\t\t\t\t\t`Email validation failed: ${brandApprovalResult.failureReason}. ` +\n\t\t\t\t\t\t\"TCR requires a verified business email domain (not personal/free providers). \" +\n\t\t\t\t\t\t\"Options: 1) Use toll-free numbers (bypasses TCR), \" +\n\t\t\t\t\t\t\"2) Set up Google Workspace/Microsoft 365, \" +\n\t\t\t\t\t\t\"3) See /TELNYX_10DLC_EMAIL_REQUIREMENTS.md\",\n\t\t\t\t\tbrandId,\n\t\t\t\t\tlog,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// Save brand ID even if not approved yet\n\t\t\tawait supabase\n\t\t\t\t.from(\"company_telnyx_settings\")\n\t\t\t\t.update({ ten_dlc_brand_id: brandId })\n\t\t\t\t.eq(\"company_id\", companyId);\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\tbrandApprovalResult.failureReason ||\n\t\t\t\t\t\"Brand created but approval pending. Please check back in a few minutes.\",\n\t\t\t\tbrandId,\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\tlog.push(\"Brand approved\");\n\n\t\t// 5. Create 10DLC Campaign\n\t\tlog.push(\"Creating 10DLC campaign...\");\n\t\tconst campaignPayload: TenDlcCampaignPayload = {\n\t\t\tbrandId: brandId,\n\t\t\tusecase: \"MIXED\", // Mixed use case covers most business needs\n\t\t\tdescription: `Business messaging for ${company.name}`,\n\t\t\tmessageFlow:\n\t\t\t\t\"Customers opt-in when providing phone number. Messages sent for appointments, invoices, and general updates.\",\n\t\t\thelpMessage: \"Reply HELP for assistance or call us.\",\n\t\t\thelpKeywords: \"HELP\",\n\t\t\toptinKeywords: \"START YES SUBSCRIBE\",\n\t\t\toptinMessage:\n\t\t\t\t\"You are now subscribed to messages from \" +\n\t\t\t\tcompany.name +\n\t\t\t\t\". Reply STOP to unsubscribe.\",\n\t\t\toptoutKeywords: \"STOP END UNSUBSCRIBE CANCEL QUIT\",\n\t\t\toptoutMessage:\n\t\t\t\t\"You have been unsubscribed from \" +\n\t\t\t\tcompany.name +\n\t\t\t\t\" messages. Reply START to resubscribe.\",\n\t\t\tsample1: \"Your appointment is confirmed for tomorrow at 2 PM.\",\n\t\t\tsample2: \"Thank you for your payment. Receipt: #12345\",\n\t\t\tsample3: \"Reminder: Service scheduled for next week.\",\n\t\t\tautoRenewal: true,\n\t\t\ttermsAndConditions: true,\n\t\t\ttermsAndConditionsLink: company.website\n\t\t\t\t? `${company.website}/terms`\n\t\t\t\t: \"https://stratos.thorbis.com/terms\",\n\t\t\tsubscriberHelp: true,\n\t\t\tsubscriberOptin: true,\n\t\t\tsubscriberOptout: true,\n\t\t};\n\n\t\tconst campaignResult = await createTenDlcCampaign(campaignPayload);\n\n\t\tif (!campaignResult.success || !campaignResult.data?.campaignId) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Failed to create 10DLC campaign: ${campaignResult.error}`,\n\t\t\t\tbrandId,\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\tconst campaignId = campaignResult.data.campaignId;\n\t\tlog.push(`Campaign created: ${campaignId}`);\n\n\t\t// 6. Poll campaign status\n\t\tlog.push(\"Waiting for campaign approval...\");\n\t\tconst campaignApprovalResult = await pollForApproval(\n\t\t\t() => getTenDlcCampaign(campaignId),\n\t\t\t60,\n\t\t);\n\n\t\tif (!campaignApprovalResult.approved) {\n\t\t\tlog.push(\n\t\t\t\t`Campaign approval failed: ${campaignApprovalResult.failureReason || \"Unknown reason\"}`,\n\t\t\t);\n\t\t\tawait supabase\n\t\t\t\t.from(\"company_telnyx_settings\")\n\t\t\t\t.update({\n\t\t\t\t\tten_dlc_brand_id: brandId,\n\t\t\t\t\tten_dlc_campaign_id: campaignId,\n\t\t\t\t})\n\t\t\t\t.eq(\"company_id\", companyId);\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\tcampaignApprovalResult.failureReason ||\n\t\t\t\t\t\"Campaign created but approval pending. Please check back in a few minutes.\",\n\t\t\t\tbrandId,\n\t\t\t\tcampaignId,\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\tlog.push(\"Campaign approved\");\n\n\t\t// 7. Attach all company phone numbers to campaign\n\t\tlog.push(\"Attaching phone numbers to campaign...\");\n\t\tconst { data: phoneNumbers } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"phone_number\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"active\");\n\n\t\tlet attachedCount = 0;\n\t\tfor (const phone of phoneNumbers || []) {\n\t\t\tconst attachResult = await attachNumberToCampaign(\n\t\t\t\tcampaignId,\n\t\t\t\tphone.phone_number,\n\t\t\t);\n\n\t\t\tif (attachResult.success) {\n\t\t\t\tattachedCount++;\n\t\t\t} else {\n\t\t\t\tlog.push(\n\t\t\t\t\t`Failed to attach ${phone.phone_number}: ${attachResult.error}`,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tlog.push(`Attached ${attachedCount} phone numbers to campaign`);\n\n\t\t// 8. Update company settings\n\t\tlog.push(\"Updating company Telnyx settings...\");\n\t\tawait supabase\n\t\t\t.from(\"company_telnyx_settings\")\n\t\t\t.update({\n\t\t\t\tten_dlc_brand_id: brandId,\n\t\t\t\tten_dlc_campaign_id: campaignId,\n\t\t\t})\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tbrandId,\n\t\t\tcampaignId,\n\t\t\tlog,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\tlog,\n\t\t};\n\t}\n}\n\n/**\n * Poll approval status until approved or timeout\n */\nasync function pollForApproval(\n\tfetcher: () => Promise<{\n\t\tsuccess: boolean;\n\t\tdata?: {\n\t\t\tstatus: string;\n\t\t\tfailureReasons?: Array<{ fields: string[]; description: string }>;\n\t\t};\n\t}>,\n\tmaxSeconds: number,\n): Promise<{ approved: boolean; failureReason?: string }> {\n\tconst startTime = Date.now();\n\tconst pollInterval = 5000; // 5 seconds\n\n\twhile (Date.now() - startTime < maxSeconds * 1000) {\n\t\tconst result = await fetcher();\n\n\t\tif (!result.success || !result.data) {\n\t\t\treturn { approved: false, failureReason: \"Failed to fetch status\" };\n\t\t}\n\n\t\tconst status = result.data.status.toLowerCase();\n\n\t\tif (status === \"approved\" || status === \"active\") {\n\t\t\treturn { approved: true };\n\t\t}\n\n\t\tif (\n\t\t\tstatus === \"rejected\" ||\n\t\t\tstatus === \"failed\" ||\n\t\t\tstatus === \"registration_failed\"\n\t\t) {\n\t\t\t// Extract failure reason from response\n\t\t\tconst failureReason =\n\t\t\t\tresult.data.failureReasons?.[0]?.description ||\n\t\t\t\t`Registration ${status}`;\n\t\t\treturn { approved: false, failureReason };\n\t\t}\n\n\t\t// Wait before polling again\n\t\tawait new Promise((resolve) => setTimeout(resolve, pollInterval));\n\t}\n\n\treturn { approved: false, failureReason: \"Timeout waiting for approval\" };\n}\n\n/**\n * Map business type to 10DLC vertical\n */\nfunction determineVertical(businessType?: string | null): string {\n\tif (!businessType) return \"PROFESSIONAL\";\n\n\tconst type = businessType.toLowerCase();\n\n\t// Map to Telnyx's exact vertical values\n\t// Valid values from error: AGRICULTURE, COMMUNICATION, CONSTRUCTION, EDUCATION,\n\t// ENERGY, ENTERTAINMENT, FINANCIAL, GAMBLING, GOVERNMENT, HEALTHCARE, HOSPITALITY,\n\t// HUMAN_RESOURCES, INSURANCE, LEGAL, MANUFACTURING, NGO, POLITICAL, POSTAL,\n\t// PROFESSIONAL, REAL_ESTATE, RETAIL, TECHNOLOGY, TRANSPORTATION\n\n\tif (type.includes(\"healthcare\") || type.includes(\"medical\"))\n\t\treturn \"HEALTHCARE\";\n\tif (type.includes(\"finance\") || type.includes(\"banking\")) return \"FINANCIAL\";\n\tif (type.includes(\"insurance\")) return \"INSURANCE\";\n\tif (type.includes(\"real estate\")) return \"REAL_ESTATE\";\n\tif (type.includes(\"retail\") || type.includes(\"ecommerce\")) return \"RETAIL\";\n\tif (\n\t\ttype.includes(\"hospitality\") ||\n\t\ttype.includes(\"restaurant\") ||\n\t\ttype.includes(\"food\") ||\n\t\ttype.includes(\"hotel\")\n\t)\n\t\treturn \"HOSPITALITY\";\n\tif (type.includes(\"education\")) return \"EDUCATION\";\n\tif (type.includes(\"technology\") || type.includes(\"software\"))\n\t\treturn \"TECHNOLOGY\";\n\tif (\n\t\ttype.includes(\"nonprofit\") ||\n\t\ttype.includes(\"charity\") ||\n\t\ttype.includes(\"ngo\")\n\t)\n\t\treturn \"NGO\";\n\tif (\n\t\ttype.includes(\"construction\") ||\n\t\ttype.includes(\"plumbing\") ||\n\t\ttype.includes(\"hvac\") ||\n\t\ttype.includes(\"electrical\") ||\n\t\ttype.includes(\"contractor\")\n\t)\n\t\treturn \"CONSTRUCTION\";\n\tif (type.includes(\"legal\") || type.includes(\"law\")) return \"LEGAL\";\n\tif (type.includes(\"manufacturing\")) return \"MANUFACTURING\";\n\tif (type.includes(\"transportation\") || type.includes(\"logistics\"))\n\t\treturn \"TRANSPORTATION\";\n\tif (type.includes(\"energy\") || type.includes(\"utilities\")) return \"ENERGY\";\n\tif (type.includes(\"agriculture\") || type.includes(\"farming\"))\n\t\treturn \"AGRICULTURE\";\n\tif (type.includes(\"entertainment\") || type.includes(\"media\"))\n\t\treturn \"ENTERTAINMENT\";\n\n\t// Default for service businesses\n\treturn \"PROFESSIONAL\";\n}\n\n/**\n * Check Telnyx account verification status\n *\n * Returns the current verification level and what's required to proceed\n */\nexport async function checkTelnyxVerificationStatus(): Promise<{\n\tsuccess: boolean;\n\tdata?: VerificationStatus & {\n\t\tnextSteps: Array<{ step: string; action: string; url?: string }>;\n\t\trequirements: {\n\t\t\tlevel1: { required: boolean; items: string[] };\n\t\t\tlevel2: { required: boolean; items: string[] };\n\t\t};\n\t};\n\terror?: string;\n}> {\n\ttry {\n\t\tconst statusResult = await checkAccountVerificationStatus();\n\n\t\tif (!statusResult.success) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: statusResult.error || \"Failed to check verification status\",\n\t\t\t};\n\t\t}\n\n\t\tconst status = statusResult.data!;\n\t\tconst nextSteps = getNextSteps(status);\n\t\tconst requirements = getVerificationRequirements(status.currentLevel);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\t...status,\n\t\t\t\tnextSteps,\n\t\t\t\trequirements,\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to check verification status\",\n\t\t};\n\t}\n}\n\n/**\n * Automatically submit toll-free and 10DLC verification during onboarding\n *\n * This function is called when a company completes Step 4 of onboarding.\n * It automatically submits verification to Telnyx using the company data\n * collected during Step 1 (Company Information).\n *\n * ServiceTitan-style flow: Users never leave the platform or visit Telnyx Portal\n */\nexport async function submitAutomatedVerification(companyId: string): Promise<{\n\tsuccess: boolean;\n\ttollFreeRequestId?: string;\n\tbrandId?: string;\n\tcampaignId?: string;\n\terror?: string;\n\tmessage?: string;\n\tlog?: string[];\n\trequiresPlatformSetup?: boolean;\n}> {\n\tconst supabase = await createClient();\n\tconst log: string[] = [];\n\n\tconst normalizePhone = (value: string | null) => {\n\t\tif (!value) return null;\n\t\tconst digits = value.replace(/\\D/g, \"\");\n\t\tif (!digits) return null;\n\t\tif (digits.length === 10) {\n\t\t\treturn `+1${digits}`;\n\t\t}\n\t\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\t\treturn `+${digits}`;\n\t\t}\n\t\treturn value.startsWith(\"+\") ? value : `+${digits}`;\n\t};\n\n\tif (!supabase) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Failed to create Supabase client\",\n\t\t\tlog,\n\t\t};\n\t}\n\n\ttry {\n\t\t// 1. Fetch company data\n\t\tconst { data: company, error: companyError } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\n\t\t\t\t`\n\t\t\t\tid,\n\t\t\t\tname,\n\t\t\t\tein,\n\t\t\t\twebsite,\n\t\t\t\tindustry,\n\t\t\t\taddress,\n\t\t\t\tcity,\n\t\t\t\tstate,\n\t\t\t\tzip_code,\n\t\t\t\tphone,\n\t\t\t\temail,\n\t\t\t\tsupport_email,\n\t\t\t\tsupport_phone\n\t\t\t`,\n\t\t\t)\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (companyError || !company) {\n\t\t\tlog.push(\"Company lookup failed\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Company not found: ${companyError?.message}`,\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\t\tlog.push(`Company loaded: ${company.name} (${company.id})`);\n\n\t\t// Validate required fields\n\t\tif (!company.ein) {\n\t\t\tlog.push(\"Missing EIN\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company EIN is required for messaging verification. Please add your Tax ID in Step 1.\",\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\tif (\n\t\t\t!company.address ||\n\t\t\t!company.city ||\n\t\t\t!company.state ||\n\t\t\t!company.zip_code\n\t\t) {\n\t\t\tlog.push(\"Incomplete address\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company address is incomplete. Please complete all address fields in Step 1.\",\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\tconst companyPhone = normalizePhone(company.phone || company.support_phone);\n\t\tif (!companyPhone) {\n\t\t\tlog.push(\"Missing company phone\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Company phone number is required for verification.\",\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\t// 2. Get company phone numbers\n\t\tconst { data: phoneNumbers, error: phoneError } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"phone_number, number_type\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"active\");\n\n\t\tif (phoneError || !phoneNumbers || phoneNumbers.length === 0) {\n\t\t\tlog.push(\"No phone numbers found for company\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"No phone numbers found. Please add a phone number before enabling messaging.\",\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\t// Separate toll-free and 10DLC numbers\n\t\tconst tollFreeNumbers = phoneNumbers.filter(\n\t\t\t(p) => p.number_type === \"toll-free\",\n\t\t);\n\t\tconst dlcNumbers = phoneNumbers.filter((p) => p.number_type === \"local\");\n\t\tlog.push(\n\t\t\t`Detected toll-free numbers: ${tollFreeNumbers.length}, 10DLC numbers: ${dlcNumbers.length}`,\n\t\t);\n\n\t\t// If no toll-free numbers, recommend using toll-free for immediate setup\n\t\tif (tollFreeNumbers.length === 0 && dlcNumbers.length > 0) {\n\t\t\tconsole.log(\n\t\t\t\t\"Note: Only local numbers found. Toll-free verification works immediately without Level 2. Consider adding toll-free numbers for faster setup.\",\n\t\t\t);\n\t\t}\n\n\t\tconst contactPhone = companyPhone;\n\t\tconst contactEmail = company.email || company.support_email || null;\n\t\tif (!contactEmail) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"A primary email is required for toll-free verification.\",\n\t\t\t\tlog,\n\t\t\t};\n\t\t}\n\n\t\t// Get company owner's profile for business contact info\n\t\tconst { data: ownerMembership } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"user_id, user_profiles!inner(first_name, last_name)\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"role\", \"owner\")\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.single();\n\n\t\t// Extract owner name, fallback to \"Admin User\" if not found\n\t\tconst ownerProfile = (ownerMembership as any)?.user_profiles;\n\t\tconst businessContactFirstName = ownerProfile?.first_name || \"Admin\";\n\t\tconst businessContactLastName = ownerProfile?.last_name || \"User\";\n\n\t\t// 3. Submit toll-free verification if we have toll-free numbers\n\t\tlet tollFreeRequestId: string | undefined;\n\t\tif (tollFreeNumbers.length > 0) {\n\t\t\tlog.push(\"Preparing toll-free verification payload\");\n\t\t\tconst normalizedWebsite =\n\t\t\t\tcompany.website ||\n\t\t\t\t`https://${company.name.toLowerCase().replace(/\\s+/g, \"\")}.com`;\n\t\t\tconst optInImageUrl = `${normalizedWebsite.replace(/\\/$/, \"\")}/opt-in`;\n\t\t\tconst additionalInfo = `${company.name} sends timely service notifications, scheduling updates, and customer support follow-ups for ${company.industry || \"field service\"} operations.`;\n\t\t\tconst sanitizedEin = company.ein.replace(/[^\\d]/g, \"\");\n\n\t\t\tconst tollFreePayload: TollFreeVerificationPayload = {\n\t\t\t\tbusinessName: company.name,\n\t\t\t\tcorporateWebsite: normalizedWebsite,\n\t\t\t\tbusinessAddr1: company.address,\n\t\t\t\tbusinessCity: company.city,\n\t\t\t\tbusinessState: company.state,\n\t\t\t\tbusinessZip: company.zip_code,\n\t\t\t\tbusinessContactFirstName: businessContactFirstName,\n\t\t\t\tbusinessContactLastName: businessContactLastName,\n\t\t\t\tbusinessContactEmail: contactEmail,\n\t\t\t\tbusinessContactPhone: contactPhone,\n\t\t\t\tphoneNumbers: tollFreeNumbers.map((p) => ({\n\t\t\t\t\tphoneNumber: p.phone_number,\n\t\t\t\t})),\n\t\t\t\tuseCase: \"Customer Support\",\n\t\t\t\tuseCaseSummary: `${company.industry} business communications including appointment reminders, service notifications, and customer support`,\n\t\t\t\tproductionMessageContent: `Hi! This is ${company.name}. Your appointment is scheduled for tomorrow at 10 AM. Reply STOP to opt out.`,\n\t\t\t\tmessageVolume: \"10000\",\n\t\t\t\toptInWorkflow:\n\t\t\t\t\t\"Customers opt-in during service booking and account creation\",\n\t\t\t\toptInWorkflowImageURLs: [\n\t\t\t\t\t{\n\t\t\t\t\t\turl:\n\t\t\t\t\t\t\toptInImageUrl ||\n\t\t\t\t\t\t\t\"https://dummyimage.com/600x400/cccccc/000000&text=Opt-In\",\n\t\t\t\t\t\tdescription: \"Opt-in form screenshot\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\toptInKeywords: \"YES,START\",\n\t\t\t\toptOutKeywords: \"STOP,UNSUBSCRIBE\",\n\t\t\t\toptOutMessage: `You have opted out of ${company.name} messages. Reply START to opt in again.`,\n\t\t\t\thelpKeywords: \"HELP,INFO\",\n\t\t\t\tbusinessRegistrationNumber: sanitizedEin,\n\t\t\t\tbusinessRegistrationType: \"EIN\",\n\t\t\t\tbusinessRegistrationCountry: \"US\",\n\t\t\t\tentityType: \"PRIVATE_PROFIT\",\n\t\t\t\tadditionalInformation: additionalInfo,\n\t\t\t\thelpMessageResponse: `For help, reply HELP or call ${companyPhone}.`,\n\t\t\t\toptInConfirmationResponse: `Thanks for subscribing to ${company.name} updates.`,\n\t\t\t};\n\n\t\t\tlog.push(\"Submitting toll-free verification to Telnyx\");\n\t\t\tconst tollFreeResult = await submitTollFreeVerification(tollFreePayload);\n\n\t\t\tif (!tollFreeResult.success || !tollFreeResult.data) {\n\t\t\t\tlog.push(\n\t\t\t\t\t`Toll-free verification failed: ${tollFreeResult.error || \"unknown\"}`,\n\t\t\t\t);\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Toll-free verification failed: ${tollFreeResult.error}`,\n\t\t\t\t\tlog,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\ttollFreeRequestId = tollFreeResult.data.id;\n\t\t\tlog.push(`Toll-free verification request created: ${tollFreeRequestId}`);\n\n\t\t\t// Save toll-free request ID to database\n\t\t\tawait supabase.from(\"company_telnyx_settings\").upsert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\ttoll_free_verification_request_id: tollFreeRequestId,\n\t\t\t\ttoll_free_verification_status: \"pending\",\n\t\t\t\ttoll_free_verification_submitted_at: new Date().toISOString(),\n\t\t\t});\n\t\t}\n\n\t\t// 4. Submit 10DLC registration if we have regular numbers (OPTIONAL - won't block toll-free)\n\t\tlet brandId: string | undefined;\n\t\tlet campaignId: string | undefined;\n\t\tlet dlcError: string | undefined;\n\n\t\tif (dlcNumbers.length > 0) {\n\t\t\tlog.push(\"Attempting 10DLC registration\");\n\t\t\tconst registrationResult = await registerCompanyFor10DLC(companyId);\n\n\t\t\tif (!registrationResult.success) {\n\t\t\t\t// Check if this is a 403 error (account verification required)\n\t\t\t\tconst is403Error =\n\t\t\t\t\tregistrationResult.error?.includes(\"403\") ||\n\t\t\t\t\tregistrationResult.error?.includes(\"verifications required\");\n\n\t\t\t\tif (is403Error) {\n\t\t\t\t\t// Platform account needs Level 2 verification\n\t\t\t\t\t// Don't fail - just log the error and continue with toll-free\n\t\t\t\t\tdlcError =\n\t\t\t\t\t\t\"10DLC requires Level 2 verification (see /TELNYX_PLATFORM_SETUP.md). Toll-free verification will proceed.\";\n\t\t\t\t\tconsole.warn(dlcError);\n\t\t\t\t\tlog.push(dlcError);\n\n\t\t\t\t\t// If we have toll-free numbers, continue (toll-free works without Level 2)\n\t\t\t\t\t// If we ONLY have local numbers and no toll-free, then fail\n\t\t\t\t\tif (tollFreeNumbers.length === 0) {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\terror:\n\t\t\t\t\t\t\t\t\"Platform setup required: Your Telnyx account needs Level 2 verification to enable 10DLC registration for local numbers. Alternative: Add toll-free numbers which work immediately without Level 2 verification. See /TELNYX_PLATFORM_SETUP.md for details.\",\n\t\t\t\t\t\t\trequiresPlatformSetup: true,\n\t\t\t\t\t\t\tlog,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t// Other error - log but don't fail if we have toll-free\n\t\t\t\t\tdlcError = `10DLC registration failed: ${registrationResult.error}`;\n\t\t\t\t\tconsole.error(dlcError);\n\t\t\t\t\tlog.push(dlcError);\n\n\t\t\t\t\tif (tollFreeNumbers.length === 0) {\n\t\t\t\t\t\t// No toll-free backup - fail\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\terror: dlcError,\n\t\t\t\t\t\t\tlog,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tbrandId = registrationResult.brandId;\n\t\t\t\tcampaignId = registrationResult.campaignId;\n\t\t\t\tlog.push(\n\t\t\t\t\t`10DLC registration completed: brand=${brandId}, campaign=${campaignId}`,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// 5. Send verification submitted email\n\t\t// Note: Don't block the response if email fails - verification was successful\n\t\tif (company.email) {\n\t\t\ttry {\n\t\t\t\tawait sendVerificationSubmittedEmail(companyId, company.email, {\n\t\t\t\t\thasTollFreeNumbers: tollFreeNumbers.length > 0,\n\t\t\t\t\thas10DLCNumbers: dlcNumbers.length > 0,\n\t\t\t\t\ttollFreeCount: tollFreeNumbers.length,\n\t\t\t\t\tdlcCount: dlcNumbers.length,\n\t\t\t\t});\n\t\t\t\tlog.push(\"Verification submitted email sent\");\n\t\t\t} catch (emailError) {\n\t\t\t\t// Log but don't fail - email is non-critical\n\t\t\t\tconsole.error(\"Failed to send verification email:\", emailError);\n\t\t\t\tlog.push(\n\t\t\t\t\t`Failed to send verification email: ${emailError instanceof Error ? emailError.message : emailError}`,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Build success message\n\t\tconst messages: string[] = [];\n\t\tif (tollFreeRequestId) {\n\t\t\tmessages.push(\n\t\t\t\t` Toll-free verification submitted (${tollFreeNumbers.length} number${tollFreeNumbers.length > 1 ? \"s\" : \"\"}) - Approval in 5-7 business days`,\n\t\t\t);\n\t\t}\n\t\tif (brandId && campaignId) {\n\t\t\tmessages.push(\n\t\t\t\t` 10DLC registration completed (${dlcNumbers.length} number${dlcNumbers.length > 1 ? \"s\" : \"\"}) - Active immediately`,\n\t\t\t);\n\t\t}\n\t\tif (dlcError) {\n\t\t\tmessages.push(` ${dlcError}`);\n\t\t}\n\t\tlog.push(...messages);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\ttollFreeRequestId,\n\t\t\tbrandId,\n\t\t\tcampaignId,\n\t\t\tmessage: messages.join(\". \"),\n\t\t\tlog,\n\t\t};\n\t} catch (error) {\n\t\tlog.push(\n\t\t\t`Unhandled verification error: ${error instanceof Error ? error.message : error}`,\n\t\t);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to submit verification\",\n\t\t\tlog,\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1085, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/email-actions.ts"],"sourcesContent":["\"use server\";\n\nimport {\n    archiveAllEmails,\n    getCompanyEmails,\n    getEmailById,\n    getEmailStats,\n    getEmailThreads,\n    markEmailAsRead,\n    type CompanyEmail,\n} from \"@/lib/email/email-service\";\nimport { z } from \"zod\";\n\nconst getEmailsSchema = z.object({\n  limit: z.coerce.number().min(1).max(500).optional().default(50),\n  offset: z.coerce.number().min(0).optional().default(0),\n  type: z.enum([\"sent\", \"received\", \"all\"]).optional().default(\"all\"),\n  inboxType: z.enum([\"personal\", \"company\"]).optional(),\n  folder: z.enum([\"inbox\", \"drafts\", \"sent\", \"archive\", \"snoozed\", \"spam\", \"trash\", \"bin\", \"starred\", \"all\"]).optional(),\n  category: z.enum([\"support\", \"sales\", \"billing\", \"general\"]).optional(),\n  label: z.string().optional(),\n  search: z.string().optional().nullable(),\n  sortBy: z.enum([\"created_at\", \"sent_at\", \"subject\"]).optional().default(\"created_at\"),\n  sortOrder: z.enum([\"asc\", \"desc\"]).optional().default(\"desc\"),\n}).passthrough();\n\nconst getEmailThreadsSchema = z.object({\n  limit: z.number().min(1).max(50).optional().default(20),\n  offset: z.number().min(0).optional().default(0),\n  search: z.string().optional(),\n});\n\nconst markEmailReadSchema = z.object({\n  emailId: z.string().min(1),\n});\n\nexport type GetEmailsInput = z.infer<typeof getEmailsSchema>;\nexport type GetEmailThreadsInput = z.infer<typeof getEmailThreadsSchema>;\nexport type MarkEmailReadInput = z.infer<typeof markEmailReadSchema>;\n\n// Re-export email types from email-service\nexport type { CompanyEmail };\n\nexport type GetEmailsResult = Awaited<ReturnType<typeof getCompanyEmails>>;\nexport type GetEmailThreadsResult = Awaited<ReturnType<typeof getEmailThreads>>;\nexport type GetEmailStatsResult = Awaited<ReturnType<typeof getEmailStats>>;\n\n/**\n * Get emails for the active company\n */\nexport async function getEmailsAction(\n  input: GetEmailsInput\n): Promise<GetEmailsResult> {\n  try {\n    const parseResult = getEmailsSchema.safeParse(input);\n    \n    if (!parseResult.success) {\n      console.error(\" Zod validation error:\", parseResult.error.issues);\n      throw new Error(`Invalid input parameters: ${parseResult.error.issues.map((e) => `${e.path.map(String).join('.')}: ${e.message}`).join(', ')}`);\n    }\n    \n    const validatedInput = parseResult.data;\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    const companyId = await getActiveCompanyId();\n\n    if (!companyId) {\n      throw new Error(\"No active company found\");\n    }\n\n    // Convert null to undefined for search field\n    const sanitizedInput = {\n      ...validatedInput,\n      search: validatedInput.search ?? undefined,\n    };\n    return await getCompanyEmails(companyId, sanitizedInput);\n  } catch (error) {\n    console.error(\" getEmailsAction error:\", error);\n    throw error;\n  }\n}\n\n/**\n * Get email threads for the active company\n */\nasync function getEmailThreadsAction(\n  input: GetEmailThreadsInput\n): Promise<GetEmailThreadsResult> {\n  try {\n    const validatedInput = getEmailThreadsSchema.parse(input);\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    const companyId = await getActiveCompanyId();\n\n    if (!companyId) {\n      throw new Error(\"No active company found\");\n    }\n\n    return await getEmailThreads(companyId, validatedInput);\n  } catch (error) {\n    if (error instanceof z.ZodError) {\n      throw new Error(\"Invalid input parameters\");\n    }\n    throw error;\n  }\n}\n\n/**\n * Get a specific email by ID\n */\nexport async function getEmailByIdAction(emailId: string): Promise<{\n  success: boolean;\n  email?: CompanyEmail;\n  error?: string;\n}> {\n  try {\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    const companyId = await getActiveCompanyId();\n\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const email = await getEmailById(companyId, emailId);\n    \n    if (!email) {\n      return { success: false, error: \"Email not found\" };\n    }\n\n    return { success: true, email };\n  } catch (error) {\n    console.error(\"Error getting email by ID:\", error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\",\n    };\n  }\n}\n\n/**\n * Mark an email as read\n */\nexport async function markEmailAsReadAction(\n  input: MarkEmailReadInput\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    const validatedInput = markEmailReadSchema.parse(input);\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    const companyId = await getActiveCompanyId();\n\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const result = await markEmailAsRead(companyId, validatedInput.emailId);\n    if (!result) {\n      return { success: false, error: \"Failed to mark email as read - check server logs for details\" };\n    }\n    return { success: true };\n  } catch (error) {\n    if (error instanceof z.ZodError) {\n      return { success: false, error: `Invalid input: ${error.issues.map((e: { message: string }) => e.message).join(\", \")}` };\n    }\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n    console.error(\"Error marking email as read:\", error);\n    return { success: false, error: errorMessage };\n  }\n}\n\n/**\n * Get email statistics for the active company\n */\nasync function getEmailStatsAction(): Promise<GetEmailStatsResult> {\n  try {\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    const companyId = await getActiveCompanyId();\n\n    if (!companyId) {\n      throw new Error(\"No active company found\");\n    }\n\n    return await getEmailStats();\n  } catch (error) {\n    console.error(\"Error getting email stats:\", error);\n    return {\n      totalEmails: 0,\n      sentEmails: 0,\n      receivedEmails: 0,\n      unreadEmails: 0,\n      threadsCount: 0,\n    };\n  }\n}\n\n/**\n * Get total unread email count for the active company\n * Used for displaying notification badges in the header\n */\nexport async function getTotalUnreadCountAction(): Promise<{\n  success: boolean;\n  count?: number;\n  error?: string\n}> {\n  try {\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    const companyId = await getActiveCompanyId();\n\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const stats = await getEmailStats();\n    return { success: true, count: stats.unreadEmails };\n  } catch (error) {\n    console.error(\"Error getting unread count:\", error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\"\n    };\n  }\n}\n\n/**\n * Fetch email content from Resend API or update with provided content\n */\nexport async function fetchEmailContentAction(\n  emailId: string,\n  _resendEmailId?: string,\n  providedContent?: { html?: string | null; text?: string | null }\n): Promise<{\n  success: boolean;\n  html?: string | null;\n  text?: string | null;\n  error?: string;\n}> {\n  \"use server\";\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, error: \"Database connection failed\" };\n    }\n\n    let html: string | null = null;\n    let text: string | null = null;\n\n    // If content is provided directly, use it\n    if (providedContent) {\n      html = providedContent.html || null;\n      text = providedContent.text || null;\n    } else {\n      // First, try to get email from database to check for content in metadata\n      const { data: email, error: emailError } = await supabase\n        .from(\"communications\")\n        .select(\"provider_message_id, provider_metadata, body, body_html\")\n        .eq(\"id\", emailId)\n        .eq(\"company_id\", companyId)\n        .single();\n\n      if (emailError) {\n        // Don't return error for PGRST errors that might be expected\n        if (emailError.code === 'PGRST116') {\n          return { success: false, error: \"Email not found in database\" };\n        }\n        return { success: false, error: `Database error: ${emailError.message}` };\n      }\n\n      if (!email) {\n        return { success: false, error: \"Email not found in database\" };\n      }\n\n      // Check if email already has content stored\n      if (email.body_html || email.body) {\n        html = email.body_html || null;\n        text = email.body || null;\n      } else if (email.provider_metadata) {\n        // Try to extract content from provider_metadata\n        const metadata = email.provider_metadata as Record<string, unknown>;\n        \n        // PRIORITY 1: Check webhook_content first (webhook payload - most reliable source)\n        const webhookContent = metadata.webhook_content as Record<string, unknown> | undefined;\n        if (webhookContent) {\n          const htmlValue = webhookContent.html || webhookContent.body_html;\n          const textValue = webhookContent.text || webhookContent.body;\n          \n          if (htmlValue && typeof htmlValue === \"string\") {\n            const content = htmlValue.trim();\n            if (content.length > 0) {\n              html = content;\n            }\n          }\n          if (!html && textValue && typeof textValue === \"string\") {\n            const content = textValue.trim();\n            if (content.length > 0) {\n              text = content;\n            }\n          }\n        }\n\n        // PRIORITY 2: Check full_content (API response) if webhook didn't have content\n        if (!html && !text) {\n          const fullContent = metadata.full_content as Record<string, unknown> | undefined;\n          if (fullContent) {\n            const htmlFields = [\"html\", \"body_html\", \"bodyHtml\"];\n            const textFields = [\"text\", \"body\", \"plain_text\", \"plainText\"];\n\n            // Try HTML fields first\n            for (const field of htmlFields) {\n              if (fullContent[field] && typeof fullContent[field] === \"string\") {\n                const content = (fullContent[field] as string).trim();\n                if (content.length > 0) {\n                  html = content;\n                  break;\n                }\n              }\n            }\n\n            // If no HTML, try text fields\n            if (!html) {\n              for (const field of textFields) {\n                if (fullContent[field] && typeof fullContent[field] === \"string\") {\n                  const content = (fullContent[field] as string).trim();\n                  if (content.length > 0) {\n                    text = content;\n                    break;\n                  }\n                }\n              }\n            }\n          }\n        }\n\n        // PRIORITY 3: Check top-level metadata.data for content (webhook payload structure)\n        if (!html && !text) {\n          const webhookData = metadata.data as Record<string, unknown> | undefined;\n          if (webhookData) {\n            const htmlValue = webhookData.html || webhookData.body_html;\n            const textValue = webhookData.text || webhookData.body;\n            \n            if (htmlValue && typeof htmlValue === \"string\") {\n              const content = htmlValue.trim();\n              if (content.length > 0) {\n                html = content;\n              }\n            }\n            if (!html && textValue && typeof textValue === \"string\") {\n              const content = textValue.trim();\n              if (content.length > 0) {\n                text = content;\n              }\n            }\n          }\n        }\n\n        // PRIORITY 4: Check top-level metadata fields directly\n        if (!html && !text) {\n          const htmlFields = [\"html\", \"body_html\"];\n          const textFields = [\"text\", \"body\"];\n          \n          for (const field of htmlFields) {\n            if (metadata[field] && typeof metadata[field] === \"string\") {\n              const content = (metadata[field] as string).trim();\n              if (content.length > 0) {\n                html = content;\n                break;\n              }\n            }\n          }\n          \n          if (!html) {\n            for (const field of textFields) {\n              if (metadata[field] && typeof metadata[field] === \"string\") {\n                const content = (metadata[field] as string).trim();\n                if (content.length > 0) {\n                  text = content;\n                  break;\n                }\n              }\n            }\n          }\n        }\n\n        // If we found content in metadata, use it and return early\n        if (html || text) {\n          // Update database with extracted content\n          if ((html || text) && supabase) {\n            const { error: updateError } = await supabase\n              .from(\"communications\")\n              .update({\n                body: text || \"\",\n                body_html: html,\n              })\n              .eq(\"id\", emailId)\n              .eq(\"company_id\", companyId);\n\n            if (updateError) {\n              console.warn(\"  Failed to update email content in database:\", updateError.message);\n            }\n          }\n          return { success: true, html, text };\n        } else {\n          // No content found in metadata\n          return {\n            success: false,\n            error: \"No email content available in metadata\"\n          };\n        }\n      } else {\n        // No metadata at all, can't fetch content\n        return { success: false, error: \"No email metadata available\" };\n      }\n    }\n\n    // Update the database with the content\n    // Try to update, but don't fail if the email doesn't exist - we still return the content\n    if (supabase) {\n      const { error: updateError } = await supabase\n        .from(\"communications\")\n        .update({\n          body: text || \"\",\n          body_html: html,\n        })\n        .eq(\"id\", emailId)\n        .eq(\"company_id\", companyId);\n\n      if (updateError) {\n        console.warn(\"  Failed to update email content in database (this is OK, content still returned):\", updateError.message);\n      }\n    }\n\n    return { success: true, html, text };\n  } catch (error) {\n    console.error(\"Error fetching email content:\", error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\",\n    };\n  }\n}\n\n/**\n * Sync inbound email routes from database to Resend\n * Creates routes in Resend that don't have a resend_route_id\n */\nexport async function syncInboundRoutesToResendAction(): Promise<{\n  success: boolean;\n  synced: number;\n  errors: string[];\n}> {\n  \"use server\";\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { createInboundRoute } = await import(\"@/lib/email/resend-domains\");\n    const { createServiceSupabaseClient } = await import(\"@/lib/supabase/service-client\");\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, synced: 0, errors: [\"Database connection failed\"] };\n    }\n\n    const serviceSupabase = await createServiceSupabaseClient();\n    if (!serviceSupabase) {\n      return { success: false, synced: 0, errors: [\"Service database connection failed\"] };\n    }\n\n    // Get all routes that don't have a resend_route_id\n    // Note: This table may not be in the type definitions, so we use type assertion\n    const { data: routes, error } = await (serviceSupabase\n      .from(\"communication_email_inbound_routes\" as any)\n      .select(\"id, company_id, route_address, name, enabled\")\n      .is(\"resend_route_id\", null)\n      .eq(\"enabled\", true) as any);\n\n    if (error) {\n      console.error(\"Failed to fetch routes:\", error);\n      return { success: false, synced: 0, errors: [error.message] };\n    }\n\n    if (!routes || routes.length === 0) {\n      return { success: true, synced: 0, errors: [] };\n    }\n\n    // Construct webhook URL\n    let webhookUrl = process.env.NEXT_PUBLIC_SITE_URL;\n    if (!webhookUrl && process.env.VERCEL_URL) {\n      webhookUrl = `https://${process.env.VERCEL_URL}`;\n    }\n    if (!webhookUrl) {\n      return { success: false, synced: 0, errors: [\"Webhook URL not configured. Set NEXT_PUBLIC_SITE_URL or VERCEL_URL\"] };\n    }\n    webhookUrl = `${webhookUrl}/api/webhooks/resend`;\n\n    const errors: string[] = [];\n    let synced = 0;\n\n    for (const route of (routes || []) as Array<{ id: string; company_id: string; route_address: string; name: string | null; enabled: boolean }>) {\n      try {\n        // Handle catch-all routes (e.g., @biezru.resend.app)\n        // Resend doesn't support true catch-all, so we'll create a route for the domain\n        // For now, we'll skip catch-all routes and handle them differently\n        if (route.route_address.startsWith(\"@\")) {\n          errors.push(`Catch-all routes (${route.route_address}) need to be configured manually in Resend dashboard`);\n          continue;\n        }\n\n        // Create route in Resend\n        const result = await createInboundRoute({\n          name: route.name || `Route for ${route.route_address}`,\n          recipients: [route.route_address],\n          url: webhookUrl,\n        });\n\n        if (!result.success) {\n          console.error(` Failed to create Resend route for ${route.route_address}:`, result.error);\n          errors.push(`${route.route_address}: ${result.error}`);\n          continue;\n        }\n\n        // Update database with resend_route_id\n        const { error: updateError } = await (serviceSupabase\n          .from(\"communication_email_inbound_routes\" as any)\n          .update({\n            resend_route_id: result.data.id,\n            signing_secret: result.data.secret || null,\n            last_synced_at: new Date().toISOString(),\n          })\n          .eq(\"id\", route.id) as any);\n\n        if (updateError) {\n          console.error(` Failed to update route ${route.route_address}:`, updateError);\n          errors.push(`${route.route_address}: Database update failed`);\n          continue;\n        }\n\n        synced++;\n      } catch (error) {\n        console.error(` Error syncing route ${route.route_address}:`, error);\n        errors.push(`${route.route_address}: ${error instanceof Error ? error.message : \"Unknown error\"}`);\n      }\n    }\n\n    return {\n      success: errors.length === 0,\n      synced,\n      errors,\n    };\n  } catch (error) {\n    console.error(\"Error syncing inbound routes:\", error);\n    return {\n      success: false,\n      synced: 0,\n      errors: [error instanceof Error ? error.message : \"Unknown error\"],\n    };\n  }\n}\n\n/**\n * Archive an email\n */\nexport async function archiveEmailAction(emailId: string): Promise<{ success: boolean; error?: string }> {\n  \"use server\";\n  \n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    \n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n    \n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, error: \"Database connection failed\" };\n    }\n    \n    const { error } = await supabase\n      .from(\"communications\")\n      .update({ is_archived: true })\n      .eq(\"id\", emailId)\n      .eq(\"company_id\", companyId)\n      .eq(\"type\", \"email\");\n    \n    if (error) {\n      return { success: false, error: error.message };\n    }\n    \n    return { success: true };\n  } catch (error) {\n    return { success: false, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}\n\n/**\n * Bulk archive multiple emails by their IDs\n */\nexport async function bulkArchiveEmailsAction(emailIds: string[]): Promise<{\n  success: boolean;\n  archived: number;\n  error?: string\n}> {\n  \"use server\";\n\n  if (!emailIds || emailIds.length === 0) {\n    return { success: false, archived: 0, error: \"No email IDs provided\" };\n  }\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, archived: 0, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, archived: 0, error: \"Database connection failed\" };\n    }\n\n    const { data, error } = await supabase\n      .from(\"communications\")\n      .update({ is_archived: true })\n      .in(\"id\", emailIds)\n      .eq(\"company_id\", companyId)\n      .eq(\"type\", \"email\")\n      .select(\"id\");\n\n    if (error) {\n      return { success: false, archived: 0, error: error.message };\n    }\n\n    const archivedCount = data?.length ?? 0;\n    return { success: true, archived: archivedCount };\n  } catch (error) {\n    return { success: false, archived: 0, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}\n\n/**\n * Archive all emails in a folder\n */\nexport async function archiveAllEmailsAction(folder?: string): Promise<{ \n  success: boolean; \n  archived: number;\n  error?: string \n}> {\n  \"use server\";\n  \n  try {\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    \n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, archived: 0, error: \"No active company found\" };\n    }\n    \n    const result = await archiveAllEmails(companyId, folder);\n    \n    if (!result.success) {\n      return { success: false, archived: 0, error: result.error };\n    }\n    \n    return { success: true, archived: result.count };\n  } catch (error) {\n    return {\n      success: false,\n      archived: 0,\n      error: error instanceof Error ? error.message : \"Unknown error\"\n    };\n  }\n}\n\n/**\n * Get email folder counts for the active company\n * Returns count of emails in each folder (inbox, sent, drafts, etc.)\n */\nexport async function getEmailFolderCountsAction(): Promise<{\n  success: boolean;\n  counts?: {\n    all: number;\n    inbox: number;\n    drafts: number;\n    sent: number;\n    archive: number;\n    snoozed: number;\n    spam: number;\n    trash: number;\n    starred: number;\n    [key: string]: number;\n  };\n  error?: string;\n}> {\n  \"use server\";\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, error: \"Database connection failed\" };\n    }\n\n    // Get counts for each folder type using parallel queries\n    // All counts show UNREAD emails only (read_at IS NULL)\n    const [\n      allResult,\n      inboxResult,\n      draftsResult,\n      sentResult,\n      archiveResult,\n      snoozedResult,\n      spamResult,\n      trashResult,\n      starredResult\n    ] = await Promise.all([\n      // All Mail: all non-deleted, unread emails\n      supabase\n        .from(\"communications\")\n        .select(\"*\", { count: \"exact\", head: true })\n        .eq(\"company_id\", companyId)\n        .eq(\"type\", \"email\")\n        .is(\"deleted_at\", null)\n        .is(\"read_at\", null),\n\n      // Inbox: inbound, not archived, not deleted, not draft, not spam, unread\n      supabase\n        .from(\"communications\")\n        .select(\"*\", { count: \"exact\", head: true })\n        .eq(\"company_id\", companyId)\n        .eq(\"type\", \"email\")\n        .eq(\"direction\", \"inbound\")\n        .eq(\"is_archived\", false)\n        .is(\"deleted_at\", null)\n        .is(\"read_at\", null)\n        .neq(\"status\", \"draft\")\n        .or(\"category.is.null,category.neq.spam\")\n        .or(\"snoozed_until.is.null,snoozed_until.lt.now()\"),\n\n      // Drafts - always count all drafts (read_at not relevant for drafts)\n      supabase\n        .from(\"communications\")\n        .select(\"*\", { count: \"exact\", head: true })\n        .eq(\"company_id\", companyId)\n        .eq(\"type\", \"email\")\n        .eq(\"status\", \"draft\")\n        .is(\"deleted_at\", null),\n\n      // Sent: outbound, not archived, not deleted, unread\n      supabase\n        .from(\"communications\")\n        .select(\"*\", { count: \"exact\", head: true })\n        .eq(\"company_id\", companyId)\n        .eq(\"type\", \"email\")\n        .eq(\"direction\", \"outbound\")\n        .eq(\"is_archived\", false)\n        .is(\"deleted_at\", null)\n        .is(\"read_at\", null)\n        .neq(\"status\", \"draft\"),\n\n      // Archive - unread archived emails\n      supabase\n        .from(\"communications\")\n        .select(\"*\", { count: \"exact\", head: true })\n        .eq(\"company_id\", companyId)\n        .eq(\"type\", \"email\")\n        .eq(\"is_archived\", true)\n        .is(\"deleted_at\", null)\n        .is(\"read_at\", null),\n\n      // Snoozed - unread snoozed emails\n      supabase\n        .from(\"communications\")\n        .select(\"*\", { count: \"exact\", head: true })\n        .eq(\"company_id\", companyId)\n        .eq(\"type\", \"email\")\n        .not(\"snoozed_until\", \"is\", null)\n        .gt(\"snoozed_until\", new Date().toISOString())\n        .is(\"deleted_at\", null)\n        .is(\"read_at\", null),\n\n      // Spam - fetch category, tags, and read_at to count unread spam\n      supabase\n        .from(\"communications\")\n        .select(\"category, tags, read_at\")\n        .eq(\"company_id\", companyId)\n        .eq(\"type\", \"email\")\n        .is(\"deleted_at\", null)\n        .is(\"read_at\", null),\n\n      // Trash - unread deleted emails\n      supabase\n        .from(\"communications\")\n        .select(\"*\", { count: \"exact\", head: true })\n        .eq(\"company_id\", companyId)\n        .eq(\"type\", \"email\")\n        .not(\"deleted_at\", \"is\", null)\n        .is(\"read_at\", null),\n\n      // Starred - fetch tags and read_at, count unread starred in memory\n      supabase\n        .from(\"communications\")\n        .select(\"tags, read_at\")\n        .eq(\"company_id\", companyId)\n        .eq(\"type\", \"email\")\n        .is(\"deleted_at\", null)\n        .is(\"read_at\", null),\n    ]);\n\n    // Count spam emails in memory (category=spam OR spam tag)\n    const spamCount = (spamResult.data ?? []).filter(email => {\n      const tags = email.tags as string[] | null;\n      const hasSpamTag = Array.isArray(tags) && tags.includes(\"spam\");\n      return email.category === \"spam\" || hasSpamTag;\n    }).length;\n\n    // Count starred emails in memory\n    const starredCount = (starredResult.data ?? []).filter(email => {\n      const tags = email.tags as string[] | null;\n      return Array.isArray(tags) && tags.includes(\"starred\");\n    }).length;\n\n    return {\n      success: true,\n      counts: {\n        all: allResult.count ?? 0,\n        inbox: inboxResult.count ?? 0,\n        drafts: draftsResult.count ?? 0,\n        sent: sentResult.count ?? 0,\n        archive: archiveResult.count ?? 0,\n        snoozed: snoozedResult.count ?? 0,\n        spam: spamCount,\n        trash: trashResult.count ?? 0,\n        starred: starredCount,\n      },\n    };\n  } catch (error) {\n    console.error(\"Error getting email folder counts:\", error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\",\n    };\n  }\n}\n\n/**\n * Toggle star status on an email\n * Adds or removes \"starred\" tag from the email's tags array\n */\nexport async function toggleStarEmailAction(emailId: string): Promise<{\n  success: boolean;\n  isStarred?: boolean;\n  error?: string\n}> {\n  \"use server\";\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, error: \"Database connection failed\" };\n    }\n\n    // First, get current tags\n    const { data: email, error: fetchError } = await supabase\n      .from(\"communications\")\n      .select(\"tags\")\n      .eq(\"id\", emailId)\n      .eq(\"company_id\", companyId)\n      .eq(\"type\", \"email\")\n      .single();\n\n    if (fetchError) {\n      return { success: false, error: fetchError.message };\n    }\n\n    const currentTags = (email?.tags as string[]) || [];\n    const isCurrentlyStarred = currentTags.includes(\"starred\");\n\n    // Toggle the starred tag\n    const newTags = isCurrentlyStarred\n      ? currentTags.filter(tag => tag !== \"starred\")\n      : [...currentTags, \"starred\"];\n\n    // Update the email\n    const { error: updateError } = await supabase\n      .from(\"communications\")\n      .update({ tags: newTags.length > 0 ? newTags : null })\n      .eq(\"id\", emailId)\n      .eq(\"company_id\", companyId)\n      .eq(\"type\", \"email\");\n\n    if (updateError) {\n      return { success: false, error: updateError.message };\n    }\n\n    return { success: true, isStarred: !isCurrentlyStarred };\n  } catch (error) {\n    console.error(\"Error toggling star on email:\", error);\n    return { success: false, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}\n\n/**\n * Toggle spam status on an email\n * Adds or removes \"spam\" tag and updates category field\n */\nexport async function toggleSpamEmailAction(emailId: string): Promise<{\n  success: boolean;\n  isSpam?: boolean;\n  error?: string\n}> {\n  \"use server\";\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, error: \"Database connection failed\" };\n    }\n\n    // First, get current tags and category\n    const { data: email, error: fetchError } = await supabase\n      .from(\"communications\")\n      .select(\"tags, category\")\n      .eq(\"id\", emailId)\n      .eq(\"company_id\", companyId)\n      .eq(\"type\", \"email\")\n      .single();\n\n    if (fetchError) {\n      return { success: false, error: fetchError.message };\n    }\n\n    const currentTags = (email?.tags as string[]) || [];\n    const isCurrentlySpam = currentTags.includes(\"spam\") || email?.category === \"spam\";\n\n    // Toggle the spam tag and category\n    const newTags = isCurrentlySpam\n      ? currentTags.filter(tag => tag !== \"spam\")\n      : [...currentTags, \"spam\"];\n\n    const newCategory = isCurrentlySpam ? null : \"spam\";\n\n    // Update the email\n    const { error: updateError } = await supabase\n      .from(\"communications\")\n      .update({\n        tags: newTags.length > 0 ? newTags : null,\n        category: newCategory\n      })\n      .eq(\"id\", emailId)\n      .eq(\"company_id\", companyId)\n      .eq(\"type\", \"email\");\n\n    if (updateError) {\n      return { success: false, error: updateError.message };\n    }\n\n    return { success: true, isSpam: !isCurrentlySpam };\n  } catch (error) {\n    console.error(\"Error toggling spam on email:\", error);\n    return { success: false, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}\n\n/**\n * Snooze an email until a specific time\n * The email will reappear in inbox after the snooze time\n */\nexport async function snoozeEmailAction(\n  emailId: string,\n  snoozeUntil: string | null\n): Promise<{\n  success: boolean;\n  snoozedUntil?: string | null;\n  error?: string;\n}> {\n  \"use server\";\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, error: \"Database connection failed\" };\n    }\n\n    // Update the snoozed_until field\n    const { error: updateError } = await supabase\n      .from(\"communications\")\n      .update({ snoozed_until: snoozeUntil })\n      .eq(\"id\", emailId)\n      .eq(\"company_id\", companyId)\n      .eq(\"type\", \"email\");\n\n    if (updateError) {\n      return { success: false, error: updateError.message };\n    }\n\n    return { success: true, snoozedUntil: snoozeUntil };\n  } catch (error) {\n    console.error(\"Error snoozing email:\", error);\n    return { success: false, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}\n\n/**\n * Unsnooze an email (remove snooze time)\n */\nexport async function unsnoozeEmailAction(emailId: string): Promise<{\n  success: boolean;\n  error?: string;\n}> {\n  return snoozeEmailAction(emailId, null);\n}\n\n/**\n * Bulk mark emails as read or unread\n */\nexport async function bulkMarkReadUnreadAction(\n  emailIds: string[],\n  markAsRead: boolean\n): Promise<{\n  success: boolean;\n  updated: number;\n  error?: string;\n}> {\n  \"use server\";\n\n  if (!emailIds || emailIds.length === 0) {\n    return { success: false, updated: 0, error: \"No IDs provided\" };\n  }\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, updated: 0, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, updated: 0, error: \"Database connection failed\" };\n    }\n\n    const { data, error } = await supabase\n      .from(\"communications\")\n      .update({ read_at: markAsRead ? new Date().toISOString() : null })\n      .in(\"id\", emailIds)\n      .eq(\"company_id\", companyId)\n      .eq(\"type\", \"email\")\n      .select(\"id\");\n\n    if (error) {\n      return { success: false, updated: 0, error: error.message };\n    }\n\n    // Dispatch event to refresh counts\n    return { success: true, updated: data?.length ?? 0 };\n  } catch (error) {\n    console.error(\"Error bulk marking emails:\", error);\n    return { success: false, updated: 0, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}\n\n/**\n * Bulk toggle star on emails\n */\nexport async function bulkStarEmailsAction(\n  emailIds: string[],\n  addStar: boolean\n): Promise<{\n  success: boolean;\n  updated: number;\n  error?: string;\n}> {\n  \"use server\";\n\n  if (!emailIds || emailIds.length === 0) {\n    return { success: false, updated: 0, error: \"No IDs provided\" };\n  }\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, updated: 0, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, updated: 0, error: \"Database connection failed\" };\n    }\n\n    // OPTIMIZED: Batch fetch all emails in ONE query (was N queries)\n    const { data: emails } = await supabase\n      .from(\"communications\")\n      .select(\"id, tags\")\n      .in(\"id\", emailIds)\n      .eq(\"company_id\", companyId);\n\n    if (!emails || emails.length === 0) {\n      return { success: true, updated: 0 };\n    }\n\n    // Group emails by what changes need to be made\n    const toUpdate: Array<{ id: string; newTags: string[] | null }> = [];\n\n    for (const email of emails) {\n      const currentTags = (email.tags as string[]) || [];\n      const hasStarred = currentTags.includes(\"starred\");\n\n      let newTags: string[];\n      if (addStar && !hasStarred) {\n        newTags = [...currentTags, \"starred\"];\n      } else if (!addStar && hasStarred) {\n        newTags = currentTags.filter((t) => t !== \"starred\");\n      } else {\n        continue; // No change needed\n      }\n\n      toUpdate.push({ id: email.id, newTags: newTags.length > 0 ? newTags : null });\n    }\n\n    if (toUpdate.length === 0) {\n      return { success: true, updated: 0 };\n    }\n\n    // Batch update using Promise.all (parallel updates)\n    const results = await Promise.all(\n      toUpdate.map(({ id, newTags }) =>\n        supabase\n          .from(\"communications\")\n          .update({ tags: newTags })\n          .eq(\"id\", id)\n          .eq(\"company_id\", companyId)\n      )\n    );\n\n    const updatedCount = results.filter((r) => !r.error).length;\n    return { success: true, updated: updatedCount };\n  } catch (error) {\n    console.error(\"Error bulk starring emails:\", error);\n    return { success: false, updated: 0, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}\n\n/**\n * Bulk delete emails (move to trash)\n */\nexport async function bulkDeleteEmailsAction(emailIds: string[]): Promise<{\n  success: boolean;\n  deleted: number;\n  error?: string;\n}> {\n  \"use server\";\n\n  if (!emailIds || emailIds.length === 0) {\n    return { success: false, deleted: 0, error: \"No IDs provided\" };\n  }\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, deleted: 0, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, deleted: 0, error: \"Database connection failed\" };\n    }\n\n    // Soft delete by setting deleted_at\n    const { data, error } = await supabase\n      .from(\"communications\")\n      .update({ deleted_at: new Date().toISOString() })\n      .in(\"id\", emailIds)\n      .eq(\"company_id\", companyId)\n      .eq(\"type\", \"email\")\n      .select(\"id\");\n\n    if (error) {\n      return { success: false, deleted: 0, error: error.message };\n    }\n\n    return { success: true, deleted: data?.length ?? 0 };\n  } catch (error) {\n    console.error(\"Error bulk deleting emails:\", error);\n    return { success: false, deleted: 0, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}\n\n/**\n * Bulk move emails to spam\n */\nexport async function bulkMoveToSpamAction(emailIds: string[]): Promise<{\n  success: boolean;\n  moved: number;\n  error?: string;\n}> {\n  \"use server\";\n\n  if (!emailIds || emailIds.length === 0) {\n    return { success: false, moved: 0, error: \"No IDs provided\" };\n  }\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, moved: 0, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, moved: 0, error: \"Database connection failed\" };\n    }\n\n    // OPTIMIZED: Batch fetch all emails in ONE query (was N queries)\n    const { data: emails } = await supabase\n      .from(\"communications\")\n      .select(\"id, tags\")\n      .in(\"id\", emailIds)\n      .eq(\"company_id\", companyId);\n\n    if (!emails || emails.length === 0) {\n      return { success: true, moved: 0 };\n    }\n\n    // Prepare updates with new tags\n    const updates = emails.map((email) => {\n      const currentTags = (email.tags as string[]) || [];\n      const newTags = currentTags.includes(\"spam\")\n        ? currentTags\n        : [...currentTags, \"spam\"];\n      return { id: email.id, newTags };\n    });\n\n    // Batch update using Promise.all (parallel updates)\n    const results = await Promise.all(\n      updates.map(({ id, newTags }) =>\n        supabase\n          .from(\"communications\")\n          .update({ category: \"spam\", tags: newTags })\n          .eq(\"id\", id)\n          .eq(\"company_id\", companyId)\n      )\n    );\n\n    const movedCount = results.filter((r) => !r.error).length;\n    return { success: true, moved: movedCount };\n  } catch (error) {\n    console.error(\"Error moving emails to spam:\", error);\n    return { success: false, moved: 0, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}\n\n// ============================================================================\n// DRAFT ACTIONS\n// ============================================================================\n\nconst saveDraftSchema = z.object({\n  id: z.string().uuid().optional(), // If provided, update existing draft\n  to: z.array(z.string().email()).optional().default([]),\n  cc: z.array(z.string().email()).optional().default([]),\n  bcc: z.array(z.string().email()).optional().default([]),\n  subject: z.string().optional().default(\"\"),\n  body: z.string().optional().default(\"\"),\n  bodyHtml: z.string().optional(),\n  customerId: z.string().uuid().optional(),\n  attachments: z.array(z.object({\n    filename: z.string(),\n    content: z.string(),\n    contentType: z.string().optional(),\n  })).optional(),\n});\n\nexport type SaveDraftInput = z.infer<typeof saveDraftSchema>;\n\n/**\n * Save or update an email draft\n * If id is provided, updates existing draft; otherwise creates a new one\n */\nexport async function saveDraftAction(input: SaveDraftInput): Promise<{\n  success: boolean;\n  draftId?: string;\n  error?: string;\n}> {\n  \"use server\";\n\n  try {\n    const parseResult = saveDraftSchema.safeParse(input);\n    if (!parseResult.success) {\n      return { success: false, error: `Invalid input: ${parseResult.error.message}` };\n    }\n\n    const { id, to, cc, bcc, subject, body, bodyHtml, customerId, attachments } = parseResult.data;\n\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, error: \"Database connection failed\" };\n    }\n\n    // Get the company's default email address for from_address\n    const { data: companySettings } = await supabase\n      .from(\"company_communication_settings\")\n      .select(\"email_from_address, email_from_name\")\n      .eq(\"company_id\", companyId)\n      .single();\n\n    const fromAddress = companySettings?.email_from_address || \"noreply@example.com\";\n    const fromName = companySettings?.email_from_name || \"Draft\";\n\n    const draftData = {\n      company_id: companyId,\n      customer_id: customerId || null,\n      type: \"email\" as const,\n      direction: \"outbound\" as const,\n      from_address: fromAddress,\n      from_name: fromName,\n      to_address: to.length > 0 ? to.join(\", \") : \"draft@placeholder.local\",\n      cc_address: cc.length > 0 ? cc.join(\", \") : null,\n      bcc_address: bcc.length > 0 ? bcc.join(\", \") : null,\n      subject: subject || \"(No subject)\",\n      body: body || \"\",\n      body_html: bodyHtml || null,\n      attachments: attachments && attachments.length > 0 ? attachments : null,\n      attachment_count: attachments?.length || 0,\n      status: \"draft\" as const,\n      is_automated: false,\n      is_internal: false,\n      is_archived: false,\n      is_thread_starter: true,\n      priority: \"normal\" as const,\n      updated_at: new Date().toISOString(),\n    };\n\n    if (id) {\n      // Update existing draft\n      const { error: updateError } = await supabase\n        .from(\"communications\")\n        .update(draftData)\n        .eq(\"id\", id)\n        .eq(\"company_id\", companyId)\n        .eq(\"status\", \"draft\");\n\n      if (updateError) {\n        console.error(\"Error updating draft:\", updateError);\n        return { success: false, error: updateError.message };\n      }\n\n      return { success: true, draftId: id };\n    } else {\n      // Create new draft\n      const { data: newDraft, error: insertError } = await supabase\n        .from(\"communications\")\n        .insert({\n          ...draftData,\n          created_at: new Date().toISOString(),\n        })\n        .select(\"id\")\n        .single();\n\n      if (insertError) {\n        console.error(\"Error creating draft:\", insertError);\n        return { success: false, error: insertError.message };\n      }\n\n      return { success: true, draftId: newDraft.id };\n    }\n  } catch (error) {\n    console.error(\"Error saving draft:\", error);\n    return { success: false, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}\n\n/**\n * Get a draft by ID\n */\nexport async function getDraftAction(draftId: string): Promise<{\n  success: boolean;\n  draft?: {\n    id: string;\n    to: string[];\n    cc: string[];\n    bcc: string[];\n    subject: string;\n    body: string;\n    bodyHtml?: string | null;\n    customerId?: string | null;\n    attachments?: Array<{ filename: string; content: string; contentType?: string }> | null;\n    updatedAt: string;\n  };\n  error?: string;\n}> {\n  \"use server\";\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, error: \"Database connection failed\" };\n    }\n\n    const { data: draft, error: fetchError } = await supabase\n      .from(\"communications\")\n      .select(\"id, to_address, cc_address, bcc_address, subject, body, body_html, customer_id, attachments, updated_at\")\n      .eq(\"id\", draftId)\n      .eq(\"company_id\", companyId)\n      .eq(\"status\", \"draft\")\n      .single();\n\n    if (fetchError) {\n      return { success: false, error: fetchError.message };\n    }\n\n    if (!draft) {\n      return { success: false, error: \"Draft not found\" };\n    }\n\n    // Parse addresses from comma-separated strings to arrays\n    const parseAddresses = (addr: string | null): string[] => {\n      if (!addr || addr === \"draft@placeholder.local\") return [];\n      return addr.split(\",\").map(a => a.trim()).filter(Boolean);\n    };\n\n    return {\n      success: true,\n      draft: {\n        id: draft.id,\n        to: parseAddresses(draft.to_address),\n        cc: parseAddresses(draft.cc_address),\n        bcc: parseAddresses(draft.bcc_address),\n        subject: draft.subject === \"(No subject)\" ? \"\" : (draft.subject || \"\"),\n        body: draft.body || \"\",\n        bodyHtml: draft.body_html,\n        customerId: draft.customer_id,\n        attachments: draft.attachments as Array<{ filename: string; content: string; contentType?: string }> | null,\n        updatedAt: draft.updated_at,\n      },\n    };\n  } catch (error) {\n    console.error(\"Error getting draft:\", error);\n    return { success: false, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}\n\n/**\n * Delete a draft\n */\nexport async function deleteDraftAction(draftId: string): Promise<{\n  success: boolean;\n  error?: string;\n}> {\n  \"use server\";\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, error: \"Database connection failed\" };\n    }\n\n    // Hard delete drafts (they don't need to go to trash)\n    const { error: deleteError } = await supabase\n      .from(\"communications\")\n      .delete()\n      .eq(\"id\", draftId)\n      .eq(\"company_id\", companyId)\n      .eq(\"status\", \"draft\");\n\n    if (deleteError) {\n      return { success: false, error: deleteError.message };\n    }\n\n    return { success: true };\n  } catch (error) {\n    console.error(\"Error deleting draft:\", error);\n    return { success: false, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}\n\n// ============================================================================\n// RETRY ACTIONS\n// ============================================================================\n\n/**\n * Retry sending a failed email\n * Fetches the failed email, resets its status, and attempts to resend\n */\nexport async function retryFailedEmailAction(emailId: string): Promise<{\n  success: boolean;\n  error?: string;\n}> {\n  \"use server\";\n\n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    const { sendEmail } = await import(\"@/lib/email/email-sender\");\n    const { PlainTextEmail } = await import(\"@/emails/plain-text-email\");\n\n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, error: \"Database connection failed\" };\n    }\n\n    // Get the failed email\n    const { data: email, error: fetchError } = await supabase\n      .from(\"communications\")\n      .select(\"*\")\n      .eq(\"id\", emailId)\n      .eq(\"company_id\", companyId)\n      .eq(\"type\", \"email\")\n      .eq(\"status\", \"failed\")\n      .single();\n\n    if (fetchError) {\n      return { success: false, error: fetchError.message };\n    }\n\n    if (!email) {\n      return { success: false, error: \"Failed email not found\" };\n    }\n\n    // Reset status to queued\n    const { error: updateError } = await supabase\n      .from(\"communications\")\n      .update({\n        status: \"queued\",\n        failure_reason: null,\n      })\n      .eq(\"id\", emailId)\n      .eq(\"company_id\", companyId);\n\n    if (updateError) {\n      return { success: false, error: `Failed to reset email status: ${updateError.message}` };\n    }\n\n    // Parse recipients\n    const parseAddresses = (addr: string | null): string | string[] => {\n      if (!addr) return [];\n      const addresses = addr.split(\",\").map(a => a.trim()).filter(Boolean);\n      return addresses.length === 1 ? addresses[0] : addresses;\n    };\n\n    const to = parseAddresses(email.to_address);\n    const cc = parseAddresses(email.cc_address);\n    const bcc = parseAddresses(email.bcc_address);\n\n    // Get attachments from metadata if stored (for scheduled emails)\n    const metadata = email.provider_metadata as Record<string, unknown> | null;\n    const attachments = metadata?.scheduled_attachments as Array<{\n      filename: string;\n      content: string;\n      contentType?: string;\n    }> | undefined;\n\n    // Attempt to resend\n    const sendResult = await sendEmail({\n      to,\n      subject: email.subject || \"(No subject)\",\n      template: PlainTextEmail({ message: email.body || \"\" }),\n      templateType: \"generic\" as any,\n      companyId,\n      communicationId: emailId,\n      cc: cc.length > 0 ? cc : undefined,\n      bcc: bcc.length > 0 ? bcc : undefined,\n      attachments,\n    });\n\n    if (!sendResult.success) {\n      // Update status back to failed\n      await supabase\n        .from(\"communications\")\n        .update({\n          status: \"failed\",\n          failure_reason: sendResult.error || \"Email send failed on retry\",\n        })\n        .eq(\"id\", emailId)\n        .eq(\"company_id\", companyId);\n\n      return {\n        success: false,\n        error: sendResult.error || \"Failed to send email on retry\",\n      };\n    }\n\n    // Update status to sent\n    await supabase\n      .from(\"communications\")\n      .update({\n        status: \"sent\",\n        sent_at: new Date().toISOString(),\n        provider_message_id: sendResult.data?.id || null,\n        failure_reason: null,\n      })\n      .eq(\"id\", emailId)\n      .eq(\"company_id\", companyId);\n\n    return { success: true };\n  } catch (error) {\n    console.error(\"Error retrying failed email:\", error);\n    return { success: false, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2638, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/notifications.ts"],"sourcesContent":["\"use server\";\n\n/**\n * Notifications Server Actions\n *\n * Server-side operations for the notifications system including:\n * - Fetching notifications with filtering and pagination\n * - Creating new notifications\n * - Marking notifications as read/unread\n * - Deleting notifications\n * - Managing notification preferences\n *\n * Performance optimizations:\n * - Server-side data fetching and validation\n * - Efficient database queries with proper indexes\n * - RLS policies for security\n * - Zod validation for all inputs\n */\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport {\n\ttype CreateNotificationInput,\n\tCreateNotificationSchema,\n\ttype GetNotificationsInput,\n\tGetNotificationsSchema,\n\ttype NotificationPreference,\n\tNotificationPreferenceSchema,\n} from \"@/lib/notifications/types\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// NOTE: Type re-exports removed to comply with Next.js 16 \"use server\" restrictions\n// Import types directly from @/lib/notifications/types instead\n\nconst UpdateNotificationPreferencesSchema = z.array(\n\tNotificationPreferenceSchema,\n);\n\n// =====================================================================================\n// Helper Functions\n// =====================================================================================\n\n/**\n * Get authenticated user and company context\n */\nasync function getAuthContext(): Promise<{\n\tuserId: string;\n\tcompanyId: string;\n\tsupabase: NonNullable<Awaited<ReturnType<typeof createClient>>>;\n}> {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\tthrow new Error(\"Supabase client not configured\");\n\t}\n\n\tconst {\n\t\tdata: { user },\n\t\terror: authError,\n\t} = await supabase.auth.getUser();\n\n\tif (authError || !user) {\n\t\tthrow new Error(\"Not authenticated\");\n\t}\n\n\t// Get user's active company from team_members\n\tconst { data: teamMember, error: teamError } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(\"company_id\")\n\t\t.eq(\"user_id\", user.id)\n\t\t.eq(\"status\", \"active\")\n\t\t.maybeSingle();\n\n\tif (teamError) {\n\t\tthrow new Error(\"Failed to fetch user company\");\n\t}\n\n\tif (!teamMember) {\n\t\tthrow new Error(\"No active company found\");\n\t}\n\n\treturn {\n\t\tuserId: user.id,\n\t\tcompanyId: teamMember.company_id,\n\t\tsupabase,\n\t};\n}\n\n// =====================================================================================\n// Notification CRUD Operations\n// =====================================================================================\n\n/**\n * Get notifications for the current user\n *\n * @param options - Filtering and pagination options\n * @returns Array of notifications and total count\n */\nexport async function getNotifications(\n\toptions?: Partial<GetNotificationsInput>,\n) {\n\ttry {\n\t\t// Notifications are user-specific, not company-specific\n\t\t// So we don't need the full auth context with company\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Supabase client not configured\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t\terror: authError,\n\t\t} = await supabase.auth.getUser();\n\n\t\tif (authError || !user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst userId = user.id;\n\n\t\t// Validate input\n\t\tconst validatedOptions = GetNotificationsSchema.parse(options || {});\n\n\t\t// Build query\n\t\tlet query = supabase\n\t\t\t.from(\"notifications\")\n\t\t\t.select(\"*\", { count: \"exact\" })\n\t\t\t.eq(\"user_id\", userId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\t// Apply filters\n\t\tif (validatedOptions.unreadOnly) {\n\t\t\tquery = query.eq(\"read\", false);\n\t\t}\n\n\t\tif (validatedOptions.type) {\n\t\t\tquery = query.eq(\"type\", validatedOptions.type);\n\t\t}\n\n\t\tif (validatedOptions.priority) {\n\t\t\tquery = query.eq(\"priority\", validatedOptions.priority);\n\t\t}\n\n\t\t// Apply pagination\n\t\tquery = query.range(\n\t\t\tvalidatedOptions.offset,\n\t\t\tvalidatedOptions.offset + validatedOptions.limit - 1,\n\t\t);\n\n\t\tconst { data, error, count } = await query;\n\n\t\tif (error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Failed to fetch notifications\",\n\t\t\t\tdata: [],\n\t\t\t\tcount: 0,\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t\tcount: count || 0,\n\t\t};\n\t} catch (error) {\n\t\tif (error instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.issues[0]?.message || \"Validation error\",\n\t\t\t\tdata: [],\n\t\t\t\tcount: 0,\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"An error occurred\",\n\t\t\tdata: [],\n\t\t\tcount: 0,\n\t\t};\n\t}\n}\n\n/**\n * Get unread notification count for the current user\n *\n * @returns Number of unread notifications\n */\nasync function getUnreadCount() {\n\ttry {\n\t\tconst { userId, supabase } = await getAuthContext();\n\n\t\t// Use the database function for optimized counting\n\t\tconst { data, error } = await supabase.rpc(\n\t\t\t\"get_unread_notification_count\",\n\t\t\t{\n\t\t\t\tp_user_id: userId,\n\t\t\t},\n\t\t);\n\n\t\tif (error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Failed to fetch unread count\",\n\t\t\t\tcount: 0,\n\t\t\t};\n\t\t}\n\n\t\treturn { success: true, count: data || 0 };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"An error occurred\",\n\t\t\tcount: 0,\n\t\t};\n\t}\n}\n\n/**\n * Create a new notification\n *\n * @param input - Notification data\n * @returns Created notification\n */\nasync function createNotification(input: CreateNotificationInput) {\n\ttry {\n\t\tconst { supabase } = await getAuthContext();\n\n\t\t// Validate input\n\t\tconst validatedData = CreateNotificationSchema.parse(input);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"notifications\")\n\t\t\t.insert({\n\t\t\t\tuser_id: validatedData.userId,\n\t\t\t\tcompany_id: validatedData.companyId,\n\t\t\t\ttype: validatedData.type,\n\t\t\t\tpriority: validatedData.priority,\n\t\t\t\ttitle: validatedData.title,\n\t\t\t\tmessage: validatedData.message,\n\t\t\t\taction_url: validatedData.actionUrl,\n\t\t\t\taction_label: validatedData.actionLabel,\n\t\t\t\tmetadata: validatedData.metadata || {},\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: \"Failed to create notification\" };\n\t\t}\n\n\t\t// Revalidate paths where notifications appear\n\t\trevalidatePath(\"/dashboard\");\n\t\trevalidatePath(\"/dashboard/notifications\");\n\n\t\treturn { success: true, data };\n\t} catch (error) {\n\t\tif (error instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.issues[0]?.message || \"Validation error\",\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"An error occurred\",\n\t\t};\n\t}\n}\n\n/**\n * Mark a notification as read\n *\n * @param notificationId - ID of the notification to mark as read\n * @returns Success status\n */\nexport async function markAsRead(notificationId: string) {\n\ttry {\n\t\tconst { userId, supabase } = await getAuthContext();\n\n\t\t// Validate UUID\n\t\tconst idSchema = z.string().uuid(\"Invalid notification ID\");\n\t\tconst validatedId = idSchema.parse(notificationId);\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"notifications\")\n\t\t\t.update({ read: true })\n\t\t\t.eq(\"id\", validatedId)\n\t\t\t.eq(\"user_id\", userId); // Ensure user owns the notification\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: \"Failed to mark notification as read\" };\n\t\t}\n\n\t\trevalidatePath(\"/dashboard\");\n\t\trevalidatePath(\"/dashboard/notifications\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tif (error instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.issues[0]?.message || \"Validation error\",\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"An error occurred\",\n\t\t};\n\t}\n}\n\n/**\n * Mark all notifications as read for the current user\n *\n * @returns Number of notifications marked as read\n */\nexport async function markAllAsRead() {\n\ttry {\n\t\tconst { userId, supabase } = await getAuthContext();\n\n\t\t// Use the database function for bulk operation\n\t\tconst { data, error } = await supabase.rpc(\"mark_all_notifications_read\", {\n\t\t\tp_user_id: userId,\n\t\t});\n\n\t\tif (error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Failed to mark all notifications as read\",\n\t\t\t\tcount: 0,\n\t\t\t};\n\t\t}\n\n\t\trevalidatePath(\"/dashboard\");\n\t\trevalidatePath(\"/dashboard/notifications\");\n\n\t\treturn { success: true, count: data || 0 };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"An error occurred\",\n\t\t\tcount: 0,\n\t\t};\n\t}\n}\n\n/**\n * Mark a notification as unread\n *\n * @param notificationId - ID of the notification to mark as unread\n * @returns Success status\n */\nasync function markAsUnread(notificationId: string) {\n\ttry {\n\t\tconst { userId, supabase } = await getAuthContext();\n\n\t\t// Validate UUID\n\t\tconst idSchema = z.string().uuid(\"Invalid notification ID\");\n\t\tconst validatedId = idSchema.parse(notificationId);\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"notifications\")\n\t\t\t.update({ read: false })\n\t\t\t.eq(\"id\", validatedId)\n\t\t\t.eq(\"user_id\", userId); // Ensure user owns the notification\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: \"Failed to mark notification as unread\" };\n\t\t}\n\n\t\trevalidatePath(\"/dashboard\");\n\t\trevalidatePath(\"/dashboard/notifications\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tif (error instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.issues[0]?.message || \"Validation error\",\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"An error occurred\",\n\t\t};\n\t}\n}\n\n/**\n * Delete a notification\n *\n * @param notificationId - ID of the notification to delete\n * @returns Success status\n */\nexport async function deleteNotification(notificationId: string) {\n\ttry {\n\t\tconst { userId, supabase } = await getAuthContext();\n\n\t\t// Validate UUID\n\t\tconst idSchema = z.string().uuid(\"Invalid notification ID\");\n\t\tconst validatedId = idSchema.parse(notificationId);\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"notifications\")\n\t\t\t.delete()\n\t\t\t.eq(\"id\", validatedId)\n\t\t\t.eq(\"user_id\", userId); // Ensure user owns the notification\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: \"Failed to delete notification\" };\n\t\t}\n\n\t\trevalidatePath(\"/dashboard\");\n\t\trevalidatePath(\"/dashboard/notifications\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tif (error instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.issues[0]?.message || \"Validation error\",\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"An error occurred\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// Notification Preferences Operations\n// =====================================================================================\n\n/**\n * Get notification preferences for the current user\n *\n * @returns Array of notification preferences\n */\nasync function getNotificationPreferences() {\n\ttry {\n\t\tconst { userId, companyId, supabase } = await getAuthContext();\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"notification_preferences\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"user_id\", userId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Failed to fetch notification preferences\",\n\t\t\t\tdata: [],\n\t\t\t};\n\t\t}\n\n\t\treturn { success: true, data: data || [] };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"An error occurred\",\n\t\t\tdata: [],\n\t\t};\n\t}\n}\n\n/**\n * Update notification preferences for the current user\n *\n * @param preferences - Array of notification preference settings\n * @returns Success status\n */\nasync function updateNotificationPreferences(\n\tpreferences: NotificationPreference[],\n) {\n\ttry {\n\t\tconst { userId, companyId, supabase } = await getAuthContext();\n\n\t\t// Validate input\n\t\tconst validatedPreferences =\n\t\t\tUpdateNotificationPreferencesSchema.parse(preferences);\n\n\t\t// Delete existing preferences\n\t\tawait supabase\n\t\t\t.from(\"notification_preferences\")\n\t\t\t.delete()\n\t\t\t.eq(\"user_id\", userId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\t// Insert new preferences\n\t\tconst preferencesToInsert = validatedPreferences.map((pref) => ({\n\t\t\tuser_id: userId,\n\t\t\tcompany_id: companyId,\n\t\t\tchannel: pref.channel,\n\t\t\tevent_type: pref.eventType,\n\t\t\tenabled: pref.enabled,\n\t\t}));\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"notification_preferences\")\n\t\t\t.insert(preferencesToInsert);\n\n\t\tif (error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Failed to update notification preferences\",\n\t\t\t};\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/profile/notifications\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tif (error instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.issues[0]?.message || \"Validation error\",\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"An error occurred\",\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3067, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/emails.ts"],"sourcesContent":["/**\n * Email Server Actions - Type-safe email sending functions\n *\n * Features:\n * - Server-side email sending via Resend\n * - Type-safe template rendering\n * - Error handling and logging\n * - Development mode support\n */\n\n\"use server\";\n\nimport { sendEmail } from \"@/lib/email/email-sender\";\nimport {\n\ttype AppointmentReminderProps,\n\ttype EmailSendResult,\n\ttype EmailVerificationProps,\n\ttype EstimateSentProps,\n\ttype InvoiceSentProps,\n\ttype JobCompleteProps,\n\ttype JobConfirmationProps,\n\ttype MagicLinkProps,\n\ttype PasswordChangedProps,\n\ttype PasswordResetProps,\n\ttype PaymentReceivedProps,\n\ttype PaymentReminderProps,\n\ttype ReviewRequestProps,\n\ttype ServiceReminderProps,\n\ttype TechEnRouteProps,\n\ttype WelcomeCustomerProps,\n\ttype WelcomeEmailProps,\n\tEmailTemplate,\n} from \"@/lib/email/email-types\";\nimport EmailVerificationEmail from \"../../emails/templates/auth/email-verification\";\nimport MagicLinkEmail from \"../../emails/templates/auth/magic-link\";\nimport PasswordChangedEmail from \"../../emails/templates/auth/password-changed\";\nimport PasswordResetEmail from \"../../emails/templates/auth/password-reset\";\nimport WelcomeEmail from \"../../emails/templates/auth/welcome\";\nimport EstimateSentEmail from \"../../emails/templates/billing/estimate-sent\";\n\nimport InvoiceSentEmail from \"../../emails/templates/billing/invoice-sent\";\nimport PaymentReceivedEmail from \"../../emails/templates/billing/payment-received\";\nimport PaymentReminderEmail from \"../../emails/templates/billing/payment-reminder\";\nimport ReviewRequestEmail from \"../../emails/templates/customer/review-request\";\nimport ServiceReminderEmail from \"../../emails/templates/customer/service-reminder\";\nimport WelcomeCustomerEmail from \"../../emails/templates/customer/welcome-customer\";\nimport AppointmentReminderEmail from \"../../emails/templates/jobs/appointment-reminder\";\nimport JobCompleteEmail from \"../../emails/templates/jobs/job-complete\";\nimport JobConfirmationEmail from \"../../emails/templates/jobs/job-confirmation\";\nimport TechEnRouteEmail from \"../../emails/templates/jobs/tech-en-route\";\n\n// =============================================================================\n// AUTHENTICATION EMAILS\n// =============================================================================\n\n/**\n * Send welcome email to new user\n */\nexport async function sendWelcomeEmail(\n\tto: string,\n\tprops: WelcomeEmailProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: \"Welcome to Thorbis!\",\n\t\ttemplate: WelcomeEmail(props),\n\t\ttemplateType: EmailTemplate.WELCOME,\n\t});\n}\n\n/**\n * Send email verification link\n */\nexport async function sendEmailVerification(\n\tto: string,\n\tprops: EmailVerificationProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: \"Verify your email address\",\n\t\ttemplate: EmailVerificationEmail(props),\n\t\ttemplateType: EmailTemplate.EMAIL_VERIFICATION,\n\t});\n}\n\n/**\n * Send password reset email\n */\nexport async function sendPasswordReset(\n\tto: string,\n\tprops: PasswordResetProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: \"Reset your password\",\n\t\ttemplate: PasswordResetEmail(props),\n\t\ttemplateType: EmailTemplate.PASSWORD_RESET,\n\t});\n}\n\n/**\n * Send password changed confirmation\n */\nexport async function sendPasswordChanged(\n\tto: string,\n\tprops: PasswordChangedProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: \"Your password has been changed\",\n\t\ttemplate: PasswordChangedEmail(props),\n\t\ttemplateType: EmailTemplate.PASSWORD_CHANGED,\n\t});\n}\n\n/**\n * Send magic link for passwordless authentication\n */\nasync function sendMagicLink(\n\tto: string,\n\tprops: MagicLinkProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: \"Sign in to Thorbis\",\n\t\ttemplate: MagicLinkEmail(props),\n\t\ttemplateType: EmailTemplate.MAGIC_LINK,\n\t});\n}\n\n// =============================================================================\n// JOB LIFECYCLE EMAILS\n// =============================================================================\n\n/**\n * Send job confirmation email\n */\nasync function sendJobConfirmation(\n\tto: string,\n\tprops: JobConfirmationProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: `Service Appointment Confirmed - ${props.jobType}`,\n\t\ttemplate: JobConfirmationEmail(props),\n\t\ttemplateType: EmailTemplate.JOB_CONFIRMATION,\n\t\ttags: [{ name: \"job_number\", value: props.jobNumber }],\n\t});\n}\n\n/**\n * Send appointment reminder (24h before)\n */\nasync function sendAppointmentReminder(\n\tto: string,\n\tprops: AppointmentReminderProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: \"Reminder: Your service appointment is tomorrow\",\n\t\ttemplate: AppointmentReminderEmail(props),\n\t\ttemplateType: EmailTemplate.APPOINTMENT_REMINDER,\n\t});\n}\n\n/**\n * Send technician en route notification\n */\nasync function sendTechEnRoute(\n\tto: string,\n\tprops: TechEnRouteProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: `${props.technicianName} is on the way!`,\n\t\ttemplate: TechEnRouteEmail(props),\n\t\ttemplateType: EmailTemplate.TECH_EN_ROUTE,\n\t});\n}\n\n/**\n * Send job completion notification\n */\nasync function sendJobComplete(\n\tto: string,\n\tprops: JobCompleteProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: \"Your service is complete!\",\n\t\ttemplate: JobCompleteEmail(props),\n\t\ttemplateType: EmailTemplate.JOB_COMPLETE,\n\t\ttags: [{ name: \"job_number\", value: props.jobNumber }],\n\t});\n}\n\n// =============================================================================\n// BILLING EMAILS\n// =============================================================================\n\n/**\n * Send invoice to customer\n */\nasync function sendInvoice(\n\tto: string,\n\tprops: InvoiceSentProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: `Invoice ${props.invoiceNumber} from Thorbis`,\n\t\ttemplate: InvoiceSentEmail(props),\n\t\ttemplateType: EmailTemplate.INVOICE_SENT,\n\t\ttags: [\n\t\t\t{ name: \"invoice_number\", value: props.invoiceNumber },\n\t\t\t{ name: \"amount\", value: props.totalAmount },\n\t\t],\n\t});\n}\n\n/**\n * Send payment confirmation\n */\nasync function sendPaymentReceived(\n\tto: string,\n\tprops: PaymentReceivedProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: \"Payment received - Thank you!\",\n\t\ttemplate: PaymentReceivedEmail(props),\n\t\ttemplateType: EmailTemplate.PAYMENT_RECEIVED,\n\t\ttags: [\n\t\t\t{ name: \"invoice_number\", value: props.invoiceNumber },\n\t\t\t{ name: \"amount\", value: props.paymentAmount },\n\t\t],\n\t});\n}\n\n/**\n * Send payment reminder for overdue invoice\n */\nasync function sendPaymentReminder(\n\tto: string,\n\tprops: PaymentReminderProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: `Payment reminder: Invoice ${props.invoiceNumber}`,\n\t\ttemplate: PaymentReminderEmail(props),\n\t\ttemplateType: EmailTemplate.PAYMENT_REMINDER,\n\t\ttags: [\n\t\t\t{ name: \"invoice_number\", value: props.invoiceNumber },\n\t\t\t{ name: \"days_overdue\", value: props.daysOverdue.toString() },\n\t\t],\n\t});\n}\n\n/**\n * Send estimate/quote to customer\n */\nasync function sendEstimate(\n\tto: string,\n\tprops: EstimateSentProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: `Estimate ${props.estimateNumber} from Thorbis`,\n\t\ttemplate: EstimateSentEmail(props),\n\t\ttemplateType: EmailTemplate.ESTIMATE_SENT,\n\t\ttags: [\n\t\t\t{ name: \"estimate_number\", value: props.estimateNumber },\n\t\t\t{ name: \"amount\", value: props.totalAmount },\n\t\t],\n\t});\n}\n\n// =============================================================================\n// CUSTOMER ENGAGEMENT EMAILS\n// =============================================================================\n\n/**\n * Send review request after job completion\n */\nasync function sendReviewRequest(\n\tto: string,\n\tprops: ReviewRequestProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: \"How was your experience with Thorbis?\",\n\t\ttemplate: ReviewRequestEmail(props),\n\t\ttemplateType: EmailTemplate.REVIEW_REQUEST,\n\t\ttags: [{ name: \"job_number\", value: props.jobNumber }],\n\t});\n}\n\n/**\n * Send service/maintenance reminder\n */\nasync function sendServiceReminder(\n\tto: string,\n\tprops: ServiceReminderProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: `Time for your ${props.serviceName} service`,\n\t\ttemplate: ServiceReminderEmail(props),\n\t\ttemplateType: EmailTemplate.SERVICE_REMINDER,\n\t});\n}\n\n/**\n * Send welcome email to new customer\n */\nasync function sendWelcomeCustomer(\n\tto: string,\n\tprops: WelcomeCustomerProps,\n): Promise<EmailSendResult> {\n\treturn await sendEmail({\n\t\tto,\n\t\tsubject: \"Welcome to Thorbis!\",\n\t\ttemplate: WelcomeCustomerEmail(props),\n\t\ttemplateType: EmailTemplate.WELCOME_CUSTOMER,\n\t});\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3365, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/auth.ts"],"sourcesContent":["\"use server\";\n\nimport { AuthApiError, AuthUnknownError } from \"@supabase/supabase-js\";\nimport { Buffer } from \"node:buffer\";\nimport { extname } from \"node:path\";\n// import { checkBotId } from \"botid/server\";\nimport { clearActiveCompany } from \"@/lib/auth/company-context\";\nimport {\n    createEmailVerificationToken,\n    verifyAndConsumeToken,\n} from \"@/lib/auth/tokens\";\nimport { emailConfig } from \"@/lib/email/resend-client\";\nimport { clearCSRFToken } from \"@/lib/security/csrf\";\nimport {\n    authRateLimiter,\n    checkRateLimit,\n    passwordResetRateLimiter,\n    RateLimitError,\n} from \"@/lib/security/rate-limit\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport {\n    createServiceSupabaseClient,\n    type ServiceSupabaseClient,\n} from \"@/lib/supabase/service-client\";\nimport { revalidatePath } from \"next/cache\";\nimport { redirect } from \"next/navigation\";\nimport { z } from \"zod\";\nimport {\n    sendEmailVerification,\n    sendPasswordChanged,\n    sendWelcomeEmail,\n} from \"./emails\";\n\nconst NAME_MIN_LENGTH = 2;\nconst NAME_MAX_LENGTH = 100;\nconst COMPANY_NAME_MIN_LENGTH = 2;\nconst COMPANY_NAME_MAX_LENGTH = 200;\nconst PHONE_MIN_DIGITS = 10;\nconst PASSWORD_MIN_LENGTH = 8;\nconst PASSWORD_MAX_LENGTH = 100;\nconst CONFIRMATION_TOKEN_TTL_HOURS = 24;\nconst COUNTRY_CODE_US = \"1\";\nconst NATIONAL_NUMBER_DIGITS = 10;\nconst EXTENDED_US_NUMBER_DIGITS = 11;\nconst BYTES_PER_KILOBYTE = 1024;\nconst BYTES_PER_MEGABYTE = BYTES_PER_KILOBYTE * BYTES_PER_KILOBYTE;\nconst AVATAR_SIZE_LIMIT_MB = 5;\nconst MAX_AVATAR_FILE_SIZE = AVATAR_SIZE_LIMIT_MB * BYTES_PER_MEGABYTE;\n\n/**\n * Authentication Server Actions - Supabase Auth + Resend Email Integration\n *\n * Performance optimizations:\n * - Server Actions for secure authentication\n * - Supabase Auth handles password hashing and session management\n * - Custom emails via Resend with branded templates\n * - Zod validation for input sanitization\n * - Proper error handling with user-friendly messages\n */\n\n// Validation Schemas\nconst signUpSchema = z.object({\n\tname: z\n\t\t.string()\n\t\t.trim()\n\t\t.min(NAME_MIN_LENGTH, \"Name must be at least 2 characters\")\n\t\t.max(NAME_MAX_LENGTH, \"Name is too long\"),\n\temail: z.string().email(\"Invalid email address\"),\n\tphone: z\n\t\t.string()\n\t\t.trim()\n\t\t.min(PHONE_MIN_DIGITS, \"Phone number is required\")\n\t\t.refine(\n\t\t\t(value) => value.replace(/\\D/g, \"\").length >= PHONE_MIN_DIGITS,\n\t\t\t\"Enter a valid phone number\",\n\t\t),\n\tpassword: z\n\t\t.string()\n\t\t.min(PASSWORD_MIN_LENGTH, \"Password must be at least 8 characters\")\n\t\t.max(PASSWORD_MAX_LENGTH, \"Password is too long\")\n\t\t.regex(\n\t\t\t/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)/,\n\t\t\t\"Password must contain uppercase, lowercase, and number\",\n\t\t),\n\tcompanyName: z\n\t\t.string()\n\t\t.trim()\n\t\t.min(COMPANY_NAME_MIN_LENGTH, \"Company name must be at least 2 characters\")\n\t\t.max(COMPANY_NAME_MAX_LENGTH, \"Company name is too long\")\n\t\t.optional(),\n\tterms: z\n\t\t.boolean()\n\t\t.refine((val) => val === true, \"You must accept the terms and conditions\"),\n});\n\nconst signInSchema = z.object({\n\temail: z.string().email(\"Invalid email address\"),\n\tpassword: z.string().min(1, \"Password is required\"),\n});\n\nconst forgotPasswordSchema = z.object({\n\temail: z.string().email(\"Invalid email address\"),\n});\n\nconst resetPasswordSchema = z\n\t.object({\n\t\tpassword: z\n\t\t\t.string()\n\t\t\t.min(PASSWORD_MIN_LENGTH, \"Password must be at least 8 characters\")\n\t\t\t.max(PASSWORD_MAX_LENGTH, \"Password is too long\")\n\t\t\t.regex(\n\t\t\t\t/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)/,\n\t\t\t\t\"Password must contain uppercase, lowercase, and number\",\n\t\t\t),\n\t\tconfirmPassword: z.string(),\n\t})\n\t.refine((data) => data.password === data.confirmPassword, {\n\t\tmessage: \"Passwords don't match\",\n\t\tpath: [\"confirmPassword\"],\n\t});\n\nconst AVATAR_STORAGE_BUCKET = \"avatars\";\nconst SUPABASE_RATE_LIMIT_MAX_RETRIES = 3;\nconst SUPABASE_RATE_LIMIT_BACKOFF_MS = 200;\n\nconst delay = (ms: number) =>\n\tnew Promise((resolve) => {\n\t\tsetTimeout(resolve, ms);\n\t});\n\nconst withSupabaseRateLimitRetry = async <T extends { error?: unknown }>(\n\toperation: () => Promise<T>,\n): Promise<T> => {\n\tfor (\n\t\tlet attempt = 1;\n\t\tattempt <= SUPABASE_RATE_LIMIT_MAX_RETRIES;\n\t\tattempt += 1\n\t) {\n\t\ttry {\n\t\t\tconst result = await operation();\n\n\t\t\tif (\n\t\t\t\tresult &&\n\t\t\t\ttypeof result === \"object\" &&\n\t\t\t\t\"error\" in result &&\n\t\t\t\tresult.error instanceof AuthApiError &&\n\t\t\t\tresult.error.code === \"over_request_rate_limit\"\n\t\t\t) {\n\t\t\t\tif (attempt === SUPABASE_RATE_LIMIT_MAX_RETRIES) {\n\t\t\t\t\tthrow result.error;\n\t\t\t\t}\n\n\t\t\t\tawait delay(SUPABASE_RATE_LIMIT_BACKOFF_MS * attempt);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\treturn result;\n\t\t} catch (error) {\n\t\t\tif (\n\t\t\t\terror instanceof AuthApiError &&\n\t\t\t\terror.code === \"over_request_rate_limit\" &&\n\t\t\t\tattempt < SUPABASE_RATE_LIMIT_MAX_RETRIES\n\t\t\t) {\n\t\t\t\tawait delay(SUPABASE_RATE_LIMIT_BACKOFF_MS * attempt);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\tthrow new Error(\"Supabase auth operation failed after retries\");\n};\n\ntype SignUpFormInput = z.infer<typeof signUpSchema>;\n\ntype SupabaseBrowserClient = Exclude<\n\tAwaited<ReturnType<typeof createClient>>,\n\tnull\n>;\n\nfunction normalizePhoneNumber(input: string): string {\n\tconst trimmed = input.trim();\n\tconst digitsOnly = trimmed.replace(/\\D/g, \"\");\n\n\tif (!digitsOnly) {\n\t\treturn trimmed;\n\t}\n\n\tif (trimmed.startsWith(\"+\")) {\n\t\treturn `+${digitsOnly}`;\n\t}\n\n\tif (\n\t\tdigitsOnly.length === EXTENDED_US_NUMBER_DIGITS &&\n\t\tdigitsOnly.startsWith(COUNTRY_CODE_US)\n\t) {\n\t\treturn `+${digitsOnly}`;\n\t}\n\n\tif (digitsOnly.length === NATIONAL_NUMBER_DIGITS) {\n\t\treturn `+${COUNTRY_CODE_US}${digitsOnly}`;\n\t}\n\n\treturn `+${digitsOnly}`;\n}\n\nconst reportAuthIssue = (_message: string, _error?: unknown) => {\n\t// TODO: Integrate structured logging/monitoring\n};\n\nconst getMetadataString = (\n\tmetadata: unknown,\n\tkey: string,\n): string | undefined => {\n\tif (metadata && typeof metadata === \"object\") {\n\t\tconst value = (metadata as Record<string, unknown>)[key];\n\t\tif (typeof value === \"string\") {\n\t\t\treturn value;\n\t\t}\n\t}\n\n\treturn;\n};\n\nasync function uploadAvatarForNewUser(\n\tsupabase: ServiceSupabaseClient,\n\tfile: File,\n\tuserId: string,\n): Promise<string | null> {\n\tif (!supabase) {\n\t\tthrow new Error(\"Supabase client not configured\");\n\t}\n\tif (!file.type.startsWith(\"image/\")) {\n\t\tthrow new Error(\"Avatar must be an image\");\n\t}\n\n\tif (file.size > MAX_AVATAR_FILE_SIZE) {\n\t\tthrow new Error(`Avatar must be smaller than ${AVATAR_SIZE_LIMIT_MB}MB`);\n\t}\n\n\tconst arrayBuffer = await file.arrayBuffer();\n\tconst extension = extname(file.name) || \".jpg\";\n\tconst filePath = `${userId}/profile${extension}`;\n\n\tconst { error: uploadError } = await supabase.storage\n\t\t.from(AVATAR_STORAGE_BUCKET)\n\t\t.upload(filePath, Buffer.from(arrayBuffer), {\n\t\t\tcacheControl: \"3600\",\n\t\t\tcontentType: file.type || \"image/jpeg\",\n\t\t\tupsert: true,\n\t\t});\n\n\tif (uploadError) {\n\t\tthrow new Error(uploadError.message);\n\t}\n\n\tconst {\n\t\tdata: { publicUrl },\n\t} = supabase.storage.from(AVATAR_STORAGE_BUCKET).getPublicUrl(filePath);\n\n\treturn publicUrl;\n}\n\nconst createServiceClientLoader = () => {\n\tlet client: ServiceSupabaseClient | null = null;\n\treturn async () => {\n\t\tif (client) {\n\t\t\treturn client;\n\t\t}\n\t\tclient = await createServiceSupabaseClient();\n\t\treturn client;\n\t};\n};\n\ntype ParsedSignUpForm = {\n\tvalidated: SignUpFormInput;\n\tnormalizedPhone: string;\n\tcompanyName?: string;\n\tavatarFile: File | null;\n};\n\nconst parseSignUpFormData = (formData: FormData): ParsedSignUpForm => {\n\tconst companyNameEntry = formData.get(\"companyName\");\n\tconst normalizedCompanyName =\n\t\ttypeof companyNameEntry === \"string\" && companyNameEntry.trim().length > 0\n\t\t\t? companyNameEntry\n\t\t\t: undefined;\n\n\tconst rawData = {\n\t\tname: (formData.get(\"name\") as string) ?? \"\",\n\t\temail: (formData.get(\"email\") as string) ?? \"\",\n\t\tphone: (formData.get(\"phone\") as string) ?? \"\",\n\t\tpassword: (formData.get(\"password\") as string) ?? \"\",\n\t\tcompanyName: normalizedCompanyName,\n\t\tterms: formData.get(\"terms\") === \"on\" || formData.get(\"terms\") === \"true\",\n\t};\n\n\tconst validated = signUpSchema.parse(rawData);\n\tconst avatarEntry = formData.get(\"avatar\");\n\tconst avatarFile =\n\t\tavatarEntry instanceof File && avatarEntry.size > 0 ? avatarEntry : null;\n\n\treturn {\n\t\tvalidated,\n\t\tnormalizedPhone: normalizePhoneNumber(validated.phone),\n\t\tcompanyName: validated.companyName?.trim() || undefined,\n\t\tavatarFile,\n\t};\n};\n\nconst requireSupabaseBrowserClient =\n\tasync (): Promise<SupabaseBrowserClient> => {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\n\t\t\t\t\"Authentication service is not configured. Please check your environment variables.\",\n\t\t\t);\n\t\t}\n\n\t\treturn supabase as SupabaseBrowserClient;\n\t};\n\ntype RegisterSupabaseUserParams = {\n\tsupabase: SupabaseBrowserClient;\n\tvalidated: SignUpFormInput;\n\tnormalizedPhone: string;\n\tcompanyName?: string;\n};\n\nconst registerSupabaseUser = async ({\n\tsupabase,\n\tvalidated,\n\tnormalizedPhone,\n\tcompanyName,\n}: RegisterSupabaseUserParams) => {\n\tconst { data, error } = await withSupabaseRateLimitRetry(() =>\n\t\tsupabase.auth.signUp({\n\t\t\temail: validated.email,\n\t\t\tpassword: validated.password,\n\t\t\toptions: {\n\t\t\t\tdata: {\n\t\t\t\t\tname: validated.name,\n\t\t\t\t\tphone: normalizedPhone,\n\t\t\t\t\tcompanyName: companyName ?? null,\n\t\t\t\t},\n\t\t\t\temailRedirectTo: `${emailConfig.siteUrl}/auth/callback`,\n\t\t\t},\n\t\t}),\n\t);\n\n\tif (error) {\n\t\tthrow new Error(error.message);\n\t}\n\n\tif (!data.user) {\n\t\tthrow new Error(\"Failed to create user account\");\n\t}\n\n\treturn data;\n};\n\ntype SyncSignUpProfileParams = {\n\tensureServiceSupabase: () => Promise<ServiceSupabaseClient>;\n\tuserId: string;\n\tnormalizedPhone: string;\n\tname: string;\n\tcompanyName?: string;\n\tavatarFile: File | null;\n};\n\nconst syncSignUpProfile = async ({\n\tensureServiceSupabase,\n\tuserId,\n\tnormalizedPhone,\n\tname,\n\tcompanyName,\n\tavatarFile,\n}: SyncSignUpProfileParams) => {\n\tlet avatarUrl: string | null = null;\n\n\tif (avatarFile) {\n\t\ttry {\n\t\t\tconst adminClient = await ensureServiceSupabase();\n\t\t\tavatarUrl = await uploadAvatarForNewUser(adminClient, avatarFile, userId);\n\t\t} catch (avatarUploadError) {\n\t\t\treportAuthIssue(\"Avatar upload failed\", avatarUploadError);\n\t\t}\n\t}\n\n\ttry {\n\t\tconst adminClient = await ensureServiceSupabase();\n\t\tconst updatePayload: Record<string, string | null> = {\n\t\t\tphone: normalizedPhone,\n\t\t};\n\n\t\tif (avatarUrl) {\n\t\t\tupdatePayload.avatar_url = avatarUrl;\n\t\t}\n\n\t\tif (!adminClient) {\n\t\t\tthrow new Error(\"Admin client not configured\");\n\t\t}\n\t\tawait adminClient.from(\"profiles\").update(updatePayload).eq(\"id\", userId);\n\t} catch (profileUpdateError) {\n\t\treportAuthIssue(\"Failed to update user profile\", profileUpdateError);\n\t}\n\n\tif (!avatarUrl) {\n\t\treturn;\n\t}\n\n\ttry {\n\t\tconst adminClient = await ensureServiceSupabase();\n\t\tif (!adminClient) {\n\t\t\tthrow new Error(\"Admin client not configured\");\n\t\t}\n\t\tawait adminClient.auth.admin.updateUserById(userId, {\n\t\t\tuser_metadata: {\n\t\t\t\tname,\n\t\t\t\tphone: normalizedPhone,\n\t\t\t\tcompanyName: companyName ?? null,\n\t\t\t\tavatarUrl,\n\t\t\t},\n\t\t});\n\t} catch (metadataError) {\n\t\treportAuthIssue(\"Failed to sync avatar metadata\", metadataError);\n\t}\n};\n\ntype PostSignUpEmailParams = {\n\temail: string;\n\tname: string;\n\trequiresConfirmation: boolean;\n\tuserId: string;\n};\n\nconst handlePostSignUpEmails = async ({\n\temail,\n\tname,\n\trequiresConfirmation,\n\tuserId,\n}: PostSignUpEmailParams): Promise<AuthActionResult | null> => {\n\tif (requiresConfirmation) {\n\t\tconst { token, expiresAt } = await createEmailVerificationToken(\n\t\t\temail,\n\t\t\tuserId,\n\t\t\tCONFIRMATION_TOKEN_TTL_HOURS,\n\t\t);\n\n\t\tconst verificationUrl = `${emailConfig.siteUrl}/auth/verify-email?token=${token}`;\n\t\tconst verificationResult = await sendEmailVerification(email, {\n\t\t\tname,\n\t\t\tverificationUrl,\n\t\t});\n\n\t\tif (!verificationResult.success) {\n\t\t\treportAuthIssue(\n\t\t\t\t\"Failed to send verification email\",\n\t\t\t\tverificationResult.error,\n\t\t\t);\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\trequiresEmailConfirmation: true,\n\t\t\t\tmessage:\n\t\t\t\t\t\"Account created! Please check your email to verify your account.\",\n\t\t\t\texpiresAt: expiresAt.toISOString(),\n\t\t\t},\n\t\t};\n\t}\n\n\tconst emailResult = await sendWelcomeEmail(email, {\n\t\tname,\n\t\tloginUrl: `${emailConfig.siteUrl}/welcome`,\n\t});\n\n\tif (!emailResult.success) {\n\t\treportAuthIssue(\"Failed to send welcome email\", emailResult.error);\n\t}\n\n\treturn null;\n};\n\nconst normalizeOptionalPhone = (phone: string | null): string | null => {\n\tif (!phone) {\n\t\treturn null;\n\t}\n\n\tconst digitsOnly = phone.replace(/\\D/g, \"\");\n\tif (digitsOnly.length < PHONE_MIN_DIGITS) {\n\t\tthrow new Error(\n\t\t\t\"Please enter a valid phone number with at least 10 digits.\",\n\t\t);\n\t}\n\n\treturn normalizePhoneNumber(phone);\n};\n\ntype CompleteProfileForm = {\n\tname: string | null;\n\tnormalizedPhone: string | null;\n\tavatarFile: File | null;\n};\n\nconst parseCompleteProfileForm = (formData: FormData): CompleteProfileForm => {\n\tconst avatarEntry = formData.get(\"avatar\");\n\tconst avatarFile =\n\t\tavatarEntry instanceof File && avatarEntry.size > 0 ? avatarEntry : null;\n\n\tconst name = (formData.get(\"name\") as string | null) ?? null;\n\tconst phone = (formData.get(\"phone\") as string | null) ?? null;\n\n\treturn {\n\t\tname,\n\t\tnormalizedPhone: normalizeOptionalPhone(phone),\n\t\tavatarFile,\n\t};\n};\n\nconst requireAuthenticatedUser = async (supabase: SupabaseBrowserClient) => {\n\tconst {\n\t\tdata: { user },\n\t} = await withSupabaseRateLimitRetry(() => supabase.auth.getUser());\n\n\tif (!user) {\n\t\tthrow new Error(\"You must be signed in to complete your profile.\");\n\t}\n\n\treturn user;\n};\n\ntype UpdateCompleteProfileRecordsParams = {\n\tensureServiceSupabase: () => Promise<ServiceSupabaseClient>;\n\tuserId: string;\n\tname: string | null;\n\tnormalizedPhone: string | null;\n\tavatarFile: File | null;\n\texistingAvatar: string | null;\n\texistingMetadata?: Record<string, unknown>;\n};\n\nconst uploadAvatarWithFallback = async ({\n\tensureServiceSupabase,\n\tavatarFile,\n\tuserId,\n\tfallbackAvatar,\n}: {\n\tensureServiceSupabase: () => Promise<ServiceSupabaseClient>;\n\tavatarFile: File | null;\n\tuserId: string;\n\tfallbackAvatar: string | null;\n}): Promise<string | null> => {\n\tif (!avatarFile) {\n\t\treturn fallbackAvatar;\n\t}\n\n\ttry {\n\t\tconst adminClient = await ensureServiceSupabase();\n\t\treturn await uploadAvatarForNewUser(adminClient, avatarFile, userId);\n\t} catch (avatarUploadError) {\n\t\treportAuthIssue(\"Avatar upload failed\", avatarUploadError);\n\t\treturn fallbackAvatar;\n\t}\n};\n\nconst updateUserTableRecord = async ({\n\tensureServiceSupabase,\n\tuserId,\n\tname,\n\tnormalizedPhone,\n\tavatarUrl,\n}: {\n\tensureServiceSupabase: () => Promise<ServiceSupabaseClient>;\n\tuserId: string;\n\tname: string | null;\n\tnormalizedPhone: string | null;\n\tavatarUrl: string | null;\n}): Promise<AuthActionResult | null> => {\n\tconst updatePayload: Record<string, string | null> = {};\n\n\tif (name) {\n\t\tupdatePayload.name = name;\n\t}\n\tif (normalizedPhone) {\n\t\tupdatePayload.phone = normalizedPhone;\n\t}\n\tif (avatarUrl) {\n\t\tupdatePayload.avatar = avatarUrl;\n\t}\n\n\tif (Object.keys(updatePayload).length === 0) {\n\t\treturn null;\n\t}\n\n\ttry {\n\t\tconst adminClient = await ensureServiceSupabase();\n\t\tif (!adminClient) {\n\t\t\tthrow new Error(\"Admin client not configured\");\n\t\t}\n\t\tconst { error } = await adminClient\n\t\t\t.from(\"profiles\")\n\t\t\t.update({\n\t\t\t\tfull_name: name || undefined,\n\t\t\t\tphone: normalizedPhone || undefined,\n\t\t\t\tavatar_url: avatarUrl || undefined,\n\t\t\t})\n\t\t\t.eq(\"id\", userId);\n\n\t\tif (error) {\n\t\t\treportAuthIssue(\"Failed to update user profile\", error);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Failed to update your profile: ${error.message}`,\n\t\t\t};\n\t\t}\n\t} catch (profileUpdateError) {\n\t\treportAuthIssue(\"Failed to update user profile\", profileUpdateError);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Failed to update your profile. Please try again.\",\n\t\t};\n\t}\n\n\treturn null;\n};\n\nconst syncUserMetadataProfile = async ({\n\tensureServiceSupabase,\n\tuserId,\n\tname,\n\tnormalizedPhone,\n\tavatarUrl,\n\texistingMetadata,\n}: {\n\tensureServiceSupabase: () => Promise<ServiceSupabaseClient>;\n\tuserId: string;\n\tname: string | null;\n\tnormalizedPhone: string | null;\n\tavatarUrl: string | null;\n\texistingMetadata?: Record<string, unknown>;\n}) => {\n\tconst hasMetadataChanges = Boolean(name || normalizedPhone || avatarUrl);\n\tif (!hasMetadataChanges) {\n\t\treturn;\n\t}\n\n\ttry {\n\t\tconst adminClient = await ensureServiceSupabase();\n\t\tconst metadata: Record<string, string | null> = {\n\t\t\t...(existingMetadata as Record<string, string | null>),\n\t\t};\n\n\t\tif (name) {\n\t\t\tmetadata.name = name;\n\t\t}\n\t\tif (normalizedPhone) {\n\t\t\tmetadata.phone = normalizedPhone;\n\t\t}\n\t\tif (avatarUrl) {\n\t\t\tmetadata.avatarUrl = avatarUrl;\n\t\t}\n\n\t\tif (!adminClient) {\n\t\t\tthrow new Error(\"Admin client not configured\");\n\t\t}\n\n\t\tawait adminClient.auth.admin.updateUserById(userId, {\n\t\t\tuser_metadata: metadata,\n\t\t});\n\t} catch (metadataError) {\n\t\treportAuthIssue(\"Failed to sync user metadata\", metadataError);\n\t}\n};\n\nconst updateCompleteProfileRecords = async ({\n\tensureServiceSupabase,\n\tuserId,\n\tname,\n\tnormalizedPhone,\n\tavatarFile,\n\texistingAvatar,\n\texistingMetadata,\n}: UpdateCompleteProfileRecordsParams): Promise<AuthActionResult | null> => {\n\tconst avatarUrl = await uploadAvatarWithFallback({\n\t\tensureServiceSupabase,\n\t\tavatarFile,\n\t\tuserId,\n\t\tfallbackAvatar: existingAvatar,\n\t});\n\n\tconst userUpdateResult = await updateUserTableRecord({\n\t\tensureServiceSupabase,\n\t\tuserId,\n\t\tname,\n\t\tnormalizedPhone,\n\t\tavatarUrl,\n\t});\n\n\tif (userUpdateResult) {\n\t\treturn userUpdateResult;\n\t}\n\n\tawait syncUserMetadataProfile({\n\t\tensureServiceSupabase,\n\t\tuserId,\n\t\tname,\n\t\tnormalizedPhone,\n\t\tavatarUrl,\n\t\texistingMetadata,\n\t});\n\n\treturn null;\n};\n\ntype ResolveProfileRedirectParams = {\n\tensureServiceSupabase: () => Promise<ServiceSupabaseClient>;\n\tuserId: string;\n};\n\nconst resolveProfileRedirectPath = async ({\n\tensureServiceSupabase,\n\tuserId,\n}: ResolveProfileRedirectParams): Promise<string> => {\n\tconst adminClient = await ensureServiceSupabase();\n\tif (!adminClient) {\n\t\tthrow new Error(\"Admin client not configured\");\n\t}\n\tconst { data: hasCompany } = await adminClient\n\t\t.from(\"company_memberships\")\n\t\t.select(\"company_id\")\n\t\t.eq(\"user_id\", userId)\n\t\t.eq(\"status\", \"active\")\n\t\t.limit(1)\n\t\t.maybeSingle();\n\n\treturn hasCompany ? \"/dashboard\" : \"/welcome\";\n};\n// Internal return type (not exported - Next.js 16 \"use server\" restriction)\ntype AuthActionResult = {\n\tsuccess: boolean;\n\terror?: string;\n\tdata?: Record<string, unknown>;\n};\n\n/**\n * Sign Up - Create new user account with Supabase Auth + Custom Resend Email\n *\n * Features:\n * - Email/password authentication\n * - Custom welcome email via Resend with branded template\n * - Creates user profile in users table via database trigger\n * - Validates input with Zod\n * - Disables Supabase's built-in emails (using custom Resend templates instead)\n */\nexport async function signUp(formData: FormData): Promise<AuthActionResult> {\n\ttry {\n\t\t// Bot protection check (Vercel BotID)\n\t\t/*\n\t\tconst botCheck = await checkBotId();\n\t\tif (botCheck.isBot) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Unable to process request. Please try again later.\",\n\t\t\t};\n\t\t}\n\t\t*/\n\n\t\tconst parsedForm = parseSignUpFormData(formData);\n\n\t\tawait checkRateLimit(parsedForm.validated.email, authRateLimiter);\n\n\t\tconst supabase = await requireSupabaseBrowserClient();\n\t\tconst authResult = await registerSupabaseUser({\n\t\t\tsupabase,\n\t\t\tvalidated: parsedForm.validated,\n\t\t\tnormalizedPhone: parsedForm.normalizedPhone,\n\t\t\tcompanyName: parsedForm.companyName,\n\t\t});\n\n\t\tconst userId = authResult.user?.id;\n\t\tif (!userId) {\n\t\t\tthrow new Error(\"Failed to create user account\");\n\t\t}\n\n\t\tconst ensureServiceSupabase = createServiceClientLoader();\n\t\tawait syncSignUpProfile({\n\t\t\tensureServiceSupabase,\n\t\t\tuserId,\n\t\t\tnormalizedPhone: parsedForm.normalizedPhone,\n\t\t\tname: parsedForm.validated.name,\n\t\t\tcompanyName: parsedForm.companyName,\n\t\t\tavatarFile: parsedForm.avatarFile,\n\t\t});\n\n\t\tconst postSignUpResult = await handlePostSignUpEmails({\n\t\t\temail: parsedForm.validated.email,\n\t\t\tname: parsedForm.validated.name,\n\t\t\trequiresConfirmation: !authResult.session,\n\t\t\tuserId,\n\t\t});\n\n\t\tif (postSignUpResult) {\n\t\t\treturn postSignUpResult;\n\t\t}\n\n\t\t// Revalidate and redirect to onboarding\n\t\trevalidatePath(\"/\", \"layout\");\n\t\tredirect(\"/dashboard\");\n\t} catch (caughtError) {\n\t\tif (caughtError instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: caughtError.issues[0]?.message || \"Validation error\",\n\t\t\t};\n\t\t}\n\n\t\tif (\n\t\t\tcaughtError instanceof Error &&\n\t\t\tcaughtError.message !== \"NEXT_REDIRECT\"\n\t\t) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: caughtError.message,\n\t\t\t};\n\t\t}\n\n\t\t// Re-throw redirect errors\n\t\tthrow caughtError;\n\t}\n}\n\n/**\n * Complete Profile - Update missing user information after OAuth signup\n *\n * Features:\n * - Collects missing required fields (phone, name)\n * - Optional avatar upload\n * - Updates both auth metadata and public.users table\n * - Company name is collected during onboarding, not here\n */\nexport async function completeProfile(\n\tformData: FormData,\n): Promise<AuthActionResult> {\n\ttry {\n\t\tconst supabase = await requireSupabaseBrowserClient();\n\t\tconst user = await requireAuthenticatedUser(supabase);\n\t\tconst parsedForm = parseCompleteProfileForm(formData);\n\t\tconst ensureServiceSupabase = createServiceClientLoader();\n\n\t\tconst profileUpdateResult = await updateCompleteProfileRecords({\n\t\t\tensureServiceSupabase,\n\t\t\tuserId: user.id,\n\t\t\tname: parsedForm.name,\n\t\t\tnormalizedPhone: parsedForm.normalizedPhone,\n\t\t\tavatarFile: parsedForm.avatarFile,\n\t\t\texistingAvatar:\n\t\t\t\tuser.user_metadata?.avatar_url || user.user_metadata?.picture || null,\n\t\t\texistingMetadata: user.user_metadata,\n\t\t});\n\n\t\tif (profileUpdateResult) {\n\t\t\treturn profileUpdateResult;\n\t\t}\n\n\t\tconst redirectPath = await resolveProfileRedirectPath({\n\t\t\tensureServiceSupabase,\n\t\t\tuserId: user.id,\n\t\t}).catch((redirectError) => {\n\t\t\treportAuthIssue(\"Error checking company status\", redirectError);\n\t\t\treturn \"/welcome\";\n\t\t});\n\n\t\trevalidatePath(\"/\", \"layout\");\n\t\tredirect(redirectPath);\n\t} catch (caughtError) {\n\t\tif (caughtError instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: caughtError.issues[0]?.message || \"Validation error\",\n\t\t\t};\n\t\t}\n\n\t\tif (\n\t\t\tcaughtError instanceof Error &&\n\t\t\tcaughtError.message !== \"NEXT_REDIRECT\"\n\t\t) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: caughtError.message,\n\t\t\t};\n\t\t}\n\n\t\tthrow caughtError;\n\t}\n}\n\n/**\n * Sign In - Authenticate existing user with Supabase Auth\n *\n * Features:\n * - Email/password authentication\n * - Session management handled by Supabase\n * - Validates input with Zod\n * - Redirects to dashboard on success\n */\nexport async function signIn(formData: FormData): Promise<AuthActionResult> {\n\ttry {\n\t\t// Bot protection check (Vercel BotID)\n\t\t/*\n\t\tconst botCheck = await checkBotId();\n\t\tif (botCheck.isBot) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Unable to process request. Please try again later.\",\n\t\t\t};\n\t\t}\n\t\t*/\n\n\t\t// Parse and validate form data\n\t\tconst rawData = {\n\t\t\temail: formData.get(\"email\") as string,\n\t\t\tpassword: formData.get(\"password\") as string,\n\t\t};\n\n\t\tconst validatedData = signInSchema.parse(rawData);\n\n\t\t// Rate limit sign-in attempts by email\n\t\ttry {\n\t\t\tawait checkRateLimit(validatedData.email, authRateLimiter);\n\t\t} catch (rateLimitError) {\n\t\t\tif (rateLimitError instanceof RateLimitError) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: rateLimitError.message,\n\t\t\t\t};\n\t\t\t}\n\t\t\tthrow rateLimitError;\n\t\t}\n\n\t\t// Create Supabase client\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Authentication service is not configured. Please check your environment variables.\",\n\t\t\t};\n\t\t}\n\n\t\t// Sign in with Supabase Auth\n\t\tconst { data, error: signInError } = await withSupabaseRateLimitRetry(() =>\n\t\t\tsupabase.auth.signInWithPassword({\n\t\t\t\temail: validatedData.email,\n\t\t\t\tpassword: validatedData.password,\n\t\t\t}),\n\t\t);\n\n\t\tif (signInError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: signInError.message,\n\t\t\t};\n\t\t}\n\n\t\tif (!data.session) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Failed to create session. Please try again.\",\n\t\t\t};\n\t\t}\n\n\t\t// Revalidate and redirect to dashboard\n\t\trevalidatePath(\"/\", \"layout\");\n\t\tredirect(\"/dashboard\");\n\t} catch (caughtError) {\n\t\tif (caughtError instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: caughtError.issues[0]?.message || \"Validation error\",\n\t\t\t};\n\t\t}\n\n\t\t// Handle AuthUnknownError (usually network/service issues)\n\t\tif (caughtError instanceof AuthUnknownError) {\n\t\t\tconsole.error(\"AuthUnknownError during sign in:\", caughtError);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Unable to connect to authentication service. Please check your internet connection and try again.\",\n\t\t\t};\n\t\t}\n\n\t\tif (\n\t\t\tcaughtError instanceof Error &&\n\t\t\tcaughtError.message !== \"NEXT_REDIRECT\"\n\t\t) {\n\t\t\t// Log non-redirect errors for debugging\n\t\t\tconsole.error(\"Sign in error:\", caughtError);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: caughtError.message,\n\t\t\t};\n\t\t}\n\n\t\tthrow caughtError;\n\t}\n}\n\n/**\n * Sign Out - End user session\n *\n * Features:\n * - Clears Supabase session (cookie-based)\n * - Clears CSRF token cookie\n * - Clears active company cookie\n * - Revalidates all cached data\n * - Redirects to login page\n *\n * Security:\n * - Ensures all authentication and security cookies are removed\n * - Prevents session reuse or CSRF attacks after logout\n */\nexport async function signOut(): Promise<AuthActionResult> {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Authentication service is not configured.\",\n\t\t\t};\n\t\t}\n\n\t\t// Sign out from Supabase (clears auth cookies)\n\t\tconst { error: signOutError } = await withSupabaseRateLimitRetry(() =>\n\t\t\tsupabase.auth.signOut(),\n\t\t);\n\n\t\tif (signOutError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: signOutError.message,\n\t\t\t};\n\t\t}\n\n\t\t// Clear all security-related cookies\n\t\tawait clearCSRFToken();\n\t\tawait clearActiveCompany();\n\n\t\t// Revalidate and redirect to login\n\t\trevalidatePath(\"/\", \"layout\");\n\t\tredirect(\"/login\");\n\t} catch (caughtError) {\n\t\tif (\n\t\t\tcaughtError instanceof Error &&\n\t\t\tcaughtError.message !== \"NEXT_REDIRECT\"\n\t\t) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: caughtError.message,\n\t\t\t};\n\t\t}\n\n\t\tthrow caughtError;\n\t}\n}\n\n/**\n * Sign In with OAuth - Authenticate with Google or other providers\n *\n * Features:\n * - OAuth provider authentication\n * - Handles both new signups and existing user logins automatically\n * - Supabase determines if user exists and signs them in or creates new account\n * - Redirects to provider login page\n * - After callback, checks if profile is complete (phone, name)\n */\nexport async function signInWithOAuth(\n\tprovider: \"google\" | \"facebook\",\n): Promise<AuthActionResult> {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Authentication service is not configured.\",\n\t\t\t};\n\t\t}\n\n\t\tconst siteUrl = process.env.NEXT_PUBLIC_SITE_URL;\n\t\tif (!siteUrl) {\n\t\t\tthrow new Error(\"NEXT_PUBLIC_SITE_URL is not configured\");\n\t\t}\n\n\t\tconst { data, error: oauthError } = await withSupabaseRateLimitRetry(() =>\n\t\t\tsupabase.auth.signInWithOAuth({\n\t\t\t\tprovider,\n\t\t\t\toptions: {\n\t\t\t\t\tredirectTo: `${siteUrl}/auth/callback`,\n\t\t\t\t},\n\t\t\t}),\n\t\t);\n\n\t\tif (oauthError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: oauthError.message,\n\t\t\t};\n\t\t}\n\n\t\t// Redirect to OAuth provider\n\t\tif (data.url) {\n\t\t\tredirect(data.url);\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t};\n\t} catch (caughtError) {\n\t\tif (\n\t\t\tcaughtError instanceof Error &&\n\t\t\tcaughtError.message !== \"NEXT_REDIRECT\"\n\t\t) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: caughtError.message,\n\t\t\t};\n\t\t}\n\n\t\tthrow caughtError;\n\t}\n}\n\n/**\n * Forgot Password - Send custom password reset email via Resend\n *\n * Features:\n * - Sends custom branded password reset email via Resend\n * - Secure token generation via Supabase\n * - Custom email template with security information\n */\nasync function forgotPassword(\n\tformData: FormData,\n): Promise<AuthActionResult> {\n\ttry {\n\t\t// Bot protection check (Vercel BotID)\n\t\t/*\n\t\tconst botCheck = await checkBotId();\n\t\tif (botCheck.isBot) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Unable to process request. Please try again later.\",\n\t\t\t};\n\t\t}\n\t\t*/\n\n\t\tconst rawData = {\n\t\t\temail: formData.get(\"email\") as string,\n\t\t};\n\n\t\tconst validatedData = forgotPasswordSchema.parse(rawData);\n\n\t\t// Rate limit password reset requests by email (stricter limit)\n\t\ttry {\n\t\t\tawait checkRateLimit(validatedData.email, passwordResetRateLimiter);\n\t\t} catch (rateLimitError) {\n\t\t\tif (rateLimitError instanceof RateLimitError) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: rateLimitError.message,\n\t\t\t\t};\n\t\t\t}\n\t\t\tthrow rateLimitError;\n\t\t}\n\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Authentication service is not configured.\",\n\t\t\t};\n\t\t}\n\n\t\t// Generate password reset token via Supabase\n\t\tconst { error: resetPasswordError } = await withSupabaseRateLimitRetry(() =>\n\t\t\tsupabase.auth.resetPasswordForEmail(validatedData.email, {\n\t\t\t\tredirectTo: `${emailConfig.siteUrl}/auth/reset-password`,\n\t\t\t}),\n\t\t);\n\n\t\tif (resetPasswordError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: resetPasswordError.message,\n\t\t\t};\n\t\t}\n\n\t\t// Note: Supabase will send its own email with the reset link.\n\t\t// To use custom Resend email instead, you need to:\n\t\t// 1. Disable Supabase's password reset email in the dashboard\n\t\t// 2. Generate your own secure token\n\t\t// 3. Send custom email with that token\n\t\t// For now, we're using Supabase's reset flow but you can customize this\n\n\t\t// TODO: Replace with custom token generation + Resend email\n\t\t// For full custom implementation, see the commented code below:\n\t\t/*\n    const resetToken = generateSecureToken(); // Implement your own token generation\n    await storeResetToken(validatedData.email, resetToken); // Store in your database\n\n    await sendPasswordReset(validatedData.email, {\n      resetUrl: `${emailConfig.siteUrl}/auth/reset-password?token=${resetToken}`,\n      expiresInMinutes: 60,\n    });\n    */\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tmessage: \"Password reset email sent. Please check your inbox.\",\n\t\t\t},\n\t\t};\n\t} catch (caughtError) {\n\t\tif (caughtError instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: caughtError.issues[0]?.message || \"Validation error\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\tcaughtError instanceof Error\n\t\t\t\t\t? caughtError.message\n\t\t\t\t\t: \"Failed to send reset email\",\n\t\t};\n\t}\n}\n\n/**\n * Reset Password - Update password with reset token + Send confirmation email\n *\n * Features:\n * - Updates user password\n * - Validates password strength\n * - Invalidates reset token after use\n * - Sends custom password changed confirmation via Resend\n */\nasync function resetPassword(\n\tformData: FormData,\n): Promise<AuthActionResult> {\n\ttry {\n\t\t// Bot protection check (Vercel BotID)\n\t\t/*\n\t\tconst botCheck = await checkBotId();\n\t\tif (botCheck.isBot) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Unable to process request. Please try again later.\",\n\t\t\t};\n\t\t}\n\t\t*/\n\n\t\tconst rawData = {\n\t\t\tpassword: formData.get(\"password\") as string,\n\t\t\tconfirmPassword: formData.get(\"confirmPassword\") as string,\n\t\t};\n\n\t\tconst validatedData = resetPasswordSchema.parse(rawData);\n\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Authentication service is not configured.\",\n\t\t\t};\n\t\t}\n\n\t\t// Get current user before updating password\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await withSupabaseRateLimitRetry(() => supabase.auth.getUser());\n\n\t\tconst { error: updateUserError } = await withSupabaseRateLimitRetry(() =>\n\t\t\tsupabase.auth.updateUser({\n\t\t\t\tpassword: validatedData.password,\n\t\t\t}),\n\t\t);\n\n\t\tif (updateUserError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: updateUserError.message,\n\t\t\t};\n\t\t}\n\n\t\t// Send password changed confirmation email via Resend\n\t\tif (user?.email) {\n\t\t\tconst emailResult = await sendPasswordChanged(user.email, {\n\t\t\t\tname: user.user_metadata?.name || \"User\",\n\t\t\t\tchangedAt: new Date(),\n\t\t\t});\n\n\t\t\t// Log email send failure but don't block password reset\n\t\t\tif (!emailResult.success) {\n\t\t\t\treportAuthIssue(\n\t\t\t\t\t\"Failed to send password changed email\",\n\t\t\t\t\temailResult.error,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tmessage:\n\t\t\t\t\t\"Password updated successfully. A confirmation email has been sent.\",\n\t\t\t},\n\t\t};\n\t} catch (caughtError) {\n\t\tif (caughtError instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: caughtError.issues[0]?.message || \"Validation error\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\tcaughtError instanceof Error\n\t\t\t\t\t? caughtError.message\n\t\t\t\t\t: \"Failed to reset password\",\n\t\t};\n\t}\n}\n\n/**\n * Get Current User - Retrieve authenticated user data\n *\n * Features:\n * - Returns user session data\n * - Returns null if not authenticated\n * - Can be used in Server Components\n */\nasync function getCurrentUser() {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await withSupabaseRateLimitRetry(() => supabase.auth.getUser());\n\n\t\treturn user;\n\t} catch (caughtError) {\n\t\treportAuthIssue(\"Error getting current user\", caughtError);\n\t\treturn null;\n\t}\n}\n\n/**\n * Get Session - Retrieve current session\n *\n * Features:\n * - Returns session data including access token\n * - Returns null if no active session\n * - Can be used in Server Components\n */\nasync function getSession() {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { session },\n\t\t} = await withSupabaseRateLimitRetry(() => supabase.auth.getSession());\n\n\t\treturn session;\n\t} catch (caughtError) {\n\t\treportAuthIssue(\"Error getting session\", caughtError);\n\t\treturn null;\n\t}\n}\n\n/**\n * Verify Email - Verify user's email with custom token\n *\n * Features:\n * - Validates custom verification token\n * - Updates Supabase user's email_confirmed_at\n * - One-time use tokens with expiration\n * - Sends welcome email after successful verification\n */\nexport async function verifyEmail(token: string): Promise<AuthActionResult> {\n\ttry {\n\t\t// Verify and consume the token\n\t\tconst tokenRecord = await verifyAndConsumeToken(\n\t\t\ttoken,\n\t\t\t\"email_verification\",\n\t\t);\n\n\t\tif (!tokenRecord) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Invalid or expired verification link. Please request a new one.\",\n\t\t\t};\n\t\t}\n\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Authentication service is not configured.\",\n\t\t\t};\n\t\t}\n\n\t\t// Update Supabase user to mark email as verified\n\t\tif (tokenRecord.userId) {\n\t\t\t// Note: profiles table doesn't have email_verified field\n\t\t\t// Email verification is handled through auth.users.email_confirmed_at\n\t\t\t// which is set automatically by Supabase Auth\n\t\t\t// We don't need to manually update profiles table\n\n\t\t\t// Send welcome email after successful verification\n\t\t\tconst welcomeResult = await sendWelcomeEmail(tokenRecord.email, {\n\t\t\t\tname: getMetadataString(tokenRecord.metadata, \"name\") || \"User\",\n\t\t\t\tloginUrl: `${emailConfig.siteUrl}/login`,\n\t\t\t});\n\n\t\t\tif (!welcomeResult.success) {\n\t\t\t\treportAuthIssue(\"Failed to send welcome email\", welcomeResult.error);\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tmessage: \"Email verified successfully! You can now sign in.\",\n\t\t\t\temail: tokenRecord.email,\n\t\t\t},\n\t\t};\n\t} catch (caughtError) {\n\t\treportAuthIssue(\"Error verifying email\", caughtError);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\tcaughtError instanceof Error\n\t\t\t\t\t? caughtError.message\n\t\t\t\t\t: \"Failed to verify email\",\n\t\t};\n\t}\n}\n\n/**\n * Resend Verification Email - Send a new verification email\n *\n * Features:\n * - Generates new verification token\n * - Deletes old tokens for the email\n * - Sends fresh verification email\n */\nasync function resendVerificationEmail(\n\temail: string,\n): Promise<AuthActionResult> {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Authentication service is not configured.\",\n\t\t\t};\n\t\t}\n\n\t\t// Check if user exists\n\t\tconst { data: userData } = await supabase\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"id, full_name, email\")\n\t\t\t.eq(\"email\", email)\n\t\t\t.single();\n\n\t\tif (!userData) {\n\t\t\t// Don't reveal if user exists or not for security\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tdata: {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\t\"If an account exists with this email, a verification link has been sent.\",\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t// Generate new verification token\n\t\tconst { token, expiresAt } = await createEmailVerificationToken(\n\t\t\temail,\n\t\t\tuserData.id,\n\t\t\tCONFIRMATION_TOKEN_TTL_HOURS,\n\t\t);\n\n\t\t// Send verification email\n\t\tconst verificationUrl = `${emailConfig.siteUrl}/auth/verify-email?token=${token}`;\n\n\t\tconst emailResult = await sendEmailVerification(email, {\n\t\t\tname: userData.full_name || \"User\",\n\t\t\tverificationUrl,\n\t\t});\n\n\t\tif (!emailResult.success) {\n\t\t\treportAuthIssue(\"Failed to send verification email\", emailResult.error);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Failed to send verification email. Please try again.\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tmessage: \"A new verification link has been sent to your email.\",\n\t\t\t\texpiresAt: expiresAt.toISOString(),\n\t\t\t},\n\t\t};\n\t} catch (caughtError) {\n\t\treportAuthIssue(\"Error resending verification email\", caughtError);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\tcaughtError instanceof Error\n\t\t\t\t\t? caughtError.message\n\t\t\t\t\t: \"Failed to resend verification email\",\n\t\t};\n\t}\n}\n\n/**\n * Get Active Company ID Action\n *\n * Server action to get the currently active company ID for client components.\n */\nexport async function getCompanyIdAction(): Promise<{\n\tsuccess: boolean;\n\tcompanyId?: string;\n\terror?: string;\n}> {\n\t\"use server\";\n\n\ttry {\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t}\n\n\t\treturn { success: true, companyId };\n\t} catch (error) {\n\t\tconsole.error(\"Error getting company ID:\", error);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4435, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/company-context.ts"],"sourcesContent":["\"use server\";\n\n/**\n * Company Context Server Actions\n *\n * Server Actions for managing active company context.\n * Used by company switcher UI components.\n */\n\nimport { revalidatePath } from \"next/cache\";\nimport {\n\tclearActiveCompany,\n\tgetActiveCompany,\n\tgetUserCompanies,\n\tsetActiveCompany,\n} from \"@/lib/auth/company-context\";\n\n/**\n * Action Result Type\n */\ntype ActionResult<T = void> =\n\t| {\n\t\t\tsuccess: true;\n\t\t\tdata?: T;\n\t\t\tmessage?: string;\n\t  }\n\t| {\n\t\t\tsuccess: false;\n\t\t\terror: string;\n\t  };\n\n/**\n * Switch Company\n *\n * Changes the user's active company context.\n * Revalidates the entire layout to update company-scoped data.\n *\n * @param companyId - Company ID to switch to\n * @returns ActionResult indicating success or failure\n */\nexport async function switchCompany(\n\tcompanyId: string,\n): Promise<ActionResult<void>> {\n\ttry {\n\t\tawait setActiveCompany(companyId);\n\n\t\t// Revalidate everything to ensure all company-scoped data is refreshed\n\t\trevalidatePath(\"/\", \"layout\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: \"Company switched successfully\",\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to switch company\",\n\t\t};\n\t}\n}\n\n/**\n * Clear Active Company\n *\n * Removes the active company context.\n * Useful for logout or company removal flows.\n *\n * @returns ActionResult indicating success or failure\n */\nasync function clearCompany(): Promise<ActionResult<void>> {\n\ttry {\n\t\tawait clearActiveCompany();\n\t\trevalidatePath(\"/\", \"layout\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: \"Company context cleared\",\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to clear company context\",\n\t\t};\n\t}\n}\n\n/**\n * Get User's Companies\n *\n * Returns all companies the user has access to.\n * Useful for populating company switcher dropdowns.\n *\n * @returns ActionResult with array of companies\n */\nasync function getCompanies(): Promise<\n\tActionResult<Array<{ id: string; name: string; logo?: string | null }>>\n> {\n\ttry {\n\t\tconst companies = await getUserCompanies();\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: companies,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to get companies\",\n\t\t};\n\t}\n}\n\n/**\n * Get Active Company Details\n *\n * Returns details about the currently active company.\n *\n * @returns ActionResult with company details or null\n */\nasync function getActiveCompanyDetails(): Promise<\n\tActionResult<{ id: string; name: string; logo?: string | null } | null>\n> {\n\ttry {\n\t\tconst company = await getActiveCompany();\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: company,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get active company\",\n\t\t};\n\t}\n}\n"],"names":[],"mappings":";;;;;AAEA;;;;;CAKC,GAED;AACA;AAAA;;;;;AA8BO,eAAe,cACrB,SAAiB;IAEjB,IAAI;QACH,MAAM,IAAA,iKAAgB,EAAC;QAEvB,uEAAuE;QACvE,IAAA,sTAAc,EAAC,KAAK;QAEpB,OAAO;YACN,SAAS;YACT,SAAS;QACV;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C;IACD;AACD;AAEA;;;;;;;CAOC,GACD,eAAe;IACd,IAAI;QACH,MAAM,IAAA,mKAAkB;QACxB,IAAA,sTAAc,EAAC,KAAK;QAEpB,OAAO;YACN,SAAS;YACT,SAAS;QACV;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAEA;;;;;;;CAOC,GACD,eAAe;IAGd,IAAI;QACH,MAAM,YAAY,MAAM,IAAA,iKAAgB;QAExC,OAAO;YACN,SAAS;YACT,MAAM;QACP;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACjD;IACD;AACD;AAEA;;;;;;CAMC,GACD,eAAe;IAGd,IAAI;QACH,MAAM,UAAU,MAAM,IAAA,iKAAgB;QAEtC,OAAO;YACN,SAAS;YACT,MAAM;QACP;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C;IACD;AACD;;;IApGsB;;AAAA,sZAAA"}},
    {"offset": {"line": 4540, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/user-status.ts"],"sourcesContent":["\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n/**\n * Update user status action\n * Allows users to change their availability status (online, available, busy)\n */\n\nexport type UserStatus = \"online\" | \"available\" | \"busy\";\n\nexport async function updateUserStatus(status: UserStatus) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Database connection failed\",\n\t\t\t};\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t\terror: authError,\n\t\t} = await supabase.auth.getUser();\n\n\t\tif (authError || !user) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Unauthorized\",\n\t\t\t};\n\t\t}\n\n\t\t// Update user status\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"profiles\")\n\t\t\t.update({ status })\n\t\t\t.eq(\"id\", user.id);\n\n\t\tif (updateError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Failed to update status\",\n\t\t\t};\n\t\t}\n\n\t\t// Revalidate all pages to reflect the new status\n\t\trevalidatePath(\"/\", \"layout\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tstatus,\n\t\t};\n\t} catch (_error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"An unexpected error occurred\",\n\t\t};\n\t}\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;;;;;AASO,eAAe,iBAAiB,MAAkB;IACxD,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,mBAAmB;QACnB,MAAM,EACL,MAAM,EAAE,IAAI,EAAE,EACd,OAAO,SAAS,EAChB,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAE/B,IAAI,aAAa,CAAC,MAAM;YACvB,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,qBAAqB;QACrB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,YACL,MAAM,CAAC;YAAE;QAAO,GAChB,EAAE,CAAC,MAAM,KAAK,EAAE;QAElB,IAAI,aAAa;YAChB,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,iDAAiD;QACjD,IAAA,sTAAc,EAAC,KAAK;QAEpB,OAAO;YACN,SAAS;YACT;QACD;IACD,EAAE,OAAO,QAAQ;QAChB,OAAO;YACN,SAAS;YACT,OAAO;QACR;IACD;AACD;;;IAjDsB;;AAAA,sZAAA"}},
    {"offset": {"line": 4600, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/ai-approval.ts"],"sourcesContent":["/**\n * AI Action Approval Server Actions\n *\n * Server actions for owner-only approval of destructive AI actions.\n * These actions wrap the action-approval service for use in React components.\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport {\n\tActionError,\n\tERROR_CODES,\n} from \"@/lib/errors/action-error\";\nimport {\n\ttype ActionResult,\n\tassertAuthenticated,\n\twithErrorHandling,\n} from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport {\n\tapproveAction,\n\trejectAction,\n\tgetPendingActionsForCompany,\n\tgetPendingActionsForChat,\n\tgetPendingAction,\n\tisCompanyOwner,\n\texpireOldActions,\n\ttype PendingAction,\n} from \"@/lib/ai/action-approval\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport type { PendingAction };\n\nexport interface ApprovalActionResult {\n\tsuccess: boolean;\n\terror?: string;\n\tactionId?: string;\n\ttoolName?: string;\n\ttoolArgs?: Record<string, unknown>;\n\t// Execution fields (for approval responses)\n\texecuted?: boolean;\n\texecutionResult?: unknown;\n\texecutionError?: string;\n}\n\n// ============================================================================\n// Validation Schemas\n// ============================================================================\n\nconst approveActionSchema = z.object({\n\tactionId: z.string().uuid(\"Invalid action ID\"),\n});\n\nconst rejectActionSchema = z.object({\n\tactionId: z.string().uuid(\"Invalid action ID\"),\n\treason: z.string().max(500, \"Reason too long\").optional(),\n});\n\nconst getPendingActionsSchema = z.object({\n\tstatus: z.enum([\"pending\", \"approved\", \"rejected\", \"expired\"]).optional(),\n\tlimit: z.number().min(1).max(100).default(50),\n});\n\nconst getChatActionsSchema = z.object({\n\tchatId: z.string().uuid(\"Invalid chat ID\"),\n});\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\nasync function getAuthenticatedUserWithCompany() {\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\tthrow new ActionError(\n\t\t\t\"Database connection failed\",\n\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t);\n\t}\n\n\tconst {\n\t\tdata: { user },\n\t} = await supabase.auth.getUser();\n\tassertAuthenticated(user?.id);\n\n\tconst { data: teamMember } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(\"company_id, role\")\n\t\t.eq(\"user_id\", user.id)\n\t\t.single();\n\n\tif (!teamMember?.company_id) {\n\t\tthrow new ActionError(\n\t\t\t\"You must be part of a company\",\n\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t403,\n\t\t);\n\t}\n\n\treturn {\n\t\tuserId: user.id,\n\t\tcompanyId: teamMember.company_id,\n\t\trole: teamMember.role,\n\t};\n}\n\n// ============================================================================\n// Server Actions\n// ============================================================================\n\n/**\n * Approve a pending AI action - OWNER ONLY\n * This action will be executed immediately after approval\n */\nexport async function approveAIAction(\n\tinput: z.infer<typeof approveActionSchema>,\n): Promise<ActionResult<ApprovalActionResult>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst validated = approveActionSchema.parse(input);\n\t\tconst { userId, companyId } = await getAuthenticatedUserWithCompany();\n\n\t\t// Verify user is owner (double-check even though DB function enforces this)\n\t\tconst ownerCheck = await isCompanyOwner(companyId, userId);\n\t\tif (!ownerCheck) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Only company owners can approve destructive AI actions\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Call the approval function (which calls the DB RPC)\n\t\tconst result = await approveAction(validated.actionId, userId);\n\n\t\tif (!result.success) {\n\t\t\tthrow new ActionError(\n\t\t\t\tresult.error || \"Failed to approve action\",\n\t\t\t\tERROR_CODES.OPERATION_FAILED,\n\t\t\t);\n\t\t}\n\n\t\t// Automatically execute the approved action\n\t\tlet executionResult: { success: boolean; result?: unknown; error?: string } | null = null;\n\t\ttry {\n\t\t\tconst response = await fetch(\n\t\t\t\t`${process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\"}/api/ai/execute-approved`,\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\tactionId: validated.actionId,\n\t\t\t\t\t\tcompanyId,\n\t\t\t\t\t}),\n\t\t\t\t}\n\t\t\t);\n\t\t\texecutionResult = await response.json();\n\t\t} catch (execError) {\n\t\t\tconsole.error(\"Failed to auto-execute approved action:\", execError);\n\t\t\t// Don't fail the approval - execution can be retried\n\t\t}\n\n\t\t// Revalidate AI-related paths\n\t\trevalidatePath(\"/dashboard/ai\");\n\t\trevalidatePath(\"/dashboard/settings/ai\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tactionId: result.actionId,\n\t\t\ttoolName: result.toolName,\n\t\t\ttoolArgs: result.toolArgs,\n\t\t\texecuted: executionResult?.success || false,\n\t\t\texecutionResult: executionResult?.result,\n\t\t\texecutionError: executionResult?.error,\n\t\t};\n\t});\n}\n\n/**\n * Reject a pending AI action - OWNER ONLY\n * The AI will not execute this action\n */\nexport async function rejectAIAction(\n\tinput: z.infer<typeof rejectActionSchema>,\n): Promise<ActionResult<ApprovalActionResult>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst validated = rejectActionSchema.parse(input);\n\t\tconst { userId, companyId } = await getAuthenticatedUserWithCompany();\n\n\t\t// Verify user is owner\n\t\tconst ownerCheck = await isCompanyOwner(companyId, userId);\n\t\tif (!ownerCheck) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Only company owners can reject destructive AI actions\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Call the rejection function\n\t\tconst result = await rejectAction(\n\t\t\tvalidated.actionId,\n\t\t\tuserId,\n\t\t\tvalidated.reason,\n\t\t);\n\n\t\tif (!result.success) {\n\t\t\tthrow new ActionError(\n\t\t\t\tresult.error || \"Failed to reject action\",\n\t\t\t\tERROR_CODES.OPERATION_FAILED,\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate AI-related paths\n\t\trevalidatePath(\"/dashboard/ai\");\n\t\trevalidatePath(\"/dashboard/settings/ai\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tactionId: validated.actionId,\n\t\t};\n\t});\n}\n\n/**\n * Get all pending actions for the current company\n * Used by the owner dashboard to review pending approvals\n */\nexport async function getCompanyPendingActions(\n\tinput?: z.infer<typeof getPendingActionsSchema>,\n): Promise<ActionResult<PendingAction[]>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst validated = input ? getPendingActionsSchema.parse(input) : { limit: 50 };\n\t\tconst { companyId } = await getAuthenticatedUserWithCompany();\n\n\t\t// Expire old actions first\n\t\tawait expireOldActions(companyId);\n\n\t\t// Fetch pending actions\n\t\tconst actions = await getPendingActionsForCompany(companyId, {\n\t\t\tstatus: validated.status,\n\t\t\tlimit: validated.limit,\n\t\t});\n\n\t\treturn actions;\n\t});\n}\n\n/**\n * Get pending actions for a specific chat session\n * Used to show approval banners in the AI chat\n */\nexport async function getChatPendingActions(\n\tinput: z.infer<typeof getChatActionsSchema>,\n): Promise<ActionResult<PendingAction[]>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst validated = getChatActionsSchema.parse(input);\n\t\tconst { companyId } = await getAuthenticatedUserWithCompany();\n\n\t\t// Expire old actions first\n\t\tawait expireOldActions(companyId);\n\n\t\t// Fetch pending actions for the chat\n\t\tconst actions = await getPendingActionsForChat(companyId, validated.chatId);\n\n\t\treturn actions;\n\t});\n}\n\n/**\n * Get a specific pending action by ID\n */\nexport async function getPendingActionById(\n\tactionId: string,\n): Promise<ActionResult<PendingAction | null>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst validated = z.string().uuid(\"Invalid action ID\").parse(actionId);\n\t\tconst { companyId } = await getAuthenticatedUserWithCompany();\n\n\t\tconst action = await getPendingAction(companyId, validated);\n\t\treturn action;\n\t});\n}\n\n/**\n * Check if current user is a company owner\n * Used by UI to determine if approval buttons should be enabled\n */\nexport async function checkIsCompanyOwner(): Promise<ActionResult<boolean>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst { userId, companyId } = await getAuthenticatedUserWithCompany();\n\t\tconst isOwner = await isCompanyOwner(companyId, userId);\n\t\treturn isOwner;\n\t});\n}\n\n/**\n * Get pending action counts for notifications\n */\nexport async function getPendingActionCounts(): Promise<\n\tActionResult<{\n\t\ttotal: number;\n\t\tbyRiskLevel: Record<string, number>;\n\t}>\n> {\n\treturn await withErrorHandling(async () => {\n\t\tconst { companyId } = await getAuthenticatedUserWithCompany();\n\n\t\t// Expire old actions first\n\t\tawait expireOldActions(companyId);\n\n\t\t// Fetch pending actions\n\t\tconst actions = await getPendingActionsForCompany(companyId, {\n\t\t\tstatus: \"pending\",\n\t\t\tlimit: 100,\n\t\t});\n\n\t\t// Group by risk level\n\t\tconst byRiskLevel: Record<string, number> = {\n\t\t\tlow: 0,\n\t\t\tmedium: 0,\n\t\t\thigh: 0,\n\t\t\tcritical: 0,\n\t\t};\n\n\t\tfor (const action of actions) {\n\t\t\tbyRiskLevel[action.riskLevel] = (byRiskLevel[action.riskLevel] || 0) + 1;\n\t\t}\n\n\t\treturn {\n\t\t\ttotal: actions.length,\n\t\t\tbyRiskLevel,\n\t\t};\n\t});\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4838, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/customers.ts"],"sourcesContent":["/**\n * Customer Management Server Actions\n *\n * Comprehensive customer relationship management with:\n * - Customer CRUD operations\n * - Customer portal invitation and access\n * - Customer metrics tracking (revenue, jobs, invoices)\n * - Communication preferences\n * - Soft delete/archive support\n * - Customer search and filtering\n */\n\n\"use server\";\n\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport { sendEmail } from \"@/lib/email/email-sender\";\nimport { EmailTemplate } from \"@/lib/email/email-types\";\nimport {\n    ActionError,\n    ERROR_CODES,\n    ERROR_MESSAGES,\n} from \"@/lib/errors/action-error\";\nimport {\n    type ActionResult,\n    assertAuthenticated,\n    assertExists,\n    withErrorHandling,\n} from \"@/lib/errors/with-error-handling\";\nimport { geocodeAddressSilent } from \"@/lib/services/geocoding\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport PortalInvitationEmail from \"../../emails/templates/customer/portal-invitation\";\n\n// ============================================================================\n// VALIDATION SCHEMAS\n// ============================================================================\n\nconst CUSTOMER_NAME_MAX_LENGTH = 100;\nconst CUSTOMER_COMPANY_MAX_LENGTH = 200;\nconst CUSTOMER_PHONE_MAX_LENGTH = 20;\nconst CUSTOMER_ADDRESS_MAX_LENGTH = 200;\nconst CUSTOMER_ADDRESS2_MAX_LENGTH = 100;\nconst CUSTOMER_CITY_MAX_LENGTH = 100;\nconst CUSTOMER_STATE_MAX_LENGTH = 50;\n\n// HTTP Status codes\nconst HTTP_STATUS_FORBIDDEN = 403;\n\n// Search defaults\nconst DEFAULT_SEARCH_LIMIT = 50;\nconst CUSTOMER_ZIP_MAX_LENGTH = 20;\nconst CUSTOMER_COUNTRY_MAX_LENGTH = 50;\nconst CUSTOMER_TAX_EXEMPT_NUMBER_MAX_LENGTH = 50;\nconst CENTS_PER_DOLLAR = 100;\n\nfunction requireSiteUrl(): string {\n\tconst siteUrl = process.env.NEXT_PUBLIC_SITE_URL;\n\tif (!siteUrl) {\n\t\tthrow new ActionError(\n\t\t\t\"NEXT_PUBLIC_SITE_URL is not configured\",\n\t\t\tERROR_CODES.INTERNAL_SERVER_ERROR,\n\t\t);\n\t}\n\treturn siteUrl.replace(/\\/$/, \"\");\n}\n\nconst customerSchema = z.object({\n\ttype: z\n\t\t.enum([\"residential\", \"commercial\", \"industrial\"])\n\t\t.default(\"residential\"),\n\tfirstName: z\n\t\t.string()\n\t\t.min(1, \"First name is required\")\n\t\t.max(CUSTOMER_NAME_MAX_LENGTH),\n\tlastName: z\n\t\t.string()\n\t\t.min(1, \"Last name is required\")\n\t\t.max(CUSTOMER_NAME_MAX_LENGTH),\n\tcompanyName: z.string().max(CUSTOMER_COMPANY_MAX_LENGTH).optional(),\n\temail: z.string().email(\"Invalid email address\"),\n\tphone: z.string().min(1, \"Phone is required\").max(CUSTOMER_PHONE_MAX_LENGTH),\n\tsecondaryPhone: z.string().max(CUSTOMER_PHONE_MAX_LENGTH).optional(),\n\taddress: z.string().max(CUSTOMER_ADDRESS_MAX_LENGTH).optional(),\n\taddress2: z.string().max(CUSTOMER_ADDRESS2_MAX_LENGTH).optional(),\n\tcity: z.string().max(CUSTOMER_CITY_MAX_LENGTH).optional(),\n\tstate: z.string().max(CUSTOMER_STATE_MAX_LENGTH).optional(),\n\tzipCode: z.string().max(CUSTOMER_ZIP_MAX_LENGTH).optional(),\n\tcountry: z.string().max(CUSTOMER_COUNTRY_MAX_LENGTH).default(\"USA\"),\n\tsource: z\n\t\t.enum([\"referral\", \"google\", \"facebook\", \"direct\", \"yelp\", \"other\"])\n\t\t.optional(),\n\treferredBy: z.string().uuid().optional().nullable(),\n\tpreferredContactMethod: z.enum([\"email\", \"phone\", \"sms\"]).default(\"email\"),\n\tpreferredTechnician: z.string().uuid().optional().nullable(),\n\tbillingEmail: z.string().email().optional().nullable(),\n\tpaymentTerms: z\n\t\t.enum([\"due_on_receipt\", \"net_15\", \"net_30\", \"net_60\"])\n\t\t.default(\"due_on_receipt\"),\n\tcreditLimit: z.number().int().min(0).default(0), // In cents\n\ttaxExempt: z.boolean().default(false),\n\ttaxExemptNumber: z\n\t\t.string()\n\t\t.max(CUSTOMER_TAX_EXEMPT_NUMBER_MAX_LENGTH)\n\t\t.optional(),\n\ttags: z.array(z.string()).optional(),\n\tnotes: z.string().optional(),\n\tinternalNotes: z.string().optional(),\n});\n\nconst communicationPreferencesSchema = z.object({\n\temail: z.boolean().default(true),\n\tsms: z.boolean().default(true),\n\tphone: z.boolean().default(true),\n\tmarketing: z.boolean().default(false),\n});\n\n// ============================================================================\n// CUSTOMER CRUD OPERATIONS\n// ============================================================================\n\n/**\n * Create a new customer with multiple contacts and properties\n */\nasync function createCustomer(\n\tformData: FormData,\n): Promise<ActionResult<string>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\t\tconst { contacts, properties, tags } =\n\t\t\tparseCustomerContactsPropertiesAndTags(formData);\n\t\tconst primaryContact = getPrimaryContactOrThrow(contacts);\n\t\tconst primaryProperty = getPrimaryProperty(properties);\n\n\t\tawait assertCustomerEmailNotDuplicate(\n\t\t\tsupabase,\n\t\t\tteamMember.company_id,\n\t\t\tprimaryContact.email,\n\t\t);\n\n\t\tconst customerType = formData.get(\"type\") || \"residential\";\n\t\tconst companyName = formData.get(\"companyName\");\n\t\tconst displayName = buildCustomerDisplayName(\n\t\t\tcustomerType,\n\t\t\tcompanyName,\n\t\t\tprimaryContact,\n\t\t);\n\n\t\tconst communicationPreferences = buildDefaultCommunicationPreferences();\n\t\tconst customerMetadata = buildCustomerMetadata(contacts);\n\n\t\tconst { lat: customerLat, lon: customerLon } =\n\t\t\tawait geocodePrimaryPropertyIfAvailable(primaryProperty);\n\n\t\tconst customer = await insertCustomerRecord(supabase, {\n\t\t\tcompanyId: teamMember.company_id,\n\t\t\tcustomerType,\n\t\t\tprimaryContact,\n\t\t\tcompanyNameValue: companyName,\n\t\t\tdisplayName,\n\t\t\tprimaryProperty,\n\t\t\tcustomerLat,\n\t\t\tcustomerLon,\n\t\t\tformData,\n\t\t\ttags,\n\t\t\tcommunicationPreferences,\n\t\t\tcustomerMetadata,\n\t\t});\n\n\t\tawait insertAdditionalPropertiesIfAny(\n\t\t\tsupabase,\n\t\t\tteamMember.company_id,\n\t\t\tcustomer.id,\n\t\t\tproperties,\n\t\t);\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\treturn customer.id;\n\t});\n}\n\ntype ParsedCustomerContact = {\n\tfirstName: string;\n\tlastName: string;\n\temail: string;\n\tphone: string;\n\trole: string;\n\tisPrimary: boolean;\n};\n\ntype ParsedCustomerProperty = {\n\tname: string;\n\taddress: string;\n\taddress2: string;\n\tcity: string;\n\tstate: string;\n\tzipCode: string;\n\tcountry: string;\n\tpropertyType: string;\n\tisPrimary: boolean;\n\tnotes: string;\n};\n\ntype ParsedCustomerFormCollections = {\n\tcontacts: ParsedCustomerContact[];\n\tproperties: ParsedCustomerProperty[];\n\ttags?: string[];\n};\n\nasync function requireCustomerCompanyMembership(\n\tsupabase: NonNullable<Awaited<ReturnType<typeof createClient>>>,\n\tuserId: string,\n) {\n\tconst { data: teamMember } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(\"company_id\")\n\t\t.eq(\"user_id\", userId)\n\t\t.single();\n\n\tif (!teamMember?.company_id) {\n\t\tthrow new ActionError(\n\t\t\t\"You must be part of a company\",\n\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t);\n\t}\n\n\treturn teamMember;\n}\n\nfunction parseCustomerContactsPropertiesAndTags(\n\tformData: FormData,\n): ParsedCustomerFormCollections {\n\tconst contacts = parseContacts(formData.get(\"contacts\"));\n\tconst properties = parseProperties(formData.get(\"properties\"));\n\tconst tags = parseTagsField(formData.get(\"tags\"));\n\n\treturn { contacts, properties, tags };\n}\n\nfunction parseContacts(\n\tvalue: FormDataEntryValue | null,\n): ParsedCustomerContact[] {\n\tif (!value || typeof value !== \"string\") {\n\t\treturn [];\n\t}\n\n\ttry {\n\t\treturn JSON.parse(value) as ParsedCustomerContact[];\n\t} catch {\n\t\tthrow new ActionError(\n\t\t\t\"Invalid contacts data\",\n\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t);\n\t}\n}\n\nfunction parseProperties(\n\tvalue: FormDataEntryValue | null,\n): ParsedCustomerProperty[] {\n\tif (!value || typeof value !== \"string\") {\n\t\treturn [];\n\t}\n\n\ttry {\n\t\treturn JSON.parse(value) as ParsedCustomerProperty[];\n\t} catch {\n\t\tthrow new ActionError(\n\t\t\t\"Invalid properties data\",\n\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t);\n\t}\n}\n\nfunction parseTagsField(\n\tvalue: FormDataEntryValue | null,\n): string[] | undefined {\n\tif (!value || typeof value !== \"string\") {\n\t\treturn;\n\t}\n\n\ttry {\n\t\treturn JSON.parse(value) as string[];\n\t} catch {\n\t\treturn value.split(\",\").map((t) => t.trim());\n\t}\n}\n\nfunction getPrimaryContactOrThrow(\n\tcontacts: ParsedCustomerContact[],\n): ParsedCustomerContact {\n\tconst primaryContact = contacts.find((c) => c.isPrimary) || contacts[0];\n\tif (!primaryContact) {\n\t\tthrow new ActionError(\n\t\t\t\"At least one contact is required\",\n\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t);\n\t}\n\treturn primaryContact;\n}\n\nfunction getPrimaryProperty(\n\tproperties: ParsedCustomerProperty[],\n): ParsedCustomerProperty | undefined {\n\treturn properties.find((p) => p.isPrimary) || properties[0];\n}\n\nasync function assertCustomerEmailNotDuplicate(\n\tsupabase: NonNullable<Awaited<ReturnType<typeof createClient>>>,\n\tcompanyId: string,\n\temail: string,\n) {\n\tconst { data: existingEmail } = await supabase\n\t\t.from(\"customers\")\n\t\t.select(\"id\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"email\", email)\n\t\t.is(\"deleted_at\", null)\n\t\t.single();\n\n\tif (existingEmail) {\n\t\tthrow new ActionError(\n\t\t\t\"A customer with this email already exists\",\n\t\t\tERROR_CODES.DB_DUPLICATE_ENTRY,\n\t\t);\n\t}\n}\n\nfunction buildCustomerDisplayName(\n\tcustomerType: FormDataEntryValue | null,\n\tcompanyNameValue: FormDataEntryValue | null,\n\tprimaryContact: ParsedCustomerContact,\n): string {\n\tconst companyName = companyNameValue ? String(companyNameValue) : null;\n\n\tif (customerType === \"commercial\" && companyName) {\n\t\treturn companyName;\n\t}\n\n\treturn `${primaryContact.firstName} ${primaryContact.lastName}`;\n}\n\nfunction buildDefaultCommunicationPreferences() {\n\treturn {\n\t\temail: true,\n\t\tsms: true,\n\t\tphone: true,\n\t\tmarketing: false,\n\t};\n}\n\nfunction buildCustomerMetadata(contacts: ParsedCustomerContact[]) {\n\treturn {\n\t\tcontacts: contacts.map((c) => ({\n\t\t\tfirstName: c.firstName,\n\t\t\tlastName: c.lastName,\n\t\t\temail: c.email,\n\t\t\tphone: c.phone,\n\t\t\trole: c.role,\n\t\t\tisPrimary: c.isPrimary,\n\t\t})),\n\t};\n}\n\nasync function geocodePrimaryPropertyIfAvailable(\n\tprimaryProperty: ParsedCustomerProperty | undefined,\n): Promise<{ lat: number | null; lon: number | null }> {\n\tif (\n\t\t!(\n\t\t\tprimaryProperty?.address &&\n\t\t\tprimaryProperty.city &&\n\t\t\tprimaryProperty.state &&\n\t\t\tprimaryProperty.zipCode\n\t\t)\n\t) {\n\t\treturn { lat: null, lon: null };\n\t}\n\n\tconst geocodeResult = await geocodeAddressSilent(\n\t\tprimaryProperty.address,\n\t\tprimaryProperty.city,\n\t\tprimaryProperty.state,\n\t\tprimaryProperty.zipCode,\n\t\tprimaryProperty.country || \"USA\",\n\t);\n\n\tif (!geocodeResult) {\n\t\treturn { lat: null, lon: null };\n\t}\n\n\treturn { lat: geocodeResult.lat, lon: geocodeResult.lon };\n}\n\ntype InsertCustomerParams = {\n\tcompanyId: string;\n\tcustomerType: FormDataEntryValue | null;\n\tprimaryContact: ParsedCustomerContact;\n\tcompanyNameValue: FormDataEntryValue | null;\n\tdisplayName: string;\n\tprimaryProperty?: ParsedCustomerProperty;\n\tcustomerLat: number | null;\n\tcustomerLon: number | null;\n\tformData: FormData;\n\ttags?: string[];\n\tcommunicationPreferences: {\n\t\temail: boolean;\n\t\tsms: boolean;\n\t\tphone: boolean;\n\t\tmarketing: boolean;\n\t};\n\tcustomerMetadata: Record<string, unknown>;\n};\n\nasync function insertCustomerRecord(\n\tsupabase: NonNullable<Awaited<ReturnType<typeof createClient>>>,\n\tparams: InsertCustomerParams,\n) {\n\tconst payload = buildCustomerInsertPayload(params);\n\n\tconst { data: customer, error: createError } = await supabase\n\t\t.from(\"customers\")\n\t\t.insert(payload)\n\t\t.select(\"id\")\n\t\t.single();\n\n\tif (createError || !customer) {\n\t\tthrow new ActionError(\n\t\t\tERROR_MESSAGES.operationFailed(\"create customer\"),\n\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t);\n\t}\n\n\treturn customer;\n}\n\nfunction buildCustomerInsertPayload(\n\tparams: InsertCustomerParams,\n): Record<string, unknown> {\n\tconst {\n\t\tcompanyId,\n\t\tcustomerType,\n\t\tprimaryContact,\n\t\tcompanyNameValue,\n\t\tdisplayName,\n\t\tprimaryProperty,\n\t\tcustomerLat,\n\t\tcustomerLon,\n\t\tformData,\n\t\ttags,\n\t\tcommunicationPreferences,\n\t\tcustomerMetadata,\n\t} = params;\n\n\tconst companyName = companyNameValue ? String(companyNameValue) : null;\n\n\treturn {\n\t\tcompany_id: companyId,\n\t\ttype: String(customerType || \"residential\"),\n\t\tfirst_name: primaryContact.firstName,\n\t\tlast_name: primaryContact.lastName,\n\t\tcompany_name: companyName,\n\t\tdisplay_name: displayName,\n\t\temail: primaryContact.email,\n\t\tphone: primaryContact.phone,\n\t\tsecondary_phone: null,\n\t\taddress: primaryProperty?.address || null,\n\t\taddress2: primaryProperty?.address2 || null,\n\t\tcity: primaryProperty?.city || null,\n\t\tstate: primaryProperty?.state || null,\n\t\tzip_code: primaryProperty?.zipCode || null,\n\t\tcountry: primaryProperty?.country || \"USA\",\n\t\tlat: customerLat,\n\t\tlon: customerLon,\n\t\tsource: formData.get(\"source\") ? String(formData.get(\"source\")) : null,\n\t\treferred_by: formData.get(\"referredBy\")\n\t\t\t? String(formData.get(\"referredBy\"))\n\t\t\t: null,\n\t\tpreferred_contact_method:\n\t\t\tString(formData.get(\"preferredContactMethod\")) || \"email\",\n\t\tpreferred_technician: formData.get(\"preferredTechnician\")\n\t\t\t? String(formData.get(\"preferredTechnician\"))\n\t\t\t: null,\n\t\tbilling_email: formData.get(\"billingEmail\")\n\t\t\t? String(formData.get(\"billingEmail\"))\n\t\t\t: null,\n\t\tpayment_terms: String(formData.get(\"paymentTerms\")) || \"due_on_receipt\",\n\t\tcredit_limit: formData.get(\"creditLimit\")\n\t\t\t? Number(formData.get(\"creditLimit\")) * CENTS_PER_DOLLAR\n\t\t\t: 0,\n\t\ttax_exempt: formData.get(\"taxExempt\") === \"on\",\n\t\ttax_exempt_number: formData.get(\"taxExemptNumber\")\n\t\t\t? String(formData.get(\"taxExemptNumber\"))\n\t\t\t: null,\n\t\ttags: tags || null,\n\t\tcommunication_preferences: communicationPreferences,\n\t\tnotes: formData.get(\"notes\") ? String(formData.get(\"notes\")) : null,\n\t\tinternal_notes: formData.get(\"internalNotes\")\n\t\t\t? String(formData.get(\"internalNotes\"))\n\t\t\t: null,\n\t\tmetadata: customerMetadata,\n\t\tstatus: \"active\",\n\t\tportal_enabled: false,\n\t\ttotal_revenue: 0,\n\t\ttotal_jobs: 0,\n\t\ttotal_invoices: 0,\n\t\taverage_job_value: 0,\n\t\toutstanding_balance: 0,\n\t};\n}\n\nasync function insertAdditionalPropertiesIfAny(\n\tsupabase: NonNullable<Awaited<ReturnType<typeof createClient>>>,\n\tcompanyId: string,\n\tcustomerId: string,\n\tproperties: ParsedCustomerProperty[],\n) {\n\tconst additionalProperties = properties.filter((p) => !p.isPrimary);\n\tif (additionalProperties.length === 0) {\n\t\treturn;\n\t}\n\n\tconst propertiesToInsert = await Promise.all(\n\t\tadditionalProperties.map(async (prop) => {\n\t\t\tlet propLat: number | null = null;\n\t\t\tlet propLon: number | null = null;\n\n\t\t\tif (prop.address && prop.city && prop.state && prop.zipCode) {\n\t\t\t\tconst geocodeResult = await geocodeAddressSilent(\n\t\t\t\t\tprop.address,\n\t\t\t\t\tprop.city,\n\t\t\t\t\tprop.state,\n\t\t\t\t\tprop.zipCode,\n\t\t\t\t\tprop.country || \"USA\",\n\t\t\t\t);\n\n\t\t\t\tif (geocodeResult) {\n\t\t\t\t\tpropLat = geocodeResult.lat;\n\t\t\t\t\tpropLon = geocodeResult.lon;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: customerId,\n\t\t\t\tname: prop.name || \"Additional Property\",\n\t\t\t\taddress: prop.address,\n\t\t\t\taddress2: prop.address2 || null,\n\t\t\t\tcity: prop.city,\n\t\t\t\tstate: prop.state,\n\t\t\t\tzip_code: prop.zipCode,\n\t\t\t\tcountry: prop.country || \"USA\",\n\t\t\t\tproperty_type: prop.propertyType || \"residential\",\n\t\t\t\tnotes: prop.notes || null,\n\t\t\t\tlat: propLat,\n\t\t\t\tlon: propLon,\n\t\t\t};\n\t\t}),\n\t);\n\n\tawait supabase.from(\"properties\").insert(propertiesToInsert);\n}\n\n/**\n * Update existing customer\n */\nasync function updateCustomer(\n\tcustomerId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id, email\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Parse tags if provided\n\t\tlet tags: string[] | undefined;\n\t\tconst tagsString = formData.get(\"tags\");\n\t\tif (tagsString && typeof tagsString === \"string\") {\n\t\t\ttry {\n\t\t\t\ttags = JSON.parse(tagsString);\n\t\t\t} catch {\n\t\t\t\ttags = tagsString.split(\",\").map((t) => t.trim());\n\t\t\t}\n\t\t}\n\n\t\t// Validate input\n\t\tconst data = customerSchema.parse({\n\t\t\ttype: formData.get(\"type\") || \"residential\",\n\t\t\tfirstName: formData.get(\"firstName\"),\n\t\t\tlastName: formData.get(\"lastName\"),\n\t\t\tcompanyName: formData.get(\"companyName\") || undefined,\n\t\t\temail: formData.get(\"email\"),\n\t\t\tphone: formData.get(\"phone\"),\n\t\t\tsecondaryPhone: formData.get(\"secondaryPhone\") || undefined,\n\t\t\taddress: formData.get(\"address\") || undefined,\n\t\t\taddress2: formData.get(\"address2\") || undefined,\n\t\t\tcity: formData.get(\"city\") || undefined,\n\t\t\tstate: formData.get(\"state\") || undefined,\n\t\t\tzipCode: formData.get(\"zipCode\") || undefined,\n\t\t\tcountry: formData.get(\"country\") || \"USA\",\n\t\t\tsource: formData.get(\"source\") || undefined,\n\t\t\treferredBy: formData.get(\"referredBy\") || null,\n\t\t\tpreferredContactMethod: formData.get(\"preferredContactMethod\") || \"email\",\n\t\t\tpreferredTechnician: formData.get(\"preferredTechnician\") || null,\n\t\t\tbillingEmail: formData.get(\"billingEmail\") || null,\n\t\t\tpaymentTerms: formData.get(\"paymentTerms\") || \"due_on_receipt\",\n\t\t\tcreditLimit: formData.get(\"creditLimit\")\n\t\t\t\t? Number(formData.get(\"creditLimit\"))\n\t\t\t\t: 0,\n\t\t\ttaxExempt: formData.get(\"taxExempt\") === \"true\",\n\t\t\ttaxExemptNumber: formData.get(\"taxExemptNumber\") || undefined,\n\t\t\ttags,\n\t\t\tnotes: formData.get(\"notes\") || undefined,\n\t\t\tinternalNotes: formData.get(\"internalNotes\") || undefined,\n\t\t});\n\n\t\t// Check if email already exists (excluding current customer)\n\t\tif (data.email !== customer.email) {\n\t\t\tconst { data: existingEmail } = await supabase\n\t\t\t\t.from(\"customers\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t\t.eq(\"email\", data.email)\n\t\t\t\t.neq(\"id\", customerId)\n\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t.single();\n\n\t\t\tif (existingEmail) {\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\t\"A customer with this email already exists\",\n\t\t\t\t\tERROR_CODES.DB_DUPLICATE_ENTRY,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Generate display name\n\t\tconst displayName =\n\t\t\tdata.type === \"commercial\" && data.companyName\n\t\t\t\t? data.companyName\n\t\t\t\t: `${data.firstName} ${data.lastName}`;\n\n\t\tconst companyName = data.companyName ? String(data.companyName) : null;\n\n\t\t// Update customer\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({\n\t\t\t\ttype: data.type,\n\t\t\t\tfirst_name: data.firstName,\n\t\t\t\tlast_name: data.lastName,\n\t\t\t\tcompany_name: companyName,\n\t\t\t\tdisplay_name: displayName,\n\t\t\t\temail: data.email,\n\t\t\t\tphone: data.phone,\n\t\t\t\tsecondary_phone: data.secondaryPhone,\n\t\t\t\taddress: data.address,\n\t\t\t\taddress2: data.address2,\n\t\t\t\tcity: data.city,\n\t\t\t\tstate: data.state,\n\t\t\t\tzip_code: data.zipCode,\n\t\t\t\tcountry: data.country,\n\t\t\t\tsource: data.source,\n\t\t\t\treferred_by: data.referredBy,\n\t\t\t\tpreferred_contact_method: data.preferredContactMethod,\n\t\t\t\tpreferred_technician: data.preferredTechnician,\n\t\t\t\tbilling_email: data.billingEmail,\n\t\t\t\tpayment_terms: data.paymentTerms,\n\t\t\t\tcredit_limit: data.creditLimit,\n\t\t\t\ttax_exempt: data.taxExempt,\n\t\t\t\ttax_exempt_number: data.taxExemptNumber,\n\t\t\t\ttags: data.tags,\n\t\t\t\tnotes: data.notes,\n\t\t\t\tinternal_notes: data.internalNotes,\n\t\t\t})\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update customer\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n/**\n * Delete customer (soft delete/archive)\n */\nexport async function deleteCustomer(\n\tcustomerId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id, outstanding_balance\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Prevent deletion if customer has outstanding balance\n\t\tif (customer.outstanding_balance > 0) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Cannot delete customer with outstanding balance. Collect payment first.\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Soft delete\n\t\tconst { error: deleteError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: user.id,\n\t\t\t\tstatus: \"archived\",\n\t\t\t})\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (deleteError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"delete customer\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t});\n}\n\n// ============================================================================\n// CUSTOMER STATUS & PREFERENCES\n// ============================================================================\n\n/**\n * Update customer status\n */\nasync function updateCustomerStatus(\n\tcustomerId: string,\n\tstatus: \"active\" | \"inactive\" | \"archived\" | \"blocked\",\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Update status\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({ status })\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update customer status\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n/**\n * Update communication preferences\n */\nasync function updateCommunicationPreferences(\n\tcustomerId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Validate input\n\t\tconst preferences = communicationPreferencesSchema.parse({\n\t\t\temail: formData.get(\"email\") === \"true\",\n\t\t\tsms: formData.get(\"sms\") === \"true\",\n\t\t\tphone: formData.get(\"phone\") === \"true\",\n\t\t\tmarketing: formData.get(\"marketing\") === \"true\",\n\t\t});\n\n\t\t// Update preferences\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({ communication_preferences: preferences })\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update communication preferences\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n// ============================================================================\n// CUSTOMER PORTAL\n// ============================================================================\n\n/**\n * Invite customer to portal\n * Sends an email with a secure token-based invitation link.\n */\nasync function inviteToPortal(\n\tcustomerId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id, email, display_name, portal_enabled\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\tif (customer.portal_enabled) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer is already invited to portal\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Generate secure portal invitation token\n\t\tconst inviteToken = Buffer.from(\n\t\t\t`${customerId}:${Date.now()}:${Math.random()}`,\n\t\t).toString(\"base64url\");\n\n\t\t// Update customer\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({\n\t\t\t\tportal_enabled: true,\n\t\t\t\tportal_invited_at: new Date().toISOString(),\n\t\t\t})\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"invite customer to portal\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Send invitation email\n\t\tconst siteUrl = requireSiteUrl();\n\t\tconst portalUrl = `${siteUrl}/portal/setup?token=${inviteToken}`;\n\n\t\tconst emailResult = await sendEmail({\n\t\t\tto: customer.email,\n\t\t\tsubject: \"You've been invited to your Customer Portal\",\n\t\t\ttemplate: PortalInvitationEmail({\n\t\t\t\tcustomerName: customer.display_name,\n\t\t\t\tportalUrl,\n\t\t\t\texpiresInHours: 168, // 7 days\n\t\t\t\tsupportEmail: process.env.RESEND_FROM_EMAIL || \"support@thorbis.com\",\n\t\t\t\tsupportPhone: \"(555) 123-4567\",\n\t\t\t}),\n\t\t\ttemplateType: EmailTemplate.PORTAL_INVITATION,\n\t\t});\n\n\t\tif (!emailResult.success) {\n\t\t\treturn;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n/**\n * Revoke portal access\n */\nasync function revokePortalAccess(\n\tcustomerId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Revoke access\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({ portal_enabled: false })\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"revoke portal access\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n// ============================================================================\n// SEARCH & REPORTING\n// ============================================================================\n\n/**\n * Get customer by phone number\n * Used for incoming call lookups\n */\nexport async function getCustomerByPhone(\n\tphoneNumber: string,\n\tcompanyId: string,\n): Promise<ActionResult<unknown>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Normalize phone number (remove formatting)\n\t\tconst normalizedPhone = phoneNumber.replace(/\\D/g, \"\");\n\n\t\t// Search by primary phone or secondary phone\n\t\tconst { data: customer, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        properties:properties(*)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.or(\n\t\t\t\t`phone.eq.${phoneNumber},phone.eq.${normalizedPhone},secondary_phone.eq.${phoneNumber},secondary_phone.eq.${normalizedPhone}`,\n\t\t\t)\n\t\t\t.single();\n\n\t\tif (error && error.code !== \"PGRST116\") {\n\t\t\t// PGRST116 = no rows found\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to find customer: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn customer || null;\n\t});\n}\n\n/**\n * Search customers by name, email, phone, or company\n */\nexport async function searchCustomers(\n\tsearchTerm: string,\n\toptions?: { limit?: number; offset?: number },\n): Promise<ActionResult<unknown[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Use the active company ID helper (same as getAllCustomers)\n\t\tconst activeCompanyId = await getActiveCompanyId();\n\t\tif (!activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"No active company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Verify user has access to the active company\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.maybeSingle();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You don't have access to this company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Use full-text search with ranking for best matches\n\t\t// Searches across: first_name, last_name, display_name, email, phone,\n\t\t// secondary_phone, company_name, address, city, state\n\t\t// Returns results ordered by relevance (weighted: name > contact > address)\n\t\tconst { searchCustomersFullText } = await import(\n\t\t\t\"@/lib/search/full-text-search\"\n\t\t);\n\n\t\tconst customers = await searchCustomersFullText(\n\t\t\tsupabase,\n\t\t\tactiveCompanyId,\n\t\t\tsearchTerm,\n\t\t\t{\n\t\t\t\tlimit: options?.limit || DEFAULT_SEARCH_LIMIT,\n\t\t\t\toffset: options?.offset || 0,\n\t\t\t},\n\t\t);\n\n\t\treturn customers;\n\t});\n}\n\n/**\n * Get top customers by revenue\n */\nasync function getTopCustomers(\n\tlimit = 10,\n): Promise<ActionResult<unknown[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\tconst { data: customers, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"total_revenue\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch top customers\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn customers || [];\n\t});\n}\n\n/**\n * Get customers with outstanding balance\n */\ntype CustomerWithBalance = {\n\tid: string;\n\tdisplay_name: string;\n\tbalance: number;\n};\n\nasync function getCustomersWithBalance(): Promise<\n\tActionResult<CustomerWithBalance[]>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\tconst { data: customers, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.gt(\"outstanding_balance\", 0)\n\t\t\t.order(\"outstanding_balance\", { ascending: false })\n\t\t\t.limit(100);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch customers with balance\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn customers || [];\n\t});\n}\n\ntype CustomerRecord = {\n\tid: string;\n\tcompany_id: string;\n\ttype: string;\n\tfirst_name: string;\n\tlast_name: string;\n\tdisplay_name: string;\n\tcompany_name?: string | null;\n\temail: string;\n\tphone: string;\n\tsecondary_phone?: string;\n\taddress?: string;\n\taddress2?: string;\n\tcity?: string;\n\tstate?: string;\n\tzip_code?: string;\n\tstatus: string;\n\ttotal_revenue?: number;\n\ttotal_jobs?: number;\n\ttotal_invoices?: number;\n\toutstanding_balance?: number;\n\tlast_job_date?: string;\n\tnext_scheduled_job?: string;\n\tcreated_at: string;\n\tupdated_at: string;\n\tarchived_at?: string | null;\n\tdeleted_at?: string | null;\n};\n\n/**\n * Get customers for phone dialer (lightweight, no enrichment)\n *\n * PERFORMANCE: Returns only basic contact info needed for dialer.\n * Use this instead of getAllCustomers() in AppHeader to avoid N+1 queries.\n *\n * Expected: 50-100ms (single query)\n * vs getAllCustomers(): 1200-2000ms (151 queries with enrichment)\n */\nexport async function getCustomersForDialer(): Promise<\n\tActionResult<\n\t\tArray<{\n\t\t\tid: string;\n\t\t\tfirst_name: string | null;\n\t\t\tlast_name: string | null;\n\t\t\tdisplay_name: string | null;\n\t\t\temail: string | null;\n\t\t\tphone: string | null;\n\t\t\tsecondary_phone?: string | null;\n\t\t\tcompany_name: string | null;\n\t\t\taddress: string | null;\n\t\t\taddress2: string | null;\n\t\t\tcity: string | null;\n\t\t\tstate: string | null;\n\t\t\tzip_code: string | null;\n\t\t}>\n\t>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst activeCompanyId = await getActiveCompanyId();\n\t\tif (!activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"No active company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Single lightweight query - no joins, no enrichment\n\t\tconst { data: customers, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\n\t\t\t\t\"id, first_name, last_name, display_name, email, phone, secondary_phone, company_name, address, address2, city, state, zip_code\",\n\t\t\t)\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"display_name\", { ascending: true });\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch customers\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn customers || [];\n\t});\n}\n\n/**\n * Get all customers for the current company (WITH ENRICHMENT)\n *\n * WARNING: This function does 151 database queries for 50 customers (N+1 pattern).\n * Expected time: 1200-2000ms\n *\n * DO NOT use in AppHeader or other frequently rendered components.\n * Use getCustomersForDialer() instead for lightweight contact info.\n *\n * Only use this on dedicated customer list pages where the enriched data is needed.\n */\nasync function getAllCustomers(): Promise<\n\tActionResult<CustomerRecord[]>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID (from cookie or first available)\n\t\tconst activeCompanyId = await getActiveCompanyId();\n\n\t\tconst FORBIDDEN_STATUS_CODE = 403;\n\t\tif (!activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tFORBIDDEN_STATUS_CODE,\n\t\t\t);\n\t\t}\n\n\t\t// Verify user has access to the active company\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.maybeSingle();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You don't have access to this company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tFORBIDDEN_STATUS_CODE,\n\t\t\t);\n\t\t}\n\n\t\tconst { data: customers, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"display_name\", { ascending: true });\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch customers\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// PERFORMANCE OPTIMIZED: Use RPC function instead of N+1 queries\n\t\t// BEFORE: 151 queries for 50 customers (1 base + 50  3 queries each)\n\t\t// AFTER: 1 RPC call with efficient LATERAL joins\n\t\t// Performance gain: 5-10 seconds faster\n\n\t\t// Note: customers variable contains the base customer data from above query\n\t\t// We replace the enrichment logic with a single RPC call\n\t\tconst { data: enrichedData, error: enrichError } = await supabase.rpc(\n\t\t\t\"get_enriched_customers_rpc\",\n\t\t\t{\n\t\t\t\tp_company_id: activeCompanyId,\n\t\t\t},\n\t\t);\n\n\t\tif (enrichError) {\n\t\t\t// Fallback to base customers if enrichment fails\n\t\t\tconsole.error(\"Failed to enrich customers:\", enrichError);\n\t\t\treturn customers as CustomerRecord[];\n\t\t}\n\n\t\t// Merge enriched data with base customer data\n\t\tconst enrichedCustomers = (enrichedData || []).map((customer: any) => ({\n\t\t\t...customer,\n\t\t\t// Override total_jobs and total_revenue with fresh aggregated values\n\t\t\ttotal_jobs: customer.enriched_total_jobs || customer.total_jobs || 0,\n\t\t\ttotal_revenue:\n\t\t\t\tcustomer.enriched_total_revenue || customer.total_revenue || 0,\n\t\t}));\n\n\t\treturn enrichedCustomers as CustomerRecord[];\n\t});\n}\n\n/**\n * Update customer page content (Novel/Tiptap JSON)\n *\n * Saves the customer's editable page layout and content\n * Used by the Novel editor for auto-save functionality\n */\nasync function updateCustomerPageContent(\n\tcustomerId: string,\n\tpageContent: Record<string, unknown>,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"customer\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Update page content\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({\n\t\t\t\tpage_content: pageContent,\n\t\t\t\tcontent_updated_by: user.id,\n\t\t\t})\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update customer page\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5706, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/email-folders.ts"],"sourcesContent":["\"use server\";\n\nimport { createClient } from \"@/lib/supabase/server\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport { z } from \"zod\";\n\nconst createFolderSchema = z.object({\n\tname: z.string().min(1).max(100),\n\tdescription: z.string().max(500).optional(),\n\tcolor: z.string().regex(/^#[0-9A-Fa-f]{6}$/).optional(),\n\ticon: z.string().optional(),\n});\n\nconst updateFolderSchema = createFolderSchema.partial().extend({\n\tid: z.string().uuid(),\n\tsort_order: z.number().int().optional(),\n});\n\nconst deleteFolderSchema = z.object({\n\tid: z.string().uuid(),\n});\n\nexport type EmailFolder = {\n\tid: string;\n\tcompany_id: string;\n\tname: string;\n\tslug: string;\n\tdescription: string | null;\n\tcolor: string | null;\n\ticon: string | null;\n\tsort_order: number;\n\tis_system: boolean;\n\tis_active: boolean;\n\tcreated_by: string | null;\n\tcreated_at: string;\n\tupdated_at: string;\n\tdeleted_at: string | null;\n};\n\n/**\n * Get all email folders for the active company\n */\nexport async function getEmailFoldersAction(): Promise<{\n\tsuccess: boolean;\n\tfolders?: EmailFolder[];\n\terror?: string;\n}> {\n\ttry {\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Database connection failed\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"email_folders\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.eq(\"is_active\", true)\n\t\t\t.order(\"sort_order\", { ascending: true })\n\t\t\t.order(\"name\", { ascending: true });\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\treturn { success: true, folders: data || [] };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n\n/**\n * Create a new email folder\n */\nexport async function createEmailFolderAction(\n\tinput: z.infer<typeof createFolderSchema>\n): Promise<{\n\tsuccess: boolean;\n\tfolder?: EmailFolder;\n\terror?: string;\n}> {\n\ttry {\n\t\tconst validated = createFolderSchema.parse(input);\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Database connection failed\" };\n\t\t}\n\n\t\tconst { data: { user } } = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\treturn { success: false, error: \"Not authenticated\" };\n\t\t}\n\n\t\t// Generate slug from name\n\t\tconst slug = validated.name\n\t\t\t.toLowerCase()\n\t\t\t.trim()\n\t\t\t.replace(/[^a-z0-9]+/g, \"-\")\n\t\t\t.replace(/^-+|-+$/g, \"\");\n\n\t\t// Check if slug already exists\n\t\tconst { data: existing } = await supabase\n\t\t\t.from(\"email_folders\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"slug\", slug)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tif (existing) {\n\t\t\treturn { success: false, error: \"A folder with this name already exists\" };\n\t\t}\n\n\t\t// Get max sort_order\n\t\tconst { data: maxOrder } = await supabase\n\t\t\t.from(\"email_folders\")\n\t\t\t.select(\"sort_order\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"sort_order\", { ascending: false })\n\t\t\t.limit(1)\n\t\t\t.single();\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"email_folders\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tname: validated.name,\n\t\t\t\tslug,\n\t\t\t\tdescription: validated.description || null,\n\t\t\t\tcolor: validated.color || null,\n\t\t\t\ticon: validated.icon || null,\n\t\t\t\tsort_order: (maxOrder?.sort_order || 0) + 1,\n\t\t\t\tcreated_by: user.id,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\treturn { success: true, folder: data };\n\t} catch (error) {\n\t\tif (error instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.errors.map((e) => `${e.path.join(\".\")}: ${e.message}`).join(\", \"),\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n\n/**\n * Update an email folder\n * @deprecated Unused\n */\nasync function updateEmailFolderAction(\n\tinput: z.infer<typeof updateFolderSchema>\n): Promise<{\n\tsuccess: boolean;\n\tfolder?: EmailFolder;\n\terror?: string;\n}> {\n\ttry {\n\t\tconst validated = updateFolderSchema.parse(input);\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Database connection failed\" };\n\t\t}\n\n\t\t// Check folder exists and belongs to company\n\t\tconst { data: existing, error: fetchError } = await supabase\n\t\t\t.from(\"email_folders\")\n\t\t\t.select(\"id, is_system\")\n\t\t\t.eq(\"id\", validated.id)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tif (fetchError || !existing) {\n\t\t\treturn { success: false, error: \"Folder not found\" };\n\t\t}\n\n\t\tif (existing.is_system) {\n\t\t\treturn { success: false, error: \"Cannot update system folders\" };\n\t\t}\n\n\t\t// If name is being updated, regenerate slug\n\t\tconst updateData: Record<string, unknown> = {};\n\t\tif (validated.name) {\n\t\t\tupdateData.name = validated.name;\n\t\t\tupdateData.slug = validated.name\n\t\t\t\t.toLowerCase()\n\t\t\t\t.trim()\n\t\t\t\t.replace(/[^a-z0-9]+/g, \"-\")\n\t\t\t\t.replace(/^-+|-+$/g, \"\");\n\t\t}\n\t\tif (validated.description !== undefined) updateData.description = validated.description;\n\t\tif (validated.color !== undefined) updateData.color = validated.color;\n\t\tif (validated.icon !== undefined) updateData.icon = validated.icon;\n\t\tif (validated.sort_order !== undefined) updateData.sort_order = validated.sort_order;\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"email_folders\")\n\t\t\t.update(updateData)\n\t\t\t.eq(\"id\", validated.id)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\treturn { success: true, folder: data };\n\t} catch (error) {\n\t\tif (error instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.errors.map((e) => `${e.path.join(\".\")}: ${e.message}`).join(\", \"),\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n\n/**\n * Delete an email folder (soft delete)\n */\nexport async function deleteEmailFolderAction(\n\tinput: z.infer<typeof deleteFolderSchema>\n): Promise<{\n\tsuccess: boolean;\n\terror?: string;\n}> {\n\ttry {\n\t\tconst validated = deleteFolderSchema.parse(input);\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Database connection failed\" };\n\t\t}\n\n\t\tconst { data: { user } } = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\treturn { success: false, error: \"Not authenticated\" };\n\t\t}\n\n\t\t// Check folder exists and belongs to company\n\t\tconst { data: existing, error: fetchError } = await supabase\n\t\t\t.from(\"email_folders\")\n\t\t\t.select(\"id, is_system\")\n\t\t\t.eq(\"id\", validated.id)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tif (fetchError || !existing) {\n\t\t\treturn { success: false, error: \"Folder not found\" };\n\t\t}\n\n\t\tif (existing.is_system) {\n\t\t\treturn { success: false, error: \"Cannot delete system folders\" };\n\t\t}\n\n\t\t// Soft delete\n\t\tconst { error } = await supabase\n\t\t\t.from(\"email_folders\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: user.id,\n\t\t\t\tis_active: false,\n\t\t\t})\n\t\t\t.eq(\"id\", validated.id)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tif (error instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.errors.map((e) => `${e.path.join(\".\")}: ${e.message}`).join(\", \"),\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5993, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/sms-actions.ts"],"sourcesContent":["\"use server\";\n\nimport {\n    getCompanySms,\n    getSmsById,\n    markSmsAsRead,\n    markSmsConversationAsRead,\n    type CompanySms,\n} from \"@/lib/communication/sms-service\";\nimport { z } from \"zod\";\n\nconst getSmsSchema = z.object({\n  limit: z.coerce.number().min(1).max(500).optional().default(50),\n  offset: z.coerce.number().min(0).optional().default(0),\n  type: z.enum([\"sent\", \"received\", \"all\"]).optional().default(\"all\"),\n  folder: z.enum([\"inbox\", \"sent\", \"archive\", \"trash\", \"bin\"]).optional(),\n  label: z.string().optional(),\n  search: z.string().optional().nullable(),\n  sortBy: z.enum([\"created_at\", \"sent_at\"]).optional().default(\"created_at\"),\n  sortOrder: z.enum([\"asc\", \"desc\"]).optional().default(\"desc\"),\n}).passthrough();\n\nconst markSmsReadSchema = z.object({\n  smsId: z.string().min(1),\n});\n\nexport type GetSmsInput = z.infer<typeof getSmsSchema>;\nexport type MarkSmsReadInput = z.infer<typeof markSmsReadSchema>;\n\n// Re-export SMS types from sms-service\nexport type { CompanySms };\n\nexport type GetSmsResult = Awaited<ReturnType<typeof getCompanySms>>;\n\n/**\n * Get SMS messages for the active company\n */\nexport async function getSmsAction(\n  input: GetSmsInput\n): Promise<GetSmsResult> {\n  try {\n    const parseResult = getSmsSchema.safeParse(input);\n    \n    if (!parseResult.success) {\n      throw new Error(`Invalid input parameters: ${parseResult.error.errors.map(e => `${e.path.join('.')}: ${e.message}`).join(', ')}`);\n    }\n    \n    const validatedInput = parseResult.data;\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    const companyId = await getActiveCompanyId();\n\n    if (!companyId) {\n      throw new Error(\"No active company found\");\n    }\n\n    return await getCompanySms(companyId, validatedInput);\n  } catch (error) {\n    console.error(\" getSmsAction error:\", error);\n    throw error;\n  }\n}\n\n/**\n * Get a specific SMS by ID\n */\nexport async function getSmsByIdAction(smsId: string): Promise<{\n  success: boolean;\n  sms?: CompanySms;\n  error?: string;\n}> {\n  try {\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    const companyId = await getActiveCompanyId();\n\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const sms = await getSmsById(companyId, smsId);\n    \n    if (!sms) {\n      return { success: false, error: \"SMS not found\" };\n    }\n\n    return { success: true, sms };\n  } catch (error) {\n    console.error(\"Error getting SMS by ID:\", error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\",\n    };\n  }\n}\n\n/**\n * Mark an SMS as read\n */\nexport async function markSmsAsReadAction(\n  input: MarkSmsReadInput\n): Promise<boolean> {\n  try {\n    const validatedInput = markSmsReadSchema.parse(input);\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    const companyId = await getActiveCompanyId();\n\n    if (!companyId) {\n      throw new Error(\"Invalid input parameters\");\n    }\n\n    return await markSmsAsRead(companyId, validatedInput.smsId);\n  } catch (error) {\n    if (error instanceof z.ZodError) {\n      throw new Error(\"Invalid input parameters\");\n    }\n    throw error;\n  }\n}\n\n/**\n * Mark all unread messages in an SMS conversation as read\n */\nexport async function markSmsConversationAsReadAction(phoneNumber: string): Promise<{\n  success: boolean;\n  error?: string;\n}> {\n  \"use server\";\n  \n  try {\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    const companyId = await getActiveCompanyId();\n    \n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n    \n    const success = await markSmsConversationAsRead(companyId, phoneNumber);\n    return { success };\n  } catch (error) {\n    console.error(\"Error marking SMS conversation as read:\", error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\",\n    };\n  }\n}\n\n/**\n * Get SMS conversation thread by phone number\n */\nexport async function getSmsConversationAction(phoneNumber: string): Promise<{\n  success: boolean;\n  messages?: CompanySms[];\n  error?: string;\n}> {\n  \"use server\";\n  \n  try {\n    const { getSmsConversation } = await import(\"@/lib/sms/sms-service\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    \n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    const messages = await getSmsConversation(companyId, phoneNumber);\n    return { success: true, messages };\n  } catch (error) {\n    console.error(\"Error fetching SMS conversation:\", error);\n    // Handle cookies() error gracefully\n    if (error instanceof Error && error.message.includes(\"cookies\")) {\n      return {\n        success: false,\n        error: \"Request context not available. Please refresh the page.\",\n      };\n    }\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\",\n    };\n  }\n}\n\n/**\n * Get SMS folder counts\n */\nexport async function getSmsFolderCountsAction(): Promise<{\n  success: boolean;\n  counts?: {\n    inbox: number;\n    sent: number;\n    archive: number;\n    trash: number;\n    [label: string]: number;\n  };\n  error?: string;\n}> {\n  \"use server\";\n  \n  try {\n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    \n    const companyId = await getActiveCompanyId();\n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n    \n    const supabase = await createClient();\n    if (!supabase) {\n      return { success: false, error: \"Database connection failed\" };\n    }\n    \n    const baseQuery = supabase\n      .from(\"communications\")\n      .select(\"*\", { count: \"exact\", head: true })\n      .eq(\"company_id\", companyId)\n      .eq(\"type\", \"sms\");\n    \n    // Get counts for each folder\n    const [inboxResult, sentResult, archiveResult, trashResult] = await Promise.all([\n      // Inbox\n      baseQuery\n        .eq(\"direction\", \"inbound\")\n        .eq(\"is_archived\", false)\n        .is(\"deleted_at\", null)\n        .or(\"snoozed_until.is.null,snoozed_until.lt.now()\"),\n      // Sent\n      baseQuery\n        .eq(\"direction\", \"outbound\")\n        .eq(\"is_archived\", false)\n        .is(\"deleted_at\", null),\n      // Archive\n      baseQuery.eq(\"is_archived\", true).is(\"deleted_at\", null),\n      // Trash\n      baseQuery.not(\"deleted_at\", \"is\", null),\n    ]);\n    \n    const counts = {\n      inbox: inboxResult.count || 0,\n      sent: sentResult.count || 0,\n      archive: archiveResult.count || 0,\n      trash: trashResult.count || 0,\n    };\n    \n    return { success: true, counts };\n  } catch (error) {\n    return { success: false, error: error instanceof Error ? error.message : \"Unknown error\" };\n  }\n}\n\n/**\n * Upload SMS attachments to storage\n */\nexport async function uploadSmsAttachments(\n  files: File[]\n): Promise<{\n  success: boolean;\n  urls?: string[];\n  error?: string;\n}> {\n  \"use server\";\n  \n  try {\n    const { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n    const companyId = await getActiveCompanyId();\n    \n    if (!companyId) {\n      return { success: false, error: \"No active company found\" };\n    }\n    \n    const { createClient } = await import(\"@/lib/supabase/server\");\n    const supabase = await createClient();\n    \n    if (!supabase) {\n      return { success: false, error: \"Database connection failed\" };\n    }\n\n    const urls: string[] = [];\n    \n      // Upload each file to Supabase Storage\n      // Use company-files bucket which has proper RLS policies for company members\n      for (const file of files) {\n        const fileExt = file.name.split('.').pop();\n        const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;\n        // Path structure: companyId must be at index [0] for RLS policy (matches document-manager pattern)\n        // Format: companyId/folder/filename (storage.foldername(name))[0] = companyId\n        const filePath = `${companyId}/sms-attachments/${fileName}`;\n        \n        // Convert file to array buffer\n        const arrayBuffer = await file.arrayBuffer();\n        const { data, error: uploadError } = await supabase.storage\n          .from('company-files') // Use company-files bucket with proper RLS\n          .upload(filePath, arrayBuffer, {\n            contentType: file.type,\n            upsert: false,\n          });\n        \n        if (uploadError) {\n          console.error(\"Upload error:\", uploadError);\n          return { success: false, error: `Failed to upload ${file.name}: ${uploadError.message}` };\n        }\n        \n        // Get public URL (or signed URL for private bucket)\n        const { data: { publicUrl } } = supabase.storage\n          .from('company-files')\n          .getPublicUrl(filePath);\n        \n        urls.push(publicUrl);\n      }\n    \n    return { success: true, urls };\n  } catch (error) {\n    console.error(\"Error uploading SMS attachments:\", error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\",\n    };\n  }\n}\n\n/**\n * SMS Template Context Type\n * Data available for auto-filling SMS templates\n */\nexport type SmsTemplateContext = {\n  companyName?: string;\n  companyPhone?: string;\n  companyEmail?: string;\n};\n\n/**\n * Get company context for SMS templates\n * Returns company info for auto-filling template messages\n */\nexport async function getCompanyContextAction(): Promise<{\n  success: boolean;\n  context?: SmsTemplateContext;\n  error?: string;\n}> {\n  \"use server\";\n\n  try {\n    const { getActiveCompany } = await import(\"@/lib/auth/company-context\");\n\n    const company = await getActiveCompany();\n    if (!company) {\n      return { success: false, error: \"No active company found\" };\n    }\n\n    return {\n      success: true,\n      context: {\n        companyName: company.name,\n        companyPhone: company.phone || undefined,\n        companyEmail: company.email || undefined,\n      },\n    };\n  } catch (error) {\n    console.error(\"Error getting company context:\", error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\",\n    };\n  }\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6323, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/vendors.ts"],"sourcesContent":["/**\n * Vendors Server Actions\n *\n * Handles vendor management with CRUD operations, search, and vendor selection.\n */\n\n\"use server\";\n\nimport {\n    ActionError,\n    ERROR_CODES,\n    ERROR_MESSAGES,\n} from \"@/lib/errors/action-error\";\nimport { revalidatePath } from \"next/cache\";\n\n// Regex constants\nconst VENDOR_NUMBER_REGEX = /VND-\\d{4}-(\\d+)/;\n\nimport {\n    type ActionResult,\n    assertAuthenticated,\n    assertExists,\n    withErrorHandling,\n} from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport {\n    type VendorUpdate,\n    vendorInsertSchema,\n    vendorUpdateSchema,\n} from \"@/lib/validations/database-schemas\";\n\n/**\n * Generate unique vendor number\n */\nasync function generateVendorNumber(\n\tsupabase: any,\n\tcompanyId: string,\n): Promise<string> {\n\tconst { data: latestVendor } = await supabase\n\t\t.from(\"vendors\")\n\t\t.select(\"vendor_number\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(1)\n\t\t.single();\n\n\tif (!latestVendor) {\n\t\treturn `VND-${new Date().getFullYear()}-001`;\n\t}\n\n\tconst match = latestVendor.vendor_number.match(VENDOR_NUMBER_REGEX);\n\tif (match) {\n\t\tconst nextNumber = Number.parseInt(match[1], 10) + 1;\n\t\treturn `VND-${new Date().getFullYear()}-${nextNumber.toString().padStart(3, \"0\")}`;\n\t}\n\n\treturn `VND-${new Date().getFullYear()}-${Date.now().toString().slice(-3)}`;\n}\n\n/**\n * Create a new vendor\n */\nasync function createVendor(\n\tformData: FormData,\n): Promise<ActionResult<string>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Generate vendor number if not provided\n\t\tconst vendorNumber =\n\t\t\tformData.get(\"vendor_number\")?.toString() ||\n\t\t\t(await generateVendorNumber(supabase, teamMember.company_id));\n\n\t\t// Validate input\n\t\tconst data = vendorInsertSchema.parse({\n\t\t\tcompany_id: teamMember.company_id,\n\t\t\tname: formData.get(\"name\"),\n\t\t\tdisplay_name: formData.get(\"display_name\") || formData.get(\"name\"),\n\t\t\tvendor_number: vendorNumber,\n\t\t\temail: formData.get(\"email\") || undefined,\n\t\t\tphone: formData.get(\"phone\") || undefined,\n\t\t\tsecondary_phone: formData.get(\"secondary_phone\") || undefined,\n\t\t\twebsite: formData.get(\"website\") || undefined,\n\t\t\taddress: formData.get(\"address\") || undefined,\n\t\t\taddress2: formData.get(\"address2\") || undefined,\n\t\t\tcity: formData.get(\"city\") || undefined,\n\t\t\tstate: formData.get(\"state\") || undefined,\n\t\t\tzip_code: formData.get(\"zip_code\") || undefined,\n\t\t\tcountry: formData.get(\"country\") || \"USA\",\n\t\t\ttax_id: formData.get(\"tax_id\") || undefined,\n\t\t\tpayment_terms: formData.get(\"payment_terms\") || \"net_30\",\n\t\t\tcredit_limit: formData.get(\"credit_limit\")\n\t\t\t\t? Number.parseInt(formData.get(\"credit_limit\") as string, 10) * 100\n\t\t\t\t: 0,\n\t\t\tpreferred_payment_method:\n\t\t\t\tformData.get(\"preferred_payment_method\") || undefined,\n\t\t\tcategory: formData.get(\"category\") || undefined,\n\t\t\ttags: formData.get(\"tags\")\n\t\t\t\t? JSON.parse(formData.get(\"tags\") as string)\n\t\t\t\t: undefined,\n\t\t\tstatus: formData.get(\"status\") || \"active\",\n\t\t\tnotes: formData.get(\"notes\") || undefined,\n\t\t\tinternal_notes: formData.get(\"internal_notes\") || undefined,\n\t\t\tcustom_fields: formData.get(\"custom_fields\")\n\t\t\t\t? JSON.parse(formData.get(\"custom_fields\") as string)\n\t\t\t\t: undefined,\n\t\t});\n\n\t\t// Check if vendor number already exists\n\t\tconst { data: existingVendor } = await supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t.eq(\"vendor_number\", data.vendor_number)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tif (existingVendor) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Vendor number already exists\",\n\t\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t\t);\n\t\t}\n\n\t\t// Insert vendor\n\t\tconst { data: vendor, error } = await supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: data.company_id,\n\t\t\t\tname: data.name,\n\t\t\t\tdisplay_name: data.display_name,\n\t\t\t\tvendor_number: data.vendor_number,\n\t\t\t\temail: data.email,\n\t\t\t\tphone: data.phone,\n\t\t\t\tsecondary_phone: data.secondary_phone,\n\t\t\t\twebsite: data.website,\n\t\t\t\taddress: data.address,\n\t\t\t\taddress2: data.address2,\n\t\t\t\tcity: data.city,\n\t\t\t\tstate: data.state,\n\t\t\t\tzip_code: data.zip_code,\n\t\t\t\tcountry: data.country,\n\t\t\t\ttax_id: data.tax_id,\n\t\t\t\tpayment_terms: data.payment_terms,\n\t\t\t\tcredit_limit: data.credit_limit,\n\t\t\t\tpreferred_payment_method: data.preferred_payment_method,\n\t\t\t\tcategory: data.category,\n\t\t\t\ttags: data.tags || [],\n\t\t\t\tstatus: data.status,\n\t\t\t\tnotes: data.notes,\n\t\t\t\tinternal_notes: data.internal_notes,\n\t\t\t\tcustom_fields: data.custom_fields || {},\n\t\t\t})\n\t\t\t.select(\"id\")\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to create vendor\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tassertExists(vendor, \"Vendor\");\n\n\t\trevalidatePath(\"/dashboard/inventory/vendors\");\n\t\trevalidatePath(`/dashboard/inventory/vendors/${vendor.id}`);\n\n\t\treturn vendor.id;\n\t});\n}\n\n/**\n * Update an existing vendor\n */\nexport async function updateVendor(\n\tvendorId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify vendor exists and belongs to company\n\t\tconst { data: existingVendor } = await supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.select(\"id, company_id, vendor_number\")\n\t\t\t.eq(\"id\", vendorId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(existingVendor, \"Vendor\");\n\n\t\tif (existingVendor.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"vendor\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Build update object from form data\n\t\tconst updateData: Partial<VendorUpdate> = {};\n\n\t\tif (formData.has(\"name\")) {\n\t\t\tupdateData.name = formData.get(\"name\") as string;\n\t\t}\n\t\tif (formData.has(\"display_name\")) {\n\t\t\tupdateData.display_name = formData.get(\"display_name\") as string;\n\t\t}\n\t\tif (formData.has(\"vendor_number\")) {\n\t\t\tupdateData.vendor_number = formData.get(\"vendor_number\") as string;\n\t\t}\n\t\tif (formData.has(\"email\")) {\n\t\t\tupdateData.email = (formData.get(\"email\") as string) || undefined;\n\t\t}\n\t\tif (formData.has(\"phone\")) {\n\t\t\tupdateData.phone = (formData.get(\"phone\") as string) || undefined;\n\t\t}\n\t\tif (formData.has(\"secondary_phone\")) {\n\t\t\tupdateData.secondary_phone =\n\t\t\t\t(formData.get(\"secondary_phone\") as string) || undefined;\n\t\t}\n\t\tif (formData.has(\"website\")) {\n\t\t\tupdateData.website = (formData.get(\"website\") as string) || undefined;\n\t\t}\n\t\tif (formData.has(\"address\")) {\n\t\t\tupdateData.address = (formData.get(\"address\") as string) || undefined;\n\t\t}\n\t\tif (formData.has(\"address2\")) {\n\t\t\tupdateData.address2 = (formData.get(\"address2\") as string) || undefined;\n\t\t}\n\t\tif (formData.has(\"city\")) {\n\t\t\tupdateData.city = (formData.get(\"city\") as string) || undefined;\n\t\t}\n\t\tif (formData.has(\"state\")) {\n\t\t\tupdateData.state = (formData.get(\"state\") as string) || undefined;\n\t\t}\n\t\tif (formData.has(\"zip_code\")) {\n\t\t\tupdateData.zip_code = (formData.get(\"zip_code\") as string) || undefined;\n\t\t}\n\t\tif (formData.has(\"country\")) {\n\t\t\tupdateData.country = formData.get(\"country\") as string;\n\t\t}\n\t\tif (formData.has(\"tax_id\")) {\n\t\t\tupdateData.tax_id = (formData.get(\"tax_id\") as string) || undefined;\n\t\t}\n\t\tif (formData.has(\"payment_terms\")) {\n\t\t\tupdateData.payment_terms = formData.get(\"payment_terms\") as any;\n\t\t}\n\t\tif (formData.has(\"credit_limit\")) {\n\t\t\tupdateData.credit_limit =\n\t\t\t\tNumber.parseInt(formData.get(\"credit_limit\") as string, 10) * 100;\n\t\t}\n\t\tif (formData.has(\"preferred_payment_method\")) {\n\t\t\tupdateData.preferred_payment_method = formData.get(\n\t\t\t\t\"preferred_payment_method\",\n\t\t\t) as any;\n\t\t}\n\t\tif (formData.has(\"category\")) {\n\t\t\tupdateData.category = formData.get(\"category\") as any;\n\t\t}\n\t\tif (formData.has(\"tags\")) {\n\t\t\tupdateData.tags = JSON.parse(formData.get(\"tags\") as string);\n\t\t}\n\t\tif (formData.has(\"status\")) {\n\t\t\tupdateData.status = formData.get(\"status\") as \"active\" | \"inactive\";\n\t\t}\n\t\tif (formData.has(\"notes\")) {\n\t\t\tupdateData.notes = (formData.get(\"notes\") as string) || undefined;\n\t\t}\n\t\tif (formData.has(\"internal_notes\")) {\n\t\t\tupdateData.internal_notes =\n\t\t\t\t(formData.get(\"internal_notes\") as string) || undefined;\n\t\t}\n\t\tif (formData.has(\"custom_fields\")) {\n\t\t\tupdateData.custom_fields = JSON.parse(\n\t\t\t\tformData.get(\"custom_fields\") as string,\n\t\t\t);\n\t\t}\n\n\t\t// Validate update data\n\t\tconst validated = vendorUpdateSchema.parse(updateData);\n\n\t\t// Check vendor number uniqueness if changed\n\t\tif (\n\t\t\tvalidated.vendor_number &&\n\t\t\tvalidated.vendor_number !== existingVendor.vendor_number\n\t\t) {\n\t\t\tconst { data: duplicate } = await supabase\n\t\t\t\t.from(\"vendors\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t\t.eq(\"vendor_number\", validated.vendor_number)\n\t\t\t\t.neq(\"id\", vendorId)\n\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t.single();\n\n\t\t\tif (duplicate) {\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\t\"Vendor number already exists\",\n\t\t\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Update vendor\n\t\tconst { error } = await supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.update(validated)\n\t\t\t.eq(\"id\", vendorId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to update vendor\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/inventory/vendors\");\n\t\trevalidatePath(`/dashboard/inventory/vendors/${vendorId}`);\n\t});\n}\n\n/**\n * Delete (soft delete) a vendor\n */\nasync function deleteVendor(\n\tvendorId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify vendor exists and belongs to company\n\t\tconst { data: vendor } = await supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", vendorId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(vendor, \"Vendor\");\n\n\t\tif (vendor.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"vendor\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Soft delete vendor\n\t\tconst { error } = await supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: user.id,\n\t\t\t})\n\t\t\t.eq(\"id\", vendorId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to delete vendor\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/inventory/vendors\");\n\t});\n}\n\n/**\n * Get a single vendor by ID\n */\nasync function getVendor(vendorId: string): Promise<ActionResult<any>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst { data: vendor, error } = await supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"id\", vendorId)\n\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to fetch vendor\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tassertExists(vendor, \"Vendor\");\n\n\t\treturn vendor;\n\t});\n}\n\n/**\n * List all vendors for the company\n */\nasync function listVendors(options?: {\n\tstatus?: \"active\" | \"inactive\";\n\tcategory?: string;\n\tsearch?: string;\n}): Promise<ActionResult<any[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tlet query = supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"name\", { ascending: true });\n\n\t\tif (options?.status) {\n\t\t\tquery = query.eq(\"status\", options.status);\n\t\t}\n\n\t\tif (options?.category) {\n\t\t\tquery = query.eq(\"category\", options.category);\n\t\t}\n\n\t\tif (options?.search) {\n\t\t\tquery = query.or(\n\t\t\t\t`name.ilike.%${options.search}%,display_name.ilike.%${options.search}%,vendor_number.ilike.%${options.search}%,email.ilike.%${options.search}%`,\n\t\t\t);\n\t\t}\n\n\t\tconst { data: vendors, error } = await query;\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to fetch vendors\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn vendors || [];\n\t});\n}\n\n/**\n * Search vendors by query string\n */\nexport async function searchVendors(\n\tquery: string,\n): Promise<ActionResult<any[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Use the same approach as searchCustomers\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst activeCompanyId = await getActiveCompanyId();\n\t\t\n\t\tif (!activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"No active company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify user has access to the active company\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.maybeSingle();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You don't have access to this company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst { data: vendors, error } = await supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.select(\"id, name, display_name, vendor_number, email, phone, status\")\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.or(\n\t\t\t\t`name.ilike.%${query}%,display_name.ilike.%${query}%,vendor_number.ilike.%${query}%,email.ilike.%${query}%`,\n\t\t\t)\n\t\t\t.limit(20);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to search vendors\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn vendors || [];\n\t});\n}\n\n/**\n * Link a purchase order to a vendor\n */\nexport async function linkPurchaseOrderToVendor(\n\tpurchaseOrderId: string,\n\tvendorId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify purchase order exists and belongs to company\n\t\tconst { data: po } = await supabase\n\t\t\t.from(\"purchase_orders\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", purchaseOrderId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(po, \"Purchase Order\");\n\n\t\tif (po.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"purchase order\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify vendor exists and belongs to company\n\t\tconst { data: vendor } = await supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", vendorId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(vendor, \"Vendor\");\n\n\t\tif (vendor.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"vendor\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Link purchase order to vendor\n\t\tconst { error } = await supabase\n\t\t\t.from(\"purchase_orders\")\n\t\t\t.update({ vendor_id: vendorId })\n\t\t\t.eq(\"id\", purchaseOrderId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to link purchase order\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work/vendors\");\n\t\trevalidatePath(`/dashboard/work/vendors/${vendorId}`);\n\t\trevalidatePath(\"/dashboard/work/purchase-orders\");\n\t\trevalidatePath(`/dashboard/work/purchase-orders/${purchaseOrderId}`);\n\t});\n}\n\n/**\n * Archive a vendor (soft delete)\n */\nexport async function archiveVendor(\n\tvendorId: string,\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Database connection not available\" };\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\treturn { success: false, error: \"Unauthorized\" };\n\t\t}\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"vendors\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t})\n\t\t\t.eq(\"id\", vendorId);\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work/vendors\");\n\t\treturn { success: true };\n\t} catch (_error) {\n\t\treturn { success: false, error: \"Failed to archive vendor\" };\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6759, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/jobs.ts"],"sourcesContent":["/**\n * Jobs Server Actions - REFACTORED FOR DOMAIN TABLE STRUCTURE\n *\n * Handles job/work order management with comprehensive CRUD operations,\n * status transitions, scheduling, and assignment logic.\n *\n * MIGRATION NOTES:\n * - Core jobs table now has ~20 columns\n * - Domain-specific data moved to 11 domain tables\n * - Financial data -> job_financial\n * - Time tracking -> job_time_tracking\n * - Archive/deletion -> job_multi_entity\n * - All domain tables have CASCADE delete on job_id\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport {\n\tActionError,\n\tERROR_CODES,\n\tERROR_MESSAGES,\n} from \"@/lib/errors/action-error\";\nimport {\n\ttype ActionResult,\n\tassertAuthenticated,\n\tassertExists,\n\twithErrorHandling,\n} from \"@/lib/errors/with-error-handling\";\nimport { notifyJobCreated } from \"@/lib/notifications/triggers\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport {\n\ttype JobStatus,\n\ttype JobStatusTransitionContext,\n\tvalidateStatusTransition,\n} from \"@/lib/validations/job-status-transitions\";\n\n// Regex constants\nconst JOB_NUMBER_REGEX = /JOB-\\d{4}-(\\d+)/;\n\n// Validation Schemas\nconst createJobSchema = z.object({\n\tpropertyId: z.string().uuid(\"Invalid property ID\"),\n\tcustomerId: z.string().uuid(\"Invalid customer ID\").optional(),\n\ttitle: z.string().min(1, \"Job title is required\"),\n\tdescription: z.string().optional(),\n\tpriority: z.enum([\"low\", \"medium\", \"high\", \"urgent\"]).default(\"medium\"),\n\tjobType: z\n\t\t.enum([\n\t\t\t\"service\",\n\t\t\t\"installation\",\n\t\t\t\"repair\",\n\t\t\t\"maintenance\",\n\t\t\t\"inspection\",\n\t\t\t\"consultation\",\n\t\t])\n\t\t.optional(),\n\tscheduledStart: z.string().optional(),\n\tscheduledEnd: z.string().optional(),\n\tassignedTo: z.string().uuid(\"Invalid user ID\").optional(),\n\tnotes: z.string().optional(),\n\t// Enhanced scheduling fields\n\tisRecurring: z.boolean().optional(),\n\tschedulingMode: z.enum([\"specific\", \"window\"]).optional(),\n\ttimeWindow: z.string().optional(),\n\trecurrenceType: z\n\t\t.enum([\"daily\", \"weekly\", \"biweekly\", \"monthly\", \"quarterly\", \"yearly\"])\n\t\t.optional(),\n\trecurrenceEndDate: z.string().optional(),\n\trecurrenceCount: z.number().int().min(1).max(365).optional(),\n});\n\nconst updateJobSchema = z.object({\n\ttitle: z.string().min(1, \"Job title is required\").optional(),\n\tdescription: z.string().optional(),\n\tstatus: z\n\t\t.enum([\n\t\t\t\"quoted\",\n\t\t\t\"scheduled\",\n\t\t\t\"in_progress\",\n\t\t\t\"on_hold\",\n\t\t\t\"completed\",\n\t\t\t\"cancelled\",\n\t\t\t\"invoiced\",\n\t\t\t\"paid\",\n\t\t])\n\t\t.optional(),\n\tpriority: z.enum([\"low\", \"medium\", \"high\", \"urgent\"]).optional(),\n\tjobType: z\n\t\t.enum([\n\t\t\t\"service\",\n\t\t\t\"installation\",\n\t\t\t\"repair\",\n\t\t\t\"maintenance\",\n\t\t\t\"inspection\",\n\t\t\t\"consultation\",\n\t\t])\n\t\t.optional(),\n\tnotes: z.string().optional(),\n\t// Financial fields (now in job_financial domain table)\n\ttotalAmount: z.number().min(0).optional(),\n\tpaidAmount: z.number().min(0).optional(),\n\tdepositAmount: z.number().min(0).optional(),\n\tscheduledStart: z.string().optional(),\n\tscheduledEnd: z.string().optional(),\n\tassignedTo: z.string().uuid(\"Invalid user ID\").optional().nullable(),\n\tcustomerId: z.string().uuid(\"Invalid customer ID\").optional().nullable(),\n\tpropertyId: z.string().uuid(\"Invalid property ID\").optional().nullable(),\n});\n\n// Type for updateJobData - makes it easier to use programmatically\nexport type UpdateJobData = z.infer<typeof updateJobSchema>;\n\nconst scheduleJobSchema = z.object({\n\tscheduledStart: z.string(),\n\tscheduledEnd: z.string(),\n});\n\n/**\n * Generate unique job number\n */\nasync function generateJobNumber(\n\tsupabase: any,\n\tcompanyId: string,\n): Promise<string> {\n\t// Get the latest job number for this company\n\tconst { data: latestJob } = await supabase\n\t\t.from(\"jobs\")\n\t\t.select(\"job_number\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(1)\n\t\t.single();\n\n\tif (!latestJob) {\n\t\treturn `JOB-${new Date().getFullYear()}-001`;\n\t}\n\n\t// Extract number from format: JOB-YYYY-NNN\n\tconst match = latestJob.job_number.match(JOB_NUMBER_REGEX);\n\tif (match) {\n\t\tconst nextNumber = Number.parseInt(match[1], 10) + 1;\n\t\treturn `JOB-${new Date().getFullYear()}-${nextNumber.toString().padStart(3, \"0\")}`;\n\t}\n\n\t// Fallback\n\treturn `JOB-${new Date().getFullYear()}-${Date.now().toString().slice(-3)}`;\n}\n\n/**\n * Calculate next recurrence date\n */\nfunction calculateNextRecurrence(\n\tcurrentDate: Date,\n\trecurrenceType: string,\n): Date {\n\tconst nextDate = new Date(currentDate);\n\n\tswitch (recurrenceType) {\n\t\tcase \"daily\":\n\t\t\tnextDate.setDate(nextDate.getDate() + 1);\n\t\t\tbreak;\n\t\tcase \"weekly\":\n\t\t\tnextDate.setDate(nextDate.getDate() + 7);\n\t\t\tbreak;\n\t\tcase \"biweekly\":\n\t\t\tnextDate.setDate(nextDate.getDate() + 14);\n\t\t\tbreak;\n\t\tcase \"monthly\":\n\t\t\tnextDate.setMonth(nextDate.getMonth() + 1);\n\t\t\tbreak;\n\t\tcase \"quarterly\":\n\t\t\tnextDate.setMonth(nextDate.getMonth() + 3);\n\t\t\tbreak;\n\t\tcase \"yearly\":\n\t\t\tnextDate.setFullYear(nextDate.getFullYear() + 1);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t// Default to monthly if unknown type\n\t\t\tnextDate.setMonth(nextDate.getMonth() + 1);\n\t\t\tbreak;\n\t}\n\n\treturn nextDate;\n}\n\n/**\n * Create recurring jobs\n */\nasync function createRecurringJobs(\n\tsupabase: any,\n\tcompanyId: string,\n\tbaseJob: any,\n\trecurrenceType: string,\n\trecurrenceEndDate?: string,\n\trecurrenceCount?: number,\n): Promise<void> {\n\tif (!baseJob.scheduled_start) {\n\t\treturn; // Can't create recurring jobs without a start date\n\t}\n\n\tconst startDate = new Date(baseJob.scheduled_start);\n\tconst endDate = new Date(baseJob.scheduled_end || baseJob.scheduled_start);\n\tconst duration = endDate.getTime() - startDate.getTime();\n\n\t// Determine how many occurrences to create\n\tconst maxOccurrences = recurrenceCount || 52; // Default to 1 year of weekly jobs\n\tconst endDateLimit = recurrenceEndDate ? new Date(recurrenceEndDate) : null;\n\n\tconst recurringJobs: (typeof baseJob)[] = [];\n\tlet currentDate = new Date(startDate);\n\n\tfor (let i = 0; i < maxOccurrences - 1; i++) {\n\t\t// -1 because we already created the first job\n\t\tcurrentDate = calculateNextRecurrence(currentDate, recurrenceType);\n\n\t\t// Stop if we've reached the end date\n\t\tif (endDateLimit && currentDate > endDateLimit) {\n\t\t\tbreak;\n\t\t}\n\n\t\tconst currentEndDate = new Date(currentDate.getTime() + duration);\n\n\t\t// Generate a unique job number for this occurrence\n\t\tconst jobNumber = await generateJobNumber(supabase, companyId);\n\n\t\trecurringJobs.push({\n\t\t\t...baseJob,\n\t\t\tjob_number: jobNumber,\n\t\t\tscheduled_start: currentDate.toISOString(),\n\t\t\tscheduled_end: currentEndDate.toISOString(),\n\t\t\ttitle: `${baseJob.title} (${i + 2}/${maxOccurrences})`, // Add occurrence number\n\t\t});\n\n\t\t// Create jobs in batches of 10 to avoid memory issues\n\t\tif (recurringJobs.length >= 10) {\n\t\t\tawait supabase.from(\"jobs\").insert(recurringJobs);\n\t\t\trecurringJobs.length = 0; // Clear array\n\t\t}\n\t}\n\n\t// Insert any remaining jobs\n\tif (recurringJobs.length > 0) {\n\t\tawait supabase.from(\"jobs\").insert(recurringJobs);\n\t}\n}\n\n/**\n * Create a new job\n *  ALREADY MIGRATED - Creates core job + all 10 domain records in parallel\n */\nexport async function createJob(\n\tformData: FormData,\n): Promise<ActionResult<string>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst data = createJobSchema.parse({\n\t\t\tpropertyId: formData.get(\"propertyId\"),\n\t\t\tcustomerId: formData.get(\"customerId\") || undefined,\n\t\t\ttitle: formData.get(\"title\"),\n\t\t\tdescription: formData.get(\"description\") || undefined,\n\t\t\tpriority: formData.get(\"priority\") || \"medium\",\n\t\t\tjobType: formData.get(\"jobType\") || undefined,\n\t\t\tscheduledStart: formData.get(\"scheduledStart\") || undefined,\n\t\t\tscheduledEnd: formData.get(\"scheduledEnd\") || undefined,\n\t\t\tassignedTo: formData.get(\"assignedTo\") || undefined,\n\t\t\tnotes: formData.get(\"notes\") || undefined,\n\t\t\t// Enhanced scheduling fields\n\t\t\tisRecurring: formData.get(\"isRecurring\") === \"true\",\n\t\t\tschedulingMode: (formData.get(\"schedulingMode\") as any) || undefined,\n\t\t\ttimeWindow: formData.get(\"timeWindow\") || undefined,\n\t\t\trecurrenceType: (formData.get(\"recurrenceType\") as any) || undefined,\n\t\t\trecurrenceEndDate: formData.get(\"recurrenceEndDate\") || undefined,\n\t\t\trecurrenceCount: formData.get(\"recurrenceCount\")\n\t\t\t\t? Number.parseInt(formData.get(\"recurrenceCount\") as string, 10)\n\t\t\t\t: undefined,\n\t\t});\n\n\t\t// Verify property belongs to company\n\t\tconst { data: property } = await supabase\n\t\t\t.from(\"properties\")\n\t\t\t.select(\"company_id, customer_id, address\")\n\t\t\t.eq(\"id\", data.propertyId)\n\t\t\t.single();\n\n\t\tassertExists(property, \"Property\");\n\n\t\tif (property.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"property\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Use customer from property if not provided\n\t\tconst customerId = data.customerId || property.customer_id;\n\n\t\t// Generate unique job number\n\t\tconst jobNumber = await generateJobNumber(supabase, companyId);\n\n\t\t// Add time window info to notes if applicable\n\t\tlet jobNotes = data.notes || \"\";\n\t\tif (data.schedulingMode === \"window\" && data.timeWindow) {\n\t\t\tconst windowInfo = `\\n\\n[Scheduling] Customer preferred time window: ${data.timeWindow.charAt(0).toUpperCase() + data.timeWindow.slice(1)}`;\n\t\t\tjobNotes = jobNotes ? `${jobNotes}${windowInfo}` : windowInfo.trim();\n\t\t}\n\n\t\t// Create core job record\n\t\tconst { data: newJob, error: createError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tproperty_id: data.propertyId,\n\t\t\t\tcustomer_id: customerId,\n\t\t\t\tassigned_to: data.assignedTo,\n\t\t\t\tjob_number: jobNumber,\n\t\t\t\ttitle: data.title,\n\t\t\t\tdescription: data.description,\n\t\t\t\tstatus: \"quoted\",\n\t\t\t\tpriority: data.priority,\n\t\t\t\tjob_type: data.jobType,\n\t\t\t\tservice_type: data.jobType, // Default service_type to job_type\n\t\t\t\tscheduled_start: data.scheduledStart,\n\t\t\t\tscheduled_end: data.scheduledEnd,\n\t\t\t\tnotes: jobNotes,\n\t\t\t})\n\t\t\t.select(\"id\")\n\t\t\t.single();\n\n\t\tif (createError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"create job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Create domain records (parallel inserts for performance)\n\t\tconst domainInserts = await Promise.all([\n\t\t\t// Financial domain - always create with defaults\n\t\t\tsupabase\n\t\t\t\t.from(\"job_financial\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\ttotal_amount: 0,\n\t\t\t\t\tpaid_amount: 0,\n\t\t\t\t\tdeposit_amount: 0,\n\t\t\t\t}),\n\n\t\t\t// Workflow domain - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_workflow\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\tworkflow_completed_stages: [],\n\t\t\t\t}),\n\n\t\t\t// Time tracking - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_time_tracking\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\ttotal_labor_hours: 0,\n\t\t\t\t\tbreak_time_minutes: 0,\n\t\t\t\t}),\n\n\t\t\t// Customer approval - always create with pending\n\t\t\tsupabase\n\t\t\t\t.from(\"job_customer_approval\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\tcustomer_approval_status: \"pending\",\n\t\t\t\t}),\n\n\t\t\t// Equipment service - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_equipment_service\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\tequipment_service_history: [],\n\t\t\t\t\tequipment_serviced: [],\n\t\t\t\t}),\n\n\t\t\t// Dispatch - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_dispatch\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t}),\n\n\t\t\t// Quality - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_quality\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\tinspection_required: false,\n\t\t\t\t}),\n\n\t\t\t// Safety - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_safety\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\trequires_permit: false,\n\t\t\t\t}),\n\n\t\t\t// AI enrichment - create empty for future processing\n\t\t\tsupabase\n\t\t\t\t.from(\"job_ai_enrichment\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t}),\n\n\t\t\t// Multi-entity - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_multi_entity\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\trequires_multiple_properties: false,\n\t\t\t\t\trequires_multiple_customers: false,\n\t\t\t\t}),\n\t\t]);\n\n\t\t// Check for any domain insert errors\n\t\tconst domainErrors = domainInserts.filter((result) => result.error);\n\t\tif (domainErrors.length > 0) {\n\t\t\t// Rollback - delete the job (CASCADE will delete domain records)\n\t\t\tawait supabase.from(\"jobs\").delete().eq(\"id\", newJob.id);\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"create job domains\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Create recurring jobs if requested\n\t\tif (data.isRecurring && data.recurrenceType && data.scheduledStart) {\n\t\t\tconst baseJob = {\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tproperty_id: data.propertyId,\n\t\t\t\tcustomer_id: customerId,\n\t\t\t\tassigned_to: data.assignedTo,\n\t\t\t\ttitle: data.title,\n\t\t\t\tdescription: data.description,\n\t\t\t\tstatus: \"quoted\",\n\t\t\t\tpriority: data.priority,\n\t\t\t\tjob_type: data.jobType,\n\t\t\t\tscheduled_start: data.scheduledStart,\n\t\t\t\tscheduled_end: data.scheduledEnd,\n\t\t\t\tnotes: data.notes,\n\t\t\t};\n\n\t\t\tawait createRecurringJobs(\n\t\t\t\tsupabase,\n\t\t\t\tcompanyId,\n\t\t\t\tbaseJob,\n\t\t\t\tdata.recurrenceType,\n\t\t\t\tdata.recurrenceEndDate,\n\t\t\t\tdata.recurrenceCount,\n\t\t\t);\n\t\t}\n\n\t\t// Send notification to assigned user if job is assigned\n\t\tif (data.assignedTo && data.assignedTo !== user.id) {\n\t\t\tawait notifyJobCreated({\n\t\t\t\tuserId: data.assignedTo,\n\t\t\t\tcompanyId: companyId,\n\t\t\t\tjobId: newJob.id,\n\t\t\t\tjobTitle: data.title,\n\t\t\t\taddress: property.address || \"Unknown address\",\n\t\t\t\tpriority:\n\t\t\t\t\tdata.priority === \"urgent\"\n\t\t\t\t\t\t? \"urgent\"\n\t\t\t\t\t\t: data.priority === \"high\"\n\t\t\t\t\t\t\t? \"high\"\n\t\t\t\t\t\t\t: \"medium\",\n\t\t\t\tactionUrl: \"/dashboard/work\",\n\t\t\t});\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(\"/dashboard/work/jobs\");\n\t\treturn newJob.id;\n\t});\n}\n\n/**\n * Get a single job by ID\n *  ALREADY MIGRATED - Fetches job with all domain data\n */\nasync function getJob(jobId: string): Promise<ActionResult<any>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Get job with basic relationships\n\t\t// Simplified query - many domain tables don't exist yet\n\t\tconst { data: job, error: jobError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\n\t\t\t\t`\n\t\t\t\t*,\n\t\t\t\tproperty:properties(*),\n\t\t\t\tcustomer:customers!customer_id(id, first_name, last_name, email, phone, display_name)\n\t\t\t`,\n\t\t\t)\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (jobError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.notFound(\"Job\"),\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t404,\n\t\t\t);\n\t\t}\n\n\t\tassertExists(job, \"Job\");\n\n\t\t// Verify job belongs to company\n\t\tif (job.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\treturn job;\n\t});\n}\n\n/**\n * Update job details\n *  REFACTORED - Now updates both core jobs table and domain tables\n */\nexport async function updateJob(\n\tjobId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID\n\t\tconst activeCompanyId = await getActiveCompanyId();\n\t\tif (!activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Get user's role to check if they're admin/owner\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\n\t\t\t\t`\n        role_id,\n        custom_roles!role_id(name, is_system)\n      `,\n\t\t\t)\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.maybeSingle();\n\n\t\tconst role = Array.isArray(teamMember?.custom_roles)\n\t\t\t? teamMember.custom_roles[0]\n\t\t\t: teamMember?.custom_roles;\n\n\t\tconst isAdminOrOwner =\n\t\t\trole?.name === \"Admin\" ||\n\t\t\trole?.name === \"Owner\" ||\n\t\t\trole?.is_system === true;\n\n\t\t// Verify job belongs to company\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, status\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Prevent editing completed or cancelled jobs (unless admin/owner)\n\t\tif (\n\t\t\t!isAdminOrOwner &&\n\t\t\t(existingJob.status === \"completed\" || existingJob.status === \"cancelled\")\n\t\t) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Cannot edit ${existingJob.status} jobs`,\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\tconst customerIdValue = formData.get(\"customerId\");\n\t\tconst propertyIdValue = formData.get(\"propertyId\");\n\n\t\t// Handle customerId: empty string or \"null\" string means remove (set to null)\n\t\t// undefined means don't change it\n\t\tlet parsedCustomerId: string | null | undefined;\n\t\tif (customerIdValue === null || customerIdValue === undefined) {\n\t\t\tparsedCustomerId = undefined; // Don't change\n\t\t} else if (customerIdValue === \"\" || customerIdValue === \"null\") {\n\t\t\tparsedCustomerId = null; // Remove customer\n\t\t} else {\n\t\t\tparsedCustomerId = customerIdValue as string; // Set to this customer\n\t\t}\n\n\t\t// Handle propertyId: empty string means remove (set to null), undefined means don't change\n\t\tlet parsedPropertyId: string | null | undefined;\n\t\tif (propertyIdValue === null || propertyIdValue === undefined) {\n\t\t\tparsedPropertyId = undefined; // Don't change\n\t\t} else if (propertyIdValue === \"\" || propertyIdValue === \"null\") {\n\t\t\tparsedPropertyId = null; // Remove property\n\t\t} else {\n\t\t\tparsedPropertyId = propertyIdValue as string; // Set to this property\n\t\t}\n\n\t\tconst data = updateJobSchema.parse({\n\t\t\ttitle: formData.get(\"title\") || undefined,\n\t\t\tdescription: formData.get(\"description\") || undefined,\n\t\t\tstatus: formData.get(\"status\") || undefined,\n\t\t\tpriority: formData.get(\"priority\") || undefined,\n\t\t\tjobType: formData.get(\"jobType\") || undefined,\n\t\t\tnotes: formData.get(\"notes\") || undefined,\n\t\t\t// Financial fields (now in job_financial domain table)\n\t\t\ttotalAmount: formData.get(\"totalAmount\")\n\t\t\t\t? Number.parseInt(formData.get(\"totalAmount\") as string, 10)\n\t\t\t\t: undefined,\n\t\t\tpaidAmount: formData.get(\"paidAmount\")\n\t\t\t\t? Number.parseInt(formData.get(\"paidAmount\") as string, 10)\n\t\t\t\t: undefined,\n\t\t\tdepositAmount: formData.get(\"depositAmount\")\n\t\t\t\t? Number.parseInt(formData.get(\"depositAmount\") as string, 10)\n\t\t\t\t: undefined,\n\t\t\tscheduledStart: formData.get(\"scheduledStart\") || undefined,\n\t\t\tscheduledEnd: formData.get(\"scheduledEnd\") || undefined,\n\t\t\tassignedTo: formData.get(\"assignedTo\") || null,\n\t\t\tcustomerId: parsedCustomerId,\n\t\t\tpropertyId: parsedPropertyId,\n\t\t});\n\n\t\t// If status is being changed, validate the transition\n\t\tif (data.status !== undefined && data.status !== existingJob.status) {\n\t\t\t// Fetch additional context for status validation\n\t\t\tconst { data: jobWithContext } = await supabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\n\t\t\t\t\t`\n\t\t\t\t\tid,\n\t\t\t\t\tstatus,\n\t\t\t\t\tscheduled_start,\n\t\t\t\t\tscheduled_end,\n\t\t\t\t\tassigned_to,\n\t\t\t\t\tcustomer_id,\n\t\t\t\t\tproperty_id,\n\t\t\t\t\ttotal_amount,\n\t\t\t\t\tinvoices:invoices(status, total_amount),\n\t\t\t\t\testimates:estimates(status),\n\t\t\t\t\tteam_assignments:job_team_assignments(team_member_id)\n\t\t\t\t`,\n\t\t\t\t)\n\t\t\t\t.eq(\"id\", jobId)\n\t\t\t\t.single();\n\n\t\t\tif (jobWithContext) {\n\t\t\t\tconst transitionContext: JobStatusTransitionContext = {\n\t\t\t\t\tcurrentStatus: jobWithContext.status as JobStatus,\n\t\t\t\t\tnewStatus: data.status as JobStatus,\n\t\t\t\t\tjob: {\n\t\t\t\t\t\tid: jobWithContext.id,\n\t\t\t\t\t\tscheduled_start:\n\t\t\t\t\t\t\tdata.scheduledStart || jobWithContext.scheduled_start,\n\t\t\t\t\t\tscheduled_end: data.scheduledEnd || jobWithContext.scheduled_end,\n\t\t\t\t\t\tassigned_to:\n\t\t\t\t\t\t\tdata.assignedTo !== undefined\n\t\t\t\t\t\t\t\t? data.assignedTo\n\t\t\t\t\t\t\t\t: jobWithContext.assigned_to,\n\t\t\t\t\t\tcustomer_id:\n\t\t\t\t\t\t\tdata.customerId !== undefined\n\t\t\t\t\t\t\t\t? data.customerId\n\t\t\t\t\t\t\t\t: jobWithContext.customer_id,\n\t\t\t\t\t\tproperty_id:\n\t\t\t\t\t\t\tdata.propertyId !== undefined\n\t\t\t\t\t\t\t\t? data.propertyId\n\t\t\t\t\t\t\t\t: jobWithContext.property_id,\n\t\t\t\t\t\ttotal_amount:\n\t\t\t\t\t\t\tdata.totalAmount !== undefined\n\t\t\t\t\t\t\t\t? data.totalAmount\n\t\t\t\t\t\t\t\t: jobWithContext.total_amount,\n\t\t\t\t\t\tinvoices: jobWithContext.invoices || [],\n\t\t\t\t\t\testimates: jobWithContext.estimates || [],\n\t\t\t\t\t\tteamAssignments: jobWithContext.team_assignments || [],\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\tconst validationResult = validateStatusTransition(transitionContext);\n\n\t\t\t\tif (!validationResult.allowed) {\n\t\t\t\t\tlet errorMessage =\n\t\t\t\t\t\tvalidationResult.reason || \"Status transition not allowed\";\n\n\t\t\t\t\tif (\n\t\t\t\t\t\tvalidationResult.requiredFields &&\n\t\t\t\t\t\tvalidationResult.requiredFields.length > 0\n\t\t\t\t\t) {\n\t\t\t\t\t\terrorMessage += `. Missing: ${validationResult.requiredFields.join(\", \")}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tthrow new ActionError(errorMessage, ERROR_CODES.VALIDATION_FAILED);\n\t\t\t\t}\n\n\t\t\t\t// Log warnings if present (non-blocking)\n\t\t\t\tif (validationResult.warnings && validationResult.warnings.length > 0) {\n\t\t\t\t\tconsole.warn(\" Status transition warnings:\", {\n\t\t\t\t\t\tjobId,\n\t\t\t\t\t\tcurrentStatus: jobWithContext.status,\n\t\t\t\t\t\tnewStatus: data.status,\n\t\t\t\t\t\twarnings: validationResult.warnings,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Build core job update object with only defined values\n\t\tconst coreUpdateData: any = {};\n\t\tif (data.title !== undefined) {\n\t\t\tcoreUpdateData.title = data.title;\n\t\t}\n\t\tif (data.description !== undefined) {\n\t\t\tcoreUpdateData.description = data.description;\n\t\t}\n\t\tif (data.status !== undefined) {\n\t\t\tcoreUpdateData.status = data.status;\n\t\t}\n\t\tif (data.priority !== undefined) {\n\t\t\tcoreUpdateData.priority = data.priority;\n\t\t}\n\t\tif (data.jobType !== undefined) {\n\t\t\tcoreUpdateData.job_type = data.jobType;\n\t\t}\n\t\tif (data.notes !== undefined) {\n\t\t\tcoreUpdateData.notes = data.notes;\n\t\t}\n\t\tif (data.scheduledStart !== undefined) {\n\t\t\tcoreUpdateData.scheduled_start = data.scheduledStart;\n\t\t}\n\t\tif (data.scheduledEnd !== undefined) {\n\t\t\tcoreUpdateData.scheduled_end = data.scheduledEnd;\n\t\t}\n\t\tif (data.assignedTo !== undefined) {\n\t\t\tcoreUpdateData.assigned_to = data.assignedTo;\n\t\t}\n\t\tif (data.customerId !== undefined) {\n\t\t\tcoreUpdateData.customer_id = data.customerId;\n\t\t}\n\t\tif (data.propertyId !== undefined) {\n\t\t\tcoreUpdateData.property_id = data.propertyId;\n\t\t\t// If property is being set (not null), verify it belongs to the customer (if customer is set)\n\t\t\tif (\n\t\t\t\tdata.propertyId !== null &&\n\t\t\t\tdata.customerId !== undefined &&\n\t\t\t\tdata.customerId !== null\n\t\t\t) {\n\t\t\t\tconst { data: property } = await supabase\n\t\t\t\t\t.from(\"properties\")\n\t\t\t\t\t.select(\"customer_id\")\n\t\t\t\t\t.eq(\"id\", data.propertyId)\n\t\t\t\t\t.single();\n\n\t\t\t\tif (property && property.customer_id !== data.customerId) {\n\t\t\t\t\tthrow new ActionError(\n\t\t\t\t\t\t\"Property does not belong to the selected customer\",\n\t\t\t\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Build financial domain update object (if any financial fields provided)\n\t\tconst financialUpdateData: any = {};\n\t\tif (data.totalAmount !== undefined) {\n\t\t\tfinancialUpdateData.total_amount = data.totalAmount;\n\t\t}\n\t\tif (data.paidAmount !== undefined) {\n\t\t\tfinancialUpdateData.paid_amount = data.paidAmount;\n\t\t}\n\t\tif (data.depositAmount !== undefined) {\n\t\t\tfinancialUpdateData.deposit_amount = data.depositAmount;\n\t\t}\n\n\t\t// Execute updates in parallel for performance\n\t\tconst updates: Promise<any>[] = [];\n\n\t\t// Update core job table if there are changes\n\t\tif (Object.keys(coreUpdateData).length > 0) {\n\t\t\tupdates.push(\n\t\t\t\tsupabase.from(\"jobs\").update(coreUpdateData).eq(\"id\", jobId),\n\t\t\t);\n\t\t}\n\n\t\t// Update financial domain table if there are changes\n\t\tif (Object.keys(financialUpdateData).length > 0) {\n\t\t\tupdates.push(\n\t\t\t\tsupabase\n\t\t\t\t\t.from(\"job_financial\")\n\t\t\t\t\t.update(financialUpdateData)\n\t\t\t\t\t.eq(\"job_id\", jobId),\n\t\t\t);\n\t\t}\n\n\t\t// Execute all updates in parallel\n\t\tif (updates.length > 0) {\n\t\t\tconst results = await Promise.all(updates);\n\n\t\t\t// Check for errors in any update\n\t\t\tconst errors = results.filter((result) => result.error);\n\t\t\tif (errors.length > 0) {\n\t\t\t\tconst errorMessages = errors.map((e) => e.error.message).join(\", \");\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\t`${ERROR_MESSAGES.operationFailed(\"update job\")}: ${errorMessages}`,\n\t\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Update job with data object (easier for programmatic use)\n * Used by job editor for in-place updates\n */\nasync function updateJobData(\n\tjobId: string,\n\tdata: Partial<UpdateJobData>,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\t// Convert data object to FormData for compatibility with existing updateJob\n\t\tconst formData = new FormData();\n\n\t\t// Add all defined fields to FormData\n\t\tif (data.title !== undefined) formData.append(\"title\", data.title);\n\t\tif (data.description !== undefined)\n\t\t\tformData.append(\"description\", data.description);\n\t\tif (data.status !== undefined) formData.append(\"status\", data.status);\n\t\tif (data.priority !== undefined) formData.append(\"priority\", data.priority);\n\t\tif (data.jobType !== undefined) formData.append(\"jobType\", data.jobType);\n\t\tif (data.notes !== undefined) formData.append(\"notes\", data.notes);\n\t\tif (data.totalAmount !== undefined)\n\t\t\tformData.append(\"totalAmount\", data.totalAmount.toString());\n\t\tif (data.paidAmount !== undefined)\n\t\t\tformData.append(\"paidAmount\", data.paidAmount.toString());\n\t\tif (data.depositAmount !== undefined)\n\t\t\tformData.append(\"depositAmount\", data.depositAmount.toString());\n\t\tif (data.scheduledStart !== undefined)\n\t\t\tformData.append(\"scheduledStart\", data.scheduledStart);\n\t\tif (data.scheduledEnd !== undefined)\n\t\t\tformData.append(\"scheduledEnd\", data.scheduledEnd);\n\t\tif (data.assignedTo !== undefined)\n\t\t\tformData.append(\"assignedTo\", data.assignedTo || \"\");\n\t\tif (data.customerId !== undefined)\n\t\t\tformData.append(\"customerId\", data.customerId || \"\");\n\t\tif (data.propertyId !== undefined)\n\t\t\tformData.append(\"propertyId\", data.propertyId || \"\");\n\n\t\t// Reuse existing updateJob logic\n\t\treturn await updateJob(jobId, formData);\n\t});\n}\n\n/**\n * Update job status with validation\n *  NO CHANGES NEEDED - Only updates jobs.status\n */\nexport async function updateJobStatus(\n\tjobId: string,\n\tnewStatus: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Validate status value\n\t\tconst validStatuses: JobStatus[] = [\n\t\t\t\"quoted\",\n\t\t\t\"scheduled\",\n\t\t\t\"in_progress\",\n\t\t\t\"on_hold\",\n\t\t\t\"completed\",\n\t\t\t\"cancelled\",\n\t\t\t\"invoiced\",\n\t\t\t\"paid\",\n\t\t];\n\t\tif (!validStatuses.includes(newStatus as JobStatus)) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Invalid job status\",\n\t\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t\t);\n\t\t}\n\n\t\t// Fetch job with all context needed for transition validation\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\n\t\t\t\t`\n\t\t\t\tid,\n\t\t\t\tcompany_id,\n\t\t\t\tstatus,\n\t\t\t\tscheduled_start,\n\t\t\t\tscheduled_end,\n\t\t\t\tassigned_to,\n\t\t\t\tcustomer_id,\n\t\t\t\tproperty_id,\n\t\t\t\ttotal_amount,\n\t\t\t\tinvoices:invoices(status, total_amount),\n\t\t\t\testimates:estimates(status),\n\t\t\t\tteam_assignments:job_team_assignments(team_member_id)\n\t\t\t`,\n\t\t\t)\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Build context for transition validation\n\t\tconst transitionContext: JobStatusTransitionContext = {\n\t\t\tcurrentStatus: existingJob.status as JobStatus,\n\t\t\tnewStatus: newStatus as JobStatus,\n\t\t\tjob: {\n\t\t\t\tid: existingJob.id,\n\t\t\t\tscheduled_start: existingJob.scheduled_start,\n\t\t\t\tscheduled_end: existingJob.scheduled_end,\n\t\t\t\tassigned_to: existingJob.assigned_to,\n\t\t\t\tcustomer_id: existingJob.customer_id,\n\t\t\t\tproperty_id: existingJob.property_id,\n\t\t\t\ttotal_amount: existingJob.total_amount,\n\t\t\t\tinvoices: existingJob.invoices || [],\n\t\t\t\testimates: existingJob.estimates || [],\n\t\t\t\tteamAssignments: existingJob.team_assignments || [],\n\t\t\t},\n\t\t};\n\n\t\t// Validate transition with comprehensive business rules\n\t\tconst validationResult = validateStatusTransition(transitionContext);\n\n\t\tif (!validationResult.allowed) {\n\t\t\tlet errorMessage =\n\t\t\t\tvalidationResult.reason || \"Status transition not allowed\";\n\n\t\t\tif (\n\t\t\t\tvalidationResult.requiredFields &&\n\t\t\t\tvalidationResult.requiredFields.length > 0\n\t\t\t) {\n\t\t\t\terrorMessage += `. Missing: ${validationResult.requiredFields.join(\", \")}`;\n\t\t\t}\n\n\t\t\tthrow new ActionError(errorMessage, ERROR_CODES.VALIDATION_FAILED);\n\t\t}\n\n\t\t// Log warnings if present (non-blocking)\n\t\tif (validationResult.warnings && validationResult.warnings.length > 0) {\n\t\t\tconsole.warn(\" Status transition warnings:\", {\n\t\t\t\tjobId,\n\t\t\t\tcurrentStatus: existingJob.status,\n\t\t\t\tnewStatus,\n\t\t\t\twarnings: validationResult.warnings,\n\t\t\t});\n\t\t}\n\n\t\t// Update status\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.update({ status: newStatus })\n\t\t\t.eq(\"id\", jobId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update job status\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconsole.log(\" Job status updated:\", {\n\t\t\tjobId,\n\t\t\toldStatus: existingJob.status,\n\t\t\tnewStatus,\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Assign job to a technician\n *  NO CHANGES NEEDED - Only updates jobs.assigned_to\n */\nasync function assignJob(\n\tjobId: string,\n\ttechnicianId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify technician belongs to company\n\t\tconst { data: technician } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"user_id\")\n\t\t\t.eq(\"user_id\", technicianId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!technician) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Technician not found in your company\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t404,\n\t\t\t);\n\t\t}\n\n\t\t// Assign job\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.update({ assigned_to: technicianId })\n\t\t\t.eq(\"id\", jobId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"assign job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Schedule a job\n *  NO CHANGES NEEDED - Only updates jobs table scheduling fields\n */\nasync function scheduleJob(\n\tjobId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst data = scheduleJobSchema.parse({\n\t\t\tscheduledStart: formData.get(\"scheduledStart\"),\n\t\t\tscheduledEnd: formData.get(\"scheduledEnd\"),\n\t\t});\n\n\t\t// Verify job belongs to company\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, status\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Update schedule and status\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.update({\n\t\t\t\tscheduled_start: data.scheduledStart,\n\t\t\t\tscheduled_end: data.scheduledEnd,\n\t\t\t\tstatus:\n\t\t\t\t\texistingJob.status === \"quoted\" ? \"scheduled\" : existingJob.status,\n\t\t\t})\n\t\t\t.eq(\"id\", jobId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"schedule job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(\"/dashboard/schedule\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Start a job\n *  REFACTORED - Now updates job_time_tracking.actual_start instead of jobs.actual_start\n */\nexport async function startJob(jobId: string): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, status\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Can only start scheduled jobs\n\t\tif (existingJob.status !== \"scheduled\" && existingJob.status !== \"quoted\") {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Job must be scheduled before starting\",\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\tconst now = new Date().toISOString();\n\n\t\t// Update both jobs table (status) and job_time_tracking table (actual_start) in parallel\n\t\tconst updates = await Promise.all([\n\t\t\tsupabase.from(\"jobs\").update({ status: \"in_progress\" }).eq(\"id\", jobId),\n\t\t\tsupabase\n\t\t\t\t.from(\"job_time_tracking\")\n\t\t\t\t.update({ actual_start: now })\n\t\t\t\t.eq(\"job_id\", jobId),\n\t\t]);\n\n\t\t// Check for errors in either update\n\t\tconst errors = updates.filter((result) => result.error);\n\t\tif (errors.length > 0) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"start job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Complete a job\n *  REFACTORED - Now updates job_time_tracking.actual_end and calculates total_labor_hours\n */\nexport async function completeJob(jobId: string): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company and get time tracking data\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, status, timeTracking:job_time_tracking(*)\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Can only complete in-progress jobs\n\t\tif (existingJob.status !== \"in_progress\") {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Job must be in progress to complete\",\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\tconst now = new Date().toISOString();\n\n\t\t// Calculate total labor hours if we have actual_start\n\t\tconst timeTracking = Array.isArray(existingJob.timeTracking)\n\t\t\t? existingJob.timeTracking[0]\n\t\t\t: existingJob.timeTracking;\n\n\t\tconst timeTrackingUpdate: any = { actual_end: now };\n\n\t\tif (timeTracking?.actual_start) {\n\t\t\tconst startTime = new Date(timeTracking.actual_start).getTime();\n\t\t\tconst endTime = new Date(now).getTime();\n\t\t\tconst hoursWorked = (endTime - startTime) / (1000 * 60 * 60); // Convert ms to hours\n\t\t\ttimeTrackingUpdate.total_labor_hours = hoursWorked;\n\t\t}\n\n\t\t// Update both jobs table (status) and job_time_tracking table (actual_end, total_labor_hours) in parallel\n\t\tconst updates = await Promise.all([\n\t\t\tsupabase.from(\"jobs\").update({ status: \"completed\" }).eq(\"id\", jobId),\n\t\t\tsupabase\n\t\t\t\t.from(\"job_time_tracking\")\n\t\t\t\t.update(timeTrackingUpdate)\n\t\t\t\t.eq(\"job_id\", jobId),\n\t\t]);\n\n\t\t// Check for errors in either update\n\t\tconst errors = updates.filter((result) => result.error);\n\t\tif (errors.length > 0) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"complete job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Cancel a job\n *  NO CHANGES NEEDED - Only updates jobs.status and jobs.notes\n */\nasync function cancelJob(\n\tjobId: string,\n\treason?: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, status, notes\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Cannot cancel completed jobs\n\t\tif (existingJob.status === \"completed\") {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Cannot cancel completed jobs\",\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\t// Add cancellation reason to notes\n\t\tconst updatedNotes = reason\n\t\t\t? `${existingJob.notes || \"\"}\\n\\n[CANCELLED]: ${reason}`.trim()\n\t\t\t: existingJob.notes;\n\n\t\t// Cancel job\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.update({\n\t\t\t\tstatus: \"cancelled\",\n\t\t\t\tnotes: updatedNotes,\n\t\t\t})\n\t\t\t.eq(\"id\", jobId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"cancel job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Search jobs with full-text search and ranking\n *  NO CHANGES NEEDED - Only searches jobs table\n */\nasync function searchJobs(\n\tsearchTerm: string,\n\toptions?: { limit?: number; offset?: number },\n): Promise<ActionResult<any[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Use full-text search with ranking for best matches\n\t\tconst { searchJobsFullText } = await import(\n\t\t\t\"@/lib/search/full-text-search\"\n\t\t);\n\n\t\tconst jobs = await searchJobsFullText(supabase, teamMember.company_id, searchTerm, {\n\t\t\tlimit: options?.limit || 50,\n\t\t\toffset: options?.offset || 0,\n\t\t});\n\n\t\treturn jobs;\n\t});\n}\n\n/**\n * Universal search across all entities\n *  NO CHANGES NEEDED - Only searches jobs table\n */\nasync function searchAll(\n\tsearchTerm: string,\n): Promise<ActionResult<any>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Use universal search RPC function\n\t\tconst { data, error } = await supabase.rpc(\"search_all_entities\", {\n\t\t\tcompany_id_param: teamMember.company_id,\n\t\t\tsearch_query: searchTerm,\n\t\t\tper_entity_limit: 5,\n\t\t});\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"search\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n// ============================================================================\n// JOB ARCHIVE & RESTORE\n// ============================================================================\n\n/**\n * Archive job (soft delete)\n *  REFACTORED - Now updates job_multi_entity.deleted_by and permanent_delete_scheduled_at\n */\nexport async function archiveJob(jobId: string): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company\n\t\tconst { data: job } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, status\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(job, \"Job\");\n\n\t\tif (job.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Cannot archive completed/paid jobs (business rule)\n\t\tif (job.status === \"completed\" || job.status === \"invoiced\") {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Cannot archive completed or invoiced jobs. These must be retained for records.\",\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\t// Archive job (soft delete)\n\t\tconst now = new Date().toISOString();\n\t\tconst scheduledDeletion = new Date(\n\t\t\tDate.now() + 90 * 24 * 60 * 60 * 1000,\n\t\t).toISOString();\n\n\t\t// Update both jobs table and job_multi_entity table in parallel\n\t\tconst updates = await Promise.all([\n\t\t\t// Update core jobs table with archive metadata\n\t\t\tsupabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.update({\n\t\t\t\t\tdeleted_at: now,\n\t\t\t\t\tarchived_at: now,\n\t\t\t\t\tstatus: \"archived\",\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", jobId),\n\n\t\t\t// Update job_multi_entity table with deletion tracking\n\t\t\tsupabase\n\t\t\t\t.from(\"job_multi_entity\")\n\t\t\t\t.update({\n\t\t\t\t\tdeleted_by: user.id,\n\t\t\t\t\tpermanent_delete_scheduled_at: scheduledDeletion,\n\t\t\t\t})\n\t\t\t\t.eq(\"job_id\", jobId),\n\t\t]);\n\n\t\t// Check for errors in either update\n\t\tconst errors = updates.filter((result) => result.error);\n\t\tif (errors.length > 0) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"archive job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(\"/dashboard/schedule\");\n\t\trevalidatePath(\"/dashboard/settings/archive\");\n\t});\n}\n\n/**\n * Restore archived job\n *  REFACTORED - Now clears job_multi_entity.deleted_by and permanent_delete_scheduled_at\n */\nasync function restoreJob(jobId: string): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company and is archived\n\t\tconst { data: job } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, deleted_at, status\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(job, \"Job\");\n\n\t\tif (job.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tif (!job.deleted_at) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Job is not archived\",\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\t// Restore job - update both tables in parallel\n\t\tconst updates = await Promise.all([\n\t\t\t// Clear core jobs table archive metadata\n\t\t\tsupabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.update({\n\t\t\t\t\tdeleted_at: null,\n\t\t\t\t\tarchived_at: null,\n\t\t\t\t\tstatus: job.status === \"archived\" ? \"scheduled\" : job.status,\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", jobId),\n\n\t\t\t// Clear job_multi_entity table deletion tracking\n\t\t\tsupabase\n\t\t\t\t.from(\"job_multi_entity\")\n\t\t\t\t.update({\n\t\t\t\t\tdeleted_by: null,\n\t\t\t\t\tpermanent_delete_scheduled_at: null,\n\t\t\t\t})\n\t\t\t\t.eq(\"job_id\", jobId),\n\t\t]);\n\n\t\t// Check for errors in either update\n\t\tconst errors = updates.filter((result) => result.error);\n\t\tif (errors.length > 0) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"restore job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(\"/dashboard/schedule\");\n\t\trevalidatePath(\"/dashboard/settings/archive\");\n\t});\n}\n\n/**\n * Remove team assignment from job\n *  NO CHANGES NEEDED - Only deletes from job_team_assignments junction table\n */\nasync function removeTeamAssignment(\n\tassignmentId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Get the junction record to find job_id for revalidation\n\t\tconst { data: record, error: fetchError } = await supabase\n\t\t\t.from(\"job_team_assignments\")\n\t\t\t.select(\"id, job_id, company_id\")\n\t\t\t.eq(\"id\", assignmentId)\n\t\t\t.single();\n\n\t\tif (fetchError || !record) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Team assignment not found\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t);\n\t\t}\n\n\t\tif (record.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"team assignment\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst jobId = record.job_id;\n\n\t\t// Delete junction table row\n\t\tconst { error: deleteError } = await supabase\n\t\t\t.from(\"job_team_assignments\")\n\t\t\t.delete()\n\t\t\t.eq(\"id\", assignmentId);\n\n\t\tif (deleteError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"remove team assignment from job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate job page and schedule\n\t\tif (jobId) {\n\t\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t\t}\n\t\trevalidatePath(\"/dashboard/schedule\");\n\t\trevalidatePath(\"/dashboard/work\");\n\t});\n}\n\n/**\n * Assign Customer and Property to Job\n *\n * Updates the job's customer_id and property_id.\n * Only one customer and property can be assigned per job.\n *\n * @param jobId - Job ID\n * @param customerId - Customer ID to assign\n * @param propertyId - Property ID to assign (optional)\n */\nexport async function assignCustomerToJob(\n\tjobId: string,\n\tcustomerId: string,\n\tpropertyId: string | null,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"company access\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job exists and belongs to company\n\t\tconst { data: job, error: jobError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tif (jobError) {\n\t\t\tconsole.error(\"Job query error:\", jobError);\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to find job: ${jobError.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t);\n\t\t}\n\n\t\tassertExists(job, \"Job\");\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer, error: customerError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tif (customerError) {\n\t\t\tconsole.error(\"Customer query error:\", customerError);\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to find customer: ${customerError.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t);\n\t\t}\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\t// If property is provided, verify it exists and belongs to customer\n\t\tif (propertyId) {\n\t\t\tconst { data: property } = await supabase\n\t\t\t\t.from(\"properties\")\n\t\t\t\t.select(\"id, customer_id\")\n\t\t\t\t.eq(\"id\", propertyId)\n\t\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t\t.single();\n\n\t\t\tif (!property) {\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\t\"Property not found or does not belong to this customer\",\n\t\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t\t404,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Update job with customer and property\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.update({\n\t\t\t\tcustomer_id: customerId,\n\t\t\t\tproperty_id: propertyId,\n\t\t\t})\n\t\t\t.eq(\"id\", jobId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"assign customer to job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Log activity\n\t\tawait supabase.from(\"job_activity_log\").insert({\n\t\t\tjob_id: jobId,\n\t\t\tcompany_id: companyId,\n\t\t\tuser_id: user.id,\n\t\t\tactivity_type: \"assigned\",\n\t\t\tentity_type: \"customer\",\n\t\t\tdescription: `Assigned customer${propertyId ? \" and property\" : \"\"}`,\n\t\t\tmetadata: {\n\t\t\t\tcustomer_id: customerId,\n\t\t\t\tproperty_id: propertyId,\n\t\t\t},\n\t\t});\n\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(\"/welcome\");\n\t});\n}\n\n/**\n * Remove Customer and Property from Job\n *\n * Removes the customer_id and property_id from the job.\n * Related data (appointments, invoices, etc.) remain but are no longer linked.\n *\n * @param jobId - Job ID\n */\nexport async function removeCustomerFromJob(\n\tjobId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"company access\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job exists and belongs to company\n\t\tconst { data: job } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id, company_id, customer_id, property_id\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(job, \"Job\");\n\n\t\t// Update job to remove customer and property\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.update({\n\t\t\t\tcustomer_id: null,\n\t\t\t\tproperty_id: null,\n\t\t\t})\n\t\t\t.eq(\"id\", jobId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"remove customer from job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Log activity\n\t\tawait supabase.from(\"job_activity_log\").insert({\n\t\t\tjob_id: jobId,\n\t\t\tcompany_id: companyId,\n\t\t\tuser_id: user.id,\n\t\t\tactivity_type: \"removed\",\n\t\t\tentity_type: \"customer\",\n\t\t\tdescription: \"Removed customer and property\",\n\t\t\tmetadata: {\n\t\t\t\tprevious_customer_id: job.customer_id,\n\t\t\t\tprevious_property_id: job.property_id,\n\t\t\t},\n\t\t});\n\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(\"/welcome\");\n\t});\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 8055, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/schedule-assignments.ts"],"sourcesContent":["\"use server\";\n\nimport { createClient } from \"@/lib/supabase/server\";\n\nexport async function assignJobToTechnician(\n\t_jobId: string,\n\tscheduleId: string,\n\ttechnicianId: string,\n) {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Database not available\" };\n\t}\n\n\ttry {\n\t\t// First check if the schedule exists and get current assignment\n\t\tconst { data: existingSchedule, error: checkError } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.select(\"id, assigned_to\")\n\t\t\t.eq(\"id\", scheduleId)\n\t\t\t.single();\n\n\t\tif (checkError) {\n\t\t\tthrow new Error(`Schedule check failed: ${checkError.message}`);\n\t\t}\n\n\t\tif (!existingSchedule) {\n\t\t\tthrow new Error(\"Schedule not found\");\n\t\t}\n\n\t\t// Update the schedule's assigned_to field\n\t\tconst { data: updatedSchedule, error: scheduleError } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update({ assigned_to: technicianId })\n\t\t\t.eq(\"id\", scheduleId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (scheduleError) {\n\t\t\tthrow new Error(`Schedule update failed: ${scheduleError.message}`);\n\t\t}\n\n\t\t// Don't revalidate immediately - let the optimistic update show\n\t\t// revalidatePath(\"/dashboard/schedule\");\n\t\treturn { success: true, data: updatedSchedule };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to assign job\",\n\t\t};\n\t}\n}\n\nexport async function updateAppointmentTimes(\n\tscheduleId: string,\n\tstartTime: Date,\n\tendTime: Date,\n) {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Database not available\" };\n\t}\n\n\ttry {\n\t\tconst duration = Math.round(\n\t\t\t(endTime.getTime() - startTime.getTime()) / (1000 * 60),\n\t\t);\n\n\t\t// Format as local datetime string WITHOUT timezone conversion\n\t\t// Get year, month, day, hour, minute from the Date object directly\n\t\tconst formatLocalDateTime = (date: Date) => {\n\t\t\tconst year = date.getFullYear();\n\t\t\tconst month = String(date.getMonth() + 1).padStart(2, \"0\");\n\t\t\tconst day = String(date.getDate()).padStart(2, \"0\");\n\t\t\tconst hour = String(date.getHours()).padStart(2, \"0\");\n\t\t\tconst minute = String(date.getMinutes()).padStart(2, \"0\");\n\t\t\tconst second = String(date.getSeconds()).padStart(2, \"0\");\n\t\t\treturn `${year}-${month}-${day} ${hour}:${minute}:${second}`;\n\t\t};\n\n\t\tconst startStr = formatLocalDateTime(startTime);\n\t\tconst endStr = formatLocalDateTime(endTime);\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update({\n\t\t\t\tstart_time: startStr,\n\t\t\t\tend_time: endStr,\n\t\t\t\tduration,\n\t\t\t})\n\t\t\t.eq(\"id\", scheduleId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\t// Don't revalidate immediately - let the optimistic update show\n\t\t// revalidatePath(\"/dashboard/schedule\");\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to update times\",\n\t\t};\n\t}\n}\n\nexport async function cancelAppointment(scheduleId: string, reason?: string) {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Database not available\" };\n\t}\n\n\ttry {\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\n\t\tif (!user) {\n\t\t\treturn { success: false, error: \"Not authenticated\" };\n\t\t}\n\n\t\t// Cancel appointment - unschedule it (remove assigned_to)\n\t\tconst { error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update({\n\t\t\t\tstatus: \"cancelled\",\n\t\t\t\tassigned_to: null, // Unassign technician\n\t\t\t\tcancelled_at: new Date().toISOString(),\n\t\t\t\tcancelled_by: user.id,\n\t\t\t\tcancellation_reason: reason || null,\n\t\t\t})\n\t\t\t.eq(\"id\", scheduleId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to cancel appointment\",\n\t\t};\n\t}\n}\n\nexport async function cancelJobAndAppointment(\n\tscheduleId: string,\n\tjobId: string,\n\treason?: string,\n) {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Database not available\" };\n\t}\n\n\ttry {\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\n\t\tif (!user) {\n\t\t\treturn { success: false, error: \"Not authenticated\" };\n\t\t}\n\n\t\tconst now = new Date().toISOString();\n\n\t\t// Cancel the appointment\n\t\tconst { error: scheduleError } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update({\n\t\t\t\tstatus: \"cancelled\",\n\t\t\t\tassigned_to: null,\n\t\t\t\tcancelled_at: now,\n\t\t\t\tcancelled_by: user.id,\n\t\t\t\tcancellation_reason: reason || null,\n\t\t\t})\n\t\t\t.eq(\"id\", scheduleId);\n\n\t\tif (scheduleError) {\n\t\t\tthrow scheduleError;\n\t\t}\n\n\t\t// Also cancel the job if it exists\n\t\tif (jobId) {\n\t\t\tconst { error: jobError } = await supabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.update({\n\t\t\t\t\tstatus: \"cancelled\",\n\t\t\t\t\tcancelled_at: now,\n\t\t\t\t\tcancelled_by: user.id,\n\t\t\t\t\tcancellation_reason: reason || null,\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", jobId);\n\n\t\t\tif (jobError) {\n\t\t\t\tthrow jobError;\n\t\t\t}\n\t\t}\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to cancel job and appointment\",\n\t\t};\n\t}\n}\n\nexport async function archiveAppointment(scheduleId: string) {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Database not available\" };\n\t}\n\n\ttry {\n\t\tconst { error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update({\n\t\t\t\tarchived_at: new Date().toISOString(),\n\t\t\t})\n\t\t\t.eq(\"id\", scheduleId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to archive appointment\",\n\t\t};\n\t}\n}\n\nexport async function completeAppointment(scheduleId: string) {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Database not available\" };\n\t}\n\n\ttry {\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\n\t\tif (!user) {\n\t\t\treturn { success: false, error: \"Not authenticated\" };\n\t\t}\n\n\t\tconst now = new Date().toISOString();\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update({\n\t\t\t\tstatus: \"completed\",\n\t\t\t\tactual_end_time: now,\n\t\t\t\tcompleted_by: user.id,\n\t\t\t})\n\t\t\t.eq(\"id\", scheduleId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to complete appointment\",\n\t\t};\n\t}\n}\n\ntype DispatchStatus = \"dispatched\" | \"arrived\" | \"closed\";\n\nasync function updateScheduleStatus(\n\tscheduleId: string,\n\tstatus: DispatchStatus,\n\textraUpdates: Record<string, unknown> = {},\n) {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Database not available\" };\n\t}\n\n\ttry {\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\n\t\tif (!user) {\n\t\t\treturn { success: false, error: \"Not authenticated\" };\n\t\t}\n\n\t\tconst now = new Date().toISOString();\n\t\tconst updates: Record<string, unknown> = {\n\t\t\tstatus,\n\t\t\tupdated_at: now,\n\t\t\t...extraUpdates,\n\t\t};\n\n\t\tif (status === \"closed\") {\n\t\t\tupdates.completed_by = user.id;\n\t\t\tupdates.actual_end_time = updates.actual_end_time ?? now;\n\t\t}\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update(updates)\n\t\t\t.eq(\"id\", scheduleId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: `Failed to update appointment status to ${status}`,\n\t\t};\n\t}\n}\n\nexport async function dispatchAppointment(scheduleId: string) {\n\treturn updateScheduleStatus(scheduleId, \"dispatched\");\n}\n\nexport async function arriveAppointment(scheduleId: string) {\n\tconst now = new Date().toISOString();\n\treturn updateScheduleStatus(scheduleId, \"arrived\", {\n\t\tactual_start_time: now,\n\t});\n}\n\nexport async function closeAppointment(scheduleId: string) {\n\tconst now = new Date().toISOString();\n\treturn updateScheduleStatus(scheduleId, \"closed\", {\n\t\tactual_end_time: now,\n\t});\n}\n\nexport async function unassignAppointment(scheduleId: string) {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Database not available\" };\n\t}\n\n\ttry {\n\t\tconst { error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update({\n\t\t\t\tassigned_to: null,\n\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t})\n\t\t\t.eq(\"id\", scheduleId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to move appointment to Unscheduled\",\n\t\t};\n\t}\n}\n\n/**\n * Send \"On My Way\" SMS notification to customer\n * Includes technician name and estimated arrival time\n */\nexport async function sendOnMyWayNotification(\n\tscheduleId: string,\n\ttechnicianName: string,\n\tcustomerPhone: string,\n\tdestinationAddress?: string,\n) {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Database not available\" };\n\t}\n\n\ttry {\n\t\t// Get user and company info\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\n\t\tif (!user) {\n\t\t\treturn { success: false, error: \"Not authenticated\" };\n\t\t}\n\n\t\t// Get company's Telnyx settings for the from number\n\t\tconst { data: membership } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.single();\n\n\t\tif (!membership?.company_id) {\n\t\t\treturn { success: false, error: \"No active company membership\" };\n\t\t}\n\n\t\tconst { data: telnyxSettings } = await supabase\n\t\t\t.from(\"company_telnyx_settings\")\n\t\t\t.select(\"phone_number, status\")\n\t\t\t.eq(\"company_id\", membership.company_id)\n\t\t\t.eq(\"status\", \"ready\")\n\t\t\t.single();\n\n\t\tif (!telnyxSettings?.phone_number) {\n\t\t\treturn { success: false, error: \"No phone number configured for SMS\" };\n\t\t}\n\n\t\t// Get company name for the message\n\t\tconst { data: company } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"name\")\n\t\t\t.eq(\"id\", membership.company_id)\n\t\t\t.single();\n\n\t\t// Build the \"On My Way\" message\n\t\tlet message = `Hi! ${technicianName} from ${company?.name || \"your service provider\"} is on the way to your appointment.`;\n\n\t\t// Try to get travel time estimate if we have a destination\n\t\tif (destinationAddress) {\n\t\t\ttry {\n\t\t\t\tconst baseUrl = process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\";\n\t\t\t\tconst travelResponse = await fetch(\n\t\t\t\t\t`${baseUrl}/api/travel-time?destination=${encodeURIComponent(destinationAddress)}`,\n\t\t\t\t\t{\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\tCookie: `sb-access-token=${user.id}`, // Pass auth context\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t);\n\n\t\t\t\tif (travelResponse.ok) {\n\t\t\t\t\tconst travelData = await travelResponse.json();\n\t\t\t\t\tif (travelData.durationText) {\n\t\t\t\t\t\tmessage += ` Estimated arrival: ${travelData.durationText}.`;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Travel time fetch failed - continue without it\n\t\t\t}\n\t\t}\n\n\t\tmessage += \" We'll see you soon!\";\n\n\t\t// Send the SMS via Telnyx\n\t\tconst { sendSMS } = await import(\"@/lib/telnyx/messaging\");\n\t\tconst result = await sendSMS({\n\t\t\tto: customerPhone,\n\t\t\tfrom: telnyxSettings.phone_number,\n\t\t\ttext: message,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn { success: false, error: \"Failed to send SMS\" };\n\t\t}\n\n\t\t// Update appointment status to dispatched\n\t\tawait supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update({\n\t\t\t\tstatus: \"dispatched\",\n\t\t\t\tdispatched_at: new Date().toISOString(),\n\t\t\t})\n\t\t\t.eq(\"id\", scheduleId);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: \"On My Way notification sent successfully\",\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to send On My Way notification\",\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 8506, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/appointments.ts"],"sourcesContent":["/**\n * Appointments Server Actions\n *\n * Handles appointment scheduling and management with comprehensive CRUD operations,\n * status transitions, reminders, and team assignment logic.\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport { ActionError, ERROR_CODES } from \"@/lib/errors/action-error\";\nimport {\n\ttype ActionResult,\n\tassertAuthenticated,\n\tassertExists,\n\twithErrorHandling,\n} from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\n\ntype SupabaseServerClient = Exclude<\n\tAwaited<ReturnType<typeof createClient>>,\n\tnull\n>;\n\nconst APPOINTMENT_NUMBER_REGEX = /APT-(\\d+)/;\nconst APPOINTMENT_NUMBER_LENGTH = 6;\nconst MILLISECONDS_PER_MINUTE = 60_000;\nconst DEFAULT_SEARCH_LIMIT = 50;\nconst DEFAULT_SEARCH_OFFSET = 0;\n\nconst getSupabaseServerClient = async (): Promise<SupabaseServerClient> => {\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\tthrow new ActionError(\n\t\t\t\"Database connection failed\",\n\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t);\n\t}\n\treturn supabase as SupabaseServerClient;\n};\n\n// Validation Schemas\nconst createAppointmentSchema = z.object({\n\tcustomerId: z.string().uuid(\"Invalid customer ID\"),\n\tpropertyId: z.string().uuid(\"Invalid property ID\").optional(),\n\tjobId: z.string().uuid(\"Invalid job ID\").optional(),\n\tassignedTo: z.string().uuid(\"Invalid user ID\").optional(),\n\ttitle: z.string().min(1, \"Appointment title is required\"),\n\tdescription: z.string().optional(),\n\tcategory: z\n\t\t.enum([\n\t\t\t\"job_appointment\",\n\t\t\t\"estimate_appointment\",\n\t\t\t\"event\",\n\t\t\t\"meeting\",\n\t\t\t\"follow_up\",\n\t\t\t\"recurring_service\",\n\t\t])\n\t\t.default(\"job_appointment\"),\n\ttype: z\n\t\t.enum([\n\t\t\t\"service_call\",\n\t\t\t\"installation\",\n\t\t\t\"maintenance\",\n\t\t\t\"inspection\",\n\t\t\t\"repair\",\n\t\t\t\"estimate\",\n\t\t\t\"follow_up\",\n\t\t\t\"winterization\",\n\t\t\t\"emergency\",\n\t\t])\n\t\t.optional(),\n\tpriority: z.enum([\"low\", \"normal\", \"high\", \"urgent\"]).default(\"normal\"),\n\tscheduledStart: z.string().min(1, \"Start time is required\"),\n\tscheduledEnd: z.string().min(1, \"End time is required\"),\n\tnotes: z.string().optional(),\n\ttravelTimeMinutes: z.number().int().min(0).optional(),\n});\n\nconst updateAppointmentSchema = z.object({\n\ttitle: z.string().min(1, \"Appointment title is required\").optional(),\n\tdescription: z.string().optional(),\n\tstatus: z\n\t\t.enum([\n\t\t\t\"scheduled\",\n\t\t\t\"confirmed\",\n\t\t\t\"in_progress\",\n\t\t\t\"completed\",\n\t\t\t\"cancelled\",\n\t\t\t\"no_show\",\n\t\t\t\"rescheduled\",\n\t\t])\n\t\t.optional(),\n\ttype: z\n\t\t.enum([\n\t\t\t\"service\",\n\t\t\t\"consultation\",\n\t\t\t\"estimate\",\n\t\t\t\"follow_up\",\n\t\t\t\"maintenance\",\n\t\t\t\"emergency\",\n\t\t\t\"inspection\",\n\t\t])\n\t\t.optional(),\n\tpriority: z.enum([\"low\", \"normal\", \"high\", \"urgent\"]).optional(),\n\tscheduledStart: z.string().optional(),\n\tscheduledEnd: z.string().optional(),\n\tactualStart: z.string().optional(),\n\tactualEnd: z.string().optional(),\n\tassignedTo: z.string().uuid(\"Invalid user ID\").optional().nullable(),\n\tnotes: z.string().optional(),\n\tcancellationReason: z.string().optional(),\n});\n\nconst rescheduleAppointmentSchema = z.object({\n\tscheduledStart: z.string().min(1, \"Start time is required\"),\n\tscheduledEnd: z.string().min(1, \"End time is required\"),\n\treason: z.string().optional(),\n});\n\n/**\n * Generate unique appointment number using database function\n */\nasync function generateAppointmentNumber(\n\tsupabase: SupabaseServerClient,\n\tcompanyId: string,\n): Promise<string> {\n\tconst { data, error } = await supabase.rpc(\"generate_appointment_number\", {\n\t\tp_company_id: companyId,\n\t});\n\n\tif (error || !data) {\n\t\t// Fallback to manual generation\n\t\tconst { data: latestAppointment } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.select(\"appointment_number\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(1)\n\t\t\t.single();\n\n\t\tif (!latestAppointment) {\n\t\t\treturn \"APT-000001\";\n\t\t}\n\n\t\tconst match = latestAppointment.appointment_number.match(\n\t\t\tAPPOINTMENT_NUMBER_REGEX,\n\t\t);\n\t\tif (match) {\n\t\t\tconst nextNumber = Number.parseInt(match[1], 10) + 1;\n\t\t\treturn `APT-${nextNumber.toString().padStart(APPOINTMENT_NUMBER_LENGTH, \"0\")}`;\n\t\t}\n\n\t\treturn `APT-${Date.now().toString().slice(-APPOINTMENT_NUMBER_LENGTH)}`;\n\t}\n\n\treturn data;\n}\n\n/**\n * Calculate duration in minutes between two dates\n */\nfunction calculateDuration(start: string, end: string): number {\n\tconst startDate = new Date(start);\n\tconst endDate = new Date(end);\n\treturn Math.round(\n\t\t(endDate.getTime() - startDate.getTime()) / MILLISECONDS_PER_MINUTE,\n\t);\n}\n\n/**\n * Validate appointment times\n */\nfunction validateAppointmentTimes(start: string, end: string): void {\n\tconst startDate = new Date(start);\n\tconst endDate = new Date(end);\n\n\tif (endDate <= startDate) {\n\t\tthrow new ActionError(\n\t\t\t\"End time must be after start time\",\n\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t);\n\t}\n\n\tif (startDate < new Date()) {\n\t\tthrow new ActionError(\n\t\t\t\"Cannot schedule appointments in the past\",\n\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t);\n\t}\n}\n\nconst extractFormValues = (\n\tformData: FormData,\n\tfields: string[],\n): Record<string, unknown> => {\n\tconst result: Record<string, unknown> = {};\n\tfor (const field of fields) {\n\t\tconst value = formData.get(field);\n\t\tif (value !== null && value !== undefined && value !== \"\") {\n\t\t\tresult[field] = value;\n\t\t}\n\t}\n\treturn result;\n};\n\nconst buildUpdatePayload = (\n\tdata: z.infer<typeof updateAppointmentSchema>,\n\tduration?: number,\n): Record<string, unknown> => {\n\tconst updateData: Record<string, unknown> = { ...data };\n\tif (duration) {\n\t\tupdateData.duration_minutes = duration;\n\t}\n\n\tif (data.actualStart && data.actualEnd) {\n\t\tupdateData.actual_duration_minutes = calculateDuration(\n\t\t\tdata.actualStart,\n\t\t\tdata.actualEnd,\n\t\t);\n\t}\n\n\treturn updateData;\n};\n\nconst toSnakeCaseRecord = (data: Record<string, unknown>) => {\n\tconst result: Record<string, unknown> = {};\n\tfor (const [key, value] of Object.entries(data)) {\n\t\tconst snakeKey = key.replace(/([A-Z])/g, \"_$1\").toLowerCase();\n\t\tresult[snakeKey] = value;\n\t}\n\treturn result;\n};\n\n/**\n * Create a new appointment\n */\nexport async function createAppointment(\n\tformData: FormData,\n): Promise<ActionResult<string>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst supabase = await getSupabaseServerClient();\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Parse and validate form data\n\t\tconst rawData = {\n\t\t\tcustomerId: formData.get(\"customerId\") as string,\n\t\t\tpropertyId: (formData.get(\"propertyId\") as string) || undefined,\n\t\t\tjobId: (formData.get(\"jobId\") as string) || undefined,\n\t\t\tassignedTo: (formData.get(\"assignedTo\") as string) || undefined,\n\t\t\ttitle: formData.get(\"title\") as string,\n\t\t\tdescription: (formData.get(\"description\") as string) || undefined,\n\t\t\tcategory: (formData.get(\"category\") as string) || \"job_appointment\",\n\t\t\ttype: (formData.get(\"type\") as string) || undefined,\n\t\t\tpriority: (formData.get(\"priority\") as string) || \"normal\",\n\t\t\tscheduledStart: formData.get(\"scheduledStart\") as string,\n\t\t\tscheduledEnd: formData.get(\"scheduledEnd\") as string,\n\t\t\tnotes: (formData.get(\"notes\") as string) || undefined,\n\t\t\ttravelTimeMinutes: formData.get(\"travelTimeMinutes\")\n\t\t\t\t? Number.parseInt(formData.get(\"travelTimeMinutes\") as string, 10)\n\t\t\t\t: undefined,\n\t\t};\n\n\t\tconst validatedData = createAppointmentSchema.parse(rawData);\n\n\t\t// Validate appointment times\n\t\tvalidateAppointmentTimes(\n\t\t\tvalidatedData.scheduledStart,\n\t\t\tvalidatedData.scheduledEnd,\n\t\t);\n\n\t\t// Calculate duration\n\t\tconst duration = calculateDuration(\n\t\t\tvalidatedData.scheduledStart,\n\t\t\tvalidatedData.scheduledEnd,\n\t\t);\n\n\t\t// Generate appointment number\n\t\tconst appointmentNumber = await generateAppointmentNumber(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t);\n\n\t\t// Create appointment\n\t\tconst { data: appointment, error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: validatedData.customerId,\n\t\t\t\tproperty_id: validatedData.propertyId,\n\t\t\t\tjob_id: validatedData.jobId,\n\t\t\t\tassigned_to: validatedData.assignedTo,\n\t\t\t\tappointment_number: appointmentNumber,\n\t\t\t\ttitle: validatedData.title,\n\t\t\t\tdescription: validatedData.description,\n\t\t\t\tcategory: validatedData.category,\n\t\t\t\ttype: validatedData.type,\n\t\t\t\tpriority: validatedData.priority,\n\t\t\t\tscheduled_start: validatedData.scheduledStart,\n\t\t\t\tscheduled_end: validatedData.scheduledEnd,\n\t\t\t\tduration_minutes: duration,\n\t\t\t\tnotes: validatedData.notes,\n\t\t\t\ttravel_time_minutes: validatedData.travelTimeMinutes,\n\t\t\t\tstatus: \"scheduled\",\n\t\t\t\tcreated_by: user.id,\n\t\t\t})\n\t\t\t.select(\"id\")\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to create appointment: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate relevant paths\n\t\trevalidatePath(\"/dashboard/work/appointments\");\n\t\trevalidatePath(\"/dashboard/schedule\");\n\t\tif (validatedData.jobId) {\n\t\t\trevalidatePath(`/dashboard/work/${validatedData.jobId}`);\n\t\t}\n\n\t\treturn appointment.id;\n\t});\n}\n\n/**\n * Update an existing appointment\n */\nasync function updateAppointment(\n\tappointmentId: string,\n\tformData: FormData,\n): Promise<ActionResult<boolean>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst supabase = await getSupabaseServerClient();\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Verify appointment exists and belongs to company\n\t\tconst { data: existingAppointment, error: fetchError } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.select(\"id, company_id, status, scheduled_start, scheduled_end, job_id\")\n\t\t\t.eq(\"id\", appointmentId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (fetchError || !existingAppointment) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Appointment not found\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t);\n\t\t}\n\n\t\t// Parse and validate form data\n\t\tconst rawData = extractFormValues(formData, [\n\t\t\t\"title\",\n\t\t\t\"description\",\n\t\t\t\"status\",\n\t\t\t\"type\",\n\t\t\t\"priority\",\n\t\t\t\"scheduledStart\",\n\t\t\t\"scheduledEnd\",\n\t\t\t\"actualStart\",\n\t\t\t\"actualEnd\",\n\t\t\t\"assignedTo\",\n\t\t\t\"notes\",\n\t\t\t\"cancellationReason\",\n\t\t]);\n\n\t\tconst validatedData = updateAppointmentSchema.parse(rawData);\n\n\t\t// Validate times if both are provided\n\t\tif (validatedData.scheduledStart && validatedData.scheduledEnd) {\n\t\t\tvalidateAppointmentTimes(\n\t\t\t\tvalidatedData.scheduledStart,\n\t\t\t\tvalidatedData.scheduledEnd,\n\t\t\t);\n\t\t}\n\n\t\t// Calculate new duration if times changed\n\t\tlet duration: number | undefined;\n\t\tif (validatedData.scheduledStart && validatedData.scheduledEnd) {\n\t\t\tduration = calculateDuration(\n\t\t\t\tvalidatedData.scheduledStart,\n\t\t\t\tvalidatedData.scheduledEnd,\n\t\t\t);\n\t\t}\n\n\t\t// Build update object\n\t\tconst updateData = buildUpdatePayload(validatedData, duration);\n\t\tconst dbUpdateData = toSnakeCaseRecord(updateData);\n\n\t\t// Update appointment\n\t\tconst { error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update(dbUpdateData)\n\t\t\t.eq(\"id\", appointmentId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to update appointment: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate relevant paths\n\t\trevalidatePath(\"/dashboard/work/appointments\");\n\t\trevalidatePath(`/dashboard/work/appointments/${appointmentId}`);\n\t\trevalidatePath(\"/dashboard/schedule\");\n\t\tif (existingAppointment.job_id) {\n\t\t\trevalidatePath(`/dashboard/work/${existingAppointment.job_id}`);\n\t\t}\n\n\t\treturn true;\n\t});\n}\n\n/**\n * Reschedule an appointment\n */\nasync function rescheduleAppointment(\n\tappointmentId: string,\n\tformData: FormData,\n): Promise<ActionResult<boolean>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst supabase = await getSupabaseServerClient();\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Parse and validate form data\n\t\tconst rawData = {\n\t\t\tscheduledStart: formData.get(\"scheduledStart\") as string,\n\t\t\tscheduledEnd: formData.get(\"scheduledEnd\") as string,\n\t\t\treason: (formData.get(\"reason\") as string) || undefined,\n\t\t};\n\n\t\tconst validatedData = rescheduleAppointmentSchema.parse(rawData);\n\n\t\t// Validate appointment times\n\t\tvalidateAppointmentTimes(\n\t\t\tvalidatedData.scheduledStart,\n\t\t\tvalidatedData.scheduledEnd,\n\t\t);\n\n\t\t// Calculate new duration\n\t\tconst duration = calculateDuration(\n\t\t\tvalidatedData.scheduledStart,\n\t\t\tvalidatedData.scheduledEnd,\n\t\t);\n\n\t\t// Update appointment with rescheduled status\n\t\tconst { error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update({\n\t\t\t\tscheduled_start: validatedData.scheduledStart,\n\t\t\t\tscheduled_end: validatedData.scheduledEnd,\n\t\t\t\tduration_minutes: duration,\n\t\t\t\tstatus: \"rescheduled\",\n\t\t\t\tnotes: validatedData.reason\n\t\t\t\t\t? `Rescheduled: ${validatedData.reason}`\n\t\t\t\t\t: undefined,\n\t\t\t})\n\t\t\t.eq(\"id\", appointmentId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to reschedule appointment: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate relevant paths\n\t\trevalidatePath(\"/dashboard/work/appointments\");\n\t\trevalidatePath(`/dashboard/work/appointments/${appointmentId}`);\n\t\trevalidatePath(\"/dashboard/schedule\");\n\n\t\treturn true;\n\t});\n}\n\n/**\n * Cancel an appointment\n */\nasync function cancelAppointment(\n\tappointmentId: string,\n\treason?: string,\n): Promise<ActionResult<boolean>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst supabase = await getSupabaseServerClient();\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Update appointment status to cancelled\n\t\tconst { error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update({\n\t\t\t\tstatus: \"cancelled\",\n\t\t\t\tcancellation_reason: reason,\n\t\t\t})\n\t\t\t.eq(\"id\", appointmentId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to cancel appointment: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate relevant paths\n\t\trevalidatePath(\"/dashboard/work/appointments\");\n\t\trevalidatePath(`/dashboard/work/appointments/${appointmentId}`);\n\t\trevalidatePath(\"/dashboard/schedule\");\n\n\t\treturn true;\n\t});\n}\n\n/**\n * Complete an appointment\n */\nasync function completeAppointment(\n\tappointmentId: string,\n\tactualEnd?: string,\n): Promise<ActionResult<boolean>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst supabase = await getSupabaseServerClient();\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Update appointment status to completed\n\t\tconst { error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update({\n\t\t\t\tstatus: \"completed\",\n\t\t\t\tactual_end: actualEnd || new Date().toISOString(),\n\t\t\t})\n\t\t\t.eq(\"id\", appointmentId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to complete appointment: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate relevant paths\n\t\trevalidatePath(\"/dashboard/work/appointments\");\n\t\trevalidatePath(`/dashboard/work/appointments/${appointmentId}`);\n\t\trevalidatePath(\"/dashboard/schedule\");\n\n\t\treturn true;\n\t});\n}\n\n/**\n * Archive an appointment (soft delete)\n */\nexport async function archiveAppointment(\n\tappointmentId: string,\n): Promise<ActionResult<boolean>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst supabase = await getSupabaseServerClient();\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Archive appointment (soft delete)\n\t\tconst now = new Date().toISOString();\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update({\n\t\t\t\tarchived_at: now,\n\t\t\t\tdeleted_at: now,\n\t\t\t\tdeleted_by: user.id,\n\t\t\t\tstatus: \"cancelled\", // Mark as cancelled when archived\n\t\t\t})\n\t\t\t.eq(\"id\", appointmentId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to archive appointment: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn true;\n\t});\n}\n\n/**\n * Delete an appointment (hard delete)\n */\nasync function deleteAppointment(\n\tappointmentId: string,\n): Promise<ActionResult<boolean>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst supabase = await getSupabaseServerClient();\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Delete appointment\n\t\tconst { error } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.delete()\n\t\t\t.eq(\"id\", appointmentId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to delete appointment: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate relevant paths\n\t\trevalidatePath(\"/dashboard/work/appointments\");\n\t\trevalidatePath(\"/dashboard/schedule\");\n\n\t\treturn true;\n\t});\n}\n\n/**\n * Search appointments\n */\nasync function searchAppointments(\n\tsearchQuery: string,\n\toptions?: {\n\t\tlimit?: number;\n\t\toffset?: number;\n\t},\n): Promise<ActionResult<Record<string, unknown>[]>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst supabase = await getSupabaseServerClient();\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Use the RPC function for ranked search\n\t\tconst { data, error } = await supabase.rpc(\"search_appointments_ranked\", {\n\t\t\tp_company_id: companyId,\n\t\t\tp_search_query: searchQuery,\n\t\t\tp_limit: options?.limit ?? DEFAULT_SEARCH_LIMIT,\n\t\t\tp_offset: options?.offset ?? DEFAULT_SEARCH_OFFSET,\n\t\t});\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Search failed: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn (data as Record<string, unknown>[]) || [];\n\t});\n}\n\n/**\n * Unlink appointment from job\n * Removes the job association (sets job_id to NULL)\n * Bidirectional operation - updates both appointment and job views\n */\nasync function unlinkScheduleFromJob(\n\tappointmentId: string,\n): Promise<ActionResult<void>> {\n\treturn await withErrorHandling(async () => {\n\t\tconst supabase = await getSupabaseServerClient();\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Get current appointment to verify exists and get job_id for revalidation\n\t\tconst { data: appointment, error: fetchError } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.select(\"id, job_id\")\n\t\t\t.eq(\"id\", appointmentId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (fetchError || !appointment) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Appointment not found\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t);\n\t\t}\n\n\t\tconst previousJobId = appointment.job_id;\n\n\t\t// Unlink appointment from job (set job_id to NULL)\n\t\tconst { error: unlinkError } = await supabase\n\t\t\t.from(\"appointments\")\n\t\t\t.update({ job_id: null })\n\t\t\t.eq(\"id\", appointmentId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (unlinkError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to unlink appointment from job\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate both pages\n\t\trevalidatePath(`/dashboard/work/appointments/${appointmentId}`);\n\t\tif (previousJobId) {\n\t\t\trevalidatePath(`/dashboard/work/${previousJobId}`);\n\t\t}\n\t\trevalidatePath(\"/dashboard/work/appointments\");\n\t\trevalidatePath(\"/dashboard/schedule\");\n\t});\n}\n"],"names":[],"mappings":"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"}}]
}