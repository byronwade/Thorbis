{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/payments/payrix-api.ts"],"sourcesContent":["/**\n * Payrix API Client\n *\n * Integration with Payrix payment processing for merchant boarding,\n * payment processing, and account management.\n *\n * Documentation: https://resource.payrix.com/\n * API Base: https://api.payrix.com\n */\n\nconst PAYRIX_API_BASE = process.env.PAYRIX_API_URL || \"https://api.payrix.com\";\nconst PAYRIX_API_KEY = process.env.PAYRIX_API_KEY;\nconst PAYRIX_PARTNER_ID = process.env.PAYRIX_PARTNER_ID;\n\ntype PayrixEntity = {\n\ttype: 1 | 2 | 3; // 1 = Individual, 2 = Corporation, 3 = LLC\n\tname: string;\n\tdba?: string;\n\temail: string;\n\tphone: string;\n\taddress1: string;\n\taddress2?: string;\n\tcity: string;\n\tstate: string;\n\tzip: string;\n\tcountry: string;\n\twebsite?: string;\n\tein?: string;\n};\n\ntype PayrixMerchant = {\n\tstatus: 1 | 2 | 3; // 1 = Active, 2 = Inactive, 3 = Suspended\n\tmcc: string; // Merchant Category Code\n\testablished: string; // YYYY-MM-DD\n\tannualVolume: number;\n\taverageTicket: number;\n\thighTicket: number;\n\trefundPolicy?: string;\n};\n\ntype PayrixMember = {\n\tfirstName: string;\n\tlastName: string;\n\ttitle: string;\n\temail: string;\n\tphone: string;\n\tdob: string; // YYYY-MM-DD\n\tssn: string; // Last 4 digits or full (encrypted)\n\townership: number; // Percentage\n\taddress1: string;\n\taddress2?: string;\n\tcity: string;\n\tstate: string;\n\tzip: string;\n\tcountry: string;\n};\n\ntype PayrixAccount = {\n\ttype: 1 | 2; // 1 = Checking, 2 = Savings\n\tnumber: string; // Account number\n\trouting: string; // Routing number\n};\n\ntype PayrixBoardingRequest = {\n\tentity: PayrixEntity;\n\tmerchant: PayrixMerchant;\n\tmembers: PayrixMember[];\n\taccounts: PayrixAccount[];\n};\n\ntype PayrixBoardingResponse = {\n\tsuccess: boolean;\n\tdata?: {\n\t\tentityId: string;\n\t\tmerchantId: string;\n\t\tmemberId: string;\n\t\tstatus: string;\n\t\tboardingStatus: string;\n\t};\n\terror?: string;\n\tdetails?: any;\n};\n\n/**\n * Create headers for Payrix API requests\n */\nfunction getPayrixHeaders(): HeadersInit {\n\tif (!PAYRIX_API_KEY) {\n\t\tthrow new Error(\"Payrix API key not configured\");\n\t}\n\n\treturn {\n\t\t\"Content-Type\": \"application/json\",\n\t\tAuthorization: `Bearer ${PAYRIX_API_KEY}`,\n\t\tAPIKEY: PAYRIX_API_KEY,\n\t};\n}\n\n/**\n * Submit merchant boarding application to Payrix\n *\n * @param request - Merchant boarding data\n * @returns Payrix boarding response\n */\nexport async function submitMerchantBoarding(\n\trequest: PayrixBoardingRequest,\n): Promise<PayrixBoardingResponse> {\n\ttry {\n\t\tconst response = await fetch(`${PAYRIX_API_BASE}/entities`, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: getPayrixHeaders(),\n\t\t\tbody: JSON.stringify({\n\t\t\t\ttype: request.entity.type,\n\t\t\t\tname: request.entity.name,\n\t\t\t\tdba: request.entity.dba,\n\t\t\t\temail: request.entity.email,\n\t\t\t\tphone: request.entity.phone,\n\t\t\t\taddress: {\n\t\t\t\t\tline1: request.entity.address1,\n\t\t\t\t\tline2: request.entity.address2,\n\t\t\t\t\tcity: request.entity.city,\n\t\t\t\t\tstate: request.entity.state,\n\t\t\t\t\tzip: request.entity.zip,\n\t\t\t\t\tcountry: request.entity.country,\n\t\t\t\t},\n\t\t\t\twebsite: request.entity.website,\n\t\t\t\tein: request.entity.ein,\n\t\t\t\tmerchant: {\n\t\t\t\t\tstatus: request.merchant.status,\n\t\t\t\t\tmcc: request.merchant.mcc,\n\t\t\t\t\testablished: request.merchant.established,\n\t\t\t\t\tannualVolume: request.merchant.annualVolume,\n\t\t\t\t\taverageTicket: request.merchant.averageTicket,\n\t\t\t\t\thighTicket: request.merchant.highTicket,\n\t\t\t\t\trefundPolicy: request.merchant.refundPolicy,\n\t\t\t\t},\n\t\t\t\tmembers: request.members.map((member) => ({\n\t\t\t\t\tfirst: member.firstName,\n\t\t\t\t\tlast: member.lastName,\n\t\t\t\t\ttitle: member.title,\n\t\t\t\t\temail: member.email,\n\t\t\t\t\tphone: member.phone,\n\t\t\t\t\tdob: member.dob,\n\t\t\t\t\tssn: member.ssn,\n\t\t\t\t\townership: member.ownership,\n\t\t\t\t\taddress: {\n\t\t\t\t\t\tline1: member.address1,\n\t\t\t\t\t\tline2: member.address2,\n\t\t\t\t\t\tcity: member.city,\n\t\t\t\t\t\tstate: member.state,\n\t\t\t\t\t\tzip: member.zip,\n\t\t\t\t\t\tcountry: member.country,\n\t\t\t\t\t},\n\t\t\t\t})),\n\t\t\t\taccounts: request.accounts.map((account) => ({\n\t\t\t\t\ttype: account.type,\n\t\t\t\t\tnumber: account.number,\n\t\t\t\t\trouting: account.routing,\n\t\t\t\t})),\n\t\t\t}),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tconst errorData = await response.json().catch(() => ({}));\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorData.message || \"Failed to submit merchant boarding\",\n\t\t\t\tdetails: errorData,\n\t\t\t};\n\t\t}\n\n\t\tconst data = await response.json();\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tentityId: data.response?.data?.[0]?.id,\n\t\t\t\tmerchantId: data.response?.data?.[0]?.merchant?.[0]?.id,\n\t\t\t\tmemberId: data.response?.data?.[0]?.members?.[0]?.id,\n\t\t\t\tstatus: data.response?.data?.[0]?.merchant?.[0]?.status,\n\t\t\t\tboardingStatus: data.response?.data?.[0]?.merchant?.[0]?.boardingStatus,\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"Payrix boarding error:\", error);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error occurred\",\n\t\t};\n\t}\n}\n\n/**\n * Check merchant boarding status\n *\n * @param merchantId - Payrix merchant ID\n * @returns Merchant status information\n */\nexport async function getMerchantStatus(merchantId: string) {\n\ttry {\n\t\tconst response = await fetch(`${PAYRIX_API_BASE}/merchants/${merchantId}`, {\n\t\t\tmethod: \"GET\",\n\t\t\theaders: getPayrixHeaders(),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tthrow new Error(\"Failed to fetch merchant status\");\n\t\t}\n\n\t\tconst data = await response.json();\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tstatus: data.response?.data?.[0]?.status,\n\t\t\t\tboardingStatus: data.response?.data?.[0]?.boardingStatus,\n\t\t\t\tboardingSubstatus: data.response?.data?.[0]?.boardingSubstatus,\n\t\t\t\tactive: data.response?.data?.[0]?.status === 1,\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"Payrix status check error:\", error);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error occurred\",\n\t\t};\n\t}\n}\n\n/**\n * Get merchant category codes (MCC)\n * Common codes for field service businesses\n */\nexport const MERCHANT_CATEGORY_CODES = {\n\tHVAC: \"1711\", // Heating, Plumbing, A/C\n\tPLUMBING: \"1711\",\n\tELECTRICAL: \"1731\",\n\tPEST_CONTROL: \"7342\",\n\tLOCKSMITH: \"7699\",\n\tAPPLIANCE_REPAIR: \"7623\",\n\tGARAGE_DOOR: \"1799\",\n\tLANDSCAPING: \"0780\",\n\tPOOL_SERVICE: \"7699\",\n\tCLEANING: \"7349\",\n\tROOFING: \"1761\",\n\tCARPENTRY: \"1751\",\n\tPAINTING: \"1721\",\n\tGENERAL_CONTRACTOR: \"1520\",\n} as const;\n\n/**\n * Get MCC code for industry\n */\nexport function getMCCForIndustry(industry: string): string {\n\tconst industryUpper = industry.toUpperCase().replace(/[^A-Z]/g, \"_\");\n\treturn (\n\t\tMERCHANT_CATEGORY_CODES[\n\t\t\tindustryUpper as keyof typeof MERCHANT_CATEGORY_CODES\n\t\t] || MERCHANT_CATEGORY_CODES.GENERAL_CONTRACTOR\n\t);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 170, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/database/src/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\";\nimport { cache } from \"react\";\n\n/**\n * Create a Supabase client for use in Server Components\n * This is useful for Supabase Auth, Storage, Realtime, etc.\n *\n * PERFORMANCE: Wrapped with React.cache() to prevent recreating\n * the client on every component render. This dramatically improves\n * performance by reusing the same client instance across the request.\n *\n * SESSION ISOLATION: This client uses default Supabase cookie names.\n * The admin app uses prefixed cookies (admin_*) to isolate its sessions.\n * This ensures admin and contractor sessions don't conflict.\n */\nexport const createClient = cache(async () => {\n\tconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n\tconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n\tif (!(supabaseUrl && supabaseAnonKey)) {\n\t\treturn null;\n\t}\n\n\t// Dynamic import of next/headers to prevent bundling in client components\n\tconst { cookies, headers } = await import(\"next/headers\");\n\n\tlet cookieStore;\n\n\t// Check if we're in a prerendering context by looking at headers\n\tlet headersStore;\n\ttry {\n\t\theadersStore = await headers();\n\t\t// If we can get headers and there's no x-prerender header, we might be safe\n\t\tif (headersStore.get('x-prerender')) {\n\t\t\treturn null;\n\t\t}\n\t} catch {\n\t\t// If headers() fails, we're likely in prerendering\n\t\treturn null;\n\t}\n\n\ttry {\n\t\tcookieStore = await cookies();\n\t} catch (error) {\n\t\t// During prerendering, cookies() may reject - return null\n\t\t// This allows PPR to work correctly\n\t\tif (error instanceof Error && (\n\t\t\terror.message.includes(\"During prerendering\") ||\n\t\t\terror.message.includes(\"prerendering\") ||\n\t\t\terror.message.includes(\"cookies()\")\n\t\t)) {\n\t\t\treturn null;\n\t\t}\n\t\t// For other errors, rethrow\n\t\tthrow error;\n\t}\n\n\treturn createServerClient(supabaseUrl, supabaseAnonKey, {\n\t\tcookies: {\n\t\t\tget(name: string) {\n\t\t\t\treturn cookieStore.get(name)?.value;\n\t\t\t},\n\t\t\tset(name: string, value: string, options) {\n\t\t\t\ttry {\n\t\t\t\t\tcookieStore.set(name, value, options);\n\t\t\t\t} catch {\n\t\t\t\t\t// The `set` method was called from a Server Component.\n\t\t\t\t\t// This can be ignored if you have middleware refreshing\n\t\t\t\t\t// user sessions.\n\t\t\t\t}\n\t\t\t},\n\t\t\tremove(name: string, _options) {\n\t\t\t\ttry {\n\t\t\t\t\tcookieStore.delete(name);\n\t\t\t\t} catch {\n\t\t\t\t\t// The `delete` method was called from a Server Component.\n\t\t\t\t\t// This can be ignored if you have middleware refreshing\n\t\t\t\t\t// user sessions.\n\t\t\t\t}\n\t\t\t},\n\t\t},\n\t});\n});\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAcO,MAAM,eAAe,IAAA,qXAAK,EAAC;IACjC,MAAM;IACN,MAAM;IAEN;;IAIA,0EAA0E;IAC1E,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,GAAG;IAE7B,IAAI;IAEJ,iEAAiE;IACjE,IAAI;IACJ,IAAI;QACH,eAAe,MAAM;QACrB,4EAA4E;QAC5E,IAAI,aAAa,GAAG,CAAC,gBAAgB;YACpC,OAAO;QACR;IACD,EAAE,OAAM;QACP,mDAAmD;QACnD,OAAO;IACR;IAEA,IAAI;QACH,cAAc,MAAM;IACrB,EAAE,OAAO,OAAO;QACf,0DAA0D;QAC1D,oCAAoC;QACpC,IAAI,iBAAiB,SAAS,CAC7B,MAAM,OAAO,CAAC,QAAQ,CAAC,0BACvB,MAAM,OAAO,CAAC,QAAQ,CAAC,mBACvB,MAAM,OAAO,CAAC,QAAQ,CAAC,YACxB,GAAG;YACF,OAAO;QACR;QACA,4BAA4B;QAC5B,MAAM;IACP;IAEA,OAAO,IAAA,4SAAkB,EAAC,aAAa,iBAAiB;QACvD,SAAS;YACR,KAAI,IAAY;gBACf,OAAO,YAAY,GAAG,CAAC,OAAO;YAC/B;YACA,KAAI,IAAY,EAAE,KAAa,EAAE,OAAO;gBACvC,IAAI;oBACH,YAAY,GAAG,CAAC,MAAM,OAAO;gBAC9B,EAAE,OAAM;gBACP,uDAAuD;gBACvD,wDAAwD;gBACxD,iBAAiB;gBAClB;YACD;YACA,QAAO,IAAY,EAAE,QAAQ;gBAC5B,IAAI;oBACH,YAAY,MAAM,CAAC;gBACpB,EAAE,OAAM;gBACP,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBAClB;YACD;QACD;IACD;AACD"}},
    {"offset": {"line": 240, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/payrix.ts"],"sourcesContent":["/**\n * Payrix Server Actions\n *\n * Server-side actions for Payrix merchant boarding and payment processing\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport {\n\tgetMCCForIndustry,\n\tgetMerchantStatus,\n\tsubmitMerchantBoarding,\n} from \"@/lib/payments/payrix-api\";\nimport { createClient } from \"@/lib/supabase/server\";\n\ntype MerchantBoardingData = {\n\tcompanyId: string;\n\t// Business Information\n\tyearsInBusiness: number;\n\tbusinessDescription: string;\n\taverageTicketAmount: number;\n\thighestTicketAmount: number;\n\testimatedMonthlyVolume: number;\n\t// Owner Information\n\townerFullName: string;\n\townerSSN: string; // Will be encrypted before storage\n\townerDOB: string; // YYYY-MM-DD\n\townerHomeAddress: string;\n\townerCity: string;\n\townerState: string;\n\townerZip: string;\n\townerOwnershipPercentage: number;\n\townerTitle: string;\n\t// Payment Methods\n\tacceptsCreditCards: boolean;\n\tacceptsDebitCards: boolean;\n\tacceptsACH: boolean;\n\tacceptsRecurring: boolean;\n\t// Bank Account (from Plaid)\n\tbankAccountNumber: string;\n\tbankRoutingNumber: string;\n\tbankAccountType: \"checking\" | \"savings\";\n};\n\n/**\n * Submit merchant boarding application to Payrix\n */\nasync function submitPayrixMerchantBoarding(data: MerchantBoardingData) {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\t// Get company information\n\t\tconst { data: company, error: companyError } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"id\", data.companyId)\n\t\t\t.single();\n\n\t\tif (companyError || !company) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Company not found\",\n\t\t\t};\n\t\t}\n\n\t\t// Parse company address\n\t\tconst addressParts = company.address?.split(\",\").map((s) => s.trim()) || [];\n\t\tconst [street, city, state, zip] = addressParts;\n\n\t\t// Determine entity type based on company structure\n\t\tconst entityType =\n\t\t\tcompany.company_size === \"individual\" || company.company_size === \"1-5\"\n\t\t\t\t? 1\n\t\t\t\t: company.legal_name?.includes(\"LLC\")\n\t\t\t\t\t? 3\n\t\t\t\t\t: 2;\n\n\t\t// Get MCC code for industry\n\t\tconst mccCode = getMCCForIndustry(company.industry || \"general\");\n\n\t\t// Calculate annual volume from monthly estimate\n\t\tconst annualVolume = data.estimatedMonthlyVolume * 12;\n\n\t\t// Parse owner name\n\t\tconst [firstName, ...lastNameParts] = data.ownerFullName.split(\" \");\n\t\tconst lastName = lastNameParts.join(\" \");\n\n\t\t// Prepare Payrix boarding request\n\t\tconst boardingRequest = {\n\t\t\tentity: {\n\t\t\t\ttype: entityType as 1 | 2 | 3,\n\t\t\t\tname: company.legal_name || company.name,\n\t\t\t\tdba: company.doing_business_as || company.name,\n\t\t\t\temail: company.email || \"\",\n\t\t\t\tphone: company.phone || \"\",\n\t\t\t\taddress1: street || \"\",\n\t\t\t\tcity: city || \"\",\n\t\t\t\tstate: state || \"\",\n\t\t\t\tzip: zip || \"\",\n\t\t\t\tcountry: \"US\",\n\t\t\t\twebsite: company.website || data.businessDescription,\n\t\t\t\tein: company.ein || undefined,\n\t\t\t},\n\t\t\tmerchant: {\n\t\t\t\tstatus: 1 as const, // Active\n\t\t\t\tmcc: mccCode,\n\t\t\t\testablished: new Date(\n\t\t\t\t\tnew Date().getFullYear() - data.yearsInBusiness,\n\t\t\t\t\t0,\n\t\t\t\t\t1,\n\t\t\t\t)\n\t\t\t\t\t.toISOString()\n\t\t\t\t\t.split(\"T\")[0],\n\t\t\t\tannualVolume,\n\t\t\t\taverageTicket: data.averageTicketAmount,\n\t\t\t\thighTicket: data.highestTicketAmount,\n\t\t\t\trefundPolicy: \"30 days\",\n\t\t\t},\n\t\t\tmembers: [\n\t\t\t\t{\n\t\t\t\t\tfirstName,\n\t\t\t\t\tlastName,\n\t\t\t\t\ttitle: data.ownerTitle,\n\t\t\t\t\temail: company.email || \"\",\n\t\t\t\t\tphone: company.phone || \"\",\n\t\t\t\t\tdob: data.ownerDOB,\n\t\t\t\t\tssn: data.ownerSSN, // Payrix will encrypt this\n\t\t\t\t\townership: data.ownerOwnershipPercentage,\n\t\t\t\t\taddress1: data.ownerHomeAddress,\n\t\t\t\t\tcity: data.ownerCity,\n\t\t\t\t\tstate: data.ownerState,\n\t\t\t\t\tzip: data.ownerZip,\n\t\t\t\t\tcountry: \"US\",\n\t\t\t\t},\n\t\t\t],\n\t\t\taccounts: [\n\t\t\t\t{\n\t\t\t\t\ttype: (data.bankAccountType === \"checking\" ? 1 : 2) as 1 | 2,\n\t\t\t\t\tnumber: data.bankAccountNumber,\n\t\t\t\t\trouting: data.bankRoutingNumber,\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\n\t\t// Submit to Payrix\n\t\tconst payrixResponse = await submitMerchantBoarding(boardingRequest);\n\n\t\tif (!payrixResponse.success) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: payrixResponse.error || \"Failed to submit merchant application\",\n\t\t\t};\n\t\t}\n\n\t\t// Save merchant account to database\n\t\tconst { error: insertError } = await supabase\n\t\t\t.from(\"payrix_merchant_accounts\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: data.companyId,\n\t\t\t\tpayrix_entity_id: payrixResponse.data?.entityId,\n\t\t\t\tpayrix_merchant_id: payrixResponse.data?.merchantId,\n\t\t\t\tpayrix_member_id: payrixResponse.data?.memberId,\n\t\t\t\tstatus: \"submitted\",\n\t\t\t\tboarding_status: payrixResponse.data?.boardingStatus,\n\t\t\t\tyears_in_business: data.yearsInBusiness,\n\t\t\t\tbusiness_description: data.businessDescription,\n\t\t\t\tbusiness_website: company.website,\n\t\t\t\taverage_ticket_amount: data.averageTicketAmount,\n\t\t\t\thighest_ticket_amount: data.highestTicketAmount,\n\t\t\t\testimated_monthly_volume: data.estimatedMonthlyVolume,\n\t\t\t\testimated_annual_volume: annualVolume,\n\t\t\t\taccepts_credit_cards: data.acceptsCreditCards,\n\t\t\t\taccepts_debit_cards: data.acceptsDebitCards,\n\t\t\t\taccepts_ach: data.acceptsACH,\n\t\t\t\taccepts_recurring: data.acceptsRecurring,\n\t\t\t\towner_full_name: data.ownerFullName,\n\t\t\t\towner_ssn_encrypted: \"***-**-****\", // Store masked version\n\t\t\t\towner_dob: new Date(data.ownerDOB),\n\t\t\t\towner_home_address: data.ownerHomeAddress,\n\t\t\t\towner_city: data.ownerCity,\n\t\t\t\towner_state: data.ownerState,\n\t\t\t\towner_zip: data.ownerZip,\n\t\t\t\towner_ownership_percentage: data.ownerOwnershipPercentage,\n\t\t\t\towner_title: data.ownerTitle,\n\t\t\t\tmcc_code: mccCode,\n\t\t\t\tpayrix_response: payrixResponse.data,\n\t\t\t\tsubmitted_at: new Date().toISOString(),\n\t\t\t});\n\n\t\tif (insertError) {\n\t\t\tconsole.error(\"Failed to save merchant account:\", insertError);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Failed to save merchant account to database\",\n\t\t\t};\n\t\t}\n\n\t\trevalidatePath(\"/welcome\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmerchantId: payrixResponse.data?.merchantId,\n\t\t\tstatus: payrixResponse.data?.status,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"Payrix boarding error:\", error);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error occurred\",\n\t\t};\n\t}\n}\n\n/**\n * Check Payrix merchant account status\n */\nasync function checkPayrixMerchantStatus(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\t// Get merchant account from database\n\t\tconst { data: merchantAccount, error } = await supabase\n\t\t\t.from(\"payrix_merchant_accounts\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error || !merchantAccount) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Merchant account not found\",\n\t\t\t};\n\t\t}\n\n\t\t// If we have a Payrix merchant ID, check status\n\t\tif (merchantAccount.payrix_merchant_id) {\n\t\t\tconst statusResponse = await getMerchantStatus(\n\t\t\t\tmerchantAccount.payrix_merchant_id,\n\t\t\t);\n\n\t\t\tif (statusResponse.success && statusResponse.data) {\n\t\t\t\t// Update database with latest status\n\t\t\t\tawait supabase\n\t\t\t\t\t.from(\"payrix_merchant_accounts\")\n\t\t\t\t\t.update({\n\t\t\t\t\t\tstatus: statusResponse.data.active ? \"approved\" : \"under_review\",\n\t\t\t\t\t\tboarding_status: statusResponse.data.boardingStatus,\n\t\t\t\t\t\tboarding_substatus: statusResponse.data.boardingSubstatus,\n\t\t\t\t\t\tlast_sync_at: new Date().toISOString(),\n\t\t\t\t\t\tapproved_at: statusResponse.data.active\n\t\t\t\t\t\t\t? new Date().toISOString()\n\t\t\t\t\t\t\t: null,\n\t\t\t\t\t})\n\t\t\t\t\t.eq(\"id\", merchantAccount.id);\n\n\t\t\t\trevalidatePath(\"/welcome\");\n\t\t\t}\n\n\t\t\treturn statusResponse;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tstatus: merchantAccount.status,\n\t\t\t\tboardingStatus: merchantAccount.boarding_status,\n\t\t\t\tactive: merchantAccount.status === \"approved\",\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"Payrix status check error:\", error);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error occurred\",\n\t\t};\n\t}\n}\n\n/**\n * Get Payrix merchant account for company\n */\nexport async function getPayrixMerchantAccount(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tconst { data: merchantAccount, error } = await supabase\n\t\t\t.from(\"payrix_merchant_accounts\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.maybeSingle();\n\n\t\tif (error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.message,\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: merchantAccount,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"Get merchant account error:\", error);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error occurred\",\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 469, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/logger.ts"],"sourcesContent":["/**\n * Telnyx Structured Logger\n *\n * Provides structured JSON logging with PII redaction,\n * log levels, and correlation ID support.\n */\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport type LogLevel = \"debug\" | \"info\" | \"warn\" | \"error\";\n\nexport interface LogContext {\n\tcorrelationId?: string;\n\tendpoint?: string;\n\tcompanyId?: string;\n\tphoneNumber?: string;\n\tcallControlId?: string;\n\tmessageSid?: string;\n\tattempt?: number;\n\tdelayMs?: number;\n\tlatencyMs?: number;\n\tstatusCode?: number;\n\terror?: string;\n\t[key: string]: unknown;\n}\n\nexport interface LogEntry {\n\ttimestamp: string;\n\tlevel: LogLevel;\n\tservice: string;\n\tmessage: string;\n\tcontext?: LogContext;\n}\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nconst LOG_LEVELS: Record<LogLevel, number> = {\n\tdebug: 0,\n\tinfo: 1,\n\twarn: 2,\n\terror: 3,\n};\n\n// Default to 'info' in production, 'debug' in development\nconst currentLogLevel: LogLevel =\n\t(process.env.TELNYX_LOG_LEVEL as LogLevel) ||\n\t(process.env.NODE_ENV === \"production\" ? \"info\" : \"debug\");\n\n// PII patterns to redact\nconst PII_PATTERNS = [\n\t// Phone numbers (various formats)\n\t/\\+?1?\\d{10,15}/g,\n\t// Email addresses\n\t/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g,\n];\n\n// Fields that should be redacted\nconst SENSITIVE_FIELDS = [\n\t\"phone\",\n\t\"phoneNumber\",\n\t\"phone_number\",\n\t\"from\",\n\t\"to\",\n\t\"fromNumber\",\n\t\"toNumber\",\n\t\"from_number\",\n\t\"to_number\",\n\t\"apiKey\",\n\t\"api_key\",\n\t\"authToken\",\n\t\"auth_token\",\n\t\"password\",\n\t\"secret\",\n\t\"token\",\n];\n\n// =============================================================================\n// PII REDACTION\n// =============================================================================\n\n/**\n * Mask a phone number, keeping last 4 digits\n */\nfunction maskPhoneNumber(phone: string): string {\n\tconst digits = phone.replace(/\\D/g, \"\");\n\tif (digits.length < 4) return \"****\";\n\treturn `***${digits.slice(-4)}`;\n}\n\n/**\n * Mask an email address\n */\nfunction maskEmail(email: string): string {\n\tconst [local, domain] = email.split(\"@\");\n\tif (!domain) return \"***@***\";\n\tconst maskedLocal = local.length > 2 ? `${local[0]}***${local[local.length - 1]}` : \"***\";\n\treturn `${maskedLocal}@${domain}`;\n}\n\n/**\n * Redact PII from a string\n */\nfunction redactString(value: string): string {\n\tlet result = value;\n\n\t// Redact phone numbers\n\tresult = result.replace(/\\+?1?\\d{10,15}/g, (match) => maskPhoneNumber(match));\n\n\t// Redact email addresses\n\tresult = result.replace(\n\t\t/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g,\n\t\t(match) => maskEmail(match)\n\t);\n\n\treturn result;\n}\n\n/**\n * Recursively redact PII from an object\n */\nfunction redactPII(obj: unknown, depth = 0): unknown {\n\t// Prevent infinite recursion\n\tif (depth > 10) return \"[MAX_DEPTH]\";\n\n\tif (obj === null || obj === undefined) {\n\t\treturn obj;\n\t}\n\n\tif (typeof obj === \"string\") {\n\t\treturn redactString(obj);\n\t}\n\n\tif (typeof obj === \"number\" || typeof obj === \"boolean\") {\n\t\treturn obj;\n\t}\n\n\tif (Array.isArray(obj)) {\n\t\treturn obj.map((item) => redactPII(item, depth + 1));\n\t}\n\n\tif (typeof obj === \"object\") {\n\t\tconst result: Record<string, unknown> = {};\n\n\t\tfor (const [key, value] of Object.entries(obj)) {\n\t\t\t// Check if this is a sensitive field\n\t\t\tconst isSensitive = SENSITIVE_FIELDS.some(\n\t\t\t\t(field) => key.toLowerCase().includes(field.toLowerCase())\n\t\t\t);\n\n\t\t\tif (isSensitive) {\n\t\t\t\tif (typeof value === \"string\") {\n\t\t\t\t\t// Mask the value\n\t\t\t\t\tif (value.includes(\"@\")) {\n\t\t\t\t\t\tresult[key] = maskEmail(value);\n\t\t\t\t\t} else if (/\\d/.test(value)) {\n\t\t\t\t\t\tresult[key] = maskPhoneNumber(value);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult[key] = \"[REDACTED]\";\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tresult[key] = \"[REDACTED]\";\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tresult[key] = redactPII(value, depth + 1);\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\treturn obj;\n}\n\n// =============================================================================\n// LOGGER CLASS\n// =============================================================================\n\nclass TelnyxLogger {\n\tprivate service = \"telnyx\";\n\tprivate defaultContext: LogContext = {};\n\n\t/**\n\t * Set default context for all log entries\n\t */\n\tsetDefaultContext(context: LogContext): void {\n\t\tthis.defaultContext = { ...this.defaultContext, ...context };\n\t}\n\n\t/**\n\t * Clear default context\n\t */\n\tclearDefaultContext(): void {\n\t\tthis.defaultContext = {};\n\t}\n\n\t/**\n\t * Check if a log level should be output\n\t */\n\tprivate shouldLog(level: LogLevel): boolean {\n\t\treturn LOG_LEVELS[level] >= LOG_LEVELS[currentLogLevel];\n\t}\n\n\t/**\n\t * Format and output a log entry\n\t */\n\tprivate log(level: LogLevel, message: string, context?: LogContext): void {\n\t\tif (!this.shouldLog(level)) return;\n\n\t\tconst entry: LogEntry = {\n\t\t\ttimestamp: new Date().toISOString(),\n\t\t\tlevel,\n\t\t\tservice: this.service,\n\t\t\tmessage,\n\t\t};\n\n\t\t// Merge default context with provided context\n\t\tconst fullContext = { ...this.defaultContext, ...context };\n\n\t\tif (Object.keys(fullContext).length > 0) {\n\t\t\t// Redact PII from context\n\t\t\tentry.context = redactPII(fullContext) as LogContext;\n\t\t}\n\n\t\t// Output as JSON in production, pretty print in development\n\t\tif (process.env.NODE_ENV === \"production\") {\n\t\t\tconst output = JSON.stringify(entry);\n\n\t\t\tswitch (level) {\n\t\t\t\tcase \"error\":\n\t\t\t\t\tconsole.error(output);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"warn\":\n\t\t\t\t\tconsole.warn(output);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tconsole.log(output);\n\t\t\t}\n\t\t} else {\n\t\t\t// Development: more readable format\n\t\t\tconst contextStr = entry.context\n\t\t\t\t? ` ${JSON.stringify(entry.context, null, 2)}`\n\t\t\t\t: \"\";\n\n\t\t\tconst prefix = `[${entry.timestamp}] [${level.toUpperCase()}] [${this.service}]`;\n\n\t\t\tswitch (level) {\n\t\t\t\tcase \"error\":\n\t\t\t\t\tconsole.error(`${prefix} ${message}${contextStr}`);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"warn\":\n\t\t\t\t\tconsole.warn(`${prefix} ${message}${contextStr}`);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"debug\":\n\t\t\t\t\tconsole.debug(`${prefix} ${message}${contextStr}`);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tconsole.log(`${prefix} ${message}${contextStr}`);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Log at debug level\n\t */\n\tdebug(message: string, context?: LogContext): void {\n\t\tthis.log(\"debug\", message, context);\n\t}\n\n\t/**\n\t * Log at info level\n\t */\n\tinfo(message: string, context?: LogContext): void {\n\t\tthis.log(\"info\", message, context);\n\t}\n\n\t/**\n\t * Log at warn level\n\t */\n\twarn(message: string, context?: LogContext): void {\n\t\tthis.log(\"warn\", message, context);\n\t}\n\n\t/**\n\t * Log at error level\n\t */\n\terror(message: string, context?: LogContext): void {\n\t\tthis.log(\"error\", message, context);\n\t}\n\n\t/**\n\t * Create a child logger with additional default context\n\t */\n\tchild(context: LogContext): TelnyxChildLogger {\n\t\treturn new TelnyxChildLogger(this, context);\n\t}\n\n\t/**\n\t * Log a request start\n\t */\n\tlogRequestStart(\n\t\tmethod: string,\n\t\tendpoint: string,\n\t\tcontext?: LogContext\n\t): { correlationId: string; startTime: number } {\n\t\tconst correlationId =\n\t\t\tcontext?.correlationId ||\n\t\t\t`tlx_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\n\t\tconst startTime = Date.now();\n\n\t\tthis.debug(`${method} ${endpoint} started`, {\n\t\t\t...context,\n\t\t\tcorrelationId,\n\t\t\tendpoint,\n\t\t});\n\n\t\treturn { correlationId, startTime };\n\t}\n\n\t/**\n\t * Log a request completion\n\t */\n\tlogRequestEnd(\n\t\tmethod: string,\n\t\tendpoint: string,\n\t\tstatusCode: number,\n\t\tstartTime: number,\n\t\tcontext?: LogContext\n\t): void {\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tconst logFn = statusCode >= 400 ? this.warn.bind(this) : this.info.bind(this);\n\n\t\tlogFn(`${method} ${endpoint} completed`, {\n\t\t\t...context,\n\t\t\tendpoint,\n\t\t\tstatusCode,\n\t\t\tlatencyMs,\n\t\t});\n\t}\n\n\t/**\n\t * Log a request error\n\t */\n\tlogRequestError(\n\t\tmethod: string,\n\t\tendpoint: string,\n\t\terror: Error,\n\t\tstartTime: number,\n\t\tcontext?: LogContext\n\t): void {\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tthis.error(`${method} ${endpoint} failed`, {\n\t\t\t...context,\n\t\t\tendpoint,\n\t\t\terror: error.message,\n\t\t\tlatencyMs,\n\t\t});\n\t}\n}\n\n/**\n * Child logger with inherited context\n */\nclass TelnyxChildLogger {\n\tconstructor(\n\t\tprivate parent: TelnyxLogger,\n\t\tprivate context: LogContext\n\t) {}\n\n\tdebug(message: string, context?: LogContext): void {\n\t\tthis.parent.debug(message, { ...this.context, ...context });\n\t}\n\n\tinfo(message: string, context?: LogContext): void {\n\t\tthis.parent.info(message, { ...this.context, ...context });\n\t}\n\n\twarn(message: string, context?: LogContext): void {\n\t\tthis.parent.warn(message, { ...this.context, ...context });\n\t}\n\n\terror(message: string, context?: LogContext): void {\n\t\tthis.parent.error(message, { ...this.context, ...context });\n\t}\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\n/**\n * Singleton logger instance\n */\nexport const telnyxLogger = new TelnyxLogger();\n\n/**\n * Create a request-scoped logger\n */\nexport function createRequestLogger(correlationId: string): TelnyxChildLogger {\n\treturn telnyxLogger.child({ correlationId });\n}\n\n/**\n * Utility to redact PII from any object (exported for testing)\n */\nexport { redactPII };\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 767, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/retry.ts"],"sourcesContent":["/**\n * Telnyx Retry Logic\n *\n * Implements exponential backoff with jitter and circuit breaker pattern\n * for resilient API calls to Telnyx.\n */\n\nimport { telnyxLogger } from \"./logger\";\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nexport interface RetryConfig {\n\tmaxRetries: number;\n\tbaseDelayMs: number;\n\tmaxDelayMs: number;\n\tjitterFactor: number; // 0-1, adds randomness to delay\n\tretryableStatusCodes: number[];\n\tretryableErrorCodes: string[];\n}\n\nexport const DEFAULT_RETRY_CONFIG: RetryConfig = {\n\tmaxRetries: 5,\n\tbaseDelayMs: 1000, // 1 second\n\tmaxDelayMs: 32000, // 32 seconds max\n\tjitterFactor: 0.3, // 30% jitter\n\tretryableStatusCodes: [408, 429, 500, 502, 503, 504],\n\tretryableErrorCodes: [\n\t\t\"ECONNRESET\",\n\t\t\"ETIMEDOUT\",\n\t\t\"ECONNREFUSED\",\n\t\t\"EPIPE\",\n\t\t\"ENOTFOUND\",\n\t\t\"ENETUNREACH\",\n\t\t\"EAI_AGAIN\",\n\t],\n};\n\n// =============================================================================\n// CIRCUIT BREAKER\n// =============================================================================\n\nexport interface CircuitBreakerConfig {\n\tfailureThreshold: number; // Failures before opening circuit\n\tresetTimeoutMs: number; // Time before trying again\n\thalfOpenRequests: number; // Requests to allow in half-open state\n}\n\nexport const DEFAULT_CIRCUIT_BREAKER_CONFIG: CircuitBreakerConfig = {\n\tfailureThreshold: 5,\n\tresetTimeoutMs: 60000, // 1 minute\n\thalfOpenRequests: 3,\n};\n\ntype CircuitState = \"closed\" | \"open\" | \"half-open\";\n\ninterface CircuitBreakerState {\n\tstate: CircuitState;\n\tfailures: number;\n\tlastFailureTime: number;\n\thalfOpenSuccesses: number;\n\thalfOpenFailures: number;\n}\n\n// Per-endpoint circuit breakers\nconst circuitBreakers = new Map<string, CircuitBreakerState>();\n\nfunction getCircuitBreaker(endpoint: string): CircuitBreakerState {\n\tif (!circuitBreakers.has(endpoint)) {\n\t\tcircuitBreakers.set(endpoint, {\n\t\t\tstate: \"closed\",\n\t\t\tfailures: 0,\n\t\t\tlastFailureTime: 0,\n\t\t\thalfOpenSuccesses: 0,\n\t\t\thalfOpenFailures: 0,\n\t\t});\n\t}\n\treturn circuitBreakers.get(endpoint)!;\n}\n\nfunction updateCircuitState(\n\tendpoint: string,\n\tsuccess: boolean,\n\tconfig: CircuitBreakerConfig = DEFAULT_CIRCUIT_BREAKER_CONFIG\n): void {\n\tconst breaker = getCircuitBreaker(endpoint);\n\tconst now = Date.now();\n\n\tif (success) {\n\t\tif (breaker.state === \"half-open\") {\n\t\t\tbreaker.halfOpenSuccesses++;\n\t\t\tif (breaker.halfOpenSuccesses >= config.halfOpenRequests) {\n\t\t\t\t// Enough successes, close the circuit\n\t\t\t\tbreaker.state = \"closed\";\n\t\t\t\tbreaker.failures = 0;\n\t\t\t\tbreaker.halfOpenSuccesses = 0;\n\t\t\t\tbreaker.halfOpenFailures = 0;\n\t\t\t\ttelnyxLogger.info(\"Circuit breaker closed\", { endpoint });\n\t\t\t}\n\t\t} else if (breaker.state === \"closed\") {\n\t\t\t// Reset failure count on success\n\t\t\tbreaker.failures = 0;\n\t\t}\n\t} else {\n\t\tbreaker.lastFailureTime = now;\n\n\t\tif (breaker.state === \"half-open\") {\n\t\t\tbreaker.halfOpenFailures++;\n\t\t\t// Any failure in half-open reopens the circuit\n\t\t\tbreaker.state = \"open\";\n\t\t\tbreaker.halfOpenSuccesses = 0;\n\t\t\tbreaker.halfOpenFailures = 0;\n\t\t\ttelnyxLogger.warn(\"Circuit breaker reopened\", { endpoint });\n\t\t} else if (breaker.state === \"closed\") {\n\t\t\tbreaker.failures++;\n\t\t\tif (breaker.failures >= config.failureThreshold) {\n\t\t\t\tbreaker.state = \"open\";\n\t\t\t\ttelnyxLogger.error(\"Circuit breaker opened\", {\n\t\t\t\t\tendpoint,\n\t\t\t\t\tfailures: breaker.failures,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction canAttempt(\n\tendpoint: string,\n\tconfig: CircuitBreakerConfig = DEFAULT_CIRCUIT_BREAKER_CONFIG\n): boolean {\n\tconst breaker = getCircuitBreaker(endpoint);\n\tconst now = Date.now();\n\n\tif (breaker.state === \"closed\") {\n\t\treturn true;\n\t}\n\n\tif (breaker.state === \"open\") {\n\t\t// Check if reset timeout has passed\n\t\tif (now - breaker.lastFailureTime >= config.resetTimeoutMs) {\n\t\t\tbreaker.state = \"half-open\";\n\t\t\tbreaker.halfOpenSuccesses = 0;\n\t\t\tbreaker.halfOpenFailures = 0;\n\t\t\ttelnyxLogger.info(\"Circuit breaker half-open\", { endpoint });\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\t// Half-open: allow limited requests\n\treturn true;\n}\n\n// =============================================================================\n// RETRY LOGIC\n// =============================================================================\n\nexport interface RetryError extends Error {\n\tstatusCode?: number;\n\terrorCode?: string;\n\tretryable: boolean;\n\tattempts: number;\n\tlastError?: Error;\n}\n\nexport function createRetryError(\n\tmessage: string,\n\toptions: {\n\t\tstatusCode?: number;\n\t\terrorCode?: string;\n\t\tretryable: boolean;\n\t\tattempts: number;\n\t\tlastError?: Error;\n\t}\n): RetryError {\n\tconst error = new Error(message) as RetryError;\n\terror.name = \"RetryError\";\n\terror.statusCode = options.statusCode;\n\terror.errorCode = options.errorCode;\n\terror.retryable = options.retryable;\n\terror.attempts = options.attempts;\n\terror.lastError = options.lastError;\n\treturn error;\n}\n\n/**\n * Check if an error is retryable\n */\nexport function isRetryable(\n\terror: unknown,\n\tconfig: RetryConfig = DEFAULT_RETRY_CONFIG\n): boolean {\n\tif (!error) return false;\n\n\t// Check for network errors\n\tif (error instanceof Error) {\n\t\tconst errorCode = (error as NodeJS.ErrnoException).code;\n\t\tif (errorCode && config.retryableErrorCodes.includes(errorCode)) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// Check for fetch/network errors\n\t\tif (\n\t\t\terror.message.includes(\"fetch failed\") ||\n\t\t\terror.message.includes(\"network\") ||\n\t\t\terror.message.includes(\"timeout\") ||\n\t\t\terror.message.includes(\"ECONNRESET\")\n\t\t) {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\t// Check for HTTP status codes\n\tif (typeof error === \"object\" && error !== null) {\n\t\tconst statusCode = (error as { statusCode?: number; status?: number })\n\t\t\t.statusCode ||\n\t\t\t(error as { statusCode?: number; status?: number }).status;\n\t\tif (statusCode && config.retryableStatusCodes.includes(statusCode)) {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\treturn false;\n}\n\n/**\n * Calculate delay with exponential backoff and jitter\n */\nexport function calculateDelay(\n\tattempt: number,\n\tconfig: RetryConfig = DEFAULT_RETRY_CONFIG\n): number {\n\t// Exponential backoff: baseDelay * 2^attempt\n\tconst exponentialDelay = config.baseDelayMs * Math.pow(2, attempt);\n\n\t// Cap at max delay\n\tconst cappedDelay = Math.min(exponentialDelay, config.maxDelayMs);\n\n\t// Add jitter (randomness to spread out retries)\n\tconst jitter = cappedDelay * config.jitterFactor * Math.random();\n\n\treturn Math.floor(cappedDelay + jitter);\n}\n\n/**\n * Sleep for specified milliseconds\n */\nexport function sleep(ms: number): Promise<void> {\n\treturn new Promise((resolve) => setTimeout(resolve, ms));\n}\n\n/**\n * Extract Retry-After header value in milliseconds\n */\nexport function parseRetryAfter(response: Response): number | null {\n\tconst retryAfter = response.headers.get(\"Retry-After\");\n\tif (!retryAfter) return null;\n\n\t// Check if it's a number (seconds)\n\tconst seconds = parseInt(retryAfter, 10);\n\tif (!isNaN(seconds)) {\n\t\treturn seconds * 1000;\n\t}\n\n\t// Check if it's a date\n\tconst date = Date.parse(retryAfter);\n\tif (!isNaN(date)) {\n\t\treturn Math.max(0, date - Date.now());\n\t}\n\n\treturn null;\n}\n\n// =============================================================================\n// RETRY WRAPPER\n// =============================================================================\n\nexport interface RetryOptions {\n\tendpoint?: string; // For circuit breaker tracking\n\tconfig?: Partial<RetryConfig>;\n\tcircuitBreakerConfig?: Partial<CircuitBreakerConfig>;\n\tonRetry?: (attempt: number, error: Error, delayMs: number) => void;\n\tcorrelationId?: string;\n}\n\n/**\n * Execute a function with retry logic and circuit breaker\n */\nexport async function withRetry<T>(\n\tfn: () => Promise<T>,\n\toptions: RetryOptions = {}\n): Promise<T> {\n\tconst config = { ...DEFAULT_RETRY_CONFIG, ...options.config };\n\tconst circuitConfig = {\n\t\t...DEFAULT_CIRCUIT_BREAKER_CONFIG,\n\t\t...options.circuitBreakerConfig,\n\t};\n\tconst endpoint = options.endpoint || \"default\";\n\tconst correlationId = options.correlationId || generateCorrelationId();\n\n\t// Check circuit breaker\n\tif (!canAttempt(endpoint, circuitConfig)) {\n\t\tconst error = createRetryError(\n\t\t\t`Circuit breaker open for endpoint: ${endpoint}`,\n\t\t\t{\n\t\t\t\tretryable: false,\n\t\t\t\tattempts: 0,\n\t\t\t}\n\t\t);\n\t\ttelnyxLogger.warn(\"Request blocked by circuit breaker\", {\n\t\t\tendpoint,\n\t\t\tcorrelationId,\n\t\t});\n\t\tthrow error;\n\t}\n\n\tlet lastError: Error | undefined;\n\tlet attempt = 0;\n\n\twhile (attempt <= config.maxRetries) {\n\t\ttry {\n\t\t\tconst result = await fn();\n\n\t\t\t// Success - update circuit breaker\n\t\t\tupdateCircuitState(endpoint, true, circuitConfig);\n\n\t\t\tif (attempt > 0) {\n\t\t\t\ttelnyxLogger.info(\"Request succeeded after retry\", {\n\t\t\t\t\tendpoint,\n\t\t\t\t\tattempt,\n\t\t\t\t\tcorrelationId,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn result;\n\t\t} catch (error) {\n\t\t\tlastError = error instanceof Error ? error : new Error(String(error));\n\n\t\t\tconst retryable = isRetryable(error, config);\n\n\t\t\ttelnyxLogger.warn(\"Request failed\", {\n\t\t\t\tendpoint,\n\t\t\t\tattempt,\n\t\t\t\tretryable,\n\t\t\t\terror: lastError.message,\n\t\t\t\tcorrelationId,\n\t\t\t});\n\n\t\t\t// Update circuit breaker on failure\n\t\t\tupdateCircuitState(endpoint, false, circuitConfig);\n\n\t\t\t// Don't retry if not retryable or max retries reached\n\t\t\tif (!retryable || attempt >= config.maxRetries) {\n\t\t\t\tthrow createRetryError(\n\t\t\t\t\t`Request failed after ${attempt + 1} attempt(s): ${lastError.message}`,\n\t\t\t\t\t{\n\t\t\t\t\t\tretryable,\n\t\t\t\t\t\tattempts: attempt + 1,\n\t\t\t\t\t\tlastError,\n\t\t\t\t\t\tstatusCode: (error as { statusCode?: number }).statusCode,\n\t\t\t\t\t\terrorCode: (error as { code?: string }).code,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Calculate delay\n\t\t\tlet delayMs = calculateDelay(attempt, config);\n\n\t\t\t// Check for Retry-After header (if error has response)\n\t\t\tif (\n\t\t\t\ttypeof error === \"object\" &&\n\t\t\t\terror !== null &&\n\t\t\t\t\"response\" in error\n\t\t\t) {\n\t\t\t\tconst response = (error as { response?: Response }).response;\n\t\t\t\tif (response) {\n\t\t\t\t\tconst retryAfter = parseRetryAfter(response);\n\t\t\t\t\tif (retryAfter) {\n\t\t\t\t\t\tdelayMs = Math.min(retryAfter, config.maxDelayMs);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Call onRetry callback\n\t\t\tif (options.onRetry) {\n\t\t\t\toptions.onRetry(attempt, lastError, delayMs);\n\t\t\t}\n\n\t\t\ttelnyxLogger.info(\"Retrying request\", {\n\t\t\t\tendpoint,\n\t\t\t\tattempt: attempt + 1,\n\t\t\t\tdelayMs,\n\t\t\t\tcorrelationId,\n\t\t\t});\n\n\t\t\tawait sleep(delayMs);\n\t\t\tattempt++;\n\t\t}\n\t}\n\n\t// Should never reach here, but just in case\n\tthrow createRetryError(\n\t\t`Request failed after ${config.maxRetries + 1} attempts`,\n\t\t{\n\t\t\tretryable: false,\n\t\t\tattempts: config.maxRetries + 1,\n\t\t\tlastError,\n\t\t}\n\t);\n}\n\n// =============================================================================\n// BULK RETRY (for rate-limited batch operations)\n// =============================================================================\n\nexport interface BulkRetryOptions<T, R> {\n\titems: T[];\n\toperation: (item: T) => Promise<R>;\n\tconcurrency?: number;\n\tretryOptions?: RetryOptions;\n\tonProgress?: (completed: number, total: number, failed: number) => void;\n}\n\nexport interface BulkRetryResult<T, R> {\n\tsuccessful: Array<{ item: T; result: R }>;\n\tfailed: Array<{ item: T; error: Error }>;\n}\n\n/**\n * Process items in bulk with retry logic and concurrency control\n */\nexport async function withBulkRetry<T, R>(\n\toptions: BulkRetryOptions<T, R>\n): Promise<BulkRetryResult<T, R>> {\n\tconst { items, operation, concurrency = 10, retryOptions, onProgress } = options;\n\n\tconst successful: Array<{ item: T; result: R }> = [];\n\tconst failed: Array<{ item: T; error: Error }> = [];\n\tlet completed = 0;\n\n\t// Process in batches\n\tfor (let i = 0; i < items.length; i += concurrency) {\n\t\tconst batch = items.slice(i, i + concurrency);\n\n\t\tconst results = await Promise.allSettled(\n\t\t\tbatch.map(async (item) => {\n\t\t\t\tconst result = await withRetry(\n\t\t\t\t\t() => operation(item),\n\t\t\t\t\tretryOptions\n\t\t\t\t);\n\t\t\t\treturn { item, result };\n\t\t\t})\n\t\t);\n\n\t\tfor (const result of results) {\n\t\t\tcompleted++;\n\n\t\t\tif (result.status === \"fulfilled\") {\n\t\t\t\tsuccessful.push(result.value);\n\t\t\t} else {\n\t\t\t\tconst item = batch[results.indexOf(result)];\n\t\t\t\tfailed.push({\n\t\t\t\t\titem,\n\t\t\t\t\terror:\n\t\t\t\t\t\tresult.reason instanceof Error\n\t\t\t\t\t\t\t? result.reason\n\t\t\t\t\t\t\t: new Error(String(result.reason)),\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif (onProgress) {\n\t\t\tonProgress(completed, items.length, failed.length);\n\t\t}\n\n\t\t// Small delay between batches to avoid rate limiting\n\t\tif (i + concurrency < items.length) {\n\t\t\tawait sleep(100);\n\t\t}\n\t}\n\n\treturn { successful, failed };\n}\n\n// =============================================================================\n// UTILITIES\n// =============================================================================\n\n/**\n * Generate a correlation ID for request tracking\n */\nexport function generateCorrelationId(): string {\n\treturn `tlx_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\n}\n\n/**\n * Get circuit breaker status for monitoring\n */\nexport function getCircuitBreakerStatus(endpoint?: string): {\n\tendpoints: Record<string, CircuitBreakerState>;\n\tsummary: {\n\t\ttotal: number;\n\t\topen: number;\n\t\thalfOpen: number;\n\t\tclosed: number;\n\t};\n} {\n\tconst endpoints: Record<string, CircuitBreakerState> = {};\n\n\tif (endpoint) {\n\t\tconst breaker = circuitBreakers.get(endpoint);\n\t\tif (breaker) {\n\t\t\tendpoints[endpoint] = breaker;\n\t\t}\n\t} else {\n\t\tcircuitBreakers.forEach((state, ep) => {\n\t\t\tendpoints[ep] = state;\n\t\t});\n\t}\n\n\tconst states = Object.values(endpoints);\n\treturn {\n\t\tendpoints,\n\t\tsummary: {\n\t\t\ttotal: states.length,\n\t\t\topen: states.filter((s) => s.state === \"open\").length,\n\t\t\thalfOpen: states.filter((s) => s.state === \"half-open\").length,\n\t\t\tclosed: states.filter((s) => s.state === \"closed\").length,\n\t\t},\n\t};\n}\n\n/**\n * Reset circuit breaker for an endpoint (for testing/manual reset)\n */\nexport function resetCircuitBreaker(endpoint: string): void {\n\tcircuitBreakers.delete(endpoint);\n\ttelnyxLogger.info(\"Circuit breaker reset\", { endpoint });\n}\n\n/**\n * Reset all circuit breakers\n */\nexport function resetAllCircuitBreakers(): void {\n\tcircuitBreakers.clear();\n\ttelnyxLogger.info(\"All circuit breakers reset\");\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1141, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/calls.ts"],"sourcesContent":["/**\n * Telnyx Calls Service - Call Control & Management\n *\n * Production-ready call control with:\n * - Retry logic with exponential backoff\n * - Request timeouts (prevents hanging)\n * - Circuit breaker protection\n * - Structured logging\n *\n * Handles all call-related operations including:\n * - Initiating outbound calls\n * - Answering incoming calls\n * - Call control (mute, hold, transfer)\n * - Call recording\n * - Hangup operations\n */\n\nimport { telnyxLogger } from \"./logger\";\nimport { withRetry } from \"./retry\";\n\nconst TELNYX_API_BASE = \"https://api.telnyx.com/v2\";\n\n// Request timeout for call control operations (15 seconds)\nconst REQUEST_TIMEOUT_MS = 15000;\n\n/**\n * Call control command types\n */\nexport type CallCommand =\n\t| \"answer\"\n\t| \"reject\"\n\t| \"hangup\"\n\t| \"bridge\"\n\t| \"speak\"\n\t| \"gather_using_audio\"\n\t| \"gather_using_speak\"\n\t| \"playback_start\"\n\t| \"playback_stop\"\n\t| \"record_start\"\n\t| \"record_stop\"\n\t| \"send_dtmf\"\n\t| \"transfer\";\n\n/**\n * Call status types from Telnyx webhooks\n */\nexport type CallStatus =\n\t| \"initiated\"\n\t| \"ringing\"\n\t| \"answered\"\n\t| \"active\"\n\t| \"hangup\"\n\t| \"machine_greeting_detected\"\n\t| \"machine_greeting_ended\";\n\n/**\n * Make a direct HTTP request to Telnyx REST API with retry and timeout\n */\nasync function telnyxCallRequest<T>(\n\tendpoint: string,\n\tbody: Record<string, unknown>,\n\toptions?: {\n\t\t/** Operation name for logging */\n\t\toperation?: string;\n\t\t/** Custom timeout in ms (default: 15000) */\n\t\ttimeout?: number;\n\t\t/** Skip retry logic (for time-sensitive operations) */\n\t\tskipRetry?: boolean;\n\t}\n): Promise<{ success: boolean; data?: T; error?: string }> {\n\tconst apiKey = process.env.TELNYX_API_KEY;\n\tif (!apiKey) {\n\t\treturn { success: false, error: \"TELNYX_API_KEY is not configured\" };\n\t}\n\n\tconst operation = options?.operation || endpoint;\n\tconst timeout = options?.timeout ?? REQUEST_TIMEOUT_MS;\n\n\tconst makeRequest = async (): Promise<{ success: boolean; data?: T; error?: string }> => {\n\t\t// Create abort controller for timeout\n\t\tconst controller = new AbortController();\n\t\tconst timeoutId = setTimeout(() => controller.abort(), timeout);\n\n\t\ttry {\n\t\t\ttelnyxLogger.debug(\"Call API request\", {\n\t\t\t\tendpoint,\n\t\t\t\toperation,\n\t\t\t});\n\n\t\t\tconst response = await fetch(`${TELNYX_API_BASE}${endpoint}`, {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify(body),\n\t\t\t\tsignal: controller.signal,\n\t\t\t});\n\n\t\t\tclearTimeout(timeoutId);\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorMessage =\n\t\t\t\t\tresult?.errors?.[0]?.detail ||\n\t\t\t\t\tresult?.errors?.[0] ||\n\t\t\t\t\tresponse.statusText;\n\n\t\t\t\ttelnyxLogger.warn(\"Call API error response\", {\n\t\t\t\t\tendpoint,\n\t\t\t\t\toperation,\n\t\t\t\t\tstatus: response.status,\n\t\t\t\t\terror: errorMessage,\n\t\t\t\t});\n\n\t\t\t\t// Throw for retry logic to catch\n\t\t\t\tconst error = new Error(`Telnyx ${response.status}: ${errorMessage}`);\n\t\t\t\t(error as Error & { statusCode: number }).statusCode = response.status;\n\t\t\t\tthrow error;\n\t\t\t}\n\n\t\t\ttelnyxLogger.debug(\"Call API success\", {\n\t\t\t\tendpoint,\n\t\t\t\toperation,\n\t\t\t});\n\n\t\t\treturn { success: true, data: result.data };\n\t\t} catch (error) {\n\t\t\tclearTimeout(timeoutId);\n\n\t\t\tif (error instanceof Error && error.name === \"AbortError\") {\n\t\t\t\ttelnyxLogger.error(\"Call API timeout\", {\n\t\t\t\t\tendpoint,\n\t\t\t\t\toperation,\n\t\t\t\t\ttimeoutMs: timeout,\n\t\t\t\t});\n\t\t\t\tthrow new Error(`Request timeout after ${timeout}ms`);\n\t\t\t}\n\n\t\t\tthrow error;\n\t\t}\n\t};\n\n\ttry {\n\t\t// Use retry logic unless skipped\n\t\tif (options?.skipRetry) {\n\t\t\treturn await makeRequest();\n\t\t}\n\n\t\treturn await withRetry(makeRequest, {\n\t\t\tendpoint: `calls:${operation}`,\n\t\t\tconfig: {\n\t\t\t\tmaxRetries: 2, // Fewer retries for call operations (time-sensitive)\n\t\t\t\tbaseDelayMs: 500,\n\t\t\t\tmaxDelayMs: 2000,\n\t\t\t},\n\t\t\tonRetry: (attempt, error, delayMs) => {\n\t\t\t\ttelnyxLogger.warn(\"Retrying call API request\", {\n\t\t\t\t\tendpoint,\n\t\t\t\t\toperation,\n\t\t\t\t\tattempt,\n\t\t\t\t\terror: error.message,\n\t\t\t\t\tdelayMs,\n\t\t\t\t});\n\t\t\t},\n\t\t});\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"Call API request failed\", {\n\t\t\tendpoint,\n\t\t\toperation,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Request failed\",\n\t\t};\n\t}\n}\n\n/**\n * Initiate an outbound call\n */\nexport async function initiateCall(params: {\n\tto: string;\n\tfrom: string;\n\tconnectionId: string;\n\twebhookUrl?: string;\n\tansweringMachineDetection?: \"premium\" | \"detect\" | \"disabled\";\n\tcustomHeaders?: Array<{ name: string; value: string }>;\n}) {\n\tconst result = await telnyxCallRequest<{\n\t\tcall_control_id: string;\n\t\tcall_session_id: string;\n\t}>(\n\t\t\"/calls\",\n\t\t{\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t\tconnection_id: params.connectionId,\n\t\t\twebhook_url: params.webhookUrl,\n\t\t\tanswering_machine_detection:\n\t\t\t\tparams.answeringMachineDetection || \"disabled\",\n\t\t\tcustom_headers: params.customHeaders,\n\t\t},\n\t\t{ operation: \"initiate\" }\n\t);\n\n\tif (!(result.success && result.data)) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: result.error || \"Failed to initiate call\",\n\t\t};\n\t}\n\n\treturn {\n\t\tsuccess: true,\n\t\tcallControlId: result.data.call_control_id,\n\t\tcallSessionId: result.data.call_session_id,\n\t\tdata: result.data,\n\t};\n}\n\n/**\n * Answer an incoming call\n */\nexport async function answerCall(params: {\n\tcallControlId: string;\n\twebhookUrl?: string;\n\tclientState?: string;\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/answer`,\n\t\t{\n\t\t\twebhook_url: params.webhookUrl,\n\t\t\tclient_state: params.clientState,\n\t\t},\n\t\t{ operation: \"answer\", skipRetry: true } // Time-sensitive, no retry\n\t);\n}\n\n/**\n * Reject an incoming call\n */\nexport async function rejectCall(params: {\n\tcallControlId: string;\n\tcause?: \"CALL_REJECTED\" | \"USER_BUSY\";\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/reject`,\n\t\t{ cause: params.cause || \"CALL_REJECTED\" },\n\t\t{ operation: \"reject\", skipRetry: true }\n\t);\n}\n\n/**\n * Hangup an active call\n */\nexport async function hangupCall(params: { callControlId: string }) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/hangup`,\n\t\t{},\n\t\t{ operation: \"hangup\" }\n\t);\n}\n\n/**\n * Start call recording\n */\nexport async function startRecording(params: {\n\tcallControlId: string;\n\tformat?: \"wav\" | \"mp3\";\n\tchannels?: \"single\" | \"dual\";\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/record_start`,\n\t\t{\n\t\t\tformat: params.format || \"mp3\",\n\t\t\tchannels: params.channels || \"single\",\n\t\t},\n\t\t{ operation: \"record_start\" }\n\t);\n}\n\n/**\n * Stop call recording\n */\nexport async function stopRecording(params: { callControlId: string }) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/record_stop`,\n\t\t{},\n\t\t{ operation: \"record_stop\" }\n\t);\n}\n\n/**\n * Play audio to the call\n */\nexport async function playAudio(params: {\n\tcallControlId: string;\n\taudioUrl: string;\n\tloop?: number;\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/playback_start`,\n\t\t{\n\t\t\taudio_url: params.audioUrl,\n\t\t\tloop: params.loop,\n\t\t},\n\t\t{ operation: \"playback_start\" }\n\t);\n}\n\n/**\n * Speak text to the call using text-to-speech\n */\nexport async function speakText(params: {\n\tcallControlId: string;\n\ttext: string;\n\tvoice?: \"male\" | \"female\";\n\tlanguage?: string;\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/speak`,\n\t\t{\n\t\t\tpayload: params.text,\n\t\t\tvoice: params.voice || \"female\",\n\t\t\tlanguage: params.language || \"en-US\",\n\t\t},\n\t\t{ operation: \"speak\" }\n\t);\n}\n\n/**\n * Transfer a call to another number\n */\nexport async function transferCall(params: {\n\tcallControlId: string;\n\tto: string;\n\tfrom: string;\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/transfer`,\n\t\t{\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t},\n\t\t{ operation: \"transfer\" }\n\t);\n}\n\n/**\n * Send DTMF tones (phone keypad presses)\n */\nexport async function sendDTMF(params: {\n\tcallControlId: string;\n\tdigits: string;\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/send_dtmf`,\n\t\t{ digits: params.digits },\n\t\t{ operation: \"send_dtmf\" }\n\t);\n}\n\n/**\n * Gather user input using audio prompts\n */\nexport async function gatherInput(params: {\n\tcallControlId: string;\n\taudioUrl?: string;\n\tspeakText?: string;\n\tvalidDigits?: string;\n\tmaxDigits?: number;\n\tminDigits?: number;\n\ttimeout?: number;\n\tterminatingDigit?: string;\n}) {\n\tconst useAudio = !!params.audioUrl;\n\tconst endpoint = useAudio\n\t\t? `/calls/${params.callControlId}/actions/gather_using_audio`\n\t\t: `/calls/${params.callControlId}/actions/gather_using_speak`;\n\n\tconst body = useAudio\n\t\t? {\n\t\t\t\taudio_url: params.audioUrl,\n\t\t\t\tvalid_digits: params.validDigits,\n\t\t\t\tmax: params.maxDigits,\n\t\t\t\tmin: params.minDigits,\n\t\t\t\ttimeout_millis: params.timeout,\n\t\t\t\tterminating_digit: params.terminatingDigit || \"#\",\n\t\t\t}\n\t\t: {\n\t\t\t\tpayload: params.speakText || \"\",\n\t\t\t\tvalid_digits: params.validDigits,\n\t\t\t\tmax: params.maxDigits,\n\t\t\t\tmin: params.minDigits,\n\t\t\t\ttimeout_millis: params.timeout,\n\t\t\t\tterminating_digit: params.terminatingDigit || \"#\",\n\t\t\t};\n\n\treturn telnyxCallRequest(endpoint, body, {\n\t\toperation: useAudio ? \"gather_audio\" : \"gather_speak\",\n\t});\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1411, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/client.ts"],"sourcesContent":["/**\n * Telnyx Client - Authenticated API Client\n *\n * Provides a singleton Telnyx client instance with proper authentication.\n * This client is used across all Telnyx service modules.\n */\n\nimport Telnyx from \"telnyx\";\n\nif (!process.env.TELNYX_API_KEY) {\n\tthrow new Error(\"TELNYX_API_KEY environment variable is required\");\n}\n\n/**\n * Singleton Telnyx client instance\n * Automatically authenticated with API key from environment variables\n */\nexport const telnyxClient = new Telnyx({ apiKey: process.env.TELNYX_API_KEY });\n\n/**\n * Type exports for use throughout the application\n */\nexport type TelnyxClient = typeof telnyxClient;\n\n/**\n * Telnyx API configuration\n */\nexport const TELNYX_CONFIG = {\n\tapiKey: process.env.TELNYX_API_KEY,\n\twebhookSecret: process.env.TELNYX_WEBHOOK_SECRET || \"\",\n\tconnectionId: process.env.NEXT_PUBLIC_TELNYX_CONNECTION_ID || \"\",\n\tpublicKey: process.env.TELNYX_PUBLIC_KEY || \"\",\n\tmessagingProfileId:\n\t\tprocess.env.TELNYX_DEFAULT_MESSAGING_PROFILE_ID ||\n\t\tprocess.env.NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID ||\n\t\t\"\",\n} as const;\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;AAED;AAAA;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,cAAc,EAAE;IAChC,MAAM,IAAI,MAAM;AACjB;AAMO,MAAM,eAAe,IAAI,oOAAM,CAAC;IAAE,QAAQ,QAAQ,GAAG,CAAC,cAAc;AAAC;AAUrE,MAAM,gBAAgB;IAC5B,QAAQ,QAAQ,GAAG,CAAC,cAAc;IAClC,eAAe,QAAQ,GAAG,CAAC,qBAAqB,IAAI;IACpD,cAAc,2DAAgD;IAC9D,WAAW,QAAQ,GAAG,CAAC,iBAAiB,IAAI;IAC5C,oBACC,QAAQ,GAAG,CAAC,mCAAmC,IAC/C,QAAQ,GAAG,CAAC,uCAAuC,IACnD;AACF"}},
    {"offset": {"line": 1442, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/config-validator.ts"],"sourcesContent":["/**\n * Telnyx Configuration Validator\n *\n * Validates all required Telnyx environment variables and configuration.\n * Provides clear error messages for missing or invalid configuration.\n */\n\nimport { TELNYX_CONFIG } from \"./client\";\n\nexport type ValidationResult = {\n\tvalid: boolean;\n\terrors: string[];\n\twarnings: string[];\n\tconfig: {\n\t\tapiKey: boolean;\n\t\tconnectionId: boolean;\n\t\tmessagingProfileId: boolean;\n\t\twebhookSecret: boolean;\n\t\tpublicKey: boolean;\n\t\tsiteUrl: boolean;\n\t};\n};\n\nfunction isLocalUrl(url: string): boolean {\n\tconst lowered = url.toLowerCase();\n\treturn (\n\t\tlowered.includes(\"localhost\") ||\n\t\tlowered.includes(\"127.0.0.1\") ||\n\t\tlowered.includes(\"0.0.0.0\") ||\n\t\tlowered.endsWith(\".local\") ||\n\t\tlowered.includes(\"://local\")\n\t);\n}\n\nfunction getBaseAppUrl(): string | undefined {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\tfor (const candidate of candidates) {\n\t\tif (candidate && candidate.trim()) {\n\t\t\tconst trimmed = candidate.trim();\n\t\t\tif (!isLocalUrl(trimmed)) {\n\t\t\t\treturn trimmed.startsWith(\"http\") ? trimmed : `https://${trimmed}`;\n\t\t\t}\n\t\t}\n\t}\n\n\tconst vercelUrl = process.env.VERCEL_URL;\n\tif (vercelUrl && !isLocalUrl(vercelUrl)) {\n\t\treturn vercelUrl.startsWith(\"http\") ? vercelUrl : `https://${vercelUrl}`;\n\t}\n\n\treturn undefined;\n}\n\n/**\n * Validate all Telnyx configuration\n */\nexport function validateTelnyxConfig(): ValidationResult {\n\tconst errors: string[] = [];\n\tconst warnings: string[] = [];\n\tconst config = {\n\t\tapiKey: false,\n\t\tconnectionId: false,\n\t\tmessagingProfileId: false,\n\t\twebhookSecret: false,\n\t\tpublicKey: false,\n\t\tsiteUrl: false,\n\t};\n\n\t// Check API Key (required)\n\tif (!TELNYX_CONFIG.apiKey || TELNYX_CONFIG.apiKey.trim() === \"\") {\n\t\terrors.push(\n\t\t\t\"TELNYX_API_KEY is not set. This is required for all Telnyx operations.\",\n\t\t);\n\t} else if (TELNYX_CONFIG.apiKey.length < 20) {\n\t\terrors.push(\n\t\t\t\"TELNYX_API_KEY appears to be invalid (too short). Get your API key from https://portal.telnyx.com\",\n\t\t);\n\t} else {\n\t\tconfig.apiKey = true;\n\t}\n\n\t// Check Connection ID (required for voice calls)\n\tif (!TELNYX_CONFIG.connectionId || TELNYX_CONFIG.connectionId.trim() === \"\") {\n\t\terrors.push(\n\t\t\t\"NEXT_PUBLIC_TELNYX_CONNECTION_ID is not set. This is required for phone calls. Get it from Telnyx Portal  Mission Control  Connections.\",\n\t\t);\n\t} else {\n\t\tconfig.connectionId = true;\n\t}\n\n\t// Check Messaging Profile ID (required for SMS)\n\tif (\n\t\t!TELNYX_CONFIG.messagingProfileId ||\n\t\tTELNYX_CONFIG.messagingProfileId.trim() === \"\"\n\t) {\n\t\terrors.push(\n\t\t\t\"TELNYX_DEFAULT_MESSAGING_PROFILE_ID or NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID is not set. This is required for SMS/MMS. Run getDefaultMessagingProfile() to fetch it automatically from Telnyx.\",\n\t\t);\n\t} else {\n\t\tconfig.messagingProfileId = true;\n\t}\n\n\t// Check Webhook Secret (recommended for production)\n\tif (\n\t\t!TELNYX_CONFIG.webhookSecret ||\n\t\tTELNYX_CONFIG.webhookSecret.trim() === \"\"\n\t) {\n\t\twarnings.push(\n\t\t\t\"TELNYX_WEBHOOK_SECRET is not set. Webhook signature verification will be disabled. Set this in production for security.\",\n\t\t);\n\t} else {\n\t\tconfig.webhookSecret = true;\n\t}\n\n\t// Check Public Key (recommended for production)\n\tif (!TELNYX_CONFIG.publicKey || TELNYX_CONFIG.publicKey.trim() === \"\") {\n\t\twarnings.push(\n\t\t\t\"TELNYX_PUBLIC_KEY is not set. Webhook signature verification may not work correctly. Get it from Telnyx Portal  API Keys.\",\n\t\t);\n\t} else {\n\t\tconfig.publicKey = true;\n\t}\n\n\t// Check Site URL (required for webhooks)\n\tconst siteUrl = getBaseAppUrl();\n\tif (!siteUrl) {\n\t\terrors.push(\n\t\t\t\"NEXT_PUBLIC_SITE_URL or SITE_URL is not set to a valid production URL. This is required for webhook callbacks. Set it to your production domain (e.g., https://thorbis.co).\",\n\t\t);\n\t} else if (isLocalUrl(siteUrl)) {\n\t\tconst isProduction =\n\t\t\tprocess.env.VERCEL_ENV === \"production\" ||\n\t\t\tprocess.env.DEPLOYMENT_ENV === \"production\";\n\t\tif (isProduction) {\n\t\t\terrors.push(\n\t\t\t\t`Site URL is set to localhost (${siteUrl}) but you're in production. Set NEXT_PUBLIC_SITE_URL to your production domain.`,\n\t\t\t);\n\t\t} else {\n\t\t\twarnings.push(\n\t\t\t\t`Site URL is set to localhost (${siteUrl}). This will not work in production.`,\n\t\t\t);\n\t\t}\n\t} else {\n\t\tconfig.siteUrl = true;\n\t}\n\n\treturn {\n\t\tvalid: errors.length === 0,\n\t\terrors,\n\t\twarnings,\n\t\tconfig,\n\t};\n}\n\n/**\n * Validate configuration for SMS operations\n */\nexport async function validateSmsConfig(): Promise<{\n\tvalid: boolean;\n\terror?: string;\n\tsuggestedProfileId?: string;\n}> {\n\tconst validation = validateTelnyxConfig();\n\n\tif (!validation.config.apiKey) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: \"TELNYX_API_KEY is required for SMS operations\",\n\t\t};\n\t}\n\n\tif (!validation.config.messagingProfileId) {\n\t\t// Try to fetch messaging profile automatically\n\t\ttry {\n\t\t\tconst { getDefaultMessagingProfile } = await import(\n\t\t\t\t\"./messaging-profile-fetcher\"\n\t\t\t);\n\t\t\tconst profileResult = await getDefaultMessagingProfile();\n\n\t\t\tif (profileResult.success && profileResult.profile) {\n\t\t\t\treturn {\n\t\t\t\t\tvalid: false,\n\t\t\t\t\terror:\n\t\t\t\t\t\t\"TELNYX_DEFAULT_MESSAGING_PROFILE_ID is required for SMS operations.\",\n\t\t\t\t\tsuggestedProfileId: profileResult.profile.id,\n\t\t\t\t};\n\t\t\t}\n\t\t} catch {\n\t\t\t// If fetch fails, return generic error\n\t\t}\n\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"TELNYX_DEFAULT_MESSAGING_PROFILE_ID is required for SMS operations. Run getDefaultMessagingProfile() to fetch it automatically from Telnyx.\",\n\t\t};\n\t}\n\n\tif (!validation.config.siteUrl) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be set to a valid production URL for SMS webhooks.\",\n\t\t};\n\t}\n\n\treturn { valid: true };\n}\n\n/**\n * Validate configuration for voice call operations\n */\nexport function validateCallConfig(): {\n\tvalid: boolean;\n\terror?: string;\n} {\n\tconst validation = validateTelnyxConfig();\n\n\tif (!validation.config.apiKey) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: \"TELNYX_API_KEY is required for phone calls\",\n\t\t};\n\t}\n\n\tif (!validation.config.connectionId) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_TELNYX_CONNECTION_ID is required for phone calls. Get it from Telnyx Portal  Mission Control  Connections.\",\n\t\t};\n\t}\n\n\tif (!validation.config.siteUrl) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be set to a valid production URL for call webhooks.\",\n\t\t};\n\t}\n\n\treturn { valid: true };\n}\n\n/**\n * Get formatted error message for display to users\n */\nfunction getFormattedErrorMessage(validation: ValidationResult): string {\n\tif (validation.valid) {\n\t\treturn \"\";\n\t}\n\n\tconst lines = [\"Telnyx configuration errors:\"];\n\tvalidation.errors.forEach((error, index) => {\n\t\tlines.push(`${index + 1}. ${error}`);\n\t});\n\n\tif (validation.warnings.length > 0) {\n\t\tlines.push(\"\");\n\t\tlines.push(\"Warnings:\");\n\t\tvalidation.warnings.forEach((warning, index) => {\n\t\t\tlines.push(`${index + 1}. ${warning}`);\n\t\t});\n\t}\n\n\treturn lines.join(\"\\n\");\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1633, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/database/src/service-client.ts"],"sourcesContent":["\"use server\";\n\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\";\nimport type { Database } from \"./types\";\n\n/**\n * Creates a Supabase client using the service role key.\n * This bypasses RLS and is intended for background jobs / automation.\n *\n * Performance Optimization:\n * - Uses SUPABASE_POOLER_URL (Transaction Mode) if available for 30-50% faster queries\n * - Falls back to NEXT_PUBLIC_SUPABASE_URL (Session Mode) if pooler not configured\n * - Transaction Mode supports 10,000+ concurrent connections vs 100 in Session Mode\n *\n * @returns Supabase client with service role, or null if not configured\n */\nexport async function createServiceSupabaseClient() {\n\t// Prefer pooler URL for Transaction Mode (better performance)\n\tconst supabaseUrl =\n\t\tprocess.env.SUPABASE_POOLER_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n\tconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n\tif (!supabaseUrl || !serviceRoleKey) {\n\t\treturn null;\n\t}\n\n\treturn createSupabaseClient<Database>(supabaseUrl, serviceRoleKey, {\n\t\tauth: {\n\t\t\tpersistSession: false,\n\t\t\tautoRefreshToken: false,\n\t\t},\n\t\tdb: {\n\t\t\tschema: \"public\",\n\t\t},\n\t\tglobal: {\n\t\t\theaders: {\n\t\t\t\t\"x-my-custom-header\": \"service-role\",\n\t\t\t},\n\t\t},\n\t});\n}\n\nexport type ServiceSupabaseClient = Awaited<\n\tReturnType<typeof createServiceSupabaseClient>\n>;\n"],"names":[],"mappings":";;;;;AAEA;;;;AAcO,eAAe;IACrB,8DAA8D;IAC9D,MAAM,cACL,QAAQ,GAAG,CAAC,mBAAmB;IAChC,MAAM,iBAAiB,QAAQ,GAAG,CAAC,yBAAyB;IAE5D,IAAI,CAAC,eAAe,CAAC,gBAAgB;QACpC,OAAO;IACR;IAEA,OAAO,IAAA,iRAAoB,EAAW,aAAa,gBAAgB;QAClE,MAAM;YACL,gBAAgB;YAChB,kBAAkB;QACnB;QACA,IAAI;YACH,QAAQ;QACT;QACA,QAAQ;YACP,SAAS;gBACR,sBAAsB;YACvB;QACD;IACD;AACD;;;IAxBsB;;AAAA,sZAAA"}},
    {"offset": {"line": 1673, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/messaging.ts"],"sourcesContent":["/**\n * Telnyx Messaging Service - SMS & MMS\n *\n * Production-ready messaging with:\n * - 10DLC compliance verification (required for US A2P SMS as of Dec 2024)\n * - Per-company rate limiting\n * - Retry logic with exponential backoff\n * - Multi-tenant support\n * - Structured logging\n */\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\nimport { telnyxLogger } from \"./logger\";\nimport { withRetry } from \"./retry\";\n\nconst TELNYX_API_BASE = \"https://api.telnyx.com/v2\";\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nconst MESSAGING_CONFIG = {\n\t// Default rate limits per company (messages per minute)\n\tdefaultRateLimitPerMinute: 60,\n\t// Max concurrent sends for bulk operations\n\tmaxConcurrentSends: 5,\n\t// Warn if 10DLC not configured\n\twarnOn10DLCMissing: true,\n\t// Request timeout in milliseconds\n\trequestTimeoutMs: 30000,\n};\n\n// =============================================================================\n// API CLIENT\n// =============================================================================\n\nfunction assertTelnyxApiKey(): string {\n\tconst apiKey = process.env.TELNYX_API_KEY;\n\tif (!apiKey) {\n\t\tthrow new Error(\"TELNYX_API_KEY is not configured\");\n\t}\n\treturn apiKey;\n}\n\nasync function telnyxRequest<T = unknown>(\n\tpath: string,\n\tinit?: RequestInit & {\n\t\tquery?: Record<string, string | number | undefined>;\n\t\ttimeout?: number;\n\t}\n): Promise<T> {\n\tconst apiKey = assertTelnyxApiKey();\n\tconst url = new URL(`${TELNYX_API_BASE}${path}`);\n\n\tif (init?.query) {\n\t\tfor (const [key, value] of Object.entries(init.query)) {\n\t\t\tif (value !== undefined && value !== null) {\n\t\t\t\turl.searchParams.set(key, String(value));\n\t\t\t}\n\t\t}\n\t}\n\n\ttelnyxLogger.debug(\"Telnyx API request\", {\n\t\tmethod: init?.method || \"GET\",\n\t\tpath,\n\t});\n\n\t// Create abort controller for timeout\n\tconst controller = new AbortController();\n\tconst timeout = init?.timeout ?? MESSAGING_CONFIG.requestTimeoutMs;\n\tconst timeoutId = setTimeout(() => controller.abort(), timeout);\n\n\ttry {\n\t\tconst response = await fetch(url, {\n\t\t\t...init,\n\t\t\theaders: {\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t\t...(init?.headers || {}),\n\t\t\t},\n\t\t\tsignal: controller.signal,\n\t\t});\n\n\t\tclearTimeout(timeoutId);\n\n\t\tconst data = await response.json();\n\n\t\tif (!response.ok) {\n\t\t\tconst detail = data?.errors?.[0]?.detail || response.statusText;\n\t\t\tconst errorCode = data?.errors?.[0]?.code;\n\t\t\ttelnyxLogger.error(\"Telnyx API error\", {\n\t\t\t\tstatus: response.status,\n\t\t\t\tdetail,\n\t\t\t\terrorCode,\n\t\t\t\tpath,\n\t\t\t});\n\t\t\tthrow new Error(`Telnyx ${response.status}: ${detail}`);\n\t\t}\n\n\t\treturn data as T;\n\t} catch (error) {\n\t\tclearTimeout(timeoutId);\n\n\t\tif (error instanceof Error && error.name === \"AbortError\") {\n\t\t\ttelnyxLogger.error(\"Telnyx API timeout\", {\n\t\t\t\tpath,\n\t\t\t\ttimeoutMs: timeout,\n\t\t\t});\n\t\t\tthrow new Error(`Request timeout after ${timeout}ms`);\n\t\t}\n\n\t\tthrow error;\n\t}\n}\n\nasync function telnyxMessageRequest(body: Record<string, unknown>) {\n\treturn telnyxRequest<{ data: TelnyxMessage }>(\"/messages\", {\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify(body),\n\t});\n}\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport type MessageType = \"SMS\" | \"MMS\";\n\nexport type MessageStatus =\n\t| \"queued\"\n\t| \"sending\"\n\t| \"sent\"\n\t| \"delivered\"\n\t| \"sending_failed\"\n\t| \"delivery_failed\"\n\t| \"delivery_unconfirmed\";\n\ninterface TelnyxMessage {\n\tid: string;\n\tstatus: MessageStatus;\n\ttype: MessageType;\n\tfrom: { phone_number: string };\n\tto: Array<{ phone_number: string; status: string }>;\n\ttext?: string;\n\tmedia?: Array<{ url: string; content_type: string }>;\n\tcreated_at: string;\n}\n\ninterface SendSMSParams {\n\tcompanyId: string;\n\tto: string;\n\tfrom: string;\n\ttext: string;\n\twebhookUrl?: string;\n\twebhookFailoverUrl?: string;\n\tuseProfileWebhooks?: boolean;\n\tmessagingProfileId?: string;\n\tskipRateLimit?: boolean;\n\tskip10DLCCheck?: boolean;\n}\n\ninterface SendSMSResult {\n\tsuccess: boolean;\n\tmessageId?: string;\n\tdata?: TelnyxMessage;\n\terror?: string;\n\twarnings?: string[];\n}\n\n// =============================================================================\n// 10DLC COMPLIANCE CHECK\n// =============================================================================\n\ninterface TenDLCStatus {\n\tisConfigured: boolean;\n\tbrandId?: string;\n\tcampaignId?: string;\n\tmessagingProfileId?: string;\n\twarnings: string[];\n}\n\n/**\n * Check 10DLC compliance status for a company\n *\n * As of December 2024, ALL US A2P SMS traffic MUST be registered with 10DLC.\n * Messages sent without proper registration may be filtered or blocked by carriers.\n */\nexport async function check10DLCStatus(companyId: string): Promise<TenDLCStatus> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tif (!supabase) {\n\t\t\treturn {\n\t\t\t\tisConfigured: false,\n\t\t\t\twarnings: [\"Database not available - cannot verify 10DLC status\"],\n\t\t\t};\n\t\t}\n\n\t\tconst { data: settings, error } = await supabase\n\t\t\t.from(\"company_telnyx_settings\")\n\t\t\t.select(\"ten_dlc_brand_id, ten_dlc_campaign_id, messaging_profile_id, status\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.maybeSingle();\n\n\t\tif (error) {\n\t\t\ttelnyxLogger.error(\"Failed to check 10DLC status\", {\n\t\t\t\tcompanyId,\n\t\t\t\terror: error.message,\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tisConfigured: false,\n\t\t\t\twarnings: [\"Failed to verify 10DLC status\"],\n\t\t\t};\n\t\t}\n\n\t\tif (!settings) {\n\t\t\treturn {\n\t\t\t\tisConfigured: false,\n\t\t\t\twarnings: [\"No Telnyx settings configured for company\"],\n\t\t\t};\n\t\t}\n\n\t\tconst warnings: string[] = [];\n\n\t\tif (!settings.ten_dlc_brand_id) {\n\t\t\twarnings.push(\"10DLC brand not registered - US SMS may be filtered\");\n\t\t}\n\n\t\tif (!settings.ten_dlc_campaign_id) {\n\t\t\twarnings.push(\"10DLC campaign not registered - US SMS may be filtered\");\n\t\t}\n\n\t\tif (!settings.messaging_profile_id) {\n\t\t\twarnings.push(\"Messaging profile not configured\");\n\t\t}\n\n\t\tconst isConfigured =\n\t\t\t!!settings.ten_dlc_brand_id &&\n\t\t\t!!settings.ten_dlc_campaign_id &&\n\t\t\t!!settings.messaging_profile_id;\n\n\t\treturn {\n\t\t\tisConfigured,\n\t\t\tbrandId: settings.ten_dlc_brand_id || undefined,\n\t\t\tcampaignId: settings.ten_dlc_campaign_id || undefined,\n\t\t\tmessagingProfileId: settings.messaging_profile_id || undefined,\n\t\t\twarnings,\n\t\t};\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"10DLC check error\", {\n\t\t\tcompanyId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\t\treturn {\n\t\t\tisConfigured: false,\n\t\t\twarnings: [\"Error checking 10DLC status\"],\n\t\t};\n\t}\n}\n\n// =============================================================================\n// RATE LIMITING\n// =============================================================================\n\n/**\n * Check and increment SMS rate limit for a company\n *\n * @returns true if under limit, false if rate limited\n */\nexport async function checkSMSRateLimit(\n\tcompanyId: string,\n\tidentifier = \"default\"\n): Promise<{ allowed: boolean; currentCount: number; limit: number }> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tif (!supabase) {\n\t\t\t// Allow in development without database\n\t\t\treturn {\n\t\t\t\tallowed: true,\n\t\t\t\tcurrentCount: 0,\n\t\t\t\tlimit: MESSAGING_CONFIG.defaultRateLimitPerMinute,\n\t\t\t};\n\t\t}\n\n\t\t// Use the database function for atomic increment\n\t\tconst { data, error } = await supabase.rpc(\"increment_rate_limit\", {\n\t\t\tp_company_id: companyId,\n\t\t\tp_resource: \"sms\",\n\t\t\tp_identifier: identifier,\n\t\t\tp_window_size_seconds: 60,\n\t\t});\n\n\t\tif (error) {\n\t\t\ttelnyxLogger.error(\"Rate limit check failed\", {\n\t\t\t\tcompanyId,\n\t\t\t\terror: error.message,\n\t\t\t});\n\t\t\t// Fail open on database errors\n\t\t\treturn {\n\t\t\t\tallowed: true,\n\t\t\t\tcurrentCount: 0,\n\t\t\t\tlimit: MESSAGING_CONFIG.defaultRateLimitPerMinute,\n\t\t\t};\n\t\t}\n\n\t\tconst result = data?.[0] || { current_count: 1 };\n\t\tconst currentCount = result.current_count as number;\n\t\tconst limit = MESSAGING_CONFIG.defaultRateLimitPerMinute;\n\t\tconst allowed = currentCount <= limit;\n\n\t\tif (!allowed) {\n\t\t\ttelnyxLogger.warn(\"SMS rate limit exceeded\", {\n\t\t\t\tcompanyId,\n\t\t\t\tcurrentCount,\n\t\t\t\tlimit,\n\t\t\t});\n\t\t}\n\n\t\treturn { allowed, currentCount, limit };\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"Rate limit error\", {\n\t\t\tcompanyId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\t\t// Fail open\n\t\treturn {\n\t\t\tallowed: true,\n\t\t\tcurrentCount: 0,\n\t\t\tlimit: MESSAGING_CONFIG.defaultRateLimitPerMinute,\n\t\t};\n\t}\n}\n\n// =============================================================================\n// SMS SENDING\n// =============================================================================\n\n/**\n * Send an SMS message with production-ready features\n *\n * Includes:\n * - 10DLC compliance verification\n * - Rate limiting per company\n * - Retry logic with exponential backoff\n * - Structured logging\n */\nexport async function sendSMS(params: SendSMSParams): Promise<SendSMSResult> {\n\tconst warnings: string[] = [];\n\n\ttry {\n\t\ttelnyxLogger.info(\"Sending SMS\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\tto: params.to.substring(0, 6) + \"****\", // Redact for logs\n\t\t\ttextLength: params.text.length,\n\t\t});\n\n\t\t// 1. Check 10DLC compliance (unless skipped)\n\t\tif (!params.skip10DLCCheck && MESSAGING_CONFIG.warnOn10DLCMissing) {\n\t\t\tconst tenDLCStatus = await check10DLCStatus(params.companyId);\n\n\t\t\tif (!tenDLCStatus.isConfigured) {\n\t\t\t\twarnings.push(...tenDLCStatus.warnings);\n\t\t\t\ttelnyxLogger.warn(\"SMS sent without 10DLC registration\", {\n\t\t\t\t\tcompanyId: params.companyId,\n\t\t\t\t\twarnings: tenDLCStatus.warnings,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Use company's messaging profile if not provided\n\t\t\tif (!params.messagingProfileId && tenDLCStatus.messagingProfileId) {\n\t\t\t\tparams.messagingProfileId = tenDLCStatus.messagingProfileId;\n\t\t\t}\n\t\t}\n\n\t\t// 2. Check rate limit (unless skipped)\n\t\tif (!params.skipRateLimit) {\n\t\t\tconst rateLimit = await checkSMSRateLimit(params.companyId);\n\n\t\t\tif (!rateLimit.allowed) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Rate limit exceeded: ${rateLimit.currentCount}/${rateLimit.limit} messages per minute`,\n\t\t\t\t\twarnings,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// 3. Send with retry logic\n\t\tconst result = await withRetry(\n\t\t\tasync () => {\n\t\t\t\tconst requestBody = {\n\t\t\t\t\tto: params.to,\n\t\t\t\t\tfrom: params.from,\n\t\t\t\t\ttext: params.text,\n\t\t\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\t\t\twebhook_url: params.webhookUrl,\n\t\t\t\t\twebhook_failover_url: params.webhookFailoverUrl,\n\t\t\t\t\tuse_profile_webhooks: params.useProfileWebhooks ?? true,\n\t\t\t\t};\n\n\t\t\t\treturn telnyxMessageRequest(requestBody);\n\t\t\t},\n\t\t\t{\n\t\t\t\tendpoint: \"messaging:send_sms\",\n\t\t\t\tconfig: {\n\t\t\t\t\tmaxRetries: 3,\n\t\t\t\t\tbaseDelayMs: 500,\n\t\t\t\t\tmaxDelayMs: 5000,\n\t\t\t\t},\n\t\t\t}\n\t\t);\n\n\t\ttelnyxLogger.info(\"SMS sent successfully\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\tmessageId: result.data.id,\n\t\t\tstatus: result.data.status,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.data.id,\n\t\t\tdata: result.data,\n\t\t\twarnings: warnings.length > 0 ? warnings : undefined,\n\t\t};\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"SMS send failed\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to send SMS\",\n\t\t\twarnings: warnings.length > 0 ? warnings : undefined,\n\t\t};\n\t}\n}\n\n/**\n * Send an MMS message with media attachments\n */\nexport async function sendMMS(params: {\n\tcompanyId: string;\n\tto: string;\n\tfrom: string;\n\ttext?: string;\n\tmediaUrls: string[];\n\twebhookUrl?: string;\n\twebhookFailoverUrl?: string;\n\tsubject?: string;\n\tmessagingProfileId?: string;\n}): Promise<SendSMSResult> {\n\ttry {\n\t\t// Check rate limit\n\t\tconst rateLimit = await checkSMSRateLimit(params.companyId);\n\t\tif (!rateLimit.allowed) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Rate limit exceeded: ${rateLimit.currentCount}/${rateLimit.limit} messages per minute`,\n\t\t\t};\n\t\t}\n\n\t\tconst result = await withRetry(\n\t\t\tasync () => {\n\t\t\t\treturn telnyxMessageRequest({\n\t\t\t\t\tto: params.to,\n\t\t\t\t\tfrom: params.from,\n\t\t\t\t\ttext: params.text,\n\t\t\t\t\tmedia_urls: params.mediaUrls,\n\t\t\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\t\t\twebhook_url: params.webhookUrl,\n\t\t\t\t\twebhook_failover_url: params.webhookFailoverUrl,\n\t\t\t\t\tsubject: params.subject,\n\t\t\t\t\ttype: \"MMS\",\n\t\t\t\t});\n\t\t\t},\n\t\t\t{\n\t\t\t\tendpoint: \"messaging:send_mms\",\n\t\t\t\tconfig: {\n\t\t\t\t\tmaxRetries: 3,\n\t\t\t\t\tbaseDelayMs: 500,\n\t\t\t\t},\n\t\t\t}\n\t\t);\n\n\t\ttelnyxLogger.info(\"MMS sent successfully\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\tmessageId: result.data.id,\n\t\t\tmediaCount: params.mediaUrls.length,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.data.id,\n\t\t\tdata: result.data,\n\t\t};\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"MMS send failed\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to send MMS\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// BULK SENDING (With Throttling)\n// =============================================================================\n\ninterface BulkSMSResult {\n\tsuccess: boolean;\n\ttotal: number;\n\tsuccessful: number;\n\tfailed: number;\n\tresults: Array<{ to: string; result: SendSMSResult }>;\n\terror?: string;\n}\n\n/**\n * Send bulk SMS with proper throttling and rate limiting\n *\n * Unlike naive Promise.all, this:\n * - Limits concurrent sends to prevent overwhelming the API\n * - Respects per-company rate limits\n * - Provides detailed per-recipient results\n */\nexport async function sendBulkSMS(params: {\n\tcompanyId: string;\n\tto: string[];\n\tfrom: string;\n\ttext: string;\n\twebhookUrl?: string;\n\tmessagingProfileId?: string;\n}): Promise<BulkSMSResult> {\n\tconst results: Array<{ to: string; result: SendSMSResult }> = [];\n\tlet successful = 0;\n\tlet failed = 0;\n\n\ttelnyxLogger.info(\"Starting bulk SMS\", {\n\t\tcompanyId: params.companyId,\n\t\trecipientCount: params.to.length,\n\t});\n\n\t// Process in batches to respect rate limits\n\tconst batchSize = MESSAGING_CONFIG.maxConcurrentSends;\n\n\tfor (let i = 0; i < params.to.length; i += batchSize) {\n\t\tconst batch = params.to.slice(i, i + batchSize);\n\n\t\tconst batchResults = await Promise.all(\n\t\t\tbatch.map(async (recipient) => {\n\t\t\t\tconst result = await sendSMS({\n\t\t\t\t\tcompanyId: params.companyId,\n\t\t\t\t\tto: recipient,\n\t\t\t\t\tfrom: params.from,\n\t\t\t\t\ttext: params.text,\n\t\t\t\t\twebhookUrl: params.webhookUrl,\n\t\t\t\t\tmessagingProfileId: params.messagingProfileId,\n\t\t\t\t\t// Skip 10DLC check for each message in bulk (already checked once)\n\t\t\t\t\tskip10DLCCheck: i > 0,\n\t\t\t\t});\n\n\t\t\t\treturn { to: recipient, result };\n\t\t\t})\n\t\t);\n\n\t\tfor (const r of batchResults) {\n\t\t\tresults.push(r);\n\t\t\tif (r.result.success) {\n\t\t\t\tsuccessful++;\n\t\t\t} else {\n\t\t\t\tfailed++;\n\t\t\t}\n\t\t}\n\n\t\t// Small delay between batches to smooth out rate limiting\n\t\tif (i + batchSize < params.to.length) {\n\t\t\tawait new Promise((resolve) => setTimeout(resolve, 100));\n\t\t}\n\t}\n\n\ttelnyxLogger.info(\"Bulk SMS completed\", {\n\t\tcompanyId: params.companyId,\n\t\ttotal: params.to.length,\n\t\tsuccessful,\n\t\tfailed,\n\t});\n\n\treturn {\n\t\tsuccess: failed === 0,\n\t\ttotal: params.to.length,\n\t\tsuccessful,\n\t\tfailed,\n\t\tresults,\n\t};\n}\n\n// =============================================================================\n// MESSAGE RETRIEVAL\n// =============================================================================\n\n/**\n * Retrieve message by ID\n */\nexport async function getMessage(messageId: string) {\n\ttry {\n\t\tconst message = await telnyxRequest<{ data: TelnyxMessage }>(\n\t\t\t`/messages/${messageId}`\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: message.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to retrieve message\",\n\t\t};\n\t}\n}\n\n/**\n * List messages with optional filtering\n */\nexport async function listMessages(params?: {\n\tpageSize?: number;\n\tpageNumber?: number;\n\tfilterFrom?: string;\n\tfilterTo?: string;\n\tfilterDirection?: \"inbound\" | \"outbound\";\n}) {\n\ttry {\n\t\tconst messages = await telnyxRequest<{\n\t\t\tdata: TelnyxMessage[];\n\t\t\tmeta: { total_pages: number; total_results: number };\n\t\t}>(\"/messages\", {\n\t\t\tquery: {\n\t\t\t\t\"page[size]\": params?.pageSize ?? 20,\n\t\t\t\t\"page[number]\": params?.pageNumber ?? 1,\n\t\t\t\t\"filter[from]\": params?.filterFrom,\n\t\t\t\t\"filter[to]\": params?.filterTo,\n\t\t\t\t\"filter[direction]\": params?.filterDirection,\n\t\t\t},\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: messages.data,\n\t\t\tmeta: messages.meta,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to list messages\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// UTILITIES\n// =============================================================================\n\n/**\n * Validate a phone number for SMS capability\n */\nexport function validatePhoneNumber(phoneNumber: string): {\n\tsuccess: boolean;\n\tformattedNumber?: string;\n\terror?: string;\n} {\n\ttry {\n\t\t// Remove any formatting from phone number\n\t\tconst cleanNumber = phoneNumber.replace(/\\D/g, \"\");\n\n\t\t// Check if it's a valid length (10-15 digits)\n\t\tif (cleanNumber.length < 10 || cleanNumber.length > 15) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Invalid phone number length (must be 10-15 digits)\",\n\t\t\t};\n\t\t}\n\n\t\t// Format to E.164\n\t\tconst formattedNumber = formatPhoneNumber(cleanNumber);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tformattedNumber,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to validate phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Format phone number to E.164 standard (+15551234567)\n */\nexport function formatPhoneNumber(phoneNumber: string): string {\n\t// Remove all non-digit characters except leading +\n\tconst digits = phoneNumber.replace(/[^\\d+]/g, \"\").replace(/(?!^)\\+/g, \"\");\n\n\t// Already has + prefix\n\tif (digits.startsWith(\"+\")) {\n\t\treturn digits;\n\t}\n\n\t// If it starts with 1 and is 11 digits, it's a US number\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn `+${digits}`;\n\t}\n\n\t// If it's 10 digits, assume US and add +1\n\tif (digits.length === 10) {\n\t\treturn `+1${digits}`;\n\t}\n\n\t// Otherwise, add + prefix\n\treturn `+${digits}`;\n}\n\n/**\n * Check if a phone number is a US number\n */\nexport function isUSPhoneNumber(phoneNumber: string): boolean {\n\tconst formatted = formatPhoneNumber(phoneNumber);\n\treturn formatted.startsWith(\"+1\") && formatted.length === 12;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2187, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/messaging-profile-setup.ts"],"sourcesContent":["/**\n * Messaging Profile Setup & Verification\n *\n * Verifies messaging profile configuration and can auto-update webhook URLs.\n */\n\nimport { TELNYX_CONFIG, telnyxClient } from \"./client\";\n\nexport type MessagingProfileStatus = {\n\texists: boolean;\n\tisActive: boolean;\n\thasWebhookUrl: boolean;\n\twebhookUrl: string | null;\n\twebhookFailoverUrl: string | null;\n\twebhookApiVersion: string | null;\n\tneedsFix: boolean;\n\tissues: string[];\n};\n\nexport type MessagingProfileFixResult = {\n\tsuccess: boolean;\n\tfixed: boolean;\n\terror?: string;\n\tchanges: string[];\n};\n\nfunction getWebhookUrl(): string | undefined {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\t\n\tconst isDevelopment = \n\t\tprocess.env.NODE_ENV === \"development\" ||\n\t\tprocess.env.VERCEL_ENV !== \"production\" ||\n\t\tprocess.env.DEPLOYMENT_ENV !== \"production\";\n\t\n\tfor (const candidate of candidates) {\n\t\tif (candidate && candidate.trim()) {\n\t\t\tconst trimmed = candidate.trim();\n\t\t\tconst isLocal =\n\t\t\t\ttrimmed.includes(\"localhost\") ||\n\t\t\t\ttrimmed.includes(\"127.0.0.1\") ||\n\t\t\t\ttrimmed.includes(\"0.0.0.0\");\n\t\t\t\n\t\t\t// In development, allow localhost URLs (useful for testing with ngrok or similar)\n\t\t\t// In production, reject localhost\n\t\t\tif (isLocal && !isDevelopment) {\n\t\t\t\tcontinue; // Skip localhost in production\n\t\t\t}\n\t\t\t\n\t\t\tconst normalized = trimmed.startsWith(\"http\")\n\t\t\t\t? trimmed\n\t\t\t\t: `https://${trimmed}`;\n\t\t\treturn `${normalized.replace(/\\/+$/, \"\")}/api/webhooks/telnyx`;\n\t\t}\n\t}\n\treturn undefined;\n}\n\n/**\n * Verify messaging profile configuration\n */\nexport async function verifyMessagingProfile(\n\tmessagingProfileId?: string,\n): Promise<MessagingProfileStatus> {\n\tconst profileId = messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\n\tconst status: MessagingProfileStatus = {\n\t\texists: false,\n\t\tisActive: false,\n\t\thasWebhookUrl: false,\n\t\twebhookUrl: null,\n\t\twebhookFailoverUrl: null,\n\t\twebhookApiVersion: null,\n\t\tneedsFix: false,\n\t\tissues: [],\n\t};\n\n\tif (!profileId || profileId.trim() === \"\") {\n\t\tstatus.issues.push(\"Messaging profile ID is not configured\");\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n\n\ttry {\n\t\tconst profile = await telnyxClient.messagingProfiles.retrieve(profileId);\n\t\tconst profileData = profile.data as any;\n\n\t\tif (!profileData) {\n\t\t\tstatus.issues.push(`Messaging profile ${profileId} not found in Telnyx`);\n\t\t\tstatus.needsFix = true;\n\t\t\treturn status;\n\t\t}\n\n\t\tstatus.exists = true;\n\t\tstatus.isActive = profileData.enabled !== false;\n\t\tstatus.webhookUrl = profileData.webhook_url || null;\n\t\tstatus.webhookFailoverUrl = profileData.webhook_failover_url || null;\n\t\tstatus.webhookApiVersion = profileData.webhook_api_version || null;\n\n\t\t// Check webhook URL\n\t\tconst expectedWebhookUrl = getWebhookUrl();\n\t\tif (!expectedWebhookUrl) {\n\t\t\tconst isDevelopment = \n\t\t\t\tprocess.env.NODE_ENV === \"development\" ||\n\t\t\t\tprocess.env.VERCEL_ENV !== \"production\" ||\n\t\t\t\tprocess.env.DEPLOYMENT_ENV !== \"production\";\n\t\t\t\n\t\t\tif (isDevelopment) {\n\t\t\t\tstatus.issues.push(\n\t\t\t\t\t\"NEXT_PUBLIC_SITE_URL is not set. Set it to your production URL (e.g., https://yourdomain.com) or use a tool like ngrok for local testing.\",\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tstatus.issues.push(\n\t\t\t\t\t\"NEXT_PUBLIC_SITE_URL is not set to a valid production URL. Set it to your production domain (e.g., https://yourdomain.com) in your environment variables.\",\n\t\t\t\t);\n\t\t\t}\n\t\t\tstatus.needsFix = true;\n\t\t} else if (!status.webhookUrl) {\n\t\t\tstatus.issues.push(\n\t\t\t\t`Webhook URL is not set. Expected: ${expectedWebhookUrl} (with optional ?company=... for multi-tenant)`,\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t} else {\n\t\t\t// Accept both base webhook URL and company-specific URLs (with query params)\n\t\t\tconst baseUrl = status.webhookUrl.split(\"?\")[0];\n\t\t\tif (\n\t\t\t\tbaseUrl === expectedWebhookUrl ||\n\t\t\t\tstatus.webhookUrl === expectedWebhookUrl\n\t\t\t) {\n\t\t\t\tstatus.hasWebhookUrl = true;\n\t\t\t} else {\n\t\t\t\tstatus.issues.push(\n\t\t\t\t\t`Webhook URL base is not set correctly. Expected: ${expectedWebhookUrl}, Current: ${baseUrl}`,\n\t\t\t\t);\n\t\t\t\tstatus.needsFix = true;\n\t\t\t}\n\t\t}\n\n\t\t// Check webhook API version\n\t\tif (status.webhookApiVersion !== \"2\") {\n\t\t\tstatus.issues.push(\n\t\t\t\t`Webhook API version should be \"2\", but is \"${status.webhookApiVersion || \"not set\"}\"`,\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\t// Check if profile is active\n\t\tif (!status.isActive) {\n\t\t\tstatus.issues.push(\"Messaging profile is not enabled\");\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\treturn status;\n\t} catch (error: any) {\n\t\tif (error?.statusCode === 404) {\n\t\t\tstatus.issues.push(`Messaging profile ${profileId} not found in Telnyx`);\n\t\t} else {\n\t\t\tstatus.issues.push(\n\t\t\t\terror?.message || \"Failed to retrieve messaging profile\",\n\t\t\t);\n\t\t}\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n}\n\n/**\n * Auto-fix messaging profile configuration\n */\nexport async function fixMessagingProfile(\n\tmessagingProfileId?: string,\n\toptions?: {\n\t\twebhookUrl?: string;\n\t\twebhookFailoverUrl?: string;\n\t},\n): Promise<MessagingProfileFixResult> {\n\tconst profileId = messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\tconst changes: string[] = [];\n\n\tif (!profileId || profileId.trim() === \"\") {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: \"Messaging profile ID is not configured\",\n\t\t\tchanges: [],\n\t\t};\n\t}\n\n\ttry {\n\t\t// Get current status\n\t\tconst status = await verifyMessagingProfile(profileId);\n\t\tif (!status.needsFix) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tfixed: false,\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Get expected webhook URL\n\t\tconst expectedWebhookUrl = options?.webhookUrl || getWebhookUrl();\n\t\tif (!expectedWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tfixed: false,\n\t\t\t\terror:\n\t\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be set to a valid production URL to configure webhooks\",\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Prepare update\n\t\tconst updateData: Record<string, unknown> = {};\n\n\t\t// Fix webhook URL\n\t\tif (status.webhookUrl !== expectedWebhookUrl) {\n\t\t\tupdateData.webhook_url = expectedWebhookUrl;\n\t\t\tchanges.push(`Updated webhook URL to ${expectedWebhookUrl}`);\n\t\t}\n\n\t\t// Fix webhook failover URL\n\t\tconst expectedFailoverUrl =\n\t\t\toptions?.webhookFailoverUrl ||\n\t\t\tprocess.env.TELNYX_WEBHOOK_FAILOVER_URL ||\n\t\t\tnull;\n\t\tif (status.webhookFailoverUrl !== expectedFailoverUrl) {\n\t\t\tupdateData.webhook_failover_url = expectedFailoverUrl;\n\t\t\tif (expectedFailoverUrl) {\n\t\t\t\tchanges.push(`Updated webhook failover URL to ${expectedFailoverUrl}`);\n\t\t\t} else {\n\t\t\t\tchanges.push(\"Removed webhook failover URL\");\n\t\t\t}\n\t\t}\n\n\t\t// Fix webhook API version\n\t\tif (status.webhookApiVersion !== \"2\") {\n\t\t\tupdateData.webhook_api_version = \"2\";\n\t\t\tchanges.push(\"Updated webhook API version to 2\");\n\t\t}\n\n\t\t// Fix profile enabled status\n\t\tif (!status.isActive) {\n\t\t\tupdateData.enabled = true;\n\t\t\tchanges.push(\"Enabled messaging profile\");\n\t\t}\n\n\t\t// Apply updates if needed\n\t\tif (Object.keys(updateData).length > 0) {\n\t\t\tawait telnyxClient.messagingProfiles.update(profileId, updateData);\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tfixed: changes.length > 0,\n\t\t\tchanges,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: error?.message || \"Failed to update messaging profile\",\n\t\t\tchanges,\n\t\t};\n\t}\n}\n\n/**\n * Get messaging profile details\n */\nasync function getMessagingProfileDetails(\n\tmessagingProfileId?: string,\n): Promise<{\n\tsuccess: boolean;\n\tdata?: any;\n\terror?: string;\n}> {\n\tconst profileId = messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\n\tif (!profileId || profileId.trim() === \"\") {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Messaging profile ID is not configured\",\n\t\t};\n\t}\n\n\ttry {\n\t\tconst profile = await telnyxClient.messagingProfiles.retrieve(profileId);\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: profile.data,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error?.message || \"Failed to retrieve messaging profile\",\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2398, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/numbers.ts"],"sourcesContent":["/**\n * Telnyx Phone Numbers Service - Number Management\n *\n * Handles all phone number operations including:\n * - Searching available numbers\n * - Purchasing numbers\n * - Porting numbers\n * - Configuring number settings\n * - Releasing numbers\n */\n\nimport { telnyxClient } from \"./client\";\n\n/**\n * Number type for search\n */\nexport type NumberType =\n\t| \"local\"\n\t| \"toll-free\"\n\t| \"national\"\n\t| \"mobile\"\n\t| \"shared_cost\";\n\n/**\n * Number features\n */\nexport type NumberFeature = \"sms\" | \"mms\" | \"voice\" | \"fax\";\n\n/**\n * Search for available phone numbers\n */\nexport async function searchAvailableNumbers(params: {\n\tcountryCode?: string;\n\tareaCode?: string;\n\tnumberType?: NumberType;\n\tfeatures?: NumberFeature[];\n\tlimit?: number;\n\tstartsWith?: string;\n\tendsWith?: string;\n\tcontains?: string;\n}) {\n\ttry {\n\t\tconst numbers = await (telnyxClient.availablePhoneNumbers as any).list({\n\t\t\tfilter: {\n\t\t\t\tcountry_code: params.countryCode || \"US\",\n\t\t\t\tnational_destination_code: params.areaCode,\n\t\t\t\tfeatures: params.features,\n\t\t\t\tlimit: params.limit || 10,\n\t\t\t\tstarts_with: params.startsWith,\n\t\t\t\tends_with: params.endsWith,\n\t\t\t\tcontains: params.contains,\n\t\t\t} as any,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: numbers.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to search numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Purchase a phone number\n */\nexport async function purchaseNumber(params: {\n\tphoneNumber: string;\n\tmessagingProfileId?: string;\n\tconnectionId?: string;\n\tbillingGroupId?: string;\n\tcustomerReference?: string;\n}) {\n\ttry {\n\t\tconst number = await telnyxClient.numberOrders.create({\n\t\t\tphone_numbers: [\n\t\t\t\t{\n\t\t\t\t\tphone_number: params.phoneNumber,\n\t\t\t\t},\n\t\t\t],\n\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\tconnection_id: params.connectionId,\n\t\t\tbilling_group_id: params.billingGroupId,\n\t\t\tcustomer_reference: params.customerReference,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\torderId: number.data?.id,\n\t\t\tdata: number.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to purchase number\",\n\t\t};\n\t}\n}\n\n/**\n * List all owned phone numbers\n */\nexport async function listOwnedNumbers(params?: {\n\tpageSize?: number;\n\tpageNumber?: number;\n\tfilterTag?: string;\n\tfilterStatus?: \"active\" | \"pending\" | \"suspended\" | \"deleted\";\n}) {\n\ttry {\n\t\tconst numbers = await (telnyxClient.phoneNumbers as any).list({\n\t\t\tpage: {\n\t\t\t\tsize: params?.pageSize || 20,\n\t\t\t\tnumber: params?.pageNumber || 1,\n\t\t\t},\n\t\t\tfilter: {\n\t\t\t\ttag: params?.filterTag,\n\t\t\t\tstatus: params?.filterStatus,\n\t\t\t} as any,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: numbers.data,\n\t\t\tmeta: numbers.meta,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to list numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Get phone number details\n */\nexport async function getNumberDetails(phoneNumberId: string) {\n\ttry {\n\t\tconst number = await (telnyxClient.phoneNumbers as any).retrieve(\n\t\t\tphoneNumberId,\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: number.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to retrieve number\",\n\t\t};\n\t}\n}\n\n/**\n * Update phone number configuration\n */\nexport async function updateNumber(params: {\n\tphoneNumberId: string;\n\tconnectionId?: string;\n\tmessagingProfileId?: string;\n\tbillingGroupId?: string;\n\ttags?: string[];\n\tcustomerReference?: string;\n}) {\n\ttry {\n\t\tconst number = await (telnyxClient.phoneNumbers as any).update(\n\t\t\tparams.phoneNumberId,\n\t\t\t{\n\t\t\t\tconnection_id: params.connectionId,\n\t\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\t\tbilling_group_id: params.billingGroupId,\n\t\t\t\ttags: params.tags,\n\t\t\t\tcustomer_reference: params.customerReference,\n\t\t\t} as any,\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: number.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to update number\",\n\t\t};\n\t}\n}\n\n/**\n * Release (delete) a phone number\n */\nexport async function releaseNumber(phoneNumberId: string) {\n\ttry {\n\t\tawait (telnyxClient.phoneNumbers as any).del(phoneNumberId);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to release number\",\n\t\t};\n\t}\n}\n\n/**\n * Initiate number porting request\n */\nexport async function initiatePorting(params: {\n\tphoneNumbers: string[];\n\tbillingGroupId?: string;\n\tfastPortEligible?: boolean;\n\t// Account information\n\taccountNumber?: string;\n\taccountPin?: string;\n\tauthorizedPerson?: string;\n\t// Service address\n\taddressLine1?: string;\n\tcity?: string;\n\tstateOrProvince?: string;\n\tzipOrPostalCode?: string;\n\tcountryCode?: string;\n}) {\n\ttry {\n\t\tconst portingOrder = await (telnyxClient as any).numberPortouts.create({\n\t\t\tphone_numbers: params.phoneNumbers,\n\t\t\tbilling_group_id: params.billingGroupId,\n\t\t\tfast_port_eligible: params.fastPortEligible,\n\t\t\tcustomer_reference: {\n\t\t\t\taccount_number: params.accountNumber,\n\t\t\t\taccount_pin: params.accountPin,\n\t\t\t\tauthorized_person: params.authorizedPerson,\n\t\t\t},\n\t\t\tservice_address: {\n\t\t\t\taddress_line_1: params.addressLine1,\n\t\t\t\tcity: params.city,\n\t\t\t\tstate_or_province: params.stateOrProvince,\n\t\t\t\tzip_or_postal_code: params.zipOrPostalCode,\n\t\t\t\tcountry_code: params.countryCode || \"US\",\n\t\t\t},\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tportingOrderId: portingOrder.data.id,\n\t\t\tdata: portingOrder.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to initiate porting\",\n\t\t};\n\t}\n}\n\n/**\n * Get porting order status\n */\nasync function getPortingStatus(portingOrderId: string) {\n\ttry {\n\t\tconst order = await (telnyxClient as any).numberPortouts.retrieve(\n\t\t\tportingOrderId,\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tstatus: order.data.status,\n\t\t\tdata: order.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get porting status\",\n\t\t};\n\t}\n}\n\n/**\n * Estimate number costs\n */\nasync function estimateNumberCost(params: {\n\tcountryCode: string;\n\tnumberType: NumberType;\n}) {\n\t// Cost estimates based on Telnyx pricing (as of 2025)\n\tconst costs = {\n\t\tUS: {\n\t\t\tlocal: { monthly: 1.0, setup: 0.0 },\n\t\t\t\"toll-free\": { monthly: 2.0, setup: 0.0 },\n\t\t\tmobile: { monthly: 5.0, setup: 0.0 },\n\t\t},\n\t\tCA: {\n\t\t\tlocal: { monthly: 1.5, setup: 0.0 },\n\t\t\t\"toll-free\": { monthly: 2.5, setup: 0.0 },\n\t\t},\n\t\tGB: {\n\t\t\tlocal: { monthly: 2.0, setup: 0.0 },\n\t\t\t\"toll-free\": { monthly: 3.0, setup: 0.0 },\n\t\t},\n\t};\n\n\tconst countryCode = params.countryCode.toUpperCase();\n\tconst pricing = costs[countryCode as keyof typeof costs];\n\n\tif (!pricing) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: `Pricing not available for country: ${countryCode}`,\n\t\t};\n\t}\n\n\tconst typePricing = pricing[params.numberType as keyof typeof pricing];\n\n\tif (!typePricing) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: `Number type ${params.numberType} not available in ${countryCode}`,\n\t\t};\n\t}\n\n\treturn {\n\t\tsuccess: true,\n\t\tcosts: {\n\t\t\tmonthly: typePricing.monthly,\n\t\t\tsetup: typePricing.setup,\n\t\t\tcurrency: \"USD\",\n\t\t},\n\t};\n}\n\n/**\n * Validate if a number can be ported\n */\nasync function validatePortability(phoneNumber: string) {\n\ttry {\n\t\t// This would typically call Telnyx's LNP (Local Number Portability) check API\n\t\t// For now, we'll do basic validation\n\n\t\tconst cleanNumber = phoneNumber.replace(/\\D/g, \"\");\n\n\t\t// Must be at least 10 digits\n\t\tif (cleanNumber.length < 10) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tportable: false,\n\t\t\t\treason: \"Phone number must be at least 10 digits\",\n\t\t\t};\n\t\t}\n\n\t\t// In a real implementation, you would check with Telnyx's LNP API\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tportable: true,\n\t\t\testimatedPortingDays: 7, // Typical porting timeline\n\t\t\tfastPortEligible: false,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to validate portability\",\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2690, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/phone-number-setup.ts"],"sourcesContent":["/**\n * Phone Number Setup & Verification\n *\n * Verifies phone numbers are properly configured in Telnyx and can auto-fix issues.\n */\n\nimport { TELNYX_CONFIG } from \"./client\";\nimport {\n\tgetNumberDetails,\n\tlistOwnedNumbers,\n\ttype NumberFeature,\n\tupdateNumber,\n} from \"./numbers\";\n\nexport type PhoneNumberStatus = {\n\texists: boolean;\n\thasMessagingProfile: boolean;\n\thasConnection: boolean;\n\tcapabilities: {\n\t\tsms: boolean;\n\t\tvoice: boolean;\n\t\tmms: boolean;\n\t};\n\tneedsFix: boolean;\n\tissues: string[];\n};\n\nexport type PhoneNumberFixResult = {\n\tsuccess: boolean;\n\tfixed: boolean;\n\terror?: string;\n\tchanges: string[];\n};\n\n/**\n * Find phone number ID by phone number string\n */\nasync function findPhoneNumberId(\n\tphoneNumber: string,\n): Promise<{ success: boolean; phoneNumberId?: string; error?: string }> {\n\ttry {\n\t\t// Normalize phone number (E.164 format)\n\t\tconst normalized = phoneNumber.replace(/\\D/g, \"\");\n\t\tconst e164 = normalized.startsWith(\"+\")\n\t\t\t? phoneNumber\n\t\t\t: normalized.startsWith(\"1\") && normalized.length === 11\n\t\t\t\t? `+${normalized}`\n\t\t\t\t: `+1${normalized}`;\n\n\t\t// List all owned numbers and find matching one\n\t\tconst result = await listOwnedNumbers({ pageSize: 100 });\n\t\tif (!result.success || !result.data) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Failed to list phone numbers from Telnyx\",\n\t\t\t};\n\t\t}\n\n\t\tconst numbers = Array.isArray(result.data) ? result.data : [result.data];\n\t\tconst matching = numbers.find(\n\t\t\t(num: any) =>\n\t\t\t\tnum.phone_number === e164 ||\n\t\t\t\tnum.phone_number === phoneNumber ||\n\t\t\t\tnum.phone_number?.replace(/\\D/g, \"\") === normalized,\n\t\t);\n\n\t\tif (!matching) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Phone number ${phoneNumber} not found in Telnyx account`,\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tphoneNumberId: matching.id,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to find phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Verify phone number configuration\n */\nexport async function verifyPhoneNumber(\n\tphoneNumber: string,\n): Promise<PhoneNumberStatus> {\n\tconst status: PhoneNumberStatus = {\n\t\texists: false,\n\t\thasMessagingProfile: false,\n\t\thasConnection: false,\n\t\tcapabilities: {\n\t\t\tsms: false,\n\t\t\tvoice: false,\n\t\t\tmms: false,\n\t\t},\n\t\tneedsFix: false,\n\t\tissues: [],\n\t};\n\n\ttry {\n\t\t// Find phone number ID\n\t\tconst findResult = await findPhoneNumberId(phoneNumber);\n\t\tif (!findResult.success || !findResult.phoneNumberId) {\n\t\t\tstatus.issues.push(\n\t\t\t\tfindResult.error || \"Phone number not found in Telnyx\",\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t\treturn status;\n\t\t}\n\n\t\tstatus.exists = true;\n\n\t\t// Get phone number details\n\t\tconst detailsResult = await getNumberDetails(findResult.phoneNumberId);\n\t\tif (!detailsResult.success || !detailsResult.data) {\n\t\t\tstatus.issues.push(\"Failed to retrieve phone number details\");\n\t\t\tstatus.needsFix = true;\n\t\t\treturn status;\n\t\t}\n\n\t\tconst numberData = detailsResult.data as any;\n\n\t\t// Check messaging profile\n\t\tif (numberData.messaging_profile_id) {\n\t\t\tstatus.hasMessagingProfile = true;\n\t\t} else {\n\t\t\tstatus.issues.push(\n\t\t\t\t\"Phone number is not associated with a messaging profile\",\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\t// Check connection\n\t\tif (numberData.connection_id) {\n\t\t\tstatus.hasConnection = true;\n\t\t} else {\n\t\t\tstatus.issues.push(\"Phone number is not associated with a connection\");\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\t// Check capabilities from phone number features\n\t\tconst features = (numberData.features || []) as string[];\n\t\tconst hasFeaturesSms = features.includes(\"sms\");\n\t\tconst hasFeaturesVoice = features.includes(\"voice\");\n\t\tconst hasFeaturesMms = features.includes(\"mms\");\n\n\t\t// Also check messaging settings endpoint for SMS/MMS status\n\t\tlet messagingEnabled = false;\n\t\ttry {\n\t\t\tconst TELNYX_API_KEY = process.env.TELNYX_API_KEY;\n\t\t\tif (TELNYX_API_KEY) {\n\t\t\t\tconst messagingResponse = await fetch(\n\t\t\t\t\t`https://api.telnyx.com/v2/phone_numbers/${findResult.phoneNumberId}/messaging`,\n\t\t\t\t\t{\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\tAuthorization: `Bearer ${TELNYX_API_KEY}`,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tif (messagingResponse.ok) {\n\t\t\t\t\tconst messagingData = await messagingResponse.json();\n\t\t\t\t\tconst messagingFeatures = messagingData?.data?.features;\n\t\t\t\t\tif (\n\t\t\t\t\t\tmessagingFeatures?.sms?.domestic_two_way ||\n\t\t\t\t\t\tmessagingFeatures?.mms?.domestic_two_way\n\t\t\t\t\t) {\n\t\t\t\t\t\tmessagingEnabled = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\t// Ignore errors - fall back to features check\n\t\t}\n\n\t\t// Consider SMS enabled if either features include it OR messaging settings confirm it\n\t\tstatus.capabilities.sms = hasFeaturesSms || messagingEnabled;\n\t\tstatus.capabilities.voice = hasFeaturesVoice;\n\t\tstatus.capabilities.mms = hasFeaturesMms || messagingEnabled;\n\n\t\tif (!status.capabilities.sms) {\n\t\t\tstatus.issues.push(\"Phone number does not have SMS capability\");\n\t\t}\n\t\tif (!status.capabilities.voice) {\n\t\t\tstatus.issues.push(\"Phone number does not have voice capability\");\n\t\t}\n\n\t\treturn status;\n\t} catch (error) {\n\t\tstatus.issues.push(\n\t\t\terror instanceof Error ? error.message : \"Unknown error\",\n\t\t);\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n}\n\n/**\n * Auto-fix phone number configuration\n */\nexport async function fixPhoneNumber(\n\tphoneNumber: string,\n\toptions?: {\n\t\tmessagingProfileId?: string;\n\t\tconnectionId?: string;\n\t},\n): Promise<PhoneNumberFixResult> {\n\tconst changes: string[] = [];\n\n\ttry {\n\t\t// Find phone number ID\n\t\tconst findResult = await findPhoneNumberId(phoneNumber);\n\t\tif (!findResult.success || !findResult.phoneNumberId) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tfixed: false,\n\t\t\t\terror: findResult.error || \"Phone number not found\",\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Get current status\n\t\tconst status = await verifyPhoneNumber(phoneNumber);\n\t\tif (!status.needsFix) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tfixed: false,\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Prepare update parameters\n\t\tconst updateParams: {\n\t\t\tphoneNumberId: string;\n\t\t\tmessagingProfileId?: string;\n\t\t\tconnectionId?: string;\n\t\t} = {\n\t\t\tphoneNumberId: findResult.phoneNumberId,\n\t\t};\n\n\t\t// Fix messaging profile\n\t\tif (!status.hasMessagingProfile) {\n\t\t\tconst messagingProfileId =\n\t\t\t\toptions?.messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\t\t\tif (messagingProfileId) {\n\t\t\t\tupdateParams.messagingProfileId = messagingProfileId;\n\t\t\t\tchanges.push(\n\t\t\t\t\t`Assigned messaging profile ${messagingProfileId} to phone number`,\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tfixed: false,\n\t\t\t\t\terror:\n\t\t\t\t\t\t\"Messaging profile ID is required but not configured. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID.\",\n\t\t\t\t\tchanges: [],\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Fix connection\n\t\tif (!status.hasConnection) {\n\t\t\tconst connectionId = options?.connectionId || TELNYX_CONFIG.connectionId;\n\t\t\tif (connectionId) {\n\t\t\t\tupdateParams.connectionId = connectionId;\n\t\t\t\tchanges.push(`Assigned connection ${connectionId} to phone number`);\n\t\t\t} else {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tfixed: false,\n\t\t\t\t\terror:\n\t\t\t\t\t\t\"Connection ID is required but not configured. Set NEXT_PUBLIC_TELNYX_CONNECTION_ID.\",\n\t\t\t\t\tchanges: [],\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Apply updates if needed\n\t\tif (updateParams.messagingProfileId || updateParams.connectionId) {\n\t\t\tconst updateResult = await updateNumber(updateParams);\n\t\t\tif (!updateResult.success) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tfixed: false,\n\t\t\t\t\terror: updateResult.error || \"Failed to update phone number\",\n\t\t\t\t\tchanges,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tfixed: changes.length > 0,\n\t\t\tchanges,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\tchanges,\n\t\t};\n\t}\n}\n\n/**\n * Verify phone number has SMS capability\n */\nexport async function verifySmsCapability(\n\tphoneNumber: string,\n): Promise<{ hasSms: boolean; error?: string }> {\n\tconst status = await verifyPhoneNumber(phoneNumber);\n\n\tif (!status.exists) {\n\t\treturn {\n\t\t\thasSms: false,\n\t\t\terror: \"Phone number not found in Telnyx\",\n\t\t};\n\t}\n\n\tif (!status.capabilities.sms) {\n\t\treturn {\n\t\t\thasSms: false,\n\t\t\terror: \"Phone number does not have SMS capability\",\n\t\t};\n\t}\n\n\tif (!status.hasMessagingProfile) {\n\t\treturn {\n\t\t\thasSms: false,\n\t\t\terror: \"Phone number is not associated with a messaging profile\",\n\t\t};\n\t}\n\n\treturn { hasSms: true };\n}\n\n/**\n * Verify phone number has voice capability\n */\nexport async function verifyVoiceCapability(\n\tphoneNumber: string,\n): Promise<{ hasVoice: boolean; error?: string }> {\n\tconst status = await verifyPhoneNumber(phoneNumber);\n\n\tif (!status.exists) {\n\t\treturn {\n\t\t\thasVoice: false,\n\t\t\terror: \"Phone number not found in Telnyx\",\n\t\t};\n\t}\n\n\tif (!status.capabilities.voice) {\n\t\treturn {\n\t\t\thasVoice: false,\n\t\t\terror: \"Phone number does not have voice capability\",\n\t\t};\n\t}\n\n\tif (!status.hasConnection) {\n\t\treturn {\n\t\t\thasVoice: false,\n\t\t\terror: \"Phone number is not associated with a connection\",\n\t\t};\n\t}\n\n\treturn { hasVoice: true };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2967, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/provision-company.ts"],"sourcesContent":["import type { SupabaseClient } from \"@supabase/supabase-js\";\nimport type { Database } from \"@/types/supabase\";\nimport { telnyxClient } from \"./client\";\nimport {\n\ttype NumberFeature,\n\ttype NumberType,\n\tpurchaseNumber,\n\tsearchAvailableNumbers,\n} from \"./numbers\";\n\nexport type CompanyTelnyxSettingsRow = {\n\tcompany_id: string;\n\tstatus: string;\n\tmessaging_profile_id: string | null;\n\tcall_control_application_id: string | null;\n\tdefault_outbound_number: string | null;\n\tdefault_outbound_phone_number_id: string | null;\n\tten_dlc_brand_id: string | null;\n\tten_dlc_campaign_id: string | null;\n\twebhook_secret: string | null;\n\tmetadata: Record<string, unknown> | null;\n\tlast_provisioned_at: string | null;\n\tcreated_at: string | null;\n\tupdated_at: string | null;\n};\n\ntype TypedSupabaseClient = SupabaseClient<Database>;\n\ntype ProvisionOptions = {\n\tcompanyId: string;\n\tsupabase: TypedSupabaseClient;\n\tareaCode?: string;\n\tnumberQuantity?: number;\n\tfeatures?: NumberFeature[];\n};\n\nconst DEFAULT_FEATURES: NumberFeature[] = [\"sms\", \"mms\", \"voice\"];\nconst COMPANY_SETTINGS_TABLE = \"company_telnyx_settings\";\n\nasync function getBaseAppUrl(): Promise<string | undefined> {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\n\tfor (const candidate of candidates) {\n\t\tif (!candidate) continue;\n\t\tconst trimmed = candidate.trim();\n\t\tif (!trimmed) continue;\n\t\tconst isLocal = /localhost|127\\.0\\.0\\.1|0\\.0\\.0\\.0/i.test(trimmed);\n\t\tif (isLocal) {\n\t\t\tcontinue;\n\t\t}\n\t\tif (trimmed.startsWith(\"http\")) {\n\t\t\treturn trimmed.replace(/\\/+$/, \"\");\n\t\t}\n\t\treturn `https://${trimmed.replace(/\\/+$/, \"\")}`;\n\t}\n\n\treturn undefined;\n}\n\nasync function buildCompanyWebhookUrl(\n\tcompanyId: string,\n): Promise<string | undefined> {\n\tconst base = await getBaseAppUrl();\n\tif (!base) {\n\t\treturn undefined;\n\t}\n\treturn `${base}/api/webhooks/telnyx?company=${companyId}`;\n}\n\nfunction formatDisplay(phoneNumber: string): string {\n\tconst digits = phoneNumber.replace(/[^0-9]/g, \"\");\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn `(${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;\n\t}\n\tif (digits.length === 10) {\n\t\treturn `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;\n\t}\n\treturn phoneNumber;\n}\n\ntype ProvisionResult = {\n\tsuccess: boolean;\n\tsettings?: CompanyTelnyxSettingsRow;\n\terror?: string;\n\tlog: string[];\n};\n\nasync function ensurePhoneNumbersInserted(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n\tphoneNumbers: Array<{\n\t\tphoneNumber: string;\n\t\tareaCode?: string;\n\t\tcountryCode?: string;\n\t\ttelnyxPhoneNumberId?: string;\n\t\tnumberType?: NumberType;\n\t}>,\n\tdefaults: {\n\t\tmessagingProfileId: string | null;\n\t\tconnectionId: string | null;\n\t},\n): Promise<void> {\n\tif (phoneNumbers.length === 0) {\n\t\treturn;\n\t}\n\n\tfor (const number of phoneNumbers) {\n\t\tconst digits = number.phoneNumber.replace(/[^0-9]/g, \"\");\n\t\tconst e164 = digits.startsWith(\"+\")\n\t\t\t? digits\n\t\t\t: digits.startsWith(\"1\") && digits.length === 11\n\t\t\t\t? `+${digits}`\n\t\t\t\t: `+1${digits}`;\n\n\t\tconst row = {\n\t\t\tcompany_id: companyId,\n\t\t\tphone_number: e164,\n\t\t\tformatted_number: formatDisplay(e164),\n\t\t\tarea_code: number.areaCode || e164.slice(2, 5),\n\t\t\tcountry_code: number.countryCode || \"US\",\n\t\t\tnumber_type: number.numberType || \"local\",\n\t\t\tstatus: \"active\",\n\t\t\tfeatures: DEFAULT_FEATURES,\n\t\t\ttelnyx_phone_number_id: number.telnyxPhoneNumberId || null,\n\t\t\ttelnyx_messaging_profile_id: defaults.messagingProfileId,\n\t\t\ttelnyx_connection_id: defaults.connectionId,\n\t\t};\n\n\t\tconst { data: existing } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"phone_number\", e164)\n\t\t\t.maybeSingle();\n\n\t\tif (existing?.id) {\n\t\t\tawait supabase.from(\"phone_numbers\").update(row).eq(\"id\", existing.id);\n\t\t} else {\n\t\t\tawait supabase.from(\"phone_numbers\").insert(row);\n\t\t}\n\t}\n}\n\nasync function createMessagingProfile(companyName: string, webhookUrl: string) {\n\tconst response = await telnyxClient.messagingProfiles.create({\n\t\tname: `${companyName} - Thorbis`,\n\t\tenabled: true,\n\t\twebhook_url: webhookUrl,\n\t\twebhook_api_version: \"2\",\n\t});\n\treturn response.data as any;\n}\n\nasync function createCallControlApplication(\n\tcompanyName: string,\n\twebhookUrl: string,\n) {\n\tconst response = await telnyxClient.callControlApplications.create({\n\t\tapplication_name: `${companyName} - Thorbis`,\n\t\twebhook_event_url: webhookUrl,\n\t\twebhook_api_version: \"2\",\n\t\tanswering_machine_detection: \"premium\",\n\t});\n\treturn response.data as any;\n}\n\nasync function purchaseNumbers(\n\tcompanyId: string,\n\toptions: {\n\t\tquantity: number;\n\t\tareaCode?: string;\n\t\tfeatures?: NumberFeature[];\n\t\tmessagingProfileId: string;\n\t\tconnectionId: string;\n\t},\n): Promise<\n\tArray<{\n\t\tphoneNumber: string;\n\t\ttelnyxPhoneNumberId?: string;\n\t\tareaCode?: string;\n\t\tnumberType?: NumberType;\n\t}>\n> {\n\tconst search = await searchAvailableNumbers({\n\t\tareaCode: options.areaCode,\n\t\tfeatures: options.features || DEFAULT_FEATURES,\n\t\tlimit: Math.max(options.quantity * 2, options.quantity),\n\t});\n\n\tif (!search.success || !search.data || search.data.length === 0) {\n\t\tthrow new Error(\"No available phone numbers found for requested criteria\");\n\t}\n\n\tconst purchased: Array<{\n\t\tphoneNumber: string;\n\t\ttelnyxPhoneNumberId?: string;\n\t\tareaCode?: string;\n\t\tnumberType?: NumberType;\n\t}> = [];\n\tconst candidates = search.data as any[];\n\n\tfor (const candidate of candidates) {\n\t\tif (purchased.length >= options.quantity) {\n\t\t\tbreak;\n\t\t}\n\n\t\tconst number = candidate.phone_number as string;\n\t\tconst purchaseResult = await purchaseNumber({\n\t\t\tphoneNumber: number,\n\t\t\tmessagingProfileId: options.messagingProfileId,\n\t\t\tconnectionId: options.connectionId,\n\t\t\tcustomerReference: `company:${companyId}`,\n\t\t});\n\n\t\tif (!purchaseResult.success) {\n\t\t\tthrow new Error(\n\t\t\t\tpurchaseResult.error ||\n\t\t\t\t\t`Failed to purchase number ${number} from Telnyx`,\n\t\t\t);\n\t\t}\n\n\t\tpurchased.push({\n\t\t\tphoneNumber: number,\n\t\t\tareaCode: candidate.national_destination_code || candidate.area_code,\n\t\t\ttelnyxPhoneNumberId: candidate.id || candidate.phone_number,\n\t\t\tnumberType: candidate.number_type,\n\t\t});\n\t}\n\n\tif (purchased.length === 0) {\n\t\tthrow new Error(\"Failed to purchase any phone numbers\");\n\t}\n\n\t// Enable messaging on all purchased numbers\n\tfor (const number of purchased) {\n\t\tif (number.telnyxPhoneNumberId) {\n\t\t\ttry {\n\t\t\t\tconst TELNYX_API_KEY = process.env.TELNYX_API_KEY;\n\t\t\t\tif (!TELNYX_API_KEY) {\n\t\t\t\t\tthrow new Error(\"TELNYX_API_KEY not configured\");\n\t\t\t\t}\n\n\t\t\t\tawait fetch(\n\t\t\t\t\t`https://api.telnyx.com/v2/phone_numbers/${number.telnyxPhoneNumberId}/messaging`,\n\t\t\t\t\t{\n\t\t\t\t\t\tmethod: \"PATCH\",\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\t\tAuthorization: `Bearer ${TELNYX_API_KEY}`,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\t\tmessaging_profile_id: options.messagingProfileId,\n\t\t\t\t\t\t}),\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\t// Log but don't fail - messaging can be enabled later\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`Failed to enable messaging on ${number.phoneNumber}:`,\n\t\t\t\t\terror,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn purchased;\n}\n\nexport async function fetchCompanyTelnyxSettings(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n): Promise<CompanyTelnyxSettingsRow | null> {\n\tconst { data } = await (supabase as any)\n\t\t.from(COMPANY_SETTINGS_TABLE)\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.maybeSingle();\n\n\treturn (data as CompanyTelnyxSettingsRow | null) ?? null;\n}\n\nexport async function ensureCompanyTelnyxSetup(\n\toptions: ProvisionOptions,\n): Promise<ProvisionResult> {\n\tconst { supabase, companyId } = options;\n\tconst log: string[] = [];\n\n\tconst existing = await fetchCompanyTelnyxSettings(supabase, companyId);\n\tif (\n\t\texisting &&\n\t\texisting.status === \"ready\" &&\n\t\texisting.messaging_profile_id &&\n\t\texisting.call_control_application_id\n\t) {\n\t\tlog.push(\"Existing Telnyx configuration found\");\n\t\treturn { success: true, settings: existing, log };\n\t}\n\n\tconst { data: company } = await supabase\n\t\t.from(\"companies\")\n\t\t.select(\"id, name\")\n\t\t.eq(\"id\", companyId)\n\t\t.maybeSingle();\n\n\tif (!company) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Company not found\",\n\t\t\tlog,\n\t\t};\n\t}\n\n\tconst webhookUrl = await buildCompanyWebhookUrl(companyId);\n\tif (!webhookUrl) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be configured with a public URL to provision Telnyx resources\",\n\t\t\tlog,\n\t\t};\n\t}\n\n\ttry {\n\t\tlog.push(\"Creating messaging profile\");\n\t\tconst messagingProfile = await createMessagingProfile(\n\t\t\tcompany.name || \"Company\",\n\t\t\twebhookUrl,\n\t\t);\n\t\tconst messagingProfileId = messagingProfile?.id as string;\n\n\t\tlog.push(\"Creating call control application\");\n\t\tconst callApplication = await createCallControlApplication(\n\t\t\tcompany.name || \"Company\",\n\t\t\twebhookUrl,\n\t\t);\n\t\tconst connectionId = callApplication?.id as string;\n\n\t\tif (!messagingProfileId || !connectionId) {\n\t\t\tthrow new Error(\n\t\t\t\t\"Failed to provision messaging profile or call control application\",\n\t\t\t);\n\t\t}\n\n\t\tlog.push(\"Purchasing phone numbers\");\n\t\tconst purchasedNumbers = await purchaseNumbers(companyId, {\n\t\t\tquantity: Math.max(options.numberQuantity || 1, 1),\n\t\t\tareaCode: options.areaCode,\n\t\t\tfeatures: options.features || DEFAULT_FEATURES,\n\t\t\tmessagingProfileId,\n\t\t\tconnectionId,\n\t\t});\n\n\t\tawait ensurePhoneNumbersInserted(supabase, companyId, purchasedNumbers, {\n\t\t\tmessagingProfileId,\n\t\t\tconnectionId,\n\t\t});\n\n\t\tconst defaultNumber =\n\t\t\tpurchasedNumbers.find((n) => n.numberType === \"toll-free\") ||\n\t\t\tpurchasedNumbers[0];\n\n\t\tconst upsertResult = await (supabase as any)\n\t\t\t.from(COMPANY_SETTINGS_TABLE)\n\t\t\t.upsert(\n\t\t\t\t{\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\tstatus: \"ready\",\n\t\t\t\t\tmessaging_profile_id: messagingProfileId,\n\t\t\t\t\tcall_control_application_id: connectionId,\n\t\t\t\t\tdefault_outbound_number: defaultNumber?.phoneNumber || null,\n\t\t\t\t\tdefault_outbound_phone_number_id:\n\t\t\t\t\t\tdefaultNumber?.telnyxPhoneNumberId || null,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\tlog,\n\t\t\t\t\t\tpurchased_numbers: purchasedNumbers.map((n) => n.phoneNumber),\n\t\t\t\t\t},\n\t\t\t\t\tlast_provisioned_at: new Date().toISOString(),\n\t\t\t\t},\n\t\t\t\t{ onConflict: \"company_id\" },\n\t\t\t)\n\t\t\t.select(\"*\")\n\t\t\t.single();\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tsettings: upsertResult.data as CompanyTelnyxSettingsRow,\n\t\t\tlog,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to provision Telnyx resources\",\n\t\t\tlog,\n\t\t};\n\t}\n}\n\nexport async function purchaseAdditionalNumbers(\n\toptions: ProvisionOptions & { quantity: number },\n): Promise<ProvisionResult> {\n\tconst { supabase, companyId, quantity } = options;\n\tconst log: string[] = [];\n\n\tconst settings = await fetchCompanyTelnyxSettings(supabase, companyId);\n\tif (\n\t\t!settings ||\n\t\tsettings.status !== \"ready\" ||\n\t\t!settings.messaging_profile_id ||\n\t\t!settings.call_control_application_id\n\t) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\t\"Company Telnyx configuration is not ready. Run ensureCompanyTelnyxSetup first.\",\n\t\t\tlog,\n\t\t};\n\t}\n\n\ttry {\n\t\tlog.push(`Purchasing ${quantity} additional numbers`);\n\t\tconst purchasedNumbers = await purchaseNumbers(companyId, {\n\t\t\tquantity,\n\t\t\tareaCode: options.areaCode,\n\t\t\tfeatures: options.features || DEFAULT_FEATURES,\n\t\t\tmessagingProfileId: settings.messaging_profile_id,\n\t\t\tconnectionId: settings.call_control_application_id,\n\t\t});\n\n\t\tawait ensurePhoneNumbersInserted(supabase, companyId, purchasedNumbers, {\n\t\t\tmessagingProfileId: settings.messaging_profile_id,\n\t\t\tconnectionId: settings.call_control_application_id,\n\t\t});\n\n\t\t// Prefer toll-free numbers as the default outbound if available\n\t\tconst tollFreeNumber = purchasedNumbers.find(\n\t\t\t(n) => n.numberType === \"toll-free\",\n\t\t);\n\t\tif (\n\t\t\ttollFreeNumber &&\n\t\t\tsettings.default_outbound_number !== tollFreeNumber.phoneNumber\n\t\t) {\n\t\t\tawait supabase\n\t\t\t\t.from(COMPANY_SETTINGS_TABLE)\n\t\t\t\t.update({\n\t\t\t\t\tdefault_outbound_number: tollFreeNumber.phoneNumber,\n\t\t\t\t\tdefault_outbound_phone_number_id:\n\t\t\t\t\t\ttollFreeNumber.telnyxPhoneNumberId || null,\n\t\t\t\t})\n\t\t\t\t.eq(\"company_id\", companyId);\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tsettings,\n\t\t\tlog,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to purchase phone numbers\",\n\t\t\tlog,\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3263, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/rate-limiter.ts"],"sourcesContent":["/**\n * Telnyx Rate Limiter\n *\n * Implements token bucket algorithm with per-company and per-endpoint\n * rate limiting to prevent API rate limit errors.\n */\n\nimport { telnyxLogger } from \"./logger\";\nimport { sleep } from \"./retry\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface RateLimitConfig {\n\tmaxTokens: number; // Maximum tokens in bucket\n\trefillRate: number; // Tokens added per second\n\trefillInterval: number; // Milliseconds between refills\n}\n\nexport interface RateLimitResult {\n\tallowed: boolean;\n\tremainingTokens: number;\n\tretryAfterMs?: number;\n\twaitTime?: number; // Time waited if queued\n}\n\ninterface TokenBucket {\n\ttokens: number;\n\tlastRefill: number;\n\tqueue: Array<{\n\t\tresolve: (result: RateLimitResult) => void;\n\t\trequestedAt: number;\n\t}>;\n}\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\n// Default rate limits based on Telnyx API limits\nexport const RATE_LIMIT_CONFIGS: Record<string, RateLimitConfig> = {\n\t// General API: 100 requests per minute\n\tdefault: {\n\t\tmaxTokens: 100,\n\t\trefillRate: 100 / 60, // ~1.67 tokens/second\n\t\trefillInterval: 1000,\n\t},\n\t// SMS: 1 message per second per number (aggregate)\n\tsms: {\n\t\tmaxTokens: 60,\n\t\trefillRate: 1,\n\t\trefillInterval: 1000,\n\t},\n\t// Voice: more relaxed\n\tvoice: {\n\t\tmaxTokens: 30,\n\t\trefillRate: 0.5,\n\t\trefillInterval: 1000,\n\t},\n\t// Lookup: can be higher\n\tlookup: {\n\t\tmaxTokens: 200,\n\t\trefillRate: 200 / 60,\n\t\trefillInterval: 1000,\n\t},\n\t// Webhook (incoming): protect against floods\n\twebhook: {\n\t\tmaxTokens: 1000,\n\t\trefillRate: 100,\n\t\trefillInterval: 1000,\n\t},\n};\n\n// =============================================================================\n// TOKEN BUCKET IMPLEMENTATION\n// =============================================================================\n\nclass TokenBucketLimiter {\n\tprivate buckets = new Map<string, TokenBucket>();\n\tprivate processingQueue = new Map<string, boolean>();\n\n\t/**\n\t * Get or create a bucket for a key\n\t */\n\tprivate getBucket(key: string, config: RateLimitConfig): TokenBucket {\n\t\tif (!this.buckets.has(key)) {\n\t\t\tthis.buckets.set(key, {\n\t\t\t\ttokens: config.maxTokens,\n\t\t\t\tlastRefill: Date.now(),\n\t\t\t\tqueue: [],\n\t\t\t});\n\t\t}\n\t\treturn this.buckets.get(key)!;\n\t}\n\n\t/**\n\t * Refill tokens based on elapsed time\n\t */\n\tprivate refillTokens(bucket: TokenBucket, config: RateLimitConfig): void {\n\t\tconst now = Date.now();\n\t\tconst elapsed = now - bucket.lastRefill;\n\t\tconst intervalsElapsed = Math.floor(elapsed / config.refillInterval);\n\n\t\tif (intervalsElapsed > 0) {\n\t\t\tconst tokensToAdd = intervalsElapsed * config.refillRate;\n\t\t\tbucket.tokens = Math.min(config.maxTokens, bucket.tokens + tokensToAdd);\n\t\t\tbucket.lastRefill = now;\n\t\t}\n\t}\n\n\t/**\n\t * Process queued requests\n\t */\n\tprivate async processQueue(key: string, config: RateLimitConfig): Promise<void> {\n\t\tif (this.processingQueue.get(key)) return;\n\t\tthis.processingQueue.set(key, true);\n\n\t\tconst bucket = this.getBucket(key, config);\n\n\t\twhile (bucket.queue.length > 0) {\n\t\t\tthis.refillTokens(bucket, config);\n\n\t\t\tif (bucket.tokens >= 1) {\n\t\t\t\tconst request = bucket.queue.shift();\n\t\t\t\tif (request) {\n\t\t\t\t\tbucket.tokens -= 1;\n\t\t\t\t\tconst waitTime = Date.now() - request.requestedAt;\n\t\t\t\t\trequest.resolve({\n\t\t\t\t\t\tallowed: true,\n\t\t\t\t\t\tremainingTokens: bucket.tokens,\n\t\t\t\t\t\twaitTime,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Calculate time until next token\n\t\t\t\tconst timeUntilToken = config.refillInterval / config.refillRate;\n\t\t\t\tawait sleep(Math.ceil(timeUntilToken));\n\t\t\t}\n\t\t}\n\n\t\tthis.processingQueue.set(key, false);\n\t}\n\n\t/**\n\t * Attempt to acquire a token (immediate, no queue)\n\t */\n\ttryAcquire(key: string, config: RateLimitConfig = RATE_LIMIT_CONFIGS.default): RateLimitResult {\n\t\tconst bucket = this.getBucket(key, config);\n\t\tthis.refillTokens(bucket, config);\n\n\t\tif (bucket.tokens >= 1) {\n\t\t\tbucket.tokens -= 1;\n\t\t\treturn {\n\t\t\t\tallowed: true,\n\t\t\t\tremainingTokens: bucket.tokens,\n\t\t\t};\n\t\t}\n\n\t\t// Calculate retry after\n\t\tconst timeUntilToken = Math.ceil(config.refillInterval / config.refillRate);\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\tremainingTokens: 0,\n\t\t\tretryAfterMs: timeUntilToken,\n\t\t};\n\t}\n\n\t/**\n\t * Acquire a token, waiting in queue if necessary\n\t */\n\tasync acquire(\n\t\tkey: string,\n\t\tconfig: RateLimitConfig = RATE_LIMIT_CONFIGS.default,\n\t\tmaxWaitMs: number = 30000\n\t): Promise<RateLimitResult> {\n\t\t// Try immediate acquisition\n\t\tconst immediate = this.tryAcquire(key, config);\n\t\tif (immediate.allowed) {\n\t\t\treturn immediate;\n\t\t}\n\n\t\t// Queue the request\n\t\tconst bucket = this.getBucket(key, config);\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst requestedAt = Date.now();\n\t\t\tconst timeoutId = setTimeout(() => {\n\t\t\t\t// Remove from queue on timeout\n\t\t\t\tconst index = bucket.queue.findIndex((r) => r.requestedAt === requestedAt);\n\t\t\t\tif (index !== -1) {\n\t\t\t\t\tbucket.queue.splice(index, 1);\n\t\t\t\t}\n\t\t\t\tresolve({\n\t\t\t\t\tallowed: false,\n\t\t\t\t\tremainingTokens: 0,\n\t\t\t\t\tretryAfterMs: maxWaitMs,\n\t\t\t\t});\n\t\t\t}, maxWaitMs);\n\n\t\t\tbucket.queue.push({\n\t\t\t\tresolve: (result) => {\n\t\t\t\t\tclearTimeout(timeoutId);\n\t\t\t\t\tresolve(result);\n\t\t\t\t},\n\t\t\t\trequestedAt,\n\t\t\t});\n\n\t\t\t// Start processing queue\n\t\t\tthis.processQueue(key, config);\n\t\t});\n\t}\n\n\t/**\n\t * Get current bucket status\n\t */\n\tgetStatus(key: string, config: RateLimitConfig = RATE_LIMIT_CONFIGS.default): {\n\t\ttokens: number;\n\t\tmaxTokens: number;\n\t\tqueueLength: number;\n\t\tutilizationPercent: number;\n\t} {\n\t\tconst bucket = this.getBucket(key, config);\n\t\tthis.refillTokens(bucket, config);\n\n\t\treturn {\n\t\t\ttokens: Math.floor(bucket.tokens),\n\t\t\tmaxTokens: config.maxTokens,\n\t\t\tqueueLength: bucket.queue.length,\n\t\t\tutilizationPercent: Math.round(((config.maxTokens - bucket.tokens) / config.maxTokens) * 100),\n\t\t};\n\t}\n\n\t/**\n\t * Reset a bucket (for testing)\n\t */\n\treset(key: string): void {\n\t\tthis.buckets.delete(key);\n\t}\n\n\t/**\n\t * Reset all buckets\n\t */\n\tresetAll(): void {\n\t\tthis.buckets.clear();\n\t}\n}\n\n// =============================================================================\n// RATE LIMITER INSTANCES\n// =============================================================================\n\n// Global rate limiter\nconst globalLimiter = new TokenBucketLimiter();\n\n// Per-company rate limiters\nconst companyLimiters = new Map<string, TokenBucketLimiter>();\n\nfunction getCompanyLimiter(companyId: string): TokenBucketLimiter {\n\tif (!companyLimiters.has(companyId)) {\n\t\tcompanyLimiters.set(companyId, new TokenBucketLimiter());\n\t}\n\treturn companyLimiters.get(companyId)!;\n}\n\n// =============================================================================\n// PUBLIC API\n// =============================================================================\n\nexport type RateLimitEndpoint = keyof typeof RATE_LIMIT_CONFIGS;\n\n/**\n * Check if a request is rate limited (immediate check, no queue)\n */\nexport function checkRateLimit(\n\tendpoint: RateLimitEndpoint = \"default\",\n\tcompanyId?: string\n): RateLimitResult {\n\tconst config = RATE_LIMIT_CONFIGS[endpoint] || RATE_LIMIT_CONFIGS.default;\n\n\t// Check global rate limit\n\tconst globalKey = `global:${endpoint}`;\n\tconst globalResult = globalLimiter.tryAcquire(globalKey, config);\n\n\tif (!globalResult.allowed) {\n\t\ttelnyxLogger.warn(\"Global rate limit hit\", {\n\t\t\tendpoint,\n\t\t\tretryAfterMs: globalResult.retryAfterMs,\n\t\t});\n\t\treturn globalResult;\n\t}\n\n\t// Check per-company rate limit if provided\n\tif (companyId) {\n\t\tconst companyLimiter = getCompanyLimiter(companyId);\n\t\tconst companyResult = companyLimiter.tryAcquire(endpoint, config);\n\n\t\tif (!companyResult.allowed) {\n\t\t\ttelnyxLogger.warn(\"Company rate limit hit\", {\n\t\t\t\tendpoint,\n\t\t\t\tcompanyId,\n\t\t\t\tretryAfterMs: companyResult.retryAfterMs,\n\t\t\t});\n\t\t\treturn companyResult;\n\t\t}\n\t}\n\n\treturn globalResult;\n}\n\n/**\n * Acquire a rate limit token, waiting if necessary\n */\nexport async function acquireRateLimit(\n\tendpoint: RateLimitEndpoint = \"default\",\n\tcompanyId?: string,\n\tmaxWaitMs: number = 30000\n): Promise<RateLimitResult> {\n\tconst config = RATE_LIMIT_CONFIGS[endpoint] || RATE_LIMIT_CONFIGS.default;\n\n\t// Acquire global token\n\tconst globalKey = `global:${endpoint}`;\n\tconst globalResult = await globalLimiter.acquire(globalKey, config, maxWaitMs);\n\n\tif (!globalResult.allowed) {\n\t\treturn globalResult;\n\t}\n\n\t// Acquire per-company token if provided\n\tif (companyId) {\n\t\tconst companyLimiter = getCompanyLimiter(companyId);\n\t\tconst companyResult = await companyLimiter.acquire(endpoint, config, maxWaitMs);\n\n\t\tif (!companyResult.allowed) {\n\t\t\treturn companyResult;\n\t\t}\n\n\t\t// Return the longer wait time\n\t\treturn {\n\t\t\t...companyResult,\n\t\t\twaitTime: Math.max(globalResult.waitTime || 0, companyResult.waitTime || 0),\n\t\t};\n\t}\n\n\treturn globalResult;\n}\n\n/**\n * Decorator function to rate limit async operations\n */\nexport function withRateLimit<T>(\n\tfn: () => Promise<T>,\n\toptions: {\n\t\tendpoint?: RateLimitEndpoint;\n\t\tcompanyId?: string;\n\t\tmaxWaitMs?: number;\n\t\tcorrelationId?: string;\n\t} = {}\n): Promise<T> {\n\tconst { endpoint = \"default\", companyId, maxWaitMs = 30000, correlationId } = options;\n\n\treturn new Promise(async (resolve, reject) => {\n\t\ttry {\n\t\t\tconst result = await acquireRateLimit(endpoint, companyId, maxWaitMs);\n\n\t\t\tif (!result.allowed) {\n\t\t\t\tconst error = new Error(\n\t\t\t\t\t`Rate limit exceeded. Retry after ${result.retryAfterMs}ms`\n\t\t\t\t);\n\t\t\t\t(error as any).code = \"RATE_LIMIT_EXCEEDED\";\n\t\t\t\t(error as any).retryAfterMs = result.retryAfterMs;\n\t\t\t\treject(error);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (result.waitTime && result.waitTime > 100) {\n\t\t\t\ttelnyxLogger.debug(\"Request waited for rate limit\", {\n\t\t\t\t\tendpoint,\n\t\t\t\t\tcompanyId,\n\t\t\t\t\twaitTime: result.waitTime,\n\t\t\t\t\tcorrelationId,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst response = await fn();\n\t\t\tresolve(response);\n\t\t} catch (error) {\n\t\t\treject(error);\n\t\t}\n\t});\n}\n\n/**\n * Get rate limit status for monitoring\n */\nexport function getRateLimitStatus(\n\tendpoint?: RateLimitEndpoint,\n\tcompanyId?: string\n): {\n\tglobal: Record<string, ReturnType<TokenBucketLimiter[\"getStatus\"]>>;\n\tcompany?: Record<string, ReturnType<TokenBucketLimiter[\"getStatus\"]>>;\n} {\n\tconst endpoints = endpoint\n\t\t? [endpoint]\n\t\t: (Object.keys(RATE_LIMIT_CONFIGS) as RateLimitEndpoint[]);\n\n\tconst global: Record<string, ReturnType<TokenBucketLimiter[\"getStatus\"]>> = {};\n\n\tfor (const ep of endpoints) {\n\t\tconst config = RATE_LIMIT_CONFIGS[ep];\n\t\tglobal[ep] = globalLimiter.getStatus(`global:${ep}`, config);\n\t}\n\n\tlet company: Record<string, ReturnType<TokenBucketLimiter[\"getStatus\"]>> | undefined;\n\n\tif (companyId) {\n\t\tconst limiter = companyLimiters.get(companyId);\n\t\tif (limiter) {\n\t\t\tcompany = {};\n\t\t\tfor (const ep of endpoints) {\n\t\t\t\tconst config = RATE_LIMIT_CONFIGS[ep];\n\t\t\t\tcompany[ep] = limiter.getStatus(ep, config);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn { global, company };\n}\n\n/**\n * Reset rate limits (for testing)\n */\nexport function resetRateLimits(companyId?: string): void {\n\tif (companyId) {\n\t\tcompanyLimiters.delete(companyId);\n\t} else {\n\t\tglobalLimiter.resetAll();\n\t\tcompanyLimiters.clear();\n\t}\n}\n\n// =============================================================================\n// BULK OPERATION HELPER\n// =============================================================================\n\nexport interface BulkRateLimitOptions {\n\tendpoint: RateLimitEndpoint;\n\tcompanyId?: string;\n\tbatchSize?: number;\n\tbatchDelayMs?: number;\n}\n\n/**\n * Process items in rate-limited batches\n */\nexport async function processBatchWithRateLimit<T, R>(\n\titems: T[],\n\tprocessor: (item: T) => Promise<R>,\n\toptions: BulkRateLimitOptions\n): Promise<Array<{ item: T; result?: R; error?: Error }>> {\n\tconst { endpoint, companyId, batchSize = 10, batchDelayMs = 1000 } = options;\n\n\tconst results: Array<{ item: T; result?: R; error?: Error }> = [];\n\n\tfor (let i = 0; i < items.length; i += batchSize) {\n\t\tconst batch = items.slice(i, i + batchSize);\n\n\t\t// Process batch with rate limiting\n\t\tconst batchResults = await Promise.all(\n\t\t\tbatch.map(async (item) => {\n\t\t\t\ttry {\n\t\t\t\t\tconst result = await withRateLimit(\n\t\t\t\t\t\t() => processor(item),\n\t\t\t\t\t\t{ endpoint, companyId }\n\t\t\t\t\t);\n\t\t\t\t\treturn { item, result };\n\t\t\t\t} catch (error) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\titem,\n\t\t\t\t\t\terror: error instanceof Error ? error : new Error(String(error)),\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\n\t\tresults.push(...batchResults);\n\n\t\t// Delay between batches\n\t\tif (i + batchSize < items.length) {\n\t\t\tawait sleep(batchDelayMs);\n\t\t}\n\t}\n\n\treturn results;\n}\n\n// =============================================================================\n// RATE LIMIT RESPONSE HANDLER\n// =============================================================================\n\n/**\n * Handle 429 response from Telnyx API\n */\nexport function handle429Response(response: Response): {\n\tretryAfterMs: number;\n\tshouldRetry: boolean;\n} {\n\tconst retryAfter = response.headers.get(\"Retry-After\");\n\n\tlet retryAfterMs = 60000; // Default 60 seconds\n\n\tif (retryAfter) {\n\t\t// Check if it's a number (seconds)\n\t\tconst seconds = parseInt(retryAfter, 10);\n\t\tif (!isNaN(seconds)) {\n\t\t\tretryAfterMs = seconds * 1000;\n\t\t} else {\n\t\t\t// Try parsing as a date\n\t\t\tconst date = Date.parse(retryAfter);\n\t\t\tif (!isNaN(date)) {\n\t\t\t\tretryAfterMs = Math.max(0, date - Date.now());\n\t\t\t}\n\t\t}\n\t}\n\n\t// Don't retry if wait is too long (> 5 minutes)\n\tconst shouldRetry = retryAfterMs <= 300000;\n\n\ttelnyxLogger.warn(\"Rate limit response received\", {\n\t\tretryAfterMs,\n\t\tshouldRetry,\n\t});\n\n\treturn { retryAfterMs, shouldRetry };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3642, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/errors.ts"],"sourcesContent":["/**\n * Telnyx Custom Error Classes\n *\n * Provides typed error classes for different failure scenarios\n * with error codes, metadata, and retry information.\n */\n\n// =============================================================================\n// ERROR CODES\n// =============================================================================\n\nexport enum TelnyxErrorCode {\n\t// Network errors\n\tNETWORK_ERROR = \"TELNYX_NETWORK_ERROR\",\n\tTIMEOUT = \"TELNYX_TIMEOUT\",\n\tCONNECTION_REFUSED = \"TELNYX_CONNECTION_REFUSED\",\n\n\t// Authentication errors\n\tINVALID_API_KEY = \"TELNYX_INVALID_API_KEY\",\n\tUNAUTHORIZED = \"TELNYX_UNAUTHORIZED\",\n\tFORBIDDEN = \"TELNYX_FORBIDDEN\",\n\n\t// Rate limiting\n\tRATE_LIMIT_EXCEEDED = \"TELNYX_RATE_LIMIT_EXCEEDED\",\n\n\t// Validation errors\n\tINVALID_PHONE_NUMBER = \"TELNYX_INVALID_PHONE_NUMBER\",\n\tINVALID_REQUEST = \"TELNYX_INVALID_REQUEST\",\n\tMISSING_REQUIRED_FIELD = \"TELNYX_MISSING_REQUIRED_FIELD\",\n\n\t// Resource errors\n\tNOT_FOUND = \"TELNYX_NOT_FOUND\",\n\tRESOURCE_CONFLICT = \"TELNYX_RESOURCE_CONFLICT\",\n\n\t// Provider errors\n\tPROVIDER_ERROR = \"TELNYX_PROVIDER_ERROR\",\n\tCARRIER_ERROR = \"TELNYX_CARRIER_ERROR\",\n\tDELIVERY_FAILED = \"TELNYX_DELIVERY_FAILED\",\n\n\t// Call-specific errors\n\tCALL_REJECTED = \"TELNYX_CALL_REJECTED\",\n\tCALL_BUSY = \"TELNYX_CALL_BUSY\",\n\tCALL_NO_ANSWER = \"TELNYX_CALL_NO_ANSWER\",\n\tCALL_FAILED = \"TELNYX_CALL_FAILED\",\n\n\t// SMS-specific errors\n\tSMS_DELIVERY_FAILED = \"TELNYX_SMS_DELIVERY_FAILED\",\n\tSMS_BLOCKED = \"TELNYX_SMS_BLOCKED\",\n\tSMS_SPAM_DETECTED = \"TELNYX_SMS_SPAM_DETECTED\",\n\n\t// Webhook errors\n\tWEBHOOK_VALIDATION_FAILED = \"TELNYX_WEBHOOK_VALIDATION_FAILED\",\n\tWEBHOOK_SIGNATURE_INVALID = \"TELNYX_WEBHOOK_SIGNATURE_INVALID\",\n\tWEBHOOK_TIMESTAMP_INVALID = \"TELNYX_WEBHOOK_TIMESTAMP_INVALID\",\n\tWEBHOOK_REPLAY_DETECTED = \"TELNYX_WEBHOOK_REPLAY_DETECTED\",\n\n\t// Circuit breaker\n\tCIRCUIT_BREAKER_OPEN = \"TELNYX_CIRCUIT_BREAKER_OPEN\",\n\n\t// Generic\n\tUNKNOWN_ERROR = \"TELNYX_UNKNOWN_ERROR\",\n\tINTERNAL_ERROR = \"TELNYX_INTERNAL_ERROR\",\n}\n\n// =============================================================================\n// BASE ERROR CLASS\n// =============================================================================\n\nexport interface TelnyxErrorMetadata {\n\tcorrelationId?: string;\n\tendpoint?: string;\n\tmethod?: string;\n\tstatusCode?: number;\n\tcompanyId?: string;\n\tphoneNumber?: string;\n\tcallControlId?: string;\n\tmessageSid?: string;\n\tattempt?: number;\n\tretryable?: boolean;\n\tretryAfterMs?: number;\n\toriginalError?: Error;\n\ttelnyxErrorCode?: string;\n\ttelnyxErrorDetail?: string;\n\t[key: string]: unknown;\n}\n\nexport class TelnyxError extends Error {\n\tpublic readonly code: TelnyxErrorCode;\n\tpublic readonly metadata: TelnyxErrorMetadata;\n\tpublic readonly timestamp: Date;\n\tpublic readonly retryable: boolean;\n\tpublic readonly retryAfterMs?: number;\n\n\tconstructor(\n\t\tmessage: string,\n\t\tcode: TelnyxErrorCode = TelnyxErrorCode.UNKNOWN_ERROR,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message);\n\t\tthis.name = \"TelnyxError\";\n\t\tthis.code = code;\n\t\tthis.metadata = metadata;\n\t\tthis.timestamp = new Date();\n\t\tthis.retryable = metadata.retryable ?? this.isRetryableCode(code);\n\t\tthis.retryAfterMs = metadata.retryAfterMs;\n\n\t\t// Capture stack trace\n\t\tif (Error.captureStackTrace) {\n\t\t\tError.captureStackTrace(this, TelnyxError);\n\t\t}\n\t}\n\n\tprivate isRetryableCode(code: TelnyxErrorCode): boolean {\n\t\tconst retryableCodes = [\n\t\t\tTelnyxErrorCode.NETWORK_ERROR,\n\t\t\tTelnyxErrorCode.TIMEOUT,\n\t\t\tTelnyxErrorCode.CONNECTION_REFUSED,\n\t\t\tTelnyxErrorCode.RATE_LIMIT_EXCEEDED,\n\t\t\tTelnyxErrorCode.PROVIDER_ERROR,\n\t\t\tTelnyxErrorCode.INTERNAL_ERROR,\n\t\t];\n\t\treturn retryableCodes.includes(code);\n\t}\n\n\t/**\n\t * Convert to JSON for logging/serialization\n\t */\n\ttoJSON(): Record<string, unknown> {\n\t\treturn {\n\t\t\tname: this.name,\n\t\t\tmessage: this.message,\n\t\t\tcode: this.code,\n\t\t\tmetadata: this.metadata,\n\t\t\ttimestamp: this.timestamp.toISOString(),\n\t\t\tretryable: this.retryable,\n\t\t\tretryAfterMs: this.retryAfterMs,\n\t\t\tstack: this.stack,\n\t\t};\n\t}\n\n\t/**\n\t * Create a user-friendly error message\n\t */\n\ttoUserMessage(): string {\n\t\tswitch (this.code) {\n\t\t\tcase TelnyxErrorCode.INVALID_PHONE_NUMBER:\n\t\t\t\treturn \"The phone number provided is invalid. Please check and try again.\";\n\t\t\tcase TelnyxErrorCode.RATE_LIMIT_EXCEEDED:\n\t\t\t\treturn \"Too many requests. Please wait a moment and try again.\";\n\t\t\tcase TelnyxErrorCode.CALL_BUSY:\n\t\t\t\treturn \"The number is busy. Please try again later.\";\n\t\t\tcase TelnyxErrorCode.CALL_NO_ANSWER:\n\t\t\t\treturn \"No answer. The call was not picked up.\";\n\t\t\tcase TelnyxErrorCode.SMS_BLOCKED:\n\t\t\t\treturn \"Message could not be delivered. The recipient may have blocked messages.\";\n\t\t\tcase TelnyxErrorCode.UNAUTHORIZED:\n\t\t\tcase TelnyxErrorCode.INVALID_API_KEY:\n\t\t\t\treturn \"Authentication failed. Please contact support.\";\n\t\t\tcase TelnyxErrorCode.NETWORK_ERROR:\n\t\t\tcase TelnyxErrorCode.TIMEOUT:\n\t\t\t\treturn \"Connection issue. Please try again.\";\n\t\t\tdefault:\n\t\t\t\treturn \"An error occurred. Please try again or contact support.\";\n\t\t}\n\t}\n}\n\n// =============================================================================\n// SPECIALIZED ERROR CLASSES\n// =============================================================================\n\n/**\n * Network-related errors (connectivity, timeout, etc.)\n */\nexport class TelnyxNetworkError extends TelnyxError {\n\tconstructor(message: string, metadata: TelnyxErrorMetadata = {}) {\n\t\tsuper(message, TelnyxErrorCode.NETWORK_ERROR, {\n\t\t\t...metadata,\n\t\t\tretryable: true,\n\t\t});\n\t\tthis.name = \"TelnyxNetworkError\";\n\t}\n}\n\n/**\n * Timeout errors\n */\nexport class TelnyxTimeoutError extends TelnyxError {\n\tpublic readonly timeoutMs: number;\n\n\tconstructor(\n\t\tmessage: string,\n\t\ttimeoutMs: number,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message, TelnyxErrorCode.TIMEOUT, {\n\t\t\t...metadata,\n\t\t\tretryable: true,\n\t\t});\n\t\tthis.name = \"TelnyxTimeoutError\";\n\t\tthis.timeoutMs = timeoutMs;\n\t}\n}\n\n/**\n * Rate limit errors\n */\nexport class TelnyxRateLimitError extends TelnyxError {\n\tconstructor(\n\t\tmessage: string,\n\t\tretryAfterMs: number,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message, TelnyxErrorCode.RATE_LIMIT_EXCEEDED, {\n\t\t\t...metadata,\n\t\t\tretryable: true,\n\t\t\tretryAfterMs,\n\t\t});\n\t\tthis.name = \"TelnyxRateLimitError\";\n\t}\n}\n\n/**\n * Authentication/Authorization errors\n */\nexport class TelnyxAuthError extends TelnyxError {\n\tconstructor(message: string, metadata: TelnyxErrorMetadata = {}) {\n\t\tconst code = metadata.statusCode === 403\n\t\t\t? TelnyxErrorCode.FORBIDDEN\n\t\t\t: TelnyxErrorCode.UNAUTHORIZED;\n\t\tsuper(message, code, {\n\t\t\t...metadata,\n\t\t\tretryable: false,\n\t\t});\n\t\tthis.name = \"TelnyxAuthError\";\n\t}\n}\n\n/**\n * Validation errors\n */\nexport class TelnyxValidationError extends TelnyxError {\n\tpublic readonly field?: string;\n\tpublic readonly validationDetails?: Record<string, string[]>;\n\n\tconstructor(\n\t\tmessage: string,\n\t\tmetadata: TelnyxErrorMetadata & {\n\t\t\tfield?: string;\n\t\t\tvalidationDetails?: Record<string, string[]>;\n\t\t} = {}\n\t) {\n\t\tsuper(message, TelnyxErrorCode.INVALID_REQUEST, {\n\t\t\t...metadata,\n\t\t\tretryable: false,\n\t\t});\n\t\tthis.name = \"TelnyxValidationError\";\n\t\tthis.field = metadata.field;\n\t\tthis.validationDetails = metadata.validationDetails;\n\t}\n}\n\n/**\n * Phone number validation errors\n */\nexport class TelnyxPhoneNumberError extends TelnyxError {\n\tpublic readonly phoneNumber: string;\n\n\tconstructor(\n\t\tmessage: string,\n\t\tphoneNumber: string,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message, TelnyxErrorCode.INVALID_PHONE_NUMBER, {\n\t\t\t...metadata,\n\t\t\tphoneNumber,\n\t\t\tretryable: false,\n\t\t});\n\t\tthis.name = \"TelnyxPhoneNumberError\";\n\t\tthis.phoneNumber = phoneNumber;\n\t}\n}\n\n/**\n * Webhook validation errors\n */\nexport class TelnyxWebhookError extends TelnyxError {\n\tconstructor(\n\t\tmessage: string,\n\t\tcode: TelnyxErrorCode = TelnyxErrorCode.WEBHOOK_VALIDATION_FAILED,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message, code, {\n\t\t\t...metadata,\n\t\t\tretryable: false,\n\t\t});\n\t\tthis.name = \"TelnyxWebhookError\";\n\t}\n}\n\n/**\n * Circuit breaker errors\n */\nexport class TelnyxCircuitBreakerError extends TelnyxError {\n\tpublic readonly endpoint: string;\n\n\tconstructor(endpoint: string, metadata: TelnyxErrorMetadata = {}) {\n\t\tsuper(\n\t\t\t`Circuit breaker is open for endpoint: ${endpoint}`,\n\t\t\tTelnyxErrorCode.CIRCUIT_BREAKER_OPEN,\n\t\t\t{\n\t\t\t\t...metadata,\n\t\t\t\tendpoint,\n\t\t\t\tretryable: false,\n\t\t\t}\n\t\t);\n\t\tthis.name = \"TelnyxCircuitBreakerError\";\n\t\tthis.endpoint = endpoint;\n\t}\n}\n\n/**\n * Call-specific errors\n */\nexport class TelnyxCallError extends TelnyxError {\n\tpublic readonly callControlId?: string;\n\n\tconstructor(\n\t\tmessage: string,\n\t\tcode: TelnyxErrorCode,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message, code, metadata);\n\t\tthis.name = \"TelnyxCallError\";\n\t\tthis.callControlId = metadata.callControlId;\n\t}\n}\n\n/**\n * SMS-specific errors\n */\nexport class TelnyxSmsError extends TelnyxError {\n\tpublic readonly messageSid?: string;\n\n\tconstructor(\n\t\tmessage: string,\n\t\tcode: TelnyxErrorCode,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message, code, metadata);\n\t\tthis.name = \"TelnyxSmsError\";\n\t\tthis.messageSid = metadata.messageSid;\n\t}\n}\n\n// =============================================================================\n// ERROR FACTORY\n// =============================================================================\n\n/**\n * Create appropriate error from HTTP response\n */\nexport function createErrorFromResponse(\n\tstatusCode: number,\n\tbody: unknown,\n\tmetadata: TelnyxErrorMetadata = {}\n): TelnyxError {\n\tconst errorBody = body as {\n\t\terrors?: Array<{ code?: string; title?: string; detail?: string }>;\n\t\terror?: string;\n\t\tmessage?: string;\n\t};\n\n\tconst errorDetail = errorBody?.errors?.[0]?.detail ||\n\t\terrorBody?.error ||\n\t\terrorBody?.message ||\n\t\t\"Unknown error\";\n\n\tconst telnyxErrorCode = errorBody?.errors?.[0]?.code;\n\n\tconst fullMetadata = {\n\t\t...metadata,\n\t\tstatusCode,\n\t\ttelnyxErrorCode,\n\t\ttelnyxErrorDetail: errorDetail,\n\t};\n\n\tswitch (statusCode) {\n\t\tcase 400:\n\t\t\treturn new TelnyxValidationError(errorDetail, fullMetadata);\n\n\t\tcase 401:\n\t\t\treturn new TelnyxAuthError(\"Invalid API key or unauthorized\", fullMetadata);\n\n\t\tcase 403:\n\t\t\treturn new TelnyxAuthError(\"Access forbidden\", fullMetadata);\n\n\t\tcase 404:\n\t\t\treturn new TelnyxError(\"Resource not found\", TelnyxErrorCode.NOT_FOUND, {\n\t\t\t\t...fullMetadata,\n\t\t\t\tretryable: false,\n\t\t\t});\n\n\t\tcase 409:\n\t\t\treturn new TelnyxError(\"Resource conflict\", TelnyxErrorCode.RESOURCE_CONFLICT, {\n\t\t\t\t...fullMetadata,\n\t\t\t\tretryable: false,\n\t\t\t});\n\n\t\tcase 429:\n\t\t\tconst retryAfter = parseInt(\n\t\t\t\t(body as { retry_after?: string })?.retry_after || \"60\",\n\t\t\t\t10\n\t\t\t) * 1000;\n\t\t\treturn new TelnyxRateLimitError(\n\t\t\t\t\"Rate limit exceeded\",\n\t\t\t\tretryAfter,\n\t\t\t\tfullMetadata\n\t\t\t);\n\n\t\tcase 500:\n\t\tcase 502:\n\t\tcase 503:\n\t\tcase 504:\n\t\t\treturn new TelnyxError(\n\t\t\t\t\"Telnyx service error\",\n\t\t\t\tTelnyxErrorCode.PROVIDER_ERROR,\n\t\t\t\t{\n\t\t\t\t\t...fullMetadata,\n\t\t\t\t\tretryable: true,\n\t\t\t\t}\n\t\t\t);\n\n\t\tdefault:\n\t\t\treturn new TelnyxError(errorDetail, TelnyxErrorCode.UNKNOWN_ERROR, fullMetadata);\n\t}\n}\n\n/**\n * Create error from network/fetch error\n */\nexport function createErrorFromException(\n\terror: unknown,\n\tmetadata: TelnyxErrorMetadata = {}\n): TelnyxError {\n\tif (error instanceof TelnyxError) {\n\t\treturn error;\n\t}\n\n\tconst originalError = error instanceof Error ? error : new Error(String(error));\n\tconst errorCode = (originalError as NodeJS.ErrnoException).code;\n\n\tconst fullMetadata = {\n\t\t...metadata,\n\t\toriginalError,\n\t};\n\n\t// Check for specific error types\n\tif (originalError.name === \"AbortError\" || originalError.message.includes(\"timeout\")) {\n\t\treturn new TelnyxTimeoutError(\n\t\t\t\"Request timed out\",\n\t\t\tmetadata.timeout as number || 30000,\n\t\t\tfullMetadata\n\t\t);\n\t}\n\n\tif (\n\t\terrorCode === \"ECONNRESET\" ||\n\t\terrorCode === \"ECONNREFUSED\" ||\n\t\terrorCode === \"ENOTFOUND\" ||\n\t\terrorCode === \"ENETUNREACH\" ||\n\t\toriginalError.message.includes(\"fetch failed\") ||\n\t\toriginalError.message.includes(\"network\")\n\t) {\n\t\treturn new TelnyxNetworkError(\n\t\t\t`Network error: ${originalError.message}`,\n\t\t\tfullMetadata\n\t\t);\n\t}\n\n\treturn new TelnyxError(\n\t\toriginalError.message,\n\t\tTelnyxErrorCode.UNKNOWN_ERROR,\n\t\tfullMetadata\n\t);\n}\n\n// =============================================================================\n// ERROR UTILITIES\n// =============================================================================\n\n/**\n * Check if an error is a TelnyxError\n */\nexport function isTelnyxError(error: unknown): error is TelnyxError {\n\treturn error instanceof TelnyxError;\n}\n\n/**\n * Check if an error is retryable\n */\nexport function isRetryableError(error: unknown): boolean {\n\tif (error instanceof TelnyxError) {\n\t\treturn error.retryable;\n\t}\n\n\t// Check for network errors\n\tif (error instanceof Error) {\n\t\tconst errorCode = (error as NodeJS.ErrnoException).code;\n\t\tconst retryableErrorCodes = [\n\t\t\t\"ECONNRESET\",\n\t\t\t\"ETIMEDOUT\",\n\t\t\t\"ECONNREFUSED\",\n\t\t\t\"EPIPE\",\n\t\t\t\"ENOTFOUND\",\n\t\t\t\"ENETUNREACH\",\n\t\t\t\"EAI_AGAIN\",\n\t\t];\n\t\tif (errorCode && retryableErrorCodes.includes(errorCode)) {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\treturn false;\n}\n\n/**\n * Wrap an error to ensure it's a TelnyxError\n */\nexport function wrapError(\n\terror: unknown,\n\tmetadata: TelnyxErrorMetadata = {}\n): TelnyxError {\n\tif (error instanceof TelnyxError) {\n\t\t// Merge metadata\n\t\treturn new TelnyxError(error.message, error.code, {\n\t\t\t...error.metadata,\n\t\t\t...metadata,\n\t\t});\n\t}\n\n\treturn createErrorFromException(error, metadata);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4000, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/metrics.ts"],"sourcesContent":["/**\n * Telnyx Metrics & Monitoring\n *\n * Tracks API performance, error rates, and usage statistics.\n */\n\nimport { telnyxLogger } from \"./logger\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface RequestMetrics {\n\tendpoint: string;\n\tmethod: string;\n\tstatusCode: number;\n\tlatencyMs: number;\n\tsuccess: boolean;\n\ttimestamp: Date;\n\tcompanyId?: string;\n\tcorrelationId?: string;\n}\n\nexport interface AggregatedMetrics {\n\ttotalRequests: number;\n\tsuccessfulRequests: number;\n\tfailedRequests: number;\n\terrorRate: number;\n\tlatency: {\n\t\tp50: number;\n\t\tp95: number;\n\t\tp99: number;\n\t\tavg: number;\n\t\tmin: number;\n\t\tmax: number;\n\t};\n\tbyEndpoint: Record<\n\t\tstring,\n\t\t{\n\t\t\tcount: number;\n\t\t\terrors: number;\n\t\t\tavgLatency: number;\n\t\t}\n\t>;\n\tbyStatusCode: Record<number, number>;\n}\n\nexport interface OperationMetrics {\n\tsmsSent: number;\n\tsmsDelivered: number;\n\tsmsFailed: number;\n\tcallsInitiated: number;\n\tcallsCompleted: number;\n\tcallsFailed: number;\n\twebhooksReceived: number;\n\twebhooksProcessed: number;\n\twebhooksFailed: number;\n}\n\n// =============================================================================\n// METRICS COLLECTOR\n// =============================================================================\n\nclass MetricsCollector {\n\tprivate requests: RequestMetrics[] = [];\n\tprivate operations: OperationMetrics = {\n\t\tsmsSent: 0,\n\t\tsmsDelivered: 0,\n\t\tsmsFailed: 0,\n\t\tcallsInitiated: 0,\n\t\tcallsCompleted: 0,\n\t\tcallsFailed: 0,\n\t\twebhooksReceived: 0,\n\t\twebhooksProcessed: 0,\n\t\twebhooksFailed: 0,\n\t};\n\tprivate retentionMs: number = 60 * 60 * 1000; // 1 hour\n\tprivate maxEntries: number = 10000;\n\tprivate cleanupInterval?: NodeJS.Timeout;\n\n\tconstructor() {\n\t\tthis.startCleanup();\n\t}\n\n\t/**\n\t * Start periodic cleanup\n\t */\n\tprivate startCleanup(): void {\n\t\tthis.cleanupInterval = setInterval(() => {\n\t\t\tthis.cleanup();\n\t\t}, 60000); // Every minute\n\n\t\tif (this.cleanupInterval.unref) {\n\t\t\tthis.cleanupInterval.unref();\n\t\t}\n\t}\n\n\t/**\n\t * Clean up old metrics\n\t */\n\tprivate cleanup(): void {\n\t\tconst cutoff = Date.now() - this.retentionMs;\n\t\tconst initialCount = this.requests.length;\n\n\t\tthis.requests = this.requests.filter(\n\t\t\t(r) => r.timestamp.getTime() > cutoff\n\t\t);\n\n\t\t// Also trim if over max entries\n\t\tif (this.requests.length > this.maxEntries) {\n\t\t\tthis.requests = this.requests.slice(-this.maxEntries);\n\t\t}\n\n\t\tconst removed = initialCount - this.requests.length;\n\t\tif (removed > 0) {\n\t\t\ttelnyxLogger.debug(\"Metrics cleanup\", { removed });\n\t\t}\n\t}\n\n\t/**\n\t * Record a request\n\t */\n\trecordRequest(metrics: RequestMetrics): void {\n\t\tthis.requests.push(metrics);\n\n\t\t// Log slow requests\n\t\tif (metrics.latencyMs > 2000) {\n\t\t\ttelnyxLogger.warn(\"Slow request detected\", {\n\t\t\t\tendpoint: metrics.endpoint,\n\t\t\t\tlatencyMs: metrics.latencyMs,\n\t\t\t\tcorrelationId: metrics.correlationId,\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Record SMS sent\n\t */\n\trecordSmsSent(success: boolean): void {\n\t\tthis.operations.smsSent++;\n\t\tif (!success) {\n\t\t\tthis.operations.smsFailed++;\n\t\t}\n\t}\n\n\t/**\n\t * Record SMS delivered\n\t */\n\trecordSmsDelivered(): void {\n\t\tthis.operations.smsDelivered++;\n\t}\n\n\t/**\n\t * Record call initiated\n\t */\n\trecordCallInitiated(success: boolean): void {\n\t\tthis.operations.callsInitiated++;\n\t\tif (!success) {\n\t\t\tthis.operations.callsFailed++;\n\t\t}\n\t}\n\n\t/**\n\t * Record call completed\n\t */\n\trecordCallCompleted(): void {\n\t\tthis.operations.callsCompleted++;\n\t}\n\n\t/**\n\t * Record webhook received\n\t */\n\trecordWebhook(processed: boolean): void {\n\t\tthis.operations.webhooksReceived++;\n\t\tif (processed) {\n\t\t\tthis.operations.webhooksProcessed++;\n\t\t} else {\n\t\t\tthis.operations.webhooksFailed++;\n\t\t}\n\t}\n\n\t/**\n\t * Get aggregated metrics for a time window\n\t */\n\tgetAggregatedMetrics(windowMs: number = 5 * 60 * 1000): AggregatedMetrics {\n\t\tconst cutoff = Date.now() - windowMs;\n\t\tconst filtered = this.requests.filter(\n\t\t\t(r) => r.timestamp.getTime() > cutoff\n\t\t);\n\n\t\tconst successfulRequests = filtered.filter((r) => r.success).length;\n\t\tconst failedRequests = filtered.length - successfulRequests;\n\t\tconst latencies = filtered.map((r) => r.latencyMs).sort((a, b) => a - b);\n\n\t\t// Calculate percentiles\n\t\tconst getPercentile = (arr: number[], p: number): number => {\n\t\t\tif (arr.length === 0) return 0;\n\t\t\tconst index = Math.ceil((p / 100) * arr.length) - 1;\n\t\t\treturn arr[Math.max(0, index)];\n\t\t};\n\n\t\t// Group by endpoint\n\t\tconst byEndpoint: Record<\n\t\t\tstring,\n\t\t\t{ count: number; errors: number; totalLatency: number }\n\t\t> = {};\n\t\tfor (const r of filtered) {\n\t\t\tif (!byEndpoint[r.endpoint]) {\n\t\t\t\tbyEndpoint[r.endpoint] = { count: 0, errors: 0, totalLatency: 0 };\n\t\t\t}\n\t\t\tbyEndpoint[r.endpoint].count++;\n\t\t\tbyEndpoint[r.endpoint].totalLatency += r.latencyMs;\n\t\t\tif (!r.success) {\n\t\t\t\tbyEndpoint[r.endpoint].errors++;\n\t\t\t}\n\t\t}\n\n\t\t// Group by status code\n\t\tconst byStatusCode: Record<number, number> = {};\n\t\tfor (const r of filtered) {\n\t\t\tbyStatusCode[r.statusCode] = (byStatusCode[r.statusCode] || 0) + 1;\n\t\t}\n\n\t\treturn {\n\t\t\ttotalRequests: filtered.length,\n\t\t\tsuccessfulRequests,\n\t\t\tfailedRequests,\n\t\t\terrorRate:\n\t\t\t\tfiltered.length > 0 ? failedRequests / filtered.length : 0,\n\t\t\tlatency: {\n\t\t\t\tp50: getPercentile(latencies, 50),\n\t\t\t\tp95: getPercentile(latencies, 95),\n\t\t\t\tp99: getPercentile(latencies, 99),\n\t\t\t\tavg:\n\t\t\t\t\tlatencies.length > 0\n\t\t\t\t\t\t? latencies.reduce((a, b) => a + b, 0) / latencies.length\n\t\t\t\t\t\t: 0,\n\t\t\t\tmin: latencies[0] || 0,\n\t\t\t\tmax: latencies[latencies.length - 1] || 0,\n\t\t\t},\n\t\t\tbyEndpoint: Object.fromEntries(\n\t\t\t\tObject.entries(byEndpoint).map(([ep, data]) => [\n\t\t\t\t\tep,\n\t\t\t\t\t{\n\t\t\t\t\t\tcount: data.count,\n\t\t\t\t\t\terrors: data.errors,\n\t\t\t\t\t\tavgLatency: data.totalLatency / data.count,\n\t\t\t\t\t},\n\t\t\t\t])\n\t\t\t),\n\t\t\tbyStatusCode,\n\t\t};\n\t}\n\n\t/**\n\t * Get operation metrics\n\t */\n\tgetOperationMetrics(): OperationMetrics {\n\t\treturn { ...this.operations };\n\t}\n\n\t/**\n\t * Get health score (0-100)\n\t */\n\tgetHealthScore(windowMs: number = 5 * 60 * 1000): number {\n\t\tconst metrics = this.getAggregatedMetrics(windowMs);\n\n\t\tif (metrics.totalRequests === 0) {\n\t\t\treturn 100; // No requests, assume healthy\n\t\t}\n\n\t\t// Factors:\n\t\t// - Error rate (weight: 50%)\n\t\t// - Latency (weight: 30%)\n\t\t// - 5xx errors (weight: 20%)\n\n\t\t// Error rate score (0 = 100%, 10%+ = 0)\n\t\tconst errorScore = Math.max(0, 100 - metrics.errorRate * 1000);\n\n\t\t// Latency score (0ms = 100, 3000ms+ = 0)\n\t\tconst latencyScore = Math.max(0, 100 - (metrics.latency.p95 / 3000) * 100);\n\n\t\t// 5xx score\n\t\tconst total5xx = Object.entries(metrics.byStatusCode)\n\t\t\t.filter(([code]) => parseInt(code) >= 500)\n\t\t\t.reduce((sum, [, count]) => sum + count, 0);\n\t\tconst rate5xx = total5xx / metrics.totalRequests;\n\t\tconst score5xx = Math.max(0, 100 - rate5xx * 1000);\n\n\t\treturn Math.round(errorScore * 0.5 + latencyScore * 0.3 + score5xx * 0.2);\n\t}\n\n\t/**\n\t * Reset metrics\n\t */\n\treset(): void {\n\t\tthis.requests = [];\n\t\tthis.operations = {\n\t\t\tsmsSent: 0,\n\t\t\tsmsDelivered: 0,\n\t\t\tsmsFailed: 0,\n\t\t\tcallsInitiated: 0,\n\t\t\tcallsCompleted: 0,\n\t\t\tcallsFailed: 0,\n\t\t\twebhooksReceived: 0,\n\t\t\twebhooksProcessed: 0,\n\t\t\twebhooksFailed: 0,\n\t\t};\n\t}\n\n\t/**\n\t * Stop cleanup interval\n\t */\n\tstop(): void {\n\t\tif (this.cleanupInterval) {\n\t\t\tclearInterval(this.cleanupInterval);\n\t\t}\n\t}\n}\n\n// =============================================================================\n// SINGLETON INSTANCE\n// =============================================================================\n\nexport const telnyxMetrics = new MetricsCollector();\n\n// =============================================================================\n// CONVENIENCE FUNCTIONS\n// =============================================================================\n\n/**\n * Create a request timer\n */\nexport function startRequestTimer(\n\tendpoint: string,\n\tmethod: string,\n\tcompanyId?: string,\n\tcorrelationId?: string\n): { end: (statusCode: number, success: boolean) => void } {\n\tconst startTime = Date.now();\n\n\treturn {\n\t\tend: (statusCode: number, success: boolean) => {\n\t\t\ttelnyxMetrics.recordRequest({\n\t\t\t\tendpoint,\n\t\t\t\tmethod,\n\t\t\t\tstatusCode,\n\t\t\t\tlatencyMs: Date.now() - startTime,\n\t\t\t\tsuccess,\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\tcompanyId,\n\t\t\t\tcorrelationId,\n\t\t\t});\n\t\t},\n\t};\n}\n\n/**\n * Get a summary for monitoring dashboards\n */\nexport function getMetricsSummary(): {\n\thealth: number;\n\tmetrics: AggregatedMetrics;\n\toperations: OperationMetrics;\n} {\n\treturn {\n\t\thealth: telnyxMetrics.getHealthScore(),\n\t\tmetrics: telnyxMetrics.getAggregatedMetrics(),\n\t\toperations: telnyxMetrics.getOperationMetrics(),\n\t};\n}\n\n/**\n * Format metrics for logging\n */\nexport function formatMetricsForLogging(): string {\n\tconst summary = getMetricsSummary();\n\tconst { metrics, operations, health } = summary;\n\n\treturn [\n\t\t`Health Score: ${health}/100`,\n\t\t`Requests: ${metrics.totalRequests} (${metrics.failedRequests} failed)`,\n\t\t`Error Rate: ${(metrics.errorRate * 100).toFixed(2)}%`,\n\t\t`Latency: p50=${metrics.latency.p50}ms p95=${metrics.latency.p95}ms`,\n\t\t`SMS: ${operations.smsSent} sent, ${operations.smsDelivered} delivered, ${operations.smsFailed} failed`,\n\t\t`Calls: ${operations.callsInitiated} initiated, ${operations.callsCompleted} completed`,\n\t\t`Webhooks: ${operations.webhooksReceived} received, ${operations.webhooksFailed} failed`,\n\t].join(\" | \");\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4267, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/api.ts"],"sourcesContent":["/**\n * Telnyx API Client\n *\n * Production-ready API client with:\n * - Configurable timeouts\n * - Automatic retries with exponential backoff\n * - Rate limiting\n * - Circuit breaker protection\n * - Structured logging\n * - Metrics collection\n */\n\nimport \"server-only\";\n\nimport { telnyxLogger } from \"./logger\";\nimport { withRetry, generateCorrelationId, type RetryOptions } from \"./retry\";\nimport { withRateLimit, type RateLimitEndpoint } from \"./rate-limiter\";\nimport {\n\tcreateErrorFromResponse,\n\tcreateErrorFromException,\n\tTelnyxError,\n\tTelnyxTimeoutError,\n} from \"./errors\";\nimport { startRequestTimer } from \"./metrics\";\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nconst TELNYX_BASE_URL = \"https://api.telnyx.com/v2\";\nconst TELNYX_PUBLIC_BASE_URL = \"https://api.telnyx.com\";\n\n// Timeout configuration by operation type\nexport const TIMEOUT_CONFIG = {\n\tdefault: 30000, // 30 seconds\n\tsms: 10000, // 10 seconds\n\tvoice: 30000, // 30 seconds\n\tlookup: 5000, // 5 seconds\n\twebhook: 2000, // 2 seconds\n\tbalance: 5000, // 5 seconds\n} as const;\n\nexport type TimeoutType = keyof typeof TIMEOUT_CONFIG;\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface TelnyxRequestOptions {\n\tmethod?: \"GET\" | \"POST\" | \"PUT\" | \"DELETE\" | \"PATCH\";\n\tbody?: Record<string, unknown>;\n\ttimeout?: number;\n\ttimeoutType?: TimeoutType;\n\trateLimitEndpoint?: RateLimitEndpoint;\n\tcompanyId?: string;\n\tcorrelationId?: string;\n\tskipRetry?: boolean;\n\tskipRateLimit?: boolean;\n\tretryOptions?: Partial<RetryOptions>;\n}\n\nexport interface TelnyxResponse<T> {\n\tsuccess: boolean;\n\tdata?: T;\n\terror?: string;\n\terrorCode?: string;\n\tcorrelationId?: string;\n\tlatencyMs?: number;\n}\n\n// =============================================================================\n// CORE REQUEST FUNCTION\n// =============================================================================\n\n/**\n * Make an authenticated request to the Telnyx API\n * with full production features (retry, rate limit, timeout, metrics)\n */\nexport async function telnyxRequest<TResponse>(\n\tpath: string,\n\toptions: TelnyxRequestOptions = {}\n): Promise<TelnyxResponse<TResponse>> {\n\tconst {\n\t\tmethod = \"GET\",\n\t\tbody,\n\t\ttimeout,\n\t\ttimeoutType = \"default\",\n\t\trateLimitEndpoint = \"default\",\n\t\tcompanyId,\n\t\tcorrelationId = generateCorrelationId(),\n\t\tskipRetry = false,\n\t\tskipRateLimit = false,\n\t\tretryOptions = {},\n\t} = options;\n\n\tconst apiKey = process.env.TELNYX_API_KEY;\n\tif (!apiKey) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"TELNYX_API_KEY is not configured\",\n\t\t\terrorCode: \"CONFIG_ERROR\",\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// Build request URL\n\tconst hasProtocol = /^https?:\\/\\//i.test(path);\n\tconst normalizedPath =\n\t\thasProtocol || path.startsWith(\"/\") ? path : `/${path}`;\n\tconst requestUrl = hasProtocol\n\t\t? normalizedPath\n\t\t: normalizedPath.startsWith(\"/public/\")\n\t\t\t? `${TELNYX_PUBLIC_BASE_URL}${normalizedPath}`\n\t\t\t: `${TELNYX_BASE_URL}${normalizedPath}`;\n\n\t// Determine timeout\n\tconst effectiveTimeout = timeout || TIMEOUT_CONFIG[timeoutType];\n\n\t// Log request start\n\ttelnyxLogger.debug(\"API request started\", {\n\t\tcorrelationId,\n\t\tendpoint: path,\n\t\tmethod,\n\t\tcompanyId,\n\t});\n\n\t// Start metrics timer\n\tconst timer = startRequestTimer(path, method, companyId, correlationId);\n\n\t// Create the actual fetch function\n\tconst executeFetch = async (): Promise<TelnyxResponse<TResponse>> => {\n\t\tconst startTime = Date.now();\n\n\t\t// Create AbortController for timeout\n\t\tconst controller = new AbortController();\n\t\tconst timeoutId = setTimeout(() => controller.abort(), effectiveTimeout);\n\n\t\ttry {\n\t\t\tconst response = await fetch(requestUrl, {\n\t\t\t\tmethod,\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\"X-Correlation-ID\": correlationId,\n\t\t\t\t},\n\t\t\t\tbody: body ? JSON.stringify(body) : undefined,\n\t\t\t\tsignal: controller.signal,\n\t\t\t\t// Enable keep-alive for connection reuse\n\t\t\t\tkeepalive: true,\n\t\t\t});\n\n\t\t\tclearTimeout(timeoutId);\n\n\t\t\tconst latencyMs = Date.now() - startTime;\n\n\t\t\t// Parse response\n\t\t\tconst payload = (await response.json().catch(() => ({}))) as\n\t\t\t\t| {\n\t\t\t\t\t\tdata?: TResponse;\n\t\t\t\t\t\terrors?: Array<{ detail?: string; code?: string }>;\n\t\t\t\t  }\n\t\t\t\t| undefined;\n\n\t\t\tif (!response.ok) {\n\t\t\t\t// Record failure metric\n\t\t\t\ttimer.end(response.status, false);\n\n\t\t\t\t// Create typed error\n\t\t\t\tconst error = createErrorFromResponse(response.status, payload, {\n\t\t\t\t\tcorrelationId,\n\t\t\t\t\tendpoint: path,\n\t\t\t\t\tmethod,\n\t\t\t\t\tcompanyId,\n\t\t\t\t});\n\n\t\t\t\ttelnyxLogger.warn(\"API request failed\", {\n\t\t\t\t\tcorrelationId,\n\t\t\t\t\tendpoint: path,\n\t\t\t\t\tstatusCode: response.status,\n\t\t\t\t\terror: error.message,\n\t\t\t\t\tlatencyMs,\n\t\t\t\t});\n\n\t\t\t\t// Throw to trigger retry if retryable\n\t\t\t\tif (error.retryable) {\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: error.message,\n\t\t\t\t\terrorCode: error.code,\n\t\t\t\t\tcorrelationId,\n\t\t\t\t\tlatencyMs,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// Record success metric\n\t\t\ttimer.end(response.status, true);\n\n\t\t\t// Telnyx API sometimes wraps response in \"data\", sometimes returns directly\n\t\t\tconst responseData = payload?.data || payload;\n\n\t\t\ttelnyxLogger.debug(\"API request completed\", {\n\t\t\t\tcorrelationId,\n\t\t\t\tendpoint: path,\n\t\t\t\tstatusCode: response.status,\n\t\t\t\tlatencyMs,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tdata: responseData as TResponse,\n\t\t\t\tcorrelationId,\n\t\t\t\tlatencyMs,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\tclearTimeout(timeoutId);\n\n\t\t\tconst latencyMs = Date.now() - startTime;\n\n\t\t\t// Handle timeout\n\t\t\tif (error instanceof Error && error.name === \"AbortError\") {\n\t\t\t\ttimer.end(0, false);\n\n\t\t\t\tconst timeoutError = new TelnyxTimeoutError(\n\t\t\t\t\t`Request timed out after ${effectiveTimeout}ms`,\n\t\t\t\t\teffectiveTimeout,\n\t\t\t\t\t{ correlationId, endpoint: path, method }\n\t\t\t\t);\n\n\t\t\t\ttelnyxLogger.error(\"API request timed out\", {\n\t\t\t\t\tcorrelationId,\n\t\t\t\t\tendpoint: path,\n\t\t\t\t\ttimeoutMs: effectiveTimeout,\n\t\t\t\t\tlatencyMs,\n\t\t\t\t});\n\n\t\t\t\tthrow timeoutError; // Throw to trigger retry\n\t\t\t}\n\n\t\t\t// Handle TelnyxError (already processed)\n\t\t\tif (error instanceof TelnyxError) {\n\t\t\t\tthrow error;\n\t\t\t}\n\n\t\t\t// Handle network/other errors\n\t\t\ttimer.end(0, false);\n\n\t\t\tconst wrappedError = createErrorFromException(error, {\n\t\t\t\tcorrelationId,\n\t\t\t\tendpoint: path,\n\t\t\t\tmethod,\n\t\t\t});\n\n\t\t\ttelnyxLogger.error(\"API request error\", {\n\t\t\t\tcorrelationId,\n\t\t\t\tendpoint: path,\n\t\t\t\terror: wrappedError.message,\n\t\t\t\tlatencyMs,\n\t\t\t});\n\n\t\t\tthrow wrappedError;\n\t\t}\n\t};\n\n\t// Apply rate limiting and retry logic\n\ttry {\n\t\tlet fetchFn = executeFetch;\n\n\t\t// Wrap with retry logic if not skipped\n\t\tif (!skipRetry) {\n\t\t\tconst originalFn = fetchFn;\n\t\t\tfetchFn = () =>\n\t\t\t\twithRetry(originalFn, {\n\t\t\t\t\tendpoint: path,\n\t\t\t\t\tcorrelationId,\n\t\t\t\t\tconfig: retryOptions.config,\n\t\t\t\t\tonRetry: (attempt, error, delayMs) => {\n\t\t\t\t\t\ttelnyxLogger.info(\"Retrying request\", {\n\t\t\t\t\t\t\tcorrelationId,\n\t\t\t\t\t\t\tendpoint: path,\n\t\t\t\t\t\t\tattempt,\n\t\t\t\t\t\t\tdelayMs,\n\t\t\t\t\t\t\terror: error.message,\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t}\n\n\t\t// Wrap with rate limiting if not skipped\n\t\tif (!skipRateLimit) {\n\t\t\tconst fnWithRetry = fetchFn;\n\t\t\tfetchFn = () =>\n\t\t\t\twithRateLimit(fnWithRetry, {\n\t\t\t\t\tendpoint: rateLimitEndpoint,\n\t\t\t\t\tcompanyId,\n\t\t\t\t\tcorrelationId,\n\t\t\t\t});\n\t\t}\n\n\t\treturn await fetchFn();\n\t} catch (error) {\n\t\t// Convert any remaining errors to response format\n\t\tif (error instanceof TelnyxError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.message,\n\t\t\t\terrorCode: error.code,\n\t\t\t\tcorrelationId,\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\tcorrelationId,\n\t\t};\n\t}\n}\n\n// =============================================================================\n// CONVENIENCE METHODS\n// =============================================================================\n\n/**\n * GET request\n */\nexport async function telnyxGet<T>(\n\tpath: string,\n\toptions: Omit<TelnyxRequestOptions, \"method\" | \"body\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, { ...options, method: \"GET\" });\n}\n\n/**\n * POST request\n */\nexport async function telnyxPost<T>(\n\tpath: string,\n\tbody: Record<string, unknown>,\n\toptions: Omit<TelnyxRequestOptions, \"method\" | \"body\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, { ...options, method: \"POST\", body });\n}\n\n/**\n * PUT request\n */\nexport async function telnyxPut<T>(\n\tpath: string,\n\tbody: Record<string, unknown>,\n\toptions: Omit<TelnyxRequestOptions, \"method\" | \"body\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, { ...options, method: \"PUT\", body });\n}\n\n/**\n * PATCH request\n */\nexport async function telnyxPatch<T>(\n\tpath: string,\n\tbody: Record<string, unknown>,\n\toptions: Omit<TelnyxRequestOptions, \"method\" | \"body\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, { ...options, method: \"PATCH\", body });\n}\n\n/**\n * DELETE request\n */\nexport async function telnyxDelete<T>(\n\tpath: string,\n\toptions: Omit<TelnyxRequestOptions, \"method\" | \"body\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, { ...options, method: \"DELETE\" });\n}\n\n// =============================================================================\n// SPECIALIZED REQUESTS\n// =============================================================================\n\n/**\n * SMS-specific request with appropriate timeout and rate limiting\n */\nexport async function telnyxSmsRequest<T>(\n\tpath: string,\n\toptions: Omit<TelnyxRequestOptions, \"timeoutType\" | \"rateLimitEndpoint\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, {\n\t\t...options,\n\t\ttimeoutType: \"sms\",\n\t\trateLimitEndpoint: \"sms\",\n\t});\n}\n\n/**\n * Voice-specific request with appropriate timeout and rate limiting\n */\nexport async function telnyxVoiceRequest<T>(\n\tpath: string,\n\toptions: Omit<TelnyxRequestOptions, \"timeoutType\" | \"rateLimitEndpoint\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, {\n\t\t...options,\n\t\ttimeoutType: \"voice\",\n\t\trateLimitEndpoint: \"voice\",\n\t});\n}\n\n/**\n * Lookup-specific request with appropriate timeout\n */\nexport async function telnyxLookupRequest<T>(\n\tpath: string,\n\toptions: Omit<TelnyxRequestOptions, \"timeoutType\" | \"rateLimitEndpoint\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, {\n\t\t...options,\n\t\ttimeoutType: \"lookup\",\n\t\trateLimitEndpoint: \"lookup\",\n\t});\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;;CAUC;;;;;;;;;;;;;;;;;;;;;;AAED;AAEA;AACA;AACA;AACA;AAMA;;;;;;;AAEA,gFAAgF;AAChF,gBAAgB;AAChB,gFAAgF;AAEhF,MAAM,kBAAkB;AACxB,MAAM,yBAAyB;AAGxB,MAAM,iBAAiB;IAC7B,SAAS;IACT,KAAK;IACL,OAAO;IACP,QAAQ;IACR,SAAS;IACT,SAAS;AACV;AAsCO,eAAe,cACrB,IAAY,EACZ,UAAgC,CAAC,CAAC;IAElC,MAAM,EACL,SAAS,KAAK,EACd,IAAI,EACJ,OAAO,EACP,cAAc,SAAS,EACvB,oBAAoB,SAAS,EAC7B,SAAS,EACT,gBAAgB,IAAA,qKAAqB,GAAE,EACvC,YAAY,KAAK,EACjB,gBAAgB,KAAK,EACrB,eAAe,CAAC,CAAC,EACjB,GAAG;IAEJ,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc;IACzC,IAAI,CAAC,QAAQ;QACZ,OAAO;YACN,SAAS;YACT,OAAO;YACP,WAAW;YACX;QACD;IACD;IAEA,oBAAoB;IACpB,MAAM,cAAc,gBAAgB,IAAI,CAAC;IACzC,MAAM,iBACL,eAAe,KAAK,UAAU,CAAC,OAAO,OAAO,CAAC,CAAC,EAAE,MAAM;IACxD,MAAM,aAAa,cAChB,iBACA,eAAe,UAAU,CAAC,cACzB,GAAG,yBAAyB,gBAAgB,GAC5C,GAAG,kBAAkB,gBAAgB;IAEzC,oBAAoB;IACpB,MAAM,mBAAmB,WAAW,cAAc,CAAC,YAAY;IAE/D,oBAAoB;IACpB,6JAAY,CAAC,KAAK,CAAC,uBAAuB;QACzC;QACA,UAAU;QACV;QACA;IACD;IAEA,sBAAsB;IACtB,MAAM,QAAQ,IAAA,mKAAiB,EAAC,MAAM,QAAQ,WAAW;IAEzD,mCAAmC;IACnC,MAAM,eAAe;QACpB,MAAM,YAAY,KAAK,GAAG;QAE1B,qCAAqC;QACrC,MAAM,aAAa,IAAI;QACvB,MAAM,YAAY,WAAW,IAAM,WAAW,KAAK,IAAI;QAEvD,IAAI;YACH,MAAM,WAAW,MAAM,MAAM,YAAY;gBACxC;gBACA,SAAS;oBACR,eAAe,CAAC,OAAO,EAAE,QAAQ;oBACjC,gBAAgB;oBAChB,oBAAoB;gBACrB;gBACA,MAAM,OAAO,KAAK,SAAS,CAAC,QAAQ;gBACpC,QAAQ,WAAW,MAAM;gBACzB,yCAAyC;gBACzC,WAAW;YACZ;YAEA,aAAa;YAEb,MAAM,YAAY,KAAK,GAAG,KAAK;YAE/B,iBAAiB;YACjB,MAAM,UAAW,MAAM,SAAS,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;YAOtD,IAAI,CAAC,SAAS,EAAE,EAAE;gBACjB,wBAAwB;gBACxB,MAAM,GAAG,CAAC,SAAS,MAAM,EAAE;gBAE3B,qBAAqB;gBACrB,MAAM,QAAQ,IAAA,wKAAuB,EAAC,SAAS,MAAM,EAAE,SAAS;oBAC/D;oBACA,UAAU;oBACV;oBACA;gBACD;gBAEA,6JAAY,CAAC,IAAI,CAAC,sBAAsB;oBACvC;oBACA,UAAU;oBACV,YAAY,SAAS,MAAM;oBAC3B,OAAO,MAAM,OAAO;oBACpB;gBACD;gBAEA,sCAAsC;gBACtC,IAAI,MAAM,SAAS,EAAE;oBACpB,MAAM;gBACP;gBAEA,OAAO;oBACN,SAAS;oBACT,OAAO,MAAM,OAAO;oBACpB,WAAW,MAAM,IAAI;oBACrB;oBACA;gBACD;YACD;YAEA,wBAAwB;YACxB,MAAM,GAAG,CAAC,SAAS,MAAM,EAAE;YAE3B,4EAA4E;YAC5E,MAAM,eAAe,SAAS,QAAQ;YAEtC,6JAAY,CAAC,KAAK,CAAC,yBAAyB;gBAC3C;gBACA,UAAU;gBACV,YAAY,SAAS,MAAM;gBAC3B;YACD;YAEA,OAAO;gBACN,SAAS;gBACT,MAAM;gBACN;gBACA;YACD;QACD,EAAE,OAAO,OAAO;YACf,aAAa;YAEb,MAAM,YAAY,KAAK,GAAG,KAAK;YAE/B,iBAAiB;YACjB,IAAI,iBAAiB,SAAS,MAAM,IAAI,KAAK,cAAc;gBAC1D,MAAM,GAAG,CAAC,GAAG;gBAEb,MAAM,eAAe,IAAI,mKAAkB,CAC1C,CAAC,wBAAwB,EAAE,iBAAiB,EAAE,CAAC,EAC/C,kBACA;oBAAE;oBAAe,UAAU;oBAAM;gBAAO;gBAGzC,6JAAY,CAAC,KAAK,CAAC,yBAAyB;oBAC3C;oBACA,UAAU;oBACV,WAAW;oBACX;gBACD;gBAEA,MAAM,cAAc,yBAAyB;YAC9C;YAEA,yCAAyC;YACzC,IAAI,iBAAiB,4JAAW,EAAE;gBACjC,MAAM;YACP;YAEA,8BAA8B;YAC9B,MAAM,GAAG,CAAC,GAAG;YAEb,MAAM,eAAe,IAAA,yKAAwB,EAAC,OAAO;gBACpD;gBACA,UAAU;gBACV;YACD;YAEA,6JAAY,CAAC,KAAK,CAAC,qBAAqB;gBACvC;gBACA,UAAU;gBACV,OAAO,aAAa,OAAO;gBAC3B;YACD;YAEA,MAAM;QACP;IACD;IAEA,sCAAsC;IACtC,IAAI;QACH,IAAI,UAAU;QAEd,uCAAuC;QACvC,IAAI,CAAC,WAAW;YACf,MAAM,aAAa;YACnB,UAAU,IACT,IAAA,yJAAS,EAAC,YAAY;oBACrB,UAAU;oBACV;oBACA,QAAQ,aAAa,MAAM;oBAC3B,SAAS,CAAC,SAAS,OAAO;wBACzB,6JAAY,CAAC,IAAI,CAAC,oBAAoB;4BACrC;4BACA,UAAU;4BACV;4BACA;4BACA,OAAO,MAAM,OAAO;wBACrB;oBACD;gBACD;QACF;QAEA,yCAAyC;QACzC,IAAI,CAAC,eAAe;YACnB,MAAM,cAAc;YACpB,UAAU,IACT,IAAA,uKAAa,EAAC,aAAa;oBAC1B,UAAU;oBACV;oBACA;gBACD;QACF;QAEA,OAAO,MAAM;IACd,EAAE,OAAO,OAAO;QACf,kDAAkD;QAClD,IAAI,iBAAiB,4JAAW,EAAE;YACjC,OAAO;gBACN,SAAS;gBACT,OAAO,MAAM,OAAO;gBACpB,WAAW,MAAM,IAAI;gBACrB;YACD;QACD;QAEA,OAAO;YACN,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;YAChD;QACD;IACD;AACD;AASO,eAAe,UACrB,IAAY,EACZ,UAAyD,CAAC,CAAC;IAE3D,OAAO,cAAiB,MAAM;QAAE,GAAG,OAAO;QAAE,QAAQ;IAAM;AAC3D;AAKO,eAAe,WACrB,IAAY,EACZ,IAA6B,EAC7B,UAAyD,CAAC,CAAC;IAE3D,OAAO,cAAiB,MAAM;QAAE,GAAG,OAAO;QAAE,QAAQ;QAAQ;IAAK;AAClE;AAKO,eAAe,UACrB,IAAY,EACZ,IAA6B,EAC7B,UAAyD,CAAC,CAAC;IAE3D,OAAO,cAAiB,MAAM;QAAE,GAAG,OAAO;QAAE,QAAQ;QAAO;IAAK;AACjE;AAKO,eAAe,YACrB,IAAY,EACZ,IAA6B,EAC7B,UAAyD,CAAC,CAAC;IAE3D,OAAO,cAAiB,MAAM;QAAE,GAAG,OAAO;QAAE,QAAQ;QAAS;IAAK;AACnE;AAKO,eAAe,aACrB,IAAY,EACZ,UAAyD,CAAC,CAAC;IAE3D,OAAO,cAAiB,MAAM;QAAE,GAAG,OAAO;QAAE,QAAQ;IAAS;AAC9D;AASO,eAAe,iBACrB,IAAY,EACZ,UAA2E,CAAC,CAAC;IAE7E,OAAO,cAAiB,MAAM;QAC7B,GAAG,OAAO;QACV,aAAa;QACb,mBAAmB;IACpB;AACD;AAKO,eAAe,mBACrB,IAAY,EACZ,UAA2E,CAAC,CAAC;IAE7E,OAAO,cAAiB,MAAM;QAC7B,GAAG,OAAO;QACV,aAAa;QACb,mBAAmB;IACpB;AACD;AAKO,eAAe,oBACrB,IAAY,EACZ,UAA2E,CAAC,CAAC;IAE7E,OAAO,cAAiB,MAAM;QAC7B,GAAG,OAAO;QACV,aAAa;QACb,mBAAmB;IACpB;AACD"}},
    {"offset": {"line": 4563, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/telnyx/ten-dlc.ts"],"sourcesContent":["import \"server-only\";\nimport { telnyxRequest } from \"./api\";\n\nexport type TenDlcBrandPayload = {\n\tentityType: \"PRIVATE_PROFIT\" | \"PUBLIC_PROFIT\" | \"NON_PROFIT\";\n\tdisplayName: string;\n\tcompanyName: string;\n\tfirstName: string;\n\tlastName: string;\n\tein: string;\n\tphone: string;\n\tstreet: string;\n\tcity: string;\n\tstate: string;\n\tpostalCode: string;\n\tcountry: string;\n\temail: string;\n\twebsite?: string;\n\tvertical: string;\n\tisReseller?: boolean;\n\tmock?: boolean;\n\tmobilePhone?: string;\n\tbusinessContactEmail?: string;\n\tstockSymbol?: string;\n\tstockExchange?: string;\n\tipAddress?: string;\n\twebhookURL?: string;\n\twebhookFailoverURL?: string;\n};\n\nexport async function createTenDlcBrand(payload: TenDlcBrandPayload) {\n\treturn telnyxRequest<{ brandId: string; status: string }>(\"/10dlc/brand\", {\n\t\tmethod: \"POST\",\n\t\tbody: payload,\n\t});\n}\n\nexport async function getTenDlcBrand(brandId: string) {\n\treturn telnyxRequest<{ brandId: string; status: string }>(\n\t\t`/10dlc/brand/${brandId}`,\n\t);\n}\n\nexport type TenDlcCampaignPayload = {\n\tbrandId: string;\n\tusecase: string;\n\tdescription: string;\n\tmessageFlow: string;\n\thelpMessage: string;\n\thelpKeywords?: string;\n\toptinKeywords?: string;\n\toptinMessage?: string;\n\toptoutKeywords?: string;\n\toptoutMessage?: string;\n\tsample1: string;\n\tsample2?: string;\n\tsample3?: string;\n\tsample4?: string;\n\tsample5?: string;\n\tautoRenewal: boolean;\n\tsubUsecases?: string[];\n\ttermsAndConditions?: boolean;\n\tprivacyPolicyLink?: string;\n\ttermsAndConditionsLink?: string;\n\taffiliateMarketing?: boolean;\n\tageGated?: boolean;\n\tdirectLending?: boolean;\n\tembeddedLink?: boolean;\n\tembeddedPhone?: boolean;\n\tnumberPool?: boolean;\n\tsubscriberHelp?: boolean;\n\tsubscriberOptin?: boolean;\n\tsubscriberOptout?: boolean;\n\treferenceId?: string;\n\tmnoIds?: number[];\n\ttag?: string[];\n};\n\nexport async function createTenDlcCampaign(payload: TenDlcCampaignPayload) {\n\treturn telnyxRequest<{ campaignId: string }>(\"/10dlc/campaignBuilder\", {\n\t\tmethod: \"POST\",\n\t\tbody: payload,\n\t});\n}\n\nexport async function getTenDlcCampaign(campaignId: string) {\n\treturn telnyxRequest<{ id: string; status: string; usecase: string }>(\n\t\t`/10dlc/campaign/${campaignId}`,\n\t);\n}\n\nexport async function attachNumberToCampaign(\n\tcampaignId: string,\n\tphoneNumber: string,\n) {\n\treturn telnyxRequest<{ id: string }>(\n\t\t`/10dlc/campaigns/${campaignId}/phone_numbers`,\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: {\n\t\t\t\tphone_numbers: [{ phone_number: phoneNumber }],\n\t\t\t},\n\t\t},\n\t);\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AACA;;;AA6BO,eAAe,kBAAkB,OAA2B;IAClE,OAAO,IAAA,2JAAa,EAAsC,gBAAgB;QACzE,QAAQ;QACR,MAAM;IACP;AACD;AAEO,eAAe,eAAe,OAAe;IACnD,OAAO,IAAA,2JAAa,EACnB,CAAC,aAAa,EAAE,SAAS;AAE3B;AAqCO,eAAe,qBAAqB,OAA8B;IACxE,OAAO,IAAA,2JAAa,EAAyB,0BAA0B;QACtE,QAAQ;QACR,MAAM;IACP;AACD;AAEO,eAAe,kBAAkB,UAAkB;IACzD,OAAO,IAAA,2JAAa,EACnB,CAAC,gBAAgB,EAAE,YAAY;AAEjC;AAEO,eAAe,uBACrB,UAAkB,EAClB,WAAmB;IAEnB,OAAO,IAAA,2JAAa,EACnB,CAAC,iBAAiB,EAAE,WAAW,cAAc,CAAC,EAC9C;QACC,QAAQ;QACR,MAAM;YACL,eAAe;gBAAC;oBAAE,cAAc;gBAAY;aAAE;QAC/C;IACD;AAEF"}},
    {"offset": {"line": 4613, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/messaging-branding.ts"],"sourcesContent":["\"use server\";\n\nimport type { SupabaseClient as SupabaseJsClient } from \"@supabase/supabase-js\";\nimport { revalidatePath } from \"next/cache\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport {\n\tattachNumberToCampaign,\n\tcreateTenDlcBrand,\n\tcreateTenDlcCampaign,\n\tgetTenDlcBrand,\n\tgetTenDlcCampaign,\n} from \"@/lib/telnyx/ten-dlc\";\nimport type { Database } from \"@/types/supabase\";\n\ntype TypedSupabaseClient = SupabaseJsClient<Database>;\n\ntype OwnerContactRow = {\n\tfull_name?: string | null;\n\temail?: string | null;\n\tphone?: string | null;\n};\n\nconst DEFAULT_MESSAGING_PROFILE_ID =\n\tprocess.env.TELNYX_DEFAULT_MESSAGING_PROFILE_ID ||\n\tprocess.env.NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID ||\n\t\"\";\n\nconst NANP_WITH_COUNTRY_DIGITS = 11;\nconst NANP_LOCAL_DIGITS = 10;\nconst WHITESPACE_SPLIT_REGEX = /\\s+/;\n\nfunction formatPhone(phone?: string | null): string | null {\n\tif (!phone) {\n\t\treturn null;\n\t}\n\tconst digits = phone.replace(/\\D/g, \"\");\n\tif (!digits) {\n\t\treturn null;\n\t}\n\tif (digits.length === NANP_WITH_COUNTRY_DIGITS && digits.startsWith(\"1\")) {\n\t\treturn `+${digits}`;\n\t}\n\tif (digits.length === NANP_LOCAL_DIGITS) {\n\t\treturn `+1${digits}`;\n\t}\n\treturn phone.startsWith(\"+\") ? phone : `+${digits}`;\n}\n\nfunction splitName(fullName?: string | null) {\n\tif (!fullName) {\n\t\treturn { first: \"Support\", last: \"Team\" };\n\t}\n\tconst parts = fullName.trim().split(WHITESPACE_SPLIT_REGEX);\n\tif (parts.length === 1) {\n\t\treturn { first: parts[0], last: \"Team\" };\n\t}\n\treturn { first: parts[0], last: parts.slice(1).join(\" \") };\n}\n\nfunction mapIndustryToVertical(industry?: string | null) {\n\tif (!industry) {\n\t\treturn \"PROFESSIONAL\";\n\t}\n\tconst normalized = industry.toLowerCase();\n\tif (normalized.includes(\"plumb\")) {\n\t\treturn \"HOME_SERVICES\";\n\t}\n\tif (normalized.includes(\"hvac\")) {\n\t\treturn \"HOME_SERVICES\";\n\t}\n\tif (normalized.includes(\"electric\")) {\n\t\treturn \"HOME_SERVICES\";\n\t}\n\tif (normalized.includes(\"clean\")) {\n\t\treturn \"PROFESSIONAL\";\n\t}\n\treturn \"PROFESSIONAL\";\n}\n\nasync function upsertBrandRecord(\n\tsupabase: TypedSupabaseClient,\n\tdata: Partial<Database[\"public\"][\"Tables\"][\"messaging_brands\"][\"Insert\"]> & {\n\t\tcompany_id: string;\n\t},\n) {\n\tconst { data: existing } = await supabase\n\t\t.from(\"messaging_brands\")\n\t\t.select(\"id\")\n\t\t.eq(\"company_id\", data.company_id)\n\t\t.maybeSingle();\n\n\tif (existing) {\n\t\tawait supabase\n\t\t\t.from(\"messaging_brands\")\n\t\t\t.update({ ...data, updated_at: new Date().toISOString() })\n\t\t\t.eq(\"id\", existing.id);\n\t} else {\n\t\tawait supabase\n\t\t\t.from(\"messaging_brands\")\n\t\t\t.insert(\n\t\t\t\tdata as Database[\"public\"][\"Tables\"][\"messaging_brands\"][\"Insert\"],\n\t\t\t);\n\t}\n}\n\nasync function upsertCampaignRecord(\n\tsupabase: TypedSupabaseClient,\n\tdata: Partial<\n\t\tDatabase[\"public\"][\"Tables\"][\"messaging_campaigns\"][\"Insert\"]\n\t> & {\n\t\tmessaging_brand_id: string;\n\t\tusecase: string;\n\t},\n) {\n\tconst { data: existing } = await supabase\n\t\t.from(\"messaging_campaigns\")\n\t\t.select(\"id\")\n\t\t.eq(\"messaging_brand_id\", data.messaging_brand_id)\n\t\t.eq(\"usecase\", data.usecase)\n\t\t.maybeSingle();\n\n\tif (existing) {\n\t\tawait supabase\n\t\t\t.from(\"messaging_campaigns\")\n\t\t\t.update({ ...data, updated_at: new Date().toISOString() })\n\t\t\t.eq(\"id\", existing.id);\n\t\treturn existing.id;\n\t}\n\n\tconst { data: inserted } = await supabase\n\t\t.from(\"messaging_campaigns\")\n\t\t.insert(data)\n\t\t.select(\"id\")\n\t\t.single();\n\n\treturn inserted?.id ?? null;\n}\n\n// Telnyx onboarding requires multiple guarded steps\nexport async function ensureMessagingBranding(\n\tcompanyId: string,\n\toptions?: { supabase?: TypedSupabaseClient | null },\n) {\n\tconst supabase = options?.supabase ?? (await createClient());\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Supabase unavailable\" };\n\t}\n\n\tconst { data: company, error } = await supabase\n\t\t.from(\"companies\")\n\t\t.select(\n\t\t\t\"id, name, legal_name, doing_business_as, phone, support_email, support_phone, website, website_url, brand_color, industry, address, city, state, zip_code, owner_id, ein, tax_id\",\n\t\t)\n\t\t.eq(\"id\", companyId)\n\t\t.single();\n\n\tif (error || !company) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error?.message || \"Company not found\",\n\t\t};\n\t}\n\n\tconst { data: ownerContact } = await supabase\n\t\t.from(\"profiles\")\n\t\t.select(\"full_name, email, phone\")\n\t\t.eq(\"id\", company.owner_id)\n\t\t.maybeSingle<OwnerContactRow>();\n\n\tconst contactName = splitName(ownerContact?.full_name);\n\tconst contactEmail =\n\t\townerContact?.email || company.support_email || \"support@example.com\";\n\tconst contactPhone =\n\t\tformatPhone(ownerContact?.phone) ||\n\t\tformatPhone(company.support_phone) ||\n\t\tformatPhone(company.phone) ||\n\t\t\"+18314280176\";\n\n\tconst { data: brandRow } = await supabase\n\t\t.from(\"messaging_brands\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.maybeSingle();\n\n\tif (brandRow?.telnyx_brand_id) {\n\t\tconst brandStatus = await getTenDlcBrand(brandRow.telnyx_brand_id);\n\t\tif (brandStatus.success && brandStatus.data) {\n\t\t\tawait supabase\n\t\t\t\t.from(\"messaging_brands\")\n\t\t\t\t.update({\n\t\t\t\t\tstatus: brandStatus.data.status,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", brandRow.id);\n\t\t}\n\t}\n\n\tif (!brandRow?.telnyx_brand_id) {\n\t\tconst brandPayload = {\n\t\t\tcustomer_reference: companyId,\n\t\t\tbrand_name: company.legal_name || company.name,\n\t\t\tein:\n\t\t\t\tcompany.ein ||\n\t\t\t\tcompany.tax_id ||\n\t\t\t\tprocess.env.FALLBACK_TEST_EIN ||\n\t\t\t\t\"00-0000000\",\n\t\t\tein_issuing_country: \"US\",\n\t\t\tvertical: mapIndustryToVertical(company.industry),\n\t\t\twebsite: company.website || company.website_url || null,\n\t\t\tcompany_type: \"PRIVATE_PROFIT\" as const,\n\t\t\taddress: {\n\t\t\t\tline1: company.address || \"115 Flintlock Lane\",\n\t\t\t\tcity: company.city || \"Ben Lomond\",\n\t\t\t\tstate: company.state || \"CA\",\n\t\t\t\tpostal_code: company.zip_code || \"95005\",\n\t\t\t\tcountry: \"US\",\n\t\t\t},\n\t\t\tcontact: {\n\t\t\t\tfirst_name: contactName.first,\n\t\t\t\tlast_name: contactName.last,\n\t\t\t\temail: contactEmail,\n\t\t\t\tphone: contactPhone,\n\t\t\t},\n\t\t\toptional_attributes: {\n\t\t\t\tdoing_business_as: company.doing_business_as || company.name,\n\t\t\t},\n\t\t};\n\n\t\tconst brandResult = await createTenDlcBrand(brandPayload);\n\t\tif (!(brandResult.success && brandResult.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: brandResult.error || \"Failed to create 10DLC brand\",\n\t\t\t};\n\t\t}\n\n\t\tawait upsertBrandRecord(supabase, {\n\t\t\tcompany_id: companyId,\n\t\t\ttelnyx_brand_id: brandResult.data.id,\n\t\t\tstatus: \"submitted\",\n\t\t\tlegal_name: brandPayload.brand_name,\n\t\t\tdoing_business_as: company.doing_business_as || company.name,\n\t\t\tein: brandPayload.ein,\n\t\t\tvertical: brandPayload.vertical,\n\t\t\twebsite: brandPayload.website,\n\t\t\tsupport_email: contactEmail,\n\t\t\tsupport_phone: contactPhone,\n\t\t\taddress_line1: brandPayload.address.line1,\n\t\t\tcity: brandPayload.address.city,\n\t\t\tstate: brandPayload.address.state,\n\t\t\tpostal_code: brandPayload.address.postal_code,\n\t\t\tbrand_color: company.brand_color,\n\t\t});\n\t}\n\n\trevalidatePath(\"/dashboard/settings/communications/brand\");\n\treturn { success: true };\n}\n\n// Linking campaigns touches several Telnyx APIs sequentially\nexport async function ensureMessagingCampaign(\n\tcompanyId: string,\n\tphoneNumber: { id: string; e164: string },\n\toptions?: { supabase?: TypedSupabaseClient | null },\n) {\n\tconst supabase = options?.supabase ?? (await createClient());\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Supabase unavailable\" };\n\t}\n\n\tconst { data: brand } = await supabase\n\t\t.from(\"messaging_brands\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.maybeSingle();\n\n\tif (!brand?.telnyx_brand_id) {\n\t\tconst brandResult = await ensureMessagingBranding(companyId, {\n\t\t\tsupabase,\n\t\t});\n\t\tif (!brandResult.success) {\n\t\t\treturn brandResult;\n\t\t}\n\t\treturn ensureMessagingCampaign(companyId, phoneNumber);\n\t}\n\n\tconst usecase = \"CUSTOMER_CARE\";\n\n\tconst { data: campaignRow } = await supabase\n\t\t.from(\"messaging_campaigns\")\n\t\t.select(\"*\")\n\t\t.eq(\"messaging_brand_id\", brand.id)\n\t\t.eq(\"usecase\", usecase)\n\t\t.maybeSingle();\n\n\tif (campaignRow?.telnyx_campaign_id) {\n\t\tconst campaignStatus = await getTenDlcCampaign(\n\t\t\tcampaignRow.telnyx_campaign_id,\n\t\t);\n\t\tif (campaignStatus.success && campaignStatus.data) {\n\t\t\tawait supabase\n\t\t\t\t.from(\"messaging_campaigns\")\n\t\t\t\t.update({\n\t\t\t\t\tstatus: campaignStatus.data.status,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", campaignRow.id);\n\t\t}\n\t}\n\n\tlet campaignId = campaignRow?.id ?? null;\n\tlet telnyxCampaignId = campaignRow?.telnyx_campaign_id ?? null;\n\n\tif (!campaignRow?.telnyx_campaign_id) {\n\t\tif (!DEFAULT_MESSAGING_PROFILE_ID) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"TELNYX_DEFAULT_MESSAGING_PROFILE_ID not configured\",\n\t\t\t};\n\t\t}\n\n\t\tconst description = `${brand.doing_business_as || brand.legal_name} provides appointment updates, reminders, and service notifications to existing customers.`;\n\t\tconst sampleMessage = `Hi {{customer_name}}, this is ${\n\t\t\tbrand.doing_business_as || brand.legal_name\n\t\t} confirming your upcoming appointment. Reply HELP for assistance or STOP to opt out.`;\n\n\t\tconst campaignPayload = {\n\t\t\tbrand_id: brand.telnyx_brand_id,\n\t\t\tcampaign_alias: `${companyId}-customer-care`,\n\t\t\tusecase,\n\t\t\tdescription,\n\t\t\tsample_messages: [sampleMessage],\n\t\t\tmessage_flow:\n\t\t\t\t\"Customers opt in during onboarding or by texting our business line. They receive service updates and can opt out by replying STOP.\",\n\t\t\tterms_and_conditions:\n\t\t\t\t\"Msg & data rates may apply. Reply STOP to opt out, HELP for help.\",\n\t\t\thelp_message: `Thanks for contacting ${brand.doing_business_as || brand.legal_name}. Reply STOP to unsubscribe.`,\n\t\t\thelp_phone_number: brand.support_phone || \"+18314280176\",\n\t\t\thelp_email: brand.support_email || \"support@example.com\",\n\t\t\tauto_renewal: true,\n\t\t\tmessage_fee_credits: 0,\n\t\t\topt_in_keywords: [\"START\", \"YES\"],\n\t\t\topt_out_keywords: [\"STOP\", \"UNSUBSCRIBE\"],\n\t\t\topt_in_message:\n\t\t\t\t\"Thanks for opting in to receive messages from us. Reply STOP to opt out.\",\n\t\t\topt_out_message:\n\t\t\t\t\"You have successfully been unsubscribed and will no longer receive messages. Reply START to opt in again.\",\n\t\t};\n\n\t\tconst campaignResult = await createTenDlcCampaign(campaignPayload);\n\t\tif (!(campaignResult.success && campaignResult.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: campaignResult.error || \"Failed to create 10DLC campaign\",\n\t\t\t};\n\t\t}\n\n\t\tcampaignId =\n\t\t\t(await upsertCampaignRecord(supabase, {\n\t\t\t\tmessaging_brand_id: brand.id,\n\t\t\t\ttelnyx_campaign_id: campaignResult.data.id,\n\t\t\t\tstatus: \"submitted\",\n\t\t\t\tusecase,\n\t\t\t\tdescription,\n\t\t\t\tsample_messages: campaignPayload.sample_messages,\n\t\t\t\tmessaging_profile_id: DEFAULT_MESSAGING_PROFILE_ID,\n\t\t\t})) ||\n\t\t\tcampaignRow?.id ||\n\t\t\tnull;\n\t\ttelnyxCampaignId = campaignResult.data.id;\n\t}\n\n\tif (!(campaignId && telnyxCampaignId)) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Campaign not ready\",\n\t\t};\n\t}\n\n\tconst { data: linkRecord } = await supabase\n\t\t.from(\"messaging_campaign_phone_numbers\")\n\t\t.select(\"*\")\n\t\t.eq(\"messaging_campaign_id\", campaignId)\n\t\t.eq(\"phone_number_id\", phoneNumber.id)\n\t\t.maybeSingle();\n\n\tif (!linkRecord?.telnyx_relationship_id) {\n\t\tconst attachResult = await attachNumberToCampaign(\n\t\t\ttelnyxCampaignId,\n\t\t\tphoneNumber.e164,\n\t\t);\n\t\tif (!(attachResult.success && attachResult.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: attachResult.error || \"Failed to link number to campaign\",\n\t\t\t};\n\t\t}\n\n\t\tif (linkRecord) {\n\t\t\tawait supabase\n\t\t\t\t.from(\"messaging_campaign_phone_numbers\")\n\t\t\t\t.update({\n\t\t\t\t\ttelnyx_relationship_id: attachResult.data.id,\n\t\t\t\t\tstatus: \"submitted\",\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", linkRecord.id);\n\t\t} else {\n\t\t\tawait supabase.from(\"messaging_campaign_phone_numbers\").insert({\n\t\t\t\tmessaging_campaign_id: campaignId,\n\t\t\t\tphone_number_id: phoneNumber.id,\n\t\t\t\ttelnyx_relationship_id: attachResult.data.id,\n\t\t\t\tstatus: \"submitted\",\n\t\t\t});\n\t\t}\n\t}\n\n\tawait supabase\n\t\t.from(\"phone_numbers\")\n\t\t.update({\n\t\t\ttelnyx_messaging_profile_id: DEFAULT_MESSAGING_PROFILE_ID,\n\t\t\tmetadata: {\n\t\t\t\tten_dlc_campaign_id: telnyxCampaignId,\n\t\t\t},\n\t\t})\n\t\t.eq(\"id\", phoneNumber.id);\n\n\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\treturn { success: true };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4929, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/telnyx.ts"],"sourcesContent":["/**\n * Telnyx Server Actions\n *\n * Server-side actions for Telnyx VoIP operations:\n * - Phone number management\n * - Call operations\n * - SMS operations\n * - Voicemail operations\n *\n * All actions include proper authentication and authorization checks.\n */\n\n\"use server\";\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { revalidatePath } from \"next/cache\";\nimport { headers } from \"next/headers\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport {\n\tanswerCall,\n\thangupCall,\n\tinitiateCall,\n\trejectCall,\n\tstartRecording,\n\tstopRecording,\n} from \"@/lib/telnyx/calls\";\nimport { TELNYX_CONFIG } from \"@/lib/telnyx/client\";\nimport {\n\tvalidateCallConfig,\n\tvalidateSmsConfig,\n} from \"@/lib/telnyx/config-validator\";\nimport { verifyConnection } from \"@/lib/telnyx/connection-setup\";\nimport { formatPhoneNumber, sendMMS, sendSMS } from \"@/lib/telnyx/messaging\";\nimport { verifyMessagingProfile } from \"@/lib/telnyx/messaging-profile-setup\";\nimport {\n\ttype NumberFeature,\n\ttype NumberType,\n\tpurchaseNumber,\n\treleaseNumber,\n\tsearchAvailableNumbers,\n} from \"@/lib/telnyx/numbers\";\nimport {\n\tverifySmsCapability,\n\tverifyVoiceCapability,\n} from \"@/lib/telnyx/phone-number-setup\";\nimport {\n\ttype CompanyTelnyxSettingsRow,\n\tensureCompanyTelnyxSetup,\n\tfetchCompanyTelnyxSettings,\n} from \"@/lib/telnyx/provision-company\";\nimport type { Database, Json } from \"@/types/supabase\";\nimport { ensureMessagingCampaign } from \"./messaging-branding\";\n\ntype TypedSupabaseClient = SupabaseClient<Database>;\n\nfunction normalizePhoneNumber(phoneNumber: string): string {\n\treturn formatPhoneNumber(phoneNumber);\n}\n\nfunction extractAreaCode(phoneNumber: string): string | null {\n\tconst digits = phoneNumber.replace(/\\D/g, \"\");\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn digits.slice(1, 4);\n\t}\n\tif (digits.length === 10) {\n\t\treturn digits.slice(0, 3);\n\t}\n\treturn null;\n}\n\nconst DEFAULT_MESSAGING_PROFILE_ID =\n\tprocess.env.TELNYX_DEFAULT_MESSAGING_PROFILE_ID ||\n\tprocess.env.NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID ||\n\t\"\";\n\nconst DEFAULT_PHONE_NUMBER_FEATURES: Json = [\"voice\", \"sms\", \"mms\"];\n\nfunction formatDisplayPhoneNumber(phoneNumber: string): string {\n\tconst digits = phoneNumber.replace(/\\D/g, \"\");\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn `+1 (${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;\n\t}\n\tif (digits.length === 10) {\n\t\treturn `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;\n\t}\n\treturn phoneNumber;\n}\n\nasync function getCompanyTelnyxSettings(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string | null,\n): Promise<CompanyTelnyxSettingsRow | null> {\n\tif (!companyId) {\n\t\treturn null;\n\t}\n\n\tconst existing = await fetchCompanyTelnyxSettings(supabase, companyId);\n\tif (existing && existing.status === \"ready\") {\n\t\treturn existing;\n\t}\n\n\tconst provisionResult = await ensureCompanyTelnyxSetup({\n\t\tcompanyId,\n\t\tsupabase,\n\t});\n\n\tif (!provisionResult.success) {\n\t\treturn null;\n\t}\n\n\treturn provisionResult.settings ?? null;\n}\n\nfunction normalizeBaseUrl(url: string): string {\n\tconst trimmed = url.trim().replace(/\\/+$/, \"\");\n\tif (/^https?:\\/\\//i.test(trimmed)) {\n\t\tif (/^http:\\/\\//i.test(trimmed) && !isLocalUrl(trimmed)) {\n\t\t\treturn trimmed.replace(/^http:\\/\\//i, \"https://\");\n\t\t}\n\t\treturn trimmed;\n\t}\n\treturn `https://${trimmed}`;\n}\n\nfunction isLocalUrl(url: string): boolean {\n\tconst lowered = url.toLowerCase();\n\treturn (\n\t\tlowered.includes(\"localhost\") ||\n\t\tlowered.includes(\"127.0.0.1\") ||\n\t\tlowered.includes(\"0.0.0.0\") ||\n\t\tlowered.endsWith(\".local\") ||\n\t\tlowered.includes(\"://local\")\n\t);\n}\n\nfunction shouldUseUrl(url: string): boolean {\n\tif (!url) {\n\t\treturn false;\n\t}\n\tconst trimmed = url.trim();\n\tif (!trimmed) {\n\t\treturn false;\n\t}\n\tconst isHostedProduction =\n\t\t(process.env.VERCEL === \"1\" && process.env.VERCEL_ENV === \"production\") ||\n\t\tprocess.env.DEPLOYMENT_ENV === \"production\";\n\n\tif (isHostedProduction && isLocalUrl(trimmed)) {\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nasync function getBaseAppUrl(): Promise<string | undefined> {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\tfor (const candidate of candidates) {\n\t\tif (candidate && shouldUseUrl(candidate)) {\n\t\t\treturn normalizeBaseUrl(candidate);\n\t\t}\n\t}\n\n\tconst vercelUrl = process.env.VERCEL_URL;\n\tif (vercelUrl && shouldUseUrl(vercelUrl)) {\n\t\treturn normalizeBaseUrl(\n\t\t\tvercelUrl.startsWith(\"http\") ? vercelUrl : `https://${vercelUrl}`,\n\t\t);\n\t}\n\n\ttry {\n\t\tconst hdrs = await headers();\n\t\tconst origin = hdrs.get(\"origin\");\n\t\tif (origin && shouldUseUrl(origin)) {\n\t\t\treturn normalizeBaseUrl(origin);\n\t\t}\n\t\tconst host = hdrs.get(\"host\");\n\t\tif (host && shouldUseUrl(host)) {\n\t\t\tconst protocol = host.includes(\"localhost\") ? \"http\" : \"https\";\n\t\t\treturn normalizeBaseUrl(`${protocol}://${host}`);\n\t\t}\n\t} catch {\n\t\t// headers() not available outside of a request context\n\t}\n\n\treturn undefined;\n}\n\nasync function buildAbsoluteUrl(path: string): Promise<string | undefined> {\n\tconst base = await getBaseAppUrl();\n\tif (!base) {\n\t\treturn undefined;\n\t}\n\tconst normalizedPath = path.startsWith(\"/\") ? path : `/${path}`;\n\treturn `${base}${normalizedPath}`;\n}\n\nasync function getTelnyxWebhookUrl(\n\tcompanyId?: string,\n): Promise<string | undefined> {\n\tif (companyId) {\n\t\treturn buildAbsoluteUrl(`/api/webhooks/telnyx?company=${companyId}`);\n\t}\n\treturn buildAbsoluteUrl(\"/api/webhooks/telnyx\");\n}\n\nasync function getPhoneNumberId(\n\tsupabase: TypedSupabaseClient,\n\tphoneNumber: string,\n): Promise<string | null> {\n\tconst normalized = normalizePhoneNumber(phoneNumber);\n\tconst { data } = await supabase\n\t\t.from(\"phone_numbers\")\n\t\t.select(\"id\")\n\t\t.eq(\"phone_number\", normalized)\n\t\t.is(\"deleted_at\", null)\n\t\t.maybeSingle();\n\n\treturn data?.id ?? null;\n}\n\nasync function ensurePhoneNumberRecordExists(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n\tphoneNumber: string | null,\n): Promise<void> {\n\tif (!phoneNumber) {\n\t\treturn;\n\t}\n\n\tconst normalized = normalizePhoneNumber(phoneNumber);\n\tconst { data } = await supabase\n\t\t.from(\"phone_numbers\")\n\t\t.select(\"id\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"phone_number\", normalized)\n\t\t.limit(1);\n\n\tif (data && data.length > 0) {\n\t\treturn;\n\t}\n\n\tawait supabase.from(\"phone_numbers\").insert({\n\t\tcompany_id: companyId,\n\t\tphone_number: normalized,\n\t\tformatted_number: formatDisplayPhoneNumber(normalized),\n\t\tcountry_code: \"US\",\n\t\tarea_code: extractAreaCode(normalized),\n\t\tnumber_type: \"local\",\n\t\tstatus: \"active\",\n\t\tfeatures: DEFAULT_PHONE_NUMBER_FEATURES,\n\t});\n}\n\nasync function resolveOutboundPhoneNumber(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n\texplicitFrom?: string | null,\n\tdefaultNumber?: string | null,\n): Promise<string | null> {\n\tif (explicitFrom) {\n\t\treturn normalizePhoneNumber(explicitFrom);\n\t}\n\n\tconst normalizedDefault = defaultNumber\n\t\t? normalizePhoneNumber(defaultNumber)\n\t\t: null;\n\n\ttry {\n\t\tconst { data } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"phone_number, number_type\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"active\");\n\n\t\tif (data && data.length > 0) {\n\t\t\tconst tollFree = data.find((n) => n.number_type === \"toll-free\");\n\t\t\tif (tollFree) {\n\t\t\t\treturn normalizePhoneNumber(tollFree.phone_number);\n\t\t\t}\n\n\t\t\tif (normalizedDefault) {\n\t\t\t\tconst defaultExists = data.some(\n\t\t\t\t\t(n) => normalizePhoneNumber(n.phone_number) === normalizedDefault,\n\t\t\t\t);\n\t\t\t\tif (defaultExists) {\n\t\t\t\t\treturn normalizedDefault;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn normalizePhoneNumber(data[0].phone_number);\n\t\t}\n\t} catch (error) {\n\t\tconsole.warn(\n\t\t\t\"Failed to load company phone numbers for outbound selection:\",\n\t\t\terror,\n\t\t);\n\t}\n\n\treturn normalizedDefault;\n}\n\nasync function mergeProviderMetadata(\n\tsupabase: TypedSupabaseClient,\n\tcommunicationId: string,\n\tpatch: Record<string, Json>,\n): Promise<void> {\n\tconst { data } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\"provider_metadata\")\n\t\t.eq(\"id\", communicationId)\n\t\t.maybeSingle();\n\n\tconst currentMetadata =\n\t\t(data?.provider_metadata as Record<string, Json> | null) ?? {};\n\tconst mergedMetadata: Record<string, Json> = {\n\t\t...currentMetadata,\n\t\t...patch,\n\t};\n\n\tawait supabase\n\t\t.from(\"communications\")\n\t\t.update({\n\t\t\tprovider_metadata: mergedMetadata,\n\t\t})\n\t\t.eq(\"id\", communicationId);\n}\n\n// =====================================================================================\n// PHONE NUMBER MANAGEMENT ACTIONS\n// =====================================================================================\n\n/**\n * Search for available phone numbers to purchase\n */\nexport async function searchPhoneNumbers(params: {\n\tareaCode?: string;\n\tnumberType?: NumberType;\n\tfeatures?: NumberFeature[];\n\tlimit?: number;\n}) {\n\ttry {\n\t\tconst result = await searchAvailableNumbers({\n\t\t\tcountryCode: \"US\",\n\t\t\tareaCode: params.areaCode,\n\t\t\tnumberType: params.numberType,\n\t\t\tfeatures: params.features,\n\t\t\tlimit: params.limit || 10,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to search phone numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Purchase a phone number and associate it with the current company\n */\nexport async function purchasePhoneNumber(params: {\n\tphoneNumber: string;\n\tcompanyId: string;\n\tbillingGroupId?: string;\n}) {\n\ttry {\n\t\t// Validate configuration\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tconst callConfig = validateCallConfig();\n\t\tif (!smsConfig.valid || !callConfig.valid) {\n\t\t\tlet errorMessage =\n\t\t\t\t\"Telnyx configuration is incomplete. Please configure all required environment variables.\";\n\n\t\t\t// If we have a suggested profile ID, include it in the error\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} to use it.`;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst normalizedPhoneNumber = normalizePhoneNumber(params.phoneNumber);\n\t\tconst formattedNumber = formatDisplayPhoneNumber(normalizedPhoneNumber);\n\t\tconst areaCode = extractAreaCode(normalizedPhoneNumber);\n\n\t\t// Purchase number from Telnyx\n\t\tconst messagingProfileId = DEFAULT_MESSAGING_PROFILE_ID || undefined;\n\n\t\tconst result = await purchaseNumber({\n\t\t\tphoneNumber: normalizedPhoneNumber,\n\t\t\tconnectionId: TELNYX_CONFIG.connectionId,\n\t\t\tmessagingProfileId,\n\t\t\tbillingGroupId: params.billingGroupId,\n\t\t\tcustomerReference: `company_${params.companyId}`,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\t// Store in database\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: params.companyId,\n\t\t\t\ttelnyx_phone_number_id: result.orderId,\n\t\t\t\ttelnyx_connection_id: TELNYX_CONFIG.connectionId,\n\t\t\t\tphone_number: normalizedPhoneNumber,\n\t\t\t\tformatted_number: formattedNumber,\n\t\t\t\tcountry_code: \"US\",\n\t\t\t\tarea_code: areaCode,\n\t\t\t\tnumber_type: \"local\",\n\t\t\t\tfeatures: [\"voice\", \"sms\"],\n\t\t\t\tstatus: \"pending\",\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\ttry {\n\t\t\tawait ensureMessagingCampaign(\n\t\t\t\tparams.companyId,\n\t\t\t\t{ id: data.id, e164: normalizedPhoneNumber },\n\t\t\t\t{ supabase },\n\t\t\t);\n\t\t} catch (_campaignError) {}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to purchase phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Get all phone numbers for a company\n */\nexport async function getCompanyPhoneNumbers(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get phone numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Update phone number configuration\n */\nasync function updatePhoneNumber(params: {\n\tphoneNumberId: string;\n\troutingRuleId?: string;\n\tforwardToNumber?: string;\n\tvoicemailEnabled?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.update({\n\t\t\t\tcall_routing_rule_id: params.routingRuleId,\n\t\t\t\tforward_to_number: params.forwardToNumber,\n\t\t\t\tvoicemail_enabled: params.voicemailEnabled,\n\t\t\t})\n\t\t\t.eq(\"id\", params.phoneNumberId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to update phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Release (delete) a phone number\n */\nasync function deletePhoneNumber(phoneNumberId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get phone number details\n\t\tconst { data: phoneNumber } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"id\", phoneNumberId)\n\t\t\t.single();\n\n\t\tif (!phoneNumber) {\n\t\t\treturn { success: false, error: \"Phone number not found\" };\n\t\t}\n\n\t\t// Release from Telnyx if we have the ID\n\t\tif (phoneNumber.telnyx_phone_number_id) {\n\t\t\tawait releaseNumber(phoneNumber.telnyx_phone_number_id);\n\t\t}\n\n\t\t// Soft delete in database\n\t\tconst { error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tstatus: \"deleted\",\n\t\t\t})\n\t\t\t.eq(\"id\", phoneNumberId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to delete phone number\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// CALL OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Initiate an outbound call\n */\nexport async function makeCall(params: {\n\tto: string;\n\tfrom: string;\n\tcompanyId: string;\n\tcustomerId?: string;\n\tjobId?: string;\n\tpropertyId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconsole.log(\" makeCall called with params:\", params);\n\n\t\tconst callConfig = validateCallConfig();\n\t\tconsole.log(\" Call config validation:\", callConfig);\n\t\tif (!callConfig.valid) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: callConfig.error || \"Call configuration is invalid\",\n\t\t\t};\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t);\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t\tcompanySettings?.default_outbound_number || null,\n\t\t);\n\n\t\tconst connectionOverride =\n\t\t\tcompanySettings?.call_control_application_id ||\n\t\t\tTELNYX_CONFIG.connectionId;\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings?.default_outbound_number || null,\n\t\t);\n\n\t\tif (!connectionOverride) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"No Telnyx connection configured for this company.\",\n\t\t\t};\n\t\t}\n\n\t\tif (!fromAddress) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured. Please provision numbers first.\",\n\t\t\t};\n\t\t}\n\n\t\t// TEMP: Skip connection verification - Level 2 required for API access\n\t\t// const connectionStatus = await verifyConnection(connectionOverride);\n\t\t// if (connectionStatus.needsFix) {\n\t\t// \treturn {\n\t\t// \t\tsuccess: false,\n\t\t// \t\terror: `Connection configuration issue: ${connectionStatus.issues.join(\", \")}. Run fixConnection() to auto-fix.`,\n\t\t// \t};\n\t\t// }\n\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\n\t\t// TEMP: Skip voice capability check - Level 2 required for API access\n\t\t// const voiceCapability = await verifyVoiceCapability(fromAddress);\n\t\t// if (!voiceCapability.hasVoice) {\n\t\t// \treturn {\n\t\t// \t\tsuccess: false,\n\t\t// \t\terror:\n\t\t// \t\t\tvoiceCapability.error || \"Phone number does not support voice calls\",\n\t\t// \t};\n\t\t// }\n\n\t\tconst telnyxWebhookUrl = await getTelnyxWebhookUrl(params.companyId);\n\t\tconsole.log(\" Webhook URL:\", telnyxWebhookUrl);\n\t\tif (!telnyxWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\n\t\tconsole.log(\" Initiating call:\", {\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\tconnectionId: connectionOverride,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t});\n\n\t\tconst result = await initiateCall({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\tconnectionId: connectionOverride,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t\tansweringMachineDetection: \"premium\",\n\t\t});\n\n\t\tconsole.log(\" Telnyx API response:\", result);\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tproperty_id: params.propertyId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"phone\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: \"\",\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_call_control_id: result.callControlId,\n\t\t\t\ttelnyx_call_session_id: result.callSessionId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\tconsole.log(\" Call created successfully:\", {\n\t\t\tcallControlId: result.callControlId,\n\t\t\tcommunicationId: data.id,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcallControlId: result.callControlId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\" makeCall error:\", error);\n\t\tconsole.error(\"Error details:\", {\n\t\t\tmessage: error instanceof Error ? error.message : String(error),\n\t\t\tstack: error instanceof Error ? error.stack : undefined,\n\t\t});\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to make call\",\n\t\t};\n\t}\n}\n\n/**\n * Answer an incoming call\n/**\n * Answer an incoming call\n */\nasync function acceptCall(callControlId: string) {\n\ttry {\n\t\tconst telnyxWebhookUrl = await getTelnyxWebhookUrl();\n\t\tif (!telnyxWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\t\tconst result = await answerCall({\n\t\t\tcallControlId,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to answer call\",\n\t\t};\n\t}\n}\n\n/**\n * Reject an incoming call\n */\nasync function declineCall(callControlId: string) {\n\ttry {\n\t\tconst result = await rejectCall({\n\t\t\tcallControlId,\n\t\t\tcause: \"CALL_REJECTED\",\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to reject call\",\n\t\t};\n\t}\n}\n\n/**\n * End an active call\n */\nasync function endCall(callControlId: string) {\n\ttry {\n\t\tconst result = await hangupCall({ callControlId });\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to end call\",\n\t\t};\n\t}\n}\n\n/**\n * Start recording a call\n */\nexport async function startCallRecording(callControlId: string) {\n\ttry {\n\t\tconst result = await startRecording({\n\t\t\tcallControlId,\n\t\t\tformat: \"mp3\",\n\t\t\tchannels: \"single\",\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to start recording\",\n\t\t};\n\t}\n}\n\n/**\n * Stop recording a call\n */\nexport async function stopCallRecording(callControlId: string) {\n\ttry {\n\t\tconst result = await stopRecording({ callControlId });\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to stop recording\",\n\t\t};\n\t}\n}\n\n/**\n * Transfer an active call to another number\n */\nexport async function transferActiveCall(params: {\n\tcallControlId: string;\n\tto: string;\n\tfrom: string;\n}) {\n\ttry {\n\t\tconst { transferCall } = await import(\"@/lib/telnyx/calls\");\n\t\tconst result = await transferCall({\n\t\t\tcallControlId: params.callControlId,\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to transfer call\",\n\t\t};\n\t}\n}\n\n/**\n * Transcribe a call recording using AssemblyAI\n *\n * Submits the recording URL to AssemblyAI for post-call transcription.\n * AssemblyAI will process the audio and send the transcript via webhook.\n *\n * @param recordingUrl - URL of the call recording (from Telnyx)\n * @param communicationId - Database ID of the communication record\n * @returns Success/error response with transcription job ID\n */\nexport async function transcribeCallRecording(params: {\n\trecordingUrl: string;\n\tcommunicationId: string;\n}) {\n\ttry {\n\t\tconst { submitTranscription } = await import(\"@/lib/assemblyai/client\");\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst webhookUrl = await buildAbsoluteUrl(\"/api/webhooks/assemblyai\");\n\t\tif (!webhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL.\",\n\t\t\t};\n\t\t}\n\n\t\t// Submit to AssemblyAI\n\t\tconst result = await submitTranscription({\n\t\t\taudio_url: params.recordingUrl,\n\t\t\tspeaker_labels: true, // Enable speaker diarization\n\t\t\twebhook_url: webhookUrl,\n\t\t});\n\n\t\tif (!(result.success && result.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: result.error || \"Failed to submit transcription\",\n\t\t\t};\n\t\t}\n\n\t\t// Store transcription job ID in database\n\t\tawait mergeProviderMetadata(supabase, params.communicationId, {\n\t\t\tassemblyai_transcription_id: result.data.id,\n\t\t\tassemblyai_status: result.data.status,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\ttranscriptionId: result.data.id,\n\t\t\tstatus: result.data.status,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to transcribe recording\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// SMS OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Send an SMS message\n */\nexport async function sendTextMessage(params: {\n\tto: string;\n\tfrom: string;\n\ttext: string;\n\tcompanyId?: string; // Optional - will be fetched if not provided\n\tcustomerId?: string;\n\tjobId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tconsole.error(\" Supabase client unavailable\");\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get company ID if not provided\n\t\tlet companyId = params.companyId;\n\t\tif (!companyId) {\n\t\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\t\tcompanyId = await getActiveCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t\t}\n\t\t}\n\n\t\tconsole.log(\" SMS Send Request:\", {\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t\tcompanyId,\n\t\t});\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t);\n\t\tif (!companySettings) {\n\t\t\tconsole.error(\" Company settings not found\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Unable to provision Telnyx resources for this company. Please verify the company's onboarding is complete and try again.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" Company settings loaded:\", {\n\t\t\tmessagingProfileId: companySettings.messaging_profile_id,\n\t\t\tdefaultNumber: companySettings.default_outbound_number,\n\t\t});\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tif (!smsConfig.valid && !companySettings?.messaging_profile_id) {\n\t\t\tlet errorMessage = smsConfig.error || \"SMS configuration is invalid\";\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} or provision company-specific settings.`;\n\t\t\t}\n\t\t\tconsole.error(\" SMS config invalid:\", errorMessage);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" SMS config valid\");\n\n\t\tconst messagingProfileId =\n\t\t\tcompanySettings?.messaging_profile_id || DEFAULT_MESSAGING_PROFILE_ID;\n\t\tif (!messagingProfileId) {\n\t\t\tconsole.error(\" No messaging profile ID\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Messaging profile is not configured for this company. Please provision communications before sending SMS.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" Using messaging profile:\", messagingProfileId);\n\n\t\tif (messagingProfileId) {\n\t\t\tconst messagingProfileStatus =\n\t\t\t\tawait verifyMessagingProfile(messagingProfileId);\n\t\t\tif (messagingProfileStatus.needsFix) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t\" Messaging profile needs fix:\",\n\t\t\t\t\tmessagingProfileStatus.issues,\n\t\t\t\t);\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Messaging profile configuration issue: ${messagingProfileStatus.issues.join(\", \")}. Run fixMessagingProfile() or reprovision the company.`,\n\t\t\t\t};\n\t\t\t}\n\t\t\tconsole.log(\" Messaging profile verified\");\n\t\t}\n\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\t\tif (!fromAddress) {\n\t\t\tconsole.error(\" No from number available\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured. Please provision numbers first.\",\n\t\t\t};\n\t\t}\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\t\tconsole.log(\" Phone numbers normalized:\", {\n\t\t\tfrom: fromAddress,\n\t\t\tto: toAddress,\n\t\t});\n\n\t\t// Verify phone number has SMS capability\n\t\tconsole.log(\" Verifying SMS capability for:\", fromAddress);\n\t\tconst smsCapability = await verifySmsCapability(fromAddress);\n\t\tif (!smsCapability.hasSms) {\n\t\t\tconsole.error(\" SMS capability check failed:\", smsCapability.error);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: smsCapability.error || \"Phone number does not support SMS\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" SMS capability verified\");\n\n\t\tconst webhookUrl = await getTelnyxWebhookUrl(companyId);\n\t\tif (!webhookUrl) {\n\t\t\tconsole.error(\" No webhook URL\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\" Webhook URL:\", webhookUrl);\n\n\t\t// Send SMS via Telnyx\n\t\tconsole.log(\" Sending SMS via Telnyx API...\");\n\t\tconst result = await sendSMS({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\ttext: params.text,\n\t\t\twebhookUrl,\n\t\t\tmessagingProfileId,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\tconsole.error(\" Telnyx API failed:\", result.error);\n\n\t\t\t// Check if error is 10DLC registration required\n\t\t\tif (\n\t\t\t\tresult.error &&\n\t\t\t\t(result.error.includes(\"10DLC\") ||\n\t\t\t\t\tresult.error.includes(\"Not 10DLC registered\") ||\n\t\t\t\t\tresult.error.includes(\"A2P\"))\n\t\t\t) {\n\t\t\t\tconsole.log(\n\t\t\t\t\t\" Detected 10DLC registration required, attempting auto-registration...\",\n\t\t\t\t);\n\n\t\t\t\t// Import 10DLC registration function\n\t\t\t\tconst { registerCompanyFor10DLC } = await import(\n\t\t\t\t\t\"@/actions/ten-dlc-registration\"\n\t\t\t\t);\n\n\t\t\t\tconst registrationResult = await registerCompanyFor10DLC(\n\t\t\t\t\tcompanyId,\n\t\t\t\t);\n\n\t\t\t\tif (registrationResult.success) {\n\t\t\t\t\tconsole.log(\" 10DLC registration successful, retrying SMS send...\");\n\n\t\t\t\t\t// Retry the SMS send now that 10DLC is registered\n\t\t\t\t\tconst retryResult = await sendSMS({\n\t\t\t\t\t\tto: toAddress,\n\t\t\t\t\t\tfrom: fromAddress,\n\t\t\t\t\t\ttext: params.text,\n\t\t\t\t\t\twebhookUrl,\n\t\t\t\t\t\tmessagingProfileId,\n\t\t\t\t\t});\n\n\t\t\t\t\tif (!retryResult.success) {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\terror: `10DLC registration completed but SMS still failed: ${retryResult.error}. The campaign may need additional approval time.`,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\t// Update result with retry success\n\t\t\t\t\tresult.success = true;\n\t\t\t\t\tresult.messageId = retryResult.messageId;\n\t\t\t\t\tconsole.log(\" SMS retry successful after 10DLC registration\");\n\t\t\t\t} else {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: `10DLC registration failed: ${registrationResult.error}. Original error: ${result.error}`,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treturn result;\n\t\t\t}\n\t\t}\n\t\tconsole.log(\" Telnyx API success:\", result.messageId);\n\n\t\t// Create communication record\n\t\tconsole.log(\" Creating communication record in database...\");\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"sms\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: params.text,\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_message_id: result.messageId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.messageId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"SMS send error:\", error);\n\t\tconsole.error(\"Error details:\", {\n\t\t\tmessage: error instanceof Error ? error.message : String(error),\n\t\t\tstack: error instanceof Error ? error.stack : undefined,\n\t\t\ttype: typeof error,\n\t\t\tstringified: JSON.stringify(error, null, 2),\n\t\t});\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: `Failed to send SMS: ${String(error)}`,\n\t\t};\n\t}\n}\n\n/**\n * Send an MMS message with media\n */\nexport async function sendMMSMessage(params: {\n\tto: string;\n\tfrom: string;\n\ttext?: string;\n\tmediaUrls: string[];\n\tcompanyId?: string; // Optional - will be fetched if not provided\n\tcustomerId?: string;\n\tjobId?: string;\n\tpropertyId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get company ID if not provided\n\t\tlet companyId = params.companyId;\n\t\tif (!companyId) {\n\t\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\t\tcompanyId = await getActiveCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t\t}\n\t\t}\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t);\n\t\tif (!companySettings) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Unable to provision Telnyx resources for this company. Please verify onboarding is complete.\",\n\t\t\t};\n\t\t}\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tif (!smsConfig.valid && !companySettings.messaging_profile_id) {\n\t\t\tlet errorMessage = smsConfig.error || \"SMS configuration is invalid\";\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} or reprovision the company.`;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\n\t\tconst messagingProfileId =\n\t\t\tcompanySettings.messaging_profile_id || DEFAULT_MESSAGING_PROFILE_ID;\n\t\tif (!messagingProfileId) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Messaging profile is not configured for this company. Please provision communications before sending MMS.\",\n\t\t\t};\n\t\t}\n\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\t\tif (!fromAddress) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured.\",\n\t\t\t};\n\t\t}\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\n\t\tconst webhookUrl = await getTelnyxWebhookUrl(companyId);\n\t\tif (!webhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\n\t\tif (messagingProfileId) {\n\t\t\tconst messagingProfileStatus =\n\t\t\t\tawait verifyMessagingProfile(messagingProfileId);\n\t\t\tif (messagingProfileStatus.needsFix) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Messaging profile configuration issue: ${messagingProfileStatus.issues.join(\", \")}. Run fixMessagingProfile() or reprovision the company.`,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tconst smsCapability = await verifySmsCapability(fromAddress);\n\t\tif (!smsCapability.hasSms) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: smsCapability.error || \"Phone number does not support SMS/MMS\",\n\t\t\t};\n\t\t}\n\n\t\tconst result = await sendMMS({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\ttext: params.text,\n\t\t\tmediaUrls: params.mediaUrls,\n\t\t\twebhookUrl,\n\t\t\tmessagingProfileId,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tproperty_id: params.propertyId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"sms\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: params.text || \"\",\n\t\t\t\tattachments: params.mediaUrls.map((url) => ({ url, type: \"image\" })),\n\t\t\t\tattachment_count: params.mediaUrls.length,\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_message_id: result.messageId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.messageId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to send MMS\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// WEBRTC OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Generate WebRTC credentials for browser calling\n */\nexport async function getWebRTCCredentials() {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t\terror: userError,\n\t\t} = await supabase.auth.getUser();\n\t\tif (userError || !user) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"User not authenticated\",\n\t\t\t};\n\t\t}\n\n\t\t// OPTION 1: Use static credentials from environment (recommended for production)\n\t\tconst staticUsername = process.env.TELNYX_WEBRTC_USERNAME;\n\t\tconst staticPassword = process.env.TELNYX_WEBRTC_PASSWORD;\n\n\t\tif (staticUsername && staticPassword) {\n\t\t\tconst credential = {\n\t\t\t\tusername: staticUsername,\n\t\t\t\tpassword: staticPassword,\n\t\t\t\texpires_at: Date.now() + 86_400 * 1000, // 24 hours from now\n\t\t\t\trealm: \"sip.telnyx.com\",\n\t\t\t\tsip_uri: `sip:${staticUsername}@sip.telnyx.com`,\n\t\t\t\tstun_servers: [\n\t\t\t\t\t\"stun:stun.telnyx.com:3478\",\n\t\t\t\t\t\"stun:stun.telnyx.com:3479\",\n\t\t\t\t],\n\t\t\t\tturn_servers: [\n\t\t\t\t\t{\n\t\t\t\t\t\turls: [\n\t\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=udp\",\n\t\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=tcp\",\n\t\t\t\t\t\t],\n\t\t\t\t\t\tusername: staticUsername,\n\t\t\t\t\t\tcredential: staticPassword,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t};\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tcredential,\n\t\t\t};\n\t\t}\n\n\t\tconst { generateWebRTCToken } = await import(\"@/lib/telnyx/webrtc\");\n\t\tconst result = await generateWebRTCToken({\n\t\t\tusername: user.email || user.id,\n\t\t\tttl: 86_400, // 24 hours\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcredential: result.credential,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get WebRTC credentials\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// VOICEMAIL OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Get all voicemails for a company\n */\nasync function getVoicemails(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        customer:customers(id, first_name, last_name, email, phone),\n        phone_number:phone_numbers(phone_number, formatted_number)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"received_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get voicemails\",\n\t\t};\n\t}\n}\n\n/**\n * Mark voicemail as read\n */\nasync function markVoicemailAsRead(voicemailId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.update({\n\t\t\t\tis_read: true,\n\t\t\t\tread_at: new Date().toISOString(),\n\t\t\t\tread_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", voicemailId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to mark voicemail as read\",\n\t\t};\n\t}\n}\n\n/**\n * Delete voicemail\n */\nasync function deleteVoicemail(voicemailId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", voicemailId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to delete voicemail\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// CALL ROUTING RULES ACTIONS\n// =====================================================================================\n\n/**\n * Get all call routing rules for a company\n */\nexport async function getCallRoutingRules(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        created_by_user:users!call_routing_rules_created_by_fkey(id, name, email),\n        forward_to_user:users!call_routing_rules_forward_to_user_id_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"priority\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get call routing rules\",\n\t\t};\n\t}\n}\n\n/**\n * Create a new call routing rule\n */\nasync function createCallRoutingRule(params: {\n\tcompanyId: string;\n\tuserId: string;\n\tname: string;\n\tdescription?: string;\n\troutingType:\n\t\t| \"direct\"\n\t\t| \"round_robin\"\n\t\t| \"ivr\"\n\t\t| \"business_hours\"\n\t\t| \"conditional\";\n\tpriority?: number;\n\tbusinessHours?: Record<string, unknown>;\n\ttimezone?: string;\n\tafterHoursAction?: \"voicemail\" | \"forward\" | \"hangup\";\n\tafterHoursForwardTo?: string;\n\tteamMembers?: string[];\n\tringTimeout?: number;\n\tivrMenu?: Record<string, unknown>;\n\tivrGreetingUrl?: string;\n\tforwardToNumber?: string;\n\tforwardToUserId?: string;\n\tenableVoicemail?: boolean;\n\tvoicemailGreetingUrl?: string;\n\tvoicemailTranscriptionEnabled?: boolean;\n\tvoicemailEmailNotifications?: boolean;\n\trecordCalls?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: params.companyId,\n\t\t\t\tcreated_by: params.userId,\n\t\t\t\tname: params.name,\n\t\t\t\tdescription: params.description,\n\t\t\t\trouting_type: params.routingType,\n\t\t\t\tpriority: params.priority || 0,\n\t\t\t\tbusiness_hours: params.businessHours,\n\t\t\t\ttimezone: params.timezone || \"America/Los_Angeles\",\n\t\t\t\tafter_hours_action: params.afterHoursAction,\n\t\t\t\tafter_hours_forward_to: params.afterHoursForwardTo,\n\t\t\t\tteam_members: params.teamMembers,\n\t\t\t\tring_timeout: params.ringTimeout || 20,\n\t\t\t\tivr_menu: params.ivrMenu,\n\t\t\t\tivr_greeting_url: params.ivrGreetingUrl,\n\t\t\t\tforward_to_number: params.forwardToNumber,\n\t\t\t\tforward_to_user_id: params.forwardToUserId,\n\t\t\t\tenable_voicemail: params.enableVoicemail !== false,\n\t\t\t\tvoicemail_greeting_url: params.voicemailGreetingUrl,\n\t\t\t\tvoicemail_transcription_enabled:\n\t\t\t\t\tparams.voicemailTranscriptionEnabled !== false,\n\t\t\t\tvoicemail_email_notifications:\n\t\t\t\t\tparams.voicemailEmailNotifications !== false,\n\t\t\t\trecord_calls: params.recordCalls,\n\t\t\t\tis_active: true,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to create call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Update an existing call routing rule\n */\nexport async function updateCallRoutingRule(params: {\n\truleId: string;\n\tname?: string;\n\tdescription?: string;\n\tpriority?: number;\n\tbusinessHours?: Record<string, unknown>;\n\ttimezone?: string;\n\tafterHoursAction?: \"voicemail\" | \"forward\" | \"hangup\";\n\tafterHoursForwardTo?: string;\n\tteamMembers?: string[];\n\tringTimeout?: number;\n\tivrMenu?: Record<string, unknown>;\n\tivrGreetingUrl?: string;\n\tforwardToNumber?: string;\n\tforwardToUserId?: string;\n\tenableVoicemail?: boolean;\n\tvoicemailGreetingUrl?: string;\n\tvoicemailTranscriptionEnabled?: boolean;\n\tvoicemailEmailNotifications?: boolean;\n\trecordCalls?: boolean;\n\tisActive?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst updateData: Record<string, unknown> = {};\n\n\t\tif (params.name !== undefined) {\n\t\t\tupdateData.name = params.name;\n\t\t}\n\t\tif (params.description !== undefined) {\n\t\t\tupdateData.description = params.description;\n\t\t}\n\t\tif (params.priority !== undefined) {\n\t\t\tupdateData.priority = params.priority;\n\t\t}\n\t\tif (params.businessHours !== undefined) {\n\t\t\tupdateData.business_hours = params.businessHours;\n\t\t}\n\t\tif (params.timezone !== undefined) {\n\t\t\tupdateData.timezone = params.timezone;\n\t\t}\n\t\tif (params.afterHoursAction !== undefined) {\n\t\t\tupdateData.after_hours_action = params.afterHoursAction;\n\t\t}\n\t\tif (params.afterHoursForwardTo !== undefined) {\n\t\t\tupdateData.after_hours_forward_to = params.afterHoursForwardTo;\n\t\t}\n\t\tif (params.teamMembers !== undefined) {\n\t\t\tupdateData.team_members = params.teamMembers;\n\t\t}\n\t\tif (params.ringTimeout !== undefined) {\n\t\t\tupdateData.ring_timeout = params.ringTimeout;\n\t\t}\n\t\tif (params.ivrMenu !== undefined) {\n\t\t\tupdateData.ivr_menu = params.ivrMenu;\n\t\t}\n\t\tif (params.ivrGreetingUrl !== undefined) {\n\t\t\tupdateData.ivr_greeting_url = params.ivrGreetingUrl;\n\t\t}\n\t\tif (params.forwardToNumber !== undefined) {\n\t\t\tupdateData.forward_to_number = params.forwardToNumber;\n\t\t}\n\t\tif (params.forwardToUserId !== undefined) {\n\t\t\tupdateData.forward_to_user_id = params.forwardToUserId;\n\t\t}\n\t\tif (params.enableVoicemail !== undefined) {\n\t\t\tupdateData.enable_voicemail = params.enableVoicemail;\n\t\t}\n\t\tif (params.voicemailGreetingUrl !== undefined) {\n\t\t\tupdateData.voicemail_greeting_url = params.voicemailGreetingUrl;\n\t\t}\n\t\tif (params.voicemailTranscriptionEnabled !== undefined) {\n\t\t\tupdateData.voicemail_transcription_enabled =\n\t\t\t\tparams.voicemailTranscriptionEnabled;\n\t\t}\n\t\tif (params.voicemailEmailNotifications !== undefined) {\n\t\t\tupdateData.voicemail_email_notifications =\n\t\t\t\tparams.voicemailEmailNotifications;\n\t\t}\n\t\tif (params.recordCalls !== undefined) {\n\t\t\tupdateData.record_calls = params.recordCalls;\n\t\t}\n\t\tif (params.isActive !== undefined) {\n\t\t\tupdateData.is_active = params.isActive;\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update(updateData)\n\t\t\t.eq(\"id\", params.ruleId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to update call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Delete a call routing rule\n */\nexport async function deleteCallRoutingRule(ruleId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", ruleId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to delete call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Toggle call routing rule active status\n */\nexport async function toggleCallRoutingRule(ruleId: string, isActive: boolean) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update({ is_active: isActive })\n\t\t\t.eq(\"id\", ruleId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to toggle call routing rule\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// PHONE NUMBER USAGE STATISTICS ACTIONS\n// =====================================================================================\n\n/**\n * Get usage statistics for a phone number\n */\nasync function getPhoneNumberUsageStats(\n\tphoneNumberId: string,\n\tdays = 30,\n) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\t// Get call statistics\n\t\tconst { data: callStats, error: callError } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, call_duration, created_at\")\n\t\t\t.eq(\"type\", \"phone\")\n\t\t\t.eq(\"phone_number_id\", phoneNumberId)\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (callError) {\n\t\t\tthrow callError;\n\t\t}\n\n\t\t// Get SMS statistics\n\t\tconst { data: smsStats, error: smsError } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, created_at\")\n\t\t\t.eq(\"type\", \"sms\")\n\t\t\t.eq(\"phone_number_id\", phoneNumberId)\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (smsError) {\n\t\t\tthrow smsError;\n\t\t}\n\n\t\t// Calculate aggregates\n\t\tconst calls = callStats || [];\n\t\tconst sms = smsStats || [];\n\n\t\tconst incomingCalls = calls.filter((c) => c.direction === \"inbound\").length;\n\t\tconst outgoingCalls = calls.filter(\n\t\t\t(c) => c.direction === \"outbound\",\n\t\t).length;\n\t\tconst totalCallDuration = calls.reduce(\n\t\t\t(sum, c) => sum + (c.call_duration || 0),\n\t\t\t0,\n\t\t);\n\t\tconst incomingSms = sms.filter((s) => s.direction === \"inbound\").length;\n\t\tconst outgoingSms = sms.filter((s) => s.direction === \"outbound\").length;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tincomingCalls,\n\t\t\t\toutgoingCalls,\n\t\t\t\ttotalCalls: incomingCalls + outgoingCalls,\n\t\t\t\ttotalCallDuration,\n\t\t\t\tincomingSms,\n\t\t\t\toutgoingSms,\n\t\t\t\ttotalSms: incomingSms + outgoingSms,\n\t\t\t\tdailyStats: aggregateDailyStats([...calls, ...sms], days),\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get usage statistics\",\n\t\t};\n\t}\n}\n\n/**\n * Get company-wide usage statistics\n */\nasync function getCompanyUsageStats(companyId: string, days = 30) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\t// Get all communications for the company\n\t\tconst { data: communications, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, call_duration, created_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.in(\"type\", [\"phone\", \"sms\"])\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\tconst items = communications || [];\n\t\tconst calls = items.filter((i) => i.type === \"phone\");\n\t\tconst sms = items.filter((i) => i.type === \"sms\");\n\n\t\tconst incomingCalls = calls.filter((c) => c.direction === \"inbound\").length;\n\t\tconst outgoingCalls = calls.filter(\n\t\t\t(c) => c.direction === \"outbound\",\n\t\t).length;\n\t\tconst totalCallDuration = calls.reduce(\n\t\t\t(sum, c) => sum + (c.call_duration || 0),\n\t\t\t0,\n\t\t);\n\t\tconst incomingSms = sms.filter((s) => s.direction === \"inbound\").length;\n\t\tconst outgoingSms = sms.filter((s) => s.direction === \"outbound\").length;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tincomingCalls,\n\t\t\t\toutgoingCalls,\n\t\t\t\ttotalCalls: incomingCalls + outgoingCalls,\n\t\t\t\ttotalCallDuration,\n\t\t\t\taverageCallDuration:\n\t\t\t\t\tcalls.length > 0 ? totalCallDuration / calls.length : 0,\n\t\t\t\tincomingSms,\n\t\t\t\toutgoingSms,\n\t\t\t\ttotalSms: incomingSms + outgoingSms,\n\t\t\t\tdailyStats: aggregateDailyStats(items, days),\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get usage statistics\",\n\t\t};\n\t}\n}\n\n/**\n * Helper function to aggregate daily statistics\n */\nfunction aggregateDailyStats(\n\titems: Array<{ created_at: string; type: string; call_duration?: number }>,\n\tdays: number,\n) {\n\tconst dailyStats: Record<\n\t\tstring,\n\t\t{ date: string; calls: number; sms: number; duration: number }\n\t> = {};\n\n\t// Initialize all days\n\tfor (let i = 0; i < days; i++) {\n\t\tconst date = new Date();\n\t\tdate.setDate(date.getDate() - i);\n\t\tconst dateStr = date.toISOString().split(\"T\")[0];\n\t\tdailyStats[dateStr] = { date: dateStr, calls: 0, sms: 0, duration: 0 };\n\t}\n\n\t// Aggregate data\n\titems.forEach((item) => {\n\t\tconst dateStr = item.created_at.split(\"T\")[0];\n\t\tif (dailyStats[dateStr]) {\n\t\t\tif (item.type === \"phone\") {\n\t\t\t\tdailyStats[dateStr].calls += 1;\n\t\t\t\tdailyStats[dateStr].duration += item.call_duration || 0;\n\t\t\t} else if (item.type === \"sms\") {\n\t\t\t\tdailyStats[dateStr].sms += 1;\n\t\t\t}\n\t\t}\n\t});\n\n\treturn Object.values(dailyStats).sort((a, b) => a.date.localeCompare(b.date));\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;;CAUC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAKD;AACA;AACA;AACA;AAQA;AACA;AAKA;AACA;AACA;AAOA;AAIA;AAMA;;;;;;;;;;;;;;;AAIA,SAAS,qBAAqB,WAAmB;IAChD,OAAO,IAAA,qKAAiB,EAAC;AAC1B;AAEA,SAAS,gBAAgB,WAAmB;IAC3C,MAAM,SAAS,YAAY,OAAO,CAAC,OAAO;IAC1C,IAAI,OAAO,MAAM,KAAK,MAAM,OAAO,UAAU,CAAC,MAAM;QACnD,OAAO,OAAO,KAAK,CAAC,GAAG;IACxB;IACA,IAAI,OAAO,MAAM,KAAK,IAAI;QACzB,OAAO,OAAO,KAAK,CAAC,GAAG;IACxB;IACA,OAAO;AACR;AAEA,MAAM,+BACL,QAAQ,GAAG,CAAC,mCAAmC,IAC/C,QAAQ,GAAG,CAAC,uCAAuC,IACnD;AAED,MAAM,gCAAsC;IAAC;IAAS;IAAO;CAAM;AAEnE,SAAS,yBAAyB,WAAmB;IACpD,MAAM,SAAS,YAAY,OAAO,CAAC,OAAO;IAC1C,IAAI,OAAO,MAAM,KAAK,MAAM,OAAO,UAAU,CAAC,MAAM;QACnD,OAAO,CAAC,IAAI,EAAE,OAAO,KAAK,CAAC,GAAG,GAAG,EAAE,EAAE,OAAO,KAAK,CAAC,GAAG,GAAG,CAAC,EAAE,OAAO,KAAK,CAAC,IAAI;IAC7E;IACA,IAAI,OAAO,MAAM,KAAK,IAAI;QACzB,OAAO,CAAC,CAAC,EAAE,OAAO,KAAK,CAAC,GAAG,GAAG,EAAE,EAAE,OAAO,KAAK,CAAC,GAAG,GAAG,CAAC,EAAE,OAAO,KAAK,CAAC,IAAI;IAC1E;IACA,OAAO;AACR;AAEA,eAAe,yBACd,QAA6B,EAC7B,UAAwB;IAExB,IAAI,CAAC,YAAW;QACf,OAAO;IACR;IAEA,MAAM,WAAW,MAAM,IAAA,yLAA0B,EAAC,UAAU;IAC5D,IAAI,YAAY,SAAS,MAAM,KAAK,SAAS;QAC5C,OAAO;IACR;IAEA,MAAM,kBAAkB,MAAM,IAAA,uLAAwB,EAAC;QACtD,WAAA;QACA;IACD;IAEA,IAAI,CAAC,gBAAgB,OAAO,EAAE;QAC7B,OAAO;IACR;IAEA,OAAO,gBAAgB,QAAQ,IAAI;AACpC;AAEA,SAAS,iBAAiB,GAAW;IACpC,MAAM,UAAU,IAAI,IAAI,GAAG,OAAO,CAAC,QAAQ;IAC3C,IAAI,gBAAgB,IAAI,CAAC,UAAU;QAClC,IAAI,cAAc,IAAI,CAAC,YAAY,CAAC,WAAW,UAAU;YACxD,OAAO,QAAQ,OAAO,CAAC,eAAe;QACvC;QACA,OAAO;IACR;IACA,OAAO,CAAC,QAAQ,EAAE,SAAS;AAC5B;AAEA,SAAS,WAAW,GAAW;IAC9B,MAAM,UAAU,IAAI,WAAW;IAC/B,OACC,QAAQ,QAAQ,CAAC,gBACjB,QAAQ,QAAQ,CAAC,gBACjB,QAAQ,QAAQ,CAAC,cACjB,QAAQ,QAAQ,CAAC,aACjB,QAAQ,QAAQ,CAAC;AAEnB;AAEA,SAAS,aAAa,GAAW;IAChC,IAAI,CAAC,KAAK;QACT,OAAO;IACR;IACA,MAAM,UAAU,IAAI,IAAI;IACxB,IAAI,CAAC,SAAS;QACb,OAAO;IACR;IACA,MAAM,qBACL,AAAC,QAAQ,GAAG,CAAC,MAAM,KAAK,OAAO,QAAQ,GAAG,CAAC,UAAU,KAAK,gBAC1D,QAAQ,GAAG,CAAC,cAAc,KAAK;IAEhC,IAAI,sBAAsB,WAAW,UAAU;QAC9C,OAAO;IACR;IAEA,OAAO;AACR;AAEA,eAAe;IACd,MAAM,aAAa;;QAElB,QAAQ,GAAG,CAAC,QAAQ;;QAEpB,QAAQ,GAAG,CAAC,OAAO;KACnB;IACD,KAAK,MAAM,aAAa,WAAY;QACnC,IAAI,aAAa,aAAa,YAAY;YACzC,OAAO,iBAAiB;QACzB;IACD;IAEA,MAAM,YAAY,QAAQ,GAAG,CAAC,UAAU;IACxC,IAAI,aAAa,aAAa,YAAY;QACzC,OAAO,iBACN,UAAU,UAAU,CAAC,UAAU,YAAY,CAAC,QAAQ,EAAE,WAAW;IAEnE;IAEA,IAAI;QACH,MAAM,OAAO,MAAM,IAAA,iTAAO;QAC1B,MAAM,SAAS,KAAK,GAAG,CAAC;QACxB,IAAI,UAAU,aAAa,SAAS;YACnC,OAAO,iBAAiB;QACzB;QACA,MAAM,OAAO,KAAK,GAAG,CAAC;QACtB,IAAI,QAAQ,aAAa,OAAO;YAC/B,MAAM,WAAW,KAAK,QAAQ,CAAC,eAAe,SAAS;YACvD,OAAO,iBAAiB,GAAG,SAAS,GAAG,EAAE,MAAM;QAChD;IACD,EAAE,OAAM;IACP,uDAAuD;IACxD;IAEA,OAAO;AACR;AAEA,eAAe,iBAAiB,IAAY;IAC3C,MAAM,OAAO,MAAM;IACnB,IAAI,CAAC,MAAM;QACV,OAAO;IACR;IACA,MAAM,iBAAiB,KAAK,UAAU,CAAC,OAAO,OAAO,CAAC,CAAC,EAAE,MAAM;IAC/D,OAAO,GAAG,OAAO,gBAAgB;AAClC;AAEA,eAAe,oBACd,UAAkB;IAElB,IAAI,YAAW;QACd,OAAO,iBAAiB,CAAC,6BAA6B,EAAE,YAAW;IACpE;IACA,OAAO,iBAAiB;AACzB;AAEA,eAAe,iBACd,QAA6B,EAC7B,WAAmB;IAEnB,MAAM,aAAa,qBAAqB;IACxC,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,iBACL,MAAM,CAAC,MACP,EAAE,CAAC,gBAAgB,YACnB,EAAE,CAAC,cAAc,MACjB,WAAW;IAEb,OAAO,MAAM,MAAM;AACpB;AAEA,eAAe,8BACd,QAA6B,EAC7B,UAAiB,EACjB,WAA0B;IAE1B,IAAI,CAAC,aAAa;QACjB;IACD;IAEA,MAAM,aAAa,qBAAqB;IACxC,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,iBACL,MAAM,CAAC,MACP,EAAE,CAAC,cAAc,YACjB,EAAE,CAAC,gBAAgB,YACnB,KAAK,CAAC;IAER,IAAI,QAAQ,KAAK,MAAM,GAAG,GAAG;QAC5B;IACD;IAEA,MAAM,SAAS,IAAI,CAAC,iBAAiB,MAAM,CAAC;QAC3C,YAAY;QACZ,cAAc;QACd,kBAAkB,yBAAyB;QAC3C,cAAc;QACd,WAAW,gBAAgB;QAC3B,aAAa;QACb,QAAQ;QACR,UAAU;IACX;AACD;AAEA,eAAe,2BACd,QAA6B,EAC7B,UAAiB,EACjB,YAA4B,EAC5B,aAA6B;IAE7B,IAAI,cAAc;QACjB,OAAO,qBAAqB;IAC7B;IAEA,MAAM,oBAAoB,gBACvB,qBAAqB,iBACrB;IAEH,IAAI;QACH,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,iBACL,MAAM,CAAC,6BACP,EAAE,CAAC,cAAc,YACjB,EAAE,CAAC,UAAU;QAEf,IAAI,QAAQ,KAAK,MAAM,GAAG,GAAG;YAC5B,MAAM,WAAW,KAAK,IAAI,CAAC,CAAC,IAAM,EAAE,WAAW,KAAK;YACpD,IAAI,UAAU;gBACb,OAAO,qBAAqB,SAAS,YAAY;YAClD;YAEA,IAAI,mBAAmB;gBACtB,MAAM,gBAAgB,KAAK,IAAI,CAC9B,CAAC,IAAM,qBAAqB,EAAE,YAAY,MAAM;gBAEjD,IAAI,eAAe;oBAClB,OAAO;gBACR;YACD;YAEA,OAAO,qBAAqB,IAAI,CAAC,EAAE,CAAC,YAAY;QACjD;IACD,EAAE,OAAO,OAAO;QACf,QAAQ,IAAI,CACX,gEACA;IAEF;IAEA,OAAO;AACR;AAEA,eAAe,sBACd,QAA6B,EAC7B,eAAuB,EACvB,KAA2B;IAE3B,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,kBACL,MAAM,CAAC,qBACP,EAAE,CAAC,MAAM,iBACT,WAAW;IAEb,MAAM,kBACL,AAAC,MAAM,qBAAqD,CAAC;IAC9D,MAAM,iBAAuC;QAC5C,GAAG,eAAe;QAClB,GAAG,KAAK;IACT;IAEA,MAAM,SACJ,IAAI,CAAC,kBACL,MAAM,CAAC;QACP,mBAAmB;IACpB,GACC,EAAE,CAAC,MAAM;AACZ;AASO,eAAe,mBAAmB,MAKxC;IACA,IAAI;QACH,MAAM,SAAS,MAAM,IAAA,wKAAsB,EAAC;YAC3C,aAAa;YACb,UAAU,OAAO,QAAQ;YACzB,YAAY,OAAO,UAAU;YAC7B,UAAU,OAAO,QAAQ;YACzB,OAAO,OAAO,KAAK,IAAI;QACxB;QAEA,OAAO;IACR,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAKO,eAAe,oBAAoB,MAIzC;IACA,IAAI;QACH,yBAAyB;QACzB,MAAM,YAAY,MAAM,IAAA,+KAAiB;QACzC,MAAM,aAAa,IAAA,gLAAkB;QACrC,IAAI,CAAC,UAAU,KAAK,IAAI,CAAC,WAAW,KAAK,EAAE;YAC1C,IAAI,eACH;YAED,6DAA6D;YAC7D,IAAI,UAAU,kBAAkB,EAAE;gBACjC,gBAAgB,CAAC,0BAA0B,EAAE,UAAU,kBAAkB,CAAC,kEAAkE,EAAE,UAAU,kBAAkB,CAAC,WAAW,CAAC;YACxL;YAEA,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,wBAAwB,qBAAqB,OAAO,WAAW;QACrE,MAAM,kBAAkB,yBAAyB;QACjD,MAAM,WAAW,gBAAgB;QAEjC,8BAA8B;QAC9B,MAAM,qBAAqB,gCAAgC;QAE3D,MAAM,SAAS,MAAM,IAAA,gKAAc,EAAC;YACnC,aAAa;YACb,cAAc,8JAAa,CAAC,YAAY;YACxC;YACA,gBAAgB,OAAO,cAAc;YACrC,mBAAmB,CAAC,QAAQ,EAAE,OAAO,SAAS,EAAE;QACjD;QAEA,IAAI,CAAC,OAAO,OAAO,EAAE;YACpB,OAAO;QACR;QAEA,oBAAoB;QACpB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,iBACL,MAAM,CAAC;YACP,YAAY,OAAO,SAAS;YAC5B,wBAAwB,OAAO,OAAO;YACtC,sBAAsB,8JAAa,CAAC,YAAY;YAChD,cAAc;YACd,kBAAkB;YAClB,cAAc;YACd,WAAW;YACX,aAAa;YACb,UAAU;gBAAC;gBAAS;aAAM;YAC1B,QAAQ;QACT,GACC,MAAM,GACN,MAAM;QAER,IAAI,OAAO;YACV,MAAM;QACP;QAEA,IAAA,sTAAc,EAAC;QAEf,IAAI;YACH,MAAM,IAAA,iLAAuB,EAC5B,OAAO,SAAS,EAChB;gBAAE,IAAI,KAAK,EAAE;gBAAE,MAAM;YAAsB,GAC3C;gBAAE;YAAS;QAEb,EAAE,OAAO,gBAAgB,CAAC;QAE1B,OAAO;YACN,SAAS;YACT;QACD;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAKO,eAAe,uBAAuB,UAAiB;IAC7D,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,iBACL,MAAM,CAAC,KACP,EAAE,CAAC,cAAc,YACjB,EAAE,CAAC,cAAc,MACjB,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM;QAEzC,IAAI,OAAO;YACV,MAAM;QACP;QAEA,OAAO;YACN,SAAS;YACT,MAAM,QAAQ,EAAE;QACjB;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C;IACD;AACD;AAEA;;CAEC,GACD,eAAe,kBAAkB,MAKhC;IACA,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,iBACL,MAAM,CAAC;YACP,sBAAsB,OAAO,aAAa;YAC1C,mBAAmB,OAAO,eAAe;YACzC,mBAAmB,OAAO,gBAAgB;QAC3C,GACC,EAAE,CAAC,MAAM,OAAO,aAAa,EAC7B,MAAM,GACN,MAAM;QAER,IAAI,OAAO;YACV,MAAM;QACP;QAEA,IAAA,sTAAc,EAAC;QAEf,OAAO;YACN,SAAS;YACT;QACD;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAEA;;CAEC,GACD,eAAe,kBAAkB,aAAqB;IACrD,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,2BAA2B;QAC3B,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,iBACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,eACT,MAAM;QAER,IAAI,CAAC,aAAa;YACjB,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAyB;QAC1D;QAEA,wCAAwC;QACxC,IAAI,YAAY,sBAAsB,EAAE;YACvC,MAAM,IAAA,+JAAa,EAAC,YAAY,sBAAsB;QACvD;QAEA,0BAA0B;QAC1B,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACtB,IAAI,CAAC,iBACL,MAAM,CAAC;YACP,YAAY,IAAI,OAAO,WAAW;YAClC,QAAQ;QACT,GACC,EAAE,CAAC,MAAM;QAEX,IAAI,OAAO;YACV,MAAM;QACP;QAEA,IAAA,sTAAc,EAAC;QAEf,OAAO;YAAE,SAAS;QAAK;IACxB,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AASO,eAAe,SAAS,MAS9B;IACA,IAAI;QACH,QAAQ,GAAG,CAAC,mCAAmC;QAE/C,MAAM,aAAa,IAAA,gLAAkB;QACrC,QAAQ,GAAG,CAAC,8BAA8B;QAC1C,IAAI,CAAC,WAAW,KAAK,EAAE;YACtB,OAAO;gBACN,SAAS;gBACT,OAAO,WAAW,KAAK,IAAI;YAC5B;QACD;QAEA,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,kBAAkB,MAAM,yBAC7B,UACA,OAAO,SAAS;QAGjB,MAAM,8BACL,UACA,OAAO,SAAS,EAChB,iBAAiB,2BAA2B;QAG7C,MAAM,qBACL,iBAAiB,+BACjB,8JAAa,CAAC,YAAY;QAC3B,MAAM,cAAc,MAAM,2BACzB,UACA,OAAO,SAAS,EAChB,OAAO,IAAI,EACX,iBAAiB,2BAA2B;QAG7C,IAAI,CAAC,oBAAoB;YACxB,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,IAAI,CAAC,aAAa;YACjB,OAAO;gBACN,SAAS;gBACT,OACC;YACF;QACD;QAEA,uEAAuE;QACvE,uEAAuE;QACvE,mCAAmC;QACnC,YAAY;QACZ,oBAAoB;QACpB,sHAAsH;QACtH,MAAM;QACN,IAAI;QAEJ,MAAM,YAAY,qBAAqB,OAAO,EAAE;QAEhD,sEAAsE;QACtE,oEAAoE;QACpE,mCAAmC;QACnC,YAAY;QACZ,oBAAoB;QACpB,WAAW;QACX,2EAA2E;QAC3E,MAAM;QACN,IAAI;QAEJ,MAAM,mBAAmB,MAAM,oBAAoB,OAAO,SAAS;QACnE,QAAQ,GAAG,CAAC,mBAAmB;QAC/B,IAAI,CAAC,kBAAkB;YACtB,OAAO;gBACN,SAAS;gBACT,OACC;YACF;QACD;QAEA,QAAQ,GAAG,CAAC,uBAAuB;YAClC,IAAI;YACJ,MAAM;YACN,cAAc;YACd,YAAY;QACb;QAEA,MAAM,SAAS,MAAM,IAAA,4JAAY,EAAC;YACjC,IAAI;YACJ,MAAM;YACN,cAAc;YACd,YAAY;YACZ,2BAA2B;QAC5B;QAEA,QAAQ,GAAG,CAAC,2BAA2B;QAEvC,IAAI,CAAC,OAAO,OAAO,EAAE;YACpB,OAAO;QACR;QAEA,MAAM,gBAAgB,MAAM,iBAAiB,UAAU;QACvD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,kBACL,MAAM,CAAC;YACP,YAAY;YACZ,aAAa,OAAO,UAAU;YAC9B,QAAQ,OAAO,KAAK,IAAI;YACxB,aAAa,OAAO,UAAU,IAAI;YAClC,YAAY,OAAO,SAAS,IAAI;YAChC,aAAa,OAAO,UAAU,IAAI;YAClC,MAAM;YACN,SAAS;YACT,WAAW;YACX,cAAc;YACd,YAAY;YACZ,MAAM;YACN,QAAQ;YACR,UAAU;YACV,iBAAiB;YACjB,aAAa;YACb,cAAc;YACd,aAAa;YACb,mBAAmB;YACnB,wBAAwB,OAAO,aAAa;YAC5C,wBAAwB,OAAO,aAAa;QAC7C,GACC,MAAM,GACN,MAAM;QAER,IAAI,OAAO;YACV,MAAM;QACP;QAEA,QAAQ,GAAG,CAAC,gCAAgC;YAC3C,eAAe,OAAO,aAAa;YACnC,iBAAiB,KAAK,EAAE;QACzB;QAEA,OAAO;YACN,SAAS;YACT,eAAe,OAAO,aAAa;YACnC;QACD;IACD,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,qBAAqB;QACnC,QAAQ,KAAK,CAAC,kBAAkB;YAC/B,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG,OAAO;YACzD,OAAO,iBAAiB,QAAQ,MAAM,KAAK,GAAG;QAC/C;QACA,OAAO;YACN,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACjD;IACD;AACD;AAEA;;;;CAIC,GACD,eAAe,WAAW,aAAqB;IAC9C,IAAI;QACH,MAAM,mBAAmB,MAAM;QAC/B,IAAI,CAAC,kBAAkB;YACtB,OAAO;gBACN,SAAS;gBACT,OACC;YACF;QACD;QACA,MAAM,SAAS,MAAM,IAAA,0JAAU,EAAC;YAC/B;YACA,YAAY;QACb;QAEA,OAAO;IACR,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACjD;IACD;AACD;AAEA;;CAEC,GACD,eAAe,YAAY,aAAqB;IAC/C,IAAI;QACH,MAAM,SAAS,MAAM,IAAA,0JAAU,EAAC;YAC/B;YACA,OAAO;QACR;QAEA,OAAO;IACR,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACjD;IACD;AACD;AAEA;;CAEC,GACD,eAAe,QAAQ,aAAqB;IAC3C,IAAI;QACH,MAAM,SAAS,MAAM,IAAA,0JAAU,EAAC;YAAE;QAAc;QAEhD,OAAO;IACR,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACjD;IACD;AACD;AAKO,eAAe,mBAAmB,aAAqB;IAC7D,IAAI;QACH,MAAM,SAAS,MAAM,IAAA,8JAAc,EAAC;YACnC;YACA,QAAQ;YACR,UAAU;QACX;QAEA,OAAO;IACR,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C;IACD;AACD;AAKO,eAAe,kBAAkB,aAAqB;IAC5D,IAAI;QACH,MAAM,SAAS,MAAM,IAAA,6JAAa,EAAC;YAAE;QAAc;QAEnD,OAAO;IACR,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C;IACD;AACD;AAKO,eAAe,mBAAmB,MAIxC;IACA,IAAI;QACH,MAAM,EAAE,YAAY,EAAE,GAAG;QACzB,MAAM,SAAS,MAAM,aAAa;YACjC,eAAe,OAAO,aAAa;YACnC,IAAI,OAAO,EAAE;YACb,MAAM,OAAO,IAAI;QAClB;QAEA,OAAO;IACR,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACjD;IACD;AACD;AAYO,eAAe,wBAAwB,MAG7C;IACA,IAAI;QACH,MAAM,EAAE,mBAAmB,EAAE,GAAG;QAChC,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,aAAa,MAAM,iBAAiB;QAC1C,IAAI,CAAC,YAAY;YAChB,OAAO;gBACN,SAAS;gBACT,OACC;YACF;QACD;QAEA,uBAAuB;QACvB,MAAM,SAAS,MAAM,oBAAoB;YACxC,WAAW,OAAO,YAAY;YAC9B,gBAAgB;YAChB,aAAa;QACd;QAEA,IAAI,CAAC,CAAC,OAAO,OAAO,IAAI,OAAO,IAAI,GAAG;YACrC,OAAO;gBACN,SAAS;gBACT,OAAO,OAAO,KAAK,IAAI;YACxB;QACD;QAEA,yCAAyC;QACzC,MAAM,sBAAsB,UAAU,OAAO,eAAe,EAAE;YAC7D,6BAA6B,OAAO,IAAI,CAAC,EAAE;YAC3C,mBAAmB,OAAO,IAAI,CAAC,MAAM;QACtC;QAEA,OAAO;YACN,SAAS;YACT,iBAAiB,OAAO,IAAI,CAAC,EAAE;YAC/B,QAAQ,OAAO,IAAI,CAAC,MAAM;QAC3B;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AASO,eAAe,gBAAgB,MASrC;IACA,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,QAAQ,KAAK,CAAC;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,iCAAiC;QACjC,IAAI,aAAY,OAAO,SAAS;QAChC,IAAI,CAAC,YAAW;YACf,MAAM,EAAE,kBAAkB,EAAE,GAAG;YAC/B,aAAY,MAAM;YAClB,IAAI,CAAC,YAAW;gBACf,OAAO;oBAAE,SAAS;oBAAO,OAAO;gBAA0B;YAC3D;QACD;QAEA,QAAQ,GAAG,CAAC,wBAAwB;YACnC,IAAI,OAAO,EAAE;YACb,MAAM,OAAO,IAAI;YACjB,WAAA;QACD;QAEA,MAAM,kBAAkB,MAAM,yBAC7B,UACA;QAED,IAAI,CAAC,iBAAiB;YACrB,QAAQ,KAAK,CAAC;YACd,OAAO;gBACN,SAAS;gBACT,OACC;YACF;QACD;QACA,QAAQ,GAAG,CAAC,8BAA8B;YACzC,oBAAoB,gBAAgB,oBAAoB;YACxD,eAAe,gBAAgB,uBAAuB;QACvD;QAEA,MAAM,8BACL,UACA,YACA,gBAAgB,uBAAuB;QAGxC,MAAM,YAAY,MAAM,IAAA,+KAAiB;QACzC,IAAI,CAAC,UAAU,KAAK,IAAI,CAAC,iBAAiB,sBAAsB;YAC/D,IAAI,eAAe,UAAU,KAAK,IAAI;YACtC,IAAI,UAAU,kBAAkB,EAAE;gBACjC,gBAAgB,CAAC,0BAA0B,EAAE,UAAU,kBAAkB,CAAC,kEAAkE,EAAE,UAAU,kBAAkB,CAAC,wCAAwC,CAAC;YACrN;YACA,QAAQ,KAAK,CAAC,yBAAyB;YACvC,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QACA,QAAQ,GAAG,CAAC;QAEZ,MAAM,qBACL,iBAAiB,wBAAwB;QAC1C,IAAI,CAAC,oBAAoB;YACxB,QAAQ,KAAK,CAAC;YACd,OAAO;gBACN,SAAS;gBACT,OACC;YACF;QACD;QACA,QAAQ,GAAG,CAAC,8BAA8B;QAE1C,IAAI,oBAAoB;YACvB,MAAM,yBACL,MAAM,IAAA,8LAAsB,EAAC;YAC9B,IAAI,uBAAuB,QAAQ,EAAE;gBACpC,QAAQ,KAAK,CACZ,kCACA,uBAAuB,MAAM;gBAE9B,OAAO;oBACN,SAAS;oBACT,OAAO,CAAC,uCAAuC,EAAE,uBAAuB,MAAM,CAAC,IAAI,CAAC,MAAM,uDAAuD,CAAC;gBACnJ;YACD;YACA,QAAQ,GAAG,CAAC;QACb;QAEA,MAAM,cAAc,MAAM,2BACzB,UACA,YACA,OAAO,IAAI,EACX,gBAAgB,uBAAuB;QAExC,IAAI,CAAC,aAAa;YACjB,QAAQ,KAAK,CAAC;YACd,OAAO;gBACN,SAAS;gBACT,OACC;YACF;QACD;QACA,MAAM,YAAY,qBAAqB,OAAO,EAAE;QAChD,QAAQ,GAAG,CAAC,+BAA+B;YAC1C,MAAM;YACN,IAAI;QACL;QAEA,yCAAyC;QACzC,QAAQ,GAAG,CAAC,oCAAoC;QAChD,MAAM,gBAAgB,MAAM,IAAA,sLAAmB,EAAC;QAChD,IAAI,CAAC,cAAc,MAAM,EAAE;YAC1B,QAAQ,KAAK,CAAC,kCAAkC,cAAc,KAAK;YACnE,OAAO;gBACN,SAAS;gBACT,OAAO,cAAc,KAAK,IAAI;YAC/B;QACD;QACA,QAAQ,GAAG,CAAC;QAEZ,MAAM,aAAa,MAAM,oBAAoB;QAC7C,IAAI,CAAC,YAAY;YAChB,QAAQ,KAAK,CAAC;YACd,OAAO;gBACN,SAAS;gBACT,OACC;YACF;QACD;QACA,QAAQ,GAAG,CAAC,kBAAkB;QAE9B,sBAAsB;QACtB,QAAQ,GAAG,CAAC;QACZ,MAAM,SAAS,MAAM,IAAA,2JAAO,EAAC;YAC5B,IAAI;YACJ,MAAM;YACN,MAAM,OAAO,IAAI;YACjB;YACA;QACD;QAEA,IAAI,CAAC,OAAO,OAAO,EAAE;YACpB,QAAQ,KAAK,CAAC,wBAAwB,OAAO,KAAK;YAElD,gDAAgD;YAChD,IACC,OAAO,KAAK,IACZ,CAAC,OAAO,KAAK,CAAC,QAAQ,CAAC,YACtB,OAAO,KAAK,CAAC,QAAQ,CAAC,2BACtB,OAAO,KAAK,CAAC,QAAQ,CAAC,MAAM,GAC5B;gBACD,QAAQ,GAAG,CACV;gBAGD,qCAAqC;gBACrC,MAAM,EAAE,uBAAuB,EAAE,GAAG;gBAIpC,MAAM,qBAAqB,MAAM,wBAChC;gBAGD,IAAI,mBAAmB,OAAO,EAAE;oBAC/B,QAAQ,GAAG,CAAC;oBAEZ,kDAAkD;oBAClD,MAAM,cAAc,MAAM,IAAA,2JAAO,EAAC;wBACjC,IAAI;wBACJ,MAAM;wBACN,MAAM,OAAO,IAAI;wBACjB;wBACA;oBACD;oBAEA,IAAI,CAAC,YAAY,OAAO,EAAE;wBACzB,OAAO;4BACN,SAAS;4BACT,OAAO,CAAC,mDAAmD,EAAE,YAAY,KAAK,CAAC,iDAAiD,CAAC;wBAClI;oBACD;oBAEA,mCAAmC;oBACnC,OAAO,OAAO,GAAG;oBACjB,OAAO,SAAS,GAAG,YAAY,SAAS;oBACxC,QAAQ,GAAG,CAAC;gBACb,OAAO;oBACN,OAAO;wBACN,SAAS;wBACT,OAAO,CAAC,2BAA2B,EAAE,mBAAmB,KAAK,CAAC,kBAAkB,EAAE,OAAO,KAAK,EAAE;oBACjG;gBACD;YACD,OAAO;gBACN,OAAO;YACR;QACD;QACA,QAAQ,GAAG,CAAC,yBAAyB,OAAO,SAAS;QAErD,8BAA8B;QAC9B,QAAQ,GAAG,CAAC;QACZ,MAAM,gBAAgB,MAAM,iBAAiB,UAAU;QACvD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,kBACL,MAAM,CAAC;YACP,YAAY;YACZ,aAAa,OAAO,UAAU;YAC9B,QAAQ,OAAO,KAAK,IAAI;YACxB,YAAY,OAAO,SAAS,IAAI;YAChC,aAAa,OAAO,UAAU,IAAI;YAClC,MAAM;YACN,SAAS;YACT,WAAW;YACX,cAAc;YACd,YAAY;YACZ,MAAM,OAAO,IAAI;YACjB,QAAQ;YACR,UAAU;YACV,iBAAiB;YACjB,aAAa;YACb,cAAc;YACd,aAAa;YACb,mBAAmB;YACnB,mBAAmB,OAAO,SAAS;QACpC,GACC,MAAM,GACN,MAAM;QAER,IAAI,OAAO;YACV,MAAM;QACP;QAEA,IAAA,sTAAc,EAAC;QAEf,OAAO;YACN,SAAS;YACT,WAAW,OAAO,SAAS;YAC3B;QACD;IACD,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,mBAAmB;QACjC,QAAQ,KAAK,CAAC,kBAAkB;YAC/B,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG,OAAO;YACzD,OAAO,iBAAiB,QAAQ,MAAM,KAAK,GAAG;YAC9C,MAAM,OAAO;YACb,aAAa,KAAK,SAAS,CAAC,OAAO,MAAM;QAC1C;QACA,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb,CAAC,oBAAoB,EAAE,OAAO,QAAQ;QAC3C;IACD;AACD;AAKO,eAAe,eAAe,MAWpC;IACA,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,iCAAiC;QACjC,IAAI,aAAY,OAAO,SAAS;QAChC,IAAI,CAAC,YAAW;YACf,MAAM,EAAE,kBAAkB,EAAE,GAAG;YAC/B,aAAY,MAAM;YAClB,IAAI,CAAC,YAAW;gBACf,OAAO;oBAAE,SAAS;oBAAO,OAAO;gBAA0B;YAC3D;QACD;QAEA,MAAM,kBAAkB,MAAM,yBAC7B,UACA;QAED,IAAI,CAAC,iBAAiB;YACrB,OAAO;gBACN,SAAS;gBACT,OACC;YACF;QACD;QAEA,MAAM,8BACL,UACA,YACA,gBAAgB,uBAAuB;QAGxC,MAAM,YAAY,MAAM,IAAA,+KAAiB;QACzC,IAAI,CAAC,UAAU,KAAK,IAAI,CAAC,gBAAgB,oBAAoB,EAAE;YAC9D,IAAI,eAAe,UAAU,KAAK,IAAI;YACtC,IAAI,UAAU,kBAAkB,EAAE;gBACjC,gBAAgB,CAAC,0BAA0B,EAAE,UAAU,kBAAkB,CAAC,kEAAkE,EAAE,UAAU,kBAAkB,CAAC,4BAA4B,CAAC;YACzM;YACA,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,MAAM,qBACL,gBAAgB,oBAAoB,IAAI;QACzC,IAAI,CAAC,oBAAoB;YACxB,OAAO;gBACN,SAAS;gBACT,OACC;YACF;QACD;QAEA,MAAM,cAAc,MAAM,2BACzB,UACA,YACA,OAAO,IAAI,EACX,gBAAgB,uBAAuB;QAExC,IAAI,CAAC,aAAa;YACjB,OAAO;gBACN,SAAS;gBACT,OACC;YACF;QACD;QACA,MAAM,YAAY,qBAAqB,OAAO,EAAE;QAEhD,MAAM,aAAa,MAAM,oBAAoB;QAC7C,IAAI,CAAC,YAAY;YAChB,OAAO;gBACN,SAAS;gBACT,OACC;YACF;QACD;QAEA,IAAI,oBAAoB;YACvB,MAAM,yBACL,MAAM,IAAA,8LAAsB,EAAC;YAC9B,IAAI,uBAAuB,QAAQ,EAAE;gBACpC,OAAO;oBACN,SAAS;oBACT,OAAO,CAAC,uCAAuC,EAAE,uBAAuB,MAAM,CAAC,IAAI,CAAC,MAAM,uDAAuD,CAAC;gBACnJ;YACD;QACD;QAEA,MAAM,gBAAgB,MAAM,IAAA,sLAAmB,EAAC;QAChD,IAAI,CAAC,cAAc,MAAM,EAAE;YAC1B,OAAO;gBACN,SAAS;gBACT,OAAO,cAAc,KAAK,IAAI;YAC/B;QACD;QAEA,MAAM,SAAS,MAAM,IAAA,2JAAO,EAAC;YAC5B,IAAI;YACJ,MAAM;YACN,MAAM,OAAO,IAAI;YACjB,WAAW,OAAO,SAAS;YAC3B;YACA;QACD;QAEA,IAAI,CAAC,OAAO,OAAO,EAAE;YACpB,OAAO;QACR;QAEA,MAAM,gBAAgB,MAAM,iBAAiB,UAAU;QACvD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,kBACL,MAAM,CAAC;YACP,YAAY;YACZ,aAAa,OAAO,UAAU;YAC9B,QAAQ,OAAO,KAAK,IAAI;YACxB,aAAa,OAAO,UAAU,IAAI;YAClC,YAAY,OAAO,SAAS,IAAI;YAChC,aAAa,OAAO,UAAU,IAAI;YAClC,MAAM;YACN,SAAS;YACT,WAAW;YACX,cAAc;YACd,YAAY;YACZ,MAAM,OAAO,IAAI,IAAI;YACrB,aAAa,OAAO,SAAS,CAAC,GAAG,CAAC,CAAC,MAAQ,CAAC;oBAAE;oBAAK,MAAM;gBAAQ,CAAC;YAClE,kBAAkB,OAAO,SAAS,CAAC,MAAM;YACzC,QAAQ;YACR,UAAU;YACV,iBAAiB;YACjB,aAAa;YACb,cAAc;YACd,aAAa;YACb,mBAAmB;YACnB,mBAAmB,OAAO,SAAS;QACpC,GACC,MAAM,GACN,MAAM;QAER,IAAI,OAAO;YACV,MAAM;QACP;QAEA,IAAA,sTAAc,EAAC;QAEf,OAAO;YACN,SAAS;YACT,WAAW,OAAO,SAAS;YAC3B;QACD;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACjD;IACD;AACD;AASO,eAAe;IACrB,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,mBAAmB;QACnB,MAAM,EACL,MAAM,EAAE,IAAI,EAAE,EACd,OAAO,SAAS,EAChB,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAC/B,IAAI,aAAa,CAAC,MAAM;YACvB,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QAEA,iFAAiF;QACjF,MAAM,iBAAiB,QAAQ,GAAG,CAAC,sBAAsB;QACzD,MAAM,iBAAiB,QAAQ,GAAG,CAAC,sBAAsB;QAEzD,IAAI,kBAAkB,gBAAgB;YACrC,MAAM,aAAa;gBAClB,UAAU;gBACV,UAAU;gBACV,YAAY,KAAK,GAAG,KAAK,SAAS;gBAClC,OAAO;gBACP,SAAS,CAAC,IAAI,EAAE,eAAe,eAAe,CAAC;gBAC/C,cAAc;oBACb;oBACA;iBACA;gBACD,cAAc;oBACb;wBACC,MAAM;4BACL;4BACA;yBACA;wBACD,UAAU;wBACV,YAAY;oBACb;iBACA;YACF;YAEA,OAAO;gBACN,SAAS;gBACT;YACD;QACD;QAEA,MAAM,EAAE,mBAAmB,EAAE,GAAG;QAChC,MAAM,SAAS,MAAM,oBAAoB;YACxC,UAAU,KAAK,KAAK,IAAI,KAAK,EAAE;YAC/B,KAAK;QACN;QAEA,IAAI,CAAC,OAAO,OAAO,EAAE;YACpB,OAAO;QACR;QAEA,OAAO;YACN,SAAS;YACT,YAAY,OAAO,UAAU;QAC9B;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAEA,wFAAwF;AACxF,+BAA+B;AAC/B,wFAAwF;AAExF;;CAEC,GACD,eAAe,cAAc,UAAiB;IAC7C,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,cACL,MAAM,CACN,CAAC;;;;MAIC,CAAC,EAEH,EAAE,CAAC,cAAc,YACjB,EAAE,CAAC,cAAc,MACjB,KAAK,CAAC,eAAe;YAAE,WAAW;QAAM;QAE1C,IAAI,OAAO;YACV,MAAM;QACP;QAEA,OAAO;YACN,SAAS;YACT,MAAM,QAAQ,EAAE;QACjB;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C;IACD;AACD;AAEA;;CAEC,GACD,eAAe,oBAAoB,WAAmB,EAAE,MAAc;IACrE,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,cACL,MAAM,CAAC;YACP,SAAS;YACT,SAAS,IAAI,OAAO,WAAW;YAC/B,SAAS;QACV,GACC,EAAE,CAAC,MAAM,aACT,MAAM,GACN,MAAM;QAER,IAAI,OAAO;YACV,MAAM;QACP;QAEA,IAAA,sTAAc,EAAC;QAEf,OAAO;YACN,SAAS;YACT;QACD;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAEA;;CAEC,GACD,eAAe,gBAAgB,WAAmB,EAAE,MAAc;IACjE,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACtB,IAAI,CAAC,cACL,MAAM,CAAC;YACP,YAAY,IAAI,OAAO,WAAW;YAClC,YAAY;QACb,GACC,EAAE,CAAC,MAAM;QAEX,IAAI,OAAO;YACV,MAAM;QACP;QAEA,IAAA,sTAAc,EAAC;QAEf,OAAO;YAAE,SAAS;QAAK;IACxB,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C;IACD;AACD;AASO,eAAe,oBAAoB,UAAiB;IAC1D,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,sBACL,MAAM,CACN,CAAC;;;;MAIC,CAAC,EAEH,EAAE,CAAC,cAAc,YACjB,EAAE,CAAC,cAAc,MACjB,KAAK,CAAC,YAAY;YAAE,WAAW;QAAM;QAEvC,IAAI,OAAO;YACV,MAAM;QACP;QAEA,OAAO;YACN,SAAS;YACT,MAAM,QAAQ,EAAE;QACjB;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAEA;;CAEC,GACD,eAAe,sBAAsB,MA2BpC;IACA,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,sBACL,MAAM,CAAC;YACP,YAAY,OAAO,SAAS;YAC5B,YAAY,OAAO,MAAM;YACzB,MAAM,OAAO,IAAI;YACjB,aAAa,OAAO,WAAW;YAC/B,cAAc,OAAO,WAAW;YAChC,UAAU,OAAO,QAAQ,IAAI;YAC7B,gBAAgB,OAAO,aAAa;YACpC,UAAU,OAAO,QAAQ,IAAI;YAC7B,oBAAoB,OAAO,gBAAgB;YAC3C,wBAAwB,OAAO,mBAAmB;YAClD,cAAc,OAAO,WAAW;YAChC,cAAc,OAAO,WAAW,IAAI;YACpC,UAAU,OAAO,OAAO;YACxB,kBAAkB,OAAO,cAAc;YACvC,mBAAmB,OAAO,eAAe;YACzC,oBAAoB,OAAO,eAAe;YAC1C,kBAAkB,OAAO,eAAe,KAAK;YAC7C,wBAAwB,OAAO,oBAAoB;YACnD,iCACC,OAAO,6BAA6B,KAAK;YAC1C,+BACC,OAAO,2BAA2B,KAAK;YACxC,cAAc,OAAO,WAAW;YAChC,WAAW;QACZ,GACC,MAAM,GACN,MAAM;QAER,IAAI,OAAO;YACV,MAAM;QACP;QAEA,IAAA,sTAAc,EAAC;QAEf,OAAO;YACN,SAAS;YACT;QACD;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAKO,eAAe,sBAAsB,MAqB3C;IACA,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,aAAsC,CAAC;QAE7C,IAAI,OAAO,IAAI,KAAK,WAAW;YAC9B,WAAW,IAAI,GAAG,OAAO,IAAI;QAC9B;QACA,IAAI,OAAO,WAAW,KAAK,WAAW;YACrC,WAAW,WAAW,GAAG,OAAO,WAAW;QAC5C;QACA,IAAI,OAAO,QAAQ,KAAK,WAAW;YAClC,WAAW,QAAQ,GAAG,OAAO,QAAQ;QACtC;QACA,IAAI,OAAO,aAAa,KAAK,WAAW;YACvC,WAAW,cAAc,GAAG,OAAO,aAAa;QACjD;QACA,IAAI,OAAO,QAAQ,KAAK,WAAW;YAClC,WAAW,QAAQ,GAAG,OAAO,QAAQ;QACtC;QACA,IAAI,OAAO,gBAAgB,KAAK,WAAW;YAC1C,WAAW,kBAAkB,GAAG,OAAO,gBAAgB;QACxD;QACA,IAAI,OAAO,mBAAmB,KAAK,WAAW;YAC7C,WAAW,sBAAsB,GAAG,OAAO,mBAAmB;QAC/D;QACA,IAAI,OAAO,WAAW,KAAK,WAAW;YACrC,WAAW,YAAY,GAAG,OAAO,WAAW;QAC7C;QACA,IAAI,OAAO,WAAW,KAAK,WAAW;YACrC,WAAW,YAAY,GAAG,OAAO,WAAW;QAC7C;QACA,IAAI,OAAO,OAAO,KAAK,WAAW;YACjC,WAAW,QAAQ,GAAG,OAAO,OAAO;QACrC;QACA,IAAI,OAAO,cAAc,KAAK,WAAW;YACxC,WAAW,gBAAgB,GAAG,OAAO,cAAc;QACpD;QACA,IAAI,OAAO,eAAe,KAAK,WAAW;YACzC,WAAW,iBAAiB,GAAG,OAAO,eAAe;QACtD;QACA,IAAI,OAAO,eAAe,KAAK,WAAW;YACzC,WAAW,kBAAkB,GAAG,OAAO,eAAe;QACvD;QACA,IAAI,OAAO,eAAe,KAAK,WAAW;YACzC,WAAW,gBAAgB,GAAG,OAAO,eAAe;QACrD;QACA,IAAI,OAAO,oBAAoB,KAAK,WAAW;YAC9C,WAAW,sBAAsB,GAAG,OAAO,oBAAoB;QAChE;QACA,IAAI,OAAO,6BAA6B,KAAK,WAAW;YACvD,WAAW,+BAA+B,GACzC,OAAO,6BAA6B;QACtC;QACA,IAAI,OAAO,2BAA2B,KAAK,WAAW;YACrD,WAAW,6BAA6B,GACvC,OAAO,2BAA2B;QACpC;QACA,IAAI,OAAO,WAAW,KAAK,WAAW;YACrC,WAAW,YAAY,GAAG,OAAO,WAAW;QAC7C;QACA,IAAI,OAAO,QAAQ,KAAK,WAAW;YAClC,WAAW,SAAS,GAAG,OAAO,QAAQ;QACvC;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,sBACL,MAAM,CAAC,YACP,EAAE,CAAC,MAAM,OAAO,MAAM,EACtB,MAAM,GACN,MAAM;QAER,IAAI,OAAO;YACV,MAAM;QACP;QAEA,IAAA,sTAAc,EAAC;QAEf,OAAO;YACN,SAAS;YACT;QACD;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAKO,eAAe,sBAAsB,MAAc,EAAE,MAAc;IACzE,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACtB,IAAI,CAAC,sBACL,MAAM,CAAC;YACP,YAAY,IAAI,OAAO,WAAW;YAClC,YAAY;QACb,GACC,EAAE,CAAC,MAAM;QAEX,IAAI,OAAO;YACV,MAAM;QACP;QAEA,IAAA,sTAAc,EAAC;QAEf,OAAO;YAAE,SAAS;QAAK;IACxB,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAKO,eAAe,sBAAsB,MAAc,EAAE,QAAiB;IAC5E,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,sBACL,MAAM,CAAC;YAAE,WAAW;QAAS,GAC7B,EAAE,CAAC,MAAM,QACT,MAAM,GACN,MAAM;QAER,IAAI,OAAO;YACV,MAAM;QACP;QAEA,IAAA,sTAAc,EAAC;QAEf,OAAO;YACN,SAAS;YACT;QACD;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAEA,wFAAwF;AACxF,wCAAwC;AACxC,wFAAwF;AAExF;;CAEC,GACD,eAAe,yBACd,aAAqB,EACrB,OAAO,EAAE;IAET,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,YAAY,IAAI;QACtB,UAAU,OAAO,CAAC,UAAU,OAAO,KAAK;QAExC,sBAAsB;QACtB,MAAM,EAAE,MAAM,SAAS,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAClD,IAAI,CAAC,kBACL,MAAM,CAAC,sDACP,EAAE,CAAC,QAAQ,SACX,EAAE,CAAC,mBAAmB,eACtB,GAAG,CAAC,cAAc,UAAU,WAAW;QAEzC,IAAI,WAAW;YACd,MAAM;QACP;QAEA,qBAAqB;QACrB,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,QAAQ,EAAE,GAAG,MAAM,SAChD,IAAI,CAAC,kBACL,MAAM,CAAC,uCACP,EAAE,CAAC,QAAQ,OACX,EAAE,CAAC,mBAAmB,eACtB,GAAG,CAAC,cAAc,UAAU,WAAW;QAEzC,IAAI,UAAU;YACb,MAAM;QACP;QAEA,uBAAuB;QACvB,MAAM,QAAQ,aAAa,EAAE;QAC7B,MAAM,MAAM,YAAY,EAAE;QAE1B,MAAM,gBAAgB,MAAM,MAAM,CAAC,CAAC,IAAM,EAAE,SAAS,KAAK,WAAW,MAAM;QAC3E,MAAM,gBAAgB,MAAM,MAAM,CACjC,CAAC,IAAM,EAAE,SAAS,KAAK,YACtB,MAAM;QACR,MAAM,oBAAoB,MAAM,MAAM,CACrC,CAAC,KAAK,IAAM,MAAM,CAAC,EAAE,aAAa,IAAI,CAAC,GACvC;QAED,MAAM,cAAc,IAAI,MAAM,CAAC,CAAC,IAAM,EAAE,SAAS,KAAK,WAAW,MAAM;QACvE,MAAM,cAAc,IAAI,MAAM,CAAC,CAAC,IAAM,EAAE,SAAS,KAAK,YAAY,MAAM;QAExE,OAAO;YACN,SAAS;YACT,MAAM;gBACL;gBACA;gBACA,YAAY,gBAAgB;gBAC5B;gBACA;gBACA;gBACA,UAAU,cAAc;gBACxB,YAAY,oBAAoB;uBAAI;uBAAU;iBAAI,EAAE;YACrD;QACD;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAEA;;CAEC,GACD,eAAe,qBAAqB,UAAiB,EAAE,OAAO,EAAE;IAC/D,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAsB;QACvD;QAEA,MAAM,YAAY,IAAI;QACtB,UAAU,OAAO,CAAC,UAAU,OAAO,KAAK;QAExC,yCAAyC;QACzC,MAAM,EAAE,MAAM,cAAc,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5C,IAAI,CAAC,kBACL,MAAM,CAAC,sDACP,EAAE,CAAC,cAAc,YACjB,EAAE,CAAC,QAAQ;YAAC;YAAS;SAAM,EAC3B,GAAG,CAAC,cAAc,UAAU,WAAW;QAEzC,IAAI,OAAO;YACV,MAAM;QACP;QAEA,MAAM,QAAQ,kBAAkB,EAAE;QAClC,MAAM,QAAQ,MAAM,MAAM,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK;QAC7C,MAAM,MAAM,MAAM,MAAM,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK;QAE3C,MAAM,gBAAgB,MAAM,MAAM,CAAC,CAAC,IAAM,EAAE,SAAS,KAAK,WAAW,MAAM;QAC3E,MAAM,gBAAgB,MAAM,MAAM,CACjC,CAAC,IAAM,EAAE,SAAS,KAAK,YACtB,MAAM;QACR,MAAM,oBAAoB,MAAM,MAAM,CACrC,CAAC,KAAK,IAAM,MAAM,CAAC,EAAE,aAAa,IAAI,CAAC,GACvC;QAED,MAAM,cAAc,IAAI,MAAM,CAAC,CAAC,IAAM,EAAE,SAAS,KAAK,WAAW,MAAM;QACvE,MAAM,cAAc,IAAI,MAAM,CAAC,CAAC,IAAM,EAAE,SAAS,KAAK,YAAY,MAAM;QAExE,OAAO;YACN,SAAS;YACT,MAAM;gBACL;gBACA;gBACA,YAAY,gBAAgB;gBAC5B;gBACA,qBACC,MAAM,MAAM,GAAG,IAAI,oBAAoB,MAAM,MAAM,GAAG;gBACvD;gBACA;gBACA,UAAU,cAAc;gBACxB,YAAY,oBAAoB,OAAO;YACxC;QACD;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OACC,iBAAiB,QACd,MAAM,OAAO,GACb;QACL;IACD;AACD;AAEA;;CAEC,GACD,SAAS,oBACR,KAA0E,EAC1E,IAAY;IAEZ,MAAM,aAGF,CAAC;IAEL,sBAAsB;IACtB,IAAK,IAAI,IAAI,GAAG,IAAI,MAAM,IAAK;QAC9B,MAAM,OAAO,IAAI;QACjB,KAAK,OAAO,CAAC,KAAK,OAAO,KAAK;QAC9B,MAAM,UAAU,KAAK,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;QAChD,UAAU,CAAC,QAAQ,GAAG;YAAE,MAAM;YAAS,OAAO;YAAG,KAAK;YAAG,UAAU;QAAE;IACtE;IAEA,iBAAiB;IACjB,MAAM,OAAO,CAAC,CAAC;QACd,MAAM,UAAU,KAAK,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE;QAC7C,IAAI,UAAU,CAAC,QAAQ,EAAE;YACxB,IAAI,KAAK,IAAI,KAAK,SAAS;gBAC1B,UAAU,CAAC,QAAQ,CAAC,KAAK,IAAI;gBAC7B,UAAU,CAAC,QAAQ,CAAC,QAAQ,IAAI,KAAK,aAAa,IAAI;YACvD,OAAO,IAAI,KAAK,IAAI,KAAK,OAAO;gBAC/B,UAAU,CAAC,QAAQ,CAAC,GAAG,IAAI;YAC5B;QACD;IACD;IAEA,OAAO,OAAO,MAAM,CAAC,YAAY,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,IAAI,CAAC,aAAa,CAAC,EAAE,IAAI;AAC5E;;;IArwDsB;IA8BA;IAkGA;IA0IA;IA8OA;IAqBA;IAiBA;IAgCA;IA+DA;IA8QA;IAoLA;IA4MA;IAmIA;IAyHA;IAoCA;;AA3iDA,sZAAA;AA8BA,sZAAA;AAkGA,sZAAA;AA0IA,sZAAA;AA8OA,sZAAA;AAqBA,sZAAA;AAiBA,sZAAA;AAgCA,sZAAA;AA+DA,sZAAA;AA8QA,sZAAA;AAoLA,sZAAA;AA4MA,sZAAA;AAmIA,sZAAA;AAyHA,sZAAA;AAoCA,sZAAA"}},
    {"offset": {"line": 6529, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/shared/src/onboarding.ts"],"sourcesContent":["/**\n * Utilities for determining onboarding completion across server components\n * and API routes. Keeps the logic centralized so we can evolve the rules\n * (e.g. adding new steps) without hunting down scattered checks.\n */\n\ntype ProgressRecord = Record<string, unknown> | null | undefined;\n\n// Must match STEPS_ORDER from onboarding-store.ts\nconst REQUIRED_STEPS = [\"welcome\", \"company\"] as const;\nconst FINAL_STEP = \"complete\" as const;\n\n/**\n * Determine whether onboarding is complete based on stored progress metadata.\n *\n * Completion criteria (in priority order):\n * 1. `completedAt` timestamp exists (set by completeOnboardingWizard action)\n * 2. `onboardingCompleted` flag is true in progress data\n * 3. \"complete\" step exists in completedSteps array\n *\n * Note: We intentionally check multiple signals for backward compatibility\n * with older onboarding records that may have different data structures.\n */\nexport function isOnboardingComplete(options: {\n\tprogress?: ProgressRecord;\n\tcompletedAt?: string | null;\n}): boolean {\n\tconst { progress, completedAt } = options;\n\n\t// Primary check: completedAt timestamp from database\n\tif (completedAt) {\n\t\treturn true;\n\t}\n\n\tif (!progress || typeof progress !== \"object\") {\n\t\treturn false;\n\t}\n\n\tconst progressRecord = progress as Record<string, unknown>;\n\n\t// Check onboardingCompleted flag\n\tif (progressRecord.onboardingCompleted === true) {\n\t\treturn true;\n\t}\n\n\t// Check if completedSteps array includes the final step\n\tconst completedSteps = progressRecord.completedSteps;\n\tif (Array.isArray(completedSteps) && completedSteps.includes(FINAL_STEP)) {\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n/**\n * Get onboarding progress percentage based on completed steps.\n */\nexport function getOnboardingProgress(options: {\n\tprogress?: ProgressRecord;\n}): number {\n\tconst { progress } = options;\n\n\tif (!progress || typeof progress !== \"object\") {\n\t\treturn 0;\n\t}\n\n\tconst progressRecord = progress as Record<string, unknown>;\n\tconst completedSteps = progressRecord.completedSteps;\n\tconst skippedSteps = progressRecord.skippedSteps;\n\n\tif (!Array.isArray(completedSteps)) {\n\t\treturn 0;\n\t}\n\n\tconst totalSteps = 14; // Total steps in onboarding\n\tconst finishedCount = completedSteps.length + (Array.isArray(skippedSteps) ? skippedSteps.length : 0);\n\n\treturn Math.round((finishedCount / totalSteps) * 100);\n}\n\n/**\n * Check if required steps are completed.\n * Returns which required steps are missing if any.\n */\nexport function getMissingRequiredSteps(options: {\n\tprogress?: ProgressRecord;\n}): string[] {\n\tconst { progress } = options;\n\n\tif (!progress || typeof progress !== \"object\") {\n\t\treturn [...REQUIRED_STEPS];\n\t}\n\n\tconst progressRecord = progress as Record<string, unknown>;\n\tconst completedSteps = progressRecord.completedSteps;\n\n\tif (!Array.isArray(completedSteps)) {\n\t\treturn [...REQUIRED_STEPS];\n\t}\n\n\treturn REQUIRED_STEPS.filter((step) => !completedSteps.includes(step));\n}\n\n/**\n * Get the current onboarding step from progress data.\n */\nexport function getCurrentOnboardingStep(options: {\n\tprogress?: ProgressRecord;\n}): string {\n\tconst { progress } = options;\n\n\tif (!progress || typeof progress !== \"object\") {\n\t\treturn \"welcome\";\n\t}\n\n\tconst progressRecord = progress as Record<string, unknown>;\n\tconst currentStep = progressRecord.currentStep;\n\n\tif (typeof currentStep === \"string\" && currentStep.length > 0) {\n\t\treturn currentStep;\n\t}\n\n\treturn \"welcome\";\n}\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;;;;;;;AAID,kDAAkD;AAClD,MAAM,iBAAiB;IAAC;IAAW;CAAU;AAC7C,MAAM,aAAa;AAaZ,SAAS,qBAAqB,OAGpC;IACA,MAAM,EAAE,QAAQ,EAAE,WAAW,EAAE,GAAG;IAElC,qDAAqD;IACrD,IAAI,aAAa;QAChB,OAAO;IACR;IAEA,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC9C,OAAO;IACR;IAEA,MAAM,iBAAiB;IAEvB,iCAAiC;IACjC,IAAI,eAAe,mBAAmB,KAAK,MAAM;QAChD,OAAO;IACR;IAEA,wDAAwD;IACxD,MAAM,iBAAiB,eAAe,cAAc;IACpD,IAAI,MAAM,OAAO,CAAC,mBAAmB,eAAe,QAAQ,CAAC,aAAa;QACzE,OAAO;IACR;IAEA,OAAO;AACR;AAKO,SAAS,sBAAsB,OAErC;IACA,MAAM,EAAE,QAAQ,EAAE,GAAG;IAErB,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC9C,OAAO;IACR;IAEA,MAAM,iBAAiB;IACvB,MAAM,iBAAiB,eAAe,cAAc;IACpD,MAAM,eAAe,eAAe,YAAY;IAEhD,IAAI,CAAC,MAAM,OAAO,CAAC,iBAAiB;QACnC,OAAO;IACR;IAEA,MAAM,aAAa,IAAI,4BAA4B;IACnD,MAAM,gBAAgB,eAAe,MAAM,GAAG,CAAC,MAAM,OAAO,CAAC,gBAAgB,aAAa,MAAM,GAAG,CAAC;IAEpG,OAAO,KAAK,KAAK,CAAC,AAAC,gBAAgB,aAAc;AAClD;AAMO,SAAS,wBAAwB,OAEvC;IACA,MAAM,EAAE,QAAQ,EAAE,GAAG;IAErB,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC9C,OAAO;eAAI;SAAe;IAC3B;IAEA,MAAM,iBAAiB;IACvB,MAAM,iBAAiB,eAAe,cAAc;IAEpD,IAAI,CAAC,MAAM,OAAO,CAAC,iBAAiB;QACnC,OAAO;eAAI;SAAe;IAC3B;IAEA,OAAO,eAAe,MAAM,CAAC,CAAC,OAAS,CAAC,eAAe,QAAQ,CAAC;AACjE;AAKO,SAAS,yBAAyB,OAExC;IACA,MAAM,EAAE,QAAQ,EAAE,GAAG;IAErB,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC9C,OAAO;IACR;IAEA,MAAM,iBAAiB;IACvB,MAAM,cAAc,eAAe,WAAW;IAE9C,IAAI,OAAO,gBAAgB,YAAY,YAAY,MAAM,GAAG,GAAG;QAC9D,OAAO;IACR;IAEA,OAAO;AACR"}},
    {"offset": {"line": 6617, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/auth/src/session.ts"],"sourcesContent":["/**\n * Session Management Utilities - Server Component Helpers\n *\n * Features:\n * - Get current authenticated user\n * - Get current session\n * - Require authentication (throw error if not authenticated)\n * - Check user permissions and roles\n * - Server Component compatible\n */\n\nimport type { Session, User } from \"@supabase/supabase-js\";\nimport { cache } from \"react\";\nimport { createClient } from \"@stratos/database/server\";\n\n/**\n * Get Current User - Cached for performance\n *\n * Returns the currently authenticated user or null if not authenticated.\n * Cached per request to avoid multiple database calls.\n *\n * SECURITY: Uses getUser() instead of getSession() to verify the session\n * is authentic by contacting the Supabase Auth server. Session data from\n * cookies cannot be trusted without server-side verification.\n */\nexport const getCurrentUser = cache(async (): Promise<User | null> => {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Use getUser() to authenticate with Supabase Auth server\n\t\t// This verifies the session is valid and not tampered with\n\t\tconst {\n\t\t\tdata: { user },\n\t\t\terror,\n\t\t} = await supabase.auth.getUser();\n\n\t\t// Handle error - could be AuthSessionMissingError or network error\n\t\tif (error) {\n\t\t\t// AuthSessionMissingError is expected when user is not authenticated\n\t\t\t// Don't log this as an error, just return null\n\t\t\tif (error.name === \"AuthSessionMissingError\") {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\n\t\treturn user;\n\t} catch (error) {\n\t\t// Catch any unexpected errors (network issues, etc.)\n\t\t// The error might be thrown instead of returned in some cases\n\t\tif (\n\t\t\terror &&\n\t\t\ttypeof error === \"object\" &&\n\t\t\t\"name\" in error &&\n\t\t\terror.name === \"AuthSessionMissingError\"\n\t\t) {\n\t\t\treturn null;\n\t\t}\n\t\treturn null;\n\t}\n});\n\n/**\n * Get Session - Cached for performance\n *\n * Returns the current session or null if not authenticated.\n * Cached per request to avoid multiple database calls.\n */\nconst getSession = cache(async (): Promise<Session | null> => {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { session },\n\t\t\terror,\n\t\t} = await supabase.auth.getSession();\n\n\t\tif (error) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn session;\n\t} catch (_error) {\n\t\treturn null;\n\t}\n});\n\n/**\n * Require User - Throw error if not authenticated\n *\n * Use this in Server Components or Server Actions that require authentication.\n * Will throw an error that can be caught by error boundaries.\n */\nexport async function requireUser(): Promise<User> {\n\tconst user = await getCurrentUser();\n\n\tif (!user) {\n\t\tthrow new Error(\"Authentication required. Please log in to continue.\");\n\t}\n\n\treturn user;\n}\n\n/**\n * Require Session - Throw error if no session\n *\n * Use this when you need both user and session data (e.g., access token).\n */\nasync function requireSession(): Promise<Session> {\n\tconst session = await getSession();\n\n\tif (!session) {\n\t\tthrow new Error(\"Active session required. Please log in to continue.\");\n\t}\n\n\treturn session;\n}\n\n/**\n * Check if user is authenticated\n *\n * Returns true if user is authenticated, false otherwise.\n * Useful for conditional rendering in Server Components.\n */\nasync function isAuthenticated(): Promise<boolean> {\n\tconst user = await getCurrentUser();\n\treturn user !== null;\n}\n\n/**\n * Get User Metadata\n *\n * Returns user metadata from Supabase Auth.\n * Useful for accessing additional user properties stored in auth.users.\n */\nasync function getUserMetadata<\n\tT = Record<string, any>,\n>(): Promise<T | null> {\n\tconst user = await getCurrentUser();\n\n\tif (!user) {\n\t\treturn null;\n\t}\n\n\treturn (user.user_metadata as T) || null;\n}\n\n/**\n * Check User Email Verified\n *\n * Returns true if user's email is verified, false otherwise.\n */\nasync function isEmailVerified(): Promise<boolean> {\n\tconst user = await getCurrentUser();\n\n\tif (!user) {\n\t\treturn false;\n\t}\n\n\treturn user.email_confirmed_at !== undefined;\n}\n\n/**\n * Get User ID\n *\n * Returns the user's ID or null if not authenticated.\n * Convenient helper for getting just the user ID.\n */\nasync function getUserId(): Promise<string | null> {\n\tconst user = await getCurrentUser();\n\treturn user?.id || null;\n}\n\n/**\n * Get User Email\n *\n * Returns the user's email or null if not authenticated.\n */\nasync function getUserEmail(): Promise<string | null> {\n\tconst user = await getCurrentUser();\n\treturn user?.email || null;\n}\n\n/**\n * Get Access Token\n *\n * Returns the current access token for API calls.\n * Useful for calling external APIs that require authentication.\n */\nasync function getAccessToken(): Promise<string | null> {\n\tconst session = await getSession();\n\treturn session?.access_token || null;\n}\n\n/**\n * Refresh Session\n *\n * Manually refresh the session to get a new access token.\n * Usually not needed as Supabase handles this automatically.\n */\nasync function refreshSession(): Promise<Session | null> {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { session },\n\t\t\terror,\n\t\t} = await supabase.auth.refreshSession();\n\n\t\tif (error) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn session;\n\t} catch (_error) {\n\t\treturn null;\n\t}\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;CASC;;;;;;AAGD;AACA;;;AAYO,MAAM,iBAAiB,IAAA,qXAAK,EAAC;IACnC,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QAEnC,IAAI,CAAC,UAAU;YACd,OAAO;QACR;QAEA,0DAA0D;QAC1D,2DAA2D;QAC3D,MAAM,EACL,MAAM,EAAE,IAAI,EAAE,EACd,KAAK,EACL,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAE/B,mEAAmE;QACnE,IAAI,OAAO;YACV,qEAAqE;YACrE,+CAA+C;YAC/C,IAAI,MAAM,IAAI,KAAK,2BAA2B;gBAC7C,OAAO;YACR;YACA,OAAO;QACR;QAEA,OAAO;IACR,EAAE,OAAO,OAAO;QACf,qDAAqD;QACrD,8DAA8D;QAC9D,IACC,SACA,OAAO,UAAU,YACjB,UAAU,SACV,MAAM,IAAI,KAAK,2BACd;YACD,OAAO;QACR;QACA,OAAO;IACR;AACD;AAEA;;;;;CAKC,GACD,MAAM,aAAa,IAAA,qXAAK,EAAC;IACxB,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QAEnC,IAAI,CAAC,UAAU;YACd,OAAO;QACR;QAEA,MAAM,EACL,MAAM,EAAE,OAAO,EAAE,EACjB,KAAK,EACL,GAAG,MAAM,SAAS,IAAI,CAAC,UAAU;QAElC,IAAI,OAAO;YACV,OAAO;QACR;QAEA,OAAO;IACR,EAAE,OAAO,QAAQ;QAChB,OAAO;IACR;AACD;AAQO,eAAe;IACrB,MAAM,OAAO,MAAM;IAEnB,IAAI,CAAC,MAAM;QACV,MAAM,IAAI,MAAM;IACjB;IAEA,OAAO;AACR;AAEA;;;;CAIC,GACD,eAAe;IACd,MAAM,UAAU,MAAM;IAEtB,IAAI,CAAC,SAAS;QACb,MAAM,IAAI,MAAM;IACjB;IAEA,OAAO;AACR;AAEA;;;;;CAKC,GACD,eAAe;IACd,MAAM,OAAO,MAAM;IACnB,OAAO,SAAS;AACjB;AAEA;;;;;CAKC,GACD,eAAe;IAGd,MAAM,OAAO,MAAM;IAEnB,IAAI,CAAC,MAAM;QACV,OAAO;IACR;IAEA,OAAO,AAAC,KAAK,aAAa,IAAU;AACrC;AAEA;;;;CAIC,GACD,eAAe;IACd,MAAM,OAAO,MAAM;IAEnB,IAAI,CAAC,MAAM;QACV,OAAO;IACR;IAEA,OAAO,KAAK,kBAAkB,KAAK;AACpC;AAEA;;;;;CAKC,GACD,eAAe;IACd,MAAM,OAAO,MAAM;IACnB,OAAO,MAAM,MAAM;AACpB;AAEA;;;;CAIC,GACD,eAAe;IACd,MAAM,OAAO,MAAM;IACnB,OAAO,MAAM,SAAS;AACvB;AAEA;;;;;CAKC,GACD,eAAe;IACd,MAAM,UAAU,MAAM;IACtB,OAAO,SAAS,gBAAgB;AACjC;AAEA;;;;;CAKC,GACD,eAAe;IACd,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,qJAAY;QAEnC,IAAI,CAAC,UAAU;YACd,OAAO;QACR;QAEA,MAAM,EACL,MAAM,EAAE,OAAO,EAAE,EACjB,KAAK,EACL,GAAG,MAAM,SAAS,IAAI,CAAC,cAAc;QAEtC,IAAI,OAAO;YACV,OAAO;QACR;QAEA,OAAO;IACR,EAAE,OAAO,QAAQ;QAChB,OAAO;IACR;AACD"}},
    {"offset": {"line": 6784, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/auth/src/company-context.ts"],"sourcesContent":["/**\n * Company Context Management\n *\n * Handles multi-tenancy by tracking and switching between companies\n * for users who may be members of multiple companies.\n *\n * Features:\n * - Active company stored in HTTP-only cookie\n * - Falls back to first available company\n * - Validates access before switching\n * - Server-side only (no client-side state)\n *\n * PERFORMANCE: All functions wrapped with React.cache() to prevent\n * redundant database queries across components in the same request.\n */\n\n\nimport { createClient } from \"@stratos/database/server\";\nimport { createServiceSupabaseClient } from \"@stratos/database/service-client\";\nimport { isOnboardingComplete } from \"@stratos/shared/onboarding\";\nimport { cache } from \"react\";\nimport { getCurrentUser } from \"./session\";\n\nconst ACTIVE_COMPANY_COOKIE = \"active_company_id\";\n\n/**\n * Company Info\n */\nexport type CompanyInfo = {\n\tid: string;\n\tname: string;\n\tlogo?: string | null;\n\tphone?: string | null;\n\temail?: string | null;\n};\n\n/**\n * Get Active Company ID\n *\n * Returns the currently active company for the user.\n * Falls back to first company if no active company is set.\n *\n * PERFORMANCE: Wrapped with React.cache() - called by every component,\n * but only executes once per request.\n *\n * @returns Company ID string or null if user has no companies\n */\nexport const getActiveCompanyId = cache(async (): Promise<string | null> => {\n\tconst { cookies } = await import(\"next/headers\");\n\tlet cookieStore;\n\ttry {\n\t\tcookieStore = await cookies();\n\t} catch (error) {\n\t\t// During prerendering, cookies() may reject - return null\n\t\t// This allows PPR to work correctly\n\t\tif (error instanceof Error && (\n\t\t\terror.message.includes(\"During prerendering\") ||\n\t\t\terror.message.includes(\"prerendering\") ||\n\t\t\terror.message.includes(\"cookies()\")\n\t\t)) {\n\t\t\treturn null;\n\t\t}\n\t\tthrow error;\n\t}\n\tconst activeCompanyId = cookieStore.get(ACTIVE_COMPANY_COOKIE)?.value;\n\n\tif (activeCompanyId) {\n\t\t// Verify user still has access to this company\n\t\tconst hasAccess = await verifyCompanyAccess(activeCompanyId);\n\t\tif (hasAccess) {\n\t\t\treturn activeCompanyId;\n\t\t}\n\t}\n\n\t// Fall back to first available company\n\tconst companies = await getUserCompanies();\n\treturn companies[0]?.id || null;\n});\n\n/**\n * Get Active Company Info\n *\n * Returns the full company object for the active company.\n *\n * PERFORMANCE: Wrapped with React.cache() - called by multiple components,\n * but only executes once per request.\n *\n * @returns CompanyInfo object or null\n */\nexport const getActiveCompany = cache(async (): Promise<CompanyInfo | null> => {\n\tconst companyId = await getActiveCompanyId();\n\tif (!companyId) {\n\t\treturn null;\n\t}\n\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\treturn null;\n\t}\n\n\tconst { data: company } = await supabase\n\t\t.from(\"companies\")\n\t\t.select(\"id, name, logo, phone, email\")\n\t\t.eq(\"id\", companyId)\n\t\t.is(\"deleted_at\", null) // Exclude archived companies\n\t\t.single();\n\n\treturn company;\n});\n\n/**\n * Set Active Company\n *\n * Switches the user's active company context.\n * Validates access before switching.\n *\n * @param companyId - Company ID to switch to\n * @throws Error if user doesn't have access to this company\n */\nexport async function setActiveCompany(companyId: string): Promise<void> {\n\t// Verify access before switching\n\tconst hasAccess = await verifyCompanyAccess(companyId);\n\n\tif (!hasAccess) {\n\t\tthrow new Error(\"You don't have access to this company\");\n\t}\n\n\tconst { cookies } = await import(\"next/headers\");\n\tconst cookieStore = await cookies();\n\tcookieStore.set(ACTIVE_COMPANY_COOKIE, companyId, {\n\t\thttpOnly: true,\n\t\tsecure: process.env.NODE_ENV === \"production\",\n\t\tsameSite: \"lax\",\n\t\tmaxAge: 60 * 60 * 24 * 30, // 30 days\n\t\tpath: \"/\",\n\t});\n}\n\n/**\n * Clear Active Company\n *\n * Removes the active company cookie.\n */\nexport async function clearActiveCompany(): Promise<void> {\n\tconst { cookies } = await import(\"next/headers\");\n\tconst cookieStore = await cookies();\n\tcookieStore.delete(ACTIVE_COMPANY_COOKIE);\n}\n\n/**\n * Get User Companies\n *\n * Returns all companies the user has access to.\n *\n * SECURITY: Uses service role because:\n * - Query filters to user's own memberships (user_id = authenticated user)\n * - JOIN to companies table causes RLS recursion with anon key\n * - User only sees their own team_members records\n * - Companies table has its own RLS protection\n *\n * @returns Array of CompanyInfo objects\n */\nexport const getUserCompanies = cache(async (): Promise<CompanyInfo[]> => {\n\tconst user = await getCurrentUser();\n\tif (!user) {\n\t\treturn [];\n\t}\n\n\t// Use service role to bypass RLS recursion on JOIN\n\t// Query is safe: explicitly filtered to user's own records\n\tconst supabase = await createServiceSupabaseClient();\n\tif (!supabase) {\n\t\treturn [];\n\t}\n\n\tconst { data: memberships } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(\n\t\t\t`\n      company_id,\n      companies!inner (\n        id,\n        name,\n        logo,\n        deleted_at,\n        onboarding_completed_at\n      )\n    `,\n\t\t)\n\t\t.eq(\"user_id\", user.id)\n\t\t.eq(\"status\", \"active\")\n\t\t.is(\"companies.deleted_at\", null); // Exclude archived companies\n\n\tif (!memberships) {\n\t\treturn [];\n\t}\n\n\t// Sort companies: prioritize completed onboarding over incomplete\n\tconst sorted = memberships.sort((a: any, b: any) => {\n\t\tconst aCompleted = !!a.companies.onboarding_completed_at;\n\t\tconst bCompleted = !!b.companies.onboarding_completed_at;\n\n\t\t// Completed companies first\n\t\tif (aCompleted && !bCompleted) return -1;\n\t\tif (!aCompleted && bCompleted) return 1;\n\n\t\t// Then by name alphabetically\n\t\treturn a.companies.name.localeCompare(b.companies.name);\n\t});\n\n\treturn sorted.map((m: any) => ({\n\t\tid: m.companies.id,\n\t\tname: m.companies.name,\n\t\tlogo: m.companies.logo,\n\t}));\n});\n\n/**\n * Verify Company Access\n *\n * Checks if user has access to a company.\n *\n * @param companyId - Company ID to verify\n * @returns true if user has access, false otherwise\n */\nconst verifyCompanyAccess = cache(\n\tasync (companyId: string): Promise<boolean> => {\n\t\tconst user = await getCurrentUser();\n\t\tif (!user) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Parallel queries instead of sequential (saves 20-30ms)\n\t\tconst [companyResult, memberResult] = await Promise.all([\n\t\t\t// Check if company exists and is not archived\n\t\t\tsupabase\n\t\t\t\t.from(\"companies\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"id\", companyId)\n\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t.single(),\n\n\t\t\t// Check if user has active membership\n\t\t\tsupabase\n\t\t\t\t.from(\"company_memberships\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"user_id\", user.id)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"status\", \"active\")\n\t\t\t\t.single(),\n\t\t]);\n\n\t\t// Both must succeed\n\t\treturn !!(companyResult.data && memberResult.data);\n\t},\n);\n\n/**\n * Get Active Team Member ID\n *\n * Returns the team_members.id for the current user in the active company.\n * Used for personal inbox filtering and other team-member-specific features.\n *\n * PERFORMANCE: Wrapped with React.cache() - called by multiple components,\n * but only executes once per request.\n *\n * @returns Team member ID string or null if not found\n */\nexport const getActiveTeamMemberId = cache(async (): Promise<string | null> => {\n\tconst user = await getCurrentUser();\n\tif (!user) {\n\t\treturn null;\n\t}\n\n\tconst companyId = await getActiveCompanyId();\n\tif (!companyId) {\n\t\treturn null;\n\t}\n\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\treturn null;\n\t}\n\n\tconst { data: teamMember } = await supabase\n\t\t.from(\"team_members\")\n\t\t.select(\"id\")\n\t\t.eq(\"user_id\", user.id)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"active\")\n\t\t.single();\n\n\treturn teamMember?.id || null;\n});\n\n/**\n * Require Active Company\n *\n * Throws error if no active company is set.\n * Useful for actions that require a company context.\n *\n * @returns Company ID string\n * @throws Error if no active company\n */\nexport async function requireActiveCompany(): Promise<string> {\n\tconst companyId = await getActiveCompanyId();\n\n\tif (!companyId) {\n\t\tthrow new Error(\"No active company selected. Please select a company.\");\n\t}\n\n\treturn companyId;\n}\n\n/**\n * Check if User Has Multiple Companies\n *\n * Useful for conditionally showing company switcher UI.\n *\n * @returns true if user has 2+ companies, false otherwise\n */\nasync function hasMultipleCompanies(): Promise<boolean> {\n\tconst companies = await getUserCompanies();\n\treturn companies.length > 1;\n}\n\n/**\n * Check if Active Company Has Completed Onboarding\n *\n * Checks if the active company has an active payment subscription.\n * This is used to determine if onboarding is complete.\n *\n * SECURITY: Uses service role because:\n * - Query filters to user's own membership (user_id = authenticated user)\n * - JOIN to companies table causes RLS recursion with anon key\n * - User only sees their own team_members record\n * - Companies table has its own RLS protection\n *\n * @returns true if company has active/trialing subscription, false otherwise\n */\nexport async function isActiveCompanyOnboardingComplete(): Promise<boolean> {\n\tconst user = await getCurrentUser();\n\tif (!user) {\n\t\treturn false;\n\t}\n\n\tconst activeCompanyId = await getActiveCompanyId();\n\tif (!activeCompanyId) {\n\t\treturn false;\n\t}\n\n\t// Use service role to bypass RLS recursion on JOIN\n\t// Query is safe: explicitly filtered to user's own record\n\tconst supabase = await createServiceSupabaseClient();\n\tif (!supabase) {\n\t\treturn false;\n\t}\n\n\t// Check the ACTIVE company's payment status\n\tconst { data: teamMember } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(\n\t\t\t\"company_id, companies!inner(stripe_subscription_status, onboarding_progress, onboarding_completed_at)\",\n\t\t)\n\t\t.eq(\"user_id\", user.id)\n\t\t.eq(\"company_id\", activeCompanyId)\n\t\t.eq(\"status\", \"active\")\n\t\t.maybeSingle();\n\n\tif (!teamMember) {\n\t\treturn false;\n\t}\n\n\tconst companies = Array.isArray(teamMember.companies)\n\t\t? teamMember.companies[0]\n\t\t: teamMember.companies;\n\tconst subscriptionStatus = companies?.stripe_subscription_status;\n\tconst subscriptionActive =\n\t\tsubscriptionStatus === \"active\" || subscriptionStatus === \"trialing\";\n\tconst onboardingProgress =\n\t\t(companies?.onboarding_progress as Record<string, unknown>) || null;\n\tconst onboardingFinished = isOnboardingComplete({\n\t\tprogress: onboardingProgress,\n\t\tcompletedAt: companies?.onboarding_completed_at ?? null,\n\t});\n\n\treturn (\n\t\t(subscriptionActive && onboardingFinished) ||\n\t\tprocess.env.NODE_ENV === \"development\"\n\t);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7019, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/auth/company-context.ts"],"sourcesContent":["// Re-export from @stratos/auth package for backwards compatibility\nexport * from \"@stratos/auth/company-context\";\n"],"names":[],"mappings":"AAAA,mEAAmE;;AACnE"}},
    {"offset": {"line": 7027, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/auth/src/user-data.ts"],"sourcesContent":["/**\n * User Data Utilities - Secure, Cached User Data Retrieval\n *\n * Performance optimizations:\n * - React cache() for request-level memoization\n * - Supabase RLS enforces security at database level\n * - Type-safe with full TypeScript support\n * - Automatic avatar generation if none provided\n */\n\nimport { cache } from \"react\";\nimport { createClient } from \"@stratos/database/server\";\nimport { createServiceSupabaseClient } from \"@stratos/database/service-client\";\nimport { isOnboardingComplete } from \"@stratos/shared/onboarding\";\nimport { getCurrentUser } from \"./session\";\n\nexport type UserStatus = \"online\" | \"available\" | \"busy\";\n\nexport type UserProfile = {\n\tid: string;\n\tfull_name: string;\n\temail: string;\n\tavatar_url: string;\n\tbio?: string;\n\tphone?: string;\n\tstatus?: UserStatus;\n\temailVerified: boolean;\n\tcreatedAt: Date;\n};\n\n/**\n * Get User Profile - Cached and Secure\n *\n * Fetches user data from both Supabase Auth and public.users table\n * Cached per request for optimal performance\n * RLS ensures users can only access their own data\n */\nexport const getUserProfile = cache(async (): Promise<UserProfile | null> => {\n\ttry {\n\t\t// Get authenticated user from Supabase Auth\n\t\tconst user = await getCurrentUser();\n\t\tif (!user) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\t// Return mock user for development\n\t\t\treturn {\n\t\t\t\tid: \"dev-user-1\",\n\t\t\t\tfull_name: \"Development User\",\n\t\t\t\temail: \"dev@example.com\",\n\t\t\t\tavatar_url: \"https://api.dicebear.com/7.x/avataaars/svg?seed=dev\",\n\t\t\t\temailVerified: true,\n\t\t\t\tcreatedAt: new Date(),\n\t\t\t};\n\t\t}\n\n\t\t// Fetch user profile from public.users table (with RLS)\n\t\tconst { data: profile, error } = await supabase\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"id\", user.id)\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\treturn getUserProfileFromAuth(user);\n\t\t}\n\n\t\t// Merge auth data with profile data\n\t\treturn {\n\t\t\tid: user.id,\n\t\t\tfull_name:\n\t\t\t\tprofile?.full_name ||\n\t\t\t\tuser.user_metadata?.name ||\n\t\t\t\tuser.email?.split(\"@\")[0] ||\n\t\t\t\t\"User\",\n\t\t\temail: user.email || profile?.email || \"\",\n\t\t\tavatar_url:\n\t\t\t\tprofile?.avatar_url ||\n\t\t\t\tuser.user_metadata?.avatar_url ||\n\t\t\t\tgenerateAvatar(user.email || profile?.email),\n\t\t\tbio: profile?.bio || undefined,\n\t\t\tphone: profile?.phone || undefined,\n\t\t\tstatus: (profile?.status as UserStatus) || \"online\",\n\t\t\temailVerified: !!user.email_confirmed_at,\n\t\t\tcreatedAt: new Date(profile?.created_at || user.created_at),\n\t\t};\n\t} catch (_error) {\n\t\treturn {\n\t\t\tid: \"dev-user-1\",\n\t\t\tfull_name: \"Development User\",\n\t\t\temail: \"dev@example.com\",\n\t\t\tavatar_url: \"https://api.dicebear.com/7.x/avataaars/svg?seed=dev\",\n\t\t\temailVerified: true,\n\t\t\tcreatedAt: new Date(),\n\t\t};\n\t}\n});\n\n/**\n * Get User Profile from Auth Only\n *\n * Fallback when public.users table doesn't have the profile yet\n */\nfunction getUserProfileFromAuth(user: any): UserProfile {\n\treturn {\n\t\tid: user.id,\n\t\tfull_name: user.user_metadata?.name || user.email?.split(\"@\")[0] || \"User\",\n\t\temail: user.email || \"\",\n\t\tavatar_url: user.user_metadata?.avatar_url || generateAvatar(user.email),\n\t\temailVerified: !!user.email_confirmed_at,\n\t\tcreatedAt: new Date(user.created_at),\n\t};\n}\n\n/**\n * Generate Avatar URL\n *\n * Creates a unique avatar based on user email using DiceBear API\n * Falls back to initials if no email provided\n */\nfunction generateAvatar(email?: string | null): string {\n\tif (!email) {\n\t\treturn \"https://api.dicebear.com/7.x/initials/svg?seed=User\";\n\t}\n\n\t// Use email as seed for consistent avatar\n\treturn `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(email)}&backgroundColor=0ea5e9&textColor=ffffff`;\n}\n\n/**\n * Get User Initials\n *\n * Extracts initials from user name for avatar fallback\n */\nfunction getUserInitials(name: string): string {\n\treturn name\n\t\t.split(\" \")\n\t\t.map((n) => n[0])\n\t\t.join(\"\")\n\t\t.toUpperCase()\n\t\t.slice(0, 2);\n}\n\n/**\n * Format User Display Name\n *\n * Returns first name only for compact display\n */\nfunction getUserDisplayName(name: string): string {\n\treturn name.split(\" \")[0] || name;\n}\n\n/**\n * Check if User Email is Verified\n *\n * Security check for features that require verified email\n */\nconst isUserEmailVerified = cache(async (): Promise<boolean> => {\n\tconst user = await getCurrentUser();\n\tif (!user) {\n\t\treturn false;\n\t}\n\n\treturn !!user.email_confirmed_at;\n});\n\n/**\n * Get User Companies\n *\n * Fetches companies the user belongs to\n *\n * SECURITY: Uses service role because:\n * - Query filters to user's own memberships (user_id = authenticated user)\n * - JOIN to companies table causes RLS recursion with anon key\n * - User only sees their own team_members records\n * - Companies table has its own RLS protection\n */\nexport const getUserCompaniesWithStatus = cache(\n\tasync (): Promise<\n\t\tArray<{\n\t\t\tid: string;\n\t\t\tname: string;\n\t\t\tlogo?: string | null;\n\t\t\tplan: string;\n\t\t\tonboardingComplete?: boolean;\n\t\t\thasPayment?: boolean;\n\t\t}>\n\t> => {\n\t\ttry {\n\t\t\tconst user = await getCurrentUser();\n\t\t\tif (!user) {\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\t// Use service role to bypass RLS recursion on JOIN\n\t\t\t// Query is safe: explicitly filtered to user's own records\n\t\t\tconst supabase = await createServiceSupabaseClient();\n\t\t\tif (!supabase) {\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\t// Fetch user's companies via team_members join\n\t\t\t// Exclude archived companies (deleted_at IS NULL)\n\t\t\tconst { data: memberships, error } = await supabase\n\t\t\t\t.from(\"company_memberships\")\n\t\t\t\t.select(\n\t\t\t\t\t`\n        company_id,\n        companies!inner (\n          id,\n          name,\n          logo,\n          stripe_subscription_status,\n          onboarding_progress,\n          onboarding_completed_at,\n          deleted_at\n        )\n      `,\n\t\t\t\t)\n\t\t\t\t.eq(\"user_id\", user.id)\n\t\t\t\t.eq(\"status\", \"active\")\n\t\t\t\t.is(\"companies.deleted_at\", null); // Exclude archived companies\n\n\t\t\tif (error) {\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\t// Map to simplified structure with onboarding status\n\t\t\t// Deduplicate by company ID in case of multiple team_member records\n\t\t\tconst companyMap = new Map<\n\t\t\t\tstring,\n\t\t\t\t{\n\t\t\t\t\tid: string;\n\t\t\t\t\tname: string;\n\t\t\t\t\tlogo?: string | null;\n\t\t\t\t\tplan: string;\n\t\t\t\t\tonboardingComplete: boolean;\n\t\t\t\t\thasPayment: boolean;\n\t\t\t\t}\n\t\t\t>();\n\n\t\t\tmemberships?.forEach((m: any) => {\n\t\t\t\tconst companyId = m.companies.id;\n\t\t\t\tif (!companyMap.has(companyId)) {\n\t\t\t\t\tconst subscriptionStatus = m.companies.stripe_subscription_status;\n\t\t\t\t\tconst onboardingProgress =\n\t\t\t\t\t\t(m.companies.onboarding_progress as Record<string, unknown>) ||\n\t\t\t\t\t\tnull;\n\t\t\t\t\tconst onboardingComplete = isOnboardingComplete({\n\t\t\t\t\t\tprogress: onboardingProgress,\n\t\t\t\t\t\tcompletedAt: m.companies.onboarding_completed_at ?? null,\n\t\t\t\t\t});\n\t\t\t\t\tconst hasPayment =\n\t\t\t\t\t\tsubscriptionStatus === \"active\" ||\n\t\t\t\t\t\tsubscriptionStatus === \"trialing\";\n\n\t\t\t\t\tlet planLabel = \"Active\";\n\t\t\t\t\tif (!(hasPayment && onboardingComplete)) {\n\t\t\t\t\t\tplanLabel =\n\t\t\t\t\t\t\tsubscriptionStatus === \"incomplete\"\n\t\t\t\t\t\t\t\t? \"Incomplete Onboarding\"\n\t\t\t\t\t\t\t\t: \"Setup Required\";\n\t\t\t\t\t}\n\n\t\t\t\t\tcompanyMap.set(companyId, {\n\t\t\t\t\t\tid: companyId,\n\t\t\t\t\t\tname: m.companies.name,\n\t\t\t\t\t\tlogo: m.companies.logo,\n\t\t\t\t\t\tplan: planLabel,\n\t\t\t\t\t\tonboardingComplete,\n\t\t\t\t\t\thasPayment,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn Array.from(companyMap.values());\n\t\t} catch (_error) {\n\t\t\treturn [];\n\t\t}\n\t},\n);\n\n/**\n * Get User Company ID\n *\n * Gets the primary company ID for the current user\n * Returns null if user is not part of any company\n * Cached per request for optimal performance\n */\nexport const getUserCompanyId = cache(async (): Promise<string | null> => {\n\ttry {\n\t\tconst user = await getCurrentUser();\n\t\tif (!user) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Get first active company membership\n\t\tconst { data: membership, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.limit(1)\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn membership?.company_id || null;\n\t} catch (_error) {\n\t\treturn null;\n\t}\n});\n\n/**\n * Update User Profile\n *\n * Securely updates user profile data\n * RLS ensures users can only update their own profile\n */\nasync function updateUserProfile(\n\tupdates: Partial<{\n\t\tfull_name: string;\n\t\tbio: string;\n\t\tphone: string;\n\t\tavatar_url: string;\n\t}>,\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tconst user = await getCurrentUser();\n\t\tif (!user) {\n\t\t\treturn { success: false, error: \"Not authenticated\" };\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service not available\" };\n\t\t}\n\n\t\t// Update profiles table (RLS enforced)\n\t\tconst { error } = await supabase\n\t\t\t.from(\"profiles\")\n\t\t\t.update({\n\t\t\t\t...updates,\n\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t})\n\t\t\t.eq(\"id\", user.id);\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\t// If updating full_name or avatar_url, also update auth metadata\n\t\tif (updates.full_name || updates.avatar_url) {\n\t\t\tconst { error: authError } = await supabase.auth.updateUser({\n\t\t\t\tdata: {\n\t\t\t\t\tname: updates.full_name,\n\t\t\t\t\tavatar_url: updates.avatar_url,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tif (authError) {\n\t\t\t\t// Don't fail the whole operation if auth update fails\n\t\t\t}\n\t\t}\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Update failed\",\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC;;;;;;;;AAED;AACA;AACA;AACA;AACA;;;;;;AAuBO,MAAM,iBAAiB,IAAA,qXAAK,EAAC;IACnC,IAAI;QACH,4CAA4C;QAC5C,MAAM,OAAO,MAAM,IAAA,oJAAc;QACjC,IAAI,CAAC,MAAM;YACV,OAAO;QACR;QAEA,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,mCAAmC;YACnC,OAAO;gBACN,IAAI;gBACJ,WAAW;gBACX,OAAO;gBACP,YAAY;gBACZ,eAAe;gBACf,WAAW,IAAI;YAChB;QACD;QAEA,wDAAwD;QACxD,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,SACrC,IAAI,CAAC,YACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;QAER,IAAI,OAAO;YACV,OAAO,uBAAuB;QAC/B;QAEA,oCAAoC;QACpC,OAAO;YACN,IAAI,KAAK,EAAE;YACX,WACC,SAAS,aACT,KAAK,aAAa,EAAE,QACpB,KAAK,KAAK,EAAE,MAAM,IAAI,CAAC,EAAE,IACzB;YACD,OAAO,KAAK,KAAK,IAAI,SAAS,SAAS;YACvC,YACC,SAAS,cACT,KAAK,aAAa,EAAE,cACpB,eAAe,KAAK,KAAK,IAAI,SAAS;YACvC,KAAK,SAAS,OAAO;YACrB,OAAO,SAAS,SAAS;YACzB,QAAQ,AAAC,SAAS,UAAyB;YAC3C,eAAe,CAAC,CAAC,KAAK,kBAAkB;YACxC,WAAW,IAAI,KAAK,SAAS,cAAc,KAAK,UAAU;QAC3D;IACD,EAAE,OAAO,QAAQ;QAChB,OAAO;YACN,IAAI;YACJ,WAAW;YACX,OAAO;YACP,YAAY;YACZ,eAAe;YACf,WAAW,IAAI;QAChB;IACD;AACD;AAEA;;;;CAIC,GACD,SAAS,uBAAuB,IAAS;IACxC,OAAO;QACN,IAAI,KAAK,EAAE;QACX,WAAW,KAAK,aAAa,EAAE,QAAQ,KAAK,KAAK,EAAE,MAAM,IAAI,CAAC,EAAE,IAAI;QACpE,OAAO,KAAK,KAAK,IAAI;QACrB,YAAY,KAAK,aAAa,EAAE,cAAc,eAAe,KAAK,KAAK;QACvE,eAAe,CAAC,CAAC,KAAK,kBAAkB;QACxC,WAAW,IAAI,KAAK,KAAK,UAAU;IACpC;AACD;AAEA;;;;;CAKC,GACD,SAAS,eAAe,KAAqB;IAC5C,IAAI,CAAC,OAAO;QACX,OAAO;IACR;IAEA,0CAA0C;IAC1C,OAAO,CAAC,+CAA+C,EAAE,mBAAmB,OAAO,wCAAwC,CAAC;AAC7H;AAEA;;;;CAIC,GACD,SAAS,gBAAgB,IAAY;IACpC,OAAO,KACL,KAAK,CAAC,KACN,GAAG,CAAC,CAAC,IAAM,CAAC,CAAC,EAAE,EACf,IAAI,CAAC,IACL,WAAW,GACX,KAAK,CAAC,GAAG;AACZ;AAEA;;;;CAIC,GACD,SAAS,mBAAmB,IAAY;IACvC,OAAO,KAAK,KAAK,CAAC,IAAI,CAAC,EAAE,IAAI;AAC9B;AAEA;;;;CAIC,GACD,MAAM,sBAAsB,IAAA,qXAAK,EAAC;IACjC,MAAM,OAAO,MAAM,IAAA,oJAAc;IACjC,IAAI,CAAC,MAAM;QACV,OAAO;IACR;IAEA,OAAO,CAAC,CAAC,KAAK,kBAAkB;AACjC;AAaO,MAAM,6BAA6B,IAAA,qXAAK,EAC9C;IAUC,IAAI;QACH,MAAM,OAAO,MAAM,IAAA,oJAAc;QACjC,IAAI,CAAC,MAAM;YACV,OAAO,EAAE;QACV;QAEA,mDAAmD;QACnD,2DAA2D;QAC3D,MAAM,WAAW,MAAM,IAAA,+KAA2B;QAClD,IAAI,CAAC,UAAU;YACd,OAAO,EAAE;QACV;QAEA,+CAA+C;QAC/C,kDAAkD;QAClD,MAAM,EAAE,MAAM,WAAW,EAAE,KAAK,EAAE,GAAG,MAAM,SACzC,IAAI,CAAC,uBACL,MAAM,CACN,CAAC;;;;;;;;;;;MAWA,CAAC,EAEF,EAAE,CAAC,WAAW,KAAK,EAAE,EACrB,EAAE,CAAC,UAAU,UACb,EAAE,CAAC,wBAAwB,OAAO,6BAA6B;QAEjE,IAAI,OAAO;YACV,OAAO,EAAE;QACV;QAEA,qDAAqD;QACrD,oEAAoE;QACpE,MAAM,aAAa,IAAI;QAYvB,aAAa,QAAQ,CAAC;YACrB,MAAM,YAAY,EAAE,SAAS,CAAC,EAAE;YAChC,IAAI,CAAC,WAAW,GAAG,CAAC,YAAY;gBAC/B,MAAM,qBAAqB,EAAE,SAAS,CAAC,0BAA0B;gBACjE,MAAM,qBACL,AAAC,EAAE,SAAS,CAAC,mBAAmB,IAChC;gBACD,MAAM,qBAAqB,IAAA,+JAAoB,EAAC;oBAC/C,UAAU;oBACV,aAAa,EAAE,SAAS,CAAC,uBAAuB,IAAI;gBACrD;gBACA,MAAM,aACL,uBAAuB,YACvB,uBAAuB;gBAExB,IAAI,YAAY;gBAChB,IAAI,CAAC,CAAC,cAAc,kBAAkB,GAAG;oBACxC,YACC,uBAAuB,eACpB,0BACA;gBACL;gBAEA,WAAW,GAAG,CAAC,WAAW;oBACzB,IAAI;oBACJ,MAAM,EAAE,SAAS,CAAC,IAAI;oBACtB,MAAM,EAAE,SAAS,CAAC,IAAI;oBACtB,MAAM;oBACN;oBACA;gBACD;YACD;QACD;QAEA,OAAO,MAAM,IAAI,CAAC,WAAW,MAAM;IACpC,EAAE,OAAO,QAAQ;QAChB,OAAO,EAAE;IACV;AACD;AAUM,MAAM,mBAAmB,IAAA,qXAAK,EAAC;IACrC,IAAI;QACH,MAAM,OAAO,MAAM,IAAA,oJAAc;QACjC,IAAI,CAAC,MAAM;YACV,OAAO;QACR;QAEA,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;QACR;QAEA,sCAAsC;QACtC,MAAM,EAAE,MAAM,UAAU,EAAE,KAAK,EAAE,GAAG,MAAM,SACxC,IAAI,CAAC,uBACL,MAAM,CAAC,cACP,EAAE,CAAC,WAAW,KAAK,EAAE,EACrB,EAAE,CAAC,UAAU,UACb,KAAK,CAAC,GACN,MAAM;QAER,IAAI,OAAO;YACV,OAAO;QACR;QAEA,OAAO,YAAY,cAAc;IAClC,EAAE,OAAO,QAAQ;QAChB,OAAO;IACR;AACD;AAEA;;;;;CAKC,GACD,eAAe,kBACd,OAKE;IAEF,IAAI;QACH,MAAM,OAAO,MAAM,IAAA,oJAAc;QACjC,IAAI,CAAC,MAAM;YACV,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAoB;QACrD;QAEA,MAAM,WAAW,MAAM,IAAA,qJAAY;QACnC,IAAI,CAAC,UAAU;YACd,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAwB;QACzD;QAEA,uCAAuC;QACvC,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACtB,IAAI,CAAC,YACL,MAAM,CAAC;YACP,GAAG,OAAO;YACV,YAAY,IAAI,OAAO,WAAW;QACnC,GACC,EAAE,CAAC,MAAM,KAAK,EAAE;QAElB,IAAI,OAAO;YACV,OAAO;gBAAE,SAAS;gBAAO,OAAO,MAAM,OAAO;YAAC;QAC/C;QAEA,iEAAiE;QACjE,IAAI,QAAQ,SAAS,IAAI,QAAQ,UAAU,EAAE;YAC5C,MAAM,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,UAAU,CAAC;gBAC3D,MAAM;oBACL,MAAM,QAAQ,SAAS;oBACvB,YAAY,QAAQ,UAAU;gBAC/B;YACD;YAEA,IAAI,WAAW;YACd,sDAAsD;YACvD;QACD;QAEA,OAAO;YAAE,SAAS;QAAK;IACxB,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACjD;IACD;AACD"}},
    {"offset": {"line": 7290, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/auth/user-data.ts"],"sourcesContent":["// Re-export from @stratos/auth package for backwards compatibility\nexport * from \"@stratos/auth/user-data\";\n"],"names":[],"mappings":"AAAA,mEAAmE;;AACnE"}},
    {"offset": {"line": 7298, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/layout/app-header-client.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const AppHeaderClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call AppHeaderClient() from the server but AppHeaderClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/layout/app-header-client.tsx <module evaluation>\",\n    \"AppHeaderClient\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,kBAAkB,IAAA,+aAAuB,EAClD;IAAa,MAAM,IAAI,MAAM;AAA8O,GAC3Q,sFACA","ignoreList":[0]}},
    {"offset": {"line": 7312, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/layout/app-header-client.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const AppHeaderClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call AppHeaderClient() from the server but AppHeaderClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/layout/app-header-client.tsx\",\n    \"AppHeaderClient\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,kBAAkB,IAAA,+aAAuB,EAClD;IAAa,MAAM,IAAI,MAAM;AAA8O,GAC3Q,kEACA","ignoreList":[0]}},
    {"offset": {"line": 7326, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 7334, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/layout/app-header.tsx"],"sourcesContent":["import { getPayrixMerchantAccount } from \"@/actions/payrix\";\nimport { getCompanyPhoneNumbers } from \"@/actions/telnyx\";\nimport { getActiveCompanyId, getUserCompanies } from \"@/lib/auth/company-context\";\nimport { getUserProfile } from \"@/lib/auth/user-data\";\nimport { getUnifiedLayoutConfig } from \"@/lib/layout/unified-layout-config\";\nimport { headers } from \"next/headers\";\nimport { AppHeaderClient } from \"./app-header-client\";\n\n/**\n * AppHeader - Server Component\n *\n * Performance optimizations:\n * - Server Component fetches user data BEFORE rendering (eliminates loading flash)\n * - Uses cached getUserProfile() and getUserCompanies() with RLS security\n * - Uses LIGHTWEIGHT getCustomersForDialer() instead of getAllCustomers()\n *   (50-100ms vs 1200-2000ms - eliminates N+1 query pattern)\n * - Fetches company phones for dialer functionality\n * - Passes data to minimal client component for interactivity only\n * - Better SEO and initial page load performance\n *\n * Why Server Component?\n * - Dashboard is always protected (user always logged in via middleware)\n * - No need for client-side loading states or auth checks\n * - Faster initial render with server-fetched data\n * - Smaller JavaScript bundle (auth logic stays on server)\n *\n * Conditional Rendering:\n * - Dashboard layout decides when to render the header (e.g. hides on TV/welcome routes)\n */\n\nexport async function AppHeader() {\n\t// For now, always pass null - the client component will handle sub-header detection\n\tconst subHeaderComponent = null;\n\n\t// Fetch user profile and companies on server (cached with React cache())\n\t// This runs on server BEFORE sending HTML to client\n\t// Handle prerender cookie access gracefully\n\tlet userProfile;\n\tlet companies;\n\tlet activeCompanyId;\n\n\ttry {\n\t\t[userProfile, companies, activeCompanyId] = await Promise.all([\n\t\t\tgetUserProfile(),\n\t\t\tgetUserCompanies(),\n\t\t\tgetActiveCompanyId(),\n\t\t]);\n\t} catch (error) {\n\t\t// During prerendering, cookies() may reject - this is expected\n\t\t// Return null and let the client-side handle it\n\t\tif (error instanceof Error && error.message.includes(\"prerendering\")) {\n\t\t\treturn null;\n\t\t}\n\t\t// Log error for monitoring but don't expose details to user\n\t\tconsole.error(\"AppHeader: Failed to fetch user data\", error);\n\t\tthrow error; // Let error boundary handle it\n\t}\n\n\t// If no user, this should never happen because dashboard is protected by middleware\n\t// But we handle it gracefully anyway\n\tif (!userProfile) {\n\t\treturn null; // Middleware will redirect to login\n\t}\n\n\t// Fetch ONLY company phone numbers on server\n\t// PERFORMANCE: Customer data is lazy-loaded on client when dialer opens\n\t// This saves 400-800ms per page load by not fetching ALL customers upfront\n\tlet companyPhones: any[] = [];\n\tlet hasPhoneNumbers = false;\n\tlet hasPayrixAccount = false;\n\tlet payrixStatus: string | null = null;\n\n\tif (activeCompanyId) {\n\t\ttry {\n\t\t\tconst [phonesResult, payrixResult] = await Promise.all([\n\t\t\t\tgetCompanyPhoneNumbers(activeCompanyId),\n\t\t\t\tgetPayrixMerchantAccount(activeCompanyId),\n\t\t\t]);\n\n\t\t\tif (phonesResult.success && phonesResult.data) {\n\t\t\t\tcompanyPhones = phonesResult.data.map((p) => ({\n\t\t\t\t\tid: p.id,\n\t\t\t\t\tnumber: p.phone_number,\n\t\t\t\t\tlabel: p.formatted_number || p.phone_number,\n\t\t\t\t}));\n\t\t\t\thasPhoneNumbers = phonesResult.data.length > 0;\n\t\t\t}\n\n\t\t\tif (payrixResult.success && payrixResult.data) {\n\t\t\t\thasPayrixAccount = true;\n\t\t\t\tpayrixStatus = payrixResult.data.status;\n\t\t\t}\n\t\t} catch (_error) {\n\t\t\t// Continue without phone/payrix data - component will handle empty array\n\t\t}\n\t}\n\n\t// Pass server-fetched data to client component for interactivity\n\t// Customers will be lazy-loaded on client side when dialer is opened\n\treturn (\n\t\t<AppHeaderClient\n\t\t\tactiveCompanyId={activeCompanyId}\n\t\t\tcompanies={companies}\n\t\t\tcompanyPhones={companyPhones}\n\t\t\tuserProfile={userProfile}\n\t\t\thasPhoneNumbers={hasPhoneNumbers}\n\t\t\thasPayrixAccount={hasPayrixAccount}\n\t\t\tpayrixStatus={payrixStatus}\n\t\t\tsubHeader={subHeaderComponent}\n\t\t/>\n\t);\n}\n"],"names":[],"mappings":";;;;;AAAA;AACA;AACA;AAAA;AACA;AAAA;AAGA;;;;;;;AAwBO,eAAe;IACrB,oFAAoF;IACpF,MAAM,qBAAqB;IAE3B,yEAAyE;IACzE,oDAAoD;IACpD,4CAA4C;IAC5C,IAAI;IACJ,IAAI;IACJ,IAAI;IAEJ,IAAI;QACH,CAAC,aAAa,WAAW,gBAAgB,GAAG,MAAM,QAAQ,GAAG,CAAC;YAC7D,IAAA,yJAAc;YACd,IAAA,iKAAgB;YAChB,IAAA,mKAAkB;SAClB;IACF,EAAE,OAAO,OAAO;QACf,+DAA+D;QAC/D,gDAAgD;QAChD,IAAI,iBAAiB,SAAS,MAAM,OAAO,CAAC,QAAQ,CAAC,iBAAiB;YACrE,OAAO;QACR;QACA,4DAA4D;QAC5D,QAAQ,KAAK,CAAC,wCAAwC;QACtD,MAAM,OAAO,+BAA+B;IAC7C;IAEA,oFAAoF;IACpF,qCAAqC;IACrC,IAAI,CAAC,aAAa;QACjB,OAAO,MAAM,oCAAoC;IAClD;IAEA,6CAA6C;IAC7C,wEAAwE;IACxE,2EAA2E;IAC3E,IAAI,gBAAuB,EAAE;IAC7B,IAAI,kBAAkB;IACtB,IAAI,mBAAmB;IACvB,IAAI,eAA8B;IAElC,IAAI,iBAAiB;QACpB,IAAI;YACH,MAAM,CAAC,cAAc,aAAa,GAAG,MAAM,QAAQ,GAAG,CAAC;gBACtD,IAAA,iKAAsB,EAAC;gBACvB,IAAA,mKAAwB,EAAC;aACzB;YAED,IAAI,aAAa,OAAO,IAAI,aAAa,IAAI,EAAE;gBAC9C,gBAAgB,aAAa,IAAI,CAAC,GAAG,CAAC,CAAC,IAAM,CAAC;wBAC7C,IAAI,EAAE,EAAE;wBACR,QAAQ,EAAE,YAAY;wBACtB,OAAO,EAAE,gBAAgB,IAAI,EAAE,YAAY;oBAC5C,CAAC;gBACD,kBAAkB,aAAa,IAAI,CAAC,MAAM,GAAG;YAC9C;YAEA,IAAI,aAAa,OAAO,IAAI,aAAa,IAAI,EAAE;gBAC9C,mBAAmB;gBACnB,eAAe,aAAa,IAAI,CAAC,MAAM;YACxC;QACD,EAAE,OAAO,QAAQ;QAChB,yEAAyE;QAC1E;IACD;IAEA,iEAAiE;IACjE,qEAAqE;IACrE,qBACC,qZAAC,yLAAe;QACf,iBAAiB;QACjB,WAAW;QACX,eAAe;QACf,aAAa;QACb,iBAAiB;QACjB,kBAAkB;QAClB,cAAc;QACd,WAAW;;;;;;AAGd"}},
    {"offset": {"line": 7432, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/layout/app-header-error-boundary.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const AppHeaderErrorBoundary = registerClientReference(\n    function() { throw new Error(\"Attempted to call AppHeaderErrorBoundary() from the server but AppHeaderErrorBoundary is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/layout/app-header-error-boundary.tsx <module evaluation>\",\n    \"AppHeaderErrorBoundary\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,yBAAyB,IAAA,+aAAuB,EACzD;IAAa,MAAM,IAAI,MAAM;AAA4P,GACzR,8FACA","ignoreList":[0]}},
    {"offset": {"line": 7446, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/layout/app-header-error-boundary.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const AppHeaderErrorBoundary = registerClientReference(\n    function() { throw new Error(\"Attempted to call AppHeaderErrorBoundary() from the server but AppHeaderErrorBoundary is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/layout/app-header-error-boundary.tsx\",\n    \"AppHeaderErrorBoundary\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,yBAAyB,IAAA,+aAAuB,EACzD;IAAa,MAAM,IAAI,MAAM;AAA4P,GACzR,0EACA","ignoreList":[0]}},
    {"offset": {"line": 7460, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 7468, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/auth/session.ts"],"sourcesContent":["// Re-export from @stratos/auth package for backwards compatibility\nexport * from \"@stratos/auth/session\";\n"],"names":[],"mappings":"AAAA,mEAAmE;;AACnE"}},
    {"offset": {"line": 7476, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/layout/dashboard-auth-wrapper.tsx"],"sourcesContent":["import { redirect } from \"next/navigation\";\nimport { getCurrentUser } from \"@/lib/auth/session\";\n\n/**\n * Dashboard Auth Wrapper - Async Server Component\n *\n * Handles authentication checks WITHOUT blocking rendering.\n * This component is wrapped in Suspense with fallback={null} so it doesn't\n * show a loading screen - it just performs auth checks in the background.\n *\n * NOTE: Onboarding redirects temporarily disabled.\n * The welcome/onboarding page is at /dashboard/welcome\n *\n * This component renders nothing - it only performs checks and redirects.\n */\nexport async function DashboardAuthWrapper() {\n\t// Check authentication - redirect to login if not authenticated\n\tconst user = await getCurrentUser();\n\n\tif (!user) {\n\t\tredirect(\"/login?message=Please log in to access the dashboard\");\n\t}\n\n\t// NOTE: Onboarding redirect logic temporarily disabled\n\t// Users can access any dashboard page regardless of onboarding status\n\t// The welcome/onboarding page is available at /dashboard/welcome\n\n\t// This component renders nothing - it only performs auth checks and redirects\n\treturn null;\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;AAAA;;;AAcO,eAAe;IACrB,gEAAgE;IAChE,MAAM,OAAO,MAAM,IAAA,oJAAc;IAEjC,IAAI,CAAC,MAAM;QACV,IAAA,wWAAQ,EAAC;IACV;IAEA,uDAAuD;IACvD,sEAAsE;IACtE,iEAAiE;IAEjE,8EAA8E;IAC9E,OAAO;AACR"}},
    {"offset": {"line": 7502, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/layout/incoming-call-notification-wrapper.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const IncomingCallNotificationWrapper = registerClientReference(\n    function() { throw new Error(\"Attempted to call IncomingCallNotificationWrapper() from the server but IncomingCallNotificationWrapper is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/layout/incoming-call-notification-wrapper.tsx <module evaluation>\",\n    \"IncomingCallNotificationWrapper\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,kCAAkC,IAAA,+aAAuB,EAClE;IAAa,MAAM,IAAI,MAAM;AAA8Q,GAC3S,uGACA","ignoreList":[0]}},
    {"offset": {"line": 7516, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/layout/incoming-call-notification-wrapper.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const IncomingCallNotificationWrapper = registerClientReference(\n    function() { throw new Error(\"Attempted to call IncomingCallNotificationWrapper() from the server but IncomingCallNotificationWrapper is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/layout/incoming-call-notification-wrapper.tsx\",\n    \"IncomingCallNotificationWrapper\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,kCAAkC,IAAA,+aAAuB,EAClE;IAAa,MAAM,IAAI,MAAM;AAA8Q,GAC3S,mFACA","ignoreList":[0]}},
    {"offset": {"line": 7530, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 7538, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/layout/mobile-bottom-tabs-wrapper.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const MobileBottomTabsWrapper = registerClientReference(\n    function() { throw new Error(\"Attempted to call MobileBottomTabsWrapper() from the server but MobileBottomTabsWrapper is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/layout/mobile-bottom-tabs-wrapper.tsx <module evaluation>\",\n    \"MobileBottomTabsWrapper\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,0BAA0B,IAAA,+aAAuB,EAC1D;IAAa,MAAM,IAAI,MAAM;AAA8P,GAC3R,+FACA","ignoreList":[0]}},
    {"offset": {"line": 7552, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/layout/mobile-bottom-tabs-wrapper.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const MobileBottomTabsWrapper = registerClientReference(\n    function() { throw new Error(\"Attempted to call MobileBottomTabsWrapper() from the server but MobileBottomTabsWrapper is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/layout/mobile-bottom-tabs-wrapper.tsx\",\n    \"MobileBottomTabsWrapper\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,0BAA0B,IAAA,+aAAuB,EAC1D;IAAa,MAAM,IAAI,MAAM;AAA8P,GAC3R,2EACA","ignoreList":[0]}},
    {"offset": {"line": 7566, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 7574, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/layout/notifications-initializer.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const NotificationsInitializer = registerClientReference(\n    function() { throw new Error(\"Attempted to call NotificationsInitializer() from the server but NotificationsInitializer is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/layout/notifications-initializer.tsx <module evaluation>\",\n    \"NotificationsInitializer\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,2BAA2B,IAAA,+aAAuB,EAC3D;IAAa,MAAM,IAAI,MAAM;AAAgQ,GAC7R,8FACA","ignoreList":[0]}},
    {"offset": {"line": 7588, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/layout/notifications-initializer.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const NotificationsInitializer = registerClientReference(\n    function() { throw new Error(\"Attempted to call NotificationsInitializer() from the server but NotificationsInitializer is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/layout/notifications-initializer.tsx\",\n    \"NotificationsInitializer\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,2BAA2B,IAAA,+aAAuB,EAC3D;IAAa,MAAM,IAAI,MAAM;AAAgQ,GAC7R,0EACA","ignoreList":[0]}},
    {"offset": {"line": 7602, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 7610, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/support/support-session-provider.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const SupportSessionProvider = registerClientReference(\n    function() { throw new Error(\"Attempted to call SupportSessionProvider() from the server but SupportSessionProvider is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/support/support-session-provider.tsx <module evaluation>\",\n    \"SupportSessionProvider\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,yBAAyB,IAAA,+aAAuB,EACzD;IAAa,MAAM,IAAI,MAAM;AAA4P,GACzR,8FACA","ignoreList":[0]}},
    {"offset": {"line": 7624, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/components/support/support-session-provider.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const SupportSessionProvider = registerClientReference(\n    function() { throw new Error(\"Attempted to call SupportSessionProvider() from the server but SupportSessionProvider is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/support/support-session-provider.tsx\",\n    \"SupportSessionProvider\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,yBAAyB,IAAA,+aAAuB,EACzD;IAAa,MAAM,IAAI,MAAM;AAA4P,GACzR,0EACA","ignoreList":[0]}},
    {"offset": {"line": 7638, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 7646, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/app/%28dashboard%29/layout.tsx"],"sourcesContent":["import { Suspense } from \"react\";\nimport { AppHeader } from \"@/components/layout/app-header\";\nimport { AppHeaderErrorBoundary } from \"@/components/layout/app-header-error-boundary\";\nimport { DashboardAuthWrapper } from \"@/components/layout/dashboard-auth-wrapper\";\nimport { IncomingCallNotificationWrapper } from \"@/components/layout/incoming-call-notification-wrapper\";\nimport { MobileBottomTabsWrapper } from \"@/components/layout/mobile-bottom-tabs-wrapper\";\nimport { NotificationsInitializer } from \"@/components/layout/notifications-initializer\";\nimport { SupportSessionProvider } from \"@/components/support/support-session-provider\";\n\n/**\n * Dashboard Layout - Server Component with PPR\n *\n * Uses Partial Prerendering (PPR) to optimize performance:\n * - Static shell (header) renders instantly (5-20ms)\n * - Auth checks happen in the background (non-blocking)\n * - Content streams in progressively\n *\n * The AppHeader is rendered immediately (static).\n * Auth checks happen via DashboardAuthWrapper but don't block rendering.\n *\n * Performance: Instant header, progressive content loading\n */\nexport default function DashboardLayout({\n\tchildren,\n}: Readonly<{\n\tchildren: React.ReactNode;\n}>) {\n\treturn (\n\t\t<div data-dashboard-layout className=\"flex h-full flex-col overflow-hidden\">\n\t\t\t{/* Header with company context - wrapped in error boundary and Suspense for PPR */}\n\t\t\t<AppHeaderErrorBoundary>\n\t\t\t\t<Suspense fallback={<HeaderSkeleton />}>\n\t\t\t\t\t<AppHeader />\n\t\t\t\t</Suspense>\n\t\t\t</AppHeaderErrorBoundary>\n\n\t\t\t{/* Desktop + toast notifications bootstrap */}\n\t\t\t<NotificationsInitializer />\n\n\t\t\t{/* Incoming call notifications */}\n\t\t\t<IncomingCallNotificationWrapper />\n\n\t\t\t{/* Auth wrapper handles redirects but doesn't block rendering */}\n\t\t\t<Suspense fallback={null}>\n\t\t\t\t<DashboardAuthWrapper />\n\t\t\t</Suspense>\n\n\t\t\t{/* Page content - each page has its own Suspense boundaries */}\n\t\t\t{/* Support session provider polls for pending/active sessions and displays approval modal + banner */}\n\t\t\t<SupportSessionProvider>\n\t\t\t\t<main id=\"main-content\" className=\"flex-1 flex flex-col overflow-y-auto pb-16 lg:pb-0\">\n\t\t\t\t\t{children}\n\t\t\t\t</main>\n\t\t\t</SupportSessionProvider>\n\n\t\t\t{/* Mobile Bottom Tab Bar - Native iOS/Android style navigation */}\n\t\t\t<MobileBottomTabsWrapper />\n\t\t</div>\n\t);\n}\n\n// Header skeleton - renders instantly while header loads\nfunction HeaderSkeleton() {\n\treturn (\n\t\t<header className=\"border-border/40 bg-background/95 supports-[backdrop-filter]:bg-background/60 sticky top-0 z-50 w-full border-b backdrop-blur\">\n\t\t\t<div className=\"flex h-14 items-center px-4\">\n\t\t\t\t<div className=\"flex flex-1 items-center gap-4\">\n\t\t\t\t\t{/* Logo skeleton */}\n\t\t\t\t\t<div className=\"bg-muted h-8 w-32 animate-pulse rounded\" />\n\n\t\t\t\t\t{/* Nav skeleton */}\n\t\t\t\t\t<div className=\"hidden md:flex md:gap-2\">\n\t\t\t\t\t\t<div className=\"bg-muted h-8 w-20 animate-pulse rounded\" />\n\t\t\t\t\t\t<div className=\"bg-muted h-8 w-20 animate-pulse rounded\" />\n\t\t\t\t\t\t<div className=\"bg-muted h-8 w-20 animate-pulse rounded\" />\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Right side skeleton */}\n\t\t\t\t<div className=\"flex items-center gap-2\">\n\t\t\t\t\t<div className=\"bg-muted size-8 animate-pulse rounded-full\" />\n\t\t\t\t\t<div className=\"bg-muted size-8 animate-pulse rounded-full\" />\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</header>\n\t);\n}\n"],"names":[],"mappings":";;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;AAee,SAAS,gBAAgB,EACvC,QAAQ,EAGP;IACD,qBACC,qZAAC;QAAI,uBAAqB;QAAC,WAAU;;0BAEpC,qZAAC,2MAAsB;0BACtB,cAAA,qZAAC,wXAAQ;oBAAC,wBAAU,qZAAC;;;;;8BACpB,cAAA,qZAAC,yKAAS;;;;;;;;;;;;;;;0BAKZ,qZAAC,uMAAwB;;;;;0BAGzB,qZAAC,6NAA+B;;;;;0BAGhC,qZAAC,wXAAQ;gBAAC,UAAU;0BACnB,cAAA,qZAAC,mMAAoB;;;;;;;;;;0BAKtB,qZAAC,wMAAsB;0BACtB,cAAA,qZAAC;oBAAK,IAAG;oBAAe,WAAU;8BAChC;;;;;;;;;;;0BAKH,qZAAC,6MAAuB;;;;;;;;;;;AAG3B;AAEA,yDAAyD;AACzD,SAAS;IACR,qBACC,qZAAC;QAAO,WAAU;kBACjB,cAAA,qZAAC;YAAI,WAAU;;8BACd,qZAAC;oBAAI,WAAU;;sCAEd,qZAAC;4BAAI,WAAU;;;;;;sCAGf,qZAAC;4BAAI,WAAU;;8CACd,qZAAC;oCAAI,WAAU;;;;;;8CACf,qZAAC;oCAAI,WAAU;;;;;;8CACf,qZAAC;oCAAI,WAAU;;;;;;;;;;;;;;;;;;8BAKjB,qZAAC;oBAAI,WAAU;;sCACd,qZAAC;4BAAI,WAAU;;;;;;sCACf,qZAAC;4BAAI,WAAU;;;;;;;;;;;;;;;;;;;;;;;AAKpB"}}]
}