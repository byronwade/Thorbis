{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/services/traffic-service.ts"],"sourcesContent":["/**\n * Traffic Service\n *\n * Fetches real-time traffic incidents using Google Maps APIs\n * Includes: crashes, construction, road closures, police activity\n */\n\nimport { z } from \"zod\";\n\n// ============================================================================\n// Types and Schemas\n// ============================================================================\n\nconst TrafficIncidentSchema = z.object({\n\ttype: z.enum([\n\t\t\"crash\",\n\t\t\"construction\",\n\t\t\"road_closed\",\n\t\t\"police\",\n\t\t\"congestion\",\n\t\t\"other\",\n\t]),\n\tseverity: z.enum([\"minor\", \"moderate\", \"major\"]),\n\tdescription: z.string(),\n\tlocation: z.object({\n\t\tlat: z.number(),\n\t\tlon: z.number(),\n\t\taddress: z.string().optional(),\n\t}),\n\tdistance: z.number(), // Distance from job location in miles\n\taffectsRoute: z.boolean(), // Whether this affects the route to the job\n\tstartTime: z.string().optional(), // ISO timestamp\n\tendTime: z.string().optional(), // ISO timestamp (for construction)\n\tenrichedAt: z.string(), // ISO timestamp\n});\n\nconst TrafficDataSchema = z.object({\n\tincidents: z.array(TrafficIncidentSchema),\n\ttotalIncidents: z.number(),\n\tnearbyIncidents: z.number(), // Within 5 miles\n\trouteAffectingIncidents: z.number(),\n\tdataSource: z.string(),\n\tenrichedAt: z.string(),\n});\n\nexport type TrafficIncident = z.infer<typeof TrafficIncidentSchema>;\nexport type TrafficData = z.infer<typeof TrafficDataSchema>;\n\n// ============================================================================\n// Traffic Service\n// ============================================================================\n\nclass TrafficService {\n\t/**\n\t * Get traffic incidents near a location\n\t */\n\tasync getTrafficIncidents(\n\t\tlat: number,\n\t\tlon: number,\n\t\tshopLat?: number,\n\t\tshopLon?: number,\n\t): Promise<TrafficData | null> {\n\t\ttry {\n\t\t\t// For now, we'll use Google Maps Directions API with traffic model\n\t\t\t// to detect incidents along the route\n\t\t\tconst apiKey =\n\t\t\t\tprocess.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY ||\n\t\t\t\tprocess.env.NEXT_PUBLIC_GOOGLE_PLACES_API_KEY;\n\n\t\t\tif (!apiKey) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst incidents: TrafficIncident[] = [];\n\n\t\t\t// If we have shop coordinates, check for incidents on the route\n\t\t\tif (shopLat && shopLon) {\n\t\t\t\tconst routeIncidents = await this.getRouteIncidents(\n\t\t\t\t\tshopLat,\n\t\t\t\t\tshopLon,\n\t\t\t\t\tlat,\n\t\t\t\t\tlon,\n\t\t\t\t\tapiKey,\n\t\t\t\t);\n\t\t\t\tincidents.push(...routeIncidents);\n\t\t\t}\n\n\t\t\t// Get nearby incidents using Google Maps Places API\n\t\t\tconst nearbyIncidents = await this.getNearbyIncidents(lat, lon, apiKey);\n\t\t\tincidents.push(...nearbyIncidents);\n\n\t\t\tconst nearbyCount = incidents.filter((i) => i.distance <= 5).length;\n\t\t\tconst routeAffectingCount = incidents.filter(\n\t\t\t\t(i) => i.affectsRoute,\n\t\t\t).length;\n\n\t\t\tconst trafficData: TrafficData = {\n\t\t\t\tincidents,\n\t\t\t\ttotalIncidents: incidents.length,\n\t\t\t\tnearbyIncidents: nearbyCount,\n\t\t\t\trouteAffectingIncidents: routeAffectingCount,\n\t\t\t\tdataSource: \"google-maps\",\n\t\t\t\tenrichedAt: new Date().toISOString(),\n\t\t\t};\n\n\t\t\treturn TrafficDataSchema.parse(trafficData);\n\t\t} catch (_error) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Get incidents along the route from shop to job\n\t */\n\tprivate async getRouteIncidents(\n\t\toriginLat: number,\n\t\toriginLon: number,\n\t\tdestLat: number,\n\t\tdestLon: number,\n\t\tapiKey: string,\n\t): Promise<TrafficIncident[]> {\n\t\ttry {\n\t\t\tconst url = new URL(\n\t\t\t\t\"https://maps.googleapis.com/maps/api/directions/json\",\n\t\t\t);\n\t\t\turl.searchParams.set(\"origin\", `${originLat},${originLon}`);\n\t\t\turl.searchParams.set(\"destination\", `${destLat},${destLon}`);\n\t\t\turl.searchParams.set(\"departure_time\", \"now\");\n\t\t\turl.searchParams.set(\"traffic_model\", \"best_guess\");\n\t\t\turl.searchParams.set(\"key\", apiKey);\n\n\t\t\tconst response = await fetch(url.toString());\n\t\t\tif (!response.ok) {\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\tconst data = await response.json();\n\n\t\t\tif (data.status !== \"OK\" || !data.routes?.[0]) {\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\tconst route = data.routes[0];\n\t\t\tconst incidents: TrafficIncident[] = [];\n\n\t\t\t// Check for warnings (construction, closures, etc.)\n\t\t\tif (route.warnings) {\n\t\t\t\tfor (const warning of route.warnings) {\n\t\t\t\t\tincidents.push({\n\t\t\t\t\t\ttype: this.categorizeWarning(warning),\n\t\t\t\t\t\tseverity: \"moderate\",\n\t\t\t\t\t\tdescription: warning,\n\t\t\t\t\t\tlocation: {\n\t\t\t\t\t\t\tlat: destLat,\n\t\t\t\t\t\t\tlon: destLon,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdistance: 0, // On route\n\t\t\t\t\t\taffectsRoute: true,\n\t\t\t\t\t\tenrichedAt: new Date().toISOString(),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Analyze traffic conditions\n\t\t\tconst leg = route.legs[0];\n\t\t\tif (leg.duration_in_traffic && leg.duration) {\n\t\t\t\tconst trafficDelay = leg.duration_in_traffic.value - leg.duration.value;\n\t\t\t\tconst delayMinutes = Math.floor(trafficDelay / 60);\n\n\t\t\t\tif (delayMinutes > 10) {\n\t\t\t\t\tincidents.push({\n\t\t\t\t\t\ttype: \"congestion\",\n\t\t\t\t\t\tseverity: delayMinutes > 30 ? \"major\" : \"moderate\",\n\t\t\t\t\t\tdescription: `Heavy traffic causing ${delayMinutes} minute delay`,\n\t\t\t\t\t\tlocation: {\n\t\t\t\t\t\t\tlat: destLat,\n\t\t\t\t\t\t\tlon: destLon,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdistance: 0,\n\t\t\t\t\t\taffectsRoute: true,\n\t\t\t\t\t\tenrichedAt: new Date().toISOString(),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn incidents;\n\t\t} catch (_error) {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\t/**\n\t * Search for incidents using Google Places API\n\t */\n\tprivate async getNearbyIncidents(\n\t\t_lat: number,\n\t\t_lon: number,\n\t\t_apiKey: string,\n\t): Promise<TrafficIncident[]> {\n\t\t// Note: Google Places API doesn't directly provide traffic incidents\n\t\t// In production, you'd want to use a dedicated traffic API like:\n\t\t// - TomTom Traffic API\n\t\t// - HERE Traffic API\n\t\t// - Waze Traffic API\n\t\t// For now, we'll return empty array\n\t\treturn [];\n\t}\n\n\t/**\n\t * Categorize a warning string into incident type\n\t */\n\tprivate categorizeWarning(warning: string): TrafficIncident[\"type\"] {\n\t\tconst lower = warning.toLowerCase();\n\t\tif (lower.includes(\"construction\") || lower.includes(\"work\")) {\n\t\t\treturn \"construction\";\n\t\t}\n\t\tif (lower.includes(\"closed\") || lower.includes(\"closure\")) {\n\t\t\treturn \"road_closed\";\n\t\t}\n\t\tif (lower.includes(\"accident\") || lower.includes(\"crash\")) {\n\t\t\treturn \"crash\";\n\t\t}\n\t\treturn \"other\";\n\t}\n}\n\nexport const trafficService = new TrafficService();\n"],"names":[],"mappings":"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"}}]
}