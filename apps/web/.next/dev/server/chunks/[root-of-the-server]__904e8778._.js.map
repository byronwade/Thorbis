{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/proxy.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\";\nimport { type NextRequest, NextResponse } from \"next/server\";\n\n/**\n * Next.js 16+ Proxy - Auth & Route Protection\n *\n * SECURITY CRITICAL:\n * - Uses proxy.ts (NOT middleware.ts) per Next.js 16+ security best practices\n * - Fixes CVE where x-middleware-subrequest header could bypass auth checks\n * - NEVER rely solely on proxy for authorization\n * - ALWAYS validate auth in Server Actions and API routes\n * - Use RLS (Row Level Security) in Supabase\n *\n * DOMAIN SEPARATION:\n * - Thorbis employees (@thorbis.com, @stratos.com) -> BLOCKED from contractor dashboard\n * - Contractors (all other domains) -> BLOCKED from admin dashboard\n *\n * SESSION ISOLATION:\n * - This app uses default Supabase cookie names\n * - Admin app uses prefixed cookies (admin_*) to isolate its sessions\n * - This ensures admin and contractor sessions don't conflict\n *\n * Performance:\n * - Runs on Node.js runtime (not Edge)\n * - Lightweight session refresh only\n * - Minimal overhead on protected routes\n */\n\n// Admin-only domains - these users CANNOT access the contractor dashboard\nconst ADMIN_ONLY_DOMAINS = [\"thorbis.com\", \"stratos.com\"];\n\nfunction isAdminDomain(email: string | undefined | null): boolean {\n\tif (!email) return false;\n\tconst domain = email.split(\"@\")[1]?.toLowerCase();\n\treturn ADMIN_ONLY_DOMAINS.includes(domain || \"\");\n}\n\nexport async function proxy(request: NextRequest) {\n\tif (process.env.NODE_ENV !== \"production\") {\n\t\t// TODO: Handle error case\n\t}\n\t// Add pathname header for server-side layout detection\n\tconst requestHeaders = new Headers(request.headers);\n\trequestHeaders.set(\"x-dashboard-pathname\", request.nextUrl.pathname);\n\n\tlet response = NextResponse.next({\n\t\trequest: {\n\t\t\theaders: requestHeaders,\n\t\t},\n\t});\n\n\tconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n\tconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n\t// If Supabase is not configured, allow request to continue\n\tif (!(supabaseUrl && supabaseAnonKey)) {\n\t\treturn response;\n\t}\n\n\tconst supabase = createServerClient(supabaseUrl, supabaseAnonKey, {\n\t\tcookies: {\n\t\t\tget(name: string) {\n\t\t\t\treturn request.cookies.get(name)?.value;\n\t\t\t},\n\t\t\tset(name: string, value: string, options) {\n\t\t\t\trequest.cookies.set({\n\t\t\t\t\tname,\n\t\t\t\t\tvalue,\n\t\t\t\t\t...options,\n\t\t\t\t});\n\t\t\t\tresponse = NextResponse.next({\n\t\t\t\t\trequest: {\n\t\t\t\t\t\theaders: requestHeaders,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t\tresponse.cookies.set({\n\t\t\t\t\tname,\n\t\t\t\t\tvalue,\n\t\t\t\t\t...options,\n\t\t\t\t});\n\t\t\t},\n\t\t\tremove(name: string, options) {\n\t\t\t\trequest.cookies.set({\n\t\t\t\t\tname,\n\t\t\t\t\tvalue: \"\",\n\t\t\t\t\t...options,\n\t\t\t\t});\n\t\t\t\tresponse = NextResponse.next({\n\t\t\t\t\trequest: {\n\t\t\t\t\t\theaders: requestHeaders,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t\tresponse.cookies.set({\n\t\t\t\t\tname,\n\t\t\t\t\tvalue: \"\",\n\t\t\t\t\t...options,\n\t\t\t\t});\n\t\t\t},\n\t\t},\n\t});\n\n\t// Refresh session if expired - this is important for long-running sessions\n\t// This also validates the session token is still valid\n\tconst {\n\t\tdata: { session },\n\t} = await supabase.auth.getSession();\n\n\t// Protected routes that require authentication\n\tconst protectedPaths = [\"/dashboard\"];\n\tconst isProtectedPath = protectedPaths.some((path) =>\n\t\trequest.nextUrl.pathname.startsWith(path),\n\t);\n\n\t// Auth pages that should redirect to dashboard if already logged in\n\tconst authPaths = [\"/login\", \"/signup\", \"/auth\"];\n\tconst isAuthPath = authPaths.some((path) =>\n\t\trequest.nextUrl.pathname.startsWith(path),\n\t);\n\n\t// Redirect unauthenticated users from protected paths to login\n\tif (isProtectedPath && !session) {\n\t\tconst redirectUrl = request.nextUrl.clone();\n\t\tredirectUrl.pathname = \"/login\";\n\t\tredirectUrl.searchParams.set(\"redirectTo\", request.nextUrl.pathname);\n\t\treturn NextResponse.redirect(redirectUrl);\n\t}\n\n\t// SECURITY: Block Thorbis employees from contractor dashboard\n\t// They must use the admin dashboard instead\n\tif (isProtectedPath && session) {\n\t\tconst userEmail = session.user?.email;\n\t\tif (isAdminDomain(userEmail)) {\n\t\t\t// Sign out the user from this app and redirect to admin\n\t\t\tawait supabase.auth.signOut();\n\t\t\tconst adminUrl =\n\t\t\t\tprocess.env.NEXT_PUBLIC_ADMIN_URL || \"http://localhost:3001\";\n\t\t\treturn NextResponse.redirect(new URL(\"/login?error=use_admin\", adminUrl));\n\t\t}\n\t}\n\n\t// Redirect authenticated users from auth pages to dashboard\n\tif (isAuthPath && session) {\n\t\tconst userEmail = session.user?.email;\n\n\t\t// If admin domain user tries to login here, redirect to admin app\n\t\tif (isAdminDomain(userEmail)) {\n\t\t\tawait supabase.auth.signOut();\n\t\t\tconst adminUrl =\n\t\t\t\tprocess.env.NEXT_PUBLIC_ADMIN_URL || \"http://localhost:3001\";\n\t\t\treturn NextResponse.redirect(new URL(\"/login?error=use_admin\", adminUrl));\n\t\t}\n\n\t\t// Check if there's a redirectTo parameter\n\t\tconst redirectTo = request.nextUrl.searchParams.get(\"redirectTo\");\n\t\tconst redirectUrl = request.nextUrl.clone();\n\t\tredirectUrl.pathname = redirectTo || \"/dashboard\";\n\t\tredirectUrl.search = \"\"; // Clear query params\n\t\treturn NextResponse.redirect(redirectUrl);\n\t}\n\n\treturn response;\n}\n\nexport const config = {\n\tmatcher: [\n\t\t/*\n\t\t * Match all request paths except for the ones starting with:\n\t\t * - _next/static (static files)\n\t\t * - _next/image (image optimization files)\n\t\t * - favicon.ico (favicon file)\n\t\t * - public folder\n\t\t * - API routes that handle their own auth\n\t\t */\n\t\t\"/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)\",\n\t],\n};\n\nexport default proxy;\n"],"names":[],"mappings":"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"}}]
}