{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/database/src/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\";\nimport { cache } from \"react\";\n\n/**\n * Create a Supabase client for use in Server Components\n * This is useful for Supabase Auth, Storage, Realtime, etc.\n *\n * PERFORMANCE: Wrapped with React.cache() to prevent recreating\n * the client on every component render. This dramatically improves\n * performance by reusing the same client instance across the request.\n *\n * SESSION ISOLATION: This client uses default Supabase cookie names.\n * The admin app uses prefixed cookies (admin_*) to isolate its sessions.\n * This ensures admin and contractor sessions don't conflict.\n */\nexport const createClient = cache(async () => {\n\tconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n\tconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n\tif (!(supabaseUrl && supabaseAnonKey)) {\n\t\treturn null;\n\t}\n\n\t// Dynamic import of next/headers to prevent bundling in client components\n\tconst { cookies, headers } = await import(\"next/headers\");\n\n\tlet cookieStore;\n\n\t// Check if we're in a prerendering context by looking at headers\n\tlet headersStore;\n\ttry {\n\t\theadersStore = await headers();\n\t\t// If we can get headers and there's no x-prerender header, we might be safe\n\t\tif (headersStore.get('x-prerender')) {\n\t\t\treturn null;\n\t\t}\n\t} catch {\n\t\t// If headers() fails, we're likely in prerendering\n\t\treturn null;\n\t}\n\n\ttry {\n\t\tcookieStore = await cookies();\n\t} catch (error) {\n\t\t// During prerendering, cookies() may reject - return null\n\t\t// This allows PPR to work correctly\n\t\tif (error instanceof Error && (\n\t\t\terror.message.includes(\"During prerendering\") ||\n\t\t\terror.message.includes(\"prerendering\") ||\n\t\t\terror.message.includes(\"cookies()\")\n\t\t)) {\n\t\t\treturn null;\n\t\t}\n\t\t// For other errors, rethrow\n\t\tthrow error;\n\t}\n\n\treturn createServerClient(supabaseUrl, supabaseAnonKey, {\n\t\tcookies: {\n\t\t\tget(name: string) {\n\t\t\t\treturn cookieStore.get(name)?.value;\n\t\t\t},\n\t\t\tset(name: string, value: string, options) {\n\t\t\t\ttry {\n\t\t\t\t\tcookieStore.set(name, value, options);\n\t\t\t\t} catch {\n\t\t\t\t\t// The `set` method was called from a Server Component.\n\t\t\t\t\t// This can be ignored if you have middleware refreshing\n\t\t\t\t\t// user sessions.\n\t\t\t\t}\n\t\t\t},\n\t\t\tremove(name: string, _options) {\n\t\t\t\ttry {\n\t\t\t\t\tcookieStore.delete(name);\n\t\t\t\t} catch {\n\t\t\t\t\t// The `delete` method was called from a Server Component.\n\t\t\t\t\t// This can be ignored if you have middleware refreshing\n\t\t\t\t\t// user sessions.\n\t\t\t\t}\n\t\t\t},\n\t\t},\n\t});\n});\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAcO,MAAM,eAAe,IAAA,uXAAK,EAAC;IACjC,MAAM;IACN,MAAM;IAEN;;IAIA,0EAA0E;IAC1E,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,GAAG;IAE7B,IAAI;IAEJ,iEAAiE;IACjE,IAAI;IACJ,IAAI;QACH,eAAe,MAAM;QACrB,4EAA4E;QAC5E,IAAI,aAAa,GAAG,CAAC,gBAAgB;YACpC,OAAO;QACR;IACD,EAAE,OAAM;QACP,mDAAmD;QACnD,OAAO;IACR;IAEA,IAAI;QACH,cAAc,MAAM;IACrB,EAAE,OAAO,OAAO;QACf,0DAA0D;QAC1D,oCAAoC;QACpC,IAAI,iBAAiB,SAAS,CAC7B,MAAM,OAAO,CAAC,QAAQ,CAAC,0BACvB,MAAM,OAAO,CAAC,QAAQ,CAAC,mBACvB,MAAM,OAAO,CAAC,QAAQ,CAAC,YACxB,GAAG;YACF,OAAO;QACR;QACA,4BAA4B;QAC5B,MAAM;IACP;IAEA,OAAO,IAAA,8SAAkB,EAAC,aAAa,iBAAiB;QACvD,SAAS;YACR,KAAI,IAAY;gBACf,OAAO,YAAY,GAAG,CAAC,OAAO;YAC/B;YACA,KAAI,IAAY,EAAE,KAAa,EAAE,OAAO;gBACvC,IAAI;oBACH,YAAY,GAAG,CAAC,MAAM,OAAO;gBAC9B,EAAE,OAAM;gBACP,uDAAuD;gBACvD,wDAAwD;gBACxD,iBAAiB;gBAClB;YACD;YACA,QAAO,IAAY,EAAE,QAAQ;gBAC5B,IAAI;oBACH,YAAY,MAAM,CAAC;gBACpB,EAAE,OAAM;gBACP,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBAClB;YACD;QACD;IACD;AACD"}},
    {"offset": {"line": 110, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/database/src/service-client.ts"],"sourcesContent":["\"use server\";\n\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\";\nimport type { Database } from \"./types\";\n\n/**\n * Creates a Supabase client using the service role key.\n * This bypasses RLS and is intended for background jobs / automation.\n *\n * Performance Optimization:\n * - Uses SUPABASE_POOLER_URL (Transaction Mode) if available for 30-50% faster queries\n * - Falls back to NEXT_PUBLIC_SUPABASE_URL (Session Mode) if pooler not configured\n * - Transaction Mode supports 10,000+ concurrent connections vs 100 in Session Mode\n *\n * @returns Supabase client with service role, or null if not configured\n */\nexport async function createServiceSupabaseClient() {\n\t// Prefer pooler URL for Transaction Mode (better performance)\n\tconst supabaseUrl =\n\t\tprocess.env.SUPABASE_POOLER_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n\tconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n\tif (!supabaseUrl || !serviceRoleKey) {\n\t\treturn null;\n\t}\n\n\treturn createSupabaseClient<Database>(supabaseUrl, serviceRoleKey, {\n\t\tauth: {\n\t\t\tpersistSession: false,\n\t\t\tautoRefreshToken: false,\n\t\t},\n\t\tdb: {\n\t\t\tschema: \"public\",\n\t\t},\n\t\tglobal: {\n\t\t\theaders: {\n\t\t\t\t\"x-my-custom-header\": \"service-role\",\n\t\t\t},\n\t\t},\n\t});\n}\n\nexport type ServiceSupabaseClient = Awaited<\n\tReturnType<typeof createServiceSupabaseClient>\n>;\n"],"names":[],"mappings":";;;;;AAEA;;;;AAcO,eAAe;IACrB,8DAA8D;IAC9D,MAAM,cACL,QAAQ,GAAG,CAAC,mBAAmB;IAChC,MAAM,iBAAiB,QAAQ,GAAG,CAAC,yBAAyB;IAE5D,IAAI,CAAC,eAAe,CAAC,gBAAgB;QACpC,OAAO;IACR;IAEA,OAAO,IAAA,mRAAoB,EAAW,aAAa,gBAAgB;QAClE,MAAM;YACL,gBAAgB;YAChB,kBAAkB;QACnB;QACA,IAAI;YACH,QAAQ;QACT;QACA,QAAQ;YACP,SAAS;gBACR,sBAAsB;YACvB;QACD;IACD;AACD;;;IAxBsB;;AAAA,wZAAA"}},
    {"offset": {"line": 150, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/shared/src/onboarding.ts"],"sourcesContent":["/**\n * Utilities for determining onboarding completion across server components\n * and API routes. Keeps the logic centralized so we can evolve the rules\n * (e.g. adding new steps) without hunting down scattered checks.\n */\n\ntype ProgressRecord = Record<string, unknown> | null | undefined;\n\n// Must match STEPS_ORDER from onboarding-store.ts\nconst REQUIRED_STEPS = [\"welcome\", \"company\"] as const;\nconst FINAL_STEP = \"complete\" as const;\n\n/**\n * Determine whether onboarding is complete based on stored progress metadata.\n *\n * Completion criteria (in priority order):\n * 1. `completedAt` timestamp exists (set by completeOnboardingWizard action)\n * 2. `onboardingCompleted` flag is true in progress data\n * 3. \"complete\" step exists in completedSteps array\n *\n * Note: We intentionally check multiple signals for backward compatibility\n * with older onboarding records that may have different data structures.\n */\nexport function isOnboardingComplete(options: {\n\tprogress?: ProgressRecord;\n\tcompletedAt?: string | null;\n}): boolean {\n\tconst { progress, completedAt } = options;\n\n\t// Primary check: completedAt timestamp from database\n\tif (completedAt) {\n\t\treturn true;\n\t}\n\n\tif (!progress || typeof progress !== \"object\") {\n\t\treturn false;\n\t}\n\n\tconst progressRecord = progress as Record<string, unknown>;\n\n\t// Check onboardingCompleted flag\n\tif (progressRecord.onboardingCompleted === true) {\n\t\treturn true;\n\t}\n\n\t// Check if completedSteps array includes the final step\n\tconst completedSteps = progressRecord.completedSteps;\n\tif (Array.isArray(completedSteps) && completedSteps.includes(FINAL_STEP)) {\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n/**\n * Get onboarding progress percentage based on completed steps.\n */\nexport function getOnboardingProgress(options: {\n\tprogress?: ProgressRecord;\n}): number {\n\tconst { progress } = options;\n\n\tif (!progress || typeof progress !== \"object\") {\n\t\treturn 0;\n\t}\n\n\tconst progressRecord = progress as Record<string, unknown>;\n\tconst completedSteps = progressRecord.completedSteps;\n\tconst skippedSteps = progressRecord.skippedSteps;\n\n\tif (!Array.isArray(completedSteps)) {\n\t\treturn 0;\n\t}\n\n\tconst totalSteps = 14; // Total steps in onboarding\n\tconst finishedCount = completedSteps.length + (Array.isArray(skippedSteps) ? skippedSteps.length : 0);\n\n\treturn Math.round((finishedCount / totalSteps) * 100);\n}\n\n/**\n * Check if required steps are completed.\n * Returns which required steps are missing if any.\n */\nexport function getMissingRequiredSteps(options: {\n\tprogress?: ProgressRecord;\n}): string[] {\n\tconst { progress } = options;\n\n\tif (!progress || typeof progress !== \"object\") {\n\t\treturn [...REQUIRED_STEPS];\n\t}\n\n\tconst progressRecord = progress as Record<string, unknown>;\n\tconst completedSteps = progressRecord.completedSteps;\n\n\tif (!Array.isArray(completedSteps)) {\n\t\treturn [...REQUIRED_STEPS];\n\t}\n\n\treturn REQUIRED_STEPS.filter((step) => !completedSteps.includes(step));\n}\n\n/**\n * Get the current onboarding step from progress data.\n */\nexport function getCurrentOnboardingStep(options: {\n\tprogress?: ProgressRecord;\n}): string {\n\tconst { progress } = options;\n\n\tif (!progress || typeof progress !== \"object\") {\n\t\treturn \"welcome\";\n\t}\n\n\tconst progressRecord = progress as Record<string, unknown>;\n\tconst currentStep = progressRecord.currentStep;\n\n\tif (typeof currentStep === \"string\" && currentStep.length > 0) {\n\t\treturn currentStep;\n\t}\n\n\treturn \"welcome\";\n}\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;;;;;;;AAID,kDAAkD;AAClD,MAAM,iBAAiB;IAAC;IAAW;CAAU;AAC7C,MAAM,aAAa;AAaZ,SAAS,qBAAqB,OAGpC;IACA,MAAM,EAAE,QAAQ,EAAE,WAAW,EAAE,GAAG;IAElC,qDAAqD;IACrD,IAAI,aAAa;QAChB,OAAO;IACR;IAEA,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC9C,OAAO;IACR;IAEA,MAAM,iBAAiB;IAEvB,iCAAiC;IACjC,IAAI,eAAe,mBAAmB,KAAK,MAAM;QAChD,OAAO;IACR;IAEA,wDAAwD;IACxD,MAAM,iBAAiB,eAAe,cAAc;IACpD,IAAI,MAAM,OAAO,CAAC,mBAAmB,eAAe,QAAQ,CAAC,aAAa;QACzE,OAAO;IACR;IAEA,OAAO;AACR;AAKO,SAAS,sBAAsB,OAErC;IACA,MAAM,EAAE,QAAQ,EAAE,GAAG;IAErB,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC9C,OAAO;IACR;IAEA,MAAM,iBAAiB;IACvB,MAAM,iBAAiB,eAAe,cAAc;IACpD,MAAM,eAAe,eAAe,YAAY;IAEhD,IAAI,CAAC,MAAM,OAAO,CAAC,iBAAiB;QACnC,OAAO;IACR;IAEA,MAAM,aAAa,IAAI,4BAA4B;IACnD,MAAM,gBAAgB,eAAe,MAAM,GAAG,CAAC,MAAM,OAAO,CAAC,gBAAgB,aAAa,MAAM,GAAG,CAAC;IAEpG,OAAO,KAAK,KAAK,CAAC,AAAC,gBAAgB,aAAc;AAClD;AAMO,SAAS,wBAAwB,OAEvC;IACA,MAAM,EAAE,QAAQ,EAAE,GAAG;IAErB,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC9C,OAAO;eAAI;SAAe;IAC3B;IAEA,MAAM,iBAAiB;IACvB,MAAM,iBAAiB,eAAe,cAAc;IAEpD,IAAI,CAAC,MAAM,OAAO,CAAC,iBAAiB;QACnC,OAAO;eAAI;SAAe;IAC3B;IAEA,OAAO,eAAe,MAAM,CAAC,CAAC,OAAS,CAAC,eAAe,QAAQ,CAAC;AACjE;AAKO,SAAS,yBAAyB,OAExC;IACA,MAAM,EAAE,QAAQ,EAAE,GAAG;IAErB,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC9C,OAAO;IACR;IAEA,MAAM,iBAAiB;IACvB,MAAM,cAAc,eAAe,WAAW;IAE9C,IAAI,OAAO,gBAAgB,YAAY,YAAY,MAAM,GAAG,GAAG;QAC9D,OAAO;IACR;IAEA,OAAO;AACR"}},
    {"offset": {"line": 238, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/auth/src/session.ts"],"sourcesContent":["/**\n * Session Management Utilities - Server Component Helpers\n *\n * Features:\n * - Get current authenticated user\n * - Get current session\n * - Require authentication (throw error if not authenticated)\n * - Check user permissions and roles\n * - Server Component compatible\n */\n\nimport type { Session, User } from \"@supabase/supabase-js\";\nimport { cache } from \"react\";\nimport { createClient } from \"@stratos/database/server\";\n\n/**\n * Get Current User - Cached for performance\n *\n * Returns the currently authenticated user or null if not authenticated.\n * Cached per request to avoid multiple database calls.\n *\n * SECURITY: Uses getUser() instead of getSession() to verify the session\n * is authentic by contacting the Supabase Auth server. Session data from\n * cookies cannot be trusted without server-side verification.\n */\nexport const getCurrentUser = cache(async (): Promise<User | null> => {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Use getUser() to authenticate with Supabase Auth server\n\t\t// This verifies the session is valid and not tampered with\n\t\tconst {\n\t\t\tdata: { user },\n\t\t\terror,\n\t\t} = await supabase.auth.getUser();\n\n\t\t// Handle error - could be AuthSessionMissingError or network error\n\t\tif (error) {\n\t\t\t// AuthSessionMissingError is expected when user is not authenticated\n\t\t\t// Don't log this as an error, just return null\n\t\t\tif (error.name === \"AuthSessionMissingError\") {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\n\t\treturn user;\n\t} catch (error) {\n\t\t// Catch any unexpected errors (network issues, etc.)\n\t\t// The error might be thrown instead of returned in some cases\n\t\tif (\n\t\t\terror &&\n\t\t\ttypeof error === \"object\" &&\n\t\t\t\"name\" in error &&\n\t\t\terror.name === \"AuthSessionMissingError\"\n\t\t) {\n\t\t\treturn null;\n\t\t}\n\t\treturn null;\n\t}\n});\n\n/**\n * Get Session - Cached for performance\n *\n * Returns the current session or null if not authenticated.\n * Cached per request to avoid multiple database calls.\n */\nconst getSession = cache(async (): Promise<Session | null> => {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { session },\n\t\t\terror,\n\t\t} = await supabase.auth.getSession();\n\n\t\tif (error) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn session;\n\t} catch (_error) {\n\t\treturn null;\n\t}\n});\n\n/**\n * Require User - Throw error if not authenticated\n *\n * Use this in Server Components or Server Actions that require authentication.\n * Will throw an error that can be caught by error boundaries.\n */\nexport async function requireUser(): Promise<User> {\n\tconst user = await getCurrentUser();\n\n\tif (!user) {\n\t\tthrow new Error(\"Authentication required. Please log in to continue.\");\n\t}\n\n\treturn user;\n}\n\n/**\n * Require Session - Throw error if no session\n *\n * Use this when you need both user and session data (e.g., access token).\n */\nasync function requireSession(): Promise<Session> {\n\tconst session = await getSession();\n\n\tif (!session) {\n\t\tthrow new Error(\"Active session required. Please log in to continue.\");\n\t}\n\n\treturn session;\n}\n\n/**\n * Check if user is authenticated\n *\n * Returns true if user is authenticated, false otherwise.\n * Useful for conditional rendering in Server Components.\n */\nasync function isAuthenticated(): Promise<boolean> {\n\tconst user = await getCurrentUser();\n\treturn user !== null;\n}\n\n/**\n * Get User Metadata\n *\n * Returns user metadata from Supabase Auth.\n * Useful for accessing additional user properties stored in auth.users.\n */\nasync function getUserMetadata<\n\tT = Record<string, any>,\n>(): Promise<T | null> {\n\tconst user = await getCurrentUser();\n\n\tif (!user) {\n\t\treturn null;\n\t}\n\n\treturn (user.user_metadata as T) || null;\n}\n\n/**\n * Check User Email Verified\n *\n * Returns true if user's email is verified, false otherwise.\n */\nasync function isEmailVerified(): Promise<boolean> {\n\tconst user = await getCurrentUser();\n\n\tif (!user) {\n\t\treturn false;\n\t}\n\n\treturn user.email_confirmed_at !== undefined;\n}\n\n/**\n * Get User ID\n *\n * Returns the user's ID or null if not authenticated.\n * Convenient helper for getting just the user ID.\n */\nasync function getUserId(): Promise<string | null> {\n\tconst user = await getCurrentUser();\n\treturn user?.id || null;\n}\n\n/**\n * Get User Email\n *\n * Returns the user's email or null if not authenticated.\n */\nasync function getUserEmail(): Promise<string | null> {\n\tconst user = await getCurrentUser();\n\treturn user?.email || null;\n}\n\n/**\n * Get Access Token\n *\n * Returns the current access token for API calls.\n * Useful for calling external APIs that require authentication.\n */\nasync function getAccessToken(): Promise<string | null> {\n\tconst session = await getSession();\n\treturn session?.access_token || null;\n}\n\n/**\n * Refresh Session\n *\n * Manually refresh the session to get a new access token.\n * Usually not needed as Supabase handles this automatically.\n */\nasync function refreshSession(): Promise<Session | null> {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { session },\n\t\t\terror,\n\t\t} = await supabase.auth.refreshSession();\n\n\t\tif (error) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn session;\n\t} catch (_error) {\n\t\treturn null;\n\t}\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;CASC;;;;;;AAGD;AACA;;;AAYO,MAAM,iBAAiB,IAAA,uXAAK,EAAC;IACnC,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,uJAAY;QAEnC,IAAI,CAAC,UAAU;YACd,OAAO;QACR;QAEA,0DAA0D;QAC1D,2DAA2D;QAC3D,MAAM,EACL,MAAM,EAAE,IAAI,EAAE,EACd,KAAK,EACL,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAE/B,mEAAmE;QACnE,IAAI,OAAO;YACV,qEAAqE;YACrE,+CAA+C;YAC/C,IAAI,MAAM,IAAI,KAAK,2BAA2B;gBAC7C,OAAO;YACR;YACA,OAAO;QACR;QAEA,OAAO;IACR,EAAE,OAAO,OAAO;QACf,qDAAqD;QACrD,8DAA8D;QAC9D,IACC,SACA,OAAO,UAAU,YACjB,UAAU,SACV,MAAM,IAAI,KAAK,2BACd;YACD,OAAO;QACR;QACA,OAAO;IACR;AACD;AAEA;;;;;CAKC,GACD,MAAM,aAAa,IAAA,uXAAK,EAAC;IACxB,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,uJAAY;QAEnC,IAAI,CAAC,UAAU;YACd,OAAO;QACR;QAEA,MAAM,EACL,MAAM,EAAE,OAAO,EAAE,EACjB,KAAK,EACL,GAAG,MAAM,SAAS,IAAI,CAAC,UAAU;QAElC,IAAI,OAAO;YACV,OAAO;QACR;QAEA,OAAO;IACR,EAAE,OAAO,QAAQ;QAChB,OAAO;IACR;AACD;AAQO,eAAe;IACrB,MAAM,OAAO,MAAM;IAEnB,IAAI,CAAC,MAAM;QACV,MAAM,IAAI,MAAM;IACjB;IAEA,OAAO;AACR;AAEA;;;;CAIC,GACD,eAAe;IACd,MAAM,UAAU,MAAM;IAEtB,IAAI,CAAC,SAAS;QACb,MAAM,IAAI,MAAM;IACjB;IAEA,OAAO;AACR;AAEA;;;;;CAKC,GACD,eAAe;IACd,MAAM,OAAO,MAAM;IACnB,OAAO,SAAS;AACjB;AAEA;;;;;CAKC,GACD,eAAe;IAGd,MAAM,OAAO,MAAM;IAEnB,IAAI,CAAC,MAAM;QACV,OAAO;IACR;IAEA,OAAO,AAAC,KAAK,aAAa,IAAU;AACrC;AAEA;;;;CAIC,GACD,eAAe;IACd,MAAM,OAAO,MAAM;IAEnB,IAAI,CAAC,MAAM;QACV,OAAO;IACR;IAEA,OAAO,KAAK,kBAAkB,KAAK;AACpC;AAEA;;;;;CAKC,GACD,eAAe;IACd,MAAM,OAAO,MAAM;IACnB,OAAO,MAAM,MAAM;AACpB;AAEA;;;;CAIC,GACD,eAAe;IACd,MAAM,OAAO,MAAM;IACnB,OAAO,MAAM,SAAS;AACvB;AAEA;;;;;CAKC,GACD,eAAe;IACd,MAAM,UAAU,MAAM;IACtB,OAAO,SAAS,gBAAgB;AACjC;AAEA;;;;;CAKC,GACD,eAAe;IACd,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,uJAAY;QAEnC,IAAI,CAAC,UAAU;YACd,OAAO;QACR;QAEA,MAAM,EACL,MAAM,EAAE,OAAO,EAAE,EACjB,KAAK,EACL,GAAG,MAAM,SAAS,IAAI,CAAC,cAAc;QAEtC,IAAI,OAAO;YACV,OAAO;QACR;QAEA,OAAO;IACR,EAAE,OAAO,QAAQ;QAChB,OAAO;IACR;AACD"}},
    {"offset": {"line": 405, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/packages/auth/src/company-context.ts"],"sourcesContent":["/**\n * Company Context Management\n *\n * Handles multi-tenancy by tracking and switching between companies\n * for users who may be members of multiple companies.\n *\n * Features:\n * - Active company stored in HTTP-only cookie\n * - Falls back to first available company\n * - Validates access before switching\n * - Server-side only (no client-side state)\n *\n * PERFORMANCE: All functions wrapped with React.cache() to prevent\n * redundant database queries across components in the same request.\n */\n\n\nimport { createClient } from \"@stratos/database/server\";\nimport { createServiceSupabaseClient } from \"@stratos/database/service-client\";\nimport { isOnboardingComplete } from \"@stratos/shared/onboarding\";\nimport { cache } from \"react\";\nimport { getCurrentUser } from \"./session\";\n\nconst ACTIVE_COMPANY_COOKIE = \"active_company_id\";\n\n/**\n * Company Info\n */\nexport type CompanyInfo = {\n\tid: string;\n\tname: string;\n\tlogo?: string | null;\n\tphone?: string | null;\n\temail?: string | null;\n};\n\n/**\n * Get Active Company ID\n *\n * Returns the currently active company for the user.\n * Falls back to first company if no active company is set.\n *\n * PERFORMANCE: Wrapped with React.cache() - called by every component,\n * but only executes once per request.\n *\n * @returns Company ID string or null if user has no companies\n */\nexport const getActiveCompanyId = cache(async (): Promise<string | null> => {\n\tconst { cookies } = await import(\"next/headers\");\n\tlet cookieStore;\n\ttry {\n\t\tcookieStore = await cookies();\n\t} catch (error) {\n\t\t// During prerendering, cookies() may reject - return null\n\t\t// This allows PPR to work correctly\n\t\tif (error instanceof Error && (\n\t\t\terror.message.includes(\"During prerendering\") ||\n\t\t\terror.message.includes(\"prerendering\") ||\n\t\t\terror.message.includes(\"cookies()\")\n\t\t)) {\n\t\t\treturn null;\n\t\t}\n\t\tthrow error;\n\t}\n\tconst activeCompanyId = cookieStore.get(ACTIVE_COMPANY_COOKIE)?.value;\n\n\tif (activeCompanyId) {\n\t\t// Verify user still has access to this company\n\t\tconst hasAccess = await verifyCompanyAccess(activeCompanyId);\n\t\tif (hasAccess) {\n\t\t\treturn activeCompanyId;\n\t\t}\n\t}\n\n\t// Fall back to first available company\n\tconst companies = await getUserCompanies();\n\treturn companies[0]?.id || null;\n});\n\n/**\n * Get Active Company Info\n *\n * Returns the full company object for the active company.\n *\n * PERFORMANCE: Wrapped with React.cache() - called by multiple components,\n * but only executes once per request.\n *\n * @returns CompanyInfo object or null\n */\nexport const getActiveCompany = cache(async (): Promise<CompanyInfo | null> => {\n\tconst companyId = await getActiveCompanyId();\n\tif (!companyId) {\n\t\treturn null;\n\t}\n\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\treturn null;\n\t}\n\n\tconst { data: company } = await supabase\n\t\t.from(\"companies\")\n\t\t.select(\"id, name, logo, phone, email\")\n\t\t.eq(\"id\", companyId)\n\t\t.is(\"deleted_at\", null) // Exclude archived companies\n\t\t.single();\n\n\treturn company;\n});\n\n/**\n * Set Active Company\n *\n * Switches the user's active company context.\n * Validates access before switching.\n *\n * @param companyId - Company ID to switch to\n * @throws Error if user doesn't have access to this company\n */\nexport async function setActiveCompany(companyId: string): Promise<void> {\n\t// Verify access before switching\n\tconst hasAccess = await verifyCompanyAccess(companyId);\n\n\tif (!hasAccess) {\n\t\tthrow new Error(\"You don't have access to this company\");\n\t}\n\n\tconst { cookies } = await import(\"next/headers\");\n\tconst cookieStore = await cookies();\n\tcookieStore.set(ACTIVE_COMPANY_COOKIE, companyId, {\n\t\thttpOnly: true,\n\t\tsecure: process.env.NODE_ENV === \"production\",\n\t\tsameSite: \"lax\",\n\t\tmaxAge: 60 * 60 * 24 * 30, // 30 days\n\t\tpath: \"/\",\n\t});\n}\n\n/**\n * Clear Active Company\n *\n * Removes the active company cookie.\n */\nexport async function clearActiveCompany(): Promise<void> {\n\tconst { cookies } = await import(\"next/headers\");\n\tconst cookieStore = await cookies();\n\tcookieStore.delete(ACTIVE_COMPANY_COOKIE);\n}\n\n/**\n * Get User Companies\n *\n * Returns all companies the user has access to.\n *\n * SECURITY: Uses service role because:\n * - Query filters to user's own memberships (user_id = authenticated user)\n * - JOIN to companies table causes RLS recursion with anon key\n * - User only sees their own team_members records\n * - Companies table has its own RLS protection\n *\n * @returns Array of CompanyInfo objects\n */\nexport const getUserCompanies = cache(async (): Promise<CompanyInfo[]> => {\n\tconst user = await getCurrentUser();\n\tif (!user) {\n\t\treturn [];\n\t}\n\n\t// Use service role to bypass RLS recursion on JOIN\n\t// Query is safe: explicitly filtered to user's own records\n\tconst supabase = await createServiceSupabaseClient();\n\tif (!supabase) {\n\t\treturn [];\n\t}\n\n\tconst { data: memberships } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(\n\t\t\t`\n      company_id,\n      companies!inner (\n        id,\n        name,\n        logo,\n        deleted_at,\n        onboarding_completed_at\n      )\n    `,\n\t\t)\n\t\t.eq(\"user_id\", user.id)\n\t\t.eq(\"status\", \"active\")\n\t\t.is(\"companies.deleted_at\", null); // Exclude archived companies\n\n\tif (!memberships) {\n\t\treturn [];\n\t}\n\n\t// Sort companies: prioritize completed onboarding over incomplete\n\tconst sorted = memberships.sort((a: any, b: any) => {\n\t\tconst aCompleted = !!a.companies.onboarding_completed_at;\n\t\tconst bCompleted = !!b.companies.onboarding_completed_at;\n\n\t\t// Completed companies first\n\t\tif (aCompleted && !bCompleted) return -1;\n\t\tif (!aCompleted && bCompleted) return 1;\n\n\t\t// Then by name alphabetically\n\t\treturn a.companies.name.localeCompare(b.companies.name);\n\t});\n\n\treturn sorted.map((m: any) => ({\n\t\tid: m.companies.id,\n\t\tname: m.companies.name,\n\t\tlogo: m.companies.logo,\n\t}));\n});\n\n/**\n * Verify Company Access\n *\n * Checks if user has access to a company.\n *\n * @param companyId - Company ID to verify\n * @returns true if user has access, false otherwise\n */\nconst verifyCompanyAccess = cache(\n\tasync (companyId: string): Promise<boolean> => {\n\t\tconst user = await getCurrentUser();\n\t\tif (!user) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Parallel queries instead of sequential (saves 20-30ms)\n\t\tconst [companyResult, memberResult] = await Promise.all([\n\t\t\t// Check if company exists and is not archived\n\t\t\tsupabase\n\t\t\t\t.from(\"companies\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"id\", companyId)\n\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t.single(),\n\n\t\t\t// Check if user has active membership\n\t\t\tsupabase\n\t\t\t\t.from(\"company_memberships\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"user_id\", user.id)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"status\", \"active\")\n\t\t\t\t.single(),\n\t\t]);\n\n\t\t// Both must succeed\n\t\treturn !!(companyResult.data && memberResult.data);\n\t},\n);\n\n/**\n * Get Active Team Member ID\n *\n * Returns the team_members.id for the current user in the active company.\n * Used for personal inbox filtering and other team-member-specific features.\n *\n * PERFORMANCE: Wrapped with React.cache() - called by multiple components,\n * but only executes once per request.\n *\n * @returns Team member ID string or null if not found\n */\nexport const getActiveTeamMemberId = cache(async (): Promise<string | null> => {\n\tconst user = await getCurrentUser();\n\tif (!user) {\n\t\treturn null;\n\t}\n\n\tconst companyId = await getActiveCompanyId();\n\tif (!companyId) {\n\t\treturn null;\n\t}\n\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\treturn null;\n\t}\n\n\tconst { data: teamMember } = await supabase\n\t\t.from(\"team_members\")\n\t\t.select(\"id\")\n\t\t.eq(\"user_id\", user.id)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"active\")\n\t\t.single();\n\n\treturn teamMember?.id || null;\n});\n\n/**\n * Require Active Company\n *\n * Throws error if no active company is set.\n * Useful for actions that require a company context.\n *\n * @returns Company ID string\n * @throws Error if no active company\n */\nexport async function requireActiveCompany(): Promise<string> {\n\tconst companyId = await getActiveCompanyId();\n\n\tif (!companyId) {\n\t\tthrow new Error(\"No active company selected. Please select a company.\");\n\t}\n\n\treturn companyId;\n}\n\n/**\n * Check if User Has Multiple Companies\n *\n * Useful for conditionally showing company switcher UI.\n *\n * @returns true if user has 2+ companies, false otherwise\n */\nasync function hasMultipleCompanies(): Promise<boolean> {\n\tconst companies = await getUserCompanies();\n\treturn companies.length > 1;\n}\n\n/**\n * Check if Active Company Has Completed Onboarding\n *\n * Checks if the active company has an active payment subscription.\n * This is used to determine if onboarding is complete.\n *\n * SECURITY: Uses service role because:\n * - Query filters to user's own membership (user_id = authenticated user)\n * - JOIN to companies table causes RLS recursion with anon key\n * - User only sees their own team_members record\n * - Companies table has its own RLS protection\n *\n * @returns true if company has active/trialing subscription, false otherwise\n */\nexport async function isActiveCompanyOnboardingComplete(): Promise<boolean> {\n\tconst user = await getCurrentUser();\n\tif (!user) {\n\t\treturn false;\n\t}\n\n\tconst activeCompanyId = await getActiveCompanyId();\n\tif (!activeCompanyId) {\n\t\treturn false;\n\t}\n\n\t// Use service role to bypass RLS recursion on JOIN\n\t// Query is safe: explicitly filtered to user's own record\n\tconst supabase = await createServiceSupabaseClient();\n\tif (!supabase) {\n\t\treturn false;\n\t}\n\n\t// Check the ACTIVE company's payment status\n\tconst { data: teamMember } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(\n\t\t\t\"company_id, companies!inner(stripe_subscription_status, onboarding_progress, onboarding_completed_at)\",\n\t\t)\n\t\t.eq(\"user_id\", user.id)\n\t\t.eq(\"company_id\", activeCompanyId)\n\t\t.eq(\"status\", \"active\")\n\t\t.maybeSingle();\n\n\tif (!teamMember) {\n\t\treturn false;\n\t}\n\n\tconst companies = Array.isArray(teamMember.companies)\n\t\t? teamMember.companies[0]\n\t\t: teamMember.companies;\n\tconst subscriptionStatus = companies?.stripe_subscription_status;\n\tconst subscriptionActive =\n\t\tsubscriptionStatus === \"active\" || subscriptionStatus === \"trialing\";\n\tconst onboardingProgress =\n\t\t(companies?.onboarding_progress as Record<string, unknown>) || null;\n\tconst onboardingFinished = isOnboardingComplete({\n\t\tprogress: onboardingProgress,\n\t\tcompletedAt: companies?.onboarding_completed_at ?? null,\n\t});\n\n\treturn (\n\t\t(subscriptionActive && onboardingFinished) ||\n\t\tprocess.env.NODE_ENV === \"development\"\n\t);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 640, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/auth/company-context.ts"],"sourcesContent":["// Re-export from @stratos/auth package for backwards compatibility\nexport * from \"@stratos/auth/company-context\";\n"],"names":[],"mappings":"AAAA,mEAAmE;;AACnE"}},
    {"offset": {"line": 674, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/deliverability-monitor.ts"],"sourcesContent":["\"use server\";\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\n/**\n * Deliverability Monitor for Multi-Tenant Email System\n *\n * Features:\n * - Track delivery events (delivered, bounced, complained)\n * - Update domain reputation scores\n * - Auto-suspend domains with poor reputation\n * - Generate deliverability reports\n */\n\nexport type DeliveryEventType =\n\t| \"delivered\"\n\t| \"bounced\"\n\t| \"soft_bounce\"\n\t| \"complained\"\n\t| \"opened\"\n\t| \"clicked\";\n\nexport interface DeliveryEvent {\n\tdomainId: string;\n\teventType: DeliveryEventType;\n\temailId?: string;\n\tmetadata?: Record<string, any>;\n}\n\nexport interface DomainHealth {\n\tdomainId: string;\n\tdomain: string;\n\treputationScore: number;\n\tbounceRate: number;\n\tcomplaintRate: number;\n\tdeliveryRate: number;\n\tstatus: \"healthy\" | \"warning\" | \"critical\" | \"suspended\";\n\ttotalEmailsSent: number;\n\thardBounces: number;\n\tsoftBounces: number;\n\tcomplaints: number;\n\tlastHealthCheck: string | null;\n}\n\n/**\n * Record a delivery event and update domain metrics\n */\nexport async function recordDeliveryEvent(\n\tevent: DeliveryEvent\n): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Use the database function to update reputation\n\tconst { error } = await supabase.rpc(\"update_domain_reputation\", {\n\t\tp_domain_id: event.domainId,\n\t\tp_event_type: event.eventType,\n\t});\n\n\tif (error) {\n\t\tconsole.error(\"Error recording delivery event:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Process Resend webhook events for deliverability tracking\n */\nexport async function processResendWebhookEvent(webhookData: {\n\ttype: string;\n\tdata: {\n\t\temail_id?: string;\n\t\tfrom?: string;\n\t\tto?: string[];\n\t\tsubject?: string;\n\t\tcreated_at?: string;\n\t\t[key: string]: any;\n\t};\n}): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Map Resend event types to our event types\n\tconst eventTypeMap: Record<string, DeliveryEventType | null> = {\n\t\t\"email.delivered\": \"delivered\",\n\t\t\"email.bounced\": \"bounced\",\n\t\t\"email.complained\": \"complained\",\n\t\t\"email.opened\": \"opened\",\n\t\t\"email.clicked\": \"clicked\",\n\t\t// Soft bounces might come as delivery_delayed in some providers\n\t\t\"email.delivery_delayed\": \"soft_bounce\",\n\t};\n\n\tconst eventType = eventTypeMap[webhookData.type];\n\tif (!eventType) {\n\t\t// Not a delivery event we track\n\t\treturn { success: true };\n\t}\n\n\t// Extract domain from the \"from\" address\n\tconst fromEmail = webhookData.data.from;\n\tif (!fromEmail) {\n\t\treturn { success: true };\n\t}\n\n\tconst domain = fromEmail.includes(\"@\")\n\t\t? fromEmail.split(\"@\")[1]\n\t\t: fromEmail;\n\n\t// Look up the domain in our database\n\tconst { data: domainRecord } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"id\")\n\t\t.eq(\"domain_name\", domain)\n\t\t.maybeSingle();\n\n\tif (!domainRecord) {\n\t\t// Domain not found in our system\n\t\treturn { success: true };\n\t}\n\n\t// Record the event\n\treturn recordDeliveryEvent({\n\t\tdomainId: domainRecord.id,\n\t\teventType,\n\t\temailId: webhookData.data.email_id,\n\t\tmetadata: webhookData.data,\n\t});\n}\n\n/**\n * Get domain health status\n */\nexport async function getDomainHealth(\n\tdomainId: string\n): Promise<DomainHealth | null> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data, error } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\n\t\t\t\"id, domain_name, reputation_score, bounce_rate, total_emails_sent, hard_bounces, soft_bounces, spam_complaints, is_suspended, last_health_check\"\n\t\t)\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (error || !data) {\n\t\treturn null;\n\t}\n\n\tconst totalEvents =\n\t\tdata.total_emails_sent + data.hard_bounces + data.soft_bounces;\n\tconst bounceRate =\n\t\ttotalEvents > 0\n\t\t\t? ((data.hard_bounces + data.soft_bounces) / totalEvents) * 100\n\t\t\t: 0;\n\tconst complaintRate =\n\t\tdata.total_emails_sent > 0\n\t\t\t? (data.spam_complaints / data.total_emails_sent) * 100\n\t\t\t: 0;\n\tconst deliveryRate =\n\t\ttotalEvents > 0 ? (data.total_emails_sent / totalEvents) * 100 : 100;\n\n\tlet status: DomainHealth[\"status\"] = \"healthy\";\n\tif (data.is_suspended) {\n\t\tstatus = \"suspended\";\n\t} else if (data.reputation_score < 30 || bounceRate > 10 || complaintRate > 0.5) {\n\t\tstatus = \"critical\";\n\t} else if (data.reputation_score < 60 || bounceRate > 5 || complaintRate > 0.2) {\n\t\tstatus = \"warning\";\n\t}\n\n\treturn {\n\t\tdomainId: data.id,\n\t\tdomain: data.domain_name,\n\t\treputationScore: Number(data.reputation_score),\n\t\tbounceRate: Number(bounceRate.toFixed(2)),\n\t\tcomplaintRate: Number(complaintRate.toFixed(3)),\n\t\tdeliveryRate: Number(deliveryRate.toFixed(2)),\n\t\tstatus,\n\t\ttotalEmailsSent: data.total_emails_sent,\n\t\thardBounces: data.hard_bounces,\n\t\tsoftBounces: data.soft_bounces,\n\t\tcomplaints: data.spam_complaints,\n\t\tlastHealthCheck: data.last_health_check,\n\t};\n}\n\n/**\n * Get all domains health for a company\n */\nexport async function getCompanyDomainsHealth(\n\tcompanyId: string\n): Promise<DomainHealth[]> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data, error } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\n\t\t\t\"id, domain_name, reputation_score, bounce_rate, total_emails_sent, hard_bounces, soft_bounces, spam_complaints, is_suspended, last_health_check\"\n\t\t)\n\t\t.eq(\"company_id\", companyId);\n\n\tif (error || !data) {\n\t\treturn [];\n\t}\n\n\treturn data.map((d) => {\n\t\tconst totalEvents = d.total_emails_sent + d.hard_bounces + d.soft_bounces;\n\t\tconst bounceRate =\n\t\t\ttotalEvents > 0 ? ((d.hard_bounces + d.soft_bounces) / totalEvents) * 100 : 0;\n\t\tconst complaintRate =\n\t\t\td.total_emails_sent > 0 ? (d.spam_complaints / d.total_emails_sent) * 100 : 0;\n\t\tconst deliveryRate =\n\t\t\ttotalEvents > 0 ? (d.total_emails_sent / totalEvents) * 100 : 100;\n\n\t\tlet status: DomainHealth[\"status\"] = \"healthy\";\n\t\tif (d.is_suspended) {\n\t\t\tstatus = \"suspended\";\n\t\t} else if (d.reputation_score < 30 || bounceRate > 10 || complaintRate > 0.5) {\n\t\t\tstatus = \"critical\";\n\t\t} else if (d.reputation_score < 60 || bounceRate > 5 || complaintRate > 0.2) {\n\t\t\tstatus = \"warning\";\n\t\t}\n\n\t\treturn {\n\t\t\tdomainId: d.id,\n\t\t\tdomain: d.domain_name,\n\t\t\treputationScore: Number(d.reputation_score),\n\t\t\tbounceRate: Number(bounceRate.toFixed(2)),\n\t\t\tcomplaintRate: Number(complaintRate.toFixed(3)),\n\t\t\tdeliveryRate: Number(deliveryRate.toFixed(2)),\n\t\t\tstatus,\n\t\t\ttotalEmailsSent: d.total_emails_sent,\n\t\t\thardBounces: d.hard_bounces,\n\t\t\tsoftBounces: d.soft_bounces,\n\t\t\tcomplaints: d.spam_complaints,\n\t\t\tlastHealthCheck: d.last_health_check,\n\t\t};\n\t});\n}\n\n/**\n * Run health check on all domains and update status\n */\nexport async function runHealthCheckForAllDomains(): Promise<{\n\tchecked: number;\n\tsuspended: number;\n\twarnings: number;\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Get all active domains\n\tconst { data: domains } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"id, reputation_score, hard_bounces, soft_bounces, spam_complaints, total_emails_sent\")\n\t\t.eq(\"is_suspended\", false);\n\n\tif (!domains) {\n\t\treturn { checked: 0, suspended: 0, warnings: 0 };\n\t}\n\n\tlet suspended = 0;\n\tlet warnings = 0;\n\n\tfor (const domain of domains) {\n\t\tconst totalEvents =\n\t\t\tdomain.total_emails_sent + domain.hard_bounces + domain.soft_bounces;\n\t\tconst bounceRate =\n\t\t\ttotalEvents > 100\n\t\t\t\t? ((domain.hard_bounces + domain.soft_bounces) / totalEvents) * 100\n\t\t\t\t: 0;\n\t\tconst complaintRate =\n\t\t\tdomain.total_emails_sent > 100\n\t\t\t\t? (domain.spam_complaints / domain.total_emails_sent) * 100\n\t\t\t\t: 0;\n\n\t\t// Auto-suspend if reputation is critical\n\t\tif (domain.reputation_score < 20 || bounceRate > 15 || complaintRate > 1) {\n\t\t\tawait supabase\n\t\t\t\t.from(\"company_email_domains\")\n\t\t\t\t.update({\n\t\t\t\t\tis_suspended: true,\n\t\t\t\t\tsuspension_reason: `Auto-suspended: Reputation ${domain.reputation_score}, Bounce rate ${bounceRate.toFixed(1)}%, Complaint rate ${complaintRate.toFixed(2)}%`,\n\t\t\t\t\tsuspended_at: new Date().toISOString(),\n\t\t\t\t\tlast_health_check: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", domain.id);\n\t\t\tsuspended++;\n\t\t} else if (domain.reputation_score < 50 || bounceRate > 8 || complaintRate > 0.3) {\n\t\t\t// Update health check timestamp for warning domains\n\t\t\tawait supabase\n\t\t\t\t.from(\"company_email_domains\")\n\t\t\t\t.update({ last_health_check: new Date().toISOString() })\n\t\t\t\t.eq(\"id\", domain.id);\n\t\t\twarnings++;\n\t\t} else {\n\t\t\t// Healthy, just update timestamp\n\t\t\tawait supabase\n\t\t\t\t.from(\"company_email_domains\")\n\t\t\t\t.update({ last_health_check: new Date().toISOString() })\n\t\t\t\t.eq(\"id\", domain.id);\n\t\t}\n\t}\n\n\treturn {\n\t\tchecked: domains.length,\n\t\tsuspended,\n\t\twarnings,\n\t};\n}\n\n/**\n * Generate deliverability report for a domain\n */\nexport async function generateDeliverabilityReport(domainId: string): Promise<{\n\tdomain: string;\n\tperiod: { start: string; end: string };\n\tmetrics: {\n\t\ttotalSent: number;\n\t\tdelivered: number;\n\t\tbounced: number;\n\t\tcomplained: number;\n\t\tdeliveryRate: number;\n\t\tbounceRate: number;\n\t\tcomplaintRate: number;\n\t};\n\treputation: {\n\t\tcurrent: number;\n\t\tchange: number;\n\t\tstatus: string;\n\t};\n\trecommendations: string[];\n} | null> {\n\tconst health = await getDomainHealth(domainId);\n\tif (!health) {\n\t\treturn null;\n\t}\n\n\tconst recommendations: string[] = [];\n\n\tif (health.bounceRate > 5) {\n\t\trecommendations.push(\n\t\t\t\"High bounce rate detected. Clean your email list and remove invalid addresses.\"\n\t\t);\n\t}\n\n\tif (health.complaintRate > 0.1) {\n\t\trecommendations.push(\n\t\t\t\"Spam complaints detected. Ensure recipients have opted in and make unsubscribe easy.\"\n\t\t);\n\t}\n\n\tif (health.reputationScore < 70) {\n\t\trecommendations.push(\n\t\t\t\"Reputation score is below optimal. Reduce sending volume temporarily and focus on engagement.\"\n\t\t);\n\t}\n\n\tif (health.status === \"warning\" || health.status === \"critical\") {\n\t\trecommendations.push(\n\t\t\t\"Domain health is degraded. Review your email content and sending practices.\"\n\t\t);\n\t}\n\n\tif (recommendations.length === 0) {\n\t\trecommendations.push(\n\t\t\t\"Domain health is good. Continue monitoring and maintain current practices.\"\n\t\t);\n\t}\n\n\treturn {\n\t\tdomain: health.domain,\n\t\tperiod: {\n\t\t\tstart: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),\n\t\t\tend: new Date().toISOString(),\n\t\t},\n\t\tmetrics: {\n\t\t\ttotalSent: health.totalEmailsSent,\n\t\t\tdelivered: health.totalEmailsSent - health.hardBounces,\n\t\t\tbounced: health.hardBounces + health.softBounces,\n\t\t\tcomplained: health.complaints,\n\t\t\tdeliveryRate: health.deliveryRate,\n\t\t\tbounceRate: health.bounceRate,\n\t\t\tcomplaintRate: health.complaintRate,\n\t\t},\n\t\treputation: {\n\t\t\tcurrent: health.reputationScore,\n\t\t\tchange: 0, // Would need historical data to calculate\n\t\t\tstatus: health.status,\n\t\t},\n\t\trecommendations,\n\t};\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 930, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/email-types.ts"],"sourcesContent":["/**\n * Email Types - Type definitions for email templates\n *\n * Features:\n * - Type-safe email data\n * - Template props interfaces\n * - Email send result types\n * - Validation schemas\n */\n\nimport { z } from \"zod\";\n\n// Email send result type\nexport type EmailSendResult = {\n\tsuccess: boolean;\n\terror?: string;\n\tdata?: {\n\t\tid?: string;\n\t\tmessage?: string;\n\t};\n};\n\n// Company branding for tenant emails\nexport type CompanyBranding = {\n\tcompanyName: string;\n\tlogoUrl?: string;\n\tprimaryColor?: string;\n\tsupportEmail?: string;\n\tsupportPhone?: string;\n\twebsiteUrl?: string;\n\taddress?: string;\n};\n\n// Base email template props\nexport type BaseEmailProps = {\n\tpreviewText?: string;\n\tcompanyName?: string; // Deprecated - use company.companyName\n\tcompany?: CompanyBranding; // For company-branded emails\n};\n\n// Authentication Email Props\nexport interface WelcomeEmailProps extends BaseEmailProps {\n\tname: string;\n\tloginUrl: string;\n}\n\nexport interface EmailVerificationProps extends BaseEmailProps {\n\tname: string;\n\tverificationUrl: string;\n}\n\nexport interface PasswordResetProps extends BaseEmailProps {\n\tname?: string;\n\tresetUrl: string;\n\texpiresInMinutes?: number;\n}\n\nexport interface PasswordChangedProps extends BaseEmailProps {\n\tname: string;\n\tchangedAt: Date;\n}\n\nexport interface MagicLinkProps extends BaseEmailProps {\n\tloginUrl: string;\n\texpiresInMinutes?: number;\n}\n\n// Job Lifecycle Email Props\nexport interface JobConfirmationProps extends BaseEmailProps {\n\tcustomerName: string;\n\tjobDate: string;\n\tjobTime: string;\n\ttechnicianName: string;\n\tjobType: string;\n\taddress: string;\n\tjobNumber: string;\n\tviewJobUrl: string;\n}\n\nexport interface AppointmentReminderProps extends BaseEmailProps {\n\tcustomerName: string;\n\tappointmentDate: string;\n\tappointmentTime: string;\n\ttechnicianName: string;\n\taddress: string;\n\trescheduleUrl: string;\n}\n\nexport interface TechEnRouteProps extends BaseEmailProps {\n\tcustomerName: string;\n\ttechnicianName: string;\n\testimatedArrival: string;\n\ttechnicianPhoto?: string;\n\ttrackingUrl?: string;\n}\n\nexport interface JobCompleteProps extends BaseEmailProps {\n\tcustomerName: string;\n\tjobNumber: string;\n\tcompletedDate: string;\n\ttotalAmount: string;\n\tinvoiceUrl: string;\n\treviewUrl: string;\n}\n\n// Billing Email Props\nexport interface InvoiceSentProps extends BaseEmailProps {\n\tcustomerName: string;\n\tinvoiceNumber: string;\n\ttotalAmount: string;\n\tdueDate: string;\n\titems: Array<{\n\t\tdescription: string;\n\t\tquantity: number;\n\t\tamount: string;\n\t}>;\n\tpaymentUrl: string;\n\tdownloadUrl: string;\n}\n\nexport interface InvoiceNotificationProps extends BaseEmailProps {\n\tcustomerName: string;\n\tinvoiceNumber: string;\n\tinvoiceDate: string;\n\tdueDate?: string;\n\ttotalAmount: number; // in cents\n\tinvoiceUrl: string;\n\tcurrency?: string;\n\titems?: Array<{\n\t\tdescription: string;\n\t\tquantity: number;\n\t\tamount: number; // in cents\n\t}>;\n\tnotes?: string;\n\tpaymentLink?: string; // Secure payment portal link\n\tcustomBody?: string; // Custom email body from template\n\tcustomFooter?: string; // Custom email footer from template\n}\n\nexport interface EstimateNotificationProps extends BaseEmailProps {\n\tcustomerName: string;\n\testimateNumber: string;\n\testimateDate: string;\n\tvalidUntil?: string;\n\ttotalAmount: number; // in cents\n\testimateUrl: string;\n\tcurrency?: string;\n\titems?: Array<{\n\t\tdescription: string;\n\t\tquantity: number;\n\t\tamount: number; // in cents\n\t}>;\n\tnotes?: string;\n}\n\nexport interface PaymentReceivedProps extends BaseEmailProps {\n\tcustomerName: string;\n\tinvoiceNumber: string;\n\tpaymentAmount: string;\n\tpaymentMethod: string;\n\tpaymentDate: string;\n\treceiptUrl: string;\n}\n\nexport interface PaymentReminderProps extends BaseEmailProps {\n\tcustomerName: string;\n\tinvoiceNumber: string;\n\ttotalAmount: string;\n\tdueDate: string;\n\tdaysOverdue: number;\n\tpaymentUrl: string;\n}\n\nexport interface EstimateSentProps extends BaseEmailProps {\n\tcustomerName: string;\n\testimateNumber: string;\n\ttotalAmount: string;\n\tvalidUntil: string;\n\titems: Array<{\n\t\tdescription: string;\n\t\tamount: string;\n\t}>;\n\tacceptUrl: string;\n\tviewUrl: string;\n}\n\n// Customer Engagement Email Props\nexport interface ReviewRequestProps extends BaseEmailProps {\n\tcustomerName: string;\n\tjobNumber: string;\n\ttechnicianName: string;\n\tcompletedDate: string;\n\treviewUrl: string;\n}\n\nexport interface ServiceReminderProps extends BaseEmailProps {\n\tcustomerName: string;\n\tserviceName: string;\n\tlastServiceDate: string;\n\tscheduleUrl: string;\n}\n\nexport interface WelcomeCustomerProps extends BaseEmailProps {\n\tcustomerName: string;\n\taccountUrl: string;\n\tsupportEmail: string;\n\tsupportPhone: string;\n}\n\nexport interface PortalInvitationProps extends BaseEmailProps {\n\tcustomerName: string;\n\tportalUrl: string;\n\texpiresInHours?: number;\n\tcompanyName?: string;\n\tsupportEmail?: string;\n\tsupportPhone?: string;\n}\n\n// Verification Email Props\nexport interface VerificationSubmittedProps extends BaseEmailProps {\n\tcompanyName: string;\n\tcontactName: string;\n\thasTollFreeNumbers: boolean;\n\thas10DLCNumbers: boolean;\n\ttollFreeCount?: number;\n\tdlcCount?: number;\n\tdashboardUrl: string;\n}\n\nexport interface VerificationCompleteProps extends BaseEmailProps {\n\tcompanyName: string;\n\tcontactName: string;\n\tverificationTypes: string[]; // [\"toll-free\", \"10dlc\"]\n\tdashboardUrl: string;\n\tmessagingUrl: string;\n}\n\n// Waitlist Email Props\nexport interface WaitlistSubscriptionProps extends BaseEmailProps {\n\tname: string;\n}\n\n// Validation Schemas\nconst emailAddressSchema = z\n\t.string()\n\t.email(\"Invalid email address\")\n\t.min(1, \"Email is required\");\n\nexport const emailSendSchema = z.object({\n\tto: z.union([emailAddressSchema, z.array(emailAddressSchema)]),\n\tsubject: z.string().min(1, \"Subject is required\").max(200),\n\treplyTo: emailAddressSchema.optional(),\n});\n\n// Template types enum\nexport enum EmailTemplate {\n\t// Auth\n\tWELCOME = \"welcome\",\n\tEMAIL_VERIFICATION = \"email-verification\",\n\tPASSWORD_RESET = \"password-reset\",\n\tPASSWORD_CHANGED = \"password-changed\",\n\tMAGIC_LINK = \"magic-link\",\n\n\t// Jobs\n\tJOB_CONFIRMATION = \"job-confirmation\",\n\tAPPOINTMENT_REMINDER = \"appointment-reminder\",\n\tTECH_EN_ROUTE = \"tech-en-route\",\n\tJOB_COMPLETE = \"job-complete\",\n\n\t// Billing\n\tINVOICE = \"invoice\",\n\tESTIMATE = \"estimate\",\n\tINVOICE_SENT = \"invoice-sent\",\n\tPAYMENT_RECEIVED = \"payment-received\",\n\tPAYMENT_REMINDER = \"payment-reminder\",\n\tESTIMATE_SENT = \"estimate-sent\",\n\n\t// Customer\n\tREVIEW_REQUEST = \"review-request\",\n\tSERVICE_REMINDER = \"service-reminder\",\n\tWELCOME_CUSTOMER = \"welcome-customer\",\n\tPORTAL_INVITATION = \"portal-invitation\",\n\n\t// Team\n\tTEAM_INVITATION = \"team-invitation\",\n\n\t// Onboarding & Verification\n\tVERIFICATION_SUBMITTED = \"verification-submitted\",\n\tVERIFICATION_COMPLETE = \"verification-complete\",\n\n\t// Waitlist\n\tWAITLIST_SUBSCRIPTION = \"waitlist-subscription\",\n\tWAITLIST_ADMIN_NOTIFICATION = \"waitlist-admin-notification\",\n\n\t// Generic\n\tGENERIC = \"generic\",\n}\n\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC;;;;;;AAED;;AAwOA,qBAAqB;AACrB,MAAM,qBAAqB,qOAAC,CAC1B,MAAM,GACN,KAAK,CAAC,yBACN,GAAG,CAAC,GAAG;AAEF,MAAM,kBAAkB,qOAAC,CAAC,MAAM,CAAC;IACvC,IAAI,qOAAC,CAAC,KAAK,CAAC;QAAC;QAAoB,qOAAC,CAAC,KAAK,CAAC;KAAoB;IAC7D,SAAS,qOAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,uBAAuB,GAAG,CAAC;IACtD,SAAS,mBAAmB,QAAQ;AACrC;AAGO,IAAA,AAAK,uCAAA;IACX,OAAO;;;;;;IAOP,OAAO;;;;;IAMP,UAAU;;;;;;;IAQV,WAAW;;;;;IAMX,OAAO;;IAGP,4BAA4B;;;IAI5B,WAAW;;;IAIX,UAAU;;WAvCC"}},
    {"offset": {"line": 996, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/pre-send-checks.ts"],"sourcesContent":["import { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\n/**\n * Pre-Send Email Deliverability Checks\n *\n * Comprehensive checks before sending any email:\n * 1. Suppression list check (bounces, complaints, unsubscribes)\n * 2. Domain verification status\n * 3. Content spam score analysis\n * 4. Reputation check\n * 5. Rate/volume considerations for warm-up\n */\n\nexport interface PreSendCheckResult {\n\tallowed: boolean;\n\twarnings: string[];\n\terrors: string[];\n\tsuggestions: string[];\n\tspamScore?: number;\n\trecipientStatus?: {\n\t\temail: string;\n\t\tsuppressed: boolean;\n\t\treason?: string;\n\t}[];\n}\n\n// Spam trigger words and patterns\nconst SPAM_TRIGGERS = {\n\turgency: [\n\t\t\"act now\",\n\t\t\"limited time\",\n\t\t\"urgent\",\n\t\t\"immediate\",\n\t\t\"expires\",\n\t\t\"hurry\",\n\t\t\"don't miss\",\n\t\t\"last chance\",\n\t\t\"final notice\",\n\t\t\"deadline\",\n\t],\n\tmoney: [\n\t\t\"free\",\n\t\t\"$$$\",\n\t\t\"cash\",\n\t\t\"discount\",\n\t\t\"save big\",\n\t\t\"best price\",\n\t\t\"cheap\",\n\t\t\"bargain\",\n\t\t\"bonus\",\n\t\t\"prize\",\n\t\t\"winner\",\n\t\t\"congratulations\",\n\t],\n\tsuspicious: [\n\t\t\"click here\",\n\t\t\"click below\",\n\t\t\"buy now\",\n\t\t\"order now\",\n\t\t\"subscribe now\",\n\t\t\"sign up free\",\n\t\t\"no obligation\",\n\t\t\"risk free\",\n\t\t\"100% free\",\n\t\t\"act immediately\",\n\t],\n\tformatting: [\n\t\t\"ALL CAPS WORDS\",\n\t\t\"!!!\",\n\t\t\"???\",\n\t\t\"$$$\",\n\t\t\"***\",\n\t\t\"###\",\n\t],\n};\n\n// Weight multipliers for spam scoring\nconst SPAM_WEIGHTS = {\n\turgency: 2,\n\tmoney: 3,\n\tsuspicious: 4,\n\tformatting: 1.5,\n\texcessiveLinks: 5,\n\tnoUnsubscribe: 3,\n\tshortContent: 2,\n\timageHeavy: 3,\n};\n\n/**\n * Check if recipient is on suppression list (bounces, complaints, unsubscribes)\n */\nexport async function checkSuppressionList(\n\tcompanyId: string,\n\trecipientEmails: string[]\n): Promise<Map<string, { suppressed: boolean; reason?: string; suppressedAt?: string }>> {\n\tconst supabase = await createServiceSupabaseClient();\n\tconst results = new Map<string, { suppressed: boolean; reason?: string; suppressedAt?: string }>();\n\n\t// Initialize all as not suppressed\n\tfor (const email of recipientEmails) {\n\t\tresults.set(email.toLowerCase(), { suppressed: false });\n\t}\n\n\t// Check suppression list\n\tconst { data: suppressions } = await supabase\n\t\t.from(\"email_suppressions\")\n\t\t.select(\"email, reason, created_at\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.in(\"email\", recipientEmails.map((e) => e.toLowerCase()));\n\n\tif (suppressions) {\n\t\tfor (const suppression of suppressions) {\n\t\t\tresults.set(suppression.email, {\n\t\t\t\tsuppressed: true,\n\t\t\t\treason: suppression.reason,\n\t\t\t\tsuppressedAt: suppression.created_at,\n\t\t\t});\n\t\t}\n\t}\n\n\t// Also check global hard bounces (cross-company)\n\tconst { data: globalBounces } = await supabase\n\t\t.from(\"email_global_bounces\")\n\t\t.select(\"email, bounce_type, created_at\")\n\t\t.in(\"email\", recipientEmails.map((e) => e.toLowerCase()))\n\t\t.eq(\"bounce_type\", \"hard\");\n\n\tif (globalBounces) {\n\t\tfor (const bounce of globalBounces) {\n\t\t\tconst existing = results.get(bounce.email);\n\t\t\tif (!existing?.suppressed) {\n\t\t\t\tresults.set(bounce.email, {\n\t\t\t\t\tsuppressed: true,\n\t\t\t\t\treason: `Global hard bounce: ${bounce.bounce_type}`,\n\t\t\t\t\tsuppressedAt: bounce.created_at,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\treturn results;\n}\n\n/**\n * Calculate spam score for email content\n * Lower is better: 0-30 = good, 30-60 = warning, 60+ = likely spam\n */\nexport function calculateSpamScore(\n\tsubject: string,\n\thtmlContent: string,\n\ttextContent: string,\n\thasUnsubscribeLink: boolean\n): { score: number; issues: string[] } {\n\tlet score = 0;\n\tconst issues: string[] = [];\n\n\tconst fullText = `${subject} ${textContent}`.toLowerCase();\n\tconst htmlLower = htmlContent.toLowerCase();\n\n\t// Check spam trigger words\n\tfor (const [category, words] of Object.entries(SPAM_TRIGGERS)) {\n\t\tconst weight = SPAM_WEIGHTS[category as keyof typeof SPAM_WEIGHTS] || 1;\n\t\tfor (const word of words) {\n\t\t\tconst regex = new RegExp(word.toLowerCase(), \"gi\");\n\t\t\tconst matches = fullText.match(regex);\n\t\t\tif (matches) {\n\t\t\t\tscore += matches.length * weight;\n\t\t\t\tif (matches.length > 1) {\n\t\t\t\t\tissues.push(`Contains \"${word}\" ${matches.length} times`);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Check for ALL CAPS in subject\n\tconst capsWords = subject.split(\" \").filter((w) => w.length > 3 && w === w.toUpperCase());\n\tif (capsWords.length > 0) {\n\t\tscore += capsWords.length * 3;\n\t\tissues.push(`Subject contains ${capsWords.length} ALL CAPS words`);\n\t}\n\n\t// Check excessive punctuation\n\tconst exclamations = (subject.match(/!/g) || []).length;\n\tif (exclamations > 1) {\n\t\tscore += exclamations * 2;\n\t\tissues.push(`Excessive exclamation marks in subject (${exclamations})`);\n\t}\n\n\t// Check link density\n\tconst links = (htmlLower.match(/<a\\s/gi) || []).length;\n\tconst wordCount = textContent.split(/\\s+/).length;\n\tif (wordCount > 0 && links / wordCount > 0.1) {\n\t\tscore += SPAM_WEIGHTS.excessiveLinks;\n\t\tissues.push(`High link density (${links} links in ${wordCount} words)`);\n\t}\n\n\t// Check image-to-text ratio\n\tconst images = (htmlLower.match(/<img\\s/gi) || []).length;\n\tif (images > 0 && textContent.length < 200) {\n\t\tscore += SPAM_WEIGHTS.imageHeavy;\n\t\tissues.push(\"Image-heavy email with little text\");\n\t}\n\n\t// Check for unsubscribe link\n\tif (!hasUnsubscribeLink) {\n\t\tscore += SPAM_WEIGHTS.noUnsubscribe;\n\t\tissues.push(\"Missing unsubscribe link (required for marketing emails)\");\n\t}\n\n\t// Check content length (very short emails look suspicious)\n\tif (textContent.length < 50) {\n\t\tscore += SPAM_WEIGHTS.shortContent;\n\t\tissues.push(\"Very short email content\");\n\t}\n\n\t// Check for suspicious patterns\n\tif (htmlLower.includes(\"display:none\") || htmlLower.includes(\"font-size:0\")) {\n\t\tscore += 10;\n\t\tissues.push(\"Contains hidden text (spam technique)\");\n\t}\n\n\t// Check for deceptive link text\n\tconst deceptiveLinkPattern = /<a[^>]*href=[\"']([^\"']+)[\"'][^>]*>([^<]+)<\\/a>/gi;\n\tlet match;\n\twhile ((match = deceptiveLinkPattern.exec(htmlContent)) !== null) {\n\t\tconst href = match[1].toLowerCase();\n\t\tconst text = match[2].toLowerCase();\n\t\tif (\n\t\t\ttext.includes(\"click here\") ||\n\t\t\ttext.includes(\"click this\") ||\n\t\t\t(text.startsWith(\"http\") && !text.includes(new URL(href).hostname))\n\t\t) {\n\t\t\tscore += 5;\n\t\t\tissues.push(\"Contains deceptive or vague link text\");\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn { score: Math.min(score, 100), issues };\n}\n\n/**\n * Check domain warm-up status and recommend volume\n */\nexport async function checkDomainWarmup(\n\tdomainId: string\n): Promise<{\n\tinWarmup: boolean;\n\tdaysSinceCreation: number;\n\trecommendedDailyLimit: number;\n\tcurrentDaySent: number;\n\tsuggestions: string[];\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data: domain } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"created_at, emails_sent_today, total_emails_sent, warmup_completed\")\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (!domain) {\n\t\treturn {\n\t\t\tinWarmup: true,\n\t\t\tdaysSinceCreation: 0,\n\t\t\trecommendedDailyLimit: 10,\n\t\t\tcurrentDaySent: 0,\n\t\t\tsuggestions: [\"Domain not found\"],\n\t\t};\n\t}\n\n\tconst createdAt = new Date(domain.created_at);\n\tconst now = new Date();\n\tconst daysSinceCreation = Math.floor((now.getTime() - createdAt.getTime()) / (1000 * 60 * 60 * 24));\n\n\t// Warm-up schedule (days -> max emails per day)\n\t// Gradual increase over 4-6 weeks for best deliverability\n\tconst warmupSchedule: Record<number, number> = {\n\t\t0: 20, // Day 0-1: 20 emails\n\t\t2: 50, // Day 2-3: 50 emails\n\t\t4: 100, // Day 4-6: 100 emails\n\t\t7: 200, // Week 2: 200 emails\n\t\t14: 500, // Week 3: 500 emails\n\t\t21: 1000, // Week 4: 1000 emails\n\t\t28: 2500, // Week 5: 2500 emails\n\t\t35: 5000, // Week 6: 5000 emails\n\t\t42: 10000, // Week 7+: 10000 emails\n\t};\n\n\tlet recommendedLimit = 20;\n\tfor (const [day, limit] of Object.entries(warmupSchedule)) {\n\t\tif (daysSinceCreation >= parseInt(day)) {\n\t\t\trecommendedLimit = limit;\n\t\t}\n\t}\n\n\tconst inWarmup = daysSinceCreation < 42 && !domain.warmup_completed;\n\tconst suggestions: string[] = [];\n\n\tif (inWarmup) {\n\t\tsuggestions.push(\n\t\t\t`Domain is in warm-up period (day ${daysSinceCreation}/42). Recommended daily limit: ${recommendedLimit} emails.`\n\t\t);\n\n\t\tif (domain.emails_sent_today >= recommendedLimit * 0.8) {\n\t\t\tsuggestions.push(\n\t\t\t\t\"Approaching daily warm-up limit. Consider spreading sends across multiple days.\"\n\t\t\t);\n\t\t}\n\t}\n\n\treturn {\n\t\tinWarmup,\n\t\tdaysSinceCreation,\n\t\trecommendedDailyLimit: recommendedLimit,\n\t\tcurrentDaySent: domain.emails_sent_today || 0,\n\t\tsuggestions,\n\t};\n}\n\n/**\n * Verify domain is properly configured for sending\n */\nexport async function verifyDomainStatus(\n\tdomainId: string\n): Promise<{\n\tcanSend: boolean;\n\tissues: string[];\n\tdnsStatus: {\n\t\tspf: boolean;\n\t\tdkim: boolean;\n\t\tdmarc: boolean;\n\t};\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data: domain } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"status, is_suspended, sending_enabled, spf_verified, dkim_verified, dmarc_verified\")\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (!domain) {\n\t\treturn {\n\t\t\tcanSend: false,\n\t\t\tissues: [\"Domain not found\"],\n\t\t\tdnsStatus: { spf: false, dkim: false, dmarc: false },\n\t\t};\n\t}\n\n\tconst issues: string[] = [];\n\n\tif (domain.status !== \"verified\") {\n\t\tissues.push(`Domain not verified (status: ${domain.status})`);\n\t}\n\n\tif (domain.is_suspended) {\n\t\tissues.push(\"Domain is suspended\");\n\t}\n\n\tif (!domain.sending_enabled) {\n\t\tissues.push(\"Sending is disabled for this domain\");\n\t}\n\n\tif (!domain.spf_verified) {\n\t\tissues.push(\"SPF record not verified - emails may fail authentication\");\n\t}\n\n\tif (!domain.dkim_verified) {\n\t\tissues.push(\"DKIM not verified - emails may fail authentication\");\n\t}\n\n\tif (!domain.dmarc_verified) {\n\t\tissues.push(\"DMARC not configured - reduces deliverability\");\n\t}\n\n\treturn {\n\t\tcanSend: issues.length === 0,\n\t\tissues,\n\t\tdnsStatus: {\n\t\t\tspf: domain.spf_verified || false,\n\t\t\tdkim: domain.dkim_verified || false,\n\t\t\tdmarc: domain.dmarc_verified || false,\n\t\t},\n\t};\n}\n\n/**\n * Comprehensive pre-send check combining all validations\n */\nexport async function runPreSendChecks(\n\tcompanyId: string,\n\tdomainId: string,\n\trecipientEmails: string[],\n\tsubject: string,\n\thtmlContent: string,\n\ttextContent: string,\n\tisMarketingEmail: boolean = false\n): Promise<PreSendCheckResult> {\n\tconst warnings: string[] = [];\n\tconst errors: string[] = [];\n\tconst suggestions: string[] = [];\n\n\t// 1. Check domain status\n\tconst domainStatus = await verifyDomainStatus(domainId);\n\tif (!domainStatus.canSend) {\n\t\terrors.push(...domainStatus.issues);\n\t} else {\n\t\t// Add warnings for missing DNS records\n\t\tif (!domainStatus.dnsStatus.dmarc) {\n\t\t\twarnings.push(\"DMARC not configured - consider adding for better deliverability\");\n\t\t}\n\t}\n\n\t// 2. Check suppression list\n\tconst suppressions = await checkSuppressionList(companyId, recipientEmails);\n\tconst recipientStatus: PreSendCheckResult[\"recipientStatus\"] = [];\n\tlet suppressedCount = 0;\n\n\tfor (const [email, status] of suppressions) {\n\t\trecipientStatus.push({\n\t\t\temail,\n\t\t\tsuppressed: status.suppressed,\n\t\t\treason: status.reason,\n\t\t});\n\t\tif (status.suppressed) {\n\t\t\tsuppressedCount++;\n\t\t}\n\t}\n\n\tif (suppressedCount > 0) {\n\t\twarnings.push(\n\t\t\t`${suppressedCount} recipient(s) on suppression list and will be skipped`\n\t\t);\n\t}\n\n\tif (suppressedCount === recipientEmails.length) {\n\t\terrors.push(\"All recipients are on suppression list - no emails will be sent\");\n\t}\n\n\t// 3. Calculate spam score\n\tconst hasUnsubscribe =\n\t\thtmlContent.includes(\"unsubscribe\") ||\n\t\thtmlContent.includes(\"List-Unsubscribe\");\n\tconst spamAnalysis = calculateSpamScore(\n\t\tsubject,\n\t\thtmlContent,\n\t\ttextContent,\n\t\thasUnsubscribe || !isMarketingEmail\n\t);\n\n\tif (spamAnalysis.score >= 60) {\n\t\terrors.push(\n\t\t\t`High spam score (${spamAnalysis.score}/100) - email likely to be filtered`\n\t\t);\n\t\terrors.push(...spamAnalysis.issues);\n\t} else if (spamAnalysis.score >= 30) {\n\t\twarnings.push(\n\t\t\t`Moderate spam score (${spamAnalysis.score}/100) - consider improvements`\n\t\t);\n\t\twarnings.push(...spamAnalysis.issues);\n\t}\n\n\t// 4. Check warm-up status\n\tconst warmupStatus = await checkDomainWarmup(domainId);\n\tif (warmupStatus.inWarmup) {\n\t\tsuggestions.push(...warmupStatus.suggestions);\n\n\t\tconst activeRecipients = recipientEmails.length - suppressedCount;\n\t\tconst remainingCapacity =\n\t\t\twarmupStatus.recommendedDailyLimit - warmupStatus.currentDaySent;\n\n\t\tif (activeRecipients > remainingCapacity) {\n\t\t\twarnings.push(\n\t\t\t\t`Sending ${activeRecipients} emails exceeds warm-up limit (${remainingCapacity} remaining today). ` +\n\t\t\t\t\t`Consider sending over multiple days.`\n\t\t\t);\n\t\t}\n\t}\n\n\t// 5. Content-specific suggestions\n\tif (!htmlContent.includes(\"<!DOCTYPE\") && !htmlContent.includes(\"<html\")) {\n\t\tsuggestions.push(\n\t\t\t\"Consider using proper HTML structure with DOCTYPE for better rendering\"\n\t\t);\n\t}\n\n\tif (textContent.length < 100) {\n\t\tsuggestions.push(\n\t\t\t\"Consider adding more text content - very short emails may look suspicious\"\n\t\t);\n\t}\n\n\tif (isMarketingEmail && !hasUnsubscribe) {\n\t\terrors.push(\n\t\t\t\"Marketing emails MUST include an unsubscribe link (CAN-SPAM requirement)\"\n\t\t);\n\t}\n\n\t// Check for personalization\n\tif (\n\t\t!htmlContent.includes(\"{{\") &&\n\t\t!htmlContent.includes(\"{name}\") &&\n\t\t!subject.includes(\"{{\")\n\t) {\n\t\tsuggestions.push(\n\t\t\t\"Consider adding personalization (recipient name, company) for better engagement\"\n\t\t);\n\t}\n\n\treturn {\n\t\tallowed: errors.length === 0,\n\t\twarnings,\n\t\terrors,\n\t\tsuggestions,\n\t\tspamScore: spamAnalysis.score,\n\t\trecipientStatus,\n\t};\n}\n\n/**\n * Add email to suppression list\n */\nexport async function addToSuppressionList(\n\tcompanyId: string,\n\temail: string,\n\treason: \"bounce\" | \"complaint\" | \"unsubscribe\" | \"manual\",\n\tdetails?: string\n): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase.from(\"email_suppressions\").upsert(\n\t\t{\n\t\t\tcompany_id: companyId,\n\t\t\temail: email.toLowerCase(),\n\t\t\treason,\n\t\t\tdetails,\n\t\t\tcreated_at: new Date().toISOString(),\n\t\t},\n\t\t{\n\t\t\tonConflict: \"company_id,email\",\n\t\t}\n\t);\n\n\tif (error) {\n\t\tconsole.error(\"Error adding to suppression list:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Add email to global bounce list (cross-company hard bounces)\n */\nexport async function addToGlobalBounceList(\n\temail: string,\n\tbounceType: \"hard\" | \"soft\",\n\tbounceReason?: string\n): Promise<{ success: boolean; error?: string }> {\n\t// Only track hard bounces globally\n\tif (bounceType !== \"hard\") {\n\t\treturn { success: true };\n\t}\n\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase.from(\"email_global_bounces\").upsert(\n\t\t{\n\t\t\temail: email.toLowerCase(),\n\t\t\tbounce_type: bounceType,\n\t\t\tbounce_reason: bounceReason,\n\t\t\tbounce_count: 1,\n\t\t\tlast_bounce_at: new Date().toISOString(),\n\t\t\tcreated_at: new Date().toISOString(),\n\t\t},\n\t\t{\n\t\t\tonConflict: \"email\",\n\t\t}\n\t);\n\n\tif (error) {\n\t\tconsole.error(\"Error adding to global bounce list:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Remove email from suppression list (for manual review cases)\n */\nexport async function removeFromSuppressionList(\n\tcompanyId: string,\n\temail: string\n): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase\n\t\t.from(\"email_suppressions\")\n\t\t.delete()\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"email\", email.toLowerCase());\n\n\tif (error) {\n\t\tconsole.error(\"Error removing from suppression list:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Get suppression list for a company\n */\nexport async function getSuppressionList(\n\tcompanyId: string,\n\tlimit: number = 100,\n\toffset: number = 0\n): Promise<{\n\tdata: Array<{\n\t\temail: string;\n\t\treason: string;\n\t\tdetails?: string;\n\t\tcreated_at: string;\n\t}>;\n\ttotal: number;\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data, count, error } = await supabase\n\t\t.from(\"email_suppressions\")\n\t\t.select(\"email, reason, details, created_at\", { count: \"exact\" })\n\t\t.eq(\"company_id\", companyId)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.range(offset, offset + limit - 1);\n\n\tif (error) {\n\t\tconsole.error(\"Error fetching suppression list:\", error);\n\t\treturn { data: [], total: 0 };\n\t}\n\n\treturn { data: data || [], total: count || 0 };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1452, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/rate-limiter.ts"],"sourcesContent":["/**\n * Email Rate Limiter\n *\n * Implements per-domain rate limiting for email sending to:\n * - Prevent spam/abuse\n * - Protect domain reputation\n * - Enforce plan-based limits\n * - Track daily/hourly email quotas\n */\n\n\"use server\";\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface RateLimitResult {\n\tallowed: boolean;\n\treason?: string;\n\tremaining?: number;\n\tresetAt?: string;\n}\n\nexport interface ActiveDomainInfo {\n\tdomainId: string;\n\tdomain: string;\n\treplyToEmail: string | null;\n\tdailyLimit: number;\n\thourlyLimit: number;\n\temailsSentToday: number;\n\temailsSentThisHour: number;\n}\n\n// =============================================================================\n// RATE LIMIT CONFIGURATION\n// =============================================================================\n\n// Default rate limits (can be overridden per domain/plan)\nconst DEFAULT_LIMITS = {\n\tdaily: 1000, // 1000 emails per day per domain\n\thourly: 100, // 100 emails per hour per domain\n\tperMinute: 10, // 10 emails per minute per domain\n};\n\n// In-memory cache for rate limit tracking (resets on server restart)\n// For production, use Redis or database counters\nconst rateLimitCache = new Map<\n\tstring,\n\t{\n\t\tcount: number;\n\t\twindowStart: number;\n\t}\n>();\n\n// =============================================================================\n// PUBLIC API\n// =============================================================================\n\n/**\n * Get the active email domain for a company\n *\n * Returns the verified, sending-enabled domain for the company,\n * prioritizing custom domains over platform subdomains.\n */\nexport async function getCompanyActiveDomain(\n\tcompanyId: string\n): Promise<ActiveDomainInfo | null> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Query for the active sending domain\n\tconst { data: domain, error } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\n\t\t\t`\n\t\t\tid,\n\t\t\tdomain_name,\n\t\t\treply_to_email,\n\t\t\tdaily_limit,\n\t\t\thourly_limit,\n\t\t\temails_sent_today,\n\t\t\temails_sent_this_hour,\n\t\t\tis_platform_subdomain\n\t\t`\n\t\t)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"verified\")\n\t\t.eq(\"sending_enabled\", true)\n\t\t.eq(\"is_suspended\", false)\n\t\t.order(\"is_platform_subdomain\", { ascending: true }) // Custom domains first\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.maybeSingle();\n\n\tif (error) {\n\t\tconsole.error(\"Error fetching company email domain:\", error);\n\t\treturn null;\n\t}\n\n\tif (!domain) {\n\t\treturn null;\n\t}\n\n\treturn {\n\t\tdomainId: domain.id,\n\t\tdomain: domain.domain_name,\n\t\treplyToEmail: domain.reply_to_email,\n\t\tdailyLimit: domain.daily_limit || DEFAULT_LIMITS.daily,\n\t\thourlyLimit: domain.hourly_limit || DEFAULT_LIMITS.hourly,\n\t\temailsSentToday: domain.emails_sent_today || 0,\n\t\temailsSentThisHour: domain.emails_sent_this_hour || 0,\n\t};\n}\n\n/**\n * Check if a domain has exceeded its rate limit\n *\n * This is a non-blocking check that doesn't increment counters.\n * Use incrementEmailCounter after successfully sending.\n */\nexport async function checkRateLimit(domainId: string): Promise<RateLimitResult> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Get current domain stats\n\tconst { data: domain, error } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\n\t\t\t`\n\t\t\tdaily_limit,\n\t\t\thourly_limit,\n\t\t\temails_sent_today,\n\t\t\temails_sent_this_hour,\n\t\t\tis_suspended,\n\t\t\tdaily_limit_reset_at,\n\t\t\thourly_limit_reset_at\n\t\t`\n\t\t)\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (error || !domain) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Domain not found or error fetching limits\",\n\t\t};\n\t}\n\n\t// Check if domain is suspended\n\tif (domain.is_suspended) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Domain is suspended due to reputation issues\",\n\t\t};\n\t}\n\n\tconst dailyLimit = domain.daily_limit || DEFAULT_LIMITS.daily;\n\tconst hourlyLimit = domain.hourly_limit || DEFAULT_LIMITS.hourly;\n\tconst emailsSentToday = domain.emails_sent_today || 0;\n\tconst emailsSentThisHour = domain.emails_sent_this_hour || 0;\n\n\t// Check daily limit\n\tif (emailsSentToday >= dailyLimit) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: `Daily email limit reached (${dailyLimit} emails/day)`,\n\t\t\tremaining: 0,\n\t\t\tresetAt: domain.daily_limit_reset_at || getNextMidnightUTC(),\n\t\t};\n\t}\n\n\t// Check hourly limit\n\tif (emailsSentThisHour >= hourlyLimit) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: `Hourly email limit reached (${hourlyLimit} emails/hour)`,\n\t\t\tremaining: 0,\n\t\t\tresetAt: domain.hourly_limit_reset_at || getNextHourUTC(),\n\t\t};\n\t}\n\n\t// Check per-minute limit (in-memory)\n\tconst minuteKey = `${domainId}:minute`;\n\tconst minuteWindow = getMinuteWindow();\n\tconst minuteCache = rateLimitCache.get(minuteKey);\n\n\tif (minuteCache && minuteCache.windowStart === minuteWindow) {\n\t\tif (minuteCache.count >= DEFAULT_LIMITS.perMinute) {\n\t\t\treturn {\n\t\t\t\tallowed: false,\n\t\t\t\treason: `Rate limit: Too many emails per minute (${DEFAULT_LIMITS.perMinute}/min)`,\n\t\t\t\tremaining: 0,\n\t\t\t};\n\t\t}\n\t}\n\n\treturn {\n\t\tallowed: true,\n\t\tremaining: Math.min(dailyLimit - emailsSentToday, hourlyLimit - emailsSentThisHour),\n\t};\n}\n\n/**\n * Increment the email counter after successfully sending\n *\n * This atomically increments the counters and validates limits.\n * Should be called after checkRateLimit and before actually sending.\n */\nexport async function incrementEmailCounter(\n\tdomainId: string\n): Promise<RateLimitResult> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Use a database function for atomic increment and validation\n\t// This prevents race conditions in high-concurrency scenarios\n\tconst { data, error } = await supabase.rpc(\"increment_email_counter\", {\n\t\tp_domain_id: domainId,\n\t});\n\n\tif (error) {\n\t\t// If the RPC doesn't exist, fall back to manual increment\n\t\tif (error.code === \"PGRST202\" || error.message.includes(\"function\")) {\n\t\t\treturn await incrementEmailCounterFallback(domainId);\n\t\t}\n\n\t\tconsole.error(\"Error incrementing email counter:\", error);\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: error.message,\n\t\t};\n\t}\n\n\t// Handle RPC result\n\tif (data && typeof data === \"object\") {\n\t\tconst result = data as { allowed: boolean; reason?: string; remaining?: number };\n\t\treturn {\n\t\t\tallowed: result.allowed,\n\t\t\treason: result.reason,\n\t\t\tremaining: result.remaining,\n\t\t};\n\t}\n\n\t// Default: allowed if no error\n\treturn { allowed: true };\n}\n\n// =============================================================================\n// HELPER FUNCTIONS\n// =============================================================================\n\n/**\n * Fallback increment method when RPC function doesn't exist\n */\nasync function incrementEmailCounterFallback(\n\tdomainId: string\n): Promise<RateLimitResult> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\t// Get current counts\n\tconst { data: domain, error: fetchError } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"emails_sent_today, emails_sent_this_hour, daily_limit, hourly_limit\")\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (fetchError || !domain) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Domain not found\",\n\t\t};\n\t}\n\n\tconst dailyLimit = domain.daily_limit || DEFAULT_LIMITS.daily;\n\tconst hourlyLimit = domain.hourly_limit || DEFAULT_LIMITS.hourly;\n\n\t// Check limits before incrementing\n\tif ((domain.emails_sent_today || 0) >= dailyLimit) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Daily limit reached\",\n\t\t};\n\t}\n\n\tif ((domain.emails_sent_this_hour || 0) >= hourlyLimit) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Hourly limit reached\",\n\t\t};\n\t}\n\n\t// Increment counters\n\tconst { error: updateError } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.update({\n\t\t\temails_sent_today: (domain.emails_sent_today || 0) + 1,\n\t\t\temails_sent_this_hour: (domain.emails_sent_this_hour || 0) + 1,\n\t\t})\n\t\t.eq(\"id\", domainId);\n\n\tif (updateError) {\n\t\tconsole.error(\"Error updating email counters:\", updateError);\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: updateError.message,\n\t\t};\n\t}\n\n\t// Update in-memory per-minute counter\n\tconst minuteKey = `${domainId}:minute`;\n\tconst minuteWindow = getMinuteWindow();\n\tconst minuteCache = rateLimitCache.get(minuteKey);\n\n\tif (minuteCache && minuteCache.windowStart === minuteWindow) {\n\t\tminuteCache.count++;\n\t} else {\n\t\trateLimitCache.set(minuteKey, {\n\t\t\tcount: 1,\n\t\t\twindowStart: minuteWindow,\n\t\t});\n\t}\n\n\treturn {\n\t\tallowed: true,\n\t\tremaining: Math.min(\n\t\t\tdailyLimit - (domain.emails_sent_today || 0) - 1,\n\t\t\thourlyLimit - (domain.emails_sent_this_hour || 0) - 1\n\t\t),\n\t};\n}\n\n/**\n * Get the current minute window (for per-minute rate limiting)\n */\nfunction getMinuteWindow(): number {\n\treturn Math.floor(Date.now() / 60000);\n}\n\n/**\n * Get the next midnight UTC timestamp\n */\nfunction getNextMidnightUTC(): string {\n\tconst now = new Date();\n\tconst tomorrow = new Date(now);\n\ttomorrow.setUTCDate(tomorrow.getUTCDate() + 1);\n\ttomorrow.setUTCHours(0, 0, 0, 0);\n\treturn tomorrow.toISOString();\n}\n\n/**\n * Get the next hour UTC timestamp\n */\nfunction getNextHourUTC(): string {\n\tconst now = new Date();\n\tconst nextHour = new Date(now);\n\tnextHour.setUTCHours(nextHour.getUTCHours() + 1, 0, 0, 0);\n\treturn nextHour.toISOString();\n}\n\n// =============================================================================\n// RESET FUNCTIONS (for cron jobs)\n// =============================================================================\n\n/**\n * Reset daily email counters (should be called by cron at midnight UTC)\n */\nexport async function resetDailyCounters(): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.update({\n\t\t\temails_sent_today: 0,\n\t\t\tdaily_limit_reset_at: getNextMidnightUTC(),\n\t\t})\n\t\t.neq(\"id\", \"\"); // Update all rows\n\n\tif (error) {\n\t\tconsole.error(\"Error resetting daily counters:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Reset hourly email counters (should be called by cron every hour)\n */\nexport async function resetHourlyCounters(): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.update({\n\t\t\temails_sent_this_hour: 0,\n\t\t\thourly_limit_reset_at: getNextHourUTC(),\n\t\t})\n\t\t.neq(\"id\", \"\"); // Update all rows\n\n\tif (error) {\n\t\tconsole.error(\"Error resetting hourly counters:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1759, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/resend-client.ts"],"sourcesContent":["/**\n * Resend Client - Email Service Configuration\n *\n * Features:\n * - Singleton Resend client instance\n * - Environment-based configuration\n * - Type-safe email sending\n * - Development mode support (logs instead of sending)\n */\n\nimport { Resend } from \"resend\";\n\nconst requiredSiteUrl = process.env.NEXT_PUBLIC_SITE_URL;\nif (!requiredSiteUrl) {\n\tthrow new Error(\"NEXT_PUBLIC_SITE_URL is not configured\");\n}\n\n// Initialize Resend client\nexport const resend = process.env.RESEND_API_KEY\n\t? new Resend(process.env.RESEND_API_KEY)\n\t: null;\n\n// Email configuration\nexport const emailConfig = {\n\tfrom: `${process.env.RESEND_FROM_NAME || \"Thorbis\"} <${process.env.RESEND_FROM_EMAIL || \"noreply@thorbis.com\"}>`,\n\t// Enable production mode if RESEND_API_KEY is configured, even in development\n\tisDevelopment:\n\t\t!process.env.RESEND_API_KEY ||\n\t\t(process.env.NODE_ENV === \"development\" && !process.env.RESEND_API_KEY),\n\tsiteUrl: requiredSiteUrl,\n\tappUrl: process.env.NEXT_PUBLIC_APP_URL || requiredSiteUrl,\n};\n\n// Check if Resend is properly configured\nexport function isResendConfigured(): boolean {\n\tif (!resend) {\n\t\treturn false;\n\t}\n\treturn true;\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC;;;;;;;;AAED;;AAEA,MAAM;AACN;;AAKO,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc,GAC7C,IAAI,iUAAM,CAAC,QAAQ,GAAG,CAAC,cAAc,IACrC;AAGI,MAAM,cAAc;IAC1B,MAAM,GAAG,QAAQ,GAAG,CAAC,gBAAgB,IAAI,UAAU,EAAE,EAAE,QAAQ,GAAG,CAAC,iBAAiB,IAAI,sBAAsB,CAAC,CAAC;IAChH,8EAA8E;IAC9E,eACC,CAAC,QAAQ,GAAG,CAAC,cAAc,IAC1B,oDAAyB,iBAAiB,CAAC,QAAQ,GAAG,CAAC,cAAc;IACvE,SAAS;IACT,QAAQ,6DAAmC;AAC5C;AAGO,SAAS;IACf,IAAI,CAAC,QAAQ;QACZ,OAAO;IACR;IACA,OAAO;AACR"}},
    {"offset": {"line": 1798, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/postmark-client.ts"],"sourcesContent":["/**\n * Postmark Email Client\n *\n * This module provides integration with Postmark as a fallback email provider.\n * Postmark is known for excellent deliverability and is used when Resend fails.\n *\n * Features:\n * - Email sending with automatic retry\n * - Domain/sender signature management\n * - Webhook signature verification\n * - Delivery status tracking\n *\n * Environment Variables Required:\n * - POSTMARK_API_KEY: Your Postmark server API token\n * - POSTMARK_WEBHOOK_SECRET: Secret for verifying webhook signatures (optional)\n *\n * @see https://postmarkapp.com/developer\n */\n\nimport crypto from \"node:crypto\";\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nconst POSTMARK_API_BASE = \"https://api.postmarkapp.com\";\n\n/**\n * Postmark client configuration\n * Checks environment variables and provides defaults\n */\nexport const postmarkConfig = {\n\tapiKey: process.env.POSTMARK_API_KEY || \"\",\n\twebhookSecret: process.env.POSTMARK_WEBHOOK_SECRET || \"\",\n\t// Default \"from\" address for Postmark (must be verified sender signature)\n\tfrom: process.env.POSTMARK_FROM_EMAIL || process.env.EMAIL_FROM || \"notifications@stratos.app\",\n\t// Is Postmark configured and ready to use?\n\tisConfigured: !!process.env.POSTMARK_API_KEY,\n\t// Provider name for logging/monitoring\n\tproviderName: \"postmark\" as const,\n};\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Standard response wrapper for Postmark API calls\n * Matches the pattern used by Resend for consistency\n */\nexport type PostmarkResponse<T> =\n\t| { success: true; data: T }\n\t| { success: false; error: string; errorCode?: number };\n\n/**\n * Postmark email send request\n * @see https://postmarkapp.com/developer/api/email-api\n */\nexport interface PostmarkSendRequest {\n\tFrom: string;\n\tTo: string;\n\tSubject: string;\n\tHtmlBody?: string;\n\tTextBody?: string;\n\tReplyTo?: string;\n\tTag?: string;\n\tTrackOpens?: boolean;\n\tTrackLinks?: \"None\" | \"HtmlAndText\" | \"HtmlOnly\" | \"TextOnly\";\n\tMessageStream?: string;\n\tMetadata?: Record<string, string>;\n}\n\n/**\n * Postmark email send response\n */\nexport interface PostmarkSendResponse {\n\tTo: string;\n\tSubmittedAt: string;\n\tMessageID: string;\n\tErrorCode: number;\n\tMessage: string;\n}\n\n/**\n * Postmark domain (sender signature) data\n * @see https://postmarkapp.com/developer/api/signatures-api\n */\nexport interface PostmarkDomainData {\n\tID: number;\n\tDomain: string;\n\tEmailAddress: string;\n\tReplyToEmailAddress: string;\n\tName: string;\n\tConfirmed: boolean;\n\tSPFVerified: boolean;\n\tSPFHost: string;\n\tSPFTextValue: string;\n\tDKIMVerified: boolean;\n\tWeakDKIM: boolean;\n\tDKIMHost: string;\n\tDKIMTextValue: string;\n\tDKIMPendingHost: string;\n\tDKIMPendingTextValue: string;\n\tDKIMRevokedHost: string;\n\tDKIMRevokedTextValue: string;\n\tSafeToRemoveRevokedKeyFromDNS: boolean;\n\tDKIMUpdateStatus: string;\n\tReturnPathDomain: string;\n\tReturnPathDomainCNAMEValue: string;\n\tReturnPathDomainVerified: boolean;\n}\n\n/**\n * Postmark webhook event types\n */\nexport type PostmarkWebhookEventType =\n\t| \"Delivery\"\n\t| \"Bounce\"\n\t| \"SpamComplaint\"\n\t| \"Open\"\n\t| \"Click\"\n\t| \"SubscriptionChange\";\n\n/**\n * Postmark webhook payload base\n */\nexport interface PostmarkWebhookPayload {\n\tRecordType: PostmarkWebhookEventType;\n\tMessageID: string;\n\tRecipient: string;\n\tTag: string;\n\tDeliveredAt?: string;\n\tBouncedAt?: string;\n\tType?: string; // Bounce type\n\tTypeCode?: number;\n\tDescription?: string;\n\tDetails?: string;\n\tEmail?: string;\n\tFrom?: string;\n\tSubject?: string;\n\tMetadata?: Record<string, string>;\n}\n\n// =============================================================================\n// API REQUEST HELPER\n// =============================================================================\n\n/**\n * Makes authenticated requests to Postmark API\n *\n * @param path - API endpoint path (e.g., \"/email\")\n * @param init - Fetch request options\n * @returns Typed response with success/error handling\n *\n * @example\n * const result = await postmarkRequest<PostmarkSendResponse>(\"/email\", {\n *   method: \"POST\",\n *   body: JSON.stringify(emailData),\n * });\n */\nasync function postmarkRequest<T>(\n\tpath: string,\n\tinit: RequestInit\n): Promise<PostmarkResponse<T>> {\n\t// Check if Postmark is configured\n\tif (!postmarkConfig.apiKey) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Postmark API key is not configured. Set POSTMARK_API_KEY environment variable.\",\n\t\t};\n\t}\n\n\ttry {\n\t\tconst response = await fetch(`${POSTMARK_API_BASE}${path}`, {\n\t\t\t...init,\n\t\t\theaders: {\n\t\t\t\t// Postmark uses X-Postmark-Server-Token for authentication\n\t\t\t\t\"X-Postmark-Server-Token\": postmarkConfig.apiKey,\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\tAccept: \"application/json\",\n\t\t\t\t...init.headers,\n\t\t\t},\n\t\t});\n\n\t\t// Parse response body\n\t\tconst body = await response.json().catch(() => ({}));\n\n\t\t// Handle non-OK responses\n\t\tif (!response.ok) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: body.Message || body.message || response.statusText,\n\t\t\t\terrorCode: body.ErrorCode,\n\t\t\t};\n\t\t}\n\n\t\treturn { success: true, data: body as T };\n\t} catch (error) {\n\t\t// Network or parsing error\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Postmark request failed\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// EMAIL SENDING\n// =============================================================================\n\n/**\n * Send an email via Postmark\n *\n * This is the primary email sending function for Postmark.\n * It handles HTML emails with optional tracking.\n *\n * @param options - Email send options\n * @returns Send result with MessageID on success\n *\n * @example\n * const result = await sendPostmarkEmail({\n *   to: \"user@example.com\",\n *   subject: \"Welcome!\",\n *   html: \"<h1>Hello</h1>\",\n *   from: \"hello@mycompany.com\",\n *   tags: { template: \"welcome\" },\n * });\n */\nexport async function sendPostmarkEmail(options: {\n\tto: string | string[];\n\tsubject: string;\n\thtml: string;\n\ttext?: string;\n\tfrom?: string;\n\treplyTo?: string;\n\ttag?: string;\n\ttrackOpens?: boolean;\n\ttrackLinks?: boolean;\n\tmetadata?: Record<string, string>;\n\tmessageStream?: string;\n}): Promise<PostmarkResponse<PostmarkSendResponse>> {\n\tconst {\n\t\tto,\n\t\tsubject,\n\t\thtml,\n\t\ttext,\n\t\tfrom = postmarkConfig.from,\n\t\treplyTo,\n\t\ttag,\n\t\ttrackOpens = true,\n\t\ttrackLinks = true,\n\t\tmetadata,\n\t\tmessageStream = \"outbound\", // Default message stream\n\t} = options;\n\n\t// Postmark requires single recipient per request for /email endpoint\n\t// For multiple recipients, we'd use /email/batch\n\tconst recipient = Array.isArray(to) ? to.join(\", \") : to;\n\n\tconst request: PostmarkSendRequest = {\n\t\tFrom: from,\n\t\tTo: recipient,\n\t\tSubject: subject,\n\t\tHtmlBody: html,\n\t\tTextBody: text,\n\t\tReplyTo: replyTo,\n\t\tTag: tag,\n\t\tTrackOpens: trackOpens,\n\t\tTrackLinks: trackLinks ? \"HtmlAndText\" : \"None\",\n\t\tMessageStream: messageStream,\n\t\tMetadata: metadata,\n\t};\n\n\t// Log send attempt for monitoring\n\tconsole.log(`[Postmark] Sending email to ${recipient}, subject: \"${subject}\"`);\n\n\tconst result = await postmarkRequest<PostmarkSendResponse>(\"/email\", {\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify(request),\n\t});\n\n\t// Log result for monitoring\n\tif (result.success) {\n\t\tconsole.log(`[Postmark] Email sent successfully, MessageID: ${result.data.MessageID}`);\n\t} else {\n\t\tconsole.error(`[Postmark] Email send failed: ${result.error}`);\n\t}\n\n\treturn result;\n}\n\n/**\n * Send batch emails via Postmark (up to 500 per request)\n *\n * @param emails - Array of email options\n * @returns Array of send results\n */\nexport async function sendPostmarkBatchEmails(\n\temails: Array<{\n\t\tto: string;\n\t\tsubject: string;\n\t\thtml: string;\n\t\ttext?: string;\n\t\tfrom?: string;\n\t\treplyTo?: string;\n\t\ttag?: string;\n\t\tmetadata?: Record<string, string>;\n\t}>\n): Promise<PostmarkResponse<PostmarkSendResponse[]>> {\n\tif (emails.length > 500) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Postmark batch limit is 500 emails per request\",\n\t\t};\n\t}\n\n\tconst requests: PostmarkSendRequest[] = emails.map((email) => ({\n\t\tFrom: email.from || postmarkConfig.from,\n\t\tTo: email.to,\n\t\tSubject: email.subject,\n\t\tHtmlBody: email.html,\n\t\tTextBody: email.text,\n\t\tReplyTo: email.replyTo,\n\t\tTag: email.tag,\n\t\tTrackOpens: true,\n\t\tTrackLinks: \"HtmlAndText\",\n\t\tMetadata: email.metadata,\n\t}));\n\n\tconsole.log(`[Postmark] Sending batch of ${emails.length} emails`);\n\n\treturn postmarkRequest<PostmarkSendResponse[]>(\"/email/batch\", {\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify(requests),\n\t});\n}\n\n// =============================================================================\n// DOMAIN/SENDER SIGNATURE MANAGEMENT\n// =============================================================================\n\n/**\n * List all sender signatures (domains) in Postmark\n *\n * @returns List of sender signatures\n */\nexport async function listPostmarkDomains(): Promise<\n\tPostmarkResponse<{ TotalCount: number; SenderSignatures: PostmarkDomainData[] }>\n> {\n\tconsole.log(\"[Postmark] Listing sender signatures\");\n\treturn postmarkRequest(\"/senders\", { method: \"GET\" });\n}\n\n/**\n * Get details of a specific sender signature\n *\n * @param signatureId - Postmark sender signature ID\n * @returns Sender signature details\n */\nexport async function getPostmarkDomain(\n\tsignatureId: number\n): Promise<PostmarkResponse<PostmarkDomainData>> {\n\tconsole.log(`[Postmark] Getting sender signature ${signatureId}`);\n\treturn postmarkRequest(`/senders/${signatureId}`, { method: \"GET\" });\n}\n\n/**\n * Create a new sender signature in Postmark\n *\n * Note: Postmark uses \"sender signatures\" which can be either:\n * - Individual email addresses\n * - Entire domains\n *\n * @param options - Sender signature options\n * @returns Created sender signature\n */\nexport async function createPostmarkDomain(options: {\n\tfromEmail: string;\n\tname: string;\n\treplyToEmail?: string;\n}): Promise<PostmarkResponse<PostmarkDomainData>> {\n\tconst { fromEmail, name, replyToEmail } = options;\n\n\tconsole.log(`[Postmark] Creating sender signature for ${fromEmail}`);\n\n\treturn postmarkRequest(\"/senders\", {\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify({\n\t\t\tFromEmail: fromEmail,\n\t\t\tName: name,\n\t\t\tReplyToEmail: replyToEmail || fromEmail,\n\t\t}),\n\t});\n}\n\n/**\n * Delete a sender signature from Postmark\n *\n * @param signatureId - Postmark sender signature ID\n * @returns Deletion result\n */\nexport async function deletePostmarkDomain(\n\tsignatureId: number\n): Promise<PostmarkResponse<{ Message: string }>> {\n\tconsole.log(`[Postmark] Deleting sender signature ${signatureId}`);\n\treturn postmarkRequest(`/senders/${signatureId}`, { method: \"DELETE\" });\n}\n\n/**\n * Resend confirmation email for a sender signature\n *\n * @param signatureId - Postmark sender signature ID\n * @returns Resend result\n */\nexport async function resendPostmarkConfirmation(\n\tsignatureId: number\n): Promise<PostmarkResponse<{ Message: string }>> {\n\tconsole.log(`[Postmark] Resending confirmation for signature ${signatureId}`);\n\treturn postmarkRequest(`/senders/${signatureId}/resend`, { method: \"POST\" });\n}\n\n/**\n * Verify DKIM for a sender signature\n * Triggers Postmark to check DNS records\n *\n * @param signatureId - Postmark sender signature ID\n * @returns Updated sender signature with verification status\n */\nexport async function verifyPostmarkDKIM(\n\tsignatureId: number\n): Promise<PostmarkResponse<PostmarkDomainData>> {\n\tconsole.log(`[Postmark] Verifying DKIM for signature ${signatureId}`);\n\treturn postmarkRequest(`/senders/${signatureId}/verifyDkim`, { method: \"PUT\" });\n}\n\n/**\n * Verify Return-Path for a sender signature\n *\n * @param signatureId - Postmark sender signature ID\n * @returns Updated sender signature with verification status\n */\nexport async function verifyPostmarkReturnPath(\n\tsignatureId: number\n): Promise<PostmarkResponse<PostmarkDomainData>> {\n\tconsole.log(`[Postmark] Verifying Return-Path for signature ${signatureId}`);\n\treturn postmarkRequest(`/senders/${signatureId}/verifyReturnPath`, { method: \"PUT\" });\n}\n\n// =============================================================================\n// SERVER/ACCOUNT INFO\n// =============================================================================\n\n/**\n * Get Postmark server information\n * Useful for verifying API key and getting server settings\n *\n * @returns Server information\n */\nexport async function getPostmarkServerInfo(): Promise<\n\tPostmarkResponse<{\n\t\tID: number;\n\t\tName: string;\n\t\tApiTokens: string[];\n\t\tColor: string;\n\t\tSmtpApiActivated: boolean;\n\t\tRawEmailEnabled: boolean;\n\t\tInboundAddress: string;\n\t\tInboundHookUrl: string;\n\t\tBounceHookUrl: string;\n\t\tOpenHookUrl: string;\n\t\tPostFirstOpenOnly: boolean;\n\t\tTrackOpens: boolean;\n\t\tTrackLinks: string;\n\t\tInboundDomain: string;\n\t\tInboundSpamThreshold: number;\n\t}>\n> {\n\tconsole.log(\"[Postmark] Getting server info\");\n\treturn postmarkRequest(\"/server\", { method: \"GET\" });\n}\n\n// =============================================================================\n// WEBHOOK VERIFICATION\n// =============================================================================\n\n/**\n * Verify Postmark webhook signature\n *\n * Postmark webhooks don't use signatures by default, but you can configure\n * basic auth or use the webhook token. This function verifies the token\n * if POSTMARK_WEBHOOK_SECRET is configured.\n *\n * @param options - Webhook verification options\n * @returns Whether the webhook is valid\n *\n * @example\n * const isValid = verifyPostmarkWebhook({\n *   payload: requestBody,\n *   token: request.headers.get(\"X-Postmark-Token\"),\n * });\n */\nexport function verifyPostmarkWebhook(options: {\n\tpayload: string;\n\ttoken?: string | null;\n}): boolean {\n\tconst { token } = options;\n\n\t// If no secret configured, accept all webhooks (not recommended for production)\n\tif (!postmarkConfig.webhookSecret) {\n\t\tconsole.warn(\"[Postmark] No webhook secret configured - accepting webhook without verification\");\n\t\treturn true;\n\t}\n\n\t// Verify the token matches our secret\n\tif (!token) {\n\t\tconsole.error(\"[Postmark] Webhook missing token\");\n\t\treturn false;\n\t}\n\n\t// Use timing-safe comparison to prevent timing attacks\n\ttry {\n\t\tconst expected = Buffer.from(postmarkConfig.webhookSecret);\n\t\tconst received = Buffer.from(token);\n\n\t\tif (expected.length !== received.length) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn crypto.timingSafeEqual(expected, received);\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n// =============================================================================\n// HEALTH CHECK\n// =============================================================================\n\n/**\n * Check if Postmark is healthy and responsive\n *\n * This function attempts to fetch server info to verify:\n * 1. API key is valid\n * 2. Postmark API is reachable\n * 3. Account is in good standing\n *\n * @returns Health check result\n */\nexport async function checkPostmarkHealth(): Promise<{\n\thealthy: boolean;\n\tprovider: \"postmark\";\n\tlatencyMs: number;\n\terror?: string;\n}> {\n\tconst startTime = Date.now();\n\n\ttry {\n\t\tconst result = await getPostmarkServerInfo();\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tif (result.success) {\n\t\t\tconsole.log(`[Postmark] Health check passed in ${latencyMs}ms`);\n\t\t\treturn {\n\t\t\t\thealthy: true,\n\t\t\t\tprovider: \"postmark\",\n\t\t\t\tlatencyMs,\n\t\t\t};\n\t\t}\n\n\t\tconsole.error(`[Postmark] Health check failed: ${result.error}`);\n\t\treturn {\n\t\t\thealthy: false,\n\t\t\tprovider: \"postmark\",\n\t\t\tlatencyMs,\n\t\t\terror: result.error,\n\t\t};\n\t} catch (error) {\n\t\tconst latencyMs = Date.now() - startTime;\n\t\tconst errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n\n\t\tconsole.error(`[Postmark] Health check error: ${errorMessage}`);\n\t\treturn {\n\t\t\thealthy: false,\n\t\t\tprovider: \"postmark\",\n\t\t\tlatencyMs,\n\t\t\terror: errorMessage,\n\t\t};\n\t}\n}\n\n// =============================================================================\n// UTILITY FUNCTIONS\n// =============================================================================\n\n/**\n * Check if Postmark is properly configured\n *\n * @returns Whether Postmark can be used\n */\nexport function isPostmarkConfigured(): boolean {\n\treturn postmarkConfig.isConfigured;\n}\n\n/**\n * Get DNS records needed for a domain in Postmark format\n *\n * @param domain - Postmark domain data\n * @returns Formatted DNS records for display\n */\nexport function getPostmarkDNSRecords(domain: PostmarkDomainData): Array<{\n\ttype: string;\n\tname: string;\n\tvalue: string;\n\tverified: boolean;\n}> {\n\tconst records: Array<{\n\t\ttype: string;\n\t\tname: string;\n\t\tvalue: string;\n\t\tverified: boolean;\n\t}> = [];\n\n\t// DKIM record\n\tif (domain.DKIMHost && domain.DKIMTextValue) {\n\t\trecords.push({\n\t\t\ttype: \"TXT\",\n\t\t\tname: domain.DKIMHost,\n\t\t\tvalue: domain.DKIMTextValue,\n\t\t\tverified: domain.DKIMVerified,\n\t\t});\n\t}\n\n\t// Return-Path CNAME\n\tif (domain.ReturnPathDomain && domain.ReturnPathDomainCNAMEValue) {\n\t\trecords.push({\n\t\t\ttype: \"CNAME\",\n\t\t\tname: domain.ReturnPathDomain,\n\t\t\tvalue: domain.ReturnPathDomainCNAMEValue,\n\t\t\tverified: domain.ReturnPathDomainVerified,\n\t\t});\n\t}\n\n\treturn records;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2121, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/token-encryption.ts"],"sourcesContent":["/**\n * Token Encryption Service\n *\n * Encrypts and decrypts OAuth refresh tokens before storing in database.\n * Uses AES-256-GCM for authenticated encryption.\n *\n * Security Features:\n * - AES-256-GCM authenticated encryption\n * - Unique IV (initialization vector) per token\n * - Authentication tag prevents tampering\n * - Key derivation from environment variable\n *\n * Environment Variables Required:\n * - TOKEN_ENCRYPTION_KEY: 32-byte hex string (64 characters)\n *\n * Generate key with: openssl rand -hex 32\n *\n * CRITICAL: Never commit encryption key to version control!\n */\n\nimport crypto from \"crypto\";\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\n/** Encryption algorithm (AES-256-GCM) */\nconst ALGORITHM = \"aes-256-gcm\";\n\n/** IV length in bytes (12 bytes = 96 bits, recommended for GCM) */\nconst IV_LENGTH = 12;\n\n/** Auth tag length in bytes (16 bytes = 128 bits) */\nconst AUTH_TAG_LENGTH = 16;\n\n/** Encoding for encrypted output */\nconst ENCODING = \"base64\";\n\n// =============================================================================\n// KEY MANAGEMENT\n// =============================================================================\n\n/**\n * Get encryption key from environment\n * Throws error if key is missing or invalid\n */\nfunction getEncryptionKey(): Buffer {\n\tconst keyHex = process.env.TOKEN_ENCRYPTION_KEY;\n\n\tif (!keyHex) {\n\t\tthrow new Error(\n\t\t\t\"TOKEN_ENCRYPTION_KEY environment variable not set. Generate with: openssl rand -hex 32\"\n\t\t);\n\t}\n\n\t// Verify key is 32 bytes (64 hex characters)\n\tif (keyHex.length !== 64) {\n\t\tthrow new Error(\n\t\t\t\"TOKEN_ENCRYPTION_KEY must be 32 bytes (64 hex characters). Generate with: openssl rand -hex 32\"\n\t\t);\n\t}\n\n\t// Convert hex string to buffer\n\tconst key = Buffer.from(keyHex, \"hex\");\n\n\tif (key.length !== 32) {\n\t\tthrow new Error(\"Invalid TOKEN_ENCRYPTION_KEY format\");\n\t}\n\n\treturn key;\n}\n\n// =============================================================================\n// ENCRYPTION/DECRYPTION\n// =============================================================================\n\n/**\n * Encrypt a token (refresh token or access token)\n *\n * @param plaintext - Token to encrypt\n * @returns Encrypted token string (format: iv:authTag:ciphertext, all base64)\n *\n * @example\n * const encrypted = encryptToken(\"ya29.a0AfH6SMB...\");\n * // Returns: \"rL8Kx2f...==:gH3pQ9...==:aB4cD5...\"\n */\nexport function encryptToken(plaintext: string): string {\n\ttry {\n\t\tconst key = getEncryptionKey();\n\n\t\t// Generate random IV (never reuse IVs!)\n\t\tconst iv = crypto.randomBytes(IV_LENGTH);\n\n\t\t// Create cipher\n\t\tconst cipher = crypto.createCipheriv(ALGORITHM, key, iv);\n\n\t\t// Encrypt\n\t\tlet ciphertext = cipher.update(plaintext, \"utf8\", ENCODING);\n\t\tciphertext += cipher.final(ENCODING);\n\n\t\t// Get authentication tag\n\t\tconst authTag = cipher.getAuthTag();\n\n\t\t// Return format: iv:authTag:ciphertext (all base64)\n\t\treturn [\n\t\t\tiv.toString(ENCODING),\n\t\t\tauthTag.toString(ENCODING),\n\t\t\tciphertext,\n\t\t].join(\":\");\n\t} catch (error) {\n\t\tconsole.error(\"[Token Encryption] Encryption failed:\", error);\n\t\tthrow new Error(\"Failed to encrypt token\");\n\t}\n}\n\n/**\n * Decrypt a token (refresh token or access token)\n *\n * @param encrypted - Encrypted token string (format: iv:authTag:ciphertext)\n * @returns Decrypted plaintext token\n *\n * @example\n * const plaintext = decryptToken(\"rL8Kx2f...==:gH3pQ9...==:aB4cD5...\");\n * // Returns: \"ya29.a0AfH6SMB...\"\n */\nexport function decryptToken(encrypted: string): string {\n\ttry {\n\t\tconst key = getEncryptionKey();\n\n\t\t// Parse encrypted format: iv:authTag:ciphertext\n\t\tconst parts = encrypted.split(\":\");\n\t\tif (parts.length !== 3) {\n\t\t\tthrow new Error(\"Invalid encrypted token format\");\n\t\t}\n\n\t\tconst [ivBase64, authTagBase64, ciphertext] = parts;\n\n\t\t// Convert from base64\n\t\tconst iv = Buffer.from(ivBase64, ENCODING);\n\t\tconst authTag = Buffer.from(authTagBase64, ENCODING);\n\n\t\t// Verify lengths\n\t\tif (iv.length !== IV_LENGTH) {\n\t\t\tthrow new Error(\"Invalid IV length\");\n\t\t}\n\n\t\tif (authTag.length !== AUTH_TAG_LENGTH) {\n\t\t\tthrow new Error(\"Invalid auth tag length\");\n\t\t}\n\n\t\t// Create decipher\n\t\tconst decipher = crypto.createDecipheriv(ALGORITHM, key, iv);\n\t\tdecipher.setAuthTag(authTag);\n\n\t\t// Decrypt\n\t\tlet plaintext = decipher.update(ciphertext, ENCODING, \"utf8\");\n\t\tplaintext += decipher.final(\"utf8\");\n\n\t\treturn plaintext;\n\t} catch (error) {\n\t\tconsole.error(\"[Token Encryption] Decryption failed:\", error);\n\t\tthrow new Error(\"Failed to decrypt token\");\n\t}\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Check if encryption key is configured\n * @returns True if key is set and valid\n */\nexport function isEncryptionConfigured(): boolean {\n\ttry {\n\t\tgetEncryptionKey();\n\t\treturn true;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n/**\n * Test encryption/decryption round-trip\n * Useful for validating configuration\n *\n * @returns True if encryption works correctly\n */\nexport function testEncryption(): boolean {\n\ttry {\n\t\tconst testToken = \"test_token_\" + crypto.randomBytes(32).toString(\"hex\");\n\t\tconst encrypted = encryptToken(testToken);\n\t\tconst decrypted = decryptToken(encrypted);\n\n\t\treturn decrypted === testToken;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n/**\n * Migrate existing plaintext tokens to encrypted format\n *\n * IMPORTANT: Run this as a one-time migration script\n * DO NOT run in production without backup!\n *\n * @example\n * // In a migration script:\n * await migrateTokensToEncrypted();\n */\nexport async function migrateTokensToEncrypted() {\n\t// This would be implemented as a standalone migration script\n\t// NOT included here to prevent accidental execution\n\tconsole.warn(\n\t\t\"[Token Encryption] Migration must be run as standalone script\"\n\t);\n\tthrow new Error(\"Use standalone migration script\");\n}\n\n// =============================================================================\n// WRAPPER FUNCTIONS FOR BACKWARD COMPATIBILITY\n// =============================================================================\n\n/**\n * Encrypt token with fallback for dev/test environments\n *\n * If encryption key not configured, returns plaintext (dev only!)\n * Production should always have encryption key configured\n */\nexport function encryptTokenSafe(plaintext: string): string {\n\tif (!isEncryptionConfigured()) {\n\t\tconsole.warn(\n\t\t\t\"[Token Encryption] Encryption key not configured - storing plaintext (DEV ONLY)\"\n\t\t);\n\t\treturn plaintext;\n\t}\n\n\treturn encryptToken(plaintext);\n}\n\n/**\n * Decrypt token with fallback for migration period\n *\n * If decryption fails (likely plaintext), returns as-is\n * Allows gradual migration from plaintext to encrypted\n */\nexport function decryptTokenSafe(encrypted: string): string {\n\tif (!isEncryptionConfigured()) {\n\t\tconsole.warn(\n\t\t\t\"[Token Encryption] Encryption key not configured - returning plaintext (DEV ONLY)\"\n\t\t);\n\t\treturn encrypted;\n\t}\n\n\t// Check if token is already encrypted (contains colons)\n\tif (!encrypted.includes(\":\")) {\n\t\tconsole.warn(\n\t\t\t\"[Token Encryption] Token appears to be plaintext - returning as-is (MIGRATION MODE)\"\n\t\t);\n\t\treturn encrypted;\n\t}\n\n\ttry {\n\t\treturn decryptToken(encrypted);\n\t} catch (error) {\n\t\tconsole.error(\n\t\t\t\"[Token Encryption] Decryption failed, returning plaintext:\",\n\t\t\terror\n\t\t);\n\t\treturn encrypted;\n\t}\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2292, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/gmail-rate-limiter.ts"],"sourcesContent":["/**\n * Gmail API Rate Limiter\n *\n * Prevents Gmail API quota exhaustion and abuse by implementing rate limits\n * at multiple levels: per-user, per-company, and global.\n *\n * Gmail API Quotas (Google-imposed):\n * - 1 billion quota units per day (project-wide)\n * - 250 quota units/user/second\n * - messages.get = 5 units, messages.list = 5 units\n *\n * Our Limits:\n * - Per-user: 1 sync every 5 minutes (max 12 syncs/hour)\n * - Per-user: Max 100 messages per sync\n * - Global: Max 10 concurrent syncs\n * - API endpoints: 60 requests/minute per user\n *\n * Implementation:\n * - In-memory rate limiting with Map (resets on server restart)\n * - Redis for distributed rate limiting (optional, for multi-server)\n * - Automatic cleanup of stale entries\n *\n * @see https://developers.google.com/gmail/api/reference/quota\n */\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface RateLimitEntry {\n\tcount: number;\n\tfirstRequest: number;\n\tlastRequest: number;\n}\n\ninterface SyncLock {\n\tteamMemberId: string;\n\tstartedAt: number;\n\texpiresAt: number;\n}\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\n/** Minimum time between syncs per user (5 minutes) */\nconst SYNC_COOLDOWN_MS = 5 * 60 * 1000;\n\n/** Maximum messages per sync */\nconst MAX_MESSAGES_PER_SYNC = 100;\n\n/** Maximum concurrent syncs globally */\nconst MAX_CONCURRENT_SYNCS = 10;\n\n/** API rate limit: requests per window */\nconst API_RATE_LIMIT = 60;\n\n/** API rate limit window (1 minute) */\nconst API_RATE_WINDOW_MS = 60 * 1000;\n\n/** How long to keep rate limit entries in memory */\nconst RATE_LIMIT_CLEANUP_MS = 60 * 60 * 1000; // 1 hour\n\n/** How long a sync lock is valid (30 minutes max) */\nconst SYNC_LOCK_TIMEOUT_MS = 30 * 60 * 1000;\n\n// =============================================================================\n// IN-MEMORY STORAGE\n// =============================================================================\n\n/** Per-user API rate limits */\nconst apiRateLimits = new Map<string, RateLimitEntry>();\n\n/** Per-user last sync timestamps */\nconst lastSyncTimes = new Map<string, number>();\n\n/** Active sync locks */\nconst activeSyncLocks = new Set<SyncLock>();\n\n/** Cleanup interval */\nlet cleanupInterval: NodeJS.Timeout | null = null;\n\n// =============================================================================\n// RATE LIMIT CHECKING\n// =============================================================================\n\n/**\n * Check if user can make an API request\n *\n * @param userId - User ID (team_member_id)\n * @returns { allowed: boolean, retryAfter?: number }\n */\nexport function checkApiRateLimit(userId: string): {\n\tallowed: boolean;\n\tretryAfter?: number;\n} {\n\tconst now = Date.now();\n\tconst entry = apiRateLimits.get(userId);\n\n\tif (!entry) {\n\t\t// First request - allow and record\n\t\tapiRateLimits.set(userId, {\n\t\t\tcount: 1,\n\t\t\tfirstRequest: now,\n\t\t\tlastRequest: now,\n\t\t});\n\t\treturn { allowed: true };\n\t}\n\n\t// Check if window has expired\n\tconst windowAge = now - entry.firstRequest;\n\tif (windowAge > API_RATE_WINDOW_MS) {\n\t\t// Window expired - reset counter\n\t\tapiRateLimits.set(userId, {\n\t\t\tcount: 1,\n\t\t\tfirstRequest: now,\n\t\t\tlastRequest: now,\n\t\t});\n\t\treturn { allowed: true };\n\t}\n\n\t// Within window - check limit\n\tif (entry.count >= API_RATE_LIMIT) {\n\t\t// Rate limit exceeded\n\t\tconst retryAfter = Math.ceil(\n\t\t\t(entry.firstRequest + API_RATE_WINDOW_MS - now) / 1000\n\t\t);\n\t\treturn { allowed: false, retryAfter };\n\t}\n\n\t// Increment counter\n\tentry.count++;\n\tentry.lastRequest = now;\n\tapiRateLimits.set(userId, entry);\n\n\treturn { allowed: true };\n}\n\n/**\n * Check if user can start a sync\n *\n * @param teamMemberId - Team member ID\n * @returns { allowed: boolean, reason?: string, retryAfter?: number }\n */\nexport function checkSyncRateLimit(teamMemberId: string): {\n\tallowed: boolean;\n\treason?: string;\n\tretryAfter?: number;\n} {\n\tconst now = Date.now();\n\n\t// Check sync cooldown\n\tconst lastSync = lastSyncTimes.get(teamMemberId);\n\tif (lastSync) {\n\t\tconst timeSinceLastSync = now - lastSync;\n\t\tif (timeSinceLastSync < SYNC_COOLDOWN_MS) {\n\t\t\tconst retryAfter = Math.ceil(\n\t\t\t\t(SYNC_COOLDOWN_MS - timeSinceLastSync) / 1000\n\t\t\t);\n\t\t\treturn {\n\t\t\t\tallowed: false,\n\t\t\t\treason: \"Sync cooldown active\",\n\t\t\t\tretryAfter,\n\t\t\t};\n\t\t}\n\t}\n\n\t// Check concurrent sync limit\n\tconst activeCount = getActiveSyncCount();\n\tif (activeCount >= MAX_CONCURRENT_SYNCS) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Maximum concurrent syncs reached\",\n\t\t\tretryAfter: 60, // Retry in 1 minute\n\t\t};\n\t}\n\n\t// Check if user already has active sync\n\tconst existingLock = Array.from(activeSyncLocks).find(\n\t\t(lock) => lock.teamMemberId === teamMemberId\n\t);\n\n\tif (existingLock) {\n\t\t// Check if lock is expired\n\t\tif (now > existingLock.expiresAt) {\n\t\t\t// Lock expired - remove it\n\t\t\tactiveSyncLocks.delete(existingLock);\n\t\t} else {\n\t\t\treturn {\n\t\t\t\tallowed: false,\n\t\t\t\treason: \"Sync already in progress\",\n\t\t\t\tretryAfter: Math.ceil((existingLock.expiresAt - now) / 1000),\n\t\t\t};\n\t\t}\n\t}\n\n\treturn { allowed: true };\n}\n\n// =============================================================================\n// SYNC LOCK MANAGEMENT\n// =============================================================================\n\n/**\n * Acquire a sync lock for a user\n *\n * @param teamMemberId - Team member ID\n * @returns Lock ID if acquired, null if failed\n */\nexport function acquireSyncLock(teamMemberId: string): SyncLock | null {\n\tconst check = checkSyncRateLimit(teamMemberId);\n\tif (!check.allowed) {\n\t\treturn null;\n\t}\n\n\tconst now = Date.now();\n\tconst lock: SyncLock = {\n\t\tteamMemberId,\n\t\tstartedAt: now,\n\t\texpiresAt: now + SYNC_LOCK_TIMEOUT_MS,\n\t};\n\n\tactiveSyncLocks.add(lock);\n\tlastSyncTimes.set(teamMemberId, now);\n\n\treturn lock;\n}\n\n/**\n * Release a sync lock\n *\n * @param lock - Lock to release\n */\nexport function releaseSyncLock(lock: SyncLock): void {\n\tactiveSyncLocks.delete(lock);\n}\n\n/**\n * Get count of active syncs\n */\nexport function getActiveSyncCount(): number {\n\t// Clean up expired locks first\n\tconst now = Date.now();\n\tfor (const lock of activeSyncLocks) {\n\t\tif (now > lock.expiresAt) {\n\t\t\tactiveSyncLocks.delete(lock);\n\t\t}\n\t}\n\n\treturn activeSyncLocks.size;\n}\n\n// =============================================================================\n// CLEANUP\n// =============================================================================\n\n/**\n * Clean up stale rate limit entries\n */\nfunction cleanup(): void {\n\tconst now = Date.now();\n\n\t// Clean API rate limits\n\tfor (const [userId, entry] of apiRateLimits.entries()) {\n\t\tconst age = now - entry.lastRequest;\n\t\tif (age > RATE_LIMIT_CLEANUP_MS) {\n\t\t\tapiRateLimits.delete(userId);\n\t\t}\n\t}\n\n\t// Clean last sync times\n\tfor (const [userId, lastSync] of lastSyncTimes.entries()) {\n\t\tconst age = now - lastSync;\n\t\tif (age > RATE_LIMIT_CLEANUP_MS) {\n\t\t\tlastSyncTimes.delete(userId);\n\t\t}\n\t}\n\n\t// Clean expired sync locks\n\tfor (const lock of activeSyncLocks) {\n\t\tif (now > lock.expiresAt) {\n\t\t\tactiveSyncLocks.delete(lock);\n\t\t}\n\t}\n}\n\n/**\n * Start automatic cleanup\n */\nexport function startCleanup(): void {\n\tif (cleanupInterval) {\n\t\treturn; // Already started\n\t}\n\n\t// Run cleanup every 5 minutes\n\tcleanupInterval = setInterval(cleanup, 5 * 60 * 1000);\n\n\tconsole.log(\"[Gmail Rate Limiter] Cleanup scheduled\");\n}\n\n/**\n * Stop automatic cleanup\n */\nexport function stopCleanup(): void {\n\tif (cleanupInterval) {\n\t\tclearInterval(cleanupInterval);\n\t\tcleanupInterval = null;\n\t}\n}\n\n// =============================================================================\n// VALIDATION\n// =============================================================================\n\n/**\n * Validate sync request parameters\n *\n * @param maxResults - Requested message count\n * @returns { valid: boolean, error?: string }\n */\nexport function validateSyncParams(maxResults: number): {\n\tvalid: boolean;\n\terror?: string;\n} {\n\tif (maxResults <= 0) {\n\t\treturn { valid: false, error: \"maxResults must be positive\" };\n\t}\n\n\tif (maxResults > MAX_MESSAGES_PER_SYNC) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: `maxResults cannot exceed ${MAX_MESSAGES_PER_SYNC}`,\n\t\t};\n\t}\n\n\treturn { valid: true };\n}\n\n// =============================================================================\n// STATISTICS\n// =============================================================================\n\n/**\n * Get rate limiter statistics\n */\nexport function getRateLimiterStats(): {\n\tapiRateLimits: number;\n\tlastSyncTimes: number;\n\tactiveSyncs: number;\n\tmaxConcurrentSyncs: number;\n} {\n\treturn {\n\t\tapiRateLimits: apiRateLimits.size,\n\t\tlastSyncTimes: lastSyncTimes.size,\n\t\tactiveSyncs: getActiveSyncCount(),\n\t\tmaxConcurrentSyncs: MAX_CONCURRENT_SYNCS,\n\t};\n}\n\n/**\n * Reset all rate limits (for testing only!)\n */\nexport function resetRateLimits(): void {\n\tapiRateLimits.clear();\n\tlastSyncTimes.clear();\n\tactiveSyncLocks.clear();\n\tconsole.warn(\"[Gmail Rate Limiter] All rate limits reset\");\n}\n\n// =============================================================================\n// INITIALIZATION\n// =============================================================================\n\n// Start cleanup on module load\nstartCleanup();\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport const RATE_LIMITS = {\n\tSYNC_COOLDOWN_MS,\n\tMAX_MESSAGES_PER_SYNC,\n\tMAX_CONCURRENT_SYNCS,\n\tAPI_RATE_LIMIT,\n\tAPI_RATE_WINDOW_MS,\n} as const;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2563, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/audit-logger.ts"],"sourcesContent":["/**\n * Email Security Audit Logger\n *\n * Logs security-relevant events for compliance, investigation, and monitoring.\n * All logs are stored in the database with retention policies.\n *\n * Events Logged:\n * - Gmail connections/disconnections\n * - Token refresh failures\n * - Permission grants/revokes\n * - Sync errors\n * - Email access (optional, for compliance)\n *\n * Usage:\n * await logAuditEvent('gmail_connected', { teamMemberId, email });\n * await logAuditEvent('permission_granted', { grantedBy, grantedTo, category });\n *\n * Database Table: email_audit_log (to be created)\n *\n * @see /docs/email/SECURITY_AUDIT.md\n */\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\nimport type { EmailCategory } from \"./email-permissions\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Audit event types\n */\nexport type AuditEventType =\n\t// Gmail OAuth events\n\t| \"gmail_connected\"\n\t| \"gmail_disconnected\"\n\t| \"gmail_token_refreshed\"\n\t| \"gmail_token_refresh_failed\"\n\t| \"gmail_token_revoked\"\n\t// Permission events\n\t| \"permission_granted\"\n\t| \"permission_revoked\"\n\t| \"permission_updated\"\n\t| \"permission_check_failed\"\n\t// Sync events\n\t| \"sync_started\"\n\t| \"sync_completed\"\n\t| \"sync_failed\"\n\t| \"sync_rate_limited\"\n\t// Email access events (optional)\n\t| \"email_accessed\"\n\t| \"email_sent\"\n\t| \"email_assigned\"\n\t// Security events\n\t| \"unauthorized_access_attempt\"\n\t| \"permission_escalation_attempt\"\n\t| \"invalid_oauth_state\"\n\t// System events\n\t| \"token_cleanup_executed\"\n\t| \"rate_limit_exceeded\";\n\n/**\n * Audit event severity levels\n */\nexport type AuditSeverity = \"info\" | \"warning\" | \"error\" | \"critical\";\n\n/**\n * Audit event metadata\n */\nexport interface AuditEventMetadata {\n\t// Common fields\n\tteamMemberId?: string;\n\tcompanyId?: string;\n\tuserId?: string; // auth.uid\n\tuserName?: string;\n\n\t// Gmail fields\n\tgmailEmail?: string;\n\tgmailMessageId?: string;\n\tsyncMessageCount?: number;\n\n\t// Permission fields\n\tcategory?: EmailCategory;\n\tgrantedBy?: string;\n\tgrantedTo?: string;\n\tcanRead?: boolean;\n\tcanSend?: boolean;\n\tcanAssign?: boolean;\n\n\t// Email fields\n\tcommunicationId?: string;\n\temailSubject?: string;\n\tfromAddress?: string;\n\ttoAddress?: string;\n\n\t// Error fields\n\terror?: string;\n\terrorCode?: string;\n\tstackTrace?: string;\n\n\t// Rate limiting\n\tretryAfter?: number;\n\trequestsPerMinute?: number;\n\n\t// Additional context\n\tipAddress?: string;\n\tuserAgent?: string;\n\t[key: string]: any;\n}\n\n/**\n * Audit event record\n */\nexport interface AuditEvent {\n\tid: string;\n\teventType: AuditEventType;\n\tseverity: AuditSeverity;\n\tmessage: string;\n\tmetadata: AuditEventMetadata;\n\tcreatedAt: string;\n}\n\n// =============================================================================\n// LOGGING FUNCTIONS\n// =============================================================================\n\n/**\n * Log an audit event\n *\n * @param eventType - Type of event\n * @param metadata - Event metadata\n * @param severity - Event severity (default: info)\n * @param message - Optional custom message\n *\n * @example\n * await logAuditEvent('gmail_connected', {\n *   teamMemberId: 'xxx',\n *   gmailEmail: 'user@gmail.com'\n * });\n */\nexport async function logAuditEvent(\n\teventType: AuditEventType,\n\tmetadata: AuditEventMetadata = {},\n\tseverity: AuditSeverity = \"info\",\n\tmessage?: string\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\t// Generate default message if not provided\n\t\tconst defaultMessage = generateDefaultMessage(eventType, metadata);\n\n\t\t// In production, store in database\n\t\t// For now, log to console with structured format\n\t\tconst logEntry = {\n\t\t\ttimestamp: new Date().toISOString(),\n\t\t\teventType,\n\t\t\tseverity,\n\t\t\tmessage: message || defaultMessage,\n\t\t\tmetadata,\n\t\t};\n\n\t\t// Console output with color coding\n\t\tconst prefix = `[Email Audit]`;\n\t\tconst severityEmoji = {\n\t\t\tinfo: \"\",\n\t\t\twarning: \"\",\n\t\t\terror: \"\",\n\t\t\tcritical: \"\",\n\t\t}[severity];\n\n\t\tconsole.log(\n\t\t\t`${prefix} ${severityEmoji} [${severity.toUpperCase()}] ${logEntry.message}`,\n\t\t\tmetadata\n\t\t);\n\n\t\t// Store in database\n\t\ttry {\n\t\t\tconst supabase = await createServiceSupabaseClient();\n\t\t\tif (supabase) {\n\t\t\t\tawait supabase.from(\"email_audit_log\").insert({\n\t\t\t\t\tcompany_id: metadata.companyId || null,\n\t\t\t\t\tevent_type: eventType,\n\t\t\t\t\tseverity,\n\t\t\t\t\tmessage: logEntry.message,\n\t\t\t\t\tteam_member_id: metadata.teamMemberId || null,\n\t\t\t\t\tuser_id: metadata.userId || null,\n\t\t\t\t\tgmail_email: metadata.gmailEmail || null,\n\t\t\t\t\tmetadata,\n\t\t\t\t\tip_address: metadata.ipAddress || null,\n\t\t\t\t\tuser_agent: metadata.userAgent || null,\n\t\t\t\t});\n\t\t\t}\n\t\t} catch (dbError) {\n\t\t\t// Don't fail the audit log if database write fails - console log is still captured\n\t\t\tconsole.error(\"[Email Audit] Failed to store in database:\", dbError);\n\t\t}\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tconsole.error(\"[Email Audit] Failed to log event:\", error);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n\n/**\n * Generate default message for event type\n */\nfunction generateDefaultMessage(\n\teventType: AuditEventType,\n\tmetadata: AuditEventMetadata\n): string {\n\tconst name = metadata.userName || metadata.teamMemberId || \"User\";\n\n\tswitch (eventType) {\n\t\tcase \"gmail_connected\":\n\t\t\treturn `${name} connected Gmail account (${metadata.gmailEmail})`;\n\t\tcase \"gmail_disconnected\":\n\t\t\treturn `${name} disconnected Gmail account (${metadata.gmailEmail})`;\n\t\tcase \"gmail_token_refreshed\":\n\t\t\treturn `Gmail token refreshed for ${metadata.gmailEmail}`;\n\t\tcase \"gmail_token_refresh_failed\":\n\t\t\treturn `Failed to refresh Gmail token for ${metadata.gmailEmail}: ${metadata.error}`;\n\t\tcase \"gmail_token_revoked\":\n\t\t\treturn `Gmail token revoked for ${metadata.gmailEmail}`;\n\n\t\tcase \"permission_granted\":\n\t\t\treturn `${metadata.grantedBy} granted ${metadata.category} permissions to ${metadata.grantedTo}`;\n\t\tcase \"permission_revoked\":\n\t\t\treturn `${metadata.grantedBy} revoked ${metadata.category} permissions from ${metadata.grantedTo}`;\n\t\tcase \"permission_updated\":\n\t\t\treturn `${metadata.grantedBy} updated ${metadata.category} permissions for ${metadata.grantedTo}`;\n\t\tcase \"permission_check_failed\":\n\t\t\treturn `Permission check failed for ${name}: ${metadata.error}`;\n\n\t\tcase \"sync_started\":\n\t\t\treturn `${name} started inbox sync`;\n\t\tcase \"sync_completed\":\n\t\t\treturn `${name} completed inbox sync (${metadata.syncMessageCount} messages)`;\n\t\tcase \"sync_failed\":\n\t\t\treturn `Inbox sync failed for ${name}: ${metadata.error}`;\n\t\tcase \"sync_rate_limited\":\n\t\t\treturn `${name} sync rate limited (retry after ${metadata.retryAfter}s)`;\n\n\t\tcase \"email_accessed\":\n\t\t\treturn `${name} accessed email: ${metadata.emailSubject}`;\n\t\tcase \"email_sent\":\n\t\t\treturn `${name} sent email to ${metadata.toAddress}: ${metadata.emailSubject}`;\n\t\tcase \"email_assigned\":\n\t\t\treturn `${name} assigned email to ${metadata.grantedTo}`;\n\n\t\tcase \"unauthorized_access_attempt\":\n\t\t\treturn `Unauthorized access attempt by ${name}: ${metadata.error}`;\n\t\tcase \"permission_escalation_attempt\":\n\t\t\treturn `Permission escalation attempt by ${name}: ${metadata.error}`;\n\t\tcase \"invalid_oauth_state\":\n\t\t\treturn `Invalid OAuth state detected: ${metadata.error}`;\n\n\t\tcase \"token_cleanup_executed\":\n\t\t\treturn `Token cleanup executed: ${metadata.syncMessageCount} tokens removed`;\n\t\tcase \"rate_limit_exceeded\":\n\t\t\treturn `Rate limit exceeded for ${name} (${metadata.requestsPerMinute} req/min)`;\n\n\t\tdefault:\n\t\t\treturn `${eventType} event for ${name}`;\n\t}\n}\n\n// =============================================================================\n// CONVENIENCE FUNCTIONS\n// =============================================================================\n\n/**\n * Log Gmail connection\n */\nexport async function logGmailConnected(\n\tteamMemberId: string,\n\tuserName: string,\n\tgmailEmail: string,\n\tcompanyId: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"gmail_connected\",\n\t\t{ teamMemberId, userName, gmailEmail, companyId },\n\t\t\"info\"\n\t);\n}\n\n/**\n * Log Gmail disconnection\n */\nexport async function logGmailDisconnected(\n\tteamMemberId: string,\n\tuserName: string,\n\tgmailEmail: string,\n\tcompanyId: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"gmail_disconnected\",\n\t\t{ teamMemberId, userName, gmailEmail, companyId },\n\t\t\"info\"\n\t);\n}\n\n/**\n * Log token refresh failure\n */\nexport async function logTokenRefreshFailed(\n\tteamMemberId: string,\n\tgmailEmail: string,\n\terror: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"gmail_token_refresh_failed\",\n\t\t{ teamMemberId, gmailEmail, error },\n\t\t\"warning\"\n\t);\n}\n\n/**\n * Log permission grant\n */\nexport async function logPermissionGranted(\n\tgrantedBy: string,\n\tgrantedByName: string,\n\tgrantedTo: string,\n\tgrantedToName: string,\n\tcategory: EmailCategory,\n\tcompanyId: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"permission_granted\",\n\t\t{\n\t\t\tgrantedBy,\n\t\t\tuserName: grantedByName,\n\t\t\tgrantedTo,\n\t\t\tcategory,\n\t\t\tcompanyId,\n\t\t},\n\t\t\"info\"\n\t);\n}\n\n/**\n * Log permission revocation\n */\nexport async function logPermissionRevoked(\n\trevokedBy: string,\n\trevokedByName: string,\n\trevokedFrom: string,\n\trevokedFromName: string,\n\tcategory: EmailCategory,\n\tcompanyId: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"permission_revoked\",\n\t\t{\n\t\t\tgrantedBy: revokedBy,\n\t\t\tuserName: revokedByName,\n\t\t\tgrantedTo: revokedFrom,\n\t\t\tcategory,\n\t\t\tcompanyId,\n\t\t},\n\t\t\"info\"\n\t);\n}\n\n/**\n * Log sync failure\n */\nexport async function logSyncFailed(\n\tteamMemberId: string,\n\tuserName: string,\n\tgmailEmail: string,\n\terror: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"sync_failed\",\n\t\t{ teamMemberId, userName, gmailEmail, error },\n\t\t\"error\"\n\t);\n}\n\n/**\n * Log unauthorized access attempt\n */\nexport async function logUnauthorizedAccess(\n\tuserId: string,\n\tuserName: string,\n\tresource: string,\n\terror: string\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"unauthorized_access_attempt\",\n\t\t{ userId, userName, error, communicationId: resource },\n\t\t\"warning\"\n\t);\n}\n\n/**\n * Log rate limit exceeded\n */\nexport async function logRateLimitExceeded(\n\tuserId: string,\n\tuserName: string,\n\trequestsPerMinute: number,\n\tretryAfter: number\n): Promise<void> {\n\tawait logAuditEvent(\n\t\t\"rate_limit_exceeded\",\n\t\t{ userId, userName, requestsPerMinute, retryAfter },\n\t\t\"warning\"\n\t);\n}\n\n// =============================================================================\n// QUERY FUNCTIONS\n// =============================================================================\n\n/**\n * Get audit events for a team member\n *\n * @param teamMemberId - Team member ID\n * @param limit - Max events to return\n * @returns List of audit events\n */\nexport async function getAuditEventsForUser(\n\tteamMemberId: string,\n\tlimit: number = 100\n): Promise<AuditEvent[]> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tif (!supabase) return [];\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"email_audit_log\")\n\t\t\t.select(\"id, event_type, severity, message, metadata, created_at\")\n\t\t\t.eq(\"team_member_id\", teamMemberId)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tif (error) {\n\t\t\tconsole.error(\"[Email Audit] Failed to query events for user:\", error);\n\t\t\treturn [];\n\t\t}\n\n\t\treturn (data || []).map((row) => ({\n\t\t\tid: row.id,\n\t\t\teventType: row.event_type as AuditEventType,\n\t\t\tseverity: row.severity as AuditSeverity,\n\t\t\tmessage: row.message,\n\t\t\tmetadata: row.metadata || {},\n\t\t\tcreatedAt: row.created_at,\n\t\t}));\n\t} catch (error) {\n\t\tconsole.error(\"[Email Audit] Failed to query events for user:\", error);\n\t\treturn [];\n\t}\n}\n\n/**\n * Get audit events for a company\n *\n * @param companyId - Company ID\n * @param limit - Max events to return\n * @returns List of audit events\n */\nexport async function getAuditEventsForCompany(\n\tcompanyId: string,\n\tlimit: number = 100\n): Promise<AuditEvent[]> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tif (!supabase) return [];\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"email_audit_log\")\n\t\t\t.select(\"id, event_type, severity, message, metadata, created_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tif (error) {\n\t\t\tconsole.error(\"[Email Audit] Failed to query events for company:\", error);\n\t\t\treturn [];\n\t\t}\n\n\t\treturn (data || []).map((row) => ({\n\t\t\tid: row.id,\n\t\t\teventType: row.event_type as AuditEventType,\n\t\t\tseverity: row.severity as AuditSeverity,\n\t\t\tmessage: row.message,\n\t\t\tmetadata: row.metadata || {},\n\t\t\tcreatedAt: row.created_at,\n\t\t}));\n\t} catch (error) {\n\t\tconsole.error(\"[Email Audit] Failed to query events for company:\", error);\n\t\treturn [];\n\t}\n}\n\n/**\n * Get critical security events\n *\n * @param limit - Max events to return\n * @returns List of critical events\n */\nexport async function getCriticalSecurityEvents(\n\tlimit: number = 50\n): Promise<AuditEvent[]> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tif (!supabase) return [];\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"email_audit_log\")\n\t\t\t.select(\"id, event_type, severity, message, metadata, created_at\")\n\t\t\t.in(\"severity\", [\"error\", \"critical\"])\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tif (error) {\n\t\t\tconsole.error(\"[Email Audit] Failed to query critical events:\", error);\n\t\t\treturn [];\n\t\t}\n\n\t\treturn (data || []).map((row) => ({\n\t\t\tid: row.id,\n\t\t\teventType: row.event_type as AuditEventType,\n\t\t\tseverity: row.severity as AuditSeverity,\n\t\t\tmessage: row.message,\n\t\t\tmetadata: row.metadata || {},\n\t\t\tcreatedAt: row.created_at,\n\t\t}));\n\t} catch (error) {\n\t\tconsole.error(\"[Email Audit] Failed to query critical events:\", error);\n\t\treturn [];\n\t}\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;CAoBC;;;;;;;;;;;;;;;;;;;;;;;;;;AAED;;AAsHO,eAAe,cACrB,SAAyB,EACzB,WAA+B,CAAC,CAAC,EACjC,WAA0B,MAAM,EAChC,OAAgB;IAEhB,IAAI;QACH,2CAA2C;QAC3C,MAAM,iBAAiB,uBAAuB,WAAW;QAEzD,mCAAmC;QACnC,iDAAiD;QACjD,MAAM,WAAW;YAChB,WAAW,IAAI,OAAO,WAAW;YACjC;YACA;YACA,SAAS,WAAW;YACpB;QACD;QAEA,mCAAmC;QACnC,MAAM,SAAS,CAAC,aAAa,CAAC;QAC9B,MAAM,gBAAgB;YACrB,MAAM;YACN,SAAS;YACT,OAAO;YACP,UAAU;QACX,CAAC,CAAC,SAAS;QAEX,QAAQ,GAAG,CACV,GAAG,OAAO,CAAC,EAAE,cAAc,EAAE,EAAE,SAAS,WAAW,GAAG,EAAE,EAAE,SAAS,OAAO,EAAE,EAC5E;QAGD,oBAAoB;QACpB,IAAI;YACH,MAAM,WAAW,MAAM,IAAA,iLAA2B;YAClD,IAAI,UAAU;gBACb,MAAM,SAAS,IAAI,CAAC,mBAAmB,MAAM,CAAC;oBAC7C,YAAY,SAAS,SAAS,IAAI;oBAClC,YAAY;oBACZ;oBACA,SAAS,SAAS,OAAO;oBACzB,gBAAgB,SAAS,YAAY,IAAI;oBACzC,SAAS,SAAS,MAAM,IAAI;oBAC5B,aAAa,SAAS,UAAU,IAAI;oBACpC;oBACA,YAAY,SAAS,SAAS,IAAI;oBAClC,YAAY,SAAS,SAAS,IAAI;gBACnC;YACD;QACD,EAAE,OAAO,SAAS;YACjB,mFAAmF;YACnF,QAAQ,KAAK,CAAC,8CAA8C;QAC7D;QAEA,OAAO;YAAE,SAAS;QAAK;IACxB,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,sCAAsC;QACpD,OAAO;YACN,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACjD;IACD;AACD;AAEA;;CAEC,GACD,SAAS,uBACR,SAAyB,EACzB,QAA4B;IAE5B,MAAM,OAAO,SAAS,QAAQ,IAAI,SAAS,YAAY,IAAI;IAE3D,OAAQ;QACP,KAAK;YACJ,OAAO,GAAG,KAAK,0BAA0B,EAAE,SAAS,UAAU,CAAC,CAAC,CAAC;QAClE,KAAK;YACJ,OAAO,GAAG,KAAK,6BAA6B,EAAE,SAAS,UAAU,CAAC,CAAC,CAAC;QACrE,KAAK;YACJ,OAAO,CAAC,0BAA0B,EAAE,SAAS,UAAU,EAAE;QAC1D,KAAK;YACJ,OAAO,CAAC,kCAAkC,EAAE,SAAS,UAAU,CAAC,EAAE,EAAE,SAAS,KAAK,EAAE;QACrF,KAAK;YACJ,OAAO,CAAC,wBAAwB,EAAE,SAAS,UAAU,EAAE;QAExD,KAAK;YACJ,OAAO,GAAG,SAAS,SAAS,CAAC,SAAS,EAAE,SAAS,QAAQ,CAAC,gBAAgB,EAAE,SAAS,SAAS,EAAE;QACjG,KAAK;YACJ,OAAO,GAAG,SAAS,SAAS,CAAC,SAAS,EAAE,SAAS,QAAQ,CAAC,kBAAkB,EAAE,SAAS,SAAS,EAAE;QACnG,KAAK;YACJ,OAAO,GAAG,SAAS,SAAS,CAAC,SAAS,EAAE,SAAS,QAAQ,CAAC,iBAAiB,EAAE,SAAS,SAAS,EAAE;QAClG,KAAK;YACJ,OAAO,CAAC,4BAA4B,EAAE,KAAK,EAAE,EAAE,SAAS,KAAK,EAAE;QAEhE,KAAK;YACJ,OAAO,GAAG,KAAK,mBAAmB,CAAC;QACpC,KAAK;YACJ,OAAO,GAAG,KAAK,uBAAuB,EAAE,SAAS,gBAAgB,CAAC,UAAU,CAAC;QAC9E,KAAK;YACJ,OAAO,CAAC,sBAAsB,EAAE,KAAK,EAAE,EAAE,SAAS,KAAK,EAAE;QAC1D,KAAK;YACJ,OAAO,GAAG,KAAK,gCAAgC,EAAE,SAAS,UAAU,CAAC,EAAE,CAAC;QAEzE,KAAK;YACJ,OAAO,GAAG,KAAK,iBAAiB,EAAE,SAAS,YAAY,EAAE;QAC1D,KAAK;YACJ,OAAO,GAAG,KAAK,eAAe,EAAE,SAAS,SAAS,CAAC,EAAE,EAAE,SAAS,YAAY,EAAE;QAC/E,KAAK;YACJ,OAAO,GAAG,KAAK,mBAAmB,EAAE,SAAS,SAAS,EAAE;QAEzD,KAAK;YACJ,OAAO,CAAC,+BAA+B,EAAE,KAAK,EAAE,EAAE,SAAS,KAAK,EAAE;QACnE,KAAK;YACJ,OAAO,CAAC,iCAAiC,EAAE,KAAK,EAAE,EAAE,SAAS,KAAK,EAAE;QACrE,KAAK;YACJ,OAAO,CAAC,8BAA8B,EAAE,SAAS,KAAK,EAAE;QAEzD,KAAK;YACJ,OAAO,CAAC,wBAAwB,EAAE,SAAS,gBAAgB,CAAC,eAAe,CAAC;QAC7E,KAAK;YACJ,OAAO,CAAC,wBAAwB,EAAE,KAAK,EAAE,EAAE,SAAS,iBAAiB,CAAC,SAAS,CAAC;QAEjF;YACC,OAAO,GAAG,UAAU,WAAW,EAAE,MAAM;IACzC;AACD;AASO,eAAe,kBACrB,YAAoB,EACpB,QAAgB,EAChB,UAAkB,EAClB,SAAiB;IAEjB,MAAM,cACL,mBACA;QAAE;QAAc;QAAU;QAAY;IAAU,GAChD;AAEF;AAKO,eAAe,qBACrB,YAAoB,EACpB,QAAgB,EAChB,UAAkB,EAClB,SAAiB;IAEjB,MAAM,cACL,sBACA;QAAE;QAAc;QAAU;QAAY;IAAU,GAChD;AAEF;AAKO,eAAe,sBACrB,YAAoB,EACpB,UAAkB,EAClB,KAAa;IAEb,MAAM,cACL,8BACA;QAAE;QAAc;QAAY;IAAM,GAClC;AAEF;AAKO,eAAe,qBACrB,SAAiB,EACjB,aAAqB,EACrB,SAAiB,EACjB,aAAqB,EACrB,QAAuB,EACvB,SAAiB;IAEjB,MAAM,cACL,sBACA;QACC;QACA,UAAU;QACV;QACA;QACA;IACD,GACA;AAEF;AAKO,eAAe,qBACrB,SAAiB,EACjB,aAAqB,EACrB,WAAmB,EACnB,eAAuB,EACvB,QAAuB,EACvB,SAAiB;IAEjB,MAAM,cACL,sBACA;QACC,WAAW;QACX,UAAU;QACV,WAAW;QACX;QACA;IACD,GACA;AAEF;AAKO,eAAe,cACrB,YAAoB,EACpB,QAAgB,EAChB,UAAkB,EAClB,KAAa;IAEb,MAAM,cACL,eACA;QAAE;QAAc;QAAU;QAAY;IAAM,GAC5C;AAEF;AAKO,eAAe,sBACrB,MAAc,EACd,QAAgB,EAChB,QAAgB,EAChB,KAAa;IAEb,MAAM,cACL,+BACA;QAAE;QAAQ;QAAU;QAAO,iBAAiB;IAAS,GACrD;AAEF;AAKO,eAAe,qBACrB,MAAc,EACd,QAAgB,EAChB,iBAAyB,EACzB,UAAkB;IAElB,MAAM,cACL,uBACA;QAAE;QAAQ;QAAU;QAAmB;IAAW,GAClD;AAEF;AAaO,eAAe,sBACrB,YAAoB,EACpB,QAAgB,GAAG;IAEnB,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAClD,IAAI,CAAC,UAAU,OAAO,EAAE;QAExB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,mBACL,MAAM,CAAC,2DACP,EAAE,CAAC,kBAAkB,cACrB,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC;QAER,IAAI,OAAO;YACV,QAAQ,KAAK,CAAC,kDAAkD;YAChE,OAAO,EAAE;QACV;QAEA,OAAO,CAAC,QAAQ,EAAE,EAAE,GAAG,CAAC,CAAC,MAAQ,CAAC;gBACjC,IAAI,IAAI,EAAE;gBACV,WAAW,IAAI,UAAU;gBACzB,UAAU,IAAI,QAAQ;gBACtB,SAAS,IAAI,OAAO;gBACpB,UAAU,IAAI,QAAQ,IAAI,CAAC;gBAC3B,WAAW,IAAI,UAAU;YAC1B,CAAC;IACF,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,kDAAkD;QAChE,OAAO,EAAE;IACV;AACD;AASO,eAAe,yBACrB,SAAiB,EACjB,QAAgB,GAAG;IAEnB,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAClD,IAAI,CAAC,UAAU,OAAO,EAAE;QAExB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,mBACL,MAAM,CAAC,2DACP,EAAE,CAAC,cAAc,WACjB,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC;QAER,IAAI,OAAO;YACV,QAAQ,KAAK,CAAC,qDAAqD;YACnE,OAAO,EAAE;QACV;QAEA,OAAO,CAAC,QAAQ,EAAE,EAAE,GAAG,CAAC,CAAC,MAAQ,CAAC;gBACjC,IAAI,IAAI,EAAE;gBACV,WAAW,IAAI,UAAU;gBACzB,UAAU,IAAI,QAAQ;gBACtB,SAAS,IAAI,OAAO;gBACpB,UAAU,IAAI,QAAQ,IAAI,CAAC;gBAC3B,WAAW,IAAI,UAAU;YAC1B,CAAC;IACF,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,qDAAqD;QACnE,OAAO,EAAE;IACV;AACD;AAQO,eAAe,0BACrB,QAAgB,EAAE;IAElB,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAClD,IAAI,CAAC,UAAU,OAAO,EAAE;QAExB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,mBACL,MAAM,CAAC,2DACP,EAAE,CAAC,YAAY;YAAC;YAAS;SAAW,EACpC,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC;QAER,IAAI,OAAO;YACV,QAAQ,KAAK,CAAC,kDAAkD;YAChE,OAAO,EAAE;QACV;QAEA,OAAO,CAAC,QAAQ,EAAE,EAAE,GAAG,CAAC,CAAC,MAAQ,CAAC;gBACjC,IAAI,IAAI,EAAE;gBACV,WAAW,IAAI,UAAU;gBACzB,UAAU,IAAI,QAAQ;gBACtB,SAAS,IAAI,OAAO;gBACpB,UAAU,IAAI,QAAQ,IAAI,CAAC;gBAC3B,WAAW,IAAI,UAAU;YAC1B,CAAC;IACF,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,kDAAkD;QAChE,OAAO,EAAE;IACV;AACD"}},
    {"offset": {"line": 2860, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/gmail-client.ts"],"sourcesContent":["/**\n * Gmail API Client (Company-Level & Per-User / Multi-Tenant)\n *\n * CRITICAL: Reply-to addresses ALWAYS use the platform subdomain (mail.thorbis.com),\n * even when sending from personal Gmail. This ensures replies go to the company's\n * centralized inbox, not the personal Gmail account.\n *\n * Example:\n * - FROM: john@gmail.com (personal Gmail)\n * - REPLY-TO: support@acme-plumbing.mail.thorbis.com (platform subdomain)\n *\n * See: /docs/email/REPLY_TO_ARCHITECTURE.md for full details\n *\n * This module provides Gmail API integration at two levels:\n * 1. Company-Level: One Gmail account for the entire company (sending only)\n * 2. Per-User: Individual team member Gmail accounts (inbox access + sending)\n *\n * Multi-Tenant Architecture:\n * - Each company can configure their own email provider\n * - Options: 'managed' (Resend/Postmark), 'gmail', or 'disabled'\n * - Company tokens stored in company_gmail_tokens table\n * - Per-user tokens stored in user_gmail_tokens table\n *\n * Key Features:\n * - Send emails via company's Gmail API\n * - Per-user inbox access and synchronization\n * - Automatic token refresh before expiration\n * - Token validation and error handling\n * - Integration with provider monitoring\n *\n * How It Works (Company-Level):\n * 1. Company admin connects Gmail via OAuth (grants gmail.send scope)\n * 2. Tokens stored in company_gmail_tokens table\n * 3. Before sending, we check/refresh tokens\n * 4. Use Gmail API to send email as company\n *\n * How It Works (Per-User):\n * 1. Team member connects their Gmail via OAuth (grants gmail.readonly + gmail.send)\n * 2. Tokens stored in user_gmail_tokens table\n * 3. Background sync job fetches inbox emails every 5-10 minutes\n * 4. Emails stored in communications table with mailbox_owner_id\n * 5. Role-based permissions control who can see which emails\n *\n * Rate Limits (Gmail API):\n * - Consumer accounts: 100 emails/day\n * - Google Workspace: 2,000 emails/day\n * - Per-minute limit: 100 messages\n *\n * Required Scopes:\n * - Company: https://www.googleapis.com/auth/gmail.send\n * - Per-User: https://www.googleapis.com/auth/gmail.readonly, gmail.send\n *\n * Environment Variables:\n * - GOOGLE_CLIENT_ID: OAuth client ID\n * - GOOGLE_CLIENT_SECRET: OAuth client secret\n *\n * @see https://developers.google.com/gmail/api/reference/rest\n */\n\n\"use server\";\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\nimport { encryptToken, decryptToken } from \"@/lib/email/token-encryption\";\nimport { checkSyncRateLimit, acquireSyncLock, releaseSyncLock, checkApiRateLimit, validateSyncParams } from \"@/lib/email/gmail-rate-limiter\";\nimport { logGmailConnected, logGmailDisconnected, logAuditEvent, logTokenRefreshFailed, logSyncFailed } from \"@/lib/email/audit-logger\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Company email provider options\n */\nexport type CompanyEmailProvider = \"managed\" | \"gmail\" | \"disabled\";\n\n/**\n * Gmail OAuth token data structure (company-level)\n */\nexport interface CompanyGmailTokenData {\n\tcompanyId: string;\n\tgmailEmail: string;\n\tgmailDisplayName?: string;\n\taccessToken: string;\n\trefreshToken: string;\n\ttokenExpiresAt: Date;\n\tisValid: boolean;\n\tscopes: string[];\n\tconnectedBy?: string;\n\tconnectedByName?: string;\n}\n\n/**\n * Result of sending an email via Gmail\n */\nexport interface GmailSendResult {\n\tsuccess: boolean;\n\tmessageId?: string;\n\tthreadId?: string;\n\terror?: string;\n\tlabelIds?: string[];\n}\n\n/**\n * Email data for Gmail sending\n */\nexport interface GmailEmailData {\n\tto: string | string[];\n\tsubject: string;\n\thtml: string;\n\ttext?: string;\n\treplyTo?: string;\n\tcc?: string | string[];\n\tbcc?: string | string[];\n\theaders?: Record<string, string>;\n}\n\n/**\n * Token refresh response from Google\n */\ninterface GoogleTokenResponse {\n\taccess_token: string;\n\texpires_in: number;\n\ttoken_type: string;\n\tscope?: string;\n\trefresh_token?: string;\n}\n\n/**\n * Per-user Gmail token data structure\n */\nexport interface UserGmailTokenData {\n\tteamMemberId: string;\n\temailAccountId: string;\n\tgmailEmail: string;\n\taccessToken: string;\n\trefreshToken: string;\n\ttokenExpiresAt: Date;\n\tscopes: string[];\n\tsyncEnabled: boolean;\n\tlastSyncedAt?: Date;\n}\n\n/**\n * Gmail message from API\n */\nexport interface GmailMessage {\n\tid: string;\n\tthreadId: string;\n\tlabelIds: string[];\n\tsnippet: string;\n\tpayload: {\n\t\theaders: Array<{ name: string; value: string }>;\n\t\tparts?: Array<{\n\t\t\tmimeType: string;\n\t\t\tbody: { data?: string; size: number };\n\t\t\tparts?: any[];\n\t\t}>;\n\t\tbody?: { data?: string; size: number };\n\t\tmimeType: string;\n\t};\n\tinternalDate: string;\n\tsizeEstimate: number;\n}\n\n/**\n * Parsed email message\n */\nexport interface ParsedGmailMessage {\n\tgmailMessageId: string;\n\tgmailThreadId: string;\n\tfrom: string;\n\tto: string[];\n\tcc?: string[];\n\tsubject: string;\n\ttextBody?: string;\n\thtmlBody?: string;\n\treceivedAt: Date;\n\thasAttachments: boolean;\n\tlabels: string[];\n}\n\n/**\n * Inbox sync result\n */\nexport interface InboxSyncResult {\n\tsuccess: boolean;\n\tmessagesFetched: number;\n\tmessagesStored: number;\n\terrors: string[];\n\tlastSyncedAt: Date;\n}\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\nconst GOOGLE_TOKEN_URL = \"https://oauth2.googleapis.com/token\";\nconst GMAIL_API_URL = \"https://gmail.googleapis.com/gmail/v1\";\nconst GMAIL_SEND_SCOPE = \"https://www.googleapis.com/auth/gmail.send\";\nconst GMAIL_READONLY_SCOPE = \"https://www.googleapis.com/auth/gmail.readonly\";\nconst GMAIL_MODIFY_SCOPE = \"https://www.googleapis.com/auth/gmail.modify\";\nconst TOKEN_REFRESH_BUFFER_MS = 5 * 60 * 1000;\n\n// =============================================================================\n// COMPANY EMAIL PROVIDER PREFERENCE\n// =============================================================================\n\n/**\n * Get company's email provider preference\n */\nexport async function getCompanyEmailProvider(\n\tcompanyId: string\n): Promise<CompanyEmailProvider> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tconst { data } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"email_provider\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\treturn (data?.email_provider as CompanyEmailProvider) || \"managed\";\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] Error getting company email provider:\", error);\n\t\treturn \"managed\";\n\t}\n}\n\n/**\n * Set company's email provider preference\n */\nexport async function setCompanyEmailProvider(\n\tcompanyId: string,\n\tprovider: CompanyEmailProvider,\n\tupdatedByUserId?: string\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\t// If switching to Gmail, verify tokens exist\n\t\tif (provider === \"gmail\") {\n\t\t\tconst tokens = await getCompanyGmailTokens(companyId);\n\t\t\tif (!tokens || !tokens.isValid) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: \"Gmail is not connected. Please connect Gmail first.\",\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tconst { error } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.update({\n\t\t\t\temail_provider: provider,\n\t\t\t\temail_provider_updated_at: new Date().toISOString(),\n\t\t\t\temail_provider_updated_by: updatedByUserId || null,\n\t\t\t})\n\t\t\t.eq(\"id\", companyId);\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\tconsole.log(`[Gmail] Company ${companyId} email provider set to: ${provider}`);\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\treturn { success: false, error: message };\n\t}\n}\n\n// =============================================================================\n// TOKEN MANAGEMENT (COMPANY-LEVEL)\n// =============================================================================\n\n/**\n * Get Gmail tokens for a company\n */\nexport async function getCompanyGmailTokens(\n\tcompanyId: string\n): Promise<CompanyGmailTokenData | null> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"company_gmail_tokens\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.maybeSingle();\n\n\t\tif (error || !data) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst tokenData: CompanyGmailTokenData = {\n\t\t\tcompanyId: data.company_id,\n\t\t\tgmailEmail: data.gmail_email,\n\t\t\tgmailDisplayName: data.gmail_display_name,\n\t\t\taccessToken: data.access_token,\n\t\t\trefreshToken: data.refresh_token,\n\t\t\ttokenExpiresAt: new Date(data.token_expires_at),\n\t\t\tisValid: data.is_valid,\n\t\t\tscopes: data.scopes || [GMAIL_SEND_SCOPE],\n\t\t\tconnectedBy: data.connected_by,\n\t\t\tconnectedByName: data.connected_by_name,\n\t\t};\n\n\t\t// Check if token needs refresh\n\t\tif (isTokenExpiringSoon(tokenData.tokenExpiresAt)) {\n\t\t\tconsole.log(`[Gmail] Token expiring soon for company ${companyId}, refreshing...`);\n\t\t\tconst refreshed = await refreshCompanyGmailToken(companyId, tokenData.refreshToken);\n\t\t\tif (refreshed) {\n\t\t\t\treturn refreshed;\n\t\t\t}\n\t\t\tconsole.warn(\"[Gmail] Token refresh failed, using existing token\");\n\t\t}\n\n\t\treturn tokenData;\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] Error getting company tokens:\", error);\n\t\treturn null;\n\t}\n}\n\nfunction isTokenExpiringSoon(expiresAt: Date): boolean {\n\treturn expiresAt.getTime() - Date.now() < TOKEN_REFRESH_BUFFER_MS;\n}\n\n/**\n * Refresh Gmail OAuth token for a company\n */\nexport async function refreshCompanyGmailToken(\n\tcompanyId: string,\n\trefreshToken: string\n): Promise<CompanyGmailTokenData | null> {\n\ttry {\n\t\tconst clientId = process.env.GOOGLE_CLIENT_ID;\n\t\tconst clientSecret = process.env.GOOGLE_CLIENT_SECRET;\n\n\t\tif (!clientId || !clientSecret) {\n\t\t\tconsole.error(\"[Gmail] Missing GOOGLE_CLIENT_ID or GOOGLE_CLIENT_SECRET\");\n\t\t\treturn null;\n\t\t}\n\n\t\tconst response = await fetch(GOOGLE_TOKEN_URL, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n\t\t\tbody: new URLSearchParams({\n\t\t\t\tclient_id: clientId,\n\t\t\t\tclient_secret: clientSecret,\n\t\t\t\trefresh_token: refreshToken,\n\t\t\t\tgrant_type: \"refresh_token\",\n\t\t\t}),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tconst errorText = await response.text();\n\t\t\tconsole.error(`[Gmail] Token refresh failed: ${response.status}`, errorText);\n\t\t\tif (response.status === 400 || response.status === 401) {\n\t\t\t\tawait markCompanyTokenInvalid(companyId, `Refresh failed: ${response.status}`);\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\n\t\tconst tokenResponse: GoogleTokenResponse = await response.json();\n\t\tconst expiresAt = new Date(Date.now() + tokenResponse.expires_in * 1000);\n\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"company_gmail_tokens\")\n\t\t\t.update({\n\t\t\t\taccess_token: tokenResponse.access_token,\n\t\t\t\ttoken_expires_at: expiresAt.toISOString(),\n\t\t\t\t...(tokenResponse.refresh_token && { refresh_token: tokenResponse.refresh_token }),\n\t\t\t\tis_valid: true,\n\t\t\t\tlast_error: null,\n\t\t\t})\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select(\"*\")\n\t\t\t.single();\n\n\t\tif (error || !data) {\n\t\t\tconsole.error(\"[Gmail] Failed to update refreshed token:\", error?.message);\n\t\t\treturn null;\n\t\t}\n\n\t\tconsole.log(`[Gmail] Token refreshed for company ${companyId}`);\n\n\t\treturn {\n\t\t\tcompanyId: data.company_id,\n\t\t\tgmailEmail: data.gmail_email,\n\t\t\tgmailDisplayName: data.gmail_display_name,\n\t\t\taccessToken: data.access_token,\n\t\t\trefreshToken: data.refresh_token,\n\t\t\ttokenExpiresAt: new Date(data.token_expires_at),\n\t\t\tisValid: data.is_valid,\n\t\t\tscopes: data.scopes || [GMAIL_SEND_SCOPE],\n\t\t\tconnectedBy: data.connected_by,\n\t\t\tconnectedByName: data.connected_by_name,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] Token refresh error:\", error);\n\t\treturn null;\n\t}\n}\n\nasync function markCompanyTokenInvalid(companyId: string, reason: string): Promise<void> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tawait supabase\n\t\t\t.from(\"company_gmail_tokens\")\n\t\t\t.update({ is_valid: false, last_error: reason })\n\t\t\t.eq(\"company_id\", companyId);\n\t\tconsole.log(`[Gmail] Marked token invalid for company ${companyId}: ${reason}`);\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] Failed to mark token invalid:\", error);\n\t}\n}\n\n/**\n * Store Gmail OAuth tokens for a company\n */\nexport async function storeCompanyGmailTokens(\n\tcompanyId: string,\n\tgmailEmail: string,\n\tdisplayName: string | null,\n\taccessToken: string,\n\trefreshToken: string,\n\texpiresIn: number,\n\tscopes: string[],\n\tconnectedByUserId?: string,\n\tconnectedByName?: string\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tif (!scopes.includes(GMAIL_SEND_SCOPE)) {\n\t\t\treturn { success: false, error: `Missing required scope: ${GMAIL_SEND_SCOPE}` };\n\t\t}\n\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tconst expiresAt = new Date(Date.now() + expiresIn * 1000);\n\n\t\tconst { error } = await supabase.from(\"company_gmail_tokens\").upsert(\n\t\t\t{\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tgmail_email: gmailEmail,\n\t\t\t\tgmail_display_name: displayName,\n\t\t\t\taccess_token: accessToken,\n\t\t\t\trefresh_token: refreshToken,\n\t\t\t\ttoken_expires_at: expiresAt.toISOString(),\n\t\t\t\tscopes,\n\t\t\t\tis_valid: true,\n\t\t\t\tlast_error: null,\n\t\t\t\tconnected_by: connectedByUserId || null,\n\t\t\t\tconnected_by_name: connectedByName || null,\n\t\t\t},\n\t\t\t{ onConflict: \"company_id\" }\n\t\t);\n\n\t\tif (error) {\n\t\t\tconsole.error(\"[Gmail] Failed to store tokens:\", error.message);\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\tconsole.log(`[Gmail] Stored tokens for company ${companyId} (${gmailEmail})`);\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\treturn { success: false, error: message };\n\t}\n}\n\n/**\n * Disconnect Gmail from a company\n */\nexport async function disconnectCompanyGmail(\n\tcompanyId: string\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\t// Get token to revoke\n\t\tconst { data: tokenData } = await supabase\n\t\t\t.from(\"company_gmail_tokens\")\n\t\t\t.select(\"access_token\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\t// Delete from database\n\t\tconst { error } = await supabase\n\t\t\t.from(\"company_gmail_tokens\")\n\t\t\t.delete()\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\t// Reset to managed provider\n\t\tawait setCompanyEmailProvider(companyId, \"managed\");\n\n\t\t// Revoke token with Google (best effort)\n\t\tif (tokenData?.access_token) {\n\t\t\ttry {\n\t\t\t\tawait fetch(`https://oauth2.googleapis.com/revoke?token=${tokenData.access_token}`, {\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t});\n\t\t\t} catch {\n\t\t\t\tconsole.warn(\"[Gmail] Token revocation request failed (non-critical)\");\n\t\t\t}\n\t\t}\n\n\t\tconsole.log(`[Gmail] Disconnected Gmail for company ${companyId}`);\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\treturn { success: false, error: message };\n\t}\n}\n\n// =============================================================================\n// EMAIL SENDING\n// =============================================================================\n\n/**\n * Send an email via company's Gmail\n */\nexport async function sendCompanyGmailEmail(\n\tcompanyId: string,\n\temailData: GmailEmailData\n): Promise<GmailSendResult> {\n\ttry {\n\t\tconst tokens = await getCompanyGmailTokens(companyId);\n\t\tif (!tokens) {\n\t\t\treturn { success: false, error: \"Gmail not connected for this company\" };\n\t\t}\n\n\t\tif (!tokens.isValid) {\n\t\t\treturn { success: false, error: `Gmail connection invalid: ${tokens.gmailEmail}` };\n\t\t}\n\n\t\tconst mimeMessage = buildMimeMessage({\n\t\t\tfrom: tokens.gmailDisplayName\n\t\t\t\t? `${tokens.gmailDisplayName} <${tokens.gmailEmail}>`\n\t\t\t\t: tokens.gmailEmail,\n\t\t\tto: Array.isArray(emailData.to) ? emailData.to.join(\", \") : emailData.to,\n\t\t\tsubject: emailData.subject,\n\t\t\thtml: emailData.html,\n\t\t\ttext: emailData.text,\n\t\t\treplyTo: emailData.replyTo,\n\t\t\tcc: emailData.cc ? (Array.isArray(emailData.cc) ? emailData.cc.join(\", \") : emailData.cc) : undefined,\n\t\t\tbcc: emailData.bcc ? (Array.isArray(emailData.bcc) ? emailData.bcc.join(\", \") : emailData.bcc) : undefined,\n\t\t\theaders: emailData.headers,\n\t\t});\n\n\t\tconst encodedMessage = base64UrlEncode(mimeMessage);\n\n\t\tconst response = await fetch(`${GMAIL_API_URL}/users/me/messages/send`, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: {\n\t\t\t\tAuthorization: `Bearer ${tokens.accessToken}`,\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t},\n\t\t\tbody: JSON.stringify({ raw: encodedMessage }),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tconst errorData = await response.json().catch(() => ({}));\n\t\t\tconst errorMessage = errorData.error?.message || `Gmail API error: ${response.status}`;\n\t\t\tconsole.error(`[Gmail] Send failed: ${errorMessage}`);\n\t\t\tif (response.status === 401) {\n\t\t\t\tawait markCompanyTokenInvalid(companyId, \"Authentication failed\");\n\t\t\t}\n\t\t\treturn { success: false, error: errorMessage };\n\t\t}\n\n\t\tconst result = await response.json();\n\n\t\t// Update last used timestamp\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tawait supabase\n\t\t\t.from(\"company_gmail_tokens\")\n\t\t\t.update({ last_used_at: new Date().toISOString() })\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tconsole.log(`[Gmail] Sent email for company ${companyId} (ID: ${result.id})`);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.id,\n\t\t\tthreadId: result.threadId,\n\t\t\tlabelIds: result.labelIds,\n\t\t};\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\tconsole.error(\"[Gmail] Send error:\", message);\n\t\treturn { success: false, error: message };\n\t}\n}\n\n// =============================================================================\n// MIME MESSAGE BUILDING\n// =============================================================================\n\ninterface MimeMessageParts {\n\tfrom: string;\n\tto: string;\n\tsubject: string;\n\thtml: string;\n\ttext?: string;\n\treplyTo?: string;\n\tcc?: string;\n\tbcc?: string;\n\theaders?: Record<string, string>;\n}\n\nfunction buildMimeMessage(parts: MimeMessageParts): string {\n\tconst boundary = `boundary_${Date.now()}_${Math.random().toString(36).substring(7)}`;\n\n\tconst lines: string[] = [\n\t\t`From: ${parts.from}`,\n\t\t`To: ${parts.to}`,\n\t\t`Subject: =?UTF-8?B?${Buffer.from(parts.subject).toString(\"base64\")}?=`,\n\t\t\"MIME-Version: 1.0\",\n\t];\n\n\tif (parts.replyTo) lines.push(`Reply-To: ${parts.replyTo}`);\n\tif (parts.cc) lines.push(`Cc: ${parts.cc}`);\n\tif (parts.bcc) lines.push(`Bcc: ${parts.bcc}`);\n\n\tif (parts.headers) {\n\t\tfor (const [key, value] of Object.entries(parts.headers)) {\n\t\t\tlines.push(`${key}: ${value}`);\n\t\t}\n\t}\n\n\tlines.push(`Content-Type: multipart/alternative; boundary=\"${boundary}\"`);\n\tlines.push(\"\");\n\n\tconst textContent = parts.text || extractTextFromHtml(parts.html);\n\tlines.push(`--${boundary}`);\n\tlines.push(\"Content-Type: text/plain; charset=UTF-8\");\n\tlines.push(\"Content-Transfer-Encoding: base64\");\n\tlines.push(\"\");\n\tlines.push(Buffer.from(textContent).toString(\"base64\"));\n\n\tlines.push(`--${boundary}`);\n\tlines.push(\"Content-Type: text/html; charset=UTF-8\");\n\tlines.push(\"Content-Transfer-Encoding: base64\");\n\tlines.push(\"\");\n\tlines.push(Buffer.from(parts.html).toString(\"base64\"));\n\n\tlines.push(`--${boundary}--`);\n\n\treturn lines.join(\"\\r\\n\");\n}\n\nfunction extractTextFromHtml(html: string): string {\n\treturn html\n\t\t.replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, \"\")\n\t\t.replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, \"\")\n\t\t.replace(/<[^>]+>/g, \" \")\n\t\t.replace(/\\s+/g, \" \")\n\t\t.trim();\n}\n\nfunction base64UrlEncode(str: string): string {\n\treturn Buffer.from(str)\n\t\t.toString(\"base64\")\n\t\t.replace(/\\+/g, \"-\")\n\t\t.replace(/\\//g, \"_\")\n\t\t.replace(/=+$/, \"\");\n}\n\n// =============================================================================\n// HEALTH CHECK\n// =============================================================================\n\n/**\n * Check Gmail health for a company\n */\nexport async function checkCompanyGmailHealth(\n\tcompanyId: string,\n\ttestApi: boolean = false\n): Promise<{\n\tconnected: boolean;\n\temail?: string;\n\tdisplayName?: string;\n\ttokenValid: boolean;\n\ttokenExpiresAt?: Date;\n\tapiHealthy?: boolean;\n\tconnectedBy?: string;\n\terror?: string;\n}> {\n\ttry {\n\t\tconst tokens = await getCompanyGmailTokens(companyId);\n\n\t\tif (!tokens) {\n\t\t\treturn { connected: false, tokenValid: false };\n\t\t}\n\n\t\tconst result = {\n\t\t\tconnected: true,\n\t\t\temail: tokens.gmailEmail,\n\t\t\tdisplayName: tokens.gmailDisplayName,\n\t\t\ttokenValid: tokens.isValid,\n\t\t\ttokenExpiresAt: tokens.tokenExpiresAt,\n\t\t\tconnectedBy: tokens.connectedByName,\n\t\t\tapiHealthy: undefined as boolean | undefined,\n\t\t};\n\n\t\tif (testApi && tokens.isValid) {\n\t\t\ttry {\n\t\t\t\tconst response = await fetch(`${GMAIL_API_URL}/users/me/profile`, {\n\t\t\t\t\theaders: { Authorization: `Bearer ${tokens.accessToken}` },\n\t\t\t\t});\n\t\t\t\tresult.apiHealthy = response.ok;\n\t\t\t} catch {\n\t\t\t\tresult.apiHealthy = false;\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tconnected: false,\n\t\t\ttokenValid: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// PER-USER TOKEN MANAGEMENT\n// =============================================================================\n\n/**\n * Get Gmail tokens for a specific team member\n */\nexport async function getUserGmailTokens(\n\tteamMemberId: string\n): Promise<UserGmailTokenData | null> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"user_gmail_tokens\")\n\t\t\t.select(\"*, user_email_accounts!inner(email_address)\")\n\t\t\t.eq(\"team_member_id\", teamMemberId)\n\t\t\t.eq(\"sync_enabled\", true)\n\t\t\t.maybeSingle();\n\n\t\tif (error || !data) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Decrypt tokens before using (CRITICAL SECURITY)\n\t\tconst decryptedAccessToken = decryptToken(data.access_token);\n\t\tconst decryptedRefreshToken = decryptToken(data.refresh_token);\n\n\t\tconst tokenData: UserGmailTokenData = {\n\t\t\tteamMemberId: data.team_member_id,\n\t\t\temailAccountId: data.user_email_account_id,\n\t\t\tgmailEmail: data.user_email_accounts.email_address,\n\t\t\taccessToken: decryptedAccessToken,\n\t\t\trefreshToken: decryptedRefreshToken,\n\t\t\ttokenExpiresAt: new Date(data.token_expiry),\n\t\t\tscopes: data.scopes || [],\n\t\t\tsyncEnabled: data.sync_enabled,\n\t\t\tlastSyncedAt: data.last_synced_at ? new Date(data.last_synced_at) : undefined,\n\t\t};\n\n\t\t// Check if token needs refresh\n\t\tif (isTokenExpiringSoon(tokenData.tokenExpiresAt)) {\n\t\t\tconsole.log(`[Gmail] Token expiring soon for user ${teamMemberId}, refreshing...`);\n\t\t\tconst refreshed = await refreshUserGmailToken(teamMemberId, tokenData.refreshToken);\n\t\t\tif (refreshed) {\n\t\t\t\treturn refreshed;\n\t\t\t}\n\t\t\tconsole.warn(\"[Gmail] User token refresh failed, using existing token\");\n\t\t}\n\n\t\treturn tokenData;\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] Error getting user tokens:\", error);\n\t\treturn null;\n\t}\n}\n\n/**\n * Refresh Gmail OAuth token for a team member\n */\nexport async function refreshUserGmailToken(\n\tteamMemberId: string,\n\trefreshToken: string\n): Promise<UserGmailTokenData | null> {\n\ttry {\n\t\tconst clientId = process.env.GOOGLE_CLIENT_ID;\n\t\tconst clientSecret = process.env.GOOGLE_CLIENT_SECRET;\n\n\t\tif (!clientId || !clientSecret) {\n\t\t\tconsole.error(\"[Gmail] Missing GOOGLE_CLIENT_ID or GOOGLE_CLIENT_SECRET\");\n\t\t\treturn null;\n\t\t}\n\n\t\tconst response = await fetch(GOOGLE_TOKEN_URL, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n\t\t\tbody: new URLSearchParams({\n\t\t\t\tclient_id: clientId,\n\t\t\t\tclient_secret: clientSecret,\n\t\t\t\trefresh_token: refreshToken,\n\t\t\t\tgrant_type: \"refresh_token\",\n\t\t\t}),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tconst errorText = await response.text();\n\t\t\tconsole.error(`[Gmail] User token refresh failed: ${response.status}`, errorText);\n\n\t\t\t// Log token refresh failure for audit trail\n\t\t\tawait logTokenRefreshFailed(\n\t\t\t\tteamMemberId,\n\t\t\t\t\"Unknown\", // Gmail email not available here\n\t\t\t\t`Token refresh failed: ${response.status} - ${errorText}`\n\t\t\t);\n\n\t\t\tif (response.status === 400 || response.status === 401) {\n\t\t\t\tawait markUserTokenInvalid(teamMemberId, `Refresh failed: ${response.status}`);\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\n\t\tconst tokenResponse: GoogleTokenResponse = await response.json();\n\t\tconst expiresAt = new Date(Date.now() + tokenResponse.expires_in * 1000);\n\n\t\t// Encrypt refreshed tokens before storing (CRITICAL SECURITY)\n\t\tconst encryptedAccessToken = encryptToken(tokenResponse.access_token);\n\t\tconst encryptedRefreshToken = tokenResponse.refresh_token\n\t\t\t? encryptToken(tokenResponse.refresh_token)\n\t\t\t: undefined;\n\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"user_gmail_tokens\")\n\t\t\t.update({\n\t\t\t\taccess_token: encryptedAccessToken,\n\t\t\t\ttoken_expiry: expiresAt.toISOString(),\n\t\t\t\t...(encryptedRefreshToken && { refresh_token: encryptedRefreshToken }),\n\t\t\t})\n\t\t\t.eq(\"team_member_id\", teamMemberId)\n\t\t\t.select(\"*, user_email_accounts!inner(email_address)\")\n\t\t\t.single();\n\n\t\tif (error || !data) {\n\t\t\tconsole.error(\"[Gmail] Failed to update refreshed user token:\", error?.message);\n\t\t\treturn null;\n\t\t}\n\n\t\tconsole.log(`[Gmail] User token refreshed for team member ${teamMemberId}`);\n\n\t\t// Decrypt tokens for return (already encrypted in DB)\n\t\tconst decryptedAccessToken = decryptToken(data.access_token);\n\t\tconst decryptedRefreshToken = decryptToken(data.refresh_token);\n\n\t\treturn {\n\t\t\tteamMemberId: data.team_member_id,\n\t\t\temailAccountId: data.user_email_account_id,\n\t\t\tgmailEmail: data.user_email_accounts.email_address,\n\t\t\taccessToken: decryptedAccessToken,\n\t\t\trefreshToken: decryptedRefreshToken,\n\t\t\ttokenExpiresAt: new Date(data.token_expiry),\n\t\t\tscopes: data.scopes || [],\n\t\t\tsyncEnabled: data.sync_enabled,\n\t\t\tlastSyncedAt: data.last_synced_at ? new Date(data.last_synced_at) : undefined,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] User token refresh error:\", error);\n\t\treturn null;\n\t}\n}\n\nasync function markUserTokenInvalid(teamMemberId: string, reason: string): Promise<void> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tawait supabase\n\t\t\t.from(\"user_gmail_tokens\")\n\t\t\t.update({ sync_enabled: false })\n\t\t\t.eq(\"team_member_id\", teamMemberId);\n\t\tconsole.log(`[Gmail] Disabled sync for team member ${teamMemberId}: ${reason}`);\n\t} catch (error) {\n\t\tconsole.error(\"[Gmail] Failed to mark user token invalid:\", error);\n\t}\n}\n\n/**\n * Store Gmail OAuth tokens for a team member\n */\nexport async function storeUserGmailTokens(\n\tteamMemberId: string,\n\temailAccountId: string,\n\taccessToken: string,\n\trefreshToken: string,\n\texpiresIn: number,\n\tscopes: string[]\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tif (!scopes.includes(GMAIL_READONLY_SCOPE) && !scopes.includes(GMAIL_MODIFY_SCOPE)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Missing required scope: ${GMAIL_READONLY_SCOPE} or ${GMAIL_MODIFY_SCOPE}`,\n\t\t\t};\n\t\t}\n\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tconst expiresAt = new Date(Date.now() + expiresIn * 1000);\n\n\t\t// Encrypt tokens before storing (CRITICAL SECURITY)\n\t\tconst encryptedAccessToken = encryptToken(accessToken);\n\t\tconst encryptedRefreshToken = encryptToken(refreshToken);\n\n\t\tconst { error } = await supabase.from(\"user_gmail_tokens\").upsert(\n\t\t\t{\n\t\t\t\tteam_member_id: teamMemberId,\n\t\t\t\tuser_email_account_id: emailAccountId,\n\t\t\t\taccess_token: encryptedAccessToken,\n\t\t\t\trefresh_token: encryptedRefreshToken,\n\t\t\t\ttoken_expiry: expiresAt.toISOString(),\n\t\t\t\tscopes,\n\t\t\t\tsync_enabled: true,\n\t\t\t\tlast_synced_at: null,\n\t\t\t},\n\t\t\t{ onConflict: \"user_email_account_id\" }\n\t\t);\n\n\t\tif (error) {\n\t\t\tconsole.error(\"[Gmail] Failed to store user tokens:\", error.message);\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\tconsole.log(`[Gmail] Stored encrypted tokens for team member ${teamMemberId}`);\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\treturn { success: false, error: message };\n\t}\n}\n\n/**\n * Disconnect Gmail for a team member\n */\nexport async function disconnectUserGmail(\n\tteamMemberId: string\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\t// Get token to revoke\n\t\tconst { data: tokenData } = await supabase\n\t\t\t.from(\"user_gmail_tokens\")\n\t\t\t.select(\"access_token\")\n\t\t\t.eq(\"team_member_id\", teamMemberId)\n\t\t\t.single();\n\n\t\t// Delete from database\n\t\tconst { error } = await supabase\n\t\t\t.from(\"user_gmail_tokens\")\n\t\t\t.delete()\n\t\t\t.eq(\"team_member_id\", teamMemberId);\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\t// Revoke token with Google (best effort)\n\t\tif (tokenData?.access_token) {\n\t\t\ttry {\n\t\t\t\tawait fetch(`https://oauth2.googleapis.com/revoke?token=${tokenData.access_token}`, {\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t});\n\t\t\t} catch {\n\t\t\t\tconsole.warn(\"[Gmail] User token revocation request failed (non-critical)\");\n\t\t\t}\n\t\t}\n\n\t\tconsole.log(`[Gmail] Disconnected Gmail for team member ${teamMemberId}`);\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\treturn { success: false, error: message };\n\t}\n}\n\n// =============================================================================\n// INBOX FETCHING\n// =============================================================================\n\n/**\n * Fetch inbox messages for a team member\n */\nexport async function fetchUserInbox(\n\tteamMemberId: string,\n\tmaxResults: number = 50,\n\tpageToken?: string\n): Promise<{ messages: GmailMessage[]; nextPageToken?: string; error?: string }> {\n\ttry {\n\t\tconst tokens = await getUserGmailTokens(teamMemberId);\n\t\tif (!tokens) {\n\t\t\treturn { messages: [], error: \"Gmail not connected for this user\" };\n\t\t}\n\n\t\t// Build query parameters\n\t\tconst params = new URLSearchParams({\n\t\t\tmaxResults: maxResults.toString(),\n\t\t\tq: \"in:inbox\", // Only fetch inbox messages\n\t\t\t...(pageToken && { pageToken }),\n\t\t});\n\n\t\t// List messages\n\t\tconst listResponse = await fetch(\n\t\t\t`${GMAIL_API_URL}/users/me/messages?${params}`,\n\t\t\t{\n\t\t\t\theaders: { Authorization: `Bearer ${tokens.accessToken}` },\n\t\t\t}\n\t\t);\n\n\t\tif (!listResponse.ok) {\n\t\t\tconst errorText = await listResponse.text();\n\t\t\tconsole.error(`[Gmail] Inbox fetch failed: ${listResponse.status}`, errorText);\n\t\t\treturn { messages: [], error: `API error: ${listResponse.status}` };\n\t\t}\n\n\t\tconst listData = await listResponse.json();\n\t\tconst messageIds = listData.messages || [];\n\t\tconst messages: GmailMessage[] = [];\n\n\t\t// Fetch full message details for each message\n\t\tfor (const msgRef of messageIds) {\n\t\t\tconst msgResponse = await fetch(\n\t\t\t\t`${GMAIL_API_URL}/users/me/messages/${msgRef.id}`,\n\t\t\t\t{\n\t\t\t\t\theaders: { Authorization: `Bearer ${tokens.accessToken}` },\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tif (msgResponse.ok) {\n\t\t\t\tconst msgData = await msgResponse.json();\n\t\t\t\tmessages.push(msgData);\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tmessages,\n\t\t\tnextPageToken: listData.nextPageToken,\n\t\t};\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\tconsole.error(\"[Gmail] Inbox fetch error:\", message);\n\t\treturn { messages: [], error: message };\n\t}\n}\n\n/**\n * Parse Gmail message to structured format\n */\nfunction parseGmailMessage(message: GmailMessage): ParsedGmailMessage {\n\tconst headers = message.payload.headers;\n\tconst getHeader = (name: string) => headers.find(h => h.name.toLowerCase() === name.toLowerCase())?.value || \"\";\n\n\tconst from = getHeader(\"From\");\n\tconst to = getHeader(\"To\").split(\",\").map(e => e.trim()).filter(Boolean);\n\tconst cc = getHeader(\"Cc\")?.split(\",\").map(e => e.trim()).filter(Boolean);\n\tconst subject = getHeader(\"Subject\");\n\n\t// Extract body content\n\tlet textBody: string | undefined;\n\tlet htmlBody: string | undefined;\n\n\tconst extractBody = (part: any): void => {\n\t\tif (part.mimeType === \"text/plain\" && part.body?.data) {\n\t\t\ttextBody = Buffer.from(part.body.data, \"base64\").toString(\"utf-8\");\n\t\t} else if (part.mimeType === \"text/html\" && part.body?.data) {\n\t\t\thtmlBody = Buffer.from(part.body.data, \"base64\").toString(\"utf-8\");\n\t\t}\n\n\t\tif (part.parts) {\n\t\t\tpart.parts.forEach(extractBody);\n\t\t}\n\t};\n\n\tif (message.payload.parts) {\n\t\tmessage.payload.parts.forEach(extractBody);\n\t} else if (message.payload.body?.data) {\n\t\t// Single part message\n\t\tif (message.payload.mimeType === \"text/plain\") {\n\t\t\ttextBody = Buffer.from(message.payload.body.data, \"base64\").toString(\"utf-8\");\n\t\t} else if (message.payload.mimeType === \"text/html\") {\n\t\t\thtmlBody = Buffer.from(message.payload.body.data, \"base64\").toString(\"utf-8\");\n\t\t}\n\t}\n\n\treturn {\n\t\tgmailMessageId: message.id,\n\t\tgmailThreadId: message.threadId,\n\t\tfrom,\n\t\tto,\n\t\tcc,\n\t\tsubject,\n\t\ttextBody,\n\t\thtmlBody,\n\t\treceivedAt: new Date(parseInt(message.internalDate)),\n\t\thasAttachments: message.payload.parts?.some(p => p.body.size > 0 && p.mimeType.startsWith(\"attachment/\")) || false,\n\t\tlabels: message.labelIds,\n\t};\n}\n\n/**\n * Store Gmail message in communications table\n */\nexport async function storeGmailMessage(\n\tcompanyId: string,\n\tteamMemberId: string,\n\temailAccountId: string,\n\tparsedMessage: ParsedGmailMessage\n): Promise<{ success: boolean; communicationId?: string; error?: string }> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\t// Check if message already exists\n\t\tconst { data: existing } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"gmail_message_id\", parsedMessage.gmailMessageId)\n\t\t\t.maybeSingle();\n\n\t\tif (existing) {\n\t\t\treturn { success: true, communicationId: existing.id };\n\t\t}\n\n\t\t// Extract customer email from \"from\" field\n\t\tconst fromEmail = parsedMessage.from.match(/<(.+?)>/)?.[1] || parsedMessage.from;\n\n\t\t// Try to find customer by email\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"email\", fromEmail)\n\t\t\t.maybeSingle();\n\n\t\t// Insert communication\n\t\tconst { data: communication, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\ttype: \"email\",\n\t\t\t\tdirection: \"inbound\",\n\t\t\t\tstatus: \"received\",\n\t\t\t\tfrom_address: fromEmail,\n\t\t\t\tto_address: parsedMessage.to[0] || \"\",\n\t\t\t\tsubject: parsedMessage.subject,\n\t\t\t\tbody: parsedMessage.htmlBody || parsedMessage.textBody || \"\",\n\t\t\t\tcustomer_id: customer?.id || null,\n\t\t\t\tmailbox_owner_id: teamMemberId,\n\t\t\t\temail_account_id: emailAccountId,\n\t\t\t\tvisibility_scope: \"private\", // Personal inbox emails default to private\n\t\t\t\tgmail_message_id: parsedMessage.gmailMessageId,\n\t\t\t\tgmail_thread_id: parsedMessage.gmailThreadId,\n\t\t\t})\n\t\t\t.select(\"id\")\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tconsole.error(\"[Gmail] Failed to store message:\", error.message);\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\treturn { success: true, communicationId: communication.id };\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\treturn { success: false, error: message };\n\t}\n}\n\n/**\n * Sync inbox for a team member\n */\nexport async function syncUserInbox(\n\tcompanyId: string,\n\tteamMemberId: string\n): Promise<InboxSyncResult> {\n\tconst startTime = new Date();\n\tlet messagesFetched = 0;\n\tlet messagesStored = 0;\n\tconst errors: string[] = [];\n\tlet syncLock: ReturnType<typeof acquireSyncLock> = null;\n\n\ttry {\n\t\t// Check rate limit before syncing (CRITICAL SAFEGUARD)\n\t\tconst rateLimitCheck = checkSyncRateLimit(teamMemberId);\n\t\tif (!rateLimitCheck.allowed) {\n\t\t\tawait logAuditEvent(\"sync_rate_limited\", {\n\t\t\t\tteamMemberId,\n\t\t\t\tretryAfter: rateLimitCheck.retryAfter,\n\t\t\t}, \"warning\");\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tmessagesFetched: 0,\n\t\t\t\tmessagesStored: 0,\n\t\t\t\terrors: [rateLimitCheck.reason || \"Rate limit exceeded\"],\n\t\t\t\tlastSyncedAt: startTime,\n\t\t\t};\n\t\t}\n\n\t\t// Acquire sync lock to prevent concurrent syncs\n\t\tsyncLock = acquireSyncLock(teamMemberId);\n\t\tif (!syncLock) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tmessagesFetched: 0,\n\t\t\t\tmessagesStored: 0,\n\t\t\t\terrors: [\"Could not acquire sync lock - another sync may be in progress\"],\n\t\t\t\tlastSyncedAt: startTime,\n\t\t\t};\n\t\t}\n\n\t\tawait logAuditEvent(\"sync_started\", { teamMemberId }, \"info\");\n\n\t\tconst tokens = await getUserGmailTokens(teamMemberId);\n\t\tif (!tokens) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tmessagesFetched: 0,\n\t\t\t\tmessagesStored: 0,\n\t\t\t\terrors: [\"Gmail not connected\"],\n\t\t\t\tlastSyncedAt: startTime,\n\t\t\t};\n\t\t}\n\n\t\t// Fetch messages since last sync (or all if never synced)\n\t\tlet pageToken: string | undefined;\n\t\tlet hasMore = true;\n\n\t\twhile (hasMore) {\n\t\t\tconst { messages, nextPageToken, error } = await fetchUserInbox(\n\t\t\t\tteamMemberId,\n\t\t\t\t50,\n\t\t\t\tpageToken\n\t\t\t);\n\n\t\t\tif (error) {\n\t\t\t\terrors.push(error);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tmessagesFetched += messages.length;\n\n\t\t\t// Store each message\n\t\t\tfor (const message of messages) {\n\t\t\t\tconst parsed = parseGmailMessage(message);\n\t\t\t\tconst { success, error: storeError } = await storeGmailMessage(\n\t\t\t\t\tcompanyId,\n\t\t\t\t\tteamMemberId,\n\t\t\t\t\ttokens.emailAccountId,\n\t\t\t\t\tparsed\n\t\t\t\t);\n\n\t\t\t\tif (success) {\n\t\t\t\t\tmessagesStored++;\n\t\t\t\t} else if (storeError) {\n\t\t\t\t\terrors.push(storeError);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Continue to next page if available\n\t\t\tpageToken = nextPageToken;\n\t\t\thasMore = !!nextPageToken && messages.length > 0;\n\t\t}\n\n\t\t// Update last synced timestamp\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tawait supabase\n\t\t\t.from(\"user_gmail_tokens\")\n\t\t\t.update({ last_synced_at: startTime.toISOString() })\n\t\t\t.eq(\"team_member_id\", teamMemberId);\n\n\t\tconsole.log(\n\t\t\t`[Gmail] Synced ${messagesStored}/${messagesFetched} messages for team member ${teamMemberId}`\n\t\t);\n\n\t\t// Log successful sync\n\t\tawait logAuditEvent(\"sync_completed\", {\n\t\t\tteamMemberId,\n\t\t\tsyncMessageCount: messagesStored,\n\t\t}, \"info\");\n\n\t\treturn {\n\t\t\tsuccess: errors.length === 0,\n\t\t\tmessagesFetched,\n\t\t\tmessagesStored,\n\t\t\terrors,\n\t\t\tlastSyncedAt: startTime,\n\t\t};\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\terrors.push(message);\n\n\t\t// Log failed sync\n\t\tawait logAuditEvent(\"sync_failed\", {\n\t\t\tteamMemberId,\n\t\t\terror: message,\n\t\t}, \"error\");\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tmessagesFetched,\n\t\t\tmessagesStored,\n\t\t\terrors,\n\t\t\tlastSyncedAt: startTime,\n\t\t};\n\t} finally {\n\t\t// Always release sync lock (CRITICAL)\n\t\tif (syncLock) {\n\t\t\treleaseSyncLock(syncLock);\n\t\t}\n\t}\n}\n\n// =============================================================================\n// INTEGRATION AVAILABILITY CHECK\n// =============================================================================\n\n/**\n * Check if Gmail integration is available (env vars configured)\n */\nexport async function isGmailIntegrationEnabled(): Promise<boolean> {\n\treturn !!(\n\t\tprocess.env.GOOGLE_CLIENT_ID &&\n\t\tprocess.env.GOOGLE_CLIENT_SECRET &&\n\t\tprocess.env.NEXT_PUBLIC_APP_URL\n\t);\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;CAyDC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAID;AACA;AACA;AACA;;;;;;;AAgIA,gFAAgF;AAChF,YAAY;AACZ,gFAAgF;AAEhF,MAAM,mBAAmB;AACzB,MAAM,gBAAgB;AACtB,MAAM,mBAAmB;AACzB,MAAM,uBAAuB;AAC7B,MAAM,qBAAqB;AAC3B,MAAM,0BAA0B,IAAI,KAAK;AASlC,eAAe,wBACrB,SAAiB;IAEjB,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAClD,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,aACL,MAAM,CAAC,kBACP,EAAE,CAAC,MAAM,WACT,MAAM;QAER,OAAO,AAAC,MAAM,kBAA2C;IAC1D,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,iDAAiD;QAC/D,OAAO;IACR;AACD;AAKO,eAAe,wBACrB,SAAiB,EACjB,QAA8B,EAC9B,eAAwB;IAExB,IAAI;QACH,6CAA6C;QAC7C,IAAI,aAAa,SAAS;YACzB,MAAM,SAAS,MAAM,sBAAsB;YAC3C,IAAI,CAAC,UAAU,CAAC,OAAO,OAAO,EAAE;gBAC/B,OAAO;oBACN,SAAS;oBACT,OAAO;gBACR;YACD;QACD;QAEA,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAClD,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACtB,IAAI,CAAC,aACL,MAAM,CAAC;YACP,gBAAgB;YAChB,2BAA2B,IAAI,OAAO,WAAW;YACjD,2BAA2B,mBAAmB;QAC/C,GACC,EAAE,CAAC,MAAM;QAEX,IAAI,OAAO;YACV,OAAO;gBAAE,SAAS;gBAAO,OAAO,MAAM,OAAO;YAAC;QAC/C;QAEA,QAAQ,GAAG,CAAC,CAAC,gBAAgB,EAAE,UAAU,wBAAwB,EAAE,UAAU;QAC7E,OAAO;YAAE,SAAS;QAAK;IACxB,EAAE,OAAO,OAAO;QACf,MAAM,UAAU,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACzD,OAAO;YAAE,SAAS;YAAO,OAAO;QAAQ;IACzC;AACD;AASO,eAAe,sBACrB,SAAiB;IAEjB,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAElD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,wBACL,MAAM,CAAC,KACP,EAAE,CAAC,cAAc,WACjB,WAAW;QAEb,IAAI,SAAS,CAAC,MAAM;YACnB,OAAO;QACR;QAEA,MAAM,YAAmC;YACxC,WAAW,KAAK,UAAU;YAC1B,YAAY,KAAK,WAAW;YAC5B,kBAAkB,KAAK,kBAAkB;YACzC,aAAa,KAAK,YAAY;YAC9B,cAAc,KAAK,aAAa;YAChC,gBAAgB,IAAI,KAAK,KAAK,gBAAgB;YAC9C,SAAS,KAAK,QAAQ;YACtB,QAAQ,KAAK,MAAM,IAAI;gBAAC;aAAiB;YACzC,aAAa,KAAK,YAAY;YAC9B,iBAAiB,KAAK,iBAAiB;QACxC;QAEA,+BAA+B;QAC/B,IAAI,oBAAoB,UAAU,cAAc,GAAG;YAClD,QAAQ,GAAG,CAAC,CAAC,wCAAwC,EAAE,UAAU,eAAe,CAAC;YACjF,MAAM,YAAY,MAAM,yBAAyB,WAAW,UAAU,YAAY;YAClF,IAAI,WAAW;gBACd,OAAO;YACR;YACA,QAAQ,IAAI,CAAC;QACd;QAEA,OAAO;IACR,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,yCAAyC;QACvD,OAAO;IACR;AACD;AAEA,SAAS,oBAAoB,SAAe;IAC3C,OAAO,UAAU,OAAO,KAAK,KAAK,GAAG,KAAK;AAC3C;AAKO,eAAe,yBACrB,SAAiB,EACjB,YAAoB;IAEpB,IAAI;QACH,MAAM,WAAW,QAAQ,GAAG,CAAC,gBAAgB;QAC7C,MAAM,eAAe,QAAQ,GAAG,CAAC,oBAAoB;QAErD,IAAI,CAAC,YAAY,CAAC,cAAc;YAC/B,QAAQ,KAAK,CAAC;YACd,OAAO;QACR;QAEA,MAAM,WAAW,MAAM,MAAM,kBAAkB;YAC9C,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAoC;YAC/D,MAAM,IAAI,gBAAgB;gBACzB,WAAW;gBACX,eAAe;gBACf,eAAe;gBACf,YAAY;YACb;QACD;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YACjB,MAAM,YAAY,MAAM,SAAS,IAAI;YACrC,QAAQ,KAAK,CAAC,CAAC,8BAA8B,EAAE,SAAS,MAAM,EAAE,EAAE;YAClE,IAAI,SAAS,MAAM,KAAK,OAAO,SAAS,MAAM,KAAK,KAAK;gBACvD,MAAM,wBAAwB,WAAW,CAAC,gBAAgB,EAAE,SAAS,MAAM,EAAE;YAC9E;YACA,OAAO;QACR;QAEA,MAAM,gBAAqC,MAAM,SAAS,IAAI;QAC9D,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,cAAc,UAAU,GAAG;QAEnE,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAClD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,wBACL,MAAM,CAAC;YACP,cAAc,cAAc,YAAY;YACxC,kBAAkB,UAAU,WAAW;YACvC,GAAI,cAAc,aAAa,IAAI;gBAAE,eAAe,cAAc,aAAa;YAAC,CAAC;YACjF,UAAU;YACV,YAAY;QACb,GACC,EAAE,CAAC,cAAc,WACjB,MAAM,CAAC,KACP,MAAM;QAER,IAAI,SAAS,CAAC,MAAM;YACnB,QAAQ,KAAK,CAAC,6CAA6C,OAAO;YAClE,OAAO;QACR;QAEA,QAAQ,GAAG,CAAC,CAAC,oCAAoC,EAAE,WAAW;QAE9D,OAAO;YACN,WAAW,KAAK,UAAU;YAC1B,YAAY,KAAK,WAAW;YAC5B,kBAAkB,KAAK,kBAAkB;YACzC,aAAa,KAAK,YAAY;YAC9B,cAAc,KAAK,aAAa;YAChC,gBAAgB,IAAI,KAAK,KAAK,gBAAgB;YAC9C,SAAS,KAAK,QAAQ;YACtB,QAAQ,KAAK,MAAM,IAAI;gBAAC;aAAiB;YACzC,aAAa,KAAK,YAAY;YAC9B,iBAAiB,KAAK,iBAAiB;QACxC;IACD,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO;IACR;AACD;AAEA,eAAe,wBAAwB,SAAiB,EAAE,MAAc;IACvE,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAClD,MAAM,SACJ,IAAI,CAAC,wBACL,MAAM,CAAC;YAAE,UAAU;YAAO,YAAY;QAAO,GAC7C,EAAE,CAAC,cAAc;QACnB,QAAQ,GAAG,CAAC,CAAC,yCAAyC,EAAE,UAAU,EAAE,EAAE,QAAQ;IAC/E,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,yCAAyC;IACxD;AACD;AAKO,eAAe,wBACrB,SAAiB,EACjB,UAAkB,EAClB,WAA0B,EAC1B,WAAmB,EACnB,YAAoB,EACpB,SAAiB,EACjB,MAAgB,EAChB,iBAA0B,EAC1B,eAAwB;IAExB,IAAI;QACH,IAAI,CAAC,OAAO,QAAQ,CAAC,mBAAmB;YACvC,OAAO;gBAAE,SAAS;gBAAO,OAAO,CAAC,wBAAwB,EAAE,kBAAkB;YAAC;QAC/E;QAEA,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAClD,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,YAAY;QAEpD,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,wBAAwB,MAAM,CACnE;YACC,YAAY;YACZ,aAAa;YACb,oBAAoB;YACpB,cAAc;YACd,eAAe;YACf,kBAAkB,UAAU,WAAW;YACvC;YACA,UAAU;YACV,YAAY;YACZ,cAAc,qBAAqB;YACnC,mBAAmB,mBAAmB;QACvC,GACA;YAAE,YAAY;QAAa;QAG5B,IAAI,OAAO;YACV,QAAQ,KAAK,CAAC,mCAAmC,MAAM,OAAO;YAC9D,OAAO;gBAAE,SAAS;gBAAO,OAAO,MAAM,OAAO;YAAC;QAC/C;QAEA,QAAQ,GAAG,CAAC,CAAC,kCAAkC,EAAE,UAAU,EAAE,EAAE,WAAW,CAAC,CAAC;QAC5E,OAAO;YAAE,SAAS;QAAK;IACxB,EAAE,OAAO,OAAO;QACf,MAAM,UAAU,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACzD,OAAO;YAAE,SAAS;YAAO,OAAO;QAAQ;IACzC;AACD;AAKO,eAAe,uBACrB,SAAiB;IAEjB,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAElD,sBAAsB;QACtB,MAAM,EAAE,MAAM,SAAS,EAAE,GAAG,MAAM,SAChC,IAAI,CAAC,wBACL,MAAM,CAAC,gBACP,EAAE,CAAC,cAAc,WACjB,MAAM;QAER,uBAAuB;QACvB,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACtB,IAAI,CAAC,wBACL,MAAM,GACN,EAAE,CAAC,cAAc;QAEnB,IAAI,OAAO;YACV,OAAO;gBAAE,SAAS;gBAAO,OAAO,MAAM,OAAO;YAAC;QAC/C;QAEA,4BAA4B;QAC5B,MAAM,wBAAwB,WAAW;QAEzC,yCAAyC;QACzC,IAAI,WAAW,cAAc;YAC5B,IAAI;gBACH,MAAM,MAAM,CAAC,2CAA2C,EAAE,UAAU,YAAY,EAAE,EAAE;oBACnF,QAAQ;gBACT;YACD,EAAE,OAAM;gBACP,QAAQ,IAAI,CAAC;YACd;QACD;QAEA,QAAQ,GAAG,CAAC,CAAC,uCAAuC,EAAE,WAAW;QACjE,OAAO;YAAE,SAAS;QAAK;IACxB,EAAE,OAAO,OAAO;QACf,MAAM,UAAU,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACzD,OAAO;YAAE,SAAS;YAAO,OAAO;QAAQ;IACzC;AACD;AASO,eAAe,sBACrB,SAAiB,EACjB,SAAyB;IAEzB,IAAI;QACH,MAAM,SAAS,MAAM,sBAAsB;QAC3C,IAAI,CAAC,QAAQ;YACZ,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAuC;QACxE;QAEA,IAAI,CAAC,OAAO,OAAO,EAAE;YACpB,OAAO;gBAAE,SAAS;gBAAO,OAAO,CAAC,0BAA0B,EAAE,OAAO,UAAU,EAAE;YAAC;QAClF;QAEA,MAAM,cAAc,iBAAiB;YACpC,MAAM,OAAO,gBAAgB,GAC1B,GAAG,OAAO,gBAAgB,CAAC,EAAE,EAAE,OAAO,UAAU,CAAC,CAAC,CAAC,GACnD,OAAO,UAAU;YACpB,IAAI,MAAM,OAAO,CAAC,UAAU,EAAE,IAAI,UAAU,EAAE,CAAC,IAAI,CAAC,QAAQ,UAAU,EAAE;YACxE,SAAS,UAAU,OAAO;YAC1B,MAAM,UAAU,IAAI;YACpB,MAAM,UAAU,IAAI;YACpB,SAAS,UAAU,OAAO;YAC1B,IAAI,UAAU,EAAE,GAAI,MAAM,OAAO,CAAC,UAAU,EAAE,IAAI,UAAU,EAAE,CAAC,IAAI,CAAC,QAAQ,UAAU,EAAE,GAAI;YAC5F,KAAK,UAAU,GAAG,GAAI,MAAM,OAAO,CAAC,UAAU,GAAG,IAAI,UAAU,GAAG,CAAC,IAAI,CAAC,QAAQ,UAAU,GAAG,GAAI;YACjG,SAAS,UAAU,OAAO;QAC3B;QAEA,MAAM,iBAAiB,gBAAgB;QAEvC,MAAM,WAAW,MAAM,MAAM,GAAG,cAAc,uBAAuB,CAAC,EAAE;YACvE,QAAQ;YACR,SAAS;gBACR,eAAe,CAAC,OAAO,EAAE,OAAO,WAAW,EAAE;gBAC7C,gBAAgB;YACjB;YACA,MAAM,KAAK,SAAS,CAAC;gBAAE,KAAK;YAAe;QAC5C;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YACjB,MAAM,YAAY,MAAM,SAAS,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;YACvD,MAAM,eAAe,UAAU,KAAK,EAAE,WAAW,CAAC,iBAAiB,EAAE,SAAS,MAAM,EAAE;YACtF,QAAQ,KAAK,CAAC,CAAC,qBAAqB,EAAE,cAAc;YACpD,IAAI,SAAS,MAAM,KAAK,KAAK;gBAC5B,MAAM,wBAAwB,WAAW;YAC1C;YACA,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAa;QAC9C;QAEA,MAAM,SAAS,MAAM,SAAS,IAAI;QAElC,6BAA6B;QAC7B,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAClD,MAAM,SACJ,IAAI,CAAC,wBACL,MAAM,CAAC;YAAE,cAAc,IAAI,OAAO,WAAW;QAAG,GAChD,EAAE,CAAC,cAAc;QAEnB,QAAQ,GAAG,CAAC,CAAC,+BAA+B,EAAE,UAAU,MAAM,EAAE,OAAO,EAAE,CAAC,CAAC,CAAC;QAE5E,OAAO;YACN,SAAS;YACT,WAAW,OAAO,EAAE;YACpB,UAAU,OAAO,QAAQ;YACzB,UAAU,OAAO,QAAQ;QAC1B;IACD,EAAE,OAAO,OAAO;QACf,MAAM,UAAU,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACzD,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO;YAAE,SAAS;YAAO,OAAO;QAAQ;IACzC;AACD;AAkBA,SAAS,iBAAiB,KAAuB;IAChD,MAAM,WAAW,CAAC,SAAS,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,IAAI;IAEpF,MAAM,QAAkB;QACvB,CAAC,MAAM,EAAE,MAAM,IAAI,EAAE;QACrB,CAAC,IAAI,EAAE,MAAM,EAAE,EAAE;QACjB,CAAC,mBAAmB,EAAE,OAAO,IAAI,CAAC,MAAM,OAAO,EAAE,QAAQ,CAAC,UAAU,EAAE,CAAC;QACvE;KACA;IAED,IAAI,MAAM,OAAO,EAAE,MAAM,IAAI,CAAC,CAAC,UAAU,EAAE,MAAM,OAAO,EAAE;IAC1D,IAAI,MAAM,EAAE,EAAE,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,MAAM,EAAE,EAAE;IAC1C,IAAI,MAAM,GAAG,EAAE,MAAM,IAAI,CAAC,CAAC,KAAK,EAAE,MAAM,GAAG,EAAE;IAE7C,IAAI,MAAM,OAAO,EAAE;QAClB,KAAK,MAAM,CAAC,KAAK,MAAM,IAAI,OAAO,OAAO,CAAC,MAAM,OAAO,EAAG;YACzD,MAAM,IAAI,CAAC,GAAG,IAAI,EAAE,EAAE,OAAO;QAC9B;IACD;IAEA,MAAM,IAAI,CAAC,CAAC,+CAA+C,EAAE,SAAS,CAAC,CAAC;IACxE,MAAM,IAAI,CAAC;IAEX,MAAM,cAAc,MAAM,IAAI,IAAI,oBAAoB,MAAM,IAAI;IAChE,MAAM,IAAI,CAAC,CAAC,EAAE,EAAE,UAAU;IAC1B,MAAM,IAAI,CAAC;IACX,MAAM,IAAI,CAAC;IACX,MAAM,IAAI,CAAC;IACX,MAAM,IAAI,CAAC,OAAO,IAAI,CAAC,aAAa,QAAQ,CAAC;IAE7C,MAAM,IAAI,CAAC,CAAC,EAAE,EAAE,UAAU;IAC1B,MAAM,IAAI,CAAC;IACX,MAAM,IAAI,CAAC;IACX,MAAM,IAAI,CAAC;IACX,MAAM,IAAI,CAAC,OAAO,IAAI,CAAC,MAAM,IAAI,EAAE,QAAQ,CAAC;IAE5C,MAAM,IAAI,CAAC,CAAC,EAAE,EAAE,SAAS,EAAE,CAAC;IAE5B,OAAO,MAAM,IAAI,CAAC;AACnB;AAEA,SAAS,oBAAoB,IAAY;IACxC,OAAO,KACL,OAAO,CAAC,mCAAmC,IAC3C,OAAO,CAAC,qCAAqC,IAC7C,OAAO,CAAC,YAAY,KACpB,OAAO,CAAC,QAAQ,KAChB,IAAI;AACP;AAEA,SAAS,gBAAgB,GAAW;IACnC,OAAO,OAAO,IAAI,CAAC,KACjB,QAAQ,CAAC,UACT,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,OAAO;AAClB;AASO,eAAe,wBACrB,SAAiB,EACjB,UAAmB,KAAK;IAWxB,IAAI;QACH,MAAM,SAAS,MAAM,sBAAsB;QAE3C,IAAI,CAAC,QAAQ;YACZ,OAAO;gBAAE,WAAW;gBAAO,YAAY;YAAM;QAC9C;QAEA,MAAM,SAAS;YACd,WAAW;YACX,OAAO,OAAO,UAAU;YACxB,aAAa,OAAO,gBAAgB;YACpC,YAAY,OAAO,OAAO;YAC1B,gBAAgB,OAAO,cAAc;YACrC,aAAa,OAAO,eAAe;YACnC,YAAY;QACb;QAEA,IAAI,WAAW,OAAO,OAAO,EAAE;YAC9B,IAAI;gBACH,MAAM,WAAW,MAAM,MAAM,GAAG,cAAc,iBAAiB,CAAC,EAAE;oBACjE,SAAS;wBAAE,eAAe,CAAC,OAAO,EAAE,OAAO,WAAW,EAAE;oBAAC;gBAC1D;gBACA,OAAO,UAAU,GAAG,SAAS,EAAE;YAChC,EAAE,OAAM;gBACP,OAAO,UAAU,GAAG;YACrB;QACD;QAEA,OAAO;IACR,EAAE,OAAO,OAAO;QACf,OAAO;YACN,WAAW;YACX,YAAY;YACZ,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACjD;IACD;AACD;AASO,eAAe,mBACrB,YAAoB;IAEpB,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAElD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,qBACL,MAAM,CAAC,+CACP,EAAE,CAAC,kBAAkB,cACrB,EAAE,CAAC,gBAAgB,MACnB,WAAW;QAEb,IAAI,SAAS,CAAC,MAAM;YACnB,OAAO;QACR;QAEA,kDAAkD;QAClD,MAAM,uBAAuB,IAAA,2KAAY,EAAC,KAAK,YAAY;QAC3D,MAAM,wBAAwB,IAAA,2KAAY,EAAC,KAAK,aAAa;QAE7D,MAAM,YAAgC;YACrC,cAAc,KAAK,cAAc;YACjC,gBAAgB,KAAK,qBAAqB;YAC1C,YAAY,KAAK,mBAAmB,CAAC,aAAa;YAClD,aAAa;YACb,cAAc;YACd,gBAAgB,IAAI,KAAK,KAAK,YAAY;YAC1C,QAAQ,KAAK,MAAM,IAAI,EAAE;YACzB,aAAa,KAAK,YAAY;YAC9B,cAAc,KAAK,cAAc,GAAG,IAAI,KAAK,KAAK,cAAc,IAAI;QACrE;QAEA,+BAA+B;QAC/B,IAAI,oBAAoB,UAAU,cAAc,GAAG;YAClD,QAAQ,GAAG,CAAC,CAAC,qCAAqC,EAAE,aAAa,eAAe,CAAC;YACjF,MAAM,YAAY,MAAM,sBAAsB,cAAc,UAAU,YAAY;YAClF,IAAI,WAAW;gBACd,OAAO;YACR;YACA,QAAQ,IAAI,CAAC;QACd;QAEA,OAAO;IACR,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,sCAAsC;QACpD,OAAO;IACR;AACD;AAKO,eAAe,sBACrB,YAAoB,EACpB,YAAoB;IAEpB,IAAI;QACH,MAAM,WAAW,QAAQ,GAAG,CAAC,gBAAgB;QAC7C,MAAM,eAAe,QAAQ,GAAG,CAAC,oBAAoB;QAErD,IAAI,CAAC,YAAY,CAAC,cAAc;YAC/B,QAAQ,KAAK,CAAC;YACd,OAAO;QACR;QAEA,MAAM,WAAW,MAAM,MAAM,kBAAkB;YAC9C,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAoC;YAC/D,MAAM,IAAI,gBAAgB;gBACzB,WAAW;gBACX,eAAe;gBACf,eAAe;gBACf,YAAY;YACb;QACD;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YACjB,MAAM,YAAY,MAAM,SAAS,IAAI;YACrC,QAAQ,KAAK,CAAC,CAAC,mCAAmC,EAAE,SAAS,MAAM,EAAE,EAAE;YAEvE,4CAA4C;YAC5C,MAAM,IAAA,gLAAqB,EAC1B,cACA,WACA,CAAC,sBAAsB,EAAE,SAAS,MAAM,CAAC,GAAG,EAAE,WAAW;YAG1D,IAAI,SAAS,MAAM,KAAK,OAAO,SAAS,MAAM,KAAK,KAAK;gBACvD,MAAM,qBAAqB,cAAc,CAAC,gBAAgB,EAAE,SAAS,MAAM,EAAE;YAC9E;YACA,OAAO;QACR;QAEA,MAAM,gBAAqC,MAAM,SAAS,IAAI;QAC9D,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,cAAc,UAAU,GAAG;QAEnE,8DAA8D;QAC9D,MAAM,uBAAuB,IAAA,2KAAY,EAAC,cAAc,YAAY;QACpE,MAAM,wBAAwB,cAAc,aAAa,GACtD,IAAA,2KAAY,EAAC,cAAc,aAAa,IACxC;QAEH,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAClD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,qBACL,MAAM,CAAC;YACP,cAAc;YACd,cAAc,UAAU,WAAW;YACnC,GAAI,yBAAyB;gBAAE,eAAe;YAAsB,CAAC;QACtE,GACC,EAAE,CAAC,kBAAkB,cACrB,MAAM,CAAC,+CACP,MAAM;QAER,IAAI,SAAS,CAAC,MAAM;YACnB,QAAQ,KAAK,CAAC,kDAAkD,OAAO;YACvE,OAAO;QACR;QAEA,QAAQ,GAAG,CAAC,CAAC,6CAA6C,EAAE,cAAc;QAE1E,sDAAsD;QACtD,MAAM,uBAAuB,IAAA,2KAAY,EAAC,KAAK,YAAY;QAC3D,MAAM,wBAAwB,IAAA,2KAAY,EAAC,KAAK,aAAa;QAE7D,OAAO;YACN,cAAc,KAAK,cAAc;YACjC,gBAAgB,KAAK,qBAAqB;YAC1C,YAAY,KAAK,mBAAmB,CAAC,aAAa;YAClD,aAAa;YACb,cAAc;YACd,gBAAgB,IAAI,KAAK,KAAK,YAAY;YAC1C,QAAQ,KAAK,MAAM,IAAI,EAAE;YACzB,aAAa,KAAK,YAAY;YAC9B,cAAc,KAAK,cAAc,GAAG,IAAI,KAAK,KAAK,cAAc,IAAI;QACrE;IACD,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,qCAAqC;QACnD,OAAO;IACR;AACD;AAEA,eAAe,qBAAqB,YAAoB,EAAE,MAAc;IACvE,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAClD,MAAM,SACJ,IAAI,CAAC,qBACL,MAAM,CAAC;YAAE,cAAc;QAAM,GAC7B,EAAE,CAAC,kBAAkB;QACvB,QAAQ,GAAG,CAAC,CAAC,sCAAsC,EAAE,aAAa,EAAE,EAAE,QAAQ;IAC/E,EAAE,OAAO,OAAO;QACf,QAAQ,KAAK,CAAC,8CAA8C;IAC7D;AACD;AAKO,eAAe,qBACrB,YAAoB,EACpB,cAAsB,EACtB,WAAmB,EACnB,YAAoB,EACpB,SAAiB,EACjB,MAAgB;IAEhB,IAAI;QACH,IAAI,CAAC,OAAO,QAAQ,CAAC,yBAAyB,CAAC,OAAO,QAAQ,CAAC,qBAAqB;YACnF,OAAO;gBACN,SAAS;gBACT,OAAO,CAAC,wBAAwB,EAAE,qBAAqB,IAAI,EAAE,oBAAoB;YAClF;QACD;QAEA,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAClD,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,YAAY;QAEpD,oDAAoD;QACpD,MAAM,uBAAuB,IAAA,2KAAY,EAAC;QAC1C,MAAM,wBAAwB,IAAA,2KAAY,EAAC;QAE3C,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,qBAAqB,MAAM,CAChE;YACC,gBAAgB;YAChB,uBAAuB;YACvB,cAAc;YACd,eAAe;YACf,cAAc,UAAU,WAAW;YACnC;YACA,cAAc;YACd,gBAAgB;QACjB,GACA;YAAE,YAAY;QAAwB;QAGvC,IAAI,OAAO;YACV,QAAQ,KAAK,CAAC,wCAAwC,MAAM,OAAO;YACnE,OAAO;gBAAE,SAAS;gBAAO,OAAO,MAAM,OAAO;YAAC;QAC/C;QAEA,QAAQ,GAAG,CAAC,CAAC,gDAAgD,EAAE,cAAc;QAC7E,OAAO;YAAE,SAAS;QAAK;IACxB,EAAE,OAAO,OAAO;QACf,MAAM,UAAU,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACzD,OAAO;YAAE,SAAS;YAAO,OAAO;QAAQ;IACzC;AACD;AAKO,eAAe,oBACrB,YAAoB;IAEpB,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAElD,sBAAsB;QACtB,MAAM,EAAE,MAAM,SAAS,EAAE,GAAG,MAAM,SAChC,IAAI,CAAC,qBACL,MAAM,CAAC,gBACP,EAAE,CAAC,kBAAkB,cACrB,MAAM;QAER,uBAAuB;QACvB,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACtB,IAAI,CAAC,qBACL,MAAM,GACN,EAAE,CAAC,kBAAkB;QAEvB,IAAI,OAAO;YACV,OAAO;gBAAE,SAAS;gBAAO,OAAO,MAAM,OAAO;YAAC;QAC/C;QAEA,yCAAyC;QACzC,IAAI,WAAW,cAAc;YAC5B,IAAI;gBACH,MAAM,MAAM,CAAC,2CAA2C,EAAE,UAAU,YAAY,EAAE,EAAE;oBACnF,QAAQ;gBACT;YACD,EAAE,OAAM;gBACP,QAAQ,IAAI,CAAC;YACd;QACD;QAEA,QAAQ,GAAG,CAAC,CAAC,2CAA2C,EAAE,cAAc;QACxE,OAAO;YAAE,SAAS;QAAK;IACxB,EAAE,OAAO,OAAO;QACf,MAAM,UAAU,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACzD,OAAO;YAAE,SAAS;YAAO,OAAO;QAAQ;IACzC;AACD;AASO,eAAe,eACrB,YAAoB,EACpB,aAAqB,EAAE,EACvB,SAAkB;IAElB,IAAI;QACH,MAAM,SAAS,MAAM,mBAAmB;QACxC,IAAI,CAAC,QAAQ;YACZ,OAAO;gBAAE,UAAU,EAAE;gBAAE,OAAO;YAAoC;QACnE;QAEA,yBAAyB;QACzB,MAAM,SAAS,IAAI,gBAAgB;YAClC,YAAY,WAAW,QAAQ;YAC/B,GAAG;YACH,GAAI,aAAa;gBAAE;YAAU,CAAC;QAC/B;QAEA,gBAAgB;QAChB,MAAM,eAAe,MAAM,MAC1B,GAAG,cAAc,mBAAmB,EAAE,QAAQ,EAC9C;YACC,SAAS;gBAAE,eAAe,CAAC,OAAO,EAAE,OAAO,WAAW,EAAE;YAAC;QAC1D;QAGD,IAAI,CAAC,aAAa,EAAE,EAAE;YACrB,MAAM,YAAY,MAAM,aAAa,IAAI;YACzC,QAAQ,KAAK,CAAC,CAAC,4BAA4B,EAAE,aAAa,MAAM,EAAE,EAAE;YACpE,OAAO;gBAAE,UAAU,EAAE;gBAAE,OAAO,CAAC,WAAW,EAAE,aAAa,MAAM,EAAE;YAAC;QACnE;QAEA,MAAM,WAAW,MAAM,aAAa,IAAI;QACxC,MAAM,aAAa,SAAS,QAAQ,IAAI,EAAE;QAC1C,MAAM,WAA2B,EAAE;QAEnC,8CAA8C;QAC9C,KAAK,MAAM,UAAU,WAAY;YAChC,MAAM,cAAc,MAAM,MACzB,GAAG,cAAc,mBAAmB,EAAE,OAAO,EAAE,EAAE,EACjD;gBACC,SAAS;oBAAE,eAAe,CAAC,OAAO,EAAE,OAAO,WAAW,EAAE;gBAAC;YAC1D;YAGD,IAAI,YAAY,EAAE,EAAE;gBACnB,MAAM,UAAU,MAAM,YAAY,IAAI;gBACtC,SAAS,IAAI,CAAC;YACf;QACD;QAEA,OAAO;YACN;YACA,eAAe,SAAS,aAAa;QACtC;IACD,EAAE,OAAO,OAAO;QACf,MAAM,UAAU,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACzD,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO;YAAE,UAAU,EAAE;YAAE,OAAO;QAAQ;IACvC;AACD;AAEA;;CAEC,GACD,SAAS,kBAAkB,OAAqB;IAC/C,MAAM,UAAU,QAAQ,OAAO,CAAC,OAAO;IACvC,MAAM,YAAY,CAAC,OAAiB,QAAQ,IAAI,CAAC,CAAA,IAAK,EAAE,IAAI,CAAC,WAAW,OAAO,KAAK,WAAW,KAAK,SAAS;IAE7G,MAAM,OAAO,UAAU;IACvB,MAAM,KAAK,UAAU,MAAM,KAAK,CAAC,KAAK,GAAG,CAAC,CAAA,IAAK,EAAE,IAAI,IAAI,MAAM,CAAC;IAChE,MAAM,KAAK,UAAU,OAAO,MAAM,KAAK,IAAI,CAAA,IAAK,EAAE,IAAI,IAAI,OAAO;IACjE,MAAM,UAAU,UAAU;IAE1B,uBAAuB;IACvB,IAAI;IACJ,IAAI;IAEJ,MAAM,cAAc,CAAC;QACpB,IAAI,KAAK,QAAQ,KAAK,gBAAgB,KAAK,IAAI,EAAE,MAAM;YACtD,WAAW,OAAO,IAAI,CAAC,KAAK,IAAI,CAAC,IAAI,EAAE,UAAU,QAAQ,CAAC;QAC3D,OAAO,IAAI,KAAK,QAAQ,KAAK,eAAe,KAAK,IAAI,EAAE,MAAM;YAC5D,WAAW,OAAO,IAAI,CAAC,KAAK,IAAI,CAAC,IAAI,EAAE,UAAU,QAAQ,CAAC;QAC3D;QAEA,IAAI,KAAK,KAAK,EAAE;YACf,KAAK,KAAK,CAAC,OAAO,CAAC;QACpB;IACD;IAEA,IAAI,QAAQ,OAAO,CAAC,KAAK,EAAE;QAC1B,QAAQ,OAAO,CAAC,KAAK,CAAC,OAAO,CAAC;IAC/B,OAAO,IAAI,QAAQ,OAAO,CAAC,IAAI,EAAE,MAAM;QACtC,sBAAsB;QACtB,IAAI,QAAQ,OAAO,CAAC,QAAQ,KAAK,cAAc;YAC9C,WAAW,OAAO,IAAI,CAAC,QAAQ,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,UAAU,QAAQ,CAAC;QACtE,OAAO,IAAI,QAAQ,OAAO,CAAC,QAAQ,KAAK,aAAa;YACpD,WAAW,OAAO,IAAI,CAAC,QAAQ,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,UAAU,QAAQ,CAAC;QACtE;IACD;IAEA,OAAO;QACN,gBAAgB,QAAQ,EAAE;QAC1B,eAAe,QAAQ,QAAQ;QAC/B;QACA;QACA;QACA;QACA;QACA;QACA,YAAY,IAAI,KAAK,SAAS,QAAQ,YAAY;QAClD,gBAAgB,QAAQ,OAAO,CAAC,KAAK,EAAE,KAAK,CAAA,IAAK,EAAE,IAAI,CAAC,IAAI,GAAG,KAAK,EAAE,QAAQ,CAAC,UAAU,CAAC,mBAAmB;QAC7G,QAAQ,QAAQ,QAAQ;IACzB;AACD;AAKO,eAAe,kBACrB,SAAiB,EACjB,YAAoB,EACpB,cAAsB,EACtB,aAAiC;IAEjC,IAAI;QACH,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAElD,kCAAkC;QAClC,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC/B,IAAI,CAAC,kBACL,MAAM,CAAC,MACP,EAAE,CAAC,oBAAoB,cAAc,cAAc,EACnD,WAAW;QAEb,IAAI,UAAU;YACb,OAAO;gBAAE,SAAS;gBAAM,iBAAiB,SAAS,EAAE;YAAC;QACtD;QAEA,2CAA2C;QAC3C,MAAM,YAAY,cAAc,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,EAAE,IAAI,cAAc,IAAI;QAEhF,gCAAgC;QAChC,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC/B,IAAI,CAAC,aACL,MAAM,CAAC,MACP,EAAE,CAAC,cAAc,WACjB,EAAE,CAAC,SAAS,WACZ,WAAW;QAEb,uBAAuB;QACvB,MAAM,EAAE,MAAM,aAAa,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3C,IAAI,CAAC,kBACL,MAAM,CAAC;YACP,YAAY;YACZ,MAAM;YACN,WAAW;YACX,QAAQ;YACR,cAAc;YACd,YAAY,cAAc,EAAE,CAAC,EAAE,IAAI;YACnC,SAAS,cAAc,OAAO;YAC9B,MAAM,cAAc,QAAQ,IAAI,cAAc,QAAQ,IAAI;YAC1D,aAAa,UAAU,MAAM;YAC7B,kBAAkB;YAClB,kBAAkB;YAClB,kBAAkB;YAClB,kBAAkB,cAAc,cAAc;YAC9C,iBAAiB,cAAc,aAAa;QAC7C,GACC,MAAM,CAAC,MACP,MAAM;QAER,IAAI,OAAO;YACV,QAAQ,KAAK,CAAC,oCAAoC,MAAM,OAAO;YAC/D,OAAO;gBAAE,SAAS;gBAAO,OAAO,MAAM,OAAO;YAAC;QAC/C;QAEA,OAAO;YAAE,SAAS;YAAM,iBAAiB,cAAc,EAAE;QAAC;IAC3D,EAAE,OAAO,OAAO;QACf,MAAM,UAAU,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACzD,OAAO;YAAE,SAAS;YAAO,OAAO;QAAQ;IACzC;AACD;AAKO,eAAe,cACrB,SAAiB,EACjB,YAAoB;IAEpB,MAAM,YAAY,IAAI;IACtB,IAAI,kBAAkB;IACtB,IAAI,iBAAiB;IACrB,MAAM,SAAmB,EAAE;IAC3B,IAAI,WAA+C;IAEnD,IAAI;QACH,uDAAuD;QACvD,MAAM,iBAAiB,IAAA,sLAAkB,EAAC;QAC1C,IAAI,CAAC,eAAe,OAAO,EAAE;YAC5B,MAAM,IAAA,wKAAa,EAAC,qBAAqB;gBACxC;gBACA,YAAY,eAAe,UAAU;YACtC,GAAG;YAEH,OAAO;gBACN,SAAS;gBACT,iBAAiB;gBACjB,gBAAgB;gBAChB,QAAQ;oBAAC,eAAe,MAAM,IAAI;iBAAsB;gBACxD,cAAc;YACf;QACD;QAEA,gDAAgD;QAChD,WAAW,IAAA,mLAAe,EAAC;QAC3B,IAAI,CAAC,UAAU;YACd,OAAO;gBACN,SAAS;gBACT,iBAAiB;gBACjB,gBAAgB;gBAChB,QAAQ;oBAAC;iBAAgE;gBACzE,cAAc;YACf;QACD;QAEA,MAAM,IAAA,wKAAa,EAAC,gBAAgB;YAAE;QAAa,GAAG;QAEtD,MAAM,SAAS,MAAM,mBAAmB;QACxC,IAAI,CAAC,QAAQ;YACZ,OAAO;gBACN,SAAS;gBACT,iBAAiB;gBACjB,gBAAgB;gBAChB,QAAQ;oBAAC;iBAAsB;gBAC/B,cAAc;YACf;QACD;QAEA,0DAA0D;QAC1D,IAAI;QACJ,IAAI,UAAU;QAEd,MAAO,QAAS;YACf,MAAM,EAAE,QAAQ,EAAE,aAAa,EAAE,KAAK,EAAE,GAAG,MAAM,eAChD,cACA,IACA;YAGD,IAAI,OAAO;gBACV,OAAO,IAAI,CAAC;gBACZ;YACD;YAEA,mBAAmB,SAAS,MAAM;YAElC,qBAAqB;YACrB,KAAK,MAAM,WAAW,SAAU;gBAC/B,MAAM,SAAS,kBAAkB;gBACjC,MAAM,EAAE,OAAO,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,kBAC5C,WACA,cACA,OAAO,cAAc,EACrB;gBAGD,IAAI,SAAS;oBACZ;gBACD,OAAO,IAAI,YAAY;oBACtB,OAAO,IAAI,CAAC;gBACb;YACD;YAEA,qCAAqC;YACrC,YAAY;YACZ,UAAU,CAAC,CAAC,iBAAiB,SAAS,MAAM,GAAG;QAChD;QAEA,+BAA+B;QAC/B,MAAM,WAAW,MAAM,IAAA,iLAA2B;QAClD,MAAM,SACJ,IAAI,CAAC,qBACL,MAAM,CAAC;YAAE,gBAAgB,UAAU,WAAW;QAAG,GACjD,EAAE,CAAC,kBAAkB;QAEvB,QAAQ,GAAG,CACV,CAAC,eAAe,EAAE,eAAe,CAAC,EAAE,gBAAgB,0BAA0B,EAAE,cAAc;QAG/F,sBAAsB;QACtB,MAAM,IAAA,wKAAa,EAAC,kBAAkB;YACrC;YACA,kBAAkB;QACnB,GAAG;QAEH,OAAO;YACN,SAAS,OAAO,MAAM,KAAK;YAC3B;YACA;YACA;YACA,cAAc;QACf;IACD,EAAE,OAAO,OAAO;QACf,MAAM,UAAU,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACzD,OAAO,IAAI,CAAC;QAEZ,kBAAkB;QAClB,MAAM,IAAA,wKAAa,EAAC,eAAe;YAClC;YACA,OAAO;QACR,GAAG;QAEH,OAAO;YACN,SAAS;YACT;YACA;YACA;YACA,cAAc;QACf;IACD,SAAU;QACT,sCAAsC;QACtC,IAAI,UAAU;YACb,IAAA,mLAAe,EAAC;QACjB;IACD;AACD;AASO,eAAe;IACrB,OAAO,CAAC,CAAC,CACR,QAAQ,GAAG,CAAC,gBAAgB,IAC5B,QAAQ,GAAG,CAAC,oBAAoB,6DAEjC;AACD;;;IA1mCsB;IAqBA;IA8CA;IAqDA;IA2FA;IAoDA;IAoDA;IA0JA;IA0DA;IAqDA;IA0GA;IAqDA;IAiDA;IAuHA;IAoEA;IAqJA;;AApmCA,wZAAA;AAqBA,wZAAA;AA8CA,wZAAA;AAqDA,wZAAA;AA2FA,wZAAA;AAoDA,wZAAA;AAoDA,wZAAA;AA0JA,wZAAA;AA0DA,wZAAA;AAqDA,wZAAA;AA0GA,wZAAA;AAqDA,wZAAA;AAiDA,wZAAA;AAuHA,wZAAA;AAoEA,wZAAA;AAqJA,wZAAA"}},
    {"offset": {"line": 3868, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/email-provider.ts"],"sourcesContent":["/**\n * Email Provider Abstraction Layer\n *\n * This module provides a unified interface for sending emails through multiple\n * providers (Resend and Postmark) with automatic fallback support.\n *\n * Architecture:\n * \n *                     Email Provider Layer                         \n * \n *   1. Try Primary Provider (Resend)                               \n *       Success  Return result, log to monitor                  \n *       Failure  Try Fallback                                   \n *   2. Try Fallback Provider (Postmark)                            \n *       Success  Return result, log to monitor                  \n *       Failure  Return error with both provider failures       \n * \n *\n * Features:\n * - Automatic fallback when primary provider fails\n * - Health monitoring for both providers\n * - Unified response format\n * - Comprehensive logging for debugging\n * - Provider-agnostic interface for email operations\n *\n * Usage:\n * ```typescript\n * import { sendEmailWithFallback } from \"@/lib/email/email-provider\";\n *\n * const result = await sendEmailWithFallback({\n *   to: \"user@example.com\",\n *   subject: \"Welcome!\",\n *   html: \"<h1>Hello</h1>\",\n * });\n * ```\n */\n\nimport { emailConfig, isResendConfigured, resend } from \"./resend-client\";\nimport {\n\tpostmarkConfig,\n\tisPostmarkConfigured,\n\tsendPostmarkEmail,\n\tcheckPostmarkHealth,\n\ttype PostmarkResponse,\n} from \"./postmark-client\";\nimport {\n\tsendCompanyGmailEmail,\n\tgetCompanyGmailTokens,\n\tgetCompanyEmailProvider,\n\tcheckCompanyGmailHealth,\n\tisGmailIntegrationEnabled,\n\ttype CompanyEmailProvider,\n\ttype GmailSendResult,\n} from \"./gmail-client\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Supported email providers\n * - resend: Primary managed provider (high deliverability, company branding)\n * - postmark: Fallback managed provider (automatic failover)\n * - gmail: User's personal Gmail account (requires OAuth connection)\n */\nexport type EmailProvider = \"resend\" | \"postmark\" | \"gmail\";\n\n/**\n * Email send options - provider-agnostic interface\n */\n/** Attachment type for email */\nexport interface EmailAttachment {\n\tfilename: string;\n\tcontent: string; // Base64 encoded content\n\tcontentType?: string;\n}\n\nexport interface EmailSendOptions {\n\t/** Recipient email address(es) */\n\tto: string | string[];\n\t/** Email subject line */\n\tsubject: string;\n\t/** HTML body content */\n\thtml: string;\n\t/** Plain text body (optional, auto-generated if not provided) */\n\ttext?: string;\n\t/** From address (uses provider default if not specified) */\n\tfrom?: string;\n\t/** Reply-to address */\n\treplyTo?: string;\n\t/** Tags for categorization and tracking */\n\ttags?: Record<string, string>;\n\t/** Communication ID for internal tracking */\n\tcommunicationId?: string;\n\t/** Company ID - required for checking company email provider preference */\n\tcompanyId?: string;\n\t/** CC recipients */\n\tcc?: string | string[];\n\t/** BCC recipients */\n\tbcc?: string | string[];\n\t/** Email attachments */\n\tattachments?: EmailAttachment[];\n}\n\n/**\n * Result of sending an email through the provider layer\n */\nexport interface EmailProviderResult {\n\t/** Whether the email was sent successfully */\n\tsuccess: boolean;\n\t/** The provider that successfully sent the email */\n\tprovider?: EmailProvider;\n\t/** Message ID from the provider */\n\tmessageId?: string;\n\t/** Error message if failed */\n\terror?: string;\n\t/** Whether fallback was used */\n\tusedFallback?: boolean;\n\t/** Detailed results from each provider attempt */\n\tattempts: Array<{\n\t\tprovider: EmailProvider;\n\t\tsuccess: boolean;\n\t\tmessageId?: string;\n\t\terror?: string;\n\t\tlatencyMs: number;\n\t}>;\n}\n\n/**\n * Provider health status\n */\nexport interface ProviderHealthStatus {\n\tprovider: EmailProvider;\n\thealthy: boolean;\n\tlatencyMs: number;\n\tlastChecked: Date;\n\terror?: string;\n}\n\n/**\n * Combined health status for all providers\n */\nexport interface AllProvidersHealth {\n\tprimary: ProviderHealthStatus | null;\n\tfallback: ProviderHealthStatus | null;\n\trecommendedProvider: EmailProvider | null;\n}\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\n/**\n * Provider configuration\n * Determines which provider is primary and which is fallback\n */\nexport const providerConfig = {\n\t/** Primary provider - tried first */\n\tprimary: \"resend\" as EmailProvider,\n\t/** Fallback provider - used if primary fails */\n\tfallback: \"postmark\" as EmailProvider,\n\t/** Enable automatic fallback on failure */\n\tenableFallback: true,\n\t/** Log all provider operations for monitoring */\n\tenableLogging: true,\n\t/** Retry count before falling back (0 = immediate fallback) */\n\tprimaryRetries: 0,\n};\n\n// =============================================================================\n// PROVIDER AVAILABILITY\n// =============================================================================\n\n/**\n * Check if a specific provider is configured and available\n *\n * @param provider - Provider to check\n * @returns Whether the provider is available\n */\nexport function isProviderConfigured(provider: EmailProvider): boolean {\n\tswitch (provider) {\n\t\tcase \"resend\":\n\t\t\treturn isResendConfigured();\n\t\tcase \"postmark\":\n\t\t\treturn isPostmarkConfigured();\n\t\tdefault:\n\t\t\treturn false;\n\t}\n}\n\n/**\n * Get list of all configured providers\n *\n * @returns Array of configured provider names\n */\nexport function getConfiguredProviders(): EmailProvider[] {\n\tconst providers: EmailProvider[] = [];\n\n\tif (isResendConfigured()) {\n\t\tproviders.push(\"resend\");\n\t}\n\n\tif (isPostmarkConfigured()) {\n\t\tproviders.push(\"postmark\");\n\t}\n\n\treturn providers;\n}\n\n/**\n * Get the best available provider\n * Returns primary if configured, otherwise fallback\n *\n * @returns Best available provider or null if none configured\n */\nexport function getBestAvailableProvider(): EmailProvider | null {\n\tif (isProviderConfigured(providerConfig.primary)) {\n\t\treturn providerConfig.primary;\n\t}\n\n\tif (providerConfig.enableFallback && isProviderConfigured(providerConfig.fallback)) {\n\t\treturn providerConfig.fallback;\n\t}\n\n\treturn null;\n}\n\n// =============================================================================\n// EMAIL SENDING\n// =============================================================================\n\n/**\n * Send email via Resend\n *\n * @param options - Email options\n * @returns Send result\n */\nasync function sendViaResend(\n\toptions: EmailSendOptions\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\n\tif (!isResendConfigured() || !resend) {\n\t\treturn { success: false, error: \"Resend is not configured\" };\n\t}\n\n\ttry {\n\t\t// Build tags array for Resend\n\t\tconst tags: Array<{ name: string; value: string }> = [];\n\t\tif (options.tags) {\n\t\t\tfor (const [name, value] of Object.entries(options.tags)) {\n\t\t\t\ttags.push({ name, value });\n\t\t\t}\n\t\t}\n\t\tif (options.communicationId) {\n\t\t\ttags.push({ name: \"communication_id\", value: options.communicationId });\n\t\t}\n\n\t\t// Send via Resend\n\t\tconst { data, error } = await resend.emails.send({\n\t\t\tfrom: options.from || emailConfig.from,\n\t\t\tto: options.to,\n\t\t\tsubject: options.subject,\n\t\t\thtml: options.html,\n\t\t\ttext: options.text,\n\t\t\treplyTo: options.replyTo,\n\t\t\ttags: tags.length > 0 ? tags : undefined,\n\t\t});\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message || \"Resend send failed\" };\n\t\t}\n\n\t\treturn { success: true, messageId: data?.id };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Resend send failed\",\n\t\t};\n\t}\n}\n\n/**\n * Send email via Postmark\n *\n * @param options - Email options\n * @returns Send result\n */\nasync function sendViaPostmark(\n\toptions: EmailSendOptions\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\n\tif (!isPostmarkConfigured()) {\n\t\treturn { success: false, error: \"Postmark is not configured\" };\n\t}\n\n\ttry {\n\t\t// Convert tags to Postmark metadata format\n\t\tconst metadata: Record<string, string> = { ...options.tags };\n\t\tif (options.communicationId) {\n\t\t\tmetadata.communication_id = options.communicationId;\n\t\t}\n\t\tif (options.companyId) {\n\t\t\tmetadata.company_id = options.companyId;\n\t\t}\n\n\t\t// Determine tag (Postmark only supports one tag per email)\n\t\tconst tag = options.tags?.template || options.tags?.type || \"transactional\";\n\n\t\t// Send via Postmark\n\t\tconst result = await sendPostmarkEmail({\n\t\t\tto: options.to,\n\t\t\tsubject: options.subject,\n\t\t\thtml: options.html,\n\t\t\ttext: options.text,\n\t\t\tfrom: options.from || postmarkConfig.from,\n\t\t\treplyTo: options.replyTo,\n\t\t\ttag,\n\t\t\tmetadata,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn { success: false, error: result.error };\n\t\t}\n\n\t\treturn { success: true, messageId: result.data.MessageID };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Postmark send failed\",\n\t\t};\n\t}\n}\n\n/**\n * Send email via Gmail (company's connected Gmail account)\n *\n * @param companyId - Company ID with connected Gmail\n * @param options - Email options\n * @returns Send result\n */\nasync function sendViaGmail(\n\tcompanyId: string,\n\toptions: EmailSendOptions\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\n\ttry {\n\t\tconst result = await sendCompanyGmailEmail(companyId, {\n\t\t\tto: options.to,\n\t\t\tsubject: options.subject,\n\t\t\thtml: options.html,\n\t\t\ttext: options.text,\n\t\t\treplyTo: options.replyTo,\n\t\t\tcc: options.cc,\n\t\t\tbcc: options.bcc,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn { success: false, error: result.error };\n\t\t}\n\n\t\treturn { success: true, messageId: result.messageId };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Gmail send failed\",\n\t\t};\n\t}\n}\n\n/**\n * Check if Gmail is available for a company\n *\n * @param companyId - Company ID to check\n * @returns Whether Gmail is available and configured\n */\nasync function isCompanyGmailAvailable(companyId: string): Promise<boolean> {\n\ttry {\n\t\t// Check if Gmail integration is enabled globally\n\t\tif (!(await isGmailIntegrationEnabled())) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst tokens = await getCompanyGmailTokens(companyId);\n\t\treturn tokens !== null && tokens.isValid;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n/**\n * Send email with automatic fallback\n *\n * This is the main function for sending emails. It:\n * 1. Checks company's email provider preference (managed vs gmail vs disabled)\n * 2. If disabled, returns error immediately\n * 3. If Gmail preferred and available, sends via Gmail\n * 4. Otherwise, tries the primary provider (Resend)\n * 5. If primary fails and fallback is enabled, tries Postmark\n * 6. Returns detailed results including all attempts\n *\n * Provider Selection Logic (Multi-Tenant):\n * - If company preference = \"disabled\"  Return error (company has email disabled)\n * - If company preference = \"gmail\" AND valid Gmail tokens exist  Gmail\n * - If company preference = \"managed\" OR Gmail unavailable  Resend  Postmark\n *\n * @param options - Email send options\n * @returns Result with success status and attempt details\n *\n * @example\n * const result = await sendEmailWithFallback({\n *   to: \"user@example.com\",\n *   subject: \"Welcome!\",\n *   html: \"<h1>Hello</h1>\",\n *   tags: { template: \"welcome\" },\n *   companyId: \"company-123\", // Required for multi-tenant provider selection\n * });\n *\n * if (result.success) {\n *   console.log(`Sent via ${result.provider}, ID: ${result.messageId}`);\n * } else {\n *   console.error(`Failed: ${result.error}`);\n * }\n */\nexport async function sendEmailWithFallback(\n\toptions: EmailSendOptions\n): Promise<EmailProviderResult> {\n\tconst attempts: EmailProviderResult[\"attempts\"] = [];\n\tconst recipient = Array.isArray(options.to) ? options.to.join(\", \") : options.to;\n\n\t// Log the send attempt\n\tif (providerConfig.enableLogging) {\n\t\tconsole.log(`[EmailProvider] Sending email to ${recipient}, subject: \"${options.subject}\"`);\n\t}\n\n\t// ==========================================================================\n\t// COMPANY EMAIL PROVIDER CHECK (Multi-Tenant)\n\t// ==========================================================================\n\t// Each company (tenant) can choose:\n\t// - 'managed': Use our Resend/Postmark providers\n\t// - 'gmail': Use their connected Gmail account\n\t// - 'disabled': Email is disabled for this company\n\tif (options.companyId) {\n\t\tconst companyPreference = await getCompanyEmailProvider(options.companyId);\n\n\t\t// Handle disabled - company has turned off email\n\t\tif (companyPreference === \"disabled\") {\n\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\tconsole.log(`[EmailProvider] Company ${options.companyId} has email disabled`);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Email is disabled for this company\",\n\t\t\t\tusedFallback: false,\n\t\t\t\tattempts: [],\n\t\t\t};\n\t\t}\n\n\t\t// Handle Gmail preference\n\t\tif (companyPreference === \"gmail\") {\n\t\t\tconst gmailAvailable = await isCompanyGmailAvailable(options.companyId);\n\n\t\t\tif (gmailAvailable) {\n\t\t\t\tconst startTime = Date.now();\n\n\t\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\t\tconsole.log(`[EmailProvider] Company ${options.companyId} prefers Gmail, attempting Gmail send...`);\n\t\t\t\t}\n\n\t\t\t\tconst result = await sendViaGmail(options.companyId, options);\n\t\t\t\tconst latencyMs = Date.now() - startTime;\n\n\t\t\t\tattempts.push({\n\t\t\t\t\tprovider: \"gmail\",\n\t\t\t\t\tsuccess: result.success,\n\t\t\t\t\tmessageId: result.messageId,\n\t\t\t\t\terror: result.error,\n\t\t\t\t\tlatencyMs,\n\t\t\t\t});\n\n\t\t\t\tif (result.success) {\n\t\t\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t`[EmailProvider]  Gmail send succeeded in ${latencyMs}ms, messageId: ${result.messageId}`\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: true,\n\t\t\t\t\t\tprovider: \"gmail\",\n\t\t\t\t\t\tmessageId: result.messageId,\n\t\t\t\t\t\tusedFallback: false,\n\t\t\t\t\t\tattempts,\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Gmail failed - fall through to managed providers\n\t\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t`[EmailProvider]  Gmail send failed in ${latencyMs}ms: ${result.error}`\n\t\t\t\t\t);\n\t\t\t\t\tconsole.log(\"[EmailProvider] Falling back to managed providers...\");\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\t\tconsole.log(`[EmailProvider] Company ${options.companyId} prefers Gmail but no valid tokens, using managed providers`);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// ==========================================================================\n\t// MANAGED PROVIDERS: Primary (Resend)  Fallback (Postmark)\n\t// ==========================================================================\n\n\t// ==========================================================================\n\t// ATTEMPT 1: Primary Provider (Resend)\n\t// ==========================================================================\n\tif (isProviderConfigured(providerConfig.primary)) {\n\t\tconst startTime = Date.now();\n\n\t\tif (providerConfig.enableLogging) {\n\t\t\tconsole.log(`[EmailProvider] Trying primary provider: ${providerConfig.primary}`);\n\t\t}\n\n\t\tconst result =\n\t\t\tproviderConfig.primary === \"resend\"\n\t\t\t\t? await sendViaResend(options)\n\t\t\t\t: await sendViaPostmark(options);\n\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tattempts.push({\n\t\t\tprovider: providerConfig.primary,\n\t\t\tsuccess: result.success,\n\t\t\tmessageId: result.messageId,\n\t\t\terror: result.error,\n\t\t\tlatencyMs,\n\t\t});\n\n\t\t// If primary succeeded, return immediately\n\t\tif (result.success) {\n\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\tconsole.log(\n\t\t\t\t\t`[EmailProvider]  Primary provider succeeded in ${latencyMs}ms, messageId: ${result.messageId}`\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tprovider: providerConfig.primary,\n\t\t\t\tmessageId: result.messageId,\n\t\t\t\tusedFallback: false,\n\t\t\t\tattempts,\n\t\t\t};\n\t\t}\n\n\t\t// Primary failed\n\t\tif (providerConfig.enableLogging) {\n\t\t\tconsole.warn(\n\t\t\t\t`[EmailProvider]  Primary provider failed in ${latencyMs}ms: ${result.error}`\n\t\t\t);\n\t\t}\n\t} else {\n\t\tif (providerConfig.enableLogging) {\n\t\t\tconsole.warn(`[EmailProvider] Primary provider (${providerConfig.primary}) not configured`);\n\t\t}\n\t}\n\n\t// ==========================================================================\n\t// ATTEMPT 2: Fallback Provider (Postmark)\n\t// ==========================================================================\n\tif (providerConfig.enableFallback && isProviderConfigured(providerConfig.fallback)) {\n\t\tconst startTime = Date.now();\n\n\t\tif (providerConfig.enableLogging) {\n\t\t\tconsole.log(`[EmailProvider] Trying fallback provider: ${providerConfig.fallback}`);\n\t\t}\n\n\t\tconst result =\n\t\t\tproviderConfig.fallback === \"postmark\"\n\t\t\t\t? await sendViaPostmark(options)\n\t\t\t\t: await sendViaResend(options);\n\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tattempts.push({\n\t\t\tprovider: providerConfig.fallback,\n\t\t\tsuccess: result.success,\n\t\t\tmessageId: result.messageId,\n\t\t\terror: result.error,\n\t\t\tlatencyMs,\n\t\t});\n\n\t\t// If fallback succeeded, return\n\t\tif (result.success) {\n\t\t\tif (providerConfig.enableLogging) {\n\t\t\t\tconsole.log(\n\t\t\t\t\t`[EmailProvider]  Fallback provider succeeded in ${latencyMs}ms, messageId: ${result.messageId}`\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tprovider: providerConfig.fallback,\n\t\t\t\tmessageId: result.messageId,\n\t\t\t\tusedFallback: true,\n\t\t\t\tattempts,\n\t\t\t};\n\t\t}\n\n\t\t// Fallback also failed\n\t\tif (providerConfig.enableLogging) {\n\t\t\tconsole.error(\n\t\t\t\t`[EmailProvider]  Fallback provider also failed in ${latencyMs}ms: ${result.error}`\n\t\t\t);\n\t\t}\n\t} else if (providerConfig.enableFallback) {\n\t\tif (providerConfig.enableLogging) {\n\t\t\tconsole.warn(\n\t\t\t\t`[EmailProvider] Fallback provider (${providerConfig.fallback}) not configured`\n\t\t\t);\n\t\t}\n\t}\n\n\t// ==========================================================================\n\t// ALL PROVIDERS FAILED\n\t// ==========================================================================\n\tconst errors = attempts.map((a) => `${a.provider}: ${a.error}`).join(\"; \");\n\n\tif (providerConfig.enableLogging) {\n\t\tconsole.error(`[EmailProvider]  All providers failed: ${errors}`);\n\t}\n\n\treturn {\n\t\tsuccess: false,\n\t\terror: `All email providers failed. ${errors}`,\n\t\tusedFallback: attempts.length > 1,\n\t\tattempts,\n\t};\n}\n\n// =============================================================================\n// HEALTH CHECKS\n// =============================================================================\n\n/**\n * Check health of Resend provider\n *\n * @returns Health status\n */\nasync function checkResendHealth(): Promise<ProviderHealthStatus> {\n\tconst startTime = Date.now();\n\n\tif (!isResendConfigured() || !resend) {\n\t\treturn {\n\t\t\tprovider: \"resend\",\n\t\t\thealthy: false,\n\t\t\tlatencyMs: 0,\n\t\t\tlastChecked: new Date(),\n\t\t\terror: \"Resend is not configured\",\n\t\t};\n\t}\n\n\ttry {\n\t\t// Resend doesn't have a dedicated health endpoint\n\t\t// We'll list domains as a health check (lightweight operation)\n\t\tconst response = await fetch(\"https://api.resend.com/domains\", {\n\t\t\tmethod: \"GET\",\n\t\t\theaders: {\n\t\t\t\tAuthorization: `Bearer ${process.env.RESEND_API_KEY}`,\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t},\n\t\t});\n\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tif (response.ok) {\n\t\t\tconsole.log(`[EmailProvider] Resend health check passed in ${latencyMs}ms`);\n\t\t\treturn {\n\t\t\t\tprovider: \"resend\",\n\t\t\t\thealthy: true,\n\t\t\t\tlatencyMs,\n\t\t\t\tlastChecked: new Date(),\n\t\t\t};\n\t\t}\n\n\t\tconst error = await response.text();\n\t\tconsole.error(`[EmailProvider] Resend health check failed: ${error}`);\n\t\treturn {\n\t\t\tprovider: \"resend\",\n\t\t\thealthy: false,\n\t\t\tlatencyMs,\n\t\t\tlastChecked: new Date(),\n\t\t\terror: `HTTP ${response.status}: ${error}`,\n\t\t};\n\t} catch (error) {\n\t\tconst latencyMs = Date.now() - startTime;\n\t\tconst errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n\n\t\tconsole.error(`[EmailProvider] Resend health check error: ${errorMessage}`);\n\t\treturn {\n\t\t\tprovider: \"resend\",\n\t\t\thealthy: false,\n\t\t\tlatencyMs,\n\t\t\tlastChecked: new Date(),\n\t\t\terror: errorMessage,\n\t\t};\n\t}\n}\n\n/**\n * Check health of all configured providers\n *\n * @returns Health status for all providers\n */\nexport async function checkAllProvidersHealth(): Promise<AllProvidersHealth> {\n\tconsole.log(\"[EmailProvider] Checking health of all providers...\");\n\n\tconst results: AllProvidersHealth = {\n\t\tprimary: null,\n\t\tfallback: null,\n\t\trecommendedProvider: null,\n\t};\n\n\t// Check primary (Resend)\n\tif (isProviderConfigured(\"resend\")) {\n\t\tresults.primary = await checkResendHealth();\n\t}\n\n\t// Check fallback (Postmark)\n\tif (isProviderConfigured(\"postmark\")) {\n\t\tconst postmarkHealth = await checkPostmarkHealth();\n\t\tresults.fallback = {\n\t\t\tprovider: \"postmark\",\n\t\t\thealthy: postmarkHealth.healthy,\n\t\t\tlatencyMs: postmarkHealth.latencyMs,\n\t\t\tlastChecked: new Date(),\n\t\t\terror: postmarkHealth.error,\n\t\t};\n\t}\n\n\t// Determine recommended provider based on health\n\tif (results.primary?.healthy) {\n\t\tresults.recommendedProvider = \"resend\";\n\t} else if (results.fallback?.healthy) {\n\t\tresults.recommendedProvider = \"postmark\";\n\t}\n\n\tconsole.log(\n\t\t`[EmailProvider] Health check complete. Primary: ${results.primary?.healthy ? \"healthy\" : \"unhealthy\"}, Fallback: ${results.fallback?.healthy ? \"healthy\" : \"unhealthy\"}, Recommended: ${results.recommendedProvider || \"none\"}`\n\t);\n\n\treturn results;\n}\n\n// =============================================================================\n// UTILITY FUNCTIONS\n// =============================================================================\n\n/**\n * Get display information about the email provider setup\n *\n * @returns Provider setup summary\n */\nexport function getProviderSetupInfo(): {\n\tprimaryConfigured: boolean;\n\tfallbackConfigured: boolean;\n\tfallbackEnabled: boolean;\n\tconfiguredProviders: EmailProvider[];\n\tstatus: \"fully_configured\" | \"primary_only\" | \"fallback_only\" | \"not_configured\";\n} {\n\tconst primaryConfigured = isProviderConfigured(providerConfig.primary);\n\tconst fallbackConfigured = isProviderConfigured(providerConfig.fallback);\n\tconst configuredProviders = getConfiguredProviders();\n\n\tlet status: \"fully_configured\" | \"primary_only\" | \"fallback_only\" | \"not_configured\";\n\n\tif (primaryConfigured && fallbackConfigured) {\n\t\tstatus = \"fully_configured\";\n\t} else if (primaryConfigured) {\n\t\tstatus = \"primary_only\";\n\t} else if (fallbackConfigured) {\n\t\tstatus = \"fallback_only\";\n\t} else {\n\t\tstatus = \"not_configured\";\n\t}\n\n\treturn {\n\t\tprimaryConfigured,\n\t\tfallbackConfigured,\n\t\tfallbackEnabled: providerConfig.enableFallback,\n\t\tconfiguredProviders,\n\t\tstatus,\n\t};\n}\n\n/**\n * Log a summary of the current provider configuration\n * Useful for debugging and startup diagnostics\n */\nexport function logProviderConfiguration(): void {\n\tconst info = getProviderSetupInfo();\n\n\tconsole.log(\"=\".repeat(60));\n\tconsole.log(\"[EmailProvider] Configuration Summary\");\n\tconsole.log(\"=\".repeat(60));\n\tconsole.log(`Primary Provider: ${providerConfig.primary} (${info.primaryConfigured ? \" configured\" : \" not configured\"})`);\n\tconsole.log(`Fallback Provider: ${providerConfig.fallback} (${info.fallbackConfigured ? \" configured\" : \" not configured\"})`);\n\tconsole.log(`Fallback Enabled: ${info.fallbackEnabled ? \"Yes\" : \"No\"}`);\n\tconsole.log(`Status: ${info.status}`);\n\tconsole.log(`Configured Providers: ${info.configuredProviders.join(\", \") || \"none\"}`);\n\tconsole.log(\"=\".repeat(60));\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4419, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/provider-monitor.ts"],"sourcesContent":["\"use server\";\n\n/**\n * Email Provider Monitor\n *\n * This module tracks the health and performance of email providers (Resend & Postmark).\n * It records every email send attempt and provides analytics for monitoring.\n *\n * Features:\n * - Track success/failure rates per provider\n * - Record latency metrics\n * - Store detailed error information\n * - Provide real-time health dashboards\n * - Alert on provider degradation\n *\n * Database Tables Used:\n * - email_provider_events: Individual send attempts\n * - email_provider_health: Aggregated health metrics (updated periodically)\n *\n * Usage:\n * ```typescript\n * // Record a successful send\n * await recordProviderEvent({\n *   provider: \"resend\",\n *   eventType: \"send_success\",\n *   messageId: \"abc123\",\n *   latencyMs: 150,\n * });\n *\n * // Get provider health stats\n * const stats = await getProviderStats(\"resend\", \"24h\");\n * ```\n */\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\nimport type { EmailProvider } from \"./email-provider\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Types of events we track for email providers\n */\nexport type ProviderEventType =\n\t| \"send_success\" // Email sent successfully\n\t| \"send_failure\" // Email send failed\n\t| \"health_check_success\" // Health check passed\n\t| \"health_check_failure\" // Health check failed\n\t| \"webhook_received\" // Webhook event received\n\t| \"fallback_triggered\"; // Fallback to secondary provider was used\n\n/**\n * Event data for recording provider activity\n */\nexport interface ProviderEventData {\n\t/** Which provider this event is for */\n\tprovider: EmailProvider;\n\t/** Type of event */\n\teventType: ProviderEventType;\n\t/** Message ID if applicable */\n\tmessageId?: string;\n\t/** Time taken for the operation in milliseconds */\n\tlatencyMs?: number;\n\t/** Error message if this was a failure */\n\terror?: string;\n\t/** Additional metadata */\n\tmetadata?: Record<string, unknown>;\n\t/** Company ID for multi-tenant tracking */\n\tcompanyId?: string;\n\t/** Domain ID if associated with a specific domain */\n\tdomainId?: string;\n}\n\n/**\n * Aggregated statistics for a provider\n */\nexport interface ProviderStats {\n\tprovider: EmailProvider;\n\tperiod: string;\n\ttotalEvents: number;\n\tsuccessCount: number;\n\tfailureCount: number;\n\tsuccessRate: number;\n\taverageLatencyMs: number;\n\tp95LatencyMs: number;\n\tfallbackCount: number;\n\tlastEventAt: Date | null;\n\tlastError: string | null;\n}\n\n/**\n * Real-time health status for dashboard\n */\nexport interface ProviderHealthDashboard {\n\tresend: {\n\t\tstatus: \"healthy\" | \"degraded\" | \"down\" | \"unknown\";\n\t\tsuccessRate24h: number;\n\t\tavgLatencyMs: number;\n\t\ttotalSent24h: number;\n\t\tlastError?: string;\n\t\tlastSuccessAt?: Date;\n\t};\n\tpostmark: {\n\t\tstatus: \"healthy\" | \"degraded\" | \"down\" | \"unknown\";\n\t\tsuccessRate24h: number;\n\t\tavgLatencyMs: number;\n\t\ttotalSent24h: number;\n\t\tlastError?: string;\n\t\tlastSuccessAt?: Date;\n\t};\n\toverall: {\n\t\tprimaryProvider: EmailProvider;\n\t\tfallbackProvider: EmailProvider;\n\t\tfallbackRate24h: number;\n\t\trecommendedAction?: string;\n\t};\n}\n\n// =============================================================================\n// EVENT RECORDING\n// =============================================================================\n\n/**\n * Record a provider event to the database\n *\n * This function logs every email provider interaction for monitoring.\n * Events are stored in the email_provider_events table.\n *\n * @param event - Event data to record\n * @returns Success status\n *\n * @example\n * await recordProviderEvent({\n *   provider: \"resend\",\n *   eventType: \"send_success\",\n *   messageId: \"msg_123\",\n *   latencyMs: 145,\n *   companyId: \"company_abc\",\n * });\n */\nexport async function recordProviderEvent(\n\tevent: ProviderEventData\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\t// Log to console for immediate visibility\n\t\tconst logPrefix = event.eventType.includes(\"success\") ? \"\" : \"\";\n\t\tconsole.log(\n\t\t\t`[ProviderMonitor] ${logPrefix} ${event.provider}:${event.eventType}` +\n\t\t\t\t(event.latencyMs ? ` (${event.latencyMs}ms)` : \"\") +\n\t\t\t\t(event.error ? ` - ${event.error}` : \"\")\n\t\t);\n\n\t\t// Insert event into database\n\t\tconst { error } = await supabase.from(\"email_provider_events\").insert({\n\t\t\tprovider: event.provider,\n\t\t\tevent_type: event.eventType,\n\t\t\tmessage_id: event.messageId || null,\n\t\t\tlatency_ms: event.latencyMs || null,\n\t\t\terror_message: event.error || null,\n\t\t\tmetadata: event.metadata || null,\n\t\t\tcompany_id: event.companyId || null,\n\t\t\tdomain_id: event.domainId || null,\n\t\t\tcreated_at: new Date().toISOString(),\n\t\t});\n\n\t\tif (error) {\n\t\t\t// Don't fail the main operation if monitoring fails\n\t\t\tconsole.error(`[ProviderMonitor] Failed to record event: ${error.message}`);\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\t// Monitoring should never break the main flow\n\t\tconsole.error(\n\t\t\t`[ProviderMonitor] Error recording event: ${error instanceof Error ? error.message : \"Unknown error\"}`\n\t\t);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n\n/**\n * Record a successful email send\n * Convenience wrapper for recordProviderEvent\n */\nexport async function recordSendSuccess(\n\tprovider: EmailProvider,\n\tmessageId: string,\n\tlatencyMs: number,\n\toptions?: { companyId?: string; domainId?: string; metadata?: Record<string, unknown> }\n): Promise<void> {\n\tawait recordProviderEvent({\n\t\tprovider,\n\t\teventType: \"send_success\",\n\t\tmessageId,\n\t\tlatencyMs,\n\t\t...options,\n\t});\n}\n\n/**\n * Record a failed email send\n * Convenience wrapper for recordProviderEvent\n */\nexport async function recordSendFailure(\n\tprovider: EmailProvider,\n\terror: string,\n\tlatencyMs: number,\n\toptions?: { companyId?: string; domainId?: string; metadata?: Record<string, unknown> }\n): Promise<void> {\n\tawait recordProviderEvent({\n\t\tprovider,\n\t\teventType: \"send_failure\",\n\t\terror,\n\t\tlatencyMs,\n\t\t...options,\n\t});\n}\n\n/**\n * Record when fallback provider was used\n */\nexport async function recordFallbackTriggered(\n\tprimaryProvider: EmailProvider,\n\tfallbackProvider: EmailProvider,\n\tprimaryError: string,\n\toptions?: { companyId?: string; metadata?: Record<string, unknown> }\n): Promise<void> {\n\tawait recordProviderEvent({\n\t\tprovider: primaryProvider,\n\t\teventType: \"fallback_triggered\",\n\t\terror: primaryError,\n\t\tmetadata: {\n\t\t\tfallback_provider: fallbackProvider,\n\t\t\t...options?.metadata,\n\t\t},\n\t\t...options,\n\t});\n}\n\n// =============================================================================\n// STATISTICS & ANALYTICS\n// =============================================================================\n\n/**\n * Get statistics for a specific provider\n *\n * @param provider - Provider to get stats for\n * @param period - Time period (\"1h\", \"24h\", \"7d\", \"30d\")\n * @returns Provider statistics\n */\nexport async function getProviderStats(\n\tprovider: EmailProvider,\n\tperiod: \"1h\" | \"24h\" | \"7d\" | \"30d\" = \"24h\"\n): Promise<ProviderStats | null> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\t// Calculate start time based on period\n\t\tconst now = new Date();\n\t\tconst periodMs = {\n\t\t\t\"1h\": 60 * 60 * 1000,\n\t\t\t\"24h\": 24 * 60 * 60 * 1000,\n\t\t\t\"7d\": 7 * 24 * 60 * 60 * 1000,\n\t\t\t\"30d\": 30 * 24 * 60 * 60 * 1000,\n\t\t};\n\t\tconst startTime = new Date(now.getTime() - periodMs[period]).toISOString();\n\n\t\t// Query events for this provider and period\n\t\tconst { data: events, error } = await supabase\n\t\t\t.from(\"email_provider_events\")\n\t\t\t.select(\"event_type, latency_ms, error_message, created_at\")\n\t\t\t.eq(\"provider\", provider)\n\t\t\t.gte(\"created_at\", startTime)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tconsole.error(`[ProviderMonitor] Failed to get stats: ${error.message}`);\n\t\t\treturn null;\n\t\t}\n\n\t\tif (!events || events.length === 0) {\n\t\t\treturn {\n\t\t\t\tprovider,\n\t\t\t\tperiod,\n\t\t\t\ttotalEvents: 0,\n\t\t\t\tsuccessCount: 0,\n\t\t\t\tfailureCount: 0,\n\t\t\t\tsuccessRate: 0,\n\t\t\t\taverageLatencyMs: 0,\n\t\t\t\tp95LatencyMs: 0,\n\t\t\t\tfallbackCount: 0,\n\t\t\t\tlastEventAt: null,\n\t\t\t\tlastError: null,\n\t\t\t};\n\t\t}\n\n\t\t// Calculate statistics\n\t\tconst sendEvents = events.filter(\n\t\t\t(e) => e.event_type === \"send_success\" || e.event_type === \"send_failure\"\n\t\t);\n\t\tconst successEvents = events.filter((e) => e.event_type === \"send_success\");\n\t\tconst failureEvents = events.filter((e) => e.event_type === \"send_failure\");\n\t\tconst fallbackEvents = events.filter((e) => e.event_type === \"fallback_triggered\");\n\n\t\t// Calculate latency metrics\n\t\tconst latencies = successEvents\n\t\t\t.map((e) => e.latency_ms)\n\t\t\t.filter((l): l is number => l !== null)\n\t\t\t.sort((a, b) => a - b);\n\n\t\tconst avgLatency =\n\t\t\tlatencies.length > 0\n\t\t\t\t? latencies.reduce((sum, l) => sum + l, 0) / latencies.length\n\t\t\t\t: 0;\n\n\t\tconst p95Index = Math.floor(latencies.length * 0.95);\n\t\tconst p95Latency = latencies.length > 0 ? latencies[p95Index] || latencies[latencies.length - 1] : 0;\n\n\t\t// Find last error\n\t\tconst lastFailure = failureEvents[0];\n\n\t\treturn {\n\t\t\tprovider,\n\t\t\tperiod,\n\t\t\ttotalEvents: events.length,\n\t\t\tsuccessCount: successEvents.length,\n\t\t\tfailureCount: failureEvents.length,\n\t\t\tsuccessRate:\n\t\t\t\tsendEvents.length > 0\n\t\t\t\t\t? (successEvents.length / sendEvents.length) * 100\n\t\t\t\t\t: 0,\n\t\t\taverageLatencyMs: Math.round(avgLatency),\n\t\t\tp95LatencyMs: Math.round(p95Latency),\n\t\t\tfallbackCount: fallbackEvents.length,\n\t\t\tlastEventAt: events[0] ? new Date(events[0].created_at) : null,\n\t\t\tlastError: lastFailure?.error_message || null,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\n\t\t\t`[ProviderMonitor] Error getting stats: ${error instanceof Error ? error.message : \"Unknown error\"}`\n\t\t);\n\t\treturn null;\n\t}\n}\n\n/**\n * Get health dashboard data for all providers\n *\n * @returns Dashboard data for monitoring UI\n */\nexport async function getProviderHealthDashboard(): Promise<ProviderHealthDashboard> {\n\tconsole.log(\"[ProviderMonitor] Getting health dashboard data...\");\n\n\t// Get stats for both providers\n\tconst [resendStats, postmarkStats] = await Promise.all([\n\t\tgetProviderStats(\"resend\", \"24h\"),\n\t\tgetProviderStats(\"postmark\", \"24h\"),\n\t]);\n\n\t// Determine health status based on success rate\n\tconst getStatus = (\n\t\tstats: ProviderStats | null\n\t): \"healthy\" | \"degraded\" | \"down\" | \"unknown\" => {\n\t\tif (!stats || stats.totalEvents === 0) return \"unknown\";\n\t\tif (stats.successRate >= 99) return \"healthy\";\n\t\tif (stats.successRate >= 95) return \"degraded\";\n\t\treturn \"down\";\n\t};\n\n\t// Calculate fallback rate\n\tconst totalFallbacks = (resendStats?.fallbackCount || 0) + (postmarkStats?.fallbackCount || 0);\n\tconst totalSends =\n\t\t(resendStats?.successCount || 0) +\n\t\t(resendStats?.failureCount || 0) +\n\t\t(postmarkStats?.successCount || 0) +\n\t\t(postmarkStats?.failureCount || 0);\n\tconst fallbackRate = totalSends > 0 ? (totalFallbacks / totalSends) * 100 : 0;\n\n\t// Determine recommended action\n\tlet recommendedAction: string | undefined;\n\tconst resendStatus = getStatus(resendStats);\n\tconst postmarkStatus = getStatus(postmarkStats);\n\n\tif (resendStatus === \"down\" && postmarkStatus === \"down\") {\n\t\trecommendedAction = \"CRITICAL: Both providers are down. Check API keys and provider status.\";\n\t} else if (resendStatus === \"down\") {\n\t\trecommendedAction = \"Primary provider (Resend) is down. Traffic is using fallback.\";\n\t} else if (fallbackRate > 10) {\n\t\trecommendedAction = \"High fallback rate detected. Review primary provider health.\";\n\t} else if (resendStatus === \"degraded\") {\n\t\trecommendedAction = \"Primary provider showing degraded performance. Monitor closely.\";\n\t}\n\n\treturn {\n\t\tresend: {\n\t\t\tstatus: resendStatus,\n\t\t\tsuccessRate24h: resendStats?.successRate || 0,\n\t\t\tavgLatencyMs: resendStats?.averageLatencyMs || 0,\n\t\t\ttotalSent24h: resendStats?.successCount || 0,\n\t\t\tlastError: resendStats?.lastError || undefined,\n\t\t\tlastSuccessAt: resendStats?.lastEventAt || undefined,\n\t\t},\n\t\tpostmark: {\n\t\t\tstatus: postmarkStatus,\n\t\t\tsuccessRate24h: postmarkStats?.successRate || 0,\n\t\t\tavgLatencyMs: postmarkStats?.averageLatencyMs || 0,\n\t\t\ttotalSent24h: postmarkStats?.successCount || 0,\n\t\t\tlastError: postmarkStats?.lastError || undefined,\n\t\t\tlastSuccessAt: postmarkStats?.lastEventAt || undefined,\n\t\t},\n\t\toverall: {\n\t\t\tprimaryProvider: \"resend\",\n\t\t\tfallbackProvider: \"postmark\",\n\t\t\tfallbackRate24h: fallbackRate,\n\t\t\trecommendedAction,\n\t\t},\n\t};\n}\n\n// =============================================================================\n// CLEANUP & MAINTENANCE\n// =============================================================================\n\n/**\n * Clean up old provider events\n * Should be run periodically (e.g., daily cron job)\n *\n * @param retentionDays - Number of days to retain events\n * @returns Number of deleted events\n */\nexport async function cleanupOldEvents(\n\tretentionDays: number = 30\n): Promise<{ deleted: number; error?: string }> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tconst cutoffDate = new Date();\n\t\tcutoffDate.setDate(cutoffDate.getDate() - retentionDays);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"email_provider_events\")\n\t\t\t.delete()\n\t\t\t.lt(\"created_at\", cutoffDate.toISOString())\n\t\t\t.select(\"id\");\n\n\t\tif (error) {\n\t\t\tconsole.error(`[ProviderMonitor] Cleanup failed: ${error.message}`);\n\t\t\treturn { deleted: 0, error: error.message };\n\t\t}\n\n\t\tconst deletedCount = data?.length || 0;\n\t\tconsole.log(`[ProviderMonitor] Cleaned up ${deletedCount} events older than ${retentionDays} days`);\n\n\t\treturn { deleted: deletedCount };\n\t} catch (error) {\n\t\tconst errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n\t\tconsole.error(`[ProviderMonitor] Cleanup error: ${errorMessage}`);\n\t\treturn { deleted: 0, error: errorMessage };\n\t}\n}\n\n// =============================================================================\n// ALERTING HELPERS\n// =============================================================================\n\n/**\n * Check if a provider should trigger an alert\n *\n * @param provider - Provider to check\n * @returns Alert status and reason\n */\nexport async function checkProviderAlert(\n\tprovider: EmailProvider\n): Promise<{\n\tshouldAlert: boolean;\n\tseverity: \"info\" | \"warning\" | \"critical\";\n\treason?: string;\n}> {\n\tconst stats = await getProviderStats(provider, \"1h\");\n\n\tif (!stats) {\n\t\treturn { shouldAlert: false, severity: \"info\" };\n\t}\n\n\t// No events in the last hour - might be expected during low traffic\n\tif (stats.totalEvents === 0) {\n\t\treturn { shouldAlert: false, severity: \"info\" };\n\t}\n\n\t// Critical: Success rate below 90%\n\tif (stats.successRate < 90) {\n\t\treturn {\n\t\t\tshouldAlert: true,\n\t\t\tseverity: \"critical\",\n\t\t\treason: `${provider} success rate is ${stats.successRate.toFixed(1)}% (below 90%)`,\n\t\t};\n\t}\n\n\t// Warning: Success rate below 99%\n\tif (stats.successRate < 99) {\n\t\treturn {\n\t\t\tshouldAlert: true,\n\t\t\tseverity: \"warning\",\n\t\t\treason: `${provider} success rate is ${stats.successRate.toFixed(1)}% (below 99%)`,\n\t\t};\n\t}\n\n\t// Warning: High latency\n\tif (stats.averageLatencyMs > 5000) {\n\t\treturn {\n\t\t\tshouldAlert: true,\n\t\t\tseverity: \"warning\",\n\t\t\treason: `${provider} average latency is ${stats.averageLatencyMs}ms (above 5s)`,\n\t\t};\n\t}\n\n\treturn { shouldAlert: false, severity: \"info\" };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4757, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/email-sender.ts"],"sourcesContent":["/**\n * Email Sender - Type-safe email sending utilities\n *\n * CRITICAL RULE - Reply-To Addresses:\n * ====================================\n * Reply-to ALWAYS uses the company's platform subdomain (mail.thorbis.com),\n * regardless of which email provider or sending method is used.\n *\n * Examples:\n * - FROM: notifications@acme.mail.thorbis.com  REPLY-TO: support@acme.mail.thorbis.com\n * - FROM: notifications@acme-plumbing.com (custom)  REPLY-TO: support@acme.mail.thorbis.com\n * - FROM: john@gmail.com (personal)  REPLY-TO: support@acme.mail.thorbis.com\n *\n * See: /docs/email/REPLY_TO_ARCHITECTURE.md for full details\n *\n * Features:\n * - Type-safe email sending with validation\n * - Development mode logging\n * - Error handling and logging\n * - Email logging to database\n * - Retry logic for failed sends\n * - Per-company rate limiting\n * - Deliverability monitoring\n */\n\n\"use server\";\n\nimport { render } from \"@react-email/components\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport type { ReactElement } from \"react\";\nimport { z } from \"zod\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport type { Database } from \"@/types/supabase\";\nimport { recordDeliveryEvent } from \"./deliverability-monitor\";\nimport type {\n\tEmailSendResult,\n\tEmailTemplate as EmailTemplateEnum,\n} from \"./email-types\";\nimport { emailSendSchema } from \"./email-types\";\nimport {\n\taddToSuppressionList,\n\tcheckSuppressionList,\n\trunPreSendChecks,\n} from \"./pre-send-checks\";\nimport {\n\tcheckRateLimit,\n\tgetCompanyActiveDomain,\n\tincrementEmailCounter,\n} from \"./rate-limiter\";\nimport { emailConfig, isResendConfigured, resend } from \"./resend-client\";\n\n// =============================================================================\n// MULTI-PROVIDER SUPPORT (Resend primary, Postmark fallback)\n// =============================================================================\n// Provider abstraction layer - handles automatic fallback when primary fails\nimport {\n\tsendEmailWithFallback,\n\tgetProviderSetupInfo,\n} from \"./email-provider\";\n\n// Provider monitoring - tracks success rates, latency for both providers\nimport {\n\trecordSendSuccess,\n\trecordSendFailure,\n\trecordFallbackTriggered,\n} from \"./provider-monitor\";\n\n// Attachment type for email\ntype EmailAttachment = {\n\tfilename: string;\n\tcontent: string; // Base64 encoded content\n\tcontentType?: string;\n};\n\n// Email send options\ntype SendEmailOptions = {\n\tto: string | string[];\n\tsubject: string;\n\ttemplate: ReactElement;\n\ttemplateType: EmailTemplateEnum;\n\t/** Reply-to address. Optional override.\n\t * If not provided, uses company's configured reply_to_email from company_email_domains table.\n\t * If company hasn't configured one, defaults to support@{company-subdomain}.mail.thorbis.com\n\t * This ensures replies always go to the same branded subdomain as FROM address (never custom domains) */\n\treplyTo?: string;\n\ttags?: { name: string; value: string }[];\n\tcompanyId?: string;\n\tcommunicationId?: string;\n\tfromOverride?: string;\n\t// CC/BCC recipients\n\tcc?: string | string[];\n\tbcc?: string | string[];\n\t// Attachments\n\tattachments?: EmailAttachment[];\n\t// Deliverability options\n\tisMarketingEmail?: boolean;\n\tskipPreSendChecks?: boolean; // For system emails that must go out\n\ttextContent?: string; // Plain text version for spam scoring\n\tunsubscribeUrl?: string;\n\tlistId?: string; // For List-Unsubscribe header\n};\n\n/**\n * Send email with React Email template\n *\n * Features:\n * - Validates email addresses\n * - Renders React Email template to HTML\n * - Sends via Resend\n * - Logs to database\n * - Development mode logging\n * - Rate limiting per company/domain\n * - Deliverability tracking\n */\nexport async function sendEmail({\n\tto,\n\tsubject,\n\ttemplate,\n\ttemplateType,\n\treplyTo,\n\ttags = [],\n\tcompanyId,\n\tcommunicationId,\n\tfromOverride,\n\tcc,\n\tbcc,\n\tattachments,\n\tisMarketingEmail = false,\n\tskipPreSendChecks = false,\n\ttextContent = \"\",\n\tunsubscribeUrl,\n\tlistId,\n}: SendEmailOptions): Promise<EmailSendResult> {\n\tlet activeDomainId: string | null = null;\n\tlet companyReplyTo: string | null = null;\n\tlet activeDomain: Awaited<ReturnType<typeof getCompanyActiveDomain>> = null;\n\n\ttry {\n\n\t\t// In development, log email instead of sending\n\t\tif (emailConfig.isDevelopment) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tdata: {\n\t\t\t\t\tid: `dev-mode-${Date.now()}`,\n\t\t\t\t\tmessage: \"Email logged in development mode (not actually sent)\",\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t// Check if at least one email provider is configured\n\t\t// We support Resend (primary) and Postmark (fallback)\n\t\tconst providerInfo = getProviderSetupInfo();\n\t\tif (providerInfo.status === \"not_configured\") {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Email service not configured. Please add RESEND_API_KEY or POSTMARK_API_KEY to environment variables.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\n\t\t\t`[EmailSender] Providers available: ${providerInfo.configuredProviders.join(\", \")} (status: ${providerInfo.status})`\n\t\t);\n\n\t\tconst supabase = await createClient();\n\n\t\t// Fetch company email domain to get reply-to configuration\n\t\tif (companyId) {\n\t\t\tactiveDomain = await getCompanyActiveDomain(companyId);\n\t\t\tif (!activeDomain) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: \"No active email domain configured for this company. Please set up email in settings.\",\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tactiveDomainId = activeDomain.domainId;\n\n\t\t\t// Set reply-to from company's domain configuration\n\t\t\t// If not set, construct default using the company's domain (e.g., support@acme.mail.thorbis.com)\n\t\t\t// This ensures all replies go to the same branded subdomain as the FROM address\n\t\t\tif (activeDomain.replyToEmail) {\n\t\t\t\tcompanyReplyTo = activeDomain.replyToEmail;\n\t\t\t} else {\n\t\t\t\t// Default to support@{company-domain}\n\t\t\t\tcompanyReplyTo = `support@${activeDomain.domain}`;\n\t\t\t}\n\t\t}\n\n\t\t// Determine final reply-to address\n\t\t// Priority: 1) Explicit replyTo parameter, 2) Company's configured reply-to, 3) None\n\t\tconst finalReplyTo = replyTo || companyReplyTo || undefined;\n\n\t\t// Validate email data (now with proper reply-to)\n\t\tconst validatedData = emailSendSchema.parse({\n\t\t\tto,\n\t\t\tsubject,\n\t\t\treplyTo: finalReplyTo,\n\t\t});\n\n\t\t// Normalize recipient list\n\t\tconst recipientEmails = Array.isArray(validatedData.to)\n\t\t\t? validatedData.to\n\t\t\t: [validatedData.to];\n\n\t\t// Check rate limits and run pre-send checks if companyId is provided\n\t\tif (companyId && activeDomainId) {\n\n\t\t\t// Check rate limit before incrementing\n\t\t\tconst rateLimitCheck = await checkRateLimit(activeDomain.domainId);\n\t\t\tif (!rateLimitCheck.allowed) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: rateLimitCheck.reason || \"Rate limit exceeded\",\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// Run pre-send deliverability checks (unless skipped for system emails)\n\t\t\tif (!skipPreSendChecks) {\n\t\t\t\t// Render template early to get HTML for spam check\n\t\t\t\tconst preCheckHtml = await render(template);\n\t\t\t\tconst plainText = textContent || extractTextFromHtml(preCheckHtml);\n\n\t\t\t\tconst preSendResult = await runPreSendChecks(\n\t\t\t\t\tcompanyId,\n\t\t\t\t\tactiveDomain.domainId,\n\t\t\t\t\trecipientEmails,\n\t\t\t\t\tsubject,\n\t\t\t\t\tpreCheckHtml,\n\t\t\t\t\tplainText,\n\t\t\t\t\tisMarketingEmail\n\t\t\t\t);\n\n\t\t\t\t// Block if there are critical errors\n\t\t\t\tif (!preSendResult.allowed) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: `Deliverability check failed: ${preSendResult.errors.join(\"; \")}`,\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tspamScore: preSendResult.spamScore,\n\t\t\t\t\t\t\twarnings: preSendResult.warnings,\n\t\t\t\t\t\t\tsuggestions: preSendResult.suggestions,\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Filter out suppressed recipients\n\t\t\t\tconst activeRecipients = recipientEmails.filter((email) => {\n\t\t\t\t\tconst status = preSendResult.recipientStatus?.find(\n\t\t\t\t\t\t(r) => r.email.toLowerCase() === email.toLowerCase()\n\t\t\t\t\t);\n\t\t\t\t\treturn !status?.suppressed;\n\t\t\t\t});\n\n\t\t\t\tif (activeRecipients.length === 0) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: \"All recipients are on suppression list - no emails sent\",\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Update validated data with filtered recipients\n\t\t\t\tif (activeRecipients.length < recipientEmails.length) {\n\t\t\t\t\tvalidatedData.to = activeRecipients.length === 1\n\t\t\t\t\t\t? activeRecipients[0]\n\t\t\t\t\t\t: activeRecipients;\n\t\t\t\t}\n\n\t\t\t\t// Log warnings if any (but still send)\n\t\t\t\tif (preSendResult.warnings.length > 0) {\n\t\t\t\t\tconsole.warn(\"[Email Deliverability Warnings]\", preSendResult.warnings);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Even for system emails, check suppression list\n\t\t\t\tconst suppressions = await checkSuppressionList(companyId, recipientEmails);\n\t\t\t\tconst activeRecipients = recipientEmails.filter((email) => {\n\t\t\t\t\tconst status = suppressions.get(email.toLowerCase());\n\t\t\t\t\treturn !status?.suppressed;\n\t\t\t\t});\n\n\t\t\t\tif (activeRecipients.length === 0) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: \"All recipients are on suppression list\",\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tif (activeRecipients.length < recipientEmails.length) {\n\t\t\t\t\tvalidatedData.to = activeRecipients.length === 1\n\t\t\t\t\t\t? activeRecipients[0]\n\t\t\t\t\t\t: activeRecipients;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Increment the counter (this also validates limits atomically)\n\t\t\tconst incrementResult = await incrementEmailCounter(activeDomain.domainId);\n\t\t\tif (!incrementResult.allowed) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: incrementResult.reason || \"Rate limit exceeded\",\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Determine from identity\n\t\tlet fromAddress = fromOverride || emailConfig.from;\n\t\tif (companyId && supabase) {\n\t\t\tconst override = await getCompanyEmailIdentity(supabase, companyId);\n\t\t\tif (override) {\n\t\t\t\tfromAddress = override;\n\t\t\t}\n\t\t}\n\n\t\t// Render template to HTML\n\t\tlet html = await render(template);\n\n\t\t// Add email tracking if communicationId is provided\n\t\tif (communicationId) {\n\t\t\tconst { addEmailTracking } = await import(\"./email-tracking\");\n\t\t\thtml = addEmailTracking(html, communicationId);\n\t\t}\n\n\t\tconst sendTags = [\n\t\t\t...tags,\n\t\t\t{ name: \"template\", value: templateType },\n\t\t\t{ name: \"environment\", value: process.env.NODE_ENV || \"development\" },\n\t\t];\n\n\t\tif (communicationId) {\n\t\t\tsendTags.push({ name: \"communication_id\", value: communicationId });\n\t\t}\n\n\t\t// Add company_id tag for webhook suppression list tracking\n\t\tif (companyId) {\n\t\t\tsendTags.push({ name: \"company_id\", value: companyId });\n\t\t}\n\n\t\t// Build enhanced headers for better deliverability\n\t\tconst emailHeaders: Record<string, string> = {\n\t\t\t// Precedence helps identify transactional vs marketing\n\t\t\t\"X-Priority\": \"3\", // Normal priority (1=High, 3=Normal, 5=Low)\n\t\t\t\"X-Mailer\": \"Stratos Email System\",\n\t\t};\n\n\t\t// Add List-Unsubscribe header for marketing emails (RFC 2369 compliance)\n\t\tif (isMarketingEmail && unsubscribeUrl) {\n\t\t\temailHeaders[\"List-Unsubscribe\"] = `<${unsubscribeUrl}>`;\n\t\t\temailHeaders[\"List-Unsubscribe-Post\"] = \"List-Unsubscribe=One-Click\";\n\t\t}\n\n\t\t// Add List-Id for mailing lists (helps with filtering)\n\t\tif (listId) {\n\t\t\temailHeaders[\"List-Id\"] = listId;\n\t\t}\n\n\t\t// Auto-Submitted header for transactional/automated emails\n\t\tif (!isMarketingEmail) {\n\t\t\temailHeaders[\"Auto-Submitted\"] = \"auto-generated\";\n\t\t\temailHeaders[\"Precedence\"] = \"bulk\"; // Prevents auto-replies\n\t\t}\n\n\t\t// =======================================================================\n\t\t// SEND EMAIL VIA PROVIDER LAYER (Resend  Postmark fallback)\n\t\t// =======================================================================\n\t\t// Convert tags to Record format for provider layer\n\t\tconst tagsRecord: Record<string, string> = {};\n\t\tfor (const tag of sendTags) {\n\t\t\ttagsRecord[tag.name] = tag.value;\n\t\t}\n\n\t\t// Track timing for monitoring\n\t\tconst sendStartTime = Date.now();\n\n\t\t// Send via provider layer (tries Resend first, then Postmark if Resend fails)\n\t\tconst providerResult = await sendEmailWithFallback({\n\t\t\tto: validatedData.to,\n\t\t\tsubject: validatedData.subject,\n\t\t\thtml,\n\t\t\ttext: textContent || extractTextFromHtml(html),\n\t\t\tfrom: fromAddress,\n\t\t\treplyTo: validatedData.replyTo,\n\t\t\ttags: tagsRecord,\n\t\t\tcommunicationId,\n\t\t\tcompanyId,\n\t\t\tcc,\n\t\t\tbcc,\n\t\t\tattachments,\n\t\t});\n\n\t\tconst sendLatencyMs = Date.now() - sendStartTime;\n\n\t\t// =======================================================================\n\t\t// RECORD PROVIDER MONITORING EVENTS\n\t\t// =======================================================================\n\t\t// Track success/failure for each provider attempt (for health dashboard)\n\t\tfor (const attempt of providerResult.attempts) {\n\t\t\tif (attempt.success) {\n\t\t\t\tawait recordSendSuccess(\n\t\t\t\t\tattempt.provider,\n\t\t\t\t\tattempt.messageId || \"\",\n\t\t\t\t\tattempt.latencyMs,\n\t\t\t\t\t{\n\t\t\t\t\t\tcompanyId,\n\t\t\t\t\t\tdomainId: activeDomainId || undefined,\n\t\t\t\t\t\tmetadata: { template: templateType },\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tawait recordSendFailure(\n\t\t\t\t\tattempt.provider,\n\t\t\t\t\tattempt.error || \"Unknown error\",\n\t\t\t\t\tattempt.latencyMs,\n\t\t\t\t\t{\n\t\t\t\t\t\tcompanyId,\n\t\t\t\t\t\tdomainId: activeDomainId || undefined,\n\t\t\t\t\t\tmetadata: { template: templateType },\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Record if fallback was triggered\n\t\tif (providerResult.usedFallback && providerResult.success) {\n\t\t\tconst primaryAttempt = providerResult.attempts.find((a) => a.provider === \"resend\");\n\t\t\tawait recordFallbackTriggered(\n\t\t\t\t\"resend\",\n\t\t\t\t\"postmark\",\n\t\t\t\tprimaryAttempt?.error || \"Primary failed\",\n\t\t\t\t{ companyId, metadata: { template: templateType } }\n\t\t\t);\n\t\t\tconsole.log(`[EmailSender] Used Postmark fallback after Resend failed: ${primaryAttempt?.error}`);\n\t\t}\n\n\t\t// =======================================================================\n\t\t// HANDLE RESULT\n\t\t// =======================================================================\n\t\tif (providerResult.success) {\n\t\t\t// SUCCESS: Email sent via one of the providers\n\t\t\tconsole.log(\n\t\t\t\t`[EmailSender]  Email sent via ${providerResult.provider}${providerResult.usedFallback ? \" (fallback)\" : \"\"} in ${sendLatencyMs}ms`\n\t\t\t);\n\n\t\t\t// Log successful email to database\n\t\t\ttry {\n\t\t\t\tif (supabase) {\n\t\t\t\t\tawait supabase.from(\"email_logs\").insert({\n\t\t\t\t\t\tto: Array.isArray(validatedData.to)\n\t\t\t\t\t\t\t? validatedData.to.join(\", \")\n\t\t\t\t\t\t\t: validatedData.to,\n\t\t\t\t\t\tfrom: fromAddress,\n\t\t\t\t\t\tsubject: validatedData.subject,\n\t\t\t\t\t\thtml_body: html,\n\t\t\t\t\t\tstatus: \"sent\",\n\t\t\t\t\t\tmessage_id: providerResult.messageId,\n\t\t\t\t\t\tcompany_id: companyId || null,\n\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\ttemplate: templateType,\n\t\t\t\t\t\t\ttags: sendTags,\n\t\t\t\t\t\t\tprovider: providerResult.provider,\n\t\t\t\t\t\t\tusedFallback: providerResult.usedFallback,\n\t\t\t\t\t\t\tlatencyMs: sendLatencyMs,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsent_at: new Date().toISOString(),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} catch (_logError) {\n\t\t\t\t// Don't throw - email was sent successfully even if logging failed\n\t\t\t}\n\n\t\t\t// Record delivered event for deliverability tracking\n\t\t\t// Note: This is an optimistic record; actual delivery confirmation comes via webhook\n\t\t\tif (activeDomainId) {\n\t\t\t\ttry {\n\t\t\t\t\tawait recordDeliveryEvent({\n\t\t\t\t\t\tdomainId: activeDomainId,\n\t\t\t\t\t\teventType: \"delivered\",\n\t\t\t\t\t\temailId: providerResult.messageId,\n\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\ttemplate: templateType,\n\t\t\t\t\t\t\tprovider: providerResult.provider,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t} catch (_deliverabilityError) {\n\t\t\t\t\t// Don't fail the overall operation\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tdata: {\n\t\t\t\t\tid: providerResult.messageId,\n\t\t\t\t\tmessage: `Email sent successfully via ${providerResult.provider}${providerResult.usedFallback ? \" (fallback)\" : \"\"}`,\n\t\t\t\t},\n\t\t\t};\n\t\t} else {\n\t\t\t// FAILURE: All providers failed\n\t\t\tconsole.error(`[EmailSender]  All providers failed: ${providerResult.error}`);\n\n\t\t\t// Log failed email to database for retry queue\n\t\t\ttry {\n\t\t\t\tif (supabase) {\n\t\t\t\t\tawait supabase.from(\"email_logs\").insert({\n\t\t\t\t\t\tto: Array.isArray(validatedData.to)\n\t\t\t\t\t\t\t? validatedData.to.join(\", \")\n\t\t\t\t\t\t\t: validatedData.to,\n\t\t\t\t\t\tfrom: fromAddress,\n\t\t\t\t\t\tsubject: validatedData.subject,\n\t\t\t\t\t\thtml_body: html,\n\t\t\t\t\t\tstatus: \"failed\",\n\t\t\t\t\t\terror_message: providerResult.error || \"All providers failed\",\n\t\t\t\t\t\tcompany_id: companyId || null,\n\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\ttemplate: templateType,\n\t\t\t\t\t\t\ttags: sendTags,\n\t\t\t\t\t\t\tattempts: providerResult.attempts,\n\t\t\t\t\t\t\tlatencyMs: sendLatencyMs,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tretry_count: 0,\n\t\t\t\t\t\tmax_retries: 3,\n\t\t\t\t\t\tnext_retry_at: new Date(Date.now() + 5 * 60 * 1000).toISOString(),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} catch (_logError) {}\n\n\t\t\t// Record bounce event for deliverability tracking\n\t\t\tif (activeDomainId) {\n\t\t\t\ttry {\n\t\t\t\t\tawait recordDeliveryEvent({\n\t\t\t\t\t\tdomainId: activeDomainId,\n\t\t\t\t\t\teventType: \"bounced\",\n\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\terror: providerResult.error,\n\t\t\t\t\t\t\ttemplate: templateType,\n\t\t\t\t\t\t\tattempts: providerResult.attempts.length,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t} catch (_deliverabilityError) {\n\t\t\t\t\t// Don't fail the overall operation\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: providerResult.error || \"Failed to send email (all providers failed)\",\n\t\t\t};\n\t\t}\n\t} catch (error) {\n\t\tif (error instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.issues[0]?.message || \"Invalid email data\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to send email\",\n\t\t};\n\t}\n}\n\n/**\n * Send batch emails (up to 100 at once per Resend limits)\n *\n * Features:\n * - Validates batch size\n * - Sends multiple emails\n * - Returns results for each email\n */\nasync function sendBatchEmails(\n\temails: SendEmailOptions[],\n): Promise<EmailSendResult[]> {\n\tif (emails.length > 100) {\n\t\treturn [\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Cannot send more than 100 emails at once\",\n\t\t\t},\n\t\t];\n\t}\n\n\tconst results = await Promise.all(emails.map((email) => sendEmail(email)));\n\n\treturn results;\n}\n\n/**\n * Test email configuration by sending a test email\n *\n * Features:\n * - Validates Resend configuration\n * - Sends test email to specified address\n * - Returns detailed error information\n */\nasync function testEmailConfiguration(\n\ttestEmailAddress: string,\n): Promise<EmailSendResult> {\n\ttry {\n\t\tconst validatedEmail = emailSendSchema.shape.to.parse(testEmailAddress);\n\n\t\tif (!isResendConfigured()) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Resend API key is not configured\",\n\t\t\t};\n\t\t}\n\n\t\t// Create a simple test template\n\t\tconst testTemplate = {\n\t\t\ttype: \"div\",\n\t\t\tprops: {\n\t\t\t\tchildren: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"h1\",\n\t\t\t\t\t\tprops: { children: \"Email Configuration Test\" },\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"p\",\n\t\t\t\t\t\tprops: {\n\t\t\t\t\t\t\tchildren: \"This is a test email from your Thorbis application.\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"p\",\n\t\t\t\t\t\tprops: {\n\t\t\t\t\t\t\tchildren:\n\t\t\t\t\t\t\t\t\"If you received this, your email configuration is working correctly!\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t} as any;\n\n\t\treturn await sendEmail({\n\t\t\tto: validatedEmail,\n\t\t\tsubject: \"Test Email - Thorbis Email Configuration\",\n\t\t\ttemplate: testTemplate,\n\t\t\ttemplateType: \"welcome\" as EmailTemplateEnum,\n\t\t\ttags: [{ name: \"type\", value: \"test\" }],\n\t\t});\n\t} catch (error) {\n\t\tif (error instanceof z.ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Invalid email address\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Configuration test failed\",\n\t\t};\n\t}\n}\n\nasync function getCompanyEmailIdentity(\n\tsupabase: SupabaseClient<Database>,\n\tcompanyId: string,\n) {\n\t// Get company name first\n\tconst { data: company } = await supabase\n\t\t.from(\"companies\")\n\t\t.select(\"name\")\n\t\t.eq(\"id\", companyId)\n\t\t.single();\n\n\tconst companyName = company?.name || \"Notification\";\n\n\t// Check company_email_domains table for active sending domain\n\t// Prioritizes custom domains over platform subdomains\n\tconst { data: domain } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"domain_name, is_platform_subdomain\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"verified\")\n\t\t.eq(\"sending_enabled\", true)\n\t\t.eq(\"is_suspended\", false)\n\t\t.order(\"is_platform_subdomain\", { ascending: true }) // Custom domains first\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.maybeSingle();\n\n\tif (domain?.domain_name) {\n\t\t// domain_name contains the full domain (e.g., company.mail.stratos.app or mail.custom.com)\n\t\treturn formatFromAddress(companyName, `notifications@${domain.domain_name}`);\n\t}\n\n\t// Fallback: Check old communication_email_settings (legacy)\n\tconst { data: settings } = await supabase\n\t\t.from(\"communication_email_settings\")\n\t\t.select(\"smtp_from_email, smtp_from_name\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.maybeSingle();\n\n\tif (settings?.smtp_from_email) {\n\t\treturn formatFromAddress(settings.smtp_from_name, settings.smtp_from_email);\n\t}\n\n\treturn null;\n}\n\nfunction formatFromAddress(name: string | null | undefined, email: string) {\n\tif (name?.trim()) {\n\t\treturn `${name} <${email}>`;\n\t}\n\treturn email;\n}\n\n/**\n * Extract plain text from HTML for spam scoring and multipart emails\n */\nfunction extractTextFromHtml(html: string): string {\n\t// Remove script and style tags with their content\n\tlet text = html.replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, \"\");\n\ttext = text.replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, \"\");\n\n\t// Replace block elements with newlines\n\ttext = text.replace(/<\\/(p|div|h[1-6]|li|br|tr)>/gi, \"\\n\");\n\ttext = text.replace(/<(br|hr)\\s*\\/?>/gi, \"\\n\");\n\n\t// Remove all remaining HTML tags\n\ttext = text.replace(/<[^>]+>/g, \" \");\n\n\t// Decode common HTML entities\n\ttext = text\n\t\t.replace(/&nbsp;/gi, \" \")\n\t\t.replace(/&amp;/gi, \"&\")\n\t\t.replace(/&lt;/gi, \"<\")\n\t\t.replace(/&gt;/gi, \">\")\n\t\t.replace(/&quot;/gi, '\"')\n\t\t.replace(/&#39;/gi, \"'\")\n\t\t.replace(/&mdash;/gi, \"\")\n\t\t.replace(/&ndash;/gi, \"\");\n\n\t// Clean up whitespace\n\ttext = text.replace(/\\s+/g, \" \").trim();\n\ttext = text.replace(/\\n\\s*\\n/g, \"\\n\\n\"); // Multiple newlines to double\n\n\treturn text;\n}\n\n/**\n * Handle bounce webhook and add to suppression list\n */\nexport async function handleBounceWebhook(\n\tcompanyId: string,\n\temail: string,\n\tbounceType: \"hard\" | \"soft\",\n\tbounceReason?: string\n): Promise<void> {\n\t// Import here to avoid circular dependency\n\tconst { addToSuppressionList, addToGlobalBounceList } = await import(\"./pre-send-checks\");\n\n\t// Add to company suppression list for hard bounces\n\tif (bounceType === \"hard\") {\n\t\tawait addToSuppressionList(companyId, email, \"bounce\", bounceReason);\n\t}\n\n\t// Add to global bounce list (hard bounces only)\n\tawait addToGlobalBounceList(email, bounceType, bounceReason);\n}\n\n/**\n * Handle complaint webhook (spam report) and add to suppression list\n */\nexport async function handleComplaintWebhook(\n\tcompanyId: string,\n\temail: string\n): Promise<void> {\n\tconst { addToSuppressionList } = await import(\"./pre-send-checks\");\n\n\t// Always suppress on complaint - user marked as spam\n\tawait addToSuppressionList(\n\t\tcompanyId,\n\t\temail,\n\t\t\"complaint\",\n\t\t\"User reported email as spam\"\n\t);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5347, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/errors/action-error.ts"],"sourcesContent":["/**\n * Action Error Class & Error Codes\n *\n * Provides standardized error handling for Server Actions with:\n * - Error codes for categorization\n * - HTTP status codes for API responses\n * - Detailed error messages\n * - Optional error details/context\n */\n\n/**\n * Error Code Constants\n *\n * Organized by category for easy management and consistent error handling\n */\nexport const ERROR_CODES = {\n\t// Authentication & Authorization\n\tAUTH_UNAUTHORIZED: \"AUTH_UNAUTHORIZED\",\n\tAUTH_FORBIDDEN: \"AUTH_FORBIDDEN\",\n\tAUTH_TOKEN_EXPIRED: \"AUTH_TOKEN_EXPIRED\",\n\tAUTH_TOKEN_INVALID: \"AUTH_TOKEN_INVALID\",\n\tAUTH_EMAIL_NOT_VERIFIED: \"AUTH_EMAIL_NOT_VERIFIED\",\n\n\t// Validation\n\tVALIDATION_FAILED: \"VALIDATION_FAILED\",\n\tVALIDATION_REQUIRED_FIELD: \"VALIDATION_REQUIRED_FIELD\",\n\tVALIDATION_INVALID_FORMAT: \"VALIDATION_INVALID_FORMAT\",\n\tVALIDATION_OUT_OF_RANGE: \"VALIDATION_OUT_OF_RANGE\",\n\n\t// Database\n\tDB_RECORD_NOT_FOUND: \"DB_RECORD_NOT_FOUND\",\n\tDB_DUPLICATE_ENTRY: \"DB_DUPLICATE_ENTRY\",\n\tDB_CONSTRAINT_VIOLATION: \"DB_CONSTRAINT_VIOLATION\",\n\tDB_FOREIGN_KEY_VIOLATION: \"DB_FOREIGN_KEY_VIOLATION\",\n\tDB_CONNECTION_ERROR: \"DB_CONNECTION_ERROR\",\n\tDB_QUERY_ERROR: \"DB_QUERY_ERROR\",\n\tDB_INSERT_ERROR: \"DB_INSERT_ERROR\",\n\tDB_UPDATE_ERROR: \"DB_UPDATE_ERROR\",\n\n\t// Business Logic\n\tBUSINESS_RULE_VIOLATION: \"BUSINESS_RULE_VIOLATION\",\n\tINSUFFICIENT_PERMISSIONS: \"INSUFFICIENT_PERMISSIONS\",\n\tOPERATION_NOT_ALLOWED: \"OPERATION_NOT_ALLOWED\",\n\tRESOURCE_LOCKED: \"RESOURCE_LOCKED\",\n\tRESOURCE_DELETED: \"RESOURCE_DELETED\",\n\n\t// External Services\n\tSERVICE_UNAVAILABLE: \"SERVICE_UNAVAILABLE\",\n\tSERVICE_TIMEOUT: \"SERVICE_TIMEOUT\",\n\tSERVICE_RATE_LIMIT: \"SERVICE_RATE_LIMIT\",\n\tSERVICE_INTEGRATION_ERROR: \"SERVICE_INTEGRATION_ERROR\",\n\tEXTERNAL_API_ERROR: \"EXTERNAL_API_ERROR\",\n\n\t// File Operations\n\tFILE_NOT_FOUND: \"FILE_NOT_FOUND\",\n\tFILE_TOO_LARGE: \"FILE_TOO_LARGE\",\n\tFILE_INVALID_TYPE: \"FILE_INVALID_TYPE\",\n\tFILE_UPLOAD_FAILED: \"FILE_UPLOAD_FAILED\",\n\n\t// Payment & Financial\n\tPAYMENT_FAILED: \"PAYMENT_FAILED\",\n\tPAYMENT_DECLINED: \"PAYMENT_DECLINED\",\n\tPAYMENT_INSUFFICIENT_FUNDS: \"PAYMENT_INSUFFICIENT_FUNDS\",\n\tPAYMENT_INVALID_AMOUNT: \"PAYMENT_INVALID_AMOUNT\",\n\tPAYMENT_ALREADY_REFUNDED: \"PAYMENT_ALREADY_REFUNDED\",\n\tPAYMENT_CANNOT_REFUND: \"PAYMENT_CANNOT_REFUND\",\n\n\t// Generic\n\tUNKNOWN_ERROR: \"UNKNOWN_ERROR\",\n\tINTERNAL_SERVER_ERROR: \"INTERNAL_SERVER_ERROR\",\n\tBAD_REQUEST: \"BAD_REQUEST\",\n\tNOT_IMPLEMENTED: \"NOT_IMPLEMENTED\",\n\tUNAUTHORIZED: \"UNAUTHORIZED\",\n\tNOT_FOUND: \"NOT_FOUND\",\n\tCONFLICT: \"CONFLICT\",\n\tEXPIRED: \"EXPIRED\",\n\tVALIDATION_ERROR: \"VALIDATION_ERROR\",\n} as const;\n\nexport type ErrorCode = (typeof ERROR_CODES)[keyof typeof ERROR_CODES];\n\n/**\n * Action Error Class\n *\n * Custom error class for Server Actions with additional context\n *\n * @example\n * throw new ActionError(\n *   \"Customer not found\",\n *   ERROR_CODES.DB_RECORD_NOT_FOUND,\n *   404,\n *   { customerId: \"123\" }\n * );\n */\nexport class ActionError extends Error {\n\tconstructor(\n\t\tmessage: string,\n\t\tpublic readonly code: ErrorCode = ERROR_CODES.UNKNOWN_ERROR,\n\t\tpublic readonly statusCode: number = 400,\n\t\tpublic readonly details?: Record<string, any>,\n\t) {\n\t\tsuper(message);\n\t\tthis.name = \"ActionError\";\n\n\t\t// Maintains proper stack trace for where error was thrown (V8 only)\n\t\tif (Error.captureStackTrace) {\n\t\t\tError.captureStackTrace(this, ActionError);\n\t\t}\n\t}\n\n\t/**\n\t * Convert error to a plain object suitable for API responses\n\t */\n\ttoJSON() {\n\t\treturn {\n\t\t\tsuccess: false as const,\n\t\t\terror: this.message,\n\t\t\tcode: this.code,\n\t\t\tstatusCode: this.statusCode,\n\t\t\t...(this.details && { details: this.details }),\n\t\t};\n\t}\n\n\t/**\n\t * Create ActionError from unknown error\n\t */\n\tstatic fromUnknown(error: unknown): ActionError {\n\t\tif (error instanceof ActionError) {\n\t\t\treturn error;\n\t\t}\n\n\t\tif (error instanceof Error) {\n\t\t\treturn new ActionError(\n\t\t\t\terror.message,\n\t\t\t\tERROR_CODES.INTERNAL_SERVER_ERROR,\n\t\t\t\t500,\n\t\t\t);\n\t\t}\n\n\t\treturn new ActionError(\n\t\t\t\"An unexpected error occurred\",\n\t\t\tERROR_CODES.UNKNOWN_ERROR,\n\t\t\t500,\n\t\t);\n\t}\n}\n\n/**\n * Error Message Helpers\n *\n * Consistent error messages for common scenarios\n */\nexport const ERROR_MESSAGES = {\n\t// Authentication\n\tunauthorized: () => \"You must be logged in to perform this action\",\n\tforbidden: (resource: string) =>\n\t\t`You don't have permission to access this ${resource}`,\n\temailNotVerified: () => \"Please verify your email before continuing\",\n\n\t// Validation\n\trequiredField: (field: string) => `${field} is required`,\n\tinvalidFormat: (field: string) => `${field} has an invalid format`,\n\toutOfRange: (field: string, min: number, max: number) =>\n\t\t`${field} must be between ${min} and ${max}`,\n\n\t// Database\n\tnotFound: (resource: string) => `${resource} not found`,\n\talreadyExists: (resource: string) => `${resource} already exists`,\n\tcannotDelete: (resource: string, reason: string) =>\n\t\t`Cannot delete ${resource}: ${reason}`,\n\n\t// Business Logic\n\tinsufficientFunds: () => \"Insufficient funds for this transaction\",\n\tcannotRefund: (reason: string) => `Cannot process refund: ${reason}`,\n\tresourceLocked: (resource: string) =>\n\t\t`${resource} is currently being modified by another user`,\n\n\t// Generic\n\toperationFailed: (operation: string) => `Failed to ${operation}`,\n\tserviceUnavailable: (service: string) =>\n\t\t`${service} is currently unavailable`,\n} as const;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5485, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/errors/with-error-handling.ts"],"sourcesContent":["/**\n * Error Handling Wrapper for Server Actions\n *\n * Provides consistent error handling, logging, and response formatting\n * for all Server Actions in the application.\n */\n\nimport { ZodError } from \"zod\";\nimport { ActionError, ERROR_CODES } from \"./action-error\";\n\n// Re-export for convenience\nexport { ActionError, ERROR_CODES } from \"./action-error\";\n\n/**\n * Standard Action Result Type\n *\n * All Server Actions should return this type for consistency\n */\nexport type ActionResult<T = void> =\n\t| {\n\t\t\tsuccess: true;\n\t\t\tdata: T;\n\t\t\tmessage?: string;\n\t\t\terror?: string;\n\t  }\n\t| {\n\t\t\tsuccess: false;\n\t\t\terror: string;\n\t\t\tcode?: string;\n\t\t\tdetails?: Record<string, any>;\n\t  };\n\n/**\n * Wrap Server Action with Error Handling\n *\n * Automatically handles errors and returns a consistent ActionResult format.\n * Logs errors appropriately and provides detailed error information in development.\n *\n * @example\n * export async function createCustomer(data: CustomerInsert) {\n *   return withErrorHandling(async () => {\n *     const validated = customerInsertSchema.parse(data);\n *     const supabase = await createClient();\n *\n *     const { data: customer, error } = await supabase\n *       .from(\"customers\")\n *       .insert(validated)\n *       .select()\n *       .single();\n *\n *     if (error) {\n *       throw new ActionError(error.message, ERROR_CODES.DB_QUERY_ERROR);\n *     }\n *\n *     return customer;\n *   });\n * }\n */\nexport async function withErrorHandling<T>(\n\tfn: () => Promise<T>,\n): Promise<ActionResult<T>> {\n\ttry {\n\t\tconst data = await fn();\n\t\treturn { success: true, data };\n\t} catch (error) {\n\t\t// Handle ActionError (our custom errors)\n\t\tif (error instanceof ActionError) {\n\t\t\t// Log authorization errors as warnings since they're expected in some cases\n\t\t\t// (e.g., user not part of a company, insufficient permissions)\n\t\t\tconst isExpectedAuthError =\n\t\t\t\terror.code === ERROR_CODES.AUTH_FORBIDDEN ||\n\t\t\t\terror.code === ERROR_CODES.AUTH_UNAUTHORIZED;\n\n\t\t\tif (isExpectedAuthError) {\n\t\t\t\t// Only log in development, or as a warning\n\t\t\t\tif (process.env.NODE_ENV === \"development\") {\n\t\t\t\t\tconsole.debug(`[Auth] Expected auth error: ${error.code} - ${error.message}`);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconsole.error(`[Action Error] ${error.code}: ${error.message}`);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.message,\n\t\t\t\tcode: error.code,\n\t\t\t\t...(error.details && { details: error.details }),\n\t\t\t};\n\t\t}\n\n\t\t// Handle Zod validation errors\n\t\tif (error instanceof ZodError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.issues[0]?.message || \"Validation failed\",\n\t\t\t\tcode: ERROR_CODES.VALIDATION_FAILED,\n\t\t\t\tdetails: {\n\t\t\t\t\tissues: error.issues.map((issue) => ({\n\t\t\t\t\t\tfield: issue.path.join(\".\"),\n\t\t\t\t\t\tmessage: issue.message,\n\t\t\t\t\t})),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t// Handle standard JavaScript errors\n\t\tif (error instanceof Error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\tprocess.env.NODE_ENV === \"development\"\n\t\t\t\t\t\t? error.message\n\t\t\t\t\t\t: \"An unexpected error occurred\",\n\t\t\t\tcode: ERROR_CODES.INTERNAL_SERVER_ERROR,\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"An unexpected error occurred\",\n\t\t\tcode: ERROR_CODES.UNKNOWN_ERROR,\n\t\t};\n\t}\n}\n\n/**\n * Create a success result\n *\n * Helper to create consistent success responses\n */\nfunction successResult<T>(data: T, message?: string): ActionResult<T> {\n\treturn {\n\t\tsuccess: true,\n\t\tdata,\n\t\t...(message && { message }),\n\t};\n}\n\n/**\n * Create an error result\n *\n * Helper to create consistent error responses\n */\nfunction errorResult(\n\terror: string,\n\tcode?: string,\n\tdetails?: Record<string, any>,\n): ActionResult<never> {\n\treturn {\n\t\tsuccess: false,\n\t\terror,\n\t\t...(code && { code }),\n\t\t...(details && { details }),\n\t};\n}\n\n/**\n * Assert Supabase client is available\n *\n * Helper to check if Supabase client exists and throw ActionError if not\n */\nexport function assertSupabase<T>(\n\tsupabase: T | null | undefined,\n): asserts supabase is T {\n\tif (!supabase) {\n\t\tthrow new ActionError(\n\t\t\t\"Database connection failed\",\n\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t500,\n\t\t);\n\t}\n}\n\n/**\n * Assert user is authenticated\n *\n * Helper to check authentication and throw ActionError if not authenticated\n */\nexport function assertAuthenticated(\n\tuserId: string | undefined,\n): asserts userId is string {\n\tif (!userId) {\n\t\tthrow new ActionError(\n\t\t\t\"You must be logged in to perform this action\",\n\t\t\tERROR_CODES.AUTH_UNAUTHORIZED,\n\t\t\t401,\n\t\t);\n\t}\n}\n\n/**\n * Assert resource exists\n *\n * Helper to check if resource exists and throw ActionError if not\n */\nexport function assertExists<T>(\n\tresource: T | null | undefined,\n\tresourceName: string,\n): asserts resource is T {\n\tif (!resource) {\n\t\tthrow new ActionError(\n\t\t\t`${resourceName} not found`,\n\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t404,\n\t\t);\n\t}\n}\n\n/**\n * Assert user has permission\n *\n * Helper to check permissions and throw ActionError if not authorized\n */\nfunction assertPermission(\n\thasPermission: boolean,\n\tresourceName: string,\n): asserts hasPermission {\n\tif (!hasPermission) {\n\t\tthrow new ActionError(\n\t\t\t`You don't have permission to access this ${resourceName}`,\n\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t403,\n\t\t);\n\t}\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;;;AAED;AACA;;;;AAkDO,eAAe,kBACrB,EAAoB;IAEpB,IAAI;QACH,MAAM,OAAO,MAAM;QACnB,OAAO;YAAE,SAAS;YAAM;QAAK;IAC9B,EAAE,OAAO,OAAO;QACf,yCAAyC;QACzC,IAAI,iBAAiB,uKAAW,EAAE;YACjC,4EAA4E;YAC5E,+DAA+D;YAC/D,MAAM,sBACL,MAAM,IAAI,KAAK,uKAAW,CAAC,cAAc,IACzC,MAAM,IAAI,KAAK,uKAAW,CAAC,iBAAiB;YAE7C,IAAI,qBAAqB;gBACxB,2CAA2C;gBAC3C,wCAA4C;oBAC3C,QAAQ,KAAK,CAAC,CAAC,4BAA4B,EAAE,MAAM,IAAI,CAAC,GAAG,EAAE,MAAM,OAAO,EAAE;gBAC7E;YACD,OAAO;gBACN,QAAQ,KAAK,CAAC,CAAC,eAAe,EAAE,MAAM,IAAI,CAAC,EAAE,EAAE,MAAM,OAAO,EAAE;YAC/D;YAEA,OAAO;gBACN,SAAS;gBACT,OAAO,MAAM,OAAO;gBACpB,MAAM,MAAM,IAAI;gBAChB,GAAI,MAAM,OAAO,IAAI;oBAAE,SAAS,MAAM,OAAO;gBAAC,CAAC;YAChD;QACD;QAEA,+BAA+B;QAC/B,IAAI,iBAAiB,6MAAQ,EAAE;YAC9B,OAAO;gBACN,SAAS;gBACT,OAAO,MAAM,MAAM,CAAC,EAAE,EAAE,WAAW;gBACnC,MAAM,uKAAW,CAAC,iBAAiB;gBACnC,SAAS;oBACR,QAAQ,MAAM,MAAM,CAAC,GAAG,CAAC,CAAC,QAAU,CAAC;4BACpC,OAAO,MAAM,IAAI,CAAC,IAAI,CAAC;4BACvB,SAAS,MAAM,OAAO;wBACvB,CAAC;gBACF;YACD;QACD;QAEA,oCAAoC;QACpC,IAAI,iBAAiB,OAAO;YAC3B,OAAO;gBACN,SAAS;gBACT,OACC,uCACG,MAAM,OAAO,GACb;gBACJ,MAAM,uKAAW,CAAC,qBAAqB;YACxC;QACD;QACA,OAAO;YACN,SAAS;YACT,OAAO;YACP,MAAM,uKAAW,CAAC,aAAa;QAChC;IACD;AACD;AAEA;;;;CAIC,GACD,SAAS,cAAiB,IAAO,EAAE,OAAgB;IAClD,OAAO;QACN,SAAS;QACT;QACA,GAAI,WAAW;YAAE;QAAQ,CAAC;IAC3B;AACD;AAEA;;;;CAIC,GACD,SAAS,YACR,KAAa,EACb,IAAa,EACb,OAA6B;IAE7B,OAAO;QACN,SAAS;QACT;QACA,GAAI,QAAQ;YAAE;QAAK,CAAC;QACpB,GAAI,WAAW;YAAE;QAAQ,CAAC;IAC3B;AACD;AAOO,SAAS,eACf,QAA8B;IAE9B,IAAI,CAAC,UAAU;QACd,MAAM,IAAI,uKAAW,CACpB,8BACA,uKAAW,CAAC,mBAAmB,EAC/B;IAEF;AACD;AAOO,SAAS,oBACf,MAA0B;IAE1B,IAAI,CAAC,QAAQ;QACZ,MAAM,IAAI,uKAAW,CACpB,gDACA,uKAAW,CAAC,iBAAiB,EAC7B;IAEF;AACD;AAOO,SAAS,aACf,QAA8B,EAC9B,YAAoB;IAEpB,IAAI,CAAC,UAAU;QACd,MAAM,IAAI,uKAAW,CACpB,GAAG,aAAa,UAAU,CAAC,EAC3B,uKAAW,CAAC,mBAAmB,EAC/B;IAEF;AACD;AAEA;;;;CAIC,GACD,SAAS,iBACR,aAAsB,EACtB,YAAoB;IAEpB,IAAI,CAAC,eAAe;QACnB,MAAM,IAAI,uKAAW,CACpB,CAAC,yCAAyC,EAAE,cAAc,EAC1D,uKAAW,CAAC,cAAc,EAC1B;IAEF;AACD"}},
    {"offset": {"line": 5621, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/services/geocoding.ts"],"sourcesContent":["/**\n * Google Geocoding API Utility\n *\n * Automatically acquires GPS coordinates (lat/lon) from addresses\n * Used during customer creation, property creation, and company onboarding\n */\n\ntype GeocodeResult = {\n\tlat: number;\n\tlon: number;\n\tformattedAddress?: string;\n};\n\ntype GeocodeResponse = {\n\tsuccess: boolean;\n\tcoordinates?: GeocodeResult;\n\terror?: string;\n};\n\n/**\n * Geocode an address to get GPS coordinates\n *\n * @param address - Street address\n * @param city - City\n * @param state - State\n * @param zipCode - ZIP code\n * @param country - Country (defaults to \"USA\")\n * @returns Coordinates {lat, lon} or null if geocoding fails\n */\nasync function geocodeAddress(\n\taddress: string,\n\tcity: string,\n\tstate: string,\n\tzipCode: string,\n\tcountry = \"USA\",\n): Promise<GeocodeResponse> {\n\ttry {\n\t\t// Build full address string\n\t\tconst fullAddress = `${address}, ${city}, ${state} ${zipCode}, ${country}`;\n\n\t\t// Get API key from environment\n\t\tconst apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY;\n\n\t\tif (!apiKey) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Geocoding API key not configured\",\n\t\t\t};\n\t\t}\n\n\t\t// Call Google Geocoding API\n\t\tconst encodedAddress = encodeURIComponent(fullAddress);\n\t\tconst url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodedAddress}&key=${apiKey}`;\n\n\t\tconst response = await fetch(url);\n\n\t\tif (!response.ok) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Geocoding failed with status ${response.status}`,\n\t\t\t};\n\t\t}\n\n\t\tconst data = await response.json();\n\n\t\t// Check if we got results\n\t\tif (data.status === \"OK\" && data.results && data.results.length > 0) {\n\t\t\tconst location = data.results[0].geometry.location;\n\t\t\tconst formattedAddress = data.results[0].formatted_address;\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tcoordinates: {\n\t\t\t\t\tlat: location.lat,\n\t\t\t\t\tlon: location.lng,\n\t\t\t\t\tformattedAddress,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\t\tif (data.status === \"ZERO_RESULTS\") {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Address not found\",\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: data.error_message || `Geocoding failed: ${data.status}`,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown geocoding error\",\n\t\t};\n\t}\n}\n\n/**\n * Geocode an address silently in the background\n * Does not throw errors - returns null on failure\n *\n * Useful for non-critical geocoding where we don't want to block\n * the main operation if geocoding fails\n */\nexport async function geocodeAddressSilent(\n\taddress: string,\n\tcity: string,\n\tstate: string,\n\tzipCode: string,\n\tcountry = \"USA\",\n): Promise<GeocodeResult | null> {\n\ttry {\n\t\tconst result = await geocodeAddress(address, city, state, zipCode, country);\n\t\treturn result.success && result.coordinates ? result.coordinates : null;\n\t} catch (_error) {\n\t\treturn null;\n\t}\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAcD;;;;;;;;;CASC,GACD,eAAe,eACd,OAAe,EACf,IAAY,EACZ,KAAa,EACb,OAAe,EACf,UAAU,KAAK;IAEf,IAAI;QACH,4BAA4B;QAC5B,MAAM,cAAc,GAAG,QAAQ,EAAE,EAAE,KAAK,EAAE,EAAE,MAAM,CAAC,EAAE,QAAQ,EAAE,EAAE,SAAS;QAE1E,+BAA+B;QAC/B,MAAM;QAEN;;QAOA,4BAA4B;QAC5B,MAAM,iBAAiB,mBAAmB;QAC1C,MAAM,MAAM,CAAC,0DAA0D,EAAE,eAAe,KAAK,EAAE,QAAQ;QAEvG,MAAM,WAAW,MAAM,MAAM;QAE7B,IAAI,CAAC,SAAS,EAAE,EAAE;YACjB,OAAO;gBACN,SAAS;gBACT,OAAO,CAAC,6BAA6B,EAAE,SAAS,MAAM,EAAE;YACzD;QACD;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAEhC,0BAA0B;QAC1B,IAAI,KAAK,MAAM,KAAK,QAAQ,KAAK,OAAO,IAAI,KAAK,OAAO,CAAC,MAAM,GAAG,GAAG;YACpE,MAAM,WAAW,KAAK,OAAO,CAAC,EAAE,CAAC,QAAQ,CAAC,QAAQ;YAClD,MAAM,mBAAmB,KAAK,OAAO,CAAC,EAAE,CAAC,iBAAiB;YAE1D,OAAO;gBACN,SAAS;gBACT,aAAa;oBACZ,KAAK,SAAS,GAAG;oBACjB,KAAK,SAAS,GAAG;oBACjB;gBACD;YACD;QACD;QACA,IAAI,KAAK,MAAM,KAAK,gBAAgB;YACnC,OAAO;gBACN,SAAS;gBACT,OAAO;YACR;QACD;QACA,OAAO;YACN,SAAS;YACT,OAAO,KAAK,aAAa,IAAI,CAAC,kBAAkB,EAAE,KAAK,MAAM,EAAE;QAChE;IACD,EAAE,OAAO,OAAO;QACf,OAAO;YACN,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACjD;IACD;AACD;AASO,eAAe,qBACrB,OAAe,EACf,IAAY,EACZ,KAAa,EACb,OAAe,EACf,UAAU,KAAK;IAEf,IAAI;QACH,MAAM,SAAS,MAAM,eAAe,SAAS,MAAM,OAAO,SAAS;QACnE,OAAO,OAAO,OAAO,IAAI,OAAO,WAAW,GAAG,OAAO,WAAW,GAAG;IACpE,EAAE,OAAO,QAAQ;QAChB,OAAO;IACR;AACD"}},
    {"offset": {"line": 5700, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/emails/theme.ts"],"sourcesContent":["export const EMAIL_COLORS = {\n\tbackground: \"#fafafa\",\n\tsurface: \"#fcfcfc\",\n\tsurfaceStrong: \"#f2f2f2\",\n\tprimary: \"#3c6ff5\",\n\tprimaryText: \"#fafafa\",\n\theading: \"#171717\",\n\ttext: \"#171717\",\n\tmuted: \"#737373\",\n\tborder: \"#e6e6e6\",\n};\n"],"names":[],"mappings":";;;;AAAO,MAAM,eAAe;IAC3B,YAAY;IACZ,SAAS;IACT,eAAe;IACf,SAAS;IACT,aAAa;IACb,SAAS;IACT,MAAM;IACN,OAAO;IACP,QAAQ;AACT"}},
    {"offset": {"line": 5719, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/emails/components/button.tsx"],"sourcesContent":["/**\n * Email Button Component - Matches dashboard button design\n *\n * Design:\n * - Primary variant with Thorbis Electric Blue\n * - Outline variant for secondary actions\n * - Responsive and accessible\n * - Supports both link and button styles\n */\n\nimport { Button as EmailButton } from \"@react-email/components\";\nimport { EMAIL_COLORS } from \"../theme\";\n\ntype ButtonProps = {\n\thref: string;\n\tchildren: React.ReactNode;\n\tvariant?: \"primary\" | \"outline\";\n};\n\nexport function Button({ href, children, variant = \"primary\" }: ButtonProps) {\n\tconst baseStyle = {\n\t\tdisplay: \"inline-block\",\n\t\tpadding: \"12px 24px\",\n\t\tfontSize: \"16px\",\n\t\tfontWeight: \"600\",\n\t\ttextDecoration: \"none\",\n\t\tborderRadius: \"8px\",\n\t\ttextAlign: \"center\" as const,\n\t\ttransition: \"all 0.2s ease\",\n\t};\n\n\tconst variantStyles = {\n\t\tprimary: {\n\t\t\tbackgroundColor: EMAIL_COLORS.primary, // Thorbis Electric Blue\n\t\t\tcolor: EMAIL_COLORS.primaryText,\n\t\t\tborder: \"none\",\n\t\t},\n\t\toutline: {\n\t\t\tbackgroundColor: \"transparent\",\n\t\t\tcolor: EMAIL_COLORS.primary,\n\t\t\tborder: `2px solid ${EMAIL_COLORS.primary}`,\n\t\t},\n\t};\n\n\treturn (\n\t\t<EmailButton\n\t\t\thref={href}\n\t\t\tstyle={{\n\t\t\t\t...baseStyle,\n\t\t\t\t...variantStyles[variant],\n\t\t\t}}\n\t\t>\n\t\t\t{children}\n\t\t</EmailButton>\n\t);\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC;;;;;AAED;AACA;;;;AAQO,SAAS,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,UAAU,SAAS,EAAe;IAC1E,MAAM,YAAY;QACjB,SAAS;QACT,SAAS;QACT,UAAU;QACV,YAAY;QACZ,gBAAgB;QAChB,cAAc;QACd,WAAW;QACX,YAAY;IACb;IAEA,MAAM,gBAAgB;QACrB,SAAS;YACR,iBAAiB,gJAAY,CAAC,OAAO;YACrC,OAAO,gJAAY,CAAC,WAAW;YAC/B,QAAQ;QACT;QACA,SAAS;YACR,iBAAiB;YACjB,OAAO,gJAAY,CAAC,OAAO;YAC3B,QAAQ,CAAC,UAAU,EAAE,gJAAY,CAAC,OAAO,EAAE;QAC5C;IACD;IAEA,qBACC,uZAAC,qQAAW;QACX,MAAM;QACN,OAAO;YACN,GAAG,SAAS;YACZ,GAAG,aAAa,CAAC,QAAQ;QAC1B;kBAEC;;;;;;AAGJ"}},
    {"offset": {"line": 5777, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/emails/components/card.tsx"],"sourcesContent":["/**\n * Email Card Component - Information card matching dashboard cards\n *\n * Design:\n * - Clean white background with subtle border\n * - Rounded corners\n * - Padding for content spacing\n * - Optional header and footer sections\n */\n\nimport { Section, Text } from \"@react-email/components\";\nimport type { ReactNode } from \"react\";\nimport { EMAIL_COLORS } from \"../theme\";\n\ntype CardProps = {\n\tchildren: ReactNode;\n\ttitle?: string;\n\tstyle?: React.CSSProperties;\n};\n\nexport function Card({ children, title, style }: CardProps) {\n\treturn (\n\t\t<Section\n\t\t\tstyle={{\n\t\t\t\t...cardStyle,\n\t\t\t\t...style,\n\t\t\t}}\n\t\t>\n\t\t\t{title && <Text style={titleStyle}>{title}</Text>}\n\t\t\t{children}\n\t\t</Section>\n\t);\n}\n\nconst cardStyle = {\n\tbackgroundColor: EMAIL_COLORS.surface,\n\tborder: `1px solid ${EMAIL_COLORS.border}`,\n\tborderRadius: \"8px\",\n\tpadding: \"24px\",\n\tmargin: \"16px 0\",\n};\n\nconst titleStyle = {\n\tfontSize: \"18px\",\n\tfontWeight: \"600\",\n\tcolor: EMAIL_COLORS.heading,\n\tmargin: \"0 0 16px 0\",\n};\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC;;;;;AAED;AAAA;AAEA;;;;AAQO,SAAS,KAAK,EAAE,QAAQ,EAAE,KAAK,EAAE,KAAK,EAAa;IACzD,qBACC,uZAAC,yQAAO;QACP,OAAO;YACN,GAAG,SAAS;YACZ,GAAG,KAAK;QACT;;YAEC,uBAAS,uZAAC,+PAAI;gBAAC,OAAO;0BAAa;;;;;;YACnC;;;;;;;AAGJ;AAEA,MAAM,YAAY;IACjB,iBAAiB,gJAAY,CAAC,OAAO;IACrC,QAAQ,CAAC,UAAU,EAAE,gJAAY,CAAC,MAAM,EAAE;IAC1C,cAAc;IACd,SAAS;IACT,QAAQ;AACT;AAEA,MAAM,aAAa;IAClB,UAAU;IACV,YAAY;IACZ,OAAO,gJAAY,CAAC,OAAO;IAC3B,QAAQ;AACT"}},
    {"offset": {"line": 5836, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/emails/components/heading.tsx"],"sourcesContent":["/**\n * Email Heading Component - Typography for email headings\n *\n * Design:\n * - H1, H2, H3 variants\n * - Matches dashboard typography\n * - Proper spacing and hierarchy\n */\n\nimport { Heading as EmailHeading } from \"@react-email/components\";\nimport { EMAIL_COLORS } from \"../theme\";\n\ntype HeadingProps = {\n\tchildren: React.ReactNode;\n\tlevel?: 1 | 2 | 3;\n\tstyle?: React.CSSProperties;\n};\n\nexport function Heading({ children, level = 1, style }: HeadingProps) {\n\tconst headingTag = `h${level}` as \"h1\" | \"h2\" | \"h3\";\n\tconst headingStyles = {\n\t\t1: {\n\t\t\tfontSize: \"32px\",\n\t\t\tfontWeight: \"700\",\n\t\t\tcolor: EMAIL_COLORS.heading,\n\t\t\tmargin: \"0 0 16px 0\",\n\t\t\tlineHeight: \"1.2\",\n\t\t},\n\t\t2: {\n\t\t\tfontSize: \"24px\",\n\t\t\tfontWeight: \"600\",\n\t\t\tcolor: EMAIL_COLORS.text,\n\t\t\tmargin: \"0 0 12px 0\",\n\t\t\tlineHeight: \"1.3\",\n\t\t},\n\t\t3: {\n\t\t\tfontSize: \"18px\",\n\t\t\tfontWeight: \"600\",\n\t\t\tcolor: EMAIL_COLORS.muted,\n\t\t\tmargin: \"0 0 8px 0\",\n\t\t\tlineHeight: \"1.4\",\n\t\t},\n\t};\n\n\treturn (\n\t\t<EmailHeading\n\t\t\tas={headingTag}\n\t\t\tstyle={{\n\t\t\t\t...headingStyles[level],\n\t\t\t\t...style,\n\t\t\t}}\n\t\t>\n\t\t\t{children}\n\t\t</EmailHeading>\n\t);\n}\n"],"names":[],"mappings":"AAAA;;;;;;;CAOC;;;;;AAED;AACA;;;;AAQO,SAAS,QAAQ,EAAE,QAAQ,EAAE,QAAQ,CAAC,EAAE,KAAK,EAAgB;IACnE,MAAM,aAAa,CAAC,CAAC,EAAE,OAAO;IAC9B,MAAM,gBAAgB;QACrB,GAAG;YACF,UAAU;YACV,YAAY;YACZ,OAAO,gJAAY,CAAC,OAAO;YAC3B,QAAQ;YACR,YAAY;QACb;QACA,GAAG;YACF,UAAU;YACV,YAAY;YACZ,OAAO,gJAAY,CAAC,IAAI;YACxB,QAAQ;YACR,YAAY;QACb;QACA,GAAG;YACF,UAAU;YACV,YAAY;YACZ,OAAO,gJAAY,CAAC,KAAK;YACzB,QAAQ;YACR,YAAY;QACb;IACD;IAEA,qBACC,uZAAC,yQAAY;QACZ,IAAI;QACJ,OAAO;YACN,GAAG,aAAa,CAAC,MAAM;YACvB,GAAG,KAAK;QACT;kBAEC;;;;;;AAGJ"}},
    {"offset": {"line": 5895, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/emails/layouts/base-layout.tsx"],"sourcesContent":["/**\n * Thorbis-Branded Email Layout\n *\n * For platform/system emails:\n * - Clean, full-width design (no cards)\n * - Thorbis logo image from CDN/env\n * - Thorbis Electric Blue branding\n * - Professional footer with Thorbis info\n *\n * Uses environment variables for:\n * - Logo URL\n * - App URL\n * - Support email\n * - Company info\n */\n\nimport {\n\tBody,\n\tContainer,\n\tHead,\n\tHr,\n\tHtml,\n\tImg,\n\tLink,\n\tPreview,\n\tSection,\n\tText,\n} from \"@react-email/components\";\nimport type { ReactNode } from \"react\";\nimport { EMAIL_COLORS } from \"../theme\";\n\ntype BaseLayoutProps = {\n\tchildren: ReactNode;\n\tpreviewText?: string;\n};\n\n// Environment-based configuration\nconst THORBIS_LOGO_URL =\n\tprocess.env.NEXT_PUBLIC_THORBIS_LOGO_URL ||\n\t\"https://thorbis.com/logo-white.png\";\nconst THORBIS_APP_URL =\n\tprocess.env.NEXT_PUBLIC_APP_URL || \"https://app.thorbis.com\";\nconst THORBIS_WEBSITE =\n\tprocess.env.NEXT_PUBLIC_WEBSITE_URL || \"https://thorbis.com\";\nconst THORBIS_SUPPORT_EMAIL =\n\tprocess.env.THORBIS_SUPPORT_EMAIL || \"support@thorbis.com\";\nconst THORBIS_DOCS_URL = `${THORBIS_WEBSITE}/docs`;\nconst THORBIS_PRIVACY_URL = `${THORBIS_WEBSITE}/privacy`;\nconst THORBIS_TERMS_URL = `${THORBIS_WEBSITE}/terms`;\n\nexport function BaseLayout({ children, previewText }: BaseLayoutProps) {\n\treturn (\n\t\t<Html>\n\t\t\t<Head>\n\t\t\t\t<style>{`\n          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');\n\n          /* Reset email client styles */\n          body { margin: 0; padding: 0; }\n          table { border-collapse: collapse; }\n          img { border: 0; }\n\n          /* Responsive */\n          @media only screen and (max-width: 600px) {\n            .mobile-padding { padding: 20px !important; }\n            .mobile-text { font-size: 14px !important; }\n            .mobile-heading { font-size: 24px !important; }\n          }\n        `}</style>\n\t\t\t</Head>\n\t\t\t{previewText && <Preview>{previewText}</Preview>}\n\t\t\t<Body style={main}>\n\t\t\t\t<Container style={container}>\n\t\t\t\t\t{/* Header with Thorbis logo on blue background */}\n\t\t\t\t\t<Section style={header}>\n\t\t\t\t\t\t<Img\n\t\t\t\t\t\t\tsrc={THORBIS_LOGO_URL}\n\t\t\t\t\t\t\talt=\"Thorbis\"\n\t\t\t\t\t\t\twidth=\"160\"\n\t\t\t\t\t\t\theight=\"40\"\n\t\t\t\t\t\t\tstyle={logo}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</Section>\n\n\t\t\t\t\t{/* Main content - full width, no cards */}\n\t\t\t\t\t<Section style={content} className=\"mobile-padding\">\n\t\t\t\t\t\t{children}\n\t\t\t\t\t</Section>\n\n\t\t\t\t\t{/* Divider */}\n\t\t\t\t\t<Hr style={divider} />\n\n\t\t\t\t\t{/* Footer */}\n\t\t\t\t\t<Section style={footer} className=\"mobile-padding\">\n\t\t\t\t\t\t{/* Support Links */}\n\t\t\t\t\t\t<Text style={footerText}>\n\t\t\t\t\t\t\tNeed help?{\" \"}\n\t\t\t\t\t\t\t<Link href={`mailto:${THORBIS_SUPPORT_EMAIL}`} style={footerLink}>\n\t\t\t\t\t\t\t\tContact Support\n\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t\t{\"  \"}\n\t\t\t\t\t\t\t<Link href={THORBIS_DOCS_URL} style={footerLink}>\n\t\t\t\t\t\t\t\tDocumentation\n\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t</Text>\n\n\t\t\t\t\t\t{/* Legal Links */}\n\t\t\t\t\t\t<Text style={footerText}>\n\t\t\t\t\t\t\t<Link href={THORBIS_PRIVACY_URL} style={footerLink}>\n\t\t\t\t\t\t\t\tPrivacy Policy\n\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t\t{\"  \"}\n\t\t\t\t\t\t\t<Link href={THORBIS_TERMS_URL} style={footerLink}>\n\t\t\t\t\t\t\t\tTerms of Service\n\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t</Text>\n\n\t\t\t\t\t\t{/* Company Info */}\n\t\t\t\t\t\t<Text style={footerCopyright}>\n\t\t\t\t\t\t\t {new Date().getFullYear()} Thorbis. All rights reserved.\n\t\t\t\t\t\t</Text>\n\n\t\t\t\t\t\t<Text style={footerAddress}>\n\t\t\t\t\t\t\tThorbis  123 Innovation Drive, San Francisco, CA 94105\n\t\t\t\t\t\t</Text>\n\n\t\t\t\t\t\t{/* Unsubscribe - required for CAN-SPAM compliance */}\n\t\t\t\t\t\t<Text style={footerUnsubscribe}>\n\t\t\t\t\t\t\tYou're receiving this email because you have an account with\n\t\t\t\t\t\t\tThorbis.{\" \"}\n\t\t\t\t\t\t\t<Link href=\"{{unsubscribe_url}}\" style={footerLink}>\n\t\t\t\t\t\t\t\tUnsubscribe from marketing emails\n\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t</Text>\n\t\t\t\t\t</Section>\n\t\t\t\t</Container>\n\t\t\t</Body>\n\t\t</Html>\n\t);\n}\n\n// Styles - Clean, full-width design\nconst main = {\n\tbackgroundColor: EMAIL_COLORS.background,\n\tfontFamily:\n\t\t'Inter, -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif',\n\tWebkitFontSmoothing: \"antialiased\" as const,\n\tMozOsxFontSmoothing: \"grayscale\" as const,\n};\n\nconst container = {\n\tbackgroundColor: EMAIL_COLORS.surface,\n\tmaxWidth: \"600px\",\n\tmargin: \"0 auto\",\n};\n\nconst header = {\n\tbackgroundColor: EMAIL_COLORS.primary, // Thorbis Electric Blue\n\tpadding: \"40px 0\",\n\ttextAlign: \"center\" as const,\n};\n\nconst logo = {\n\tmargin: \"0 auto\",\n\tdisplay: \"block\",\n};\n\nconst content = {\n\tpadding: \"48px 40px\",\n\tcolor: EMAIL_COLORS.text,\n\tfontSize: \"16px\",\n\tlineHeight: \"24px\",\n};\n\nconst divider = {\n\tborderColor: EMAIL_COLORS.border,\n\tborderWidth: \"1px\",\n\tmargin: \"0\",\n};\n\nconst footer = {\n\tpadding: \"32px 40px\",\n\ttextAlign: \"center\" as const,\n\tbackgroundColor: EMAIL_COLORS.surfaceStrong,\n};\n\nconst footerText = {\n\tcolor: EMAIL_COLORS.muted,\n\tfontSize: \"14px\",\n\tlineHeight: \"24px\",\n\tmargin: \"8px 0\",\n};\n\nconst footerLink = {\n\tcolor: EMAIL_COLORS.primary,\n\ttextDecoration: \"none\",\n\tfontWeight: \"500\",\n};\n\nconst footerCopyright = {\n\tcolor: EMAIL_COLORS.muted,\n\tfontSize: \"13px\",\n\tmargin: \"16px 0 0 0\",\n\tfontWeight: \"600\",\n};\n\nconst footerAddress = {\n\tcolor: EMAIL_COLORS.muted,\n\tfontSize: \"12px\",\n\tmargin: \"8px 0\",\n};\n\nconst footerUnsubscribe = {\n\tcolor: EMAIL_COLORS.muted,\n\tfontSize: \"11px\",\n\tmargin: \"16px 0 0 0\",\n\tlineHeight: \"18px\",\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6207, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/emails/templates/customer/portal-invitation.tsx"],"sourcesContent":["/**\n * Portal Invitation Email Template - Customer portal access invitation\n *\n * Features:\n * - Invitation to access customer portal\n * - Secure setup link with expiration\n * - Portal features overview\n * - Getting started guide\n */\n\nimport { Text } from \"@react-email/components\";\nimport { Button } from \"../../components/button\";\nimport { Card } from \"../../components/card\";\nimport { Heading } from \"../../components/heading\";\nimport { BaseLayout } from \"../../layouts/base-layout\";\nimport { EMAIL_COLORS } from \"../../theme\";\n\nexport type PortalInvitationProps = {\n\tcustomerName: string;\n\tportalUrl: string;\n\texpiresInHours?: number;\n\tcompanyName?: string;\n\tsupportEmail?: string;\n\tsupportPhone?: string;\n\tpreviewText?: string;\n};\n\nexport default function PortalInvitationEmail({\n\tcustomerName,\n\tportalUrl,\n\texpiresInHours = 168, // 7 days default\n\tcompanyName = \"Thorbis\",\n\tsupportEmail = \"support@thorbis.com\",\n\tsupportPhone = \"(555) 123-4567\",\n\tpreviewText = \"You've been invited to access your customer portal\",\n}: PortalInvitationProps) {\n\treturn (\n\t\t<BaseLayout previewText={previewText}>\n\t\t\t<Heading level={1}>You're Invited!</Heading>\n\n\t\t\t<Text style={paragraph}>Hi {customerName},</Text>\n\n\t\t\t<Text style={paragraph}>\n\t\t\t\tGreat news! You now have access to your {companyName} customer portal -\n\t\t\t\ta convenient online hub where you can manage your services, view\n\t\t\t\tinvoices, and communicate with us anytime.\n\t\t\t</Text>\n\n\t\t\t<Card style={invitationCard}>\n\t\t\t\t<div style={invitationIcon}></div>\n\t\t\t\t<Text style={invitationTitle}>Your Portal is Ready!</Text>\n\t\t\t\t<Text style={invitationText}>\n\t\t\t\t\tClick the button below to set up your account and access all your\n\t\t\t\t\tservice information in one place.\n\t\t\t\t</Text>\n\t\t\t</Card>\n\n\t\t\t<div style={buttonContainer}>\n\t\t\t\t<Button href={portalUrl}>Set Up My Account</Button>\n\t\t\t</div>\n\n\t\t\t<Card style={expiryCard}>\n\t\t\t\t<Text style={expiryText}>\n\t\t\t\t\t This invitation link will expire in{\" \"}\n\t\t\t\t\t<strong>{expiresInHours} hours</strong>. Please complete your account\n\t\t\t\t\tsetup soon.\n\t\t\t\t</Text>\n\t\t\t</Card>\n\n\t\t\t<Card style={featuresCard}>\n\t\t\t\t<Heading level={3}>What you can do in your portal:</Heading>\n\t\t\t\t<ul style={featuresList}>\n\t\t\t\t\t<li style={featureItem}>\n\t\t\t\t\t\t<strong> View & Schedule Services:</strong> Book appointments and\n\t\t\t\t\t\ttrack upcoming service visits\n\t\t\t\t\t</li>\n\t\t\t\t\t<li style={featureItem}>\n\t\t\t\t\t\t<strong> Manage Invoices:</strong> View billing history and pay\n\t\t\t\t\t\tinvoices online securely\n\t\t\t\t\t</li>\n\t\t\t\t\t<li style={featureItem}>\n\t\t\t\t\t\t<strong> Service History:</strong> Access complete records of all\n\t\t\t\t\t\tyour past services\n\t\t\t\t\t</li>\n\t\t\t\t\t<li style={featureItem}>\n\t\t\t\t\t\t<strong> Property Details:</strong> Manage multiple properties and\n\t\t\t\t\t\tservice locations\n\t\t\t\t\t</li>\n\t\t\t\t\t<li style={featureItem}>\n\t\t\t\t\t\t<strong> Direct Communication:</strong> Message our team and get\n\t\t\t\t\t\treal-time updates\n\t\t\t\t\t</li>\n\t\t\t\t\t<li style={featureItem}>\n\t\t\t\t\t\t<strong> Mobile Access:</strong> Access your account from any\n\t\t\t\t\t\tdevice, anywhere\n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t</Card>\n\n\t\t\t<Card style={securityCard}>\n\t\t\t\t<Heading level={3}>Secure & Private</Heading>\n\t\t\t\t<Text style={securityText}>\n\t\t\t\t\tYour portal is protected with industry-standard security. Only you can\n\t\t\t\t\taccess your account information, and all data is encrypted for your\n\t\t\t\t\tprotection.\n\t\t\t\t</Text>\n\t\t\t</Card>\n\n\t\t\t<Card style={stepsCard}>\n\t\t\t\t<Heading level={3}>Getting Started is Easy</Heading>\n\t\t\t\t<div style={stepGrid}>\n\t\t\t\t\t<div style={step}>\n\t\t\t\t\t\t<div style={stepNumber}>1</div>\n\t\t\t\t\t\t<Text style={stepText}>\n\t\t\t\t\t\t\tClick the \"Set Up My Account\" button above\n\t\t\t\t\t\t</Text>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div style={step}>\n\t\t\t\t\t\t<div style={stepNumber}>2</div>\n\t\t\t\t\t\t<Text style={stepText}>\n\t\t\t\t\t\t\tCreate a secure password for your account\n\t\t\t\t\t\t</Text>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div style={step}>\n\t\t\t\t\t\t<div style={stepNumber}>3</div>\n\t\t\t\t\t\t<Text style={stepText}>\n\t\t\t\t\t\t\tExplore your portal and manage your services!\n\t\t\t\t\t\t</Text>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</Card>\n\n\t\t\t<Card style={helpCard}>\n\t\t\t\t<Heading level={3}>Need Help?</Heading>\n\t\t\t\t<Text style={helpText}>\n\t\t\t\t\tIf you have any questions about setting up your portal or need\n\t\t\t\t\tassistance, our support team is here to help.\n\t\t\t\t</Text>\n\t\t\t\t<div style={contactGrid}>\n\t\t\t\t\t<div style={contactMethod}>\n\t\t\t\t\t\t<Text style={contactLabel}>Email:</Text>\n\t\t\t\t\t\t<a href={`mailto:${supportEmail}`} style={contactLink}>\n\t\t\t\t\t\t\t{supportEmail}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div style={contactMethod}>\n\t\t\t\t\t\t<Text style={contactLabel}>Phone:</Text>\n\t\t\t\t\t\t<a href={`tel:${supportPhone}`} style={contactLink}>\n\t\t\t\t\t\t\t{supportPhone}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</Card>\n\n\t\t\t<Text style={footerNote}>\n\t\t\t\t<strong>Note:</strong> If you didn't request portal access or believe\n\t\t\t\tyou received this email in error, please contact us at{\" \"}\n\t\t\t\t<a href={`mailto:${supportEmail}`} style={inlineLink}>\n\t\t\t\t\t{supportEmail}\n\t\t\t\t</a>\n\t\t\t\t.\n\t\t\t</Text>\n\t\t</BaseLayout>\n\t);\n}\n\n// Styles\nconst paragraph = {\n\tcolor: \"#374151\",\n\tfontSize: \"16px\",\n\tlineHeight: \"24px\",\n\tmargin: \"0 0 16px 0\",\n};\n\nconst invitationCard = {\n\tbackground:\n\t\t\"linear-gradient(135deg, hsl(217 91% 60%) 0%, hsl(217 91% 50%) 100%)\",\n\tborderRadius: \"12px\",\n\tpadding: \"40px\",\n\tmargin: \"24px 0\",\n\ttextAlign: \"center\" as const,\n};\n\nconst invitationIcon = {\n\tfontSize: \"64px\",\n\tmargin: \"0 0 16px 0\",\n};\n\nconst invitationTitle = {\n\tcolor: EMAIL_COLORS.primaryText,\n\tfontSize: \"24px\",\n\tfontWeight: \"600\",\n\tmargin: \"0 0 12px 0\",\n};\n\nconst invitationText = {\n\tcolor: EMAIL_COLORS.primaryText,\n\tfontSize: \"16px\",\n\tlineHeight: \"24px\",\n\tmargin: \"0\",\n\topacity: \"0.95\",\n};\n\nconst buttonContainer = {\n\tmargin: \"32px 0\",\n\ttextAlign: \"center\" as const,\n};\n\nconst expiryCard = {\n\tbackgroundColor: \"#fef3c7\",\n\tborder: \"1px solid #fde68a\",\n\tborderRadius: \"8px\",\n\tpadding: \"16px\",\n\tmargin: \"24px 0\",\n\ttextAlign: \"center\" as const,\n};\n\nconst expiryText = {\n\tcolor: \"#92400e\",\n\tfontSize: \"14px\",\n\tlineHeight: \"20px\",\n\tmargin: \"0\",\n};\n\nconst featuresCard = {\n\tbackgroundColor: \"#f0fdf4\",\n\tborder: \"1px solid #bbf7d0\",\n\tmargin: \"24px 0\",\n};\n\nconst featuresList = {\n\tcolor: \"#166534\",\n\tfontSize: \"14px\",\n\tlineHeight: \"22px\",\n\tmargin: \"12px 0 0 20px\",\n\tpadding: \"0\",\n};\n\nconst featureItem = {\n\tmargin: \"0 0 12px 0\",\n};\n\nconst securityCard = {\n\tbackgroundColor: \"#f5f3ff\",\n\tborder: \"1px solid #ddd6fe\",\n\tmargin: \"24px 0\",\n};\n\nconst securityText = {\n\tcolor: \"#5b21b6\",\n\tfontSize: \"15px\",\n\tlineHeight: \"22px\",\n\tmargin: \"12px 0 0 0\",\n};\n\nconst stepsCard = {\n\tbackgroundColor: \"#eff6ff\",\n\tborder: \"1px solid #bfdbfe\",\n\tmargin: \"24px 0\",\n};\n\nconst stepGrid = {\n\tdisplay: \"grid\" as const,\n\tgridTemplateColumns: \"1fr 1fr 1fr\",\n\tgap: \"20px\",\n\tmargin: \"20px 0 0 0\",\n};\n\nconst step = {\n\ttextAlign: \"center\" as const,\n};\n\nconst stepNumber = {\n\twidth: \"40px\",\n\theight: \"40px\",\n\tbackgroundColor: \"hsl(217 91% 60%)\",\n\tcolor: EMAIL_COLORS.primaryText,\n\tborderRadius: \"50%\",\n\tdisplay: \"inline-flex\",\n\talignItems: \"center\",\n\tjustifyContent: \"center\",\n\tfontSize: \"18px\",\n\tfontWeight: \"600\",\n\tmargin: \"0 auto 12px auto\",\n};\n\nconst stepText = {\n\tcolor: \"#1e40af\",\n\tfontSize: \"13px\",\n\tlineHeight: \"18px\",\n\tmargin: \"0\",\n};\n\nconst helpCard = {\n\tbackgroundColor: \"#fef2f2\",\n\tborder: \"1px solid #fecaca\",\n\tmargin: \"24px 0\",\n};\n\nconst helpText = {\n\tcolor: \"#991b1b\",\n\tfontSize: \"15px\",\n\tlineHeight: \"22px\",\n\tmargin: \"12px 0 20px 0\",\n};\n\nconst contactGrid = {\n\tdisplay: \"grid\" as const,\n\tgridTemplateColumns: \"1fr 1fr\",\n\tgap: \"16px\",\n};\n\nconst contactMethod = {\n\ttextAlign: \"center\" as const,\n};\n\nconst contactLabel = {\n\tcolor: \"#6b7280\",\n\tfontSize: \"12px\",\n\ttextTransform: \"uppercase\" as const,\n\tletterSpacing: \"0.05em\",\n\tmargin: \"0 0 8px 0\",\n};\n\nconst contactLink = {\n\tcolor: \"hsl(217 91% 60%)\",\n\tfontSize: \"15px\",\n\tfontWeight: \"600\",\n\ttextDecoration: \"underline\",\n};\n\nconst footerNote = {\n\tcolor: \"#6b7280\",\n\tfontSize: \"13px\",\n\tlineHeight: \"20px\",\n\tmargin: \"32px 0 0 0\",\n\tpadding: \"20px\",\n\tbackgroundColor: \"#f9fafb\",\n\tborderRadius: \"8px\",\n\ttextAlign: \"center\" as const,\n};\n\nconst inlineLink = {\n\tcolor: \"hsl(217 91% 60%)\",\n\ttextDecoration: \"underline\",\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6881, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/actions/customers.ts"],"sourcesContent":["/**\n * Customer Management Server Actions\n *\n * Comprehensive customer relationship management with:\n * - Customer CRUD operations\n * - Customer portal invitation and access\n * - Customer metrics tracking (revenue, jobs, invoices)\n * - Communication preferences\n * - Soft delete/archive support\n * - Customer search and filtering\n */\n\n\"use server\";\n\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport { sendEmail } from \"@/lib/email/email-sender\";\nimport { EmailTemplate } from \"@/lib/email/email-types\";\nimport {\n    ActionError,\n    ERROR_CODES,\n    ERROR_MESSAGES,\n} from \"@/lib/errors/action-error\";\nimport {\n    type ActionResult,\n    assertAuthenticated,\n    assertExists,\n    withErrorHandling,\n} from \"@/lib/errors/with-error-handling\";\nimport { geocodeAddressSilent } from \"@/lib/services/geocoding\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport PortalInvitationEmail from \"../../emails/templates/customer/portal-invitation\";\n\n// ============================================================================\n// VALIDATION SCHEMAS\n// ============================================================================\n\nconst CUSTOMER_NAME_MAX_LENGTH = 100;\nconst CUSTOMER_COMPANY_MAX_LENGTH = 200;\nconst CUSTOMER_PHONE_MAX_LENGTH = 20;\nconst CUSTOMER_ADDRESS_MAX_LENGTH = 200;\nconst CUSTOMER_ADDRESS2_MAX_LENGTH = 100;\nconst CUSTOMER_CITY_MAX_LENGTH = 100;\nconst CUSTOMER_STATE_MAX_LENGTH = 50;\n\n// HTTP Status codes\nconst HTTP_STATUS_FORBIDDEN = 403;\n\n// Search defaults\nconst DEFAULT_SEARCH_LIMIT = 50;\nconst CUSTOMER_ZIP_MAX_LENGTH = 20;\nconst CUSTOMER_COUNTRY_MAX_LENGTH = 50;\nconst CUSTOMER_TAX_EXEMPT_NUMBER_MAX_LENGTH = 50;\nconst CENTS_PER_DOLLAR = 100;\n\nfunction requireSiteUrl(): string {\n\tconst siteUrl = process.env.NEXT_PUBLIC_SITE_URL;\n\tif (!siteUrl) {\n\t\tthrow new ActionError(\n\t\t\t\"NEXT_PUBLIC_SITE_URL is not configured\",\n\t\t\tERROR_CODES.INTERNAL_SERVER_ERROR,\n\t\t);\n\t}\n\treturn siteUrl.replace(/\\/$/, \"\");\n}\n\nconst customerSchema = z.object({\n\ttype: z\n\t\t.enum([\"residential\", \"commercial\", \"industrial\"])\n\t\t.default(\"residential\"),\n\tfirstName: z\n\t\t.string()\n\t\t.min(1, \"First name is required\")\n\t\t.max(CUSTOMER_NAME_MAX_LENGTH),\n\tlastName: z\n\t\t.string()\n\t\t.min(1, \"Last name is required\")\n\t\t.max(CUSTOMER_NAME_MAX_LENGTH),\n\tcompanyName: z.string().max(CUSTOMER_COMPANY_MAX_LENGTH).optional(),\n\temail: z.string().email(\"Invalid email address\"),\n\tphone: z.string().min(1, \"Phone is required\").max(CUSTOMER_PHONE_MAX_LENGTH),\n\tsecondaryPhone: z.string().max(CUSTOMER_PHONE_MAX_LENGTH).optional(),\n\taddress: z.string().max(CUSTOMER_ADDRESS_MAX_LENGTH).optional(),\n\taddress2: z.string().max(CUSTOMER_ADDRESS2_MAX_LENGTH).optional(),\n\tcity: z.string().max(CUSTOMER_CITY_MAX_LENGTH).optional(),\n\tstate: z.string().max(CUSTOMER_STATE_MAX_LENGTH).optional(),\n\tzipCode: z.string().max(CUSTOMER_ZIP_MAX_LENGTH).optional(),\n\tcountry: z.string().max(CUSTOMER_COUNTRY_MAX_LENGTH).default(\"USA\"),\n\tsource: z\n\t\t.enum([\"referral\", \"google\", \"facebook\", \"direct\", \"yelp\", \"other\"])\n\t\t.optional(),\n\treferredBy: z.string().uuid().optional().nullable(),\n\tpreferredContactMethod: z.enum([\"email\", \"phone\", \"sms\"]).default(\"email\"),\n\tpreferredTechnician: z.string().uuid().optional().nullable(),\n\tbillingEmail: z.string().email().optional().nullable(),\n\tpaymentTerms: z\n\t\t.enum([\"due_on_receipt\", \"net_15\", \"net_30\", \"net_60\"])\n\t\t.default(\"due_on_receipt\"),\n\tcreditLimit: z.number().int().min(0).default(0), // In cents\n\ttaxExempt: z.boolean().default(false),\n\ttaxExemptNumber: z\n\t\t.string()\n\t\t.max(CUSTOMER_TAX_EXEMPT_NUMBER_MAX_LENGTH)\n\t\t.optional(),\n\ttags: z.array(z.string()).optional(),\n\tnotes: z.string().optional(),\n\tinternalNotes: z.string().optional(),\n});\n\nconst communicationPreferencesSchema = z.object({\n\temail: z.boolean().default(true),\n\tsms: z.boolean().default(true),\n\tphone: z.boolean().default(true),\n\tmarketing: z.boolean().default(false),\n});\n\n// ============================================================================\n// CUSTOMER CRUD OPERATIONS\n// ============================================================================\n\n/**\n * Create a new customer with multiple contacts and properties\n */\nasync function createCustomer(\n\tformData: FormData,\n): Promise<ActionResult<string>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\t\tconst { contacts, properties, tags } =\n\t\t\tparseCustomerContactsPropertiesAndTags(formData);\n\t\tconst primaryContact = getPrimaryContactOrThrow(contacts);\n\t\tconst primaryProperty = getPrimaryProperty(properties);\n\n\t\tawait assertCustomerEmailNotDuplicate(\n\t\t\tsupabase,\n\t\t\tteamMember.company_id,\n\t\t\tprimaryContact.email,\n\t\t);\n\n\t\tconst customerType = formData.get(\"type\") || \"residential\";\n\t\tconst companyName = formData.get(\"companyName\");\n\t\tconst displayName = buildCustomerDisplayName(\n\t\t\tcustomerType,\n\t\t\tcompanyName,\n\t\t\tprimaryContact,\n\t\t);\n\n\t\tconst communicationPreferences = buildDefaultCommunicationPreferences();\n\t\tconst customerMetadata = buildCustomerMetadata(contacts);\n\n\t\tconst { lat: customerLat, lon: customerLon } =\n\t\t\tawait geocodePrimaryPropertyIfAvailable(primaryProperty);\n\n\t\tconst customer = await insertCustomerRecord(supabase, {\n\t\t\tcompanyId: teamMember.company_id,\n\t\t\tcustomerType,\n\t\t\tprimaryContact,\n\t\t\tcompanyNameValue: companyName,\n\t\t\tdisplayName,\n\t\t\tprimaryProperty,\n\t\t\tcustomerLat,\n\t\t\tcustomerLon,\n\t\t\tformData,\n\t\t\ttags,\n\t\t\tcommunicationPreferences,\n\t\t\tcustomerMetadata,\n\t\t});\n\n\t\tawait insertAdditionalPropertiesIfAny(\n\t\t\tsupabase,\n\t\t\tteamMember.company_id,\n\t\t\tcustomer.id,\n\t\t\tproperties,\n\t\t);\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\treturn customer.id;\n\t});\n}\n\ntype ParsedCustomerContact = {\n\tfirstName: string;\n\tlastName: string;\n\temail: string;\n\tphone: string;\n\trole: string;\n\tisPrimary: boolean;\n};\n\ntype ParsedCustomerProperty = {\n\tname: string;\n\taddress: string;\n\taddress2: string;\n\tcity: string;\n\tstate: string;\n\tzipCode: string;\n\tcountry: string;\n\tpropertyType: string;\n\tisPrimary: boolean;\n\tnotes: string;\n};\n\ntype ParsedCustomerFormCollections = {\n\tcontacts: ParsedCustomerContact[];\n\tproperties: ParsedCustomerProperty[];\n\ttags?: string[];\n};\n\nasync function requireCustomerCompanyMembership(\n\tsupabase: NonNullable<Awaited<ReturnType<typeof createClient>>>,\n\tuserId: string,\n) {\n\tconst { data: teamMember } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(\"company_id\")\n\t\t.eq(\"user_id\", userId)\n\t\t.single();\n\n\tif (!teamMember?.company_id) {\n\t\tthrow new ActionError(\n\t\t\t\"You must be part of a company\",\n\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t);\n\t}\n\n\treturn teamMember;\n}\n\nfunction parseCustomerContactsPropertiesAndTags(\n\tformData: FormData,\n): ParsedCustomerFormCollections {\n\tconst contacts = parseContacts(formData.get(\"contacts\"));\n\tconst properties = parseProperties(formData.get(\"properties\"));\n\tconst tags = parseTagsField(formData.get(\"tags\"));\n\n\treturn { contacts, properties, tags };\n}\n\nfunction parseContacts(\n\tvalue: FormDataEntryValue | null,\n): ParsedCustomerContact[] {\n\tif (!value || typeof value !== \"string\") {\n\t\treturn [];\n\t}\n\n\ttry {\n\t\treturn JSON.parse(value) as ParsedCustomerContact[];\n\t} catch {\n\t\tthrow new ActionError(\n\t\t\t\"Invalid contacts data\",\n\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t);\n\t}\n}\n\nfunction parseProperties(\n\tvalue: FormDataEntryValue | null,\n): ParsedCustomerProperty[] {\n\tif (!value || typeof value !== \"string\") {\n\t\treturn [];\n\t}\n\n\ttry {\n\t\treturn JSON.parse(value) as ParsedCustomerProperty[];\n\t} catch {\n\t\tthrow new ActionError(\n\t\t\t\"Invalid properties data\",\n\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t);\n\t}\n}\n\nfunction parseTagsField(\n\tvalue: FormDataEntryValue | null,\n): string[] | undefined {\n\tif (!value || typeof value !== \"string\") {\n\t\treturn;\n\t}\n\n\ttry {\n\t\treturn JSON.parse(value) as string[];\n\t} catch {\n\t\treturn value.split(\",\").map((t) => t.trim());\n\t}\n}\n\nfunction getPrimaryContactOrThrow(\n\tcontacts: ParsedCustomerContact[],\n): ParsedCustomerContact {\n\tconst primaryContact = contacts.find((c) => c.isPrimary) || contacts[0];\n\tif (!primaryContact) {\n\t\tthrow new ActionError(\n\t\t\t\"At least one contact is required\",\n\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t);\n\t}\n\treturn primaryContact;\n}\n\nfunction getPrimaryProperty(\n\tproperties: ParsedCustomerProperty[],\n): ParsedCustomerProperty | undefined {\n\treturn properties.find((p) => p.isPrimary) || properties[0];\n}\n\nasync function assertCustomerEmailNotDuplicate(\n\tsupabase: NonNullable<Awaited<ReturnType<typeof createClient>>>,\n\tcompanyId: string,\n\temail: string,\n) {\n\tconst { data: existingEmail } = await supabase\n\t\t.from(\"customers\")\n\t\t.select(\"id\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"email\", email)\n\t\t.is(\"deleted_at\", null)\n\t\t.single();\n\n\tif (existingEmail) {\n\t\tthrow new ActionError(\n\t\t\t\"A customer with this email already exists\",\n\t\t\tERROR_CODES.DB_DUPLICATE_ENTRY,\n\t\t);\n\t}\n}\n\nfunction buildCustomerDisplayName(\n\tcustomerType: FormDataEntryValue | null,\n\tcompanyNameValue: FormDataEntryValue | null,\n\tprimaryContact: ParsedCustomerContact,\n): string {\n\tconst companyName = companyNameValue ? String(companyNameValue) : null;\n\n\tif (customerType === \"commercial\" && companyName) {\n\t\treturn companyName;\n\t}\n\n\treturn `${primaryContact.firstName} ${primaryContact.lastName}`;\n}\n\nfunction buildDefaultCommunicationPreferences() {\n\treturn {\n\t\temail: true,\n\t\tsms: true,\n\t\tphone: true,\n\t\tmarketing: false,\n\t};\n}\n\nfunction buildCustomerMetadata(contacts: ParsedCustomerContact[]) {\n\treturn {\n\t\tcontacts: contacts.map((c) => ({\n\t\t\tfirstName: c.firstName,\n\t\t\tlastName: c.lastName,\n\t\t\temail: c.email,\n\t\t\tphone: c.phone,\n\t\t\trole: c.role,\n\t\t\tisPrimary: c.isPrimary,\n\t\t})),\n\t};\n}\n\nasync function geocodePrimaryPropertyIfAvailable(\n\tprimaryProperty: ParsedCustomerProperty | undefined,\n): Promise<{ lat: number | null; lon: number | null }> {\n\tif (\n\t\t!(\n\t\t\tprimaryProperty?.address &&\n\t\t\tprimaryProperty.city &&\n\t\t\tprimaryProperty.state &&\n\t\t\tprimaryProperty.zipCode\n\t\t)\n\t) {\n\t\treturn { lat: null, lon: null };\n\t}\n\n\tconst geocodeResult = await geocodeAddressSilent(\n\t\tprimaryProperty.address,\n\t\tprimaryProperty.city,\n\t\tprimaryProperty.state,\n\t\tprimaryProperty.zipCode,\n\t\tprimaryProperty.country || \"USA\",\n\t);\n\n\tif (!geocodeResult) {\n\t\treturn { lat: null, lon: null };\n\t}\n\n\treturn { lat: geocodeResult.lat, lon: geocodeResult.lon };\n}\n\ntype InsertCustomerParams = {\n\tcompanyId: string;\n\tcustomerType: FormDataEntryValue | null;\n\tprimaryContact: ParsedCustomerContact;\n\tcompanyNameValue: FormDataEntryValue | null;\n\tdisplayName: string;\n\tprimaryProperty?: ParsedCustomerProperty;\n\tcustomerLat: number | null;\n\tcustomerLon: number | null;\n\tformData: FormData;\n\ttags?: string[];\n\tcommunicationPreferences: {\n\t\temail: boolean;\n\t\tsms: boolean;\n\t\tphone: boolean;\n\t\tmarketing: boolean;\n\t};\n\tcustomerMetadata: Record<string, unknown>;\n};\n\nasync function insertCustomerRecord(\n\tsupabase: NonNullable<Awaited<ReturnType<typeof createClient>>>,\n\tparams: InsertCustomerParams,\n) {\n\tconst payload = buildCustomerInsertPayload(params);\n\n\tconst { data: customer, error: createError } = await supabase\n\t\t.from(\"customers\")\n\t\t.insert(payload)\n\t\t.select(\"id\")\n\t\t.single();\n\n\tif (createError || !customer) {\n\t\tthrow new ActionError(\n\t\t\tERROR_MESSAGES.operationFailed(\"create customer\"),\n\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t);\n\t}\n\n\treturn customer;\n}\n\nfunction buildCustomerInsertPayload(\n\tparams: InsertCustomerParams,\n): Record<string, unknown> {\n\tconst {\n\t\tcompanyId,\n\t\tcustomerType,\n\t\tprimaryContact,\n\t\tcompanyNameValue,\n\t\tdisplayName,\n\t\tprimaryProperty,\n\t\tcustomerLat,\n\t\tcustomerLon,\n\t\tformData,\n\t\ttags,\n\t\tcommunicationPreferences,\n\t\tcustomerMetadata,\n\t} = params;\n\n\tconst companyName = companyNameValue ? String(companyNameValue) : null;\n\n\treturn {\n\t\tcompany_id: companyId,\n\t\ttype: String(customerType || \"residential\"),\n\t\tfirst_name: primaryContact.firstName,\n\t\tlast_name: primaryContact.lastName,\n\t\tcompany_name: companyName,\n\t\tdisplay_name: displayName,\n\t\temail: primaryContact.email,\n\t\tphone: primaryContact.phone,\n\t\tsecondary_phone: null,\n\t\taddress: primaryProperty?.address || null,\n\t\taddress2: primaryProperty?.address2 || null,\n\t\tcity: primaryProperty?.city || null,\n\t\tstate: primaryProperty?.state || null,\n\t\tzip_code: primaryProperty?.zipCode || null,\n\t\tcountry: primaryProperty?.country || \"USA\",\n\t\tlat: customerLat,\n\t\tlon: customerLon,\n\t\tsource: formData.get(\"source\") ? String(formData.get(\"source\")) : null,\n\t\treferred_by: formData.get(\"referredBy\")\n\t\t\t? String(formData.get(\"referredBy\"))\n\t\t\t: null,\n\t\tpreferred_contact_method:\n\t\t\tString(formData.get(\"preferredContactMethod\")) || \"email\",\n\t\tpreferred_technician: formData.get(\"preferredTechnician\")\n\t\t\t? String(formData.get(\"preferredTechnician\"))\n\t\t\t: null,\n\t\tbilling_email: formData.get(\"billingEmail\")\n\t\t\t? String(formData.get(\"billingEmail\"))\n\t\t\t: null,\n\t\tpayment_terms: String(formData.get(\"paymentTerms\")) || \"due_on_receipt\",\n\t\tcredit_limit: formData.get(\"creditLimit\")\n\t\t\t? Number(formData.get(\"creditLimit\")) * CENTS_PER_DOLLAR\n\t\t\t: 0,\n\t\ttax_exempt: formData.get(\"taxExempt\") === \"on\",\n\t\ttax_exempt_number: formData.get(\"taxExemptNumber\")\n\t\t\t? String(formData.get(\"taxExemptNumber\"))\n\t\t\t: null,\n\t\ttags: tags || null,\n\t\tcommunication_preferences: communicationPreferences,\n\t\tnotes: formData.get(\"notes\") ? String(formData.get(\"notes\")) : null,\n\t\tinternal_notes: formData.get(\"internalNotes\")\n\t\t\t? String(formData.get(\"internalNotes\"))\n\t\t\t: null,\n\t\tmetadata: customerMetadata,\n\t\tstatus: \"active\",\n\t\tportal_enabled: false,\n\t\ttotal_revenue: 0,\n\t\ttotal_jobs: 0,\n\t\ttotal_invoices: 0,\n\t\taverage_job_value: 0,\n\t\toutstanding_balance: 0,\n\t};\n}\n\nasync function insertAdditionalPropertiesIfAny(\n\tsupabase: NonNullable<Awaited<ReturnType<typeof createClient>>>,\n\tcompanyId: string,\n\tcustomerId: string,\n\tproperties: ParsedCustomerProperty[],\n) {\n\tconst additionalProperties = properties.filter((p) => !p.isPrimary);\n\tif (additionalProperties.length === 0) {\n\t\treturn;\n\t}\n\n\tconst propertiesToInsert = await Promise.all(\n\t\tadditionalProperties.map(async (prop) => {\n\t\t\tlet propLat: number | null = null;\n\t\t\tlet propLon: number | null = null;\n\n\t\t\tif (prop.address && prop.city && prop.state && prop.zipCode) {\n\t\t\t\tconst geocodeResult = await geocodeAddressSilent(\n\t\t\t\t\tprop.address,\n\t\t\t\t\tprop.city,\n\t\t\t\t\tprop.state,\n\t\t\t\t\tprop.zipCode,\n\t\t\t\t\tprop.country || \"USA\",\n\t\t\t\t);\n\n\t\t\t\tif (geocodeResult) {\n\t\t\t\t\tpropLat = geocodeResult.lat;\n\t\t\t\t\tpropLon = geocodeResult.lon;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: customerId,\n\t\t\t\tname: prop.name || \"Additional Property\",\n\t\t\t\taddress: prop.address,\n\t\t\t\taddress2: prop.address2 || null,\n\t\t\t\tcity: prop.city,\n\t\t\t\tstate: prop.state,\n\t\t\t\tzip_code: prop.zipCode,\n\t\t\t\tcountry: prop.country || \"USA\",\n\t\t\t\tproperty_type: prop.propertyType || \"residential\",\n\t\t\t\tnotes: prop.notes || null,\n\t\t\t\tlat: propLat,\n\t\t\t\tlon: propLon,\n\t\t\t};\n\t\t}),\n\t);\n\n\tawait supabase.from(\"properties\").insert(propertiesToInsert);\n}\n\n/**\n * Update existing customer\n */\nasync function updateCustomer(\n\tcustomerId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id, email\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Parse tags if provided\n\t\tlet tags: string[] | undefined;\n\t\tconst tagsString = formData.get(\"tags\");\n\t\tif (tagsString && typeof tagsString === \"string\") {\n\t\t\ttry {\n\t\t\t\ttags = JSON.parse(tagsString);\n\t\t\t} catch {\n\t\t\t\ttags = tagsString.split(\",\").map((t) => t.trim());\n\t\t\t}\n\t\t}\n\n\t\t// Validate input\n\t\tconst data = customerSchema.parse({\n\t\t\ttype: formData.get(\"type\") || \"residential\",\n\t\t\tfirstName: formData.get(\"firstName\"),\n\t\t\tlastName: formData.get(\"lastName\"),\n\t\t\tcompanyName: formData.get(\"companyName\") || undefined,\n\t\t\temail: formData.get(\"email\"),\n\t\t\tphone: formData.get(\"phone\"),\n\t\t\tsecondaryPhone: formData.get(\"secondaryPhone\") || undefined,\n\t\t\taddress: formData.get(\"address\") || undefined,\n\t\t\taddress2: formData.get(\"address2\") || undefined,\n\t\t\tcity: formData.get(\"city\") || undefined,\n\t\t\tstate: formData.get(\"state\") || undefined,\n\t\t\tzipCode: formData.get(\"zipCode\") || undefined,\n\t\t\tcountry: formData.get(\"country\") || \"USA\",\n\t\t\tsource: formData.get(\"source\") || undefined,\n\t\t\treferredBy: formData.get(\"referredBy\") || null,\n\t\t\tpreferredContactMethod: formData.get(\"preferredContactMethod\") || \"email\",\n\t\t\tpreferredTechnician: formData.get(\"preferredTechnician\") || null,\n\t\t\tbillingEmail: formData.get(\"billingEmail\") || null,\n\t\t\tpaymentTerms: formData.get(\"paymentTerms\") || \"due_on_receipt\",\n\t\t\tcreditLimit: formData.get(\"creditLimit\")\n\t\t\t\t? Number(formData.get(\"creditLimit\"))\n\t\t\t\t: 0,\n\t\t\ttaxExempt: formData.get(\"taxExempt\") === \"true\",\n\t\t\ttaxExemptNumber: formData.get(\"taxExemptNumber\") || undefined,\n\t\t\ttags,\n\t\t\tnotes: formData.get(\"notes\") || undefined,\n\t\t\tinternalNotes: formData.get(\"internalNotes\") || undefined,\n\t\t});\n\n\t\t// Check if email already exists (excluding current customer)\n\t\tif (data.email !== customer.email) {\n\t\t\tconst { data: existingEmail } = await supabase\n\t\t\t\t.from(\"customers\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t\t.eq(\"email\", data.email)\n\t\t\t\t.neq(\"id\", customerId)\n\t\t\t\t.is(\"deleted_at\", null)\n\t\t\t\t.single();\n\n\t\t\tif (existingEmail) {\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\t\"A customer with this email already exists\",\n\t\t\t\t\tERROR_CODES.DB_DUPLICATE_ENTRY,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Generate display name\n\t\tconst displayName =\n\t\t\tdata.type === \"commercial\" && data.companyName\n\t\t\t\t? data.companyName\n\t\t\t\t: `${data.firstName} ${data.lastName}`;\n\n\t\tconst companyName = data.companyName ? String(data.companyName) : null;\n\n\t\t// Update customer\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({\n\t\t\t\ttype: data.type,\n\t\t\t\tfirst_name: data.firstName,\n\t\t\t\tlast_name: data.lastName,\n\t\t\t\tcompany_name: companyName,\n\t\t\t\tdisplay_name: displayName,\n\t\t\t\temail: data.email,\n\t\t\t\tphone: data.phone,\n\t\t\t\tsecondary_phone: data.secondaryPhone,\n\t\t\t\taddress: data.address,\n\t\t\t\taddress2: data.address2,\n\t\t\t\tcity: data.city,\n\t\t\t\tstate: data.state,\n\t\t\t\tzip_code: data.zipCode,\n\t\t\t\tcountry: data.country,\n\t\t\t\tsource: data.source,\n\t\t\t\treferred_by: data.referredBy,\n\t\t\t\tpreferred_contact_method: data.preferredContactMethod,\n\t\t\t\tpreferred_technician: data.preferredTechnician,\n\t\t\t\tbilling_email: data.billingEmail,\n\t\t\t\tpayment_terms: data.paymentTerms,\n\t\t\t\tcredit_limit: data.creditLimit,\n\t\t\t\ttax_exempt: data.taxExempt,\n\t\t\t\ttax_exempt_number: data.taxExemptNumber,\n\t\t\t\ttags: data.tags,\n\t\t\t\tnotes: data.notes,\n\t\t\t\tinternal_notes: data.internalNotes,\n\t\t\t})\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update customer\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n/**\n * Delete customer (soft delete/archive)\n */\nexport async function deleteCustomer(\n\tcustomerId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id, outstanding_balance\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Prevent deletion if customer has outstanding balance\n\t\tif (customer.outstanding_balance > 0) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Cannot delete customer with outstanding balance. Collect payment first.\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Soft delete\n\t\tconst { error: deleteError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: user.id,\n\t\t\t\tstatus: \"archived\",\n\t\t\t})\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (deleteError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"delete customer\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t});\n}\n\n// ============================================================================\n// CUSTOMER STATUS & PREFERENCES\n// ============================================================================\n\n/**\n * Update customer status\n */\nasync function updateCustomerStatus(\n\tcustomerId: string,\n\tstatus: \"active\" | \"inactive\" | \"archived\" | \"blocked\",\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Update status\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({ status })\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update customer status\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n/**\n * Update communication preferences\n */\nasync function updateCommunicationPreferences(\n\tcustomerId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Validate input\n\t\tconst preferences = communicationPreferencesSchema.parse({\n\t\t\temail: formData.get(\"email\") === \"true\",\n\t\t\tsms: formData.get(\"sms\") === \"true\",\n\t\t\tphone: formData.get(\"phone\") === \"true\",\n\t\t\tmarketing: formData.get(\"marketing\") === \"true\",\n\t\t});\n\n\t\t// Update preferences\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({ communication_preferences: preferences })\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update communication preferences\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n// ============================================================================\n// CUSTOMER PORTAL\n// ============================================================================\n\n/**\n * Invite customer to portal\n * Sends an email with a secure token-based invitation link.\n */\nasync function inviteToPortal(\n\tcustomerId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id, email, display_name, portal_enabled\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\tif (customer.portal_enabled) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer is already invited to portal\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Generate secure portal invitation token\n\t\tconst inviteToken = Buffer.from(\n\t\t\t`${customerId}:${Date.now()}:${Math.random()}`,\n\t\t).toString(\"base64url\");\n\n\t\t// Update customer\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({\n\t\t\t\tportal_enabled: true,\n\t\t\t\tportal_invited_at: new Date().toISOString(),\n\t\t\t})\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"invite customer to portal\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Send invitation email\n\t\tconst siteUrl = requireSiteUrl();\n\t\tconst portalUrl = `${siteUrl}/portal/setup?token=${inviteToken}`;\n\n\t\tconst emailResult = await sendEmail({\n\t\t\tto: customer.email,\n\t\t\tsubject: \"You've been invited to your Customer Portal\",\n\t\t\ttemplate: PortalInvitationEmail({\n\t\t\t\tcustomerName: customer.display_name,\n\t\t\t\tportalUrl,\n\t\t\t\texpiresInHours: 168, // 7 days\n\t\t\t\tsupportEmail: process.env.RESEND_FROM_EMAIL || \"support@thorbis.com\",\n\t\t\t\tsupportPhone: \"(555) 123-4567\",\n\t\t\t}),\n\t\t\ttemplateType: EmailTemplate.PORTAL_INVITATION,\n\t\t});\n\n\t\tif (!emailResult.success) {\n\t\t\treturn;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n/**\n * Revoke portal access\n */\nasync function revokePortalAccess(\n\tcustomerId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst teamMember = await requireCustomerCompanyMembership(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t);\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Customer not found\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Revoke access\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({ portal_enabled: false })\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"revoke portal access\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/customers\");\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n\n// ============================================================================\n// SEARCH & REPORTING\n// ============================================================================\n\n/**\n * Get customer by phone number\n * Used for incoming call lookups\n */\nexport async function getCustomerByPhone(\n\tphoneNumber: string,\n\tcompanyId: string,\n): Promise<ActionResult<unknown>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Normalize phone number (remove formatting)\n\t\tconst normalizedPhone = phoneNumber.replace(/\\D/g, \"\");\n\n\t\t// Search by primary phone or secondary phone\n\t\tconst { data: customer, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        properties:properties(*)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.or(\n\t\t\t\t`phone.eq.${phoneNumber},phone.eq.${normalizedPhone},secondary_phone.eq.${phoneNumber},secondary_phone.eq.${normalizedPhone}`,\n\t\t\t)\n\t\t\t.single();\n\n\t\tif (error && error.code !== \"PGRST116\") {\n\t\t\t// PGRST116 = no rows found\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to find customer: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn customer || null;\n\t});\n}\n\n/**\n * Search customers by name, email, phone, or company\n */\nexport async function searchCustomers(\n\tsearchTerm: string,\n\toptions?: { limit?: number; offset?: number },\n): Promise<ActionResult<unknown[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Use the active company ID helper (same as getAllCustomers)\n\t\tconst activeCompanyId = await getActiveCompanyId();\n\t\tif (!activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"No active company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Verify user has access to the active company\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.maybeSingle();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You don't have access to this company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Use full-text search with ranking for best matches\n\t\t// Searches across: first_name, last_name, display_name, email, phone,\n\t\t// secondary_phone, company_name, address, city, state\n\t\t// Returns results ordered by relevance (weighted: name > contact > address)\n\t\tconst { searchCustomersFullText } = await import(\n\t\t\t\"@/lib/search/full-text-search\"\n\t\t);\n\n\t\tconst customers = await searchCustomersFullText(\n\t\t\tsupabase,\n\t\t\tactiveCompanyId,\n\t\t\tsearchTerm,\n\t\t\t{\n\t\t\t\tlimit: options?.limit || DEFAULT_SEARCH_LIMIT,\n\t\t\t\toffset: options?.offset || 0,\n\t\t\t},\n\t\t);\n\n\t\treturn customers;\n\t});\n}\n\n/**\n * Get top customers by revenue\n */\nasync function getTopCustomers(\n\tlimit = 10,\n): Promise<ActionResult<unknown[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\tconst { data: customers, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"total_revenue\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch top customers\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn customers || [];\n\t});\n}\n\n/**\n * Get customers with outstanding balance\n */\ntype CustomerWithBalance = {\n\tid: string;\n\tdisplay_name: string;\n\tbalance: number;\n};\n\nasync function getCustomersWithBalance(): Promise<\n\tActionResult<CustomerWithBalance[]>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\tconst { data: customers, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.gt(\"outstanding_balance\", 0)\n\t\t\t.order(\"outstanding_balance\", { ascending: false })\n\t\t\t.limit(100);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch customers with balance\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn customers || [];\n\t});\n}\n\ntype CustomerRecord = {\n\tid: string;\n\tcompany_id: string;\n\ttype: string;\n\tfirst_name: string;\n\tlast_name: string;\n\tdisplay_name: string;\n\tcompany_name?: string | null;\n\temail: string;\n\tphone: string;\n\tsecondary_phone?: string;\n\taddress?: string;\n\taddress2?: string;\n\tcity?: string;\n\tstate?: string;\n\tzip_code?: string;\n\tstatus: string;\n\ttotal_revenue?: number;\n\ttotal_jobs?: number;\n\ttotal_invoices?: number;\n\toutstanding_balance?: number;\n\tlast_job_date?: string;\n\tnext_scheduled_job?: string;\n\tcreated_at: string;\n\tupdated_at: string;\n\tarchived_at?: string | null;\n\tdeleted_at?: string | null;\n};\n\n/**\n * Get customers for phone dialer (lightweight, no enrichment)\n *\n * PERFORMANCE: Returns only basic contact info needed for dialer.\n * Use this instead of getAllCustomers() in AppHeader to avoid N+1 queries.\n *\n * Expected: 50-100ms (single query)\n * vs getAllCustomers(): 1200-2000ms (151 queries with enrichment)\n */\nexport async function getCustomersForDialer(): Promise<\n\tActionResult<\n\t\tArray<{\n\t\t\tid: string;\n\t\t\tfirst_name: string | null;\n\t\t\tlast_name: string | null;\n\t\t\tdisplay_name: string | null;\n\t\t\temail: string | null;\n\t\t\tphone: string | null;\n\t\t\tsecondary_phone?: string | null;\n\t\t\tcompany_name: string | null;\n\t\t\taddress: string | null;\n\t\t\taddress2: string | null;\n\t\t\tcity: string | null;\n\t\t\tstate: string | null;\n\t\t\tzip_code: string | null;\n\t\t}>\n\t>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst activeCompanyId = await getActiveCompanyId();\n\t\tif (!activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"No active company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Single lightweight query - no joins, no enrichment\n\t\tconst { data: customers, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\n\t\t\t\t\"id, first_name, last_name, display_name, email, phone, secondary_phone, company_name, address, address2, city, state, zip_code\",\n\t\t\t)\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"display_name\", { ascending: true });\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch customers\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn customers || [];\n\t});\n}\n\n/**\n * Get all customers for the current company (WITH ENRICHMENT)\n *\n * WARNING: This function does 151 database queries for 50 customers (N+1 pattern).\n * Expected time: 1200-2000ms\n *\n * DO NOT use in AppHeader or other frequently rendered components.\n * Use getCustomersForDialer() instead for lightweight contact info.\n *\n * Only use this on dedicated customer list pages where the enriched data is needed.\n */\nasync function getAllCustomers(): Promise<\n\tActionResult<CustomerRecord[]>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID (from cookie or first available)\n\t\tconst activeCompanyId = await getActiveCompanyId();\n\n\t\tconst FORBIDDEN_STATUS_CODE = 403;\n\t\tif (!activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tFORBIDDEN_STATUS_CODE,\n\t\t\t);\n\t\t}\n\n\t\t// Verify user has access to the active company\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.maybeSingle();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You don't have access to this company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tFORBIDDEN_STATUS_CODE,\n\t\t\t);\n\t\t}\n\n\t\tconst { data: customers, error } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"display_name\", { ascending: true });\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch customers\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// PERFORMANCE OPTIMIZED: Use RPC function instead of N+1 queries\n\t\t// BEFORE: 151 queries for 50 customers (1 base + 50  3 queries each)\n\t\t// AFTER: 1 RPC call with efficient LATERAL joins\n\t\t// Performance gain: 5-10 seconds faster\n\n\t\t// Note: customers variable contains the base customer data from above query\n\t\t// We replace the enrichment logic with a single RPC call\n\t\tconst { data: enrichedData, error: enrichError } = await supabase.rpc(\n\t\t\t\"get_enriched_customers_rpc\",\n\t\t\t{\n\t\t\t\tp_company_id: activeCompanyId,\n\t\t\t},\n\t\t);\n\n\t\tif (enrichError) {\n\t\t\t// Fallback to base customers if enrichment fails\n\t\t\tconsole.error(\"Failed to enrich customers:\", enrichError);\n\t\t\treturn customers as CustomerRecord[];\n\t\t}\n\n\t\t// Merge enriched data with base customer data\n\t\tconst enrichedCustomers = (enrichedData || []).map((customer: any) => ({\n\t\t\t...customer,\n\t\t\t// Override total_jobs and total_revenue with fresh aggregated values\n\t\t\ttotal_jobs: customer.enriched_total_jobs || customer.total_jobs || 0,\n\t\t\ttotal_revenue:\n\t\t\t\tcustomer.enriched_total_revenue || customer.total_revenue || 0,\n\t\t}));\n\n\t\treturn enrichedCustomers as CustomerRecord[];\n\t});\n}\n\n/**\n * Update customer page content (Novel/Tiptap JSON)\n *\n * Saves the customer's editable page layout and content\n * Used by the Novel editor for auto-save functionality\n */\nasync function updateCustomerPageContent(\n\tcustomerId: string,\n\tpageContent: Record<string, unknown>,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\tif (customer.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"customer\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\tHTTP_STATUS_FORBIDDEN,\n\t\t\t);\n\t\t}\n\n\t\t// Update page content\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.update({\n\t\t\t\tpage_content: pageContent,\n\t\t\t\tcontent_updated_by: user.id,\n\t\t\t})\n\t\t\t.eq(\"id\", customerId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update customer page\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(`/dashboard/customers/${customerId}`);\n\t});\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7751, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/app/api/dialer/customers/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { getCustomersForDialer } from \"@/actions/customers\";\n\nexport async function GET() {\n\ttry {\n\t\tconst result = await getCustomersForDialer();\n\t\tif (!result.success || !result.data) {\n\t\t\treturn NextResponse.json(\n\t\t\t\t{ error: result.error ?? \"Failed to load customers\" },\n\t\t\t\t{ status: 500 },\n\t\t\t);\n\t\t}\n\n\t\treturn NextResponse.json({ customers: result.data });\n\t} catch (error) {\n\t\treturn NextResponse.json(\n\t\t\t{\n\t\t\t\terror:\n\t\t\t\t\terror instanceof Error ? error.message : \"Failed to load customers\",\n\t\t\t},\n\t\t\t{ status: 500 },\n\t\t);\n\t}\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEO,eAAe;IACrB,IAAI;QACH,MAAM,SAAS,MAAM,IAAA,qKAAqB;QAC1C,IAAI,CAAC,OAAO,OAAO,IAAI,CAAC,OAAO,IAAI,EAAE;YACpC,OAAO,uTAAY,CAAC,IAAI,CACvB;gBAAE,OAAO,OAAO,KAAK,IAAI;YAA2B,GACpD;gBAAE,QAAQ;YAAI;QAEhB;QAEA,OAAO,uTAAY,CAAC,IAAI,CAAC;YAAE,WAAW,OAAO,IAAI;QAAC;IACnD,EAAE,OAAO,OAAO;QACf,OAAO,uTAAY,CAAC,IAAI,CACvB;YACC,OACC,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C,GACA;YAAE,QAAQ;QAAI;IAEhB;AACD"}}]
}