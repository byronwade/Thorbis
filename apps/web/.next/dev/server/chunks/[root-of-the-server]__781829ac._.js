module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[project]/packages/database/src/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$ssr$40$0$2e$7$2e$0_$40$supabase$2b$supabase$2d$js$40$2$2e$81$2e$0$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@supabase+ssr@0.7.0_@supabase+supabase-js@2.81.0/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$ssr$40$0$2e$7$2e$0_$40$supabase$2b$supabase$2d$js$40$2$2e$81$2e$0$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@supabase+ssr@0.7.0_@supabase+supabase-js@2.81.0/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react.js [app-route] (ecmascript)");
;
;
const createClient = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cache"])(async ()=>{
    const supabaseUrl = ("TURBOPACK compile-time value", "https://togejqdwggezkxahomeh.supabase.co");
    const supabaseAnonKey = ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvZ2VqcWR3Z2dlemt4YWhvbWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3MjAyOTUsImV4cCI6MjA3NzI5NjI5NX0.a74QOxiIcxeALZsTsNXNDiOls1MZDsFfyGFq992eBBM");
    if ("TURBOPACK compile-time falsy", 0) //TURBOPACK unreachable
    ;
    // Dynamic import of next/headers to prevent bundling in client components
    const { cookies, headers } = await __turbopack_context__.A("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/headers.js [app-route] (ecmascript, async loader)");
    let cookieStore;
    // Check if we're in a prerendering context by looking at headers
    let headersStore;
    try {
        headersStore = await headers();
        // If we can get headers and there's no x-prerender header, we might be safe
        if (headersStore.get('x-prerender')) {
            return null;
        }
    } catch  {
        // If headers() fails, we're likely in prerendering
        return null;
    }
    try {
        cookieStore = await cookies();
    } catch (error) {
        // During prerendering, cookies() may reject - return null
        // This allows PPR to work correctly
        if (error instanceof Error && (error.message.includes("During prerendering") || error.message.includes("prerendering") || error.message.includes("cookies()"))) {
            return null;
        }
        // For other errors, rethrow
        throw error;
    }
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$ssr$40$0$2e$7$2e$0_$40$supabase$2b$supabase$2d$js$40$2$2e$81$2e$0$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(supabaseUrl, supabaseAnonKey, {
        cookies: {
            get (name) {
                return cookieStore.get(name)?.value;
            },
            set (name, value, options) {
                try {
                    cookieStore.set(name, value, options);
                } catch  {
                // The `set` method was called from a Server Component.
                // This can be ignored if you have middleware refreshing
                // user sessions.
                }
            },
            remove (name, _options) {
                try {
                    cookieStore.delete(name);
                } catch  {
                // The `delete` method was called from a Server Component.
                // This can be ignored if you have middleware refreshing
                // user sessions.
                }
            }
        }
    });
});
}),
"[project]/packages/database/src/service-client.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/* __next_internal_action_entry_do_not_use__ [{"0065abb4e4ef4b97e2016c1b54c8d9b3a9ff7b955e":"createServiceSupabaseClient"},"",""] */ __turbopack_context__.s([
    "createServiceSupabaseClient",
    ()=>createServiceSupabaseClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/server-reference.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$supabase$2d$js$40$2$2e$81$2e$0$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@supabase+supabase-js@2.81.0/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/action-validate.js [app-route] (ecmascript)");
;
;
async function createServiceSupabaseClient() {
    // Prefer pooler URL for Transaction Mode (better performance)
    const supabaseUrl = process.env.SUPABASE_POOLER_URL || ("TURBOPACK compile-time value", "https://togejqdwggezkxahomeh.supabase.co");
    const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
    if (!supabaseUrl || !serviceRoleKey) {
        return null;
    }
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$supabase$2d$js$40$2$2e$81$2e$0$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(supabaseUrl, serviceRoleKey, {
        auth: {
            persistSession: false,
            autoRefreshToken: false
        },
        db: {
            schema: "public"
        },
        global: {
            headers: {
                "x-my-custom-header": "service-role"
            }
        }
    });
}
;
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ensureServerEntryExports"])([
    createServiceSupabaseClient
]);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(createServiceSupabaseClient, "0065abb4e4ef4b97e2016c1b54c8d9b3a9ff7b955e", null);
}),
"[project]/packages/shared/src/onboarding.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Utilities for determining onboarding completion across server components
 * and API routes. Keeps the logic centralized so we can evolve the rules
 * (e.g. adding new steps) without hunting down scattered checks.
 */ __turbopack_context__.s([
    "getCurrentOnboardingStep",
    ()=>getCurrentOnboardingStep,
    "getMissingRequiredSteps",
    ()=>getMissingRequiredSteps,
    "getOnboardingProgress",
    ()=>getOnboardingProgress,
    "isOnboardingComplete",
    ()=>isOnboardingComplete
]);
// Must match STEPS_ORDER from onboarding-store.ts
const REQUIRED_STEPS = [
    "welcome",
    "company"
];
const FINAL_STEP = "complete";
function isOnboardingComplete(options) {
    const { progress, completedAt } = options;
    // Primary check: completedAt timestamp from database
    if (completedAt) {
        return true;
    }
    if (!progress || typeof progress !== "object") {
        return false;
    }
    const progressRecord = progress;
    // Check onboardingCompleted flag
    if (progressRecord.onboardingCompleted === true) {
        return true;
    }
    // Check if completedSteps array includes the final step
    const completedSteps = progressRecord.completedSteps;
    if (Array.isArray(completedSteps) && completedSteps.includes(FINAL_STEP)) {
        return true;
    }
    return false;
}
function getOnboardingProgress(options) {
    const { progress } = options;
    if (!progress || typeof progress !== "object") {
        return 0;
    }
    const progressRecord = progress;
    const completedSteps = progressRecord.completedSteps;
    const skippedSteps = progressRecord.skippedSteps;
    if (!Array.isArray(completedSteps)) {
        return 0;
    }
    const totalSteps = 14; // Total steps in onboarding
    const finishedCount = completedSteps.length + (Array.isArray(skippedSteps) ? skippedSteps.length : 0);
    return Math.round(finishedCount / totalSteps * 100);
}
function getMissingRequiredSteps(options) {
    const { progress } = options;
    if (!progress || typeof progress !== "object") {
        return [
            ...REQUIRED_STEPS
        ];
    }
    const progressRecord = progress;
    const completedSteps = progressRecord.completedSteps;
    if (!Array.isArray(completedSteps)) {
        return [
            ...REQUIRED_STEPS
        ];
    }
    return REQUIRED_STEPS.filter((step)=>!completedSteps.includes(step));
}
function getCurrentOnboardingStep(options) {
    const { progress } = options;
    if (!progress || typeof progress !== "object") {
        return "welcome";
    }
    const progressRecord = progress;
    const currentStep = progressRecord.currentStep;
    if (typeof currentStep === "string" && currentStep.length > 0) {
        return currentStep;
    }
    return "welcome";
}
}),
"[project]/packages/auth/src/session.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Session Management Utilities - Server Component Helpers
 *
 * Features:
 * - Get current authenticated user
 * - Get current session
 * - Require authentication (throw error if not authenticated)
 * - Check user permissions and roles
 * - Server Component compatible
 */ __turbopack_context__.s([
    "getCurrentUser",
    ()=>getCurrentUser,
    "requireUser",
    ()=>requireUser
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/database/src/server.ts [app-route] (ecmascript)");
;
;
const getCurrentUser = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cache"])(async ()=>{
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            return null;
        }
        // Use getUser() to authenticate with Supabase Auth server
        // This verifies the session is valid and not tampered with
        const { data: { user }, error } = await supabase.auth.getUser();
        // Handle error - could be AuthSessionMissingError or network error
        if (error) {
            // AuthSessionMissingError is expected when user is not authenticated
            // Don't log this as an error, just return null
            if (error.name === "AuthSessionMissingError") {
                return null;
            }
            return null;
        }
        return user;
    } catch (error) {
        // Catch any unexpected errors (network issues, etc.)
        // The error might be thrown instead of returned in some cases
        if (error && typeof error === "object" && "name" in error && error.name === "AuthSessionMissingError") {
            return null;
        }
        return null;
    }
});
/**
 * Get Session - Cached for performance
 *
 * Returns the current session or null if not authenticated.
 * Cached per request to avoid multiple database calls.
 */ const getSession = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cache"])(async ()=>{
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            return null;
        }
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) {
            return null;
        }
        return session;
    } catch (_error) {
        return null;
    }
});
async function requireUser() {
    const user = await getCurrentUser();
    if (!user) {
        throw new Error("Authentication required. Please log in to continue.");
    }
    return user;
}
/**
 * Require Session - Throw error if no session
 *
 * Use this when you need both user and session data (e.g., access token).
 */ async function requireSession() {
    const session = await getSession();
    if (!session) {
        throw new Error("Active session required. Please log in to continue.");
    }
    return session;
}
/**
 * Check if user is authenticated
 *
 * Returns true if user is authenticated, false otherwise.
 * Useful for conditional rendering in Server Components.
 */ async function isAuthenticated() {
    const user = await getCurrentUser();
    return user !== null;
}
/**
 * Get User Metadata
 *
 * Returns user metadata from Supabase Auth.
 * Useful for accessing additional user properties stored in auth.users.
 */ async function getUserMetadata() {
    const user = await getCurrentUser();
    if (!user) {
        return null;
    }
    return user.user_metadata || null;
}
/**
 * Check User Email Verified
 *
 * Returns true if user's email is verified, false otherwise.
 */ async function isEmailVerified() {
    const user = await getCurrentUser();
    if (!user) {
        return false;
    }
    return user.email_confirmed_at !== undefined;
}
/**
 * Get User ID
 *
 * Returns the user's ID or null if not authenticated.
 * Convenient helper for getting just the user ID.
 */ async function getUserId() {
    const user = await getCurrentUser();
    return user?.id || null;
}
/**
 * Get User Email
 *
 * Returns the user's email or null if not authenticated.
 */ async function getUserEmail() {
    const user = await getCurrentUser();
    return user?.email || null;
}
/**
 * Get Access Token
 *
 * Returns the current access token for API calls.
 * Useful for calling external APIs that require authentication.
 */ async function getAccessToken() {
    const session = await getSession();
    return session?.access_token || null;
}
/**
 * Refresh Session
 *
 * Manually refresh the session to get a new access token.
 * Usually not needed as Supabase handles this automatically.
 */ async function refreshSession() {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            return null;
        }
        const { data: { session }, error } = await supabase.auth.refreshSession();
        if (error) {
            return null;
        }
        return session;
    } catch (_error) {
        return null;
    }
}
}),
"[project]/packages/auth/src/company-context.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Company Context Management
 *
 * Handles multi-tenancy by tracking and switching between companies
 * for users who may be members of multiple companies.
 *
 * Features:
 * - Active company stored in HTTP-only cookie
 * - Falls back to first available company
 * - Validates access before switching
 * - Server-side only (no client-side state)
 *
 * PERFORMANCE: All functions wrapped with React.cache() to prevent
 * redundant database queries across components in the same request.
 */ __turbopack_context__.s([
    "clearActiveCompany",
    ()=>clearActiveCompany,
    "getActiveCompany",
    ()=>getActiveCompany,
    "getActiveCompanyId",
    ()=>getActiveCompanyId,
    "getActiveTeamMemberId",
    ()=>getActiveTeamMemberId,
    "getUserCompanies",
    ()=>getUserCompanies,
    "isActiveCompanyOnboardingComplete",
    ()=>isActiveCompanyOnboardingComplete,
    "requireActiveCompany",
    ()=>requireActiveCompany,
    "setActiveCompany",
    ()=>setActiveCompany
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/database/src/server.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/database/src/service-client.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$shared$2f$src$2f$onboarding$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/shared/src/onboarding.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$auth$2f$src$2f$session$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/auth/src/session.ts [app-route] (ecmascript)");
;
;
;
;
;
const ACTIVE_COMPANY_COOKIE = "active_company_id";
const getActiveCompanyId = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cache"])(async ()=>{
    const { cookies } = await __turbopack_context__.A("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/headers.js [app-route] (ecmascript, async loader)");
    let cookieStore;
    try {
        cookieStore = await cookies();
    } catch (error) {
        // During prerendering, cookies() may reject - return null
        // This allows PPR to work correctly
        if (error instanceof Error && (error.message.includes("During prerendering") || error.message.includes("prerendering") || error.message.includes("cookies()"))) {
            return null;
        }
        throw error;
    }
    const activeCompanyId = cookieStore.get(ACTIVE_COMPANY_COOKIE)?.value;
    if (activeCompanyId) {
        // Verify user still has access to this company
        const hasAccess = await verifyCompanyAccess(activeCompanyId);
        if (hasAccess) {
            return activeCompanyId;
        }
    }
    // Fall back to first available company
    const companies = await getUserCompanies();
    return companies[0]?.id || null;
});
const getActiveCompany = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cache"])(async ()=>{
    const companyId = await getActiveCompanyId();
    if (!companyId) {
        return null;
    }
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
    if (!supabase) {
        return null;
    }
    const { data: company } = await supabase.from("companies").select("id, name, logo, phone, email").eq("id", companyId).is("deleted_at", null) // Exclude archived companies
    .single();
    return company;
});
async function setActiveCompany(companyId) {
    // Verify access before switching
    const hasAccess = await verifyCompanyAccess(companyId);
    if (!hasAccess) {
        throw new Error("You don't have access to this company");
    }
    const { cookies } = await __turbopack_context__.A("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/headers.js [app-route] (ecmascript, async loader)");
    const cookieStore = await cookies();
    cookieStore.set(ACTIVE_COMPANY_COOKIE, companyId, {
        httpOnly: true,
        secure: ("TURBOPACK compile-time value", "development") === "production",
        sameSite: "lax",
        maxAge: 60 * 60 * 24 * 30,
        path: "/"
    });
}
async function clearActiveCompany() {
    const { cookies } = await __turbopack_context__.A("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/headers.js [app-route] (ecmascript, async loader)");
    const cookieStore = await cookies();
    cookieStore.delete(ACTIVE_COMPANY_COOKIE);
}
const getUserCompanies = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cache"])(async ()=>{
    const user = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$auth$2f$src$2f$session$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getCurrentUser"])();
    if (!user) {
        return [];
    }
    // Use service role to bypass RLS recursion on JOIN
    // Query is safe: explicitly filtered to user's own records
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    if (!supabase) {
        return [];
    }
    const { data: memberships } = await supabase.from("company_memberships").select(`
      company_id,
      companies!inner (
        id,
        name,
        logo,
        deleted_at,
        onboarding_completed_at
      )
    `).eq("user_id", user.id).eq("status", "active").is("companies.deleted_at", null); // Exclude archived companies
    if (!memberships) {
        return [];
    }
    // Sort companies: prioritize completed onboarding over incomplete
    const sorted = memberships.sort((a, b)=>{
        const aCompleted = !!a.companies.onboarding_completed_at;
        const bCompleted = !!b.companies.onboarding_completed_at;
        // Completed companies first
        if (aCompleted && !bCompleted) return -1;
        if (!aCompleted && bCompleted) return 1;
        // Then by name alphabetically
        return a.companies.name.localeCompare(b.companies.name);
    });
    return sorted.map((m)=>({
            id: m.companies.id,
            name: m.companies.name,
            logo: m.companies.logo
        }));
});
/**
 * Verify Company Access
 *
 * Checks if user has access to a company.
 *
 * @param companyId - Company ID to verify
 * @returns true if user has access, false otherwise
 */ const verifyCompanyAccess = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cache"])(async (companyId)=>{
    const user = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$auth$2f$src$2f$session$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getCurrentUser"])();
    if (!user) {
        return false;
    }
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
    if (!supabase) {
        return false;
    }
    // Parallel queries instead of sequential (saves 20-30ms)
    const [companyResult, memberResult] = await Promise.all([
        // Check if company exists and is not archived
        supabase.from("companies").select("id").eq("id", companyId).is("deleted_at", null).single(),
        // Check if user has active membership
        supabase.from("company_memberships").select("id").eq("user_id", user.id).eq("company_id", companyId).eq("status", "active").single()
    ]);
    // Both must succeed
    return !!(companyResult.data && memberResult.data);
});
const getActiveTeamMemberId = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cache"])(async ()=>{
    const user = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$auth$2f$src$2f$session$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getCurrentUser"])();
    if (!user) {
        return null;
    }
    const companyId = await getActiveCompanyId();
    if (!companyId) {
        return null;
    }
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
    if (!supabase) {
        return null;
    }
    const { data: teamMember } = await supabase.from("team_members").select("id").eq("user_id", user.id).eq("company_id", companyId).eq("status", "active").single();
    return teamMember?.id || null;
});
async function requireActiveCompany() {
    const companyId = await getActiveCompanyId();
    if (!companyId) {
        throw new Error("No active company selected. Please select a company.");
    }
    return companyId;
}
/**
 * Check if User Has Multiple Companies
 *
 * Useful for conditionally showing company switcher UI.
 *
 * @returns true if user has 2+ companies, false otherwise
 */ async function hasMultipleCompanies() {
    const companies = await getUserCompanies();
    return companies.length > 1;
}
async function isActiveCompanyOnboardingComplete() {
    const user = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$auth$2f$src$2f$session$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getCurrentUser"])();
    if (!user) {
        return false;
    }
    const activeCompanyId = await getActiveCompanyId();
    if (!activeCompanyId) {
        return false;
    }
    // Use service role to bypass RLS recursion on JOIN
    // Query is safe: explicitly filtered to user's own record
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    if (!supabase) {
        return false;
    }
    // Check the ACTIVE company's payment status
    const { data: teamMember } = await supabase.from("company_memberships").select("company_id, companies!inner(stripe_subscription_status, onboarding_progress, onboarding_completed_at)").eq("user_id", user.id).eq("company_id", activeCompanyId).eq("status", "active").maybeSingle();
    if (!teamMember) {
        return false;
    }
    const companies = Array.isArray(teamMember.companies) ? teamMember.companies[0] : teamMember.companies;
    const subscriptionStatus = companies?.stripe_subscription_status;
    const subscriptionActive = subscriptionStatus === "active" || subscriptionStatus === "trialing";
    const onboardingProgress = companies?.onboarding_progress || null;
    const onboardingFinished = (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$shared$2f$src$2f$onboarding$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isOnboardingComplete"])({
        progress: onboardingProgress,
        completedAt: companies?.onboarding_completed_at ?? null
    });
    return subscriptionActive && onboardingFinished || ("TURBOPACK compile-time value", "development") === "development";
}
}),
"[project]/apps/web/src/lib/auth/company-context.ts [app-route] (ecmascript) <locals>", ((__turbopack_context__) => {
"use strict";

// Re-export from @stratos/auth package for backwards compatibility
__turbopack_context__.s([]);
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$auth$2f$src$2f$company$2d$context$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/auth/src/company-context.ts [app-route] (ecmascript)");
;
}),
"[externals]/prettier/plugins/html [external] (prettier/plugins/html, esm_import)", ((__turbopack_context__) => {
"use strict";

return __turbopack_context__.a(async (__turbopack_handle_async_dependencies__, __turbopack_async_result__) => { try {

const mod = await __turbopack_context__.y("prettier/plugins/html");

__turbopack_context__.n(mod);
__turbopack_async_result__();
} catch(e) { __turbopack_async_result__(e); } }, true);}),
"[externals]/prettier/standalone [external] (prettier/standalone, esm_import)", ((__turbopack_context__) => {
"use strict";

return __turbopack_context__.a(async (__turbopack_handle_async_dependencies__, __turbopack_async_result__) => { try {

const mod = await __turbopack_context__.y("prettier/standalone");

__turbopack_context__.n(mod);
__turbopack_async_result__();
} catch(e) { __turbopack_async_result__(e); } }, true);}),
"[externals]/node:stream [external] (node:stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:stream", () => require("node:stream"));

module.exports = mod;
}),
"[project]/apps/web/src/lib/email/deliverability-monitor.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/* __next_internal_action_entry_do_not_use__ [{"00c33d6af75b179c3e5fb2a253ea5a10b9f9653dff":"runHealthCheckForAllDomains","407f3abd7521af716b17126cab115727d0f9d2d93c":"getDomainHealth","40872808aec1a4f1b129010a366e6a68870ce0df8d":"processResendWebhookEvent","409c8641fcd4f7b2db25c834d3da962a5bd66b4798":"getCompanyDomainsHealth","40b125991185ef24f09bd02dc43e2aa44f415f71f9":"generateDeliverabilityReport","40c65805cd77cf6cd7eae148fa7901b55f8b6c304b":"recordDeliveryEvent"},"",""] */ __turbopack_context__.s([
    "generateDeliverabilityReport",
    ()=>generateDeliverabilityReport,
    "getCompanyDomainsHealth",
    ()=>getCompanyDomainsHealth,
    "getDomainHealth",
    ()=>getDomainHealth,
    "processResendWebhookEvent",
    ()=>processResendWebhookEvent,
    "recordDeliveryEvent",
    ()=>recordDeliveryEvent,
    "runHealthCheckForAllDomains",
    ()=>runHealthCheckForAllDomains
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/server-reference.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/database/src/service-client.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/action-validate.js [app-route] (ecmascript)");
;
;
async function recordDeliveryEvent(event) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    // Use the database function to update reputation
    const { error } = await supabase.rpc("update_domain_reputation", {
        p_domain_id: event.domainId,
        p_event_type: event.eventType
    });
    if (error) {
        console.error("Error recording delivery event:", error);
        return {
            success: false,
            error: error.message
        };
    }
    return {
        success: true
    };
}
async function processResendWebhookEvent(webhookData) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    // Map Resend event types to our event types
    const eventTypeMap = {
        "email.delivered": "delivered",
        "email.bounced": "bounced",
        "email.complained": "complained",
        "email.opened": "opened",
        "email.clicked": "clicked",
        // Soft bounces might come as delivery_delayed in some providers
        "email.delivery_delayed": "soft_bounce"
    };
    const eventType = eventTypeMap[webhookData.type];
    if (!eventType) {
        // Not a delivery event we track
        return {
            success: true
        };
    }
    // Extract domain from the "from" address
    const fromEmail = webhookData.data.from;
    if (!fromEmail) {
        return {
            success: true
        };
    }
    const domain = fromEmail.includes("@") ? fromEmail.split("@")[1] : fromEmail;
    // Look up the domain in our database
    const { data: domainRecord } = await supabase.from("company_email_domains").select("id").eq("domain_name", domain).maybeSingle();
    if (!domainRecord) {
        // Domain not found in our system
        return {
            success: true
        };
    }
    // Record the event
    return recordDeliveryEvent({
        domainId: domainRecord.id,
        eventType,
        emailId: webhookData.data.email_id,
        metadata: webhookData.data
    });
}
async function getDomainHealth(domainId) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    const { data, error } = await supabase.from("company_email_domains").select("id, domain_name, reputation_score, bounce_rate, total_emails_sent, hard_bounces, soft_bounces, spam_complaints, is_suspended, last_health_check").eq("id", domainId).single();
    if (error || !data) {
        return null;
    }
    const totalEvents = data.total_emails_sent + data.hard_bounces + data.soft_bounces;
    const bounceRate = totalEvents > 0 ? (data.hard_bounces + data.soft_bounces) / totalEvents * 100 : 0;
    const complaintRate = data.total_emails_sent > 0 ? data.spam_complaints / data.total_emails_sent * 100 : 0;
    const deliveryRate = totalEvents > 0 ? data.total_emails_sent / totalEvents * 100 : 100;
    let status = "healthy";
    if (data.is_suspended) {
        status = "suspended";
    } else if (data.reputation_score < 30 || bounceRate > 10 || complaintRate > 0.5) {
        status = "critical";
    } else if (data.reputation_score < 60 || bounceRate > 5 || complaintRate > 0.2) {
        status = "warning";
    }
    return {
        domainId: data.id,
        domain: data.domain_name,
        reputationScore: Number(data.reputation_score),
        bounceRate: Number(bounceRate.toFixed(2)),
        complaintRate: Number(complaintRate.toFixed(3)),
        deliveryRate: Number(deliveryRate.toFixed(2)),
        status,
        totalEmailsSent: data.total_emails_sent,
        hardBounces: data.hard_bounces,
        softBounces: data.soft_bounces,
        complaints: data.spam_complaints,
        lastHealthCheck: data.last_health_check
    };
}
async function getCompanyDomainsHealth(companyId) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    const { data, error } = await supabase.from("company_email_domains").select("id, domain_name, reputation_score, bounce_rate, total_emails_sent, hard_bounces, soft_bounces, spam_complaints, is_suspended, last_health_check").eq("company_id", companyId);
    if (error || !data) {
        return [];
    }
    return data.map((d)=>{
        const totalEvents = d.total_emails_sent + d.hard_bounces + d.soft_bounces;
        const bounceRate = totalEvents > 0 ? (d.hard_bounces + d.soft_bounces) / totalEvents * 100 : 0;
        const complaintRate = d.total_emails_sent > 0 ? d.spam_complaints / d.total_emails_sent * 100 : 0;
        const deliveryRate = totalEvents > 0 ? d.total_emails_sent / totalEvents * 100 : 100;
        let status = "healthy";
        if (d.is_suspended) {
            status = "suspended";
        } else if (d.reputation_score < 30 || bounceRate > 10 || complaintRate > 0.5) {
            status = "critical";
        } else if (d.reputation_score < 60 || bounceRate > 5 || complaintRate > 0.2) {
            status = "warning";
        }
        return {
            domainId: d.id,
            domain: d.domain_name,
            reputationScore: Number(d.reputation_score),
            bounceRate: Number(bounceRate.toFixed(2)),
            complaintRate: Number(complaintRate.toFixed(3)),
            deliveryRate: Number(deliveryRate.toFixed(2)),
            status,
            totalEmailsSent: d.total_emails_sent,
            hardBounces: d.hard_bounces,
            softBounces: d.soft_bounces,
            complaints: d.spam_complaints,
            lastHealthCheck: d.last_health_check
        };
    });
}
async function runHealthCheckForAllDomains() {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    // Get all active domains
    const { data: domains } = await supabase.from("company_email_domains").select("id, reputation_score, hard_bounces, soft_bounces, spam_complaints, total_emails_sent").eq("is_suspended", false);
    if (!domains) {
        return {
            checked: 0,
            suspended: 0,
            warnings: 0
        };
    }
    let suspended = 0;
    let warnings = 0;
    for (const domain of domains){
        const totalEvents = domain.total_emails_sent + domain.hard_bounces + domain.soft_bounces;
        const bounceRate = totalEvents > 100 ? (domain.hard_bounces + domain.soft_bounces) / totalEvents * 100 : 0;
        const complaintRate = domain.total_emails_sent > 100 ? domain.spam_complaints / domain.total_emails_sent * 100 : 0;
        // Auto-suspend if reputation is critical
        if (domain.reputation_score < 20 || bounceRate > 15 || complaintRate > 1) {
            await supabase.from("company_email_domains").update({
                is_suspended: true,
                suspension_reason: `Auto-suspended: Reputation ${domain.reputation_score}, Bounce rate ${bounceRate.toFixed(1)}%, Complaint rate ${complaintRate.toFixed(2)}%`,
                suspended_at: new Date().toISOString(),
                last_health_check: new Date().toISOString()
            }).eq("id", domain.id);
            suspended++;
        } else if (domain.reputation_score < 50 || bounceRate > 8 || complaintRate > 0.3) {
            // Update health check timestamp for warning domains
            await supabase.from("company_email_domains").update({
                last_health_check: new Date().toISOString()
            }).eq("id", domain.id);
            warnings++;
        } else {
            // Healthy, just update timestamp
            await supabase.from("company_email_domains").update({
                last_health_check: new Date().toISOString()
            }).eq("id", domain.id);
        }
    }
    return {
        checked: domains.length,
        suspended,
        warnings
    };
}
async function generateDeliverabilityReport(domainId) {
    const health = await getDomainHealth(domainId);
    if (!health) {
        return null;
    }
    const recommendations = [];
    if (health.bounceRate > 5) {
        recommendations.push("High bounce rate detected. Clean your email list and remove invalid addresses.");
    }
    if (health.complaintRate > 0.1) {
        recommendations.push("Spam complaints detected. Ensure recipients have opted in and make unsubscribe easy.");
    }
    if (health.reputationScore < 70) {
        recommendations.push("Reputation score is below optimal. Reduce sending volume temporarily and focus on engagement.");
    }
    if (health.status === "warning" || health.status === "critical") {
        recommendations.push("Domain health is degraded. Review your email content and sending practices.");
    }
    if (recommendations.length === 0) {
        recommendations.push("Domain health is good. Continue monitoring and maintain current practices.");
    }
    return {
        domain: health.domain,
        period: {
            start: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
            end: new Date().toISOString()
        },
        metrics: {
            totalSent: health.totalEmailsSent,
            delivered: health.totalEmailsSent - health.hardBounces,
            bounced: health.hardBounces + health.softBounces,
            complained: health.complaints,
            deliveryRate: health.deliveryRate,
            bounceRate: health.bounceRate,
            complaintRate: health.complaintRate
        },
        reputation: {
            current: health.reputationScore,
            change: 0,
            status: health.status
        },
        recommendations
    };
}
;
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ensureServerEntryExports"])([
    recordDeliveryEvent,
    processResendWebhookEvent,
    getDomainHealth,
    getCompanyDomainsHealth,
    runHealthCheckForAllDomains,
    generateDeliverabilityReport
]);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(recordDeliveryEvent, "40c65805cd77cf6cd7eae148fa7901b55f8b6c304b", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(processResendWebhookEvent, "40872808aec1a4f1b129010a366e6a68870ce0df8d", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(getDomainHealth, "407f3abd7521af716b17126cab115727d0f9d2d93c", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(getCompanyDomainsHealth, "409c8641fcd4f7b2db25c834d3da962a5bd66b4798", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(runHealthCheckForAllDomains, "00c33d6af75b179c3e5fb2a253ea5a10b9f9653dff", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(generateDeliverabilityReport, "40b125991185ef24f09bd02dc43e2aa44f415f71f9", null);
}),
"[project]/apps/web/src/lib/email/email-types.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Email Types - Type definitions for email templates
 *
 * Features:
 * - Type-safe email data
 * - Template props interfaces
 * - Email send result types
 * - Validation schemas
 */ __turbopack_context__.s([
    "EmailTemplate",
    ()=>EmailTemplate,
    "emailSendSchema",
    ()=>emailSendSchema
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/zod@4.1.12/node_modules/zod/v4/classic/external.js [app-route] (ecmascript) <export * as z>");
;
// Validation Schemas
const emailAddressSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().email("Invalid email address").min(1, "Email is required");
const emailSendSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].object({
    to: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].union([
        emailAddressSchema,
        __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].array(emailAddressSchema)
    ]),
    subject: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().min(1, "Subject is required").max(200),
    replyTo: emailAddressSchema.optional()
});
var EmailTemplate = /*#__PURE__*/ function(EmailTemplate) {
    // Auth
    EmailTemplate["WELCOME"] = "welcome";
    EmailTemplate["EMAIL_VERIFICATION"] = "email-verification";
    EmailTemplate["PASSWORD_RESET"] = "password-reset";
    EmailTemplate["PASSWORD_CHANGED"] = "password-changed";
    EmailTemplate["MAGIC_LINK"] = "magic-link";
    // Jobs
    EmailTemplate["JOB_CONFIRMATION"] = "job-confirmation";
    EmailTemplate["APPOINTMENT_REMINDER"] = "appointment-reminder";
    EmailTemplate["TECH_EN_ROUTE"] = "tech-en-route";
    EmailTemplate["JOB_COMPLETE"] = "job-complete";
    // Billing
    EmailTemplate["INVOICE"] = "invoice";
    EmailTemplate["ESTIMATE"] = "estimate";
    EmailTemplate["INVOICE_SENT"] = "invoice-sent";
    EmailTemplate["PAYMENT_RECEIVED"] = "payment-received";
    EmailTemplate["PAYMENT_REMINDER"] = "payment-reminder";
    EmailTemplate["ESTIMATE_SENT"] = "estimate-sent";
    // Customer
    EmailTemplate["REVIEW_REQUEST"] = "review-request";
    EmailTemplate["SERVICE_REMINDER"] = "service-reminder";
    EmailTemplate["WELCOME_CUSTOMER"] = "welcome-customer";
    EmailTemplate["PORTAL_INVITATION"] = "portal-invitation";
    // Team
    EmailTemplate["TEAM_INVITATION"] = "team-invitation";
    // Onboarding & Verification
    EmailTemplate["VERIFICATION_SUBMITTED"] = "verification-submitted";
    EmailTemplate["VERIFICATION_COMPLETE"] = "verification-complete";
    // Waitlist
    EmailTemplate["WAITLIST_SUBSCRIPTION"] = "waitlist-subscription";
    EmailTemplate["WAITLIST_ADMIN_NOTIFICATION"] = "waitlist-admin-notification";
    // Generic
    EmailTemplate["GENERIC"] = "generic";
    return EmailTemplate;
}({});
}),
"[project]/apps/web/src/lib/email/pre-send-checks.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "addToGlobalBounceList",
    ()=>addToGlobalBounceList,
    "addToSuppressionList",
    ()=>addToSuppressionList,
    "calculateSpamScore",
    ()=>calculateSpamScore,
    "checkDomainWarmup",
    ()=>checkDomainWarmup,
    "checkSuppressionList",
    ()=>checkSuppressionList,
    "getSuppressionList",
    ()=>getSuppressionList,
    "removeFromSuppressionList",
    ()=>removeFromSuppressionList,
    "runPreSendChecks",
    ()=>runPreSendChecks,
    "verifyDomainStatus",
    ()=>verifyDomainStatus
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/database/src/service-client.ts [app-route] (ecmascript)");
;
// Spam trigger words and patterns
const SPAM_TRIGGERS = {
    urgency: [
        "act now",
        "limited time",
        "urgent",
        "immediate",
        "expires",
        "hurry",
        "don't miss",
        "last chance",
        "final notice",
        "deadline"
    ],
    money: [
        "free",
        "$$$",
        "cash",
        "discount",
        "save big",
        "best price",
        "cheap",
        "bargain",
        "bonus",
        "prize",
        "winner",
        "congratulations"
    ],
    suspicious: [
        "click here",
        "click below",
        "buy now",
        "order now",
        "subscribe now",
        "sign up free",
        "no obligation",
        "risk free",
        "100% free",
        "act immediately"
    ],
    formatting: [
        "ALL CAPS WORDS",
        "!!!",
        "???",
        "$$$",
        "***",
        "###"
    ]
};
// Weight multipliers for spam scoring
const SPAM_WEIGHTS = {
    urgency: 2,
    money: 3,
    suspicious: 4,
    formatting: 1.5,
    excessiveLinks: 5,
    noUnsubscribe: 3,
    shortContent: 2,
    imageHeavy: 3
};
async function checkSuppressionList(companyId, recipientEmails) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    const results = new Map();
    // Initialize all as not suppressed
    for (const email of recipientEmails){
        results.set(email.toLowerCase(), {
            suppressed: false
        });
    }
    // Check suppression list
    const { data: suppressions } = await supabase.from("email_suppressions").select("email, reason, created_at").eq("company_id", companyId).in("email", recipientEmails.map((e)=>e.toLowerCase()));
    if (suppressions) {
        for (const suppression of suppressions){
            results.set(suppression.email, {
                suppressed: true,
                reason: suppression.reason,
                suppressedAt: suppression.created_at
            });
        }
    }
    // Also check global hard bounces (cross-company)
    const { data: globalBounces } = await supabase.from("email_global_bounces").select("email, bounce_type, created_at").in("email", recipientEmails.map((e)=>e.toLowerCase())).eq("bounce_type", "hard");
    if (globalBounces) {
        for (const bounce of globalBounces){
            const existing = results.get(bounce.email);
            if (!existing?.suppressed) {
                results.set(bounce.email, {
                    suppressed: true,
                    reason: `Global hard bounce: ${bounce.bounce_type}`,
                    suppressedAt: bounce.created_at
                });
            }
        }
    }
    return results;
}
function calculateSpamScore(subject, htmlContent, textContent, hasUnsubscribeLink) {
    let score = 0;
    const issues = [];
    const fullText = `${subject} ${textContent}`.toLowerCase();
    const htmlLower = htmlContent.toLowerCase();
    // Check spam trigger words
    for (const [category, words] of Object.entries(SPAM_TRIGGERS)){
        const weight = SPAM_WEIGHTS[category] || 1;
        for (const word of words){
            const regex = new RegExp(word.toLowerCase(), "gi");
            const matches = fullText.match(regex);
            if (matches) {
                score += matches.length * weight;
                if (matches.length > 1) {
                    issues.push(`Contains "${word}" ${matches.length} times`);
                }
            }
        }
    }
    // Check for ALL CAPS in subject
    const capsWords = subject.split(" ").filter((w)=>w.length > 3 && w === w.toUpperCase());
    if (capsWords.length > 0) {
        score += capsWords.length * 3;
        issues.push(`Subject contains ${capsWords.length} ALL CAPS words`);
    }
    // Check excessive punctuation
    const exclamations = (subject.match(/!/g) || []).length;
    if (exclamations > 1) {
        score += exclamations * 2;
        issues.push(`Excessive exclamation marks in subject (${exclamations})`);
    }
    // Check link density
    const links = (htmlLower.match(/<a\s/gi) || []).length;
    const wordCount = textContent.split(/\s+/).length;
    if (wordCount > 0 && links / wordCount > 0.1) {
        score += SPAM_WEIGHTS.excessiveLinks;
        issues.push(`High link density (${links} links in ${wordCount} words)`);
    }
    // Check image-to-text ratio
    const images = (htmlLower.match(/<img\s/gi) || []).length;
    if (images > 0 && textContent.length < 200) {
        score += SPAM_WEIGHTS.imageHeavy;
        issues.push("Image-heavy email with little text");
    }
    // Check for unsubscribe link
    if (!hasUnsubscribeLink) {
        score += SPAM_WEIGHTS.noUnsubscribe;
        issues.push("Missing unsubscribe link (required for marketing emails)");
    }
    // Check content length (very short emails look suspicious)
    if (textContent.length < 50) {
        score += SPAM_WEIGHTS.shortContent;
        issues.push("Very short email content");
    }
    // Check for suspicious patterns
    if (htmlLower.includes("display:none") || htmlLower.includes("font-size:0")) {
        score += 10;
        issues.push("Contains hidden text (spam technique)");
    }
    // Check for deceptive link text
    const deceptiveLinkPattern = /<a[^>]*href=["']([^"']+)["'][^>]*>([^<]+)<\/a>/gi;
    let match;
    while((match = deceptiveLinkPattern.exec(htmlContent)) !== null){
        const href = match[1].toLowerCase();
        const text = match[2].toLowerCase();
        if (text.includes("click here") || text.includes("click this") || text.startsWith("http") && !text.includes(new URL(href).hostname)) {
            score += 5;
            issues.push("Contains deceptive or vague link text");
            break;
        }
    }
    return {
        score: Math.min(score, 100),
        issues
    };
}
async function checkDomainWarmup(domainId) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    const { data: domain } = await supabase.from("company_email_domains").select("created_at, emails_sent_today, total_emails_sent, warmup_completed").eq("id", domainId).single();
    if (!domain) {
        return {
            inWarmup: true,
            daysSinceCreation: 0,
            recommendedDailyLimit: 10,
            currentDaySent: 0,
            suggestions: [
                "Domain not found"
            ]
        };
    }
    const createdAt = new Date(domain.created_at);
    const now = new Date();
    const daysSinceCreation = Math.floor((now.getTime() - createdAt.getTime()) / (1000 * 60 * 60 * 24));
    // Warm-up schedule (days -> max emails per day)
    // Gradual increase over 4-6 weeks for best deliverability
    const warmupSchedule = {
        0: 20,
        2: 50,
        4: 100,
        7: 200,
        14: 500,
        21: 1000,
        28: 2500,
        35: 5000,
        42: 10000
    };
    let recommendedLimit = 20;
    for (const [day, limit] of Object.entries(warmupSchedule)){
        if (daysSinceCreation >= parseInt(day)) {
            recommendedLimit = limit;
        }
    }
    const inWarmup = daysSinceCreation < 42 && !domain.warmup_completed;
    const suggestions = [];
    if (inWarmup) {
        suggestions.push(`Domain is in warm-up period (day ${daysSinceCreation}/42). Recommended daily limit: ${recommendedLimit} emails.`);
        if (domain.emails_sent_today >= recommendedLimit * 0.8) {
            suggestions.push("Approaching daily warm-up limit. Consider spreading sends across multiple days.");
        }
    }
    return {
        inWarmup,
        daysSinceCreation,
        recommendedDailyLimit: recommendedLimit,
        currentDaySent: domain.emails_sent_today || 0,
        suggestions
    };
}
async function verifyDomainStatus(domainId) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    const { data: domain } = await supabase.from("company_email_domains").select("status, is_suspended, sending_enabled, spf_verified, dkim_verified, dmarc_verified").eq("id", domainId).single();
    if (!domain) {
        return {
            canSend: false,
            issues: [
                "Domain not found"
            ],
            dnsStatus: {
                spf: false,
                dkim: false,
                dmarc: false
            }
        };
    }
    const issues = [];
    if (domain.status !== "verified") {
        issues.push(`Domain not verified (status: ${domain.status})`);
    }
    if (domain.is_suspended) {
        issues.push("Domain is suspended");
    }
    if (!domain.sending_enabled) {
        issues.push("Sending is disabled for this domain");
    }
    if (!domain.spf_verified) {
        issues.push("SPF record not verified - emails may fail authentication");
    }
    if (!domain.dkim_verified) {
        issues.push("DKIM not verified - emails may fail authentication");
    }
    if (!domain.dmarc_verified) {
        issues.push("DMARC not configured - reduces deliverability");
    }
    return {
        canSend: issues.length === 0,
        issues,
        dnsStatus: {
            spf: domain.spf_verified || false,
            dkim: domain.dkim_verified || false,
            dmarc: domain.dmarc_verified || false
        }
    };
}
async function runPreSendChecks(companyId, domainId, recipientEmails, subject, htmlContent, textContent, isMarketingEmail = false) {
    const warnings = [];
    const errors = [];
    const suggestions = [];
    // 1. Check domain status
    const domainStatus = await verifyDomainStatus(domainId);
    if (!domainStatus.canSend) {
        errors.push(...domainStatus.issues);
    } else {
        // Add warnings for missing DNS records
        if (!domainStatus.dnsStatus.dmarc) {
            warnings.push("DMARC not configured - consider adding for better deliverability");
        }
    }
    // 2. Check suppression list
    const suppressions = await checkSuppressionList(companyId, recipientEmails);
    const recipientStatus = [];
    let suppressedCount = 0;
    for (const [email, status] of suppressions){
        recipientStatus.push({
            email,
            suppressed: status.suppressed,
            reason: status.reason
        });
        if (status.suppressed) {
            suppressedCount++;
        }
    }
    if (suppressedCount > 0) {
        warnings.push(`${suppressedCount} recipient(s) on suppression list and will be skipped`);
    }
    if (suppressedCount === recipientEmails.length) {
        errors.push("All recipients are on suppression list - no emails will be sent");
    }
    // 3. Calculate spam score
    const hasUnsubscribe = htmlContent.includes("unsubscribe") || htmlContent.includes("List-Unsubscribe");
    const spamAnalysis = calculateSpamScore(subject, htmlContent, textContent, hasUnsubscribe || !isMarketingEmail);
    if (spamAnalysis.score >= 60) {
        errors.push(`High spam score (${spamAnalysis.score}/100) - email likely to be filtered`);
        errors.push(...spamAnalysis.issues);
    } else if (spamAnalysis.score >= 30) {
        warnings.push(`Moderate spam score (${spamAnalysis.score}/100) - consider improvements`);
        warnings.push(...spamAnalysis.issues);
    }
    // 4. Check warm-up status
    const warmupStatus = await checkDomainWarmup(domainId);
    if (warmupStatus.inWarmup) {
        suggestions.push(...warmupStatus.suggestions);
        const activeRecipients = recipientEmails.length - suppressedCount;
        const remainingCapacity = warmupStatus.recommendedDailyLimit - warmupStatus.currentDaySent;
        if (activeRecipients > remainingCapacity) {
            warnings.push(`Sending ${activeRecipients} emails exceeds warm-up limit (${remainingCapacity} remaining today). ` + `Consider sending over multiple days.`);
        }
    }
    // 5. Content-specific suggestions
    if (!htmlContent.includes("<!DOCTYPE") && !htmlContent.includes("<html")) {
        suggestions.push("Consider using proper HTML structure with DOCTYPE for better rendering");
    }
    if (textContent.length < 100) {
        suggestions.push("Consider adding more text content - very short emails may look suspicious");
    }
    if (isMarketingEmail && !hasUnsubscribe) {
        errors.push("Marketing emails MUST include an unsubscribe link (CAN-SPAM requirement)");
    }
    // Check for personalization
    if (!htmlContent.includes("{{") && !htmlContent.includes("{name}") && !subject.includes("{{")) {
        suggestions.push("Consider adding personalization (recipient name, company) for better engagement");
    }
    return {
        allowed: errors.length === 0,
        warnings,
        errors,
        suggestions,
        spamScore: spamAnalysis.score,
        recipientStatus
    };
}
async function addToSuppressionList(companyId, email, reason, details) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    const { error } = await supabase.from("email_suppressions").upsert({
        company_id: companyId,
        email: email.toLowerCase(),
        reason,
        details,
        created_at: new Date().toISOString()
    }, {
        onConflict: "company_id,email"
    });
    if (error) {
        console.error("Error adding to suppression list:", error);
        return {
            success: false,
            error: error.message
        };
    }
    return {
        success: true
    };
}
async function addToGlobalBounceList(email, bounceType, bounceReason) {
    // Only track hard bounces globally
    if (bounceType !== "hard") {
        return {
            success: true
        };
    }
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    const { error } = await supabase.from("email_global_bounces").upsert({
        email: email.toLowerCase(),
        bounce_type: bounceType,
        bounce_reason: bounceReason,
        bounce_count: 1,
        last_bounce_at: new Date().toISOString(),
        created_at: new Date().toISOString()
    }, {
        onConflict: "email"
    });
    if (error) {
        console.error("Error adding to global bounce list:", error);
        return {
            success: false,
            error: error.message
        };
    }
    return {
        success: true
    };
}
async function removeFromSuppressionList(companyId, email) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    const { error } = await supabase.from("email_suppressions").delete().eq("company_id", companyId).eq("email", email.toLowerCase());
    if (error) {
        console.error("Error removing from suppression list:", error);
        return {
            success: false,
            error: error.message
        };
    }
    return {
        success: true
    };
}
async function getSuppressionList(companyId, limit = 100, offset = 0) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    const { data, count, error } = await supabase.from("email_suppressions").select("email, reason, details, created_at", {
        count: "exact"
    }).eq("company_id", companyId).order("created_at", {
        ascending: false
    }).range(offset, offset + limit - 1);
    if (error) {
        console.error("Error fetching suppression list:", error);
        return {
            data: [],
            total: 0
        };
    }
    return {
        data: data || [],
        total: count || 0
    };
}
}),
"[project]/apps/web/src/lib/email/rate-limiter.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Email Rate Limiter
 *
 * Implements per-domain rate limiting for email sending to:
 * - Prevent spam/abuse
 * - Protect domain reputation
 * - Enforce plan-based limits
 * - Track daily/hourly email quotas
 */ /* __next_internal_action_entry_do_not_use__ [{"0020a1d15ae77f64582de2c225d74b37bc9b2a8829":"resetHourlyCounters","00465270d3bffebed3c4f6194507dd54b9dddb7ac3":"resetDailyCounters","403e591ad4fb452eef9adfd77242abc86364b2744d":"incrementEmailCounter","4061912faba61aa4780a560a519048767cb9ddc45c":"getCompanyActiveDomain","40eb9b5dc8fc719648117169eca131590fddc21657":"checkRateLimit"},"",""] */ __turbopack_context__.s([
    "checkRateLimit",
    ()=>checkRateLimit,
    "getCompanyActiveDomain",
    ()=>getCompanyActiveDomain,
    "incrementEmailCounter",
    ()=>incrementEmailCounter,
    "resetDailyCounters",
    ()=>resetDailyCounters,
    "resetHourlyCounters",
    ()=>resetHourlyCounters
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/server-reference.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/database/src/service-client.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/action-validate.js [app-route] (ecmascript)");
;
;
// =============================================================================
// RATE LIMIT CONFIGURATION
// =============================================================================
// Default rate limits (can be overridden per domain/plan)
const DEFAULT_LIMITS = {
    daily: 1000,
    hourly: 100,
    perMinute: 10
};
// In-memory cache for rate limit tracking (resets on server restart)
// For production, use Redis or database counters
const rateLimitCache = new Map();
async function getCompanyActiveDomain(companyId) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    // Query for the active sending domain
    const { data: domain, error } = await supabase.from("company_email_domains").select(`
			id,
			domain_name,
			reply_to_email,
			daily_limit,
			hourly_limit,
			emails_sent_today,
			emails_sent_this_hour,
			is_platform_subdomain
		`).eq("company_id", companyId).eq("status", "verified").eq("sending_enabled", true).eq("is_suspended", false).order("is_platform_subdomain", {
        ascending: true
    }) // Custom domains first
    .order("created_at", {
        ascending: false
    }).maybeSingle();
    if (error) {
        console.error("Error fetching company email domain:", error);
        return null;
    }
    if (!domain) {
        return null;
    }
    return {
        domainId: domain.id,
        domain: domain.domain_name,
        replyToEmail: domain.reply_to_email,
        dailyLimit: domain.daily_limit || DEFAULT_LIMITS.daily,
        hourlyLimit: domain.hourly_limit || DEFAULT_LIMITS.hourly,
        emailsSentToday: domain.emails_sent_today || 0,
        emailsSentThisHour: domain.emails_sent_this_hour || 0
    };
}
async function checkRateLimit(domainId) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    // Get current domain stats
    const { data: domain, error } = await supabase.from("company_email_domains").select(`
			daily_limit,
			hourly_limit,
			emails_sent_today,
			emails_sent_this_hour,
			is_suspended,
			daily_limit_reset_at,
			hourly_limit_reset_at
		`).eq("id", domainId).single();
    if (error || !domain) {
        return {
            allowed: false,
            reason: "Domain not found or error fetching limits"
        };
    }
    // Check if domain is suspended
    if (domain.is_suspended) {
        return {
            allowed: false,
            reason: "Domain is suspended due to reputation issues"
        };
    }
    const dailyLimit = domain.daily_limit || DEFAULT_LIMITS.daily;
    const hourlyLimit = domain.hourly_limit || DEFAULT_LIMITS.hourly;
    const emailsSentToday = domain.emails_sent_today || 0;
    const emailsSentThisHour = domain.emails_sent_this_hour || 0;
    // Check daily limit
    if (emailsSentToday >= dailyLimit) {
        return {
            allowed: false,
            reason: `Daily email limit reached (${dailyLimit} emails/day)`,
            remaining: 0,
            resetAt: domain.daily_limit_reset_at || getNextMidnightUTC()
        };
    }
    // Check hourly limit
    if (emailsSentThisHour >= hourlyLimit) {
        return {
            allowed: false,
            reason: `Hourly email limit reached (${hourlyLimit} emails/hour)`,
            remaining: 0,
            resetAt: domain.hourly_limit_reset_at || getNextHourUTC()
        };
    }
    // Check per-minute limit (in-memory)
    const minuteKey = `${domainId}:minute`;
    const minuteWindow = getMinuteWindow();
    const minuteCache = rateLimitCache.get(minuteKey);
    if (minuteCache && minuteCache.windowStart === minuteWindow) {
        if (minuteCache.count >= DEFAULT_LIMITS.perMinute) {
            return {
                allowed: false,
                reason: `Rate limit: Too many emails per minute (${DEFAULT_LIMITS.perMinute}/min)`,
                remaining: 0
            };
        }
    }
    return {
        allowed: true,
        remaining: Math.min(dailyLimit - emailsSentToday, hourlyLimit - emailsSentThisHour)
    };
}
async function incrementEmailCounter(domainId) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    // Use a database function for atomic increment and validation
    // This prevents race conditions in high-concurrency scenarios
    const { data, error } = await supabase.rpc("increment_email_counter", {
        p_domain_id: domainId
    });
    if (error) {
        // If the RPC doesn't exist, fall back to manual increment
        if (error.code === "PGRST202" || error.message.includes("function")) {
            return await incrementEmailCounterFallback(domainId);
        }
        console.error("Error incrementing email counter:", error);
        return {
            allowed: false,
            reason: error.message
        };
    }
    // Handle RPC result
    if (data && typeof data === "object") {
        const result = data;
        return {
            allowed: result.allowed,
            reason: result.reason,
            remaining: result.remaining
        };
    }
    // Default: allowed if no error
    return {
        allowed: true
    };
}
// =============================================================================
// HELPER FUNCTIONS
// =============================================================================
/**
 * Fallback increment method when RPC function doesn't exist
 */ async function incrementEmailCounterFallback(domainId) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    // Get current counts
    const { data: domain, error: fetchError } = await supabase.from("company_email_domains").select("emails_sent_today, emails_sent_this_hour, daily_limit, hourly_limit").eq("id", domainId).single();
    if (fetchError || !domain) {
        return {
            allowed: false,
            reason: "Domain not found"
        };
    }
    const dailyLimit = domain.daily_limit || DEFAULT_LIMITS.daily;
    const hourlyLimit = domain.hourly_limit || DEFAULT_LIMITS.hourly;
    // Check limits before incrementing
    if ((domain.emails_sent_today || 0) >= dailyLimit) {
        return {
            allowed: false,
            reason: "Daily limit reached"
        };
    }
    if ((domain.emails_sent_this_hour || 0) >= hourlyLimit) {
        return {
            allowed: false,
            reason: "Hourly limit reached"
        };
    }
    // Increment counters
    const { error: updateError } = await supabase.from("company_email_domains").update({
        emails_sent_today: (domain.emails_sent_today || 0) + 1,
        emails_sent_this_hour: (domain.emails_sent_this_hour || 0) + 1
    }).eq("id", domainId);
    if (updateError) {
        console.error("Error updating email counters:", updateError);
        return {
            allowed: false,
            reason: updateError.message
        };
    }
    // Update in-memory per-minute counter
    const minuteKey = `${domainId}:minute`;
    const minuteWindow = getMinuteWindow();
    const minuteCache = rateLimitCache.get(minuteKey);
    if (minuteCache && minuteCache.windowStart === minuteWindow) {
        minuteCache.count++;
    } else {
        rateLimitCache.set(minuteKey, {
            count: 1,
            windowStart: minuteWindow
        });
    }
    return {
        allowed: true,
        remaining: Math.min(dailyLimit - (domain.emails_sent_today || 0) - 1, hourlyLimit - (domain.emails_sent_this_hour || 0) - 1)
    };
}
/**
 * Get the current minute window (for per-minute rate limiting)
 */ function getMinuteWindow() {
    return Math.floor(Date.now() / 60000);
}
/**
 * Get the next midnight UTC timestamp
 */ function getNextMidnightUTC() {
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setUTCDate(tomorrow.getUTCDate() + 1);
    tomorrow.setUTCHours(0, 0, 0, 0);
    return tomorrow.toISOString();
}
/**
 * Get the next hour UTC timestamp
 */ function getNextHourUTC() {
    const now = new Date();
    const nextHour = new Date(now);
    nextHour.setUTCHours(nextHour.getUTCHours() + 1, 0, 0, 0);
    return nextHour.toISOString();
}
async function resetDailyCounters() {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    const { error } = await supabase.from("company_email_domains").update({
        emails_sent_today: 0,
        daily_limit_reset_at: getNextMidnightUTC()
    }).neq("id", ""); // Update all rows
    if (error) {
        console.error("Error resetting daily counters:", error);
        return {
            success: false,
            error: error.message
        };
    }
    return {
        success: true
    };
}
async function resetHourlyCounters() {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
    const { error } = await supabase.from("company_email_domains").update({
        emails_sent_this_hour: 0,
        hourly_limit_reset_at: getNextHourUTC()
    }).neq("id", ""); // Update all rows
    if (error) {
        console.error("Error resetting hourly counters:", error);
        return {
            success: false,
            error: error.message
        };
    }
    return {
        success: true
    };
}
;
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ensureServerEntryExports"])([
    getCompanyActiveDomain,
    checkRateLimit,
    incrementEmailCounter,
    resetDailyCounters,
    resetHourlyCounters
]);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(getCompanyActiveDomain, "4061912faba61aa4780a560a519048767cb9ddc45c", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(checkRateLimit, "40eb9b5dc8fc719648117169eca131590fddc21657", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(incrementEmailCounter, "403e591ad4fb452eef9adfd77242abc86364b2744d", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(resetDailyCounters, "00465270d3bffebed3c4f6194507dd54b9dddb7ac3", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(resetHourlyCounters, "0020a1d15ae77f64582de2c225d74b37bc9b2a8829", null);
}),
"[externals]/node:crypto [external] (node:crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:crypto", () => require("node:crypto"));

module.exports = mod;
}),
"[project]/apps/web/src/lib/email/resend-client.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Resend Client - Email Service Configuration
 *
 * Features:
 * - Singleton Resend client instance
 * - Environment-based configuration
 * - Type-safe email sending
 * - Development mode support (logs instead of sending)
 */ __turbopack_context__.s([
    "emailConfig",
    ()=>emailConfig,
    "isResendConfigured",
    ()=>isResendConfigured,
    "resend",
    ()=>resend
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$resend$40$6$2e$4$2e$2_$40$react$2d$email$2b$render$40$1$2e$4$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0_$2f$node_modules$2f$resend$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/resend@6.4.2_@react-email+render@1.4.0_react-dom@19.2.0_react@19.2.0__react@19.2.0_/node_modules/resend/dist/index.mjs [app-route] (ecmascript)");
;
const requiredSiteUrl = ("TURBOPACK compile-time value", "http://localhost:3000");
if ("TURBOPACK compile-time falsy", 0) //TURBOPACK unreachable
;
const resend = process.env.RESEND_API_KEY ? new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$resend$40$6$2e$4$2e$2_$40$react$2d$email$2b$render$40$1$2e$4$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0_$2f$node_modules$2f$resend$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Resend"](process.env.RESEND_API_KEY) : null;
const emailConfig = {
    from: `${process.env.RESEND_FROM_NAME || "Thorbis"} <${process.env.RESEND_FROM_EMAIL || "noreply@thorbis.com"}>`,
    // Enable production mode if RESEND_API_KEY is configured, even in development
    isDevelopment: !process.env.RESEND_API_KEY || ("TURBOPACK compile-time value", "development") === "development" && !process.env.RESEND_API_KEY,
    siteUrl: requiredSiteUrl,
    appUrl: ("TURBOPACK compile-time value", "http://localhost:3000") || requiredSiteUrl
};
function isResendConfigured() {
    if (!resend) {
        return false;
    }
    return true;
}
}),
"[project]/apps/web/src/lib/email/postmark-client.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Postmark Email Client
 *
 * This module provides integration with Postmark as a fallback email provider.
 * Postmark is known for excellent deliverability and is used when Resend fails.
 *
 * Features:
 * - Email sending with automatic retry
 * - Domain/sender signature management
 * - Webhook signature verification
 * - Delivery status tracking
 *
 * Environment Variables Required:
 * - POSTMARK_API_KEY: Your Postmark server API token
 * - POSTMARK_WEBHOOK_SECRET: Secret for verifying webhook signatures (optional)
 *
 * @see https://postmarkapp.com/developer
 */ __turbopack_context__.s([
    "checkPostmarkHealth",
    ()=>checkPostmarkHealth,
    "createPostmarkDomain",
    ()=>createPostmarkDomain,
    "deletePostmarkDomain",
    ()=>deletePostmarkDomain,
    "getPostmarkDNSRecords",
    ()=>getPostmarkDNSRecords,
    "getPostmarkDomain",
    ()=>getPostmarkDomain,
    "getPostmarkServerInfo",
    ()=>getPostmarkServerInfo,
    "isPostmarkConfigured",
    ()=>isPostmarkConfigured,
    "listPostmarkDomains",
    ()=>listPostmarkDomains,
    "postmarkConfig",
    ()=>postmarkConfig,
    "resendPostmarkConfirmation",
    ()=>resendPostmarkConfirmation,
    "sendPostmarkBatchEmails",
    ()=>sendPostmarkBatchEmails,
    "sendPostmarkEmail",
    ()=>sendPostmarkEmail,
    "verifyPostmarkDKIM",
    ()=>verifyPostmarkDKIM,
    "verifyPostmarkReturnPath",
    ()=>verifyPostmarkReturnPath,
    "verifyPostmarkWebhook",
    ()=>verifyPostmarkWebhook
]);
var __TURBOPACK__imported__module__$5b$externals$5d2f$node$3a$crypto__$5b$external$5d$__$28$node$3a$crypto$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/node:crypto [external] (node:crypto, cjs)");
;
// =============================================================================
// CONFIGURATION
// =============================================================================
const POSTMARK_API_BASE = "https://api.postmarkapp.com";
const postmarkConfig = {
    apiKey: process.env.POSTMARK_API_KEY || "",
    webhookSecret: process.env.POSTMARK_WEBHOOK_SECRET || "",
    // Default "from" address for Postmark (must be verified sender signature)
    from: process.env.POSTMARK_FROM_EMAIL || process.env.EMAIL_FROM || "notifications@stratos.app",
    // Is Postmark configured and ready to use?
    isConfigured: !!process.env.POSTMARK_API_KEY,
    // Provider name for logging/monitoring
    providerName: "postmark"
};
// =============================================================================
// API REQUEST HELPER
// =============================================================================
/**
 * Makes authenticated requests to Postmark API
 *
 * @param path - API endpoint path (e.g., "/email")
 * @param init - Fetch request options
 * @returns Typed response with success/error handling
 *
 * @example
 * const result = await postmarkRequest<PostmarkSendResponse>("/email", {
 *   method: "POST",
 *   body: JSON.stringify(emailData),
 * });
 */ async function postmarkRequest(path, init) {
    // Check if Postmark is configured
    if (!postmarkConfig.apiKey) {
        return {
            success: false,
            error: "Postmark API key is not configured. Set POSTMARK_API_KEY environment variable."
        };
    }
    try {
        const response = await fetch(`${POSTMARK_API_BASE}${path}`, {
            ...init,
            headers: {
                // Postmark uses X-Postmark-Server-Token for authentication
                "X-Postmark-Server-Token": postmarkConfig.apiKey,
                "Content-Type": "application/json",
                Accept: "application/json",
                ...init.headers
            }
        });
        // Parse response body
        const body = await response.json().catch(()=>({}));
        // Handle non-OK responses
        if (!response.ok) {
            return {
                success: false,
                error: body.Message || body.message || response.statusText,
                errorCode: body.ErrorCode
            };
        }
        return {
            success: true,
            data: body
        };
    } catch (error) {
        // Network or parsing error
        return {
            success: false,
            error: error instanceof Error ? error.message : "Postmark request failed"
        };
    }
}
async function sendPostmarkEmail(options) {
    const { to, subject, html, text, from = postmarkConfig.from, replyTo, tag, trackOpens = true, trackLinks = true, metadata, messageStream = "outbound" } = options;
    // Postmark requires single recipient per request for /email endpoint
    // For multiple recipients, we'd use /email/batch
    const recipient = Array.isArray(to) ? to.join(", ") : to;
    const request = {
        From: from,
        To: recipient,
        Subject: subject,
        HtmlBody: html,
        TextBody: text,
        ReplyTo: replyTo,
        Tag: tag,
        TrackOpens: trackOpens,
        TrackLinks: trackLinks ? "HtmlAndText" : "None",
        MessageStream: messageStream,
        Metadata: metadata
    };
    // Log send attempt for monitoring
    console.log(`[Postmark] Sending email to ${recipient}, subject: "${subject}"`);
    const result = await postmarkRequest("/email", {
        method: "POST",
        body: JSON.stringify(request)
    });
    // Log result for monitoring
    if (result.success) {
        console.log(`[Postmark] Email sent successfully, MessageID: ${result.data.MessageID}`);
    } else {
        console.error(`[Postmark] Email send failed: ${result.error}`);
    }
    return result;
}
async function sendPostmarkBatchEmails(emails) {
    if (emails.length > 500) {
        return {
            success: false,
            error: "Postmark batch limit is 500 emails per request"
        };
    }
    const requests = emails.map((email)=>({
            From: email.from || postmarkConfig.from,
            To: email.to,
            Subject: email.subject,
            HtmlBody: email.html,
            TextBody: email.text,
            ReplyTo: email.replyTo,
            Tag: email.tag,
            TrackOpens: true,
            TrackLinks: "HtmlAndText",
            Metadata: email.metadata
        }));
    console.log(`[Postmark] Sending batch of ${emails.length} emails`);
    return postmarkRequest("/email/batch", {
        method: "POST",
        body: JSON.stringify(requests)
    });
}
async function listPostmarkDomains() {
    console.log("[Postmark] Listing sender signatures");
    return postmarkRequest("/senders", {
        method: "GET"
    });
}
async function getPostmarkDomain(signatureId) {
    console.log(`[Postmark] Getting sender signature ${signatureId}`);
    return postmarkRequest(`/senders/${signatureId}`, {
        method: "GET"
    });
}
async function createPostmarkDomain(options) {
    const { fromEmail, name, replyToEmail } = options;
    console.log(`[Postmark] Creating sender signature for ${fromEmail}`);
    return postmarkRequest("/senders", {
        method: "POST",
        body: JSON.stringify({
            FromEmail: fromEmail,
            Name: name,
            ReplyToEmail: replyToEmail || fromEmail
        })
    });
}
async function deletePostmarkDomain(signatureId) {
    console.log(`[Postmark] Deleting sender signature ${signatureId}`);
    return postmarkRequest(`/senders/${signatureId}`, {
        method: "DELETE"
    });
}
async function resendPostmarkConfirmation(signatureId) {
    console.log(`[Postmark] Resending confirmation for signature ${signatureId}`);
    return postmarkRequest(`/senders/${signatureId}/resend`, {
        method: "POST"
    });
}
async function verifyPostmarkDKIM(signatureId) {
    console.log(`[Postmark] Verifying DKIM for signature ${signatureId}`);
    return postmarkRequest(`/senders/${signatureId}/verifyDkim`, {
        method: "PUT"
    });
}
async function verifyPostmarkReturnPath(signatureId) {
    console.log(`[Postmark] Verifying Return-Path for signature ${signatureId}`);
    return postmarkRequest(`/senders/${signatureId}/verifyReturnPath`, {
        method: "PUT"
    });
}
async function getPostmarkServerInfo() {
    console.log("[Postmark] Getting server info");
    return postmarkRequest("/server", {
        method: "GET"
    });
}
function verifyPostmarkWebhook(options) {
    const { token } = options;
    // If no secret configured, accept all webhooks (not recommended for production)
    if (!postmarkConfig.webhookSecret) {
        console.warn("[Postmark] No webhook secret configured - accepting webhook without verification");
        return true;
    }
    // Verify the token matches our secret
    if (!token) {
        console.error("[Postmark] Webhook missing token");
        return false;
    }
    // Use timing-safe comparison to prevent timing attacks
    try {
        const expected = Buffer.from(postmarkConfig.webhookSecret);
        const received = Buffer.from(token);
        if (expected.length !== received.length) {
            return false;
        }
        return __TURBOPACK__imported__module__$5b$externals$5d2f$node$3a$crypto__$5b$external$5d$__$28$node$3a$crypto$2c$__cjs$29$__["default"].timingSafeEqual(expected, received);
    } catch  {
        return false;
    }
}
async function checkPostmarkHealth() {
    const startTime = Date.now();
    try {
        const result = await getPostmarkServerInfo();
        const latencyMs = Date.now() - startTime;
        if (result.success) {
            console.log(`[Postmark] Health check passed in ${latencyMs}ms`);
            return {
                healthy: true,
                provider: "postmark",
                latencyMs
            };
        }
        console.error(`[Postmark] Health check failed: ${result.error}`);
        return {
            healthy: false,
            provider: "postmark",
            latencyMs,
            error: result.error
        };
    } catch (error) {
        const latencyMs = Date.now() - startTime;
        const errorMessage = error instanceof Error ? error.message : "Unknown error";
        console.error(`[Postmark] Health check error: ${errorMessage}`);
        return {
            healthy: false,
            provider: "postmark",
            latencyMs,
            error: errorMessage
        };
    }
}
function isPostmarkConfigured() {
    return postmarkConfig.isConfigured;
}
function getPostmarkDNSRecords(domain) {
    const records = [];
    // DKIM record
    if (domain.DKIMHost && domain.DKIMTextValue) {
        records.push({
            type: "TXT",
            name: domain.DKIMHost,
            value: domain.DKIMTextValue,
            verified: domain.DKIMVerified
        });
    }
    // Return-Path CNAME
    if (domain.ReturnPathDomain && domain.ReturnPathDomainCNAMEValue) {
        records.push({
            type: "CNAME",
            name: domain.ReturnPathDomain,
            value: domain.ReturnPathDomainCNAMEValue,
            verified: domain.ReturnPathDomainVerified
        });
    }
    return records;
}
}),
"[externals]/crypto [external] (crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}),
"[project]/apps/web/src/lib/email/token-encryption.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Token Encryption Service
 *
 * Encrypts and decrypts OAuth refresh tokens before storing in database.
 * Uses AES-256-GCM for authenticated encryption.
 *
 * Security Features:
 * - AES-256-GCM authenticated encryption
 * - Unique IV (initialization vector) per token
 * - Authentication tag prevents tampering
 * - Key derivation from environment variable
 *
 * Environment Variables Required:
 * - TOKEN_ENCRYPTION_KEY: 32-byte hex string (64 characters)
 *
 * Generate key with: openssl rand -hex 32
 *
 * CRITICAL: Never commit encryption key to version control!
 */ __turbopack_context__.s([
    "decryptToken",
    ()=>decryptToken,
    "decryptTokenSafe",
    ()=>decryptTokenSafe,
    "encryptToken",
    ()=>encryptToken,
    "encryptTokenSafe",
    ()=>encryptTokenSafe,
    "isEncryptionConfigured",
    ()=>isEncryptionConfigured,
    "migrateTokensToEncrypted",
    ()=>migrateTokensToEncrypted,
    "testEncryption",
    ()=>testEncryption
]);
var __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/crypto [external] (crypto, cjs)");
;
// =============================================================================
// CONSTANTS
// =============================================================================
/** Encryption algorithm (AES-256-GCM) */ const ALGORITHM = "aes-256-gcm";
/** IV length in bytes (12 bytes = 96 bits, recommended for GCM) */ const IV_LENGTH = 12;
/** Auth tag length in bytes (16 bytes = 128 bits) */ const AUTH_TAG_LENGTH = 16;
/** Encoding for encrypted output */ const ENCODING = "base64";
// =============================================================================
// KEY MANAGEMENT
// =============================================================================
/**
 * Get encryption key from environment
 * Throws error if key is missing or invalid
 */ function getEncryptionKey() {
    const keyHex = process.env.TOKEN_ENCRYPTION_KEY;
    if (!keyHex) {
        throw new Error("TOKEN_ENCRYPTION_KEY environment variable not set. Generate with: openssl rand -hex 32");
    }
    // Verify key is 32 bytes (64 hex characters)
    if (keyHex.length !== 64) {
        throw new Error("TOKEN_ENCRYPTION_KEY must be 32 bytes (64 hex characters). Generate with: openssl rand -hex 32");
    }
    // Convert hex string to buffer
    const key = Buffer.from(keyHex, "hex");
    if (key.length !== 32) {
        throw new Error("Invalid TOKEN_ENCRYPTION_KEY format");
    }
    return key;
}
function encryptToken(plaintext) {
    try {
        const key = getEncryptionKey();
        // Generate random IV (never reuse IVs!)
        const iv = __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__["default"].randomBytes(IV_LENGTH);
        // Create cipher
        const cipher = __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__["default"].createCipheriv(ALGORITHM, key, iv);
        // Encrypt
        let ciphertext = cipher.update(plaintext, "utf8", ENCODING);
        ciphertext += cipher.final(ENCODING);
        // Get authentication tag
        const authTag = cipher.getAuthTag();
        // Return format: iv:authTag:ciphertext (all base64)
        return [
            iv.toString(ENCODING),
            authTag.toString(ENCODING),
            ciphertext
        ].join(":");
    } catch (error) {
        console.error("[Token Encryption] Encryption failed:", error);
        throw new Error("Failed to encrypt token");
    }
}
function decryptToken(encrypted) {
    try {
        const key = getEncryptionKey();
        // Parse encrypted format: iv:authTag:ciphertext
        const parts = encrypted.split(":");
        if (parts.length !== 3) {
            throw new Error("Invalid encrypted token format");
        }
        const [ivBase64, authTagBase64, ciphertext] = parts;
        // Convert from base64
        const iv = Buffer.from(ivBase64, ENCODING);
        const authTag = Buffer.from(authTagBase64, ENCODING);
        // Verify lengths
        if (iv.length !== IV_LENGTH) {
            throw new Error("Invalid IV length");
        }
        if (authTag.length !== AUTH_TAG_LENGTH) {
            throw new Error("Invalid auth tag length");
        }
        // Create decipher
        const decipher = __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__["default"].createDecipheriv(ALGORITHM, key, iv);
        decipher.setAuthTag(authTag);
        // Decrypt
        let plaintext = decipher.update(ciphertext, ENCODING, "utf8");
        plaintext += decipher.final("utf8");
        return plaintext;
    } catch (error) {
        console.error("[Token Encryption] Decryption failed:", error);
        throw new Error("Failed to decrypt token");
    }
}
function isEncryptionConfigured() {
    try {
        getEncryptionKey();
        return true;
    } catch  {
        return false;
    }
}
function testEncryption() {
    try {
        const testToken = "test_token_" + __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__["default"].randomBytes(32).toString("hex");
        const encrypted = encryptToken(testToken);
        const decrypted = decryptToken(encrypted);
        return decrypted === testToken;
    } catch  {
        return false;
    }
}
async function migrateTokensToEncrypted() {
    // This would be implemented as a standalone migration script
    // NOT included here to prevent accidental execution
    console.warn("[Token Encryption] Migration must be run as standalone script");
    throw new Error("Use standalone migration script");
}
function encryptTokenSafe(plaintext) {
    if (!isEncryptionConfigured()) {
        console.warn("[Token Encryption] Encryption key not configured - storing plaintext (DEV ONLY)");
        return plaintext;
    }
    return encryptToken(plaintext);
}
function decryptTokenSafe(encrypted) {
    if (!isEncryptionConfigured()) {
        console.warn("[Token Encryption] Encryption key not configured - returning plaintext (DEV ONLY)");
        return encrypted;
    }
    // Check if token is already encrypted (contains colons)
    if (!encrypted.includes(":")) {
        console.warn("[Token Encryption] Token appears to be plaintext - returning as-is (MIGRATION MODE)");
        return encrypted;
    }
    try {
        return decryptToken(encrypted);
    } catch (error) {
        console.error("[Token Encryption] Decryption failed, returning plaintext:", error);
        return encrypted;
    }
}
}),
"[project]/apps/web/src/lib/email/gmail-rate-limiter.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Gmail API Rate Limiter
 *
 * Prevents Gmail API quota exhaustion and abuse by implementing rate limits
 * at multiple levels: per-user, per-company, and global.
 *
 * Gmail API Quotas (Google-imposed):
 * - 1 billion quota units per day (project-wide)
 * - 250 quota units/user/second
 * - messages.get = 5 units, messages.list = 5 units
 *
 * Our Limits:
 * - Per-user: 1 sync every 5 minutes (max 12 syncs/hour)
 * - Per-user: Max 100 messages per sync
 * - Global: Max 10 concurrent syncs
 * - API endpoints: 60 requests/minute per user
 *
 * Implementation:
 * - In-memory rate limiting with Map (resets on server restart)
 * - Redis for distributed rate limiting (optional, for multi-server)
 * - Automatic cleanup of stale entries
 *
 * @see https://developers.google.com/gmail/api/reference/quota
 */ // =============================================================================
// TYPES
// =============================================================================
__turbopack_context__.s([
    "RATE_LIMITS",
    ()=>RATE_LIMITS,
    "acquireSyncLock",
    ()=>acquireSyncLock,
    "checkApiRateLimit",
    ()=>checkApiRateLimit,
    "checkSyncRateLimit",
    ()=>checkSyncRateLimit,
    "getActiveSyncCount",
    ()=>getActiveSyncCount,
    "getRateLimiterStats",
    ()=>getRateLimiterStats,
    "releaseSyncLock",
    ()=>releaseSyncLock,
    "resetRateLimits",
    ()=>resetRateLimits,
    "startCleanup",
    ()=>startCleanup,
    "stopCleanup",
    ()=>stopCleanup,
    "validateSyncParams",
    ()=>validateSyncParams
]);
// =============================================================================
// CONSTANTS
// =============================================================================
/** Minimum time between syncs per user (5 minutes) */ const SYNC_COOLDOWN_MS = 5 * 60 * 1000;
/** Maximum messages per sync */ const MAX_MESSAGES_PER_SYNC = 100;
/** Maximum concurrent syncs globally */ const MAX_CONCURRENT_SYNCS = 10;
/** API rate limit: requests per window */ const API_RATE_LIMIT = 60;
/** API rate limit window (1 minute) */ const API_RATE_WINDOW_MS = 60 * 1000;
/** How long to keep rate limit entries in memory */ const RATE_LIMIT_CLEANUP_MS = 60 * 60 * 1000; // 1 hour
/** How long a sync lock is valid (30 minutes max) */ const SYNC_LOCK_TIMEOUT_MS = 30 * 60 * 1000;
// =============================================================================
// IN-MEMORY STORAGE
// =============================================================================
/** Per-user API rate limits */ const apiRateLimits = new Map();
/** Per-user last sync timestamps */ const lastSyncTimes = new Map();
/** Active sync locks */ const activeSyncLocks = new Set();
/** Cleanup interval */ let cleanupInterval = null;
function checkApiRateLimit(userId) {
    const now = Date.now();
    const entry = apiRateLimits.get(userId);
    if (!entry) {
        // First request - allow and record
        apiRateLimits.set(userId, {
            count: 1,
            firstRequest: now,
            lastRequest: now
        });
        return {
            allowed: true
        };
    }
    // Check if window has expired
    const windowAge = now - entry.firstRequest;
    if (windowAge > API_RATE_WINDOW_MS) {
        // Window expired - reset counter
        apiRateLimits.set(userId, {
            count: 1,
            firstRequest: now,
            lastRequest: now
        });
        return {
            allowed: true
        };
    }
    // Within window - check limit
    if (entry.count >= API_RATE_LIMIT) {
        // Rate limit exceeded
        const retryAfter = Math.ceil((entry.firstRequest + API_RATE_WINDOW_MS - now) / 1000);
        return {
            allowed: false,
            retryAfter
        };
    }
    // Increment counter
    entry.count++;
    entry.lastRequest = now;
    apiRateLimits.set(userId, entry);
    return {
        allowed: true
    };
}
function checkSyncRateLimit(teamMemberId) {
    const now = Date.now();
    // Check sync cooldown
    const lastSync = lastSyncTimes.get(teamMemberId);
    if (lastSync) {
        const timeSinceLastSync = now - lastSync;
        if (timeSinceLastSync < SYNC_COOLDOWN_MS) {
            const retryAfter = Math.ceil((SYNC_COOLDOWN_MS - timeSinceLastSync) / 1000);
            return {
                allowed: false,
                reason: "Sync cooldown active",
                retryAfter
            };
        }
    }
    // Check concurrent sync limit
    const activeCount = getActiveSyncCount();
    if (activeCount >= MAX_CONCURRENT_SYNCS) {
        return {
            allowed: false,
            reason: "Maximum concurrent syncs reached",
            retryAfter: 60
        };
    }
    // Check if user already has active sync
    const existingLock = Array.from(activeSyncLocks).find((lock)=>lock.teamMemberId === teamMemberId);
    if (existingLock) {
        // Check if lock is expired
        if (now > existingLock.expiresAt) {
            // Lock expired - remove it
            activeSyncLocks.delete(existingLock);
        } else {
            return {
                allowed: false,
                reason: "Sync already in progress",
                retryAfter: Math.ceil((existingLock.expiresAt - now) / 1000)
            };
        }
    }
    return {
        allowed: true
    };
}
function acquireSyncLock(teamMemberId) {
    const check = checkSyncRateLimit(teamMemberId);
    if (!check.allowed) {
        return null;
    }
    const now = Date.now();
    const lock = {
        teamMemberId,
        startedAt: now,
        expiresAt: now + SYNC_LOCK_TIMEOUT_MS
    };
    activeSyncLocks.add(lock);
    lastSyncTimes.set(teamMemberId, now);
    return lock;
}
function releaseSyncLock(lock) {
    activeSyncLocks.delete(lock);
}
function getActiveSyncCount() {
    // Clean up expired locks first
    const now = Date.now();
    for (const lock of activeSyncLocks){
        if (now > lock.expiresAt) {
            activeSyncLocks.delete(lock);
        }
    }
    return activeSyncLocks.size;
}
// =============================================================================
// CLEANUP
// =============================================================================
/**
 * Clean up stale rate limit entries
 */ function cleanup() {
    const now = Date.now();
    // Clean API rate limits
    for (const [userId, entry] of apiRateLimits.entries()){
        const age = now - entry.lastRequest;
        if (age > RATE_LIMIT_CLEANUP_MS) {
            apiRateLimits.delete(userId);
        }
    }
    // Clean last sync times
    for (const [userId, lastSync] of lastSyncTimes.entries()){
        const age = now - lastSync;
        if (age > RATE_LIMIT_CLEANUP_MS) {
            lastSyncTimes.delete(userId);
        }
    }
    // Clean expired sync locks
    for (const lock of activeSyncLocks){
        if (now > lock.expiresAt) {
            activeSyncLocks.delete(lock);
        }
    }
}
function startCleanup() {
    if (cleanupInterval) {
        return; // Already started
    }
    // Run cleanup every 5 minutes
    cleanupInterval = setInterval(cleanup, 5 * 60 * 1000);
    console.log("[Gmail Rate Limiter] Cleanup scheduled");
}
function stopCleanup() {
    if (cleanupInterval) {
        clearInterval(cleanupInterval);
        cleanupInterval = null;
    }
}
function validateSyncParams(maxResults) {
    if (maxResults <= 0) {
        return {
            valid: false,
            error: "maxResults must be positive"
        };
    }
    if (maxResults > MAX_MESSAGES_PER_SYNC) {
        return {
            valid: false,
            error: `maxResults cannot exceed ${MAX_MESSAGES_PER_SYNC}`
        };
    }
    return {
        valid: true
    };
}
function getRateLimiterStats() {
    return {
        apiRateLimits: apiRateLimits.size,
        lastSyncTimes: lastSyncTimes.size,
        activeSyncs: getActiveSyncCount(),
        maxConcurrentSyncs: MAX_CONCURRENT_SYNCS
    };
}
function resetRateLimits() {
    apiRateLimits.clear();
    lastSyncTimes.clear();
    activeSyncLocks.clear();
    console.warn("[Gmail Rate Limiter] All rate limits reset");
}
// =============================================================================
// INITIALIZATION
// =============================================================================
// Start cleanup on module load
startCleanup();
const RATE_LIMITS = {
    SYNC_COOLDOWN_MS,
    MAX_MESSAGES_PER_SYNC,
    MAX_CONCURRENT_SYNCS,
    API_RATE_LIMIT,
    API_RATE_WINDOW_MS
};
}),
"[project]/apps/web/src/lib/email/audit-logger.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Email Security Audit Logger
 *
 * Logs security-relevant events for compliance, investigation, and monitoring.
 * All logs are stored in the database with retention policies.
 *
 * Events Logged:
 * - Gmail connections/disconnections
 * - Token refresh failures
 * - Permission grants/revokes
 * - Sync errors
 * - Email access (optional, for compliance)
 *
 * Usage:
 * await logAuditEvent('gmail_connected', { teamMemberId, email });
 * await logAuditEvent('permission_granted', { grantedBy, grantedTo, category });
 *
 * Database Table: email_audit_log (to be created)
 *
 * @see /docs/email/SECURITY_AUDIT.md
 */ __turbopack_context__.s([
    "getAuditEventsForCompany",
    ()=>getAuditEventsForCompany,
    "getAuditEventsForUser",
    ()=>getAuditEventsForUser,
    "getCriticalSecurityEvents",
    ()=>getCriticalSecurityEvents,
    "logAuditEvent",
    ()=>logAuditEvent,
    "logGmailConnected",
    ()=>logGmailConnected,
    "logGmailDisconnected",
    ()=>logGmailDisconnected,
    "logPermissionGranted",
    ()=>logPermissionGranted,
    "logPermissionRevoked",
    ()=>logPermissionRevoked,
    "logRateLimitExceeded",
    ()=>logRateLimitExceeded,
    "logSyncFailed",
    ()=>logSyncFailed,
    "logTokenRefreshFailed",
    ()=>logTokenRefreshFailed,
    "logUnauthorizedAccess",
    ()=>logUnauthorizedAccess
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/database/src/service-client.ts [app-route] (ecmascript)");
;
async function logAuditEvent(eventType, metadata = {}, severity = "info", message) {
    try {
        // Generate default message if not provided
        const defaultMessage = generateDefaultMessage(eventType, metadata);
        // In production, store in database
        // For now, log to console with structured format
        const logEntry = {
            timestamp: new Date().toISOString(),
            eventType,
            severity,
            message: message || defaultMessage,
            metadata
        };
        // Console output with color coding
        const prefix = `[Email Audit]`;
        const severityEmoji = {
            info: "",
            warning: "",
            error: "",
            critical: ""
        }[severity];
        console.log(`${prefix} ${severityEmoji} [${severity.toUpperCase()}] ${logEntry.message}`, metadata);
        // Store in database
        try {
            const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
            if (supabase) {
                await supabase.from("email_audit_log").insert({
                    company_id: metadata.companyId || null,
                    event_type: eventType,
                    severity,
                    message: logEntry.message,
                    team_member_id: metadata.teamMemberId || null,
                    user_id: metadata.userId || null,
                    gmail_email: metadata.gmailEmail || null,
                    metadata,
                    ip_address: metadata.ipAddress || null,
                    user_agent: metadata.userAgent || null
                });
            }
        } catch (dbError) {
            // Don't fail the audit log if database write fails - console log is still captured
            console.error("[Email Audit] Failed to store in database:", dbError);
        }
        return {
            success: true
        };
    } catch (error) {
        console.error("[Email Audit] Failed to log event:", error);
        return {
            success: false,
            error: error instanceof Error ? error.message : "Unknown error"
        };
    }
}
/**
 * Generate default message for event type
 */ function generateDefaultMessage(eventType, metadata) {
    const name = metadata.userName || metadata.teamMemberId || "User";
    switch(eventType){
        case "gmail_connected":
            return `${name} connected Gmail account (${metadata.gmailEmail})`;
        case "gmail_disconnected":
            return `${name} disconnected Gmail account (${metadata.gmailEmail})`;
        case "gmail_token_refreshed":
            return `Gmail token refreshed for ${metadata.gmailEmail}`;
        case "gmail_token_refresh_failed":
            return `Failed to refresh Gmail token for ${metadata.gmailEmail}: ${metadata.error}`;
        case "gmail_token_revoked":
            return `Gmail token revoked for ${metadata.gmailEmail}`;
        case "permission_granted":
            return `${metadata.grantedBy} granted ${metadata.category} permissions to ${metadata.grantedTo}`;
        case "permission_revoked":
            return `${metadata.grantedBy} revoked ${metadata.category} permissions from ${metadata.grantedTo}`;
        case "permission_updated":
            return `${metadata.grantedBy} updated ${metadata.category} permissions for ${metadata.grantedTo}`;
        case "permission_check_failed":
            return `Permission check failed for ${name}: ${metadata.error}`;
        case "sync_started":
            return `${name} started inbox sync`;
        case "sync_completed":
            return `${name} completed inbox sync (${metadata.syncMessageCount} messages)`;
        case "sync_failed":
            return `Inbox sync failed for ${name}: ${metadata.error}`;
        case "sync_rate_limited":
            return `${name} sync rate limited (retry after ${metadata.retryAfter}s)`;
        case "email_accessed":
            return `${name} accessed email: ${metadata.emailSubject}`;
        case "email_sent":
            return `${name} sent email to ${metadata.toAddress}: ${metadata.emailSubject}`;
        case "email_assigned":
            return `${name} assigned email to ${metadata.grantedTo}`;
        case "unauthorized_access_attempt":
            return `Unauthorized access attempt by ${name}: ${metadata.error}`;
        case "permission_escalation_attempt":
            return `Permission escalation attempt by ${name}: ${metadata.error}`;
        case "invalid_oauth_state":
            return `Invalid OAuth state detected: ${metadata.error}`;
        case "token_cleanup_executed":
            return `Token cleanup executed: ${metadata.syncMessageCount} tokens removed`;
        case "rate_limit_exceeded":
            return `Rate limit exceeded for ${name} (${metadata.requestsPerMinute} req/min)`;
        default:
            return `${eventType} event for ${name}`;
    }
}
async function logGmailConnected(teamMemberId, userName, gmailEmail, companyId) {
    await logAuditEvent("gmail_connected", {
        teamMemberId,
        userName,
        gmailEmail,
        companyId
    }, "info");
}
async function logGmailDisconnected(teamMemberId, userName, gmailEmail, companyId) {
    await logAuditEvent("gmail_disconnected", {
        teamMemberId,
        userName,
        gmailEmail,
        companyId
    }, "info");
}
async function logTokenRefreshFailed(teamMemberId, gmailEmail, error) {
    await logAuditEvent("gmail_token_refresh_failed", {
        teamMemberId,
        gmailEmail,
        error
    }, "warning");
}
async function logPermissionGranted(grantedBy, grantedByName, grantedTo, grantedToName, category, companyId) {
    await logAuditEvent("permission_granted", {
        grantedBy,
        userName: grantedByName,
        grantedTo,
        category,
        companyId
    }, "info");
}
async function logPermissionRevoked(revokedBy, revokedByName, revokedFrom, revokedFromName, category, companyId) {
    await logAuditEvent("permission_revoked", {
        grantedBy: revokedBy,
        userName: revokedByName,
        grantedTo: revokedFrom,
        category,
        companyId
    }, "info");
}
async function logSyncFailed(teamMemberId, userName, gmailEmail, error) {
    await logAuditEvent("sync_failed", {
        teamMemberId,
        userName,
        gmailEmail,
        error
    }, "error");
}
async function logUnauthorizedAccess(userId, userName, resource, error) {
    await logAuditEvent("unauthorized_access_attempt", {
        userId,
        userName,
        error,
        communicationId: resource
    }, "warning");
}
async function logRateLimitExceeded(userId, userName, requestsPerMinute, retryAfter) {
    await logAuditEvent("rate_limit_exceeded", {
        userId,
        userName,
        requestsPerMinute,
        retryAfter
    }, "warning");
}
async function getAuditEventsForUser(teamMemberId, limit = 100) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        if (!supabase) return [];
        const { data, error } = await supabase.from("email_audit_log").select("id, event_type, severity, message, metadata, created_at").eq("team_member_id", teamMemberId).order("created_at", {
            ascending: false
        }).limit(limit);
        if (error) {
            console.error("[Email Audit] Failed to query events for user:", error);
            return [];
        }
        return (data || []).map((row)=>({
                id: row.id,
                eventType: row.event_type,
                severity: row.severity,
                message: row.message,
                metadata: row.metadata || {},
                createdAt: row.created_at
            }));
    } catch (error) {
        console.error("[Email Audit] Failed to query events for user:", error);
        return [];
    }
}
async function getAuditEventsForCompany(companyId, limit = 100) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        if (!supabase) return [];
        const { data, error } = await supabase.from("email_audit_log").select("id, event_type, severity, message, metadata, created_at").eq("company_id", companyId).order("created_at", {
            ascending: false
        }).limit(limit);
        if (error) {
            console.error("[Email Audit] Failed to query events for company:", error);
            return [];
        }
        return (data || []).map((row)=>({
                id: row.id,
                eventType: row.event_type,
                severity: row.severity,
                message: row.message,
                metadata: row.metadata || {},
                createdAt: row.created_at
            }));
    } catch (error) {
        console.error("[Email Audit] Failed to query events for company:", error);
        return [];
    }
}
async function getCriticalSecurityEvents(limit = 50) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        if (!supabase) return [];
        const { data, error } = await supabase.from("email_audit_log").select("id, event_type, severity, message, metadata, created_at").in("severity", [
            "error",
            "critical"
        ]).order("created_at", {
            ascending: false
        }).limit(limit);
        if (error) {
            console.error("[Email Audit] Failed to query critical events:", error);
            return [];
        }
        return (data || []).map((row)=>({
                id: row.id,
                eventType: row.event_type,
                severity: row.severity,
                message: row.message,
                metadata: row.metadata || {},
                createdAt: row.created_at
            }));
    } catch (error) {
        console.error("[Email Audit] Failed to query critical events:", error);
        return [];
    }
}
}),
"[project]/apps/web/src/lib/email/gmail-client.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Gmail API Client (Company-Level & Per-User / Multi-Tenant)
 *
 * CRITICAL: Reply-to addresses ALWAYS use the platform subdomain (mail.thorbis.com),
 * even when sending from personal Gmail. This ensures replies go to the company's
 * centralized inbox, not the personal Gmail account.
 *
 * Example:
 * - FROM: john@gmail.com (personal Gmail)
 * - REPLY-TO: support@acme-plumbing.mail.thorbis.com (platform subdomain)
 *
 * See: /docs/email/REPLY_TO_ARCHITECTURE.md for full details
 *
 * This module provides Gmail API integration at two levels:
 * 1. Company-Level: One Gmail account for the entire company (sending only)
 * 2. Per-User: Individual team member Gmail accounts (inbox access + sending)
 *
 * Multi-Tenant Architecture:
 * - Each company can configure their own email provider
 * - Options: 'managed' (Resend/Postmark), 'gmail', or 'disabled'
 * - Company tokens stored in company_gmail_tokens table
 * - Per-user tokens stored in user_gmail_tokens table
 *
 * Key Features:
 * - Send emails via company's Gmail API
 * - Per-user inbox access and synchronization
 * - Automatic token refresh before expiration
 * - Token validation and error handling
 * - Integration with provider monitoring
 *
 * How It Works (Company-Level):
 * 1. Company admin connects Gmail via OAuth (grants gmail.send scope)
 * 2. Tokens stored in company_gmail_tokens table
 * 3. Before sending, we check/refresh tokens
 * 4. Use Gmail API to send email as company
 *
 * How It Works (Per-User):
 * 1. Team member connects their Gmail via OAuth (grants gmail.readonly + gmail.send)
 * 2. Tokens stored in user_gmail_tokens table
 * 3. Background sync job fetches inbox emails every 5-10 minutes
 * 4. Emails stored in communications table with mailbox_owner_id
 * 5. Role-based permissions control who can see which emails
 *
 * Rate Limits (Gmail API):
 * - Consumer accounts: 100 emails/day
 * - Google Workspace: 2,000 emails/day
 * - Per-minute limit: 100 messages
 *
 * Required Scopes:
 * - Company: https://www.googleapis.com/auth/gmail.send
 * - Per-User: https://www.googleapis.com/auth/gmail.readonly, gmail.send
 *
 * Environment Variables:
 * - GOOGLE_CLIENT_ID: OAuth client ID
 * - GOOGLE_CLIENT_SECRET: OAuth client secret
 *
 * @see https://developers.google.com/gmail/api/reference/rest
 */ /* __next_internal_action_entry_do_not_use__ [{"0077b5d695a6e4bd1ec48ffe0a639d5f7737bedd9a":"isGmailIntegrationEnabled","402e7af979456c6169a23490efd5611eedb77b7f8d":"getUserGmailTokens","40668734ac0715444771ef63df4ce2328f9e9144e1":"disconnectUserGmail","4093292a46f282093734eae84e8bdd79e58274f64f":"disconnectCompanyGmail","40b41f81fe9259fafce704bbd3935f68276fc4e2ca":"getCompanyEmailProvider","40f32c0cfb7780293a18cf77271d2770c0d61fe547":"getCompanyGmailTokens","6028c8a328b5f7616873329b038fce472d56c751d5":"checkCompanyGmailHealth","60666d082731fc0da1ea78000a7b22b3afbbc989b7":"sendCompanyGmailEmail","606b9ecbf77951fa1ec76cb2b2d919f43a5335a5f2":"syncUserInbox","607bbb8ec456319d6f212db11b0dad6d62ec6e5cdc":"refreshUserGmailToken","60afa4f94f55ff80042f81a76c673e75545d27872d":"refreshCompanyGmailToken","701eda529738b7cb8db9c89a5a499d69941ede094c":"setCompanyEmailProvider","70b8ccf02d177c82841b8a8e25abfece8615b480cf":"fetchUserInbox","78ce69226fb0c4303ba3e078a1534c86a000dbb744":"storeGmailMessage","7e684d0fcd64a86c227a3635ab611c4c140250b6fb":"storeUserGmailTokens","7fa9d4af88bd605b13c48fb4e2937bda4ef2ce0a20":"storeCompanyGmailTokens"},"",""] */ __turbopack_context__.s([
    "checkCompanyGmailHealth",
    ()=>checkCompanyGmailHealth,
    "disconnectCompanyGmail",
    ()=>disconnectCompanyGmail,
    "disconnectUserGmail",
    ()=>disconnectUserGmail,
    "fetchUserInbox",
    ()=>fetchUserInbox,
    "getCompanyEmailProvider",
    ()=>getCompanyEmailProvider,
    "getCompanyGmailTokens",
    ()=>getCompanyGmailTokens,
    "getUserGmailTokens",
    ()=>getUserGmailTokens,
    "isGmailIntegrationEnabled",
    ()=>isGmailIntegrationEnabled,
    "refreshCompanyGmailToken",
    ()=>refreshCompanyGmailToken,
    "refreshUserGmailToken",
    ()=>refreshUserGmailToken,
    "sendCompanyGmailEmail",
    ()=>sendCompanyGmailEmail,
    "setCompanyEmailProvider",
    ()=>setCompanyEmailProvider,
    "storeCompanyGmailTokens",
    ()=>storeCompanyGmailTokens,
    "storeGmailMessage",
    ()=>storeGmailMessage,
    "storeUserGmailTokens",
    ()=>storeUserGmailTokens,
    "syncUserInbox",
    ()=>syncUserInbox
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/server-reference.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/database/src/service-client.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$token$2d$encryption$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/token-encryption.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$gmail$2d$rate$2d$limiter$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/gmail-rate-limiter.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$audit$2d$logger$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/audit-logger.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/action-validate.js [app-route] (ecmascript)");
;
;
;
;
;
// =============================================================================
// CONSTANTS
// =============================================================================
const GOOGLE_TOKEN_URL = "https://oauth2.googleapis.com/token";
const GMAIL_API_URL = "https://gmail.googleapis.com/gmail/v1";
const GMAIL_SEND_SCOPE = "https://www.googleapis.com/auth/gmail.send";
const GMAIL_READONLY_SCOPE = "https://www.googleapis.com/auth/gmail.readonly";
const GMAIL_MODIFY_SCOPE = "https://www.googleapis.com/auth/gmail.modify";
const TOKEN_REFRESH_BUFFER_MS = 5 * 60 * 1000;
async function getCompanyEmailProvider(companyId) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        const { data } = await supabase.from("companies").select("email_provider").eq("id", companyId).single();
        return data?.email_provider || "managed";
    } catch (error) {
        console.error("[Gmail] Error getting company email provider:", error);
        return "managed";
    }
}
async function setCompanyEmailProvider(companyId, provider, updatedByUserId) {
    try {
        // If switching to Gmail, verify tokens exist
        if (provider === "gmail") {
            const tokens = await getCompanyGmailTokens(companyId);
            if (!tokens || !tokens.isValid) {
                return {
                    success: false,
                    error: "Gmail is not connected. Please connect Gmail first."
                };
            }
        }
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        const { error } = await supabase.from("companies").update({
            email_provider: provider,
            email_provider_updated_at: new Date().toISOString(),
            email_provider_updated_by: updatedByUserId || null
        }).eq("id", companyId);
        if (error) {
            return {
                success: false,
                error: error.message
            };
        }
        console.log(`[Gmail] Company ${companyId} email provider set to: ${provider}`);
        return {
            success: true
        };
    } catch (error) {
        const message = error instanceof Error ? error.message : "Unknown error";
        return {
            success: false,
            error: message
        };
    }
}
async function getCompanyGmailTokens(companyId) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        const { data, error } = await supabase.from("company_gmail_tokens").select("*").eq("company_id", companyId).maybeSingle();
        if (error || !data) {
            return null;
        }
        const tokenData = {
            companyId: data.company_id,
            gmailEmail: data.gmail_email,
            gmailDisplayName: data.gmail_display_name,
            accessToken: data.access_token,
            refreshToken: data.refresh_token,
            tokenExpiresAt: new Date(data.token_expires_at),
            isValid: data.is_valid,
            scopes: data.scopes || [
                GMAIL_SEND_SCOPE
            ],
            connectedBy: data.connected_by,
            connectedByName: data.connected_by_name
        };
        // Check if token needs refresh
        if (isTokenExpiringSoon(tokenData.tokenExpiresAt)) {
            console.log(`[Gmail] Token expiring soon for company ${companyId}, refreshing...`);
            const refreshed = await refreshCompanyGmailToken(companyId, tokenData.refreshToken);
            if (refreshed) {
                return refreshed;
            }
            console.warn("[Gmail] Token refresh failed, using existing token");
        }
        return tokenData;
    } catch (error) {
        console.error("[Gmail] Error getting company tokens:", error);
        return null;
    }
}
function isTokenExpiringSoon(expiresAt) {
    return expiresAt.getTime() - Date.now() < TOKEN_REFRESH_BUFFER_MS;
}
async function refreshCompanyGmailToken(companyId, refreshToken) {
    try {
        const clientId = process.env.GOOGLE_CLIENT_ID;
        const clientSecret = process.env.GOOGLE_CLIENT_SECRET;
        if (!clientId || !clientSecret) {
            console.error("[Gmail] Missing GOOGLE_CLIENT_ID or GOOGLE_CLIENT_SECRET");
            return null;
        }
        const response = await fetch(GOOGLE_TOKEN_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({
                client_id: clientId,
                client_secret: clientSecret,
                refresh_token: refreshToken,
                grant_type: "refresh_token"
            })
        });
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`[Gmail] Token refresh failed: ${response.status}`, errorText);
            if (response.status === 400 || response.status === 401) {
                await markCompanyTokenInvalid(companyId, `Refresh failed: ${response.status}`);
            }
            return null;
        }
        const tokenResponse = await response.json();
        const expiresAt = new Date(Date.now() + tokenResponse.expires_in * 1000);
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        const { data, error } = await supabase.from("company_gmail_tokens").update({
            access_token: tokenResponse.access_token,
            token_expires_at: expiresAt.toISOString(),
            ...tokenResponse.refresh_token && {
                refresh_token: tokenResponse.refresh_token
            },
            is_valid: true,
            last_error: null
        }).eq("company_id", companyId).select("*").single();
        if (error || !data) {
            console.error("[Gmail] Failed to update refreshed token:", error?.message);
            return null;
        }
        console.log(`[Gmail] Token refreshed for company ${companyId}`);
        return {
            companyId: data.company_id,
            gmailEmail: data.gmail_email,
            gmailDisplayName: data.gmail_display_name,
            accessToken: data.access_token,
            refreshToken: data.refresh_token,
            tokenExpiresAt: new Date(data.token_expires_at),
            isValid: data.is_valid,
            scopes: data.scopes || [
                GMAIL_SEND_SCOPE
            ],
            connectedBy: data.connected_by,
            connectedByName: data.connected_by_name
        };
    } catch (error) {
        console.error("[Gmail] Token refresh error:", error);
        return null;
    }
}
async function markCompanyTokenInvalid(companyId, reason) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        await supabase.from("company_gmail_tokens").update({
            is_valid: false,
            last_error: reason
        }).eq("company_id", companyId);
        console.log(`[Gmail] Marked token invalid for company ${companyId}: ${reason}`);
    } catch (error) {
        console.error("[Gmail] Failed to mark token invalid:", error);
    }
}
async function storeCompanyGmailTokens(companyId, gmailEmail, displayName, accessToken, refreshToken, expiresIn, scopes, connectedByUserId, connectedByName) {
    try {
        if (!scopes.includes(GMAIL_SEND_SCOPE)) {
            return {
                success: false,
                error: `Missing required scope: ${GMAIL_SEND_SCOPE}`
            };
        }
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        const expiresAt = new Date(Date.now() + expiresIn * 1000);
        const { error } = await supabase.from("company_gmail_tokens").upsert({
            company_id: companyId,
            gmail_email: gmailEmail,
            gmail_display_name: displayName,
            access_token: accessToken,
            refresh_token: refreshToken,
            token_expires_at: expiresAt.toISOString(),
            scopes,
            is_valid: true,
            last_error: null,
            connected_by: connectedByUserId || null,
            connected_by_name: connectedByName || null
        }, {
            onConflict: "company_id"
        });
        if (error) {
            console.error("[Gmail] Failed to store tokens:", error.message);
            return {
                success: false,
                error: error.message
            };
        }
        console.log(`[Gmail] Stored tokens for company ${companyId} (${gmailEmail})`);
        return {
            success: true
        };
    } catch (error) {
        const message = error instanceof Error ? error.message : "Unknown error";
        return {
            success: false,
            error: message
        };
    }
}
async function disconnectCompanyGmail(companyId) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        // Get token to revoke
        const { data: tokenData } = await supabase.from("company_gmail_tokens").select("access_token").eq("company_id", companyId).single();
        // Delete from database
        const { error } = await supabase.from("company_gmail_tokens").delete().eq("company_id", companyId);
        if (error) {
            return {
                success: false,
                error: error.message
            };
        }
        // Reset to managed provider
        await setCompanyEmailProvider(companyId, "managed");
        // Revoke token with Google (best effort)
        if (tokenData?.access_token) {
            try {
                await fetch(`https://oauth2.googleapis.com/revoke?token=${tokenData.access_token}`, {
                    method: "POST"
                });
            } catch  {
                console.warn("[Gmail] Token revocation request failed (non-critical)");
            }
        }
        console.log(`[Gmail] Disconnected Gmail for company ${companyId}`);
        return {
            success: true
        };
    } catch (error) {
        const message = error instanceof Error ? error.message : "Unknown error";
        return {
            success: false,
            error: message
        };
    }
}
async function sendCompanyGmailEmail(companyId, emailData) {
    try {
        const tokens = await getCompanyGmailTokens(companyId);
        if (!tokens) {
            return {
                success: false,
                error: "Gmail not connected for this company"
            };
        }
        if (!tokens.isValid) {
            return {
                success: false,
                error: `Gmail connection invalid: ${tokens.gmailEmail}`
            };
        }
        const mimeMessage = buildMimeMessage({
            from: tokens.gmailDisplayName ? `${tokens.gmailDisplayName} <${tokens.gmailEmail}>` : tokens.gmailEmail,
            to: Array.isArray(emailData.to) ? emailData.to.join(", ") : emailData.to,
            subject: emailData.subject,
            html: emailData.html,
            text: emailData.text,
            replyTo: emailData.replyTo,
            cc: emailData.cc ? Array.isArray(emailData.cc) ? emailData.cc.join(", ") : emailData.cc : undefined,
            bcc: emailData.bcc ? Array.isArray(emailData.bcc) ? emailData.bcc.join(", ") : emailData.bcc : undefined,
            headers: emailData.headers
        });
        const encodedMessage = base64UrlEncode(mimeMessage);
        const response = await fetch(`${GMAIL_API_URL}/users/me/messages/send`, {
            method: "POST",
            headers: {
                Authorization: `Bearer ${tokens.accessToken}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                raw: encodedMessage
            })
        });
        if (!response.ok) {
            const errorData = await response.json().catch(()=>({}));
            const errorMessage = errorData.error?.message || `Gmail API error: ${response.status}`;
            console.error(`[Gmail] Send failed: ${errorMessage}`);
            if (response.status === 401) {
                await markCompanyTokenInvalid(companyId, "Authentication failed");
            }
            return {
                success: false,
                error: errorMessage
            };
        }
        const result = await response.json();
        // Update last used timestamp
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        await supabase.from("company_gmail_tokens").update({
            last_used_at: new Date().toISOString()
        }).eq("company_id", companyId);
        console.log(`[Gmail] Sent email for company ${companyId} (ID: ${result.id})`);
        return {
            success: true,
            messageId: result.id,
            threadId: result.threadId,
            labelIds: result.labelIds
        };
    } catch (error) {
        const message = error instanceof Error ? error.message : "Unknown error";
        console.error("[Gmail] Send error:", message);
        return {
            success: false,
            error: message
        };
    }
}
function buildMimeMessage(parts) {
    const boundary = `boundary_${Date.now()}_${Math.random().toString(36).substring(7)}`;
    const lines = [
        `From: ${parts.from}`,
        `To: ${parts.to}`,
        `Subject: =?UTF-8?B?${Buffer.from(parts.subject).toString("base64")}?=`,
        "MIME-Version: 1.0"
    ];
    if (parts.replyTo) lines.push(`Reply-To: ${parts.replyTo}`);
    if (parts.cc) lines.push(`Cc: ${parts.cc}`);
    if (parts.bcc) lines.push(`Bcc: ${parts.bcc}`);
    if (parts.headers) {
        for (const [key, value] of Object.entries(parts.headers)){
            lines.push(`${key}: ${value}`);
        }
    }
    lines.push(`Content-Type: multipart/alternative; boundary="${boundary}"`);
    lines.push("");
    const textContent = parts.text || extractTextFromHtml(parts.html);
    lines.push(`--${boundary}`);
    lines.push("Content-Type: text/plain; charset=UTF-8");
    lines.push("Content-Transfer-Encoding: base64");
    lines.push("");
    lines.push(Buffer.from(textContent).toString("base64"));
    lines.push(`--${boundary}`);
    lines.push("Content-Type: text/html; charset=UTF-8");
    lines.push("Content-Transfer-Encoding: base64");
    lines.push("");
    lines.push(Buffer.from(parts.html).toString("base64"));
    lines.push(`--${boundary}--`);
    return lines.join("\r\n");
}
function extractTextFromHtml(html) {
    return html.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, "").replace(/<script[^>]*>[\s\S]*?<\/script>/gi, "").replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim();
}
function base64UrlEncode(str) {
    return Buffer.from(str).toString("base64").replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}
async function checkCompanyGmailHealth(companyId, testApi = false) {
    try {
        const tokens = await getCompanyGmailTokens(companyId);
        if (!tokens) {
            return {
                connected: false,
                tokenValid: false
            };
        }
        const result = {
            connected: true,
            email: tokens.gmailEmail,
            displayName: tokens.gmailDisplayName,
            tokenValid: tokens.isValid,
            tokenExpiresAt: tokens.tokenExpiresAt,
            connectedBy: tokens.connectedByName,
            apiHealthy: undefined
        };
        if (testApi && tokens.isValid) {
            try {
                const response = await fetch(`${GMAIL_API_URL}/users/me/profile`, {
                    headers: {
                        Authorization: `Bearer ${tokens.accessToken}`
                    }
                });
                result.apiHealthy = response.ok;
            } catch  {
                result.apiHealthy = false;
            }
        }
        return result;
    } catch (error) {
        return {
            connected: false,
            tokenValid: false,
            error: error instanceof Error ? error.message : "Unknown error"
        };
    }
}
async function getUserGmailTokens(teamMemberId) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        const { data, error } = await supabase.from("user_gmail_tokens").select("*, user_email_accounts!inner(email_address)").eq("team_member_id", teamMemberId).eq("sync_enabled", true).maybeSingle();
        if (error || !data) {
            return null;
        }
        // Decrypt tokens before using (CRITICAL SECURITY)
        const decryptedAccessToken = (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$token$2d$encryption$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["decryptToken"])(data.access_token);
        const decryptedRefreshToken = (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$token$2d$encryption$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["decryptToken"])(data.refresh_token);
        const tokenData = {
            teamMemberId: data.team_member_id,
            emailAccountId: data.user_email_account_id,
            gmailEmail: data.user_email_accounts.email_address,
            accessToken: decryptedAccessToken,
            refreshToken: decryptedRefreshToken,
            tokenExpiresAt: new Date(data.token_expiry),
            scopes: data.scopes || [],
            syncEnabled: data.sync_enabled,
            lastSyncedAt: data.last_synced_at ? new Date(data.last_synced_at) : undefined
        };
        // Check if token needs refresh
        if (isTokenExpiringSoon(tokenData.tokenExpiresAt)) {
            console.log(`[Gmail] Token expiring soon for user ${teamMemberId}, refreshing...`);
            const refreshed = await refreshUserGmailToken(teamMemberId, tokenData.refreshToken);
            if (refreshed) {
                return refreshed;
            }
            console.warn("[Gmail] User token refresh failed, using existing token");
        }
        return tokenData;
    } catch (error) {
        console.error("[Gmail] Error getting user tokens:", error);
        return null;
    }
}
async function refreshUserGmailToken(teamMemberId, refreshToken) {
    try {
        const clientId = process.env.GOOGLE_CLIENT_ID;
        const clientSecret = process.env.GOOGLE_CLIENT_SECRET;
        if (!clientId || !clientSecret) {
            console.error("[Gmail] Missing GOOGLE_CLIENT_ID or GOOGLE_CLIENT_SECRET");
            return null;
        }
        const response = await fetch(GOOGLE_TOKEN_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({
                client_id: clientId,
                client_secret: clientSecret,
                refresh_token: refreshToken,
                grant_type: "refresh_token"
            })
        });
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`[Gmail] User token refresh failed: ${response.status}`, errorText);
            // Log token refresh failure for audit trail
            await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$audit$2d$logger$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["logTokenRefreshFailed"])(teamMemberId, "Unknown", `Token refresh failed: ${response.status} - ${errorText}`);
            if (response.status === 400 || response.status === 401) {
                await markUserTokenInvalid(teamMemberId, `Refresh failed: ${response.status}`);
            }
            return null;
        }
        const tokenResponse = await response.json();
        const expiresAt = new Date(Date.now() + tokenResponse.expires_in * 1000);
        // Encrypt refreshed tokens before storing (CRITICAL SECURITY)
        const encryptedAccessToken = (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$token$2d$encryption$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["encryptToken"])(tokenResponse.access_token);
        const encryptedRefreshToken = tokenResponse.refresh_token ? (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$token$2d$encryption$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["encryptToken"])(tokenResponse.refresh_token) : undefined;
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        const { data, error } = await supabase.from("user_gmail_tokens").update({
            access_token: encryptedAccessToken,
            token_expiry: expiresAt.toISOString(),
            ...encryptedRefreshToken && {
                refresh_token: encryptedRefreshToken
            }
        }).eq("team_member_id", teamMemberId).select("*, user_email_accounts!inner(email_address)").single();
        if (error || !data) {
            console.error("[Gmail] Failed to update refreshed user token:", error?.message);
            return null;
        }
        console.log(`[Gmail] User token refreshed for team member ${teamMemberId}`);
        // Decrypt tokens for return (already encrypted in DB)
        const decryptedAccessToken = (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$token$2d$encryption$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["decryptToken"])(data.access_token);
        const decryptedRefreshToken = (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$token$2d$encryption$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["decryptToken"])(data.refresh_token);
        return {
            teamMemberId: data.team_member_id,
            emailAccountId: data.user_email_account_id,
            gmailEmail: data.user_email_accounts.email_address,
            accessToken: decryptedAccessToken,
            refreshToken: decryptedRefreshToken,
            tokenExpiresAt: new Date(data.token_expiry),
            scopes: data.scopes || [],
            syncEnabled: data.sync_enabled,
            lastSyncedAt: data.last_synced_at ? new Date(data.last_synced_at) : undefined
        };
    } catch (error) {
        console.error("[Gmail] User token refresh error:", error);
        return null;
    }
}
async function markUserTokenInvalid(teamMemberId, reason) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        await supabase.from("user_gmail_tokens").update({
            sync_enabled: false
        }).eq("team_member_id", teamMemberId);
        console.log(`[Gmail] Disabled sync for team member ${teamMemberId}: ${reason}`);
    } catch (error) {
        console.error("[Gmail] Failed to mark user token invalid:", error);
    }
}
async function storeUserGmailTokens(teamMemberId, emailAccountId, accessToken, refreshToken, expiresIn, scopes) {
    try {
        if (!scopes.includes(GMAIL_READONLY_SCOPE) && !scopes.includes(GMAIL_MODIFY_SCOPE)) {
            return {
                success: false,
                error: `Missing required scope: ${GMAIL_READONLY_SCOPE} or ${GMAIL_MODIFY_SCOPE}`
            };
        }
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        const expiresAt = new Date(Date.now() + expiresIn * 1000);
        // Encrypt tokens before storing (CRITICAL SECURITY)
        const encryptedAccessToken = (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$token$2d$encryption$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["encryptToken"])(accessToken);
        const encryptedRefreshToken = (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$token$2d$encryption$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["encryptToken"])(refreshToken);
        const { error } = await supabase.from("user_gmail_tokens").upsert({
            team_member_id: teamMemberId,
            user_email_account_id: emailAccountId,
            access_token: encryptedAccessToken,
            refresh_token: encryptedRefreshToken,
            token_expiry: expiresAt.toISOString(),
            scopes,
            sync_enabled: true,
            last_synced_at: null
        }, {
            onConflict: "user_email_account_id"
        });
        if (error) {
            console.error("[Gmail] Failed to store user tokens:", error.message);
            return {
                success: false,
                error: error.message
            };
        }
        console.log(`[Gmail] Stored encrypted tokens for team member ${teamMemberId}`);
        return {
            success: true
        };
    } catch (error) {
        const message = error instanceof Error ? error.message : "Unknown error";
        return {
            success: false,
            error: message
        };
    }
}
async function disconnectUserGmail(teamMemberId) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        // Get token to revoke
        const { data: tokenData } = await supabase.from("user_gmail_tokens").select("access_token").eq("team_member_id", teamMemberId).single();
        // Delete from database
        const { error } = await supabase.from("user_gmail_tokens").delete().eq("team_member_id", teamMemberId);
        if (error) {
            return {
                success: false,
                error: error.message
            };
        }
        // Revoke token with Google (best effort)
        if (tokenData?.access_token) {
            try {
                await fetch(`https://oauth2.googleapis.com/revoke?token=${tokenData.access_token}`, {
                    method: "POST"
                });
            } catch  {
                console.warn("[Gmail] User token revocation request failed (non-critical)");
            }
        }
        console.log(`[Gmail] Disconnected Gmail for team member ${teamMemberId}`);
        return {
            success: true
        };
    } catch (error) {
        const message = error instanceof Error ? error.message : "Unknown error";
        return {
            success: false,
            error: message
        };
    }
}
async function fetchUserInbox(teamMemberId, maxResults = 50, pageToken) {
    try {
        const tokens = await getUserGmailTokens(teamMemberId);
        if (!tokens) {
            return {
                messages: [],
                error: "Gmail not connected for this user"
            };
        }
        // Build query parameters
        const params = new URLSearchParams({
            maxResults: maxResults.toString(),
            q: "in:inbox",
            ...pageToken && {
                pageToken
            }
        });
        // List messages
        const listResponse = await fetch(`${GMAIL_API_URL}/users/me/messages?${params}`, {
            headers: {
                Authorization: `Bearer ${tokens.accessToken}`
            }
        });
        if (!listResponse.ok) {
            const errorText = await listResponse.text();
            console.error(`[Gmail] Inbox fetch failed: ${listResponse.status}`, errorText);
            return {
                messages: [],
                error: `API error: ${listResponse.status}`
            };
        }
        const listData = await listResponse.json();
        const messageIds = listData.messages || [];
        const messages = [];
        // Fetch full message details for each message
        for (const msgRef of messageIds){
            const msgResponse = await fetch(`${GMAIL_API_URL}/users/me/messages/${msgRef.id}`, {
                headers: {
                    Authorization: `Bearer ${tokens.accessToken}`
                }
            });
            if (msgResponse.ok) {
                const msgData = await msgResponse.json();
                messages.push(msgData);
            }
        }
        return {
            messages,
            nextPageToken: listData.nextPageToken
        };
    } catch (error) {
        const message = error instanceof Error ? error.message : "Unknown error";
        console.error("[Gmail] Inbox fetch error:", message);
        return {
            messages: [],
            error: message
        };
    }
}
/**
 * Parse Gmail message to structured format
 */ function parseGmailMessage(message) {
    const headers = message.payload.headers;
    const getHeader = (name)=>headers.find((h)=>h.name.toLowerCase() === name.toLowerCase())?.value || "";
    const from = getHeader("From");
    const to = getHeader("To").split(",").map((e)=>e.trim()).filter(Boolean);
    const cc = getHeader("Cc")?.split(",").map((e)=>e.trim()).filter(Boolean);
    const subject = getHeader("Subject");
    // Extract body content
    let textBody;
    let htmlBody;
    const extractBody = (part)=>{
        if (part.mimeType === "text/plain" && part.body?.data) {
            textBody = Buffer.from(part.body.data, "base64").toString("utf-8");
        } else if (part.mimeType === "text/html" && part.body?.data) {
            htmlBody = Buffer.from(part.body.data, "base64").toString("utf-8");
        }
        if (part.parts) {
            part.parts.forEach(extractBody);
        }
    };
    if (message.payload.parts) {
        message.payload.parts.forEach(extractBody);
    } else if (message.payload.body?.data) {
        // Single part message
        if (message.payload.mimeType === "text/plain") {
            textBody = Buffer.from(message.payload.body.data, "base64").toString("utf-8");
        } else if (message.payload.mimeType === "text/html") {
            htmlBody = Buffer.from(message.payload.body.data, "base64").toString("utf-8");
        }
    }
    return {
        gmailMessageId: message.id,
        gmailThreadId: message.threadId,
        from,
        to,
        cc,
        subject,
        textBody,
        htmlBody,
        receivedAt: new Date(parseInt(message.internalDate)),
        hasAttachments: message.payload.parts?.some((p)=>p.body.size > 0 && p.mimeType.startsWith("attachment/")) || false,
        labels: message.labelIds
    };
}
async function storeGmailMessage(companyId, teamMemberId, emailAccountId, parsedMessage) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        // Check if message already exists
        const { data: existing } = await supabase.from("communications").select("id").eq("gmail_message_id", parsedMessage.gmailMessageId).maybeSingle();
        if (existing) {
            return {
                success: true,
                communicationId: existing.id
            };
        }
        // Extract customer email from "from" field
        const fromEmail = parsedMessage.from.match(/<(.+?)>/)?.[1] || parsedMessage.from;
        // Try to find customer by email
        const { data: customer } = await supabase.from("customers").select("id").eq("company_id", companyId).eq("email", fromEmail).maybeSingle();
        // Insert communication
        const { data: communication, error } = await supabase.from("communications").insert({
            company_id: companyId,
            type: "email",
            direction: "inbound",
            status: "received",
            from_address: fromEmail,
            to_address: parsedMessage.to[0] || "",
            subject: parsedMessage.subject,
            body: parsedMessage.htmlBody || parsedMessage.textBody || "",
            customer_id: customer?.id || null,
            mailbox_owner_id: teamMemberId,
            email_account_id: emailAccountId,
            visibility_scope: "private",
            gmail_message_id: parsedMessage.gmailMessageId,
            gmail_thread_id: parsedMessage.gmailThreadId
        }).select("id").single();
        if (error) {
            console.error("[Gmail] Failed to store message:", error.message);
            return {
                success: false,
                error: error.message
            };
        }
        return {
            success: true,
            communicationId: communication.id
        };
    } catch (error) {
        const message = error instanceof Error ? error.message : "Unknown error";
        return {
            success: false,
            error: message
        };
    }
}
async function syncUserInbox(companyId, teamMemberId) {
    const startTime = new Date();
    let messagesFetched = 0;
    let messagesStored = 0;
    const errors = [];
    let syncLock = null;
    try {
        // Check rate limit before syncing (CRITICAL SAFEGUARD)
        const rateLimitCheck = (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$gmail$2d$rate$2d$limiter$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["checkSyncRateLimit"])(teamMemberId);
        if (!rateLimitCheck.allowed) {
            await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$audit$2d$logger$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["logAuditEvent"])("sync_rate_limited", {
                teamMemberId,
                retryAfter: rateLimitCheck.retryAfter
            }, "warning");
            return {
                success: false,
                messagesFetched: 0,
                messagesStored: 0,
                errors: [
                    rateLimitCheck.reason || "Rate limit exceeded"
                ],
                lastSyncedAt: startTime
            };
        }
        // Acquire sync lock to prevent concurrent syncs
        syncLock = (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$gmail$2d$rate$2d$limiter$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["acquireSyncLock"])(teamMemberId);
        if (!syncLock) {
            return {
                success: false,
                messagesFetched: 0,
                messagesStored: 0,
                errors: [
                    "Could not acquire sync lock - another sync may be in progress"
                ],
                lastSyncedAt: startTime
            };
        }
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$audit$2d$logger$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["logAuditEvent"])("sync_started", {
            teamMemberId
        }, "info");
        const tokens = await getUserGmailTokens(teamMemberId);
        if (!tokens) {
            return {
                success: false,
                messagesFetched: 0,
                messagesStored: 0,
                errors: [
                    "Gmail not connected"
                ],
                lastSyncedAt: startTime
            };
        }
        // Fetch messages since last sync (or all if never synced)
        let pageToken;
        let hasMore = true;
        while(hasMore){
            const { messages, nextPageToken, error } = await fetchUserInbox(teamMemberId, 50, pageToken);
            if (error) {
                errors.push(error);
                break;
            }
            messagesFetched += messages.length;
            // Store each message
            for (const message of messages){
                const parsed = parseGmailMessage(message);
                const { success, error: storeError } = await storeGmailMessage(companyId, teamMemberId, tokens.emailAccountId, parsed);
                if (success) {
                    messagesStored++;
                } else if (storeError) {
                    errors.push(storeError);
                }
            }
            // Continue to next page if available
            pageToken = nextPageToken;
            hasMore = !!nextPageToken && messages.length > 0;
        }
        // Update last synced timestamp
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        await supabase.from("user_gmail_tokens").update({
            last_synced_at: startTime.toISOString()
        }).eq("team_member_id", teamMemberId);
        console.log(`[Gmail] Synced ${messagesStored}/${messagesFetched} messages for team member ${teamMemberId}`);
        // Log successful sync
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$audit$2d$logger$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["logAuditEvent"])("sync_completed", {
            teamMemberId,
            syncMessageCount: messagesStored
        }, "info");
        return {
            success: errors.length === 0,
            messagesFetched,
            messagesStored,
            errors,
            lastSyncedAt: startTime
        };
    } catch (error) {
        const message = error instanceof Error ? error.message : "Unknown error";
        errors.push(message);
        // Log failed sync
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$audit$2d$logger$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["logAuditEvent"])("sync_failed", {
            teamMemberId,
            error: message
        }, "error");
        return {
            success: false,
            messagesFetched,
            messagesStored,
            errors,
            lastSyncedAt: startTime
        };
    } finally{
        // Always release sync lock (CRITICAL)
        if (syncLock) {
            (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$gmail$2d$rate$2d$limiter$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["releaseSyncLock"])(syncLock);
        }
    }
}
async function isGmailIntegrationEnabled() {
    return !!(process.env.GOOGLE_CLIENT_ID && process.env.GOOGLE_CLIENT_SECRET && ("TURBOPACK compile-time value", "http://localhost:3000"));
}
;
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ensureServerEntryExports"])([
    getCompanyEmailProvider,
    setCompanyEmailProvider,
    getCompanyGmailTokens,
    refreshCompanyGmailToken,
    storeCompanyGmailTokens,
    disconnectCompanyGmail,
    sendCompanyGmailEmail,
    checkCompanyGmailHealth,
    getUserGmailTokens,
    refreshUserGmailToken,
    storeUserGmailTokens,
    disconnectUserGmail,
    fetchUserInbox,
    storeGmailMessage,
    syncUserInbox,
    isGmailIntegrationEnabled
]);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(getCompanyEmailProvider, "40b41f81fe9259fafce704bbd3935f68276fc4e2ca", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(setCompanyEmailProvider, "701eda529738b7cb8db9c89a5a499d69941ede094c", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(getCompanyGmailTokens, "40f32c0cfb7780293a18cf77271d2770c0d61fe547", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(refreshCompanyGmailToken, "60afa4f94f55ff80042f81a76c673e75545d27872d", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(storeCompanyGmailTokens, "7fa9d4af88bd605b13c48fb4e2937bda4ef2ce0a20", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(disconnectCompanyGmail, "4093292a46f282093734eae84e8bdd79e58274f64f", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(sendCompanyGmailEmail, "60666d082731fc0da1ea78000a7b22b3afbbc989b7", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(checkCompanyGmailHealth, "6028c8a328b5f7616873329b038fce472d56c751d5", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(getUserGmailTokens, "402e7af979456c6169a23490efd5611eedb77b7f8d", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(refreshUserGmailToken, "607bbb8ec456319d6f212db11b0dad6d62ec6e5cdc", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(storeUserGmailTokens, "7e684d0fcd64a86c227a3635ab611c4c140250b6fb", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(disconnectUserGmail, "40668734ac0715444771ef63df4ce2328f9e9144e1", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(fetchUserInbox, "70b8ccf02d177c82841b8a8e25abfece8615b480cf", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(storeGmailMessage, "78ce69226fb0c4303ba3e078a1534c86a000dbb744", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(syncUserInbox, "606b9ecbf77951fa1ec76cb2b2d919f43a5335a5f2", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(isGmailIntegrationEnabled, "0077b5d695a6e4bd1ec48ffe0a639d5f7737bedd9a", null);
}),
"[project]/apps/web/src/lib/email/email-provider.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Email Provider Abstraction Layer
 *
 * This module provides a unified interface for sending emails through multiple
 * providers (Resend and Postmark) with automatic fallback support.
 *
 * Architecture:
 * 
 *                     Email Provider Layer                         
 * 
 *   1. Try Primary Provider (Resend)                               
 *       Success  Return result, log to monitor                  
 *       Failure  Try Fallback                                   
 *   2. Try Fallback Provider (Postmark)                            
 *       Success  Return result, log to monitor                  
 *       Failure  Return error with both provider failures       
 * 
 *
 * Features:
 * - Automatic fallback when primary provider fails
 * - Health monitoring for both providers
 * - Unified response format
 * - Comprehensive logging for debugging
 * - Provider-agnostic interface for email operations
 *
 * Usage:
 * ```typescript
 * import { sendEmailWithFallback } from "@/lib/email/email-provider";
 *
 * const result = await sendEmailWithFallback({
 *   to: "user@example.com",
 *   subject: "Welcome!",
 *   html: "<h1>Hello</h1>",
 * });
 * ```
 */ __turbopack_context__.s([
    "checkAllProvidersHealth",
    ()=>checkAllProvidersHealth,
    "getBestAvailableProvider",
    ()=>getBestAvailableProvider,
    "getConfiguredProviders",
    ()=>getConfiguredProviders,
    "getProviderSetupInfo",
    ()=>getProviderSetupInfo,
    "isProviderConfigured",
    ()=>isProviderConfigured,
    "logProviderConfiguration",
    ()=>logProviderConfiguration,
    "providerConfig",
    ()=>providerConfig,
    "sendEmailWithFallback",
    ()=>sendEmailWithFallback
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$resend$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/resend-client.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$postmark$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/postmark-client.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$gmail$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/gmail-client.ts [app-route] (ecmascript)");
;
;
;
const providerConfig = {
    /** Primary provider - tried first */ primary: "resend",
    /** Fallback provider - used if primary fails */ fallback: "postmark",
    /** Enable automatic fallback on failure */ enableFallback: true,
    /** Log all provider operations for monitoring */ enableLogging: true,
    /** Retry count before falling back (0 = immediate fallback) */ primaryRetries: 0
};
function isProviderConfigured(provider) {
    switch(provider){
        case "resend":
            return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$resend$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isResendConfigured"])();
        case "postmark":
            return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$postmark$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isPostmarkConfigured"])();
        default:
            return false;
    }
}
function getConfiguredProviders() {
    const providers = [];
    if ((0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$resend$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isResendConfigured"])()) {
        providers.push("resend");
    }
    if ((0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$postmark$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isPostmarkConfigured"])()) {
        providers.push("postmark");
    }
    return providers;
}
function getBestAvailableProvider() {
    if (isProviderConfigured(providerConfig.primary)) {
        return providerConfig.primary;
    }
    if (providerConfig.enableFallback && isProviderConfigured(providerConfig.fallback)) {
        return providerConfig.fallback;
    }
    return null;
}
// =============================================================================
// EMAIL SENDING
// =============================================================================
/**
 * Send email via Resend
 *
 * @param options - Email options
 * @returns Send result
 */ async function sendViaResend(options) {
    if (!(0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$resend$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isResendConfigured"])() || !__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$resend$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["resend"]) {
        return {
            success: false,
            error: "Resend is not configured"
        };
    }
    try {
        // Build tags array for Resend
        const tags = [];
        if (options.tags) {
            for (const [name, value] of Object.entries(options.tags)){
                tags.push({
                    name,
                    value
                });
            }
        }
        if (options.communicationId) {
            tags.push({
                name: "communication_id",
                value: options.communicationId
            });
        }
        // Send via Resend
        const { data, error } = await __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$resend$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["resend"].emails.send({
            from: options.from || __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$resend$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["emailConfig"].from,
            to: options.to,
            subject: options.subject,
            html: options.html,
            text: options.text,
            replyTo: options.replyTo,
            tags: tags.length > 0 ? tags : undefined
        });
        if (error) {
            return {
                success: false,
                error: error.message || "Resend send failed"
            };
        }
        return {
            success: true,
            messageId: data?.id
        };
    } catch (error) {
        return {
            success: false,
            error: error instanceof Error ? error.message : "Resend send failed"
        };
    }
}
/**
 * Send email via Postmark
 *
 * @param options - Email options
 * @returns Send result
 */ async function sendViaPostmark(options) {
    if (!(0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$postmark$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isPostmarkConfigured"])()) {
        return {
            success: false,
            error: "Postmark is not configured"
        };
    }
    try {
        // Convert tags to Postmark metadata format
        const metadata = {
            ...options.tags
        };
        if (options.communicationId) {
            metadata.communication_id = options.communicationId;
        }
        if (options.companyId) {
            metadata.company_id = options.companyId;
        }
        // Determine tag (Postmark only supports one tag per email)
        const tag = options.tags?.template || options.tags?.type || "transactional";
        // Send via Postmark
        const result = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$postmark$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["sendPostmarkEmail"])({
            to: options.to,
            subject: options.subject,
            html: options.html,
            text: options.text,
            from: options.from || __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$postmark$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["postmarkConfig"].from,
            replyTo: options.replyTo,
            tag,
            metadata
        });
        if (!result.success) {
            return {
                success: false,
                error: result.error
            };
        }
        return {
            success: true,
            messageId: result.data.MessageID
        };
    } catch (error) {
        return {
            success: false,
            error: error instanceof Error ? error.message : "Postmark send failed"
        };
    }
}
/**
 * Send email via Gmail (company's connected Gmail account)
 *
 * @param companyId - Company ID with connected Gmail
 * @param options - Email options
 * @returns Send result
 */ async function sendViaGmail(companyId, options) {
    try {
        const result = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$gmail$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["sendCompanyGmailEmail"])(companyId, {
            to: options.to,
            subject: options.subject,
            html: options.html,
            text: options.text,
            replyTo: options.replyTo,
            cc: options.cc,
            bcc: options.bcc
        });
        if (!result.success) {
            return {
                success: false,
                error: result.error
            };
        }
        return {
            success: true,
            messageId: result.messageId
        };
    } catch (error) {
        return {
            success: false,
            error: error instanceof Error ? error.message : "Gmail send failed"
        };
    }
}
/**
 * Check if Gmail is available for a company
 *
 * @param companyId - Company ID to check
 * @returns Whether Gmail is available and configured
 */ async function isCompanyGmailAvailable(companyId) {
    try {
        // Check if Gmail integration is enabled globally
        if (!await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$gmail$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isGmailIntegrationEnabled"])()) {
            return false;
        }
        const tokens = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$gmail$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getCompanyGmailTokens"])(companyId);
        return tokens !== null && tokens.isValid;
    } catch  {
        return false;
    }
}
async function sendEmailWithFallback(options) {
    const attempts = [];
    const recipient = Array.isArray(options.to) ? options.to.join(", ") : options.to;
    // Log the send attempt
    if (providerConfig.enableLogging) {
        console.log(`[EmailProvider] Sending email to ${recipient}, subject: "${options.subject}"`);
    }
    // ==========================================================================
    // COMPANY EMAIL PROVIDER CHECK (Multi-Tenant)
    // ==========================================================================
    // Each company (tenant) can choose:
    // - 'managed': Use our Resend/Postmark providers
    // - 'gmail': Use their connected Gmail account
    // - 'disabled': Email is disabled for this company
    if (options.companyId) {
        const companyPreference = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$gmail$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getCompanyEmailProvider"])(options.companyId);
        // Handle disabled - company has turned off email
        if (companyPreference === "disabled") {
            if (providerConfig.enableLogging) {
                console.log(`[EmailProvider] Company ${options.companyId} has email disabled`);
            }
            return {
                success: false,
                error: "Email is disabled for this company",
                usedFallback: false,
                attempts: []
            };
        }
        // Handle Gmail preference
        if (companyPreference === "gmail") {
            const gmailAvailable = await isCompanyGmailAvailable(options.companyId);
            if (gmailAvailable) {
                const startTime = Date.now();
                if (providerConfig.enableLogging) {
                    console.log(`[EmailProvider] Company ${options.companyId} prefers Gmail, attempting Gmail send...`);
                }
                const result = await sendViaGmail(options.companyId, options);
                const latencyMs = Date.now() - startTime;
                attempts.push({
                    provider: "gmail",
                    success: result.success,
                    messageId: result.messageId,
                    error: result.error,
                    latencyMs
                });
                if (result.success) {
                    if (providerConfig.enableLogging) {
                        console.log(`[EmailProvider]  Gmail send succeeded in ${latencyMs}ms, messageId: ${result.messageId}`);
                    }
                    return {
                        success: true,
                        provider: "gmail",
                        messageId: result.messageId,
                        usedFallback: false,
                        attempts
                    };
                }
                // Gmail failed - fall through to managed providers
                if (providerConfig.enableLogging) {
                    console.warn(`[EmailProvider]  Gmail send failed in ${latencyMs}ms: ${result.error}`);
                    console.log("[EmailProvider] Falling back to managed providers...");
                }
            } else {
                if (providerConfig.enableLogging) {
                    console.log(`[EmailProvider] Company ${options.companyId} prefers Gmail but no valid tokens, using managed providers`);
                }
            }
        }
    }
    // ==========================================================================
    // MANAGED PROVIDERS: Primary (Resend)  Fallback (Postmark)
    // ==========================================================================
    // ==========================================================================
    // ATTEMPT 1: Primary Provider (Resend)
    // ==========================================================================
    if (isProviderConfigured(providerConfig.primary)) {
        const startTime = Date.now();
        if (providerConfig.enableLogging) {
            console.log(`[EmailProvider] Trying primary provider: ${providerConfig.primary}`);
        }
        const result = providerConfig.primary === "resend" ? await sendViaResend(options) : await sendViaPostmark(options);
        const latencyMs = Date.now() - startTime;
        attempts.push({
            provider: providerConfig.primary,
            success: result.success,
            messageId: result.messageId,
            error: result.error,
            latencyMs
        });
        // If primary succeeded, return immediately
        if (result.success) {
            if (providerConfig.enableLogging) {
                console.log(`[EmailProvider]  Primary provider succeeded in ${latencyMs}ms, messageId: ${result.messageId}`);
            }
            return {
                success: true,
                provider: providerConfig.primary,
                messageId: result.messageId,
                usedFallback: false,
                attempts
            };
        }
        // Primary failed
        if (providerConfig.enableLogging) {
            console.warn(`[EmailProvider]  Primary provider failed in ${latencyMs}ms: ${result.error}`);
        }
    } else {
        if (providerConfig.enableLogging) {
            console.warn(`[EmailProvider] Primary provider (${providerConfig.primary}) not configured`);
        }
    }
    // ==========================================================================
    // ATTEMPT 2: Fallback Provider (Postmark)
    // ==========================================================================
    if (providerConfig.enableFallback && isProviderConfigured(providerConfig.fallback)) {
        const startTime = Date.now();
        if (providerConfig.enableLogging) {
            console.log(`[EmailProvider] Trying fallback provider: ${providerConfig.fallback}`);
        }
        const result = providerConfig.fallback === "postmark" ? await sendViaPostmark(options) : await sendViaResend(options);
        const latencyMs = Date.now() - startTime;
        attempts.push({
            provider: providerConfig.fallback,
            success: result.success,
            messageId: result.messageId,
            error: result.error,
            latencyMs
        });
        // If fallback succeeded, return
        if (result.success) {
            if (providerConfig.enableLogging) {
                console.log(`[EmailProvider]  Fallback provider succeeded in ${latencyMs}ms, messageId: ${result.messageId}`);
            }
            return {
                success: true,
                provider: providerConfig.fallback,
                messageId: result.messageId,
                usedFallback: true,
                attempts
            };
        }
        // Fallback also failed
        if (providerConfig.enableLogging) {
            console.error(`[EmailProvider]  Fallback provider also failed in ${latencyMs}ms: ${result.error}`);
        }
    } else if (providerConfig.enableFallback) {
        if (providerConfig.enableLogging) {
            console.warn(`[EmailProvider] Fallback provider (${providerConfig.fallback}) not configured`);
        }
    }
    // ==========================================================================
    // ALL PROVIDERS FAILED
    // ==========================================================================
    const errors = attempts.map((a)=>`${a.provider}: ${a.error}`).join("; ");
    if (providerConfig.enableLogging) {
        console.error(`[EmailProvider]  All providers failed: ${errors}`);
    }
    return {
        success: false,
        error: `All email providers failed. ${errors}`,
        usedFallback: attempts.length > 1,
        attempts
    };
}
// =============================================================================
// HEALTH CHECKS
// =============================================================================
/**
 * Check health of Resend provider
 *
 * @returns Health status
 */ async function checkResendHealth() {
    const startTime = Date.now();
    if (!(0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$resend$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isResendConfigured"])() || !__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$resend$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["resend"]) {
        return {
            provider: "resend",
            healthy: false,
            latencyMs: 0,
            lastChecked: new Date(),
            error: "Resend is not configured"
        };
    }
    try {
        // Resend doesn't have a dedicated health endpoint
        // We'll list domains as a health check (lightweight operation)
        const response = await fetch("https://api.resend.com/domains", {
            method: "GET",
            headers: {
                Authorization: `Bearer ${process.env.RESEND_API_KEY}`,
                "Content-Type": "application/json"
            }
        });
        const latencyMs = Date.now() - startTime;
        if (response.ok) {
            console.log(`[EmailProvider] Resend health check passed in ${latencyMs}ms`);
            return {
                provider: "resend",
                healthy: true,
                latencyMs,
                lastChecked: new Date()
            };
        }
        const error = await response.text();
        console.error(`[EmailProvider] Resend health check failed: ${error}`);
        return {
            provider: "resend",
            healthy: false,
            latencyMs,
            lastChecked: new Date(),
            error: `HTTP ${response.status}: ${error}`
        };
    } catch (error) {
        const latencyMs = Date.now() - startTime;
        const errorMessage = error instanceof Error ? error.message : "Unknown error";
        console.error(`[EmailProvider] Resend health check error: ${errorMessage}`);
        return {
            provider: "resend",
            healthy: false,
            latencyMs,
            lastChecked: new Date(),
            error: errorMessage
        };
    }
}
async function checkAllProvidersHealth() {
    console.log("[EmailProvider] Checking health of all providers...");
    const results = {
        primary: null,
        fallback: null,
        recommendedProvider: null
    };
    // Check primary (Resend)
    if (isProviderConfigured("resend")) {
        results.primary = await checkResendHealth();
    }
    // Check fallback (Postmark)
    if (isProviderConfigured("postmark")) {
        const postmarkHealth = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$postmark$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["checkPostmarkHealth"])();
        results.fallback = {
            provider: "postmark",
            healthy: postmarkHealth.healthy,
            latencyMs: postmarkHealth.latencyMs,
            lastChecked: new Date(),
            error: postmarkHealth.error
        };
    }
    // Determine recommended provider based on health
    if (results.primary?.healthy) {
        results.recommendedProvider = "resend";
    } else if (results.fallback?.healthy) {
        results.recommendedProvider = "postmark";
    }
    console.log(`[EmailProvider] Health check complete. Primary: ${results.primary?.healthy ? "healthy" : "unhealthy"}, Fallback: ${results.fallback?.healthy ? "healthy" : "unhealthy"}, Recommended: ${results.recommendedProvider || "none"}`);
    return results;
}
function getProviderSetupInfo() {
    const primaryConfigured = isProviderConfigured(providerConfig.primary);
    const fallbackConfigured = isProviderConfigured(providerConfig.fallback);
    const configuredProviders = getConfiguredProviders();
    let status;
    if (primaryConfigured && fallbackConfigured) {
        status = "fully_configured";
    } else if (primaryConfigured) {
        status = "primary_only";
    } else if (fallbackConfigured) {
        status = "fallback_only";
    } else {
        status = "not_configured";
    }
    return {
        primaryConfigured,
        fallbackConfigured,
        fallbackEnabled: providerConfig.enableFallback,
        configuredProviders,
        status
    };
}
function logProviderConfiguration() {
    const info = getProviderSetupInfo();
    console.log("=".repeat(60));
    console.log("[EmailProvider] Configuration Summary");
    console.log("=".repeat(60));
    console.log(`Primary Provider: ${providerConfig.primary} (${info.primaryConfigured ? " configured" : " not configured"})`);
    console.log(`Fallback Provider: ${providerConfig.fallback} (${info.fallbackConfigured ? " configured" : " not configured"})`);
    console.log(`Fallback Enabled: ${info.fallbackEnabled ? "Yes" : "No"}`);
    console.log(`Status: ${info.status}`);
    console.log(`Configured Providers: ${info.configuredProviders.join(", ") || "none"}`);
    console.log("=".repeat(60));
}
}),
"[project]/apps/web/src/lib/email/provider-monitor.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/* __next_internal_action_entry_do_not_use__ [{"00faa648440817b6eb791efa3ac3f6799aadfc9c34":"getProviderHealthDashboard","409b5721717e9390fdc0497fb59a8e8288ce7e42eb":"recordProviderEvent","40e70ff533f92b7e4f1d73f0ee5ca1fb5976d2a7b7":"checkProviderAlert","40f62a25c31b2883789933798d9582364eb2054b33":"cleanupOldEvents","600d8ab2284910a9b02d01729982f3d70069af430f":"getProviderStats","781dfc9673db486fe6aca86ae42d62ed8772859573":"recordFallbackTriggered","784c581679ff185a1c20eb49054e2d9cb65647d043":"recordSendSuccess","7856b878a603663b87a02cbc0e54b6231beee483cb":"recordSendFailure"},"",""] */ __turbopack_context__.s([
    "checkProviderAlert",
    ()=>checkProviderAlert,
    "cleanupOldEvents",
    ()=>cleanupOldEvents,
    "getProviderHealthDashboard",
    ()=>getProviderHealthDashboard,
    "getProviderStats",
    ()=>getProviderStats,
    "recordFallbackTriggered",
    ()=>recordFallbackTriggered,
    "recordProviderEvent",
    ()=>recordProviderEvent,
    "recordSendFailure",
    ()=>recordSendFailure,
    "recordSendSuccess",
    ()=>recordSendSuccess
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/server-reference.js [app-route] (ecmascript)");
/**
 * Email Provider Monitor
 *
 * This module tracks the health and performance of email providers (Resend & Postmark).
 * It records every email send attempt and provides analytics for monitoring.
 *
 * Features:
 * - Track success/failure rates per provider
 * - Record latency metrics
 * - Store detailed error information
 * - Provide real-time health dashboards
 * - Alert on provider degradation
 *
 * Database Tables Used:
 * - email_provider_events: Individual send attempts
 * - email_provider_health: Aggregated health metrics (updated periodically)
 *
 * Usage:
 * ```typescript
 * // Record a successful send
 * await recordProviderEvent({
 *   provider: "resend",
 *   eventType: "send_success",
 *   messageId: "abc123",
 *   latencyMs: 150,
 * });
 *
 * // Get provider health stats
 * const stats = await getProviderStats("resend", "24h");
 * ```
 */ var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/database/src/service-client.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/action-validate.js [app-route] (ecmascript)");
;
;
async function recordProviderEvent(event) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        // Log to console for immediate visibility
        const logPrefix = event.eventType.includes("success") ? "" : "";
        console.log(`[ProviderMonitor] ${logPrefix} ${event.provider}:${event.eventType}` + (event.latencyMs ? ` (${event.latencyMs}ms)` : "") + (event.error ? ` - ${event.error}` : ""));
        // Insert event into database
        const { error } = await supabase.from("email_provider_events").insert({
            provider: event.provider,
            event_type: event.eventType,
            message_id: event.messageId || null,
            latency_ms: event.latencyMs || null,
            error_message: event.error || null,
            metadata: event.metadata || null,
            company_id: event.companyId || null,
            domain_id: event.domainId || null,
            created_at: new Date().toISOString()
        });
        if (error) {
            // Don't fail the main operation if monitoring fails
            console.error(`[ProviderMonitor] Failed to record event: ${error.message}`);
            return {
                success: false,
                error: error.message
            };
        }
        return {
            success: true
        };
    } catch (error) {
        // Monitoring should never break the main flow
        console.error(`[ProviderMonitor] Error recording event: ${error instanceof Error ? error.message : "Unknown error"}`);
        return {
            success: false,
            error: error instanceof Error ? error.message : "Unknown error"
        };
    }
}
async function recordSendSuccess(provider, messageId, latencyMs, options) {
    await recordProviderEvent({
        provider,
        eventType: "send_success",
        messageId,
        latencyMs,
        ...options
    });
}
async function recordSendFailure(provider, error, latencyMs, options) {
    await recordProviderEvent({
        provider,
        eventType: "send_failure",
        error,
        latencyMs,
        ...options
    });
}
async function recordFallbackTriggered(primaryProvider, fallbackProvider, primaryError, options) {
    await recordProviderEvent({
        provider: primaryProvider,
        eventType: "fallback_triggered",
        error: primaryError,
        metadata: {
            fallback_provider: fallbackProvider,
            ...options?.metadata
        },
        ...options
    });
}
async function getProviderStats(provider, period = "24h") {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        // Calculate start time based on period
        const now = new Date();
        const periodMs = {
            "1h": 60 * 60 * 1000,
            "24h": 24 * 60 * 60 * 1000,
            "7d": 7 * 24 * 60 * 60 * 1000,
            "30d": 30 * 24 * 60 * 60 * 1000
        };
        const startTime = new Date(now.getTime() - periodMs[period]).toISOString();
        // Query events for this provider and period
        const { data: events, error } = await supabase.from("email_provider_events").select("event_type, latency_ms, error_message, created_at").eq("provider", provider).gte("created_at", startTime).order("created_at", {
            ascending: false
        });
        if (error) {
            console.error(`[ProviderMonitor] Failed to get stats: ${error.message}`);
            return null;
        }
        if (!events || events.length === 0) {
            return {
                provider,
                period,
                totalEvents: 0,
                successCount: 0,
                failureCount: 0,
                successRate: 0,
                averageLatencyMs: 0,
                p95LatencyMs: 0,
                fallbackCount: 0,
                lastEventAt: null,
                lastError: null
            };
        }
        // Calculate statistics
        const sendEvents = events.filter((e)=>e.event_type === "send_success" || e.event_type === "send_failure");
        const successEvents = events.filter((e)=>e.event_type === "send_success");
        const failureEvents = events.filter((e)=>e.event_type === "send_failure");
        const fallbackEvents = events.filter((e)=>e.event_type === "fallback_triggered");
        // Calculate latency metrics
        const latencies = successEvents.map((e)=>e.latency_ms).filter((l)=>l !== null).sort((a, b)=>a - b);
        const avgLatency = latencies.length > 0 ? latencies.reduce((sum, l)=>sum + l, 0) / latencies.length : 0;
        const p95Index = Math.floor(latencies.length * 0.95);
        const p95Latency = latencies.length > 0 ? latencies[p95Index] || latencies[latencies.length - 1] : 0;
        // Find last error
        const lastFailure = failureEvents[0];
        return {
            provider,
            period,
            totalEvents: events.length,
            successCount: successEvents.length,
            failureCount: failureEvents.length,
            successRate: sendEvents.length > 0 ? successEvents.length / sendEvents.length * 100 : 0,
            averageLatencyMs: Math.round(avgLatency),
            p95LatencyMs: Math.round(p95Latency),
            fallbackCount: fallbackEvents.length,
            lastEventAt: events[0] ? new Date(events[0].created_at) : null,
            lastError: lastFailure?.error_message || null
        };
    } catch (error) {
        console.error(`[ProviderMonitor] Error getting stats: ${error instanceof Error ? error.message : "Unknown error"}`);
        return null;
    }
}
async function getProviderHealthDashboard() {
    console.log("[ProviderMonitor] Getting health dashboard data...");
    // Get stats for both providers
    const [resendStats, postmarkStats] = await Promise.all([
        getProviderStats("resend", "24h"),
        getProviderStats("postmark", "24h")
    ]);
    // Determine health status based on success rate
    const getStatus = (stats)=>{
        if (!stats || stats.totalEvents === 0) return "unknown";
        if (stats.successRate >= 99) return "healthy";
        if (stats.successRate >= 95) return "degraded";
        return "down";
    };
    // Calculate fallback rate
    const totalFallbacks = (resendStats?.fallbackCount || 0) + (postmarkStats?.fallbackCount || 0);
    const totalSends = (resendStats?.successCount || 0) + (resendStats?.failureCount || 0) + (postmarkStats?.successCount || 0) + (postmarkStats?.failureCount || 0);
    const fallbackRate = totalSends > 0 ? totalFallbacks / totalSends * 100 : 0;
    // Determine recommended action
    let recommendedAction;
    const resendStatus = getStatus(resendStats);
    const postmarkStatus = getStatus(postmarkStats);
    if (resendStatus === "down" && postmarkStatus === "down") {
        recommendedAction = "CRITICAL: Both providers are down. Check API keys and provider status.";
    } else if (resendStatus === "down") {
        recommendedAction = "Primary provider (Resend) is down. Traffic is using fallback.";
    } else if (fallbackRate > 10) {
        recommendedAction = "High fallback rate detected. Review primary provider health.";
    } else if (resendStatus === "degraded") {
        recommendedAction = "Primary provider showing degraded performance. Monitor closely.";
    }
    return {
        resend: {
            status: resendStatus,
            successRate24h: resendStats?.successRate || 0,
            avgLatencyMs: resendStats?.averageLatencyMs || 0,
            totalSent24h: resendStats?.successCount || 0,
            lastError: resendStats?.lastError || undefined,
            lastSuccessAt: resendStats?.lastEventAt || undefined
        },
        postmark: {
            status: postmarkStatus,
            successRate24h: postmarkStats?.successRate || 0,
            avgLatencyMs: postmarkStats?.averageLatencyMs || 0,
            totalSent24h: postmarkStats?.successCount || 0,
            lastError: postmarkStats?.lastError || undefined,
            lastSuccessAt: postmarkStats?.lastEventAt || undefined
        },
        overall: {
            primaryProvider: "resend",
            fallbackProvider: "postmark",
            fallbackRate24h: fallbackRate,
            recommendedAction
        }
    };
}
async function cleanupOldEvents(retentionDays = 30) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$service$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceSupabaseClient"])();
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
        const { data, error } = await supabase.from("email_provider_events").delete().lt("created_at", cutoffDate.toISOString()).select("id");
        if (error) {
            console.error(`[ProviderMonitor] Cleanup failed: ${error.message}`);
            return {
                deleted: 0,
                error: error.message
            };
        }
        const deletedCount = data?.length || 0;
        console.log(`[ProviderMonitor] Cleaned up ${deletedCount} events older than ${retentionDays} days`);
        return {
            deleted: deletedCount
        };
    } catch (error) {
        const errorMessage = error instanceof Error ? error.message : "Unknown error";
        console.error(`[ProviderMonitor] Cleanup error: ${errorMessage}`);
        return {
            deleted: 0,
            error: errorMessage
        };
    }
}
async function checkProviderAlert(provider) {
    const stats = await getProviderStats(provider, "1h");
    if (!stats) {
        return {
            shouldAlert: false,
            severity: "info"
        };
    }
    // No events in the last hour - might be expected during low traffic
    if (stats.totalEvents === 0) {
        return {
            shouldAlert: false,
            severity: "info"
        };
    }
    // Critical: Success rate below 90%
    if (stats.successRate < 90) {
        return {
            shouldAlert: true,
            severity: "critical",
            reason: `${provider} success rate is ${stats.successRate.toFixed(1)}% (below 90%)`
        };
    }
    // Warning: Success rate below 99%
    if (stats.successRate < 99) {
        return {
            shouldAlert: true,
            severity: "warning",
            reason: `${provider} success rate is ${stats.successRate.toFixed(1)}% (below 99%)`
        };
    }
    // Warning: High latency
    if (stats.averageLatencyMs > 5000) {
        return {
            shouldAlert: true,
            severity: "warning",
            reason: `${provider} average latency is ${stats.averageLatencyMs}ms (above 5s)`
        };
    }
    return {
        shouldAlert: false,
        severity: "info"
    };
}
;
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ensureServerEntryExports"])([
    recordProviderEvent,
    recordSendSuccess,
    recordSendFailure,
    recordFallbackTriggered,
    getProviderStats,
    getProviderHealthDashboard,
    cleanupOldEvents,
    checkProviderAlert
]);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(recordProviderEvent, "409b5721717e9390fdc0497fb59a8e8288ce7e42eb", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(recordSendSuccess, "784c581679ff185a1c20eb49054e2d9cb65647d043", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(recordSendFailure, "7856b878a603663b87a02cbc0e54b6231beee483cb", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(recordFallbackTriggered, "781dfc9673db486fe6aca86ae42d62ed8772859573", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(getProviderStats, "600d8ab2284910a9b02d01729982f3d70069af430f", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(getProviderHealthDashboard, "00faa648440817b6eb791efa3ac3f6799aadfc9c34", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(cleanupOldEvents, "40f62a25c31b2883789933798d9582364eb2054b33", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(checkProviderAlert, "40e70ff533f92b7e4f1d73f0ee5ca1fb5976d2a7b7", null);
}),
"[project]/apps/web/src/lib/email/email-sender.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

return __turbopack_context__.a(async (__turbopack_handle_async_dependencies__, __turbopack_async_result__) => { try {

/**
 * Email Sender - Type-safe email sending utilities
 *
 * CRITICAL RULE - Reply-To Addresses:
 * ====================================
 * Reply-to ALWAYS uses the company's platform subdomain (mail.thorbis.com),
 * regardless of which email provider or sending method is used.
 *
 * Examples:
 * - FROM: notifications@acme.mail.thorbis.com  REPLY-TO: support@acme.mail.thorbis.com
 * - FROM: notifications@acme-plumbing.com (custom)  REPLY-TO: support@acme.mail.thorbis.com
 * - FROM: john@gmail.com (personal)  REPLY-TO: support@acme.mail.thorbis.com
 *
 * See: /docs/email/REPLY_TO_ARCHITECTURE.md for full details
 *
 * Features:
 * - Type-safe email sending with validation
 * - Development mode logging
 * - Error handling and logging
 * - Email logging to database
 * - Retry logic for failed sends
 * - Per-company rate limiting
 * - Deliverability monitoring
 */ /* __next_internal_action_entry_do_not_use__ [{"4045fd66fd12d1ad15f17f3d1f2568de874cc6fe03":"sendEmail","60f3c70ab599823c9a6057a8809a3f49da02ad41ca":"handleComplaintWebhook","786c50dbddde0ade87252ff3556bd12a05815d3db8":"handleBounceWebhook"},"",""] */ __turbopack_context__.s([
    "handleBounceWebhook",
    ()=>handleBounceWebhook,
    "handleComplaintWebhook",
    ()=>handleComplaintWebhook,
    "sendEmail",
    ()=>sendEmail
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/server-reference.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$render$40$1$2e$4$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$render$2f$dist$2f$node$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+render@1.4.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/@react-email/render/dist/node/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/zod@4.1.12/node_modules/zod/v4/classic/external.js [app-route] (ecmascript) <export * as z>");
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/database/src/server.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$deliverability$2d$monitor$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/deliverability-monitor.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$email$2d$types$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/email-types.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$pre$2d$send$2d$checks$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/pre-send-checks.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$rate$2d$limiter$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/rate-limiter.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$resend$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/resend-client.ts [app-route] (ecmascript)");
// =============================================================================
// MULTI-PROVIDER SUPPORT (Resend primary, Postmark fallback)
// =============================================================================
// Provider abstraction layer - handles automatic fallback when primary fails
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$email$2d$provider$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/email-provider.ts [app-route] (ecmascript)");
// Provider monitoring - tracks success rates, latency for both providers
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$provider$2d$monitor$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/provider-monitor.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/action-validate.js [app-route] (ecmascript)");
var __turbopack_async_dependencies__ = __turbopack_handle_async_dependencies__([
    __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$render$40$1$2e$4$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$render$2f$dist$2f$node$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__
]);
[__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$render$40$1$2e$4$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$render$2f$dist$2f$node$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__] = __turbopack_async_dependencies__.then ? (await __turbopack_async_dependencies__)() : __turbopack_async_dependencies__;
;
;
;
;
;
;
;
;
;
;
;
async function sendEmail({ to, subject, template, templateType, replyTo, tags = [], companyId, communicationId, fromOverride, cc, bcc, attachments, isMarketingEmail = false, skipPreSendChecks = false, textContent = "", unsubscribeUrl, listId }) {
    let activeDomainId = null;
    let companyReplyTo = null;
    let activeDomain = null;
    try {
        // In development, log email instead of sending
        if (__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$resend$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["emailConfig"].isDevelopment) {
            return {
                success: true,
                data: {
                    id: `dev-mode-${Date.now()}`,
                    message: "Email logged in development mode (not actually sent)"
                }
            };
        }
        // Check if at least one email provider is configured
        // We support Resend (primary) and Postmark (fallback)
        const providerInfo = (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$email$2d$provider$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getProviderSetupInfo"])();
        if (providerInfo.status === "not_configured") {
            return {
                success: false,
                error: "Email service not configured. Please add RESEND_API_KEY or POSTMARK_API_KEY to environment variables."
            };
        }
        console.log(`[EmailSender] Providers available: ${providerInfo.configuredProviders.join(", ")} (status: ${providerInfo.status})`);
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        // Fetch company email domain to get reply-to configuration
        if (companyId) {
            activeDomain = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$rate$2d$limiter$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getCompanyActiveDomain"])(companyId);
            if (!activeDomain) {
                return {
                    success: false,
                    error: "No active email domain configured for this company. Please set up email in settings."
                };
            }
            activeDomainId = activeDomain.domainId;
            // Set reply-to from company's domain configuration
            // If not set, construct default using the company's domain (e.g., support@acme.mail.thorbis.com)
            // This ensures all replies go to the same branded subdomain as the FROM address
            if (activeDomain.replyToEmail) {
                companyReplyTo = activeDomain.replyToEmail;
            } else {
                // Default to support@{company-domain}
                companyReplyTo = `support@${activeDomain.domain}`;
            }
        }
        // Determine final reply-to address
        // Priority: 1) Explicit replyTo parameter, 2) Company's configured reply-to, 3) None
        const finalReplyTo = replyTo || companyReplyTo || undefined;
        // Validate email data (now with proper reply-to)
        const validatedData = __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$email$2d$types$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["emailSendSchema"].parse({
            to,
            subject,
            replyTo: finalReplyTo
        });
        // Normalize recipient list
        const recipientEmails = Array.isArray(validatedData.to) ? validatedData.to : [
            validatedData.to
        ];
        // Check rate limits and run pre-send checks if companyId is provided
        if (companyId && activeDomainId) {
            // Check rate limit before incrementing
            const rateLimitCheck = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$rate$2d$limiter$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["checkRateLimit"])(activeDomain.domainId);
            if (!rateLimitCheck.allowed) {
                return {
                    success: false,
                    error: rateLimitCheck.reason || "Rate limit exceeded"
                };
            }
            // Run pre-send deliverability checks (unless skipped for system emails)
            if (!skipPreSendChecks) {
                // Render template early to get HTML for spam check
                const preCheckHtml = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$render$40$1$2e$4$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$render$2f$dist$2f$node$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["render"])(template);
                const plainText = textContent || extractTextFromHtml(preCheckHtml);
                const preSendResult = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$pre$2d$send$2d$checks$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["runPreSendChecks"])(companyId, activeDomain.domainId, recipientEmails, subject, preCheckHtml, plainText, isMarketingEmail);
                // Block if there are critical errors
                if (!preSendResult.allowed) {
                    return {
                        success: false,
                        error: `Deliverability check failed: ${preSendResult.errors.join("; ")}`,
                        data: {
                            spamScore: preSendResult.spamScore,
                            warnings: preSendResult.warnings,
                            suggestions: preSendResult.suggestions
                        }
                    };
                }
                // Filter out suppressed recipients
                const activeRecipients = recipientEmails.filter((email)=>{
                    const status = preSendResult.recipientStatus?.find((r)=>r.email.toLowerCase() === email.toLowerCase());
                    return !status?.suppressed;
                });
                if (activeRecipients.length === 0) {
                    return {
                        success: false,
                        error: "All recipients are on suppression list - no emails sent"
                    };
                }
                // Update validated data with filtered recipients
                if (activeRecipients.length < recipientEmails.length) {
                    validatedData.to = activeRecipients.length === 1 ? activeRecipients[0] : activeRecipients;
                }
                // Log warnings if any (but still send)
                if (preSendResult.warnings.length > 0) {
                    console.warn("[Email Deliverability Warnings]", preSendResult.warnings);
                }
            } else {
                // Even for system emails, check suppression list
                const suppressions = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$pre$2d$send$2d$checks$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["checkSuppressionList"])(companyId, recipientEmails);
                const activeRecipients = recipientEmails.filter((email)=>{
                    const status = suppressions.get(email.toLowerCase());
                    return !status?.suppressed;
                });
                if (activeRecipients.length === 0) {
                    return {
                        success: false,
                        error: "All recipients are on suppression list"
                    };
                }
                if (activeRecipients.length < recipientEmails.length) {
                    validatedData.to = activeRecipients.length === 1 ? activeRecipients[0] : activeRecipients;
                }
            }
            // Increment the counter (this also validates limits atomically)
            const incrementResult = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$rate$2d$limiter$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["incrementEmailCounter"])(activeDomain.domainId);
            if (!incrementResult.allowed) {
                return {
                    success: false,
                    error: incrementResult.reason || "Rate limit exceeded"
                };
            }
        }
        // Determine from identity
        let fromAddress = fromOverride || __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$resend$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["emailConfig"].from;
        if (companyId && supabase) {
            const override = await getCompanyEmailIdentity(supabase, companyId);
            if (override) {
                fromAddress = override;
            }
        }
        // Render template to HTML
        let html = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$render$40$1$2e$4$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$render$2f$dist$2f$node$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["render"])(template);
        // Add email tracking if communicationId is provided
        if (communicationId) {
            const { addEmailTracking } = await __turbopack_context__.A("[project]/apps/web/src/lib/email/email-tracking.ts [app-route] (ecmascript, async loader)");
            html = addEmailTracking(html, communicationId);
        }
        const sendTags = [
            ...tags,
            {
                name: "template",
                value: templateType
            },
            {
                name: "environment",
                value: ("TURBOPACK compile-time value", "development") || "development"
            }
        ];
        if (communicationId) {
            sendTags.push({
                name: "communication_id",
                value: communicationId
            });
        }
        // Add company_id tag for webhook suppression list tracking
        if (companyId) {
            sendTags.push({
                name: "company_id",
                value: companyId
            });
        }
        // Build enhanced headers for better deliverability
        const emailHeaders = {
            // Precedence helps identify transactional vs marketing
            "X-Priority": "3",
            "X-Mailer": "Stratos Email System"
        };
        // Add List-Unsubscribe header for marketing emails (RFC 2369 compliance)
        if (isMarketingEmail && unsubscribeUrl) {
            emailHeaders["List-Unsubscribe"] = `<${unsubscribeUrl}>`;
            emailHeaders["List-Unsubscribe-Post"] = "List-Unsubscribe=One-Click";
        }
        // Add List-Id for mailing lists (helps with filtering)
        if (listId) {
            emailHeaders["List-Id"] = listId;
        }
        // Auto-Submitted header for transactional/automated emails
        if (!isMarketingEmail) {
            emailHeaders["Auto-Submitted"] = "auto-generated";
            emailHeaders["Precedence"] = "bulk"; // Prevents auto-replies
        }
        // =======================================================================
        // SEND EMAIL VIA PROVIDER LAYER (Resend  Postmark fallback)
        // =======================================================================
        // Convert tags to Record format for provider layer
        const tagsRecord = {};
        for (const tag of sendTags){
            tagsRecord[tag.name] = tag.value;
        }
        // Track timing for monitoring
        const sendStartTime = Date.now();
        // Send via provider layer (tries Resend first, then Postmark if Resend fails)
        const providerResult = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$email$2d$provider$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["sendEmailWithFallback"])({
            to: validatedData.to,
            subject: validatedData.subject,
            html,
            text: textContent || extractTextFromHtml(html),
            from: fromAddress,
            replyTo: validatedData.replyTo,
            tags: tagsRecord,
            communicationId,
            companyId,
            cc,
            bcc,
            attachments
        });
        const sendLatencyMs = Date.now() - sendStartTime;
        // =======================================================================
        // RECORD PROVIDER MONITORING EVENTS
        // =======================================================================
        // Track success/failure for each provider attempt (for health dashboard)
        for (const attempt of providerResult.attempts){
            if (attempt.success) {
                await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$provider$2d$monitor$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["recordSendSuccess"])(attempt.provider, attempt.messageId || "", attempt.latencyMs, {
                    companyId,
                    domainId: activeDomainId || undefined,
                    metadata: {
                        template: templateType
                    }
                });
            } else {
                await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$provider$2d$monitor$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["recordSendFailure"])(attempt.provider, attempt.error || "Unknown error", attempt.latencyMs, {
                    companyId,
                    domainId: activeDomainId || undefined,
                    metadata: {
                        template: templateType
                    }
                });
            }
        }
        // Record if fallback was triggered
        if (providerResult.usedFallback && providerResult.success) {
            const primaryAttempt = providerResult.attempts.find((a)=>a.provider === "resend");
            await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$provider$2d$monitor$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["recordFallbackTriggered"])("resend", "postmark", primaryAttempt?.error || "Primary failed", {
                companyId,
                metadata: {
                    template: templateType
                }
            });
            console.log(`[EmailSender] Used Postmark fallback after Resend failed: ${primaryAttempt?.error}`);
        }
        // =======================================================================
        // HANDLE RESULT
        // =======================================================================
        if (providerResult.success) {
            // SUCCESS: Email sent via one of the providers
            console.log(`[EmailSender]  Email sent via ${providerResult.provider}${providerResult.usedFallback ? " (fallback)" : ""} in ${sendLatencyMs}ms`);
            // Log successful email to database
            try {
                if (supabase) {
                    await supabase.from("email_logs").insert({
                        to: Array.isArray(validatedData.to) ? validatedData.to.join(", ") : validatedData.to,
                        from: fromAddress,
                        subject: validatedData.subject,
                        html_body: html,
                        status: "sent",
                        message_id: providerResult.messageId,
                        company_id: companyId || null,
                        metadata: {
                            template: templateType,
                            tags: sendTags,
                            provider: providerResult.provider,
                            usedFallback: providerResult.usedFallback,
                            latencyMs: sendLatencyMs
                        },
                        sent_at: new Date().toISOString()
                    });
                }
            } catch (_logError) {
            // Don't throw - email was sent successfully even if logging failed
            }
            // Record delivered event for deliverability tracking
            // Note: This is an optimistic record; actual delivery confirmation comes via webhook
            if (activeDomainId) {
                try {
                    await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$deliverability$2d$monitor$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["recordDeliveryEvent"])({
                        domainId: activeDomainId,
                        eventType: "delivered",
                        emailId: providerResult.messageId,
                        metadata: {
                            template: templateType,
                            provider: providerResult.provider
                        }
                    });
                } catch (_deliverabilityError) {
                // Don't fail the overall operation
                }
            }
            return {
                success: true,
                data: {
                    id: providerResult.messageId,
                    message: `Email sent successfully via ${providerResult.provider}${providerResult.usedFallback ? " (fallback)" : ""}`
                }
            };
        } else {
            // FAILURE: All providers failed
            console.error(`[EmailSender]  All providers failed: ${providerResult.error}`);
            // Log failed email to database for retry queue
            try {
                if (supabase) {
                    await supabase.from("email_logs").insert({
                        to: Array.isArray(validatedData.to) ? validatedData.to.join(", ") : validatedData.to,
                        from: fromAddress,
                        subject: validatedData.subject,
                        html_body: html,
                        status: "failed",
                        error_message: providerResult.error || "All providers failed",
                        company_id: companyId || null,
                        metadata: {
                            template: templateType,
                            tags: sendTags,
                            attempts: providerResult.attempts,
                            latencyMs: sendLatencyMs
                        },
                        retry_count: 0,
                        max_retries: 3,
                        next_retry_at: new Date(Date.now() + 5 * 60 * 1000).toISOString()
                    });
                }
            } catch (_logError) {}
            // Record bounce event for deliverability tracking
            if (activeDomainId) {
                try {
                    await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$deliverability$2d$monitor$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["recordDeliveryEvent"])({
                        domainId: activeDomainId,
                        eventType: "bounced",
                        metadata: {
                            error: providerResult.error,
                            template: templateType,
                            attempts: providerResult.attempts.length
                        }
                    });
                } catch (_deliverabilityError) {
                // Don't fail the overall operation
                }
            }
            return {
                success: false,
                error: providerResult.error || "Failed to send email (all providers failed)"
            };
        }
    } catch (error) {
        if (error instanceof __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].ZodError) {
            return {
                success: false,
                error: error.issues[0]?.message || "Invalid email data"
            };
        }
        return {
            success: false,
            error: error instanceof Error ? error.message : "Failed to send email"
        };
    }
}
/**
 * Send batch emails (up to 100 at once per Resend limits)
 *
 * Features:
 * - Validates batch size
 * - Sends multiple emails
 * - Returns results for each email
 */ async function sendBatchEmails(emails) {
    if (emails.length > 100) {
        return [
            {
                success: false,
                error: "Cannot send more than 100 emails at once"
            }
        ];
    }
    const results = await Promise.all(emails.map((email)=>sendEmail(email)));
    return results;
}
/**
 * Test email configuration by sending a test email
 *
 * Features:
 * - Validates Resend configuration
 * - Sends test email to specified address
 * - Returns detailed error information
 */ async function testEmailConfiguration(testEmailAddress) {
    try {
        const validatedEmail = __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$email$2d$types$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["emailSendSchema"].shape.to.parse(testEmailAddress);
        if (!(0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$resend$2d$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isResendConfigured"])()) {
            return {
                success: false,
                error: "Resend API key is not configured"
            };
        }
        // Create a simple test template
        const testTemplate = {
            type: "div",
            props: {
                children: [
                    {
                        type: "h1",
                        props: {
                            children: "Email Configuration Test"
                        }
                    },
                    {
                        type: "p",
                        props: {
                            children: "This is a test email from your Thorbis application."
                        }
                    },
                    {
                        type: "p",
                        props: {
                            children: "If you received this, your email configuration is working correctly!"
                        }
                    }
                ]
            }
        };
        return await sendEmail({
            to: validatedEmail,
            subject: "Test Email - Thorbis Email Configuration",
            template: testTemplate,
            templateType: "welcome",
            tags: [
                {
                    name: "type",
                    value: "test"
                }
            ]
        });
    } catch (error) {
        if (error instanceof __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].ZodError) {
            return {
                success: false,
                error: "Invalid email address"
            };
        }
        return {
            success: false,
            error: error instanceof Error ? error.message : "Configuration test failed"
        };
    }
}
async function getCompanyEmailIdentity(supabase, companyId) {
    // Get company name first
    const { data: company } = await supabase.from("companies").select("name").eq("id", companyId).single();
    const companyName = company?.name || "Notification";
    // Check company_email_domains table for active sending domain
    // Prioritizes custom domains over platform subdomains
    const { data: domain } = await supabase.from("company_email_domains").select("domain_name, is_platform_subdomain").eq("company_id", companyId).eq("status", "verified").eq("sending_enabled", true).eq("is_suspended", false).order("is_platform_subdomain", {
        ascending: true
    }) // Custom domains first
    .order("created_at", {
        ascending: false
    }).maybeSingle();
    if (domain?.domain_name) {
        // domain_name contains the full domain (e.g., company.mail.stratos.app or mail.custom.com)
        return formatFromAddress(companyName, `notifications@${domain.domain_name}`);
    }
    // Fallback: Check old communication_email_settings (legacy)
    const { data: settings } = await supabase.from("communication_email_settings").select("smtp_from_email, smtp_from_name").eq("company_id", companyId).maybeSingle();
    if (settings?.smtp_from_email) {
        return formatFromAddress(settings.smtp_from_name, settings.smtp_from_email);
    }
    return null;
}
function formatFromAddress(name, email) {
    if (name?.trim()) {
        return `${name} <${email}>`;
    }
    return email;
}
/**
 * Extract plain text from HTML for spam scoring and multipart emails
 */ function extractTextFromHtml(html) {
    // Remove script and style tags with their content
    let text = html.replace(/<script[^>]*>[\s\S]*?<\/script>/gi, "");
    text = text.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, "");
    // Replace block elements with newlines
    text = text.replace(/<\/(p|div|h[1-6]|li|br|tr)>/gi, "\n");
    text = text.replace(/<(br|hr)\s*\/?>/gi, "\n");
    // Remove all remaining HTML tags
    text = text.replace(/<[^>]+>/g, " ");
    // Decode common HTML entities
    text = text.replace(/&nbsp;/gi, " ").replace(/&amp;/gi, "&").replace(/&lt;/gi, "<").replace(/&gt;/gi, ">").replace(/&quot;/gi, '"').replace(/&#39;/gi, "'").replace(/&mdash;/gi, "").replace(/&ndash;/gi, "");
    // Clean up whitespace
    text = text.replace(/\s+/g, " ").trim();
    text = text.replace(/\n\s*\n/g, "\n\n"); // Multiple newlines to double
    return text;
}
async function handleBounceWebhook(companyId, email, bounceType, bounceReason) {
    // Import here to avoid circular dependency
    const { addToSuppressionList, addToGlobalBounceList } = await __turbopack_context__.A("[project]/apps/web/src/lib/email/pre-send-checks.ts [app-route] (ecmascript, async loader)");
    // Add to company suppression list for hard bounces
    if (bounceType === "hard") {
        await addToSuppressionList(companyId, email, "bounce", bounceReason);
    }
    // Add to global bounce list (hard bounces only)
    await addToGlobalBounceList(email, bounceType, bounceReason);
}
async function handleComplaintWebhook(companyId, email) {
    const { addToSuppressionList } = await __turbopack_context__.A("[project]/apps/web/src/lib/email/pre-send-checks.ts [app-route] (ecmascript, async loader)");
    // Always suppress on complaint - user marked as spam
    await addToSuppressionList(companyId, email, "complaint", "User reported email as spam");
}
;
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ensureServerEntryExports"])([
    sendEmail,
    handleBounceWebhook,
    handleComplaintWebhook
]);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(sendEmail, "4045fd66fd12d1ad15f17f3d1f2568de874cc6fe03", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(handleBounceWebhook, "786c50dbddde0ade87252ff3556bd12a05815d3db8", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(handleComplaintWebhook, "60f3c70ab599823c9a6057a8809a3f49da02ad41ca", null);
__turbopack_async_result__();
} catch(e) { __turbopack_async_result__(e); } }, false);}),
"[project]/apps/web/src/lib/errors/action-error.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Action Error Class & Error Codes
 *
 * Provides standardized error handling for Server Actions with:
 * - Error codes for categorization
 * - HTTP status codes for API responses
 * - Detailed error messages
 * - Optional error details/context
 */ /**
 * Error Code Constants
 *
 * Organized by category for easy management and consistent error handling
 */ __turbopack_context__.s([
    "ActionError",
    ()=>ActionError,
    "ERROR_CODES",
    ()=>ERROR_CODES,
    "ERROR_MESSAGES",
    ()=>ERROR_MESSAGES
]);
const ERROR_CODES = {
    // Authentication & Authorization
    AUTH_UNAUTHORIZED: "AUTH_UNAUTHORIZED",
    AUTH_FORBIDDEN: "AUTH_FORBIDDEN",
    AUTH_TOKEN_EXPIRED: "AUTH_TOKEN_EXPIRED",
    AUTH_TOKEN_INVALID: "AUTH_TOKEN_INVALID",
    AUTH_EMAIL_NOT_VERIFIED: "AUTH_EMAIL_NOT_VERIFIED",
    // Validation
    VALIDATION_FAILED: "VALIDATION_FAILED",
    VALIDATION_REQUIRED_FIELD: "VALIDATION_REQUIRED_FIELD",
    VALIDATION_INVALID_FORMAT: "VALIDATION_INVALID_FORMAT",
    VALIDATION_OUT_OF_RANGE: "VALIDATION_OUT_OF_RANGE",
    // Database
    DB_RECORD_NOT_FOUND: "DB_RECORD_NOT_FOUND",
    DB_DUPLICATE_ENTRY: "DB_DUPLICATE_ENTRY",
    DB_CONSTRAINT_VIOLATION: "DB_CONSTRAINT_VIOLATION",
    DB_FOREIGN_KEY_VIOLATION: "DB_FOREIGN_KEY_VIOLATION",
    DB_CONNECTION_ERROR: "DB_CONNECTION_ERROR",
    DB_QUERY_ERROR: "DB_QUERY_ERROR",
    DB_INSERT_ERROR: "DB_INSERT_ERROR",
    DB_UPDATE_ERROR: "DB_UPDATE_ERROR",
    // Business Logic
    BUSINESS_RULE_VIOLATION: "BUSINESS_RULE_VIOLATION",
    INSUFFICIENT_PERMISSIONS: "INSUFFICIENT_PERMISSIONS",
    OPERATION_NOT_ALLOWED: "OPERATION_NOT_ALLOWED",
    RESOURCE_LOCKED: "RESOURCE_LOCKED",
    RESOURCE_DELETED: "RESOURCE_DELETED",
    // External Services
    SERVICE_UNAVAILABLE: "SERVICE_UNAVAILABLE",
    SERVICE_TIMEOUT: "SERVICE_TIMEOUT",
    SERVICE_RATE_LIMIT: "SERVICE_RATE_LIMIT",
    SERVICE_INTEGRATION_ERROR: "SERVICE_INTEGRATION_ERROR",
    EXTERNAL_API_ERROR: "EXTERNAL_API_ERROR",
    // File Operations
    FILE_NOT_FOUND: "FILE_NOT_FOUND",
    FILE_TOO_LARGE: "FILE_TOO_LARGE",
    FILE_INVALID_TYPE: "FILE_INVALID_TYPE",
    FILE_UPLOAD_FAILED: "FILE_UPLOAD_FAILED",
    // Payment & Financial
    PAYMENT_FAILED: "PAYMENT_FAILED",
    PAYMENT_DECLINED: "PAYMENT_DECLINED",
    PAYMENT_INSUFFICIENT_FUNDS: "PAYMENT_INSUFFICIENT_FUNDS",
    PAYMENT_INVALID_AMOUNT: "PAYMENT_INVALID_AMOUNT",
    PAYMENT_ALREADY_REFUNDED: "PAYMENT_ALREADY_REFUNDED",
    PAYMENT_CANNOT_REFUND: "PAYMENT_CANNOT_REFUND",
    // Generic
    UNKNOWN_ERROR: "UNKNOWN_ERROR",
    INTERNAL_SERVER_ERROR: "INTERNAL_SERVER_ERROR",
    BAD_REQUEST: "BAD_REQUEST",
    NOT_IMPLEMENTED: "NOT_IMPLEMENTED",
    UNAUTHORIZED: "UNAUTHORIZED",
    NOT_FOUND: "NOT_FOUND",
    CONFLICT: "CONFLICT",
    EXPIRED: "EXPIRED",
    VALIDATION_ERROR: "VALIDATION_ERROR"
};
class ActionError extends Error {
    code;
    statusCode;
    details;
    constructor(message, code = ERROR_CODES.UNKNOWN_ERROR, statusCode = 400, details){
        super(message), this.code = code, this.statusCode = statusCode, this.details = details;
        this.name = "ActionError";
        // Maintains proper stack trace for where error was thrown (V8 only)
        if (Error.captureStackTrace) {
            Error.captureStackTrace(this, ActionError);
        }
    }
    /**
	 * Convert error to a plain object suitable for API responses
	 */ toJSON() {
        return {
            success: false,
            error: this.message,
            code: this.code,
            statusCode: this.statusCode,
            ...this.details && {
                details: this.details
            }
        };
    }
    /**
	 * Create ActionError from unknown error
	 */ static fromUnknown(error) {
        if (error instanceof ActionError) {
            return error;
        }
        if (error instanceof Error) {
            return new ActionError(error.message, ERROR_CODES.INTERNAL_SERVER_ERROR, 500);
        }
        return new ActionError("An unexpected error occurred", ERROR_CODES.UNKNOWN_ERROR, 500);
    }
}
const ERROR_MESSAGES = {
    // Authentication
    unauthorized: ()=>"You must be logged in to perform this action",
    forbidden: (resource)=>`You don't have permission to access this ${resource}`,
    emailNotVerified: ()=>"Please verify your email before continuing",
    // Validation
    requiredField: (field)=>`${field} is required`,
    invalidFormat: (field)=>`${field} has an invalid format`,
    outOfRange: (field, min, max)=>`${field} must be between ${min} and ${max}`,
    // Database
    notFound: (resource)=>`${resource} not found`,
    alreadyExists: (resource)=>`${resource} already exists`,
    cannotDelete: (resource, reason)=>`Cannot delete ${resource}: ${reason}`,
    // Business Logic
    insufficientFunds: ()=>"Insufficient funds for this transaction",
    cannotRefund: (reason)=>`Cannot process refund: ${reason}`,
    resourceLocked: (resource)=>`${resource} is currently being modified by another user`,
    // Generic
    operationFailed: (operation)=>`Failed to ${operation}`,
    serviceUnavailable: (service)=>`${service} is currently unavailable`
};
}),
"[project]/apps/web/src/lib/errors/with-error-handling.ts [app-route] (ecmascript) <locals>", ((__turbopack_context__) => {
"use strict";

/**
 * Error Handling Wrapper for Server Actions
 *
 * Provides consistent error handling, logging, and response formatting
 * for all Server Actions in the application.
 */ __turbopack_context__.s([
    "assertAuthenticated",
    ()=>assertAuthenticated,
    "assertExists",
    ()=>assertExists,
    "assertSupabase",
    ()=>assertSupabase,
    "withErrorHandling",
    ()=>withErrorHandling
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$errors$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/zod@4.1.12/node_modules/zod/v4/classic/errors.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/errors/action-error.ts [app-route] (ecmascript)");
;
;
;
async function withErrorHandling(fn) {
    try {
        const data = await fn();
        return {
            success: true,
            data
        };
    } catch (error) {
        // Handle ActionError (our custom errors)
        if (error instanceof __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]) {
            // Log authorization errors as warnings since they're expected in some cases
            // (e.g., user not part of a company, insufficient permissions)
            const isExpectedAuthError = error.code === __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN || error.code === __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_UNAUTHORIZED;
            if (isExpectedAuthError) {
                // Only log in development, or as a warning
                if ("TURBOPACK compile-time truthy", 1) {
                    console.debug(`[Auth] Expected auth error: ${error.code} - ${error.message}`);
                }
            } else {
                console.error(`[Action Error] ${error.code}: ${error.message}`);
            }
            return {
                success: false,
                error: error.message,
                code: error.code,
                ...error.details && {
                    details: error.details
                }
            };
        }
        // Handle Zod validation errors
        if (error instanceof __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$errors$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ZodError"]) {
            return {
                success: false,
                error: error.issues[0]?.message || "Validation failed",
                code: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].VALIDATION_FAILED,
                details: {
                    issues: error.issues.map((issue)=>({
                            field: issue.path.join("."),
                            message: issue.message
                        }))
                }
            };
        }
        // Handle standard JavaScript errors
        if (error instanceof Error) {
            return {
                success: false,
                error: ("TURBOPACK compile-time truthy", 1) ? error.message : "TURBOPACK unreachable",
                code: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].INTERNAL_SERVER_ERROR
            };
        }
        return {
            success: false,
            error: "An unexpected error occurred",
            code: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].UNKNOWN_ERROR
        };
    }
}
/**
 * Create a success result
 *
 * Helper to create consistent success responses
 */ function successResult(data, message) {
    return {
        success: true,
        data,
        ...message && {
            message
        }
    };
}
/**
 * Create an error result
 *
 * Helper to create consistent error responses
 */ function errorResult(error, code, details) {
    return {
        success: false,
        error,
        ...code && {
            code
        },
        ...details && {
            details
        }
    };
}
function assertSupabase(supabase) {
    if (!supabase) {
        throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR, 500);
    }
}
function assertAuthenticated(userId) {
    if (!userId) {
        throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("You must be logged in to perform this action", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_UNAUTHORIZED, 401);
    }
}
function assertExists(resource, resourceName) {
    if (!resource) {
        throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](`${resourceName} not found`, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_RECORD_NOT_FOUND, 404);
    }
}
/**
 * Assert user has permission
 *
 * Helper to check permissions and throw ActionError if not authorized
 */ function assertPermission(hasPermission, resourceName) {
    if (!hasPermission) {
        throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](`You don't have permission to access this ${resourceName}`, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, 403);
    }
}
}),
"[project]/apps/web/src/lib/services/geocoding.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Google Geocoding API Utility
 *
 * Automatically acquires GPS coordinates (lat/lon) from addresses
 * Used during customer creation, property creation, and company onboarding
 */ __turbopack_context__.s([
    "geocodeAddressSilent",
    ()=>geocodeAddressSilent
]);
/**
 * Geocode an address to get GPS coordinates
 *
 * @param address - Street address
 * @param city - City
 * @param state - State
 * @param zipCode - ZIP code
 * @param country - Country (defaults to "USA")
 * @returns Coordinates {lat, lon} or null if geocoding fails
 */ async function geocodeAddress(address, city, state, zipCode, country = "USA") {
    try {
        // Build full address string
        const fullAddress = `${address}, ${city}, ${state} ${zipCode}, ${country}`;
        // Get API key from environment
        const apiKey = ("TURBOPACK compile-time value", "AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0");
        if ("TURBOPACK compile-time falsy", 0) //TURBOPACK unreachable
        ;
        // Call Google Geocoding API
        const encodedAddress = encodeURIComponent(fullAddress);
        const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodedAddress}&key=${apiKey}`;
        const response = await fetch(url);
        if (!response.ok) {
            return {
                success: false,
                error: `Geocoding failed with status ${response.status}`
            };
        }
        const data = await response.json();
        // Check if we got results
        if (data.status === "OK" && data.results && data.results.length > 0) {
            const location = data.results[0].geometry.location;
            const formattedAddress = data.results[0].formatted_address;
            return {
                success: true,
                coordinates: {
                    lat: location.lat,
                    lon: location.lng,
                    formattedAddress
                }
            };
        }
        if (data.status === "ZERO_RESULTS") {
            return {
                success: false,
                error: "Address not found"
            };
        }
        return {
            success: false,
            error: data.error_message || `Geocoding failed: ${data.status}`
        };
    } catch (error) {
        return {
            success: false,
            error: error instanceof Error ? error.message : "Unknown geocoding error"
        };
    }
}
async function geocodeAddressSilent(address, city, state, zipCode, country = "USA") {
    try {
        const result = await geocodeAddress(address, city, state, zipCode, country);
        return result.success && result.coordinates ? result.coordinates : null;
    } catch (_error) {
        return null;
    }
}
}),
"[project]/apps/web/emails/theme.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "EMAIL_COLORS",
    ()=>EMAIL_COLORS
]);
const EMAIL_COLORS = {
    background: "#fafafa",
    surface: "#fcfcfc",
    surfaceStrong: "#f2f2f2",
    primary: "#3c6ff5",
    primaryText: "#fafafa",
    heading: "#171717",
    text: "#171717",
    muted: "#737373",
    border: "#e6e6e6"
};
}),
"[project]/apps/web/emails/components/button.tsx [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Email Button Component - Matches dashboard button design
 *
 * Design:
 * - Primary variant with Thorbis Electric Blue
 * - Outline variant for secondary actions
 * - Responsive and accessible
 * - Supports both link and button styles
 */ __turbopack_context__.s([
    "Button",
    ()=>Button
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-dev-runtime.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$button$40$0$2e$2$2e$0_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$button$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+button@0.2.0_react@19.2.0/node_modules/@react-email/button/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/emails/theme.ts [app-route] (ecmascript)");
;
;
;
function Button({ href, children, variant = "primary" }) {
    const baseStyle = {
        display: "inline-block",
        padding: "12px 24px",
        fontSize: "16px",
        fontWeight: "600",
        textDecoration: "none",
        borderRadius: "8px",
        textAlign: "center",
        transition: "all 0.2s ease"
    };
    const variantStyles = {
        primary: {
            backgroundColor: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].primary,
            color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].primaryText,
            border: "none"
        },
        outline: {
            backgroundColor: "transparent",
            color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].primary,
            border: `2px solid ${__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].primary}`
        }
    };
    return /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$button$40$0$2e$2$2e$0_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$button$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Button"], {
        href: href,
        style: {
            ...baseStyle,
            ...variantStyles[variant]
        },
        children: children
    }, void 0, false, {
        fileName: "[project]/apps/web/emails/components/button.tsx",
        lineNumber: 46,
        columnNumber: 3
    }, this);
}
}),
"[project]/apps/web/emails/components/card.tsx [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Email Card Component - Information card matching dashboard cards
 *
 * Design:
 * - Clean white background with subtle border
 * - Rounded corners
 * - Padding for content spacing
 * - Optional header and footer sections
 */ __turbopack_context__.s([
    "Card",
    ()=>Card
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-dev-runtime.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$section$40$0$2e$0$2e$16_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$section$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+section@0.0.16_react@19.2.0/node_modules/@react-email/section/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+text@0.1.5_react@19.2.0/node_modules/@react-email/text/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/emails/theme.ts [app-route] (ecmascript)");
;
;
;
function Card({ children, title, style }) {
    return /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$section$40$0$2e$0$2e$16_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$section$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Section"], {
        style: {
            ...cardStyle,
            ...style
        },
        children: [
            title && /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                style: titleStyle,
                children: title
            }, void 0, false, {
                fileName: "[project]/apps/web/emails/components/card.tsx",
                lineNumber: 29,
                columnNumber: 14
            }, this),
            children
        ]
    }, void 0, true, {
        fileName: "[project]/apps/web/emails/components/card.tsx",
        lineNumber: 23,
        columnNumber: 3
    }, this);
}
const cardStyle = {
    backgroundColor: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].surface,
    border: `1px solid ${__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].border}`,
    borderRadius: "8px",
    padding: "24px",
    margin: "16px 0"
};
const titleStyle = {
    fontSize: "18px",
    fontWeight: "600",
    color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].heading,
    margin: "0 0 16px 0"
};
}),
"[project]/apps/web/emails/components/heading.tsx [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Email Heading Component - Typography for email headings
 *
 * Design:
 * - H1, H2, H3 variants
 * - Matches dashboard typography
 * - Proper spacing and hierarchy
 */ __turbopack_context__.s([
    "Heading",
    ()=>Heading
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-dev-runtime.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$heading$40$0$2e$0$2e$15_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$heading$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+heading@0.0.15_react@19.2.0/node_modules/@react-email/heading/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/emails/theme.ts [app-route] (ecmascript)");
;
;
;
function Heading({ children, level = 1, style }) {
    const headingTag = `h${level}`;
    const headingStyles = {
        1: {
            fontSize: "32px",
            fontWeight: "700",
            color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].heading,
            margin: "0 0 16px 0",
            lineHeight: "1.2"
        },
        2: {
            fontSize: "24px",
            fontWeight: "600",
            color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].text,
            margin: "0 0 12px 0",
            lineHeight: "1.3"
        },
        3: {
            fontSize: "18px",
            fontWeight: "600",
            color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].muted,
            margin: "0 0 8px 0",
            lineHeight: "1.4"
        }
    };
    return /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$heading$40$0$2e$0$2e$15_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$heading$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Heading"], {
        as: headingTag,
        style: {
            ...headingStyles[level],
            ...style
        },
        children: children
    }, void 0, false, {
        fileName: "[project]/apps/web/emails/components/heading.tsx",
        lineNumber: 46,
        columnNumber: 3
    }, this);
}
}),
"[project]/apps/web/emails/layouts/base-layout.tsx [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Thorbis-Branded Email Layout
 *
 * For platform/system emails:
 * - Clean, full-width design (no cards)
 * - Thorbis logo image from CDN/env
 * - Thorbis Electric Blue branding
 * - Professional footer with Thorbis info
 *
 * Uses environment variables for:
 * - Logo URL
 * - App URL
 * - Support email
 * - Company info
 */ __turbopack_context__.s([
    "BaseLayout",
    ()=>BaseLayout
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-dev-runtime.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$body$40$0$2e$1$2e$0_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$body$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+body@0.1.0_react@19.2.0/node_modules/@react-email/body/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$container$40$0$2e$0$2e$15_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$container$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+container@0.0.15_react@19.2.0/node_modules/@react-email/container/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$head$40$0$2e$0$2e$12_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$head$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+head@0.0.12_react@19.2.0/node_modules/@react-email/head/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$hr$40$0$2e$0$2e$11_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$hr$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+hr@0.0.11_react@19.2.0/node_modules/@react-email/hr/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$html$40$0$2e$0$2e$11_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$html$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+html@0.0.11_react@19.2.0/node_modules/@react-email/html/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$img$40$0$2e$0$2e$11_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$img$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+img@0.0.11_react@19.2.0/node_modules/@react-email/img/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$link$40$0$2e$0$2e$12_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$link$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+link@0.0.12_react@19.2.0/node_modules/@react-email/link/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$preview$40$0$2e$0$2e$13_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$preview$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+preview@0.0.13_react@19.2.0/node_modules/@react-email/preview/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$section$40$0$2e$0$2e$16_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$section$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+section@0.0.16_react@19.2.0/node_modules/@react-email/section/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+text@0.1.5_react@19.2.0/node_modules/@react-email/text/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/emails/theme.ts [app-route] (ecmascript)");
;
;
;
// Environment-based configuration
const THORBIS_LOGO_URL = process.env.NEXT_PUBLIC_THORBIS_LOGO_URL || "https://thorbis.com/logo-white.png";
const THORBIS_APP_URL = ("TURBOPACK compile-time value", "http://localhost:3000") || "https://app.thorbis.com";
const THORBIS_WEBSITE = process.env.NEXT_PUBLIC_WEBSITE_URL || "https://thorbis.com";
const THORBIS_SUPPORT_EMAIL = process.env.THORBIS_SUPPORT_EMAIL || "support@thorbis.com";
const THORBIS_DOCS_URL = `${THORBIS_WEBSITE}/docs`;
const THORBIS_PRIVACY_URL = `${THORBIS_WEBSITE}/privacy`;
const THORBIS_TERMS_URL = `${THORBIS_WEBSITE}/terms`;
function BaseLayout({ children, previewText }) {
    return /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$html$40$0$2e$0$2e$11_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$html$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Html"], {
        children: [
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$head$40$0$2e$0$2e$12_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$head$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Head"], {
                children: /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("style", {
                    children: `
          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

          /* Reset email client styles */
          body { margin: 0; padding: 0; }
          table { border-collapse: collapse; }
          img { border: 0; }

          /* Responsive */
          @media only screen and (max-width: 600px) {
            .mobile-padding { padding: 20px !important; }
            .mobile-text { font-size: 14px !important; }
            .mobile-heading { font-size: 24px !important; }
          }
        `
                }, void 0, false, {
                    fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                    lineNumber: 55,
                    columnNumber: 5
                }, this)
            }, void 0, false, {
                fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                lineNumber: 54,
                columnNumber: 4
            }, this),
            previewText && /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$preview$40$0$2e$0$2e$13_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$preview$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Preview"], {
                children: previewText
            }, void 0, false, {
                fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                lineNumber: 71,
                columnNumber: 20
            }, this),
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$body$40$0$2e$1$2e$0_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$body$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Body"], {
                style: main,
                children: /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$container$40$0$2e$0$2e$15_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$container$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Container"], {
                    style: container,
                    children: [
                        /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$section$40$0$2e$0$2e$16_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$section$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Section"], {
                            style: header,
                            children: /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$img$40$0$2e$0$2e$11_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$img$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Img"], {
                                src: THORBIS_LOGO_URL,
                                alt: "Thorbis",
                                width: "160",
                                height: "40",
                                style: logo
                            }, void 0, false, {
                                fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                                lineNumber: 76,
                                columnNumber: 7
                            }, this)
                        }, void 0, false, {
                            fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                            lineNumber: 75,
                            columnNumber: 6
                        }, this),
                        /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$section$40$0$2e$0$2e$16_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$section$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Section"], {
                            style: content,
                            className: "mobile-padding",
                            children: children
                        }, void 0, false, {
                            fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                            lineNumber: 86,
                            columnNumber: 6
                        }, this),
                        /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$hr$40$0$2e$0$2e$11_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$hr$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Hr"], {
                            style: divider
                        }, void 0, false, {
                            fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                            lineNumber: 91,
                            columnNumber: 6
                        }, this),
                        /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$section$40$0$2e$0$2e$16_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$section$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Section"], {
                            style: footer,
                            className: "mobile-padding",
                            children: [
                                /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                                    style: footerText,
                                    children: [
                                        "Need help?",
                                        " ",
                                        /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$link$40$0$2e$0$2e$12_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$link$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Link"], {
                                            href: `mailto:${THORBIS_SUPPORT_EMAIL}`,
                                            style: footerLink,
                                            children: "Contact Support"
                                        }, void 0, false, {
                                            fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                                            lineNumber: 98,
                                            columnNumber: 8
                                        }, this),
                                        "  ",
                                        /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$link$40$0$2e$0$2e$12_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$link$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Link"], {
                                            href: THORBIS_DOCS_URL,
                                            style: footerLink,
                                            children: "Documentation"
                                        }, void 0, false, {
                                            fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                                            lineNumber: 102,
                                            columnNumber: 8
                                        }, this)
                                    ]
                                }, void 0, true, {
                                    fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                                    lineNumber: 96,
                                    columnNumber: 7
                                }, this),
                                /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                                    style: footerText,
                                    children: [
                                        /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$link$40$0$2e$0$2e$12_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$link$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Link"], {
                                            href: THORBIS_PRIVACY_URL,
                                            style: footerLink,
                                            children: "Privacy Policy"
                                        }, void 0, false, {
                                            fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                                            lineNumber: 109,
                                            columnNumber: 8
                                        }, this),
                                        "  ",
                                        /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$link$40$0$2e$0$2e$12_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$link$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Link"], {
                                            href: THORBIS_TERMS_URL,
                                            style: footerLink,
                                            children: "Terms of Service"
                                        }, void 0, false, {
                                            fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                                            lineNumber: 113,
                                            columnNumber: 8
                                        }, this)
                                    ]
                                }, void 0, true, {
                                    fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                                    lineNumber: 108,
                                    columnNumber: 7
                                }, this),
                                /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                                    style: footerCopyright,
                                    children: [
                                        " ",
                                        new Date().getFullYear(),
                                        " Thorbis. All rights reserved."
                                    ]
                                }, void 0, true, {
                                    fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                                    lineNumber: 119,
                                    columnNumber: 7
                                }, this),
                                /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                                    style: footerAddress,
                                    children: "Thorbis  123 Innovation Drive, San Francisco, CA 94105"
                                }, void 0, false, {
                                    fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                                    lineNumber: 123,
                                    columnNumber: 7
                                }, this),
                                /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                                    style: footerUnsubscribe,
                                    children: [
                                        "You're receiving this email because you have an account with Thorbis.",
                                        " ",
                                        /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$link$40$0$2e$0$2e$12_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$link$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Link"], {
                                            href: "{{unsubscribe_url}}",
                                            style: footerLink,
                                            children: "Unsubscribe from marketing emails"
                                        }, void 0, false, {
                                            fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                                            lineNumber: 131,
                                            columnNumber: 8
                                        }, this)
                                    ]
                                }, void 0, true, {
                                    fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                                    lineNumber: 128,
                                    columnNumber: 7
                                }, this)
                            ]
                        }, void 0, true, {
                            fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                            lineNumber: 94,
                            columnNumber: 6
                        }, this)
                    ]
                }, void 0, true, {
                    fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                    lineNumber: 73,
                    columnNumber: 5
                }, this)
            }, void 0, false, {
                fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
                lineNumber: 72,
                columnNumber: 4
            }, this)
        ]
    }, void 0, true, {
        fileName: "[project]/apps/web/emails/layouts/base-layout.tsx",
        lineNumber: 53,
        columnNumber: 3
    }, this);
}
// Styles - Clean, full-width design
const main = {
    backgroundColor: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].background,
    fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
    WebkitFontSmoothing: "antialiased",
    MozOsxFontSmoothing: "grayscale"
};
const container = {
    backgroundColor: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].surface,
    maxWidth: "600px",
    margin: "0 auto"
};
const header = {
    backgroundColor: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].primary,
    padding: "40px 0",
    textAlign: "center"
};
const logo = {
    margin: "0 auto",
    display: "block"
};
const content = {
    padding: "48px 40px",
    color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].text,
    fontSize: "16px",
    lineHeight: "24px"
};
const divider = {
    borderColor: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].border,
    borderWidth: "1px",
    margin: "0"
};
const footer = {
    padding: "32px 40px",
    textAlign: "center",
    backgroundColor: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].surfaceStrong
};
const footerText = {
    color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].muted,
    fontSize: "14px",
    lineHeight: "24px",
    margin: "8px 0"
};
const footerLink = {
    color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].primary,
    textDecoration: "none",
    fontWeight: "500"
};
const footerCopyright = {
    color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].muted,
    fontSize: "13px",
    margin: "16px 0 0 0",
    fontWeight: "600"
};
const footerAddress = {
    color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].muted,
    fontSize: "12px",
    margin: "8px 0"
};
const footerUnsubscribe = {
    color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].muted,
    fontSize: "11px",
    margin: "16px 0 0 0",
    lineHeight: "18px"
};
}),
"[project]/apps/web/emails/templates/customer/portal-invitation.tsx [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Portal Invitation Email Template - Customer portal access invitation
 *
 * Features:
 * - Invitation to access customer portal
 * - Secure setup link with expiration
 * - Portal features overview
 * - Getting started guide
 */ __turbopack_context__.s([
    "default",
    ()=>PortalInvitationEmail
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-dev-runtime.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@react-email+text@0.1.5_react@19.2.0/node_modules/@react-email/text/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$button$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/emails/components/button.tsx [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$card$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/emails/components/card.tsx [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$heading$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/emails/components/heading.tsx [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$layouts$2f$base$2d$layout$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/emails/layouts/base-layout.tsx [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/emails/theme.ts [app-route] (ecmascript)");
;
;
;
;
;
;
;
function PortalInvitationEmail({ customerName, portalUrl, expiresInHours = 168, companyName = "Thorbis", supportEmail = "support@thorbis.com", supportPhone = "(555) 123-4567", previewText = "You've been invited to access your customer portal" }) {
    return /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$layouts$2f$base$2d$layout$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["BaseLayout"], {
        previewText: previewText,
        children: [
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$heading$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Heading"], {
                level: 1,
                children: "You're Invited!"
            }, void 0, false, {
                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                lineNumber: 39,
                columnNumber: 4
            }, this),
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                style: paragraph,
                children: [
                    "Hi ",
                    customerName,
                    ","
                ]
            }, void 0, true, {
                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                lineNumber: 41,
                columnNumber: 4
            }, this),
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                style: paragraph,
                children: [
                    "Great news! You now have access to your ",
                    companyName,
                    " customer portal - a convenient online hub where you can manage your services, view invoices, and communicate with us anytime."
                ]
            }, void 0, true, {
                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                lineNumber: 43,
                columnNumber: 4
            }, this),
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$card$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Card"], {
                style: invitationCard,
                children: [
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                        style: invitationIcon,
                        children: ""
                    }, void 0, false, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 50,
                        columnNumber: 5
                    }, this),
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                        style: invitationTitle,
                        children: "Your Portal is Ready!"
                    }, void 0, false, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 51,
                        columnNumber: 5
                    }, this),
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                        style: invitationText,
                        children: "Click the button below to set up your account and access all your service information in one place."
                    }, void 0, false, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 52,
                        columnNumber: 5
                    }, this)
                ]
            }, void 0, true, {
                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                lineNumber: 49,
                columnNumber: 4
            }, this),
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                style: buttonContainer,
                children: /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$button$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Button"], {
                    href: portalUrl,
                    children: "Set Up My Account"
                }, void 0, false, {
                    fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                    lineNumber: 59,
                    columnNumber: 5
                }, this)
            }, void 0, false, {
                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                lineNumber: 58,
                columnNumber: 4
            }, this),
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$card$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Card"], {
                style: expiryCard,
                children: /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                    style: expiryText,
                    children: [
                        " This invitation link will expire in",
                        " ",
                        /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("strong", {
                            children: [
                                expiresInHours,
                                " hours"
                            ]
                        }, void 0, true, {
                            fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                            lineNumber: 65,
                            columnNumber: 6
                        }, this),
                        ". Please complete your account setup soon."
                    ]
                }, void 0, true, {
                    fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                    lineNumber: 63,
                    columnNumber: 5
                }, this)
            }, void 0, false, {
                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                lineNumber: 62,
                columnNumber: 4
            }, this),
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$card$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Card"], {
                style: featuresCard,
                children: [
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$heading$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Heading"], {
                        level: 3,
                        children: "What you can do in your portal:"
                    }, void 0, false, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 71,
                        columnNumber: 5
                    }, this),
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("ul", {
                        style: featuresList,
                        children: [
                            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("li", {
                                style: featureItem,
                                children: [
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("strong", {
                                        children: " View & Schedule Services:"
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 74,
                                        columnNumber: 7
                                    }, this),
                                    " Book appointments and track upcoming service visits"
                                ]
                            }, void 0, true, {
                                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                lineNumber: 73,
                                columnNumber: 6
                            }, this),
                            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("li", {
                                style: featureItem,
                                children: [
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("strong", {
                                        children: " Manage Invoices:"
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 78,
                                        columnNumber: 7
                                    }, this),
                                    " View billing history and pay invoices online securely"
                                ]
                            }, void 0, true, {
                                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                lineNumber: 77,
                                columnNumber: 6
                            }, this),
                            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("li", {
                                style: featureItem,
                                children: [
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("strong", {
                                        children: " Service History:"
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 82,
                                        columnNumber: 7
                                    }, this),
                                    " Access complete records of all your past services"
                                ]
                            }, void 0, true, {
                                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                lineNumber: 81,
                                columnNumber: 6
                            }, this),
                            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("li", {
                                style: featureItem,
                                children: [
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("strong", {
                                        children: " Property Details:"
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 86,
                                        columnNumber: 7
                                    }, this),
                                    " Manage multiple properties and service locations"
                                ]
                            }, void 0, true, {
                                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                lineNumber: 85,
                                columnNumber: 6
                            }, this),
                            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("li", {
                                style: featureItem,
                                children: [
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("strong", {
                                        children: " Direct Communication:"
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 90,
                                        columnNumber: 7
                                    }, this),
                                    " Message our team and get real-time updates"
                                ]
                            }, void 0, true, {
                                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                lineNumber: 89,
                                columnNumber: 6
                            }, this),
                            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("li", {
                                style: featureItem,
                                children: [
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("strong", {
                                        children: " Mobile Access:"
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 94,
                                        columnNumber: 7
                                    }, this),
                                    " Access your account from any device, anywhere"
                                ]
                            }, void 0, true, {
                                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                lineNumber: 93,
                                columnNumber: 6
                            }, this)
                        ]
                    }, void 0, true, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 72,
                        columnNumber: 5
                    }, this)
                ]
            }, void 0, true, {
                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                lineNumber: 70,
                columnNumber: 4
            }, this),
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$card$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Card"], {
                style: securityCard,
                children: [
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$heading$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Heading"], {
                        level: 3,
                        children: "Secure & Private"
                    }, void 0, false, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 101,
                        columnNumber: 5
                    }, this),
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                        style: securityText,
                        children: "Your portal is protected with industry-standard security. Only you can access your account information, and all data is encrypted for your protection."
                    }, void 0, false, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 102,
                        columnNumber: 5
                    }, this)
                ]
            }, void 0, true, {
                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                lineNumber: 100,
                columnNumber: 4
            }, this),
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$card$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Card"], {
                style: stepsCard,
                children: [
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$heading$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Heading"], {
                        level: 3,
                        children: "Getting Started is Easy"
                    }, void 0, false, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 110,
                        columnNumber: 5
                    }, this),
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                        style: stepGrid,
                        children: [
                            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                                style: step,
                                children: [
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                                        style: stepNumber,
                                        children: "1"
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 113,
                                        columnNumber: 7
                                    }, this),
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                                        style: stepText,
                                        children: 'Click the "Set Up My Account" button above'
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 114,
                                        columnNumber: 7
                                    }, this)
                                ]
                            }, void 0, true, {
                                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                lineNumber: 112,
                                columnNumber: 6
                            }, this),
                            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                                style: step,
                                children: [
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                                        style: stepNumber,
                                        children: "2"
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 119,
                                        columnNumber: 7
                                    }, this),
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                                        style: stepText,
                                        children: "Create a secure password for your account"
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 120,
                                        columnNumber: 7
                                    }, this)
                                ]
                            }, void 0, true, {
                                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                lineNumber: 118,
                                columnNumber: 6
                            }, this),
                            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                                style: step,
                                children: [
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                                        style: stepNumber,
                                        children: "3"
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 125,
                                        columnNumber: 7
                                    }, this),
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                                        style: stepText,
                                        children: "Explore your portal and manage your services!"
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 126,
                                        columnNumber: 7
                                    }, this)
                                ]
                            }, void 0, true, {
                                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                lineNumber: 124,
                                columnNumber: 6
                            }, this)
                        ]
                    }, void 0, true, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 111,
                        columnNumber: 5
                    }, this)
                ]
            }, void 0, true, {
                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                lineNumber: 109,
                columnNumber: 4
            }, this),
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$card$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Card"], {
                style: helpCard,
                children: [
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$components$2f$heading$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Heading"], {
                        level: 3,
                        children: "Need Help?"
                    }, void 0, false, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 134,
                        columnNumber: 5
                    }, this),
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                        style: helpText,
                        children: "If you have any questions about setting up your portal or need assistance, our support team is here to help."
                    }, void 0, false, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 135,
                        columnNumber: 5
                    }, this),
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                        style: contactGrid,
                        children: [
                            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                                style: contactMethod,
                                children: [
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                                        style: contactLabel,
                                        children: "Email:"
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 141,
                                        columnNumber: 7
                                    }, this),
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("a", {
                                        href: `mailto:${supportEmail}`,
                                        style: contactLink,
                                        children: supportEmail
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 142,
                                        columnNumber: 7
                                    }, this)
                                ]
                            }, void 0, true, {
                                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                lineNumber: 140,
                                columnNumber: 6
                            }, this),
                            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                                style: contactMethod,
                                children: [
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                                        style: contactLabel,
                                        children: "Phone:"
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 147,
                                        columnNumber: 7
                                    }, this),
                                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("a", {
                                        href: `tel:${supportPhone}`,
                                        style: contactLink,
                                        children: supportPhone
                                    }, void 0, false, {
                                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                        lineNumber: 148,
                                        columnNumber: 7
                                    }, this)
                                ]
                            }, void 0, true, {
                                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                                lineNumber: 146,
                                columnNumber: 6
                            }, this)
                        ]
                    }, void 0, true, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 139,
                        columnNumber: 5
                    }, this)
                ]
            }, void 0, true, {
                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                lineNumber: 133,
                columnNumber: 4
            }, this),
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$react$2d$email$2b$text$40$0$2e$1$2e$5_react$40$19$2e$2$2e$0$2f$node_modules$2f40$react$2d$email$2f$text$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Text"], {
                style: footerNote,
                children: [
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("strong", {
                        children: "Note:"
                    }, void 0, false, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 156,
                        columnNumber: 5
                    }, this),
                    " If you didn't request portal access or believe you received this email in error, please contact us at",
                    " ",
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["jsxDEV"])("a", {
                        href: `mailto:${supportEmail}`,
                        style: inlineLink,
                        children: supportEmail
                    }, void 0, false, {
                        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                        lineNumber: 158,
                        columnNumber: 5
                    }, this),
                    "."
                ]
            }, void 0, true, {
                fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
                lineNumber: 155,
                columnNumber: 4
            }, this)
        ]
    }, void 0, true, {
        fileName: "[project]/apps/web/emails/templates/customer/portal-invitation.tsx",
        lineNumber: 38,
        columnNumber: 3
    }, this);
}
// Styles
const paragraph = {
    color: "#374151",
    fontSize: "16px",
    lineHeight: "24px",
    margin: "0 0 16px 0"
};
const invitationCard = {
    background: "linear-gradient(135deg, hsl(217 91% 60%) 0%, hsl(217 91% 50%) 100%)",
    borderRadius: "12px",
    padding: "40px",
    margin: "24px 0",
    textAlign: "center"
};
const invitationIcon = {
    fontSize: "64px",
    margin: "0 0 16px 0"
};
const invitationTitle = {
    color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].primaryText,
    fontSize: "24px",
    fontWeight: "600",
    margin: "0 0 12px 0"
};
const invitationText = {
    color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].primaryText,
    fontSize: "16px",
    lineHeight: "24px",
    margin: "0",
    opacity: "0.95"
};
const buttonContainer = {
    margin: "32px 0",
    textAlign: "center"
};
const expiryCard = {
    backgroundColor: "#fef3c7",
    border: "1px solid #fde68a",
    borderRadius: "8px",
    padding: "16px",
    margin: "24px 0",
    textAlign: "center"
};
const expiryText = {
    color: "#92400e",
    fontSize: "14px",
    lineHeight: "20px",
    margin: "0"
};
const featuresCard = {
    backgroundColor: "#f0fdf4",
    border: "1px solid #bbf7d0",
    margin: "24px 0"
};
const featuresList = {
    color: "#166534",
    fontSize: "14px",
    lineHeight: "22px",
    margin: "12px 0 0 20px",
    padding: "0"
};
const featureItem = {
    margin: "0 0 12px 0"
};
const securityCard = {
    backgroundColor: "#f5f3ff",
    border: "1px solid #ddd6fe",
    margin: "24px 0"
};
const securityText = {
    color: "#5b21b6",
    fontSize: "15px",
    lineHeight: "22px",
    margin: "12px 0 0 0"
};
const stepsCard = {
    backgroundColor: "#eff6ff",
    border: "1px solid #bfdbfe",
    margin: "24px 0"
};
const stepGrid = {
    display: "grid",
    gridTemplateColumns: "1fr 1fr 1fr",
    gap: "20px",
    margin: "20px 0 0 0"
};
const step = {
    textAlign: "center"
};
const stepNumber = {
    width: "40px",
    height: "40px",
    backgroundColor: "hsl(217 91% 60%)",
    color: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$theme$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EMAIL_COLORS"].primaryText,
    borderRadius: "50%",
    display: "inline-flex",
    alignItems: "center",
    justifyContent: "center",
    fontSize: "18px",
    fontWeight: "600",
    margin: "0 auto 12px auto"
};
const stepText = {
    color: "#1e40af",
    fontSize: "13px",
    lineHeight: "18px",
    margin: "0"
};
const helpCard = {
    backgroundColor: "#fef2f2",
    border: "1px solid #fecaca",
    margin: "24px 0"
};
const helpText = {
    color: "#991b1b",
    fontSize: "15px",
    lineHeight: "22px",
    margin: "12px 0 20px 0"
};
const contactGrid = {
    display: "grid",
    gridTemplateColumns: "1fr 1fr",
    gap: "16px"
};
const contactMethod = {
    textAlign: "center"
};
const contactLabel = {
    color: "#6b7280",
    fontSize: "12px",
    textTransform: "uppercase",
    letterSpacing: "0.05em",
    margin: "0 0 8px 0"
};
const contactLink = {
    color: "hsl(217 91% 60%)",
    fontSize: "15px",
    fontWeight: "600",
    textDecoration: "underline"
};
const footerNote = {
    color: "#6b7280",
    fontSize: "13px",
    lineHeight: "20px",
    margin: "32px 0 0 0",
    padding: "20px",
    backgroundColor: "#f9fafb",
    borderRadius: "8px",
    textAlign: "center"
};
const inlineLink = {
    color: "hsl(217 91% 60%)",
    textDecoration: "underline"
};
}),
"[project]/apps/web/src/actions/customers.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

return __turbopack_context__.a(async (__turbopack_handle_async_dependencies__, __turbopack_async_result__) => { try {

/**
 * Customer Management Server Actions
 *
 * Comprehensive customer relationship management with:
 * - Customer CRUD operations
 * - Customer portal invitation and access
 * - Customer metrics tracking (revenue, jobs, invoices)
 * - Communication preferences
 * - Soft delete/archive support
 * - Customer search and filtering
 */ /* __next_internal_action_entry_do_not_use__ [{"00337bf9ccf6d7f5002dfdd1c39a50a1925fa9cd70":"getCustomersForDialer","40b277f535f8a989546d6c7e3a1af8abe77de6c459":"deleteCustomer","6048659199289e27e8a29c146dcc920a7afc8ad29e":"searchCustomers","604ac8c079e9497e74d11dd7c17f442078174db43f":"getCustomerByPhone"},"",""] */ __turbopack_context__.s([
    "deleteCustomer",
    ()=>deleteCustomer,
    "getCustomerByPhone",
    ()=>getCustomerByPhone,
    "getCustomersForDialer",
    ()=>getCustomersForDialer,
    "searchCustomers",
    ()=>searchCustomers
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/server-reference.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$auth$2f$company$2d$context$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/apps/web/src/lib/auth/company-context.ts [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$auth$2f$src$2f$company$2d$context$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/auth/src/company-context.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$email$2d$sender$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/email-sender.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$email$2d$types$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/email/email-types.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/errors/action-error.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/apps/web/src/lib/errors/with-error-handling.ts [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$services$2f$geocoding$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/lib/services/geocoding.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/packages/database/src/server.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$cache$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/cache.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/zod@4.1.12/node_modules/zod/v4/classic/external.js [app-route] (ecmascript) <export * as z>");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$templates$2f$customer$2f$portal$2d$invitation$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/emails/templates/customer/portal-invitation.tsx [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/dist/build/webpack/loaders/next-flight-loader/action-validate.js [app-route] (ecmascript)");
var __turbopack_async_dependencies__ = __turbopack_handle_async_dependencies__([
    __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$email$2d$sender$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__
]);
[__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$email$2d$sender$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__] = __turbopack_async_dependencies__.then ? (await __turbopack_async_dependencies__)() : __turbopack_async_dependencies__;
;
;
;
;
;
;
;
;
;
;
;
// ============================================================================
// VALIDATION SCHEMAS
// ============================================================================
const CUSTOMER_NAME_MAX_LENGTH = 100;
const CUSTOMER_COMPANY_MAX_LENGTH = 200;
const CUSTOMER_PHONE_MAX_LENGTH = 20;
const CUSTOMER_ADDRESS_MAX_LENGTH = 200;
const CUSTOMER_ADDRESS2_MAX_LENGTH = 100;
const CUSTOMER_CITY_MAX_LENGTH = 100;
const CUSTOMER_STATE_MAX_LENGTH = 50;
// HTTP Status codes
const HTTP_STATUS_FORBIDDEN = 403;
// Search defaults
const DEFAULT_SEARCH_LIMIT = 50;
const CUSTOMER_ZIP_MAX_LENGTH = 20;
const CUSTOMER_COUNTRY_MAX_LENGTH = 50;
const CUSTOMER_TAX_EXEMPT_NUMBER_MAX_LENGTH = 50;
const CENTS_PER_DOLLAR = 100;
function requireSiteUrl() {
    const siteUrl = ("TURBOPACK compile-time value", "http://localhost:3000");
    if ("TURBOPACK compile-time falsy", 0) //TURBOPACK unreachable
    ;
    return siteUrl.replace(/\/$/, "");
}
const customerSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].object({
    type: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].enum([
        "residential",
        "commercial",
        "industrial"
    ]).default("residential"),
    firstName: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().min(1, "First name is required").max(CUSTOMER_NAME_MAX_LENGTH),
    lastName: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().min(1, "Last name is required").max(CUSTOMER_NAME_MAX_LENGTH),
    companyName: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().max(CUSTOMER_COMPANY_MAX_LENGTH).optional(),
    email: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().email("Invalid email address"),
    phone: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().min(1, "Phone is required").max(CUSTOMER_PHONE_MAX_LENGTH),
    secondaryPhone: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().max(CUSTOMER_PHONE_MAX_LENGTH).optional(),
    address: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().max(CUSTOMER_ADDRESS_MAX_LENGTH).optional(),
    address2: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().max(CUSTOMER_ADDRESS2_MAX_LENGTH).optional(),
    city: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().max(CUSTOMER_CITY_MAX_LENGTH).optional(),
    state: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().max(CUSTOMER_STATE_MAX_LENGTH).optional(),
    zipCode: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().max(CUSTOMER_ZIP_MAX_LENGTH).optional(),
    country: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().max(CUSTOMER_COUNTRY_MAX_LENGTH).default("USA"),
    source: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].enum([
        "referral",
        "google",
        "facebook",
        "direct",
        "yelp",
        "other"
    ]).optional(),
    referredBy: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().uuid().optional().nullable(),
    preferredContactMethod: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].enum([
        "email",
        "phone",
        "sms"
    ]).default("email"),
    preferredTechnician: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().uuid().optional().nullable(),
    billingEmail: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().email().optional().nullable(),
    paymentTerms: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].enum([
        "due_on_receipt",
        "net_15",
        "net_30",
        "net_60"
    ]).default("due_on_receipt"),
    creditLimit: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].number().int().min(0).default(0),
    taxExempt: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].boolean().default(false),
    taxExemptNumber: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().max(CUSTOMER_TAX_EXEMPT_NUMBER_MAX_LENGTH).optional(),
    tags: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].array(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string()).optional(),
    notes: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().optional(),
    internalNotes: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().optional()
});
const communicationPreferencesSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].object({
    email: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].boolean().default(true),
    sms: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].boolean().default(true),
    phone: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].boolean().default(true),
    marketing: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$zod$40$4$2e$1$2e$12$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].boolean().default(false)
});
// ============================================================================
// CUSTOMER CRUD OPERATIONS
// ============================================================================
/**
 * Create a new customer with multiple contacts and properties
 */ async function createCustomer(formData) {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        const { data: { user } } = await supabase.auth.getUser();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertAuthenticated"])(user?.id);
        const teamMember = await requireCustomerCompanyMembership(supabase, user.id);
        const { contacts, properties, tags } = parseCustomerContactsPropertiesAndTags(formData);
        const primaryContact = getPrimaryContactOrThrow(contacts);
        const primaryProperty = getPrimaryProperty(properties);
        await assertCustomerEmailNotDuplicate(supabase, teamMember.company_id, primaryContact.email);
        const customerType = formData.get("type") || "residential";
        const companyName = formData.get("companyName");
        const displayName = buildCustomerDisplayName(customerType, companyName, primaryContact);
        const communicationPreferences = buildDefaultCommunicationPreferences();
        const customerMetadata = buildCustomerMetadata(contacts);
        const { lat: customerLat, lon: customerLon } = await geocodePrimaryPropertyIfAvailable(primaryProperty);
        const customer = await insertCustomerRecord(supabase, {
            companyId: teamMember.company_id,
            customerType,
            primaryContact,
            companyNameValue: companyName,
            displayName,
            primaryProperty,
            customerLat,
            customerLon,
            formData,
            tags,
            communicationPreferences,
            customerMetadata
        });
        await insertAdditionalPropertiesIfAny(supabase, teamMember.company_id, customer.id, properties);
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$cache$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["revalidatePath"])("/dashboard/customers");
        return customer.id;
    });
}
async function requireCustomerCompanyMembership(supabase, userId) {
    const { data: teamMember } = await supabase.from("company_memberships").select("company_id").eq("user_id", userId).single();
    if (!teamMember?.company_id) {
        throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("You must be part of a company", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, HTTP_STATUS_FORBIDDEN);
    }
    return teamMember;
}
function parseCustomerContactsPropertiesAndTags(formData) {
    const contacts = parseContacts(formData.get("contacts"));
    const properties = parseProperties(formData.get("properties"));
    const tags = parseTagsField(formData.get("tags"));
    return {
        contacts,
        properties,
        tags
    };
}
function parseContacts(value) {
    if (!value || typeof value !== "string") {
        return [];
    }
    try {
        return JSON.parse(value);
    } catch  {
        throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Invalid contacts data", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].VALIDATION_FAILED);
    }
}
function parseProperties(value) {
    if (!value || typeof value !== "string") {
        return [];
    }
    try {
        return JSON.parse(value);
    } catch  {
        throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Invalid properties data", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].VALIDATION_FAILED);
    }
}
function parseTagsField(value) {
    if (!value || typeof value !== "string") {
        return;
    }
    try {
        return JSON.parse(value);
    } catch  {
        return value.split(",").map((t)=>t.trim());
    }
}
function getPrimaryContactOrThrow(contacts) {
    const primaryContact = contacts.find((c)=>c.isPrimary) || contacts[0];
    if (!primaryContact) {
        throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("At least one contact is required", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].VALIDATION_FAILED);
    }
    return primaryContact;
}
function getPrimaryProperty(properties) {
    return properties.find((p)=>p.isPrimary) || properties[0];
}
async function assertCustomerEmailNotDuplicate(supabase, companyId, email) {
    const { data: existingEmail } = await supabase.from("customers").select("id").eq("company_id", companyId).eq("email", email).is("deleted_at", null).single();
    if (existingEmail) {
        throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("A customer with this email already exists", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_DUPLICATE_ENTRY);
    }
}
function buildCustomerDisplayName(customerType, companyNameValue, primaryContact) {
    const companyName = companyNameValue ? String(companyNameValue) : null;
    if (customerType === "commercial" && companyName) {
        return companyName;
    }
    return `${primaryContact.firstName} ${primaryContact.lastName}`;
}
function buildDefaultCommunicationPreferences() {
    return {
        email: true,
        sms: true,
        phone: true,
        marketing: false
    };
}
function buildCustomerMetadata(contacts) {
    return {
        contacts: contacts.map((c)=>({
                firstName: c.firstName,
                lastName: c.lastName,
                email: c.email,
                phone: c.phone,
                role: c.role,
                isPrimary: c.isPrimary
            }))
    };
}
async function geocodePrimaryPropertyIfAvailable(primaryProperty) {
    if (!(primaryProperty?.address && primaryProperty.city && primaryProperty.state && primaryProperty.zipCode)) {
        return {
            lat: null,
            lon: null
        };
    }
    const geocodeResult = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$services$2f$geocoding$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["geocodeAddressSilent"])(primaryProperty.address, primaryProperty.city, primaryProperty.state, primaryProperty.zipCode, primaryProperty.country || "USA");
    if (!geocodeResult) {
        return {
            lat: null,
            lon: null
        };
    }
    return {
        lat: geocodeResult.lat,
        lon: geocodeResult.lon
    };
}
async function insertCustomerRecord(supabase, params) {
    const payload = buildCustomerInsertPayload(params);
    const { data: customer, error: createError } = await supabase.from("customers").insert(payload).select("id").single();
    if (createError || !customer) {
        throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_MESSAGES"].operationFailed("create customer"), __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_QUERY_ERROR);
    }
    return customer;
}
function buildCustomerInsertPayload(params) {
    const { companyId, customerType, primaryContact, companyNameValue, displayName, primaryProperty, customerLat, customerLon, formData, tags, communicationPreferences, customerMetadata } = params;
    const companyName = companyNameValue ? String(companyNameValue) : null;
    return {
        company_id: companyId,
        type: String(customerType || "residential"),
        first_name: primaryContact.firstName,
        last_name: primaryContact.lastName,
        company_name: companyName,
        display_name: displayName,
        email: primaryContact.email,
        phone: primaryContact.phone,
        secondary_phone: null,
        address: primaryProperty?.address || null,
        address2: primaryProperty?.address2 || null,
        city: primaryProperty?.city || null,
        state: primaryProperty?.state || null,
        zip_code: primaryProperty?.zipCode || null,
        country: primaryProperty?.country || "USA",
        lat: customerLat,
        lon: customerLon,
        source: formData.get("source") ? String(formData.get("source")) : null,
        referred_by: formData.get("referredBy") ? String(formData.get("referredBy")) : null,
        preferred_contact_method: String(formData.get("preferredContactMethod")) || "email",
        preferred_technician: formData.get("preferredTechnician") ? String(formData.get("preferredTechnician")) : null,
        billing_email: formData.get("billingEmail") ? String(formData.get("billingEmail")) : null,
        payment_terms: String(formData.get("paymentTerms")) || "due_on_receipt",
        credit_limit: formData.get("creditLimit") ? Number(formData.get("creditLimit")) * CENTS_PER_DOLLAR : 0,
        tax_exempt: formData.get("taxExempt") === "on",
        tax_exempt_number: formData.get("taxExemptNumber") ? String(formData.get("taxExemptNumber")) : null,
        tags: tags || null,
        communication_preferences: communicationPreferences,
        notes: formData.get("notes") ? String(formData.get("notes")) : null,
        internal_notes: formData.get("internalNotes") ? String(formData.get("internalNotes")) : null,
        metadata: customerMetadata,
        status: "active",
        portal_enabled: false,
        total_revenue: 0,
        total_jobs: 0,
        total_invoices: 0,
        average_job_value: 0,
        outstanding_balance: 0
    };
}
async function insertAdditionalPropertiesIfAny(supabase, companyId, customerId, properties) {
    const additionalProperties = properties.filter((p)=>!p.isPrimary);
    if (additionalProperties.length === 0) {
        return;
    }
    const propertiesToInsert = await Promise.all(additionalProperties.map(async (prop)=>{
        let propLat = null;
        let propLon = null;
        if (prop.address && prop.city && prop.state && prop.zipCode) {
            const geocodeResult = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$services$2f$geocoding$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["geocodeAddressSilent"])(prop.address, prop.city, prop.state, prop.zipCode, prop.country || "USA");
            if (geocodeResult) {
                propLat = geocodeResult.lat;
                propLon = geocodeResult.lon;
            }
        }
        return {
            company_id: companyId,
            customer_id: customerId,
            name: prop.name || "Additional Property",
            address: prop.address,
            address2: prop.address2 || null,
            city: prop.city,
            state: prop.state,
            zip_code: prop.zipCode,
            country: prop.country || "USA",
            property_type: prop.propertyType || "residential",
            notes: prop.notes || null,
            lat: propLat,
            lon: propLon
        };
    }));
    await supabase.from("properties").insert(propertiesToInsert);
}
/**
 * Update existing customer
 */ async function updateCustomer(customerId, formData) {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        const { data: { user } } = await supabase.auth.getUser();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertAuthenticated"])(user?.id);
        const teamMember = await requireCustomerCompanyMembership(supabase, user.id);
        // Verify customer exists and belongs to company
        const { data: customer } = await supabase.from("customers").select("id, company_id, email").eq("id", customerId).is("deleted_at", null).single();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertExists"])(customer, "Customer");
        if (customer.company_id !== teamMember.company_id) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Customer not found", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, HTTP_STATUS_FORBIDDEN);
        }
        // Parse tags if provided
        let tags;
        const tagsString = formData.get("tags");
        if (tagsString && typeof tagsString === "string") {
            try {
                tags = JSON.parse(tagsString);
            } catch  {
                tags = tagsString.split(",").map((t)=>t.trim());
            }
        }
        // Validate input
        const data = customerSchema.parse({
            type: formData.get("type") || "residential",
            firstName: formData.get("firstName"),
            lastName: formData.get("lastName"),
            companyName: formData.get("companyName") || undefined,
            email: formData.get("email"),
            phone: formData.get("phone"),
            secondaryPhone: formData.get("secondaryPhone") || undefined,
            address: formData.get("address") || undefined,
            address2: formData.get("address2") || undefined,
            city: formData.get("city") || undefined,
            state: formData.get("state") || undefined,
            zipCode: formData.get("zipCode") || undefined,
            country: formData.get("country") || "USA",
            source: formData.get("source") || undefined,
            referredBy: formData.get("referredBy") || null,
            preferredContactMethod: formData.get("preferredContactMethod") || "email",
            preferredTechnician: formData.get("preferredTechnician") || null,
            billingEmail: formData.get("billingEmail") || null,
            paymentTerms: formData.get("paymentTerms") || "due_on_receipt",
            creditLimit: formData.get("creditLimit") ? Number(formData.get("creditLimit")) : 0,
            taxExempt: formData.get("taxExempt") === "true",
            taxExemptNumber: formData.get("taxExemptNumber") || undefined,
            tags,
            notes: formData.get("notes") || undefined,
            internalNotes: formData.get("internalNotes") || undefined
        });
        // Check if email already exists (excluding current customer)
        if (data.email !== customer.email) {
            const { data: existingEmail } = await supabase.from("customers").select("id").eq("company_id", teamMember.company_id).eq("email", data.email).neq("id", customerId).is("deleted_at", null).single();
            if (existingEmail) {
                throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("A customer with this email already exists", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_DUPLICATE_ENTRY);
            }
        }
        // Generate display name
        const displayName = data.type === "commercial" && data.companyName ? data.companyName : `${data.firstName} ${data.lastName}`;
        const companyName = data.companyName ? String(data.companyName) : null;
        // Update customer
        const { error: updateError } = await supabase.from("customers").update({
            type: data.type,
            first_name: data.firstName,
            last_name: data.lastName,
            company_name: companyName,
            display_name: displayName,
            email: data.email,
            phone: data.phone,
            secondary_phone: data.secondaryPhone,
            address: data.address,
            address2: data.address2,
            city: data.city,
            state: data.state,
            zip_code: data.zipCode,
            country: data.country,
            source: data.source,
            referred_by: data.referredBy,
            preferred_contact_method: data.preferredContactMethod,
            preferred_technician: data.preferredTechnician,
            billing_email: data.billingEmail,
            payment_terms: data.paymentTerms,
            credit_limit: data.creditLimit,
            tax_exempt: data.taxExempt,
            tax_exempt_number: data.taxExemptNumber,
            tags: data.tags,
            notes: data.notes,
            internal_notes: data.internalNotes
        }).eq("id", customerId);
        if (updateError) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_MESSAGES"].operationFailed("update customer"), __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_QUERY_ERROR);
        }
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$cache$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["revalidatePath"])("/dashboard/customers");
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$cache$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["revalidatePath"])(`/dashboard/customers/${customerId}`);
    });
}
async function deleteCustomer(customerId) {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        const { data: { user } } = await supabase.auth.getUser();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertAuthenticated"])(user?.id);
        const teamMember = await requireCustomerCompanyMembership(supabase, user.id);
        // Verify customer exists and belongs to company
        const { data: customer } = await supabase.from("customers").select("id, company_id, outstanding_balance").eq("id", customerId).is("deleted_at", null).single();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertExists"])(customer, "Customer");
        if (customer.company_id !== teamMember.company_id) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Customer not found", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, HTTP_STATUS_FORBIDDEN);
        }
        // Prevent deletion if customer has outstanding balance
        if (customer.outstanding_balance > 0) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Cannot delete customer with outstanding balance. Collect payment first.", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].BUSINESS_RULE_VIOLATION);
        }
        // Soft delete
        const { error: deleteError } = await supabase.from("customers").update({
            deleted_at: new Date().toISOString(),
            deleted_by: user.id,
            status: "archived"
        }).eq("id", customerId);
        if (deleteError) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_MESSAGES"].operationFailed("delete customer"), __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_QUERY_ERROR);
        }
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$cache$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["revalidatePath"])("/dashboard/customers");
    });
}
// ============================================================================
// CUSTOMER STATUS & PREFERENCES
// ============================================================================
/**
 * Update customer status
 */ async function updateCustomerStatus(customerId, status) {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        const { data: { user } } = await supabase.auth.getUser();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertAuthenticated"])(user?.id);
        const teamMember = await requireCustomerCompanyMembership(supabase, user.id);
        // Verify customer exists and belongs to company
        const { data: customer } = await supabase.from("customers").select("id, company_id").eq("id", customerId).is("deleted_at", null).single();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertExists"])(customer, "Customer");
        if (customer.company_id !== teamMember.company_id) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Customer not found", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, HTTP_STATUS_FORBIDDEN);
        }
        // Update status
        const { error: updateError } = await supabase.from("customers").update({
            status
        }).eq("id", customerId);
        if (updateError) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_MESSAGES"].operationFailed("update customer status"), __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_QUERY_ERROR);
        }
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$cache$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["revalidatePath"])("/dashboard/customers");
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$cache$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["revalidatePath"])(`/dashboard/customers/${customerId}`);
    });
}
/**
 * Update communication preferences
 */ async function updateCommunicationPreferences(customerId, formData) {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        const { data: { user } } = await supabase.auth.getUser();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertAuthenticated"])(user?.id);
        const teamMember = await requireCustomerCompanyMembership(supabase, user.id);
        // Verify customer exists and belongs to company
        const { data: customer } = await supabase.from("customers").select("id, company_id").eq("id", customerId).is("deleted_at", null).single();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertExists"])(customer, "Customer");
        if (customer.company_id !== teamMember.company_id) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Customer not found", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, HTTP_STATUS_FORBIDDEN);
        }
        // Validate input
        const preferences = communicationPreferencesSchema.parse({
            email: formData.get("email") === "true",
            sms: formData.get("sms") === "true",
            phone: formData.get("phone") === "true",
            marketing: formData.get("marketing") === "true"
        });
        // Update preferences
        const { error: updateError } = await supabase.from("customers").update({
            communication_preferences: preferences
        }).eq("id", customerId);
        if (updateError) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_MESSAGES"].operationFailed("update communication preferences"), __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_QUERY_ERROR);
        }
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$cache$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["revalidatePath"])(`/dashboard/customers/${customerId}`);
    });
}
// ============================================================================
// CUSTOMER PORTAL
// ============================================================================
/**
 * Invite customer to portal
 * Sends an email with a secure token-based invitation link.
 */ async function inviteToPortal(customerId) {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        const { data: { user } } = await supabase.auth.getUser();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertAuthenticated"])(user?.id);
        const teamMember = await requireCustomerCompanyMembership(supabase, user.id);
        // Verify customer exists and belongs to company
        const { data: customer } = await supabase.from("customers").select("id, company_id, email, display_name, portal_enabled").eq("id", customerId).is("deleted_at", null).single();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertExists"])(customer, "Customer");
        if (customer.company_id !== teamMember.company_id) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Customer not found", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, HTTP_STATUS_FORBIDDEN);
        }
        if (customer.portal_enabled) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Customer is already invited to portal", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].BUSINESS_RULE_VIOLATION);
        }
        // Generate secure portal invitation token
        const inviteToken = Buffer.from(`${customerId}:${Date.now()}:${Math.random()}`).toString("base64url");
        // Update customer
        const { error: updateError } = await supabase.from("customers").update({
            portal_enabled: true,
            portal_invited_at: new Date().toISOString()
        }).eq("id", customerId);
        if (updateError) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_MESSAGES"].operationFailed("invite customer to portal"), __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_QUERY_ERROR);
        }
        // Send invitation email
        const siteUrl = requireSiteUrl();
        const portalUrl = `${siteUrl}/portal/setup?token=${inviteToken}`;
        const emailResult = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$email$2d$sender$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["sendEmail"])({
            to: customer.email,
            subject: "You've been invited to your Customer Portal",
            template: (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$emails$2f$templates$2f$customer$2f$portal$2d$invitation$2e$tsx__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])({
                customerName: customer.display_name,
                portalUrl,
                expiresInHours: 168,
                supportEmail: process.env.RESEND_FROM_EMAIL || "support@thorbis.com",
                supportPhone: "(555) 123-4567"
            }),
            templateType: __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$email$2f$email$2d$types$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["EmailTemplate"].PORTAL_INVITATION
        });
        if (!emailResult.success) {
            return;
        }
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$cache$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["revalidatePath"])("/dashboard/customers");
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$cache$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["revalidatePath"])(`/dashboard/customers/${customerId}`);
    });
}
/**
 * Revoke portal access
 */ async function revokePortalAccess(customerId) {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        const { data: { user } } = await supabase.auth.getUser();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertAuthenticated"])(user?.id);
        const teamMember = await requireCustomerCompanyMembership(supabase, user.id);
        // Verify customer exists and belongs to company
        const { data: customer } = await supabase.from("customers").select("id, company_id").eq("id", customerId).is("deleted_at", null).single();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertExists"])(customer, "Customer");
        if (customer.company_id !== teamMember.company_id) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Customer not found", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, HTTP_STATUS_FORBIDDEN);
        }
        // Revoke access
        const { error: updateError } = await supabase.from("customers").update({
            portal_enabled: false
        }).eq("id", customerId);
        if (updateError) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_MESSAGES"].operationFailed("revoke portal access"), __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_QUERY_ERROR);
        }
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$cache$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["revalidatePath"])("/dashboard/customers");
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$cache$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["revalidatePath"])(`/dashboard/customers/${customerId}`);
    });
}
async function getCustomerByPhone(phoneNumber, companyId) {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        // Normalize phone number (remove formatting)
        const normalizedPhone = phoneNumber.replace(/\D/g, "");
        // Search by primary phone or secondary phone
        const { data: customer, error } = await supabase.from("customers").select(`
        *,
        properties:properties(*)
      `).eq("company_id", companyId).or(`phone.eq.${phoneNumber},phone.eq.${normalizedPhone},secondary_phone.eq.${phoneNumber},secondary_phone.eq.${normalizedPhone}`).single();
        if (error && error.code !== "PGRST116") {
            // PGRST116 = no rows found
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](`Failed to find customer: ${error.message}`, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_QUERY_ERROR);
        }
        return customer || null;
    });
}
async function searchCustomers(searchTerm, options) {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        const { data: { user } } = await supabase.auth.getUser();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertAuthenticated"])(user?.id);
        // Use the active company ID helper (same as getAllCustomers)
        const activeCompanyId = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$auth$2f$src$2f$company$2d$context$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getActiveCompanyId"])();
        if (!activeCompanyId) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("No active company", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, HTTP_STATUS_FORBIDDEN);
        }
        // Verify user has access to the active company
        const { data: teamMember } = await supabase.from("company_memberships").select("company_id").eq("user_id", user.id).eq("company_id", activeCompanyId).eq("status", "active").maybeSingle();
        if (!teamMember?.company_id) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("You don't have access to this company", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, HTTP_STATUS_FORBIDDEN);
        }
        // Use full-text search with ranking for best matches
        // Searches across: first_name, last_name, display_name, email, phone,
        // secondary_phone, company_name, address, city, state
        // Returns results ordered by relevance (weighted: name > contact > address)
        const { searchCustomersFullText } = await __turbopack_context__.A("[project]/apps/web/src/lib/search/full-text-search.ts [app-route] (ecmascript, async loader)");
        const customers = await searchCustomersFullText(supabase, activeCompanyId, searchTerm, {
            limit: options?.limit || DEFAULT_SEARCH_LIMIT,
            offset: options?.offset || 0
        });
        return customers;
    });
}
/**
 * Get top customers by revenue
 */ async function getTopCustomers(limit = 10) {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        const { data: { user } } = await supabase.auth.getUser();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertAuthenticated"])(user?.id);
        const { data: teamMember } = await supabase.from("company_memberships").select("company_id").eq("user_id", user.id).single();
        if (!teamMember?.company_id) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("You must be part of a company", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, HTTP_STATUS_FORBIDDEN);
        }
        const { data: customers, error } = await supabase.from("customers").select("*").eq("company_id", teamMember.company_id).eq("status", "active").is("deleted_at", null).order("total_revenue", {
            ascending: false
        }).limit(limit);
        if (error) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_MESSAGES"].operationFailed("fetch top customers"), __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_QUERY_ERROR);
        }
        return customers || [];
    });
}
async function getCustomersWithBalance() {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        const { data: { user } } = await supabase.auth.getUser();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertAuthenticated"])(user?.id);
        const { data: teamMember } = await supabase.from("company_memberships").select("company_id").eq("user_id", user.id).single();
        if (!teamMember?.company_id) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("You must be part of a company", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, HTTP_STATUS_FORBIDDEN);
        }
        const { data: customers, error } = await supabase.from("customers").select("*").eq("company_id", teamMember.company_id).is("deleted_at", null).gt("outstanding_balance", 0).order("outstanding_balance", {
            ascending: false
        }).limit(100);
        if (error) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_MESSAGES"].operationFailed("fetch customers with balance"), __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_QUERY_ERROR);
        }
        return customers || [];
    });
}
async function getCustomersForDialer() {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        const { data: { user } } = await supabase.auth.getUser();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertAuthenticated"])(user?.id);
        const activeCompanyId = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$auth$2f$src$2f$company$2d$context$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getActiveCompanyId"])();
        if (!activeCompanyId) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("No active company", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, 403);
        }
        // Single lightweight query - no joins, no enrichment
        const { data: customers, error } = await supabase.from("customers").select("id, first_name, last_name, display_name, email, phone, secondary_phone, company_name, address, address2, city, state, zip_code").eq("company_id", activeCompanyId).is("deleted_at", null).order("display_name", {
            ascending: true
        });
        if (error) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_MESSAGES"].operationFailed("fetch customers"), __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_QUERY_ERROR);
        }
        return customers || [];
    });
}
/**
 * Get all customers for the current company (WITH ENRICHMENT)
 *
 * WARNING: This function does 151 database queries for 50 customers (N+1 pattern).
 * Expected time: 1200-2000ms
 *
 * DO NOT use in AppHeader or other frequently rendered components.
 * Use getCustomersForDialer() instead for lightweight contact info.
 *
 * Only use this on dedicated customer list pages where the enriched data is needed.
 */ async function getAllCustomers() {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        const { data: { user } } = await supabase.auth.getUser();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertAuthenticated"])(user?.id);
        // Get active company ID (from cookie or first available)
        const activeCompanyId = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$auth$2f$src$2f$company$2d$context$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getActiveCompanyId"])();
        const FORBIDDEN_STATUS_CODE = 403;
        if (!activeCompanyId) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("You must be part of a company", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, FORBIDDEN_STATUS_CODE);
        }
        // Verify user has access to the active company
        const { data: teamMember } = await supabase.from("company_memberships").select("company_id").eq("user_id", user.id).eq("company_id", activeCompanyId).eq("status", "active").maybeSingle();
        if (!teamMember?.company_id) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("You don't have access to this company", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, FORBIDDEN_STATUS_CODE);
        }
        const { data: customers, error } = await supabase.from("customers").select("*").eq("company_id", activeCompanyId).is("deleted_at", null).order("display_name", {
            ascending: true
        });
        if (error) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_MESSAGES"].operationFailed("fetch customers"), __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_QUERY_ERROR);
        }
        // PERFORMANCE OPTIMIZED: Use RPC function instead of N+1 queries
        // BEFORE: 151 queries for 50 customers (1 base + 50  3 queries each)
        // AFTER: 1 RPC call with efficient LATERAL joins
        // Performance gain: 5-10 seconds faster
        // Note: customers variable contains the base customer data from above query
        // We replace the enrichment logic with a single RPC call
        const { data: enrichedData, error: enrichError } = await supabase.rpc("get_enriched_customers_rpc", {
            p_company_id: activeCompanyId
        });
        if (enrichError) {
            // Fallback to base customers if enrichment fails
            console.error("Failed to enrich customers:", enrichError);
            return customers;
        }
        // Merge enriched data with base customer data
        const enrichedCustomers = (enrichedData || []).map((customer)=>({
                ...customer,
                // Override total_jobs and total_revenue with fresh aggregated values
                total_jobs: customer.enriched_total_jobs || customer.total_jobs || 0,
                total_revenue: customer.enriched_total_revenue || customer.total_revenue || 0
            }));
        return enrichedCustomers;
    });
}
/**
 * Update customer page content (Novel/Tiptap JSON)
 *
 * Saves the customer's editable page layout and content
 * Used by the Novel editor for auto-save functionality
 */ async function updateCustomerPageContent(customerId, pageContent) {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["withErrorHandling"])(async ()=>{
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$packages$2f$database$2f$src$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        if (!supabase) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("Database connection failed", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_CONNECTION_ERROR);
        }
        const { data: { user } } = await supabase.auth.getUser();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertAuthenticated"])(user?.id);
        const { data: teamMember } = await supabase.from("company_memberships").select("company_id").eq("user_id", user.id).single();
        if (!teamMember?.company_id) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"]("You must be part of a company", __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, HTTP_STATUS_FORBIDDEN);
        }
        // Verify customer exists and belongs to company
        const { data: customer } = await supabase.from("customers").select("id, company_id").eq("id", customerId).is("deleted_at", null).single();
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$with$2d$error$2d$handling$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["assertExists"])(customer, "Customer");
        if (customer.company_id !== teamMember.company_id) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_MESSAGES"].forbidden("customer"), __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].AUTH_FORBIDDEN, HTTP_STATUS_FORBIDDEN);
        }
        // Update page content
        const { error: updateError } = await supabase.from("customers").update({
            page_content: pageContent,
            content_updated_by: user.id
        }).eq("id", customerId);
        if (updateError) {
            throw new __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ActionError"](__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_MESSAGES"].operationFailed("update customer page"), __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$lib$2f$errors$2f$action$2d$error$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ERROR_CODES"].DB_QUERY_ERROR);
        }
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$cache$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["revalidatePath"])(`/dashboard/customers/${customerId}`);
    });
}
;
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ensureServerEntryExports"])([
    deleteCustomer,
    getCustomerByPhone,
    searchCustomers,
    getCustomersForDialer
]);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(deleteCustomer, "40b277f535f8a989546d6c7e3a1af8abe77de6c459", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(getCustomerByPhone, "604ac8c079e9497e74d11dd7c17f442078174db43f", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(searchCustomers, "6048659199289e27e8a29c146dcc920a7afc8ad29e", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(getCustomersForDialer, "00337bf9ccf6d7f5002dfdd1c39a50a1925fa9cd70", null);
__turbopack_async_result__();
} catch(e) { __turbopack_async_result__(e); } }, false);}),
"[project]/apps/web/src/app/api/dialer/customers/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

return __turbopack_context__.a(async (__turbopack_handle_async_dependencies__, __turbopack_async_result__) => { try {

__turbopack_context__.s([
    "GET",
    ()=>GET
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.0.4_@opentelemetry+api@1.9.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$actions$2f$customers$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/src/actions/customers.ts [app-route] (ecmascript)");
var __turbopack_async_dependencies__ = __turbopack_handle_async_dependencies__([
    __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$actions$2f$customers$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__
]);
[__TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$actions$2f$customers$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__] = __turbopack_async_dependencies__.then ? (await __turbopack_async_dependencies__)() : __turbopack_async_dependencies__;
;
;
async function GET() {
    try {
        const result = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$src$2f$actions$2f$customers$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getCustomersForDialer"])();
        if (!result.success || !result.data) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: result.error ?? "Failed to load customers"
            }, {
                status: 500
            });
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            customers: result.data
        });
    } catch (error) {
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$4_$40$opentelemetry$2b$api$40$1$2e$9$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: error instanceof Error ? error.message : "Failed to load customers"
        }, {
            status: 500
        });
    }
}
__turbopack_async_result__();
} catch(e) { __turbopack_async_result__(e); } }, false);}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__781829ac._.js.map