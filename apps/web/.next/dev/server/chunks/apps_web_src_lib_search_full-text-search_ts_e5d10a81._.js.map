{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/search/full-text-search.ts"],"sourcesContent":["/**\n * Full-Text Search Utilities\n *\n * Provides enterprise-grade PostgreSQL full-text search with:\n * - Weighted ranking (ts_rank) for best match results\n * - Multi-field search across all relevant columns\n * - Fuzzy matching with pg_trgm for typo tolerance\n * - Company-scoped security (RLS enforced)\n *\n * Performance:\n * - Uses GIN indexes for sub-millisecond search\n * - Searches millions of records efficiently\n * - Returns top 50 results by default (configurable)\n *\n * Search Features:\n * - Multi-word queries: \"john plumber\" matches both words\n * - Phrase search: Use quotes for exact phrases\n * - Fuzzy matching: Handles typos and variations\n * - Weighted fields: Name matches rank higher than notes\n */\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\n\n/**\n * Search result with ranking score\n */\nexport type SearchResult<T> = T & {\n\tsearch_rank?: number;\n\tsearch_similarity?: number;\n};\n\n/**\n * Search options for customization\n */\nexport type SearchOptions = {\n\tlimit?: number;\n\toffset?: number;\n\tminSimilarity?: number; // 0-1, default 0.3\n\tuseFullTextSearch?: boolean; // Default true\n\tuseFuzzyMatch?: boolean; // Default true\n\torderBy?: string; // Additional ordering after rank\n};\n\n/**\n * Search customers with full-text search and ranking\n *\n * Searches across: first_name, last_name, display_name, email, phone, company_name, address\n * Returns results ordered by relevance (best matches first)\n *\n * @example\n * const results = await searchCustomersFullText(supabase, companyId, \"john plumber\");\n * // Returns customers matching \"john\" AND \"plumber\" ranked by relevance\n */\nexport async function searchCustomersFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst {\n\t\tlimit = 50,\n\t\toffset = 0,\n\t\tminSimilarity = 0.3,\n\t\tuseFullTextSearch = true,\n\t\tuseFuzzyMatch = true,\n\t} = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_customers_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search if full-text search not available or fails\n\tconst { data } = await supabase\n\t\t.from(\"customers\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.or(\n\t\t\t`display_name.ilike.%${query}%,email.ilike.%${query}%,phone.ilike.%${query}%,company_name.ilike.%${query}%,address.ilike.%${query}%,city.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"display_name\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search jobs with full-text search and ranking\n *\n * Searches across: job_number, title, description, notes, job_type, status, priority\n * Returns results ordered by relevance\n */\nexport async function searchJobsFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 50, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_jobs_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"jobs\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.or(\n\t\t\t`job_number.ilike.%${query}%,title.ilike.%${query}%,description.ilike.%${query}%,notes.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search properties with full-text search and ranking\n *\n * Searches across: name, address, city, state, zip_code, notes\n * Returns results ordered by relevance\n */\nasync function searchPropertiesFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 50, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_properties_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"properties\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.or(\n\t\t\t`name.ilike.%${query}%,address.ilike.%${query}%,city.ilike.%${query}%,state.ilike.%${query}%,zip_code.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"address\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search price book items with full-text search and ranking\n *\n * Searches across: name, sku, supplier_sku, description, category, subcategory\n * Returns results ordered by relevance\n */\nasync function searchPriceBookItemsFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 100, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\n\t\t\t\"search_price_book_items_ranked\",\n\t\t\t{\n\t\t\t\tcompany_id_param: companyId,\n\t\t\t\tsearch_query: query,\n\t\t\t\tresult_limit: limit,\n\t\t\t\tresult_offset: offset,\n\t\t\t},\n\t\t);\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"price_book_items\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.or(\n\t\t\t`name.ilike.%${query}%,sku.ilike.%${query}%,supplier_sku.ilike.%${query}%,description.ilike.%${query}%,category.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"name\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search equipment with full-text search and ranking\n *\n * Searches across: equipment_number, name, type, manufacturer, model, serial_number\n * Returns results ordered by relevance\n */\nasync function searchEquipmentFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 50, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_equipment_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"equipment\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.or(\n\t\t\t`equipment_number.ilike.%${query}%,name.ilike.%${query}%,type.ilike.%${query}%,manufacturer.ilike.%${query}%,model.ilike.%${query}%,serial_number.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"name\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Universal search function - searches across ALL entities\n *\n * Returns combined results from customers, jobs, properties, equipment, etc.\n * Useful for global search functionality\n */\nexport async function searchAllEntities(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<{\n\tcustomers: SearchResult<any>[];\n\tjobs: SearchResult<any>[];\n\tproperties: SearchResult<any>[];\n\tequipment: SearchResult<any>[];\n\tpriceBookItems: SearchResult<any>[];\n}> {\n\tconst defaultLimit = options.limit || 10; // Limit per entity\n\n\tconst [customers, jobs, properties, equipment, priceBookItems] =\n\t\tawait Promise.all([\n\t\t\tsearchCustomersFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchJobsFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchPropertiesFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchEquipmentFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchPriceBookItemsFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t]);\n\n\treturn {\n\t\tcustomers,\n\t\tjobs,\n\t\tproperties,\n\t\tequipment,\n\t\tpriceBookItems,\n\t};\n}\n"],"names":[],"mappings":"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"}}]
}