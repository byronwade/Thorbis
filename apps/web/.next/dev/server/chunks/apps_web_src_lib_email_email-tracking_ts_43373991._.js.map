{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/byronwade/Stratos/apps/web/src/lib/email/email-tracking.ts"],"sourcesContent":["/**\n * Email Tracking Utilities\n * \n * Adds tracking pixels and link tracking to all outgoing emails\n * to track opens, clicks, and delivery status.\n */\n\n/**\n * Generate a tracking pixel URL for email opens\n */\nfunction generateTrackingPixelUrl(\n\tcommunicationId: string,\n\tbaseUrl: string = process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\"\n): string {\n\treturn `${baseUrl}/api/email/track/open?c=${encodeURIComponent(communicationId)}`;\n}\n\n/**\n * Generate a tracking URL for link clicks\n */\nfunction generateTrackingClickUrl(\n\tcommunicationId: string,\n\toriginalUrl: string,\n\tbaseUrl: string = process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\"\n): string {\n\treturn `${baseUrl}/api/email/track/click?c=${encodeURIComponent(communicationId)}&u=${encodeURIComponent(originalUrl)}`;\n}\n\n/**\n * Inject tracking pixel into HTML email\n * Adds a 1x1 transparent pixel at the end of the email body\n */\nfunction injectTrackingPixel(\n\thtml: string,\n\tcommunicationId: string,\n\tbaseUrl?: string\n): string {\n\tconst trackingUrl = generateTrackingPixelUrl(communicationId, baseUrl);\n\t\n\t// Create tracking pixel\n\tconst trackingPixel = `<img src=\"${trackingUrl}\" width=\"1\" height=\"1\" style=\"display:none;width:1px;height:1px;border:0;\" alt=\"\" />`;\n\t\n\t// Try to inject before closing body tag, otherwise append to end\n\tif (html.includes(\"</body>\")) {\n\t\treturn html.replace(\"</body>\", `${trackingPixel}</body>`);\n\t}\n\t\n\t// If no body tag, append to end\n\treturn `${html}${trackingPixel}`;\n}\n\n/**\n * Wrap all links in HTML with tracking URLs\n * Preserves original link behavior while tracking clicks\n */\nfunction wrapLinksWithTracking(\n\thtml: string,\n\tcommunicationId: string,\n\tbaseUrl?: string\n): string {\n\t// Regex to find all href attributes in anchor tags\n\tconst linkRegex = /<a\\s+([^>]*\\s+)?href=[\"']([^\"']+)[\"']([^>]*)>/gi;\n\t\n\treturn html.replace(linkRegex, (match, before, url, after) => {\n\t\t// Skip if already a tracking URL or mailto/tel links\n\t\tif (\n\t\t\turl.startsWith(\"mailto:\") ||\n\t\t\turl.startsWith(\"tel:\") ||\n\t\t\turl.startsWith(\"#\") ||\n\t\t\turl.includes(\"/api/email/track/\")\n\t\t) {\n\t\t\treturn match;\n\t\t}\n\t\t\n\t\t// Generate tracking URL\n\t\tconst trackingUrl = generateTrackingClickUrl(communicationId, url, baseUrl);\n\t\t\n\t\t// Replace href with tracking URL\n\t\treturn `<a ${before || \"\"}href=\"${trackingUrl}\"${after || \"\"}>`;\n\t});\n}\n\n/**\n * Add complete tracking to email HTML\n * - Injects tracking pixel for opens\n * - Wraps all links for click tracking\n */\nexport function addEmailTracking(\n\thtml: string,\n\tcommunicationId: string,\n\tbaseUrl?: string\n): string {\n\t// First wrap links, then add tracking pixel\n\tlet trackedHtml = wrapLinksWithTracking(html, communicationId, baseUrl);\n\ttrackedHtml = injectTrackingPixel(trackedHtml, communicationId, baseUrl);\n\t\n\treturn trackedHtml;\n}\n\n"],"names":[],"mappings":"AAAA;;;;;CAKC,GAED;;CAEC;;;;AACD,SAAS,yBACR,eAAuB,EACvB,UAAkB,6DAAmC,uBAAuB;IAE5E,OAAO,GAAG,QAAQ,wBAAwB,EAAE,mBAAmB,kBAAkB;AAClF;AAEA;;CAEC,GACD,SAAS,yBACR,eAAuB,EACvB,WAAmB,EACnB,UAAkB,6DAAmC,uBAAuB;IAE5E,OAAO,GAAG,QAAQ,yBAAyB,EAAE,mBAAmB,iBAAiB,GAAG,EAAE,mBAAmB,cAAc;AACxH;AAEA;;;CAGC,GACD,SAAS,oBACR,IAAY,EACZ,eAAuB,EACvB,OAAgB;IAEhB,MAAM,cAAc,yBAAyB,iBAAiB;IAE9D,wBAAwB;IACxB,MAAM,gBAAgB,CAAC,UAAU,EAAE,YAAY,oFAAoF,CAAC;IAEpI,iEAAiE;IACjE,IAAI,KAAK,QAAQ,CAAC,YAAY;QAC7B,OAAO,KAAK,OAAO,CAAC,WAAW,GAAG,cAAc,OAAO,CAAC;IACzD;IAEA,gCAAgC;IAChC,OAAO,GAAG,OAAO,eAAe;AACjC;AAEA;;;CAGC,GACD,SAAS,sBACR,IAAY,EACZ,eAAuB,EACvB,OAAgB;IAEhB,mDAAmD;IACnD,MAAM,YAAY;IAElB,OAAO,KAAK,OAAO,CAAC,WAAW,CAAC,OAAO,QAAQ,KAAK;QACnD,qDAAqD;QACrD,IACC,IAAI,UAAU,CAAC,cACf,IAAI,UAAU,CAAC,WACf,IAAI,UAAU,CAAC,QACf,IAAI,QAAQ,CAAC,sBACZ;YACD,OAAO;QACR;QAEA,wBAAwB;QACxB,MAAM,cAAc,yBAAyB,iBAAiB,KAAK;QAEnE,iCAAiC;QACjC,OAAO,CAAC,GAAG,EAAE,UAAU,GAAG,MAAM,EAAE,YAAY,CAAC,EAAE,SAAS,GAAG,CAAC,CAAC;IAChE;AACD;AAOO,SAAS,iBACf,IAAY,EACZ,eAAuB,EACvB,OAAgB;IAEhB,4CAA4C;IAC5C,IAAI,cAAc,sBAAsB,MAAM,iBAAiB;IAC/D,cAAc,oBAAoB,aAAa,iBAAiB;IAEhE,OAAO;AACR"}}]
}