module.exports=[530533,e=>{"use strict";var t=e.i(755535),r=e.i(377233),a=e.i(490003),s=e.i(492991),i=e.i(241970),n=e.i(357699),o=e.i(212454),l=e.i(48717),c=e.i(798301),u=e.i(986366),d=e.i(983537),p=e.i(147475),h=e.i(561930),m=e.i(803747),g=e.i(368557),f=e.i(42037),w=e.i(193695);e.i(432036);var R=e.i(573881),C=e.i(297676),v=e.i(511368);class y{config;currentBatchSize;processedCount=0;successCount=0;failureCount=0;errors=[];constructor(e={}){this.config={initialSize:e.initialSize||1e3,maxSize:e.maxSize||2e3,minSize:e.minSize||500,successThreshold:e.successThreshold||.95,failureThreshold:e.failureThreshold||.85},this.currentBatchSize=this.config.initialSize}async processBatches(e,t,r,a){let s=e.length,i=0;for(let n=0;n<s;n+=this.currentBatchSize){let o=e.slice(n,n+this.currentBatchSize);i++;let l=await this.processBatch(o,t,r,i,n);this.processedCount+=l.recordsProcessed,this.successCount+=l.successCount,this.failureCount+=l.failureCount,this.errors.push(...l.errors),a&&a(this.processedCount,s),this.adjustBatchSize(l.successRate,l.duration)}return{totalProcessed:this.processedCount,successCount:this.successCount,failureCount:this.failureCount,errors:this.errors}}async processBatch(e,t,r,a,s){let i=Date.now();try{let n=await (0,v.createClient)(),o=e.map((e,t)=>({...e,company_id:r,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),_record_index:s+t})),{data:l,error:c}=await n.from(this.getTableName(t)).insert(o).select("id");if(c)return await this.processIndividually(e,t,r,a,s);let u=Date.now()-i;return{batchNumber:a,recordsProcessed:e.length,successCount:l?.length||e.length,failureCount:0,duration:u,errors:[],successRate:1}}catch(i){return console.error(`Batch ${a} failed:`,i),await this.processIndividually(e,t,r,a,s)}}async processIndividually(e,t,r,a,s){let i=Date.now(),n=[],o=0,l=await (0,v.createClient)(),c=this.getTableName(t);for(let t=0;t<e.length;t++){let a={...e[t],company_id:r,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};try{let{error:r}=await l.from(c).insert(a).select("id").single();r?n.push({recordIndex:s+t,recordData:e[t],error:r.message,code:r.code||"INSERT_FAILED",severity:"error",canRetry:!0}):o++}catch(r){n.push({recordIndex:s+t,recordData:e[t],error:r instanceof Error?r.message:"Unknown error",code:"UNEXPECTED_ERROR",severity:"error",canRetry:!0})}}let u=Date.now()-i;return{batchNumber:a,recordsProcessed:e.length,successCount:o,failureCount:e.length-o,duration:u,errors:n,successRate:o/e.length}}adjustBatchSize(e,t){e>this.config.successThreshold&&t<1e3?this.currentBatchSize=Math.min(Math.floor(1.5*this.currentBatchSize),this.config.maxSize):(e<this.config.failureThreshold||t>5e3)&&(this.currentBatchSize=Math.max(Math.floor(.75*this.currentBatchSize),this.config.minSize))}getTableName(e){return({customers:"customers",jobs:"jobs",invoices:"invoices",estimates:"estimates",equipment:"equipment",properties:"properties",team:"team_members",communications:"communications",payments:"payments",contracts:"contracts",appointments:"appointments",vendors:"vendors",purchase_orders:"purchase_orders",service_agreements:"service_agreements",maintenance_plans:"maintenance_plans"})[e]||e}getStats(){return{processedCount:this.processedCount,successCount:this.successCount,failureCount:this.failureCount,currentBatchSize:this.currentBatchSize,errorCount:this.errors.length}}reset(){this.processedCount=0,this.successCount=0,this.failureCount=0,this.errors=[],this.currentBatchSize=this.config.initialSize}}var S=e.i(365719);class _{relationshipMap;constructor(e){this.relationshipMap=e||{customers:new Map,properties:new Map,jobs:new Map,invoices:new Map,equipment:new Map,team:new Map}}async transformBatch(e,t){return e.map(e=>this.transformRecord(e,t))}transformRecord(e,t){let r={};for(let a of t){let t=e[a.sourceField];if(null==t&&!a.required){void 0!==a.defaultValue&&(r[a.targetField]=a.defaultValue);continue}let s=this.applyFieldTransformation(t,a.transformation,a.transformationParams);"split"===a.transformation&&"object"==typeof s?Object.assign(r,s):r[a.targetField]=s}return this.normalizeRecord(r)}applyFieldTransformation(e,t,r){return(0,S.applyTransformation)(e,t,r)}normalizeRecord(e){let t={...e};return t.email&&"string"==typeof t.email&&(t.email=this.normalizeEmail(t.email)),t.phone&&"string"==typeof t.phone&&(t.phone=this.normalizePhone(t.phone)),t.state&&"string"==typeof t.state&&(t.state=t.state.toUpperCase()),t.zip&&"string"==typeof t.zip&&(t.zip=this.normalizeZip(t.zip)),t.tags&&"string"==typeof t.tags&&(t.tags=t.tags.split(",").map(e=>e.trim())),t}mapRelationshipIds(e,t){let r={...e};for(let[a,s]of(e.id&&(r.external_id=String(e.id)),Object.entries({customer_id:"customers",property_id:"properties",job_id:"jobs",invoice_id:"invoices",equipment_id:"equipment",team_member_id:"team"})))if(e[a]){let i=String(e[a]),n=this.relationshipMap[s].get(i);n?r[a]=n:(console.warn(`Warning: No mapping found for ${a}=${i} in ${t}`),r[a]=null)}return r}addRelationshipMapping(e,t,r){this.relationshipMap[e].set(t,r)}getRelationshipMap(){return this.relationshipMap}normalizeEmail(e){return e.toLowerCase().trim()}normalizePhone(e){let t=e.replace(/\D/g,"");return 10===t.length?`+1${t}`:(11===t.length&&t.startsWith("1"),`+${t}`)}normalizeZip(e){let t=e.match(/(\d{5})(-?\d{4})?/);return t?t[2]?`${t[1]}-${t[2].replace("-","")}`:t[1]:e}parseAddress(e){let t=e.split(",").map(e=>e.trim());if(t.length>=3){let[e,r,a]=t,s=a.match(/([A-Z]{2})\s*(\d{5}(-\d{4})?)/);if(s)return{address:e,city:r,state:s[1],zip:s[2]}}return{address:e}}convertDateFormat(e,t="iso8601"){let r=new Date(e);if(isNaN(r.getTime()))throw Error(`Invalid date: ${e}`);switch(t){case"iso8601":case"datetime":default:return r.toISOString();case"date":return r.toISOString().split("T")[0]}}sanitizeText(e){return e.replace(/\x00/g,"").replace(/[\x00-\x1F\x7F]/g,"").trim()}}var E=e.i(158884),x=e.i(699936);async function T(e){try{let{records:t,entityType:r,mappings:a,companyId:s,userId:i,isDryRun:n=!1,duplicateHandling:o="skip",sourcePlatform:l,mappingId:c}=await e.json();if(!t||!Array.isArray(t)||0===t.length)return C.NextResponse.json({error:"records must be a non-empty array"},{status:400});if(!r)return C.NextResponse.json({error:"entityType is required"},{status:400});if(!s||!i)return C.NextResponse.json({error:"companyId and userId are required"},{status:400});let u=await (0,v.createClient)(),{data:d,error:p}=await u.from("data_imports").insert({company_id:s,user_id:i,data_type:r,source_platform:l,mapping_id:c,total_rows:t.length,successful_rows:0,failed_rows:0,status:"in_progress",is_dry_run:n,duplicate_handling_strategy:o,estimated_duration_seconds:Math.ceil(t.length/167),rollback_available_until:new Date(Date.now()+864e5).toISOString()}).select("id").single();if(p||!d)throw Error("Failed to create import job");let h=d.id;return I(h,t,r,a,s,n,o).catch(e=>{console.error(`Import ${h} failed:`,e)}),C.NextResponse.json({success:!0,data:{importId:h,status:"in_progress",totalRecords:t.length,estimatedDurationSeconds:Math.ceil(t.length/167)}})}catch(e){return console.error("Import execution error:",e),C.NextResponse.json({success:!1,error:{message:e instanceof Error?e.message:"Import execution failed",code:"IMPORT_EXECUTION_ERROR"}},{status:500})}}async function I(e,t,r,a,s,i,n){let o=Math.ceil(t.length/1e3),l=new x.ProgressTracker(e,t.length,o);try{await l.setStatus("in_progress");let e=new _,n=await e.transformBatch(t,a),o=new E.DataValidator,c=await o.validateBatch(n,r,a);if(!c.valid&&(await l.addErrors(c.errors),c.invalidRecords.length/t.length>.1))return void await l.markFailed("Too many validation errors (> 10%)");let u=c.validRecords;if(i){await l.updateProgress(u.length,u.length,0),await l.markComplete();return}let d=new y,p=await d.processBatches(u,r,s,(e,t)=>{let r=d.getStats();l.updateProgress(e,r.successCount,r.failureCount)});p.errors.length>0&&await l.addErrors(p.errors),await l.markComplete()}catch(t){console.error(`Import ${e} failed:`,t),await l.markFailed(t instanceof Error?t.message:"Import failed")}}async function O(){return new C.NextResponse(null,{status:204,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}e.s(["OPTIONS",()=>O,"POST",()=>T,"maxDuration",0,300],619188);var A=e.i(619188);let N=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/import/execute/route",pathname:"/api/import/execute",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/import/execute/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:b,workUnitAsyncStorage:P,serverHooks:z}=N;function M(){return(0,a.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:P})}async function D(e,t,a){N.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let C="/api/import/execute/route";C=C.replace(/\/index$/,"")||"/";let v=await N.prepare(e,t,{srcPage:C,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:S,nextConfig:_,parsedUrl:E,isDraftMode:x,prerenderManifest:T,routerServerContext:I,isOnDemandRevalidate:O,revalidateOnlyGenerated:A,resolvedPathname:b,clientReferenceManifest:P,serverActionsManifest:z}=v,M=(0,l.normalizeAppPath)(C),D=!!(T.dynamicRoutes[M]||T.routes[b]),B=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,E,!1):t.end("This page could not be found"),null);if(D&&!x){let e=!!T.routes[b],t=T.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(_.experimental.adapterPath)return await B();throw new w.NoFallbackError}}let j=null;!D||N.isDev||x||(j="/index"===(j=b)?"/":j);let q=!0===N.isDev||!D,k=D&&!q;z&&P&&(0,n.setReferenceManifestsSingleton)({page:C,clientReferenceManifest:P,serverActionsManifest:z,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:z})});let F=e.method||"GET",U=(0,i.getTracer)(),$=U.getActiveScopeSpan(),H={params:S,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!_.experimental.authInterrupts},cacheComponents:!!_.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:_.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>N.onRequestError(e,t,a,I)},sharedContext:{buildId:y}},K=new c.NodeNextRequest(e),L=new c.NodeNextResponse(t),V=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let n=async e=>N.handle(V,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=U.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${F} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${C}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var i,l;let c=async({previousCacheEntry:r})=>{try{if(!o&&O&&A&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await n(s);e.fetchMetrics=H.renderOpts.fetchMetrics;let l=H.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=H.renderOpts.collectedTags;if(!D)return await (0,h.sendResponse)(K,L,i,H.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,a=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:C,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:O})},I),t}},u=await N.handleResponse({req:e,nextConfig:_,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:A,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:o});if(!D)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",O?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,m.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&D||d.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(K,L,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};$?await l($):await U.withPropagatedContext(e.headers,()=>U.trace(d.BaseServerSpan.handleRequest,{spanName:`${F} ${C}`,kind:i.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:O})}),D)throw t;return await (0,h.sendResponse)(K,L,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>M,"routeModule",()=>N,"serverHooks",()=>z,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>P],530533)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_3bd56a90.js.map