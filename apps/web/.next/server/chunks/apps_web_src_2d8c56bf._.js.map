{"version":3,"sources":["../../../../../apps/web/src/actions/messaging-branding.ts","../../../../../apps/web/src/lib/telnyx/messaging-profile-setup.ts","../../../../../apps/web/src/lib/telnyx/numbers.ts","../../../../../apps/web/src/lib/telnyx/phone-number-setup.ts","../../../../../apps/web/src/lib/telnyx/api.ts","../../../../../apps/web/src/lib/telnyx/rate-limiter.ts","../../../../../apps/web/src/lib/telnyx/ten-dlc.ts"],"sourcesContent":["\"use server\";\n\nimport type { SupabaseClient as SupabaseJsClient } from \"@supabase/supabase-js\";\nimport { revalidatePath } from \"next/cache\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport {\n\tattachNumberToCampaign,\n\tcreateTenDlcBrand,\n\tcreateTenDlcCampaign,\n\tgetTenDlcBrand,\n\tgetTenDlcCampaign,\n} from \"@/lib/telnyx/ten-dlc\";\nimport type { Database } from \"@/types/supabase\";\n\ntype TypedSupabaseClient = SupabaseJsClient<Database>;\n\ntype OwnerContactRow = {\n\tfull_name?: string | null;\n\temail?: string | null;\n\tphone?: string | null;\n};\n\nconst DEFAULT_MESSAGING_PROFILE_ID =\n\tprocess.env.TELNYX_DEFAULT_MESSAGING_PROFILE_ID ||\n\tprocess.env.NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID ||\n\t\"\";\n\nconst NANP_WITH_COUNTRY_DIGITS = 11;\nconst NANP_LOCAL_DIGITS = 10;\nconst WHITESPACE_SPLIT_REGEX = /\\s+/;\n\nfunction formatPhone(phone?: string | null): string | null {\n\tif (!phone) {\n\t\treturn null;\n\t}\n\tconst digits = phone.replace(/\\D/g, \"\");\n\tif (!digits) {\n\t\treturn null;\n\t}\n\tif (digits.length === NANP_WITH_COUNTRY_DIGITS && digits.startsWith(\"1\")) {\n\t\treturn `+${digits}`;\n\t}\n\tif (digits.length === NANP_LOCAL_DIGITS) {\n\t\treturn `+1${digits}`;\n\t}\n\treturn phone.startsWith(\"+\") ? phone : `+${digits}`;\n}\n\nfunction splitName(fullName?: string | null) {\n\tif (!fullName) {\n\t\treturn { first: \"Support\", last: \"Team\" };\n\t}\n\tconst parts = fullName.trim().split(WHITESPACE_SPLIT_REGEX);\n\tif (parts.length === 1) {\n\t\treturn { first: parts[0], last: \"Team\" };\n\t}\n\treturn { first: parts[0], last: parts.slice(1).join(\" \") };\n}\n\nfunction mapIndustryToVertical(industry?: string | null) {\n\tif (!industry) {\n\t\treturn \"PROFESSIONAL\";\n\t}\n\tconst normalized = industry.toLowerCase();\n\tif (normalized.includes(\"plumb\")) {\n\t\treturn \"HOME_SERVICES\";\n\t}\n\tif (normalized.includes(\"hvac\")) {\n\t\treturn \"HOME_SERVICES\";\n\t}\n\tif (normalized.includes(\"electric\")) {\n\t\treturn \"HOME_SERVICES\";\n\t}\n\tif (normalized.includes(\"clean\")) {\n\t\treturn \"PROFESSIONAL\";\n\t}\n\treturn \"PROFESSIONAL\";\n}\n\nasync function upsertBrandRecord(\n\tsupabase: TypedSupabaseClient,\n\tdata: Partial<Database[\"public\"][\"Tables\"][\"messaging_brands\"][\"Insert\"]> & {\n\t\tcompany_id: string;\n\t},\n) {\n\tconst { data: existing } = await supabase\n\t\t.from(\"messaging_brands\")\n\t\t.select(\"id\")\n\t\t.eq(\"company_id\", data.company_id)\n\t\t.maybeSingle();\n\n\tif (existing) {\n\t\tawait supabase\n\t\t\t.from(\"messaging_brands\")\n\t\t\t.update({ ...data, updated_at: new Date().toISOString() })\n\t\t\t.eq(\"id\", existing.id);\n\t} else {\n\t\tawait supabase\n\t\t\t.from(\"messaging_brands\")\n\t\t\t.insert(\n\t\t\t\tdata as Database[\"public\"][\"Tables\"][\"messaging_brands\"][\"Insert\"],\n\t\t\t);\n\t}\n}\n\nasync function upsertCampaignRecord(\n\tsupabase: TypedSupabaseClient,\n\tdata: Partial<\n\t\tDatabase[\"public\"][\"Tables\"][\"messaging_campaigns\"][\"Insert\"]\n\t> & {\n\t\tmessaging_brand_id: string;\n\t\tusecase: string;\n\t},\n) {\n\tconst { data: existing } = await supabase\n\t\t.from(\"messaging_campaigns\")\n\t\t.select(\"id\")\n\t\t.eq(\"messaging_brand_id\", data.messaging_brand_id)\n\t\t.eq(\"usecase\", data.usecase)\n\t\t.maybeSingle();\n\n\tif (existing) {\n\t\tawait supabase\n\t\t\t.from(\"messaging_campaigns\")\n\t\t\t.update({ ...data, updated_at: new Date().toISOString() })\n\t\t\t.eq(\"id\", existing.id);\n\t\treturn existing.id;\n\t}\n\n\tconst { data: inserted } = await supabase\n\t\t.from(\"messaging_campaigns\")\n\t\t.insert(data)\n\t\t.select(\"id\")\n\t\t.single();\n\n\treturn inserted?.id ?? null;\n}\n\n// Telnyx onboarding requires multiple guarded steps\nexport async function ensureMessagingBranding(\n\tcompanyId: string,\n\toptions?: { supabase?: TypedSupabaseClient | null },\n) {\n\tconst supabase = options?.supabase ?? (await createClient());\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Supabase unavailable\" };\n\t}\n\n\tconst { data: company, error } = await supabase\n\t\t.from(\"companies\")\n\t\t.select(\n\t\t\t\"id, name, legal_name, doing_business_as, phone, support_email, support_phone, website, website_url, brand_color, industry, address, city, state, zip_code, owner_id, ein, tax_id\",\n\t\t)\n\t\t.eq(\"id\", companyId)\n\t\t.single();\n\n\tif (error || !company) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error?.message || \"Company not found\",\n\t\t};\n\t}\n\n\tconst { data: ownerContact } = await supabase\n\t\t.from(\"profiles\")\n\t\t.select(\"full_name, email, phone\")\n\t\t.eq(\"id\", company.owner_id)\n\t\t.maybeSingle<OwnerContactRow>();\n\n\tconst contactName = splitName(ownerContact?.full_name);\n\tconst contactEmail =\n\t\townerContact?.email || company.support_email || \"support@example.com\";\n\tconst contactPhone =\n\t\tformatPhone(ownerContact?.phone) ||\n\t\tformatPhone(company.support_phone) ||\n\t\tformatPhone(company.phone) ||\n\t\t\"+18314280176\";\n\n\tconst { data: brandRow } = await supabase\n\t\t.from(\"messaging_brands\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.maybeSingle();\n\n\tif (brandRow?.telnyx_brand_id) {\n\t\tconst brandStatus = await getTenDlcBrand(brandRow.telnyx_brand_id);\n\t\tif (brandStatus.success && brandStatus.data) {\n\t\t\tawait supabase\n\t\t\t\t.from(\"messaging_brands\")\n\t\t\t\t.update({\n\t\t\t\t\tstatus: brandStatus.data.status,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", brandRow.id);\n\t\t}\n\t}\n\n\tif (!brandRow?.telnyx_brand_id) {\n\t\tconst brandPayload = {\n\t\t\tcustomer_reference: companyId,\n\t\t\tbrand_name: company.legal_name || company.name,\n\t\t\tein:\n\t\t\t\tcompany.ein ||\n\t\t\t\tcompany.tax_id ||\n\t\t\t\tprocess.env.FALLBACK_TEST_EIN ||\n\t\t\t\t\"00-0000000\",\n\t\t\tein_issuing_country: \"US\",\n\t\t\tvertical: mapIndustryToVertical(company.industry),\n\t\t\twebsite: company.website || company.website_url || null,\n\t\t\tcompany_type: \"PRIVATE_PROFIT\" as const,\n\t\t\taddress: {\n\t\t\t\tline1: company.address || \"115 Flintlock Lane\",\n\t\t\t\tcity: company.city || \"Ben Lomond\",\n\t\t\t\tstate: company.state || \"CA\",\n\t\t\t\tpostal_code: company.zip_code || \"95005\",\n\t\t\t\tcountry: \"US\",\n\t\t\t},\n\t\t\tcontact: {\n\t\t\t\tfirst_name: contactName.first,\n\t\t\t\tlast_name: contactName.last,\n\t\t\t\temail: contactEmail,\n\t\t\t\tphone: contactPhone,\n\t\t\t},\n\t\t\toptional_attributes: {\n\t\t\t\tdoing_business_as: company.doing_business_as || company.name,\n\t\t\t},\n\t\t};\n\n\t\tconst brandResult = await createTenDlcBrand(brandPayload);\n\t\tif (!(brandResult.success && brandResult.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: brandResult.error || \"Failed to create 10DLC brand\",\n\t\t\t};\n\t\t}\n\n\t\tawait upsertBrandRecord(supabase, {\n\t\t\tcompany_id: companyId,\n\t\t\ttelnyx_brand_id: brandResult.data.id,\n\t\t\tstatus: \"submitted\",\n\t\t\tlegal_name: brandPayload.brand_name,\n\t\t\tdoing_business_as: company.doing_business_as || company.name,\n\t\t\tein: brandPayload.ein,\n\t\t\tvertical: brandPayload.vertical,\n\t\t\twebsite: brandPayload.website,\n\t\t\tsupport_email: contactEmail,\n\t\t\tsupport_phone: contactPhone,\n\t\t\taddress_line1: brandPayload.address.line1,\n\t\t\tcity: brandPayload.address.city,\n\t\t\tstate: brandPayload.address.state,\n\t\t\tpostal_code: brandPayload.address.postal_code,\n\t\t\tbrand_color: company.brand_color,\n\t\t});\n\t}\n\n\trevalidatePath(\"/dashboard/settings/communications/brand\");\n\treturn { success: true };\n}\n\n// Linking campaigns touches several Telnyx APIs sequentially\nexport async function ensureMessagingCampaign(\n\tcompanyId: string,\n\tphoneNumber: { id: string; e164: string },\n\toptions?: { supabase?: TypedSupabaseClient | null },\n) {\n\tconst supabase = options?.supabase ?? (await createClient());\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Supabase unavailable\" };\n\t}\n\n\tconst { data: brand } = await supabase\n\t\t.from(\"messaging_brands\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.maybeSingle();\n\n\tif (!brand?.telnyx_brand_id) {\n\t\tconst brandResult = await ensureMessagingBranding(companyId, {\n\t\t\tsupabase,\n\t\t});\n\t\tif (!brandResult.success) {\n\t\t\treturn brandResult;\n\t\t}\n\t\treturn ensureMessagingCampaign(companyId, phoneNumber);\n\t}\n\n\tconst usecase = \"CUSTOMER_CARE\";\n\n\tconst { data: campaignRow } = await supabase\n\t\t.from(\"messaging_campaigns\")\n\t\t.select(\"*\")\n\t\t.eq(\"messaging_brand_id\", brand.id)\n\t\t.eq(\"usecase\", usecase)\n\t\t.maybeSingle();\n\n\tif (campaignRow?.telnyx_campaign_id) {\n\t\tconst campaignStatus = await getTenDlcCampaign(\n\t\t\tcampaignRow.telnyx_campaign_id,\n\t\t);\n\t\tif (campaignStatus.success && campaignStatus.data) {\n\t\t\tawait supabase\n\t\t\t\t.from(\"messaging_campaigns\")\n\t\t\t\t.update({\n\t\t\t\t\tstatus: campaignStatus.data.status,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", campaignRow.id);\n\t\t}\n\t}\n\n\tlet campaignId = campaignRow?.id ?? null;\n\tlet telnyxCampaignId = campaignRow?.telnyx_campaign_id ?? null;\n\n\tif (!campaignRow?.telnyx_campaign_id) {\n\t\tif (!DEFAULT_MESSAGING_PROFILE_ID) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"TELNYX_DEFAULT_MESSAGING_PROFILE_ID not configured\",\n\t\t\t};\n\t\t}\n\n\t\tconst description = `${brand.doing_business_as || brand.legal_name} provides appointment updates, reminders, and service notifications to existing customers.`;\n\t\tconst sampleMessage = `Hi {{customer_name}}, this is ${\n\t\t\tbrand.doing_business_as || brand.legal_name\n\t\t} confirming your upcoming appointment. Reply HELP for assistance or STOP to opt out.`;\n\n\t\tconst campaignPayload = {\n\t\t\tbrand_id: brand.telnyx_brand_id,\n\t\t\tcampaign_alias: `${companyId}-customer-care`,\n\t\t\tusecase,\n\t\t\tdescription,\n\t\t\tsample_messages: [sampleMessage],\n\t\t\tmessage_flow:\n\t\t\t\t\"Customers opt in during onboarding or by texting our business line. They receive service updates and can opt out by replying STOP.\",\n\t\t\tterms_and_conditions:\n\t\t\t\t\"Msg & data rates may apply. Reply STOP to opt out, HELP for help.\",\n\t\t\thelp_message: `Thanks for contacting ${brand.doing_business_as || brand.legal_name}. Reply STOP to unsubscribe.`,\n\t\t\thelp_phone_number: brand.support_phone || \"+18314280176\",\n\t\t\thelp_email: brand.support_email || \"support@example.com\",\n\t\t\tauto_renewal: true,\n\t\t\tmessage_fee_credits: 0,\n\t\t\topt_in_keywords: [\"START\", \"YES\"],\n\t\t\topt_out_keywords: [\"STOP\", \"UNSUBSCRIBE\"],\n\t\t\topt_in_message:\n\t\t\t\t\"Thanks for opting in to receive messages from us. Reply STOP to opt out.\",\n\t\t\topt_out_message:\n\t\t\t\t\"You have successfully been unsubscribed and will no longer receive messages. Reply START to opt in again.\",\n\t\t};\n\n\t\tconst campaignResult = await createTenDlcCampaign(campaignPayload);\n\t\tif (!(campaignResult.success && campaignResult.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: campaignResult.error || \"Failed to create 10DLC campaign\",\n\t\t\t};\n\t\t}\n\n\t\tcampaignId =\n\t\t\t(await upsertCampaignRecord(supabase, {\n\t\t\t\tmessaging_brand_id: brand.id,\n\t\t\t\ttelnyx_campaign_id: campaignResult.data.id,\n\t\t\t\tstatus: \"submitted\",\n\t\t\t\tusecase,\n\t\t\t\tdescription,\n\t\t\t\tsample_messages: campaignPayload.sample_messages,\n\t\t\t\tmessaging_profile_id: DEFAULT_MESSAGING_PROFILE_ID,\n\t\t\t})) ||\n\t\t\tcampaignRow?.id ||\n\t\t\tnull;\n\t\ttelnyxCampaignId = campaignResult.data.id;\n\t}\n\n\tif (!(campaignId && telnyxCampaignId)) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Campaign not ready\",\n\t\t};\n\t}\n\n\tconst { data: linkRecord } = await supabase\n\t\t.from(\"messaging_campaign_phone_numbers\")\n\t\t.select(\"*\")\n\t\t.eq(\"messaging_campaign_id\", campaignId)\n\t\t.eq(\"phone_number_id\", phoneNumber.id)\n\t\t.maybeSingle();\n\n\tif (!linkRecord?.telnyx_relationship_id) {\n\t\tconst attachResult = await attachNumberToCampaign(\n\t\t\ttelnyxCampaignId,\n\t\t\tphoneNumber.e164,\n\t\t);\n\t\tif (!(attachResult.success && attachResult.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: attachResult.error || \"Failed to link number to campaign\",\n\t\t\t};\n\t\t}\n\n\t\tif (linkRecord) {\n\t\t\tawait supabase\n\t\t\t\t.from(\"messaging_campaign_phone_numbers\")\n\t\t\t\t.update({\n\t\t\t\t\ttelnyx_relationship_id: attachResult.data.id,\n\t\t\t\t\tstatus: \"submitted\",\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", linkRecord.id);\n\t\t} else {\n\t\t\tawait supabase.from(\"messaging_campaign_phone_numbers\").insert({\n\t\t\t\tmessaging_campaign_id: campaignId,\n\t\t\t\tphone_number_id: phoneNumber.id,\n\t\t\t\ttelnyx_relationship_id: attachResult.data.id,\n\t\t\t\tstatus: \"submitted\",\n\t\t\t});\n\t\t}\n\t}\n\n\tawait supabase\n\t\t.from(\"phone_numbers\")\n\t\t.update({\n\t\t\ttelnyx_messaging_profile_id: DEFAULT_MESSAGING_PROFILE_ID,\n\t\t\tmetadata: {\n\t\t\t\tten_dlc_campaign_id: telnyxCampaignId,\n\t\t\t},\n\t\t})\n\t\t.eq(\"id\", phoneNumber.id);\n\n\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\treturn { success: true };\n}\n","/**\n * Messaging Profile Setup & Verification\n *\n * Verifies messaging profile configuration and can auto-update webhook URLs.\n */\n\nimport { TELNYX_CONFIG, telnyxClient } from \"./client\";\n\nexport type MessagingProfileStatus = {\n\texists: boolean;\n\tisActive: boolean;\n\thasWebhookUrl: boolean;\n\twebhookUrl: string | null;\n\twebhookFailoverUrl: string | null;\n\twebhookApiVersion: string | null;\n\tneedsFix: boolean;\n\tissues: string[];\n};\n\nexport type MessagingProfileFixResult = {\n\tsuccess: boolean;\n\tfixed: boolean;\n\terror?: string;\n\tchanges: string[];\n};\n\nfunction getWebhookUrl(): string | undefined {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\t\n\tconst isDevelopment = \n\t\tprocess.env.NODE_ENV === \"development\" ||\n\t\tprocess.env.VERCEL_ENV !== \"production\" ||\n\t\tprocess.env.DEPLOYMENT_ENV !== \"production\";\n\t\n\tfor (const candidate of candidates) {\n\t\tif (candidate && candidate.trim()) {\n\t\t\tconst trimmed = candidate.trim();\n\t\t\tconst isLocal =\n\t\t\t\ttrimmed.includes(\"localhost\") ||\n\t\t\t\ttrimmed.includes(\"127.0.0.1\") ||\n\t\t\t\ttrimmed.includes(\"0.0.0.0\");\n\t\t\t\n\t\t\t// In development, allow localhost URLs (useful for testing with ngrok or similar)\n\t\t\t// In production, reject localhost\n\t\t\tif (isLocal && !isDevelopment) {\n\t\t\t\tcontinue; // Skip localhost in production\n\t\t\t}\n\t\t\t\n\t\t\tconst normalized = trimmed.startsWith(\"http\")\n\t\t\t\t? trimmed\n\t\t\t\t: `https://${trimmed}`;\n\t\t\treturn `${normalized.replace(/\\/+$/, \"\")}/api/webhooks/telnyx`;\n\t\t}\n\t}\n\treturn undefined;\n}\n\n/**\n * Verify messaging profile configuration\n */\nexport async function verifyMessagingProfile(\n\tmessagingProfileId?: string,\n): Promise<MessagingProfileStatus> {\n\tconst profileId = messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\n\tconst status: MessagingProfileStatus = {\n\t\texists: false,\n\t\tisActive: false,\n\t\thasWebhookUrl: false,\n\t\twebhookUrl: null,\n\t\twebhookFailoverUrl: null,\n\t\twebhookApiVersion: null,\n\t\tneedsFix: false,\n\t\tissues: [],\n\t};\n\n\tif (!profileId || profileId.trim() === \"\") {\n\t\tstatus.issues.push(\"Messaging profile ID is not configured\");\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n\n\ttry {\n\t\tconst profile = await telnyxClient.messagingProfiles.retrieve(profileId);\n\t\tconst profileData = profile.data as any;\n\n\t\tif (!profileData) {\n\t\t\tstatus.issues.push(`Messaging profile ${profileId} not found in Telnyx`);\n\t\t\tstatus.needsFix = true;\n\t\t\treturn status;\n\t\t}\n\n\t\tstatus.exists = true;\n\t\tstatus.isActive = profileData.enabled !== false;\n\t\tstatus.webhookUrl = profileData.webhook_url || null;\n\t\tstatus.webhookFailoverUrl = profileData.webhook_failover_url || null;\n\t\tstatus.webhookApiVersion = profileData.webhook_api_version || null;\n\n\t\t// Check webhook URL\n\t\tconst expectedWebhookUrl = getWebhookUrl();\n\t\tif (!expectedWebhookUrl) {\n\t\t\tconst isDevelopment = \n\t\t\t\tprocess.env.NODE_ENV === \"development\" ||\n\t\t\t\tprocess.env.VERCEL_ENV !== \"production\" ||\n\t\t\t\tprocess.env.DEPLOYMENT_ENV !== \"production\";\n\t\t\t\n\t\t\tif (isDevelopment) {\n\t\t\t\tstatus.issues.push(\n\t\t\t\t\t\"NEXT_PUBLIC_SITE_URL is not set. Set it to your production URL (e.g., https://yourdomain.com) or use a tool like ngrok for local testing.\",\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tstatus.issues.push(\n\t\t\t\t\t\"NEXT_PUBLIC_SITE_URL is not set to a valid production URL. Set it to your production domain (e.g., https://yourdomain.com) in your environment variables.\",\n\t\t\t\t);\n\t\t\t}\n\t\t\tstatus.needsFix = true;\n\t\t} else if (!status.webhookUrl) {\n\t\t\tstatus.issues.push(\n\t\t\t\t`Webhook URL is not set. Expected: ${expectedWebhookUrl} (with optional ?company=... for multi-tenant)`,\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t} else {\n\t\t\t// Accept both base webhook URL and company-specific URLs (with query params)\n\t\t\tconst baseUrl = status.webhookUrl.split(\"?\")[0];\n\t\t\tif (\n\t\t\t\tbaseUrl === expectedWebhookUrl ||\n\t\t\t\tstatus.webhookUrl === expectedWebhookUrl\n\t\t\t) {\n\t\t\t\tstatus.hasWebhookUrl = true;\n\t\t\t} else {\n\t\t\t\tstatus.issues.push(\n\t\t\t\t\t`Webhook URL base is not set correctly. Expected: ${expectedWebhookUrl}, Current: ${baseUrl}`,\n\t\t\t\t);\n\t\t\t\tstatus.needsFix = true;\n\t\t\t}\n\t\t}\n\n\t\t// Check webhook API version\n\t\tif (status.webhookApiVersion !== \"2\") {\n\t\t\tstatus.issues.push(\n\t\t\t\t`Webhook API version should be \"2\", but is \"${status.webhookApiVersion || \"not set\"}\"`,\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\t// Check if profile is active\n\t\tif (!status.isActive) {\n\t\t\tstatus.issues.push(\"Messaging profile is not enabled\");\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\treturn status;\n\t} catch (error: any) {\n\t\tif (error?.statusCode === 404) {\n\t\t\tstatus.issues.push(`Messaging profile ${profileId} not found in Telnyx`);\n\t\t} else {\n\t\t\tstatus.issues.push(\n\t\t\t\terror?.message || \"Failed to retrieve messaging profile\",\n\t\t\t);\n\t\t}\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n}\n\n/**\n * Auto-fix messaging profile configuration\n */\nexport async function fixMessagingProfile(\n\tmessagingProfileId?: string,\n\toptions?: {\n\t\twebhookUrl?: string;\n\t\twebhookFailoverUrl?: string;\n\t},\n): Promise<MessagingProfileFixResult> {\n\tconst profileId = messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\tconst changes: string[] = [];\n\n\tif (!profileId || profileId.trim() === \"\") {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: \"Messaging profile ID is not configured\",\n\t\t\tchanges: [],\n\t\t};\n\t}\n\n\ttry {\n\t\t// Get current status\n\t\tconst status = await verifyMessagingProfile(profileId);\n\t\tif (!status.needsFix) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tfixed: false,\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Get expected webhook URL\n\t\tconst expectedWebhookUrl = options?.webhookUrl || getWebhookUrl();\n\t\tif (!expectedWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tfixed: false,\n\t\t\t\terror:\n\t\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be set to a valid production URL to configure webhooks\",\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Prepare update\n\t\tconst updateData: Record<string, unknown> = {};\n\n\t\t// Fix webhook URL\n\t\tif (status.webhookUrl !== expectedWebhookUrl) {\n\t\t\tupdateData.webhook_url = expectedWebhookUrl;\n\t\t\tchanges.push(`Updated webhook URL to ${expectedWebhookUrl}`);\n\t\t}\n\n\t\t// Fix webhook failover URL\n\t\tconst expectedFailoverUrl =\n\t\t\toptions?.webhookFailoverUrl ||\n\t\t\tprocess.env.TELNYX_WEBHOOK_FAILOVER_URL ||\n\t\t\tnull;\n\t\tif (status.webhookFailoverUrl !== expectedFailoverUrl) {\n\t\t\tupdateData.webhook_failover_url = expectedFailoverUrl;\n\t\t\tif (expectedFailoverUrl) {\n\t\t\t\tchanges.push(`Updated webhook failover URL to ${expectedFailoverUrl}`);\n\t\t\t} else {\n\t\t\t\tchanges.push(\"Removed webhook failover URL\");\n\t\t\t}\n\t\t}\n\n\t\t// Fix webhook API version\n\t\tif (status.webhookApiVersion !== \"2\") {\n\t\t\tupdateData.webhook_api_version = \"2\";\n\t\t\tchanges.push(\"Updated webhook API version to 2\");\n\t\t}\n\n\t\t// Fix profile enabled status\n\t\tif (!status.isActive) {\n\t\t\tupdateData.enabled = true;\n\t\t\tchanges.push(\"Enabled messaging profile\");\n\t\t}\n\n\t\t// Apply updates if needed\n\t\tif (Object.keys(updateData).length > 0) {\n\t\t\tawait telnyxClient.messagingProfiles.update(profileId, updateData);\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tfixed: changes.length > 0,\n\t\t\tchanges,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: error?.message || \"Failed to update messaging profile\",\n\t\t\tchanges,\n\t\t};\n\t}\n}\n\n/**\n * Get messaging profile details\n */\nasync function getMessagingProfileDetails(\n\tmessagingProfileId?: string,\n): Promise<{\n\tsuccess: boolean;\n\tdata?: any;\n\terror?: string;\n}> {\n\tconst profileId = messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\n\tif (!profileId || profileId.trim() === \"\") {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Messaging profile ID is not configured\",\n\t\t};\n\t}\n\n\ttry {\n\t\tconst profile = await telnyxClient.messagingProfiles.retrieve(profileId);\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: profile.data,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error?.message || \"Failed to retrieve messaging profile\",\n\t\t};\n\t}\n}\n","/**\n * Telnyx Phone Numbers Service - Number Management\n *\n * Handles all phone number operations including:\n * - Searching available numbers\n * - Purchasing numbers\n * - Porting numbers\n * - Configuring number settings\n * - Releasing numbers\n */\n\nimport { telnyxClient } from \"./client\";\n\n/**\n * Number type for search\n */\nexport type NumberType =\n\t| \"local\"\n\t| \"toll-free\"\n\t| \"national\"\n\t| \"mobile\"\n\t| \"shared_cost\";\n\n/**\n * Number features\n */\nexport type NumberFeature = \"sms\" | \"mms\" | \"voice\" | \"fax\";\n\n/**\n * Search for available phone numbers\n */\nexport async function searchAvailableNumbers(params: {\n\tcountryCode?: string;\n\tareaCode?: string;\n\tnumberType?: NumberType;\n\tfeatures?: NumberFeature[];\n\tlimit?: number;\n\tstartsWith?: string;\n\tendsWith?: string;\n\tcontains?: string;\n}) {\n\ttry {\n\t\tconst numbers = await (telnyxClient.availablePhoneNumbers as any).list({\n\t\t\tfilter: {\n\t\t\t\tcountry_code: params.countryCode || \"US\",\n\t\t\t\tnational_destination_code: params.areaCode,\n\t\t\t\tfeatures: params.features,\n\t\t\t\tlimit: params.limit || 10,\n\t\t\t\tstarts_with: params.startsWith,\n\t\t\t\tends_with: params.endsWith,\n\t\t\t\tcontains: params.contains,\n\t\t\t} as any,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: numbers.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to search numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Purchase a phone number\n */\nexport async function purchaseNumber(params: {\n\tphoneNumber: string;\n\tmessagingProfileId?: string;\n\tconnectionId?: string;\n\tbillingGroupId?: string;\n\tcustomerReference?: string;\n}) {\n\ttry {\n\t\tconst number = await telnyxClient.numberOrders.create({\n\t\t\tphone_numbers: [\n\t\t\t\t{\n\t\t\t\t\tphone_number: params.phoneNumber,\n\t\t\t\t},\n\t\t\t],\n\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\tconnection_id: params.connectionId,\n\t\t\tbilling_group_id: params.billingGroupId,\n\t\t\tcustomer_reference: params.customerReference,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\torderId: number.data?.id,\n\t\t\tdata: number.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to purchase number\",\n\t\t};\n\t}\n}\n\n/**\n * List all owned phone numbers\n */\nexport async function listOwnedNumbers(params?: {\n\tpageSize?: number;\n\tpageNumber?: number;\n\tfilterTag?: string;\n\tfilterStatus?: \"active\" | \"pending\" | \"suspended\" | \"deleted\";\n}) {\n\ttry {\n\t\tconst numbers = await (telnyxClient.phoneNumbers as any).list({\n\t\t\tpage: {\n\t\t\t\tsize: params?.pageSize || 20,\n\t\t\t\tnumber: params?.pageNumber || 1,\n\t\t\t},\n\t\t\tfilter: {\n\t\t\t\ttag: params?.filterTag,\n\t\t\t\tstatus: params?.filterStatus,\n\t\t\t} as any,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: numbers.data,\n\t\t\tmeta: numbers.meta,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to list numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Get phone number details\n */\nexport async function getNumberDetails(phoneNumberId: string) {\n\ttry {\n\t\tconst number = await (telnyxClient.phoneNumbers as any).retrieve(\n\t\t\tphoneNumberId,\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: number.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to retrieve number\",\n\t\t};\n\t}\n}\n\n/**\n * Update phone number configuration\n */\nexport async function updateNumber(params: {\n\tphoneNumberId: string;\n\tconnectionId?: string;\n\tmessagingProfileId?: string;\n\tbillingGroupId?: string;\n\ttags?: string[];\n\tcustomerReference?: string;\n}) {\n\ttry {\n\t\tconst number = await (telnyxClient.phoneNumbers as any).update(\n\t\t\tparams.phoneNumberId,\n\t\t\t{\n\t\t\t\tconnection_id: params.connectionId,\n\t\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\t\tbilling_group_id: params.billingGroupId,\n\t\t\t\ttags: params.tags,\n\t\t\t\tcustomer_reference: params.customerReference,\n\t\t\t} as any,\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: number.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to update number\",\n\t\t};\n\t}\n}\n\n/**\n * Release (delete) a phone number\n */\nexport async function releaseNumber(phoneNumberId: string) {\n\ttry {\n\t\tawait (telnyxClient.phoneNumbers as any).del(phoneNumberId);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to release number\",\n\t\t};\n\t}\n}\n\n/**\n * Initiate number porting request\n */\nexport async function initiatePorting(params: {\n\tphoneNumbers: string[];\n\tbillingGroupId?: string;\n\tfastPortEligible?: boolean;\n\t// Account information\n\taccountNumber?: string;\n\taccountPin?: string;\n\tauthorizedPerson?: string;\n\t// Service address\n\taddressLine1?: string;\n\tcity?: string;\n\tstateOrProvince?: string;\n\tzipOrPostalCode?: string;\n\tcountryCode?: string;\n}) {\n\ttry {\n\t\tconst portingOrder = await (telnyxClient as any).numberPortouts.create({\n\t\t\tphone_numbers: params.phoneNumbers,\n\t\t\tbilling_group_id: params.billingGroupId,\n\t\t\tfast_port_eligible: params.fastPortEligible,\n\t\t\tcustomer_reference: {\n\t\t\t\taccount_number: params.accountNumber,\n\t\t\t\taccount_pin: params.accountPin,\n\t\t\t\tauthorized_person: params.authorizedPerson,\n\t\t\t},\n\t\t\tservice_address: {\n\t\t\t\taddress_line_1: params.addressLine1,\n\t\t\t\tcity: params.city,\n\t\t\t\tstate_or_province: params.stateOrProvince,\n\t\t\t\tzip_or_postal_code: params.zipOrPostalCode,\n\t\t\t\tcountry_code: params.countryCode || \"US\",\n\t\t\t},\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tportingOrderId: portingOrder.data.id,\n\t\t\tdata: portingOrder.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to initiate porting\",\n\t\t};\n\t}\n}\n\n/**\n * Get porting order status\n */\nasync function getPortingStatus(portingOrderId: string) {\n\ttry {\n\t\tconst order = await (telnyxClient as any).numberPortouts.retrieve(\n\t\t\tportingOrderId,\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tstatus: order.data.status,\n\t\t\tdata: order.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get porting status\",\n\t\t};\n\t}\n}\n\n/**\n * Estimate number costs\n */\nasync function estimateNumberCost(params: {\n\tcountryCode: string;\n\tnumberType: NumberType;\n}) {\n\t// Cost estimates based on Telnyx pricing (as of 2025)\n\tconst costs = {\n\t\tUS: {\n\t\t\tlocal: { monthly: 1.0, setup: 0.0 },\n\t\t\t\"toll-free\": { monthly: 2.0, setup: 0.0 },\n\t\t\tmobile: { monthly: 5.0, setup: 0.0 },\n\t\t},\n\t\tCA: {\n\t\t\tlocal: { monthly: 1.5, setup: 0.0 },\n\t\t\t\"toll-free\": { monthly: 2.5, setup: 0.0 },\n\t\t},\n\t\tGB: {\n\t\t\tlocal: { monthly: 2.0, setup: 0.0 },\n\t\t\t\"toll-free\": { monthly: 3.0, setup: 0.0 },\n\t\t},\n\t};\n\n\tconst countryCode = params.countryCode.toUpperCase();\n\tconst pricing = costs[countryCode as keyof typeof costs];\n\n\tif (!pricing) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: `Pricing not available for country: ${countryCode}`,\n\t\t};\n\t}\n\n\tconst typePricing = pricing[params.numberType as keyof typeof pricing];\n\n\tif (!typePricing) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: `Number type ${params.numberType} not available in ${countryCode}`,\n\t\t};\n\t}\n\n\treturn {\n\t\tsuccess: true,\n\t\tcosts: {\n\t\t\tmonthly: typePricing.monthly,\n\t\t\tsetup: typePricing.setup,\n\t\t\tcurrency: \"USD\",\n\t\t},\n\t};\n}\n\n/**\n * Validate if a number can be ported\n */\nasync function validatePortability(phoneNumber: string) {\n\ttry {\n\t\t// This would typically call Telnyx's LNP (Local Number Portability) check API\n\t\t// For now, we'll do basic validation\n\n\t\tconst cleanNumber = phoneNumber.replace(/\\D/g, \"\");\n\n\t\t// Must be at least 10 digits\n\t\tif (cleanNumber.length < 10) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tportable: false,\n\t\t\t\treason: \"Phone number must be at least 10 digits\",\n\t\t\t};\n\t\t}\n\n\t\t// In a real implementation, you would check with Telnyx's LNP API\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tportable: true,\n\t\t\testimatedPortingDays: 7, // Typical porting timeline\n\t\t\tfastPortEligible: false,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to validate portability\",\n\t\t};\n\t}\n}\n","/**\n * Phone Number Setup & Verification\n *\n * Verifies phone numbers are properly configured in Telnyx and can auto-fix issues.\n */\n\nimport { TELNYX_CONFIG } from \"./client\";\nimport {\n\tgetNumberDetails,\n\tlistOwnedNumbers,\n\ttype NumberFeature,\n\tupdateNumber,\n} from \"./numbers\";\n\nexport type PhoneNumberStatus = {\n\texists: boolean;\n\thasMessagingProfile: boolean;\n\thasConnection: boolean;\n\tcapabilities: {\n\t\tsms: boolean;\n\t\tvoice: boolean;\n\t\tmms: boolean;\n\t};\n\tneedsFix: boolean;\n\tissues: string[];\n};\n\nexport type PhoneNumberFixResult = {\n\tsuccess: boolean;\n\tfixed: boolean;\n\terror?: string;\n\tchanges: string[];\n};\n\n/**\n * Find phone number ID by phone number string\n */\nasync function findPhoneNumberId(\n\tphoneNumber: string,\n): Promise<{ success: boolean; phoneNumberId?: string; error?: string }> {\n\ttry {\n\t\t// Normalize phone number (E.164 format)\n\t\tconst normalized = phoneNumber.replace(/\\D/g, \"\");\n\t\tconst e164 = normalized.startsWith(\"+\")\n\t\t\t? phoneNumber\n\t\t\t: normalized.startsWith(\"1\") && normalized.length === 11\n\t\t\t\t? `+${normalized}`\n\t\t\t\t: `+1${normalized}`;\n\n\t\t// List all owned numbers and find matching one\n\t\tconst result = await listOwnedNumbers({ pageSize: 100 });\n\t\tif (!result.success || !result.data) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Failed to list phone numbers from Telnyx\",\n\t\t\t};\n\t\t}\n\n\t\tconst numbers = Array.isArray(result.data) ? result.data : [result.data];\n\t\tconst matching = numbers.find(\n\t\t\t(num: any) =>\n\t\t\t\tnum.phone_number === e164 ||\n\t\t\t\tnum.phone_number === phoneNumber ||\n\t\t\t\tnum.phone_number?.replace(/\\D/g, \"\") === normalized,\n\t\t);\n\n\t\tif (!matching) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Phone number ${phoneNumber} not found in Telnyx account`,\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tphoneNumberId: matching.id,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to find phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Verify phone number configuration\n */\nexport async function verifyPhoneNumber(\n\tphoneNumber: string,\n): Promise<PhoneNumberStatus> {\n\tconst status: PhoneNumberStatus = {\n\t\texists: false,\n\t\thasMessagingProfile: false,\n\t\thasConnection: false,\n\t\tcapabilities: {\n\t\t\tsms: false,\n\t\t\tvoice: false,\n\t\t\tmms: false,\n\t\t},\n\t\tneedsFix: false,\n\t\tissues: [],\n\t};\n\n\ttry {\n\t\t// Find phone number ID\n\t\tconst findResult = await findPhoneNumberId(phoneNumber);\n\t\tif (!findResult.success || !findResult.phoneNumberId) {\n\t\t\tstatus.issues.push(\n\t\t\t\tfindResult.error || \"Phone number not found in Telnyx\",\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t\treturn status;\n\t\t}\n\n\t\tstatus.exists = true;\n\n\t\t// Get phone number details\n\t\tconst detailsResult = await getNumberDetails(findResult.phoneNumberId);\n\t\tif (!detailsResult.success || !detailsResult.data) {\n\t\t\tstatus.issues.push(\"Failed to retrieve phone number details\");\n\t\t\tstatus.needsFix = true;\n\t\t\treturn status;\n\t\t}\n\n\t\tconst numberData = detailsResult.data as any;\n\n\t\t// Check messaging profile\n\t\tif (numberData.messaging_profile_id) {\n\t\t\tstatus.hasMessagingProfile = true;\n\t\t} else {\n\t\t\tstatus.issues.push(\n\t\t\t\t\"Phone number is not associated with a messaging profile\",\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\t// Check connection\n\t\tif (numberData.connection_id) {\n\t\t\tstatus.hasConnection = true;\n\t\t} else {\n\t\t\tstatus.issues.push(\"Phone number is not associated with a connection\");\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\t// Check capabilities from phone number features\n\t\tconst features = (numberData.features || []) as string[];\n\t\tconst hasFeaturesSms = features.includes(\"sms\");\n\t\tconst hasFeaturesVoice = features.includes(\"voice\");\n\t\tconst hasFeaturesMms = features.includes(\"mms\");\n\n\t\t// Also check messaging settings endpoint for SMS/MMS status\n\t\tlet messagingEnabled = false;\n\t\ttry {\n\t\t\tconst TELNYX_API_KEY = process.env.TELNYX_API_KEY;\n\t\t\tif (TELNYX_API_KEY) {\n\t\t\t\tconst messagingResponse = await fetch(\n\t\t\t\t\t`https://api.telnyx.com/v2/phone_numbers/${findResult.phoneNumberId}/messaging`,\n\t\t\t\t\t{\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\tAuthorization: `Bearer ${TELNYX_API_KEY}`,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tif (messagingResponse.ok) {\n\t\t\t\t\tconst messagingData = await messagingResponse.json();\n\t\t\t\t\tconst messagingFeatures = messagingData?.data?.features;\n\t\t\t\t\tif (\n\t\t\t\t\t\tmessagingFeatures?.sms?.domestic_two_way ||\n\t\t\t\t\t\tmessagingFeatures?.mms?.domestic_two_way\n\t\t\t\t\t) {\n\t\t\t\t\t\tmessagingEnabled = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\t// Ignore errors - fall back to features check\n\t\t}\n\n\t\t// Consider SMS enabled if either features include it OR messaging settings confirm it\n\t\tstatus.capabilities.sms = hasFeaturesSms || messagingEnabled;\n\t\tstatus.capabilities.voice = hasFeaturesVoice;\n\t\tstatus.capabilities.mms = hasFeaturesMms || messagingEnabled;\n\n\t\tif (!status.capabilities.sms) {\n\t\t\tstatus.issues.push(\"Phone number does not have SMS capability\");\n\t\t}\n\t\tif (!status.capabilities.voice) {\n\t\t\tstatus.issues.push(\"Phone number does not have voice capability\");\n\t\t}\n\n\t\treturn status;\n\t} catch (error) {\n\t\tstatus.issues.push(\n\t\t\terror instanceof Error ? error.message : \"Unknown error\",\n\t\t);\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n}\n\n/**\n * Auto-fix phone number configuration\n */\nexport async function fixPhoneNumber(\n\tphoneNumber: string,\n\toptions?: {\n\t\tmessagingProfileId?: string;\n\t\tconnectionId?: string;\n\t},\n): Promise<PhoneNumberFixResult> {\n\tconst changes: string[] = [];\n\n\ttry {\n\t\t// Find phone number ID\n\t\tconst findResult = await findPhoneNumberId(phoneNumber);\n\t\tif (!findResult.success || !findResult.phoneNumberId) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tfixed: false,\n\t\t\t\terror: findResult.error || \"Phone number not found\",\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Get current status\n\t\tconst status = await verifyPhoneNumber(phoneNumber);\n\t\tif (!status.needsFix) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tfixed: false,\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Prepare update parameters\n\t\tconst updateParams: {\n\t\t\tphoneNumberId: string;\n\t\t\tmessagingProfileId?: string;\n\t\t\tconnectionId?: string;\n\t\t} = {\n\t\t\tphoneNumberId: findResult.phoneNumberId,\n\t\t};\n\n\t\t// Fix messaging profile\n\t\tif (!status.hasMessagingProfile) {\n\t\t\tconst messagingProfileId =\n\t\t\t\toptions?.messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\t\t\tif (messagingProfileId) {\n\t\t\t\tupdateParams.messagingProfileId = messagingProfileId;\n\t\t\t\tchanges.push(\n\t\t\t\t\t`Assigned messaging profile ${messagingProfileId} to phone number`,\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tfixed: false,\n\t\t\t\t\terror:\n\t\t\t\t\t\t\"Messaging profile ID is required but not configured. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID.\",\n\t\t\t\t\tchanges: [],\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Fix connection\n\t\tif (!status.hasConnection) {\n\t\t\tconst connectionId = options?.connectionId || TELNYX_CONFIG.connectionId;\n\t\t\tif (connectionId) {\n\t\t\t\tupdateParams.connectionId = connectionId;\n\t\t\t\tchanges.push(`Assigned connection ${connectionId} to phone number`);\n\t\t\t} else {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tfixed: false,\n\t\t\t\t\terror:\n\t\t\t\t\t\t\"Connection ID is required but not configured. Set NEXT_PUBLIC_TELNYX_CONNECTION_ID.\",\n\t\t\t\t\tchanges: [],\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Apply updates if needed\n\t\tif (updateParams.messagingProfileId || updateParams.connectionId) {\n\t\t\tconst updateResult = await updateNumber(updateParams);\n\t\t\tif (!updateResult.success) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tfixed: false,\n\t\t\t\t\terror: updateResult.error || \"Failed to update phone number\",\n\t\t\t\t\tchanges,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tfixed: changes.length > 0,\n\t\t\tchanges,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\tchanges,\n\t\t};\n\t}\n}\n\n/**\n * Verify phone number has SMS capability\n */\nexport async function verifySmsCapability(\n\tphoneNumber: string,\n): Promise<{ hasSms: boolean; error?: string }> {\n\tconst status = await verifyPhoneNumber(phoneNumber);\n\n\tif (!status.exists) {\n\t\treturn {\n\t\t\thasSms: false,\n\t\t\terror: \"Phone number not found in Telnyx\",\n\t\t};\n\t}\n\n\tif (!status.capabilities.sms) {\n\t\treturn {\n\t\t\thasSms: false,\n\t\t\terror: \"Phone number does not have SMS capability\",\n\t\t};\n\t}\n\n\tif (!status.hasMessagingProfile) {\n\t\treturn {\n\t\t\thasSms: false,\n\t\t\terror: \"Phone number is not associated with a messaging profile\",\n\t\t};\n\t}\n\n\treturn { hasSms: true };\n}\n\n/**\n * Verify phone number has voice capability\n */\nexport async function verifyVoiceCapability(\n\tphoneNumber: string,\n): Promise<{ hasVoice: boolean; error?: string }> {\n\tconst status = await verifyPhoneNumber(phoneNumber);\n\n\tif (!status.exists) {\n\t\treturn {\n\t\t\thasVoice: false,\n\t\t\terror: \"Phone number not found in Telnyx\",\n\t\t};\n\t}\n\n\tif (!status.capabilities.voice) {\n\t\treturn {\n\t\t\thasVoice: false,\n\t\t\terror: \"Phone number does not have voice capability\",\n\t\t};\n\t}\n\n\tif (!status.hasConnection) {\n\t\treturn {\n\t\t\thasVoice: false,\n\t\t\terror: \"Phone number is not associated with a connection\",\n\t\t};\n\t}\n\n\treturn { hasVoice: true };\n}\n","/**\n * Telnyx API Client\n *\n * Production-ready API client with:\n * - Configurable timeouts\n * - Automatic retries with exponential backoff\n * - Rate limiting\n * - Circuit breaker protection\n * - Structured logging\n * - Metrics collection\n */\n\nimport \"server-only\";\n\nimport { telnyxLogger } from \"./logger\";\nimport { withRetry, generateCorrelationId, type RetryOptions } from \"./retry\";\nimport { withRateLimit, type RateLimitEndpoint } from \"./rate-limiter\";\nimport {\n\tcreateErrorFromResponse,\n\tcreateErrorFromException,\n\tTelnyxError,\n\tTelnyxTimeoutError,\n} from \"./errors\";\nimport { startRequestTimer } from \"./metrics\";\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nconst TELNYX_BASE_URL = \"https://api.telnyx.com/v2\";\nconst TELNYX_PUBLIC_BASE_URL = \"https://api.telnyx.com\";\n\n// Timeout configuration by operation type\nexport const TIMEOUT_CONFIG = {\n\tdefault: 30000, // 30 seconds\n\tsms: 10000, // 10 seconds\n\tvoice: 30000, // 30 seconds\n\tlookup: 5000, // 5 seconds\n\twebhook: 2000, // 2 seconds\n\tbalance: 5000, // 5 seconds\n} as const;\n\nexport type TimeoutType = keyof typeof TIMEOUT_CONFIG;\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface TelnyxRequestOptions {\n\tmethod?: \"GET\" | \"POST\" | \"PUT\" | \"DELETE\" | \"PATCH\";\n\tbody?: Record<string, unknown>;\n\ttimeout?: number;\n\ttimeoutType?: TimeoutType;\n\trateLimitEndpoint?: RateLimitEndpoint;\n\tcompanyId?: string;\n\tcorrelationId?: string;\n\tskipRetry?: boolean;\n\tskipRateLimit?: boolean;\n\tretryOptions?: Partial<RetryOptions>;\n}\n\nexport interface TelnyxResponse<T> {\n\tsuccess: boolean;\n\tdata?: T;\n\terror?: string;\n\terrorCode?: string;\n\tcorrelationId?: string;\n\tlatencyMs?: number;\n}\n\n// =============================================================================\n// CORE REQUEST FUNCTION\n// =============================================================================\n\n/**\n * Make an authenticated request to the Telnyx API\n * with full production features (retry, rate limit, timeout, metrics)\n */\nexport async function telnyxRequest<TResponse>(\n\tpath: string,\n\toptions: TelnyxRequestOptions = {}\n): Promise<TelnyxResponse<TResponse>> {\n\tconst {\n\t\tmethod = \"GET\",\n\t\tbody,\n\t\ttimeout,\n\t\ttimeoutType = \"default\",\n\t\trateLimitEndpoint = \"default\",\n\t\tcompanyId,\n\t\tcorrelationId = generateCorrelationId(),\n\t\tskipRetry = false,\n\t\tskipRateLimit = false,\n\t\tretryOptions = {},\n\t} = options;\n\n\tconst apiKey = process.env.TELNYX_API_KEY;\n\tif (!apiKey) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"TELNYX_API_KEY is not configured\",\n\t\t\terrorCode: \"CONFIG_ERROR\",\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// Build request URL\n\tconst hasProtocol = /^https?:\\/\\//i.test(path);\n\tconst normalizedPath =\n\t\thasProtocol || path.startsWith(\"/\") ? path : `/${path}`;\n\tconst requestUrl = hasProtocol\n\t\t? normalizedPath\n\t\t: normalizedPath.startsWith(\"/public/\")\n\t\t\t? `${TELNYX_PUBLIC_BASE_URL}${normalizedPath}`\n\t\t\t: `${TELNYX_BASE_URL}${normalizedPath}`;\n\n\t// Determine timeout\n\tconst effectiveTimeout = timeout || TIMEOUT_CONFIG[timeoutType];\n\n\t// Log request start\n\ttelnyxLogger.debug(\"API request started\", {\n\t\tcorrelationId,\n\t\tendpoint: path,\n\t\tmethod,\n\t\tcompanyId,\n\t});\n\n\t// Start metrics timer\n\tconst timer = startRequestTimer(path, method, companyId, correlationId);\n\n\t// Create the actual fetch function\n\tconst executeFetch = async (): Promise<TelnyxResponse<TResponse>> => {\n\t\tconst startTime = Date.now();\n\n\t\t// Create AbortController for timeout\n\t\tconst controller = new AbortController();\n\t\tconst timeoutId = setTimeout(() => controller.abort(), effectiveTimeout);\n\n\t\ttry {\n\t\t\tconst response = await fetch(requestUrl, {\n\t\t\t\tmethod,\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\"X-Correlation-ID\": correlationId,\n\t\t\t\t},\n\t\t\t\tbody: body ? JSON.stringify(body) : undefined,\n\t\t\t\tsignal: controller.signal,\n\t\t\t\t// Enable keep-alive for connection reuse\n\t\t\t\tkeepalive: true,\n\t\t\t});\n\n\t\t\tclearTimeout(timeoutId);\n\n\t\t\tconst latencyMs = Date.now() - startTime;\n\n\t\t\t// Parse response\n\t\t\tconst payload = (await response.json().catch(() => ({}))) as\n\t\t\t\t| {\n\t\t\t\t\t\tdata?: TResponse;\n\t\t\t\t\t\terrors?: Array<{ detail?: string; code?: string }>;\n\t\t\t\t  }\n\t\t\t\t| undefined;\n\n\t\t\tif (!response.ok) {\n\t\t\t\t// Record failure metric\n\t\t\t\ttimer.end(response.status, false);\n\n\t\t\t\t// Create typed error\n\t\t\t\tconst error = createErrorFromResponse(response.status, payload, {\n\t\t\t\t\tcorrelationId,\n\t\t\t\t\tendpoint: path,\n\t\t\t\t\tmethod,\n\t\t\t\t\tcompanyId,\n\t\t\t\t});\n\n\t\t\t\ttelnyxLogger.warn(\"API request failed\", {\n\t\t\t\t\tcorrelationId,\n\t\t\t\t\tendpoint: path,\n\t\t\t\t\tstatusCode: response.status,\n\t\t\t\t\terror: error.message,\n\t\t\t\t\tlatencyMs,\n\t\t\t\t});\n\n\t\t\t\t// Throw to trigger retry if retryable\n\t\t\t\tif (error.retryable) {\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: error.message,\n\t\t\t\t\terrorCode: error.code,\n\t\t\t\t\tcorrelationId,\n\t\t\t\t\tlatencyMs,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// Record success metric\n\t\t\ttimer.end(response.status, true);\n\n\t\t\t// Telnyx API sometimes wraps response in \"data\", sometimes returns directly\n\t\t\tconst responseData = payload?.data || payload;\n\n\t\t\ttelnyxLogger.debug(\"API request completed\", {\n\t\t\t\tcorrelationId,\n\t\t\t\tendpoint: path,\n\t\t\t\tstatusCode: response.status,\n\t\t\t\tlatencyMs,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tdata: responseData as TResponse,\n\t\t\t\tcorrelationId,\n\t\t\t\tlatencyMs,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\tclearTimeout(timeoutId);\n\n\t\t\tconst latencyMs = Date.now() - startTime;\n\n\t\t\t// Handle timeout\n\t\t\tif (error instanceof Error && error.name === \"AbortError\") {\n\t\t\t\ttimer.end(0, false);\n\n\t\t\t\tconst timeoutError = new TelnyxTimeoutError(\n\t\t\t\t\t`Request timed out after ${effectiveTimeout}ms`,\n\t\t\t\t\teffectiveTimeout,\n\t\t\t\t\t{ correlationId, endpoint: path, method }\n\t\t\t\t);\n\n\t\t\t\ttelnyxLogger.error(\"API request timed out\", {\n\t\t\t\t\tcorrelationId,\n\t\t\t\t\tendpoint: path,\n\t\t\t\t\ttimeoutMs: effectiveTimeout,\n\t\t\t\t\tlatencyMs,\n\t\t\t\t});\n\n\t\t\t\tthrow timeoutError; // Throw to trigger retry\n\t\t\t}\n\n\t\t\t// Handle TelnyxError (already processed)\n\t\t\tif (error instanceof TelnyxError) {\n\t\t\t\tthrow error;\n\t\t\t}\n\n\t\t\t// Handle network/other errors\n\t\t\ttimer.end(0, false);\n\n\t\t\tconst wrappedError = createErrorFromException(error, {\n\t\t\t\tcorrelationId,\n\t\t\t\tendpoint: path,\n\t\t\t\tmethod,\n\t\t\t});\n\n\t\t\ttelnyxLogger.error(\"API request error\", {\n\t\t\t\tcorrelationId,\n\t\t\t\tendpoint: path,\n\t\t\t\terror: wrappedError.message,\n\t\t\t\tlatencyMs,\n\t\t\t});\n\n\t\t\tthrow wrappedError;\n\t\t}\n\t};\n\n\t// Apply rate limiting and retry logic\n\ttry {\n\t\tlet fetchFn = executeFetch;\n\n\t\t// Wrap with retry logic if not skipped\n\t\tif (!skipRetry) {\n\t\t\tconst originalFn = fetchFn;\n\t\t\tfetchFn = () =>\n\t\t\t\twithRetry(originalFn, {\n\t\t\t\t\tendpoint: path,\n\t\t\t\t\tcorrelationId,\n\t\t\t\t\tconfig: retryOptions.config,\n\t\t\t\t\tonRetry: (attempt, error, delayMs) => {\n\t\t\t\t\t\ttelnyxLogger.info(\"Retrying request\", {\n\t\t\t\t\t\t\tcorrelationId,\n\t\t\t\t\t\t\tendpoint: path,\n\t\t\t\t\t\t\tattempt,\n\t\t\t\t\t\t\tdelayMs,\n\t\t\t\t\t\t\terror: error.message,\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t}\n\n\t\t// Wrap with rate limiting if not skipped\n\t\tif (!skipRateLimit) {\n\t\t\tconst fnWithRetry = fetchFn;\n\t\t\tfetchFn = () =>\n\t\t\t\twithRateLimit(fnWithRetry, {\n\t\t\t\t\tendpoint: rateLimitEndpoint,\n\t\t\t\t\tcompanyId,\n\t\t\t\t\tcorrelationId,\n\t\t\t\t});\n\t\t}\n\n\t\treturn await fetchFn();\n\t} catch (error) {\n\t\t// Convert any remaining errors to response format\n\t\tif (error instanceof TelnyxError) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error.message,\n\t\t\t\terrorCode: error.code,\n\t\t\t\tcorrelationId,\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\tcorrelationId,\n\t\t};\n\t}\n}\n\n// =============================================================================\n// CONVENIENCE METHODS\n// =============================================================================\n\n/**\n * GET request\n */\nexport async function telnyxGet<T>(\n\tpath: string,\n\toptions: Omit<TelnyxRequestOptions, \"method\" | \"body\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, { ...options, method: \"GET\" });\n}\n\n/**\n * POST request\n */\nexport async function telnyxPost<T>(\n\tpath: string,\n\tbody: Record<string, unknown>,\n\toptions: Omit<TelnyxRequestOptions, \"method\" | \"body\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, { ...options, method: \"POST\", body });\n}\n\n/**\n * PUT request\n */\nexport async function telnyxPut<T>(\n\tpath: string,\n\tbody: Record<string, unknown>,\n\toptions: Omit<TelnyxRequestOptions, \"method\" | \"body\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, { ...options, method: \"PUT\", body });\n}\n\n/**\n * PATCH request\n */\nexport async function telnyxPatch<T>(\n\tpath: string,\n\tbody: Record<string, unknown>,\n\toptions: Omit<TelnyxRequestOptions, \"method\" | \"body\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, { ...options, method: \"PATCH\", body });\n}\n\n/**\n * DELETE request\n */\nexport async function telnyxDelete<T>(\n\tpath: string,\n\toptions: Omit<TelnyxRequestOptions, \"method\" | \"body\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, { ...options, method: \"DELETE\" });\n}\n\n// =============================================================================\n// SPECIALIZED REQUESTS\n// =============================================================================\n\n/**\n * SMS-specific request with appropriate timeout and rate limiting\n */\nexport async function telnyxSmsRequest<T>(\n\tpath: string,\n\toptions: Omit<TelnyxRequestOptions, \"timeoutType\" | \"rateLimitEndpoint\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, {\n\t\t...options,\n\t\ttimeoutType: \"sms\",\n\t\trateLimitEndpoint: \"sms\",\n\t});\n}\n\n/**\n * Voice-specific request with appropriate timeout and rate limiting\n */\nexport async function telnyxVoiceRequest<T>(\n\tpath: string,\n\toptions: Omit<TelnyxRequestOptions, \"timeoutType\" | \"rateLimitEndpoint\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, {\n\t\t...options,\n\t\ttimeoutType: \"voice\",\n\t\trateLimitEndpoint: \"voice\",\n\t});\n}\n\n/**\n * Lookup-specific request with appropriate timeout\n */\nexport async function telnyxLookupRequest<T>(\n\tpath: string,\n\toptions: Omit<TelnyxRequestOptions, \"timeoutType\" | \"rateLimitEndpoint\"> = {}\n): Promise<TelnyxResponse<T>> {\n\treturn telnyxRequest<T>(path, {\n\t\t...options,\n\t\ttimeoutType: \"lookup\",\n\t\trateLimitEndpoint: \"lookup\",\n\t});\n}\n","/**\n * Telnyx Rate Limiter\n *\n * Implements token bucket algorithm with per-company and per-endpoint\n * rate limiting to prevent API rate limit errors.\n */\n\nimport { telnyxLogger } from \"./logger\";\nimport { sleep } from \"./retry\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface RateLimitConfig {\n\tmaxTokens: number; // Maximum tokens in bucket\n\trefillRate: number; // Tokens added per second\n\trefillInterval: number; // Milliseconds between refills\n}\n\nexport interface RateLimitResult {\n\tallowed: boolean;\n\tremainingTokens: number;\n\tretryAfterMs?: number;\n\twaitTime?: number; // Time waited if queued\n}\n\ninterface TokenBucket {\n\ttokens: number;\n\tlastRefill: number;\n\tqueue: Array<{\n\t\tresolve: (result: RateLimitResult) => void;\n\t\trequestedAt: number;\n\t}>;\n}\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\n// Default rate limits based on Telnyx API limits\nexport const RATE_LIMIT_CONFIGS: Record<string, RateLimitConfig> = {\n\t// General API: 100 requests per minute\n\tdefault: {\n\t\tmaxTokens: 100,\n\t\trefillRate: 100 / 60, // ~1.67 tokens/second\n\t\trefillInterval: 1000,\n\t},\n\t// SMS: 1 message per second per number (aggregate)\n\tsms: {\n\t\tmaxTokens: 60,\n\t\trefillRate: 1,\n\t\trefillInterval: 1000,\n\t},\n\t// Voice: more relaxed\n\tvoice: {\n\t\tmaxTokens: 30,\n\t\trefillRate: 0.5,\n\t\trefillInterval: 1000,\n\t},\n\t// Lookup: can be higher\n\tlookup: {\n\t\tmaxTokens: 200,\n\t\trefillRate: 200 / 60,\n\t\trefillInterval: 1000,\n\t},\n\t// Webhook (incoming): protect against floods\n\twebhook: {\n\t\tmaxTokens: 1000,\n\t\trefillRate: 100,\n\t\trefillInterval: 1000,\n\t},\n};\n\n// =============================================================================\n// TOKEN BUCKET IMPLEMENTATION\n// =============================================================================\n\nclass TokenBucketLimiter {\n\tprivate buckets = new Map<string, TokenBucket>();\n\tprivate processingQueue = new Map<string, boolean>();\n\n\t/**\n\t * Get or create a bucket for a key\n\t */\n\tprivate getBucket(key: string, config: RateLimitConfig): TokenBucket {\n\t\tif (!this.buckets.has(key)) {\n\t\t\tthis.buckets.set(key, {\n\t\t\t\ttokens: config.maxTokens,\n\t\t\t\tlastRefill: Date.now(),\n\t\t\t\tqueue: [],\n\t\t\t});\n\t\t}\n\t\treturn this.buckets.get(key)!;\n\t}\n\n\t/**\n\t * Refill tokens based on elapsed time\n\t */\n\tprivate refillTokens(bucket: TokenBucket, config: RateLimitConfig): void {\n\t\tconst now = Date.now();\n\t\tconst elapsed = now - bucket.lastRefill;\n\t\tconst intervalsElapsed = Math.floor(elapsed / config.refillInterval);\n\n\t\tif (intervalsElapsed > 0) {\n\t\t\tconst tokensToAdd = intervalsElapsed * config.refillRate;\n\t\t\tbucket.tokens = Math.min(config.maxTokens, bucket.tokens + tokensToAdd);\n\t\t\tbucket.lastRefill = now;\n\t\t}\n\t}\n\n\t/**\n\t * Process queued requests\n\t */\n\tprivate async processQueue(key: string, config: RateLimitConfig): Promise<void> {\n\t\tif (this.processingQueue.get(key)) return;\n\t\tthis.processingQueue.set(key, true);\n\n\t\tconst bucket = this.getBucket(key, config);\n\n\t\twhile (bucket.queue.length > 0) {\n\t\t\tthis.refillTokens(bucket, config);\n\n\t\t\tif (bucket.tokens >= 1) {\n\t\t\t\tconst request = bucket.queue.shift();\n\t\t\t\tif (request) {\n\t\t\t\t\tbucket.tokens -= 1;\n\t\t\t\t\tconst waitTime = Date.now() - request.requestedAt;\n\t\t\t\t\trequest.resolve({\n\t\t\t\t\t\tallowed: true,\n\t\t\t\t\t\tremainingTokens: bucket.tokens,\n\t\t\t\t\t\twaitTime,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Calculate time until next token\n\t\t\t\tconst timeUntilToken = config.refillInterval / config.refillRate;\n\t\t\t\tawait sleep(Math.ceil(timeUntilToken));\n\t\t\t}\n\t\t}\n\n\t\tthis.processingQueue.set(key, false);\n\t}\n\n\t/**\n\t * Attempt to acquire a token (immediate, no queue)\n\t */\n\ttryAcquire(key: string, config: RateLimitConfig = RATE_LIMIT_CONFIGS.default): RateLimitResult {\n\t\tconst bucket = this.getBucket(key, config);\n\t\tthis.refillTokens(bucket, config);\n\n\t\tif (bucket.tokens >= 1) {\n\t\t\tbucket.tokens -= 1;\n\t\t\treturn {\n\t\t\t\tallowed: true,\n\t\t\t\tremainingTokens: bucket.tokens,\n\t\t\t};\n\t\t}\n\n\t\t// Calculate retry after\n\t\tconst timeUntilToken = Math.ceil(config.refillInterval / config.refillRate);\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\tremainingTokens: 0,\n\t\t\tretryAfterMs: timeUntilToken,\n\t\t};\n\t}\n\n\t/**\n\t * Acquire a token, waiting in queue if necessary\n\t */\n\tasync acquire(\n\t\tkey: string,\n\t\tconfig: RateLimitConfig = RATE_LIMIT_CONFIGS.default,\n\t\tmaxWaitMs: number = 30000\n\t): Promise<RateLimitResult> {\n\t\t// Try immediate acquisition\n\t\tconst immediate = this.tryAcquire(key, config);\n\t\tif (immediate.allowed) {\n\t\t\treturn immediate;\n\t\t}\n\n\t\t// Queue the request\n\t\tconst bucket = this.getBucket(key, config);\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst requestedAt = Date.now();\n\t\t\tconst timeoutId = setTimeout(() => {\n\t\t\t\t// Remove from queue on timeout\n\t\t\t\tconst index = bucket.queue.findIndex((r) => r.requestedAt === requestedAt);\n\t\t\t\tif (index !== -1) {\n\t\t\t\t\tbucket.queue.splice(index, 1);\n\t\t\t\t}\n\t\t\t\tresolve({\n\t\t\t\t\tallowed: false,\n\t\t\t\t\tremainingTokens: 0,\n\t\t\t\t\tretryAfterMs: maxWaitMs,\n\t\t\t\t});\n\t\t\t}, maxWaitMs);\n\n\t\t\tbucket.queue.push({\n\t\t\t\tresolve: (result) => {\n\t\t\t\t\tclearTimeout(timeoutId);\n\t\t\t\t\tresolve(result);\n\t\t\t\t},\n\t\t\t\trequestedAt,\n\t\t\t});\n\n\t\t\t// Start processing queue\n\t\t\tthis.processQueue(key, config);\n\t\t});\n\t}\n\n\t/**\n\t * Get current bucket status\n\t */\n\tgetStatus(key: string, config: RateLimitConfig = RATE_LIMIT_CONFIGS.default): {\n\t\ttokens: number;\n\t\tmaxTokens: number;\n\t\tqueueLength: number;\n\t\tutilizationPercent: number;\n\t} {\n\t\tconst bucket = this.getBucket(key, config);\n\t\tthis.refillTokens(bucket, config);\n\n\t\treturn {\n\t\t\ttokens: Math.floor(bucket.tokens),\n\t\t\tmaxTokens: config.maxTokens,\n\t\t\tqueueLength: bucket.queue.length,\n\t\t\tutilizationPercent: Math.round(((config.maxTokens - bucket.tokens) / config.maxTokens) * 100),\n\t\t};\n\t}\n\n\t/**\n\t * Reset a bucket (for testing)\n\t */\n\treset(key: string): void {\n\t\tthis.buckets.delete(key);\n\t}\n\n\t/**\n\t * Reset all buckets\n\t */\n\tresetAll(): void {\n\t\tthis.buckets.clear();\n\t}\n}\n\n// =============================================================================\n// RATE LIMITER INSTANCES\n// =============================================================================\n\n// Global rate limiter\nconst globalLimiter = new TokenBucketLimiter();\n\n// Per-company rate limiters\nconst companyLimiters = new Map<string, TokenBucketLimiter>();\n\nfunction getCompanyLimiter(companyId: string): TokenBucketLimiter {\n\tif (!companyLimiters.has(companyId)) {\n\t\tcompanyLimiters.set(companyId, new TokenBucketLimiter());\n\t}\n\treturn companyLimiters.get(companyId)!;\n}\n\n// =============================================================================\n// PUBLIC API\n// =============================================================================\n\nexport type RateLimitEndpoint = keyof typeof RATE_LIMIT_CONFIGS;\n\n/**\n * Check if a request is rate limited (immediate check, no queue)\n */\nexport function checkRateLimit(\n\tendpoint: RateLimitEndpoint = \"default\",\n\tcompanyId?: string\n): RateLimitResult {\n\tconst config = RATE_LIMIT_CONFIGS[endpoint] || RATE_LIMIT_CONFIGS.default;\n\n\t// Check global rate limit\n\tconst globalKey = `global:${endpoint}`;\n\tconst globalResult = globalLimiter.tryAcquire(globalKey, config);\n\n\tif (!globalResult.allowed) {\n\t\ttelnyxLogger.warn(\"Global rate limit hit\", {\n\t\t\tendpoint,\n\t\t\tretryAfterMs: globalResult.retryAfterMs,\n\t\t});\n\t\treturn globalResult;\n\t}\n\n\t// Check per-company rate limit if provided\n\tif (companyId) {\n\t\tconst companyLimiter = getCompanyLimiter(companyId);\n\t\tconst companyResult = companyLimiter.tryAcquire(endpoint, config);\n\n\t\tif (!companyResult.allowed) {\n\t\t\ttelnyxLogger.warn(\"Company rate limit hit\", {\n\t\t\t\tendpoint,\n\t\t\t\tcompanyId,\n\t\t\t\tretryAfterMs: companyResult.retryAfterMs,\n\t\t\t});\n\t\t\treturn companyResult;\n\t\t}\n\t}\n\n\treturn globalResult;\n}\n\n/**\n * Acquire a rate limit token, waiting if necessary\n */\nexport async function acquireRateLimit(\n\tendpoint: RateLimitEndpoint = \"default\",\n\tcompanyId?: string,\n\tmaxWaitMs: number = 30000\n): Promise<RateLimitResult> {\n\tconst config = RATE_LIMIT_CONFIGS[endpoint] || RATE_LIMIT_CONFIGS.default;\n\n\t// Acquire global token\n\tconst globalKey = `global:${endpoint}`;\n\tconst globalResult = await globalLimiter.acquire(globalKey, config, maxWaitMs);\n\n\tif (!globalResult.allowed) {\n\t\treturn globalResult;\n\t}\n\n\t// Acquire per-company token if provided\n\tif (companyId) {\n\t\tconst companyLimiter = getCompanyLimiter(companyId);\n\t\tconst companyResult = await companyLimiter.acquire(endpoint, config, maxWaitMs);\n\n\t\tif (!companyResult.allowed) {\n\t\t\treturn companyResult;\n\t\t}\n\n\t\t// Return the longer wait time\n\t\treturn {\n\t\t\t...companyResult,\n\t\t\twaitTime: Math.max(globalResult.waitTime || 0, companyResult.waitTime || 0),\n\t\t};\n\t}\n\n\treturn globalResult;\n}\n\n/**\n * Decorator function to rate limit async operations\n */\nexport function withRateLimit<T>(\n\tfn: () => Promise<T>,\n\toptions: {\n\t\tendpoint?: RateLimitEndpoint;\n\t\tcompanyId?: string;\n\t\tmaxWaitMs?: number;\n\t\tcorrelationId?: string;\n\t} = {}\n): Promise<T> {\n\tconst { endpoint = \"default\", companyId, maxWaitMs = 30000, correlationId } = options;\n\n\treturn new Promise(async (resolve, reject) => {\n\t\ttry {\n\t\t\tconst result = await acquireRateLimit(endpoint, companyId, maxWaitMs);\n\n\t\t\tif (!result.allowed) {\n\t\t\t\tconst error = new Error(\n\t\t\t\t\t`Rate limit exceeded. Retry after ${result.retryAfterMs}ms`\n\t\t\t\t);\n\t\t\t\t(error as any).code = \"RATE_LIMIT_EXCEEDED\";\n\t\t\t\t(error as any).retryAfterMs = result.retryAfterMs;\n\t\t\t\treject(error);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (result.waitTime && result.waitTime > 100) {\n\t\t\t\ttelnyxLogger.debug(\"Request waited for rate limit\", {\n\t\t\t\t\tendpoint,\n\t\t\t\t\tcompanyId,\n\t\t\t\t\twaitTime: result.waitTime,\n\t\t\t\t\tcorrelationId,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst response = await fn();\n\t\t\tresolve(response);\n\t\t} catch (error) {\n\t\t\treject(error);\n\t\t}\n\t});\n}\n\n/**\n * Get rate limit status for monitoring\n */\nexport function getRateLimitStatus(\n\tendpoint?: RateLimitEndpoint,\n\tcompanyId?: string\n): {\n\tglobal: Record<string, ReturnType<TokenBucketLimiter[\"getStatus\"]>>;\n\tcompany?: Record<string, ReturnType<TokenBucketLimiter[\"getStatus\"]>>;\n} {\n\tconst endpoints = endpoint\n\t\t? [endpoint]\n\t\t: (Object.keys(RATE_LIMIT_CONFIGS) as RateLimitEndpoint[]);\n\n\tconst global: Record<string, ReturnType<TokenBucketLimiter[\"getStatus\"]>> = {};\n\n\tfor (const ep of endpoints) {\n\t\tconst config = RATE_LIMIT_CONFIGS[ep];\n\t\tglobal[ep] = globalLimiter.getStatus(`global:${ep}`, config);\n\t}\n\n\tlet company: Record<string, ReturnType<TokenBucketLimiter[\"getStatus\"]>> | undefined;\n\n\tif (companyId) {\n\t\tconst limiter = companyLimiters.get(companyId);\n\t\tif (limiter) {\n\t\t\tcompany = {};\n\t\t\tfor (const ep of endpoints) {\n\t\t\t\tconst config = RATE_LIMIT_CONFIGS[ep];\n\t\t\t\tcompany[ep] = limiter.getStatus(ep, config);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn { global, company };\n}\n\n/**\n * Reset rate limits (for testing)\n */\nexport function resetRateLimits(companyId?: string): void {\n\tif (companyId) {\n\t\tcompanyLimiters.delete(companyId);\n\t} else {\n\t\tglobalLimiter.resetAll();\n\t\tcompanyLimiters.clear();\n\t}\n}\n\n// =============================================================================\n// BULK OPERATION HELPER\n// =============================================================================\n\nexport interface BulkRateLimitOptions {\n\tendpoint: RateLimitEndpoint;\n\tcompanyId?: string;\n\tbatchSize?: number;\n\tbatchDelayMs?: number;\n}\n\n/**\n * Process items in rate-limited batches\n */\nexport async function processBatchWithRateLimit<T, R>(\n\titems: T[],\n\tprocessor: (item: T) => Promise<R>,\n\toptions: BulkRateLimitOptions\n): Promise<Array<{ item: T; result?: R; error?: Error }>> {\n\tconst { endpoint, companyId, batchSize = 10, batchDelayMs = 1000 } = options;\n\n\tconst results: Array<{ item: T; result?: R; error?: Error }> = [];\n\n\tfor (let i = 0; i < items.length; i += batchSize) {\n\t\tconst batch = items.slice(i, i + batchSize);\n\n\t\t// Process batch with rate limiting\n\t\tconst batchResults = await Promise.all(\n\t\t\tbatch.map(async (item) => {\n\t\t\t\ttry {\n\t\t\t\t\tconst result = await withRateLimit(\n\t\t\t\t\t\t() => processor(item),\n\t\t\t\t\t\t{ endpoint, companyId }\n\t\t\t\t\t);\n\t\t\t\t\treturn { item, result };\n\t\t\t\t} catch (error) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\titem,\n\t\t\t\t\t\terror: error instanceof Error ? error : new Error(String(error)),\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\n\t\tresults.push(...batchResults);\n\n\t\t// Delay between batches\n\t\tif (i + batchSize < items.length) {\n\t\t\tawait sleep(batchDelayMs);\n\t\t}\n\t}\n\n\treturn results;\n}\n\n// =============================================================================\n// RATE LIMIT RESPONSE HANDLER\n// =============================================================================\n\n/**\n * Handle 429 response from Telnyx API\n */\nexport function handle429Response(response: Response): {\n\tretryAfterMs: number;\n\tshouldRetry: boolean;\n} {\n\tconst retryAfter = response.headers.get(\"Retry-After\");\n\n\tlet retryAfterMs = 60000; // Default 60 seconds\n\n\tif (retryAfter) {\n\t\t// Check if it's a number (seconds)\n\t\tconst seconds = parseInt(retryAfter, 10);\n\t\tif (!isNaN(seconds)) {\n\t\t\tretryAfterMs = seconds * 1000;\n\t\t} else {\n\t\t\t// Try parsing as a date\n\t\t\tconst date = Date.parse(retryAfter);\n\t\t\tif (!isNaN(date)) {\n\t\t\t\tretryAfterMs = Math.max(0, date - Date.now());\n\t\t\t}\n\t\t}\n\t}\n\n\t// Don't retry if wait is too long (> 5 minutes)\n\tconst shouldRetry = retryAfterMs <= 300000;\n\n\ttelnyxLogger.warn(\"Rate limit response received\", {\n\t\tretryAfterMs,\n\t\tshouldRetry,\n\t});\n\n\treturn { retryAfterMs, shouldRetry };\n}\n","import \"server-only\";\nimport { telnyxRequest } from \"./api\";\n\nexport type TenDlcBrandPayload = {\n\tentityType: \"PRIVATE_PROFIT\" | \"PUBLIC_PROFIT\" | \"NON_PROFIT\";\n\tdisplayName: string;\n\tcompanyName: string;\n\tfirstName: string;\n\tlastName: string;\n\tein: string;\n\tphone: string;\n\tstreet: string;\n\tcity: string;\n\tstate: string;\n\tpostalCode: string;\n\tcountry: string;\n\temail: string;\n\twebsite?: string;\n\tvertical: string;\n\tisReseller?: boolean;\n\tmock?: boolean;\n\tmobilePhone?: string;\n\tbusinessContactEmail?: string;\n\tstockSymbol?: string;\n\tstockExchange?: string;\n\tipAddress?: string;\n\twebhookURL?: string;\n\twebhookFailoverURL?: string;\n};\n\nexport async function createTenDlcBrand(payload: TenDlcBrandPayload) {\n\treturn telnyxRequest<{ brandId: string; status: string }>(\"/10dlc/brand\", {\n\t\tmethod: \"POST\",\n\t\tbody: payload,\n\t});\n}\n\nexport async function getTenDlcBrand(brandId: string) {\n\treturn telnyxRequest<{ brandId: string; status: string }>(\n\t\t`/10dlc/brand/${brandId}`,\n\t);\n}\n\nexport type TenDlcCampaignPayload = {\n\tbrandId: string;\n\tusecase: string;\n\tdescription: string;\n\tmessageFlow: string;\n\thelpMessage: string;\n\thelpKeywords?: string;\n\toptinKeywords?: string;\n\toptinMessage?: string;\n\toptoutKeywords?: string;\n\toptoutMessage?: string;\n\tsample1: string;\n\tsample2?: string;\n\tsample3?: string;\n\tsample4?: string;\n\tsample5?: string;\n\tautoRenewal: boolean;\n\tsubUsecases?: string[];\n\ttermsAndConditions?: boolean;\n\tprivacyPolicyLink?: string;\n\ttermsAndConditionsLink?: string;\n\taffiliateMarketing?: boolean;\n\tageGated?: boolean;\n\tdirectLending?: boolean;\n\tembeddedLink?: boolean;\n\tembeddedPhone?: boolean;\n\tnumberPool?: boolean;\n\tsubscriberHelp?: boolean;\n\tsubscriberOptin?: boolean;\n\tsubscriberOptout?: boolean;\n\treferenceId?: string;\n\tmnoIds?: number[];\n\ttag?: string[];\n};\n\nexport async function createTenDlcCampaign(payload: TenDlcCampaignPayload) {\n\treturn telnyxRequest<{ campaignId: string }>(\"/10dlc/campaignBuilder\", {\n\t\tmethod: \"POST\",\n\t\tbody: payload,\n\t});\n}\n\nexport async function getTenDlcCampaign(campaignId: string) {\n\treturn telnyxRequest<{ id: string; status: string; usecase: string }>(\n\t\t`/10dlc/campaign/${campaignId}`,\n\t);\n}\n\nexport async function attachNumberToCampaign(\n\tcampaignId: string,\n\tphoneNumber: string,\n) {\n\treturn telnyxRequest<{ id: string }>(\n\t\t`/10dlc/campaigns/${campaignId}/phone_numbers`,\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: {\n\t\t\t\tphone_numbers: [{ phone_number: phoneNumber }],\n\t\t\t},\n\t\t},\n\t);\n}\n"],"names":[],"mappings":"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"}