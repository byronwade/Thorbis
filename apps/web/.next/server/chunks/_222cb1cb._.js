module.exports=[786348,e=>{"use strict";let t={debug:0,info:1,warn:2,error:3},r=process.env.TELNYX_LOG_LEVEL||"info",s=["phone","phoneNumber","phone_number","from","to","fromNumber","toNumber","from_number","to_number","apiKey","api_key","authToken","auth_token","password","secret","token"];function a(e){let t=e.replace(/\D/g,"");return t.length<4?"****":`***${t.slice(-4)}`}function n(e){let[t,r]=e.split("@");if(!r)return"***@***";let s=t.length>2?`${t[0]}***${t[t.length-1]}`:"***";return`${s}@${r}`}class o{parent;context;constructor(e,t){this.parent=e,this.context=t}debug(e,t){this.parent.debug(e,{...this.context,...t})}info(e,t){this.parent.info(e,{...this.context,...t})}warn(e,t){this.parent.warn(e,{...this.context,...t})}error(e,t){this.parent.error(e,{...this.context,...t})}}let i=new class{service="telnyx";defaultContext={};setDefaultContext(e){this.defaultContext={...this.defaultContext,...e}}clearDefaultContext(){this.defaultContext={}}shouldLog(e){return t[e]>=t[r]}log(e,t,r){if(!this.shouldLog(e))return;let o={timestamp:new Date().toISOString(),level:e,service:this.service,message:t},i={...this.defaultContext,...r};Object.keys(i).length>0&&(o.context=function e(t,r=0){if(r>10)return"[MAX_DEPTH]";if(null==t)return t;if("string"==typeof t)return t.replace(/\+?1?\d{10,15}/g,e=>a(e)).replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,e=>n(e));if("number"==typeof t||"boolean"==typeof t)return t;if(Array.isArray(t))return t.map(t=>e(t,r+1));if("object"==typeof t){let o={};for(let[i,l]of Object.entries(t))s.some(e=>i.toLowerCase().includes(e.toLowerCase()))?"string"==typeof l?l.includes("@")?o[i]=n(l):/\d/.test(l)?o[i]=a(l):o[i]="[REDACTED]":o[i]="[REDACTED]":o[i]=e(l,r+1);return o}return t}(i));{let t=JSON.stringify(o);switch(e){case"error":console.error(t);break;case"warn":console.warn(t)}}}debug(e,t){this.log("debug",e,t)}info(e,t){this.log("info",e,t)}warn(e,t){this.log("warn",e,t)}error(e,t){this.log("error",e,t)}child(e){return new o(this,e)}logRequestStart(e,t,r){let s=r?.correlationId||`tlx_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,a=Date.now();return this.debug(`${e} ${t} started`,{...r,correlationId:s,endpoint:t}),{correlationId:s,startTime:a}}logRequestEnd(e,t,r,s,a){let n=Date.now()-s;(r>=400?this.warn.bind(this):this.info.bind(this))(`${e} ${t} completed`,{...a,endpoint:t,statusCode:r,latencyMs:n})}logRequestError(e,t,r,s,a){let n=Date.now()-s;this.error(`${e} ${t} failed`,{...a,endpoint:t,error:r.message,latencyMs:n})}};e.s(["telnyxLogger",0,i])},628123,e=>{"use strict";var t=e.i(786348);let r={maxRetries:5,baseDelayMs:1e3,maxDelayMs:32e3,jitterFactor:.3,retryableStatusCodes:[408,429,500,502,503,504],retryableErrorCodes:["ECONNRESET","ETIMEDOUT","ECONNREFUSED","EPIPE","ENOTFOUND","ENETUNREACH","EAI_AGAIN"]},s={failureThreshold:5,resetTimeoutMs:6e4,halfOpenRequests:3},a=new Map;function n(e){return a.has(e)||a.set(e,{state:"closed",failures:0,lastFailureTime:0,halfOpenSuccesses:0,halfOpenFailures:0}),a.get(e)}function o(e,r,a=s){let i=n(e),l=Date.now();r?"half-open"===i.state?(i.halfOpenSuccesses++,i.halfOpenSuccesses>=a.halfOpenRequests&&(i.state="closed",i.failures=0,i.halfOpenSuccesses=0,i.halfOpenFailures=0,t.telnyxLogger.info("Circuit breaker closed",{endpoint:e}))):"closed"===i.state&&(i.failures=0):(i.lastFailureTime=l,"half-open"===i.state?(i.halfOpenFailures++,i.state="open",i.halfOpenSuccesses=0,i.halfOpenFailures=0,t.telnyxLogger.warn("Circuit breaker reopened",{endpoint:e})):"closed"===i.state&&(i.failures++,i.failures>=a.failureThreshold&&(i.state="open",t.telnyxLogger.error("Circuit breaker opened",{endpoint:e,failures:i.failures}))))}function i(e,t){let r=Error(e);return r.name="RetryError",r.statusCode=t.statusCode,r.errorCode=t.errorCode,r.retryable=t.retryable,r.attempts=t.attempts,r.lastError=t.lastError,r}function l(e){return new Promise(t=>setTimeout(t,e))}async function E(e,a={}){let u,d={...r,...a.config},h={...s,...a.circuitBreakerConfig},R=a.endpoint||"default",_=a.correlationId||c();if(!function(e,r=s){let a=n(e),o=Date.now();return"closed"===a.state||"open"!==a.state||o-a.lastFailureTime>=r.resetTimeoutMs&&(a.state="half-open",a.halfOpenSuccesses=0,a.halfOpenFailures=0,t.telnyxLogger.info("Circuit breaker half-open",{endpoint:e}),!0)}(R,h)){let e=i(`Circuit breaker open for endpoint: ${R}`,{retryable:!1,attempts:0});throw t.telnyxLogger.warn("Request blocked by circuit breaker",{endpoint:R,correlationId:_}),e}let N=0;for(;N<=d.maxRetries;)try{let r=await e();return o(R,!0,h),N>0&&t.telnyxLogger.info("Request succeeded after retry",{endpoint:R,attempt:N,correlationId:_}),r}catch(n){u=n instanceof Error?n:Error(String(n));let e=function(e,t=r){if(!e)return!1;if(e instanceof Error){let r=e.code;if(r&&t.retryableErrorCodes.includes(r)||e.message.includes("fetch failed")||e.message.includes("network")||e.message.includes("timeout")||e.message.includes("ECONNRESET"))return!0}if("object"==typeof e&&null!==e){let r=e.statusCode||e.status;if(r&&t.retryableStatusCodes.includes(r))return!0}return!1}(n,d);if(t.telnyxLogger.warn("Request failed",{endpoint:R,attempt:N,retryable:e,error:u.message,correlationId:_}),o(R,!1,h),!e||N>=d.maxRetries)throw i(`Request failed after ${N+1} attempt(s): ${u.message}`,{retryable:e,attempts:N+1,lastError:u,statusCode:n.statusCode,errorCode:n.code});let s=function(e,t=r){let s=Math.min(t.baseDelayMs*Math.pow(2,e),t.maxDelayMs),a=s*t.jitterFactor*Math.random();return Math.floor(s+a)}(N,d);if("object"==typeof n&&null!==n&&"response"in n){let e=n.response;if(e){let t=function(e){let t=e.headers.get("Retry-After");if(!t)return null;let r=parseInt(t,10);if(!isNaN(r))return 1e3*r;let s=Date.parse(t);return isNaN(s)?null:Math.max(0,s-Date.now())}(e);t&&(s=Math.min(t,d.maxDelayMs))}}a.onRetry&&a.onRetry(N,u,s),t.telnyxLogger.info("Retrying request",{endpoint:R,attempt:N+1,delayMs:s,correlationId:_}),await l(s),N++}throw i(`Request failed after ${d.maxRetries+1} attempts`,{retryable:!1,attempts:d.maxRetries+1,lastError:u})}function c(){return`tlx_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}e.s(["generateCorrelationId",()=>c,"sleep",()=>l,"withRetry",()=>E])},618874,(e,t,r)=>{},408305,692837,e=>{"use strict";var t,r=((t={}).NETWORK_ERROR="TELNYX_NETWORK_ERROR",t.TIMEOUT="TELNYX_TIMEOUT",t.CONNECTION_REFUSED="TELNYX_CONNECTION_REFUSED",t.INVALID_API_KEY="TELNYX_INVALID_API_KEY",t.UNAUTHORIZED="TELNYX_UNAUTHORIZED",t.FORBIDDEN="TELNYX_FORBIDDEN",t.RATE_LIMIT_EXCEEDED="TELNYX_RATE_LIMIT_EXCEEDED",t.INVALID_PHONE_NUMBER="TELNYX_INVALID_PHONE_NUMBER",t.INVALID_REQUEST="TELNYX_INVALID_REQUEST",t.MISSING_REQUIRED_FIELD="TELNYX_MISSING_REQUIRED_FIELD",t.NOT_FOUND="TELNYX_NOT_FOUND",t.RESOURCE_CONFLICT="TELNYX_RESOURCE_CONFLICT",t.PROVIDER_ERROR="TELNYX_PROVIDER_ERROR",t.CARRIER_ERROR="TELNYX_CARRIER_ERROR",t.DELIVERY_FAILED="TELNYX_DELIVERY_FAILED",t.CALL_REJECTED="TELNYX_CALL_REJECTED",t.CALL_BUSY="TELNYX_CALL_BUSY",t.CALL_NO_ANSWER="TELNYX_CALL_NO_ANSWER",t.CALL_FAILED="TELNYX_CALL_FAILED",t.SMS_DELIVERY_FAILED="TELNYX_SMS_DELIVERY_FAILED",t.SMS_BLOCKED="TELNYX_SMS_BLOCKED",t.SMS_SPAM_DETECTED="TELNYX_SMS_SPAM_DETECTED",t.WEBHOOK_VALIDATION_FAILED="TELNYX_WEBHOOK_VALIDATION_FAILED",t.WEBHOOK_SIGNATURE_INVALID="TELNYX_WEBHOOK_SIGNATURE_INVALID",t.WEBHOOK_TIMESTAMP_INVALID="TELNYX_WEBHOOK_TIMESTAMP_INVALID",t.WEBHOOK_REPLAY_DETECTED="TELNYX_WEBHOOK_REPLAY_DETECTED",t.CIRCUIT_BREAKER_OPEN="TELNYX_CIRCUIT_BREAKER_OPEN",t.UNKNOWN_ERROR="TELNYX_UNKNOWN_ERROR",t.INTERNAL_ERROR="TELNYX_INTERNAL_ERROR",t);class s extends Error{code;metadata;timestamp;retryable;retryAfterMs;constructor(e,t="TELNYX_UNKNOWN_ERROR",r={}){super(e),this.name="TelnyxError",this.code=t,this.metadata=r,this.timestamp=new Date,this.retryable=r.retryable??this.isRetryableCode(t),this.retryAfterMs=r.retryAfterMs,Error.captureStackTrace&&Error.captureStackTrace(this,s)}isRetryableCode(e){return["TELNYX_NETWORK_ERROR","TELNYX_TIMEOUT","TELNYX_CONNECTION_REFUSED","TELNYX_RATE_LIMIT_EXCEEDED","TELNYX_PROVIDER_ERROR","TELNYX_INTERNAL_ERROR"].includes(e)}toJSON(){return{name:this.name,message:this.message,code:this.code,metadata:this.metadata,timestamp:this.timestamp.toISOString(),retryable:this.retryable,retryAfterMs:this.retryAfterMs,stack:this.stack}}toUserMessage(){switch(this.code){case"TELNYX_INVALID_PHONE_NUMBER":return"The phone number provided is invalid. Please check and try again.";case"TELNYX_RATE_LIMIT_EXCEEDED":return"Too many requests. Please wait a moment and try again.";case"TELNYX_CALL_BUSY":return"The number is busy. Please try again later.";case"TELNYX_CALL_NO_ANSWER":return"No answer. The call was not picked up.";case"TELNYX_SMS_BLOCKED":return"Message could not be delivered. The recipient may have blocked messages.";case"TELNYX_UNAUTHORIZED":case"TELNYX_INVALID_API_KEY":return"Authentication failed. Please contact support.";case"TELNYX_NETWORK_ERROR":case"TELNYX_TIMEOUT":return"Connection issue. Please try again.";default:return"An error occurred. Please try again or contact support."}}}class a extends s{constructor(e,t={}){super(e,"TELNYX_NETWORK_ERROR",{...t,retryable:!0}),this.name="TelnyxNetworkError"}}class n extends s{timeoutMs;constructor(e,t,r={}){super(e,"TELNYX_TIMEOUT",{...r,retryable:!0}),this.name="TelnyxTimeoutError",this.timeoutMs=t}}class o extends s{constructor(e,t,r={}){super(e,"TELNYX_RATE_LIMIT_EXCEEDED",{...r,retryable:!0,retryAfterMs:t}),this.name="TelnyxRateLimitError"}}class i extends s{constructor(e,t={}){super(e,403===t.statusCode?"TELNYX_FORBIDDEN":"TELNYX_UNAUTHORIZED",{...t,retryable:!1}),this.name="TelnyxAuthError"}}class l extends s{field;validationDetails;constructor(e,t={}){super(e,"TELNYX_INVALID_REQUEST",{...t,retryable:!1}),this.name="TelnyxValidationError",this.field=t.field,this.validationDetails=t.validationDetails}}function E(e,t,r={}){let a=t?.errors?.[0]?.detail||t?.error||t?.message||"Unknown error",n=t?.errors?.[0]?.code,c={...r,statusCode:e,telnyxErrorCode:n,telnyxErrorDetail:a};switch(e){case 400:return new l(a,c);case 401:return new i("Invalid API key or unauthorized",c);case 403:return new i("Access forbidden",c);case 404:return new s("Resource not found","TELNYX_NOT_FOUND",{...c,retryable:!1});case 409:return new s("Resource conflict","TELNYX_RESOURCE_CONFLICT",{...c,retryable:!1});case 429:return new o("Rate limit exceeded",1e3*parseInt(t?.retry_after||"60",10),c);case 500:case 502:case 503:case 504:return new s("Telnyx service error","TELNYX_PROVIDER_ERROR",{...c,retryable:!0});default:return new s(a,"TELNYX_UNKNOWN_ERROR",c)}}function c(e,t={}){if(e instanceof s)return e;let r=e instanceof Error?e:Error(String(e)),o=r.code,i={...t,originalError:r};return"AbortError"===r.name||r.message.includes("timeout")?new n("Request timed out",t.timeout||3e4,i):"ECONNRESET"===o||"ECONNREFUSED"===o||"ENOTFOUND"===o||"ENETUNREACH"===o||r.message.includes("fetch failed")||r.message.includes("network")?new a(`Network error: ${r.message}`,i):new s(r.message,"TELNYX_UNKNOWN_ERROR",i)}e.s(["TelnyxError",()=>s,"TelnyxErrorCode",()=>r,"TelnyxTimeoutError",()=>n,"createErrorFromException",()=>c,"createErrorFromResponse",()=>E],408305);var u=e.i(786348);let d=new class{requests=[];operations={smsSent:0,smsDelivered:0,smsFailed:0,callsInitiated:0,callsCompleted:0,callsFailed:0,webhooksReceived:0,webhooksProcessed:0,webhooksFailed:0};retentionMs=36e5;maxEntries=1e4;cleanupInterval;constructor(){this.startCleanup()}startCleanup(){this.cleanupInterval=setInterval(()=>{this.cleanup()},6e4),this.cleanupInterval.unref&&this.cleanupInterval.unref()}cleanup(){let e=Date.now()-this.retentionMs,t=this.requests.length;this.requests=this.requests.filter(t=>t.timestamp.getTime()>e),this.requests.length>this.maxEntries&&(this.requests=this.requests.slice(-this.maxEntries));let r=t-this.requests.length;r>0&&u.telnyxLogger.debug("Metrics cleanup",{removed:r})}recordRequest(e){this.requests.push(e),e.latencyMs>2e3&&u.telnyxLogger.warn("Slow request detected",{endpoint:e.endpoint,latencyMs:e.latencyMs,correlationId:e.correlationId})}recordSmsSent(e){this.operations.smsSent++,!e&&this.operations.smsFailed++}recordSmsDelivered(){this.operations.smsDelivered++}recordCallInitiated(e){this.operations.callsInitiated++,!e&&this.operations.callsFailed++}recordCallCompleted(){this.operations.callsCompleted++}recordWebhook(e){this.operations.webhooksReceived++,e?this.operations.webhooksProcessed++:this.operations.webhooksFailed++}getAggregatedMetrics(e=3e5){let t=Date.now()-e,r=this.requests.filter(e=>e.timestamp.getTime()>t),s=r.filter(e=>e.success).length,a=r.length-s,n=r.map(e=>e.latencyMs).sort((e,t)=>e-t),o=(e,t)=>{if(0===e.length)return 0;let r=Math.ceil(t/100*e.length)-1;return e[Math.max(0,r)]},i={};for(let e of r)i[e.endpoint]||(i[e.endpoint]={count:0,errors:0,totalLatency:0}),i[e.endpoint].count++,i[e.endpoint].totalLatency+=e.latencyMs,!e.success&&i[e.endpoint].errors++;let l={};for(let e of r)l[e.statusCode]=(l[e.statusCode]||0)+1;return{totalRequests:r.length,successfulRequests:s,failedRequests:a,errorRate:r.length>0?a/r.length:0,latency:{p50:o(n,50),p95:o(n,95),p99:o(n,99),avg:n.length>0?n.reduce((e,t)=>e+t,0)/n.length:0,min:n[0]||0,max:n[n.length-1]||0},byEndpoint:Object.fromEntries(Object.entries(i).map(([e,t])=>[e,{count:t.count,errors:t.errors,avgLatency:t.totalLatency/t.count}])),byStatusCode:l}}getOperationMetrics(){return{...this.operations}}getHealthScore(e=3e5){let t=this.getAggregatedMetrics(e);return 0===t.totalRequests?100:Math.round(.5*Math.max(0,100-1e3*t.errorRate)+.3*Math.max(0,100-t.latency.p95/3e3*100)+.2*Math.max(0,100-1e3*(Object.entries(t.byStatusCode).filter(([e])=>parseInt(e)>=500).reduce((e,[,t])=>e+t,0)/t.totalRequests)))}reset(){this.requests=[],this.operations={smsSent:0,smsDelivered:0,smsFailed:0,callsInitiated:0,callsCompleted:0,callsFailed:0,webhooksReceived:0,webhooksProcessed:0,webhooksFailed:0}}stop(){this.cleanupInterval&&clearInterval(this.cleanupInterval)}};function h(e,t,r,s){let a=Date.now();return{end:(n,o)=>{d.recordRequest({endpoint:e,method:t,statusCode:n,latencyMs:Date.now()-a,success:o,timestamp:new Date,companyId:r,correlationId:s})}}}e.s(["startRequestTimer",()=>h,"telnyxMetrics",0,d],692837)}];

//# sourceMappingURL=_222cb1cb._.js.map