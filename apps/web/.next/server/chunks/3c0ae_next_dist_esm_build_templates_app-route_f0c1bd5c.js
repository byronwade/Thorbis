module.exports=[252625,e=>{"use strict";var t=e.i(755535),a=e.i(377233),r=e.i(490003),n=e.i(492991),o=e.i(241970),l=e.i(357699),i=e.i(212454),s=e.i(48717),d=e.i(798301),c=e.i(986366),u=e.i(983537),_=e.i(147475),p=e.i(561930),m=e.i(803747),h=e.i(368557),g=e.i(42037),f=e.i(193695);e.i(432036);var w=e.i(573881),v=e.i(297676),R=e.i(273568);async function b(e){let t=e.headers.get("authorization"),a=process.env.CRON_SECRET;if(!a)return v.NextResponse.json({error:"Cron secret not configured"},{status:500});if(t!==`Bearer ${a}`)return v.NextResponse.json({error:"Unauthorized"},{status:401});try{let e=(0,R.createServiceSupabaseClient)(),t=[],{data:a,error:r}=await e.from("companies").select("id").is("deleted_at",null);if(r||!a)return v.NextResponse.json({error:"Failed to fetch companies",details:r?.message},{status:500});for(let r of a)try{let a=await k(e,r.id),n=await E(e,r.id);t.push({companyId:r.id,campaignsProcessed:a,csrsProcessed:n,success:!0})}catch(a){let e=a instanceof Error?a.message:"Unknown error";t.push({companyId:r.id,campaignsProcessed:0,csrsProcessed:0,success:!1,error:e})}let n=t.reduce((e,t)=>e+t.campaignsProcessed,0),o=t.reduce((e,t)=>e+t.csrsProcessed,0);return v.NextResponse.json({success:!0,totalCampaignsProcessed:n,totalCSRsProcessed:o,companiesProcessed:a.length,results:t})}catch(t){let e=t instanceof Error?t.message:"Unknown error";return v.NextResponse.json({error:"Failed",details:e},{status:500})}}async function k(e,t){let a=new Date().toISOString().split("T")[0],{data:r,error:n}=await e.from("marketing_campaigns").select("*").eq("company_id",t).in("status",["active","completed"]).is("deleted_at",null);if(n||!r)throw Error(`Failed to fetch campaigns: ${n?.message}`);let o=0;for(let n of r)try{let{data:r}=await e.from("marketing_call_tracking").select("*").eq("campaign_id",n.id),l=r?.length??0,i=r?.filter(e=>e.answered)?.length??0,s=r?.filter(e=>e.booked_job)?.length??0,d=r?.filter(e=>"spam"!==e.call_outcome&&"wrong_number"!==e.call_outcome)?.length??0,c=r?.filter(e=>e.job_id).map(e=>e.job_id)??[],u=0,_=0;if(c.length>0){let{data:t}=await e.from("jobs").select("total_amount, profit_actual").in("id",c);u=t?.reduce((e,t)=>e+(t.total_amount??0),0)??0,_=t?.reduce((e,t)=>e+(t.profit_actual??0),0)??0}let p=n.actual_spend??0,m=d>0?p/d:0,h=s>0?p/s:0,g=p>0?u/p:0,f=p>0?(u-p)/p*100:0;await e.from("marketing_campaigns").update({total_leads:d,total_calls:l,total_booked_jobs:s,total_revenue:Math.round(100*u)/100,total_profit:Math.round(100*_)/100,cost_per_lead:Math.round(100*m)/100,cost_per_acquisition:Math.round(100*h)/100,return_on_ad_spend:Math.round(100*g)/100,roi_percent:Math.round(100*f)/100,updated_at:new Date().toISOString()}).eq("id",n.id);let w=d>0?s/d*100:0,v=l>0?i/l*100:0;await e.from("analytics_marketing_attribution").upsert({company_id:t,date:a,campaign_id:n.id,channel:n.channel,lead_source:n.utm_source??n.channel,daily_spend:p,cumulative_spend:p,total_calls:l,answered_calls:i,call_answer_rate:Math.round(100*v)/100,total_leads:d,booked_appointments:s,booking_rate:Math.round(100*w)/100,total_revenue:Math.round(100*u)/100,total_profit:Math.round(100*_)/100,cost_per_lead:Math.round(100*m)/100,cost_per_acquisition:Math.round(100*h)/100,return_on_ad_spend:Math.round(100*g)/100,roi_percent:Math.round(100*f)/100,updated_at:new Date().toISOString()},{onConflict:"company_id,date,campaign_id,channel,lead_source"}),o++}catch{continue}return await y(e,t,a),o}async function y(e,t,a){let{data:r}=await e.from("marketing_call_tracking").select(`
			*,
			campaign:marketing_campaigns(channel, utm_source)
		`).eq("company_id",t).gte("call_start",`${a}T00:00:00`).lt("call_start",`${a}T23:59:59`);if(!r||0===r.length)return;let n={};for(let e of r){let t=e.campaign?.channel??"organic";n[t]||(n[t]={calls:0,answered:0,booked:0,revenue:0}),n[t].calls++,e.answered&&n[t].answered++,e.booked_job&&n[t].booked++,n[t].revenue+=e.attributed_revenue??0}for(let[r,o]of Object.entries(n)){let n=o.calls>0?o.answered/o.calls*100:0,l=o.calls>0?o.booked/o.calls*100:0;await e.from("analytics_marketing_attribution").upsert({company_id:t,date:a,campaign_id:null,channel:r,lead_source:r,total_calls:o.calls,answered_calls:o.answered,call_answer_rate:Math.round(100*n)/100,total_leads:o.calls,booked_appointments:o.booked,booking_rate:Math.round(100*l)/100,total_revenue:Math.round(100*o.revenue)/100,updated_at:new Date().toISOString()},{onConflict:"company_id,date,campaign_id,channel,lead_source"})}}async function E(e,t){let a=new Date,r=a.toISOString().split("T")[0],n=new Date(a);n.setDate(n.getDate()-30);let o=n.toISOString().split("T")[0],{data:l}=await e.from("users").select("id, first_name, last_name, role").eq("company_id",t).in("role",["admin","office_staff","dispatcher","csr"]).is("deleted_at",null);if(!l||0===l.length)return 0;let i=0,s=[];for(let a of l)try{let{data:l}=await e.from("marketing_call_tracking").select("*").eq("answered_by_user_id",a.id).gte("call_start",n.toISOString()),d=l?.length??0,c=l?.filter(e=>e.missed_call)?.length??0,u=d+c,_=u>0?d/u*100:0,p=l?.filter(e=>"spam"!==e.call_outcome&&"wrong_number"!==e.call_outcome&&"voicemail"!==e.call_outcome)?.length??0,m=l?.filter(e=>e.booked_job)?.length??0,h=p>0?m/p*100:0,g=l?.reduce((e,t)=>e+(t.attributed_revenue??0),0)??0,f=m>0?g/m:0,w=d>0?g/d:0,v=l&&l.length>0?l.reduce((e,t)=>e+(t.talk_time_seconds??0),0)/l.length:0,R=l&&l.length>0?l.reduce((e,t)=>e+(t.ring_time_seconds??0),0)/l.length:0,b=l&&l.length>0?l.reduce((e,t)=>e+(t.hold_time_seconds??0),0)/l.length:0,k=(l?.reduce((e,t)=>e+(t.talk_time_seconds??0),0)/60)??0,y=l?.filter(e=>e.call_quality_score)??[],E=y.length>0?y.reduce((e,t)=>e+(t.call_quality_score??0),0)/y.length:0,M=l?.filter(e=>"positive"===e.customer_sentiment)?.length??0,C=l?.filter(e=>"negative"===e.customer_sentiment)?.length??0,x=l?.filter(e=>e.is_new_customer)?.length??0,S=d-x,I=Math.min(h/80*40,40),O=Math.min(g/1e4*30,30),T=Math.min(d/100*20,20),P=E/5*10,A=I+O+T+P;s.push({userId:a.id,name:`${a.first_name} ${a.last_name}`.trim(),bookingRate:h,revenue:g,callVolume:d,performanceScore:A}),await e.from("analytics_csr_metrics").upsert({company_id:t,user_id:a.id,date:r,period_start:o,period_end:r,csr_name:`${a.first_name} ${a.last_name}`.trim(),total_calls_received:u,total_calls_answered:d,total_calls_missed:c,call_answer_rate:Math.round(100*_)/100,avg_ring_time_seconds:Math.round(R),avg_talk_time_seconds:Math.round(v),avg_hold_time_seconds:Math.round(b),total_talk_time_minutes:Math.round(k),total_opportunities:p,jobs_booked:m,booking_rate:Math.round(100*h)/100,booked_revenue:Math.round(100*g)/100,avg_booked_ticket:Math.round(100*f)/100,revenue_per_call:Math.round(100*w)/100,new_customers_created:x,existing_customer_calls:S,avg_call_quality_score:Math.round(100*E)/100,positive_sentiment_calls:M,negative_sentiment_calls:C,overall_performance_score:Math.round(100*A)/100,updated_at:new Date().toISOString()},{onConflict:"company_id,user_id,date"}),i++}catch{continue}if(s.length>1){let a=[...s].sort((e,t)=>t.bookingRate-e.bookingRate),n=[...s].sort((e,t)=>t.revenue-e.revenue),o=[...s].sort((e,t)=>t.callVolume-e.callVolume);for(let l of s){let i=a.findIndex(e=>e.userId===l.userId)+1,s=n.findIndex(e=>e.userId===l.userId)+1,d=o.findIndex(e=>e.userId===l.userId)+1;await e.from("analytics_csr_metrics").update({booking_rate_rank:i,revenue_rank:s,call_volume_rank:d}).eq("company_id",t).eq("user_id",l.userId).eq("date",r)}}return i}e.s(["GET",()=>b,"maxDuration",0,300],598179);var M=e.i(598179);let C=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cron/calculate-marketing-csr/route",pathname:"/api/cron/calculate-marketing-csr",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/cron/calculate-marketing-csr/route.ts",nextConfigOutput:"",userland:M}),{workAsyncStorage:x,workUnitAsyncStorage:S,serverHooks:I}=C;function O(){return(0,r.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:S})}async function T(e,t,r){C.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/cron/calculate-marketing-csr/route";v=v.replace(/\/index$/,"")||"/";let R=await C.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:b,params:k,nextConfig:y,parsedUrl:E,isDraftMode:M,prerenderManifest:x,routerServerContext:S,isOnDemandRevalidate:I,revalidateOnlyGenerated:O,resolvedPathname:T,clientReferenceManifest:P,serverActionsManifest:A}=R,N=(0,s.normalizeAppPath)(v),q=!!(x.dynamicRoutes[N]||x.routes[T]),D=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,E,!1):t.end("This page could not be found"),null);if(q&&!M){let e=!!x.routes[T],t=x.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await D();throw new f.NoFallbackError}}let j=null;!q||C.isDev||M||(j="/index"===(j=T)?"/":j);let U=!0===C.isDev||!q,H=q&&!U;A&&P&&(0,l.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:P,serverActionsManifest:A,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:A})});let $=e.method||"GET",F=(0,o.getTracer)(),K=F.getActiveScopeSpan(),B={params:k,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>C.onRequestError(e,t,r,S)},sharedContext:{buildId:b}},V=new d.NodeNextRequest(e),L=new d.NodeNextResponse(t),G=c.NextRequestAdapter.fromNodeNextRequest(V,(0,c.signalFromNodeResponse)(t));try{let l=async e=>C.handle(G,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${$} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${v}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),s=async n=>{var o,s;let d=async({previousCacheEntry:a})=>{try{if(!i&&I&&O&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await l(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let s=B.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let d=B.renderOpts.collectedTags;if(!q)return await (0,p.sendResponse)(V,L,o,B.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(o.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,r=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:I})},S),t}},c=await C.handleResponse({req:e,nextConfig:y,cacheKey:j,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:O,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:i});if(!q)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(s=c.value)?void 0:s.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",I?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),M&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&q||u.delete(g.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(V,L,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};K?await s(K):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${$} ${v}`,kind:o.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},s))}catch(t){if(t instanceof f.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:I})}),q)throw t;return await (0,p.sendResponse)(V,L,new Response(null,{status:500})),null}}e.s(["handler",()=>T,"patchFetch",()=>O,"routeModule",()=>C,"serverHooks",()=>I,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>S],252625)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_f0c1bd5c.js.map