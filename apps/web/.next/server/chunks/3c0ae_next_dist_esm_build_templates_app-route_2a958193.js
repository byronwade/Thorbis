module.exports=[108143,e=>{"use strict";var t=e.i(755535),a=e.i(377233),n=e.i(490003),r=e.i(492991),s=e.i(241970),o=e.i(357699),l=e.i(212454),i=e.i(48717),c=e.i(798301),d=e.i(986366),u=e.i(983537),_=e.i(147475),p=e.i(561930),m=e.i(803747),h=e.i(368557),g=e.i(42037),f=e.i(193695);e.i(432036);var v=e.i(573881),y=e.i(297676),b=e.i(273568);async function w(e){let t=e.headers.get("authorization"),a=process.env.CRON_SECRET;if(!a)return y.NextResponse.json({error:"Cron secret not configured"},{status:500});if(t!==`Bearer ${a}`)return y.NextResponse.json({error:"Unauthorized"},{status:401});try{let e=(0,b.createServiceSupabaseClient)(),t=[],{data:a,error:n}=await e.from("companies").select("id").is("deleted_at",null);if(n)return y.NextResponse.json({error:"Failed to fetch companies",details:n.message},{status:500});if(!a||0===a.length)return y.NextResponse.json({success:!0,message:"No companies to process",processed:0});let r=new Date;r.setDate(r.getDate()-1);let s=r.toISOString().split("T")[0],o=`${s}T00:00:00.000Z`,l=`${s}T23:59:59.999Z`;for(let n of a)try{await R(e,n.id,s,o,l),t.push({companyId:n.id,success:!0})}catch(a){let e=a instanceof Error?a.message:"Unknown error";t.push({companyId:n.id,success:!1,error:e})}let i=t.filter(e=>e.success).length,c=t.filter(e=>!e.success).length;return y.NextResponse.json({success:!0,message:`Processed ${a.length} companies`,snapshotDate:s,successCount:i,failCount:c,results:t})}catch(t){let e=t instanceof Error?t.message:"Unknown error";return y.NextResponse.json({error:"Analytics population failed",details:e},{status:500})}}async function R(e,t,a,n,r){let[s,o,l,i,c,d,u,_,p,m,h,g]=await Promise.all([e.from("jobs").select("id, status, total_revenue, actual_start_time, actual_end_time, job_type, is_callback").eq("company_id",t).gte("created_at",n).lt("created_at",r).is("deleted_at",null),e.from("jobs").select("id, total_revenue, actual_start_time, actual_end_time, job_type").eq("company_id",t).eq("status","completed").gte("actual_end_time",n).lt("actual_end_time",r).is("deleted_at",null),e.from("estimates").select("id, status, total_amount, conversion_status").eq("company_id",t).gte("created_at",n).lt("created_at",r).is("deleted_at",null),e.from("invoices").select("id, status, total_amount, balance_amount, due_date, paid_at").eq("company_id",t).gte("created_at",n).lt("created_at",r).is("deleted_at",null),e.from("payments").select("id, amount, payment_method, status").eq("company_id",t).eq("status","completed").gte("created_at",n).lt("created_at",r).is("deleted_at",null),e.from("appointments").select("id, status").eq("company_id",t).gte("start_time",n).lt("start_time",r).is("deleted_at",null),e.from("communications").select("id, type, direction, response_time_minutes").eq("company_id",t).gte("created_at",n).lt("created_at",r).is("deleted_at",null),e.from("customers").select("id").eq("company_id",t).gte("created_at",n).lt("created_at",r).is("deleted_at",null),e.from("contracts").select("id, status, total_value").eq("company_id",t).gte("created_at",n).lt("created_at",r).is("deleted_at",null),e.from("users").select("id").eq("company_id",t).eq("role","technician").eq("status","active"),e.from("time_entries").select("id, duration_minutes, billable, user_id").eq("company_id",t).gte("created_at",n).lt("created_at",r).is("deleted_at",null),e.from("invoice_items").select("id, quantity, unit_price, item_type, invoice:invoices!inner(company_id, created_at)").eq("invoice.company_id",t).gte("invoice.created_at",n).lt("invoice.created_at",r)]),f=s.data??[],v=o.data??[],y=l.data??[],b=i.data??[],w=c.data??[],R=d.data??[],q=u.data??[],j=_.data??[],x=p.data??[],C=m.data??[],T=h.data??[],S=g.data??[],M=f.length,N=f.filter(e=>"scheduled"===e.status).length,A=v.length,O=f.filter(e=>"cancelled"===e.status).length,D=f.filter(e=>"in_progress"===e.status).length,k=v.filter(e=>!e.is_callback).length,P=v.filter(e=>e.is_callback).length,I=v.reduce((e,t)=>e+(t.total_revenue??0),0),U=A>0?Math.round(I/A):0,H=v.filter(e=>e.actual_start_time&&e.actual_end_time).map(e=>{let t=new Date(e.actual_start_time).getTime();return Math.round((new Date(e.actual_end_time).getTime()-t)/6e4)}),$=H.length>0?Math.round(H.reduce((e,t)=>e+t,0)/H.length):0,F=y.length,K=y.filter(e=>"won"===e.conversion_status).length,B=y.filter(e=>"lost"===e.conversion_status).length,L=F>0?K/F*100:0,z=y.reduce((e,t)=>e+(t.total_amount??0),0),G=b.length,V=b.filter(e=>"paid"===e.status).length,X=b.filter(e=>!!e.due_date&&"paid"!==e.status&&new Date(e.due_date)<new Date(a)).length,Z=w.reduce((e,t)=>e+(t.amount??0),0),W=w.length,J=R.length,Q=R.filter(e=>"completed"===e.status).length,Y=R.filter(e=>"cancelled"===e.status).length,ee=R.filter(e=>"no_show"===e.status).length,et=q.filter(e=>"email"===e.type&&"outbound"===e.direction).length,ea=q.filter(e=>"email"===e.type&&"inbound"===e.direction).length,en=q.filter(e=>"sms"===e.type&&"outbound"===e.direction).length,er=q.filter(e=>"sms"===e.type&&"inbound"===e.direction).length,es=q.filter(e=>"call"===e.type&&"outbound"===e.direction).length,eo=q.filter(e=>"call"===e.type&&"inbound"===e.direction).length,el=q.filter(e=>null!=e.response_time_minutes).map(e=>e.response_time_minutes),ei=el.length>0?Math.round(el.reduce((e,t)=>e+t,0)/el.length):0,ec=x.length,ed=x.filter(e=>"renewed"===e.status).length,eu=x.filter(e=>"cancelled"===e.status).length,e_=x.reduce((e,t)=>e+(t.total_value??0),0),{count:ep}=await e.from("contracts").select("id",{count:"exact",head:!0}).eq("company_id",t).eq("status","active").is("deleted_at",null),{count:em}=await e.from("customers").select("id",{count:"exact",head:!0}).eq("company_id",t).is("deleted_at",null),{data:eh}=await e.from("invoices").select("balance_amount").eq("company_id",t).in("status",["sent","partial","overdue"]).is("deleted_at",null),eg=(eh??[]).reduce((e,t)=>e+(t.balance_amount??0),0),ef=v.map(e=>e.total_revenue??0).sort((e,t)=>e-t),ev=ef.length>0?ef[Math.floor(ef.length/2)]:0,ey=ef.length>0?ef[Math.floor(.25*ef.length)]:0,eb=ef.length>0?ef[Math.floor(.75*ef.length)]:0,ew=ef.length>0?ef[Math.floor(.9*ef.length)]:0,eR={};for(let e of v){let t=e.job_type??"unknown";eR[t]=(eR[t]??0)+1}let eE=Object.entries(eR).sort((e,t)=>t[1]-e[1])[0],eq={};for(let e of w){let t=e.payment_method??"unknown";eq[t]=(eq[t]??0)+1}let ej=Object.entries(eq).sort((e,t)=>t[1]-e[1])[0],ex=T.filter(e=>!0===e.billable).reduce((e,t)=>e+(t.duration_minutes??0),0),eC=T.filter(e=>!1===e.billable||null===e.billable).reduce((e,t)=>e+(t.duration_minutes??0),0),eT=8*C.length,eS=(ex+eC)/60,eM=0,eN=0,eA=0;for(let e of S){let t=(e.unit_price??0)*(e.quantity??1);"part"===e.item_type||"material"===e.item_type?eM+=t:"labor"===e.item_type?eN+=t:"service"===e.item_type&&(eA+=t)}let eO=f.filter(e=>"emergency"===e.priority).length,eD=v.filter(e=>"emergency"===e.priority).reduce((e,t)=>e+(t.total_revenue??0),0),ek=v.filter(e=>!!e.actual_start_time&&!!e.actual_end_time&&new Date(e.actual_start_time).toISOString().split("T")[0]===new Date(e.actual_end_time).toISOString().split("T")[0]).length,eP=f.filter(e=>"rescheduled"===e.status).length,eI=(d.data??[]).reduce((e,t)=>e+(t.drive_time_minutes??0),0),eU=y.reduce((e,t)=>e+(t.total_amount??0),0),eH=v.filter(e=>null!=e.profit_actual).map(e=>e.profit_actual??0),e$=eH.length>0?eH.reduce((e,t)=>e+t,0)/eH.length:0,{error:eF}=await e.from("analytics_daily_snapshots").upsert({company_id:t,snapshot_date:a,total_revenue:I,collected_revenue:Z,outstanding_revenue:eg,average_ticket:U,jobs_created:M,jobs_scheduled:N,jobs_completed:A,jobs_cancelled:O,jobs_in_progress:D,average_job_duration_minutes:$,first_time_fix_count:k,callback_count:P,new_customers:j.length,total_active_customers:em??0,estimates_created:F,estimates_approved:K,estimates_declined:B,estimate_conversion_rate:L,estimate_total_value:z,invoices_created:G,invoices_paid:V,invoices_overdue:X,payments_received:Z,payment_count:W,appointments_scheduled:J,appointments_completed:Q,appointments_cancelled:Y,appointments_no_show:ee,appointment_show_rate:J>0?Q/J*100:0,emails_sent:et,emails_received:ea,sms_sent:en,sms_received:er,calls_made:es,calls_received:eo,average_response_time_minutes:ei,active_technicians:C.length,contracts_created:ec,contracts_renewed:ed,contracts_cancelled:eu,active_contracts:ep??0,contract_revenue:e_,median_job_value:ev,job_value_p25:ey,job_value_p75:eb,job_value_p90:ew,most_common_job_type:eE?.[0]??null,most_common_job_type_count:eE?.[1]??0,most_common_payment_method:ej?.[0]??null,most_common_payment_method_count:ej?.[1]??0,avg_response_time_minutes:ei,emergency_calls:eO,emergency_revenue:eD,same_day_completions:ek,callbacks:P,rescheduled_jobs:eP,capacity_available_hours:eT,capacity_booked_hours:eS,capacity_utilization:eT>0?eS/eT*100:0,drive_time_total_minutes:eI,billable_hours:ex/60,non_billable_hours:eC/60,parts_revenue:eM,labor_revenue:eN,service_revenue:eA,quotes_sent:F,quotes_value:eU,quotes_accepted:K,quotes_rejected:B,invoices_created:G,invoices_value:b.reduce((e,t)=>e+(t.total_amount??0),0),payments_received:W,payments_value:Z,avg_job_duration_minutes:$,avg_job_value:A>0?I/A:0,avg_job_profit:e$,updated_at:new Date().toISOString()},{onConflict:"company_id,snapshot_date"});if(eF)throw Error(`Failed to upsert snapshot: ${eF.message}`);await E(e,t,a)}async function E(e,t,a){let n=new Date(a);n.setDate(n.getDate()-90);let{data:r}=await e.from("analytics_daily_snapshots").select("snapshot_date, total_revenue, jobs_completed, new_customers").eq("company_id",t).gte("snapshot_date",n.toISOString().split("T")[0]).lte("snapshot_date",a).order("snapshot_date",{ascending:!0});if(!r||r.length<2)return;let s=r.map(e=>e.total_revenue??0),o=r.map(e=>e.jobs_completed??0),l=r.map(e=>e.new_customers??0),i=q(s,7),c=q(s,30),d=q(s,90),u=q(o,7),_=q(o,30),p=q(l,7),m=j(s.slice(-7)),h=j(o.slice(-7)),g=j(l.slice(-7)),f=s[s.length-2]??0,v=s[s.length-1]??0,y=s[s.length-8]??0,b=Math.round(7*i),w=Math.round(30*c);await e.from("analytics_daily_snapshots").update({revenue_7day_ma:Math.round(i),revenue_30day_ma:Math.round(c),revenue_90day_ma:Math.round(d),jobs_7day_ma:u,jobs_30day_ma:_,customers_7day_ma:p,revenue_trend:m,jobs_trend:h,customer_trend:g,revenue_vs_prev_day_percent:f>0?(v-f)/f*100:0,revenue_vs_prev_week_percent:y>0?(v-y)/y*100:0,revenue_forecast_7d:b,revenue_forecast_30d:w}).eq("company_id",t).eq("snapshot_date",a)}function q(e,t){if(0===e.length)return 0;let a=e.slice(-t);return a.reduce((e,t)=>e+t,0)/a.length}function j(e){if(e.length<2)return"stable";let t=e.slice(0,Math.floor(e.length/2)),a=e.slice(Math.floor(e.length/2)),n=t.reduce((e,t)=>e+t,0)/t.length,r=a.reduce((e,t)=>e+t,0)/a.length,s=n>0?(r-n)/n*100:0;return s>10?"increasing":s<-10?"decreasing":"stable"}e.s(["GET",()=>w,"maxDuration",0,300],42558);var x=e.i(42558);let C=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cron/populate-analytics/route",pathname:"/api/cron/populate-analytics",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/cron/populate-analytics/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:T,workUnitAsyncStorage:S,serverHooks:M}=C;function N(){return(0,n.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:S})}async function A(e,t,n){C.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/cron/populate-analytics/route";y=y.replace(/\/index$/,"")||"/";let b=await C.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!b)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:w,params:R,nextConfig:E,parsedUrl:q,isDraftMode:j,prerenderManifest:x,routerServerContext:T,isOnDemandRevalidate:S,revalidateOnlyGenerated:M,resolvedPathname:N,clientReferenceManifest:A,serverActionsManifest:O}=b,D=(0,i.normalizeAppPath)(y),k=!!(x.dynamicRoutes[D]||x.routes[N]),P=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,q,!1):t.end("This page could not be found"),null);if(k&&!j){let e=!!x.routes[N],t=x.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await P();throw new f.NoFallbackError}}let I=null;!k||C.isDev||j||(I="/index"===(I=N)?"/":I);let U=!0===C.isDev||!k,H=k&&!U;O&&A&&(0,o.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:A,serverActionsManifest:O,serverModuleMap:(0,l.createServerModuleMap)({serverActionsManifest:O})});let $=e.method||"GET",F=(0,s.getTracer)(),K=F.getActiveScopeSpan(),B={params:R,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n)=>C.onRequestError(e,t,n,T)},sharedContext:{buildId:w}},L=new c.NodeNextRequest(e),z=new c.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let o=async e=>C.handle(G,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${$} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${y}`)}),l=!!(0,r.getRequestMeta)(e,"minimalMode"),i=async r=>{var s,i;let c=async({previousCacheEntry:a})=>{try{if(!l&&S&&M&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(r);e.fetchMetrics=B.renderOpts.fetchMetrics;let i=B.renderOpts.pendingWaitUntil;i&&n.waitUntil&&(n.waitUntil(i),i=void 0);let c=B.renderOpts.collectedTags;if(!k)return await (0,p.sendResponse)(L,z,s,B.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(s.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,n=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==a?void 0:a.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:S})},T),t}},d=await C.handleResponse({req:e,nextConfig:E,cacheKey:I,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:M,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:l});if(!k)return null;if((null==d||null==(s=d.value)?void 0:s.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(i=d.value)?void 0:i.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",S?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),j&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&k||u.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(L,z,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};K?await i(K):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${$} ${y}`,kind:s.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},i))}catch(t){if(t instanceof f.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:S})}),k)throw t;return await (0,p.sendResponse)(L,z,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>N,"routeModule",()=>C,"serverHooks",()=>M,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>S],108143)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_2a958193.js.map