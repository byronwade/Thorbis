module.exports=[899696,e=>{"use strict";var t=e.i(755535),r=e.i(377233),a=e.i(490003),i=e.i(492991),s=e.i(241970),n=e.i(357699),o=e.i(212454),l=e.i(48717),c=e.i(798301),u=e.i(986366),d=e.i(983537),p=e.i(147475),m=e.i(561930),h=e.i(803747),_=e.i(368557),g=e.i(42037),y=e.i(193695);e.i(432036);var w=e.i(573881),v=e.i(297676),f=e.i(350318);e.i(16106);var R=e.i(985647);class P{baseUrl="https://api.shovels.ai/v1";apiKey=process.env.SHOVELS_API_KEY;isConfigured(){return!!this.apiKey}async request(e,t){try{let r=new URL(`${this.baseUrl}${e}`);t&&Object.entries(t).forEach(([e,t])=>{null!=t&&r.searchParams.set(e,String(t))});let a=await fetch(r.toString(),{headers:{Authorization:`Bearer ${this.apiKey}`,Accept:"application/json"}});if(!a.ok)return console.error("Shovels API error:",a.status,await a.text()),null;return await a.json()}catch(e){return console.error("Shovels API error:",e),null}}async searchPermits(e){let t={};return e.address&&(t.address=e.address),e.latitude&&(t.latitude=e.latitude),e.longitude&&(t.longitude=e.longitude),e.radius_miles&&(t.radius_miles=e.radius_miles),e.city&&(t.city=e.city),e.state&&(t.state=e.state),e.county&&(t.county=e.county),e.zip&&(t.zip=e.zip),e.permit_type&&(t.permit_type=e.permit_type),e.status&&(t.status=e.status),e.contractor_name&&(t.contractor_name=e.contractor_name),e.contractor_license&&(t.contractor_license=e.contractor_license),e.issue_date_start&&(t.issue_date_start=e.issue_date_start),e.issue_date_end&&(t.issue_date_end=e.issue_date_end),e.valuation_min&&(t.valuation_min=e.valuation_min),e.valuation_max&&(t.valuation_max=e.valuation_max),e.page&&(t.page=e.page),e.page_size&&(t.page_size=e.page_size),e.sort_by&&(t.sort_by=e.sort_by),e.sort_order&&(t.sort_order=e.sort_order),this.request("/permits/search",t)}async getPermit(e){return this.request(`/permits/${e}`)}async getPermitsByAddress(e){let t=await this.searchPermits({address:e,page_size:100});return t?.data||null}async getPermitsByLocation(e,t,r=1,a){return this.searchPermits({latitude:e,longitude:t,radius_miles:r,...a})}async getPropertyPermitHistory(e){let t=await this.getPermitsByAddress(e);if(!t||0===t.length)return null;let r={},a={},i=0;for(let e of t){let t=e.permit_type||"Unknown";r[t]=(r[t]||0)+1,e.contractor?.name&&(a[e.contractor.name]=(a[e.contractor.name]||0)+1),e.valuation&&(i+=e.valuation)}let s=Object.entries(a).map(([e,t])=>({name:e,permit_count:t})).sort((e,t)=>t.permit_count-e.permit_count),n=[...t].sort((e,t)=>{let r=e.issue_date?new Date(e.issue_date).getTime():0;return(t.issue_date?new Date(t.issue_date).getTime():0)-r});return{address:t[0].address||{},parcel:t[0].parcel,permits:t,total_permits:t.length,total_valuation:i,permit_types:r,contractors_used:s,last_permit_date:n[0]?.issue_date}}async searchContractors(e){let t={};return e.name&&(t.name=e.name),e.license_number&&(t.license_number=e.license_number),e.license_type&&(t.license_type=e.license_type),e.city&&(t.city=e.city),e.state&&(t.state=e.state),e.specialty&&(t.specialty=e.specialty),e.min_permits&&(t.min_permits=e.min_permits),e.min_rating&&(t.min_rating=e.min_rating),e.page&&(t.page=e.page),e.page_size&&(t.page_size=e.page_size),this.request("/contractors/search",t)}async getContractor(e){return this.request(`/contractors/${e}`)}async getContractorByLicense(e,t){let r=await this.searchContractors({license_number:e,state:t,page_size:1});return r?.data?.[0]||null}async getContractorPermits(e,t){return this.searchPermits({contractor_name:e,...t})}async getMarketActivity(e,t,r){let a=r?.end_date||new Date().toISOString().split("T")[0],i=r?.start_date||new Date(Date.now()-31536e6).toISOString().split("T")[0],s=await this.searchPermits({city:e,state:t,issue_date_start:i,issue_date_end:a,permit_type:r?.permit_type,page_size:1e3});if(!s||0===s.data.length)return null;let n=s.data,o={},l={},c=0;for(let e of n){let t=e.permit_type||"Unknown";o[t]=(o[t]||0)+1,e.contractor?.name&&(l[e.contractor.name]=(l[e.contractor.name]||0)+1),e.valuation&&(c+=e.valuation)}let u=Object.entries(l).map(([e,t])=>({name:e,permit_count:t})).sort((e,t)=>t.permit_count-e.permit_count).slice(0,10);return{jurisdiction:`${e}, ${t}`,period:`${i} to ${a}`,total_permits:n.length,total_valuation:c,permit_types:o,average_valuation:n.length>0?c/n.length:0,top_contractors:u}}async getHVACPermitHistory(e){let t=await this.searchPermits({address:e,permit_type:"HVAC",page_size:50}),r=await this.searchPermits({address:e,permit_type:"Mechanical",page_size:50}),a=Array.from(new Map([...t?.data||[],...r?.data||[]].map(e=>[e.id,e])).values());return a.length>0?a:null}async getPlumbingPermitHistory(e){let t=await this.searchPermits({address:e,permit_type:"Plumbing",page_size:50});return t?.data||null}async getElectricalPermitHistory(e){let t=await this.searchPermits({address:e,permit_type:"Electrical",page_size:50});return t?.data||null}async getRecentRenovationActivity(e,t=24){let r=new Date;r.setMonth(r.getMonth()-t);let a=await this.searchPermits({address:e,issue_date_start:r.toISOString().split("T")[0],page_size:100}),i=a?.data||[],s=[...new Set(i.map(e=>e.permit_type).filter(Boolean))],n=i.reduce((e,t)=>e+(t.valuation||0),0);return{hasRecentActivity:i.length>0,permits:i,renovationTypes:s,totalInvestment:n}}async findCompetitorContractors(e,t,r){let a=await this.searchContractors({city:e,state:t,specialty:r,min_permits:5,page_size:50});return a?.data||null}async verifyContractorLicense(e,t){let r=await this.getContractorByLicense(e,t);if(!r)return{valid:!1,contractor:null,status:"Not Found",expiration:null};let a=!!r.license_expiration&&new Date(r.license_expiration)<new Date;return{valid:"Active"===r.license_status&&!a,contractor:r,status:r.license_status||"Unknown",expiration:r.license_expiration||null}}async getEquipmentInstallationTimeline(e){let[t,r,a]=await Promise.all([this.getHVACPermitHistory(e),this.getPlumbingPermitHistory(e),this.getElectricalPermitHistory(e)]),i=(e,t)=>{if(!e)return{lastInstall:null,age:null};let r=e.filter(e=>t.some(t=>(e.work_description?.toLowerCase()||"").includes(t)||(e.permit_type_description?.toLowerCase()||"").includes(t)));if(0===r.length)return{lastInstall:null,age:null};let a=r.sort((e,t)=>{let r=e.issue_date?new Date(e.issue_date).getTime():0;return(t.issue_date?new Date(t.issue_date).getTime():0)-r})[0].issue_date||null,i=a?Math.floor((Date.now()-new Date(a).getTime())/315576e5):null;return{lastInstall:a,age:i}};return{hvac:i(t,["install","replace","new unit","furnace","air condition"]),plumbing:i(r,["install","replace","new","repipe"]),electrical:i(a,["install","panel","upgrade","rewire"]),waterHeater:i(r,["water heater","hot water","tankless"])}}async getServiceOpportunityLeads(e,t,r){let a=r?.minEquipmentAge||10,i=new Date;i.setFullYear(i.getFullYear()-a);let s={city:e,state:t,permit_type:r?.permitType||"HVAC",issue_date_end:i.toISOString().split("T")[0],page_size:100,sort_by:"issue_date",sort_order:"asc"};r?.latitude&&r?.longitude&&r?.radiusMiles&&(s.latitude=r.latitude,s.longitude=r.longitude,s.radius_miles=r.radiusMiles);let n=await this.searchPermits(s);return n?.data?n.data.map(e=>({address:e.address?.street?`${e.address.street}, ${e.address.city}, ${e.address.state} ${e.address.zip}`:"Unknown",lastPermitDate:e.issue_date||"Unknown",equipmentAge:e.issue_date?Math.floor((Date.now()-new Date(e.issue_date).getTime())/315576e5):0,permitType:e.permit_type||"Unknown",contractor:e.contractor?.name||null})):[]}}let E=new P;var C=e.i(511368);async function A(e){try{let t=e.nextUrl.searchParams,r=t.get("address"),a=t.get("city"),i=t.get("state"),s=t.get("zip"),n=t.get("action")||"permits",o=t.get("permitType"),l=t.get("contractorId"),c=t.get("licenseNumber"),u=await (0,C.createClient)();if(!u)return v.NextResponse.json({error:"Database connection failed"},{status:500});let{data:{user:d}}=await u.auth.getUser();if(!d)return v.NextResponse.json({error:"Unauthorized"},{status:401});let p=await (0,R.getActiveCompanyId)();if(!p)return v.NextResponse.json({error:"No active company selected"},{status:401});let m=await (0,f.checkApiQuota)(p,"shovels");if(m&&!m.has_quota)return v.NextResponse.json({error:"API quota exceeded",currentUsage:m.current_usage,limit:m.monthly_limit},{status:429});let h={search:"search_permits",permits:"permits_by_address",contractor:"contractor","verify-license":"verify_license","hvac-history":"hvac_history","plumbing-history":"plumbing_history","equipment-timeline":"equipment_timeline","service-leads":"service_leads",competitors:"competitors"}[n];if(!h)return v.NextResponse.json({error:"Invalid action"},{status:400});let _=await (0,f.withUsageTracking)(p,"shovels",h,async()=>{switch(n){case"search":if(!s)throw Error("zip required for search");return await E.searchPermits({zip_code:s,type:o||void 0});case"permits":if(!(r&&a&&i&&s))throw Error("address, city, state, zip required");return await E.getPermitsByAddress(r,a,i,s);case"contractor":if(!l)throw Error("contractorId required");return await E.getContractor(l);case"verify-license":if(!(c&&i))throw Error("licenseNumber and state required");return await E.verifyContractorLicense(c,i);case"hvac-history":if(!(r&&a&&i&&s))throw Error("address, city, state, zip required");return await E.getHVACPermitHistory(r,a,i,s);case"plumbing-history":if(!(r&&a&&i&&s))throw Error("address, city, state, zip required");return await E.getPlumbingPermitHistory(r,a,i,s);case"equipment-timeline":if(!(r&&a&&i&&s))throw Error("address, city, state, zip required");return await E.getEquipmentInstallationTimeline(r,a,i,s);case"service-leads":{if(!s)throw Error("zip required");let e=t.get("yearsOld");return await E.getServiceOpportunityLeads(s,e?parseInt(e):void 0)}case"competitors":if(!s)throw Error("zip required");return await E.findCompetitorContractors(s);default:throw Error(`Unknown action: ${n}`)}});if(!_)return v.NextResponse.json({error:"No data found"},{status:404});return v.NextResponse.json(_,{headers:{"Cache-Control":"public, s-maxage=3600, stale-while-revalidate=7200"}})}catch(e){if(console.error("Shovels API error:",e),e instanceof Error&&e.message.includes("required"))return v.NextResponse.json({error:e.message},{status:400});return v.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>A],889992);var x=e.i(889992);let b=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/property/shovels/route",pathname:"/api/property/shovels",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/property/shovels/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:T,workUnitAsyncStorage:q,serverHooks:S}=b;function N(){return(0,a.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:q})}async function I(e,t,a){b.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/property/shovels/route";v=v.replace(/\/index$/,"")||"/";let f=await b.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:P,nextConfig:E,parsedUrl:C,isDraftMode:A,prerenderManifest:x,routerServerContext:T,isOnDemandRevalidate:q,revalidateOnlyGenerated:S,resolvedPathname:N,clientReferenceManifest:I,serverActionsManifest:H}=f,z=(0,l.normalizeAppPath)(v),O=!!(x.dynamicRoutes[z]||x.routes[N]),U=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,C,!1):t.end("This page could not be found"),null);if(O&&!A){let e=!!x.routes[N],t=x.dynamicRoutes[z];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await U();throw new y.NoFallbackError}}let D=null;!O||b.isDev||A||(D="/index"===(D=N)?"/":D);let k=!0===b.isDev||!O,M=O&&!k;H&&I&&(0,n.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:I,serverActionsManifest:H,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:H})});let $=e.method||"GET",j=(0,s.getTracer)(),L=j.getActiveScopeSpan(),B={params:P,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>b.onRequestError(e,t,a,T)},sharedContext:{buildId:R}},K=new c.NodeNextRequest(e),F=new c.NodeNextResponse(t),V=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let n=async e=>b.handle(V,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${$} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${v}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var s,l;let c=async({previousCacheEntry:r})=>{try{if(!o&&q&&S&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await n(i);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=B.renderOpts.collectedTags;if(!O)return await (0,m.sendResponse)(K,F,s,B.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(s.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await b.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:q})},T),t}},u=await b.handleResponse({req:e,nextConfig:E,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:q,revalidateOnlyGenerated:S,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:o});if(!O)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",q?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&O||d.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,_.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(K,F,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};L?await l(L):await j.withPropagatedContext(e.headers,()=>j.trace(d.BaseServerSpan.handleRequest,{spanName:`${$} ${v}`,kind:s.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await b.onRequestError(e,t,{routerKind:"App Router",routePath:z,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:q})}),O)throw t;return await (0,m.sendResponse)(K,F,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>N,"routeModule",()=>b,"serverHooks",()=>S,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>q],899696)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_dbb91c10.js.map