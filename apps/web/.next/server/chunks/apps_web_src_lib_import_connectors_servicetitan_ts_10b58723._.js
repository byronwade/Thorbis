module.exports=[630003,e=>{"use strict";var t=e.i(90221);class r extends t.BaseDataConnector{baseUrl="https://api.servicetitan.io";authUrl="https://auth.servicetitan.io";apiVersion="v2";rateLimit=60;rateLimitRemaining=60;rateLimitResetAt=new Date;constructor(e){super(e)}async authenticate(){try{if(this.credentials.accessToken&&this.credentials.tokenExpiry&&new Date(this.credentials.tokenExpiry)>new Date)return this.authToken=this.credentials.accessToken,this.authenticated=!0,{success:!0,token:this.authToken};if(this.credentials.refreshToken)return await this.refreshAccessToken();return await this.getAccessToken()}catch(t){let e=t instanceof Error?t.message:"Authentication failed";return this.log("error","Authentication failed",t),{success:!1,error:e}}}async getAccessToken(){let{clientId:e,clientSecret:t}=this.credentials;if(!e||!t)return{success:!1,error:"Client ID and Client Secret are required"};try{let r=await fetch(`${this.authUrl}/connect/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:e,client_secret:t})});if(!r.ok){let e=await r.text();throw Error(`OAuth failed: ${r.status} - ${e}`)}let i=await r.json();return this.authToken=i.access_token,this.authenticated=!0,this.credentials.accessToken=i.access_token,this.credentials.tokenExpiry=new Date(Date.now()+1e3*i.expires_in).toISOString(),i.refresh_token&&(this.credentials.refreshToken=i.refresh_token),this.log("info","Successfully authenticated with ServiceTitan"),{success:!0,token:this.authToken}}catch(t){let e=t instanceof Error?t.message:"Token request failed";return this.log("error","Failed to get access token",t),{success:!1,error:e}}}async refreshAccessToken(){let{clientId:e,clientSecret:t,refreshToken:r}=this.credentials;if(!e||!t||!r)return await this.getAccessToken();try{let i=await fetch(`${this.authUrl}/connect/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",client_id:e,client_secret:t,refresh_token:r})});if(!i.ok)return await this.getAccessToken();let n=await i.json();return this.authToken=n.access_token,this.authenticated=!0,this.credentials.accessToken=n.access_token,this.credentials.tokenExpiry=new Date(Date.now()+1e3*n.expires_in).toISOString(),n.refresh_token&&(this.credentials.refreshToken=n.refresh_token),this.log("info","Successfully refreshed ServiceTitan token"),{success:!0,token:this.authToken}}catch(t){let e=t instanceof Error?t.message:"Token refresh failed";return this.log("error","Failed to refresh token",t),{success:!1,error:e}}}async *fetchData(e,t){if(this.validateEntityType(e),!this.authenticated){let e=await this.authenticate();if(!e.success)throw Error(`Authentication failed: ${e.error}`)}let r=this.getEntityEndpoint(e),i=t.continueFrom,n=!0,s=0;for(;n;){await this.waitForRateLimit();try{let a=this.buildUrl(r,{continueFrom:i,includeDeleted:t.includeDeleted,...t.filters}),o=await this.makeRequest(a),c=await o.json(),d=c.data||[];for(let t of(n=!!(i=c.continueFrom)&&d.length>0,this.log("info",`Fetched page ${++s} of ${e}`,{count:d.length,hasMore:n}),d))yield this.sanitizeData(this.transformRecord(e,t));this.updateRateLimitFromHeaders(o.headers)}catch(t){throw this.log("error",`Failed to fetch ${e}`,t),t}}this.log("info",`Completed fetching ${e}`,{totalPages:s})}async getSchema(e){let t={customers:{entity:"customers",primaryKey:"id",fields:[{name:"id",type:"number",required:!0,description:"ServiceTitan customer ID"},{name:"name",type:"string",required:!0,description:"Customer name"},{name:"type",type:"string",required:!0,description:"residential or commercial"},{name:"email",type:"string",required:!1,description:"Primary email"},{name:"phoneNumbers",type:"array",required:!1,description:"Phone numbers"},{name:"address",type:"json",required:!1,description:"Address object"},{name:"balance",type:"number",required:!1,description:"Account balance"},{name:"tags",type:"array",required:!1,description:"Customer tags"},{name:"customFields",type:"json",required:!1,description:"Custom field values"},{name:"createdOn",type:"datetime",required:!0,description:"Creation timestamp"},{name:"modifiedOn",type:"datetime",required:!1,description:"Last modified"},{name:"active",type:"boolean",required:!0,description:"Is active"}],relationships:[{field:"locations",referencesEntity:"properties",referencesField:"customerId"},{field:"jobs",referencesEntity:"jobs",referencesField:"customerId"}]},jobs:{entity:"jobs",primaryKey:"id",fields:[{name:"id",type:"number",required:!0},{name:"jobNumber",type:"string",required:!0},{name:"customerId",type:"number",required:!0},{name:"locationId",type:"number",required:!1},{name:"jobType",type:"string",required:!0},{name:"summary",type:"string",required:!1},{name:"status",type:"string",required:!0},{name:"completedOn",type:"datetime",required:!1},{name:"total",type:"number",required:!1},{name:"technicians",type:"array",required:!1}],relationships:[{field:"customerId",referencesEntity:"customers",referencesField:"id"},{field:"locationId",referencesEntity:"properties",referencesField:"id"}]},invoices:{entity:"invoices",primaryKey:"id",fields:[{name:"id",type:"number",required:!0},{name:"number",type:"string",required:!0},{name:"customerId",type:"number",required:!0},{name:"jobId",type:"number",required:!1},{name:"total",type:"number",required:!0},{name:"balance",type:"number",required:!0},{name:"status",type:"string",required:!0},{name:"dueDate",type:"date",required:!1},{name:"items",type:"array",required:!1}],relationships:[{field:"customerId",referencesEntity:"customers",referencesField:"id"},{field:"jobId",referencesEntity:"jobs",referencesField:"id"}]}}[e];if(!t)throw Error(`Schema not defined for entity: ${e}`);return t}async estimateRecordCount(e,t){let r=this.getEntityEndpoint(e),i=this.buildUrl(r,{...t,pageSize:1});try{let e=await this.makeRequest(i),t=await e.json();if(t.continueFrom)return 1e4;return t.data?.length||0}catch(e){return this.log("warn","Failed to estimate record count, returning 0",e),0}}async getRateLimitInfo(){return{limit:this.rateLimit,remaining:this.rateLimitRemaining,resetAt:this.rateLimitResetAt}}getSupportedEntities(){return["customers","jobs","invoices","estimates","equipment","properties","team","appointments","payments"]}getEntityEndpoint(e){let t={customers:"/crm/v2/export/customers",jobs:"/jpm/v2/export/jobs",invoices:"/accounting/v2/export/invoices",estimates:"/sales/v2/export/estimates",equipment:"/equipment/v2/export/equipment",properties:"/crm/v2/export/locations",team:"/settings/v2/export/technicians",appointments:"/jpm/v2/export/appointments",payments:"/accounting/v2/export/payments"}[e];if(!t)throw Error(`Endpoint not configured for entity: ${e}`);return t}buildUrl(e,t){let r=new URL(`${this.baseUrl}${e}`);return t&&Object.entries(t).forEach(([e,t])=>{null!=t&&r.searchParams.append(e,String(t))}),this.credentials.tenantId&&r.searchParams.append("tenant",this.credentials.tenantId),r.toString()}async makeRequest(e){if(!this.authToken)throw Error("Not authenticated");let t=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${this.authToken}`,"Content-Type":"application/json"}});if(401===t.status){if((await this.authenticate()).success)return this.makeRequest(e);throw Error("Authentication expired and refresh failed")}if(!t.ok){let e=await t.text();throw Error(`ServiceTitan API error: ${t.status} - ${e}`)}return t}transformRecord(e,t){let r={...t};return r.external_id=String(t.id),t.phoneNumbers&&Array.isArray(t.phoneNumbers)&&(r.phone=t.phoneNumbers[0]?.number,r.phone_numbers=t.phoneNumbers),t.email&&(r.email=this.normalizeEmail(t.email)),t.address&&(r.address=t.address.street,r.city=t.address.city,r.state=t.address.state,r.zip=t.address.zip),r}async waitForRateLimit(){if(this.rateLimitRemaining<=1){let e=Date.now(),t=Math.max(0,this.rateLimitResetAt.getTime()-e);t>0&&(this.log("info",`Rate limit reached, waiting ${t}ms`),await this.sleep(t)),this.rateLimitRemaining=this.rateLimit,this.rateLimitResetAt=new Date(Date.now()+1e3)}this.rateLimitRemaining--}updateRateLimitFromHeaders(e){let t=e.get("x-ratelimit-remaining"),r=e.get("x-ratelimit-reset");t&&(this.rateLimitRemaining=parseInt(t,10)),r&&(this.rateLimitResetAt=new Date(1e3*parseInt(r,10)))}}e.s(["ServiceTitanConnector",()=>r])}];

//# sourceMappingURL=apps_web_src_lib_import_connectors_servicetitan_ts_10b58723._.js.map