{"version":3,"sources":["../../../../../apps/web/src/lib/telnyx/logger.ts","../../../../../apps/web/src/lib/telnyx/retry.ts","../../../../../apps/web/src/lib/telnyx/messaging.ts"],"sourcesContent":["/**\n * Telnyx Structured Logger\n *\n * Provides structured JSON logging with PII redaction,\n * log levels, and correlation ID support.\n */\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport type LogLevel = \"debug\" | \"info\" | \"warn\" | \"error\";\n\nexport interface LogContext {\n\tcorrelationId?: string;\n\tendpoint?: string;\n\tcompanyId?: string;\n\tphoneNumber?: string;\n\tcallControlId?: string;\n\tmessageSid?: string;\n\tattempt?: number;\n\tdelayMs?: number;\n\tlatencyMs?: number;\n\tstatusCode?: number;\n\terror?: string;\n\t[key: string]: unknown;\n}\n\nexport interface LogEntry {\n\ttimestamp: string;\n\tlevel: LogLevel;\n\tservice: string;\n\tmessage: string;\n\tcontext?: LogContext;\n}\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nconst LOG_LEVELS: Record<LogLevel, number> = {\n\tdebug: 0,\n\tinfo: 1,\n\twarn: 2,\n\terror: 3,\n};\n\n// Default to 'info' in production, 'debug' in development\nconst currentLogLevel: LogLevel =\n\t(process.env.TELNYX_LOG_LEVEL as LogLevel) ||\n\t(process.env.NODE_ENV === \"production\" ? \"info\" : \"debug\");\n\n// PII patterns to redact\nconst PII_PATTERNS = [\n\t// Phone numbers (various formats)\n\t/\\+?1?\\d{10,15}/g,\n\t// Email addresses\n\t/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g,\n];\n\n// Fields that should be redacted\nconst SENSITIVE_FIELDS = [\n\t\"phone\",\n\t\"phoneNumber\",\n\t\"phone_number\",\n\t\"from\",\n\t\"to\",\n\t\"fromNumber\",\n\t\"toNumber\",\n\t\"from_number\",\n\t\"to_number\",\n\t\"apiKey\",\n\t\"api_key\",\n\t\"authToken\",\n\t\"auth_token\",\n\t\"password\",\n\t\"secret\",\n\t\"token\",\n];\n\n// =============================================================================\n// PII REDACTION\n// =============================================================================\n\n/**\n * Mask a phone number, keeping last 4 digits\n */\nfunction maskPhoneNumber(phone: string): string {\n\tconst digits = phone.replace(/\\D/g, \"\");\n\tif (digits.length < 4) return \"****\";\n\treturn `***${digits.slice(-4)}`;\n}\n\n/**\n * Mask an email address\n */\nfunction maskEmail(email: string): string {\n\tconst [local, domain] = email.split(\"@\");\n\tif (!domain) return \"***@***\";\n\tconst maskedLocal = local.length > 2 ? `${local[0]}***${local[local.length - 1]}` : \"***\";\n\treturn `${maskedLocal}@${domain}`;\n}\n\n/**\n * Redact PII from a string\n */\nfunction redactString(value: string): string {\n\tlet result = value;\n\n\t// Redact phone numbers\n\tresult = result.replace(/\\+?1?\\d{10,15}/g, (match) => maskPhoneNumber(match));\n\n\t// Redact email addresses\n\tresult = result.replace(\n\t\t/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g,\n\t\t(match) => maskEmail(match)\n\t);\n\n\treturn result;\n}\n\n/**\n * Recursively redact PII from an object\n */\nfunction redactPII(obj: unknown, depth = 0): unknown {\n\t// Prevent infinite recursion\n\tif (depth > 10) return \"[MAX_DEPTH]\";\n\n\tif (obj === null || obj === undefined) {\n\t\treturn obj;\n\t}\n\n\tif (typeof obj === \"string\") {\n\t\treturn redactString(obj);\n\t}\n\n\tif (typeof obj === \"number\" || typeof obj === \"boolean\") {\n\t\treturn obj;\n\t}\n\n\tif (Array.isArray(obj)) {\n\t\treturn obj.map((item) => redactPII(item, depth + 1));\n\t}\n\n\tif (typeof obj === \"object\") {\n\t\tconst result: Record<string, unknown> = {};\n\n\t\tfor (const [key, value] of Object.entries(obj)) {\n\t\t\t// Check if this is a sensitive field\n\t\t\tconst isSensitive = SENSITIVE_FIELDS.some(\n\t\t\t\t(field) => key.toLowerCase().includes(field.toLowerCase())\n\t\t\t);\n\n\t\t\tif (isSensitive) {\n\t\t\t\tif (typeof value === \"string\") {\n\t\t\t\t\t// Mask the value\n\t\t\t\t\tif (value.includes(\"@\")) {\n\t\t\t\t\t\tresult[key] = maskEmail(value);\n\t\t\t\t\t} else if (/\\d/.test(value)) {\n\t\t\t\t\t\tresult[key] = maskPhoneNumber(value);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult[key] = \"[REDACTED]\";\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tresult[key] = \"[REDACTED]\";\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tresult[key] = redactPII(value, depth + 1);\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\treturn obj;\n}\n\n// =============================================================================\n// LOGGER CLASS\n// =============================================================================\n\nclass TelnyxLogger {\n\tprivate service = \"telnyx\";\n\tprivate defaultContext: LogContext = {};\n\n\t/**\n\t * Set default context for all log entries\n\t */\n\tsetDefaultContext(context: LogContext): void {\n\t\tthis.defaultContext = { ...this.defaultContext, ...context };\n\t}\n\n\t/**\n\t * Clear default context\n\t */\n\tclearDefaultContext(): void {\n\t\tthis.defaultContext = {};\n\t}\n\n\t/**\n\t * Check if a log level should be output\n\t */\n\tprivate shouldLog(level: LogLevel): boolean {\n\t\treturn LOG_LEVELS[level] >= LOG_LEVELS[currentLogLevel];\n\t}\n\n\t/**\n\t * Format and output a log entry\n\t */\n\tprivate log(level: LogLevel, message: string, context?: LogContext): void {\n\t\tif (!this.shouldLog(level)) return;\n\n\t\tconst entry: LogEntry = {\n\t\t\ttimestamp: new Date().toISOString(),\n\t\t\tlevel,\n\t\t\tservice: this.service,\n\t\t\tmessage,\n\t\t};\n\n\t\t// Merge default context with provided context\n\t\tconst fullContext = { ...this.defaultContext, ...context };\n\n\t\tif (Object.keys(fullContext).length > 0) {\n\t\t\t// Redact PII from context\n\t\t\tentry.context = redactPII(fullContext) as LogContext;\n\t\t}\n\n\t\t// Output as JSON in production, pretty print in development\n\t\tif (process.env.NODE_ENV === \"production\") {\n\t\t\tconst output = JSON.stringify(entry);\n\n\t\t\tswitch (level) {\n\t\t\t\tcase \"error\":\n\t\t\t\t\tconsole.error(output);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"warn\":\n\t\t\t\t\tconsole.warn(output);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tconsole.log(output);\n\t\t\t}\n\t\t} else {\n\t\t\t// Development: more readable format\n\t\t\tconst contextStr = entry.context\n\t\t\t\t? ` ${JSON.stringify(entry.context, null, 2)}`\n\t\t\t\t: \"\";\n\n\t\t\tconst prefix = `[${entry.timestamp}] [${level.toUpperCase()}] [${this.service}]`;\n\n\t\t\tswitch (level) {\n\t\t\t\tcase \"error\":\n\t\t\t\t\tconsole.error(`${prefix} ${message}${contextStr}`);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"warn\":\n\t\t\t\t\tconsole.warn(`${prefix} ${message}${contextStr}`);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"debug\":\n\t\t\t\t\tconsole.debug(`${prefix} ${message}${contextStr}`);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tconsole.log(`${prefix} ${message}${contextStr}`);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Log at debug level\n\t */\n\tdebug(message: string, context?: LogContext): void {\n\t\tthis.log(\"debug\", message, context);\n\t}\n\n\t/**\n\t * Log at info level\n\t */\n\tinfo(message: string, context?: LogContext): void {\n\t\tthis.log(\"info\", message, context);\n\t}\n\n\t/**\n\t * Log at warn level\n\t */\n\twarn(message: string, context?: LogContext): void {\n\t\tthis.log(\"warn\", message, context);\n\t}\n\n\t/**\n\t * Log at error level\n\t */\n\terror(message: string, context?: LogContext): void {\n\t\tthis.log(\"error\", message, context);\n\t}\n\n\t/**\n\t * Create a child logger with additional default context\n\t */\n\tchild(context: LogContext): TelnyxChildLogger {\n\t\treturn new TelnyxChildLogger(this, context);\n\t}\n\n\t/**\n\t * Log a request start\n\t */\n\tlogRequestStart(\n\t\tmethod: string,\n\t\tendpoint: string,\n\t\tcontext?: LogContext\n\t): { correlationId: string; startTime: number } {\n\t\tconst correlationId =\n\t\t\tcontext?.correlationId ||\n\t\t\t`tlx_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\n\t\tconst startTime = Date.now();\n\n\t\tthis.debug(`${method} ${endpoint} started`, {\n\t\t\t...context,\n\t\t\tcorrelationId,\n\t\t\tendpoint,\n\t\t});\n\n\t\treturn { correlationId, startTime };\n\t}\n\n\t/**\n\t * Log a request completion\n\t */\n\tlogRequestEnd(\n\t\tmethod: string,\n\t\tendpoint: string,\n\t\tstatusCode: number,\n\t\tstartTime: number,\n\t\tcontext?: LogContext\n\t): void {\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tconst logFn = statusCode >= 400 ? this.warn.bind(this) : this.info.bind(this);\n\n\t\tlogFn(`${method} ${endpoint} completed`, {\n\t\t\t...context,\n\t\t\tendpoint,\n\t\t\tstatusCode,\n\t\t\tlatencyMs,\n\t\t});\n\t}\n\n\t/**\n\t * Log a request error\n\t */\n\tlogRequestError(\n\t\tmethod: string,\n\t\tendpoint: string,\n\t\terror: Error,\n\t\tstartTime: number,\n\t\tcontext?: LogContext\n\t): void {\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tthis.error(`${method} ${endpoint} failed`, {\n\t\t\t...context,\n\t\t\tendpoint,\n\t\t\terror: error.message,\n\t\t\tlatencyMs,\n\t\t});\n\t}\n}\n\n/**\n * Child logger with inherited context\n */\nclass TelnyxChildLogger {\n\tconstructor(\n\t\tprivate parent: TelnyxLogger,\n\t\tprivate context: LogContext\n\t) {}\n\n\tdebug(message: string, context?: LogContext): void {\n\t\tthis.parent.debug(message, { ...this.context, ...context });\n\t}\n\n\tinfo(message: string, context?: LogContext): void {\n\t\tthis.parent.info(message, { ...this.context, ...context });\n\t}\n\n\twarn(message: string, context?: LogContext): void {\n\t\tthis.parent.warn(message, { ...this.context, ...context });\n\t}\n\n\terror(message: string, context?: LogContext): void {\n\t\tthis.parent.error(message, { ...this.context, ...context });\n\t}\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\n/**\n * Singleton logger instance\n */\nexport const telnyxLogger = new TelnyxLogger();\n\n/**\n * Create a request-scoped logger\n */\nexport function createRequestLogger(correlationId: string): TelnyxChildLogger {\n\treturn telnyxLogger.child({ correlationId });\n}\n\n/**\n * Utility to redact PII from any object (exported for testing)\n */\nexport { redactPII };\n","/**\n * Telnyx Retry Logic\n *\n * Implements exponential backoff with jitter and circuit breaker pattern\n * for resilient API calls to Telnyx.\n */\n\nimport { telnyxLogger } from \"./logger\";\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nexport interface RetryConfig {\n\tmaxRetries: number;\n\tbaseDelayMs: number;\n\tmaxDelayMs: number;\n\tjitterFactor: number; // 0-1, adds randomness to delay\n\tretryableStatusCodes: number[];\n\tretryableErrorCodes: string[];\n}\n\nexport const DEFAULT_RETRY_CONFIG: RetryConfig = {\n\tmaxRetries: 5,\n\tbaseDelayMs: 1000, // 1 second\n\tmaxDelayMs: 32000, // 32 seconds max\n\tjitterFactor: 0.3, // 30% jitter\n\tretryableStatusCodes: [408, 429, 500, 502, 503, 504],\n\tretryableErrorCodes: [\n\t\t\"ECONNRESET\",\n\t\t\"ETIMEDOUT\",\n\t\t\"ECONNREFUSED\",\n\t\t\"EPIPE\",\n\t\t\"ENOTFOUND\",\n\t\t\"ENETUNREACH\",\n\t\t\"EAI_AGAIN\",\n\t],\n};\n\n// =============================================================================\n// CIRCUIT BREAKER\n// =============================================================================\n\nexport interface CircuitBreakerConfig {\n\tfailureThreshold: number; // Failures before opening circuit\n\tresetTimeoutMs: number; // Time before trying again\n\thalfOpenRequests: number; // Requests to allow in half-open state\n}\n\nexport const DEFAULT_CIRCUIT_BREAKER_CONFIG: CircuitBreakerConfig = {\n\tfailureThreshold: 5,\n\tresetTimeoutMs: 60000, // 1 minute\n\thalfOpenRequests: 3,\n};\n\ntype CircuitState = \"closed\" | \"open\" | \"half-open\";\n\ninterface CircuitBreakerState {\n\tstate: CircuitState;\n\tfailures: number;\n\tlastFailureTime: number;\n\thalfOpenSuccesses: number;\n\thalfOpenFailures: number;\n}\n\n// Per-endpoint circuit breakers\nconst circuitBreakers = new Map<string, CircuitBreakerState>();\n\nfunction getCircuitBreaker(endpoint: string): CircuitBreakerState {\n\tif (!circuitBreakers.has(endpoint)) {\n\t\tcircuitBreakers.set(endpoint, {\n\t\t\tstate: \"closed\",\n\t\t\tfailures: 0,\n\t\t\tlastFailureTime: 0,\n\t\t\thalfOpenSuccesses: 0,\n\t\t\thalfOpenFailures: 0,\n\t\t});\n\t}\n\treturn circuitBreakers.get(endpoint)!;\n}\n\nfunction updateCircuitState(\n\tendpoint: string,\n\tsuccess: boolean,\n\tconfig: CircuitBreakerConfig = DEFAULT_CIRCUIT_BREAKER_CONFIG\n): void {\n\tconst breaker = getCircuitBreaker(endpoint);\n\tconst now = Date.now();\n\n\tif (success) {\n\t\tif (breaker.state === \"half-open\") {\n\t\t\tbreaker.halfOpenSuccesses++;\n\t\t\tif (breaker.halfOpenSuccesses >= config.halfOpenRequests) {\n\t\t\t\t// Enough successes, close the circuit\n\t\t\t\tbreaker.state = \"closed\";\n\t\t\t\tbreaker.failures = 0;\n\t\t\t\tbreaker.halfOpenSuccesses = 0;\n\t\t\t\tbreaker.halfOpenFailures = 0;\n\t\t\t\ttelnyxLogger.info(\"Circuit breaker closed\", { endpoint });\n\t\t\t}\n\t\t} else if (breaker.state === \"closed\") {\n\t\t\t// Reset failure count on success\n\t\t\tbreaker.failures = 0;\n\t\t}\n\t} else {\n\t\tbreaker.lastFailureTime = now;\n\n\t\tif (breaker.state === \"half-open\") {\n\t\t\tbreaker.halfOpenFailures++;\n\t\t\t// Any failure in half-open reopens the circuit\n\t\t\tbreaker.state = \"open\";\n\t\t\tbreaker.halfOpenSuccesses = 0;\n\t\t\tbreaker.halfOpenFailures = 0;\n\t\t\ttelnyxLogger.warn(\"Circuit breaker reopened\", { endpoint });\n\t\t} else if (breaker.state === \"closed\") {\n\t\t\tbreaker.failures++;\n\t\t\tif (breaker.failures >= config.failureThreshold) {\n\t\t\t\tbreaker.state = \"open\";\n\t\t\t\ttelnyxLogger.error(\"Circuit breaker opened\", {\n\t\t\t\t\tendpoint,\n\t\t\t\t\tfailures: breaker.failures,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction canAttempt(\n\tendpoint: string,\n\tconfig: CircuitBreakerConfig = DEFAULT_CIRCUIT_BREAKER_CONFIG\n): boolean {\n\tconst breaker = getCircuitBreaker(endpoint);\n\tconst now = Date.now();\n\n\tif (breaker.state === \"closed\") {\n\t\treturn true;\n\t}\n\n\tif (breaker.state === \"open\") {\n\t\t// Check if reset timeout has passed\n\t\tif (now - breaker.lastFailureTime >= config.resetTimeoutMs) {\n\t\t\tbreaker.state = \"half-open\";\n\t\t\tbreaker.halfOpenSuccesses = 0;\n\t\t\tbreaker.halfOpenFailures = 0;\n\t\t\ttelnyxLogger.info(\"Circuit breaker half-open\", { endpoint });\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\t// Half-open: allow limited requests\n\treturn true;\n}\n\n// =============================================================================\n// RETRY LOGIC\n// =============================================================================\n\nexport interface RetryError extends Error {\n\tstatusCode?: number;\n\terrorCode?: string;\n\tretryable: boolean;\n\tattempts: number;\n\tlastError?: Error;\n}\n\nexport function createRetryError(\n\tmessage: string,\n\toptions: {\n\t\tstatusCode?: number;\n\t\terrorCode?: string;\n\t\tretryable: boolean;\n\t\tattempts: number;\n\t\tlastError?: Error;\n\t}\n): RetryError {\n\tconst error = new Error(message) as RetryError;\n\terror.name = \"RetryError\";\n\terror.statusCode = options.statusCode;\n\terror.errorCode = options.errorCode;\n\terror.retryable = options.retryable;\n\terror.attempts = options.attempts;\n\terror.lastError = options.lastError;\n\treturn error;\n}\n\n/**\n * Check if an error is retryable\n */\nexport function isRetryable(\n\terror: unknown,\n\tconfig: RetryConfig = DEFAULT_RETRY_CONFIG\n): boolean {\n\tif (!error) return false;\n\n\t// Check for network errors\n\tif (error instanceof Error) {\n\t\tconst errorCode = (error as NodeJS.ErrnoException).code;\n\t\tif (errorCode && config.retryableErrorCodes.includes(errorCode)) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// Check for fetch/network errors\n\t\tif (\n\t\t\terror.message.includes(\"fetch failed\") ||\n\t\t\terror.message.includes(\"network\") ||\n\t\t\terror.message.includes(\"timeout\") ||\n\t\t\terror.message.includes(\"ECONNRESET\")\n\t\t) {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\t// Check for HTTP status codes\n\tif (typeof error === \"object\" && error !== null) {\n\t\tconst statusCode = (error as { statusCode?: number; status?: number })\n\t\t\t.statusCode ||\n\t\t\t(error as { statusCode?: number; status?: number }).status;\n\t\tif (statusCode && config.retryableStatusCodes.includes(statusCode)) {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\treturn false;\n}\n\n/**\n * Calculate delay with exponential backoff and jitter\n */\nexport function calculateDelay(\n\tattempt: number,\n\tconfig: RetryConfig = DEFAULT_RETRY_CONFIG\n): number {\n\t// Exponential backoff: baseDelay * 2^attempt\n\tconst exponentialDelay = config.baseDelayMs * Math.pow(2, attempt);\n\n\t// Cap at max delay\n\tconst cappedDelay = Math.min(exponentialDelay, config.maxDelayMs);\n\n\t// Add jitter (randomness to spread out retries)\n\tconst jitter = cappedDelay * config.jitterFactor * Math.random();\n\n\treturn Math.floor(cappedDelay + jitter);\n}\n\n/**\n * Sleep for specified milliseconds\n */\nexport function sleep(ms: number): Promise<void> {\n\treturn new Promise((resolve) => setTimeout(resolve, ms));\n}\n\n/**\n * Extract Retry-After header value in milliseconds\n */\nexport function parseRetryAfter(response: Response): number | null {\n\tconst retryAfter = response.headers.get(\"Retry-After\");\n\tif (!retryAfter) return null;\n\n\t// Check if it's a number (seconds)\n\tconst seconds = parseInt(retryAfter, 10);\n\tif (!isNaN(seconds)) {\n\t\treturn seconds * 1000;\n\t}\n\n\t// Check if it's a date\n\tconst date = Date.parse(retryAfter);\n\tif (!isNaN(date)) {\n\t\treturn Math.max(0, date - Date.now());\n\t}\n\n\treturn null;\n}\n\n// =============================================================================\n// RETRY WRAPPER\n// =============================================================================\n\nexport interface RetryOptions {\n\tendpoint?: string; // For circuit breaker tracking\n\tconfig?: Partial<RetryConfig>;\n\tcircuitBreakerConfig?: Partial<CircuitBreakerConfig>;\n\tonRetry?: (attempt: number, error: Error, delayMs: number) => void;\n\tcorrelationId?: string;\n}\n\n/**\n * Execute a function with retry logic and circuit breaker\n */\nexport async function withRetry<T>(\n\tfn: () => Promise<T>,\n\toptions: RetryOptions = {}\n): Promise<T> {\n\tconst config = { ...DEFAULT_RETRY_CONFIG, ...options.config };\n\tconst circuitConfig = {\n\t\t...DEFAULT_CIRCUIT_BREAKER_CONFIG,\n\t\t...options.circuitBreakerConfig,\n\t};\n\tconst endpoint = options.endpoint || \"default\";\n\tconst correlationId = options.correlationId || generateCorrelationId();\n\n\t// Check circuit breaker\n\tif (!canAttempt(endpoint, circuitConfig)) {\n\t\tconst error = createRetryError(\n\t\t\t`Circuit breaker open for endpoint: ${endpoint}`,\n\t\t\t{\n\t\t\t\tretryable: false,\n\t\t\t\tattempts: 0,\n\t\t\t}\n\t\t);\n\t\ttelnyxLogger.warn(\"Request blocked by circuit breaker\", {\n\t\t\tendpoint,\n\t\t\tcorrelationId,\n\t\t});\n\t\tthrow error;\n\t}\n\n\tlet lastError: Error | undefined;\n\tlet attempt = 0;\n\n\twhile (attempt <= config.maxRetries) {\n\t\ttry {\n\t\t\tconst result = await fn();\n\n\t\t\t// Success - update circuit breaker\n\t\t\tupdateCircuitState(endpoint, true, circuitConfig);\n\n\t\t\tif (attempt > 0) {\n\t\t\t\ttelnyxLogger.info(\"Request succeeded after retry\", {\n\t\t\t\t\tendpoint,\n\t\t\t\t\tattempt,\n\t\t\t\t\tcorrelationId,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn result;\n\t\t} catch (error) {\n\t\t\tlastError = error instanceof Error ? error : new Error(String(error));\n\n\t\t\tconst retryable = isRetryable(error, config);\n\n\t\t\ttelnyxLogger.warn(\"Request failed\", {\n\t\t\t\tendpoint,\n\t\t\t\tattempt,\n\t\t\t\tretryable,\n\t\t\t\terror: lastError.message,\n\t\t\t\tcorrelationId,\n\t\t\t});\n\n\t\t\t// Update circuit breaker on failure\n\t\t\tupdateCircuitState(endpoint, false, circuitConfig);\n\n\t\t\t// Don't retry if not retryable or max retries reached\n\t\t\tif (!retryable || attempt >= config.maxRetries) {\n\t\t\t\tthrow createRetryError(\n\t\t\t\t\t`Request failed after ${attempt + 1} attempt(s): ${lastError.message}`,\n\t\t\t\t\t{\n\t\t\t\t\t\tretryable,\n\t\t\t\t\t\tattempts: attempt + 1,\n\t\t\t\t\t\tlastError,\n\t\t\t\t\t\tstatusCode: (error as { statusCode?: number }).statusCode,\n\t\t\t\t\t\terrorCode: (error as { code?: string }).code,\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Calculate delay\n\t\t\tlet delayMs = calculateDelay(attempt, config);\n\n\t\t\t// Check for Retry-After header (if error has response)\n\t\t\tif (\n\t\t\t\ttypeof error === \"object\" &&\n\t\t\t\terror !== null &&\n\t\t\t\t\"response\" in error\n\t\t\t) {\n\t\t\t\tconst response = (error as { response?: Response }).response;\n\t\t\t\tif (response) {\n\t\t\t\t\tconst retryAfter = parseRetryAfter(response);\n\t\t\t\t\tif (retryAfter) {\n\t\t\t\t\t\tdelayMs = Math.min(retryAfter, config.maxDelayMs);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Call onRetry callback\n\t\t\tif (options.onRetry) {\n\t\t\t\toptions.onRetry(attempt, lastError, delayMs);\n\t\t\t}\n\n\t\t\ttelnyxLogger.info(\"Retrying request\", {\n\t\t\t\tendpoint,\n\t\t\t\tattempt: attempt + 1,\n\t\t\t\tdelayMs,\n\t\t\t\tcorrelationId,\n\t\t\t});\n\n\t\t\tawait sleep(delayMs);\n\t\t\tattempt++;\n\t\t}\n\t}\n\n\t// Should never reach here, but just in case\n\tthrow createRetryError(\n\t\t`Request failed after ${config.maxRetries + 1} attempts`,\n\t\t{\n\t\t\tretryable: false,\n\t\t\tattempts: config.maxRetries + 1,\n\t\t\tlastError,\n\t\t}\n\t);\n}\n\n// =============================================================================\n// BULK RETRY (for rate-limited batch operations)\n// =============================================================================\n\nexport interface BulkRetryOptions<T, R> {\n\titems: T[];\n\toperation: (item: T) => Promise<R>;\n\tconcurrency?: number;\n\tretryOptions?: RetryOptions;\n\tonProgress?: (completed: number, total: number, failed: number) => void;\n}\n\nexport interface BulkRetryResult<T, R> {\n\tsuccessful: Array<{ item: T; result: R }>;\n\tfailed: Array<{ item: T; error: Error }>;\n}\n\n/**\n * Process items in bulk with retry logic and concurrency control\n */\nexport async function withBulkRetry<T, R>(\n\toptions: BulkRetryOptions<T, R>\n): Promise<BulkRetryResult<T, R>> {\n\tconst { items, operation, concurrency = 10, retryOptions, onProgress } = options;\n\n\tconst successful: Array<{ item: T; result: R }> = [];\n\tconst failed: Array<{ item: T; error: Error }> = [];\n\tlet completed = 0;\n\n\t// Process in batches\n\tfor (let i = 0; i < items.length; i += concurrency) {\n\t\tconst batch = items.slice(i, i + concurrency);\n\n\t\tconst results = await Promise.allSettled(\n\t\t\tbatch.map(async (item) => {\n\t\t\t\tconst result = await withRetry(\n\t\t\t\t\t() => operation(item),\n\t\t\t\t\tretryOptions\n\t\t\t\t);\n\t\t\t\treturn { item, result };\n\t\t\t})\n\t\t);\n\n\t\tfor (const result of results) {\n\t\t\tcompleted++;\n\n\t\t\tif (result.status === \"fulfilled\") {\n\t\t\t\tsuccessful.push(result.value);\n\t\t\t} else {\n\t\t\t\tconst item = batch[results.indexOf(result)];\n\t\t\t\tfailed.push({\n\t\t\t\t\titem,\n\t\t\t\t\terror:\n\t\t\t\t\t\tresult.reason instanceof Error\n\t\t\t\t\t\t\t? result.reason\n\t\t\t\t\t\t\t: new Error(String(result.reason)),\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif (onProgress) {\n\t\t\tonProgress(completed, items.length, failed.length);\n\t\t}\n\n\t\t// Small delay between batches to avoid rate limiting\n\t\tif (i + concurrency < items.length) {\n\t\t\tawait sleep(100);\n\t\t}\n\t}\n\n\treturn { successful, failed };\n}\n\n// =============================================================================\n// UTILITIES\n// =============================================================================\n\n/**\n * Generate a correlation ID for request tracking\n */\nexport function generateCorrelationId(): string {\n\treturn `tlx_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\n}\n\n/**\n * Get circuit breaker status for monitoring\n */\nexport function getCircuitBreakerStatus(endpoint?: string): {\n\tendpoints: Record<string, CircuitBreakerState>;\n\tsummary: {\n\t\ttotal: number;\n\t\topen: number;\n\t\thalfOpen: number;\n\t\tclosed: number;\n\t};\n} {\n\tconst endpoints: Record<string, CircuitBreakerState> = {};\n\n\tif (endpoint) {\n\t\tconst breaker = circuitBreakers.get(endpoint);\n\t\tif (breaker) {\n\t\t\tendpoints[endpoint] = breaker;\n\t\t}\n\t} else {\n\t\tcircuitBreakers.forEach((state, ep) => {\n\t\t\tendpoints[ep] = state;\n\t\t});\n\t}\n\n\tconst states = Object.values(endpoints);\n\treturn {\n\t\tendpoints,\n\t\tsummary: {\n\t\t\ttotal: states.length,\n\t\t\topen: states.filter((s) => s.state === \"open\").length,\n\t\t\thalfOpen: states.filter((s) => s.state === \"half-open\").length,\n\t\t\tclosed: states.filter((s) => s.state === \"closed\").length,\n\t\t},\n\t};\n}\n\n/**\n * Reset circuit breaker for an endpoint (for testing/manual reset)\n */\nexport function resetCircuitBreaker(endpoint: string): void {\n\tcircuitBreakers.delete(endpoint);\n\ttelnyxLogger.info(\"Circuit breaker reset\", { endpoint });\n}\n\n/**\n * Reset all circuit breakers\n */\nexport function resetAllCircuitBreakers(): void {\n\tcircuitBreakers.clear();\n\ttelnyxLogger.info(\"All circuit breakers reset\");\n}\n","/**\n * Telnyx Messaging Service - SMS & MMS\n *\n * Production-ready messaging with:\n * - 10DLC compliance verification (required for US A2P SMS as of Dec 2024)\n * - Per-company rate limiting\n * - Retry logic with exponential backoff\n * - Multi-tenant support\n * - Structured logging\n */\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\nimport { telnyxLogger } from \"./logger\";\nimport { withRetry } from \"./retry\";\n\nconst TELNYX_API_BASE = \"https://api.telnyx.com/v2\";\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nconst MESSAGING_CONFIG = {\n\t// Default rate limits per company (messages per minute)\n\tdefaultRateLimitPerMinute: 60,\n\t// Max concurrent sends for bulk operations\n\tmaxConcurrentSends: 5,\n\t// Warn if 10DLC not configured\n\twarnOn10DLCMissing: true,\n\t// Request timeout in milliseconds\n\trequestTimeoutMs: 30000,\n};\n\n// =============================================================================\n// API CLIENT\n// =============================================================================\n\nfunction assertTelnyxApiKey(): string {\n\tconst apiKey = process.env.TELNYX_API_KEY;\n\tif (!apiKey) {\n\t\tthrow new Error(\"TELNYX_API_KEY is not configured\");\n\t}\n\treturn apiKey;\n}\n\nasync function telnyxRequest<T = unknown>(\n\tpath: string,\n\tinit?: RequestInit & {\n\t\tquery?: Record<string, string | number | undefined>;\n\t\ttimeout?: number;\n\t}\n): Promise<T> {\n\tconst apiKey = assertTelnyxApiKey();\n\tconst url = new URL(`${TELNYX_API_BASE}${path}`);\n\n\tif (init?.query) {\n\t\tfor (const [key, value] of Object.entries(init.query)) {\n\t\t\tif (value !== undefined && value !== null) {\n\t\t\t\turl.searchParams.set(key, String(value));\n\t\t\t}\n\t\t}\n\t}\n\n\ttelnyxLogger.debug(\"Telnyx API request\", {\n\t\tmethod: init?.method || \"GET\",\n\t\tpath,\n\t});\n\n\t// Create abort controller for timeout\n\tconst controller = new AbortController();\n\tconst timeout = init?.timeout ?? MESSAGING_CONFIG.requestTimeoutMs;\n\tconst timeoutId = setTimeout(() => controller.abort(), timeout);\n\n\ttry {\n\t\tconst response = await fetch(url, {\n\t\t\t...init,\n\t\t\theaders: {\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t\t...(init?.headers || {}),\n\t\t\t},\n\t\t\tsignal: controller.signal,\n\t\t});\n\n\t\tclearTimeout(timeoutId);\n\n\t\tconst data = await response.json();\n\n\t\tif (!response.ok) {\n\t\t\tconst detail = data?.errors?.[0]?.detail || response.statusText;\n\t\t\tconst errorCode = data?.errors?.[0]?.code;\n\t\t\ttelnyxLogger.error(\"Telnyx API error\", {\n\t\t\t\tstatus: response.status,\n\t\t\t\tdetail,\n\t\t\t\terrorCode,\n\t\t\t\tpath,\n\t\t\t});\n\t\t\tthrow new Error(`Telnyx ${response.status}: ${detail}`);\n\t\t}\n\n\t\treturn data as T;\n\t} catch (error) {\n\t\tclearTimeout(timeoutId);\n\n\t\tif (error instanceof Error && error.name === \"AbortError\") {\n\t\t\ttelnyxLogger.error(\"Telnyx API timeout\", {\n\t\t\t\tpath,\n\t\t\t\ttimeoutMs: timeout,\n\t\t\t});\n\t\t\tthrow new Error(`Request timeout after ${timeout}ms`);\n\t\t}\n\n\t\tthrow error;\n\t}\n}\n\nasync function telnyxMessageRequest(body: Record<string, unknown>) {\n\treturn telnyxRequest<{ data: TelnyxMessage }>(\"/messages\", {\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify(body),\n\t});\n}\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport type MessageType = \"SMS\" | \"MMS\";\n\nexport type MessageStatus =\n\t| \"queued\"\n\t| \"sending\"\n\t| \"sent\"\n\t| \"delivered\"\n\t| \"sending_failed\"\n\t| \"delivery_failed\"\n\t| \"delivery_unconfirmed\";\n\ninterface TelnyxMessage {\n\tid: string;\n\tstatus: MessageStatus;\n\ttype: MessageType;\n\tfrom: { phone_number: string };\n\tto: Array<{ phone_number: string; status: string }>;\n\ttext?: string;\n\tmedia?: Array<{ url: string; content_type: string }>;\n\tcreated_at: string;\n}\n\ninterface SendSMSParams {\n\tcompanyId: string;\n\tto: string;\n\tfrom: string;\n\ttext: string;\n\twebhookUrl?: string;\n\twebhookFailoverUrl?: string;\n\tuseProfileWebhooks?: boolean;\n\tmessagingProfileId?: string;\n\tskipRateLimit?: boolean;\n\tskip10DLCCheck?: boolean;\n}\n\ninterface SendSMSResult {\n\tsuccess: boolean;\n\tmessageId?: string;\n\tdata?: TelnyxMessage;\n\terror?: string;\n\twarnings?: string[];\n}\n\n// =============================================================================\n// 10DLC COMPLIANCE CHECK\n// =============================================================================\n\ninterface TenDLCStatus {\n\tisConfigured: boolean;\n\tbrandId?: string;\n\tcampaignId?: string;\n\tmessagingProfileId?: string;\n\twarnings: string[];\n}\n\n/**\n * Check 10DLC compliance status for a company\n *\n * As of December 2024, ALL US A2P SMS traffic MUST be registered with 10DLC.\n * Messages sent without proper registration may be filtered or blocked by carriers.\n */\nexport async function check10DLCStatus(companyId: string): Promise<TenDLCStatus> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tif (!supabase) {\n\t\t\treturn {\n\t\t\t\tisConfigured: false,\n\t\t\t\twarnings: [\"Database not available - cannot verify 10DLC status\"],\n\t\t\t};\n\t\t}\n\n\t\tconst { data: settings, error } = await supabase\n\t\t\t.from(\"company_telnyx_settings\")\n\t\t\t.select(\"ten_dlc_brand_id, ten_dlc_campaign_id, messaging_profile_id, status\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.maybeSingle();\n\n\t\tif (error) {\n\t\t\ttelnyxLogger.error(\"Failed to check 10DLC status\", {\n\t\t\t\tcompanyId,\n\t\t\t\terror: error.message,\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tisConfigured: false,\n\t\t\t\twarnings: [\"Failed to verify 10DLC status\"],\n\t\t\t};\n\t\t}\n\n\t\tif (!settings) {\n\t\t\treturn {\n\t\t\t\tisConfigured: false,\n\t\t\t\twarnings: [\"No Telnyx settings configured for company\"],\n\t\t\t};\n\t\t}\n\n\t\tconst warnings: string[] = [];\n\n\t\tif (!settings.ten_dlc_brand_id) {\n\t\t\twarnings.push(\"10DLC brand not registered - US SMS may be filtered\");\n\t\t}\n\n\t\tif (!settings.ten_dlc_campaign_id) {\n\t\t\twarnings.push(\"10DLC campaign not registered - US SMS may be filtered\");\n\t\t}\n\n\t\tif (!settings.messaging_profile_id) {\n\t\t\twarnings.push(\"Messaging profile not configured\");\n\t\t}\n\n\t\tconst isConfigured =\n\t\t\t!!settings.ten_dlc_brand_id &&\n\t\t\t!!settings.ten_dlc_campaign_id &&\n\t\t\t!!settings.messaging_profile_id;\n\n\t\treturn {\n\t\t\tisConfigured,\n\t\t\tbrandId: settings.ten_dlc_brand_id || undefined,\n\t\t\tcampaignId: settings.ten_dlc_campaign_id || undefined,\n\t\t\tmessagingProfileId: settings.messaging_profile_id || undefined,\n\t\t\twarnings,\n\t\t};\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"10DLC check error\", {\n\t\t\tcompanyId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\t\treturn {\n\t\t\tisConfigured: false,\n\t\t\twarnings: [\"Error checking 10DLC status\"],\n\t\t};\n\t}\n}\n\n// =============================================================================\n// RATE LIMITING\n// =============================================================================\n\n/**\n * Check and increment SMS rate limit for a company\n *\n * @returns true if under limit, false if rate limited\n */\nexport async function checkSMSRateLimit(\n\tcompanyId: string,\n\tidentifier = \"default\"\n): Promise<{ allowed: boolean; currentCount: number; limit: number }> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tif (!supabase) {\n\t\t\t// Allow in development without database\n\t\t\treturn {\n\t\t\t\tallowed: true,\n\t\t\t\tcurrentCount: 0,\n\t\t\t\tlimit: MESSAGING_CONFIG.defaultRateLimitPerMinute,\n\t\t\t};\n\t\t}\n\n\t\t// Use the database function for atomic increment\n\t\tconst { data, error } = await supabase.rpc(\"increment_rate_limit\", {\n\t\t\tp_company_id: companyId,\n\t\t\tp_resource: \"sms\",\n\t\t\tp_identifier: identifier,\n\t\t\tp_window_size_seconds: 60,\n\t\t});\n\n\t\tif (error) {\n\t\t\ttelnyxLogger.error(\"Rate limit check failed\", {\n\t\t\t\tcompanyId,\n\t\t\t\terror: error.message,\n\t\t\t});\n\t\t\t// Fail open on database errors\n\t\t\treturn {\n\t\t\t\tallowed: true,\n\t\t\t\tcurrentCount: 0,\n\t\t\t\tlimit: MESSAGING_CONFIG.defaultRateLimitPerMinute,\n\t\t\t};\n\t\t}\n\n\t\tconst result = data?.[0] || { current_count: 1 };\n\t\tconst currentCount = result.current_count as number;\n\t\tconst limit = MESSAGING_CONFIG.defaultRateLimitPerMinute;\n\t\tconst allowed = currentCount <= limit;\n\n\t\tif (!allowed) {\n\t\t\ttelnyxLogger.warn(\"SMS rate limit exceeded\", {\n\t\t\t\tcompanyId,\n\t\t\t\tcurrentCount,\n\t\t\t\tlimit,\n\t\t\t});\n\t\t}\n\n\t\treturn { allowed, currentCount, limit };\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"Rate limit error\", {\n\t\t\tcompanyId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\t\t// Fail open\n\t\treturn {\n\t\t\tallowed: true,\n\t\t\tcurrentCount: 0,\n\t\t\tlimit: MESSAGING_CONFIG.defaultRateLimitPerMinute,\n\t\t};\n\t}\n}\n\n// =============================================================================\n// SMS SENDING\n// =============================================================================\n\n/**\n * Send an SMS message with production-ready features\n *\n * Includes:\n * - 10DLC compliance verification\n * - Rate limiting per company\n * - Retry logic with exponential backoff\n * - Structured logging\n */\nexport async function sendSMS(params: SendSMSParams): Promise<SendSMSResult> {\n\tconst warnings: string[] = [];\n\n\ttry {\n\t\ttelnyxLogger.info(\"Sending SMS\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\tto: params.to.substring(0, 6) + \"****\", // Redact for logs\n\t\t\ttextLength: params.text.length,\n\t\t});\n\n\t\t// 1. Check 10DLC compliance (unless skipped)\n\t\tif (!params.skip10DLCCheck && MESSAGING_CONFIG.warnOn10DLCMissing) {\n\t\t\tconst tenDLCStatus = await check10DLCStatus(params.companyId);\n\n\t\t\tif (!tenDLCStatus.isConfigured) {\n\t\t\t\twarnings.push(...tenDLCStatus.warnings);\n\t\t\t\ttelnyxLogger.warn(\"SMS sent without 10DLC registration\", {\n\t\t\t\t\tcompanyId: params.companyId,\n\t\t\t\t\twarnings: tenDLCStatus.warnings,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Use company's messaging profile if not provided\n\t\t\tif (!params.messagingProfileId && tenDLCStatus.messagingProfileId) {\n\t\t\t\tparams.messagingProfileId = tenDLCStatus.messagingProfileId;\n\t\t\t}\n\t\t}\n\n\t\t// 2. Check rate limit (unless skipped)\n\t\tif (!params.skipRateLimit) {\n\t\t\tconst rateLimit = await checkSMSRateLimit(params.companyId);\n\n\t\t\tif (!rateLimit.allowed) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Rate limit exceeded: ${rateLimit.currentCount}/${rateLimit.limit} messages per minute`,\n\t\t\t\t\twarnings,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// 3. Send with retry logic\n\t\tconst result = await withRetry(\n\t\t\tasync () => {\n\t\t\t\tconst requestBody = {\n\t\t\t\t\tto: params.to,\n\t\t\t\t\tfrom: params.from,\n\t\t\t\t\ttext: params.text,\n\t\t\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\t\t\twebhook_url: params.webhookUrl,\n\t\t\t\t\twebhook_failover_url: params.webhookFailoverUrl,\n\t\t\t\t\tuse_profile_webhooks: params.useProfileWebhooks ?? true,\n\t\t\t\t};\n\n\t\t\t\treturn telnyxMessageRequest(requestBody);\n\t\t\t},\n\t\t\t{\n\t\t\t\tendpoint: \"messaging:send_sms\",\n\t\t\t\tconfig: {\n\t\t\t\t\tmaxRetries: 3,\n\t\t\t\t\tbaseDelayMs: 500,\n\t\t\t\t\tmaxDelayMs: 5000,\n\t\t\t\t},\n\t\t\t}\n\t\t);\n\n\t\ttelnyxLogger.info(\"SMS sent successfully\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\tmessageId: result.data.id,\n\t\t\tstatus: result.data.status,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.data.id,\n\t\t\tdata: result.data,\n\t\t\twarnings: warnings.length > 0 ? warnings : undefined,\n\t\t};\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"SMS send failed\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to send SMS\",\n\t\t\twarnings: warnings.length > 0 ? warnings : undefined,\n\t\t};\n\t}\n}\n\n/**\n * Send an MMS message with media attachments\n */\nexport async function sendMMS(params: {\n\tcompanyId: string;\n\tto: string;\n\tfrom: string;\n\ttext?: string;\n\tmediaUrls: string[];\n\twebhookUrl?: string;\n\twebhookFailoverUrl?: string;\n\tsubject?: string;\n\tmessagingProfileId?: string;\n}): Promise<SendSMSResult> {\n\ttry {\n\t\t// Check rate limit\n\t\tconst rateLimit = await checkSMSRateLimit(params.companyId);\n\t\tif (!rateLimit.allowed) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Rate limit exceeded: ${rateLimit.currentCount}/${rateLimit.limit} messages per minute`,\n\t\t\t};\n\t\t}\n\n\t\tconst result = await withRetry(\n\t\t\tasync () => {\n\t\t\t\treturn telnyxMessageRequest({\n\t\t\t\t\tto: params.to,\n\t\t\t\t\tfrom: params.from,\n\t\t\t\t\ttext: params.text,\n\t\t\t\t\tmedia_urls: params.mediaUrls,\n\t\t\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\t\t\twebhook_url: params.webhookUrl,\n\t\t\t\t\twebhook_failover_url: params.webhookFailoverUrl,\n\t\t\t\t\tsubject: params.subject,\n\t\t\t\t\ttype: \"MMS\",\n\t\t\t\t});\n\t\t\t},\n\t\t\t{\n\t\t\t\tendpoint: \"messaging:send_mms\",\n\t\t\t\tconfig: {\n\t\t\t\t\tmaxRetries: 3,\n\t\t\t\t\tbaseDelayMs: 500,\n\t\t\t\t},\n\t\t\t}\n\t\t);\n\n\t\ttelnyxLogger.info(\"MMS sent successfully\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\tmessageId: result.data.id,\n\t\t\tmediaCount: params.mediaUrls.length,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.data.id,\n\t\t\tdata: result.data,\n\t\t};\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"MMS send failed\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to send MMS\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// BULK SENDING (With Throttling)\n// =============================================================================\n\ninterface BulkSMSResult {\n\tsuccess: boolean;\n\ttotal: number;\n\tsuccessful: number;\n\tfailed: number;\n\tresults: Array<{ to: string; result: SendSMSResult }>;\n\terror?: string;\n}\n\n/**\n * Send bulk SMS with proper throttling and rate limiting\n *\n * Unlike naive Promise.all, this:\n * - Limits concurrent sends to prevent overwhelming the API\n * - Respects per-company rate limits\n * - Provides detailed per-recipient results\n */\nexport async function sendBulkSMS(params: {\n\tcompanyId: string;\n\tto: string[];\n\tfrom: string;\n\ttext: string;\n\twebhookUrl?: string;\n\tmessagingProfileId?: string;\n}): Promise<BulkSMSResult> {\n\tconst results: Array<{ to: string; result: SendSMSResult }> = [];\n\tlet successful = 0;\n\tlet failed = 0;\n\n\ttelnyxLogger.info(\"Starting bulk SMS\", {\n\t\tcompanyId: params.companyId,\n\t\trecipientCount: params.to.length,\n\t});\n\n\t// Process in batches to respect rate limits\n\tconst batchSize = MESSAGING_CONFIG.maxConcurrentSends;\n\n\tfor (let i = 0; i < params.to.length; i += batchSize) {\n\t\tconst batch = params.to.slice(i, i + batchSize);\n\n\t\tconst batchResults = await Promise.all(\n\t\t\tbatch.map(async (recipient) => {\n\t\t\t\tconst result = await sendSMS({\n\t\t\t\t\tcompanyId: params.companyId,\n\t\t\t\t\tto: recipient,\n\t\t\t\t\tfrom: params.from,\n\t\t\t\t\ttext: params.text,\n\t\t\t\t\twebhookUrl: params.webhookUrl,\n\t\t\t\t\tmessagingProfileId: params.messagingProfileId,\n\t\t\t\t\t// Skip 10DLC check for each message in bulk (already checked once)\n\t\t\t\t\tskip10DLCCheck: i > 0,\n\t\t\t\t});\n\n\t\t\t\treturn { to: recipient, result };\n\t\t\t})\n\t\t);\n\n\t\tfor (const r of batchResults) {\n\t\t\tresults.push(r);\n\t\t\tif (r.result.success) {\n\t\t\t\tsuccessful++;\n\t\t\t} else {\n\t\t\t\tfailed++;\n\t\t\t}\n\t\t}\n\n\t\t// Small delay between batches to smooth out rate limiting\n\t\tif (i + batchSize < params.to.length) {\n\t\t\tawait new Promise((resolve) => setTimeout(resolve, 100));\n\t\t}\n\t}\n\n\ttelnyxLogger.info(\"Bulk SMS completed\", {\n\t\tcompanyId: params.companyId,\n\t\ttotal: params.to.length,\n\t\tsuccessful,\n\t\tfailed,\n\t});\n\n\treturn {\n\t\tsuccess: failed === 0,\n\t\ttotal: params.to.length,\n\t\tsuccessful,\n\t\tfailed,\n\t\tresults,\n\t};\n}\n\n// =============================================================================\n// MESSAGE RETRIEVAL\n// =============================================================================\n\n/**\n * Retrieve message by ID\n */\nexport async function getMessage(messageId: string) {\n\ttry {\n\t\tconst message = await telnyxRequest<{ data: TelnyxMessage }>(\n\t\t\t`/messages/${messageId}`\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: message.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to retrieve message\",\n\t\t};\n\t}\n}\n\n/**\n * List messages with optional filtering\n */\nexport async function listMessages(params?: {\n\tpageSize?: number;\n\tpageNumber?: number;\n\tfilterFrom?: string;\n\tfilterTo?: string;\n\tfilterDirection?: \"inbound\" | \"outbound\";\n}) {\n\ttry {\n\t\tconst messages = await telnyxRequest<{\n\t\t\tdata: TelnyxMessage[];\n\t\t\tmeta: { total_pages: number; total_results: number };\n\t\t}>(\"/messages\", {\n\t\t\tquery: {\n\t\t\t\t\"page[size]\": params?.pageSize ?? 20,\n\t\t\t\t\"page[number]\": params?.pageNumber ?? 1,\n\t\t\t\t\"filter[from]\": params?.filterFrom,\n\t\t\t\t\"filter[to]\": params?.filterTo,\n\t\t\t\t\"filter[direction]\": params?.filterDirection,\n\t\t\t},\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: messages.data,\n\t\t\tmeta: messages.meta,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to list messages\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// UTILITIES\n// =============================================================================\n\n/**\n * Validate a phone number for SMS capability\n */\nexport function validatePhoneNumber(phoneNumber: string): {\n\tsuccess: boolean;\n\tformattedNumber?: string;\n\terror?: string;\n} {\n\ttry {\n\t\t// Remove any formatting from phone number\n\t\tconst cleanNumber = phoneNumber.replace(/\\D/g, \"\");\n\n\t\t// Check if it's a valid length (10-15 digits)\n\t\tif (cleanNumber.length < 10 || cleanNumber.length > 15) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Invalid phone number length (must be 10-15 digits)\",\n\t\t\t};\n\t\t}\n\n\t\t// Format to E.164\n\t\tconst formattedNumber = formatPhoneNumber(cleanNumber);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tformattedNumber,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to validate phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Format phone number to E.164 standard (+15551234567)\n */\nexport function formatPhoneNumber(phoneNumber: string): string {\n\t// Remove all non-digit characters except leading +\n\tconst digits = phoneNumber.replace(/[^\\d+]/g, \"\").replace(/(?!^)\\+/g, \"\");\n\n\t// Already has + prefix\n\tif (digits.startsWith(\"+\")) {\n\t\treturn digits;\n\t}\n\n\t// If it starts with 1 and is 11 digits, it's a US number\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn `+${digits}`;\n\t}\n\n\t// If it's 10 digits, assume US and add +1\n\tif (digits.length === 10) {\n\t\treturn `+1${digits}`;\n\t}\n\n\t// Otherwise, add + prefix\n\treturn `+${digits}`;\n}\n\n/**\n * Check if a phone number is a US number\n */\nexport function isUSPhoneNumber(phoneNumber: string): boolean {\n\tconst formatted = formatPhoneNumber(phoneNumber);\n\treturn formatted.startsWith(\"+1\") && formatted.length === 12;\n}\n"],"names":[],"mappings":"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"}