module.exports=[55849,e=>{"use strict";var t=e.i(755535),a=e.i(377233),o=e.i(490003),r=e.i(492991),n=e.i(241970),i=e.i(357699),s=e.i(212454),l=e.i(48717),c=e.i(798301),u=e.i(986366),d=e.i(983537),p=e.i(147475),h=e.i(561930),m=e.i(803747),g=e.i(368557),f=e.i(42037),w=e.i(193695);e.i(432036);var y=e.i(573881),R=e.i(297676),v=e.i(443608);e.i(715051);var b=e.i(511368);let A=v.z.object({location:v.z.object({lat:v.z.number(),lng:v.z.number()}),accuracy:v.z.number()});class C{static instance;apiKey;baseUrl="https://www.googleapis.com/geolocation/v1/geolocate";cache=new Map;CACHE_TTL=3e5;constructor(){this.apiKey=process.env.GOOGLE_API_KEY||"AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0",this.apiKey||console.warn("GoogleGeolocationService: No API key found. Set GOOGLE_API_KEY environment variable.")}static getInstance(){return C.instance||(C.instance=new C),C.instance}isConfigured(){return!!this.apiKey}getCacheKey(e){let t=e.cellTowers?.map(e=>`${e.cellId}`).join(",")||"",a=e.wifiAccessPoints?.map(e=>e.macAddress).join(",")||"";return`${t}_${a}_${e.considerIp}`}cleanCache(){let e=Date.now();for(let[t,a]of this.cache.entries())e-a.timestamp>this.CACHE_TTL&&this.cache.delete(t)}async getLocation(e){if(!this.apiKey)throw Error("Geolocation API key not configured");let t=this.getCacheKey(e);this.cleanCache();let a=this.cache.get(t);if(a)return a.result;let o=await fetch(`${this.baseUrl}?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!o.ok){let e=await o.json();throw Error(`Geolocation API error: ${e.error?.message||o.statusText}`)}let r=await o.json(),n=A.parse(r),i="ip";e.cellTowers&&e.cellTowers.length>0&&e.wifiAccessPoints&&e.wifiAccessPoints.length>0?i="hybrid":e.cellTowers&&e.cellTowers.length>0?i="cell":e.wifiAccessPoints&&e.wifiAccessPoints.length>0&&(i="wifi");let s={latitude:n.location.lat,longitude:n.location.lng,accuracy:n.accuracy,source:i,timestamp:new Date};return this.cache.set(t,{result:s,timestamp:Date.now()}),s}async getLocationFromIP(){return this.getLocation({considerIp:!0})}async getLocationFromWifi(e){if(0===e.length)throw Error("At least one WiFi access point is required");return this.getLocation({wifiAccessPoints:e,considerIp:!0})}async getLocationFromCellTowers(e,t){if(0===e.length)throw Error("At least one cell tower is required");return this.getLocation({cellTowers:e,radioType:t,considerIp:!0})}async getHybridLocation(e,t,a){return this.getLocation({cellTowers:e,wifiAccessPoints:t,radioType:a,considerIp:!0})}verifyLocationProximity(e,t,a=100){let o=this.haversineDistance(e,t);return{isAtLocation:o<=a,distanceMeters:Math.round(o),withinAccuracy:o<=1.5*a}}haversineDistance(e,t){let a=e.latitude*Math.PI/180,o=t.latitude*Math.PI/180,r=(t.latitude-e.latitude)*Math.PI/180,n=(t.longitude-e.longitude)*Math.PI/180,i=Math.sin(r/2)*Math.sin(r/2)+Math.cos(a)*Math.cos(o)*Math.sin(n/2)*Math.sin(n/2);return 2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))*6371e3}async reverseGeocode(e){if(!this.apiKey)throw Error("Geolocation API key not configured");let t=await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${e.latitude},${e.longitude}&key=${this.apiKey}`);if(!t.ok)return e;let a=await t.json();if("OK"!==a.status||!a.results||0===a.results.length)return e;let o=a.results[0],r=o.address_components||[],n=e=>{let t=r.find(t=>t.types.includes(e));return t?.long_name};return{...e,address:o.formatted_address,city:n("locality")||n("sublocality"),state:n("administrative_area_level_1"),postalCode:n("postal_code"),country:n("country")}}startTracking(e,t=3e4,a){let o=!0,r=async()=>{if(o){try{let t;if(a){let e=await a();t=await this.getLocationFromWifi(e)}else t=await this.getLocationFromIP();e(t)}catch(e){console.error("Location tracking error:",e)}o&&setTimeout(r,t)}};return r(),()=>{o=!1}}clearCache(){this.cache.clear()}}let E=C.getInstance(),x=v.z.object({macAddress:v.z.string(),signalStrength:v.z.number().optional(),age:v.z.number().optional(),channel:v.z.number().optional(),signalToNoiseRatio:v.z.number().optional()}),P=v.z.object({cellId:v.z.number(),locationAreaCode:v.z.number(),mobileCountryCode:v.z.number(),mobileNetworkCode:v.z.number(),age:v.z.number().optional(),signalStrength:v.z.number().optional(),timingAdvance:v.z.number().optional()}),T=v.z.object({latitude:v.z.number(),longitude:v.z.number()}),I=v.z.object({type:v.z.enum(["ip","wifi","cell","hybrid","verify"]),wifiAccessPoints:v.z.array(x).optional(),cellTowers:v.z.array(P).optional(),radioType:v.z.enum(["lte","gsm","cdma","wcdma","nr"]).optional(),technicianLocation:T.optional(),jobLocation:T.optional(),toleranceMeters:v.z.number().min(1).max(1e3).optional(),includeAddress:v.z.boolean().optional()});async function S(e){try{let t=await (0,b.createClient)(),{data:{user:a}}=await t.auth.getUser();if(!a)return R.NextResponse.json({error:"Unauthorized"},{status:401});if(!E.isConfigured())return R.NextResponse.json({error:"Geolocation service is not configured. Set GOOGLE_API_KEY environment variable."},{status:503});let o=await e.json(),r=I.parse(o);switch(r.type){case"ip":{let e=await E.getLocationFromIP();if(r.includeAddress){let t=await E.reverseGeocode(e);return R.NextResponse.json({success:!0,data:{...t,timestamp:t.timestamp.toISOString()}})}return R.NextResponse.json({success:!0,data:{...e,timestamp:e.timestamp.toISOString()}})}case"wifi":{if(!r.wifiAccessPoints||0===r.wifiAccessPoints.length)return R.NextResponse.json({error:"WiFi access points required for wifi location"},{status:400});let e=await E.getLocationFromWifi(r.wifiAccessPoints);if(r.includeAddress){let t=await E.reverseGeocode(e);return R.NextResponse.json({success:!0,data:{...t,timestamp:t.timestamp.toISOString()}})}return R.NextResponse.json({success:!0,data:{...e,timestamp:e.timestamp.toISOString()}})}case"cell":{if(!r.cellTowers||0===r.cellTowers.length)return R.NextResponse.json({error:"Cell towers required for cell location"},{status:400});let e=await E.getLocationFromCellTowers(r.cellTowers,r.radioType);if(r.includeAddress){let t=await E.reverseGeocode(e);return R.NextResponse.json({success:!0,data:{...t,timestamp:t.timestamp.toISOString()}})}return R.NextResponse.json({success:!0,data:{...e,timestamp:e.timestamp.toISOString()}})}case"hybrid":{let e=await E.getHybridLocation(r.cellTowers,r.wifiAccessPoints,r.radioType);if(r.includeAddress){let t=await E.reverseGeocode(e);return R.NextResponse.json({success:!0,data:{...t,timestamp:t.timestamp.toISOString()}})}return R.NextResponse.json({success:!0,data:{...e,timestamp:e.timestamp.toISOString()}})}case"verify":{if(!r.technicianLocation||!r.jobLocation)return R.NextResponse.json({error:"Technician and job locations required for verification"},{status:400});let e=E.verifyLocationProximity(r.technicianLocation,r.jobLocation,r.toleranceMeters);return R.NextResponse.json({success:!0,data:e})}default:return R.NextResponse.json({error:"Invalid location type"},{status:400})}}catch(e){if(console.error("Geolocation error:",e),e instanceof v.z.ZodError)return R.NextResponse.json({error:"Invalid request data",details:e.errors},{status:400});return R.NextResponse.json({error:"Failed to get location",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}e.s(["POST",()=>S],836531);var N=e.i(836531);let j=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/location/route",pathname:"/api/location",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/location/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:O,workUnitAsyncStorage:_,serverHooks:L}=j;function M(){return(0,o.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:_})}async function z(e,t,o){j.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/location/route";R=R.replace(/\/index$/,"")||"/";let v=await j.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:b,params:A,nextConfig:C,parsedUrl:E,isDraftMode:x,prerenderManifest:P,routerServerContext:T,isOnDemandRevalidate:I,revalidateOnlyGenerated:S,resolvedPathname:N,clientReferenceManifest:O,serverActionsManifest:_}=v,L=(0,l.normalizeAppPath)(R),M=!!(P.dynamicRoutes[L]||P.routes[N]),z=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,E,!1):t.end("This page could not be found"),null);if(M&&!x){let e=!!P.routes[N],t=P.dynamicRoutes[L];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await z();throw new w.NoFallbackError}}let k=null;!M||j.isDev||x||(k="/index"===(k=N)?"/":k);let q=!0===j.isDev||!M,K=M&&!q;_&&O&&(0,i.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:O,serverActionsManifest:_,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:_})});let G=e.method||"GET",H=(0,n.getTracer)(),U=H.getActiveScopeSpan(),F={params:A,prerenderManifest:P,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,o)=>j.onRequestError(e,t,o,T)},sharedContext:{buildId:b}},$=new c.NodeNextRequest(e),D=new c.NodeNextResponse(t),W=u.NextRequestAdapter.fromNodeNextRequest($,(0,u.signalFromNodeResponse)(t));try{let i=async e=>j.handle(W,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=H.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=a.get("next.route");if(o){let t=`${G} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${G} ${R}`)}),s=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var n,l;let c=async({previousCacheEntry:a})=>{try{if(!s&&I&&S&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(r);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&o.waitUntil&&(o.waitUntil(l),l=void 0);let c=F.renderOpts.collectedTags;if(!M)return await (0,h.sendResponse)($,D,n,F.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,o=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:o}}}}catch(t){throw(null==a?void 0:a.isStale)&&await j.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:K,isOnDemandRevalidate:I})},T),t}},u=await j.handleResponse({req:e,nextConfig:C,cacheKey:k,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:P,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:S,responseGenerator:c,waitUntil:o.waitUntil,isMinimalMode:s});if(!M)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",I?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,m.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&M||d.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)($,D,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};U?await l(U):await H.withPropagatedContext(e.headers,()=>H.trace(d.BaseServerSpan.handleRequest,{spanName:`${G} ${R}`,kind:n.SpanKind.SERVER,attributes:{"http.method":G,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await j.onRequestError(e,t,{routerKind:"App Router",routePath:L,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:K,isOnDemandRevalidate:I})}),M)throw t;return await (0,h.sendResponse)($,D,new Response(null,{status:500})),null}}e.s(["handler",()=>z,"patchFetch",()=>M,"routeModule",()=>j,"serverHooks",()=>L,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>_],55849)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_d0a9782e.js.map