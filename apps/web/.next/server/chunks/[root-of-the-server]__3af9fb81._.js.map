{"version":3,"sources":["../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/server/route-modules/app-page/module.compiled.js","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/server/route-modules/app-page/vendored/rsc/react.ts","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/dist/compiled/%40edge-runtime/cookies/index.js","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/server/web/spec-extension/adapters/reflect.ts","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/server/request/utils.ts","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server.ts","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../../packages/database/src/service-client.ts","../../../../../apps/web/src/lib/telnyx/messaging.ts","../../../../../apps/web/src/lib/telnyx/webhooks.ts"],"sourcesContent":["if (process.env.NEXT_RUNTIME === 'edge') {\n  module.exports = require('next/dist/server/route-modules/app-page/module.js')\n} else {\n  if (process.env.__NEXT_EXPERIMENTAL_REACT) {\n    if (process.env.NODE_ENV === 'development') {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo-experimental.runtime.dev.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page-experimental.runtime.dev.js')\n      }\n    } else {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo-experimental.runtime.prod.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page-experimental.runtime.prod.js')\n      }\n    }\n  } else {\n    if (process.env.NODE_ENV === 'development') {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo.runtime.dev.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page.runtime.dev.js')\n      }\n    } else {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo.runtime.prod.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page.runtime.prod.js')\n      }\n    }\n  }\n}\n","module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['react-rsc']!.React\n","\"use strict\";\nvar __defProp = Object.defineProperty;\nvar __getOwnPropDesc = Object.getOwnPropertyDescriptor;\nvar __getOwnPropNames = Object.getOwnPropertyNames;\nvar __hasOwnProp = Object.prototype.hasOwnProperty;\nvar __export = (target, all) => {\n  for (var name in all)\n    __defProp(target, name, { get: all[name], enumerable: true });\n};\nvar __copyProps = (to, from, except, desc) => {\n  if (from && typeof from === \"object\" || typeof from === \"function\") {\n    for (let key of __getOwnPropNames(from))\n      if (!__hasOwnProp.call(to, key) && key !== except)\n        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });\n  }\n  return to;\n};\nvar __toCommonJS = (mod) => __copyProps(__defProp({}, \"__esModule\", { value: true }), mod);\n\n// src/index.ts\nvar src_exports = {};\n__export(src_exports, {\n  RequestCookies: () => RequestCookies,\n  ResponseCookies: () => ResponseCookies,\n  parseCookie: () => parseCookie,\n  parseSetCookie: () => parseSetCookie,\n  stringifyCookie: () => stringifyCookie\n});\nmodule.exports = __toCommonJS(src_exports);\n\n// src/serialize.ts\nfunction stringifyCookie(c) {\n  var _a;\n  const attrs = [\n    \"path\" in c && c.path && `Path=${c.path}`,\n    \"expires\" in c && (c.expires || c.expires === 0) && `Expires=${(typeof c.expires === \"number\" ? new Date(c.expires) : c.expires).toUTCString()}`,\n    \"maxAge\" in c && typeof c.maxAge === \"number\" && `Max-Age=${c.maxAge}`,\n    \"domain\" in c && c.domain && `Domain=${c.domain}`,\n    \"secure\" in c && c.secure && \"Secure\",\n    \"httpOnly\" in c && c.httpOnly && \"HttpOnly\",\n    \"sameSite\" in c && c.sameSite && `SameSite=${c.sameSite}`,\n    \"partitioned\" in c && c.partitioned && \"Partitioned\",\n    \"priority\" in c && c.priority && `Priority=${c.priority}`\n  ].filter(Boolean);\n  const stringified = `${c.name}=${encodeURIComponent((_a = c.value) != null ? _a : \"\")}`;\n  return attrs.length === 0 ? stringified : `${stringified}; ${attrs.join(\"; \")}`;\n}\nfunction parseCookie(cookie) {\n  const map = /* @__PURE__ */ new Map();\n  for (const pair of cookie.split(/; */)) {\n    if (!pair)\n      continue;\n    const splitAt = pair.indexOf(\"=\");\n    if (splitAt === -1) {\n      map.set(pair, \"true\");\n      continue;\n    }\n    const [key, value] = [pair.slice(0, splitAt), pair.slice(splitAt + 1)];\n    try {\n      map.set(key, decodeURIComponent(value != null ? value : \"true\"));\n    } catch {\n    }\n  }\n  return map;\n}\nfunction parseSetCookie(setCookie) {\n  if (!setCookie) {\n    return void 0;\n  }\n  const [[name, value], ...attributes] = parseCookie(setCookie);\n  const {\n    domain,\n    expires,\n    httponly,\n    maxage,\n    path,\n    samesite,\n    secure,\n    partitioned,\n    priority\n  } = Object.fromEntries(\n    attributes.map(([key, value2]) => [\n      key.toLowerCase().replace(/-/g, \"\"),\n      value2\n    ])\n  );\n  const cookie = {\n    name,\n    value: decodeURIComponent(value),\n    domain,\n    ...expires && { expires: new Date(expires) },\n    ...httponly && { httpOnly: true },\n    ...typeof maxage === \"string\" && { maxAge: Number(maxage) },\n    path,\n    ...samesite && { sameSite: parseSameSite(samesite) },\n    ...secure && { secure: true },\n    ...priority && { priority: parsePriority(priority) },\n    ...partitioned && { partitioned: true }\n  };\n  return compact(cookie);\n}\nfunction compact(t) {\n  const newT = {};\n  for (const key in t) {\n    if (t[key]) {\n      newT[key] = t[key];\n    }\n  }\n  return newT;\n}\nvar SAME_SITE = [\"strict\", \"lax\", \"none\"];\nfunction parseSameSite(string) {\n  string = string.toLowerCase();\n  return SAME_SITE.includes(string) ? string : void 0;\n}\nvar PRIORITY = [\"low\", \"medium\", \"high\"];\nfunction parsePriority(string) {\n  string = string.toLowerCase();\n  return PRIORITY.includes(string) ? string : void 0;\n}\nfunction splitCookiesString(cookiesString) {\n  if (!cookiesString)\n    return [];\n  var cookiesStrings = [];\n  var pos = 0;\n  var start;\n  var ch;\n  var lastComma;\n  var nextStart;\n  var cookiesSeparatorFound;\n  function skipWhitespace() {\n    while (pos < cookiesString.length && /\\s/.test(cookiesString.charAt(pos))) {\n      pos += 1;\n    }\n    return pos < cookiesString.length;\n  }\n  function notSpecialChar() {\n    ch = cookiesString.charAt(pos);\n    return ch !== \"=\" && ch !== \";\" && ch !== \",\";\n  }\n  while (pos < cookiesString.length) {\n    start = pos;\n    cookiesSeparatorFound = false;\n    while (skipWhitespace()) {\n      ch = cookiesString.charAt(pos);\n      if (ch === \",\") {\n        lastComma = pos;\n        pos += 1;\n        skipWhitespace();\n        nextStart = pos;\n        while (pos < cookiesString.length && notSpecialChar()) {\n          pos += 1;\n        }\n        if (pos < cookiesString.length && cookiesString.charAt(pos) === \"=\") {\n          cookiesSeparatorFound = true;\n          pos = nextStart;\n          cookiesStrings.push(cookiesString.substring(start, lastComma));\n          start = pos;\n        } else {\n          pos = lastComma + 1;\n        }\n      } else {\n        pos += 1;\n      }\n    }\n    if (!cookiesSeparatorFound || pos >= cookiesString.length) {\n      cookiesStrings.push(cookiesString.substring(start, cookiesString.length));\n    }\n  }\n  return cookiesStrings;\n}\n\n// src/request-cookies.ts\nvar RequestCookies = class {\n  constructor(requestHeaders) {\n    /** @internal */\n    this._parsed = /* @__PURE__ */ new Map();\n    this._headers = requestHeaders;\n    const header = requestHeaders.get(\"cookie\");\n    if (header) {\n      const parsed = parseCookie(header);\n      for (const [name, value] of parsed) {\n        this._parsed.set(name, { name, value });\n      }\n    }\n  }\n  [Symbol.iterator]() {\n    return this._parsed[Symbol.iterator]();\n  }\n  /**\n   * The amount of cookies received from the client\n   */\n  get size() {\n    return this._parsed.size;\n  }\n  get(...args) {\n    const name = typeof args[0] === \"string\" ? args[0] : args[0].name;\n    return this._parsed.get(name);\n  }\n  getAll(...args) {\n    var _a;\n    const all = Array.from(this._parsed);\n    if (!args.length) {\n      return all.map(([_, value]) => value);\n    }\n    const name = typeof args[0] === \"string\" ? args[0] : (_a = args[0]) == null ? void 0 : _a.name;\n    return all.filter(([n]) => n === name).map(([_, value]) => value);\n  }\n  has(name) {\n    return this._parsed.has(name);\n  }\n  set(...args) {\n    const [name, value] = args.length === 1 ? [args[0].name, args[0].value] : args;\n    const map = this._parsed;\n    map.set(name, { name, value });\n    this._headers.set(\n      \"cookie\",\n      Array.from(map).map(([_, value2]) => stringifyCookie(value2)).join(\"; \")\n    );\n    return this;\n  }\n  /**\n   * Delete the cookies matching the passed name or names in the request.\n   */\n  delete(names) {\n    const map = this._parsed;\n    const result = !Array.isArray(names) ? map.delete(names) : names.map((name) => map.delete(name));\n    this._headers.set(\n      \"cookie\",\n      Array.from(map).map(([_, value]) => stringifyCookie(value)).join(\"; \")\n    );\n    return result;\n  }\n  /**\n   * Delete all the cookies in the cookies in the request.\n   */\n  clear() {\n    this.delete(Array.from(this._parsed.keys()));\n    return this;\n  }\n  /**\n   * Format the cookies in the request as a string for logging\n   */\n  [Symbol.for(\"edge-runtime.inspect.custom\")]() {\n    return `RequestCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`;\n  }\n  toString() {\n    return [...this._parsed.values()].map((v) => `${v.name}=${encodeURIComponent(v.value)}`).join(\"; \");\n  }\n};\n\n// src/response-cookies.ts\nvar ResponseCookies = class {\n  constructor(responseHeaders) {\n    /** @internal */\n    this._parsed = /* @__PURE__ */ new Map();\n    var _a, _b, _c;\n    this._headers = responseHeaders;\n    const setCookie = (_c = (_b = (_a = responseHeaders.getSetCookie) == null ? void 0 : _a.call(responseHeaders)) != null ? _b : responseHeaders.get(\"set-cookie\")) != null ? _c : [];\n    const cookieStrings = Array.isArray(setCookie) ? setCookie : splitCookiesString(setCookie);\n    for (const cookieString of cookieStrings) {\n      const parsed = parseSetCookie(cookieString);\n      if (parsed)\n        this._parsed.set(parsed.name, parsed);\n    }\n  }\n  /**\n   * {@link https://wicg.github.io/cookie-store/#CookieStore-get CookieStore#get} without the Promise.\n   */\n  get(...args) {\n    const key = typeof args[0] === \"string\" ? args[0] : args[0].name;\n    return this._parsed.get(key);\n  }\n  /**\n   * {@link https://wicg.github.io/cookie-store/#CookieStore-getAll CookieStore#getAll} without the Promise.\n   */\n  getAll(...args) {\n    var _a;\n    const all = Array.from(this._parsed.values());\n    if (!args.length) {\n      return all;\n    }\n    const key = typeof args[0] === \"string\" ? args[0] : (_a = args[0]) == null ? void 0 : _a.name;\n    return all.filter((c) => c.name === key);\n  }\n  has(name) {\n    return this._parsed.has(name);\n  }\n  /**\n   * {@link https://wicg.github.io/cookie-store/#CookieStore-set CookieStore#set} without the Promise.\n   */\n  set(...args) {\n    const [name, value, cookie] = args.length === 1 ? [args[0].name, args[0].value, args[0]] : args;\n    const map = this._parsed;\n    map.set(name, normalizeCookie({ name, value, ...cookie }));\n    replace(map, this._headers);\n    return this;\n  }\n  /**\n   * {@link https://wicg.github.io/cookie-store/#CookieStore-delete CookieStore#delete} without the Promise.\n   */\n  delete(...args) {\n    const [name, options] = typeof args[0] === \"string\" ? [args[0]] : [args[0].name, args[0]];\n    return this.set({ ...options, name, value: \"\", expires: /* @__PURE__ */ new Date(0) });\n  }\n  [Symbol.for(\"edge-runtime.inspect.custom\")]() {\n    return `ResponseCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`;\n  }\n  toString() {\n    return [...this._parsed.values()].map(stringifyCookie).join(\"; \");\n  }\n};\nfunction replace(bag, headers) {\n  headers.delete(\"set-cookie\");\n  for (const [, value] of bag) {\n    const serialized = stringifyCookie(value);\n    headers.append(\"set-cookie\", serialized);\n  }\n}\nfunction normalizeCookie(cookie = { name: \"\", value: \"\" }) {\n  if (typeof cookie.expires === \"number\") {\n    cookie.expires = new Date(cookie.expires);\n  }\n  if (cookie.maxAge) {\n    cookie.expires = new Date(Date.now() + cookie.maxAge * 1e3);\n  }\n  if (cookie.path === null || cookie.path === void 0) {\n    cookie.path = \"/\";\n  }\n  return cookie;\n}\n// Annotate the CommonJS export names for ESM import in node:\n0 && (module.exports = {\n  RequestCookies,\n  ResponseCookies,\n  parseCookie,\n  parseSetCookie,\n  stringifyCookie\n});\n","export class ReflectAdapter {\n  static get<T extends object>(\n    target: T,\n    prop: string | symbol,\n    receiver: unknown\n  ): any {\n    const value = Reflect.get(target, prop, receiver)\n    if (typeof value === 'function') {\n      return value.bind(target)\n    }\n\n    return value\n  }\n\n  static set<T extends object>(\n    target: T,\n    prop: string | symbol,\n    value: any,\n    receiver: any\n  ): boolean {\n    return Reflect.set(target, prop, value, receiver)\n  }\n\n  static has<T extends object>(target: T, prop: string | symbol): boolean {\n    return Reflect.has(target, prop)\n  }\n\n  static deleteProperty<T extends object>(\n    target: T,\n    prop: string | symbol\n  ): boolean {\n    return Reflect.deleteProperty(target, prop)\n  }\n}\n","import { StaticGenBailoutError } from '../../client/components/static-generation-bailout'\nimport { afterTaskAsyncStorage } from '../app-render/after-task-async-storage.external'\nimport type { WorkStore } from '../app-render/work-async-storage.external'\n\nexport function throwWithStaticGenerationBailoutErrorWithDynamicError(\n  route: string,\n  expression: string\n): never {\n  throw new StaticGenBailoutError(\n    `Route ${route} with \\`dynamic = \"error\"\\` couldn't be rendered statically because it used ${expression}. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`\n  )\n}\n\nexport function throwForSearchParamsAccessInUseCache(\n  workStore: WorkStore,\n  constructorOpt: Function\n): never {\n  const error = new Error(\n    `Route ${workStore.route} used \\`searchParams\\` inside \"use cache\". Accessing dynamic request data inside a cache scope is not supported. If you need some search params inside a cached function await \\`searchParams\\` outside of the cached function and pass only the required search params as arguments to the cached function. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n  )\n\n  Error.captureStackTrace(error, constructorOpt)\n  workStore.invalidDynamicUsageError ??= error\n\n  throw error\n}\n\nexport function isRequestAPICallableInsideAfter() {\n  const afterTaskStore = afterTaskAsyncStorage.getStore()\n  return afterTaskStore?.rootTaskSpawnPhase === 'action'\n}\n","module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['react-rsc']!.ReactServerDOMTurbopackServer\n","/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","\"use server\";\n\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\";\nimport type { Database } from \"./types\";\n\n/**\n * Creates a Supabase client using the service role key.\n * This bypasses RLS and is intended for background jobs / automation.\n *\n * Performance Optimization:\n * - Uses SUPABASE_POOLER_URL (Transaction Mode) if available for 30-50% faster queries\n * - Falls back to NEXT_PUBLIC_SUPABASE_URL (Session Mode) if pooler not configured\n * - Transaction Mode supports 10,000+ concurrent connections vs 100 in Session Mode\n *\n * @returns Supabase client with service role, or null if not configured\n */\nexport async function createServiceSupabaseClient() {\n\t// Prefer pooler URL for Transaction Mode (better performance)\n\tconst supabaseUrl =\n\t\tprocess.env.SUPABASE_POOLER_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n\tconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n\tif (!supabaseUrl || !serviceRoleKey) {\n\t\treturn null;\n\t}\n\n\treturn createSupabaseClient<Database>(supabaseUrl, serviceRoleKey, {\n\t\tauth: {\n\t\t\tpersistSession: false,\n\t\t\tautoRefreshToken: false,\n\t\t},\n\t\tdb: {\n\t\t\tschema: \"public\",\n\t\t},\n\t\tglobal: {\n\t\t\theaders: {\n\t\t\t\t\"x-my-custom-header\": \"service-role\",\n\t\t\t},\n\t\t},\n\t});\n}\n\nexport type ServiceSupabaseClient = Awaited<\n\tReturnType<typeof createServiceSupabaseClient>\n>;\n","/**\n * Telnyx Messaging Service - SMS & MMS\n *\n * Production-ready messaging with:\n * - 10DLC compliance verification (required for US A2P SMS as of Dec 2024)\n * - Per-company rate limiting\n * - Retry logic with exponential backoff\n * - Multi-tenant support\n * - Structured logging\n */\n\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\nimport { telnyxLogger } from \"./logger\";\nimport { withRetry } from \"./retry\";\n\nconst TELNYX_API_BASE = \"https://api.telnyx.com/v2\";\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nconst MESSAGING_CONFIG = {\n\t// Default rate limits per company (messages per minute)\n\tdefaultRateLimitPerMinute: 60,\n\t// Max concurrent sends for bulk operations\n\tmaxConcurrentSends: 5,\n\t// Warn if 10DLC not configured\n\twarnOn10DLCMissing: true,\n\t// Request timeout in milliseconds\n\trequestTimeoutMs: 30000,\n};\n\n// =============================================================================\n// API CLIENT\n// =============================================================================\n\nfunction assertTelnyxApiKey(): string {\n\tconst apiKey = process.env.TELNYX_API_KEY;\n\tif (!apiKey) {\n\t\tthrow new Error(\"TELNYX_API_KEY is not configured\");\n\t}\n\treturn apiKey;\n}\n\nasync function telnyxRequest<T = unknown>(\n\tpath: string,\n\tinit?: RequestInit & {\n\t\tquery?: Record<string, string | number | undefined>;\n\t\ttimeout?: number;\n\t}\n): Promise<T> {\n\tconst apiKey = assertTelnyxApiKey();\n\tconst url = new URL(`${TELNYX_API_BASE}${path}`);\n\n\tif (init?.query) {\n\t\tfor (const [key, value] of Object.entries(init.query)) {\n\t\t\tif (value !== undefined && value !== null) {\n\t\t\t\turl.searchParams.set(key, String(value));\n\t\t\t}\n\t\t}\n\t}\n\n\ttelnyxLogger.debug(\"Telnyx API request\", {\n\t\tmethod: init?.method || \"GET\",\n\t\tpath,\n\t});\n\n\t// Create abort controller for timeout\n\tconst controller = new AbortController();\n\tconst timeout = init?.timeout ?? MESSAGING_CONFIG.requestTimeoutMs;\n\tconst timeoutId = setTimeout(() => controller.abort(), timeout);\n\n\ttry {\n\t\tconst response = await fetch(url, {\n\t\t\t...init,\n\t\t\theaders: {\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t\t...(init?.headers || {}),\n\t\t\t},\n\t\t\tsignal: controller.signal,\n\t\t});\n\n\t\tclearTimeout(timeoutId);\n\n\t\tconst data = await response.json();\n\n\t\tif (!response.ok) {\n\t\t\tconst detail = data?.errors?.[0]?.detail || response.statusText;\n\t\t\tconst errorCode = data?.errors?.[0]?.code;\n\t\t\ttelnyxLogger.error(\"Telnyx API error\", {\n\t\t\t\tstatus: response.status,\n\t\t\t\tdetail,\n\t\t\t\terrorCode,\n\t\t\t\tpath,\n\t\t\t});\n\t\t\tthrow new Error(`Telnyx ${response.status}: ${detail}`);\n\t\t}\n\n\t\treturn data as T;\n\t} catch (error) {\n\t\tclearTimeout(timeoutId);\n\n\t\tif (error instanceof Error && error.name === \"AbortError\") {\n\t\t\ttelnyxLogger.error(\"Telnyx API timeout\", {\n\t\t\t\tpath,\n\t\t\t\ttimeoutMs: timeout,\n\t\t\t});\n\t\t\tthrow new Error(`Request timeout after ${timeout}ms`);\n\t\t}\n\n\t\tthrow error;\n\t}\n}\n\nasync function telnyxMessageRequest(body: Record<string, unknown>) {\n\treturn telnyxRequest<{ data: TelnyxMessage }>(\"/messages\", {\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify(body),\n\t});\n}\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport type MessageType = \"SMS\" | \"MMS\";\n\nexport type MessageStatus =\n\t| \"queued\"\n\t| \"sending\"\n\t| \"sent\"\n\t| \"delivered\"\n\t| \"sending_failed\"\n\t| \"delivery_failed\"\n\t| \"delivery_unconfirmed\";\n\ninterface TelnyxMessage {\n\tid: string;\n\tstatus: MessageStatus;\n\ttype: MessageType;\n\tfrom: { phone_number: string };\n\tto: Array<{ phone_number: string; status: string }>;\n\ttext?: string;\n\tmedia?: Array<{ url: string; content_type: string }>;\n\tcreated_at: string;\n}\n\ninterface SendSMSParams {\n\tcompanyId: string;\n\tto: string;\n\tfrom: string;\n\ttext: string;\n\twebhookUrl?: string;\n\twebhookFailoverUrl?: string;\n\tuseProfileWebhooks?: boolean;\n\tmessagingProfileId?: string;\n\tskipRateLimit?: boolean;\n\tskip10DLCCheck?: boolean;\n}\n\ninterface SendSMSResult {\n\tsuccess: boolean;\n\tmessageId?: string;\n\tdata?: TelnyxMessage;\n\terror?: string;\n\twarnings?: string[];\n}\n\n// =============================================================================\n// 10DLC COMPLIANCE CHECK\n// =============================================================================\n\ninterface TenDLCStatus {\n\tisConfigured: boolean;\n\tbrandId?: string;\n\tcampaignId?: string;\n\tmessagingProfileId?: string;\n\twarnings: string[];\n}\n\n/**\n * Check 10DLC compliance status for a company\n *\n * As of December 2024, ALL US A2P SMS traffic MUST be registered with 10DLC.\n * Messages sent without proper registration may be filtered or blocked by carriers.\n */\nexport async function check10DLCStatus(companyId: string): Promise<TenDLCStatus> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tif (!supabase) {\n\t\t\treturn {\n\t\t\t\tisConfigured: false,\n\t\t\t\twarnings: [\"Database not available - cannot verify 10DLC status\"],\n\t\t\t};\n\t\t}\n\n\t\tconst { data: settings, error } = await supabase\n\t\t\t.from(\"company_telnyx_settings\")\n\t\t\t.select(\"ten_dlc_brand_id, ten_dlc_campaign_id, messaging_profile_id, status\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.maybeSingle();\n\n\t\tif (error) {\n\t\t\ttelnyxLogger.error(\"Failed to check 10DLC status\", {\n\t\t\t\tcompanyId,\n\t\t\t\terror: error.message,\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tisConfigured: false,\n\t\t\t\twarnings: [\"Failed to verify 10DLC status\"],\n\t\t\t};\n\t\t}\n\n\t\tif (!settings) {\n\t\t\treturn {\n\t\t\t\tisConfigured: false,\n\t\t\t\twarnings: [\"No Telnyx settings configured for company\"],\n\t\t\t};\n\t\t}\n\n\t\tconst warnings: string[] = [];\n\n\t\tif (!settings.ten_dlc_brand_id) {\n\t\t\twarnings.push(\"10DLC brand not registered - US SMS may be filtered\");\n\t\t}\n\n\t\tif (!settings.ten_dlc_campaign_id) {\n\t\t\twarnings.push(\"10DLC campaign not registered - US SMS may be filtered\");\n\t\t}\n\n\t\tif (!settings.messaging_profile_id) {\n\t\t\twarnings.push(\"Messaging profile not configured\");\n\t\t}\n\n\t\tconst isConfigured =\n\t\t\t!!settings.ten_dlc_brand_id &&\n\t\t\t!!settings.ten_dlc_campaign_id &&\n\t\t\t!!settings.messaging_profile_id;\n\n\t\treturn {\n\t\t\tisConfigured,\n\t\t\tbrandId: settings.ten_dlc_brand_id || undefined,\n\t\t\tcampaignId: settings.ten_dlc_campaign_id || undefined,\n\t\t\tmessagingProfileId: settings.messaging_profile_id || undefined,\n\t\t\twarnings,\n\t\t};\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"10DLC check error\", {\n\t\t\tcompanyId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\t\treturn {\n\t\t\tisConfigured: false,\n\t\t\twarnings: [\"Error checking 10DLC status\"],\n\t\t};\n\t}\n}\n\n// =============================================================================\n// RATE LIMITING\n// =============================================================================\n\n/**\n * Check and increment SMS rate limit for a company\n *\n * @returns true if under limit, false if rate limited\n */\nexport async function checkSMSRateLimit(\n\tcompanyId: string,\n\tidentifier = \"default\"\n): Promise<{ allowed: boolean; currentCount: number; limit: number }> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tif (!supabase) {\n\t\t\t// Allow in development without database\n\t\t\treturn {\n\t\t\t\tallowed: true,\n\t\t\t\tcurrentCount: 0,\n\t\t\t\tlimit: MESSAGING_CONFIG.defaultRateLimitPerMinute,\n\t\t\t};\n\t\t}\n\n\t\t// Use the database function for atomic increment\n\t\tconst { data, error } = await supabase.rpc(\"increment_rate_limit\", {\n\t\t\tp_company_id: companyId,\n\t\t\tp_resource: \"sms\",\n\t\t\tp_identifier: identifier,\n\t\t\tp_window_size_seconds: 60,\n\t\t});\n\n\t\tif (error) {\n\t\t\ttelnyxLogger.error(\"Rate limit check failed\", {\n\t\t\t\tcompanyId,\n\t\t\t\terror: error.message,\n\t\t\t});\n\t\t\t// Fail open on database errors\n\t\t\treturn {\n\t\t\t\tallowed: true,\n\t\t\t\tcurrentCount: 0,\n\t\t\t\tlimit: MESSAGING_CONFIG.defaultRateLimitPerMinute,\n\t\t\t};\n\t\t}\n\n\t\tconst result = data?.[0] || { current_count: 1 };\n\t\tconst currentCount = result.current_count as number;\n\t\tconst limit = MESSAGING_CONFIG.defaultRateLimitPerMinute;\n\t\tconst allowed = currentCount <= limit;\n\n\t\tif (!allowed) {\n\t\t\ttelnyxLogger.warn(\"SMS rate limit exceeded\", {\n\t\t\t\tcompanyId,\n\t\t\t\tcurrentCount,\n\t\t\t\tlimit,\n\t\t\t});\n\t\t}\n\n\t\treturn { allowed, currentCount, limit };\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"Rate limit error\", {\n\t\t\tcompanyId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\t\t// Fail open\n\t\treturn {\n\t\t\tallowed: true,\n\t\t\tcurrentCount: 0,\n\t\t\tlimit: MESSAGING_CONFIG.defaultRateLimitPerMinute,\n\t\t};\n\t}\n}\n\n// =============================================================================\n// SMS SENDING\n// =============================================================================\n\n/**\n * Send an SMS message with production-ready features\n *\n * Includes:\n * - 10DLC compliance verification\n * - Rate limiting per company\n * - Retry logic with exponential backoff\n * - Structured logging\n */\nexport async function sendSMS(params: SendSMSParams): Promise<SendSMSResult> {\n\tconst warnings: string[] = [];\n\n\ttry {\n\t\ttelnyxLogger.info(\"Sending SMS\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\tto: params.to.substring(0, 6) + \"****\", // Redact for logs\n\t\t\ttextLength: params.text.length,\n\t\t});\n\n\t\t// 1. Check 10DLC compliance (unless skipped)\n\t\tif (!params.skip10DLCCheck && MESSAGING_CONFIG.warnOn10DLCMissing) {\n\t\t\tconst tenDLCStatus = await check10DLCStatus(params.companyId);\n\n\t\t\tif (!tenDLCStatus.isConfigured) {\n\t\t\t\twarnings.push(...tenDLCStatus.warnings);\n\t\t\t\ttelnyxLogger.warn(\"SMS sent without 10DLC registration\", {\n\t\t\t\t\tcompanyId: params.companyId,\n\t\t\t\t\twarnings: tenDLCStatus.warnings,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Use company's messaging profile if not provided\n\t\t\tif (!params.messagingProfileId && tenDLCStatus.messagingProfileId) {\n\t\t\t\tparams.messagingProfileId = tenDLCStatus.messagingProfileId;\n\t\t\t}\n\t\t}\n\n\t\t// 2. Check rate limit (unless skipped)\n\t\tif (!params.skipRateLimit) {\n\t\t\tconst rateLimit = await checkSMSRateLimit(params.companyId);\n\n\t\t\tif (!rateLimit.allowed) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Rate limit exceeded: ${rateLimit.currentCount}/${rateLimit.limit} messages per minute`,\n\t\t\t\t\twarnings,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// 3. Send with retry logic\n\t\tconst result = await withRetry(\n\t\t\tasync () => {\n\t\t\t\tconst requestBody = {\n\t\t\t\t\tto: params.to,\n\t\t\t\t\tfrom: params.from,\n\t\t\t\t\ttext: params.text,\n\t\t\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\t\t\twebhook_url: params.webhookUrl,\n\t\t\t\t\twebhook_failover_url: params.webhookFailoverUrl,\n\t\t\t\t\tuse_profile_webhooks: params.useProfileWebhooks ?? true,\n\t\t\t\t};\n\n\t\t\t\treturn telnyxMessageRequest(requestBody);\n\t\t\t},\n\t\t\t{\n\t\t\t\tendpoint: \"messaging:send_sms\",\n\t\t\t\tconfig: {\n\t\t\t\t\tmaxRetries: 3,\n\t\t\t\t\tbaseDelayMs: 500,\n\t\t\t\t\tmaxDelayMs: 5000,\n\t\t\t\t},\n\t\t\t}\n\t\t);\n\n\t\ttelnyxLogger.info(\"SMS sent successfully\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\tmessageId: result.data.id,\n\t\t\tstatus: result.data.status,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.data.id,\n\t\t\tdata: result.data,\n\t\t\twarnings: warnings.length > 0 ? warnings : undefined,\n\t\t};\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"SMS send failed\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to send SMS\",\n\t\t\twarnings: warnings.length > 0 ? warnings : undefined,\n\t\t};\n\t}\n}\n\n/**\n * Send an MMS message with media attachments\n */\nexport async function sendMMS(params: {\n\tcompanyId: string;\n\tto: string;\n\tfrom: string;\n\ttext?: string;\n\tmediaUrls: string[];\n\twebhookUrl?: string;\n\twebhookFailoverUrl?: string;\n\tsubject?: string;\n\tmessagingProfileId?: string;\n}): Promise<SendSMSResult> {\n\ttry {\n\t\t// Check rate limit\n\t\tconst rateLimit = await checkSMSRateLimit(params.companyId);\n\t\tif (!rateLimit.allowed) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Rate limit exceeded: ${rateLimit.currentCount}/${rateLimit.limit} messages per minute`,\n\t\t\t};\n\t\t}\n\n\t\tconst result = await withRetry(\n\t\t\tasync () => {\n\t\t\t\treturn telnyxMessageRequest({\n\t\t\t\t\tto: params.to,\n\t\t\t\t\tfrom: params.from,\n\t\t\t\t\ttext: params.text,\n\t\t\t\t\tmedia_urls: params.mediaUrls,\n\t\t\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\t\t\twebhook_url: params.webhookUrl,\n\t\t\t\t\twebhook_failover_url: params.webhookFailoverUrl,\n\t\t\t\t\tsubject: params.subject,\n\t\t\t\t\ttype: \"MMS\",\n\t\t\t\t});\n\t\t\t},\n\t\t\t{\n\t\t\t\tendpoint: \"messaging:send_mms\",\n\t\t\t\tconfig: {\n\t\t\t\t\tmaxRetries: 3,\n\t\t\t\t\tbaseDelayMs: 500,\n\t\t\t\t},\n\t\t\t}\n\t\t);\n\n\t\ttelnyxLogger.info(\"MMS sent successfully\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\tmessageId: result.data.id,\n\t\t\tmediaCount: params.mediaUrls.length,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.data.id,\n\t\t\tdata: result.data,\n\t\t};\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"MMS send failed\", {\n\t\t\tcompanyId: params.companyId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to send MMS\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// BULK SENDING (With Throttling)\n// =============================================================================\n\ninterface BulkSMSResult {\n\tsuccess: boolean;\n\ttotal: number;\n\tsuccessful: number;\n\tfailed: number;\n\tresults: Array<{ to: string; result: SendSMSResult }>;\n\terror?: string;\n}\n\n/**\n * Send bulk SMS with proper throttling and rate limiting\n *\n * Unlike naive Promise.all, this:\n * - Limits concurrent sends to prevent overwhelming the API\n * - Respects per-company rate limits\n * - Provides detailed per-recipient results\n */\nexport async function sendBulkSMS(params: {\n\tcompanyId: string;\n\tto: string[];\n\tfrom: string;\n\ttext: string;\n\twebhookUrl?: string;\n\tmessagingProfileId?: string;\n}): Promise<BulkSMSResult> {\n\tconst results: Array<{ to: string; result: SendSMSResult }> = [];\n\tlet successful = 0;\n\tlet failed = 0;\n\n\ttelnyxLogger.info(\"Starting bulk SMS\", {\n\t\tcompanyId: params.companyId,\n\t\trecipientCount: params.to.length,\n\t});\n\n\t// Process in batches to respect rate limits\n\tconst batchSize = MESSAGING_CONFIG.maxConcurrentSends;\n\n\tfor (let i = 0; i < params.to.length; i += batchSize) {\n\t\tconst batch = params.to.slice(i, i + batchSize);\n\n\t\tconst batchResults = await Promise.all(\n\t\t\tbatch.map(async (recipient) => {\n\t\t\t\tconst result = await sendSMS({\n\t\t\t\t\tcompanyId: params.companyId,\n\t\t\t\t\tto: recipient,\n\t\t\t\t\tfrom: params.from,\n\t\t\t\t\ttext: params.text,\n\t\t\t\t\twebhookUrl: params.webhookUrl,\n\t\t\t\t\tmessagingProfileId: params.messagingProfileId,\n\t\t\t\t\t// Skip 10DLC check for each message in bulk (already checked once)\n\t\t\t\t\tskip10DLCCheck: i > 0,\n\t\t\t\t});\n\n\t\t\t\treturn { to: recipient, result };\n\t\t\t})\n\t\t);\n\n\t\tfor (const r of batchResults) {\n\t\t\tresults.push(r);\n\t\t\tif (r.result.success) {\n\t\t\t\tsuccessful++;\n\t\t\t} else {\n\t\t\t\tfailed++;\n\t\t\t}\n\t\t}\n\n\t\t// Small delay between batches to smooth out rate limiting\n\t\tif (i + batchSize < params.to.length) {\n\t\t\tawait new Promise((resolve) => setTimeout(resolve, 100));\n\t\t}\n\t}\n\n\ttelnyxLogger.info(\"Bulk SMS completed\", {\n\t\tcompanyId: params.companyId,\n\t\ttotal: params.to.length,\n\t\tsuccessful,\n\t\tfailed,\n\t});\n\n\treturn {\n\t\tsuccess: failed === 0,\n\t\ttotal: params.to.length,\n\t\tsuccessful,\n\t\tfailed,\n\t\tresults,\n\t};\n}\n\n// =============================================================================\n// MESSAGE RETRIEVAL\n// =============================================================================\n\n/**\n * Retrieve message by ID\n */\nexport async function getMessage(messageId: string) {\n\ttry {\n\t\tconst message = await telnyxRequest<{ data: TelnyxMessage }>(\n\t\t\t`/messages/${messageId}`\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: message.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to retrieve message\",\n\t\t};\n\t}\n}\n\n/**\n * List messages with optional filtering\n */\nexport async function listMessages(params?: {\n\tpageSize?: number;\n\tpageNumber?: number;\n\tfilterFrom?: string;\n\tfilterTo?: string;\n\tfilterDirection?: \"inbound\" | \"outbound\";\n}) {\n\ttry {\n\t\tconst messages = await telnyxRequest<{\n\t\t\tdata: TelnyxMessage[];\n\t\t\tmeta: { total_pages: number; total_results: number };\n\t\t}>(\"/messages\", {\n\t\t\tquery: {\n\t\t\t\t\"page[size]\": params?.pageSize ?? 20,\n\t\t\t\t\"page[number]\": params?.pageNumber ?? 1,\n\t\t\t\t\"filter[from]\": params?.filterFrom,\n\t\t\t\t\"filter[to]\": params?.filterTo,\n\t\t\t\t\"filter[direction]\": params?.filterDirection,\n\t\t\t},\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: messages.data,\n\t\t\tmeta: messages.meta,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to list messages\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// UTILITIES\n// =============================================================================\n\n/**\n * Validate a phone number for SMS capability\n */\nexport function validatePhoneNumber(phoneNumber: string): {\n\tsuccess: boolean;\n\tformattedNumber?: string;\n\terror?: string;\n} {\n\ttry {\n\t\t// Remove any formatting from phone number\n\t\tconst cleanNumber = phoneNumber.replace(/\\D/g, \"\");\n\n\t\t// Check if it's a valid length (10-15 digits)\n\t\tif (cleanNumber.length < 10 || cleanNumber.length > 15) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Invalid phone number length (must be 10-15 digits)\",\n\t\t\t};\n\t\t}\n\n\t\t// Format to E.164\n\t\tconst formattedNumber = formatPhoneNumber(cleanNumber);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tformattedNumber,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to validate phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Format phone number to E.164 standard (+15551234567)\n */\nexport function formatPhoneNumber(phoneNumber: string): string {\n\t// Remove all non-digit characters except leading +\n\tconst digits = phoneNumber.replace(/[^\\d+]/g, \"\").replace(/(?!^)\\+/g, \"\");\n\n\t// Already has + prefix\n\tif (digits.startsWith(\"+\")) {\n\t\treturn digits;\n\t}\n\n\t// If it starts with 1 and is 11 digits, it's a US number\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn `+${digits}`;\n\t}\n\n\t// If it's 10 digits, assume US and add +1\n\tif (digits.length === 10) {\n\t\treturn `+1${digits}`;\n\t}\n\n\t// Otherwise, add + prefix\n\treturn `+${digits}`;\n}\n\n/**\n * Check if a phone number is a US number\n */\nexport function isUSPhoneNumber(phoneNumber: string): boolean {\n\tconst formatted = formatPhoneNumber(phoneNumber);\n\treturn formatted.startsWith(\"+1\") && formatted.length === 12;\n}\n","/**\n * Telnyx Webhooks Service - Webhook Verification & Processing\n *\n * Production-ready webhook security:\n * - MANDATORY signature verification in production (fail-closed)\n * - Timestamp validation (replay protection)\n * - Database-backed deduplication (works across serverless instances)\n * - Multi-tenant support (company_id scoping)\n * - Structured logging\n */\n\nimport crypto from \"node:crypto\";\nimport { TELNYX_CONFIG } from \"./client\";\nimport { telnyxLogger } from \"./logger\";\nimport { TelnyxWebhookError, TelnyxErrorCode } from \"./errors\";\nimport { telnyxMetrics } from \"./metrics\";\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nconst WEBHOOK_CONFIG = {\n\t// Maximum age for webhook timestamps (replay protection)\n\tmaxTimestampAgeSeconds: 300, // 5 minutes\n\t// Minimum allowed timestamp age (future timestamps)\n\tminTimestampAgeFutureSeconds: 60, // 1 minute tolerance for clock skew\n\t// Deduplication window\n\tdedupWindowMinutes: 5,\n\t// Log level for webhook events\n\tlogLevel: (process.env.TELNYX_WEBHOOK_LOG_LEVEL || \"info\") as \"debug\" | \"info\",\n};\n\n// In-memory fallback for development (NOT used in production)\nconst processedWebhooksInMemory = new Map<string, number>();\nconst DEDUP_WINDOW_MS = WEBHOOK_CONFIG.dedupWindowMinutes * 60 * 1000;\n\n/**\n * Check if we're in production mode\n * IMPORTANT: Fail closed - if NODE_ENV is not explicitly 'development', treat as production\n */\nfunction isProductionMode(): boolean {\n\treturn process.env.NODE_ENV !== \"development\";\n}\n\n/**\n * Telnyx webhook event types\n */\nexport type WebhookEventType =\n\t// Call events\n\t| \"call.initiated\"\n\t| \"call.answered\"\n\t| \"call.hangup\"\n\t| \"call.bridged\"\n\t| \"call.speak.ended\"\n\t| \"call.playback.started\"\n\t| \"call.playback.ended\"\n\t| \"call.dtmf.received\"\n\t| \"call.gather.ended\"\n\t| \"call.recording.saved\"\n\t| \"call.machine.detection.ended\"\n\t| \"call.machine.premium.detection.ended\"\n\t// Message events\n\t| \"message.sent\"\n\t| \"message.delivered\"\n\t| \"message.sending_failed\"\n\t| \"message.delivery_failed\"\n\t| \"message.received\"\n\t| \"message.finalized\"\n\t// Fax events\n\t| \"fax.received\"\n\t| \"fax.sent\"\n\t| \"fax.failed\"\n\t// Number events\n\t| \"number_reservation.created\"\n\t| \"number_reservation.deleted\"\n\t| \"number_order.created\"\n\t| \"number_order.updated\"\n\t// Conference events\n\t| \"conference.created\"\n\t| \"conference.ended\"\n\t| \"conference.participant.joined\"\n\t| \"conference.participant.left\";\n\n/**\n * Base webhook payload structure\n */\nexport type WebhookPayload = {\n\tdata: {\n\t\tevent_type: WebhookEventType;\n\t\tid: string;\n\t\toccurred_at: string;\n\t\tpayload: Record<string, unknown>;\n\t\trecord_type: string;\n\t};\n\tmeta?: {\n\t\tattempt_number: number;\n\t\tdelivered_to: string;\n\t};\n};\n\n/**\n * Call webhook payload types\n */\nexport interface CallInitiatedPayload extends WebhookPayload {\n\tdata: {\n\t\tevent_type: \"call.initiated\";\n\t\tpayload: {\n\t\t\tcall_control_id: string;\n\t\t\tcall_leg_id: string;\n\t\t\tcall_session_id: string;\n\t\t\tclient_state: string | null;\n\t\t\tconnection_id: string;\n\t\t\tdirection: \"incoming\" | \"outgoing\";\n\t\t\tfrom: string;\n\t\t\tstart_time: string;\n\t\t\tstate: \"parked\";\n\t\t\tto: string;\n\t\t};\n\t} & WebhookPayload[\"data\"];\n}\n\nexport interface CallAnsweredPayload extends WebhookPayload {\n\tdata: {\n\t\tevent_type: \"call.answered\";\n\t\tpayload: {\n\t\t\tcall_control_id: string;\n\t\t\tcall_leg_id: string;\n\t\t\tcall_session_id: string;\n\t\t\tclient_state: string | null;\n\t\t\tconnection_id: string;\n\t\t\tfrom: string;\n\t\t\tstart_time: string;\n\t\t\tstate: \"answered\";\n\t\t\tto: string;\n\t\t};\n\t} & WebhookPayload[\"data\"];\n}\n\nexport interface CallHangupPayload extends WebhookPayload {\n\tdata: {\n\t\tevent_type: \"call.hangup\";\n\t\tpayload: {\n\t\t\tcall_control_id: string;\n\t\t\tcall_leg_id: string;\n\t\t\tcall_session_id: string;\n\t\t\tclient_state: string | null;\n\t\t\tconnection_id: string;\n\t\t\tend_time: string;\n\t\t\tfrom: string;\n\t\t\thangup_cause: string;\n\t\t\thangup_source: string;\n\t\t\tsip_hangup_cause: string;\n\t\t\tstart_time: string;\n\t\t\tstate: \"hangup\";\n\t\t\tto: string;\n\t\t};\n\t} & WebhookPayload[\"data\"];\n}\n\n/**\n * Message webhook payload types\n */\nexport interface MessageReceivedPayload extends WebhookPayload {\n\tdata: {\n\t\tevent_type: \"message.received\";\n\t\tpayload: {\n\t\t\tid: string;\n\t\t\tfrom: {\n\t\t\t\tphone_number: string;\n\t\t\t\tcarrier: string;\n\t\t\t\tline_type: string;\n\t\t\t};\n\t\t\tto: Array<{\n\t\t\t\tphone_number: string;\n\t\t\t\tstatus: string;\n\t\t\t}>;\n\t\t\ttext: string;\n\t\t\tmedia: Array<{\n\t\t\t\turl: string;\n\t\t\t\tcontent_type: string;\n\t\t\t\tsize: number;\n\t\t\t}>;\n\t\t\treceived_at: string;\n\t\t\twebhook_url: string;\n\t\t\twebhook_failover_url: string;\n\t\t};\n\t} & WebhookPayload[\"data\"];\n}\n\n// =============================================================================\n// SIGNATURE VERIFICATION (FAIL-CLOSED IN PRODUCTION)\n// =============================================================================\n\n/**\n * Verify webhook signature from Telnyx\n *\n * Telnyx signs webhooks with Ed25519 using your public key.\n * The signature is sent in the `telnyx-signature-ed25519` header.\n *\n * SECURITY: This function FAILS CLOSED in production.\n * - Production: Rejects ALL webhooks if public key is not configured\n * - Development: Allows skipping verification with warning\n */\nexport function verifyWebhookSignature(params: {\n\tpayload: string | Buffer;\n\tsignature: string;\n\ttimestamp: string;\n\tcorrelationId?: string;\n}): { valid: boolean; error?: string } {\n\tconst correlationId = params.correlationId || \"unknown\";\n\tconst isProduction = isProductionMode();\n\n\ttry {\n\t\tconst publicKeyBase64 = TELNYX_CONFIG.publicKey;\n\n\t\t// CRITICAL: Fail closed in production if no public key\n\t\tif (!publicKeyBase64) {\n\t\t\tif (isProduction) {\n\t\t\t\ttelnyxLogger.error(\n\t\t\t\t\t\"SECURITY: Webhook rejected - TELNYX_PUBLIC_KEY not configured in production\",\n\t\t\t\t\t{ correlationId }\n\t\t\t\t);\n\t\t\t\treturn {\n\t\t\t\t\tvalid: false,\n\t\t\t\t\terror: \"TELNYX_PUBLIC_KEY is required in production - webhook rejected\",\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// Development only: allow with warning\n\t\t\ttelnyxLogger.warn(\n\t\t\t\t\"[DEV ONLY] Webhook signature verification skipped - TELNYX_PUBLIC_KEY not configured\",\n\t\t\t\t{ correlationId }\n\t\t\t);\n\t\t\treturn { valid: true };\n\t\t}\n\n\t\t// Validate required parameters\n\t\tif (!params.signature) {\n\t\t\ttelnyxLogger.warn(\"Webhook missing signature header\", { correlationId });\n\t\t\treturn { valid: false, error: \"Missing telnyx-signature-ed25519 header\" };\n\t\t}\n\n\t\tif (!params.timestamp) {\n\t\t\ttelnyxLogger.warn(\"Webhook missing timestamp header\", { correlationId });\n\t\t\treturn { valid: false, error: \"Missing telnyx-timestamp header\" };\n\t\t}\n\n\t\t// Build signed payload: timestamp|payload\n\t\tconst payloadBuffer = Buffer.isBuffer(params.payload)\n\t\t\t? params.payload\n\t\t\t: Buffer.from(params.payload);\n\t\tconst signedPayload = Buffer.concat([\n\t\t\tBuffer.from(params.timestamp),\n\t\t\tBuffer.from(\"|\"),\n\t\t\tpayloadBuffer,\n\t\t]);\n\n\t\t// Create public key from base64 DER format\n\t\tconst publicKey = crypto.createPublicKey({\n\t\t\tkey: Buffer.from(publicKeyBase64, \"base64\"),\n\t\t\tformat: \"der\",\n\t\t\ttype: \"spki\",\n\t\t});\n\n\t\t// Verify Ed25519 signature\n\t\tconst isValid = crypto.verify(\n\t\t\tnull, // Ed25519 doesn't use a separate hash algorithm\n\t\t\tsignedPayload,\n\t\t\tpublicKey,\n\t\t\tBuffer.from(params.signature, \"base64\")\n\t\t);\n\n\t\tif (!isValid) {\n\t\t\ttelnyxLogger.warn(\"Webhook signature verification failed - invalid signature\", {\n\t\t\t\tcorrelationId,\n\t\t\t});\n\t\t\treturn { valid: false, error: \"Invalid signature\" };\n\t\t}\n\n\t\ttelnyxLogger.debug(\"Webhook signature verified successfully\", { correlationId });\n\t\treturn { valid: true };\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"Webhook signature verification error\", {\n\t\t\tcorrelationId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: error instanceof Error ? error.message : \"Signature verification failed\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// PAYLOAD PARSING\n// =============================================================================\n\n/**\n * Parse and validate webhook payload\n */\nexport function parseWebhookPayload(\n\trawPayload: string | Buffer\n): WebhookPayload | null {\n\ttry {\n\t\tconst payload =\n\t\t\ttypeof rawPayload === \"string\"\n\t\t\t\t? JSON.parse(rawPayload)\n\t\t\t\t: JSON.parse(rawPayload.toString());\n\n\t\t// Validate required fields\n\t\tif (!(payload.data?.event_type && payload.data.payload)) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn payload as WebhookPayload;\n\t} catch {\n\t\treturn null;\n\t}\n}\n\n/**\n * Extract event type from webhook payload\n */\nexport function getEventType(payload: WebhookPayload): WebhookEventType {\n\treturn payload.data.event_type;\n}\n\n/**\n * Type guard for call events\n */\nexport function isCallEvent(eventType: WebhookEventType): boolean {\n\treturn eventType.startsWith(\"call.\");\n}\n\n/**\n * Type guard for message events\n */\nexport function isMessageEvent(eventType: WebhookEventType): boolean {\n\treturn eventType.startsWith(\"message.\");\n}\n\n/**\n * Format webhook response for Telnyx\n */\nexport function createWebhookResponse(success: boolean, message?: string) {\n\treturn {\n\t\tsuccess,\n\t\tmessage:\n\t\t\tmessage ||\n\t\t\t(success\n\t\t\t\t? \"Webhook processed successfully\"\n\t\t\t\t: \"Webhook processing failed\"),\n\t};\n}\n\n// =============================================================================\n// TIMESTAMP VALIDATION (REPLAY PROTECTION)\n// =============================================================================\n\n/**\n * Validate webhook timestamp to prevent replay attacks\n * Rejects webhooks older than 5 minutes or too far in the future\n */\nexport function isWebhookTimestampValid(\n\ttimestamp: string,\n\tmaxAgeSeconds = WEBHOOK_CONFIG.maxTimestampAgeSeconds\n): { valid: boolean; error?: string; ageSeconds?: number } {\n\ttry {\n\t\tif (!timestamp) {\n\t\t\treturn { valid: false, error: \"Missing timestamp\" };\n\t\t}\n\n\t\tlet webhookTimeMs: number;\n\n\t\tconst numericTimestamp = Number(timestamp);\n\t\tif (Number.isFinite(numericTimestamp)) {\n\t\t\t// Telnyx sends UNIX seconds as the timestamp header\n\t\t\twebhookTimeMs = numericTimestamp * 1000;\n\t\t} else {\n\t\t\tconst parsed = new Date(timestamp).getTime();\n\t\t\tif (Number.isNaN(parsed)) {\n\t\t\t\treturn { valid: false, error: \"Invalid timestamp format\" };\n\t\t\t}\n\t\t\twebhookTimeMs = parsed;\n\t\t}\n\n\t\tconst now = Date.now();\n\t\tconst ageSeconds = (now - webhookTimeMs) / 1000;\n\n\t\t// Check if too old\n\t\tif (ageSeconds > maxAgeSeconds) {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\terror: `Timestamp too old: ${Math.round(ageSeconds)}s (max ${maxAgeSeconds}s)`,\n\t\t\t\tageSeconds,\n\t\t\t};\n\t\t}\n\n\t\t// Check if too far in the future (clock skew tolerance)\n\t\tif (ageSeconds < -WEBHOOK_CONFIG.minTimestampAgeFutureSeconds) {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\terror: `Timestamp too far in future: ${Math.round(-ageSeconds)}s`,\n\t\t\t\tageSeconds,\n\t\t\t};\n\t\t}\n\n\t\treturn { valid: true, ageSeconds };\n\t} catch (error) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: error instanceof Error ? error.message : \"Timestamp validation failed\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// DATABASE-BACKED DEDUPLICATION (Multi-Tenant)\n// =============================================================================\n\n/**\n * Check if a webhook has already been processed (async, database-backed)\n *\n * @param companyId - The company ID for multi-tenant isolation\n * @param webhookId - The unique webhook ID from Telnyx\n * @param source - The webhook source (default: 'telnyx')\n */\nexport async function isWebhookDuplicateAsync(\n\tcompanyId: string,\n\twebhookId: string,\n\tsource = \"telnyx\"\n): Promise<boolean> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tif (!supabase) {\n\t\t\t// Fallback to in-memory for development\n\t\t\ttelnyxLogger.warn(\"Database not available, using in-memory deduplication\");\n\t\t\treturn isWebhookDuplicateInMemory(webhookId);\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"webhook_dedup_cache\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"webhook_id\", webhookId)\n\t\t\t.eq(\"source\", source)\n\t\t\t.gt(\"expires_at\", new Date().toISOString())\n\t\t\t.maybeSingle();\n\n\t\tif (error) {\n\t\t\ttelnyxLogger.error(\"Database dedup check failed\", { error: error.message, webhookId });\n\t\t\t// Fail open on database errors to not block webhooks\n\t\t\treturn false;\n\t\t}\n\n\t\treturn data !== null;\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"Deduplication check error\", {\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\twebhookId,\n\t\t});\n\t\t// Fail open on errors\n\t\treturn false;\n\t}\n}\n\n/**\n * Mark a webhook as processed (async, database-backed)\n *\n * @param companyId - The company ID for multi-tenant isolation\n * @param webhookId - The unique webhook ID from Telnyx\n * @param source - The webhook source (default: 'telnyx')\n */\nexport async function markWebhookProcessedAsync(\n\tcompanyId: string,\n\twebhookId: string,\n\tsource = \"telnyx\"\n): Promise<void> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tif (!supabase) {\n\t\t\t// Fallback to in-memory for development\n\t\t\tmarkWebhookProcessedInMemory(webhookId);\n\t\t\treturn;\n\t\t}\n\n\t\tconst expiresAt = new Date(Date.now() + DEDUP_WINDOW_MS).toISOString();\n\n\t\tconst { error } = await supabase.from(\"webhook_dedup_cache\").upsert(\n\t\t\t{\n\t\t\t\tcompany_id: companyId,\n\t\t\t\twebhook_id: webhookId,\n\t\t\t\tsource,\n\t\t\t\tprocessed_at: new Date().toISOString(),\n\t\t\t\texpires_at: expiresAt,\n\t\t\t},\n\t\t\t{\n\t\t\t\tonConflict: \"company_id,webhook_id,source\",\n\t\t\t\tignoreDuplicates: false,\n\t\t\t}\n\t\t);\n\n\t\tif (error) {\n\t\t\ttelnyxLogger.error(\"Failed to mark webhook as processed\", {\n\t\t\t\terror: error.message,\n\t\t\t\twebhookId,\n\t\t\t});\n\t\t}\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"Mark webhook processed error\", {\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\twebhookId,\n\t\t});\n\t}\n}\n\n/**\n * Cleanup expired webhook dedup entries\n * Call this periodically (e.g., via cron job or after processing)\n */\nexport async function cleanupExpiredWebhookDedup(): Promise<number> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tif (!supabase) {\n\t\t\tcleanupProcessedWebhooksInMemory();\n\t\t\treturn 0;\n\t\t}\n\n\t\t// Use the database function for atomic cleanup\n\t\tconst { data, error } = await supabase.rpc(\"cleanup_expired_webhook_dedup\");\n\n\t\tif (error) {\n\t\t\ttelnyxLogger.error(\"Webhook dedup cleanup failed\", { error: error.message });\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst deletedCount = data as number;\n\t\tif (deletedCount > 0) {\n\t\t\ttelnyxLogger.info(`Cleaned up ${deletedCount} expired webhook dedup entries`);\n\t\t}\n\n\t\treturn deletedCount;\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"Webhook dedup cleanup error\", {\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\t\treturn 0;\n\t}\n}\n\n// =============================================================================\n// IN-MEMORY FALLBACK (Development Only)\n// =============================================================================\n\nfunction isWebhookDuplicateInMemory(webhookId: string): boolean {\n\tcleanupProcessedWebhooksInMemory();\n\treturn processedWebhooksInMemory.has(webhookId);\n}\n\nfunction markWebhookProcessedInMemory(webhookId: string): void {\n\tprocessedWebhooksInMemory.set(webhookId, Date.now());\n}\n\nfunction cleanupProcessedWebhooksInMemory(): void {\n\tconst cutoff = Date.now() - DEDUP_WINDOW_MS;\n\tfor (const [id, timestamp] of processedWebhooksInMemory.entries()) {\n\t\tif (timestamp < cutoff) {\n\t\t\tprocessedWebhooksInMemory.delete(id);\n\t\t}\n\t}\n}\n\n// =============================================================================\n// COMPREHENSIVE WEBHOOK VALIDATION (Async, Multi-Tenant)\n// =============================================================================\n\nexport interface WebhookValidationResult {\n\tvalid: boolean;\n\terror?: string;\n\terrorCode?: TelnyxErrorCode;\n\tpayload?: WebhookPayload;\n\tisDuplicate?: boolean;\n\tcorrelationId: string;\n}\n\n/**\n * Comprehensive webhook validation (async, multi-tenant)\n *\n * Validates:\n * 1. Signature (MANDATORY in production - fail-closed)\n * 2. Timestamp (replay protection)\n * 3. Payload structure\n * 4. Deduplication (database-backed for serverless)\n *\n * @param params.companyId - Required for multi-tenant deduplication\n */\nexport async function validateWebhookAsync(params: {\n\tcompanyId: string;\n\trawPayload: string | Buffer;\n\tsignature: string;\n\ttimestamp: string;\n\tcorrelationId?: string;\n}): Promise<WebhookValidationResult> {\n\tconst correlationId =\n\t\tparams.correlationId ||\n\t\t`wh_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\n\n\ttelnyxLogger.debug(\"Validating webhook\", {\n\t\tcorrelationId,\n\t\tcompanyId: params.companyId,\n\t});\n\n\t// 1. Validate signature (FAIL-CLOSED in production)\n\tconst signatureResult = verifyWebhookSignature({\n\t\tpayload: params.rawPayload,\n\t\tsignature: params.signature,\n\t\ttimestamp: params.timestamp,\n\t\tcorrelationId,\n\t});\n\n\tif (!signatureResult.valid) {\n\t\ttelnyxMetrics.recordWebhook(false);\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: signatureResult.error || \"Invalid signature\",\n\t\t\terrorCode: TelnyxErrorCode.WEBHOOK_SIGNATURE_INVALID,\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// 2. Validate timestamp (replay protection)\n\tconst timestampResult = isWebhookTimestampValid(params.timestamp);\n\tif (!timestampResult.valid) {\n\t\ttelnyxLogger.warn(\"Webhook timestamp validation failed\", {\n\t\t\tcorrelationId,\n\t\t\terror: timestampResult.error,\n\t\t});\n\t\ttelnyxMetrics.recordWebhook(false);\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: timestampResult.error || \"Invalid timestamp\",\n\t\t\terrorCode: TelnyxErrorCode.WEBHOOK_TIMESTAMP_INVALID,\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// 3. Parse payload\n\tconst payload = parseWebhookPayload(params.rawPayload);\n\tif (!payload) {\n\t\ttelnyxLogger.warn(\"Webhook payload parsing failed\", { correlationId });\n\t\ttelnyxMetrics.recordWebhook(false);\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: \"Invalid webhook payload structure\",\n\t\t\terrorCode: TelnyxErrorCode.WEBHOOK_VALIDATION_FAILED,\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// 4. Check for duplicates (database-backed)\n\tconst webhookId = payload.data.id;\n\tif (webhookId) {\n\t\tconst isDuplicate = await isWebhookDuplicateAsync(\n\t\t\tparams.companyId,\n\t\t\twebhookId\n\t\t);\n\n\t\tif (isDuplicate) {\n\t\t\ttelnyxLogger.info(\"Duplicate webhook detected, skipping\", {\n\t\t\t\tcorrelationId,\n\t\t\t\twebhookId,\n\t\t\t\tcompanyId: params.companyId,\n\t\t\t});\n\t\t\ttelnyxMetrics.recordWebhook(true); // Count as processed\n\t\t\treturn {\n\t\t\t\tvalid: true,\n\t\t\t\tpayload,\n\t\t\t\tisDuplicate: true,\n\t\t\t\tcorrelationId,\n\t\t\t};\n\t\t}\n\n\t\t// Mark as processed\n\t\tawait markWebhookProcessedAsync(params.companyId, webhookId);\n\t}\n\n\ttelnyxLogger.info(\"Webhook validated successfully\", {\n\t\tcorrelationId,\n\t\teventType: payload.data.event_type,\n\t\twebhookId,\n\t\tcompanyId: params.companyId,\n\t});\n\n\ttelnyxMetrics.recordWebhook(true);\n\n\treturn {\n\t\tvalid: true,\n\t\tpayload,\n\t\tisDuplicate: false,\n\t\tcorrelationId,\n\t};\n}\n\n// =============================================================================\n// LEGACY SYNC API (Deprecated - use validateWebhookAsync)\n// =============================================================================\n\n/**\n * @deprecated Use validateWebhookAsync for production (supports database dedup)\n * Synchronous validation - only uses in-memory deduplication\n */\nexport function validateWebhook(params: {\n\trawPayload: string | Buffer;\n\tsignature: string;\n\ttimestamp: string;\n\tcorrelationId?: string;\n}): WebhookValidationResult {\n\tconst correlationId =\n\t\tparams.correlationId ||\n\t\t`wh_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\n\n\ttelnyxLogger.warn(\n\t\t\"Using deprecated sync validateWebhook - migrate to validateWebhookAsync\",\n\t\t{ correlationId }\n\t);\n\n\t// 1. Validate signature\n\tconst signatureResult = verifyWebhookSignature({\n\t\tpayload: params.rawPayload,\n\t\tsignature: params.signature,\n\t\ttimestamp: params.timestamp,\n\t\tcorrelationId,\n\t});\n\n\tif (!signatureResult.valid) {\n\t\ttelnyxMetrics.recordWebhook(false);\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: signatureResult.error || \"Invalid signature\",\n\t\t\terrorCode: TelnyxErrorCode.WEBHOOK_SIGNATURE_INVALID,\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// 2. Validate timestamp\n\tconst timestampResult = isWebhookTimestampValid(params.timestamp);\n\tif (!timestampResult.valid) {\n\t\ttelnyxMetrics.recordWebhook(false);\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: timestampResult.error || \"Invalid timestamp\",\n\t\t\terrorCode: TelnyxErrorCode.WEBHOOK_TIMESTAMP_INVALID,\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// 3. Parse payload\n\tconst payload = parseWebhookPayload(params.rawPayload);\n\tif (!payload) {\n\t\ttelnyxMetrics.recordWebhook(false);\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: \"Invalid webhook payload structure\",\n\t\t\terrorCode: TelnyxErrorCode.WEBHOOK_VALIDATION_FAILED,\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// 4. Check for duplicates (in-memory only - not safe for serverless!)\n\tconst webhookId = payload.data.id;\n\tif (webhookId) {\n\t\tconst isDuplicate = isWebhookDuplicateInMemory(webhookId);\n\t\tif (isDuplicate) {\n\t\t\ttelnyxMetrics.recordWebhook(true);\n\t\t\treturn {\n\t\t\t\tvalid: true,\n\t\t\t\tpayload,\n\t\t\t\tisDuplicate: true,\n\t\t\t\tcorrelationId,\n\t\t\t};\n\t\t}\n\t\tmarkWebhookProcessedInMemory(webhookId);\n\t}\n\n\ttelnyxMetrics.recordWebhook(true);\n\n\treturn {\n\t\tvalid: true,\n\t\tpayload,\n\t\tisDuplicate: false,\n\t\tcorrelationId,\n\t};\n}\n\n// =============================================================================\n// LEGACY EXPORTS (For backwards compatibility)\n// =============================================================================\n\n/** @deprecated Use isWebhookDuplicateAsync */\nexport function isWebhookDuplicate(webhookId: string): boolean {\n\treturn isWebhookDuplicateInMemory(webhookId);\n}\n\n/** @deprecated Use markWebhookProcessedAsync */\nexport function markWebhookProcessed(webhookId: string): void {\n\tmarkWebhookProcessedInMemory(webhookId);\n}\n\n/** @deprecated Internal use only */\nexport function clearProcessedWebhooks(): void {\n\tprocessedWebhooksInMemory.clear();\n}\n\n/** Get deduplication stats (in-memory only) */\nexport function getDeduplicationStats(): {\n\ttrackedWebhooks: number;\n\toldestTimestamp: number | null;\n} {\n\tcleanupProcessedWebhooksInMemory();\n\n\tlet oldestTimestamp: number | null = null;\n\tfor (const timestamp of processedWebhooksInMemory.values()) {\n\t\tif (oldestTimestamp === null || timestamp < oldestTimestamp) {\n\t\t\toldestTimestamp = timestamp;\n\t\t}\n\t}\n\n\treturn {\n\t\ttrackedWebhooks: processedWebhooksInMemory.size,\n\t\toldestTimestamp,\n\t};\n}\n"],"names":["process","env","NEXT_RUNTIME","module","exports","require","__NEXT_EXPERIMENTAL_REACT","NODE_ENV","TURBOPACK","vendored","React","ReflectAdapter","get","target","prop","receiver","value","Reflect","bind","set","has","deleteProperty","isRequestAPICallableInsideAfter","throwForSearchParamsAccessInUseCache","throwWithStaticGenerationBailoutErrorWithDynamicError","route","expression","StaticGenBailoutError","workStore","constructorOpt","error","Error","captureStackTrace","invalidDynamicUsageError","afterTaskStore","afterTaskAsyncStorage","getStore","rootTaskSpawnPhase","ReactServerDOMTurbopackServer","registerServerReference","ensureServerEntryExports","actions","i","length","action"],"mappings":"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","ignoreList":[0,1,2,3,4,5,6,7]}