module.exports=[786348,e=>{"use strict";let t={debug:0,info:1,warn:2,error:3},r=process.env.TELNYX_LOG_LEVEL||"info",n=["phone","phoneNumber","phone_number","from","to","fromNumber","toNumber","from_number","to_number","apiKey","api_key","authToken","auth_token","password","secret","token"];function s(e){let t=e.replace(/\D/g,"");return t.length<4?"****":`***${t.slice(-4)}`}function a(e){let[t,r]=e.split("@");if(!r)return"***@***";let n=t.length>2?`${t[0]}***${t[t.length-1]}`:"***";return`${n}@${r}`}class o{parent;context;constructor(e,t){this.parent=e,this.context=t}debug(e,t){this.parent.debug(e,{...this.context,...t})}info(e,t){this.parent.info(e,{...this.context,...t})}warn(e,t){this.parent.warn(e,{...this.context,...t})}error(e,t){this.parent.error(e,{...this.context,...t})}}let i=new class{service="telnyx";defaultContext={};setDefaultContext(e){this.defaultContext={...this.defaultContext,...e}}clearDefaultContext(){this.defaultContext={}}shouldLog(e){return t[e]>=t[r]}log(e,t,r){if(!this.shouldLog(e))return;let o={timestamp:new Date().toISOString(),level:e,service:this.service,message:t},i={...this.defaultContext,...r};Object.keys(i).length>0&&(o.context=function e(t,r=0){if(r>10)return"[MAX_DEPTH]";if(null==t)return t;if("string"==typeof t)return t.replace(/\+?1?\d{10,15}/g,e=>s(e)).replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,e=>a(e));if("number"==typeof t||"boolean"==typeof t)return t;if(Array.isArray(t))return t.map(t=>e(t,r+1));if("object"==typeof t){let o={};for(let[i,l]of Object.entries(t))n.some(e=>i.toLowerCase().includes(e.toLowerCase()))?"string"==typeof l?l.includes("@")?o[i]=a(l):/\d/.test(l)?o[i]=s(l):o[i]="[REDACTED]":o[i]="[REDACTED]":o[i]=e(l,r+1);return o}return t}(i));{let t=JSON.stringify(o);switch(e){case"error":console.error(t);break;case"warn":console.warn(t)}}}debug(e,t){this.log("debug",e,t)}info(e,t){this.log("info",e,t)}warn(e,t){this.log("warn",e,t)}error(e,t){this.log("error",e,t)}child(e){return new o(this,e)}logRequestStart(e,t,r){let n=r?.correlationId||`tlx_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,s=Date.now();return this.debug(`${e} ${t} started`,{...r,correlationId:n,endpoint:t}),{correlationId:n,startTime:s}}logRequestEnd(e,t,r,n,s){let a=Date.now()-n;(r>=400?this.warn.bind(this):this.info.bind(this))(`${e} ${t} completed`,{...s,endpoint:t,statusCode:r,latencyMs:a})}logRequestError(e,t,r,n,s){let a=Date.now()-n;this.error(`${e} ${t} failed`,{...s,endpoint:t,error:r.message,latencyMs:a})}};e.s(["telnyxLogger",0,i])},628123,e=>{"use strict";var t=e.i(786348);let r={maxRetries:5,baseDelayMs:1e3,maxDelayMs:32e3,jitterFactor:.3,retryableStatusCodes:[408,429,500,502,503,504],retryableErrorCodes:["ECONNRESET","ETIMEDOUT","ECONNREFUSED","EPIPE","ENOTFOUND","ENETUNREACH","EAI_AGAIN"]},n={failureThreshold:5,resetTimeoutMs:6e4,halfOpenRequests:3},s=new Map;function a(e){return s.has(e)||s.set(e,{state:"closed",failures:0,lastFailureTime:0,halfOpenSuccesses:0,halfOpenFailures:0}),s.get(e)}function o(e,r,s=n){let i=a(e),l=Date.now();r?"half-open"===i.state?(i.halfOpenSuccesses++,i.halfOpenSuccesses>=s.halfOpenRequests&&(i.state="closed",i.failures=0,i.halfOpenSuccesses=0,i.halfOpenFailures=0,t.telnyxLogger.info("Circuit breaker closed",{endpoint:e}))):"closed"===i.state&&(i.failures=0):(i.lastFailureTime=l,"half-open"===i.state?(i.halfOpenFailures++,i.state="open",i.halfOpenSuccesses=0,i.halfOpenFailures=0,t.telnyxLogger.warn("Circuit breaker reopened",{endpoint:e})):"closed"===i.state&&(i.failures++,i.failures>=s.failureThreshold&&(i.state="open",t.telnyxLogger.error("Circuit breaker opened",{endpoint:e,failures:i.failures}))))}function i(e,t){let r=Error(e);return r.name="RetryError",r.statusCode=t.statusCode,r.errorCode=t.errorCode,r.retryable=t.retryable,r.attempts=t.attempts,r.lastError=t.lastError,r}function l(e){return new Promise(t=>setTimeout(t,e))}async function u(e,s={}){let d,g={...r,...s.config},f={...n,...s.circuitBreakerConfig},m=s.endpoint||"default",h=s.correlationId||c();if(!function(e,r=n){let s=a(e),o=Date.now();return"closed"===s.state||"open"!==s.state||o-s.lastFailureTime>=r.resetTimeoutMs&&(s.state="half-open",s.halfOpenSuccesses=0,s.halfOpenFailures=0,t.telnyxLogger.info("Circuit breaker half-open",{endpoint:e}),!0)}(m,f)){let e=i(`Circuit breaker open for endpoint: ${m}`,{retryable:!1,attempts:0});throw t.telnyxLogger.warn("Request blocked by circuit breaker",{endpoint:m,correlationId:h}),e}let p=0;for(;p<=g.maxRetries;)try{let r=await e();return o(m,!0,f),p>0&&t.telnyxLogger.info("Request succeeded after retry",{endpoint:m,attempt:p,correlationId:h}),r}catch(a){d=a instanceof Error?a:Error(String(a));let e=function(e,t=r){if(!e)return!1;if(e instanceof Error){let r=e.code;if(r&&t.retryableErrorCodes.includes(r)||e.message.includes("fetch failed")||e.message.includes("network")||e.message.includes("timeout")||e.message.includes("ECONNRESET"))return!0}if("object"==typeof e&&null!==e){let r=e.statusCode||e.status;if(r&&t.retryableStatusCodes.includes(r))return!0}return!1}(a,g);if(t.telnyxLogger.warn("Request failed",{endpoint:m,attempt:p,retryable:e,error:d.message,correlationId:h}),o(m,!1,f),!e||p>=g.maxRetries)throw i(`Request failed after ${p+1} attempt(s): ${d.message}`,{retryable:e,attempts:p+1,lastError:d,statusCode:a.statusCode,errorCode:a.code});let n=function(e,t=r){let n=Math.min(t.baseDelayMs*Math.pow(2,e),t.maxDelayMs),s=n*t.jitterFactor*Math.random();return Math.floor(n+s)}(p,g);if("object"==typeof a&&null!==a&&"response"in a){let e=a.response;if(e){let t=function(e){let t=e.headers.get("Retry-After");if(!t)return null;let r=parseInt(t,10);if(!isNaN(r))return 1e3*r;let n=Date.parse(t);return isNaN(n)?null:Math.max(0,n-Date.now())}(e);t&&(n=Math.min(t,g.maxDelayMs))}}s.onRetry&&s.onRetry(p,d,n),t.telnyxLogger.info("Retrying request",{endpoint:m,attempt:p+1,delayMs:n,correlationId:h}),await l(n),p++}throw i(`Request failed after ${g.maxRetries+1} attempts`,{retryable:!1,attempts:g.maxRetries+1,lastError:d})}function c(){return`tlx_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}e.s(["generateCorrelationId",()=>c,"sleep",()=>l,"withRetry",()=>u])},381979,e=>{"use strict";var t=e.i(273568),r=e.i(786348),n=e.i(628123);async function s(e,t){let n=function(){let e=process.env.TELNYX_API_KEY;if(!e)throw Error("TELNYX_API_KEY is not configured");return e}(),s=new URL(`https://api.telnyx.com/v2${e}`);if(t?.query)for(let[e,r]of Object.entries(t.query))null!=r&&s.searchParams.set(e,String(r));r.telnyxLogger.debug("Telnyx API request",{method:t?.method||"GET",path:e});let a=new AbortController,o=t?.timeout??3e4,i=setTimeout(()=>a.abort(),o);try{let o=await fetch(s,{...t,headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`,...t?.headers||{}},signal:a.signal});clearTimeout(i);let l=await o.json();if(!o.ok){let t=l?.errors?.[0]?.detail||o.statusText,n=l?.errors?.[0]?.code;throw r.telnyxLogger.error("Telnyx API error",{status:o.status,detail:t,errorCode:n,path:e}),Error(`Telnyx ${o.status}: ${t}`)}return l}catch(t){if(clearTimeout(i),t instanceof Error&&"AbortError"===t.name)throw r.telnyxLogger.error("Telnyx API timeout",{path:e,timeoutMs:o}),Error(`Request timeout after ${o}ms`);throw t}}async function a(e){return s("/messages",{method:"POST",body:JSON.stringify(e)})}async function o(e){try{let n=await (0,t.createServiceSupabaseClient)();if(!n)return{isConfigured:!1,warnings:["Database not available - cannot verify 10DLC status"]};let{data:s,error:a}=await n.from("company_telnyx_settings").select("ten_dlc_brand_id, ten_dlc_campaign_id, messaging_profile_id, status").eq("company_id",e).maybeSingle();if(a)return r.telnyxLogger.error("Failed to check 10DLC status",{companyId:e,error:a.message}),{isConfigured:!1,warnings:["Failed to verify 10DLC status"]};if(!s)return{isConfigured:!1,warnings:["No Telnyx settings configured for company"]};let o=[];return s.ten_dlc_brand_id||o.push("10DLC brand not registered - US SMS may be filtered"),s.ten_dlc_campaign_id||o.push("10DLC campaign not registered - US SMS may be filtered"),s.messaging_profile_id||o.push("Messaging profile not configured"),{isConfigured:!!s.ten_dlc_brand_id&&!!s.ten_dlc_campaign_id&&!!s.messaging_profile_id,brandId:s.ten_dlc_brand_id||void 0,campaignId:s.ten_dlc_campaign_id||void 0,messagingProfileId:s.messaging_profile_id||void 0,warnings:o}}catch(t){return r.telnyxLogger.error("10DLC check error",{companyId:e,error:t instanceof Error?t.message:"Unknown error"}),{isConfigured:!1,warnings:["Error checking 10DLC status"]}}}async function i(e,n="default"){try{let s=await (0,t.createServiceSupabaseClient)();if(!s)return{allowed:!0,currentCount:0,limit:60};let{data:a,error:o}=await s.rpc("increment_rate_limit",{p_company_id:e,p_resource:"sms",p_identifier:n,p_window_size_seconds:60});if(o)return r.telnyxLogger.error("Rate limit check failed",{companyId:e,error:o.message}),{allowed:!0,currentCount:0,limit:60};let i=(a?.[0]||{current_count:1}).current_count,l=i<=60;return l||r.telnyxLogger.warn("SMS rate limit exceeded",{companyId:e,currentCount:i,limit:60}),{allowed:l,currentCount:i,limit:60}}catch(t){return r.telnyxLogger.error("Rate limit error",{companyId:e,error:t instanceof Error?t.message:"Unknown error"}),{allowed:!0,currentCount:0,limit:60}}}async function l(e){let t=[];try{if(r.telnyxLogger.info("Sending SMS",{companyId:e.companyId,to:e.to.substring(0,6)+"****",textLength:e.text.length}),!e.skip10DLCCheck){let n=await o(e.companyId);n.isConfigured||(t.push(...n.warnings),r.telnyxLogger.warn("SMS sent without 10DLC registration",{companyId:e.companyId,warnings:n.warnings})),!e.messagingProfileId&&n.messagingProfileId&&(e.messagingProfileId=n.messagingProfileId)}if(!e.skipRateLimit){let r=await i(e.companyId);if(!r.allowed)return{success:!1,error:`Rate limit exceeded: ${r.currentCount}/${r.limit} messages per minute`,warnings:t}}let s=await (0,n.withRetry)(async()=>{let t={to:e.to,from:e.from,text:e.text,messaging_profile_id:e.messagingProfileId,webhook_url:e.webhookUrl,webhook_failover_url:e.webhookFailoverUrl,use_profile_webhooks:e.useProfileWebhooks??!0};return a(t)},{endpoint:"messaging:send_sms",config:{maxRetries:3,baseDelayMs:500,maxDelayMs:5e3}});return r.telnyxLogger.info("SMS sent successfully",{companyId:e.companyId,messageId:s.data.id,status:s.data.status}),{success:!0,messageId:s.data.id,data:s.data,warnings:t.length>0?t:void 0}}catch(n){return r.telnyxLogger.error("SMS send failed",{companyId:e.companyId,error:n instanceof Error?n.message:"Unknown error"}),{success:!1,error:n instanceof Error?n.message:"Failed to send SMS",warnings:t.length>0?t:void 0}}}async function u(e){try{let t=await i(e.companyId);if(!t.allowed)return{success:!1,error:`Rate limit exceeded: ${t.currentCount}/${t.limit} messages per minute`};let s=await (0,n.withRetry)(async()=>a({to:e.to,from:e.from,text:e.text,media_urls:e.mediaUrls,messaging_profile_id:e.messagingProfileId,webhook_url:e.webhookUrl,webhook_failover_url:e.webhookFailoverUrl,subject:e.subject,type:"MMS"}),{endpoint:"messaging:send_mms",config:{maxRetries:3,baseDelayMs:500}});return r.telnyxLogger.info("MMS sent successfully",{companyId:e.companyId,messageId:s.data.id,mediaCount:e.mediaUrls.length}),{success:!0,messageId:s.data.id,data:s.data}}catch(t){return r.telnyxLogger.error("MMS send failed",{companyId:e.companyId,error:t instanceof Error?t.message:"Unknown error"}),{success:!1,error:t instanceof Error?t.message:"Failed to send MMS"}}}async function c(e){let t=[],n=0,s=0;r.telnyxLogger.info("Starting bulk SMS",{companyId:e.companyId,recipientCount:e.to.length});for(let r=0;r<e.to.length;r+=5){let a=e.to.slice(r,r+5);for(let o of(await Promise.all(a.map(async t=>{let n=await l({companyId:e.companyId,to:t,from:e.from,text:e.text,webhookUrl:e.webhookUrl,messagingProfileId:e.messagingProfileId,skip10DLCCheck:r>0});return{to:t,result:n}}))))t.push(o),o.result.success?n++:s++;r+5<e.to.length&&await new Promise(e=>setTimeout(e,100))}return r.telnyxLogger.info("Bulk SMS completed",{companyId:e.companyId,total:e.to.length,successful:n,failed:s}),{success:0===s,total:e.to.length,successful:n,failed:s,results:t}}async function d(e){try{let t=await s(`/messages/${e}`);return{success:!0,data:t.data}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to retrieve message"}}}async function g(e){try{let t=await s("/messages",{query:{"page[size]":e?.pageSize??20,"page[number]":e?.pageNumber??1,"filter[from]":e?.filterFrom,"filter[to]":e?.filterTo,"filter[direction]":e?.filterDirection}});return{success:!0,data:t.data,meta:t.meta}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to list messages"}}}function f(e){try{let t=e.replace(/\D/g,"");if(t.length<10||t.length>15)return{success:!1,error:"Invalid phone number length (must be 10-15 digits)"};let r=m(t);return{success:!0,formattedNumber:r}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to validate phone number"}}}function m(e){let t=e.replace(/[^\d+]/g,"").replace(/(?!^)\+/g,"");return t.startsWith("+")?t:11===t.length&&t.startsWith("1")?`+${t}`:10===t.length?`+1${t}`:`+${t}`}function h(e){let t=m(e);return t.startsWith("+1")&&12===t.length}e.s(["check10DLCStatus",()=>o,"checkSMSRateLimit",()=>i,"formatPhoneNumber",()=>m,"getMessage",()=>d,"isUSPhoneNumber",()=>h,"listMessages",()=>g,"sendBulkSMS",()=>c,"sendMMS",()=>u,"sendSMS",()=>l,"validatePhoneNumber",()=>f])}];

//# sourceMappingURL=apps_web_src_lib_telnyx_3e11bd70._.js.map