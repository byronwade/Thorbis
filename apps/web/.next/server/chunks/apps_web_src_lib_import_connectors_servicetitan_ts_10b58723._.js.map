{"version":3,"sources":["../../../../../apps/web/src/lib/import/connectors/servicetitan.ts"],"sourcesContent":["/**\n * ServiceTitan API Connector\n *\n * Features:\n * - OAuth 2.0 authentication\n * - Rate limiting (60 calls/sec per tenant)\n * - ContinueFrom token pagination\n * - Comprehensive entity support\n *\n * API Documentation: https://developer.servicetitan.io\n */\n\nimport type {\n\tDataConnectorConfig,\n\tEntityType,\n\tFetchOptions,\n\tSchemaDefinition,\n\tSchemaField,\n} from \"@/types/import\";\nimport { BaseDataConnector } from \"./base\";\n\ninterface ServiceTitanTokenResponse {\n\taccess_token: string;\n\ttoken_type: string;\n\texpires_in: number;\n\trefresh_token?: string;\n}\n\ninterface ServiceTitanPaginationInfo {\n\tcontinueFrom?: string;\n\thasMore: boolean;\n}\n\nexport class ServiceTitanConnector extends BaseDataConnector {\n\tprivate readonly baseUrl = \"https://api.servicetitan.io\";\n\tprivate readonly authUrl = \"https://auth.servicetitan.io\";\n\tprivate readonly apiVersion = \"v2\";\n\n\t// Rate limiting: 60 calls/sec per tenant\n\tprivate readonly rateLimit = 60;\n\tprivate rateLimitRemaining = 60;\n\tprivate rateLimitResetAt = new Date();\n\n\tconstructor(config: DataConnectorConfig) {\n\t\tsuper(config);\n\t}\n\n\t// ========================================================================\n\t// Authentication\n\t// ========================================================================\n\n\tasync authenticate(): Promise<{\n\t\tsuccess: boolean;\n\t\ttoken?: string;\n\t\terror?: string;\n\t}> {\n\t\ttry {\n\t\t\t// Check if we already have a valid token\n\t\t\tif (this.credentials.accessToken && this.credentials.tokenExpiry) {\n\t\t\t\tconst expiry = new Date(this.credentials.tokenExpiry);\n\t\t\t\tif (expiry > new Date()) {\n\t\t\t\t\tthis.authToken = this.credentials.accessToken;\n\t\t\t\t\tthis.authenticated = true;\n\t\t\t\t\treturn { success: true, token: this.authToken };\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Refresh token if available\n\t\t\tif (this.credentials.refreshToken) {\n\t\t\t\treturn await this.refreshAccessToken();\n\t\t\t}\n\n\t\t\t// Otherwise, get new token with client credentials\n\t\t\treturn await this.getAccessToken();\n\t\t} catch (error) {\n\t\t\tconst message =\n\t\t\t\terror instanceof Error ? error.message : \"Authentication failed\";\n\t\t\tthis.log(\"error\", \"Authentication failed\", error);\n\t\t\treturn { success: false, error: message };\n\t\t}\n\t}\n\n\tprivate async getAccessToken(): Promise<{\n\t\tsuccess: boolean;\n\t\ttoken?: string;\n\t\terror?: string;\n\t}> {\n\t\tconst { clientId, clientSecret } = this.credentials;\n\n\t\tif (!clientId || !clientSecret) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Client ID and Client Secret are required\",\n\t\t\t};\n\t\t}\n\n\t\ttry {\n\t\t\tconst response = await fetch(`${this.authUrl}/connect/token`, {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders: {\n\t\t\t\t\t\"Content-Type\": \"application/x-www-form-urlencoded\",\n\t\t\t\t},\n\t\t\t\tbody: new URLSearchParams({\n\t\t\t\t\tgrant_type: \"client_credentials\",\n\t\t\t\t\tclient_id: clientId,\n\t\t\t\t\tclient_secret: clientSecret,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst error = await response.text();\n\t\t\t\tthrow new Error(`OAuth failed: ${response.status} - ${error}`);\n\t\t\t}\n\n\t\t\tconst data: ServiceTitanTokenResponse = await response.json();\n\n\t\t\tthis.authToken = data.access_token;\n\t\t\tthis.authenticated = true;\n\n\t\t\t// Update credentials with new token\n\t\t\tthis.credentials.accessToken = data.access_token;\n\t\t\tthis.credentials.tokenExpiry = new Date(\n\t\t\t\tDate.now() + data.expires_in * 1000,\n\t\t\t).toISOString();\n\t\t\tif (data.refresh_token) {\n\t\t\t\tthis.credentials.refreshToken = data.refresh_token;\n\t\t\t}\n\n\t\t\tthis.log(\"info\", \"Successfully authenticated with ServiceTitan\");\n\t\t\treturn { success: true, token: this.authToken };\n\t\t} catch (error) {\n\t\t\tconst message =\n\t\t\t\terror instanceof Error ? error.message : \"Token request failed\";\n\t\t\tthis.log(\"error\", \"Failed to get access token\", error);\n\t\t\treturn { success: false, error: message };\n\t\t}\n\t}\n\n\tprivate async refreshAccessToken(): Promise<{\n\t\tsuccess: boolean;\n\t\ttoken?: string;\n\t\terror?: string;\n\t}> {\n\t\tconst { clientId, clientSecret, refreshToken } = this.credentials;\n\n\t\tif (!clientId || !clientSecret || !refreshToken) {\n\t\t\treturn await this.getAccessToken();\n\t\t}\n\n\t\ttry {\n\t\t\tconst response = await fetch(`${this.authUrl}/connect/token`, {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders: {\n\t\t\t\t\t\"Content-Type\": \"application/x-www-form-urlencoded\",\n\t\t\t\t},\n\t\t\t\tbody: new URLSearchParams({\n\t\t\t\t\tgrant_type: \"refresh_token\",\n\t\t\t\t\tclient_id: clientId,\n\t\t\t\t\tclient_secret: clientSecret,\n\t\t\t\t\trefresh_token: refreshToken,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\t// If refresh fails, try getting new token\n\t\t\t\treturn await this.getAccessToken();\n\t\t\t}\n\n\t\t\tconst data: ServiceTitanTokenResponse = await response.json();\n\n\t\t\tthis.authToken = data.access_token;\n\t\t\tthis.authenticated = true;\n\n\t\t\t// Update credentials\n\t\t\tthis.credentials.accessToken = data.access_token;\n\t\t\tthis.credentials.tokenExpiry = new Date(\n\t\t\t\tDate.now() + data.expires_in * 1000,\n\t\t\t).toISOString();\n\t\t\tif (data.refresh_token) {\n\t\t\t\tthis.credentials.refreshToken = data.refresh_token;\n\t\t\t}\n\n\t\t\tthis.log(\"info\", \"Successfully refreshed ServiceTitan token\");\n\t\t\treturn { success: true, token: this.authToken };\n\t\t} catch (error) {\n\t\t\tconst message =\n\t\t\t\terror instanceof Error ? error.message : \"Token refresh failed\";\n\t\t\tthis.log(\"error\", \"Failed to refresh token\", error);\n\t\t\treturn { success: false, error: message };\n\t\t}\n\t}\n\n\t// ========================================================================\n\t// Data Fetching\n\t// ========================================================================\n\n\tasync *fetchData(\n\t\tentity: EntityType,\n\t\toptions: FetchOptions,\n\t): AsyncGenerator<Record<string, unknown>, void, undefined> {\n\t\tthis.validateEntityType(entity);\n\n\t\t// Ensure authenticated\n\t\tif (!this.authenticated) {\n\t\t\tconst authResult = await this.authenticate();\n\t\t\tif (!authResult.success) {\n\t\t\t\tthrow new Error(`Authentication failed: ${authResult.error}`);\n\t\t\t}\n\t\t}\n\n\t\tconst endpoint = this.getEntityEndpoint(entity);\n\t\tlet continueFrom = options.continueFrom;\n\t\tlet hasMore = true;\n\t\tlet pageCount = 0;\n\n\t\twhile (hasMore) {\n\t\t\t// Rate limiting\n\t\t\tawait this.waitForRateLimit();\n\n\t\t\ttry {\n\t\t\t\tconst url = this.buildUrl(endpoint, {\n\t\t\t\t\tcontinueFrom,\n\t\t\t\t\tincludeDeleted: options.includeDeleted,\n\t\t\t\t\t...options.filters,\n\t\t\t\t});\n\n\t\t\t\tconst response = await this.makeRequest(url);\n\t\t\t\tconst data = await response.json();\n\n\t\t\t\t// ServiceTitan returns {data: [], continueFrom: string}\n\t\t\t\tconst records = data.data || [];\n\t\t\t\tcontinueFrom = data.continueFrom;\n\t\t\t\thasMore = !!continueFrom && records.length > 0;\n\n\t\t\t\tthis.log(\"info\", `Fetched page ${++pageCount} of ${entity}`, {\n\t\t\t\t\tcount: records.length,\n\t\t\t\t\thasMore,\n\t\t\t\t});\n\n\t\t\t\t// Yield each record\n\t\t\t\tfor (const record of records) {\n\t\t\t\t\tyield this.sanitizeData(this.transformRecord(entity, record));\n\t\t\t\t}\n\n\t\t\t\t// Update rate limit info from response headers\n\t\t\t\tthis.updateRateLimitFromHeaders(response.headers);\n\t\t\t} catch (error) {\n\t\t\t\tthis.log(\"error\", `Failed to fetch ${entity}`, error);\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t}\n\n\t\tthis.log(\"info\", `Completed fetching ${entity}`, { totalPages: pageCount });\n\t}\n\n\t// ========================================================================\n\t// Schema Definition\n\t// ========================================================================\n\n\tasync getSchema(entity: EntityType): Promise<SchemaDefinition> {\n\t\tconst schemas: Record<EntityType, SchemaDefinition> = {\n\t\t\tcustomers: {\n\t\t\t\tentity: \"customers\",\n\t\t\t\tprimaryKey: \"id\",\n\t\t\t\tfields: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"id\",\n\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tdescription: \"ServiceTitan customer ID\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"name\",\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tdescription: \"Customer name\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"type\",\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tdescription: \"residential or commercial\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"email\",\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\tdescription: \"Primary email\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"phoneNumbers\",\n\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\tdescription: \"Phone numbers\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"address\",\n\t\t\t\t\t\ttype: \"json\",\n\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\tdescription: \"Address object\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"balance\",\n\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\tdescription: \"Account balance\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"tags\",\n\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\tdescription: \"Customer tags\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"customFields\",\n\t\t\t\t\t\ttype: \"json\",\n\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\tdescription: \"Custom field values\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"createdOn\",\n\t\t\t\t\t\ttype: \"datetime\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tdescription: \"Creation timestamp\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"modifiedOn\",\n\t\t\t\t\t\ttype: \"datetime\",\n\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\tdescription: \"Last modified\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"active\",\n\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tdescription: \"Is active\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\trelationships: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"locations\",\n\t\t\t\t\t\treferencesEntity: \"properties\",\n\t\t\t\t\t\treferencesField: \"customerId\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"jobs\",\n\t\t\t\t\t\treferencesEntity: \"jobs\",\n\t\t\t\t\t\treferencesField: \"customerId\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t\tjobs: {\n\t\t\t\tentity: \"jobs\",\n\t\t\t\tprimaryKey: \"id\",\n\t\t\t\tfields: [\n\t\t\t\t\t{ name: \"id\", type: \"number\", required: true },\n\t\t\t\t\t{ name: \"jobNumber\", type: \"string\", required: true },\n\t\t\t\t\t{ name: \"customerId\", type: \"number\", required: true },\n\t\t\t\t\t{ name: \"locationId\", type: \"number\", required: false },\n\t\t\t\t\t{ name: \"jobType\", type: \"string\", required: true },\n\t\t\t\t\t{ name: \"summary\", type: \"string\", required: false },\n\t\t\t\t\t{ name: \"status\", type: \"string\", required: true },\n\t\t\t\t\t{ name: \"completedOn\", type: \"datetime\", required: false },\n\t\t\t\t\t{ name: \"total\", type: \"number\", required: false },\n\t\t\t\t\t{ name: \"technicians\", type: \"array\", required: false },\n\t\t\t\t],\n\t\t\t\trelationships: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"customerId\",\n\t\t\t\t\t\treferencesEntity: \"customers\",\n\t\t\t\t\t\treferencesField: \"id\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"locationId\",\n\t\t\t\t\t\treferencesEntity: \"properties\",\n\t\t\t\t\t\treferencesField: \"id\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t\tinvoices: {\n\t\t\t\tentity: \"invoices\",\n\t\t\t\tprimaryKey: \"id\",\n\t\t\t\tfields: [\n\t\t\t\t\t{ name: \"id\", type: \"number\", required: true },\n\t\t\t\t\t{ name: \"number\", type: \"string\", required: true },\n\t\t\t\t\t{ name: \"customerId\", type: \"number\", required: true },\n\t\t\t\t\t{ name: \"jobId\", type: \"number\", required: false },\n\t\t\t\t\t{ name: \"total\", type: \"number\", required: true },\n\t\t\t\t\t{ name: \"balance\", type: \"number\", required: true },\n\t\t\t\t\t{ name: \"status\", type: \"string\", required: true },\n\t\t\t\t\t{ name: \"dueDate\", type: \"date\", required: false },\n\t\t\t\t\t{ name: \"items\", type: \"array\", required: false },\n\t\t\t\t],\n\t\t\t\trelationships: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"customerId\",\n\t\t\t\t\t\treferencesEntity: \"customers\",\n\t\t\t\t\t\treferencesField: \"id\",\n\t\t\t\t\t},\n\t\t\t\t\t{ field: \"jobId\", referencesEntity: \"jobs\", referencesField: \"id\" },\n\t\t\t\t],\n\t\t\t},\n\t\t\t// Add more entities as needed\n\t\t} as Partial<Record<EntityType, SchemaDefinition>>;\n\n\t\tconst schema = schemas[entity];\n\t\tif (!schema) {\n\t\t\tthrow new Error(`Schema not defined for entity: ${entity}`);\n\t\t}\n\n\t\treturn schema;\n\t}\n\n\t// ========================================================================\n\t// Utilities\n\t// ========================================================================\n\n\tasync estimateRecordCount(\n\t\tentity: EntityType,\n\t\tfilters?: Record<string, unknown>,\n\t): Promise<number> {\n\t\t// ServiceTitan doesn't provide count endpoint, so we fetch first page\n\t\tconst endpoint = this.getEntityEndpoint(entity);\n\t\tconst url = this.buildUrl(endpoint, { ...filters, pageSize: 1 });\n\n\t\ttry {\n\t\t\tconst response = await this.makeRequest(url);\n\t\t\tconst data = await response.json();\n\n\t\t\t// If there's a continueFrom token, assume large dataset\n\t\t\tif (data.continueFrom) {\n\t\t\t\treturn 10000; // Estimate for planning\n\t\t\t}\n\n\t\t\treturn data.data?.length || 0;\n\t\t} catch (error) {\n\t\t\tthis.log(\"warn\", \"Failed to estimate record count, returning 0\", error);\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\tasync getRateLimitInfo(): Promise<{\n\t\tlimit: number;\n\t\tremaining: number;\n\t\tresetAt: Date;\n\t}> {\n\t\treturn {\n\t\t\tlimit: this.rateLimit,\n\t\t\tremaining: this.rateLimitRemaining,\n\t\t\tresetAt: this.rateLimitResetAt,\n\t\t};\n\t}\n\n\tprotected getSupportedEntities(): EntityType[] {\n\t\treturn [\n\t\t\t\"customers\",\n\t\t\t\"jobs\",\n\t\t\t\"invoices\",\n\t\t\t\"estimates\",\n\t\t\t\"equipment\",\n\t\t\t\"properties\",\n\t\t\t\"team\",\n\t\t\t\"appointments\",\n\t\t\t\"payments\",\n\t\t];\n\t}\n\n\t// ========================================================================\n\t// Private Helpers\n\t// ========================================================================\n\n\tprivate getEntityEndpoint(entity: EntityType): string {\n\t\tconst endpoints: Partial<Record<EntityType, string>> = {\n\t\t\tcustomers: \"/crm/v2/export/customers\",\n\t\t\tjobs: \"/jpm/v2/export/jobs\",\n\t\t\tinvoices: \"/accounting/v2/export/invoices\",\n\t\t\testimates: \"/sales/v2/export/estimates\",\n\t\t\tequipment: \"/equipment/v2/export/equipment\",\n\t\t\tproperties: \"/crm/v2/export/locations\",\n\t\t\tteam: \"/settings/v2/export/technicians\",\n\t\t\tappointments: \"/jpm/v2/export/appointments\",\n\t\t\tpayments: \"/accounting/v2/export/payments\",\n\t\t};\n\n\t\tconst endpoint = endpoints[entity];\n\t\tif (!endpoint) {\n\t\t\tthrow new Error(`Endpoint not configured for entity: ${entity}`);\n\t\t}\n\n\t\treturn endpoint;\n\t}\n\n\tprivate buildUrl(endpoint: string, params?: Record<string, unknown>): string {\n\t\tconst url = new URL(`${this.baseUrl}${endpoint}`);\n\n\t\tif (params) {\n\t\t\tObject.entries(params).forEach(([key, value]) => {\n\t\t\t\tif (value !== undefined && value !== null) {\n\t\t\t\t\turl.searchParams.append(key, String(value));\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Add tenant ID if available\n\t\tif (this.credentials.tenantId) {\n\t\t\turl.searchParams.append(\"tenant\", this.credentials.tenantId);\n\t\t}\n\n\t\treturn url.toString();\n\t}\n\n\tprivate async makeRequest(url: string): Promise<Response> {\n\t\tif (!this.authToken) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst response = await fetch(url, {\n\t\t\tmethod: \"GET\",\n\t\t\theaders: {\n\t\t\t\tAuthorization: `Bearer ${this.authToken}`,\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t},\n\t\t});\n\n\t\tif (response.status === 401) {\n\t\t\t// Try to refresh token\n\t\t\tconst authResult = await this.authenticate();\n\t\t\tif (authResult.success) {\n\t\t\t\t// Retry request\n\t\t\t\treturn this.makeRequest(url);\n\t\t\t}\n\t\t\tthrow new Error(\"Authentication expired and refresh failed\");\n\t\t}\n\n\t\tif (!response.ok) {\n\t\t\tconst errorText = await response.text();\n\t\t\tthrow new Error(\n\t\t\t\t`ServiceTitan API error: ${response.status} - ${errorText}`,\n\t\t\t);\n\t\t}\n\n\t\treturn response;\n\t}\n\n\tprivate transformRecord(\n\t\tentity: EntityType,\n\t\trecord: any,\n\t): Record<string, unknown> {\n\t\t// Transform ServiceTitan data to Stratos format\n\t\tconst transformed: Record<string, unknown> = { ...record };\n\n\t\t// Store original ID for relationship mapping\n\t\ttransformed.external_id = String(record.id);\n\n\t\t// Normalize phone numbers\n\t\tif (record.phoneNumbers && Array.isArray(record.phoneNumbers)) {\n\t\t\ttransformed.phone = record.phoneNumbers[0]?.number;\n\t\t\ttransformed.phone_numbers = record.phoneNumbers;\n\t\t}\n\n\t\t// Normalize email\n\t\tif (record.email) {\n\t\t\ttransformed.email = this.normalizeEmail(record.email);\n\t\t}\n\n\t\t// Handle address\n\t\tif (record.address) {\n\t\t\ttransformed.address = record.address.street;\n\t\t\ttransformed.city = record.address.city;\n\t\t\ttransformed.state = record.address.state;\n\t\t\ttransformed.zip = record.address.zip;\n\t\t}\n\n\t\treturn transformed;\n\t}\n\n\tprivate async waitForRateLimit(): Promise<void> {\n\t\tif (this.rateLimitRemaining <= 1) {\n\t\t\tconst now = Date.now();\n\t\t\tconst resetAt = this.rateLimitResetAt.getTime();\n\t\t\tconst waitTime = Math.max(0, resetAt - now);\n\n\t\t\tif (waitTime > 0) {\n\t\t\t\tthis.log(\"info\", `Rate limit reached, waiting ${waitTime}ms`);\n\t\t\t\tawait this.sleep(waitTime);\n\t\t\t}\n\n\t\t\t// Reset rate limit\n\t\t\tthis.rateLimitRemaining = this.rateLimit;\n\t\t\tthis.rateLimitResetAt = new Date(Date.now() + 1000); // 1 second window\n\t\t}\n\n\t\tthis.rateLimitRemaining--;\n\t}\n\n\tprivate updateRateLimitFromHeaders(headers: Headers): void {\n\t\tconst remaining = headers.get(\"x-ratelimit-remaining\");\n\t\tconst reset = headers.get(\"x-ratelimit-reset\");\n\n\t\tif (remaining) {\n\t\t\tthis.rateLimitRemaining = parseInt(remaining, 10);\n\t\t}\n\n\t\tif (reset) {\n\t\t\tthis.rateLimitResetAt = new Date(parseInt(reset, 10) * 1000);\n\t\t}\n\t}\n}\n"],"names":[],"mappings":"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"}