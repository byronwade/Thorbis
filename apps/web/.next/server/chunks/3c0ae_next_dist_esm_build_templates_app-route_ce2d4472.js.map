{"version":3,"sources":["../../../../../apps/web/src/app/api/ai/chat/route.ts","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/dist/esm/build/templates/app-route.js"],"sourcesContent":["/**\n * AI Chat API Route - Proactive Business Manager\n *\n * Features:\n * - Google Gemini as primary AI\n * - Comprehensive business tools\n * - Permission-based action control\n * - Proactive business insights\n */\n\nimport { streamText, tool } from \"ai\";\nimport { google } from \"@ai-sdk/google\";\nimport { z } from \"zod\";\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\nimport { aiAgentTools, toolCategories, type ToolCategory } from \"@/lib/ai/agent-tools\";\nimport {\n\tshouldInterceptTool,\n\tisDestructiveTool,\n\tgetDestructiveToolMetadata,\n\ttype DestructiveToolMetadata,\n} from \"@/lib/ai/action-approval\";\n\nexport const maxDuration = 60;\n\n// ============================================================================\n// COMPANY CONTEXT CACHE - Reduces AI costs by ~$300-800/month\n// Context is cached per company for 5 minutes to avoid 10 DB queries per message\n// ============================================================================\nconst companyContextCache = new Map<string, { data: string; timestamp: number }>();\nconst CONTEXT_CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes\n\nfunction getCachedContext(companyId: string): string | null {\n\tconst cached = companyContextCache.get(companyId);\n\tif (cached && Date.now() - cached.timestamp < CONTEXT_CACHE_TTL_MS) {\n\t\treturn cached.data;\n\t}\n\treturn null;\n}\n\nfunction setCachedContext(companyId: string, data: string): void {\n\tcompanyContextCache.set(companyId, { data, timestamp: Date.now() });\n\n\t// Cleanup old entries (prevent memory leak)\n\tif (companyContextCache.size > 100) {\n\t\tconst now = Date.now();\n\t\tfor (const [key, value] of companyContextCache) {\n\t\t\tif (now - value.timestamp > CONTEXT_CACHE_TTL_MS) {\n\t\t\t\tcompanyContextCache.delete(key);\n\t\t\t}\n\t\t}\n\t}\n}\n\ntype PermissionMode = \"autonomous\" | \"ask_permission\" | \"manual_only\" | \"disabled\";\n\ninterface AISettings {\n\tpermission_mode: PermissionMode;\n\taction_permissions: Record<ToolCategory, PermissionMode>;\n\tcan_make_calls: boolean;\n\tcan_send_sms: boolean;\n\tcan_send_emails: boolean;\n\tcan_create_invoices: boolean;\n\tcan_create_appointments: boolean;\n\tcan_create_customers: boolean;\n\tcan_update_customers: boolean;\n\tcan_move_funds: boolean;\n\tcan_manage_buckets: boolean;\n\tmax_transaction_amount: number;\n\tproactive_customer_outreach: boolean;\n\tproactive_financial_advice: boolean;\n\tproactive_scheduling_suggestions: boolean;\n\tcompany_context: string | null;\n\tcustom_system_prompt: string | null;\n\tpreferred_model: string;\n\tmodel_temperature: number;\n\t// New capability flags for expanded tools\n\tcan_email_team: boolean;\n\tcan_sms_team: boolean;\n\tcan_email_vendors: boolean;\n\tcan_sms_vendors: boolean;\n\tcan_schedule_reminders: boolean;\n\tcan_access_detailed_reports: boolean;\n\tcan_access_properties: boolean;\n\tcan_access_equipment: boolean;\n}\n\nasync function getAISettings(companyId: string): Promise<AISettings | null> {\n\tconst supabase = createServiceSupabaseClient();\n\tconst { data } = await supabase\n\t\t.from(\"ai_agent_settings\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.single();\n\n\treturn data as AISettings | null;\n}\n\nasync function getCompanyContext(companyId: string): Promise<string> {\n\t// Check cache first (saves ~10 DB queries per cached hit)\n\tconst cached = getCachedContext(companyId);\n\tif (cached) {\n\t\treturn cached;\n\t}\n\n\tconst supabase = createServiceSupabaseClient();\n\n\t// Get comprehensive business context in parallel\n\t// Using head: true for count-only queries to minimize data transfer\n\tconst [\n\t\tcompanyResult,\n\t\tcustomerResult,\n\t\tteamResult,\n\t\tvendorResult,\n\t\tjobResult,\n\t\tinvoiceResult,\n\t\toverdueInvoiceResult,\n\t\tappointmentResult,\n\t\tequipmentResult,\n\t\trecentJobsResult,\n\t] = await Promise.all([\n\t\t// Company info\n\t\tsupabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"name, industry, phone, email, address, city, state, zip_code, website, timezone, business_hours\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single(),\n\t\t// Active customers count (head: true = no data transfer, only count)\n\t\tsupabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id\", { count: \"exact\", head: true })\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"active\"),\n\t\t// Team members count by role\n\t\tsupabase\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"id, role\")\n\t\t\t.eq(\"company_id\", companyId),\n\t\t// Vendors count (head: true = no data transfer, only count)\n\t\tsupabase\n\t\t\t.from(\"vendors\")\n\t\t\t.select(\"id\", { count: \"exact\", head: true })\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"is_active\", true),\n\t\t// Jobs by status (limit to prevent fetching thousands)\n\t\tsupabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id, status\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.in(\"status\", [\"pending\", \"in_progress\", \"scheduled\"])\n\t\t\t.limit(500),\n\t\t// Invoices summary (limit to prevent fetching thousands)\n\t\tsupabase\n\t\t\t.from(\"invoices\")\n\t\t\t.select(\"id, status, total_amount\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.in(\"status\", [\"draft\", \"sent\", \"pending\"])\n\t\t\t.limit(500),\n\t\t// Overdue invoices (limit for performance)\n\t\tsupabase\n\t\t\t.from(\"invoices\")\n\t\t\t.select(\"id, total_amount, due_date\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"pending\")\n\t\t\t.lt(\"due_date\", new Date().toISOString())\n\t\t\t.limit(100),\n\t\t// Today's appointments\n\t\tsupabase\n\t\t\t.from(\"appointments\")\n\t\t\t.select(\"id, status\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"scheduled_start\", new Date().toISOString().split(\"T\")[0])\n\t\t\t.lt(\"scheduled_start\", new Date(Date.now() + 86400000).toISOString().split(\"T\")[0]),\n\t\t// Equipment needing maintenance\n\t\tsupabase\n\t\t\t.from(\"equipment\")\n\t\t\t.select(\"id, next_service_date\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.lt(\"next_service_date\", new Date(Date.now() + 30 * 86400000).toISOString()),\n\t\t// Recent completed jobs (last 30 days for revenue estimate)\n\t\tsupabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id, total_amount\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"completed\")\n\t\t\t.gte(\"completed_at\", new Date(Date.now() - 30 * 86400000).toISOString())\n\t\t\t.limit(500),\n\t]);\n\n\tconst company = companyResult.data;\n\tconst customerCount = customerResult.count || 0;\n\tconst teamMembers = teamResult.data || [];\n\tconst vendorCount = vendorResult.count || 0;\n\tconst activeJobs = jobResult.data || [];\n\tconst pendingInvoices = invoiceResult.data || [];\n\tconst overdueInvoices = overdueInvoiceResult.data || [];\n\tconst todayAppointments = appointmentResult.data || [];\n\tconst maintenanceDue = equipmentResult.data || [];\n\tconst recentJobs = recentJobsResult.data || [];\n\n\t// Calculate team breakdown\n\tconst teamByRole = teamMembers.reduce((acc: Record<string, number>, member) => {\n\t\tconst role = member.role || \"staff\";\n\t\tacc[role] = (acc[role] || 0) + 1;\n\t\treturn acc;\n\t}, {});\n\n\t// Calculate job breakdown\n\tconst jobsByStatus = activeJobs.reduce((acc: Record<string, number>, job) => {\n\t\tacc[job.status] = (acc[job.status] || 0) + 1;\n\t\treturn acc;\n\t}, {});\n\n\t// Calculate financial metrics\n\tconst pendingInvoiceTotal = pendingInvoices.reduce((sum, inv) => sum + (inv.total_amount || 0), 0);\n\tconst overdueTotal = overdueInvoices.reduce((sum, inv) => sum + (inv.total_amount || 0), 0);\n\tconst monthlyRevenue = recentJobs.reduce((sum, job) => sum + (job.total_amount || 0), 0);\n\n\t// Format currency helper\n\tconst formatCurrency = (cents: number) => `$${(cents / 100).toLocaleString(\"en-US\", { minimumFractionDigits: 2 })}`;\n\n\tconst context = `\n## Company Information\n- Name: ${company?.name || \"Unknown\"}\n- Industry: ${company?.industry || \"Service Business\"}\n- Phone: ${company?.phone || \"Not configured\"}\n- Email: ${company?.email || \"Not configured\"}\n- Location: ${company?.city ? `${company.city}, ${company.state} ${company.zip_code}` : \"Not configured\"}\n- Timezone: ${company?.timezone || \"America/New_York\"}\n\n## Team Overview\n- Total Team Members: ${teamMembers.length}\n${Object.entries(teamByRole).map(([role, count]) => `- ${role.charAt(0).toUpperCase() + role.slice(1)}s: ${count}`).join(\"\\n\")}\n\n## Business Metrics (Current)\n- Active Customers: ${customerCount}\n- Active Vendors: ${vendorCount}\n- Active Jobs: ${activeJobs.length} (${Object.entries(jobsByStatus).map(([status, count]) => `${count} ${status}`).join(\", \") || \"none\"})\n- Today's Appointments: ${todayAppointments.length}\n- Equipment Needing Service (next 30 days): ${maintenanceDue.length}\n\n## Financial Overview\n- Pending Invoices: ${pendingInvoices.length} (${formatCurrency(pendingInvoiceTotal)})\n- Overdue Invoices: ${overdueInvoices.length} (${formatCurrency(overdueTotal)})${overdueInvoices.length > 0 ? \" ⚠️ ATTENTION NEEDED\" : \"\"}\n- Last 30 Days Revenue: ${formatCurrency(monthlyRevenue)}\n\n## Important Alerts\n${overdueInvoices.length > 0 ? `- ${overdueInvoices.length} overdue invoice(s) totaling ${formatCurrency(overdueTotal)} need attention` : \"\"}\n${maintenanceDue.length > 0 ? `- ${maintenanceDue.length} piece(s) of equipment due for maintenance` : \"\"}\n${jobsByStatus.pending ? `- ${jobsByStatus.pending} job(s) pending assignment` : \"\"}\n${!overdueInvoices.length && !maintenanceDue.length && !jobsByStatus.pending ? \"- No urgent issues at this time\" : \"\"}\n`;\n\n\t// Cache the context for subsequent requests (saves ~10 queries per cached hit)\n\tsetCachedContext(companyId, context);\n\n\treturn context;\n}\n\nfunction buildSystemPrompt(settings: AISettings | null, companyContext: string): string {\n\tconst permissionMode = settings?.permission_mode || \"ask_permission\";\n\tconst proactiveFeatures = [];\n\n\tif (settings?.proactive_customer_outreach) proactiveFeatures.push(\"customer outreach\");\n\tif (settings?.proactive_financial_advice) proactiveFeatures.push(\"financial advice\");\n\tif (settings?.proactive_scheduling_suggestions) proactiveFeatures.push(\"scheduling optimization\");\n\n\tconst permissionInstructions = {\n\t\tautonomous: \"You can take actions directly without asking for permission. Execute tasks proactively to help the business.\",\n\t\task_permission: \"Always ask for confirmation before taking actions that modify data, send communications, or involve money. Explain what you plan to do and wait for approval.\",\n\t\tmanual_only: \"Only respond to direct questions. Do not take any actions unless explicitly instructed by the user.\",\n\t\tdisabled: \"You can only provide information and answer questions. You cannot execute any tools or take actions.\",\n\t};\n\n\treturn `You are an AI business manager assistant for a field service company. You act as a proactive manager helping owners and staff run their business efficiently.\n\n${companyContext}\n\n## Your Role\n- Help manage customers, jobs, invoices, and communications\n- Provide business insights and recommendations\n- ${proactiveFeatures.length > 0 ? `Proactively assist with: ${proactiveFeatures.join(\", \")}` : \"Respond to user requests\"}\n- Be professional, helpful, and efficient\n\n## Permission Level: ${permissionMode.toUpperCase()}\n${permissionInstructions[permissionMode]}\n\n## Available Capabilities\n${settings ? `\n### Customer Communication\n- Send Emails to Customers: ${settings.can_send_emails ? \"Yes\" : \"No\"}\n- Send SMS to Customers: ${settings.can_send_sms ? \"Yes\" : \"No\"}\n- Make Calls: ${settings.can_make_calls ? \"Yes\" : \"No\"}\n\n### Team Communication\n- Send Emails to Team: ${settings.can_email_team ? \"Yes\" : \"No\"}\n- Send SMS to Team: ${settings.can_sms_team ? \"Yes\" : \"No\"}\n\n### Vendor Communication\n- Send Emails to Vendors: ${settings.can_email_vendors ? \"Yes\" : \"No\"}\n- Send SMS to Vendors: ${settings.can_sms_vendors ? \"Yes\" : \"No\"}\n\n### Scheduling & Reminders\n- Create Appointments: ${settings.can_create_appointments ? \"Yes\" : \"No\"}\n- Schedule Reminders: ${settings.can_schedule_reminders ? \"Yes\" : \"No\"}\n\n### Financial\n- Create Invoices: ${settings.can_create_invoices ? \"Yes\" : \"No\"}\n- Move Funds: ${settings.can_move_funds ? \"Yes (max $${(settings.max_transaction_amount / 100).toFixed(2)})\" : \"No\"}\n\n### Customer Management\n- Create Customers: ${settings.can_create_customers ? \"Yes\" : \"No\"}\n- Update Customers: ${settings.can_update_customers ? \"Yes\" : \"No\"}\n\n### Data Access\n- Access Properties: ${settings.can_access_properties ? \"Yes\" : \"No\"}\n- Access Equipment: ${settings.can_access_equipment ? \"Yes\" : \"No\"}\n- Detailed Reports (job costing, revenue breakdown, AR aging): ${settings.can_access_detailed_reports ? \"Yes\" : \"No\"}\n` : \"All capabilities available (default settings)\"}\n\n## Guidelines\n1. Always search for existing customers/jobs before creating new ones\n2. Confirm customer details before sending communications\n3. For financial actions, always explain the amounts involved\n4. When scheduling, check availability first\n5. Log all communications and actions taken\n6. Provide proactive insights when relevant (overdue invoices, inactive customers, etc.)\n\n## IMPORTANT: Destructive Action Approval\nCertain actions are classified as \"destructive\" and REQUIRE owner approval before execution:\n- Sending emails, SMS, or making calls to customers, team members, or vendors\n- Creating invoices or moving funds\n- Creating or modifying appointments\n- Updating customer records\n\nWhen you attempt these actions, they will be queued for owner review instead of executing immediately.\nThe system will show a notification that owner approval is required.\nOnce a company owner approves the action, it will be executed automatically.\nIf rejected, the action will not be executed and you'll be notified.\nThis is a security measure to prevent unauthorized communications or financial actions.\n\n${settings?.custom_system_prompt ? `\\n## Additional Instructions\\n${settings.custom_system_prompt}` : \"\"}\n${settings?.company_context ? `\\n## Business Context\\n${settings.company_context}` : \"\"}\n`;\n}\n\nfunction filterToolsByPermissions(settings: AISettings | null): Record<string, typeof aiAgentTools[keyof typeof aiAgentTools]> {\n\tif (!settings) return aiAgentTools;\n\n\tconst permissionMode = settings.permission_mode;\n\tif (permissionMode === \"disabled\") return {};\n\n\tconst filteredTools: Record<string, typeof aiAgentTools[keyof typeof aiAgentTools]> = {};\n\n\tfor (const [toolName, toolInstance] of Object.entries(aiAgentTools)) {\n\t\tconst category = toolCategories[toolName];\n\t\tconst categoryPermission = settings.action_permissions?.[category] || permissionMode;\n\n\t\t// Skip if category is disabled\n\t\tif (categoryPermission === \"disabled\") continue;\n\n\t\t// Check specific capability flags - Customer Communication\n\t\tif (toolName === \"sendEmail\" && !settings.can_send_emails) continue;\n\t\tif (toolName === \"sendSms\" && !settings.can_send_sms) continue;\n\t\tif (toolName === \"initiateCall\" && !settings.can_make_calls) continue;\n\n\t\t// Team Communication\n\t\tif (toolName === \"sendTeamEmail\" && !settings.can_email_team) continue;\n\t\tif (toolName === \"sendTeamSms\" && !settings.can_sms_team) continue;\n\n\t\t// Vendor Communication\n\t\tif (toolName === \"sendVendorEmail\" && !settings.can_email_vendors) continue;\n\t\tif (toolName === \"sendVendorSms\" && !settings.can_sms_vendors) continue;\n\n\t\t// Financial\n\t\tif (toolName === \"createInvoice\" && !settings.can_create_invoices) continue;\n\t\tif (toolName === \"transferToBucket\" && !settings.can_move_funds) continue;\n\n\t\t// Scheduling\n\t\tif (toolName === \"createAppointment\" && !settings.can_create_appointments) continue;\n\n\t\t// Customers\n\t\tif (toolName === \"createCustomer\" && !settings.can_create_customers) continue;\n\t\tif (toolName === \"updateCustomer\" && !settings.can_update_customers) continue;\n\n\t\t// Reminders/Notifications\n\t\tif ((toolName === \"scheduleReminder\" || toolName === \"cancelReminder\" || toolName === \"sendImmediateNotification\") && !settings.can_schedule_reminders) continue;\n\n\t\t// Detailed Reports\n\t\tif ((toolName === \"getJobCostingReport\" || toolName === \"getRevenueBreakdown\" || toolName === \"getARAgingReport\" || toolName === \"getTeamPerformanceReport\" || toolName === \"getCustomerLifetimeValue\") && !settings.can_access_detailed_reports) continue;\n\n\t\t// Property Access\n\t\tif ((toolName === \"searchProperties\" || toolName === \"getPropertyDetails\") && !settings.can_access_properties) continue;\n\n\t\t// Equipment Access\n\t\tif ((toolName === \"searchEquipment\" || toolName === \"getMaintenanceDue\") && !settings.can_access_equipment) continue;\n\n\t\tfilteredTools[toolName] = toolInstance;\n\t}\n\n\treturn filteredTools;\n}\n\n// Request action approval tool - used when permission mode is ask_permission\nconst requestApprovalTool = tool({\n\tdescription: \"Request user approval before taking an action. Use this when you need permission to proceed.\",\n\tparameters: z.object({\n\t\taction: z.string().describe(\"The action you want to take\"),\n\t\treason: z.string().describe(\"Why this action is beneficial\"),\n\t\tdetails: z.string().describe(\"Specific details of what will happen\"),\n\t}),\n\texecute: async ({ action, reason, details }) => {\n\t\treturn {\n\t\t\trequiresApproval: true,\n\t\t\taction,\n\t\t\treason,\n\t\t\tdetails,\n\t\t\tmessage: `I'd like to ${action}. ${reason}. This will: ${details}. Do you approve?`,\n\t\t};\n\t},\n});\n\n/**\n * Wrap destructive tools with owner approval interception\n * When a destructive tool is called, instead of executing it directly,\n * we create a pending action and return a message asking for owner approval.\n */\nfunction wrapToolsWithApprovalCheck(\n\ttools: Record<string, typeof aiAgentTools[keyof typeof aiAgentTools]>,\n\tcontext: {\n\t\tcompanyId: string;\n\t\tuserId: string;\n\t\tchatId: string;\n\t\tmessageId: string;\n\t}\n): Record<string, typeof aiAgentTools[keyof typeof aiAgentTools]> {\n\tconst wrappedTools: Record<string, typeof aiAgentTools[keyof typeof aiAgentTools]> = {};\n\n\tfor (const [toolName, toolInstance] of Object.entries(tools)) {\n\t\t// Check if this tool is destructive and requires owner approval\n\t\tconst metadata = getDestructiveToolMetadata(toolName);\n\n\t\tif (metadata && metadata.requiresOwnerApproval) {\n\t\t\t// Wrap the tool to intercept and require approval\n\t\t\twrappedTools[toolName] = tool({\n\t\t\t\tdescription: toolInstance.description,\n\t\t\t\tparameters: toolInstance.parameters,\n\t\t\t\texecute: async (args: Record<string, unknown>) => {\n\t\t\t\t\t// Intercept the tool call and create a pending action\n\t\t\t\t\tconst interception = await shouldInterceptTool(\n\t\t\t\t\t\ttoolName,\n\t\t\t\t\t\targs,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcompanyId: context.companyId,\n\t\t\t\t\t\t\tchatId: context.chatId,\n\t\t\t\t\t\t\tmessageId: context.messageId,\n\t\t\t\t\t\t\tuserId: context.userId,\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\n\t\t\t\t\tif (interception.intercept) {\n\t\t\t\t\t\tif (interception.error) {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\t\trequiresOwnerApproval: true,\n\t\t\t\t\t\t\t\terror: interception.error,\n\t\t\t\t\t\t\t\tmessage: `Failed to create approval request: ${interception.error}`,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Return a message indicating approval is needed\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\trequiresOwnerApproval: true,\n\t\t\t\t\t\t\tpendingActionId: interception.pendingActionId,\n\t\t\t\t\t\t\triskLevel: metadata.riskLevel,\n\t\t\t\t\t\t\tactionType: metadata.actionType,\n\t\t\t\t\t\t\tmessage: `⚠️ This action requires owner approval before it can be executed.\n\n**Action:** ${metadata.description}\n**Risk Level:** ${metadata.riskLevel.toUpperCase()}\n**Affected:** ${metadata.affectedEntityType}\n\nThe action has been queued for owner review. Once a company owner approves this action, it will be executed automatically.\n\nPending Action ID: ${interception.pendingActionId}`,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\t// If no interception needed, execute the original tool\n\t\t\t\t\t// (This shouldn't happen for destructive tools, but fallback just in case)\n\t\t\t\t\tif (typeof toolInstance.execute === \"function\") {\n\t\t\t\t\t\treturn await toolInstance.execute(args);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn { success: false, error: \"Tool execution not available\" };\n\t\t\t\t},\n\t\t\t}) as typeof aiAgentTools[keyof typeof aiAgentTools];\n\t\t} else {\n\t\t\t// Non-destructive tools pass through unchanged\n\t\t\twrappedTools[toolName] = toolInstance;\n\t\t}\n\t}\n\n\treturn wrappedTools;\n}\n\nexport async function POST(req: Request) {\n\ttry {\n\t\tconst {\n\t\t\tmessages,\n\t\t\tcompanyId: providedCompanyId,\n\t\t\tuserId: providedUserId,\n\t\t\tchatId: providedChatId,\n\t\t\tmodel: requestedModel,\n\t\t} = await req.json();\n\n\t\tif (!(messages && Array.isArray(messages))) {\n\t\t\treturn Response.json({ error: \"Messages are required\" }, { status: 400 });\n\t\t}\n\n\t\t// Get company ID from auth or use provided (for demo)\n\t\tconst companyId = providedCompanyId || process.env.DEFAULT_COMPANY_ID;\n\n\t\tif (!companyId) {\n\t\t\treturn Response.json({ error: \"Company ID required\" }, { status: 400 });\n\t\t}\n\n\t\t// Get user ID (required for destructive action tracking)\n\t\tconst userId = providedUserId || \"anonymous\";\n\n\t\t// Get or generate chat ID\n\t\tconst chatId = providedChatId || crypto.randomUUID();\n\n\t\t// Generate a unique message ID for this request\n\t\tconst messageId = crypto.randomUUID();\n\n\t\t// Load AI settings and company context\n\t\tconst [settings, companyContext] = await Promise.all([\n\t\t\tgetAISettings(companyId),\n\t\t\tgetCompanyContext(companyId),\n\t\t]);\n\n\t\t// Build system prompt based on settings\n\t\tconst systemPrompt = buildSystemPrompt(settings, companyContext);\n\n\t\t// Filter tools based on permissions\n\t\tlet availableTools = filterToolsByPermissions(settings);\n\n\t\t// Wrap destructive tools with owner approval interception\n\t\t// This ensures ALL destructive actions require owner approval before execution\n\t\tavailableTools = wrapToolsWithApprovalCheck(availableTools, {\n\t\t\tcompanyId,\n\t\t\tuserId,\n\t\t\tchatId,\n\t\t\tmessageId,\n\t\t});\n\n\t\t// Add approval tool if in ask_permission mode\n\t\tif (settings?.permission_mode === \"ask_permission\") {\n\t\t\tavailableTools.requestApproval = requestApprovalTool;\n\t\t}\n\n\t\t// Determine model - using Google Gemini\n\t\tconst modelId = requestedModel || settings?.preferred_model || \"gemini-2.0-flash-exp\";\n\t\tconst temperature = settings?.model_temperature || 0.7;\n\n\t\t// Create model instance\n\t\tconst model = google(modelId);\n\n\t\t// Create tool context with company ID\n\t\tconst toolContext = { companyId };\n\n\t\t// Stream the response\n\t\tconst result = streamText({\n\t\t\tmodel,\n\t\t\tmessages,\n\t\t\ttemperature,\n\t\t\tsystem: systemPrompt,\n\t\t\ttools: availableTools,\n\t\t\tmaxSteps: 5, // Reduced from 10 to lower AI costs (15-20% savings)\n\t\t\texperimental_toolCallStreaming: true,\n\t\t\tonStepFinish: async ({ toolCalls, toolResults }) => {\n\t\t\t\t// Log AI actions to the database\n\t\t\t\tif (toolCalls && toolCalls.length > 0) {\n\t\t\t\t\tconst supabase = createServiceSupabaseClient();\n\t\t\t\t\tfor (const call of toolCalls) {\n\t\t\t\t\t\tconst category = toolCategories[call.toolName] || \"system\";\n\t\t\t\t\t\tconst result = toolResults?.find((r) => r.toolCallId === call.toolCallId);\n\n\t\t\t\t\t\tawait supabase.from(\"ai_action_log\").insert({\n\t\t\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\t\t\taction_type: category,\n\t\t\t\t\t\t\taction_name: call.toolName,\n\t\t\t\t\t\t\taction_description: JSON.stringify(call.args),\n\t\t\t\t\t\t\tpermission_mode: settings?.permission_mode || \"ask_permission\",\n\t\t\t\t\t\t\tpermission_requested: settings?.permission_mode === \"ask_permission\",\n\t\t\t\t\t\t\tpermission_granted: settings?.permission_mode === \"autonomous\",\n\t\t\t\t\t\t\tstatus: result?.result?.success ? \"executed\" : \"failed\",\n\t\t\t\t\t\t\tinput_data: call.args,\n\t\t\t\t\t\t\toutput_data: result?.result,\n\t\t\t\t\t\t\texecuted_at: new Date().toISOString(),\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\n\t\treturn result.toDataStreamResponse();\n\t} catch (error) {\n\t\tconsole.error(\"AI Chat Error:\", error);\n\t\treturn Response.json(\n\t\t\t{ error: error instanceof Error ? error.message : \"Unknown error\" },\n\t\t\t{ status: 500 },\n\t\t);\n\t}\n}\n","import { AppRouteRouteModule } from \"next/dist/esm/server/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/esm/server/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/esm/server/lib/patch-fetch\";\nimport { addRequestMeta, getRequestMeta } from \"next/dist/esm/server/request-meta\";\nimport { getTracer, SpanKind } from \"next/dist/esm/server/lib/trace/tracer\";\nimport { setReferenceManifestsSingleton } from \"next/dist/esm/server/app-render/encryption-utils\";\nimport { createServerModuleMap } from \"next/dist/esm/server/app-render/action-utils\";\nimport { normalizeAppPath } from \"next/dist/esm/shared/lib/router/utils/app-paths\";\nimport { NodeNextRequest, NodeNextResponse } from \"next/dist/esm/server/base-http/node\";\nimport { NextRequestAdapter, signalFromNodeResponse } from \"next/dist/esm/server/web/spec-extension/adapters/next-request\";\nimport { BaseServerSpan } from \"next/dist/esm/server/lib/trace/constants\";\nimport { getRevalidateReason } from \"next/dist/esm/server/instrumentation/utils\";\nimport { sendResponse } from \"next/dist/esm/server/send-response\";\nimport { fromNodeOutgoingHttpHeaders, toNodeOutgoingHttpHeaders } from \"next/dist/esm/server/web/utils\";\nimport { getCacheControlHeader } from \"next/dist/esm/server/lib/cache-control\";\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from \"next/dist/esm/lib/constants\";\nimport { NoFallbackError } from \"next/dist/esm/shared/lib/no-fallback-error.external\";\nimport { CachedRouteKind } from \"next/dist/esm/server/response-cache\";\nimport * as userland from \"INNER_APP_ROUTE\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/ai/chat/route\",\n        pathname: \"/api/ai/chat\",\n        filename: \"route\",\n        bundlePath: \"\"\n    },\n    distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n    relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n    resolvedPagePath: \"[project]/apps/web/src/app/api/ai/chat/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return _patchFetch({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\nexport { routeModule, workAsyncStorage, workUnitAsyncStorage, serverHooks, patchFetch,  };\nexport async function handler(req, res, ctx) {\n    if (routeModule.isDev) {\n        addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint());\n    }\n    let srcPage = \"/api/ai/chat/route\";\n    // turbopack doesn't normalize `/index` in the page name\n    // so we need to to process dynamic routes properly\n    // TODO: fix turbopack providing differing value from webpack\n    if (process.env.TURBOPACK) {\n        srcPage = srcPage.replace(/\\/index$/, '') || '/';\n    } else if (srcPage === '/index') {\n        // we always normalize /index specifically\n        srcPage = '/';\n    }\n    const multiZoneDraftMode = process.env.__NEXT_MULTI_ZONE_DRAFT_MODE;\n    const prepareResult = await routeModule.prepare(req, res, {\n        srcPage,\n        multiZoneDraftMode\n    });\n    if (!prepareResult) {\n        res.statusCode = 400;\n        res.end('Bad Request');\n        ctx.waitUntil == null ? void 0 : ctx.waitUntil.call(ctx, Promise.resolve());\n        return null;\n    }\n    const { buildId, params, nextConfig, parsedUrl, isDraftMode, prerenderManifest, routerServerContext, isOnDemandRevalidate, revalidateOnlyGenerated, resolvedPathname, clientReferenceManifest, serverActionsManifest } = prepareResult;\n    const normalizedSrcPage = normalizeAppPath(srcPage);\n    let isIsr = Boolean(prerenderManifest.dynamicRoutes[normalizedSrcPage] || prerenderManifest.routes[resolvedPathname]);\n    const render404 = async ()=>{\n        // TODO: should route-module itself handle rendering the 404\n        if (routerServerContext == null ? void 0 : routerServerContext.render404) {\n            await routerServerContext.render404(req, res, parsedUrl, false);\n        } else {\n            res.end('This page could not be found');\n        }\n        return null;\n    };\n    if (isIsr && !isDraftMode) {\n        const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname]);\n        const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage];\n        if (prerenderInfo) {\n            if (prerenderInfo.fallback === false && !isPrerendered) {\n                if (nextConfig.experimental.adapterPath) {\n                    return await render404();\n                }\n                throw new NoFallbackError();\n            }\n        }\n    }\n    let cacheKey = null;\n    if (isIsr && !routeModule.isDev && !isDraftMode) {\n        cacheKey = resolvedPathname;\n        // ensure /index and / is normalized to one key\n        cacheKey = cacheKey === '/index' ? '/' : cacheKey;\n    }\n    const supportsDynamicResponse = // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true || // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr;\n    // This is a revalidation request if the request is for a static\n    // page and it is not being resumed from a postponed render and\n    // it is not a dynamic RSC request then it is a revalidation\n    // request.\n    const isStaticGeneration = isIsr && !supportsDynamicResponse;\n    // Before rendering (which initializes component tree modules), we have to\n    // set the reference manifests to our global store so Server Action's\n    // encryption util can access to them at the top level of the page module.\n    if (serverActionsManifest && clientReferenceManifest) {\n        setReferenceManifestsSingleton({\n            page: srcPage,\n            clientReferenceManifest,\n            serverActionsManifest,\n            serverModuleMap: createServerModuleMap({\n                serverActionsManifest\n            })\n        });\n    }\n    const method = req.method || 'GET';\n    const tracer = getTracer();\n    const activeSpan = tracer.getActiveScopeSpan();\n    const context = {\n        params,\n        prerenderManifest,\n        renderOpts: {\n            experimental: {\n                authInterrupts: Boolean(nextConfig.experimental.authInterrupts)\n            },\n            cacheComponents: Boolean(nextConfig.cacheComponents),\n            supportsDynamicResponse,\n            incrementalCache: getRequestMeta(req, 'incrementalCache'),\n            cacheLifeProfiles: nextConfig.cacheLife,\n            waitUntil: ctx.waitUntil,\n            onClose: (cb)=>{\n                res.on('close', cb);\n            },\n            onAfterTaskError: undefined,\n            onInstrumentationRequestError: (error, _request, errorContext)=>routeModule.onRequestError(req, error, errorContext, routerServerContext)\n        },\n        sharedContext: {\n            buildId\n        }\n    };\n    const nodeNextReq = new NodeNextRequest(req);\n    const nodeNextRes = new NodeNextResponse(res);\n    const nextReq = NextRequestAdapter.fromNodeNextRequest(nodeNextReq, signalFromNodeResponse(res));\n    try {\n        const invokeRouteModule = async (span)=>{\n            return routeModule.handle(nextReq, context).finally(()=>{\n                if (!span) return;\n                span.setAttributes({\n                    'http.status_code': res.statusCode,\n                    'next.rsc': false\n                });\n                const rootSpanAttributes = tracer.getRootSpanAttributes();\n                // We were unable to get attributes, probably OTEL is not enabled\n                if (!rootSpanAttributes) {\n                    return;\n                }\n                if (rootSpanAttributes.get('next.span_type') !== BaseServerSpan.handleRequest) {\n                    console.warn(`Unexpected root span type '${rootSpanAttributes.get('next.span_type')}'. Please report this Next.js issue https://github.com/vercel/next.js`);\n                    return;\n                }\n                const route = rootSpanAttributes.get('next.route');\n                if (route) {\n                    const name = `${method} ${route}`;\n                    span.setAttributes({\n                        'next.route': route,\n                        'http.route': route,\n                        'next.span_name': name\n                    });\n                    span.updateName(name);\n                } else {\n                    span.updateName(`${method} ${srcPage}`);\n                }\n            });\n        };\n        const isMinimalMode = Boolean(process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode'));\n        const handleResponse = async (currentSpan)=>{\n            var _cacheEntry_value;\n            const responseGenerator = async ({ previousCacheEntry })=>{\n                try {\n                    if (!isMinimalMode && isOnDemandRevalidate && revalidateOnlyGenerated && !previousCacheEntry) {\n                        res.statusCode = 404;\n                        // on-demand revalidate always sets this header\n                        res.setHeader('x-nextjs-cache', 'REVALIDATED');\n                        res.end('This page could not be found');\n                        return null;\n                    }\n                    const response = await invokeRouteModule(currentSpan);\n                    req.fetchMetrics = context.renderOpts.fetchMetrics;\n                    let pendingWaitUntil = context.renderOpts.pendingWaitUntil;\n                    // Attempt using provided waitUntil if available\n                    // if it's not we fallback to sendResponse's handling\n                    if (pendingWaitUntil) {\n                        if (ctx.waitUntil) {\n                            ctx.waitUntil(pendingWaitUntil);\n                            pendingWaitUntil = undefined;\n                        }\n                    }\n                    const cacheTags = context.renderOpts.collectedTags;\n                    // If the request is for a static response, we can cache it so long\n                    // as it's not edge.\n                    if (isIsr) {\n                        const blob = await response.blob();\n                        // Copy the headers from the response.\n                        const headers = toNodeOutgoingHttpHeaders(response.headers);\n                        if (cacheTags) {\n                            headers[NEXT_CACHE_TAGS_HEADER] = cacheTags;\n                        }\n                        if (!headers['content-type'] && blob.type) {\n                            headers['content-type'] = blob.type;\n                        }\n                        const revalidate = typeof context.renderOpts.collectedRevalidate === 'undefined' || context.renderOpts.collectedRevalidate >= INFINITE_CACHE ? false : context.renderOpts.collectedRevalidate;\n                        const expire = typeof context.renderOpts.collectedExpire === 'undefined' || context.renderOpts.collectedExpire >= INFINITE_CACHE ? undefined : context.renderOpts.collectedExpire;\n                        // Create the cache entry for the response.\n                        const cacheEntry = {\n                            value: {\n                                kind: CachedRouteKind.APP_ROUTE,\n                                status: response.status,\n                                body: Buffer.from(await blob.arrayBuffer()),\n                                headers\n                            },\n                            cacheControl: {\n                                revalidate,\n                                expire\n                            }\n                        };\n                        return cacheEntry;\n                    } else {\n                        // send response without caching if not ISR\n                        await sendResponse(nodeNextReq, nodeNextRes, response, context.renderOpts.pendingWaitUntil);\n                        return null;\n                    }\n                } catch (err) {\n                    // if this is a background revalidate we need to report\n                    // the request error here as it won't be bubbled\n                    if (previousCacheEntry == null ? void 0 : previousCacheEntry.isStale) {\n                        await routeModule.onRequestError(req, err, {\n                            routerKind: 'App Router',\n                            routePath: srcPage,\n                            routeType: 'route',\n                            revalidateReason: getRevalidateReason({\n                                isStaticGeneration,\n                                isOnDemandRevalidate\n                            })\n                        }, routerServerContext);\n                    }\n                    throw err;\n                }\n            };\n            const cacheEntry = await routeModule.handleResponse({\n                req,\n                nextConfig,\n                cacheKey,\n                routeKind: RouteKind.APP_ROUTE,\n                isFallback: false,\n                prerenderManifest,\n                isRoutePPREnabled: false,\n                isOnDemandRevalidate,\n                revalidateOnlyGenerated,\n                responseGenerator,\n                waitUntil: ctx.waitUntil,\n                isMinimalMode\n            });\n            // we don't create a cacheEntry for ISR\n            if (!isIsr) {\n                return null;\n            }\n            if ((cacheEntry == null ? void 0 : (_cacheEntry_value = cacheEntry.value) == null ? void 0 : _cacheEntry_value.kind) !== CachedRouteKind.APP_ROUTE) {\n                var _cacheEntry_value1;\n                throw Object.defineProperty(new Error(`Invariant: app-route received invalid cache entry ${cacheEntry == null ? void 0 : (_cacheEntry_value1 = cacheEntry.value) == null ? void 0 : _cacheEntry_value1.kind}`), \"__NEXT_ERROR_CODE\", {\n                    value: \"E701\",\n                    enumerable: false,\n                    configurable: true\n                });\n            }\n            if (!isMinimalMode) {\n                res.setHeader('x-nextjs-cache', isOnDemandRevalidate ? 'REVALIDATED' : cacheEntry.isMiss ? 'MISS' : cacheEntry.isStale ? 'STALE' : 'HIT');\n            }\n            // Draft mode should never be cached\n            if (isDraftMode) {\n                res.setHeader('Cache-Control', 'private, no-cache, no-store, max-age=0, must-revalidate');\n            }\n            const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers);\n            if (!(isMinimalMode && isIsr)) {\n                headers.delete(NEXT_CACHE_TAGS_HEADER);\n            }\n            // If cache control is already set on the response we don't\n            // override it to allow users to customize it via next.config\n            if (cacheEntry.cacheControl && !res.getHeader('Cache-Control') && !headers.get('Cache-Control')) {\n                headers.set('Cache-Control', getCacheControlHeader(cacheEntry.cacheControl));\n            }\n            await sendResponse(nodeNextReq, nodeNextRes, // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n            new Response(cacheEntry.value.body, {\n                headers,\n                status: cacheEntry.value.status || 200\n            }));\n            return null;\n        };\n        // TODO: activeSpan code path is for when wrapped by\n        // next-server can be removed when this is no longer used\n        if (activeSpan) {\n            await handleResponse(activeSpan);\n        } else {\n            await tracer.withPropagatedContext(req.headers, ()=>tracer.trace(BaseServerSpan.handleRequest, {\n                    spanName: `${method} ${srcPage}`,\n                    kind: SpanKind.SERVER,\n                    attributes: {\n                        'http.method': method,\n                        'http.target': req.url\n                    }\n                }, handleResponse));\n        }\n    } catch (err) {\n        if (!(err instanceof NoFallbackError)) {\n            await routeModule.onRequestError(req, err, {\n                routerKind: 'App Router',\n                routePath: normalizedSrcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                    isStaticGeneration,\n                    isOnDemandRevalidate\n                })\n            });\n        }\n        // rethrow so that we can handle serving error page\n        // If this is during static generation, throw the error again.\n        if (isIsr) throw err;\n        // Otherwise, send a 500 response.\n        await sendResponse(nodeNextReq, nodeNextRes, new Response(null, {\n            status: 500\n        }));\n        return null;\n    }\n}\n\n//# sourceMappingURL=app-route.js.map\n"],"names":[],"mappings":"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","ignoreList":[1]}