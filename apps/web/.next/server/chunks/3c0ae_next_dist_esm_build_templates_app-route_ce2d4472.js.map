{"version":3,"sources":["../../../../../apps/web/src/app/api/ai/chat/route.ts","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/dist/esm/build/templates/app-route.js"],"sourcesContent":["/**\n * AI Chat API Route - Proactive Business Manager\n *\n * Features:\n * - Groq as the exclusive AI provider (free tier with generous limits)\n * - Comprehensive business tools (86+ tools)\n * - Permission-based action control\n * - Proactive business insights\n */\n\nimport { convertToModelMessages, generateText, jsonSchema, stepCountIs, streamText, tool } from \"ai\";\nimport { z } from \"zod\";\nimport {\n\ttype DestructiveToolMetadata,\n\tgetDestructiveToolMetadata,\n\tisDestructiveTool,\n\tshouldInterceptTool,\n} from \"@/lib/ai/action-approval\";\nimport {\n\taiAgentTools,\n\ttype ToolCategory,\n\ttoolCategories,\n} from \"@/lib/ai/agent-tools\";\nimport { createAIProvider, type AIProvider } from \"@/lib/ai/config\";\nimport { createServiceSupabaseClient } from \"@stratos/database\";\nimport { trackExternalApiCall } from \"@/lib/analytics/external-api-tracker\";\n\nexport const maxDuration = 60;\n\n// ============================================================================\n// MESSAGE PERSISTENCE - Save chat history to Supabase\n// ============================================================================\n\ninterface MessagePart {\n\ttype: string;\n\ttext?: string;\n\ttoolName?: string;\n\ttoolCallId?: string;\n\targs?: unknown;\n\tresult?: unknown;\n}\n\n/**\n * UUID validation regex\n */\nconst UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\n\nfunction isValidUUID(str: string): boolean {\n\treturn UUID_REGEX.test(str);\n}\n\n/**\n * Generate a meaningful chat title using AI\n * Runs asynchronously after chat creation to avoid blocking\n */\nasync function generateChatTitleWithAI(\n\tsupabase: Awaited<ReturnType<typeof createServiceSupabaseClient>>,\n\tchatId: string,\n\tfirstMessage: string,\n): Promise<void> {\n\tif (!supabase || !firstMessage.trim()) return;\n\n\ttry {\n\t\t// Use Groq for title generation (free)\n\t\tif (!process.env.GROQ_API_KEY) {\n\t\t\tconsole.log(\"[AI Chat API] No GROQ_API_KEY available for title generation\");\n\t\t\treturn;\n\t\t}\n\n\t\tconst model = createAIProvider({ provider: \"groq\", model: \"llama-3.3-70b-versatile\" });\n\n\t\tconst { text: title } = await generateText({\n\t\t\tmodel,\n\t\t\tprompt: `Generate a very brief, descriptive title (3-6 words max) for a conversation that starts with this message. Return ONLY the title, no quotes or extra text.\n\nMessage: \"${firstMessage.slice(0, 500)}\"\n\nTitle:`,\n\t\t\tmaxOutputTokens: 30, // AI SDK 5: maxTokens renamed to maxOutputTokens\n\t\t\ttemperature: 0.3,\n\t\t});\n\n\t\t// Clean up the title\n\t\tlet cleanTitle = title\n\t\t\t.trim()\n\t\t\t.replace(/^[\"']|[\"']$/g, \"\") // Remove surrounding quotes\n\t\t\t.replace(/^Title:\\s*/i, \"\") // Remove \"Title:\" prefix if AI added it\n\t\t\t.slice(0, 100); // Ensure max length\n\n\t\t// Capitalize first letter\n\t\tif (cleanTitle) {\n\t\t\tcleanTitle = cleanTitle.charAt(0).toUpperCase() + cleanTitle.slice(1);\n\t\t}\n\n\t\tif (cleanTitle && cleanTitle !== \"New Chat\") {\n\t\t\tawait supabase\n\t\t\t\t.from(\"chats\")\n\t\t\t\t.update({ title: cleanTitle, updated_at: new Date().toISOString() })\n\t\t\t\t.eq(\"id\", chatId);\n\n\t\t\tconsole.log(\"[AI Chat API] Generated title for chat:\", chatId, \"->\", cleanTitle);\n\t\t}\n\t} catch (error) {\n\t\t// Non-critical error - just log and continue\n\t\tconsole.error(\"[AI Chat API] Title generation failed:\", error);\n\t}\n}\n\n/**\n * Ensure a chat exists, creating one if needed\n * Returns canPersist: false if persistence is not possible (invalid UUIDs, no supabase, etc.)\n */\nasync function ensureChat(\n\tsupabase: Awaited<ReturnType<typeof createServiceSupabaseClient>>,\n\tchatId: string,\n\tuserId: string,\n\tcompanyId: string,\n\tfirstMessageContent?: string,\n): Promise<{ id: string; isNew: boolean; canPersist: boolean }> {\n\t// If no supabase, skip persistence\n\tif (!supabase) {\n\t\tconsole.log(\"[AI Chat API] Supabase not available, skipping chat persistence\");\n\t\treturn { id: chatId, isNew: false, canPersist: false };\n\t}\n\n\t// Validate all required UUIDs - if invalid, skip persistence but continue with chat\n\tif (!isValidUUID(chatId)) {\n\t\tconsole.log(\"[AI Chat API] Invalid chatId UUID, skipping persistence:\", chatId);\n\t\treturn { id: chatId, isNew: false, canPersist: false };\n\t}\n\tif (!isValidUUID(userId) || userId === \"anonymous\") {\n\t\tconsole.log(\"[AI Chat API] Invalid or anonymous userId, skipping persistence:\", userId);\n\t\treturn { id: chatId, isNew: false, canPersist: false };\n\t}\n\tif (!isValidUUID(companyId)) {\n\t\tconsole.log(\"[AI Chat API] Invalid companyId UUID, skipping persistence:\", companyId);\n\t\treturn { id: chatId, isNew: false, canPersist: false };\n\t}\n\n\t// Check if chat exists\n\tconst { data: existingChat } = await supabase\n\t\t.from(\"chats\")\n\t\t.select(\"id\")\n\t\t.eq(\"id\", chatId)\n\t\t.single();\n\n\tif (existingChat) {\n\t\treturn { id: existingChat.id, isNew: false, canPersist: true };\n\t}\n\n\t// Create new chat with placeholder title - AI will generate a better one\n\tconst { data: newChat, error } = await supabase\n\t\t.from(\"chats\")\n\t\t.insert({\n\t\t\tid: chatId,\n\t\t\ttitle: \"New Chat\",\n\t\t\tuser_id: userId,\n\t\t\tcompany_id: companyId,\n\t\t\tvisibility: \"private\",\n\t\t})\n\t\t.select(\"id\")\n\t\t.single();\n\n\tif (error) {\n\t\tconsole.error(\"[AI Chat API] Error creating chat:\", error);\n\t\treturn { id: chatId, isNew: false, canPersist: false };\n\t}\n\n\tconsole.log(\"[AI Chat API] Created new chat:\", newChat.id);\n\n\t// Generate AI title in background (non-blocking, fire-and-forget)\n\tif (firstMessageContent && firstMessageContent.trim()) {\n\t\tgenerateChatTitleWithAI(supabase, chatId, firstMessageContent).catch((err) => {\n\t\t\tconsole.error(\"[AI Chat API] Background title generation failed:\", err);\n\t\t});\n\t}\n\n\treturn { id: newChat.id, isNew: true, canPersist: true };\n}\n\n/**\n * Save a message to the messages_v2 table\n */\nasync function saveMessage(\n\tsupabase: Awaited<ReturnType<typeof createServiceSupabaseClient>>,\n\tchatId: string,\n\trole: \"user\" | \"assistant\" | \"system\",\n\tparts: MessagePart[],\n\tattachments: unknown[] = [],\n): Promise<string | null> {\n\tif (!supabase) {\n\t\treturn null;\n\t}\n\n\tconst { data, error } = await supabase\n\t\t.from(\"messages_v2\")\n\t\t.insert({\n\t\t\tchat_id: chatId,\n\t\t\trole,\n\t\t\tparts,\n\t\t\tattachments,\n\t\t})\n\t\t.select(\"id\")\n\t\t.single();\n\n\tif (error) {\n\t\tconsole.error(\"[AI Chat API] Error saving message:\", error);\n\t\treturn null;\n\t}\n\n\treturn data.id;\n}\n\n/**\n * Convert AI SDK message to parts format for storage\n */\nfunction convertToMessageParts(content: string | unknown[]): MessagePart[] {\n\t// If content is already an array of parts, use it\n\tif (Array.isArray(content)) {\n\t\treturn content.map((part) => {\n\t\t\tif (typeof part === \"string\") {\n\t\t\t\treturn { type: \"text\", text: part };\n\t\t\t}\n\t\t\treturn part as MessagePart;\n\t\t});\n\t}\n\n\t// If content is a string, wrap it as a text part\n\tif (typeof content === \"string\") {\n\t\treturn [{ type: \"text\", text: content }];\n\t}\n\n\treturn [{ type: \"text\", text: String(content) }];\n}\n\n// ============================================================================\n// COMPANY CONTEXT CACHE - Reduces AI costs by ~$300-800/month\n// Context is cached per company for 5 minutes to avoid 10 DB queries per message\n// ============================================================================\nconst companyContextCache = new Map<\n\tstring,\n\t{ data: string; timestamp: number }\n>();\nconst CONTEXT_CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes\n\nfunction getCachedContext(companyId: string): string | null {\n\tconst cached = companyContextCache.get(companyId);\n\tif (cached && Date.now() - cached.timestamp < CONTEXT_CACHE_TTL_MS) {\n\t\treturn cached.data;\n\t}\n\treturn null;\n}\n\nfunction setCachedContext(companyId: string, data: string): void {\n\tcompanyContextCache.set(companyId, { data, timestamp: Date.now() });\n\n\t// Cleanup old entries (prevent memory leak)\n\tif (companyContextCache.size > 100) {\n\t\tconst now = Date.now();\n\t\tfor (const [key, value] of companyContextCache) {\n\t\t\tif (now - value.timestamp > CONTEXT_CACHE_TTL_MS) {\n\t\t\t\tcompanyContextCache.delete(key);\n\t\t\t}\n\t\t}\n\t}\n}\n\ntype PermissionMode =\n\t| \"autonomous\"\n\t| \"ask_permission\"\n\t| \"manual_only\"\n\t| \"disabled\";\n\ninterface AISettings {\n\tpermission_mode: PermissionMode;\n\taction_permissions: Record<ToolCategory, PermissionMode>;\n\tcan_make_calls: boolean;\n\tcan_send_sms: boolean;\n\tcan_send_emails: boolean;\n\tcan_create_invoices: boolean;\n\tcan_create_appointments: boolean;\n\tcan_create_customers: boolean;\n\tcan_update_customers: boolean;\n\tcan_move_funds: boolean;\n\tcan_manage_buckets: boolean;\n\tmax_transaction_amount: number;\n\tproactive_customer_outreach: boolean;\n\tproactive_financial_advice: boolean;\n\tproactive_scheduling_suggestions: boolean;\n\tcompany_context: string | null;\n\tcustom_system_prompt: string | null;\n\tpreferred_model: string;\n\tmodel_temperature: number;\n\t// New capability flags for expanded tools\n\tcan_email_team: boolean;\n\tcan_sms_team: boolean;\n\tcan_email_vendors: boolean;\n\tcan_sms_vendors: boolean;\n\tcan_schedule_reminders: boolean;\n\tcan_access_detailed_reports: boolean;\n\tcan_access_properties: boolean;\n\tcan_access_equipment: boolean;\n}\n\nasync function getAISettings(companyId: string): Promise<AISettings | null> {\n\tconst supabase = await createServiceSupabaseClient();\n\tif (!supabase) {\n\t\tconsole.warn(\"[AI Chat API] Service client not configured, skipping AI settings\");\n\t\treturn null;\n\t}\n\tconst { data } = await supabase\n\t\t.from(\"ai_agent_settings\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.single();\n\n\treturn data as AISettings | null;\n}\n\nasync function getCompanyContext(companyId: string): Promise<string> {\n\t// Check cache first (saves ~10 DB queries per cached hit)\n\tconst cached = getCachedContext(companyId);\n\tif (cached) {\n\t\treturn cached;\n\t}\n\n\tconst supabase = await createServiceSupabaseClient();\n\tif (!supabase) {\n\t\treturn \"## Company Context\\nService client not configured - company context unavailable.\";\n\t}\n\n\t// Get comprehensive business context in parallel\n\t// Using head: true for count-only queries to minimize data transfer\n\tconst [\n\t\tcompanyResult,\n\t\tcustomerResult,\n\t\tteamResult,\n\t\tvendorResult,\n\t\tjobResult,\n\t\tinvoiceResult,\n\t\toverdueInvoiceResult,\n\t\tappointmentResult,\n\t\tequipmentResult,\n\t\trecentJobsResult,\n\t] = await Promise.all([\n\t\t// Company info\n\t\tsupabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\n\t\t\t\t\"name, industry, phone, email, address, city, state, zip_code, website, timezone, business_hours\",\n\t\t\t)\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single(),\n\t\t// Active customers count (head: true = no data transfer, only count)\n\t\tsupabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id\", { count: \"exact\", head: true })\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"active\"),\n\t\t// Team members count by role\n\t\tsupabase\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"id, role\")\n\t\t\t.eq(\"company_id\", companyId),\n\t\t// Vendors count (head: true = no data transfer, only count)\n\t\tsupabase\n\t\t\t.from(\"vendors\")\n\t\t\t.select(\"id\", { count: \"exact\", head: true })\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"is_active\", true),\n\t\t// Jobs by status (limit to prevent fetching thousands)\n\t\tsupabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id, status\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.in(\"status\", [\"pending\", \"in_progress\", \"scheduled\"])\n\t\t\t.limit(500),\n\t\t// Invoices summary (limit to prevent fetching thousands)\n\t\tsupabase\n\t\t\t.from(\"invoices\")\n\t\t\t.select(\"id, status, total_amount\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.in(\"status\", [\"draft\", \"sent\", \"pending\"])\n\t\t\t.limit(500),\n\t\t// Overdue invoices (limit for performance)\n\t\tsupabase\n\t\t\t.from(\"invoices\")\n\t\t\t.select(\"id, total_amount, due_date\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"pending\")\n\t\t\t.lt(\"due_date\", new Date().toISOString())\n\t\t\t.limit(100),\n\t\t// Today's appointments\n\t\tsupabase\n\t\t\t.from(\"appointments\")\n\t\t\t.select(\"id, status\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"scheduled_start\", new Date().toISOString().split(\"T\")[0])\n\t\t\t.lt(\n\t\t\t\t\"scheduled_start\",\n\t\t\t\tnew Date(Date.now() + 86400000).toISOString().split(\"T\")[0],\n\t\t\t),\n\t\t// Equipment needing maintenance\n\t\tsupabase\n\t\t\t.from(\"equipment\")\n\t\t\t.select(\"id, next_service_date\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.lt(\n\t\t\t\t\"next_service_date\",\n\t\t\t\tnew Date(Date.now() + 30 * 86400000).toISOString(),\n\t\t\t),\n\t\t// Recent completed jobs (last 30 days for revenue estimate)\n\t\tsupabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id, total_amount\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"completed\")\n\t\t\t.gte(\"completed_at\", new Date(Date.now() - 30 * 86400000).toISOString())\n\t\t\t.limit(500),\n\t]);\n\n\tconst company = companyResult.data;\n\tconst customerCount = customerResult.count || 0;\n\tconst teamMembers = teamResult.data || [];\n\tconst vendorCount = vendorResult.count || 0;\n\tconst activeJobs = jobResult.data || [];\n\tconst pendingInvoices = invoiceResult.data || [];\n\tconst overdueInvoices = overdueInvoiceResult.data || [];\n\tconst todayAppointments = appointmentResult.data || [];\n\tconst maintenanceDue = equipmentResult.data || [];\n\tconst recentJobs = recentJobsResult.data || [];\n\n\t// Calculate team breakdown\n\tconst teamByRole = teamMembers.reduce(\n\t\t(acc: Record<string, number>, member) => {\n\t\t\tconst role = member.role || \"staff\";\n\t\t\tacc[role] = (acc[role] || 0) + 1;\n\t\t\treturn acc;\n\t\t},\n\t\t{},\n\t);\n\n\t// Calculate job breakdown\n\tconst jobsByStatus = activeJobs.reduce((acc: Record<string, number>, job) => {\n\t\tacc[job.status] = (acc[job.status] || 0) + 1;\n\t\treturn acc;\n\t}, {});\n\n\t// Calculate financial metrics\n\tconst pendingInvoiceTotal = pendingInvoices.reduce(\n\t\t(sum, inv) => sum + (inv.total_amount || 0),\n\t\t0,\n\t);\n\tconst overdueTotal = overdueInvoices.reduce(\n\t\t(sum, inv) => sum + (inv.total_amount || 0),\n\t\t0,\n\t);\n\tconst monthlyRevenue = recentJobs.reduce(\n\t\t(sum, job) => sum + (job.total_amount || 0),\n\t\t0,\n\t);\n\n\t// Format currency helper\n\tconst formatCurrency = (cents: number) =>\n\t\t`$${(cents / 100).toLocaleString(\"en-US\", { minimumFractionDigits: 2 })}`;\n\n\tconst context = `\n## Company Information\n- Name: ${company?.name || \"Unknown\"}\n- Industry: ${company?.industry || \"Service Business\"}\n- Phone: ${company?.phone || \"Not configured\"}\n- Email: ${company?.email || \"Not configured\"}\n- Location: ${company?.city ? `${company.city}, ${company.state} ${company.zip_code}` : \"Not configured\"}\n- Timezone: ${company?.timezone || \"America/New_York\"}\n\n## Team Overview\n- Total Team Members: ${teamMembers.length}\n${Object.entries(teamByRole)\n\t.map(\n\t\t([role, count]) =>\n\t\t\t`- ${role.charAt(0).toUpperCase() + role.slice(1)}s: ${count}`,\n\t)\n\t.join(\"\\n\")}\n\n## Business Metrics (Current)\n- Active Customers: ${customerCount}\n- Active Vendors: ${vendorCount}\n- Active Jobs: ${activeJobs.length} (${\n\t\tObject.entries(jobsByStatus)\n\t\t\t.map(([status, count]) => `${count} ${status}`)\n\t\t\t.join(\", \") || \"none\"\n\t})\n- Today's Appointments: ${todayAppointments.length}\n- Equipment Needing Service (next 30 days): ${maintenanceDue.length}\n\n## Financial Overview\n- Pending Invoices: ${pendingInvoices.length} (${formatCurrency(pendingInvoiceTotal)})\n- Overdue Invoices: ${overdueInvoices.length} (${formatCurrency(overdueTotal)})${overdueInvoices.length > 0 ? \" ⚠️ ATTENTION NEEDED\" : \"\"}\n- Last 30 Days Revenue: ${formatCurrency(monthlyRevenue)}\n\n## Important Alerts\n${overdueInvoices.length > 0 ? `- ${overdueInvoices.length} overdue invoice(s) totaling ${formatCurrency(overdueTotal)} need attention` : \"\"}\n${maintenanceDue.length > 0 ? `- ${maintenanceDue.length} piece(s) of equipment due for maintenance` : \"\"}\n${jobsByStatus.pending ? `- ${jobsByStatus.pending} job(s) pending assignment` : \"\"}\n${!overdueInvoices.length && !maintenanceDue.length && !jobsByStatus.pending ? \"- No urgent issues at this time\" : \"\"}\n`;\n\n\t// Cache the context for subsequent requests (saves ~10 queries per cached hit)\n\tsetCachedContext(companyId, context);\n\n\treturn context;\n}\n\nfunction buildSystemPrompt(\n\tsettings: AISettings | null,\n\tcompanyContext: string,\n): string {\n\tconst permissionMode = settings?.permission_mode || \"ask_permission\";\n\tconst proactiveFeatures = [];\n\n\tif (settings?.proactive_customer_outreach)\n\t\tproactiveFeatures.push(\"customer outreach\");\n\tif (settings?.proactive_financial_advice)\n\t\tproactiveFeatures.push(\"financial advice\");\n\tif (settings?.proactive_scheduling_suggestions)\n\t\tproactiveFeatures.push(\"scheduling optimization\");\n\n\tconst permissionInstructions = {\n\t\tautonomous:\n\t\t\t\"You can take actions directly without asking for permission. Execute tasks proactively to help the business.\",\n\t\task_permission:\n\t\t\t\"Always ask for confirmation before taking actions that modify data, send communications, or involve money. Explain what you plan to do and wait for approval.\",\n\t\tmanual_only:\n\t\t\t\"Only respond to direct questions. Do not take any actions unless explicitly instructed by the user.\",\n\t\tdisabled:\n\t\t\t\"You can only provide information and answer questions. You cannot execute any tools or take actions.\",\n\t};\n\n\treturn `You are an AI business manager assistant for a field service company. You act as a proactive manager helping owners and staff run their business efficiently.\n\n${companyContext}\n\n## Your Role\n- Help manage customers, jobs, invoices, and communications\n- Provide business insights and recommendations\n- ${proactiveFeatures.length > 0 ? `Proactively assist with: ${proactiveFeatures.join(\", \")}` : \"Respond to user requests\"}\n- Be professional, helpful, and efficient\n\n## Permission Level: ${permissionMode.toUpperCase()}\n${permissionInstructions[permissionMode]}\n\n## Available Capabilities\n${\n\tsettings\n\t\t? `\n### Customer Communication\n- Send Emails to Customers: ${settings.can_send_emails ? \"Yes\" : \"No\"}\n- Send SMS to Customers: ${settings.can_send_sms ? \"Yes\" : \"No\"}\n- Make Calls: ${settings.can_make_calls ? \"Yes\" : \"No\"}\n\n### Team Communication\n- Send Emails to Team: ${settings.can_email_team ? \"Yes\" : \"No\"}\n- Send SMS to Team: ${settings.can_sms_team ? \"Yes\" : \"No\"}\n\n### Vendor Communication\n- Send Emails to Vendors: ${settings.can_email_vendors ? \"Yes\" : \"No\"}\n- Send SMS to Vendors: ${settings.can_sms_vendors ? \"Yes\" : \"No\"}\n\n### Scheduling & Reminders\n- Create Appointments: ${settings.can_create_appointments ? \"Yes\" : \"No\"}\n- Schedule Reminders: ${settings.can_schedule_reminders ? \"Yes\" : \"No\"}\n\n### Financial\n- Create Invoices: ${settings.can_create_invoices ? \"Yes\" : \"No\"}\n- Move Funds: ${settings.can_move_funds ? \"Yes (max $${(settings.max_transaction_amount / 100).toFixed(2)})\" : \"No\"}\n\n### Customer Management\n- Create Customers: ${settings.can_create_customers ? \"Yes\" : \"No\"}\n- Update Customers: ${settings.can_update_customers ? \"Yes\" : \"No\"}\n\n### Data Access\n- Access Properties: ${settings.can_access_properties ? \"Yes\" : \"No\"}\n- Access Equipment: ${settings.can_access_equipment ? \"Yes\" : \"No\"}\n- Detailed Reports (job costing, revenue breakdown, AR aging): ${settings.can_access_detailed_reports ? \"Yes\" : \"No\"}\n`\n\t\t: \"All capabilities available (default settings)\"\n}\n\n## Guidelines\n1. Always search for existing customers/jobs before creating new ones\n2. Confirm customer details before sending communications\n3. For financial actions, always explain the amounts involved\n4. When scheduling, check availability first\n5. Log all communications and actions taken\n6. Provide proactive insights when relevant (overdue invoices, inactive customers, etc.)\n7. Do NOT list database tables or perform schema introspection unless the user explicitly asks for it\n8. Keep responses concise and focused on the user request; avoid verbose summaries\n9. When a question needs current or external information, use the web search tools (webSearchTool/webSearchNewsTool/webSearchSiteTool) and cite the sources you used\n\n## IMPORTANT: Destructive Action Approval\nCertain actions are classified as \"destructive\" and REQUIRE owner approval before execution:\n- Sending emails, SMS, or making calls to customers, team members, or vendors\n- Creating invoices or moving funds\n- Creating or modifying appointments\n- Updating customer records\n\nWhen you attempt these actions, they will be queued for owner review instead of executing immediately.\nThe system will show a notification that owner approval is required.\nOnce a company owner approves the action, it will be executed automatically.\nIf rejected, the action will not be executed and you'll be notified.\nThis is a security measure to prevent unauthorized communications or financial actions.\n\n${settings?.custom_system_prompt ? `\\n## Additional Instructions\\n${settings.custom_system_prompt}` : \"\"}\n${settings?.company_context ? `\\n## Business Context\\n${settings.company_context}` : \"\"}\n`;\n}\n\nfunction filterToolsByPermissions(\n\tsettings: AISettings | null,\n): Record<string, (typeof aiAgentTools)[keyof typeof aiAgentTools]> {\n\tif (!settings) return aiAgentTools;\n\n\tconst permissionMode = settings.permission_mode;\n\tif (permissionMode === \"disabled\") return {};\n\n\tconst filteredTools: Record<\n\t\tstring,\n\t\t(typeof aiAgentTools)[keyof typeof aiAgentTools]\n\t> = {};\n\n\tfor (const [toolName, toolInstance] of Object.entries(aiAgentTools)) {\n\t\tconst category = toolCategories[toolName];\n\t\tconst categoryPermission =\n\t\t\tsettings.action_permissions?.[category] || permissionMode;\n\n\t\t// Avoid noisy introspection tools unless explicitly requested\n\t\tif (toolName === \"listDatabaseTables\") continue;\n\n\t\t// Skip if category is disabled\n\t\tif (categoryPermission === \"disabled\") continue;\n\n\t\t// Check specific capability flags - Customer Communication\n\t\tif (toolName === \"sendEmail\" && !settings.can_send_emails) continue;\n\t\tif (toolName === \"sendSms\" && !settings.can_send_sms) continue;\n\t\tif (toolName === \"initiateCall\" && !settings.can_make_calls) continue;\n\n\t\t// Team Communication\n\t\tif (toolName === \"sendTeamEmail\" && !settings.can_email_team) continue;\n\t\tif (toolName === \"sendTeamSms\" && !settings.can_sms_team) continue;\n\n\t\t// Vendor Communication\n\t\tif (toolName === \"sendVendorEmail\" && !settings.can_email_vendors) continue;\n\t\tif (toolName === \"sendVendorSms\" && !settings.can_sms_vendors) continue;\n\n\t\t// Financial\n\t\tif (toolName === \"createInvoice\" && !settings.can_create_invoices) continue;\n\t\tif (toolName === \"transferToBucket\" && !settings.can_move_funds) continue;\n\n\t\t// Scheduling\n\t\tif (toolName === \"createAppointment\" && !settings.can_create_appointments)\n\t\t\tcontinue;\n\n\t\t// Customers\n\t\tif (toolName === \"createCustomer\" && !settings.can_create_customers)\n\t\t\tcontinue;\n\t\tif (toolName === \"updateCustomer\" && !settings.can_update_customers)\n\t\t\tcontinue;\n\n\t\t// Reminders/Notifications\n\t\tif (\n\t\t\t(toolName === \"scheduleReminder\" ||\n\t\t\t\ttoolName === \"cancelReminder\" ||\n\t\t\t\ttoolName === \"sendImmediateNotification\") &&\n\t\t\t!settings.can_schedule_reminders\n\t\t)\n\t\t\tcontinue;\n\n\t\t// Detailed Reports\n\t\tif (\n\t\t\t(toolName === \"getJobCostingReport\" ||\n\t\t\t\ttoolName === \"getRevenueBreakdown\" ||\n\t\t\t\ttoolName === \"getARAgingReport\" ||\n\t\t\t\ttoolName === \"getTeamPerformanceReport\" ||\n\t\t\t\ttoolName === \"getCustomerLifetimeValue\") &&\n\t\t\t!settings.can_access_detailed_reports\n\t\t)\n\t\t\tcontinue;\n\n\t\t// Property Access\n\t\tif (\n\t\t\t(toolName === \"searchProperties\" || toolName === \"getPropertyDetails\") &&\n\t\t\t!settings.can_access_properties\n\t\t)\n\t\t\tcontinue;\n\n\t\t// Equipment Access\n\t\tif (\n\t\t\t(toolName === \"searchEquipment\" || toolName === \"getMaintenanceDue\") &&\n\t\t\t!settings.can_access_equipment\n\t\t)\n\t\t\tcontinue;\n\n\t\tfilteredTools[toolName] = toolInstance;\n\t}\n\n\treturn filteredTools;\n}\n\n// Request action approval tool - used when permission mode is ask_permission\n// AI SDK 6: parameters -> inputSchema\nconst requestApprovalTool = tool({\n\tdescription:\n\t\t\"Request user approval before taking an action. Use this when you need permission to proceed.\",\n\tinputSchema: z.object({\n\t\taction: z.string().describe(\"The action you want to take\"),\n\t\treason: z.string().describe(\"Why this action is beneficial\"),\n\t\tdetails: z.string().describe(\"Specific details of what will happen\"),\n\t}),\n\texecute: async ({ action, reason, details }) => {\n\t\treturn {\n\t\t\trequiresApproval: true,\n\t\t\taction,\n\t\t\treason,\n\t\t\tdetails,\n\t\t\tmessage: `I'd like to ${action}. ${reason}. This will: ${details}. Do you approve?`,\n\t\t};\n\t},\n});\n\n/**\n * Wrap destructive tools with owner approval interception\n * When a destructive tool is called, instead of executing it directly,\n * we create a pending action and return a message asking for owner approval.\n */\nfunction wrapToolsWithApprovalCheck(\n\ttools: Record<string, (typeof aiAgentTools)[keyof typeof aiAgentTools]>,\n\tcontext: {\n\t\tcompanyId: string;\n\t\tuserId: string;\n\t\tchatId: string;\n\t\tmessageId: string;\n\t},\n): Record<string, (typeof aiAgentTools)[keyof typeof aiAgentTools]> {\n\tconst wrappedTools: Record<\n\t\tstring,\n\t\t(typeof aiAgentTools)[keyof typeof aiAgentTools]\n\t> = {};\n\n\tfor (const [toolName, toolInstance] of Object.entries(tools)) {\n\t\t// Check if this tool is destructive and requires owner approval\n\t\tconst metadata = getDestructiveToolMetadata(toolName);\n\n\t\tif (metadata && metadata.requiresOwnerApproval) {\n\t\t\t// Wrap the tool to intercept and require approval\n\t\t\t// AI SDK 6: parameters -> inputSchema, and access toolInstance.inputSchema\n\t\t\tconst toolSchema = \"inputSchema\" in toolInstance ? toolInstance.inputSchema : (toolInstance as { parameters?: unknown }).parameters;\n\t\t\twrappedTools[toolName] = tool({\n\t\t\t\tdescription: toolInstance.description,\n\t\t\t\tinputSchema: toolSchema,\n\t\t\t\texecute: async (args: Record<string, unknown>) => {\n\t\t\t\t\t// Intercept the tool call and create a pending action\n\t\t\t\t\tconst interception = await shouldInterceptTool(toolName, args, {\n\t\t\t\t\t\tcompanyId: context.companyId,\n\t\t\t\t\t\tchatId: context.chatId,\n\t\t\t\t\t\tmessageId: context.messageId,\n\t\t\t\t\t\tuserId: context.userId,\n\t\t\t\t\t});\n\n\t\t\t\t\tif (interception.intercept) {\n\t\t\t\t\t\tif (interception.error) {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\t\trequiresOwnerApproval: true,\n\t\t\t\t\t\t\t\terror: interception.error,\n\t\t\t\t\t\t\t\tmessage: `Failed to create approval request: ${interception.error}`,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Return a message indicating approval is needed\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\trequiresOwnerApproval: true,\n\t\t\t\t\t\t\tpendingActionId: interception.pendingActionId,\n\t\t\t\t\t\t\triskLevel: metadata.riskLevel,\n\t\t\t\t\t\t\tactionType: metadata.actionType,\n\t\t\t\t\t\t\tmessage: `⚠️ This action requires owner approval before it can be executed.\n\n**Action:** ${metadata.description}\n**Risk Level:** ${metadata.riskLevel.toUpperCase()}\n**Affected:** ${metadata.affectedEntityType}\n\nThe action has been queued for owner review. Once a company owner approves this action, it will be executed automatically.\n\nPending Action ID: ${interception.pendingActionId}`,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\t// If no interception needed, execute the original tool\n\t\t\t\t\t// (This shouldn't happen for destructive tools, but fallback just in case)\n\t\t\t\t\tif (typeof toolInstance.execute === \"function\") {\n\t\t\t\t\t\treturn await toolInstance.execute(args);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn { success: false, error: \"Tool execution not available\" };\n\t\t\t\t},\n\t\t\t}) as (typeof aiAgentTools)[keyof typeof aiAgentTools];\n\t\t} else {\n\t\t\t// Non-destructive tools pass through unchanged\n\t\t\twrappedTools[toolName] = toolInstance;\n\t\t}\n\t}\n\n\treturn wrappedTools;\n}\n\nexport async function POST(req: Request) {\n\ttry {\n\t\tconst {\n\t\t\tmessages,\n\t\t\tcompanyId: providedCompanyId,\n\t\t\tuserId: providedUserId,\n\t\t\tchatId: providedChatId,\n\t\t\tmodel: requestedModel,\n\t\t} = await req.json();\n\n\t\tif (!(messages && Array.isArray(messages))) {\n\t\t\treturn Response.json({ error: \"Messages are required\" }, { status: 400 });\n\t\t}\n\n\t\tconsole.log(\"[AI Chat API] Received request:\", {\n\t\t\tmessageCount: messages.length,\n\t\t\tcompanyId: providedCompanyId,\n\t\t\tchatId: providedChatId,\n\t\t\tmodel: requestedModel,\n\t\t});\n\n\t\t// Get company ID from auth or use provided (for demo)\n\t\tlet companyId = providedCompanyId || process.env.DEFAULT_COMPANY_ID;\n\t\tif (!companyId) {\n\t\t\t// Fallback to active company cookie if available\n\t\t\ttry {\n\t\t\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\t\t\tcompanyId = (await getActiveCompanyId()) || companyId;\n\t\t\t} catch (err) {\n\t\t\t\tconsole.warn(\"[AI Chat API] Unable to read active company:\", err);\n\t\t\t}\n\t\t}\n\n\t\tif (!companyId) {\n\t\t\treturn Response.json({ error: \"Company ID required\" }, { status: 400 });\n\t\t}\n\n\t\t// Get user ID (required for destructive action tracking)\n\t\tconst userId = providedUserId || \"anonymous\";\n\n\t\t// Get or generate chat ID\n\t\tconst chatId = providedChatId || crypto.randomUUID();\n\n\t\t// Generate a unique message ID for this request\n\t\tconst messageId = crypto.randomUUID();\n\n\t\t// Load AI settings and company context\n\t\tconst [settings, companyContext, supabase] = await Promise.all([\n\t\t\tgetAISettings(companyId),\n\t\t\tgetCompanyContext(companyId),\n\t\t\tcreateServiceSupabaseClient(),\n\t\t]);\n\n\t\t// === MESSAGE PERSISTENCE: Ensure chat exists and save user message ===\n\t\t// Get the last user message (the new one being sent)\n\t\tconst lastMessage = messages[messages.length - 1];\n\t\tconst isNewUserMessage = lastMessage?.role === \"user\";\n\t\tconst userMessageContent = isNewUserMessage\n\t\t\t? (typeof lastMessage.content === \"string\"\n\t\t\t\t\t? lastMessage.content\n\t\t\t\t\t: lastMessage.parts?.[0]?.text || \"\")\n\t\t\t: \"\";\n\n\t\t// Ensure chat exists (creates if new)\n\t\tconst chatResult = await ensureChat(\n\t\t\tsupabase,\n\t\t\tchatId,\n\t\t\tuserId,\n\t\t\tcompanyId,\n\t\t\tuserMessageContent,\n\t\t);\n\n\t\t// Save the new user message if this is a new message AND persistence is possible\n\t\tif (isNewUserMessage && supabase && chatResult.canPersist) {\n\t\t\tconst parts = lastMessage.parts\n\t\t\t\t? lastMessage.parts\n\t\t\t\t: convertToMessageParts(lastMessage.content);\n\t\t\tconst savedId = await saveMessage(supabase, chatId, \"user\", parts, lastMessage.attachments || []);\n\t\t\tif (savedId) {\n\t\t\t\tconsole.log(\"[AI Chat API] Saved user message:\", savedId);\n\t\t\t}\n\t\t}\n\n\t\t// Build system prompt based on settings\n\t\tconst systemPrompt = buildSystemPrompt(settings, companyContext);\n\n\t\t// Filter tools based on permissions\n\t\tlet availableTools = filterToolsByPermissions(settings);\n\n\t\t// Wrap destructive tools with owner approval interception\n\t\t// This ensures ALL destructive actions require owner approval before execution\n\t\tavailableTools = wrapToolsWithApprovalCheck(availableTools, {\n\t\t\tcompanyId,\n\t\t\tuserId,\n\t\t\tchatId,\n\t\t\tmessageId,\n\t\t});\n\n\t\t// Add approval tool if in ask_permission mode\n\t\tif (settings?.permission_mode === \"ask_permission\") {\n\t\t\tavailableTools.requestApproval = requestApprovalTool;\n\t\t}\n\n\t\t// Determine model and provider - Groq only\n\t\tconst temperature = settings?.model_temperature || 0.7;\n\n\t\t// Use Groq exclusively (free with tools)\n\t\tconst modelId = requestedModel || settings?.preferred_model || \"llama-3.3-70b-versatile\";\n\t\tconst provider: AIProvider = \"groq\";\n\n\t\tconsole.log(\"[AI Chat API] Using model:\", modelId, \"provider:\", provider);\n\n\t\t// Create model instance using Groq\n\t\tconst model = createAIProvider({ provider, model: modelId });\n\n\t// Create tool context with company ID\n\tconst toolContext = { companyId };\n\n\t// Convert messages to ModelMessage format for streamText\n\t// AI SDK v5: UIMessage has 'parts' array, ModelMessage has 'content' string\n\t\t// Handle both formats for backward compatibility and direct API calls\n\t\tlet modelMessages;\n\t\tconst isUIMessageFormat = messages[0]?.parts !== undefined;\n\n\t\tif (isUIMessageFormat) {\n\t\t\t// UIMessage format from useChat hook - convert to ModelMessage\n\t\t\tmodelMessages = convertToModelMessages(messages);\n\t\t\t// Strip tool invocations from prior assistant messages to avoid malformed tool_calls\n\t\t\tmodelMessages = modelMessages.map((m: any) => {\n\t\t\t\tif (m.role === \"assistant\") {\n\t\t\t\t\tdelete m.toolInvocations;\n\t\t\t\t}\n\t\t\t\treturn m;\n\t\t\t});\n\t\t} else {\n\t\t\t// Already in simple/ModelMessage format (role + content) - use as-is\n\t\t\tmodelMessages = messages.map((msg: { role: string; content: string }) => ({\n\t\t\t\trole: msg.role as \"user\" | \"assistant\" | \"system\",\n\t\t\t\tcontent: msg.content,\n\t\t\t}));\n\t\t}\n\n\t\t// Drop tool role messages entirely (Groq requires tool_calls with arguments, which we don't persist in history)\n\t\tmodelMessages = modelMessages.filter(\n\t\t\t(m: any) => m.role !== \"tool\" && m.role !== \"function\"\n\t\t);\n\n\t\tconsole.log(\"[AI Chat API] Processed messages:\", {\n\t\t\toriginalFormat: isUIMessageFormat ? \"UIMessage (parts)\" : \"ModelMessage (content)\",\n\t\t\tconvertedCount: modelMessages.length,\n\t\t});\n\n\t\t// Groq supports tools with llama-3.3-70b-versatile model\n\t\tconst shouldDisableTools = false;\n\n\t// Build the streamText configuration\n\tconst streamConfig: Parameters<typeof streamText>[0] = {\n\t\tmodel,\n\t\tmessages: modelMessages,\n\t\ttemperature,\n\t\tsystem: systemPrompt,\n\t\tmaxOutputTokens: 512, // keep replies concise and reduce latency\n\t};\n\n\t// Enable tools - Groq with llama-3.3-70b-versatile supports tools\n\tif (!shouldDisableTools) {\n\t\tstreamConfig.tools = availableTools;\n\t\tstreamConfig.stopWhen = stepCountIs(5); // Reduced from 10 to lower AI costs\n\t\tstreamConfig.maxToolRoundtrips = 2; // cap tool loops to improve response time\n\t}\n\n\t// Stream the response with retry-on-rate-limit (fallback to smaller model)\n\tconst aiStartTime = Date.now();\n\tconst runStream = async (modelOverride?: string) => {\n\t\tif (modelOverride) {\n\t\t\tconsole.warn(\"[AI Chat API] Falling back to model:\", modelOverride);\n\t\t\tstreamConfig.model = createAIProvider({ provider, model: modelOverride });\n\t\t}\n\n\t\treturn streamText({\n\t\t\t...streamConfig,\n\t\t\t// === AI SDK 6 BEST PRACTICE: Handle streaming errors ===\n\t\t\tonError: (event) => {\n\t\t\t\tconsole.error(\"[AI Chat API] Stream error:\", {\n\t\t\t\t\terror: event.error,\n\t\t\t\t\tmessage: (event.error as any)?.message,\n\t\t\t\t\tstack: (event.error as any)?.stack,\n\t\t\t\t\tname: (event.error as any)?.name,\n\t\t\t\t\tmodelMessages: modelMessages,\n\t\t\t\t});\n\t\t\t\t// Track failed API call\n\t\t\t\ttrackExternalApiCall({\n\t\t\t\t\tapiName: \"groq\",\n\t\t\t\t\tendpoint: `chat.${modelOverride || modelId}`,\n\t\t\t\t\tcompanyId,\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tresponseTimeMs: Date.now() - aiStartTime,\n\t\t\t\t\testimatedCostCents: 0,\n\t\t\t\t\terrorMessage: event.error instanceof Error ? event.error.message : String(event.error),\n\t\t\t\t}).catch(() => {});\n\t\t\t},\n\t\t\t// === AI SDK 6 BEST PRACTICE: Track individual chunks for debugging ===\n\t\t\tonChunk: (event) => {\n\t\t\t\t// Log tool calls as they stream in for better debugging\n\t\t\t\tif (event.chunk.type === \"tool-call\") {\n\t\t\t\t\tconsole.log(\"[AI Chat API] Tool call started:\", event.chunk.toolName);\n\t\t\t\t}\n\t\t\t},\n\t\t\tonToolCall: (event) => {\n\t\t\t\tconsole.log(\"[AI Chat API] Tool call event:\", {\n\t\t\t\t\tname: event.toolName,\n\t\t\t\t\tcallId: event.toolCallId,\n\t\t\t\t});\n\t\t\t},\n\t\t\tonToolResult: (event) => {\n\t\t\t\tconsole.log(\"[AI Chat API] Tool result event:\", {\n\t\t\t\t\tcallId: event.toolCallId,\n\t\t\t\t\thasResult: !!event.result,\n\t\t\t\t});\n\t\t\t},\n\t\t\t// === MESSAGE PERSISTENCE: Save assistant response when complete ===\n\t\t\tonFinish: async ({ text, toolCalls, toolResults, usage }) => {\n\t\t\t\t// Track AI API usage for admin dashboard\n\t\t\t\tconst responseTimeMs = Date.now() - aiStartTime;\n\t\t\t\tconst totalTokens = (usage?.promptTokens || 0) + (usage?.completionTokens || 0);\n\n\t\t\t\t// Groq is free tier - no cost\n\t\t\t\tconst estimatedCostCents = 0;\n\n\t\t\t\t// Track the API call (fire-and-forget)\n\t\t\t\ttrackExternalApiCall({\n\t\t\t\t\tapiName: \"groq\",\n\t\t\t\t\tendpoint: `chat.${modelOverride || modelId}`,\n\t\t\t\t\tcompanyId,\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\tresponseTimeMs,\n\t\t\t\t\testimatedCostCents,\n\t\t\t\t}).catch(() => {});\n\n\t\t\t\t// Save the assistant's response to messages_v2 (only if persistence is possible)\n\t\t\t\tif (text && supabase && chatResult.canPersist) {\n\t\t\t\t\t// Build parts array with text and any tool calls/results\n\t\t\t\t\tconst parts: MessagePart[] = [];\n\n\t\t\t\t\t// Add text content\n\t\t\t\t\tif (text) {\n\t\t\t\t\t\tparts.push({ type: \"text\", text });\n\t\t\t\t\t}\n\n\t\t\t\t\t// Add tool calls and results if any\n\t\t\t\t\tif (toolCalls && toolCalls.length > 0) {\n\t\t\t\t\t\tfor (const call of toolCalls) {\n\t\t\t\t\t\t\tconst toolName = \"toolName\" in call ? call.toolName : (call as { name?: string }).name || \"unknown\";\n\t\t\t\t\t\t\tconst toolInput = \"input\" in call ? call.input : (\"args\" in call ? (call as { args?: unknown }).args : null);\n\n\t\t\t\t\t\t\tparts.push({\n\t\t\t\t\t\t\t\ttype: \"tool-invocation\",\n\t\t\t\t\t\t\t\ttoolName,\n\t\t\t\t\t\t\t\ttoolCallId: call.toolCallId,\n\t\t\t\t\t\t\t\targs: toolInput,\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t// Find and add the result\n\t\t\t\t\t\t\tconst resultData = toolResults?.find((r) => r.toolCallId === call.toolCallId);\n\t\t\t\t\t\t\tif (resultData) {\n\t\t\t\t\t\t\t\tconst toolOutput = \"output\" in resultData ? resultData.output : (resultData as { result?: unknown })?.result;\n\t\t\t\t\t\t\t\tparts.push({\n\t\t\t\t\t\t\t\t\ttype: \"tool-result\",\n\t\t\t\t\t\t\t\t\ttoolCallId: call.toolCallId,\n\t\t\t\t\t\t\t\t\tresult: toolOutput,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tconst savedId = await saveMessage(supabase, chatId, \"assistant\", parts, []);\n\t\t\t\t\tif (savedId) {\n\t\t\t\t\t\tconsole.log(\"[AI Chat API] Saved assistant message:\", savedId);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\tonStepFinish: async ({ toolCalls, toolResults }) => {\n\t\t\t\t// Log AI actions to the database\n\t\t\t\tif (toolCalls && toolCalls.length > 0) {\n\t\t\t\t\tconst supabase = await createServiceSupabaseClient();\n\t\t\t\t\tif (!supabase) {\n\t\t\t\t\t\tconsole.warn(\"[AI Chat API] Service client not configured, skipping action log\");\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tfor (const call of toolCalls) {\n\t\t\t\t\t\t// AI SDK v5: toolName may be on different property, check for dynamic tools\n\t\t\t\t\t\tconst toolName = \"toolName\" in call ? call.toolName : (call as { name?: string }).name || \"unknown\";\n\t\t\t\t\t\tconst category = toolCategories[toolName] || \"system\";\n\n\t\t\t\t\t\t// AI SDK v5: args is now input\n\t\t\t\t\t\tconst toolInput = \"input\" in call ? call.input : (\"args\" in call ? (call as { args?: unknown }).args : null);\n\n\t\t\t\t\t\tconst result = toolResults?.find(\n\t\t\t\t\t\t\t(r) => r.toolCallId === call.toolCallId,\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\t// AI SDK v5: result.result is now result.output\n\t\t\t\t\t\tconst toolOutput = result && \"output\" in result ? result.output : (result as { result?: unknown })?.result;\n\t\t\t\t\t\tconst isSuccess = toolOutput && typeof toolOutput === \"object\" && \"success\" in toolOutput ? (toolOutput as { success?: boolean }).success : false;\n\n\t\t\t\t\t\tawait supabase.from(\"ai_action_log\").insert({\n\t\t\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\t\t\taction_type: category,\n\t\t\t\t\t\t\taction_name: toolName,\n\t\t\t\t\t\t\taction_description: JSON.stringify(toolInput),\n\t\t\t\t\t\t\tpermission_mode: settings?.permission_mode || \"ask_permission\",\n\t\t\t\t\t\t\tpermission_requested:\n\t\t\t\t\t\t\t\tsettings?.permission_mode === \"ask_permission\",\n\t\t\t\t\t\t\tpermission_granted: settings?.permission_mode === \"autonomous\",\n\t\t\t\t\t\t\tstatus: isSuccess ? \"executed\" : \"failed\",\n\t\t\t\t\t\t\tinput_data: toolInput,\n\t\t\t\t\t\t\toutput_data: toolOutput,\n\t\t\t\t\t\t\texecuted_at: new Date().toISOString(),\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t};\n\n\tlet result;\n\ttry {\n\t\tresult = await runStream();\n\t} catch (error: any) {\n\t\tconst message = error?.message || \"\";\n\t\tconst isRateLimit = message.includes(\"rate limit\") || message.includes(\"Rate limit\");\n\n\t\tif (isRateLimit && modelId !== \"llama-3.1-8b-instant\") {\n\t\t\tresult = await runStream(\"llama-3.1-8b-instant\");\n\t\t} else {\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t// AI SDK v5: Use toUIMessageStreamResponse for full-featured streaming with tools\n\treturn result.toUIMessageStreamResponse();\n\t} catch (error) {\n\t\tconsole.error(\"[AI Chat API] Error:\", error);\n\n\t\t// Provide more detailed error info for debugging\n\t\tconst errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n\t\tconst errorName = error instanceof Error ? error.name : \"UnknownError\";\n\n\t\treturn Response.json(\n\t\t\t{\n\t\t\t\terror: errorMessage,\n\t\t\t\terrorType: errorName,\n\t\t\t\ttimestamp: new Date().toISOString(),\n\t\t\t},\n\t\t\t{ status: 500 },\n\t\t);\n\t}\n}\n","import { AppRouteRouteModule } from \"next/dist/esm/server/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/esm/server/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/esm/server/lib/patch-fetch\";\nimport { addRequestMeta, getRequestMeta } from \"next/dist/esm/server/request-meta\";\nimport { getTracer, SpanKind } from \"next/dist/esm/server/lib/trace/tracer\";\nimport { setReferenceManifestsSingleton } from \"next/dist/esm/server/app-render/encryption-utils\";\nimport { createServerModuleMap } from \"next/dist/esm/server/app-render/action-utils\";\nimport { normalizeAppPath } from \"next/dist/esm/shared/lib/router/utils/app-paths\";\nimport { NodeNextRequest, NodeNextResponse } from \"next/dist/esm/server/base-http/node\";\nimport { NextRequestAdapter, signalFromNodeResponse } from \"next/dist/esm/server/web/spec-extension/adapters/next-request\";\nimport { BaseServerSpan } from \"next/dist/esm/server/lib/trace/constants\";\nimport { getRevalidateReason } from \"next/dist/esm/server/instrumentation/utils\";\nimport { sendResponse } from \"next/dist/esm/server/send-response\";\nimport { fromNodeOutgoingHttpHeaders, toNodeOutgoingHttpHeaders } from \"next/dist/esm/server/web/utils\";\nimport { getCacheControlHeader } from \"next/dist/esm/server/lib/cache-control\";\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from \"next/dist/esm/lib/constants\";\nimport { NoFallbackError } from \"next/dist/esm/shared/lib/no-fallback-error.external\";\nimport { CachedRouteKind } from \"next/dist/esm/server/response-cache\";\nimport * as userland from \"INNER_APP_ROUTE\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/ai/chat/route\",\n        pathname: \"/api/ai/chat\",\n        filename: \"route\",\n        bundlePath: \"\"\n    },\n    distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n    relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n    resolvedPagePath: \"[project]/apps/web/src/app/api/ai/chat/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return _patchFetch({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\nexport { routeModule, workAsyncStorage, workUnitAsyncStorage, serverHooks, patchFetch,  };\nexport async function handler(req, res, ctx) {\n    if (routeModule.isDev) {\n        addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint());\n    }\n    let srcPage = \"/api/ai/chat/route\";\n    // turbopack doesn't normalize `/index` in the page name\n    // so we need to to process dynamic routes properly\n    // TODO: fix turbopack providing differing value from webpack\n    if (process.env.TURBOPACK) {\n        srcPage = srcPage.replace(/\\/index$/, '') || '/';\n    } else if (srcPage === '/index') {\n        // we always normalize /index specifically\n        srcPage = '/';\n    }\n    const multiZoneDraftMode = process.env.__NEXT_MULTI_ZONE_DRAFT_MODE;\n    const prepareResult = await routeModule.prepare(req, res, {\n        srcPage,\n        multiZoneDraftMode\n    });\n    if (!prepareResult) {\n        res.statusCode = 400;\n        res.end('Bad Request');\n        ctx.waitUntil == null ? void 0 : ctx.waitUntil.call(ctx, Promise.resolve());\n        return null;\n    }\n    const { buildId, params, nextConfig, parsedUrl, isDraftMode, prerenderManifest, routerServerContext, isOnDemandRevalidate, revalidateOnlyGenerated, resolvedPathname, clientReferenceManifest, serverActionsManifest } = prepareResult;\n    const normalizedSrcPage = normalizeAppPath(srcPage);\n    let isIsr = Boolean(prerenderManifest.dynamicRoutes[normalizedSrcPage] || prerenderManifest.routes[resolvedPathname]);\n    const render404 = async ()=>{\n        // TODO: should route-module itself handle rendering the 404\n        if (routerServerContext == null ? void 0 : routerServerContext.render404) {\n            await routerServerContext.render404(req, res, parsedUrl, false);\n        } else {\n            res.end('This page could not be found');\n        }\n        return null;\n    };\n    if (isIsr && !isDraftMode) {\n        const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname]);\n        const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage];\n        if (prerenderInfo) {\n            if (prerenderInfo.fallback === false && !isPrerendered) {\n                if (nextConfig.experimental.adapterPath) {\n                    return await render404();\n                }\n                throw new NoFallbackError();\n            }\n        }\n    }\n    let cacheKey = null;\n    if (isIsr && !routeModule.isDev && !isDraftMode) {\n        cacheKey = resolvedPathname;\n        // ensure /index and / is normalized to one key\n        cacheKey = cacheKey === '/index' ? '/' : cacheKey;\n    }\n    const supportsDynamicResponse = // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true || // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr;\n    // This is a revalidation request if the request is for a static\n    // page and it is not being resumed from a postponed render and\n    // it is not a dynamic RSC request then it is a revalidation\n    // request.\n    const isStaticGeneration = isIsr && !supportsDynamicResponse;\n    // Before rendering (which initializes component tree modules), we have to\n    // set the reference manifests to our global store so Server Action's\n    // encryption util can access to them at the top level of the page module.\n    if (serverActionsManifest && clientReferenceManifest) {\n        setReferenceManifestsSingleton({\n            page: srcPage,\n            clientReferenceManifest,\n            serverActionsManifest,\n            serverModuleMap: createServerModuleMap({\n                serverActionsManifest\n            })\n        });\n    }\n    const method = req.method || 'GET';\n    const tracer = getTracer();\n    const activeSpan = tracer.getActiveScopeSpan();\n    const context = {\n        params,\n        prerenderManifest,\n        renderOpts: {\n            experimental: {\n                authInterrupts: Boolean(nextConfig.experimental.authInterrupts)\n            },\n            cacheComponents: Boolean(nextConfig.cacheComponents),\n            supportsDynamicResponse,\n            incrementalCache: getRequestMeta(req, 'incrementalCache'),\n            cacheLifeProfiles: nextConfig.cacheLife,\n            waitUntil: ctx.waitUntil,\n            onClose: (cb)=>{\n                res.on('close', cb);\n            },\n            onAfterTaskError: undefined,\n            onInstrumentationRequestError: (error, _request, errorContext)=>routeModule.onRequestError(req, error, errorContext, routerServerContext)\n        },\n        sharedContext: {\n            buildId\n        }\n    };\n    const nodeNextReq = new NodeNextRequest(req);\n    const nodeNextRes = new NodeNextResponse(res);\n    const nextReq = NextRequestAdapter.fromNodeNextRequest(nodeNextReq, signalFromNodeResponse(res));\n    try {\n        const invokeRouteModule = async (span)=>{\n            return routeModule.handle(nextReq, context).finally(()=>{\n                if (!span) return;\n                span.setAttributes({\n                    'http.status_code': res.statusCode,\n                    'next.rsc': false\n                });\n                const rootSpanAttributes = tracer.getRootSpanAttributes();\n                // We were unable to get attributes, probably OTEL is not enabled\n                if (!rootSpanAttributes) {\n                    return;\n                }\n                if (rootSpanAttributes.get('next.span_type') !== BaseServerSpan.handleRequest) {\n                    console.warn(`Unexpected root span type '${rootSpanAttributes.get('next.span_type')}'. Please report this Next.js issue https://github.com/vercel/next.js`);\n                    return;\n                }\n                const route = rootSpanAttributes.get('next.route');\n                if (route) {\n                    const name = `${method} ${route}`;\n                    span.setAttributes({\n                        'next.route': route,\n                        'http.route': route,\n                        'next.span_name': name\n                    });\n                    span.updateName(name);\n                } else {\n                    span.updateName(`${method} ${srcPage}`);\n                }\n            });\n        };\n        const isMinimalMode = Boolean(process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode'));\n        const handleResponse = async (currentSpan)=>{\n            var _cacheEntry_value;\n            const responseGenerator = async ({ previousCacheEntry })=>{\n                try {\n                    if (!isMinimalMode && isOnDemandRevalidate && revalidateOnlyGenerated && !previousCacheEntry) {\n                        res.statusCode = 404;\n                        // on-demand revalidate always sets this header\n                        res.setHeader('x-nextjs-cache', 'REVALIDATED');\n                        res.end('This page could not be found');\n                        return null;\n                    }\n                    const response = await invokeRouteModule(currentSpan);\n                    req.fetchMetrics = context.renderOpts.fetchMetrics;\n                    let pendingWaitUntil = context.renderOpts.pendingWaitUntil;\n                    // Attempt using provided waitUntil if available\n                    // if it's not we fallback to sendResponse's handling\n                    if (pendingWaitUntil) {\n                        if (ctx.waitUntil) {\n                            ctx.waitUntil(pendingWaitUntil);\n                            pendingWaitUntil = undefined;\n                        }\n                    }\n                    const cacheTags = context.renderOpts.collectedTags;\n                    // If the request is for a static response, we can cache it so long\n                    // as it's not edge.\n                    if (isIsr) {\n                        const blob = await response.blob();\n                        // Copy the headers from the response.\n                        const headers = toNodeOutgoingHttpHeaders(response.headers);\n                        if (cacheTags) {\n                            headers[NEXT_CACHE_TAGS_HEADER] = cacheTags;\n                        }\n                        if (!headers['content-type'] && blob.type) {\n                            headers['content-type'] = blob.type;\n                        }\n                        const revalidate = typeof context.renderOpts.collectedRevalidate === 'undefined' || context.renderOpts.collectedRevalidate >= INFINITE_CACHE ? false : context.renderOpts.collectedRevalidate;\n                        const expire = typeof context.renderOpts.collectedExpire === 'undefined' || context.renderOpts.collectedExpire >= INFINITE_CACHE ? undefined : context.renderOpts.collectedExpire;\n                        // Create the cache entry for the response.\n                        const cacheEntry = {\n                            value: {\n                                kind: CachedRouteKind.APP_ROUTE,\n                                status: response.status,\n                                body: Buffer.from(await blob.arrayBuffer()),\n                                headers\n                            },\n                            cacheControl: {\n                                revalidate,\n                                expire\n                            }\n                        };\n                        return cacheEntry;\n                    } else {\n                        // send response without caching if not ISR\n                        await sendResponse(nodeNextReq, nodeNextRes, response, context.renderOpts.pendingWaitUntil);\n                        return null;\n                    }\n                } catch (err) {\n                    // if this is a background revalidate we need to report\n                    // the request error here as it won't be bubbled\n                    if (previousCacheEntry == null ? void 0 : previousCacheEntry.isStale) {\n                        await routeModule.onRequestError(req, err, {\n                            routerKind: 'App Router',\n                            routePath: srcPage,\n                            routeType: 'route',\n                            revalidateReason: getRevalidateReason({\n                                isStaticGeneration,\n                                isOnDemandRevalidate\n                            })\n                        }, routerServerContext);\n                    }\n                    throw err;\n                }\n            };\n            const cacheEntry = await routeModule.handleResponse({\n                req,\n                nextConfig,\n                cacheKey,\n                routeKind: RouteKind.APP_ROUTE,\n                isFallback: false,\n                prerenderManifest,\n                isRoutePPREnabled: false,\n                isOnDemandRevalidate,\n                revalidateOnlyGenerated,\n                responseGenerator,\n                waitUntil: ctx.waitUntil,\n                isMinimalMode\n            });\n            // we don't create a cacheEntry for ISR\n            if (!isIsr) {\n                return null;\n            }\n            if ((cacheEntry == null ? void 0 : (_cacheEntry_value = cacheEntry.value) == null ? void 0 : _cacheEntry_value.kind) !== CachedRouteKind.APP_ROUTE) {\n                var _cacheEntry_value1;\n                throw Object.defineProperty(new Error(`Invariant: app-route received invalid cache entry ${cacheEntry == null ? void 0 : (_cacheEntry_value1 = cacheEntry.value) == null ? void 0 : _cacheEntry_value1.kind}`), \"__NEXT_ERROR_CODE\", {\n                    value: \"E701\",\n                    enumerable: false,\n                    configurable: true\n                });\n            }\n            if (!isMinimalMode) {\n                res.setHeader('x-nextjs-cache', isOnDemandRevalidate ? 'REVALIDATED' : cacheEntry.isMiss ? 'MISS' : cacheEntry.isStale ? 'STALE' : 'HIT');\n            }\n            // Draft mode should never be cached\n            if (isDraftMode) {\n                res.setHeader('Cache-Control', 'private, no-cache, no-store, max-age=0, must-revalidate');\n            }\n            const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers);\n            if (!(isMinimalMode && isIsr)) {\n                headers.delete(NEXT_CACHE_TAGS_HEADER);\n            }\n            // If cache control is already set on the response we don't\n            // override it to allow users to customize it via next.config\n            if (cacheEntry.cacheControl && !res.getHeader('Cache-Control') && !headers.get('Cache-Control')) {\n                headers.set('Cache-Control', getCacheControlHeader(cacheEntry.cacheControl));\n            }\n            await sendResponse(nodeNextReq, nodeNextRes, // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n            new Response(cacheEntry.value.body, {\n                headers,\n                status: cacheEntry.value.status || 200\n            }));\n            return null;\n        };\n        // TODO: activeSpan code path is for when wrapped by\n        // next-server can be removed when this is no longer used\n        if (activeSpan) {\n            await handleResponse(activeSpan);\n        } else {\n            await tracer.withPropagatedContext(req.headers, ()=>tracer.trace(BaseServerSpan.handleRequest, {\n                    spanName: `${method} ${srcPage}`,\n                    kind: SpanKind.SERVER,\n                    attributes: {\n                        'http.method': method,\n                        'http.target': req.url\n                    }\n                }, handleResponse));\n        }\n    } catch (err) {\n        if (!(err instanceof NoFallbackError)) {\n            await routeModule.onRequestError(req, err, {\n                routerKind: 'App Router',\n                routePath: normalizedSrcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                    isStaticGeneration,\n                    isOnDemandRevalidate\n                })\n            });\n        }\n        // rethrow so that we can handle serving error page\n        // If this is during static generation, throw the error again.\n        if (isIsr) throw err;\n        // Otherwise, send a 500 response.\n        await sendResponse(nodeNextReq, nodeNextRes, new Response(null, {\n            status: 500\n        }));\n        return null;\n    }\n}\n\n//# sourceMappingURL=app-route.js.map\n"],"names":[],"mappings":"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","ignoreList":[1]}