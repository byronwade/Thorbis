module.exports=[738832,e=>{"use strict";var t=e.i(755535),a=e.i(377233),n=e.i(490003),r=e.i(492991),o=e.i(241970),s=e.i(357699),i=e.i(212454),c=e.i(48717),d=e.i(798301),l=e.i(986366),u=e.i(983537),p=e.i(147475),m=e.i(561930),_=e.i(803747),y=e.i(368557),f=e.i(42037),h=e.i(193695);e.i(432036);var v=e.i(573881),I=e.i(297676),R=e.i(511368);async function w(e,t){let a=await (0,R.createClient)();if(!a)return null;let{data:n}=await a.from("finance_bank_accounts").select("id").eq("company_id",e).eq("is_active",!0).limit(1);if(!n||0===n.length)return null;let{data:r}=await a.from("company_payment_processors").select("*").eq("company_id",e).eq("status","active").order("created_at",{ascending:!1});if(!r||0===r.length)return null;if(t?.forceProcessor){let e=r.find(e=>e.processor_type===t.forceProcessor);if(e)return g(e)}let o=t?.amount||0,s=t?.channel||"online";if(o>1e6&&r.some(e=>"adyen"===e.processor_type)){let e=r.find(e=>"adyen"===e.processor_type);if(e)return g(e)}if(("card_present"===s||"tap_to_pay"===s)&&r.some(e=>"adyen"===e.processor_type)){let e=r.find(e=>"adyen"===e.processor_type);if(e)return g(e)}if("ach"===s){let e=r.find(e=>"plaid"===e.processor_type);if(e)return g(e);let t=r.find(e=>"profitstars"===e.processor_type);if(t)return g(t)}return g(r[0])}async function g(t){switch(t.processor_type){case"adyen":{let{AdyenProcessor:a}=await e.A(424167);return new a({companyId:t.company_id,accountId:t.adyen_account_id,apiKey:t.adyen_api_key_encrypted,merchantAccount:t.adyen_merchant_account,liveMode:t.adyen_live_mode})}case"plaid":{let{PlaidProcessor:a}=await e.A(277793);return new a({companyId:t.company_id,clientId:t.plaid_client_id,secret:t.plaid_secret_encrypted,environment:t.plaid_environment||"sandbox"})}case"profitstars":{let{ProfitStarsProcessor:a}=await e.A(888102);return new a({companyId:t.company_id,merchantId:t.profitstars_merchant_id,apiKey:t.profitstars_api_key_encrypted,routingNumber:t.profitstars_routing_number})}case"stripe":{let{StripeProcessor:a}=await e.A(111406);return new a({companyId:t.company_id,liveMode:t.adyen_live_mode})}default:return null}}async function x(e){try{let t=await (0,R.createClient)();if(!t)return I.NextResponse.json({success:!1,error:"Database unavailable"},{status:503});let{data:{user:a}}=await t.auth.getUser();if(!a)return I.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let n=await e.json();if(!n.clientId||!n.companyId||!n.amount)return I.NextResponse.json({success:!1,error:"Missing required fields"},{status:400});let{data:r}=await t.from("company_memberships").select("role").eq("user_id",a.id).eq("company_id",n.companyId).eq("status","active").single();if(!r)return I.NextResponse.json({success:!1,error:"Access denied to this company"},{status:403});let{data:o}=await t.from("payment_offline_queue").select("id, sync_status, payment_id, processor_transaction_id").eq("company_id",n.companyId).eq("client_id",n.clientId).single();if(o&&"succeeded"===o.sync_status)return I.NextResponse.json({success:!0,transactionId:o.processor_transaction_id,paymentId:o.payment_id,deduplicated:!0});let s={card:"online",ach:"ach",check:"check",cash:"online",financing:"online"}[n.paymentMethod]||"online";if("cash"===n.paymentMethod){let{data:e,error:a}=await t.from("payments").insert({company_id:n.companyId,customer_id:n.customerId,invoice_id:n.invoiceId,job_id:n.jobId,amount:n.amount,payment_method:"cash",status:"completed",notes:n.notes,metadata:{...n.metadata,offline_client_id:n.clientId,collected_at:n.collectedAt,collected_by:n.collectedBy,device_id:n.deviceId}}).select("id").single();if(a)return I.NextResponse.json({success:!1,error:a.message},{status:500});return await t.from("payment_offline_queue").upsert({company_id:n.companyId,client_id:n.clientId,customer_id:n.customerId,invoice_id:n.invoiceId,job_id:n.jobId,amount:n.amount,currency:n.currency,payment_method:n.paymentMethod,payment_data:n.paymentData,sync_status:"succeeded",payment_id:e.id,processed_at:new Date().toISOString(),collected_at:n.collectedAt,collected_by:n.collectedBy,device_id:n.deviceId}),I.NextResponse.json({success:!0,transactionId:`cash-${e.id}`,paymentId:e.id})}let i=await w(n.companyId,{amount:n.amount,channel:s});if(!i)return I.NextResponse.json({success:!1,error:"No payment processor configured for this company"},{status:400});let c=await i.processPayment({amount:n.amount,currency:n.currency,customerId:n.customerId||"",invoiceId:n.invoiceId,paymentMethodId:n.paymentData.paymentMethodId,channel:s,metadata:{...n.metadata,offline_client_id:n.clientId,collected_at:n.collectedAt,device_id:n.deviceId},description:n.notes});if(c.success&&c.transactionId){let{data:e}=await t.from("payments").insert({company_id:n.companyId,customer_id:n.customerId,invoice_id:n.invoiceId,job_id:n.jobId,amount:n.amount,payment_method:n.paymentMethod,status:"succeeded"===c.status?"completed":"pending",processor_id:c.transactionId,processor_transaction_id:c.processorTransactionId,notes:n.notes,metadata:{...n.metadata,offline_client_id:n.clientId,processor_response:c.processorMetadata}}).select("id").single();return await t.from("payment_offline_queue").upsert({company_id:n.companyId,client_id:n.clientId,customer_id:n.customerId,invoice_id:n.invoiceId,job_id:n.jobId,amount:n.amount,currency:n.currency,payment_method:n.paymentMethod,payment_data:n.paymentData,sync_status:"succeeded",processor_type:"adyen",processor_transaction_id:c.transactionId,payment_id:e?.id,processed_at:new Date().toISOString(),collected_at:n.collectedAt,collected_by:n.collectedBy,device_id:n.deviceId}),I.NextResponse.json({success:!0,transactionId:c.transactionId,paymentId:e?.id})}return await t.from("payment_offline_queue").upsert({company_id:n.companyId,client_id:n.clientId,customer_id:n.customerId,invoice_id:n.invoiceId,amount:n.amount,currency:n.currency,payment_method:n.paymentMethod,payment_data:n.paymentData,sync_status:"failed",last_error:c.error,last_error_code:c.failureCode,collected_at:n.collectedAt,collected_by:n.collectedBy}),I.NextResponse.json({success:!1,error:c.error||"Payment processing failed",failureCode:c.failureCode},{status:400})}catch(e){return console.error("[ProcessOfflinePayment] Error:",e),I.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Internal server error"},{status:500})}}e.s(["POST",()=>x],188030);var E=e.i(188030);let b=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/payments/process-offline/route",pathname:"/api/payments/process-offline",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/payments/process-offline/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:A,workUnitAsyncStorage:C,serverHooks:N}=b;function P(){return(0,n.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:C})}async function q(e,t,n){b.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let I="/api/payments/process-offline/route";I=I.replace(/\/index$/,"")||"/";let R=await b.prepare(e,t,{srcPage:I,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:w,params:g,nextConfig:x,parsedUrl:E,isDraftMode:A,prerenderManifest:C,routerServerContext:N,isOnDemandRevalidate:P,revalidateOnlyGenerated:q,resolvedPathname:M,clientReferenceManifest:j,serverActionsManifest:T}=R,O=(0,c.normalizeAppPath)(I),S=!!(C.dynamicRoutes[O]||C.routes[M]),D=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,E,!1):t.end("This page could not be found"),null);if(S&&!A){let e=!!C.routes[M],t=C.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await D();throw new h.NoFallbackError}}let k=null;!S||b.isDev||A||(k="/index"===(k=M)?"/":k);let U=!0===b.isDev||!S,H=S&&!U;T&&j&&(0,s.setReferenceManifestsSingleton)({page:I,clientReferenceManifest:j,serverActionsManifest:T,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:T})});let K=e.method||"GET",$=(0,o.getTracer)(),B=$.getActiveScopeSpan(),F={params:g,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n)=>b.onRequestError(e,t,n,N)},sharedContext:{buildId:w}},L=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),V=l.NextRequestAdapter.fromNodeNextRequest(L,(0,l.signalFromNodeResponse)(t));try{let s=async e=>b.handle(V,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=$.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${K} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${K} ${I}`)}),i=!!(0,r.getRequestMeta)(e,"minimalMode"),c=async r=>{var o,c;let d=async({previousCacheEntry:a})=>{try{if(!i&&P&&q&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await s(r);e.fetchMetrics=F.renderOpts.fetchMetrics;let c=F.renderOpts.pendingWaitUntil;c&&n.waitUntil&&(n.waitUntil(c),c=void 0);let d=F.renderOpts.collectedTags;if(!S)return await (0,m.sendResponse)(L,G,o,F.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(o.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,n=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==a?void 0:a.isStale)&&await b.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:P})},N),t}},l=await b.handleResponse({req:e,nextConfig:x,cacheKey:k,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:q,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:i});if(!S)return null;if((null==l||null==(o=l.value)?void 0:o.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(c=l.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",P?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,_.fromNodeOutgoingHttpHeaders)(l.value.headers);return i&&S||u.delete(f.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,y.getCacheControlHeader)(l.cacheControl)),await (0,m.sendResponse)(L,G,new Response(l.value.body,{headers:u,status:l.value.status||200})),null};B?await c(B):await $.withPropagatedContext(e.headers,()=>$.trace(u.BaseServerSpan.handleRequest,{spanName:`${K} ${I}`,kind:o.SpanKind.SERVER,attributes:{"http.method":K,"http.target":e.url}},c))}catch(t){if(t instanceof h.NoFallbackError||await b.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:P})}),S)throw t;return await (0,m.sendResponse)(L,G,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>P,"routeModule",()=>b,"serverHooks",()=>N,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>C],738832)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_4f1316df.js.map