module.exports=[189959,e=>{"use strict";var t=e.i(755535),a=e.i(377233),r=e.i(490003),n=e.i(492991),o=e.i(241970),i=e.i(357699),s=e.i(212454),l=e.i(48717),u=e.i(798301),c=e.i(986366),d=e.i(983537),p=e.i(147475),h=e.i(561930),m=e.i(803747),g=e.i(368557),y=e.i(42037),f=e.i(193695);e.i(432036);var b=e.i(573881),z=e.i(297676),w=e.i(443608);let S=w.z.object({isValid:w.z.boolean(),input:w.z.object({address1:w.z.string().optional(),address2:w.z.string(),city:w.z.string().optional(),state:w.z.string().optional(),zip5:w.z.string().optional(),zip4:w.z.string().optional()}),standardized:w.z.object({address1:w.z.string().optional(),address2:w.z.string(),city:w.z.string(),state:w.z.string(),zip5:w.z.string(),zip4:w.z.string().optional(),deliveryPoint:w.z.string().optional()}).optional(),error:w.z.string().optional(),suggestions:w.z.array(w.z.string()).optional(),enrichedAt:w.z.string()}),v=new class{uspsUserId;constructor(){this.uspsUserId=process.env.USPS_USER_ID}async validateAddress(e){if(!this.uspsUserId)return{isValid:!1,input:e,error:"USPS API not configured",enrichedAt:new Date().toISOString()};try{let t=this.buildUSPSXML(e),a=`https://secure.shippingapis.com/ShippingAPI.dll?API=Verify&XML=${encodeURIComponent(t)}`,r=await fetch(a,{headers:{"User-Agent":"Thorbis-FMS/1.0 (support@thorbis.app)"}});if(!r.ok)throw Error(`USPS API failed: ${r.status}`);let n=await r.text(),o=this.parseUSPSResponse(n,e);return S.parse(o)}catch(t){return{isValid:!1,input:e,error:t instanceof Error?t.message:"Unknown validation error",enrichedAt:new Date().toISOString()}}}buildUSPSXML(e){return`<AddressValidateRequest USERID="${this.uspsUserId}"><Revision>1</Revision><Address ID="0"><Address1>${this.escapeXML(e.address1||"")}</Address1><Address2>${this.escapeXML(e.address2)}</Address2><City>${this.escapeXML(e.city||"")}</City><State>${this.escapeXML(e.state||"")}</State><Zip5>${e.zip5||""}</Zip5><Zip4>${e.zip4||""}</Zip4></Address></AddressValidateRequest>`}parseUSPSResponse(e,t){if(e.includes("<Error>")){let a=e.match(/<Description>(.*?)<\/Description>/),r=a?a[1]:"Unknown USPS error";return{isValid:!1,input:t,error:r,suggestions:this.extractSuggestions(r)}}try{let a=e.match(/<Address1>(.*?)<\/Address1>/),r=e.match(/<Address2>(.*?)<\/Address2>/),n=e.match(/<City>(.*?)<\/City>/),o=e.match(/<State>(.*?)<\/State>/),i=e.match(/<Zip5>(.*?)<\/Zip5>/),s=e.match(/<Zip4>(.*?)<\/Zip4>/),l=e.match(/<DPVConfirmation>(.*?)<\/DPVConfirmation>/);if(!(r&&n&&o&&i))return{isValid:!1,input:t,error:"Incomplete address data from USPS"};return{isValid:!0,input:t,standardized:{address1:a?a[1]:void 0,address2:r[1],city:n[1],state:o[1],zip5:i[1],zip4:s?s[1]:void 0,deliveryPoint:l?l[1]:void 0}}}catch(e){return{isValid:!1,input:t,error:"Failed to parse USPS response"}}}extractSuggestions(e){let t=[];return e.toLowerCase().includes("invalid")&&(t.push("Check street address spelling"),t.push("Verify city and state")),e.toLowerCase().includes("zip")&&t.push("Verify ZIP code is correct for this city/state"),(e.toLowerCase().includes("apartment")||e.toLowerCase().includes("unit"))&&t.push("Include apartment or unit number if applicable"),t}escapeXML(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}isAddressComplete(e){return!!(e.address2&&e.city&&e.state&&e.zip5&&5===e.zip5.length)}},A=w.z.object({footprint:w.z.object({area:w.z.number().optional(),perimeter:w.z.number().optional(),coordinates:w.z.array(w.z.array(w.z.number())).optional()}).optional(),buildingType:w.z.string().optional(),height:w.z.number().optional(),levels:w.z.number().optional(),roofShape:w.z.string().optional(),roofMaterial:w.z.string().optional(),wallMaterial:w.z.string().optional(),constructionDate:w.z.string().optional(),addressFromOSM:w.z.object({houseNumber:w.z.string().optional(),street:w.z.string().optional(),city:w.z.string().optional(),state:w.z.string().optional(),postcode:w.z.string().optional()}).optional(),dataSource:w.z.literal("osm"),osmId:w.z.number().optional(),osmType:w.z.enum(["node","way","relation"]).optional(),enrichedAt:w.z.string()});class ${cache=new Map;cacheTTL=2592e6;async getBuildingData(e,t){let a=`building:${e.toFixed(6)},${t.toFixed(6)}`,r=this.cache.get(a);if(r&&Date.now()-r.timestamp<this.cacheTTL)return r.data;try{let r=`
        [out:json][timeout:25];
        (
          way(around:25,${e},${t})["building"];
          relation(around:25,${e},${t})["building"];
        );
        out tags geom;
      `.trim(),n=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",headers:{"Content-Type":"text/plain","User-Agent":"Thorbis-FMS/1.0 (support@thorbis.app)"},body:r});if(!n.ok)return null;let o=(await n.json()).elements||[];if(0===o.length)return null;let i=o[0],s=i.tags||{},l={buildingType:this.normalizeBuildingType(s.building),height:s.height?Number.parseFloat(s.height):void 0,levels:s["building:levels"]?Number.parseInt(s["building:levels"],10):void 0,roofShape:s["roof:shape"],roofMaterial:s["roof:material"],wallMaterial:s["wall:material"]||s["building:material"],constructionDate:s.start_date||s.construction_date,addressFromOSM:{houseNumber:s["addr:housenumber"],street:s["addr:street"],city:s["addr:city"],state:s["addr:state"],postcode:s["addr:postcode"]},osmId:i.id,osmType:i.type,dataSource:"osm",enrichedAt:new Date().toISOString()};if(i.geometry&&i.geometry.length>0){let e=i.geometry.map(e=>[e.lon,e.lat]),t=this.calculatePolygonArea(e),a=this.calculatePolygonPerimeter(e);l.footprint={area:Math.round(t),perimeter:Math.round(a),coordinates:e}}let u=A.parse(l);return this.cache.set(a,{data:u,timestamp:Date.now()}),u}catch(e){return null}}normalizeBuildingType(e){if(e&&"yes"!==e)return({house:"residential",detached:"residential",semidetached_house:"residential",terrace:"residential",apartments:"residential",residential:"residential",commercial:"commercial",retail:"commercial",office:"commercial",industrial:"industrial",warehouse:"industrial",shed:"storage",garage:"storage",garages:"storage",church:"religious",school:"educational",hospital:"healthcare",hotel:"hospitality"})[e.toLowerCase()]||e}calculatePolygonArea(e){if(e.length<3)return 0;let t=0;for(let a=0;a<e.length;a++){let r=(a+1)%e.length;t+=e[a][0]*e[r][1],t-=e[r][0]*e[a][1]}return 111e3*(t=Math.abs(t/2))*(111e3*Math.cos(e[0][1]*Math.PI/180))}calculatePolygonPerimeter(e){if(e.length<2)return 0;let t=0;for(let a=0;a<e.length;a++){let r=(a+1)%e.length,n=e[a][1],o=e[a][0],i=e[r][1],s=e[r][0],l=(i-n)*Math.PI/180,u=(s-o)*Math.PI/180,c=Math.sin(l/2)*Math.sin(l/2)+Math.cos(n*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.sin(u/2)*Math.sin(u/2);t+=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))*6371e3}return t}}let M=new $,I="Thorbis-FMS/1.0 (support@thorbis.app)";w.z.object({population:w.z.number().optional(),populationDensity:w.z.number().optional(),medianHouseholdIncome:w.z.number().optional(),medianAge:w.z.number().optional(),educationBachelorsOrHigher:w.z.number().optional(),housingUnits:w.z.number().optional(),medianHomeValue:w.z.number().optional(),povertyRate:w.z.number().optional(),unemploymentRate:w.z.number().optional(),dataSource:w.z.string(),enrichedAt:w.z.string()});class P{cache=new Map;cacheTTL=7776e6;async getDemographics(e,t){let a=`demographics:${e.toFixed(4)},${t.toFixed(4)}`,r=this.cache.get(a);if(r&&Date.now()-r.timestamp<this.cacheTTL)return r.data;try{let r,n=`https://geo.fcc.gov/api/census/block/find?latitude=${e}&longitude=${t}&format=json`,o=await fetch(n,{headers:{"User-Agent":I}});if(!o.ok)return null;let i=await o.json(),s=i.State?.FIPS,l=i.County?.FIPS,u=i.Block?.FIPS?.substring(0,11);if(!(s&&l&&u))return null;let c=`https://api.census.gov/data/2022/acs/acs5?get=B01003_001E,B19013_001E,B01002_001E,B15003_022E,B15003_023E,B15003_024E,B15003_025E,B15003_001E,B25077_001E,B17001_002E,B17001_001E,B23025_005E,B23025_003E&for=tract:${u.substring(5)}&in=state:${s}%20county:${l}`,d=await fetch(c,{headers:{"User-Agent":I}});if(!d.ok)return null;let p=await d.text();if(!p||""===p.trim())return null;try{r=JSON.parse(p)}catch(e){return null}if(!Array.isArray(r)||r.length<2)return null;let h=r[1],m=Number.parseInt(h[0],10)||0,g=Number.parseInt(h[1],10)||0,y=Number.parseFloat(h[2])||0,f=Number.parseInt(h[3],10)||0,b=Number.parseInt(h[4],10)||0,z=Number.parseInt(h[5],10)||0,w=Number.parseInt(h[6],10)||0,S=Number.parseInt(h[7],10)||1,v=Number.parseInt(h[8],10)||0,A=Number.parseInt(h[9],10)||0,$=Number.parseInt(h[10],10)||1,M=Number.parseInt(h[11],10)||0,P=Number.parseInt(h[12],10)||1,C={population:m,medianHouseholdIncome:g,medianAge:y,educationBachelorsOrHigher:Math.round((f+b+z+w)/S*1e3)/10,medianHomeValue:v,povertyRate:Math.round(A/$*1e3)/10,unemploymentRate:Math.round(M/P*1e3)/10,dataSource:"census",enrichedAt:new Date().toISOString()};return this.cache.set(a,{data:C,timestamp:Date.now()}),C}catch(e){return null}}}let C=new P;w.z.object({elevationFeet:w.z.number(),elevationMeters:w.z.number(),dataSource:w.z.string(),enrichedAt:w.z.string()});class T{cache=new Map;cacheTTL=31536e6;async getElevation(e,t){let a=`elevation:${e.toFixed(6)},${t.toFixed(6)}`,r=this.cache.get(a);if(r&&Date.now()-r.timestamp<this.cacheTTL)return r.data;try{let r,n=`https://epqs.nationalmap.gov/v1/json?x=${t}&y=${e}&units=Feet&includeDate=false`,o=await fetch(n,{headers:{"User-Agent":"Thorbis-FMS/1.0 (support@thorbis.app)"}});if(!o.ok)return null;let i=await o.text();if(!i||""===i.trim())return null;try{r=JSON.parse(i)}catch(e){return null}if(!r||"object"!=typeof r||!("value"in r))return null;let s=r;if(!s.value)return null;let l=Number.parseFloat(s.value),u=.3048*l,c={elevationFeet:Math.round(l),elevationMeters:Math.round(10*u)/10,dataSource:"usgs",enrichedAt:new Date().toISOString()};return this.cache.set(a,{data:c,timestamp:Date.now()}),c}catch(e){return null}}}let D=new T;var R=e.i(774407);w.z.object({mainView:w.z.string(),alternateViews:w.z.array(w.z.string()).optional(),heading:w.z.number().optional(),pitch:w.z.number().optional(),fov:w.z.number().optional(),available:w.z.boolean(),dataSource:w.z.string(),enrichedAt:w.z.string()});class x{apiKey;cache=new Map;cacheTTL=7776e6;constructor(){this.apiKey="AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0"}async getStreetView(e,t,a){if(!this.apiKey)return null;let r=`streetview:${e.toFixed(6)},${t.toFixed(6)}`,n=this.cache.get(r);if(n&&Date.now()-n.timestamp<this.cacheTTL)return n.data;try{let n=`https://maps.googleapis.com/maps/api/streetview/metadata?location=${e},${t}&key=${this.apiKey}`,o=await fetch(n);if(!o.ok)return null;let i=await o.json();if("OK"!==i.status)return{mainView:"",available:!1,dataSource:"google-streetview",enrichedAt:new Date().toISOString()};let s="600x400",l=a?`location=${encodeURIComponent(a)}`:`location=${e},${t}`,u=`https://maps.googleapis.com/maps/api/streetview?size=${s}&${l}&heading=0&pitch=0&fov=90&key=${this.apiKey}`,c=[`https://maps.googleapis.com/maps/api/streetview?size=${s}&${l}&heading=90&pitch=0&fov=90&key=${this.apiKey}`,`https://maps.googleapis.com/maps/api/streetview?size=${s}&${l}&heading=180&pitch=0&fov=90&key=${this.apiKey}`,`https://maps.googleapis.com/maps/api/streetview?size=${s}&${l}&heading=270&pitch=0&fov=90&key=${this.apiKey}`],d={mainView:u,alternateViews:c,heading:0,pitch:0,fov:90,available:!0,dataSource:"google-streetview",enrichedAt:new Date().toISOString()};return this.cache.set(r,{data:d,timestamp:Date.now()}),d}catch(e){return null}}getImageUrl(e,t,a=0,r="600x400"){return this.apiKey?`https://maps.googleapis.com/maps/api/streetview?size=${r}&location=${e},${t}&heading=${a}&key=${this.apiKey}`:null}getPanoramaUrl(e,t){return`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${e},${t}`}}let j=new x,O="Thorbis-FMS/1.0 (support@thorbis.app)",F=w.z.object({lat:w.z.number(),lon:w.z.number(),displayName:w.z.string(),address:w.z.object({house_number:w.z.string().optional(),road:w.z.string().optional(),city:w.z.string().optional(),state:w.z.string().optional(),postcode:w.z.string().optional(),country:w.z.string().optional()}).optional()}),N=w.z.object({countyFips:w.z.string(),countyName:w.z.string(),stateFips:w.z.string(),stateCode:w.z.string(),blockFips:w.z.string().optional()}),_=w.z.object({inFloodZone:w.z.boolean(),zone:w.z.string().optional(),floodway:w.z.boolean().optional(),riskLevel:w.z.enum(["high","moderate","minimal","unknown"]),description:w.z.string()});w.z.object({coordinates:w.z.object({lat:w.z.number(),lon:w.z.number()}),county:N.optional(),floodZone:_.optional(),enrichedAt:w.z.string()});class E{cache=new Map;cacheTTL=6048e5;async geocodeWithGoogle(e){try{let t=new URLSearchParams({address:e,key:"AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0"}),a=await fetch(`https://maps.googleapis.com/maps/api/geocode/json?${t}`,{signal:AbortSignal.timeout(1e4)});if(!a.ok)return null;let r=await a.json();if("OK"!==r.status||!r.results||0===r.results.length)return null;let n=r.results[0],o=n.geometry.location,i=n.address_components||[],s=e=>i.find(t=>t.types.includes(e))?.long_name,l={lat:o.lat,lon:o.lng,displayName:n.formatted_address,address:{house_number:s("street_number"),road:s("route"),city:s("locality")||s("sublocality")||s("postal_town"),state:i.find(e=>e.types.includes("administrative_area_level_1"))?.short_name,postcode:s("postal_code"),country:s("country")}};return F.parse(l)}catch(e){return"TimeoutError"===e.name||"AbortError"===e.name?console.warn("Google Geocoding: Request timed out for address"):console.error("Google Geocoding error:",e.message),null}}async geocodeWithNominatim(e){try{let t=new URLSearchParams({q:e,format:"jsonv2",addressdetails:"1",limit:"1"}),a=await fetch(`https://nominatim.openstreetmap.org/search?${t}`,{headers:{"User-Agent":O},signal:AbortSignal.timeout(15e3)});if(!a.ok)return 429===a.status?console.warn("Nominatim Geocoding: Rate limited - try again in a few seconds"):console.warn(`Nominatim Geocoding: HTTP ${a.status} error`),null;let r=await a.json();if(!Array.isArray(r)||0===r.length)return null;let n=r[0],o={lat:Number.parseFloat(n.lat),lon:Number.parseFloat(n.lon),displayName:n.display_name,address:n.address?{house_number:n.address.house_number,road:n.address.road,city:n.address.city||n.address.town||n.address.village,state:n.address.state,postcode:n.address.postcode,country:n.address.country}:void 0};return F.parse(o)}catch(e){return"TimeoutError"===e.name||"AbortError"===e.name?console.warn("Nominatim Geocoding: Request timed out"):console.error("Nominatim Geocoding error:",e.message),null}}async geocode(e){let t=`geocode:${e}`,a=this.cache.get(t);if(a&&Date.now()-a.timestamp<this.cacheTTL)return a.data;let r=await this.geocodeWithGoogle(e);return r||(r=await this.geocodeWithNominatim(e)),r&&this.cache.set(t,{data:r,timestamp:Date.now()}),r}async reverseGeocode(e,t){let a=`reverse:${e},${t}`,r=this.cache.get(a);if(r&&Date.now()-r.timestamp<this.cacheTTL)return r.data;try{let r=new URLSearchParams({lat:e.toString(),lon:t.toString(),format:"jsonv2",addressdetails:"1"}),n=await fetch(`https://nominatim.openstreetmap.org/reverse?${r}`,{headers:{"User-Agent":O}});if(!n.ok)return null;let o=await n.json(),i={lat:Number.parseFloat(o.lat),lon:Number.parseFloat(o.lon),displayName:o.display_name,address:o.address?{house_number:o.address.house_number,road:o.address.road,city:o.address.city||o.address.town||o.address.village,state:o.address.state,postcode:o.address.postcode,country:o.address.country}:void 0};return this.cache.set(a,{data:i,timestamp:Date.now()}),F.parse(i)}catch(e){return null}}async getCountyData(e,t){let a=`county:${e},${t}`,r=this.cache.get(a);if(r&&Date.now()-r.timestamp<this.cacheTTL)return r.data;try{let r=`https://geo.fcc.gov/api/census/block/find?latitude=${e}&longitude=${t}&format=json`,n=await fetch(r,{headers:{"User-Agent":O}});if(!n.ok)return null;let o=await n.json(),i={countyFips:o.County?.FIPS||"",countyName:o.County?.name||"",stateFips:o.State?.FIPS||"",stateCode:o.State?.code||"",blockFips:o.Block?.FIPS};return this.cache.set(a,{data:i,timestamp:Date.now()}),N.parse(i)}catch(e){return null}}async getFloodZoneData(e,t){let a=`flood:${e},${t}`,r=this.cache.get(a);if(r&&Date.now()-r.timestamp<this.cacheTTL)return r.data;try{let r=new URLSearchParams({f:"json",geometry:JSON.stringify({x:t,y:e,spatialReference:{wkid:4326}}),geometryType:"esriGeometryPoint",sr:"4326",layers:"all:28",tolerance:"1",mapExtent:`${t-.01},${e-.01},${t+.01},${e+.01}`,imageDisplay:"800,600,96",returnGeometry:"false"}),n=`https://hazards.fema.gov/gis/nfhl/rest/services/public/NFHL/MapServer/identify?${r.toString()}`,o=await fetch(n,{headers:{"User-Agent":O}});if(!o.ok)return 404===o.status||console.warn(`Flood Zone API error: ${o.status} for location (${e}, ${t})`),null;let i=((await o.json()).results||[]).find(e=>/Zone [A|AE|AO|AH|VE|V]/i.test(e.attributes?.FLD_ZONE||""));if(i){let e=i.attributes.FLD_ZONE,t="FLOODWAY"===i.attributes.FLOODWAY,r="high",n="";e.startsWith("V")?(r="high",n="High-risk coastal flood zone with wave action."):e.startsWith("A")?(r="high",n="High-risk flood zone. Flood insurance required."):e.startsWith("X")&&(r="moderate",n="Moderate flood risk area."),t&&(n+=" Located in regulatory floodway.");let o={inFloodZone:!0,zone:e,floodway:t,riskLevel:r,description:n};return this.cache.set(a,{data:o,timestamp:Date.now()}),_.parse(o)}let s={inFloodZone:!1,riskLevel:"minimal",description:"Not in a mapped flood zone."};return this.cache.set(a,{data:s,timestamp:Date.now()}),_.parse(s)}catch(e){return null}}async getLocationIntelligence(e,t){let[a,r]=await Promise.all([this.getCountyData(e,t),this.getFloodZoneData(e,t)]);return{coordinates:{lat:e,lon:t},county:a||void 0,floodZone:r||void 0,enrichedAt:new Date().toISOString()}}clearCache(){this.cache.clear()}}let k=new E;w.z.object({address:w.z.object({full:w.z.string(),street:w.z.string(),city:w.z.string(),state:w.z.string(),zipCode:w.z.string()}),characteristics:w.z.object({propertyType:w.z.string().optional(),yearBuilt:w.z.number().optional(),squareFeet:w.z.number().optional(),lotSize:w.z.number().optional(),bedrooms:w.z.number().optional(),bathrooms:w.z.number().optional(),stories:w.z.number().optional(),garage:w.z.boolean().optional(),pool:w.z.boolean().optional()}).optional(),assessment:w.z.object({assessedValue:w.z.number().optional(),taxAmount:w.z.number().optional(),assessmentYear:w.z.number().optional()}).optional(),market:w.z.object({estimatedValue:w.z.number().optional(),estimatedValueRange:w.z.object({low:w.z.number(),high:w.z.number()}).optional(),pricePerSqFt:w.z.number().optional(),lastSoldDate:w.z.string().optional(),lastSoldPrice:w.z.number().optional()}).optional(),demographics:w.z.object({medianHouseholdIncome:w.z.number().optional(),medianHomeValue:w.z.number().optional(),population:w.z.number().optional()}).optional(),dataSource:w.z.string(),enrichedAt:w.z.string()});class L{rentcastApiKey;attomApiKey;cache=new Map;cacheTTL=2592e6;constructor(){this.rentcastApiKey=process.env.RENTCAST_API_KEY,this.attomApiKey=process.env.ATTOM_API_KEY}async getPropertyData(e,t,a,r,n,o){let i=`${e}-${t}-${a}-${r}`,s=this.cache.get(i);if(s&&Date.now()-s.timestamp<this.cacheTTL)return s.data;try{let n=`${e}, ${t}, ${a} ${r}`,o=await this.getRentCastData(e,t,a,r);return!o&&this.attomApiKey&&(o=await this.getAttomData(e,t,a,r)),o||(o={address:{full:n,street:e,city:t,state:a,zipCode:r},dataSource:"none",enrichedAt:new Date().toISOString()}),this.cache.set(i,{data:o,timestamp:Date.now()}),o}catch(e){return null}}async getRentCastData(e,t,a,r){if(!this.rentcastApiKey)return null;try{let n=`https://api.rentcast.io/v1/properties?address=${encodeURIComponent(e)}&city=${encodeURIComponent(t)}&state=${encodeURIComponent(a)}&zipCode=${encodeURIComponent(r)}`,o=await fetch(n,{headers:{"X-Api-Key":this.rentcastApiKey,Accept:"application/json"}});if(!o.ok)return null;let i=await o.json();if(!i?.id)return null;return{address:{full:`${e}, ${t}, ${a} ${r}`,street:e,city:t,state:a,zipCode:r},characteristics:{propertyType:i.propertyType,yearBuilt:i.yearBuilt,squareFeet:i.squareFootage,lotSize:i.lotSize,bedrooms:i.bedrooms,bathrooms:i.bathrooms,stories:i.stories,garage:!!i.garage||void 0,pool:!!i.pool||void 0},assessment:i.assessedValue?{assessedValue:i.assessedValue,taxAmount:i.propertyTaxes,assessmentYear:i.assessedYear}:void 0,market:{estimatedValue:i.price||i.addressedValue,lastSoldDate:i.lastSaleDate,lastSoldPrice:i.lastSalePrice,pricePerSqFt:i.price&&i.squareFootage?Math.round(i.price/i.squareFootage):void 0},dataSource:"rentcast",enrichedAt:new Date().toISOString()}}catch(e){return null}}async getAttomData(e,t,a,r){if(!this.attomApiKey)return null;try{let n=`https://api.gateway.attomdata.com/propertyapi/v1.0.0/property/basicprofile?address1=${encodeURIComponent(e)}&address2=${encodeURIComponent(`${t}, ${a} ${r}`)}`,o=await fetch(n,{headers:{apikey:this.attomApiKey,Accept:"application/json"}});if(!o.ok)return null;let i=await o.json(),s=i.property?.[0];if(!s)return null;let l=s.building,u=s.summary,c=s.assessment,d=s.sale;return{address:{full:`${e}, ${t}, ${a} ${r}`,street:e,city:t,state:a,zipCode:r},characteristics:{propertyType:l?.propertyType||u?.proptype,yearBuilt:l?.yearBuilt?Number.parseInt(l.yearBuilt,10):void 0,squareFeet:l?.size?.livingSize?Number.parseInt(l.size.livingSize,10):void 0,lotSize:u?.lotSize?Number.parseInt(u.lotSize,10):void 0,bedrooms:l?.rooms?.beds?Number.parseInt(l.rooms.beds,10):void 0,bathrooms:l?.rooms?.bathstotal?Number.parseInt(l.rooms.bathstotal,10):void 0,stories:l?.stories?Number.parseInt(l.stories,10):void 0,garage:!!l?.parking?.garagetype||void 0,pool:!!l?.pool||void 0},assessment:c?{assessedValue:c.assessed?.assdTtlValue?Number.parseInt(c.assessed.assdTtlValue,10):void 0,taxAmount:c.tax?.taxAmt?Number.parseInt(c.tax.taxAmt,10):void 0,assessmentYear:c.assessed?.assdYear?Number.parseInt(c.assessed.assdYear,10):void 0}:void 0,market:d?{lastSoldDate:d.saleTransDate,lastSoldPrice:d.amount?.saleAmt?Number.parseInt(d.amount.saleAmt,10):void 0}:void 0,dataSource:"attom",enrichedAt:new Date().toISOString()}}catch(e){return null}}estimateCharacteristics(e){let t={};if(e.characteristics?.yearBuilt){t.ageYears=new Date().getFullYear()-e.characteristics.yearBuilt,t.ageYears<5?t.propertyCondition="new":t.ageYears<15?t.propertyCondition="good":t.ageYears<30?t.propertyCondition="average":t.ageYears<50?t.propertyCondition="fair":t.propertyCondition="poor";let a=[];t.ageYears>15&&a.push("Water heater likely needs replacement (15-20 year lifespan)"),t.ageYears>20&&a.push("HVAC system may need replacement (15-25 year lifespan)"),t.ageYears>25&&a.push("Plumbing systems should be inspected for corrosion"),t.ageYears>30&&a.push("Electrical panel upgrade may be needed"),t.recommendMaintenance=a}return t}}let U=new L,K="Thorbis-FMS/1.0 (support@thorbis.app)",q=["https://overpass-api.de/api/interpreter","https://overpass.kumi.systems/api/interpreter","https://overpass.openstreetmap.ru/api/interpreter"];w.z.object({distance:w.z.number(),duration:w.z.number(),from:w.z.object({lat:w.z.number(),lon:w.z.number()}),to:w.z.object({lat:w.z.number(),lon:w.z.number()})});let V=w.z.object({id:w.z.number(),name:w.z.string().optional(),lat:w.z.number(),lon:w.z.number(),type:w.z.string(),distance:w.z.number().optional()}),Y=new class{orsApiKey;overpassCache;overpassRequestTimestamps=[];currentOverpassInstanceIndex=0;constructor(){this.orsApiKey=process.env.ORS_API_KEY,this.overpassCache=new Map}async getRoute(e,t){if(!this.orsApiKey)return this.getStraightLineRoute(e,t);try{let a=await fetch("https://api.openrouteservice.org/v2/directions/driving-car",{method:"POST",headers:{Authorization:this.orsApiKey,"Content-Type":"application/json","User-Agent":K},body:JSON.stringify({coordinates:[[e.lon,e.lat],[t.lon,t.lat]],preference:"fastest"})});if(!a.ok)return this.getStraightLineRoute(e,t);let r=await a.json(),n=r.routes?.[0];if(!n)return this.getStraightLineRoute(e,t);return{distance:n.summary.distance,duration:n.summary.duration,from:e,to:t}}catch(a){return this.getStraightLineRoute(e,t)}}async getRouteMatrix(e,t){if(!this.orsApiKey)return null;try{let a=[...e.map(e=>[e.lon,e.lat]),...t.map(e=>[e.lon,e.lat])],r=e.map((e,t)=>t),n=t.map((t,a)=>e.length+a),o=await fetch("https://api.openrouteservice.org/v2/matrix/driving-car",{method:"POST",headers:{Authorization:this.orsApiKey,"Content-Type":"application/json","User-Agent":K},body:JSON.stringify({locations:a,sources:r,destinations:n,metrics:["duration","distance"]})});if(!o.ok)return null;let i=await o.json();return{durations:i.durations||[],distances:i.distances||[]}}catch(e){return null}}canMakeOverpassRequest(){let e=Date.now();return this.overpassRequestTimestamps=this.overpassRequestTimestamps.filter(t=>t>e-6e4),this.overpassRequestTimestamps.length<2}recordOverpassRequest(){this.overpassRequestTimestamps.push(Date.now())}async waitForRateLimit(){if(this.canMakeOverpassRequest()||0===this.overpassRequestTimestamps.length)return;let e=Math.min(...this.overpassRequestTimestamps)+6e4-Date.now()+1e3;e>0&&await new Promise(t=>setTimeout(t,e))}async makeOverpassRequest(e,t=3){let a;for(let r=0;r<=t;r++){await this.waitForRateLimit();let n=(this.currentOverpassInstanceIndex+r)%q.length,o=q[n];try{this.recordOverpassRequest();let a=await fetch(o,{method:"POST",headers:{"Content-Type":"text/plain","User-Agent":K},body:e});if(429===a.status){let e=a.headers.get("Retry-After"),o=e?1e3*Number.parseInt(e,10):2**r*1e3;if(r<t){await new Promise(e=>setTimeout(e,o)),this.currentOverpassInstanceIndex=(n+1)%q.length;continue}}if(!a.ok)throw Error(`Overpass API returned ${a.status} from ${o}`);return this.currentOverpassInstanceIndex=(n+1)%q.length,a}catch(e){if(a=e instanceof Error?e:Error(String(e)),r<t){let e=2**r*1e3;await new Promise(t=>setTimeout(t,e)),this.currentOverpassInstanceIndex=(n+1)%q.length}}}throw a||Error("Max retries exceeded for Overpass API")}async findNearbySuppliers(e,t,a=8e3){let r=`${e.toFixed(4)}_${t.toFixed(4)}_${a}`,n=this.overpassCache.get(r);if(n&&Date.now()-n.timestamp<36e5)return n.data;try{let n=`
        [out:json][timeout:25];
        (
          node(around:${a},${e},${t})["shop"="hardware"];
          node(around:${a},${e},${t})["shop"="doityourself"];
          node(around:${a},${e},${t})["shop"="trade"]["trade"="plumbing"];
          way(around:${a},${e},${t})["shop"="hardware"];
          way(around:${a},${e},${t})["shop"="doityourself"];
        );
        out center 30;
      `.trim(),o=await this.makeOverpassRequest(n),i=((await o.json()).elements||[]).map(a=>{let r=a.lat??a.center?.lat,n=a.lon??a.center?.lon;if(!(r&&n))return null;let o=this.calculateDistance(e,t,r,n);return{id:a.id,name:a.tags?.name||"Unknown Supplier",lat:r,lon:n,type:a.tags?.shop||a.tags?.trade||"hardware",distance:o}}).filter(e=>null!==e).sort((e,t)=>(e.distance||0)-(t.distance||0)).slice(0,10).map(e=>V.parse(e));if(this.overpassCache.set(r,{data:i,timestamp:Date.now()}),this.overpassCache.size>100){let e=Array.from(this.overpassCache.entries());e.sort((e,t)=>t[1].timestamp-e[1].timestamp),this.overpassCache=new Map(e.slice(0,100))}return i}catch(e){if(n)return n.data;return[]}}getStraightLineRoute(e,t){let a=this.calculateDistance(e.lat,e.lon,t.lat,t.lon);return{distance:a,duration:a/4e4*3600,from:e,to:t}}calculateDistance(e,t,a,r){let n=e*Math.PI/180,o=a*Math.PI/180,i=(a-e)*Math.PI/180,s=(r-t)*Math.PI/180,l=Math.sin(i/2)*Math.sin(i/2)+Math.cos(n)*Math.cos(o)*Math.sin(s/2)*Math.sin(s/2);return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371e3}formatDuration(e){if(e<60)return`${Math.round(e)}s`;if(e<3600)return`${Math.round(e/60)}min`;let t=Math.floor(e/3600),a=Math.round(e%3600/60);return`${t}h ${a}min`}formatDistance(e){return e<1e3?`${Math.round(e)}m`:`${(e/1e3).toFixed(1)}km`}},W=w.z.object({name:w.z.string(),type:w.z.string().optional(),operator:w.z.string().optional(),distance:w.z.number(),lat:w.z.number(),lon:w.z.number()});w.z.object({schools:w.z.array(W),closestSchool:w.z.number().optional(),totalSchools:w.z.number(),dataSource:w.z.string(),enrichedAt:w.z.string()});class H{cache=new Map;cacheTTL=7776e6;async getNearbySchools(e,t,a=5e3){let r=`schools:${e.toFixed(4)},${t.toFixed(4)}`,n=this.cache.get(r);if(n&&Date.now()-n.timestamp<this.cacheTTL)return n.data;try{let n=`
        [out:json][timeout:25];
        (
          node(around:${a},${e},${t})["amenity"="school"];
          way(around:${a},${e},${t})["amenity"="school"];
          node(around:${a},${e},${t})["amenity"="kindergarten"];
          node(around:${a},${e},${t})["amenity"="college"];
          node(around:${a},${e},${t})["amenity"="university"];
        );
        out center tags;
      `.trim(),o=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",headers:{"Content-Type":"text/plain","User-Agent":"Thorbis-FMS/1.0 (support@thorbis.app)"},body:n});if(!o.ok)return null;let i=await o.json();if(!i.elements||0===i.elements.length)return{schools:[],totalSchools:0,dataSource:"osm",enrichedAt:new Date().toISOString()};let s=i.elements.map(a=>{let r=a.tags||{},n=a.center?.lat||a.lat,o=a.center?.lon||a.lon,i=this.calculateDistance(e,t,n,o);return{name:r.name||"Unnamed School",type:this.getSchoolType(r),operator:r.operator||r["operator:type"],distance:Math.round(i),lat:n,lon:o}});s.sort((e,t)=>e.distance-t.distance);let l={schools:s.slice(0,10),closestSchool:s[0]?.distance,totalSchools:s.length,dataSource:"osm",enrichedAt:new Date().toISOString()};return this.cache.set(r,{data:l,timestamp:Date.now()}),l}catch(e){return null}}getSchoolType(e){if("kindergarten"===e.amenity)return"Preschool";if("university"===e.amenity)return"University";if("college"===e.amenity)return"College";if(e["isced:level"]){let t=e["isced:level"];if(t.includes("0")||t.includes("1"))return"Elementary";if(t.includes("2"))return"Middle School";if(t.includes("3"))return"High School"}return"School"}calculateDistance(e,t,a,r){let n=e*Math.PI/180,o=a*Math.PI/180,i=(a-e)*Math.PI/180,s=(r-t)*Math.PI/180,l=Math.sin(i/2)*Math.sin(i/2)+Math.cos(n)*Math.cos(o)*Math.sin(s/2)*Math.sin(s/2);return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371e3}}let B=new H;w.z.object({timeZoneId:w.z.string(),timeZoneName:w.z.string(),rawOffset:w.z.number(),dstOffset:w.z.number(),totalOffset:w.z.number(),totalOffsetHours:w.z.number(),isDST:w.z.boolean(),dataSource:w.z.string(),enrichedAt:w.z.string()});class G{apiKey;cache=new Map;cacheTTL=2592e6;constructor(){this.apiKey="AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0"}async getTimeZone(e,t){if(!this.apiKey)return null;let a=`timezone:${e.toFixed(4)},${t.toFixed(4)}`,r=this.cache.get(a);if(r&&Date.now()-r.timestamp<this.cacheTTL)return r.data;try{let r=Math.floor(Date.now()/1e3),n=`https://maps.googleapis.com/maps/api/timezone/json?location=${e},${t}&timestamp=${r}&key=${this.apiKey}`,o=await fetch(n,{headers:{"User-Agent":"Thorbis-FMS/1.0 (support@thorbis.app)"}});if(!o.ok)return null;let i=await o.json();if("OK"!==i.status)return null;let s=i.rawOffset+i.dstOffset,l=0!==i.dstOffset,u={timeZoneId:i.timeZoneId,timeZoneName:i.timeZoneName,rawOffset:i.rawOffset,dstOffset:i.dstOffset,totalOffset:s,totalOffsetHours:s/3600,isDST:l,dataSource:"google-timezone",enrichedAt:new Date().toISOString()};return this.cache.set(a,{data:u,timestamp:Date.now()}),u}catch(e){return null}}formatOffset(e){let t=e>=0?"+":"-",a=Math.abs(e),r=Math.floor(a),n=Math.round((a-r)*60);return 0===n?`UTC${t}${r}`:`UTC${t}${r}:${n.toString().padStart(2,"0")}`}getCurrentLocalTime(e){return new Date(new Date().toLocaleString("en-US",{timeZone:e}))}isSameTimeZone(e){return e===Intl.DateTimeFormat().resolvedOptions().timeZone}}let Z=new G;var Q=e.i(136200);w.z.object({score:w.z.number(),category:w.z.string(),nearbyAmenities:w.z.object({restaurants:w.z.number(),shops:w.z.number(),schools:w.z.number(),parks:w.z.number(),transit:w.z.number(),healthcare:w.z.number()}),closestTransit:w.z.number().optional(),dataSource:w.z.string(),enrichedAt:w.z.string()});class X{cache=new Map;cacheTTL=2592e6;async getWalkability(e,t){let a=`walkability:${e.toFixed(4)},${t.toFixed(4)}`,r=this.cache.get(a);if(r&&Date.now()-r.timestamp<this.cacheTTL)return r.data;try{let r=`
        [out:json][timeout:25];
        (
          node(around:1000,${e},${t})["amenity"~"restaurant|cafe|fast_food|bar|pub"];
          node(around:1000,${e},${t})["shop"];
          node(around:1000,${e},${t})["amenity"~"school|kindergarten|college|university"];
          node(around:1000,${e},${t})["leisure"~"park|playground|garden"];
          node(around:1000,${e},${t})["public_transport"];
          node(around:1000,${e},${t})["amenity"~"hospital|clinic|doctors|pharmacy"];
        );
        out count;
      `.trim(),n=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",headers:{"Content-Type":"text/plain","User-Agent":"Thorbis-FMS/1.0 (support@thorbis.app)"},body:r});if(!n.ok)return null;let o=await n.json(),i={restaurants:0,shops:0,schools:0,parks:0,transit:0,healthcare:0};if(o.elements)for(let e of o.elements){let t=e.tags||{};t.amenity&&(["restaurant","cafe","fast_food","bar","pub"].includes(t.amenity)?i.restaurants++:["school","kindergarten","college","university"].includes(t.amenity)?i.schools++:["hospital","clinic","doctors","pharmacy"].includes(t.amenity)&&i.healthcare++),t.shop&&i.shops++,t.leisure&&["park","playground","garden"].includes(t.leisure)&&i.parks++,t.public_transport&&i.transit++}let s=Math.min(100,2*i.restaurants+2*i.shops+5*i.schools+3*i.parks+10*i.transit+5*i.healthcare),l=this.getWalkabilityCategory(s),u={score:Math.round(s),category:l,nearbyAmenities:i,dataSource:"osm",enrichedAt:new Date().toISOString()};return this.cache.set(a,{data:u,timestamp:Date.now()}),u}catch(e){return null}}getWalkabilityCategory(e){return e>=90?"Walker's Paradise":e>=70?"Very Walkable":e>=50?"Somewhat Walkable":e>=25?"Car-Dependent":"Very Car-Dependent"}}let J=new X,ee=w.z.object({location:w.z.object({lat:w.z.number(),lon:w.z.number(),siteName:w.z.string().optional(),organization:w.z.string().optional()}),hardness:w.z.object({valueMgL:w.z.number(),classification:w.z.enum(["soft","moderate","hard","very_hard"]),unit:w.z.string(),measurementDate:w.z.string().optional()}),recommendations:w.z.object({shouldInstallSoftener:w.z.boolean(),reason:w.z.string(),estimatedAnnualSavings:w.z.number().optional()}),enrichedAt:w.z.string()});class et{cache=new Map;cacheTTL=2592e6;async getWaterQuality(e,t){let a=`${e.toFixed(4)},${t.toFixed(4)}`,r=this.cache.get(a);if(r&&Date.now()-r.timestamp<this.cacheTTL)return r.data;try{let r=new URLSearchParams({mimeType:"json",zip:"no",characteristicName:"Hardness, Ca, Mg as CaCO3",lat:e.toFixed(6),long:t.toFixed(6),within:"25",sorted:"no",startDateLo:this.getDateYearsAgo(5)}),n=`https://www.waterqualitydata.us/data/Result/search?${r}`,o=await fetch(n,{headers:{"User-Agent":"Thorbis-FMS/1.0 (support@thorbis.app)",Accept:"application/json"}});if(!o.ok)return 404===o.status||406===o.status||console.warn(`Water quality API error: ${o.status} for location (${e}, ${t})`),null;let i=await o.json();if(!(i&&Array.isArray(i))||0===i.length)return this.getDefaultWaterQuality(e,t);let s=i.filter(e=>e.ResultMeasureValue&&!Number.isNaN(Number(e.ResultMeasureValue))).map(e=>({value:Number(e.ResultMeasureValue),unit:e.ResultMeasure?.MeasureUnitCode||"mg/L",date:e.ActivityStartDate,site:e.MonitoringLocationName,org:e.OrganizationFormalName})).sort((e,t)=>{let a=new Date(e.date||0);return new Date(t.date||0).getTime()-a.getTime()});if(0===s.length)return this.getDefaultWaterQuality(e,t);let l=s[0],u=l.value,c=this.classifyHardness(u),d=this.generateRecommendations(u,c),p={location:{lat:e,lon:t,siteName:l.site,organization:l.org},hardness:{valueMgL:u,classification:c,unit:l.unit,measurementDate:l.date},recommendations:d,enrichedAt:new Date().toISOString()};return this.cache.set(a,{data:p,timestamp:Date.now()}),ee.parse(p)}catch(e){return null}}classifyHardness(e){return e<60?"soft":e<120?"moderate":e<180?"hard":"very_hard"}generateRecommendations(e,t){let a,r="";return"soft"===t?r="Your water is soft and doesn't require a softener.":"moderate"===t?(r="Your water hardness is moderate. A softener is optional but may extend appliance life.",a=2e4):"hard"===t?(r="Your water is hard. We recommend installing a water softener to protect your pipes and appliances.",a=5e4):(r="Your water is very hard. A water softener is highly recommended to prevent scale buildup and extend equipment life.",a=8e4),{shouldInstallSoftener:e>=120,reason:r,estimatedAnnualSavings:a}}getDefaultWaterQuality(e,t){return{location:{lat:e,lon:t},hardness:{valueMgL:100,classification:"moderate",unit:"mg/L"},recommendations:{shouldInstallSoftener:!1,reason:"No local water hardness data available. National average suggests moderate hardness."},enrichedAt:new Date().toISOString()}}getDateYearsAgo(e){let t=new Date;return t.setFullYear(t.getFullYear()-e),t.toISOString().split("T")[0]}clearCache(){this.cache.clear()}}let ea=new et,er="Thorbis-FMS/1.0 (support@thorbis.app)",en=w.z.object({lat:w.z.number(),lng:w.z.number()}),eo=w.z.object({distance:w.z.number(),duration:w.z.number(),durationInTraffic:w.z.number(),from:en,to:en,polyline:w.z.string().optional(),summary:w.z.string().optional(),warnings:w.z.array(w.z.string()).optional(),trafficDelay:w.z.number()}),ei=w.z.object({originIndex:w.z.number(),destinationIndex:w.z.number(),distance:w.z.number(),duration:w.z.number(),durationInTraffic:w.z.number(),status:w.z.enum(["OK","NOT_FOUND","ZERO_RESULTS"])}),es=w.z.object({elements:w.z.array(ei),originAddresses:w.z.array(w.z.string()).optional(),destinationAddresses:w.z.array(w.z.string()).optional()}),el=w.z.object({totalDistance:w.z.number(),totalDuration:w.z.number(),totalDurationInTraffic:w.z.number(),optimizedOrder:w.z.array(w.z.number()),legs:w.z.array(w.z.object({from:en,to:en,distance:w.z.number(),duration:w.z.number(),durationInTraffic:w.z.number(),polyline:w.z.string().optional()})),polyline:w.z.string().optional()});class eu{apiKey;routeCache=new Map;matrixCache=new Map;constructor(){this.apiKey=process.env.GOOGLE_API_KEY||"AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0"}isAvailable(){return!!this.apiKey}async getRoute(e,t){if(!this.apiKey)return console.warn("Google Routes Service: No API key configured"),this.getFallbackRoute(e,t);let a=`route:${e.lat.toFixed(5)},${e.lng.toFixed(5)}-${t.lat.toFixed(5)},${t.lng.toFixed(5)}`,r=this.routeCache.get(a);if(r&&Date.now()-r.timestamp<3e5)return r.data;try{let r=new URL("https://maps.googleapis.com/maps/api/directions/json");r.searchParams.set("origin",`${e.lat},${e.lng}`),r.searchParams.set("destination",`${t.lat},${t.lng}`),r.searchParams.set("departure_time","now"),r.searchParams.set("traffic_model","best_guess"),r.searchParams.set("key",this.apiKey);let n=await fetch(r.toString(),{headers:{"User-Agent":er}});if(!n.ok)return console.error(`Google Routes API error: ${n.status} ${n.statusText}`),this.getFallbackRoute(e,t);let o=await n.json();if("OK"!==o.status||!o.routes?.[0])return console.warn(`Google Routes API returned status: ${o.status}`),this.getFallbackRoute(e,t);let i=o.routes[0],s=i.legs[0],l=s.duration?.value||0,u=s.duration_in_traffic?.value||l,c={distance:s.distance?.value||0,duration:l,durationInTraffic:u,from:e,to:t,polyline:i.overview_polyline?.points,summary:i.summary,warnings:i.warnings||[],trafficDelay:Math.max(0,u-l)},d=eo.parse(c);return this.routeCache.set(a,{data:d,timestamp:Date.now()}),this.cleanCache(this.routeCache,3e5),d}catch(a){return console.error("Google Routes Service error:",a),this.getFallbackRoute(e,t)}}async getRouteMatrix(e,t){if(!this.apiKey)return console.warn("Google Routes Service: No API key configured for matrix"),null;if(0===e.length||0===t.length)return null;let a=e.slice(0,25),r=t.slice(0,25),n=`matrix:${a.map(e=>`${e.lat.toFixed(4)},${e.lng.toFixed(4)}`).join("|")}-${r.map(e=>`${e.lat.toFixed(4)},${e.lng.toFixed(4)}`).join("|")}`,o=this.matrixCache.get(n);if(o&&Date.now()-o.timestamp<6e5)return o.data;try{let e=new URL("https://maps.googleapis.com/maps/api/distancematrix/json");e.searchParams.set("origins",a.map(e=>`${e.lat},${e.lng}`).join("|")),e.searchParams.set("destinations",r.map(e=>`${e.lat},${e.lng}`).join("|")),e.searchParams.set("departure_time","now"),e.searchParams.set("traffic_model","best_guess"),e.searchParams.set("key",this.apiKey);let t=await fetch(e.toString(),{headers:{"User-Agent":er}});if(!t.ok)return console.error(`Google Distance Matrix API error: ${t.status} ${t.statusText}`),null;let o=await t.json();if("OK"!==o.status)return console.warn(`Google Distance Matrix API status: ${o.status}`),null;let i=[];for(let e=0;e<o.rows.length;e++)for(let t=0;t<o.rows[e].elements.length;t++){let a=o.rows[e].elements[t],r=a.duration?.value||0,n=a.duration_in_traffic?.value||r;i.push({originIndex:e,destinationIndex:t,distance:a.distance?.value||0,duration:r,durationInTraffic:n,status:"OK"===a.status?"OK":"ZERO_RESULTS"===a.status?"ZERO_RESULTS":"NOT_FOUND"})}let s={elements:i,originAddresses:o.origin_addresses,destinationAddresses:o.destination_addresses},l=es.parse(s);return this.matrixCache.set(n,{data:l,timestamp:Date.now()}),this.cleanCache(this.matrixCache,6e5),l}catch(e){return console.error("Google Distance Matrix error:",e),null}}async getETA(e,t){let a=await this.getRoute(e,t);if(!a)return null;let r=new Date(new Date().getTime()+1e3*a.durationInTraffic),n=Math.ceil(a.durationInTraffic/60),o=Math.ceil(a.trafficDelay/60);return{eta:r,durationMinutes:n,durationText:this.formatDuration(a.durationInTraffic),trafficDelayMinutes:o}}async rankTechniciansByETA(e,t){if(0===e.length)return[];let a=e.map(e=>e.location),r=await this.getRouteMatrix(a,[t]);return r?e.map((e,t)=>{let a=r.elements.find(e=>e.originIndex===t&&0===e.destinationIndex);return a&&"OK"===a.status?{id:e.id,name:e.name,etaMinutes:Math.ceil(a.durationInTraffic/60),distanceKm:a.distance/1e3,trafficDelayMinutes:Math.ceil((a.durationInTraffic-a.duration)/60)}:{id:e.id,name:e.name,etaMinutes:1/0,distanceKm:0,trafficDelayMinutes:0}}).sort((e,t)=>e.etaMinutes-t.etaMinutes):(await Promise.all(e.map(async e=>{let a=await this.getRoute(e.location,t);return{id:e.id,name:e.name,etaMinutes:a?Math.ceil(a.durationInTraffic/60):1/0,distanceKm:a?a.distance/1e3:0,trafficDelayMinutes:a?Math.ceil(a.trafficDelay/60):0}}))).sort((e,t)=>e.etaMinutes-t.etaMinutes)}async getMultiStopRoute(e,t,a=!1){if(0===t.length)return null;if(1===t.length){let a=await this.getRoute(e,t[0]);return a?{totalDistance:a.distance,totalDuration:a.duration,totalDurationInTraffic:a.durationInTraffic,optimizedOrder:[0],legs:[{from:e,to:t[0],distance:a.distance,duration:a.duration,durationInTraffic:a.durationInTraffic,polyline:a.polyline}],polyline:a.polyline}:null}let r=[e,...t],n=await this.getRouteMatrix(r,r);if(!n)return this.getSequentialRoute(e,t,a);let o=new Set,i=[],s=0;for(;i.length<t.length;){let e=-1,a=1/0;for(let r=1;r<=t.length;r++){if(o.has(r))continue;let t=n.elements.find(e=>e.originIndex===s&&e.destinationIndex===r);t&&"OK"===t.status&&t.durationInTraffic<a&&(a=t.durationInTraffic,e=r)}if(-1===e)break;o.add(e),i.push(e-1),s=e}let l=[],u=0,c=0,d=0,p=e;for(let e of i){let a=t[e],r=await this.getRoute(p,a);r&&(l.push({from:p,to:a,distance:r.distance,duration:r.duration,durationInTraffic:r.durationInTraffic,polyline:r.polyline}),u+=r.distance,c+=r.duration,d+=r.durationInTraffic),p=a}if(a&&l.length>0){let t=await this.getRoute(p,e);t&&(l.push({from:p,to:e,distance:t.distance,duration:t.duration,durationInTraffic:t.durationInTraffic,polyline:t.polyline}),u+=t.distance,c+=t.duration,d+=t.durationInTraffic)}return el.parse({totalDistance:u,totalDuration:c,totalDurationInTraffic:d,optimizedOrder:i,legs:l})}async getSequentialRoute(e,t,a){let r=[],n=0,o=0,i=0,s=e;for(let e=0;e<t.length;e++){let a=await this.getRoute(s,t[e]);a&&(r.push({from:s,to:t[e],distance:a.distance,duration:a.duration,durationInTraffic:a.durationInTraffic,polyline:a.polyline}),n+=a.distance,o+=a.duration,i+=a.durationInTraffic),s=t[e]}if(a){let t=await this.getRoute(s,e);t&&(r.push({from:s,to:e,distance:t.distance,duration:t.duration,durationInTraffic:t.durationInTraffic,polyline:t.polyline}),n+=t.distance,o+=t.duration,i+=t.durationInTraffic)}return{totalDistance:n,totalDuration:o,totalDurationInTraffic:i,optimizedOrder:t.map((e,t)=>t),legs:r}}getFallbackRoute(e,t){let a=this.calculateHaversineDistance(e,t),r=Math.round(a/4e4*3600);return{distance:Math.round(a),duration:r,durationInTraffic:r,from:e,to:t,trafficDelay:0,warnings:["Using estimated route - Google API unavailable"]}}calculateHaversineDistance(e,t){let a=e.lat*Math.PI/180,r=t.lat*Math.PI/180,n=(t.lat-e.lat)*Math.PI/180,o=(t.lng-e.lng)*Math.PI/180,i=Math.sin(n/2)*Math.sin(n/2)+Math.cos(a)*Math.cos(r)*Math.sin(o/2)*Math.sin(o/2);return 2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))*6371e3}formatDuration(e){if(e<60)return`${Math.round(e)} sec`;if(e<3600)return`${Math.round(e/60)} min`;let t=Math.floor(e/3600),a=Math.round(e%3600/60);return`${t}h ${a}min`}formatDistance(e){return e<1e3?`${Math.round(e)} m`:`${(e/1e3*.621371).toFixed(1)} mi`}cleanCache(e,t){let a=Date.now();for(let[r,n]of e.entries())a-n.timestamp>2*t&&e.delete(r);if(e.size>500){let t=Array.from(e.entries());for(let[a,r]of(t.sort((e,t)=>t[1].timestamp-e[1].timestamp),e.clear(),t.slice(0,250)))e.set(a,r)}}clearCache(){this.routeCache.clear(),this.matrixCache.clear()}}let ec=new eu;var ed=e.i(849797),ep=e.i(356622),eh=e.i(266299);let em=w.z.object({sw:w.z.object({lat:w.z.number(),lng:w.z.number()}),ne:w.z.object({lat:w.z.number(),lng:w.z.number()})}),eg=w.z.object({pitchDegrees:w.z.number(),azimuthDegrees:w.z.number(),stats:w.z.object({areaMeters2:w.z.number(),sunshineQuantiles:w.z.array(w.z.number()).optional(),groundAreaMeters2:w.z.number().optional()}),center:w.z.object({lat:w.z.number(),lng:w.z.number()}).optional(),boundingBox:em.optional(),planeHeightAtCenterMeters:w.z.number().optional()}),ey=w.z.object({panelsCount:w.z.number(),yearlyEnergyDcKwh:w.z.number(),roofSegmentSummaries:w.z.array(w.z.object({pitchDegrees:w.z.number(),azimuthDegrees:w.z.number(),panelsCount:w.z.number(),yearlyEnergyDcKwh:w.z.number(),segmentIndex:w.z.number()})).optional()}),ef=w.z.object({monthlyBill:w.z.object({currencyCode:w.z.string(),units:w.z.string(),nanos:w.z.number().optional()}),panelConfigIndex:w.z.number(),financialDetails:w.z.object({initialAcKwhPerYear:w.z.number(),remainingLifetimeUtilityBill:w.z.object({currencyCode:w.z.string(),units:w.z.string()}),federalIncentive:w.z.object({currencyCode:w.z.string(),units:w.z.string()}).optional(),stateIncentive:w.z.object({currencyCode:w.z.string(),units:w.z.string()}).optional(),utilityIncentive:w.z.object({currencyCode:w.z.string(),units:w.z.string()}).optional(),lifetimeSrecTotal:w.z.object({currencyCode:w.z.string(),units:w.z.string()}).optional(),costOfElectricityWithoutSolar:w.z.object({currencyCode:w.z.string(),units:w.z.string()}).optional(),netMeteringAllowed:w.z.boolean().optional(),solarPercentage:w.z.number().optional(),percentageExportedToGrid:w.z.number().optional()}).optional(),leasingSavings:w.z.object({leasesAllowed:w.z.boolean(),leasesSupported:w.z.boolean(),annualLeasingCost:w.z.object({currencyCode:w.z.string(),units:w.z.string()}).optional(),savings:w.z.object({savingsYear1:w.z.object({currencyCode:w.z.string(),units:w.z.string()}),savingsYear20:w.z.object({currencyCode:w.z.string(),units:w.z.string()}),savingsLifetime:w.z.object({currencyCode:w.z.string(),units:w.z.string()})}).optional()}).optional(),cashPurchaseSavings:w.z.object({outOfPocketCost:w.z.object({currencyCode:w.z.string(),units:w.z.string()}),upfrontCost:w.z.object({currencyCode:w.z.string(),units:w.z.string()}),rebateValue:w.z.object({currencyCode:w.z.string(),units:w.z.string()}).optional(),paybackYears:w.z.number().optional(),savings:w.z.object({savingsYear1:w.z.object({currencyCode:w.z.string(),units:w.z.string()}),savingsYear20:w.z.object({currencyCode:w.z.string(),units:w.z.string()}),savingsLifetime:w.z.object({currencyCode:w.z.string(),units:w.z.string()})})}).optional(),financedPurchaseSavings:w.z.object({annualLoanPayment:w.z.object({currencyCode:w.z.string(),units:w.z.string()}),loanInterestRate:w.z.number(),savings:w.z.object({savingsYear1:w.z.object({currencyCode:w.z.string(),units:w.z.string()}),savingsYear20:w.z.object({currencyCode:w.z.string(),units:w.z.string()}),savingsLifetime:w.z.object({currencyCode:w.z.string(),units:w.z.string()})}).optional()}).optional()}),eb=w.z.object({name:w.z.string().optional(),center:w.z.object({lat:w.z.number(),lng:w.z.number()}),boundingBox:em.optional(),imageryDate:w.z.object({year:w.z.number(),month:w.z.number(),day:w.z.number()}).optional(),imageryProcessedDate:w.z.object({year:w.z.number(),month:w.z.number(),day:w.z.number()}).optional(),postalCode:w.z.string().optional(),administrativeArea:w.z.string().optional(),statisticalArea:w.z.string().optional(),regionCode:w.z.string().optional(),solarPotential:w.z.object({maxArrayPanelsCount:w.z.number(),maxArrayAreaMeters2:w.z.number(),maxSunshineHoursPerYear:w.z.number(),carbonOffsetFactorKgPerMwh:w.z.number(),wholeRoofStats:w.z.object({areaMeters2:w.z.number(),sunshineQuantiles:w.z.array(w.z.number()).optional(),groundAreaMeters2:w.z.number().optional()}).optional(),roofSegmentStats:w.z.array(eg).optional(),solarPanelConfigs:w.z.array(ey).optional(),financialAnalyses:w.z.array(ef).optional(),panelCapacityWatts:w.z.number().optional(),panelHeightMeters:w.z.number().optional(),panelWidthMeters:w.z.number().optional(),panelLifetimeYears:w.z.number().optional()})}),ez=w.z.object({location:w.z.object({lat:w.z.number(),lng:w.z.number()}),buildingInsights:eb.optional(),dataQuality:w.z.enum(["HIGH","MEDIUM","LOW","IMAGERY_UNAVAILABLE"]),source:w.z.enum(["google"]),enrichedAt:w.z.string()});class ew{apiKey;cache=new Map;constructor(){this.apiKey=process.env.GOOGLE_API_KEY||"AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0"}isAvailable(){return!!this.apiKey}async getSolarData(e,t){let a=`solar:${e.toFixed(6)},${t.toFixed(6)}`,r=this.cache.get(a);if(r&&Date.now()-r.timestamp<864e5)return r.data;if(!this.apiKey)return console.warn("Google Solar Service: No API key configured"),null;try{let r=new URL("https://solar.googleapis.com/v1/buildingInsights:findClosest");r.searchParams.set("location.latitude",e.toString()),r.searchParams.set("location.longitude",t.toString()),r.searchParams.set("requiredQuality","LOW"),r.searchParams.set("key",this.apiKey);let n=await fetch(r.toString(),{headers:{"User-Agent":"Thorbis-FMS/1.0 (support@thorbis.app)"}});if(!n.ok){if(404===n.status)return{location:{lat:e,lng:t},dataQuality:"IMAGERY_UNAVAILABLE",source:"google",enrichedAt:new Date().toISOString()};return console.error(`Google Solar API error: ${n.status}`),null}let o=await n.json(),i={location:{lat:e,lng:t},buildingInsights:o,dataQuality:o.imageryQuality||"MEDIUM",source:"google",enrichedAt:new Date().toISOString()},s=ez.parse(i);return this.cache.set(a,{data:s,timestamp:Date.now()}),this.cleanCache(),s}catch(e){return console.error("Google Solar fetch error:",e),null}}getSolarSummary(e){if(!e.buildingInsights?.solarPotential)return{hasData:!1,maxPanels:0,maxAreaSqFt:0,yearlyEnergyKwh:0,carbonOffsetLbs:0,sunshineHoursPerYear:0,roofSegments:0,bestRoofPitch:0,bestRoofDirection:"Unknown",dataQuality:e.dataQuality};let t=e.buildingInsights.solarPotential,a=t.solarPanelConfigs||[],r=t.roofSegmentStats||[],n=a.reduce((e,t)=>t.panelsCount>(e?.panelsCount||0)?t:e,a[0]),o=r.reduce((e,t)=>{if(!e)return t;let a=180-Math.abs(180-e.azimuthDegrees);return 180-Math.abs(180-t.azimuthDegrees)>a?t:e},r[0]);return{hasData:!0,maxPanels:t.maxArrayPanelsCount,maxAreaSqFt:Math.round(10.764*t.maxArrayAreaMeters2),yearlyEnergyKwh:Math.round(n?.yearlyEnergyDcKwh||0),carbonOffsetLbs:Math.round(t.carbonOffsetFactorKgPerMwh*((n?.yearlyEnergyDcKwh||0)/1e3)*2.205/1),sunshineHoursPerYear:Math.round(t.maxSunshineHoursPerYear),roofSegments:r.length,bestRoofPitch:Math.round(o?.pitchDegrees||0),bestRoofDirection:o?["N","NE","E","SE","S","SW","W","NW"][Math.round(o.azimuthDegrees/45)%8]:"Unknown",dataQuality:e.dataQuality}}getFinancialAnalysis(e,t){if(!e.buildingInsights?.solarPotential)return null;let a=e.buildingInsights.solarPotential,r=a.financialAnalyses||[],n=r.reduce((e,a)=>{if(!e)return a;let r=parseFloat(e.monthlyBill.units);return Math.abs(parseFloat(a.monthlyBill.units)-t)<Math.abs(r-t)?a:e},r[0]);if(!n)return null;let o=a.solarPanelConfigs||[],i=o[n.panelConfigIndex]||o[0],s=n.cashPurchaseSavings,l=n.financialDetails,u=a.panelCapacityWatts||400,c=i?i.panelsCount*u*2.75:0,d=.3*c,p=i?.yearlyEnergyDcKwh||0,h=.15*p;return{hasData:!0,recommendedPanels:i?.panelsCount||0,estimatedCost:Math.round(c),yearlyProduction:Math.round(p),yearlyValueGenerated:Math.round(h),monthlyBillReduction:Math.round(h/12),paybackYears:s?.paybackYears||Math.round(c/h),twentyYearSavings:s?.savings?.savingsYear20?parseFloat(s.savings.savingsYear20.units):Math.round(20*h-c+d),federalTaxCredit:Math.round(d),solarPercentage:l?.solarPercentage||0}}isSuitableForSolar(e){if(!e.buildingInsights?.solarPotential)return{suitable:!1,score:0,reasons:[],concerns:["No solar data available for this location"]};let t=e.buildingInsights.solarPotential,a=[],r=[],n=50;t.maxSunshineHoursPerYear>1500?(a.push(`Excellent sunshine: ${Math.round(t.maxSunshineHoursPerYear)} hours/year`),n+=20):t.maxSunshineHoursPerYear>1200?(a.push(`Good sunshine: ${Math.round(t.maxSunshineHoursPerYear)} hours/year`),n+=10):(r.push(`Limited sunshine: ${Math.round(t.maxSunshineHoursPerYear)} hours/year`),n-=10),t.maxArrayAreaMeters2>50?(a.push(`Large roof area: ${Math.round(10.764*t.maxArrayAreaMeters2)} sq ft available`),n+=15):t.maxArrayAreaMeters2>25?(a.push(`Adequate roof area: ${Math.round(10.764*t.maxArrayAreaMeters2)} sq ft`),n+=5):(r.push(`Limited roof area: ${Math.round(10.764*t.maxArrayAreaMeters2)} sq ft`),n-=15),t.maxArrayPanelsCount>30?(a.push(`Can fit ${t.maxArrayPanelsCount} panels`),n+=10):t.maxArrayPanelsCount>15?(a.push(`Can fit ${t.maxArrayPanelsCount} panels`),n+=5):t.maxArrayPanelsCount<10&&(r.push(`Limited panel capacity: ${t.maxArrayPanelsCount} panels`),n-=10);let o=(t.roofSegmentStats||[]).filter(e=>e.azimuthDegrees>=135&&e.azimuthDegrees<=225);return o.length>0?(a.push(`${o.length} south-facing roof section(s)`),n+=10):(r.push("No south-facing roof sections"),n-=5),"HIGH"===e.dataQuality?n+=5:"LOW"===e.dataQuality&&(r.push("Limited imagery quality - estimates may be less accurate"),n-=5),{suitable:(n=Math.max(0,Math.min(100,n)))>=50,score:n,reasons:a,concerns:r}}generateProposalSummary(e,t){let a=this.getSolarSummary(e),r=this.getFinancialAnalysis(e,t),n=this.isSuitableForSolar(e);if(!a?.hasData||!r?.hasData)return{headline:"Solar assessment unavailable",systemSize:"N/A",panelCount:0,estimatedCost:"N/A",federalCredit:"N/A",netCost:"N/A",yearlyProduction:"N/A",monthlyOffset:"N/A",paybackPeriod:"N/A",twentyYearSavings:"N/A",carbonOffset:"N/A",suitable:!1,concerns:["Solar data not available for this location"]};let o=(r.recommendedPanels*(e.buildingInsights?.solarPotential?.panelCapacityWatts||400)/1e3).toFixed(1);return{headline:n.suitable?`Great solar potential! Save up to $${r.twentyYearSavings.toLocaleString()} over 20 years`:"Solar may be limited at this property",systemSize:`${o} kW system`,panelCount:r.recommendedPanels,estimatedCost:`$${r.estimatedCost.toLocaleString()}`,federalCredit:`$${r.federalTaxCredit.toLocaleString()} (30% ITC)`,netCost:`$${(r.estimatedCost-r.federalTaxCredit).toLocaleString()}`,yearlyProduction:`${r.yearlyProduction.toLocaleString()} kWh/year`,monthlyOffset:`$${r.monthlyBillReduction}/month`,paybackPeriod:`${r.paybackYears} years`,twentyYearSavings:`$${r.twentyYearSavings.toLocaleString()}`,carbonOffset:`${a.carbonOffsetLbs.toLocaleString()} lbs CO/year`,suitable:n.suitable,concerns:n.concerns}}cleanCache(){let e=Date.now();for(let[t,a]of this.cache.entries())e-a.timestamp>1728e5&&this.cache.delete(t);if(this.cache.size>200){let e=Array.from(this.cache.entries());for(let[t,a]of(e.sort((e,t)=>t[1].timestamp-e[1].timestamp),this.cache.clear(),e.slice(0,100)))this.cache.set(t,a)}}clearCache(){this.cache.clear()}}let eS=new ew,ev=w.z.object({jobId:w.z.string().uuid(),location:w.z.object({lat:w.z.number(),lon:w.z.number(),address:w.z.string()}),propertyData:w.z.any().optional(),buildingData:w.z.any().optional(),weather:w.z.any().optional(),waterQuality:w.z.any().optional(),addressValidation:w.z.any().optional(),locationIntelligence:w.z.any().optional(),nearbySuppliers:w.z.array(w.z.any()).optional(),demographics:w.z.any().optional(),airQuality:w.z.any().optional(),pollen:w.z.any().optional(),solar:w.z.any().optional(),elevation:w.z.any().optional(),walkability:w.z.any().optional(),schools:w.z.any().optional(),streetView:w.z.any().optional(),googlePlaces:w.z.any().optional(),timeZone:w.z.any().optional(),traffic:w.z.any().optional(),recommendations:w.z.object({shouldReschedule:w.z.boolean(),rescheduleReason:w.z.string().optional(),upsellOpportunities:w.z.array(w.z.string()),safetyWarnings:w.z.array(w.z.string()),hvacRecommendations:w.z.array(w.z.object({type:w.z.string(),reason:w.z.string(),urgency:w.z.enum(["low","medium","high"]),estimatedValue:w.z.number().optional()})).optional(),solarRecommendation:w.z.object({suitable:w.z.boolean(),summary:w.z.string(),estimatedSavings:w.z.number().optional(),panelCount:w.z.number().optional()}).optional()}),enrichmentStatus:w.z.enum(["pending","in_progress","completed","failed"]),enrichedAt:w.z.string().optional(),sources:w.z.array(w.z.string())}),eA=new Map,e$=new class{getCacheKey(e){return`enrichment:${e.id}:${e.lat||0}:${e.lon||0}`}async enrichJob(e){let t,a=this.getCacheKey(e),r=eA.get(a);if(r&&r.expires>Date.now())return r.data;let n=[],o=[],i=[],s=!1;try{let r,l=e.lat,u=e.lon;if(l&&u)n.push("property_coordinates");else{let t=`${e.address}, ${e.city}, ${e.state} ${e.zipCode}`,a=await k.geocode(t);if(!a)return{jobId:e.id,location:{lat:0,lon:0,address:t},recommendations:{shouldReschedule:!1,upsellOpportunities:[],safetyWarnings:["Unable to geocode address - enrichment unavailable","Nominatim geocoding service may be rate-limited or unavailable","To fix: Add latitude/longitude coordinates to the property, or try again in a few minutes"]},enrichmentStatus:"failed",sources:[]};l=a.lat,u=a.lon,n.push("nominatim")}let[c,d,p,h,m,g,y,f,b,z,w,S,A,$,I,P,T,x]=await Promise.all([U.getPropertyData(e.address,e.city,e.state,e.zipCode,l,u).catch(e=>null),M.getBuildingData(l,u).catch(e=>null),ed.googleWeatherService.getWeatherData(l,u).catch(e=>null),ea.getWaterQuality(l,u).catch(e=>null),v.validateAddress({address2:e.address,address1:e.address2,city:e.city,state:e.state,zip5:e.zipCode}).catch(e=>null),k.getLocationIntelligence(l,u).catch(e=>null),Y.findNearbySuppliers(l,u,8e3).catch(e=>[]),C.getDemographics(l,u).catch(e=>null),ep.googleAirQualityService.getAirQuality(l,u).catch(e=>null),eh.googlePollenService.getPollenData(l,u).catch(e=>null),eS.getSolarData(l,u).catch(e=>null),D.getElevation(l,u).catch(e=>null),J.getWalkability(l,u).catch(e=>null),B.getNearbySchools(l,u).catch(e=>null),j.getStreetView(l,u,`${e.address}, ${e.city}, ${e.state}`).catch(e=>null),R.googlePlacesService.findNearbySuppliers(l,u,8e3).catch(e=>null),Z.getTimeZone(l,u).catch(e=>null),Q.trafficService.getTrafficIncidents(l,u).catch(e=>null)]);c&&n.push(c.dataSource),d&&n.push("osm"),p&&n.push("google-weather"),h&&n.push("usgs"),m?.isValid&&n.push("usps"),g&&n.push("fcc","fema"),y.length>0&&n.push("overpass"),f&&n.push("census"),b&&n.push("google-air-quality"),z&&n.push("google-pollen"),w&&n.push("google-solar"),S&&n.push("usgs-elevation"),A&&n.push("osm-walkability"),$&&n.push("osm-schools"),I?.available&&n.push("google-streetview"),P&&n.push("google-places"),T&&n.push("google-timezone"),x&&n.push("google-traffic");let O=[];if(p&&p.alerts&&p.alerts.length>0){let e=p.alerts[0];"Extreme"===p.highestSeverity||"Severe"===p.highestSeverity?(s=!0,t=`Severe weather alert: ${e.headline}`,i.push(e.headline)):i.push(`Weather advisory: ${e.headline}`)}if(p){let e=ed.googleWeatherService.isSuitableForOutdoorWork(p);e.suitable||i.push(e.reason||"Weather may impact outdoor work")}if(b){let e=ep.googleAirQualityService.isSuitableForOutdoorWork(b);e.suitable||i.push(e.reason||"Poor air quality may impact outdoor work");let t=ep.googleAirQualityService.getHVACFilterRecommendation(b);"Standard filters are adequate"!==t.recommendation&&(O.push({type:"Air Filter Upgrade",reason:t.recommendation,urgency:"high"===t.upgradeUrgency?"high":"medium"===t.upgradeUrgency?"medium":"low",estimatedValue:"HEPA"===t.suggestedFilter?150:75}),o.push(`Air Filter: ${t.recommendation} (Suggested: ${t.suggestedFilter})`))}if(z){let e=eh.googlePollenService.getHVACUpsellRecommendation(z);e.shouldRecommend&&(O.push({type:"Air Filtration",reason:e.reason,urgency:e.urgency,estimatedValue:e.estimatedValue}),o.push(`${e.productType}: ${e.reason} (Est. value: $${e.estimatedValue})`));let t=eh.googlePollenService.getTodaysSummary(z);"very_high"===t.overallLevel&&i.push(`Very high pollen levels: ${t.description}`)}if(w&&eS.isSuitableForSolar(w)){let e=eS.getSolarSummary(w),t=eS.getFinancialAnalysis(w);r={suitable:!0,summary:e,estimatedSavings:t?.twentyYearSavings,panelCount:w.buildingInsights?.solarPotential?.maxArrayPanelsCount},t&&t.twentyYearSavings>5e3&&o.push(`Solar Installation: ${e} (Est. 20-year savings: $${t.twentyYearSavings.toLocaleString()})`)}else w&&(r={suitable:!1,summary:"Property may not be ideal for solar installation based on roof characteristics"});if(h?.recommendations?.shouldInstallSoftener&&o.push(`Water Softener: ${h.recommendations.reason} (Save $${(h.recommendations.estimatedAnnualSavings||0)/100}/year)`),g?.floodZone?.inFloodZone){let e=g.floodZone;"high"===e.riskLevel&&i.push(`Flood Zone ${e.zone}: ${e.description}`)}if(m&&!m.isValid&&i.push(`Address validation failed: ${m.error||"Invalid address"}`),c){let e=U.estimateCharacteristics(c);if(e.recommendMaintenance&&e.recommendMaintenance.length>0)for(let t of e.recommendMaintenance)o.push(t)}let F=ev.parse({jobId:e.id,location:{lat:l,lon:u,address:`${e.address}, ${e.city}, ${e.state}`},propertyData:c,buildingData:d,weather:p,waterQuality:h,addressValidation:m,locationIntelligence:g,nearbySuppliers:y,demographics:f,airQuality:b,pollen:z,solar:w,elevation:S,walkability:A,schools:$,streetView:I,googlePlaces:P,timeZone:T,traffic:x,recommendations:{shouldReschedule:s,rescheduleReason:t,upsellOpportunities:o,safetyWarnings:i,hvacRecommendations:O.length>0?O:void 0,solarRecommendation:r},enrichmentStatus:"completed",enrichedAt:new Date().toISOString(),sources:n});return eA.set(a,{data:F,expires:Date.now()+3e5}),F}catch(t){return{jobId:e.id,location:{lat:e.lat||0,lon:e.lon||0,address:`${e.address}, ${e.city}, ${e.state}`},recommendations:{shouldReschedule:!1,upsellOpportunities:[],safetyWarnings:["Enrichment failed"]},enrichmentStatus:"failed",sources:[]}}}async getWeatherAlerts(e,t){try{let a=await ed.googleWeatherService.getWeatherData(e,t);return a?.alerts||[]}catch(e){return[]}}async getWeatherData(e,t){try{return await ed.googleWeatherService.getWeatherData(e,t)}catch(e){return null}}async getTravelTime(e,t){try{return await ec.getRoute(e,t)}catch(e){return null}}async getETA(e,t){try{return await ec.getETA(e,t)}catch(e){return null}}async rankTechniciansByETA(e,t){try{return await ec.rankTechniciansByETA(e,t)}catch(e){return[]}}async getOptimizedRoute(e,t=!0){try{return await ec.getMultiStopRoute(e,t)}catch(e){return null}}async getAirQuality(e,t){try{return await ep.googleAirQualityService.getAirQuality(e,t)}catch(e){return null}}async getPollenData(e,t){try{return await eh.googlePollenService.getPollenData(e,t)}catch(e){return null}}async getSolarPotential(e,t){try{return await eS.getSolarData(e,t)}catch(e){return null}}async getSolarProposal(e,t){try{let a=await eS.getSolarData(e,t);if(!a)return null;return eS.generateProposalSummary(a)}catch(e){return null}}getWeatherSummary(e){return ed.googleWeatherService.getWeatherSummary(e)}isWeatherSuitableForWork(e){return ed.googleWeatherService.isSuitableForOutdoorWork(e)}getHVACFilterRecommendation(e){return ep.googleAirQualityService.getHVACFilterRecommendation(e)}getPollenUpsellRecommendation(e){return eh.googlePollenService.getHVACUpsellRecommendation(e)}};var eM=e.i(511368);async function eI(e){try{let t=e.nextUrl.searchParams,a=t.get("jobId"),r=t.get("address"),n=t.get("city"),o=t.get("state"),i=t.get("zipCode"),s=t.get("lat"),l=t.get("lon");if(!(a&&r&&n&&o))return z.NextResponse.json({error:"Missing required parameters"},{status:400});let u=await (0,eM.createClient)();if(!u)return z.NextResponse.json({error:"Database connection failed"},{status:500});let{data:{user:c}}=await u.auth.getUser();if(!c)return z.NextResponse.json({error:"Unauthorized"},{status:401});let d=e$.enrichJob({id:a,address:r,address2:void 0,city:n,state:o,zipCode:i||"",lat:s?Number.parseFloat(s):void 0,lon:l?Number.parseFloat(l):void 0}),p=new Promise((e,t)=>setTimeout(()=>t(Error("Timeout")),1e4)),h=await Promise.race([d,p]).catch(()=>null);if(!h)return z.NextResponse.json({error:"Enrichment timeout or failed"},{status:504});return z.NextResponse.json(h,{headers:{"Cache-Control":"public, s-maxage=300, stale-while-revalidate=600"}})}catch(e){return z.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>eI],134099);var eP=e.i(134099);let eC=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/job-enrichment/route",pathname:"/api/job-enrichment",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/job-enrichment/route.ts",nextConfigOutput:"",userland:eP}),{workAsyncStorage:eT,workUnitAsyncStorage:eD,serverHooks:eR}=eC;function ex(){return(0,r.patchFetch)({workAsyncStorage:eT,workUnitAsyncStorage:eD})}async function ej(e,t,r){eC.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let z="/api/job-enrichment/route";z=z.replace(/\/index$/,"")||"/";let w=await eC.prepare(e,t,{srcPage:z,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:S,params:v,nextConfig:A,parsedUrl:$,isDraftMode:M,prerenderManifest:I,routerServerContext:P,isOnDemandRevalidate:C,revalidateOnlyGenerated:T,resolvedPathname:D,clientReferenceManifest:R,serverActionsManifest:x}=w,j=(0,l.normalizeAppPath)(z),O=!!(I.dynamicRoutes[j]||I.routes[D]),F=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,$,!1):t.end("This page could not be found"),null);if(O&&!M){let e=!!I.routes[D],t=I.dynamicRoutes[j];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await F();throw new f.NoFallbackError}}let N=null;!O||eC.isDev||M||(N="/index"===(N=D)?"/":N);let _=!0===eC.isDev||!O,E=O&&!_;x&&R&&(0,i.setReferenceManifestsSingleton)({page:z,clientReferenceManifest:R,serverActionsManifest:x,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:x})});let k=e.method||"GET",L=(0,o.getTracer)(),U=L.getActiveScopeSpan(),K={params:v,prerenderManifest:I,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:_,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>eC.onRequestError(e,t,r,P)},sharedContext:{buildId:S}},q=new u.NodeNextRequest(e),V=new u.NodeNextResponse(t),Y=c.NextRequestAdapter.fromNodeNextRequest(q,(0,c.signalFromNodeResponse)(t));try{let i=async e=>eC.handle(Y,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=L.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${k} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${z}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var o,l;let u=async({previousCacheEntry:a})=>{try{if(!s&&C&&T&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(n);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=K.renderOpts.collectedTags;if(!O)return await (0,h.sendResponse)(q,V,o,K.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(o.headers);u&&(t[y.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,r=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await eC.onRequestError(e,t,{routerKind:"App Router",routePath:z,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:E,isOnDemandRevalidate:C})},P),t}},c=await eC.handleResponse({req:e,nextConfig:A,cacheKey:N,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:T,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:s});if(!O)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",C?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),M&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&O||d.delete(y.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,h.sendResponse)(q,V,new Response(c.value.body,{headers:d,status:c.value.status||200})),null};U?await l(U):await L.withPropagatedContext(e.headers,()=>L.trace(d.BaseServerSpan.handleRequest,{spanName:`${k} ${z}`,kind:o.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await eC.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:E,isOnDemandRevalidate:C})}),O)throw t;return await (0,h.sendResponse)(q,V,new Response(null,{status:500})),null}}e.s(["handler",()=>ej,"patchFetch",()=>ex,"routeModule",()=>eC,"serverHooks",()=>eR,"workAsyncStorage",()=>eT,"workUnitAsyncStorage",()=>eD],189959)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_3951dc9f.js.map