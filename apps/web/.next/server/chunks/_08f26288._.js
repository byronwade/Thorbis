module.exports=[581561,e=>e.a(async(t,a)=>{try{var o=e.i(795824),r=e.i(641979),n=e.i(155333),i=e.i(273568),s=e.i(766988),l=e.i(297676),d=e.i(951615),c=t([r]);async function u(e,t,a){if(!a)return{customerId:null,hasDuplicates:!1};let o=a.toLowerCase().trim(),{data:r,error:n}=await e.from("customers").select("id, updated_at").eq("company_id",t).eq("email",o).order("updated_at",{ascending:!1});return n?(console.error("Error finding customer by email:",n),{customerId:null,hasDuplicates:!1}):r&&0!==r.length?1===r.length?{customerId:r[0].id,hasDuplicates:!1}:{customerId:r[0].id,duplicateCustomerIds:r.slice(1).map(e=>e.id),hasDuplicates:!0}:{customerId:null,hasDuplicates:!1}}async function m(e){try{let t=await e.text(),a=await (0,s.headers)();if(!await (0,n.verifyResendWebhookSignature)({payload:t,headers:{svixId:a.get("svix-id")||void 0,svixTimestamp:a.get("svix-timestamp")||void 0,svixSignature:a.get("svix-signature")||void 0}}))return console.error("âŒ Invalid webhook signature"),l.NextResponse.json({success:!1,error:"Invalid signature"},{status:401});let r=JSON.parse(t),d=await (0,i.createServiceSupabaseClient)();if(!d)return console.error("âŒ Failed to create Supabase client"),l.NextResponse.json({success:!1,error:"Database connection failed"},{status:500});switch(r.type){case"email.delivered":case"email.bounced":case"email.complained":case"email.opened":case"email.clicked":if(await p(d,r),["email.delivered","email.bounced","email.complained","email.opened","email.clicked"].includes(r.type))try{await (0,o.processResendWebhookEvent)({type:r.type,data:{email_id:r.data.id,from:"string"==typeof r.data.from?.[0]?r.data.from[0]:r.data.from?.[0]?.email,to:r.data.to?.map(e=>"string"==typeof e?e:e.email),subject:r.data.subject,created_at:r.created_at}})}catch(e){console.error("âš ï¸  Deliverability tracking error:",e)}break;case"email.received":await f(d,r)}return l.NextResponse.json({success:!0})}catch(e){return console.error("ðŸ’¥ Webhook processing failed:",e),l.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function p(e,t){let a=t.data.tags?.find(e=>"communication_id"===e.name)?.value,o=t.data.tags?.find(e=>"company_id"===e.name)?.value;if("email.bounced"===t.type||"email.complained"===t.type){let n=t.data.to?.map(e=>"string"==typeof e?e:e.email).filter(Boolean)||[],i=o;if(!i&&a){let{data:t}=await e.from("communications").select("company_id").eq("id",a).single();i=t?.company_id}if(i&&n.length>0)for(let e of n)try{if("email.bounced"===t.type){let a="hard"===t.data.bounce_type?"hard":"soft",o=t.data.bounce_reason||t.data.error?.message;await (0,r.handleBounceWebhook)(i,e,a,o)}else"email.complained"===t.type&&await (0,r.handleComplaintWebhook)(i,e)}catch(e){console.error(`Failed to process ${t.type} for suppression list:`,e)}}if(!a)return;await e.from("communication_email_events").insert({communication_id:a,event_type:t.type,provider_event_id:t.data.id,payload:t,occurred_at:t.created_at});let n={provider_status:t.type,provider_metadata:t};if("email.delivered"===t.type&&(n.status="delivered",n.delivered_at=new Date().toISOString()),"email.bounced"===t.type&&(n.status="bounced",n.bounced_at=new Date().toISOString(),n.bounce_reason=t.data.bounce_reason||t.data.error?.message),"email.complained"===t.type&&(n.status="complained",n.complained_at=new Date().toISOString()),"email.opened"===t.type){let{data:t}=await e.from("communications").select("opened_at, open_count").eq("id",a).single();n.open_count=(t?.open_count||0)+1,t?.opened_at||(n.opened_at=new Date().toISOString())}if("email.clicked"===t.type){let{data:t}=await e.from("communications").select("clicked_at, click_count").eq("id",a).single();n.click_count=(t?.click_count||0)+1,t?.clicked_at||(n.clicked_at=new Date().toISOString())}await e.from("communications").update(n).eq("id",a)}async function f(t,a){let o,r=a.data.to?.[0];if("string"==typeof r?o=r:r&&"object"==typeof r&&"email"in r&&(o=r.email),!o){console.error("âŒ No destination email found in webhook payload"),console.error("   Payload data:",JSON.stringify(a.data,null,2));return}let i=o.split("@")[1],{data:s,error:l}=await t.from("communication_email_inbound_routes").select("company_id, route_address").eq("route_address",o).eq("enabled",!0).maybeSingle();if(l&&console.error("âŒ Route lookup error:",l.message),!s?.company_id&&i){let e=`@${i}`,{data:a,error:o}=await t.from("communication_email_inbound_routes").select("company_id, route_address").eq("route_address",e).eq("enabled",!0).maybeSingle();!o&&a?.company_id&&(s=a)}let c=s?.company_id;if(!c&&i){let{data:e,error:a}=await t.from("companies").select("id, email_domain, email_receive_all").eq("email_domain",i).eq("email_receive_all",!0).maybeSingle();if(!a&&e){c=e.id;let{data:a,error:r}=await t.from("communication_email_inbound_routes").insert({company_id:c,route_address:o,name:`Auto-created route for ${o}`,enabled:!0,status:"active"}).select().maybeSingle();r&&console.error(`âš ï¸  Failed to auto-create route:`,r.message)}}if(!c){let{error:e}=await t.from("communication_unrouted_emails").insert({to_address:o,from_address:a.data.from?.[0]?.email||a.data.from?.[0]||"unknown",subject:a.data.subject,payload:a,status:"pending"});e&&console.error(`âŒ Failed to store unrouted email:`,e.message);return}let m=a.data.email_id||a.data.id;if(!m)return void console.error("âŒ No email ID found in webhook payload");let p={subject:a.data.subject||"(No subject)",html:a.data.html||null,text:a.data.text||a.data.body||""};if(!p.html&&!p.text){let e=await (0,n.getReceivedEmail)(m);e.success&&e.data?(p.html=e.data.html||e.data.body_html||null,p.text=e.data.text||e.data.body||e.data.plain_text||""):console.error(`Failed to fetch email content for ${m}: ${e.error}`)}try{let r=p.text||"",i=p.html||null;r||i||(r=a.data.text||a.data.body||"",i=a.data.html||a.data.body_html||null);let s=a.data.attachments||[],l=[];if(s.length>0)l=s.map(e=>({id:e.id||`att_${Date.now()}_${Math.random()}`,filename:e.filename||"attachment",content_type:e.content_type||"application/octet-stream",content:e.content}));else{let e=await (0,n.listReceivedEmailAttachments)(m);l=e.success?e.data:[]}let f=[];if(l.length>0)for(let e of l)try{let a;if(e.content&&"string"==typeof e.content)a=d.Buffer.from(e.content,"base64");else{let t=await (0,n.getReceivedEmailAttachment)(m,e.id);if(!t.success){console.error(`Failed to download attachment ${e.filename}: ${t.error}`);continue}let o=t.data;if(o.content&&"string"==typeof o.content)a=d.Buffer.from(o.content,"base64");else if(o.content&&d.Buffer.isBuffer(o.content))a=o.content;else{console.error(`Invalid attachment content format for ${e.filename}`);continue}}let o=`${c}/${Date.now()}-${e.filename}`;await t.storage.from("email-attachments").upload(o,a,{contentType:e.content_type||"application/octet-stream",upsert:!0});let{data:r}=t.storage.from("email-attachments").getPublicUrl(o);f.push({id:e.id,name:e.filename,filename:e.filename,path:o,type:e.content_type,content_type:e.content_type,storage_url:r.publicUrl,storage_path:o,storage_bucket:"email-attachments"})}catch(t){console.error(`Error processing attachment ${e.filename}:`,t)}let h=a.data.from?.[0],_="string"==typeof h?h:h?.email,y="object"==typeof h&&h&&"name"in h?h.name:void 0,g=null,b={customerId:null,hasDuplicates:!1};_&&(g=(b=await u(t,c,_)).customerId)&&b.hasDuplicates;let v=null;try{let{checkSpam:t}=await e.A(860012);(v=await t({subject:p.subject,body:r,bodyHtml:i,fromAddress:_,fromName:y,toAddress:o})).isSpam}catch(e){console.error(`âš ï¸  Spam filter check failed:`,e)}let w={...a,full_content:p,webhook_content:{text:a.data.text,html:a.data.html,body:a.data.body,body_html:a.data.body_html},attachments:f,spam_check:v?{isSpam:v.isSpam,confidence:v.confidence,reason:v.reason,method:v.method,score:v.score,checked_at:new Date().toISOString()}:null};b.hasDuplicates&&(w.duplicate_customers={detected:!0,primary_customer_id:g,other_customer_ids:b.duplicateCustomerIds,merge_suggested:!0,message:"Multiple customers found with this email address. Consider merging these contacts."});let R={company_id:c,customer_id:g,type:"email",channel:"resend",direction:"inbound",from_address:_,from_name:y,to_address:o,subject:p.subject,body:r,body_html:i,status:"delivered",provider_message_id:m,provider_metadata:w,is_thread_starter:!0};v?.isSpam&&(R.category="spam",R.tags=["spam"]);let{data:x,error:S}=await t.from("communications").insert(R).select().single();if(S){console.error(`âŒ Failed to insert email:`,S),console.error(`   Error details: ${JSON.stringify(S,null,2)}`);return}}catch(e){console.error(`Unexpected error processing email: ${e}`);return}}[r]=c.then?(await c)():c,e.s(["POST",()=>m]),a()}catch(e){a(e)}},!1),158147,e=>e.a(async(t,a)=>{try{var o=e.i(755535),r=e.i(377233),n=e.i(490003),i=e.i(492991),s=e.i(241970),l=e.i(357699),d=e.i(212454),c=e.i(48717),u=e.i(798301),m=e.i(986366),p=e.i(983537),f=e.i(147475),h=e.i(561930),_=e.i(803747),y=e.i(368557),g=e.i(42037),b=e.i(193695);e.i(432036);var v=e.i(573881),w=e.i(581561),R=t([w]);[w]=R.then?(await R)():R;let E=new o.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/webhooks/resend/route",pathname:"/api/webhooks/resend",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/webhooks/resend/route.ts",nextConfigOutput:"",userland:w}),{workAsyncStorage:k,workUnitAsyncStorage:C,serverHooks:I}=E;function x(){return(0,n.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:C})}async function S(e,t,a){E.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let o="/api/webhooks/resend/route";o=o.replace(/\/index$/,"")||"/";let n=await E.prepare(e,t,{srcPage:o,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:R,nextConfig:x,parsedUrl:S,isDraftMode:k,prerenderManifest:C,routerServerContext:I,isOnDemandRevalidate:A,revalidateOnlyGenerated:N,resolvedPathname:D,clientReferenceManifest:O,serverActionsManifest:T}=n,q=(0,c.normalizeAppPath)(o),P=!!(C.dynamicRoutes[q]||C.routes[D]),$=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,S,!1):t.end("This page could not be found"),null);if(P&&!k){let e=!!C.routes[D],t=C.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await $();throw new b.NoFallbackError}}let j=null;!P||E.isDev||k||(j=D,j="/index"===j?"/":j);let U=!0===E.isDev||!P,H=P&&!U;T&&O&&(0,l.setReferenceManifestsSingleton)({page:o,clientReferenceManifest:O,serverActionsManifest:T,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:T})});let M=e.method||"GET",F=(0,s.getTracer)(),B=F.getActiveScopeSpan(),K={params:R,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,o)=>E.onRequestError(e,t,o,I)},sharedContext:{buildId:w}},W=new u.NodeNextRequest(e),L=new u.NodeNextResponse(t),G=m.NextRequestAdapter.fromNodeNextRequest(W,(0,m.signalFromNodeResponse)(t));try{let n=async e=>E.handle(G,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${M} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${o}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var s,d;let c=async({previousCacheEntry:r})=>{try{if(!l&&A&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await n(i);e.fetchMetrics=K.renderOpts.fetchMetrics;let s=K.renderOpts.pendingWaitUntil;s&&a.waitUntil&&(a.waitUntil(s),s=void 0);let d=K.renderOpts.collectedTags;if(!P)return await (0,h.sendResponse)(W,L,o,K.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(o.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,r=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:o,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:A})},I),t}},u=await E.handleResponse({req:e,nextConfig:x,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:N,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:l});if(!P)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",A?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),k&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,_.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&P||m.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,y.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(W,L,new Response(u.value.body,{headers:m,status:u.value.status||200})),null};B?await d(B):await F.withPropagatedContext(e.headers,()=>F.trace(p.BaseServerSpan.handleRequest,{spanName:`${M} ${o}`,kind:s.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},d))}catch(t){if(t instanceof b.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:A})}),P)throw t;return await (0,h.sendResponse)(W,L,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>x,"routeModule",()=>E,"serverHooks",()=>I,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>C]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_08f26288._.js.map