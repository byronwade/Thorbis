module.exports=[84066,e=>{"use strict";var t=e.i(755535),r=e.i(377233),n=e.i(490003),o=e.i(492991),a=e.i(241970),i=e.i(357699),s=e.i(212454),l=e.i(48717),c=e.i(798301),u=e.i(986366),d=e.i(983537),p=e.i(147475),m=e.i(561930),h=e.i(803747),g=e.i(368557),f=e.i(42037),b=e.i(193695);e.i(432036);var y=e.i(573881);e.i(715051);var w=e.i(511368),v=e.i(297676),E=e.i(443608);let x="Thorbis-FMS/1.0 (support@thorbis.app)",z=E.z.object({vertices:E.z.array(E.z.object({x:E.z.number().optional(),y:E.z.number().optional()}))});E.z.object({description:E.z.string(),boundingPoly:z.optional(),locale:E.z.string().optional()}),E.z.object({mid:E.z.string().optional(),locale:E.z.string().optional(),description:E.z.string(),score:E.z.number().optional(),confidence:E.z.number().optional(),topicality:E.z.number().optional(),boundingPoly:z.optional()});let C=E.z.object({mid:E.z.string().optional(),description:E.z.string(),score:E.z.number(),topicality:E.z.number().optional()}),A=E.z.object({mid:E.z.string().optional(),description:E.z.string(),score:E.z.number(),boundingPoly:z.optional()}),R=E.z.object({mid:E.z.string().optional(),name:E.z.string(),score:E.z.number(),boundingPoly:z.optional()}),T=E.z.object({color:E.z.object({red:E.z.number(),green:E.z.number(),blue:E.z.number(),alpha:E.z.number().optional()}),score:E.z.number(),pixelFraction:E.z.number()}),N=E.z.object({value:E.z.string(),confidence:E.z.number(),type:E.z.enum(["serial","model","part","unknown"]),boundingBox:z.optional()}),O=E.z.object({equipmentType:E.z.string().optional(),brand:E.z.string().optional(),model:E.z.string().optional(),serialNumbers:E.z.array(N),allText:E.z.string(),labels:E.z.array(C),logos:E.z.array(A),objects:E.z.array(R),dominantColors:E.z.array(T),conditionHints:E.z.array(E.z.string()),hvacInfo:E.z.object({type:E.z.enum(["furnace","air_conditioner","heat_pump","water_heater","thermostat","air_handler","condenser","ductwork","other"]),manufacturer:E.z.string().optional(),estimatedAge:E.z.string().optional(),efficiency:E.z.string().optional()}).optional()}),j=E.z.object({text:E.z.string(),confidence:E.z.number(),blocks:E.z.array(E.z.object({text:E.z.string(),confidence:E.z.number(),boundingBox:z.optional()})),structuredData:E.z.record(E.z.string()).optional()});E.z.object({format:E.z.string(),rawValue:E.z.string(),boundingBox:z.optional()});let P=["carrier","trane","lennox","rheem","ruud","goodman","amana","york","bryant","american standard","daikin","mitsubishi","fujitsu","lg","samsung","honeywell","ecobee","nest","bosch","navien","rinnai","ao smith","bradford white","state water heaters"],S=[/\b[A-Z]{2,4}[\d]{6,12}\b/gi,/\b\d{10,14}\b/g,/\bS\/N[:\s]*([A-Z0-9-]+)\b/gi,/\bSERIAL[:\s#]*([A-Z0-9-]+)\b/gi,/\bMODEL[:\s#]*([A-Z0-9-]+)\b/gi,/\bM\/N[:\s]*([A-Z0-9-]+)\b/gi,/\bMDL[:\s]*([A-Z0-9-]+)\b/gi,/\bPART[:\s#]*([A-Z0-9-]+)\b/gi,/\bP\/N[:\s]*([A-Z0-9-]+)\b/gi,/\bSKU[:\s]*([A-Z0-9-]+)\b/gi],I={furnace:["furnace","heating","blower","heat exchanger","combustion"],air_conditioner:["air conditioner","a/c","ac unit","cooling","seer","condenser"],heat_pump:["heat pump","hspf","hybrid","dual fuel"],water_heater:["water heater","tank","tankless","gallon","gpm","gas water","electric water"],thermostat:["thermostat","programmable","smart home","wifi","temperature control"],air_handler:["air handler","ahu","blower coil"],condenser:["condenser","outdoor unit","compressor"],ductwork:["duct","ductwork","register","grille","vent"]},_=new class{apiKey;constructor(){this.apiKey=process.env.GOOGLE_API_KEY||process.env.GOOGLE_CLOUD_VISION_API_KEY||"AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0"}isAvailable(){return!!this.apiKey}async analyzeEquipment(e){if(!this.apiKey)return console.warn("Google Vision Service: No API key configured"),null;try{let t=await this.prepareImageContent(e),r=await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":x},body:JSON.stringify({requests:[{image:t,features:[{type:"TEXT_DETECTION",maxResults:50},{type:"LABEL_DETECTION",maxResults:20},{type:"LOGO_DETECTION",maxResults:10},{type:"OBJECT_LOCALIZATION",maxResults:20},{type:"IMAGE_PROPERTIES"}]}]})});if(!r.ok)return console.error(`Google Vision API error: ${r.status} ${r.statusText}`),null;let n=await r.json(),o=n.responses?.[0];if(!o)return null;let a=o.textAnnotations?.[0]?.description||"",i=o.textAnnotations?.slice(1)||[],s=this.extractSerialNumbers(a,i),l=(o.labelAnnotations||[]).map(e=>({mid:e.mid,description:e.description||"",score:e.score||0,topicality:e.topicality})),c=(o.logoAnnotations||[]).map(e=>({mid:e.mid,description:e.description||"",score:e.score||0,boundingPoly:e.boundingPoly})),u=(o.localizedObjectAnnotations||[]).map(e=>({mid:e.mid,name:e.name||"",score:e.score||0,boundingPoly:e.boundingPoly})),d=o.imagePropertiesAnnotation?.dominantColors?.colors?.map(e=>({color:{red:e.color?.red||0,green:e.color?.green||0,blue:e.color?.blue||0,alpha:e.color?.alpha},score:e.score||0,pixelFraction:e.pixelFraction||0}))||[],p=this.identifyBrand(c,a),m=this.identifyEquipmentType(l,u,a),h=this.analyzeHVACEquipment(m,p,a,l),g=this.extractConditionHints(l,a);return O.parse({equipmentType:m,brand:p,model:s.find(e=>"model"===e.type)?.value,serialNumbers:s,allText:a,labels:l,logos:c,objects:u,dominantColors:d.slice(0,5),conditionHints:g,hvacInfo:h})}catch(e){return console.error("Google Vision Service error:",e),null}}async scanDocument(e){if(!this.apiKey)return console.warn("Google Vision Service: No API key configured"),null;try{let t=await this.prepareImageContent(e),r=await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":x},body:JSON.stringify({requests:[{image:t,features:[{type:"DOCUMENT_TEXT_DETECTION"}]}]})});if(!r.ok)return console.error(`Google Vision API error: ${r.status} ${r.statusText}`),null;let n=await r.json(),o=n.responses?.[0]?.fullTextAnnotation;if(!o)return null;let a=o.pages?.[0]?.blocks?.map(e=>({text:e.paragraphs?.map(e=>e.words?.map(e=>e.symbols?.map(e=>e.text).join("")).join(" ")).join("\n")||"",confidence:e.confidence||0,boundingBox:e.boundingBox}))||[],i=this.extractStructuredData(o.text);return j.parse({text:o.text||"",confidence:o.pages?.[0]?.confidence||0,blocks:a,structuredData:i})}catch(e){return console.error("Google Vision Service error:",e),null}}async detectBarcodes(e){if(!this.apiKey)return console.warn("Google Vision Service: No API key configured"),[];try{let t=await this.prepareImageContent(e),r=await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":x},body:JSON.stringify({requests:[{image:t,features:[{type:"TEXT_DETECTION"}]}]})});if(!r.ok)return[];let n=await r.json(),o=n.responses?.[0]?.textAnnotations||[],a=[],i=o[0]?.description||"";for(let e of[/\b\d{12,13}\b/g,/\b[A-Z0-9]{6,20}\b/g])for(let t of i.match(e)||[])this.isValidBarcode(t)&&a.push({format:this.detectBarcodeFormat(t),rawValue:t});return a}catch(e){return console.error("Google Vision Service error:",e),[]}}async extractText(e){if(!this.apiKey)return null;try{let t=await this.prepareImageContent(e),r=await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":x},body:JSON.stringify({requests:[{image:t,features:[{type:"TEXT_DETECTION"}]}]})});if(!r.ok)return null;let n=await r.json();return n.responses?.[0]?.textAnnotations?.[0]?.description||null}catch(e){return console.error("Google Vision Service error:",e),null}}async prepareImageContent(e){return Buffer.isBuffer(e)?{content:e.toString("base64")}:e.startsWith("http://")||e.startsWith("https://")?{source:{imageUri:e}}:{content:e.replace(/^data:image\/\w+;base64,/,"")}}extractSerialNumbers(e,t){let r=[],n=new Set;for(let o of S)for(let a of e.matchAll(o)){let e=(a[1]||a[0]).replace(/[:\s]/g,"").toUpperCase();if(n.has(e))continue;n.add(e);let i="unknown",s=o.source.toLowerCase();s.includes("serial")||s.includes("s/n")?i="serial":s.includes("model")||s.includes("m/n")?i="model":(s.includes("part")||s.includes("p/n")||s.includes("sku"))&&(i="part");let l=t.find(t=>t.description&&t.description.toUpperCase().includes(e.substring(0,6)));r.push({value:e,confidence:l?.9:.7,type:i,boundingBox:l?.boundingPoly})}return r}identifyBrand(e,t){if(e.length>0)return e.sort((e,t)=>t.score-e.score)[0].description;let r=t.toLowerCase();for(let e of P)if(r.includes(e))return e.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}identifyEquipmentType(e,t,r){let n=[...e.map(e=>e.description.toLowerCase()),...t.map(e=>e.name.toLowerCase()),r.toLowerCase()].join(" ");for(let[e,t]of Object.entries(I))for(let r of t)if(n.includes(r))return e.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ");let o=e.filter(e=>e.score>.7&&["appliance","machine","equipment","hvac","heating","cooling"].some(t=>e.description.toLowerCase().includes(t)));if(o.length>0)return o[0].description}analyzeHVACEquipment(e,t,r,n){let o,a;if(!e)return;let i=r.toLowerCase(),s="other";for(let[t,r]of Object.entries({furnace:"furnace","air conditioner":"air_conditioner","heat pump":"heat_pump","water heater":"water_heater",thermostat:"thermostat","air handler":"air_handler",condenser:"condenser",ductwork:"ductwork"}))if(e.toLowerCase().includes(t)){s=r;break}let l=i.match(/(\d{1,2}(?:\.\d)?)\s*seer/),c=i.match(/(\d{2,3}(?:\.\d)?)\s*%?\s*afue/),u=i.match(/(\d{1,2}(?:\.\d)?)\s*hspf/);l?o=`${l[1]} SEER`:c?o=`${c[1]}% AFUE`:u&&(o=`${u[1]} HSPF`);let d=i.match(/(?:mfg|manufactured|date)[:\s]*(\d{4})/i);if(d){let e=parseInt(d[1]),t=new Date().getFullYear();e>=1990&&e<=t&&(a=`${t-e} years (Mfg ${e})`)}return{type:s,manufacturer:t,estimatedAge:a,efficiency:o}}extractConditionHints(e,t){let r=[],n=t.toLowerCase(),o={rust:"Visible rust detected",corrosion:"Corrosion observed",damage:"Potential damage visible",leak:"Possible leak indicated",dirty:"Equipment appears dirty",clean:"Equipment appears clean",new:"Equipment appears new/recent",old:"Equipment appears aged"};for(let[e,t]of Object.entries(o))n.includes(e)&&r.push(t);for(let t of e)if(t.score>.8){let e=t.description.toLowerCase();for(let[t,n]of Object.entries(o))e.includes(t)&&!r.includes(n)&&r.push(n)}return r}extractStructuredData(e){let t={};for(let[r,n]of Object.entries({date:/(?:date|dated?)[:\s]*(\d{1,2}[/-]\d{1,2}[/-]\d{2,4})/i,total:/(?:total|amount)[:\s]*\$?([\d,]+\.?\d*)/i,invoice:/(?:invoice|inv)[:\s#]*(\w+)/i,customer:/(?:customer|client|bill to)[:\s]*([\w\s]+?)(?:\n|$)/i,phone:/(?:phone|tel|ph)[:\s]*([\d\-()\s]+)/i,email:/[\w.-]+@[\w.-]+\.\w+/i,address:/(\d+[\w\s,]+(?:st|street|ave|avenue|rd|road|dr|drive|ln|lane|blvd|boulevard)[\w\s,]*)/i})){let o=e.match(n);o&&(t[r]=o[1]?.trim()||o[0].trim())}return Object.keys(t).length>0?t:{}}isValidBarcode(e){if(e.length<6||e.length>20)return!1;if(/^\d{12,13}$/.test(e)){let t=e.split("").map(Number),r=t.pop(),n=0;for(let e=0;e<t.length;e++)n+=t[e]*(e%2==0?1:3);return(10-n%10)%10===r}return!0}detectBarcodeFormat(e){return/^\d{12}$/.test(e)?"UPC-A":/^\d{13}$/.test(e)?"EAN-13":/^\d{8}$/.test(e)?"EAN-8":/^[A-Z0-9]+$/.test(e)?"CODE39":"UNKNOWN"}};async function k(e){let t=await (0,w.createClient)(),{data:{user:r}}=await t.auth.getUser();if(!r)return v.NextResponse.json({error:"Unauthorized"},{status:401});try{let t,r,n=e.headers.get("content-type")||"",o="equipment";if(n.includes("multipart/form-data")){let r=await e.formData(),n=r.get("image");if(o=r.get("type")||"equipment",!n)return v.NextResponse.json({error:"Image file is required"},{status:400});let a=await n.arrayBuffer();t=Buffer.from(a).toString("base64")}else{let r=await e.json();if(t=r.image,o=r.type||"equipment",!t)return v.NextResponse.json({error:"Image (base64 or URL) is required"},{status:400})}if(!_.isAvailable())return v.NextResponse.json({error:"Vision service not configured"},{status:503});switch(o){case"equipment":r=await _.analyzeEquipment(t);break;case"document":r=await _.scanDocument(t);break;case"barcode":r={barcodes:await _.detectBarcodes(t)};break;case"text":r={text:await _.extractText(t)};break;default:return v.NextResponse.json({error:"Invalid analysis type. Use: equipment, document, barcode, or text"},{status:400})}if(!r)return v.NextResponse.json({error:"Failed to analyze image"},{status:500});return v.NextResponse.json({success:!0,type:o,data:r})}catch(e){return console.error("Vision analysis error:",e),v.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["POST",()=>k],129175);var q=e.i(129175);let U=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/vision/analyze/route",pathname:"/api/vision/analyze",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/vision/analyze/route.ts",nextConfigOutput:"",userland:q}),{workAsyncStorage:D,workUnitAsyncStorage:$,serverHooks:L}=U;function B(){return(0,n.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:$})}async function K(e,t,n){U.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/vision/analyze/route";w=w.replace(/\/index$/,"")||"/";let v=await U.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:E,params:x,nextConfig:z,parsedUrl:C,isDraftMode:A,prerenderManifest:R,routerServerContext:T,isOnDemandRevalidate:N,revalidateOnlyGenerated:O,resolvedPathname:j,clientReferenceManifest:P,serverActionsManifest:S}=v,I=(0,l.normalizeAppPath)(w),_=!!(R.dynamicRoutes[I]||R.routes[j]),k=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,C,!1):t.end("This page could not be found"),null);if(_&&!A){let e=!!R.routes[j],t=R.dynamicRoutes[I];if(t&&!1===t.fallback&&!e){if(z.experimental.adapterPath)return await k();throw new b.NoFallbackError}}let q=null;!_||U.isDev||A||(q="/index"===(q=j)?"/":q);let D=!0===U.isDev||!_,$=_&&!D;S&&P&&(0,i.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:P,serverActionsManifest:S,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:S})});let L=e.method||"GET",B=(0,a.getTracer)(),K=B.getActiveScopeSpan(),M={params:x,prerenderManifest:R,renderOpts:{experimental:{authInterrupts:!!z.experimental.authInterrupts},cacheComponents:!!z.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:z.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>U.onRequestError(e,t,n,T)},sharedContext:{buildId:E}},H=new c.NodeNextRequest(e),V=new c.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(H,(0,u.signalFromNodeResponse)(t));try{let i=async e=>U.handle(G,M).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=B.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${L} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${w}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var a,l;let c=async({previousCacheEntry:r})=>{try{if(!s&&N&&O&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await i(o);e.fetchMetrics=M.renderOpts.fetchMetrics;let l=M.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let c=M.renderOpts.collectedTags;if(!_)return await (0,m.sendResponse)(H,V,a,M.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,n=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await U.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:N})},T),t}},u=await U.handleResponse({req:e,nextConfig:z,cacheKey:q,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:R,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:O,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:s});if(!_)return null;if((null==u||null==(a=u.value)?void 0:a.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",N?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&_||d.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(H,V,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};K?await l(K):await B.withPropagatedContext(e.headers,()=>B.trace(d.BaseServerSpan.handleRequest,{spanName:`${L} ${w}`,kind:a.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},l))}catch(t){if(t instanceof b.NoFallbackError||await U.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:N})}),_)throw t;return await (0,m.sendResponse)(H,V,new Response(null,{status:500})),null}}e.s(["handler",()=>K,"patchFetch",()=>B,"routeModule",()=>U,"serverHooks",()=>L,"workAsyncStorage",()=>D,"workUnitAsyncStorage",()=>$],84066)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_3e36a841.js.map