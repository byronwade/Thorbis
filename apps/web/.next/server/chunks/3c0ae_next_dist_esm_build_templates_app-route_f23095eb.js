module.exports=[978755,e=>{"use strict";var t=e.i(755535),r=e.i(377233),a=e.i(490003),o=e.i(492991),n=e.i(241970),i=e.i(357699),s=e.i(212454),l=e.i(48717),d=e.i(798301),c=e.i(986366),u=e.i(983537),m=e.i(147475),p=e.i(561930),g=e.i(803747),y=e.i(368557),h=e.i(42037),_=e.i(193695);e.i(432036);var f=e.i(573881),w=e.i(766988),x=e.i(297676),b=e.i(273568),v=e.i(381979);async function I(e){let t=process.env.TELNYX_API_KEY;if(!t)return{success:!1,error:"TELNYX_API_KEY is not configured"};try{let r=await fetch(`https://api.telnyx.com/v2/number_lookup/${encodeURIComponent(e)}`,{method:"GET",headers:{Authorization:`Bearer ${t}`},cache:"no-store"});if(!r.ok){let e=await r.json().catch(()=>({errors:[{detail:r.statusText}]}));return{success:!1,error:e?.errors?.[0]?.detail||`Telnyx lookup failed (${r.status})`}}let a=await r.json();return{success:!0,data:a.data}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error during lookup"}}}e.i(618874);var R=e.i(70110),k=e.i(786348);e.i(628123);async function C(e){try{let t=(0,b.createServiceSupabaseClient)(),r=new Date(Date.now()+6e4),{data:a,error:o}=await t.from("webhook_failures").insert({company_id:e.companyId||null,event_type:e.eventType,payload:e.payload,error_message:e.errorMessage,retry_count:0,next_retry_at:r.toISOString()}).select("id").single();if(o)return k.telnyxLogger.error("Failed to add to DLQ",{error:o.message,eventType:e.eventType,correlationId:e.correlationId}),{success:!1,error:o.message};return k.telnyxLogger.info("Added to DLQ",{entryId:a.id,eventType:e.eventType,nextRetryAt:r.toISOString(),correlationId:e.correlationId}),{success:!0,entryId:a.id}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}var L=e.i(692837);async function E(e){let t,r,a,o,n=Date.now(),i=`wh_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;try{o=await e.text();let s=await (0,w.headers)(),l=s.get("telnyx-signature-ed25519")||"",d=s.get("telnyx-timestamp")||"",c=(0,R.verifyWebhookSignature)({payload:o,signature:l,timestamp:d,correlationId:i});if(!c.valid)return k.telnyxLogger.warn("Webhook signature verification failed",{correlationId:i,error:c.error}),L.telnyxMetrics.recordWebhook(!1),x.NextResponse.json((0,R.createWebhookResponse)(!1,c.error||"Invalid signature"),{status:401});let u=(0,R.isWebhookTimestampValid)(d);if(!u.valid)return k.telnyxLogger.warn("Webhook timestamp validation failed",{correlationId:i,error:u.error}),L.telnyxMetrics.recordWebhook(!1),x.NextResponse.json((0,R.createWebhookResponse)(!1,u.error||"Invalid timestamp"),{status:400});let m=(0,R.parseWebhookPayload)(o);if(!m)return k.telnyxLogger.warn("Webhook payload parsing failed",{correlationId:i}),L.telnyxMetrics.recordWebhook(!1),x.NextResponse.json((0,R.createWebhookResponse)(!1,"Invalid webhook payload"),{status:400});t=(0,R.getEventType)(m),r=m.data.id;let p=await (0,b.createServiceSupabaseClient)();if(!p)return k.telnyxLogger.error("Failed to create Supabase client",{correlationId:i}),x.NextResponse.json((0,R.createWebhookResponse)(!1,"Database unavailable"),{status:503});let g=function(e,t){let r=e.data.payload;if(t.startsWith("call."))return r.to||null;if(t.startsWith("message.")){let e=r.to;return e?.[0]?.phone_number?e[0].phone_number:r.to_phone_number||null}return null}(m,t);if(g){let e=await H(p,g);a=e?.companyId}if(r&&a){if(await (0,R.isWebhookDuplicateAsync)(a,r))return k.telnyxLogger.info("Duplicate webhook skipped (database-backed)",{correlationId:i,webhookId:r,companyId:a}),x.NextResponse.json((0,R.createWebhookResponse)(!0,"Already processed"),{status:200})}else r&&!a&&k.telnyxLogger.debug("No company context for webhook dedup",{correlationId:i,webhookId:r,targetPhone:g});k.telnyxLogger.info("Processing webhook",{correlationId:i,eventType:t,webhookId:r,companyId:a}),(0,R.isCallEvent)(t)?await S(m,t,i):(0,R.isMessageEvent)(t)?await O(m,t,i):k.telnyxLogger.debug("Unhandled event type",{correlationId:i,eventType:t}),r&&a&&await (0,R.markWebhookProcessedAsync)(a,r);let y=Date.now()-n;return k.telnyxLogger.info("Webhook processed successfully",{correlationId:i,eventType:t,webhookId:r,companyId:a,latencyMs:y}),L.telnyxMetrics.recordWebhook(!0),x.NextResponse.json((0,R.createWebhookResponse)(!0),{status:200})}catch(l){let e=Date.now()-n,s=l instanceof Error?l.message:"Unknown error";if(k.telnyxLogger.error("Webhook processing failed",{correlationId:i,eventType:t,webhookId:r,companyId:a,error:s,latencyMs:e}),t)try{await C({companyId:a,eventType:t,payload:o?JSON.parse(o):{},errorMessage:s,correlationId:i}),k.telnyxLogger.info("Webhook added to DLQ for retry",{correlationId:i,webhookId:r,eventType:t})}catch(e){k.telnyxLogger.error("Failed to add webhook to DLQ",{correlationId:i,webhookId:r,error:e instanceof Error?e.message:"Unknown DLQ error"})}return L.telnyxMetrics.recordWebhook(!1),x.NextResponse.json((0,R.createWebhookResponse)(!1,"Internal error"),{status:500})}}async function S(e,t,r){let a=await (0,b.createServiceSupabaseClient)();if(!a)throw k.telnyxLogger.error("Failed to create Supabase client for call event",{correlationId:r,eventType:t}),Error("Database unavailable");switch(t){case"call.initiated":await D(e,a,r);break;case"call.answered":await N(e,a,r);break;case"call.hangup":await T(e,a,r);break;case"call.recording.saved":await A(e,a,r);break;case"call.machine.detection.ended":case"call.machine.premium.detection.ended":await M(e,a,r);break;default:k.telnyxLogger.debug("Unhandled call event",{correlationId:r,eventType:t})}}async function D(e,t,r){let a,o=e.data.payload,n=await H(t,o.to);if(!n)return void k.telnyxLogger.warn("No phone context found for call",{correlationId:r,to:o.to});let i=j(o.from),s=j(o.to),l="incoming"===o.direction?await $(t,n.companyId,i):{customerId:null,hasDuplicates:!1},d=l.customerId,c=null;if(d&&(c=await K(t,d)),!c){let e=await I(i);e.success&&e.data?(c=e.data.caller_name||null,a=e.data):e.error&&(a={error:e.error})}let u={company_id:n.companyId,type:"phone",channel:"telnyx",direction:"incoming"===o.direction?"inbound":"outbound",from_address:i,to_address:s,from_name:c,body:"",status:"queued",priority:"normal",phone_number_id:n.phoneNumberId,is_archived:!1,is_internal:!1,is_automated:!1,is_thread_starter:!0,telnyx_call_control_id:o.call_control_id,telnyx_call_session_id:o.call_session_id},m={};a&&(m.caller_lookup=a),l.hasDuplicates&&(m.duplicate_customers={detected:!0,primary_customer_id:d,other_customer_ids:l.duplicateCustomerIds,merge_suggested:!0,message:"Multiple customers found with this phone number. Consider merging these contacts."}),Object.keys(m).length>0&&(u.provider_metadata=m),d&&(u.customer_id=d);let{error:p}=await t.from("communications").upsert(u,{onConflict:"telnyx_call_control_id"});if(p)throw k.telnyxLogger.error("Failed to upsert call communication",{correlationId:r,callControlId:o.call_control_id,error:p.message}),p;k.telnyxLogger.info("Call initiated recorded",{correlationId:r,callControlId:o.call_control_id,direction:o.direction,customerId:d})}async function N(e,t,r){let a=e.data.payload,{error:o,count:n}=await t.from("communications").update({status:"delivered",call_answered_at:new Date().toISOString()}).eq("telnyx_call_control_id",a.call_control_id);if(o)throw k.telnyxLogger.error("Failed to update call answered status",{correlationId:r,callControlId:a.call_control_id,error:o.message}),o;0===n?k.telnyxLogger.warn("No communication found for call.answered",{correlationId:r,callControlId:a.call_control_id}):k.telnyxLogger.info("Call answered recorded",{correlationId:r,callControlId:a.call_control_id})}async function T(e,t,r){let a=e.data.payload,o=new Date(a.start_time).getTime(),n=Math.round((new Date(a.end_time).getTime()-o)/1e3),{error:i,count:s}=await t.from("communications").update({status:"sent",call_ended_at:a.end_time,call_duration:n,hangup_cause:a.hangup_cause,hangup_source:a.hangup_source}).eq("telnyx_call_control_id",a.call_control_id);if(i)throw k.telnyxLogger.error("Failed to update call hangup status",{correlationId:r,callControlId:a.call_control_id,error:i.message}),i;0===s?k.telnyxLogger.warn("No communication found for call.hangup",{correlationId:r,callControlId:a.call_control_id}):k.telnyxLogger.info("Call hangup recorded",{correlationId:r,callControlId:a.call_control_id,duration:n,hangupCause:a.hangup_cause}),L.telnyxMetrics.recordCallCompleted()}async function A(t,r,a){let o=t.data.payload,n=o.recording_urls?.[0]||o.public_recording_url;if(!n)return void k.telnyxLogger.warn("Recording saved event without URL",{correlationId:a,callControlId:o.call_control_id});let{data:i,error:s}=await r.from("communications").update({call_recording_url:n,recording_channels:o.channels}).eq("telnyx_call_control_id",o.call_control_id).select("id").single();if(s)throw k.telnyxLogger.error("Failed to update recording URL",{correlationId:a,callControlId:o.call_control_id,error:s.message}),s;if(k.telnyxLogger.info("Recording saved",{correlationId:a,callControlId:o.call_control_id,communicationId:i?.id}),i?.id)try{let{transcribeCallRecording:t}=await e.A(448702),r=await t({recordingUrl:n,communicationId:i.id});r.success?k.telnyxLogger.info("Transcription started",{correlationId:a,communicationId:i.id}):k.telnyxLogger.warn("Transcription failed to start",{correlationId:a,communicationId:i.id,error:r.error})}catch(e){k.telnyxLogger.error("Transcription error (non-fatal)",{correlationId:a,communicationId:i.id,error:e instanceof Error?e.message:"Unknown"})}}async function M(e,t,r){let a=e.data.payload,{error:o}=await t.from("communications").update({answering_machine_detected:"human"!==a.result}).eq("telnyx_call_control_id",a.call_control_id);o?k.telnyxLogger.error("Failed to update machine detection",{correlationId:r,callControlId:a.call_control_id,error:o.message}):k.telnyxLogger.debug("Machine detection recorded",{correlationId:r,callControlId:a.call_control_id,result:a.result})}async function O(e,t,r){let a=await (0,b.createServiceSupabaseClient)();if(!a)throw k.telnyxLogger.error("Failed to create Supabase client for message event",{correlationId:r,eventType:t}),Error("Database unavailable");switch(t){case"message.received":await P(e,a,r);break;case"message.sent":await U(e,a,r);break;case"message.delivered":await q(e,a,r);break;case"message.sending_failed":case"message.delivery_failed":await W(e,t,a,r);break;case"message.read":await F(e,a,r);break;default:k.telnyxLogger.debug("Unhandled message event",{correlationId:r,eventType:t})}}async function P(e,t,r){let a=e.data.payload,o=a.to[0]?.phone_number,n=o?await H(t,o):null;if(!n)return void k.telnyxLogger.warn("No phone context found for message",{correlationId:r,to:o});let i=j(a.from.phone_number),s=j(o),l=await $(t,n.companyId,i),d=l.customerId,c={carrier:a.from.carrier,line_type:a.from.line_type,media:a.media};l.hasDuplicates&&(c.duplicate_customers={detected:!0,primary_customer_id:d,other_customer_ids:l.duplicateCustomerIds,merge_suggested:!0,message:"Multiple customers found with this phone number. Consider merging these contacts."});let{error:u}=await t.from("communications").insert({company_id:n.companyId,customer_id:d,type:"sms",channel:"telnyx",direction:"inbound",from_address:i,to_address:s,body:a.text||"",status:"delivered",priority:"normal",phone_number_id:n.phoneNumberId,is_archived:!1,is_internal:!1,is_automated:!1,is_thread_starter:!0,telnyx_message_id:a.id,received_at:a.received_at,provider_metadata:c});if(u)throw k.telnyxLogger.error("Failed to insert incoming message",{correlationId:r,messageId:a.id,error:u.message}),u;k.telnyxLogger.info("Inbound message recorded",{correlationId:r,messageId:a.id,from:i,customerId:d,hasDuplicates:l.hasDuplicates})}async function U(e,t,r){let a=e.data.payload,{error:o,count:n}=await t.from("communications").update({status:"sent",sent_at:new Date().toISOString()}).eq("telnyx_message_id",a.id);if(o)throw k.telnyxLogger.error("Failed to update message sent status",{correlationId:r,messageId:a.id,error:o.message}),o;0===n?k.telnyxLogger.warn("No communication found for message.sent",{correlationId:r,messageId:a.id}):k.telnyxLogger.debug("Message sent status updated",{correlationId:r,messageId:a.id}),L.telnyxMetrics.recordSmsSent(!0)}async function q(e,t,r){let a=e.data.payload,{error:o,count:n}=await t.from("communications").update({status:"delivered",delivered_at:new Date().toISOString()}).eq("telnyx_message_id",a.id);if(o)throw k.telnyxLogger.error("Failed to update message delivered status",{correlationId:r,messageId:a.id,error:o.message}),o;0===n?k.telnyxLogger.warn("No communication found for message.delivered",{correlationId:r,messageId:a.id}):k.telnyxLogger.debug("Message delivered status updated",{correlationId:r,messageId:a.id}),L.telnyxMetrics.recordSmsDelivered()}async function W(e,t,r,a){let o=e.data.payload,n=o.errors?.[0]?.detail||"Unknown error",{error:i,count:s}=await r.from("communications").update({status:"failed",failed_at:new Date().toISOString(),failure_reason:n}).eq("telnyx_message_id",o.id);if(i)throw k.telnyxLogger.error("Failed to update message failed status",{correlationId:a,messageId:o.id,error:i.message}),i;0===s?k.telnyxLogger.warn("No communication found for message failure",{correlationId:a,messageId:o.id,eventType:t}):k.telnyxLogger.warn("Message failed",{correlationId:a,messageId:o.id,eventType:t,failureReason:n}),L.telnyxMetrics.recordSmsSent(!1)}async function F(e,t,r){let a=e.data.payload,{error:o,count:n}=await t.from("communications").update({read_at:new Date().toISOString()}).eq("telnyx_message_id",a.id);o&&k.telnyxLogger.error("Failed to update message read status",{correlationId:r,messageId:a.id,error:o.message}),n&&n>0&&k.telnyxLogger.debug("Message read status updated",{correlationId:r,messageId:a.id})}function j(e){return(0,v.formatPhoneNumber)(e)}async function H(e,t){let r=j(t),{data:a}=await e.from("phone_numbers").select("id, company_id").eq("phone_number",r).is("deleted_at",null).maybeSingle();return a?{companyId:a.company_id,phoneNumberId:a.id}:null}async function $(e,t,r){let a,o=(a=r.replace(/\D/g,"")).length>10?a.slice(-10):a;if(!o)return{customerId:null,hasDuplicates:!1};let{data:n}=await e.from("customers").select("id, updated_at").eq("company_id",t).or(`phone.ilike.%${o}%,secondary_phone.ilike.%${o}%`).order("updated_at",{ascending:!1});return n&&0!==n.length?1===n.length?{customerId:n[0].id,hasDuplicates:!1}:(k.telnyxLogger.info("Multiple customers found for phone number",{phoneNumber:r,companyId:t,customerCount:n.length,customerIds:n.map(e=>e.id)}),{customerId:n[0].id,duplicateCustomerIds:n.slice(1).map(e=>e.id),hasDuplicates:!0}):{customerId:null,hasDuplicates:!1}}async function K(e,t){let{data:r}=await e.from("customers").select("first_name, last_name, company_name").eq("id",t).maybeSingle();return r?[r.first_name?.trim(),r.last_name?.trim()].filter(Boolean).join(" ").trim()||r.company_name||null:null}e.s(["POST",()=>E],808343);var B=e.i(808343);let Q=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/webhooks/telnyx/route",pathname:"/api/webhooks/telnyx",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/webhooks/telnyx/route.ts",nextConfigOutput:"",userland:B}),{workAsyncStorage:X,workUnitAsyncStorage:G,serverHooks:V}=Q;function Y(){return(0,a.patchFetch)({workAsyncStorage:X,workUnitAsyncStorage:G})}async function z(e,t,a){Q.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/webhooks/telnyx/route";w=w.replace(/\/index$/,"")||"/";let x=await Q.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!x)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:b,params:v,nextConfig:I,parsedUrl:R,isDraftMode:k,prerenderManifest:C,routerServerContext:L,isOnDemandRevalidate:E,revalidateOnlyGenerated:S,resolvedPathname:D,clientReferenceManifest:N,serverActionsManifest:T}=x,A=(0,l.normalizeAppPath)(w),M=!!(C.dynamicRoutes[A]||C.routes[D]),O=async()=>((null==L?void 0:L.render404)?await L.render404(e,t,R,!1):t.end("This page could not be found"),null);if(M&&!k){let e=!!C.routes[D],t=C.dynamicRoutes[A];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await O();throw new _.NoFallbackError}}let P=null;!M||Q.isDev||k||(P="/index"===(P=D)?"/":P);let U=!0===Q.isDev||!M,q=M&&!U;T&&N&&(0,i.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:N,serverActionsManifest:T,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:T})});let W=e.method||"GET",F=(0,n.getTracer)(),j=F.getActiveScopeSpan(),H={params:v,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>Q.onRequestError(e,t,a,L)},sharedContext:{buildId:b}},$=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),B=c.NextRequestAdapter.fromNodeNextRequest($,(0,c.signalFromNodeResponse)(t));try{let i=async e=>Q.handle(B,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${W} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${W} ${w}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var n,l;let d=async({previousCacheEntry:r})=>{try{if(!s&&E&&S&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(o);e.fetchMetrics=H.renderOpts.fetchMetrics;let l=H.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=H.renderOpts.collectedTags;if(!M)return await (0,p.sendResponse)($,K,n,H.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[h.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,a=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await Q.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:E})},L),t}},c=await Q.handleResponse({req:e,nextConfig:I,cacheKey:P,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:E,revalidateOnlyGenerated:S,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!M)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",E?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),k&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,g.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&M||u.delete(h.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,y.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)($,K,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};j?await l(j):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${W} ${w}`,kind:n.SpanKind.SERVER,attributes:{"http.method":W,"http.target":e.url}},l))}catch(t){if(t instanceof _.NoFallbackError||await Q.onRequestError(e,t,{routerKind:"App Router",routePath:A,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:E})}),M)throw t;return await (0,p.sendResponse)($,K,new Response(null,{status:500})),null}}e.s(["handler",()=>z,"patchFetch",()=>Y,"routeModule",()=>Q,"serverHooks",()=>V,"workAsyncStorage",()=>X,"workUnitAsyncStorage",()=>G],978755)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_f23095eb.js.map