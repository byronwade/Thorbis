{"version":3,"sources":["../../../../../apps/web/src/lib/telnyx/logger.ts","../../../../../apps/web/src/lib/telnyx/errors.ts","../../../../../apps/web/src/lib/telnyx/metrics.ts","../../../../../apps/web/src/lib/telnyx/messaging-profile-setup.ts","../../../../../apps/web/src/lib/telnyx/numbers.ts","../../../../../apps/web/src/lib/telnyx/phone-number-setup.ts"],"sourcesContent":["/**\n * Telnyx Structured Logger\n *\n * Provides structured JSON logging with PII redaction,\n * log levels, and correlation ID support.\n */\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport type LogLevel = \"debug\" | \"info\" | \"warn\" | \"error\";\n\nexport interface LogContext {\n\tcorrelationId?: string;\n\tendpoint?: string;\n\tcompanyId?: string;\n\tphoneNumber?: string;\n\tcallControlId?: string;\n\tmessageSid?: string;\n\tattempt?: number;\n\tdelayMs?: number;\n\tlatencyMs?: number;\n\tstatusCode?: number;\n\terror?: string;\n\t[key: string]: unknown;\n}\n\nexport interface LogEntry {\n\ttimestamp: string;\n\tlevel: LogLevel;\n\tservice: string;\n\tmessage: string;\n\tcontext?: LogContext;\n}\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nconst LOG_LEVELS: Record<LogLevel, number> = {\n\tdebug: 0,\n\tinfo: 1,\n\twarn: 2,\n\terror: 3,\n};\n\n// Default to 'info' in production, 'debug' in development\nconst currentLogLevel: LogLevel =\n\t(process.env.TELNYX_LOG_LEVEL as LogLevel) ||\n\t(process.env.NODE_ENV === \"production\" ? \"info\" : \"debug\");\n\n// PII patterns to redact\nconst PII_PATTERNS = [\n\t// Phone numbers (various formats)\n\t/\\+?1?\\d{10,15}/g,\n\t// Email addresses\n\t/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g,\n];\n\n// Fields that should be redacted\nconst SENSITIVE_FIELDS = [\n\t\"phone\",\n\t\"phoneNumber\",\n\t\"phone_number\",\n\t\"from\",\n\t\"to\",\n\t\"fromNumber\",\n\t\"toNumber\",\n\t\"from_number\",\n\t\"to_number\",\n\t\"apiKey\",\n\t\"api_key\",\n\t\"authToken\",\n\t\"auth_token\",\n\t\"password\",\n\t\"secret\",\n\t\"token\",\n];\n\n// =============================================================================\n// PII REDACTION\n// =============================================================================\n\n/**\n * Mask a phone number, keeping last 4 digits\n */\nfunction maskPhoneNumber(phone: string): string {\n\tconst digits = phone.replace(/\\D/g, \"\");\n\tif (digits.length < 4) return \"****\";\n\treturn `***${digits.slice(-4)}`;\n}\n\n/**\n * Mask an email address\n */\nfunction maskEmail(email: string): string {\n\tconst [local, domain] = email.split(\"@\");\n\tif (!domain) return \"***@***\";\n\tconst maskedLocal = local.length > 2 ? `${local[0]}***${local[local.length - 1]}` : \"***\";\n\treturn `${maskedLocal}@${domain}`;\n}\n\n/**\n * Redact PII from a string\n */\nfunction redactString(value: string): string {\n\tlet result = value;\n\n\t// Redact phone numbers\n\tresult = result.replace(/\\+?1?\\d{10,15}/g, (match) => maskPhoneNumber(match));\n\n\t// Redact email addresses\n\tresult = result.replace(\n\t\t/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g,\n\t\t(match) => maskEmail(match)\n\t);\n\n\treturn result;\n}\n\n/**\n * Recursively redact PII from an object\n */\nfunction redactPII(obj: unknown, depth = 0): unknown {\n\t// Prevent infinite recursion\n\tif (depth > 10) return \"[MAX_DEPTH]\";\n\n\tif (obj === null || obj === undefined) {\n\t\treturn obj;\n\t}\n\n\tif (typeof obj === \"string\") {\n\t\treturn redactString(obj);\n\t}\n\n\tif (typeof obj === \"number\" || typeof obj === \"boolean\") {\n\t\treturn obj;\n\t}\n\n\tif (Array.isArray(obj)) {\n\t\treturn obj.map((item) => redactPII(item, depth + 1));\n\t}\n\n\tif (typeof obj === \"object\") {\n\t\tconst result: Record<string, unknown> = {};\n\n\t\tfor (const [key, value] of Object.entries(obj)) {\n\t\t\t// Check if this is a sensitive field\n\t\t\tconst isSensitive = SENSITIVE_FIELDS.some(\n\t\t\t\t(field) => key.toLowerCase().includes(field.toLowerCase())\n\t\t\t);\n\n\t\t\tif (isSensitive) {\n\t\t\t\tif (typeof value === \"string\") {\n\t\t\t\t\t// Mask the value\n\t\t\t\t\tif (value.includes(\"@\")) {\n\t\t\t\t\t\tresult[key] = maskEmail(value);\n\t\t\t\t\t} else if (/\\d/.test(value)) {\n\t\t\t\t\t\tresult[key] = maskPhoneNumber(value);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult[key] = \"[REDACTED]\";\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tresult[key] = \"[REDACTED]\";\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tresult[key] = redactPII(value, depth + 1);\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\treturn obj;\n}\n\n// =============================================================================\n// LOGGER CLASS\n// =============================================================================\n\nclass TelnyxLogger {\n\tprivate service = \"telnyx\";\n\tprivate defaultContext: LogContext = {};\n\n\t/**\n\t * Set default context for all log entries\n\t */\n\tsetDefaultContext(context: LogContext): void {\n\t\tthis.defaultContext = { ...this.defaultContext, ...context };\n\t}\n\n\t/**\n\t * Clear default context\n\t */\n\tclearDefaultContext(): void {\n\t\tthis.defaultContext = {};\n\t}\n\n\t/**\n\t * Check if a log level should be output\n\t */\n\tprivate shouldLog(level: LogLevel): boolean {\n\t\treturn LOG_LEVELS[level] >= LOG_LEVELS[currentLogLevel];\n\t}\n\n\t/**\n\t * Format and output a log entry\n\t */\n\tprivate log(level: LogLevel, message: string, context?: LogContext): void {\n\t\tif (!this.shouldLog(level)) return;\n\n\t\tconst entry: LogEntry = {\n\t\t\ttimestamp: new Date().toISOString(),\n\t\t\tlevel,\n\t\t\tservice: this.service,\n\t\t\tmessage,\n\t\t};\n\n\t\t// Merge default context with provided context\n\t\tconst fullContext = { ...this.defaultContext, ...context };\n\n\t\tif (Object.keys(fullContext).length > 0) {\n\t\t\t// Redact PII from context\n\t\t\tentry.context = redactPII(fullContext) as LogContext;\n\t\t}\n\n\t\t// Output as JSON in production, pretty print in development\n\t\tif (process.env.NODE_ENV === \"production\") {\n\t\t\tconst output = JSON.stringify(entry);\n\n\t\t\tswitch (level) {\n\t\t\t\tcase \"error\":\n\t\t\t\t\tconsole.error(output);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"warn\":\n\t\t\t\t\tconsole.warn(output);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tconsole.log(output);\n\t\t\t}\n\t\t} else {\n\t\t\t// Development: more readable format\n\t\t\tconst contextStr = entry.context\n\t\t\t\t? ` ${JSON.stringify(entry.context, null, 2)}`\n\t\t\t\t: \"\";\n\n\t\t\tconst prefix = `[${entry.timestamp}] [${level.toUpperCase()}] [${this.service}]`;\n\n\t\t\tswitch (level) {\n\t\t\t\tcase \"error\":\n\t\t\t\t\tconsole.error(`${prefix} ${message}${contextStr}`);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"warn\":\n\t\t\t\t\tconsole.warn(`${prefix} ${message}${contextStr}`);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"debug\":\n\t\t\t\t\tconsole.debug(`${prefix} ${message}${contextStr}`);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tconsole.log(`${prefix} ${message}${contextStr}`);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Log at debug level\n\t */\n\tdebug(message: string, context?: LogContext): void {\n\t\tthis.log(\"debug\", message, context);\n\t}\n\n\t/**\n\t * Log at info level\n\t */\n\tinfo(message: string, context?: LogContext): void {\n\t\tthis.log(\"info\", message, context);\n\t}\n\n\t/**\n\t * Log at warn level\n\t */\n\twarn(message: string, context?: LogContext): void {\n\t\tthis.log(\"warn\", message, context);\n\t}\n\n\t/**\n\t * Log at error level\n\t */\n\terror(message: string, context?: LogContext): void {\n\t\tthis.log(\"error\", message, context);\n\t}\n\n\t/**\n\t * Create a child logger with additional default context\n\t */\n\tchild(context: LogContext): TelnyxChildLogger {\n\t\treturn new TelnyxChildLogger(this, context);\n\t}\n\n\t/**\n\t * Log a request start\n\t */\n\tlogRequestStart(\n\t\tmethod: string,\n\t\tendpoint: string,\n\t\tcontext?: LogContext\n\t): { correlationId: string; startTime: number } {\n\t\tconst correlationId =\n\t\t\tcontext?.correlationId ||\n\t\t\t`tlx_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\n\t\tconst startTime = Date.now();\n\n\t\tthis.debug(`${method} ${endpoint} started`, {\n\t\t\t...context,\n\t\t\tcorrelationId,\n\t\t\tendpoint,\n\t\t});\n\n\t\treturn { correlationId, startTime };\n\t}\n\n\t/**\n\t * Log a request completion\n\t */\n\tlogRequestEnd(\n\t\tmethod: string,\n\t\tendpoint: string,\n\t\tstatusCode: number,\n\t\tstartTime: number,\n\t\tcontext?: LogContext\n\t): void {\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tconst logFn = statusCode >= 400 ? this.warn.bind(this) : this.info.bind(this);\n\n\t\tlogFn(`${method} ${endpoint} completed`, {\n\t\t\t...context,\n\t\t\tendpoint,\n\t\t\tstatusCode,\n\t\t\tlatencyMs,\n\t\t});\n\t}\n\n\t/**\n\t * Log a request error\n\t */\n\tlogRequestError(\n\t\tmethod: string,\n\t\tendpoint: string,\n\t\terror: Error,\n\t\tstartTime: number,\n\t\tcontext?: LogContext\n\t): void {\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\tthis.error(`${method} ${endpoint} failed`, {\n\t\t\t...context,\n\t\t\tendpoint,\n\t\t\terror: error.message,\n\t\t\tlatencyMs,\n\t\t});\n\t}\n}\n\n/**\n * Child logger with inherited context\n */\nclass TelnyxChildLogger {\n\tconstructor(\n\t\tprivate parent: TelnyxLogger,\n\t\tprivate context: LogContext\n\t) {}\n\n\tdebug(message: string, context?: LogContext): void {\n\t\tthis.parent.debug(message, { ...this.context, ...context });\n\t}\n\n\tinfo(message: string, context?: LogContext): void {\n\t\tthis.parent.info(message, { ...this.context, ...context });\n\t}\n\n\twarn(message: string, context?: LogContext): void {\n\t\tthis.parent.warn(message, { ...this.context, ...context });\n\t}\n\n\terror(message: string, context?: LogContext): void {\n\t\tthis.parent.error(message, { ...this.context, ...context });\n\t}\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\n/**\n * Singleton logger instance\n */\nexport const telnyxLogger = new TelnyxLogger();\n\n/**\n * Create a request-scoped logger\n */\nexport function createRequestLogger(correlationId: string): TelnyxChildLogger {\n\treturn telnyxLogger.child({ correlationId });\n}\n\n/**\n * Utility to redact PII from any object (exported for testing)\n */\nexport { redactPII };\n","/**\n * Telnyx Custom Error Classes\n *\n * Provides typed error classes for different failure scenarios\n * with error codes, metadata, and retry information.\n */\n\n// =============================================================================\n// ERROR CODES\n// =============================================================================\n\nexport enum TelnyxErrorCode {\n\t// Network errors\n\tNETWORK_ERROR = \"TELNYX_NETWORK_ERROR\",\n\tTIMEOUT = \"TELNYX_TIMEOUT\",\n\tCONNECTION_REFUSED = \"TELNYX_CONNECTION_REFUSED\",\n\n\t// Authentication errors\n\tINVALID_API_KEY = \"TELNYX_INVALID_API_KEY\",\n\tUNAUTHORIZED = \"TELNYX_UNAUTHORIZED\",\n\tFORBIDDEN = \"TELNYX_FORBIDDEN\",\n\n\t// Rate limiting\n\tRATE_LIMIT_EXCEEDED = \"TELNYX_RATE_LIMIT_EXCEEDED\",\n\n\t// Validation errors\n\tINVALID_PHONE_NUMBER = \"TELNYX_INVALID_PHONE_NUMBER\",\n\tINVALID_REQUEST = \"TELNYX_INVALID_REQUEST\",\n\tMISSING_REQUIRED_FIELD = \"TELNYX_MISSING_REQUIRED_FIELD\",\n\n\t// Resource errors\n\tNOT_FOUND = \"TELNYX_NOT_FOUND\",\n\tRESOURCE_CONFLICT = \"TELNYX_RESOURCE_CONFLICT\",\n\n\t// Provider errors\n\tPROVIDER_ERROR = \"TELNYX_PROVIDER_ERROR\",\n\tCARRIER_ERROR = \"TELNYX_CARRIER_ERROR\",\n\tDELIVERY_FAILED = \"TELNYX_DELIVERY_FAILED\",\n\n\t// Call-specific errors\n\tCALL_REJECTED = \"TELNYX_CALL_REJECTED\",\n\tCALL_BUSY = \"TELNYX_CALL_BUSY\",\n\tCALL_NO_ANSWER = \"TELNYX_CALL_NO_ANSWER\",\n\tCALL_FAILED = \"TELNYX_CALL_FAILED\",\n\n\t// SMS-specific errors\n\tSMS_DELIVERY_FAILED = \"TELNYX_SMS_DELIVERY_FAILED\",\n\tSMS_BLOCKED = \"TELNYX_SMS_BLOCKED\",\n\tSMS_SPAM_DETECTED = \"TELNYX_SMS_SPAM_DETECTED\",\n\n\t// Webhook errors\n\tWEBHOOK_VALIDATION_FAILED = \"TELNYX_WEBHOOK_VALIDATION_FAILED\",\n\tWEBHOOK_SIGNATURE_INVALID = \"TELNYX_WEBHOOK_SIGNATURE_INVALID\",\n\tWEBHOOK_TIMESTAMP_INVALID = \"TELNYX_WEBHOOK_TIMESTAMP_INVALID\",\n\tWEBHOOK_REPLAY_DETECTED = \"TELNYX_WEBHOOK_REPLAY_DETECTED\",\n\n\t// Circuit breaker\n\tCIRCUIT_BREAKER_OPEN = \"TELNYX_CIRCUIT_BREAKER_OPEN\",\n\n\t// Generic\n\tUNKNOWN_ERROR = \"TELNYX_UNKNOWN_ERROR\",\n\tINTERNAL_ERROR = \"TELNYX_INTERNAL_ERROR\",\n}\n\n// =============================================================================\n// BASE ERROR CLASS\n// =============================================================================\n\nexport interface TelnyxErrorMetadata {\n\tcorrelationId?: string;\n\tendpoint?: string;\n\tmethod?: string;\n\tstatusCode?: number;\n\tcompanyId?: string;\n\tphoneNumber?: string;\n\tcallControlId?: string;\n\tmessageSid?: string;\n\tattempt?: number;\n\tretryable?: boolean;\n\tretryAfterMs?: number;\n\toriginalError?: Error;\n\ttelnyxErrorCode?: string;\n\ttelnyxErrorDetail?: string;\n\t[key: string]: unknown;\n}\n\nexport class TelnyxError extends Error {\n\tpublic readonly code: TelnyxErrorCode;\n\tpublic readonly metadata: TelnyxErrorMetadata;\n\tpublic readonly timestamp: Date;\n\tpublic readonly retryable: boolean;\n\tpublic readonly retryAfterMs?: number;\n\n\tconstructor(\n\t\tmessage: string,\n\t\tcode: TelnyxErrorCode = TelnyxErrorCode.UNKNOWN_ERROR,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message);\n\t\tthis.name = \"TelnyxError\";\n\t\tthis.code = code;\n\t\tthis.metadata = metadata;\n\t\tthis.timestamp = new Date();\n\t\tthis.retryable = metadata.retryable ?? this.isRetryableCode(code);\n\t\tthis.retryAfterMs = metadata.retryAfterMs;\n\n\t\t// Capture stack trace\n\t\tif (Error.captureStackTrace) {\n\t\t\tError.captureStackTrace(this, TelnyxError);\n\t\t}\n\t}\n\n\tprivate isRetryableCode(code: TelnyxErrorCode): boolean {\n\t\tconst retryableCodes = [\n\t\t\tTelnyxErrorCode.NETWORK_ERROR,\n\t\t\tTelnyxErrorCode.TIMEOUT,\n\t\t\tTelnyxErrorCode.CONNECTION_REFUSED,\n\t\t\tTelnyxErrorCode.RATE_LIMIT_EXCEEDED,\n\t\t\tTelnyxErrorCode.PROVIDER_ERROR,\n\t\t\tTelnyxErrorCode.INTERNAL_ERROR,\n\t\t];\n\t\treturn retryableCodes.includes(code);\n\t}\n\n\t/**\n\t * Convert to JSON for logging/serialization\n\t */\n\ttoJSON(): Record<string, unknown> {\n\t\treturn {\n\t\t\tname: this.name,\n\t\t\tmessage: this.message,\n\t\t\tcode: this.code,\n\t\t\tmetadata: this.metadata,\n\t\t\ttimestamp: this.timestamp.toISOString(),\n\t\t\tretryable: this.retryable,\n\t\t\tretryAfterMs: this.retryAfterMs,\n\t\t\tstack: this.stack,\n\t\t};\n\t}\n\n\t/**\n\t * Create a user-friendly error message\n\t */\n\ttoUserMessage(): string {\n\t\tswitch (this.code) {\n\t\t\tcase TelnyxErrorCode.INVALID_PHONE_NUMBER:\n\t\t\t\treturn \"The phone number provided is invalid. Please check and try again.\";\n\t\t\tcase TelnyxErrorCode.RATE_LIMIT_EXCEEDED:\n\t\t\t\treturn \"Too many requests. Please wait a moment and try again.\";\n\t\t\tcase TelnyxErrorCode.CALL_BUSY:\n\t\t\t\treturn \"The number is busy. Please try again later.\";\n\t\t\tcase TelnyxErrorCode.CALL_NO_ANSWER:\n\t\t\t\treturn \"No answer. The call was not picked up.\";\n\t\t\tcase TelnyxErrorCode.SMS_BLOCKED:\n\t\t\t\treturn \"Message could not be delivered. The recipient may have blocked messages.\";\n\t\t\tcase TelnyxErrorCode.UNAUTHORIZED:\n\t\t\tcase TelnyxErrorCode.INVALID_API_KEY:\n\t\t\t\treturn \"Authentication failed. Please contact support.\";\n\t\t\tcase TelnyxErrorCode.NETWORK_ERROR:\n\t\t\tcase TelnyxErrorCode.TIMEOUT:\n\t\t\t\treturn \"Connection issue. Please try again.\";\n\t\t\tdefault:\n\t\t\t\treturn \"An error occurred. Please try again or contact support.\";\n\t\t}\n\t}\n}\n\n// =============================================================================\n// SPECIALIZED ERROR CLASSES\n// =============================================================================\n\n/**\n * Network-related errors (connectivity, timeout, etc.)\n */\nexport class TelnyxNetworkError extends TelnyxError {\n\tconstructor(message: string, metadata: TelnyxErrorMetadata = {}) {\n\t\tsuper(message, TelnyxErrorCode.NETWORK_ERROR, {\n\t\t\t...metadata,\n\t\t\tretryable: true,\n\t\t});\n\t\tthis.name = \"TelnyxNetworkError\";\n\t}\n}\n\n/**\n * Timeout errors\n */\nexport class TelnyxTimeoutError extends TelnyxError {\n\tpublic readonly timeoutMs: number;\n\n\tconstructor(\n\t\tmessage: string,\n\t\ttimeoutMs: number,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message, TelnyxErrorCode.TIMEOUT, {\n\t\t\t...metadata,\n\t\t\tretryable: true,\n\t\t});\n\t\tthis.name = \"TelnyxTimeoutError\";\n\t\tthis.timeoutMs = timeoutMs;\n\t}\n}\n\n/**\n * Rate limit errors\n */\nexport class TelnyxRateLimitError extends TelnyxError {\n\tconstructor(\n\t\tmessage: string,\n\t\tretryAfterMs: number,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message, TelnyxErrorCode.RATE_LIMIT_EXCEEDED, {\n\t\t\t...metadata,\n\t\t\tretryable: true,\n\t\t\tretryAfterMs,\n\t\t});\n\t\tthis.name = \"TelnyxRateLimitError\";\n\t}\n}\n\n/**\n * Authentication/Authorization errors\n */\nexport class TelnyxAuthError extends TelnyxError {\n\tconstructor(message: string, metadata: TelnyxErrorMetadata = {}) {\n\t\tconst code = metadata.statusCode === 403\n\t\t\t? TelnyxErrorCode.FORBIDDEN\n\t\t\t: TelnyxErrorCode.UNAUTHORIZED;\n\t\tsuper(message, code, {\n\t\t\t...metadata,\n\t\t\tretryable: false,\n\t\t});\n\t\tthis.name = \"TelnyxAuthError\";\n\t}\n}\n\n/**\n * Validation errors\n */\nexport class TelnyxValidationError extends TelnyxError {\n\tpublic readonly field?: string;\n\tpublic readonly validationDetails?: Record<string, string[]>;\n\n\tconstructor(\n\t\tmessage: string,\n\t\tmetadata: TelnyxErrorMetadata & {\n\t\t\tfield?: string;\n\t\t\tvalidationDetails?: Record<string, string[]>;\n\t\t} = {}\n\t) {\n\t\tsuper(message, TelnyxErrorCode.INVALID_REQUEST, {\n\t\t\t...metadata,\n\t\t\tretryable: false,\n\t\t});\n\t\tthis.name = \"TelnyxValidationError\";\n\t\tthis.field = metadata.field;\n\t\tthis.validationDetails = metadata.validationDetails;\n\t}\n}\n\n/**\n * Phone number validation errors\n */\nexport class TelnyxPhoneNumberError extends TelnyxError {\n\tpublic readonly phoneNumber: string;\n\n\tconstructor(\n\t\tmessage: string,\n\t\tphoneNumber: string,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message, TelnyxErrorCode.INVALID_PHONE_NUMBER, {\n\t\t\t...metadata,\n\t\t\tphoneNumber,\n\t\t\tretryable: false,\n\t\t});\n\t\tthis.name = \"TelnyxPhoneNumberError\";\n\t\tthis.phoneNumber = phoneNumber;\n\t}\n}\n\n/**\n * Webhook validation errors\n */\nexport class TelnyxWebhookError extends TelnyxError {\n\tconstructor(\n\t\tmessage: string,\n\t\tcode: TelnyxErrorCode = TelnyxErrorCode.WEBHOOK_VALIDATION_FAILED,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message, code, {\n\t\t\t...metadata,\n\t\t\tretryable: false,\n\t\t});\n\t\tthis.name = \"TelnyxWebhookError\";\n\t}\n}\n\n/**\n * Circuit breaker errors\n */\nexport class TelnyxCircuitBreakerError extends TelnyxError {\n\tpublic readonly endpoint: string;\n\n\tconstructor(endpoint: string, metadata: TelnyxErrorMetadata = {}) {\n\t\tsuper(\n\t\t\t`Circuit breaker is open for endpoint: ${endpoint}`,\n\t\t\tTelnyxErrorCode.CIRCUIT_BREAKER_OPEN,\n\t\t\t{\n\t\t\t\t...metadata,\n\t\t\t\tendpoint,\n\t\t\t\tretryable: false,\n\t\t\t}\n\t\t);\n\t\tthis.name = \"TelnyxCircuitBreakerError\";\n\t\tthis.endpoint = endpoint;\n\t}\n}\n\n/**\n * Call-specific errors\n */\nexport class TelnyxCallError extends TelnyxError {\n\tpublic readonly callControlId?: string;\n\n\tconstructor(\n\t\tmessage: string,\n\t\tcode: TelnyxErrorCode,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message, code, metadata);\n\t\tthis.name = \"TelnyxCallError\";\n\t\tthis.callControlId = metadata.callControlId;\n\t}\n}\n\n/**\n * SMS-specific errors\n */\nexport class TelnyxSmsError extends TelnyxError {\n\tpublic readonly messageSid?: string;\n\n\tconstructor(\n\t\tmessage: string,\n\t\tcode: TelnyxErrorCode,\n\t\tmetadata: TelnyxErrorMetadata = {}\n\t) {\n\t\tsuper(message, code, metadata);\n\t\tthis.name = \"TelnyxSmsError\";\n\t\tthis.messageSid = metadata.messageSid;\n\t}\n}\n\n// =============================================================================\n// ERROR FACTORY\n// =============================================================================\n\n/**\n * Create appropriate error from HTTP response\n */\nexport function createErrorFromResponse(\n\tstatusCode: number,\n\tbody: unknown,\n\tmetadata: TelnyxErrorMetadata = {}\n): TelnyxError {\n\tconst errorBody = body as {\n\t\terrors?: Array<{ code?: string; title?: string; detail?: string }>;\n\t\terror?: string;\n\t\tmessage?: string;\n\t};\n\n\tconst errorDetail = errorBody?.errors?.[0]?.detail ||\n\t\terrorBody?.error ||\n\t\terrorBody?.message ||\n\t\t\"Unknown error\";\n\n\tconst telnyxErrorCode = errorBody?.errors?.[0]?.code;\n\n\tconst fullMetadata = {\n\t\t...metadata,\n\t\tstatusCode,\n\t\ttelnyxErrorCode,\n\t\ttelnyxErrorDetail: errorDetail,\n\t};\n\n\tswitch (statusCode) {\n\t\tcase 400:\n\t\t\treturn new TelnyxValidationError(errorDetail, fullMetadata);\n\n\t\tcase 401:\n\t\t\treturn new TelnyxAuthError(\"Invalid API key or unauthorized\", fullMetadata);\n\n\t\tcase 403:\n\t\t\treturn new TelnyxAuthError(\"Access forbidden\", fullMetadata);\n\n\t\tcase 404:\n\t\t\treturn new TelnyxError(\"Resource not found\", TelnyxErrorCode.NOT_FOUND, {\n\t\t\t\t...fullMetadata,\n\t\t\t\tretryable: false,\n\t\t\t});\n\n\t\tcase 409:\n\t\t\treturn new TelnyxError(\"Resource conflict\", TelnyxErrorCode.RESOURCE_CONFLICT, {\n\t\t\t\t...fullMetadata,\n\t\t\t\tretryable: false,\n\t\t\t});\n\n\t\tcase 429:\n\t\t\tconst retryAfter = parseInt(\n\t\t\t\t(body as { retry_after?: string })?.retry_after || \"60\",\n\t\t\t\t10\n\t\t\t) * 1000;\n\t\t\treturn new TelnyxRateLimitError(\n\t\t\t\t\"Rate limit exceeded\",\n\t\t\t\tretryAfter,\n\t\t\t\tfullMetadata\n\t\t\t);\n\n\t\tcase 500:\n\t\tcase 502:\n\t\tcase 503:\n\t\tcase 504:\n\t\t\treturn new TelnyxError(\n\t\t\t\t\"Telnyx service error\",\n\t\t\t\tTelnyxErrorCode.PROVIDER_ERROR,\n\t\t\t\t{\n\t\t\t\t\t...fullMetadata,\n\t\t\t\t\tretryable: true,\n\t\t\t\t}\n\t\t\t);\n\n\t\tdefault:\n\t\t\treturn new TelnyxError(errorDetail, TelnyxErrorCode.UNKNOWN_ERROR, fullMetadata);\n\t}\n}\n\n/**\n * Create error from network/fetch error\n */\nexport function createErrorFromException(\n\terror: unknown,\n\tmetadata: TelnyxErrorMetadata = {}\n): TelnyxError {\n\tif (error instanceof TelnyxError) {\n\t\treturn error;\n\t}\n\n\tconst originalError = error instanceof Error ? error : new Error(String(error));\n\tconst errorCode = (originalError as NodeJS.ErrnoException).code;\n\n\tconst fullMetadata = {\n\t\t...metadata,\n\t\toriginalError,\n\t};\n\n\t// Check for specific error types\n\tif (originalError.name === \"AbortError\" || originalError.message.includes(\"timeout\")) {\n\t\treturn new TelnyxTimeoutError(\n\t\t\t\"Request timed out\",\n\t\t\tmetadata.timeout as number || 30000,\n\t\t\tfullMetadata\n\t\t);\n\t}\n\n\tif (\n\t\terrorCode === \"ECONNRESET\" ||\n\t\terrorCode === \"ECONNREFUSED\" ||\n\t\terrorCode === \"ENOTFOUND\" ||\n\t\terrorCode === \"ENETUNREACH\" ||\n\t\toriginalError.message.includes(\"fetch failed\") ||\n\t\toriginalError.message.includes(\"network\")\n\t) {\n\t\treturn new TelnyxNetworkError(\n\t\t\t`Network error: ${originalError.message}`,\n\t\t\tfullMetadata\n\t\t);\n\t}\n\n\treturn new TelnyxError(\n\t\toriginalError.message,\n\t\tTelnyxErrorCode.UNKNOWN_ERROR,\n\t\tfullMetadata\n\t);\n}\n\n// =============================================================================\n// ERROR UTILITIES\n// =============================================================================\n\n/**\n * Check if an error is a TelnyxError\n */\nexport function isTelnyxError(error: unknown): error is TelnyxError {\n\treturn error instanceof TelnyxError;\n}\n\n/**\n * Check if an error is retryable\n */\nexport function isRetryableError(error: unknown): boolean {\n\tif (error instanceof TelnyxError) {\n\t\treturn error.retryable;\n\t}\n\n\t// Check for network errors\n\tif (error instanceof Error) {\n\t\tconst errorCode = (error as NodeJS.ErrnoException).code;\n\t\tconst retryableErrorCodes = [\n\t\t\t\"ECONNRESET\",\n\t\t\t\"ETIMEDOUT\",\n\t\t\t\"ECONNREFUSED\",\n\t\t\t\"EPIPE\",\n\t\t\t\"ENOTFOUND\",\n\t\t\t\"ENETUNREACH\",\n\t\t\t\"EAI_AGAIN\",\n\t\t];\n\t\tif (errorCode && retryableErrorCodes.includes(errorCode)) {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\treturn false;\n}\n\n/**\n * Wrap an error to ensure it's a TelnyxError\n */\nexport function wrapError(\n\terror: unknown,\n\tmetadata: TelnyxErrorMetadata = {}\n): TelnyxError {\n\tif (error instanceof TelnyxError) {\n\t\t// Merge metadata\n\t\treturn new TelnyxError(error.message, error.code, {\n\t\t\t...error.metadata,\n\t\t\t...metadata,\n\t\t});\n\t}\n\n\treturn createErrorFromException(error, metadata);\n}\n","/**\n * Telnyx Metrics & Monitoring\n *\n * Tracks API performance, error rates, and usage statistics.\n */\n\nimport { telnyxLogger } from \"./logger\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface RequestMetrics {\n\tendpoint: string;\n\tmethod: string;\n\tstatusCode: number;\n\tlatencyMs: number;\n\tsuccess: boolean;\n\ttimestamp: Date;\n\tcompanyId?: string;\n\tcorrelationId?: string;\n}\n\nexport interface AggregatedMetrics {\n\ttotalRequests: number;\n\tsuccessfulRequests: number;\n\tfailedRequests: number;\n\terrorRate: number;\n\tlatency: {\n\t\tp50: number;\n\t\tp95: number;\n\t\tp99: number;\n\t\tavg: number;\n\t\tmin: number;\n\t\tmax: number;\n\t};\n\tbyEndpoint: Record<\n\t\tstring,\n\t\t{\n\t\t\tcount: number;\n\t\t\terrors: number;\n\t\t\tavgLatency: number;\n\t\t}\n\t>;\n\tbyStatusCode: Record<number, number>;\n}\n\nexport interface OperationMetrics {\n\tsmsSent: number;\n\tsmsDelivered: number;\n\tsmsFailed: number;\n\tcallsInitiated: number;\n\tcallsCompleted: number;\n\tcallsFailed: number;\n\twebhooksReceived: number;\n\twebhooksProcessed: number;\n\twebhooksFailed: number;\n}\n\n// =============================================================================\n// METRICS COLLECTOR\n// =============================================================================\n\nclass MetricsCollector {\n\tprivate requests: RequestMetrics[] = [];\n\tprivate operations: OperationMetrics = {\n\t\tsmsSent: 0,\n\t\tsmsDelivered: 0,\n\t\tsmsFailed: 0,\n\t\tcallsInitiated: 0,\n\t\tcallsCompleted: 0,\n\t\tcallsFailed: 0,\n\t\twebhooksReceived: 0,\n\t\twebhooksProcessed: 0,\n\t\twebhooksFailed: 0,\n\t};\n\tprivate retentionMs: number = 60 * 60 * 1000; // 1 hour\n\tprivate maxEntries: number = 10000;\n\tprivate cleanupInterval?: NodeJS.Timeout;\n\n\tconstructor() {\n\t\tthis.startCleanup();\n\t}\n\n\t/**\n\t * Start periodic cleanup\n\t */\n\tprivate startCleanup(): void {\n\t\tthis.cleanupInterval = setInterval(() => {\n\t\t\tthis.cleanup();\n\t\t}, 60000); // Every minute\n\n\t\tif (this.cleanupInterval.unref) {\n\t\t\tthis.cleanupInterval.unref();\n\t\t}\n\t}\n\n\t/**\n\t * Clean up old metrics\n\t */\n\tprivate cleanup(): void {\n\t\tconst cutoff = Date.now() - this.retentionMs;\n\t\tconst initialCount = this.requests.length;\n\n\t\tthis.requests = this.requests.filter(\n\t\t\t(r) => r.timestamp.getTime() > cutoff\n\t\t);\n\n\t\t// Also trim if over max entries\n\t\tif (this.requests.length > this.maxEntries) {\n\t\t\tthis.requests = this.requests.slice(-this.maxEntries);\n\t\t}\n\n\t\tconst removed = initialCount - this.requests.length;\n\t\tif (removed > 0) {\n\t\t\ttelnyxLogger.debug(\"Metrics cleanup\", { removed });\n\t\t}\n\t}\n\n\t/**\n\t * Record a request\n\t */\n\trecordRequest(metrics: RequestMetrics): void {\n\t\tthis.requests.push(metrics);\n\n\t\t// Log slow requests\n\t\tif (metrics.latencyMs > 2000) {\n\t\t\ttelnyxLogger.warn(\"Slow request detected\", {\n\t\t\t\tendpoint: metrics.endpoint,\n\t\t\t\tlatencyMs: metrics.latencyMs,\n\t\t\t\tcorrelationId: metrics.correlationId,\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Record SMS sent\n\t */\n\trecordSmsSent(success: boolean): void {\n\t\tthis.operations.smsSent++;\n\t\tif (!success) {\n\t\t\tthis.operations.smsFailed++;\n\t\t}\n\t}\n\n\t/**\n\t * Record SMS delivered\n\t */\n\trecordSmsDelivered(): void {\n\t\tthis.operations.smsDelivered++;\n\t}\n\n\t/**\n\t * Record call initiated\n\t */\n\trecordCallInitiated(success: boolean): void {\n\t\tthis.operations.callsInitiated++;\n\t\tif (!success) {\n\t\t\tthis.operations.callsFailed++;\n\t\t}\n\t}\n\n\t/**\n\t * Record call completed\n\t */\n\trecordCallCompleted(): void {\n\t\tthis.operations.callsCompleted++;\n\t}\n\n\t/**\n\t * Record webhook received\n\t */\n\trecordWebhook(processed: boolean): void {\n\t\tthis.operations.webhooksReceived++;\n\t\tif (processed) {\n\t\t\tthis.operations.webhooksProcessed++;\n\t\t} else {\n\t\t\tthis.operations.webhooksFailed++;\n\t\t}\n\t}\n\n\t/**\n\t * Get aggregated metrics for a time window\n\t */\n\tgetAggregatedMetrics(windowMs: number = 5 * 60 * 1000): AggregatedMetrics {\n\t\tconst cutoff = Date.now() - windowMs;\n\t\tconst filtered = this.requests.filter(\n\t\t\t(r) => r.timestamp.getTime() > cutoff\n\t\t);\n\n\t\tconst successfulRequests = filtered.filter((r) => r.success).length;\n\t\tconst failedRequests = filtered.length - successfulRequests;\n\t\tconst latencies = filtered.map((r) => r.latencyMs).sort((a, b) => a - b);\n\n\t\t// Calculate percentiles\n\t\tconst getPercentile = (arr: number[], p: number): number => {\n\t\t\tif (arr.length === 0) return 0;\n\t\t\tconst index = Math.ceil((p / 100) * arr.length) - 1;\n\t\t\treturn arr[Math.max(0, index)];\n\t\t};\n\n\t\t// Group by endpoint\n\t\tconst byEndpoint: Record<\n\t\t\tstring,\n\t\t\t{ count: number; errors: number; totalLatency: number }\n\t\t> = {};\n\t\tfor (const r of filtered) {\n\t\t\tif (!byEndpoint[r.endpoint]) {\n\t\t\t\tbyEndpoint[r.endpoint] = { count: 0, errors: 0, totalLatency: 0 };\n\t\t\t}\n\t\t\tbyEndpoint[r.endpoint].count++;\n\t\t\tbyEndpoint[r.endpoint].totalLatency += r.latencyMs;\n\t\t\tif (!r.success) {\n\t\t\t\tbyEndpoint[r.endpoint].errors++;\n\t\t\t}\n\t\t}\n\n\t\t// Group by status code\n\t\tconst byStatusCode: Record<number, number> = {};\n\t\tfor (const r of filtered) {\n\t\t\tbyStatusCode[r.statusCode] = (byStatusCode[r.statusCode] || 0) + 1;\n\t\t}\n\n\t\treturn {\n\t\t\ttotalRequests: filtered.length,\n\t\t\tsuccessfulRequests,\n\t\t\tfailedRequests,\n\t\t\terrorRate:\n\t\t\t\tfiltered.length > 0 ? failedRequests / filtered.length : 0,\n\t\t\tlatency: {\n\t\t\t\tp50: getPercentile(latencies, 50),\n\t\t\t\tp95: getPercentile(latencies, 95),\n\t\t\t\tp99: getPercentile(latencies, 99),\n\t\t\t\tavg:\n\t\t\t\t\tlatencies.length > 0\n\t\t\t\t\t\t? latencies.reduce((a, b) => a + b, 0) / latencies.length\n\t\t\t\t\t\t: 0,\n\t\t\t\tmin: latencies[0] || 0,\n\t\t\t\tmax: latencies[latencies.length - 1] || 0,\n\t\t\t},\n\t\t\tbyEndpoint: Object.fromEntries(\n\t\t\t\tObject.entries(byEndpoint).map(([ep, data]) => [\n\t\t\t\t\tep,\n\t\t\t\t\t{\n\t\t\t\t\t\tcount: data.count,\n\t\t\t\t\t\terrors: data.errors,\n\t\t\t\t\t\tavgLatency: data.totalLatency / data.count,\n\t\t\t\t\t},\n\t\t\t\t])\n\t\t\t),\n\t\t\tbyStatusCode,\n\t\t};\n\t}\n\n\t/**\n\t * Get operation metrics\n\t */\n\tgetOperationMetrics(): OperationMetrics {\n\t\treturn { ...this.operations };\n\t}\n\n\t/**\n\t * Get health score (0-100)\n\t */\n\tgetHealthScore(windowMs: number = 5 * 60 * 1000): number {\n\t\tconst metrics = this.getAggregatedMetrics(windowMs);\n\n\t\tif (metrics.totalRequests === 0) {\n\t\t\treturn 100; // No requests, assume healthy\n\t\t}\n\n\t\t// Factors:\n\t\t// - Error rate (weight: 50%)\n\t\t// - Latency (weight: 30%)\n\t\t// - 5xx errors (weight: 20%)\n\n\t\t// Error rate score (0 = 100%, 10%+ = 0)\n\t\tconst errorScore = Math.max(0, 100 - metrics.errorRate * 1000);\n\n\t\t// Latency score (0ms = 100, 3000ms+ = 0)\n\t\tconst latencyScore = Math.max(0, 100 - (metrics.latency.p95 / 3000) * 100);\n\n\t\t// 5xx score\n\t\tconst total5xx = Object.entries(metrics.byStatusCode)\n\t\t\t.filter(([code]) => parseInt(code) >= 500)\n\t\t\t.reduce((sum, [, count]) => sum + count, 0);\n\t\tconst rate5xx = total5xx / metrics.totalRequests;\n\t\tconst score5xx = Math.max(0, 100 - rate5xx * 1000);\n\n\t\treturn Math.round(errorScore * 0.5 + latencyScore * 0.3 + score5xx * 0.2);\n\t}\n\n\t/**\n\t * Reset metrics\n\t */\n\treset(): void {\n\t\tthis.requests = [];\n\t\tthis.operations = {\n\t\t\tsmsSent: 0,\n\t\t\tsmsDelivered: 0,\n\t\t\tsmsFailed: 0,\n\t\t\tcallsInitiated: 0,\n\t\t\tcallsCompleted: 0,\n\t\t\tcallsFailed: 0,\n\t\t\twebhooksReceived: 0,\n\t\t\twebhooksProcessed: 0,\n\t\t\twebhooksFailed: 0,\n\t\t};\n\t}\n\n\t/**\n\t * Stop cleanup interval\n\t */\n\tstop(): void {\n\t\tif (this.cleanupInterval) {\n\t\t\tclearInterval(this.cleanupInterval);\n\t\t}\n\t}\n}\n\n// =============================================================================\n// SINGLETON INSTANCE\n// =============================================================================\n\nexport const telnyxMetrics = new MetricsCollector();\n\n// =============================================================================\n// CONVENIENCE FUNCTIONS\n// =============================================================================\n\n/**\n * Create a request timer\n */\nexport function startRequestTimer(\n\tendpoint: string,\n\tmethod: string,\n\tcompanyId?: string,\n\tcorrelationId?: string\n): { end: (statusCode: number, success: boolean) => void } {\n\tconst startTime = Date.now();\n\n\treturn {\n\t\tend: (statusCode: number, success: boolean) => {\n\t\t\ttelnyxMetrics.recordRequest({\n\t\t\t\tendpoint,\n\t\t\t\tmethod,\n\t\t\t\tstatusCode,\n\t\t\t\tlatencyMs: Date.now() - startTime,\n\t\t\t\tsuccess,\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\tcompanyId,\n\t\t\t\tcorrelationId,\n\t\t\t});\n\t\t},\n\t};\n}\n\n/**\n * Get a summary for monitoring dashboards\n */\nexport function getMetricsSummary(): {\n\thealth: number;\n\tmetrics: AggregatedMetrics;\n\toperations: OperationMetrics;\n} {\n\treturn {\n\t\thealth: telnyxMetrics.getHealthScore(),\n\t\tmetrics: telnyxMetrics.getAggregatedMetrics(),\n\t\toperations: telnyxMetrics.getOperationMetrics(),\n\t};\n}\n\n/**\n * Format metrics for logging\n */\nexport function formatMetricsForLogging(): string {\n\tconst summary = getMetricsSummary();\n\tconst { metrics, operations, health } = summary;\n\n\treturn [\n\t\t`Health Score: ${health}/100`,\n\t\t`Requests: ${metrics.totalRequests} (${metrics.failedRequests} failed)`,\n\t\t`Error Rate: ${(metrics.errorRate * 100).toFixed(2)}%`,\n\t\t`Latency: p50=${metrics.latency.p50}ms p95=${metrics.latency.p95}ms`,\n\t\t`SMS: ${operations.smsSent} sent, ${operations.smsDelivered} delivered, ${operations.smsFailed} failed`,\n\t\t`Calls: ${operations.callsInitiated} initiated, ${operations.callsCompleted} completed`,\n\t\t`Webhooks: ${operations.webhooksReceived} received, ${operations.webhooksFailed} failed`,\n\t].join(\" | \");\n}\n","/**\n * Messaging Profile Setup & Verification\n *\n * Verifies messaging profile configuration and can auto-update webhook URLs.\n */\n\nimport { TELNYX_CONFIG, telnyxClient } from \"./client\";\n\nexport type MessagingProfileStatus = {\n\texists: boolean;\n\tisActive: boolean;\n\thasWebhookUrl: boolean;\n\twebhookUrl: string | null;\n\twebhookFailoverUrl: string | null;\n\twebhookApiVersion: string | null;\n\tneedsFix: boolean;\n\tissues: string[];\n};\n\nexport type MessagingProfileFixResult = {\n\tsuccess: boolean;\n\tfixed: boolean;\n\terror?: string;\n\tchanges: string[];\n};\n\nfunction getWebhookUrl(): string | undefined {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\t\n\tconst isDevelopment = \n\t\tprocess.env.NODE_ENV === \"development\" ||\n\t\tprocess.env.VERCEL_ENV !== \"production\" ||\n\t\tprocess.env.DEPLOYMENT_ENV !== \"production\";\n\t\n\tfor (const candidate of candidates) {\n\t\tif (candidate && candidate.trim()) {\n\t\t\tconst trimmed = candidate.trim();\n\t\t\tconst isLocal =\n\t\t\t\ttrimmed.includes(\"localhost\") ||\n\t\t\t\ttrimmed.includes(\"127.0.0.1\") ||\n\t\t\t\ttrimmed.includes(\"0.0.0.0\");\n\t\t\t\n\t\t\t// In development, allow localhost URLs (useful for testing with ngrok or similar)\n\t\t\t// In production, reject localhost\n\t\t\tif (isLocal && !isDevelopment) {\n\t\t\t\tcontinue; // Skip localhost in production\n\t\t\t}\n\t\t\t\n\t\t\tconst normalized = trimmed.startsWith(\"http\")\n\t\t\t\t? trimmed\n\t\t\t\t: `https://${trimmed}`;\n\t\t\treturn `${normalized.replace(/\\/+$/, \"\")}/api/webhooks/telnyx`;\n\t\t}\n\t}\n\treturn undefined;\n}\n\n/**\n * Verify messaging profile configuration\n */\nexport async function verifyMessagingProfile(\n\tmessagingProfileId?: string,\n): Promise<MessagingProfileStatus> {\n\tconst profileId = messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\n\tconst status: MessagingProfileStatus = {\n\t\texists: false,\n\t\tisActive: false,\n\t\thasWebhookUrl: false,\n\t\twebhookUrl: null,\n\t\twebhookFailoverUrl: null,\n\t\twebhookApiVersion: null,\n\t\tneedsFix: false,\n\t\tissues: [],\n\t};\n\n\tif (!profileId || profileId.trim() === \"\") {\n\t\tstatus.issues.push(\"Messaging profile ID is not configured\");\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n\n\ttry {\n\t\tconst profile = await telnyxClient.messagingProfiles.retrieve(profileId);\n\t\tconst profileData = profile.data as any;\n\n\t\tif (!profileData) {\n\t\t\tstatus.issues.push(`Messaging profile ${profileId} not found in Telnyx`);\n\t\t\tstatus.needsFix = true;\n\t\t\treturn status;\n\t\t}\n\n\t\tstatus.exists = true;\n\t\tstatus.isActive = profileData.enabled !== false;\n\t\tstatus.webhookUrl = profileData.webhook_url || null;\n\t\tstatus.webhookFailoverUrl = profileData.webhook_failover_url || null;\n\t\tstatus.webhookApiVersion = profileData.webhook_api_version || null;\n\n\t\t// Check webhook URL\n\t\tconst expectedWebhookUrl = getWebhookUrl();\n\t\tif (!expectedWebhookUrl) {\n\t\t\tconst isDevelopment = \n\t\t\t\tprocess.env.NODE_ENV === \"development\" ||\n\t\t\t\tprocess.env.VERCEL_ENV !== \"production\" ||\n\t\t\t\tprocess.env.DEPLOYMENT_ENV !== \"production\";\n\t\t\t\n\t\t\tif (isDevelopment) {\n\t\t\t\tstatus.issues.push(\n\t\t\t\t\t\"NEXT_PUBLIC_SITE_URL is not set. Set it to your production URL (e.g., https://yourdomain.com) or use a tool like ngrok for local testing.\",\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tstatus.issues.push(\n\t\t\t\t\t\"NEXT_PUBLIC_SITE_URL is not set to a valid production URL. Set it to your production domain (e.g., https://yourdomain.com) in your environment variables.\",\n\t\t\t\t);\n\t\t\t}\n\t\t\tstatus.needsFix = true;\n\t\t} else if (!status.webhookUrl) {\n\t\t\tstatus.issues.push(\n\t\t\t\t`Webhook URL is not set. Expected: ${expectedWebhookUrl} (with optional ?company=... for multi-tenant)`,\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t} else {\n\t\t\t// Accept both base webhook URL and company-specific URLs (with query params)\n\t\t\tconst baseUrl = status.webhookUrl.split(\"?\")[0];\n\t\t\tif (\n\t\t\t\tbaseUrl === expectedWebhookUrl ||\n\t\t\t\tstatus.webhookUrl === expectedWebhookUrl\n\t\t\t) {\n\t\t\t\tstatus.hasWebhookUrl = true;\n\t\t\t} else {\n\t\t\t\tstatus.issues.push(\n\t\t\t\t\t`Webhook URL base is not set correctly. Expected: ${expectedWebhookUrl}, Current: ${baseUrl}`,\n\t\t\t\t);\n\t\t\t\tstatus.needsFix = true;\n\t\t\t}\n\t\t}\n\n\t\t// Check webhook API version\n\t\tif (status.webhookApiVersion !== \"2\") {\n\t\t\tstatus.issues.push(\n\t\t\t\t`Webhook API version should be \"2\", but is \"${status.webhookApiVersion || \"not set\"}\"`,\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\t// Check if profile is active\n\t\tif (!status.isActive) {\n\t\t\tstatus.issues.push(\"Messaging profile is not enabled\");\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\treturn status;\n\t} catch (error: any) {\n\t\tif (error?.statusCode === 404) {\n\t\t\tstatus.issues.push(`Messaging profile ${profileId} not found in Telnyx`);\n\t\t} else {\n\t\t\tstatus.issues.push(\n\t\t\t\terror?.message || \"Failed to retrieve messaging profile\",\n\t\t\t);\n\t\t}\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n}\n\n/**\n * Auto-fix messaging profile configuration\n */\nexport async function fixMessagingProfile(\n\tmessagingProfileId?: string,\n\toptions?: {\n\t\twebhookUrl?: string;\n\t\twebhookFailoverUrl?: string;\n\t},\n): Promise<MessagingProfileFixResult> {\n\tconst profileId = messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\tconst changes: string[] = [];\n\n\tif (!profileId || profileId.trim() === \"\") {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: \"Messaging profile ID is not configured\",\n\t\t\tchanges: [],\n\t\t};\n\t}\n\n\ttry {\n\t\t// Get current status\n\t\tconst status = await verifyMessagingProfile(profileId);\n\t\tif (!status.needsFix) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tfixed: false,\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Get expected webhook URL\n\t\tconst expectedWebhookUrl = options?.webhookUrl || getWebhookUrl();\n\t\tif (!expectedWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tfixed: false,\n\t\t\t\terror:\n\t\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be set to a valid production URL to configure webhooks\",\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Prepare update\n\t\tconst updateData: Record<string, unknown> = {};\n\n\t\t// Fix webhook URL\n\t\tif (status.webhookUrl !== expectedWebhookUrl) {\n\t\t\tupdateData.webhook_url = expectedWebhookUrl;\n\t\t\tchanges.push(`Updated webhook URL to ${expectedWebhookUrl}`);\n\t\t}\n\n\t\t// Fix webhook failover URL\n\t\tconst expectedFailoverUrl =\n\t\t\toptions?.webhookFailoverUrl ||\n\t\t\tprocess.env.TELNYX_WEBHOOK_FAILOVER_URL ||\n\t\t\tnull;\n\t\tif (status.webhookFailoverUrl !== expectedFailoverUrl) {\n\t\t\tupdateData.webhook_failover_url = expectedFailoverUrl;\n\t\t\tif (expectedFailoverUrl) {\n\t\t\t\tchanges.push(`Updated webhook failover URL to ${expectedFailoverUrl}`);\n\t\t\t} else {\n\t\t\t\tchanges.push(\"Removed webhook failover URL\");\n\t\t\t}\n\t\t}\n\n\t\t// Fix webhook API version\n\t\tif (status.webhookApiVersion !== \"2\") {\n\t\t\tupdateData.webhook_api_version = \"2\";\n\t\t\tchanges.push(\"Updated webhook API version to 2\");\n\t\t}\n\n\t\t// Fix profile enabled status\n\t\tif (!status.isActive) {\n\t\t\tupdateData.enabled = true;\n\t\t\tchanges.push(\"Enabled messaging profile\");\n\t\t}\n\n\t\t// Apply updates if needed\n\t\tif (Object.keys(updateData).length > 0) {\n\t\t\tawait telnyxClient.messagingProfiles.update(profileId, updateData);\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tfixed: changes.length > 0,\n\t\t\tchanges,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: error?.message || \"Failed to update messaging profile\",\n\t\t\tchanges,\n\t\t};\n\t}\n}\n\n/**\n * Get messaging profile details\n */\nasync function getMessagingProfileDetails(\n\tmessagingProfileId?: string,\n): Promise<{\n\tsuccess: boolean;\n\tdata?: any;\n\terror?: string;\n}> {\n\tconst profileId = messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\n\tif (!profileId || profileId.trim() === \"\") {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Messaging profile ID is not configured\",\n\t\t};\n\t}\n\n\ttry {\n\t\tconst profile = await telnyxClient.messagingProfiles.retrieve(profileId);\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: profile.data,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error?.message || \"Failed to retrieve messaging profile\",\n\t\t};\n\t}\n}\n","/**\n * Telnyx Phone Numbers Service - Number Management\n *\n * Handles all phone number operations including:\n * - Searching available numbers\n * - Purchasing numbers\n * - Porting numbers\n * - Configuring number settings\n * - Releasing numbers\n */\n\nimport { telnyxClient } from \"./client\";\n\n/**\n * Number type for search\n */\nexport type NumberType =\n\t| \"local\"\n\t| \"toll-free\"\n\t| \"national\"\n\t| \"mobile\"\n\t| \"shared_cost\";\n\n/**\n * Number features\n */\nexport type NumberFeature = \"sms\" | \"mms\" | \"voice\" | \"fax\";\n\n/**\n * Search for available phone numbers\n */\nexport async function searchAvailableNumbers(params: {\n\tcountryCode?: string;\n\tareaCode?: string;\n\tnumberType?: NumberType;\n\tfeatures?: NumberFeature[];\n\tlimit?: number;\n\tstartsWith?: string;\n\tendsWith?: string;\n\tcontains?: string;\n}) {\n\ttry {\n\t\tconst numbers = await (telnyxClient.availablePhoneNumbers as any).list({\n\t\t\tfilter: {\n\t\t\t\tcountry_code: params.countryCode || \"US\",\n\t\t\t\tnational_destination_code: params.areaCode,\n\t\t\t\tfeatures: params.features,\n\t\t\t\tlimit: params.limit || 10,\n\t\t\t\tstarts_with: params.startsWith,\n\t\t\t\tends_with: params.endsWith,\n\t\t\t\tcontains: params.contains,\n\t\t\t} as any,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: numbers.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to search numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Purchase a phone number\n */\nexport async function purchaseNumber(params: {\n\tphoneNumber: string;\n\tmessagingProfileId?: string;\n\tconnectionId?: string;\n\tbillingGroupId?: string;\n\tcustomerReference?: string;\n}) {\n\ttry {\n\t\tconst number = await telnyxClient.numberOrders.create({\n\t\t\tphone_numbers: [\n\t\t\t\t{\n\t\t\t\t\tphone_number: params.phoneNumber,\n\t\t\t\t},\n\t\t\t],\n\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\tconnection_id: params.connectionId,\n\t\t\tbilling_group_id: params.billingGroupId,\n\t\t\tcustomer_reference: params.customerReference,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\torderId: number.data?.id,\n\t\t\tdata: number.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to purchase number\",\n\t\t};\n\t}\n}\n\n/**\n * List all owned phone numbers\n */\nexport async function listOwnedNumbers(params?: {\n\tpageSize?: number;\n\tpageNumber?: number;\n\tfilterTag?: string;\n\tfilterStatus?: \"active\" | \"pending\" | \"suspended\" | \"deleted\";\n}) {\n\ttry {\n\t\tconst numbers = await (telnyxClient.phoneNumbers as any).list({\n\t\t\tpage: {\n\t\t\t\tsize: params?.pageSize || 20,\n\t\t\t\tnumber: params?.pageNumber || 1,\n\t\t\t},\n\t\t\tfilter: {\n\t\t\t\ttag: params?.filterTag,\n\t\t\t\tstatus: params?.filterStatus,\n\t\t\t} as any,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: numbers.data,\n\t\t\tmeta: numbers.meta,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to list numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Get phone number details\n */\nexport async function getNumberDetails(phoneNumberId: string) {\n\ttry {\n\t\tconst number = await (telnyxClient.phoneNumbers as any).retrieve(\n\t\t\tphoneNumberId,\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: number.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to retrieve number\",\n\t\t};\n\t}\n}\n\n/**\n * Update phone number configuration\n */\nexport async function updateNumber(params: {\n\tphoneNumberId: string;\n\tconnectionId?: string;\n\tmessagingProfileId?: string;\n\tbillingGroupId?: string;\n\ttags?: string[];\n\tcustomerReference?: string;\n}) {\n\ttry {\n\t\tconst number = await (telnyxClient.phoneNumbers as any).update(\n\t\t\tparams.phoneNumberId,\n\t\t\t{\n\t\t\t\tconnection_id: params.connectionId,\n\t\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\t\tbilling_group_id: params.billingGroupId,\n\t\t\t\ttags: params.tags,\n\t\t\t\tcustomer_reference: params.customerReference,\n\t\t\t} as any,\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: number.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to update number\",\n\t\t};\n\t}\n}\n\n/**\n * Release (delete) a phone number\n */\nexport async function releaseNumber(phoneNumberId: string) {\n\ttry {\n\t\tawait (telnyxClient.phoneNumbers as any).del(phoneNumberId);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to release number\",\n\t\t};\n\t}\n}\n\n/**\n * Initiate number porting request\n */\nexport async function initiatePorting(params: {\n\tphoneNumbers: string[];\n\tbillingGroupId?: string;\n\tfastPortEligible?: boolean;\n\t// Account information\n\taccountNumber?: string;\n\taccountPin?: string;\n\tauthorizedPerson?: string;\n\t// Service address\n\taddressLine1?: string;\n\tcity?: string;\n\tstateOrProvince?: string;\n\tzipOrPostalCode?: string;\n\tcountryCode?: string;\n}) {\n\ttry {\n\t\tconst portingOrder = await (telnyxClient as any).numberPortouts.create({\n\t\t\tphone_numbers: params.phoneNumbers,\n\t\t\tbilling_group_id: params.billingGroupId,\n\t\t\tfast_port_eligible: params.fastPortEligible,\n\t\t\tcustomer_reference: {\n\t\t\t\taccount_number: params.accountNumber,\n\t\t\t\taccount_pin: params.accountPin,\n\t\t\t\tauthorized_person: params.authorizedPerson,\n\t\t\t},\n\t\t\tservice_address: {\n\t\t\t\taddress_line_1: params.addressLine1,\n\t\t\t\tcity: params.city,\n\t\t\t\tstate_or_province: params.stateOrProvince,\n\t\t\t\tzip_or_postal_code: params.zipOrPostalCode,\n\t\t\t\tcountry_code: params.countryCode || \"US\",\n\t\t\t},\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tportingOrderId: portingOrder.data.id,\n\t\t\tdata: portingOrder.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to initiate porting\",\n\t\t};\n\t}\n}\n\n/**\n * Get porting order status\n */\nasync function getPortingStatus(portingOrderId: string) {\n\ttry {\n\t\tconst order = await (telnyxClient as any).numberPortouts.retrieve(\n\t\t\tportingOrderId,\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tstatus: order.data.status,\n\t\t\tdata: order.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get porting status\",\n\t\t};\n\t}\n}\n\n/**\n * Estimate number costs\n */\nasync function estimateNumberCost(params: {\n\tcountryCode: string;\n\tnumberType: NumberType;\n}) {\n\t// Cost estimates based on Telnyx pricing (as of 2025)\n\tconst costs = {\n\t\tUS: {\n\t\t\tlocal: { monthly: 1.0, setup: 0.0 },\n\t\t\t\"toll-free\": { monthly: 2.0, setup: 0.0 },\n\t\t\tmobile: { monthly: 5.0, setup: 0.0 },\n\t\t},\n\t\tCA: {\n\t\t\tlocal: { monthly: 1.5, setup: 0.0 },\n\t\t\t\"toll-free\": { monthly: 2.5, setup: 0.0 },\n\t\t},\n\t\tGB: {\n\t\t\tlocal: { monthly: 2.0, setup: 0.0 },\n\t\t\t\"toll-free\": { monthly: 3.0, setup: 0.0 },\n\t\t},\n\t};\n\n\tconst countryCode = params.countryCode.toUpperCase();\n\tconst pricing = costs[countryCode as keyof typeof costs];\n\n\tif (!pricing) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: `Pricing not available for country: ${countryCode}`,\n\t\t};\n\t}\n\n\tconst typePricing = pricing[params.numberType as keyof typeof pricing];\n\n\tif (!typePricing) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: `Number type ${params.numberType} not available in ${countryCode}`,\n\t\t};\n\t}\n\n\treturn {\n\t\tsuccess: true,\n\t\tcosts: {\n\t\t\tmonthly: typePricing.monthly,\n\t\t\tsetup: typePricing.setup,\n\t\t\tcurrency: \"USD\",\n\t\t},\n\t};\n}\n\n/**\n * Validate if a number can be ported\n */\nasync function validatePortability(phoneNumber: string) {\n\ttry {\n\t\t// This would typically call Telnyx's LNP (Local Number Portability) check API\n\t\t// For now, we'll do basic validation\n\n\t\tconst cleanNumber = phoneNumber.replace(/\\D/g, \"\");\n\n\t\t// Must be at least 10 digits\n\t\tif (cleanNumber.length < 10) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tportable: false,\n\t\t\t\treason: \"Phone number must be at least 10 digits\",\n\t\t\t};\n\t\t}\n\n\t\t// In a real implementation, you would check with Telnyx's LNP API\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tportable: true,\n\t\t\testimatedPortingDays: 7, // Typical porting timeline\n\t\t\tfastPortEligible: false,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to validate portability\",\n\t\t};\n\t}\n}\n","/**\n * Phone Number Setup & Verification\n *\n * Verifies phone numbers are properly configured in Telnyx and can auto-fix issues.\n */\n\nimport { TELNYX_CONFIG } from \"./client\";\nimport {\n\tgetNumberDetails,\n\tlistOwnedNumbers,\n\ttype NumberFeature,\n\tupdateNumber,\n} from \"./numbers\";\n\nexport type PhoneNumberStatus = {\n\texists: boolean;\n\thasMessagingProfile: boolean;\n\thasConnection: boolean;\n\tcapabilities: {\n\t\tsms: boolean;\n\t\tvoice: boolean;\n\t\tmms: boolean;\n\t};\n\tneedsFix: boolean;\n\tissues: string[];\n};\n\nexport type PhoneNumberFixResult = {\n\tsuccess: boolean;\n\tfixed: boolean;\n\terror?: string;\n\tchanges: string[];\n};\n\n/**\n * Find phone number ID by phone number string\n */\nasync function findPhoneNumberId(\n\tphoneNumber: string,\n): Promise<{ success: boolean; phoneNumberId?: string; error?: string }> {\n\ttry {\n\t\t// Normalize phone number (E.164 format)\n\t\tconst normalized = phoneNumber.replace(/\\D/g, \"\");\n\t\tconst e164 = normalized.startsWith(\"+\")\n\t\t\t? phoneNumber\n\t\t\t: normalized.startsWith(\"1\") && normalized.length === 11\n\t\t\t\t? `+${normalized}`\n\t\t\t\t: `+1${normalized}`;\n\n\t\t// List all owned numbers and find matching one\n\t\tconst result = await listOwnedNumbers({ pageSize: 100 });\n\t\tif (!result.success || !result.data) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Failed to list phone numbers from Telnyx\",\n\t\t\t};\n\t\t}\n\n\t\tconst numbers = Array.isArray(result.data) ? result.data : [result.data];\n\t\tconst matching = numbers.find(\n\t\t\t(num: any) =>\n\t\t\t\tnum.phone_number === e164 ||\n\t\t\t\tnum.phone_number === phoneNumber ||\n\t\t\t\tnum.phone_number?.replace(/\\D/g, \"\") === normalized,\n\t\t);\n\n\t\tif (!matching) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Phone number ${phoneNumber} not found in Telnyx account`,\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tphoneNumberId: matching.id,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to find phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Verify phone number configuration\n */\nexport async function verifyPhoneNumber(\n\tphoneNumber: string,\n): Promise<PhoneNumberStatus> {\n\tconst status: PhoneNumberStatus = {\n\t\texists: false,\n\t\thasMessagingProfile: false,\n\t\thasConnection: false,\n\t\tcapabilities: {\n\t\t\tsms: false,\n\t\t\tvoice: false,\n\t\t\tmms: false,\n\t\t},\n\t\tneedsFix: false,\n\t\tissues: [],\n\t};\n\n\ttry {\n\t\t// Find phone number ID\n\t\tconst findResult = await findPhoneNumberId(phoneNumber);\n\t\tif (!findResult.success || !findResult.phoneNumberId) {\n\t\t\tstatus.issues.push(\n\t\t\t\tfindResult.error || \"Phone number not found in Telnyx\",\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t\treturn status;\n\t\t}\n\n\t\tstatus.exists = true;\n\n\t\t// Get phone number details\n\t\tconst detailsResult = await getNumberDetails(findResult.phoneNumberId);\n\t\tif (!detailsResult.success || !detailsResult.data) {\n\t\t\tstatus.issues.push(\"Failed to retrieve phone number details\");\n\t\t\tstatus.needsFix = true;\n\t\t\treturn status;\n\t\t}\n\n\t\tconst numberData = detailsResult.data as any;\n\n\t\t// Check messaging profile\n\t\tif (numberData.messaging_profile_id) {\n\t\t\tstatus.hasMessagingProfile = true;\n\t\t} else {\n\t\t\tstatus.issues.push(\n\t\t\t\t\"Phone number is not associated with a messaging profile\",\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\t// Check connection\n\t\tif (numberData.connection_id) {\n\t\t\tstatus.hasConnection = true;\n\t\t} else {\n\t\t\tstatus.issues.push(\"Phone number is not associated with a connection\");\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\t// Check capabilities from phone number features\n\t\tconst features = (numberData.features || []) as string[];\n\t\tconst hasFeaturesSms = features.includes(\"sms\");\n\t\tconst hasFeaturesVoice = features.includes(\"voice\");\n\t\tconst hasFeaturesMms = features.includes(\"mms\");\n\n\t\t// Also check messaging settings endpoint for SMS/MMS status\n\t\tlet messagingEnabled = false;\n\t\ttry {\n\t\t\tconst TELNYX_API_KEY = process.env.TELNYX_API_KEY;\n\t\t\tif (TELNYX_API_KEY) {\n\t\t\t\tconst messagingResponse = await fetch(\n\t\t\t\t\t`https://api.telnyx.com/v2/phone_numbers/${findResult.phoneNumberId}/messaging`,\n\t\t\t\t\t{\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\tAuthorization: `Bearer ${TELNYX_API_KEY}`,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tif (messagingResponse.ok) {\n\t\t\t\t\tconst messagingData = await messagingResponse.json();\n\t\t\t\t\tconst messagingFeatures = messagingData?.data?.features;\n\t\t\t\t\tif (\n\t\t\t\t\t\tmessagingFeatures?.sms?.domestic_two_way ||\n\t\t\t\t\t\tmessagingFeatures?.mms?.domestic_two_way\n\t\t\t\t\t) {\n\t\t\t\t\t\tmessagingEnabled = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\t// Ignore errors - fall back to features check\n\t\t}\n\n\t\t// Consider SMS enabled if either features include it OR messaging settings confirm it\n\t\tstatus.capabilities.sms = hasFeaturesSms || messagingEnabled;\n\t\tstatus.capabilities.voice = hasFeaturesVoice;\n\t\tstatus.capabilities.mms = hasFeaturesMms || messagingEnabled;\n\n\t\tif (!status.capabilities.sms) {\n\t\t\tstatus.issues.push(\"Phone number does not have SMS capability\");\n\t\t}\n\t\tif (!status.capabilities.voice) {\n\t\t\tstatus.issues.push(\"Phone number does not have voice capability\");\n\t\t}\n\n\t\treturn status;\n\t} catch (error) {\n\t\tstatus.issues.push(\n\t\t\terror instanceof Error ? error.message : \"Unknown error\",\n\t\t);\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n}\n\n/**\n * Auto-fix phone number configuration\n */\nexport async function fixPhoneNumber(\n\tphoneNumber: string,\n\toptions?: {\n\t\tmessagingProfileId?: string;\n\t\tconnectionId?: string;\n\t},\n): Promise<PhoneNumberFixResult> {\n\tconst changes: string[] = [];\n\n\ttry {\n\t\t// Find phone number ID\n\t\tconst findResult = await findPhoneNumberId(phoneNumber);\n\t\tif (!findResult.success || !findResult.phoneNumberId) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tfixed: false,\n\t\t\t\terror: findResult.error || \"Phone number not found\",\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Get current status\n\t\tconst status = await verifyPhoneNumber(phoneNumber);\n\t\tif (!status.needsFix) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tfixed: false,\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Prepare update parameters\n\t\tconst updateParams: {\n\t\t\tphoneNumberId: string;\n\t\t\tmessagingProfileId?: string;\n\t\t\tconnectionId?: string;\n\t\t} = {\n\t\t\tphoneNumberId: findResult.phoneNumberId,\n\t\t};\n\n\t\t// Fix messaging profile\n\t\tif (!status.hasMessagingProfile) {\n\t\t\tconst messagingProfileId =\n\t\t\t\toptions?.messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\t\t\tif (messagingProfileId) {\n\t\t\t\tupdateParams.messagingProfileId = messagingProfileId;\n\t\t\t\tchanges.push(\n\t\t\t\t\t`Assigned messaging profile ${messagingProfileId} to phone number`,\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tfixed: false,\n\t\t\t\t\terror:\n\t\t\t\t\t\t\"Messaging profile ID is required but not configured. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID.\",\n\t\t\t\t\tchanges: [],\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Fix connection\n\t\tif (!status.hasConnection) {\n\t\t\tconst connectionId = options?.connectionId || TELNYX_CONFIG.connectionId;\n\t\t\tif (connectionId) {\n\t\t\t\tupdateParams.connectionId = connectionId;\n\t\t\t\tchanges.push(`Assigned connection ${connectionId} to phone number`);\n\t\t\t} else {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tfixed: false,\n\t\t\t\t\terror:\n\t\t\t\t\t\t\"Connection ID is required but not configured. Set NEXT_PUBLIC_TELNYX_CONNECTION_ID.\",\n\t\t\t\t\tchanges: [],\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Apply updates if needed\n\t\tif (updateParams.messagingProfileId || updateParams.connectionId) {\n\t\t\tconst updateResult = await updateNumber(updateParams);\n\t\t\tif (!updateResult.success) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tfixed: false,\n\t\t\t\t\terror: updateResult.error || \"Failed to update phone number\",\n\t\t\t\t\tchanges,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tfixed: changes.length > 0,\n\t\t\tchanges,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\tchanges,\n\t\t};\n\t}\n}\n\n/**\n * Verify phone number has SMS capability\n */\nexport async function verifySmsCapability(\n\tphoneNumber: string,\n): Promise<{ hasSms: boolean; error?: string }> {\n\tconst status = await verifyPhoneNumber(phoneNumber);\n\n\tif (!status.exists) {\n\t\treturn {\n\t\t\thasSms: false,\n\t\t\terror: \"Phone number not found in Telnyx\",\n\t\t};\n\t}\n\n\tif (!status.capabilities.sms) {\n\t\treturn {\n\t\t\thasSms: false,\n\t\t\terror: \"Phone number does not have SMS capability\",\n\t\t};\n\t}\n\n\tif (!status.hasMessagingProfile) {\n\t\treturn {\n\t\t\thasSms: false,\n\t\t\terror: \"Phone number is not associated with a messaging profile\",\n\t\t};\n\t}\n\n\treturn { hasSms: true };\n}\n\n/**\n * Verify phone number has voice capability\n */\nexport async function verifyVoiceCapability(\n\tphoneNumber: string,\n): Promise<{ hasVoice: boolean; error?: string }> {\n\tconst status = await verifyPhoneNumber(phoneNumber);\n\n\tif (!status.exists) {\n\t\treturn {\n\t\t\thasVoice: false,\n\t\t\terror: \"Phone number not found in Telnyx\",\n\t\t};\n\t}\n\n\tif (!status.capabilities.voice) {\n\t\treturn {\n\t\t\thasVoice: false,\n\t\t\terror: \"Phone number does not have voice capability\",\n\t\t};\n\t}\n\n\tif (!status.hasConnection) {\n\t\treturn {\n\t\t\thasVoice: false,\n\t\t\terror: \"Phone number is not associated with a connection\",\n\t\t};\n\t}\n\n\treturn { hasVoice: true };\n}\n"],"names":[],"mappings":"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"}