module.exports=[34711,e=>{"use strict";var t=e.i(755535),n=e.i(377233),a=e.i(490003),r=e.i(492991),s=e.i(241970),o=e.i(357699),i=e.i(212454),l=e.i(48717),u=e.i(798301),c=e.i(986366),p=e.i(983537),d=e.i(147475),m=e.i(561930),g=e.i(803747),f=e.i(368557),h=e.i(42037),y=e.i(193695);e.i(432036);var b=e.i(573881),x=e.i(297676),v=e.i(443608);e.i(715051);var z=e.i(511368);let R="Stratos-FMS/1.0 (support@stratos.app)",w=new class{apiKey;baseUrl="https://generativelanguage.googleapis.com/v1beta";defaultModel="gemini-1.5-flash";constructor(){this.apiKey=process.env.GOOGLE_GEMINI_API_KEY||process.env.GOOGLE_API_KEY}async generateContent(e,t={}){if(!this.apiKey)return console.warn("Google Gemini API key not configured"),null;let n=t.model||this.defaultModel;try{let a=`${this.baseUrl}/models/${n}:generateContent?key=${this.apiKey}`,r={contents:[{parts:[{text:e}]}]};t.config&&(r.generationConfig=t.config),t.safetySettings&&(r.safetySettings=t.safetySettings),t.systemInstruction&&(r.systemInstruction={parts:[{text:t.systemInstruction}]});let s=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":R},body:JSON.stringify(r)});if(!s.ok){let e=await s.text();return console.error("Gemini API error:",s.status,e),null}let o=await s.json();if(!o.candidates||0===o.candidates.length)return console.error("No candidates returned from Gemini"),null;let i=o.candidates[0];return{text:i.content?.parts?.[0]?.text||"",finishReason:i.finishReason,safetyRatings:i.safetyRatings,tokenCount:o.usageMetadata?{prompt:o.usageMetadata.promptTokenCount,response:o.usageMetadata.candidatesTokenCount,total:o.usageMetadata.totalTokenCount}:void 0}}catch(e){return console.error("Gemini API error:",e),null}}async chat(e,t,n={}){if(!this.apiKey)return console.warn("Google Gemini API key not configured"),null;let a=n.model||this.defaultModel;try{let r=`${this.baseUrl}/models/${a}:generateContent?key=${this.apiKey}`,s={contents:[...e,{role:"user",parts:[{text:t}]}]};n.config&&(s.generationConfig=n.config),n.systemInstruction&&(s.systemInstruction={parts:[{text:n.systemInstruction}]});let o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":R},body:JSON.stringify(s)});if(!o.ok){let e=await o.text();return console.error("Gemini chat error:",o.status,e),null}let i=await o.json();if(!i.candidates||0===i.candidates.length)return null;let l=i.candidates[0],u=l.content?.parts?.[0]?.text||"",c=[...e,{role:"user",parts:[{text:t}]},{role:"model",parts:[{text:u}]}];return{text:u,finishReason:l.finishReason,safetyRatings:l.safetyRatings,history:c,tokenCount:i.usageMetadata?{prompt:i.usageMetadata.promptTokenCount,response:i.usageMetadata.candidatesTokenCount,total:i.usageMetadata.totalTokenCount}:void 0}}catch(e){return console.error("Gemini chat error:",e),null}}async generateEmbedding(e,t={}){if(!this.apiKey)return console.warn("Google Gemini API key not configured"),null;let n=t.model||"text-embedding-004";try{let a=`${this.baseUrl}/models/${n}:embedContent?key=${this.apiKey}`,r={model:`models/${n}`,content:{parts:[{text:e}]}};t.taskType&&(r.taskType=t.taskType);let s=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":R},body:JSON.stringify(r)});if(!s.ok)return console.error("Gemini embedding error:",s.status),null;let o=await s.json();return{embedding:o.embedding?.values||[],dimensions:o.embedding?.values?.length||0}}catch(e){return console.error("Gemini embedding error:",e),null}}async batchEmbeddings(e,t={}){if(!this.apiKey)return console.warn("Google Gemini API key not configured"),null;let n=t.model||"text-embedding-004";try{let a=`${this.baseUrl}/models/${n}:batchEmbedContents?key=${this.apiKey}`,r=e.map(e=>({model:`models/${n}`,content:{parts:[{text:e}]},taskType:t.taskType})),s=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":R},body:JSON.stringify({requests:r})});if(!s.ok)return console.error("Gemini batch embedding error:",s.status),null;return((await s.json()).embeddings||[]).map(e=>({embedding:e.values||[],dimensions:e.values?.length||0}))}catch(e){return console.error("Gemini batch embedding error:",e),null}}async generateJobDescription(e){let t=`You are a professional field service technician assistant.
Generate clear, professional job descriptions for service tickets.
Include relevant technical details, safety considerations, and expected work scope.
Keep descriptions concise but comprehensive.`,n=`Generate a professional job description for:
Service Type: ${e.serviceType}
${e.equipment?`Equipment: ${e.equipment}`:""}
${e.symptoms?`Symptoms/Issues: ${e.symptoms}`:""}
${e.customerNotes?`Customer Notes: ${e.customerNotes}`:""}

Provide a clear, professional description that technicians can use.`,a=await this.generateContent(n,{systemInstruction:t,config:{temperature:.7,maxOutputTokens:500}});return a?.text||null}async analyzeEstimate(e){let t=`You are an expert in field service pricing and estimates.
Analyze estimates for completeness, accuracy, and competitiveness.
Provide actionable feedback and suggestions.`,n=e.lineItems.map(e=>`- ${e.name}: $${e.price} x ${e.quantity}`).join("\n"),a=`Analyze this service estimate:

Description: ${e.description}

Line Items:
${n}

${e.laborHours?`Labor Hours: ${e.laborHours}`:""}
Total Amount: $${e.totalAmount}

Provide:
1. Brief analysis of the estimate
2. 3-5 specific suggestions for improvement
3. Assessment of competitiveness (low/fair/high pricing)

Format as JSON with keys: analysis, suggestions (array), competitiveness`,r=await this.generateContent(a,{systemInstruction:t,config:{temperature:.5,maxOutputTokens:800}});if(!r?.text)return null;try{let e=r.text.match(/\{[\s\S]*\}/);if(e)return JSON.parse(e[0])}catch{return{analysis:r.text,suggestions:[],competitiveness:"unknown"}}return null}async draftCustomerEmail(e){let t=`You are a professional customer service representative for a field service company.
Write friendly, professional emails that maintain good customer relationships.
Keep emails concise and action-oriented.`,n=`Draft an email for: ${{appointment_confirmation:"Confirm an upcoming service appointment",follow_up:"Follow up after a completed service",estimate_sent:"Notify that an estimate has been sent",invoice_reminder:"Send a friendly reminder about an outstanding invoice",thank_you:"Thank the customer for their business"}[e.purpose]}

Customer Name: ${e.customerName}
Company Name: ${e.companyName}
${e.jobDetails?`Job Details: ${e.jobDetails}`:""}
${e.appointmentDate?`Appointment Date: ${e.appointmentDate}`:""}
${e.amount?`Amount: $${e.amount}`:""}

Format as JSON with keys: subject, body`,a=await this.generateContent(n,{systemInstruction:t,config:{temperature:.7,maxOutputTokens:600}});if(!a?.text)return null;try{let e=a.text.match(/\{[\s\S]*\}/);if(e)return JSON.parse(e[0])}catch{let e=a.text.split("\n");return{subject:e[0]?.replace(/^Subject:\s*/i,"")||"Service Update",body:e.slice(1).join("\n").trim()}}return null}async summarizeText(e,t={}){let n=t.format||"bullets",a=t.maxLength||200,r=`Summarize the following text in ${"bullets"===n?"bullet points":"a concise paragraph"}. Keep it under ${a} words:

${e}`,s=await this.generateContent(r,{config:{temperature:.3,maxOutputTokens:500}});return s?.text||null}async extractStructuredData(e,t){let n=t.fields.map(e=>`- ${e.name} (${e.type}): ${e.description}`).join("\n"),a=`Extract the following fields from the text and return as JSON:

Fields to extract:
${n}

Text:
${e}

Return only valid JSON with the specified fields.`,r=await this.generateContent(a,{config:{temperature:.1,maxOutputTokens:500}});if(!r?.text)return null;try{let e=r.text.match(/\{[\s\S]*\}/);if(e)return JSON.parse(e[0])}catch{console.error("Failed to parse extracted data")}return null}async generateServiceRecommendations(e){let t=e.services.map(e=>`- ${e.date}: ${e.type}${e.equipment?` (${e.equipment})`:""}`).join("\n"),n=`Based on this customer's service history, recommend future services:

Service History:
${t}

${e.equipmentAge?`Equipment Age: ${e.equipmentAge} years`:""}
${e.lastMaintenanceDate?`Last Maintenance: ${e.lastMaintenanceDate}`:""}

Provide 3-5 specific service recommendations as a JSON array of strings.`,a=await this.generateContent(n,{config:{temperature:.6,maxOutputTokens:400}});if(!a?.text)return null;try{let e=a.text.match(/\[[\s\S]*\]/);if(e)return JSON.parse(e[0])}catch{return a.text.split("\n").filter(e=>e.trim().startsWith("-")||e.match(/^\d+\./)).map(e=>e.replace(/^[-\d.]+\s*/,"").trim()).filter(e=>e.length>0)}return null}async countTokens(e,t){if(!this.apiKey)return null;let n=t||this.defaultModel;try{let t=`${this.baseUrl}/models/${n}:countTokens?key=${this.apiKey}`,a=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":R},body:JSON.stringify({contents:[{parts:[{text:e}]}]})});if(!a.ok)return null;return(await a.json()).totalTokens||null}catch{return null}}async listModels(){if(!this.apiKey)return null;try{let e=`${this.baseUrl}/models?key=${this.apiKey}`,t=await fetch(e,{headers:{"User-Agent":R}});if(!t.ok)return null;return((await t.json()).models||[]).map(e=>({name:e.name,displayName:e.displayName,description:e.description}))}catch{return null}}isConfigured(){return!!this.apiKey}},N=v.z.enum(["gemini-1.5-pro","gemini-1.5-flash","gemini-1.5-flash-8b","gemini-1.0-pro"]).optional(),j=v.z.object({temperature:v.z.number().min(0).max(2).optional(),topK:v.z.number().optional(),topP:v.z.number().optional(),maxOutputTokens:v.z.number().optional(),stopSequences:v.z.array(v.z.string()).optional()}).optional(),k=v.z.object({action:v.z.literal("generate"),prompt:v.z.string().min(1),model:N,config:j,systemInstruction:v.z.string().optional()}),T=v.z.object({role:v.z.enum(["user","model"]),parts:v.z.array(v.z.object({text:v.z.string()}))}),C=v.z.object({action:v.z.literal("chat"),messages:v.z.array(T),newMessage:v.z.string().min(1),model:N,config:j,systemInstruction:v.z.string().optional()}),$=v.z.object({action:v.z.literal("embed"),text:v.z.string().min(1),model:v.z.string().optional(),taskType:v.z.string().optional()}),E=v.z.object({action:v.z.literal("batch-embed"),texts:v.z.array(v.z.string().min(1)).min(1).max(100),model:v.z.string().optional(),taskType:v.z.string().optional()}),A=v.z.object({action:v.z.literal("job-description"),serviceType:v.z.string(),equipment:v.z.string().optional(),symptoms:v.z.string().optional(),customerNotes:v.z.string().optional()}),S=v.z.object({action:v.z.literal("analyze-estimate"),description:v.z.string(),lineItems:v.z.array(v.z.object({name:v.z.string(),price:v.z.number(),quantity:v.z.number()})),laborHours:v.z.number().optional(),totalAmount:v.z.number()}),O=v.z.object({action:v.z.literal("draft-email"),purpose:v.z.enum(["appointment_confirmation","follow_up","estimate_sent","invoice_reminder","thank_you"]),customerName:v.z.string(),companyName:v.z.string(),jobDetails:v.z.string().optional(),appointmentDate:v.z.string().optional(),amount:v.z.number().optional()}),I=v.z.object({action:v.z.literal("summarize"),text:v.z.string().min(1),maxLength:v.z.number().optional(),format:v.z.enum(["bullets","paragraph"]).optional()}),P=v.z.object({action:v.z.literal("extract"),text:v.z.string().min(1),fields:v.z.array(v.z.object({name:v.z.string(),type:v.z.string(),description:v.z.string()}))}),M=v.z.object({action:v.z.literal("recommendations"),services:v.z.array(v.z.object({type:v.z.string(),date:v.z.string(),equipment:v.z.string().optional()})),equipmentAge:v.z.number().optional(),lastMaintenanceDate:v.z.string().optional()}),_=v.z.object({action:v.z.literal("count-tokens"),text:v.z.string(),model:N}),D=v.z.discriminatedUnion("action",[k,C,$,E,A,S,O,I,P,M,_]);async function G(e){try{let t=await (0,z.createClient)(),{data:{user:n}}=await t.auth.getUser();if(!n)return x.NextResponse.json({error:"Unauthorized"},{status:401});if(!w.isConfigured())return x.NextResponse.json({error:"Gemini service is not configured. Set GOOGLE_GEMINI_API_KEY or GOOGLE_API_KEY environment variable."},{status:503});let a=await e.json(),r=D.parse(a);switch(r.action){case"generate":{let e=await w.generateContent(r.prompt,{model:r.model,config:r.config,systemInstruction:r.systemInstruction});if(!e)return x.NextResponse.json({error:"Failed to generate content"},{status:500});return x.NextResponse.json({success:!0,data:e})}case"chat":{let e=await w.chat(r.messages,r.newMessage,{model:r.model,config:r.config,systemInstruction:r.systemInstruction});if(!e)return x.NextResponse.json({error:"Failed to process chat"},{status:500});return x.NextResponse.json({success:!0,data:e})}case"embed":{let e=await w.generateEmbedding(r.text,{model:r.model,taskType:r.taskType});if(!e)return x.NextResponse.json({error:"Failed to generate embedding"},{status:500});return x.NextResponse.json({success:!0,data:e})}case"batch-embed":{let e=await w.batchEmbeddings(r.texts,{model:r.model,taskType:r.taskType});if(!e)return x.NextResponse.json({error:"Failed to generate batch embeddings"},{status:500});return x.NextResponse.json({success:!0,data:{embeddings:e,count:e.length}})}case"job-description":{let e=await w.generateJobDescription({serviceType:r.serviceType,equipment:r.equipment,symptoms:r.symptoms,customerNotes:r.customerNotes});if(!e)return x.NextResponse.json({error:"Failed to generate job description"},{status:500});return x.NextResponse.json({success:!0,data:{description:e}})}case"analyze-estimate":{let e=await w.analyzeEstimate({description:r.description,lineItems:r.lineItems,laborHours:r.laborHours,totalAmount:r.totalAmount});if(!e)return x.NextResponse.json({error:"Failed to analyze estimate"},{status:500});return x.NextResponse.json({success:!0,data:e})}case"draft-email":{let e=await w.draftCustomerEmail({purpose:r.purpose,customerName:r.customerName,companyName:r.companyName,jobDetails:r.jobDetails,appointmentDate:r.appointmentDate,amount:r.amount});if(!e)return x.NextResponse.json({error:"Failed to draft email"},{status:500});return x.NextResponse.json({success:!0,data:e})}case"summarize":{let e=await w.summarizeText(r.text,{maxLength:r.maxLength,format:r.format});if(!e)return x.NextResponse.json({error:"Failed to summarize text"},{status:500});return x.NextResponse.json({success:!0,data:{summary:e}})}case"extract":{let e=await w.extractStructuredData(r.text,{fields:r.fields});if(!e)return x.NextResponse.json({error:"Failed to extract data"},{status:500});return x.NextResponse.json({success:!0,data:e})}case"recommendations":{let e=await w.generateServiceRecommendations({services:r.services,equipmentAge:r.equipmentAge,lastMaintenanceDate:r.lastMaintenanceDate});if(!e)return x.NextResponse.json({error:"Failed to generate recommendations"},{status:500});return x.NextResponse.json({success:!0,data:{recommendations:e}})}case"count-tokens":{let e=await w.countTokens(r.text,r.model);if(null===e)return x.NextResponse.json({error:"Failed to count tokens"},{status:500});return x.NextResponse.json({success:!0,data:{tokenCount:e}})}default:return x.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){if(console.error("Gemini API error:",e),e instanceof v.z.ZodError)return x.NextResponse.json({error:"Invalid request data",details:e.errors},{status:400});return x.NextResponse.json({error:"Failed to process Gemini request",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}e.s(["POST",()=>G],379999);var q=e.i(379999);let U=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/gemini/route",pathname:"/api/gemini",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/gemini/route.ts",nextConfigOutput:"",userland:q}),{workAsyncStorage:K,workUnitAsyncStorage:F,serverHooks:H}=U;function J(){return(0,a.patchFetch)({workAsyncStorage:K,workUnitAsyncStorage:F})}async function L(e,t,a){U.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/gemini/route";x=x.replace(/\/index$/,"")||"/";let v=await U.prepare(e,t,{srcPage:x,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:z,params:R,nextConfig:w,parsedUrl:N,isDraftMode:j,prerenderManifest:k,routerServerContext:T,isOnDemandRevalidate:C,revalidateOnlyGenerated:$,resolvedPathname:E,clientReferenceManifest:A,serverActionsManifest:S}=v,O=(0,l.normalizeAppPath)(x),I=!!(k.dynamicRoutes[O]||k.routes[E]),P=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,N,!1):t.end("This page could not be found"),null);if(I&&!j){let e=!!k.routes[E],t=k.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await P();throw new y.NoFallbackError}}let M=null;!I||U.isDev||j||(M="/index"===(M=E)?"/":M);let _=!0===U.isDev||!I,D=I&&!_;S&&A&&(0,o.setReferenceManifestsSingleton)({page:x,clientReferenceManifest:A,serverActionsManifest:S,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:S})});let G=e.method||"GET",q=(0,s.getTracer)(),K=q.getActiveScopeSpan(),F={params:R,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:_,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,a)=>U.onRequestError(e,t,a,T)},sharedContext:{buildId:z}},H=new u.NodeNextRequest(e),J=new u.NodeNextResponse(t),L=c.NextRequestAdapter.fromNodeNextRequest(H,(0,c.signalFromNodeResponse)(t));try{let o=async e=>U.handle(L,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=q.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${G} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${G} ${x}`)}),i=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var s,l;let u=async({previousCacheEntry:n})=>{try{if(!i&&C&&$&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(r);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=F.renderOpts.collectedTags;if(!I)return await (0,m.sendResponse)(H,J,s,F.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[h.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,a=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==n?void 0:n.isStale)&&await U.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:C})},T),t}},c=await U.handleResponse({req:e,nextConfig:w,cacheKey:M,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:$,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:i});if(!I)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",C?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),j&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&I||p.delete(h.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,f.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)(H,J,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};K?await l(K):await q.withPropagatedContext(e.headers,()=>q.trace(p.BaseServerSpan.handleRequest,{spanName:`${G} ${x}`,kind:s.SpanKind.SERVER,attributes:{"http.method":G,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await U.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:C})}),I)throw t;return await (0,m.sendResponse)(H,J,new Response(null,{status:500})),null}}e.s(["handler",()=>L,"patchFetch",()=>J,"routeModule",()=>U,"serverHooks",()=>H,"workAsyncStorage",()=>K,"workUnitAsyncStorage",()=>F],34711)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_615184d9.js.map