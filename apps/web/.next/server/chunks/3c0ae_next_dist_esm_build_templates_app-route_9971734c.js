module.exports=[406183,e=>{"use strict";var t=e.i(755535),n=e.i(377233),a=e.i(490003),i=e.i(492991),r=e.i(241970),s=e.i(357699),o=e.i(212454),d=e.i(48717),l=e.i(798301),c=e.i(986366),u=e.i(983537),p=e.i(147475),g=e.i(561930),h=e.i(803747),f=e.i(368557),m=e.i(42037),x=e.i(193695);e.i(432036);var T=e.i(573881),v=e.i(297676),w=e.i(443608);e.i(715051);var R=e.i(511368);let E=w.z.object({status:w.z.enum(["OK","NOT_FOUND","ZERO_RESULTS","MAX_ROUTE_LENGTH_EXCEEDED"]),distance:w.z.object({value:w.z.number(),text:w.z.string()}).optional(),duration:w.z.object({value:w.z.number(),text:w.z.string()}).optional(),durationInTraffic:w.z.object({value:w.z.number(),text:w.z.string()}).optional(),fare:w.z.object({currency:w.z.string(),value:w.z.number(),text:w.z.string()}).optional()}),I=w.z.object({elements:w.z.array(E)});w.z.object({status:w.z.enum(["OK","INVALID_REQUEST","MAX_ELEMENTS_EXCEEDED","MAX_DIMENSIONS_EXCEEDED","OVER_DAILY_LIMIT","OVER_QUERY_LIMIT","REQUEST_DENIED","UNKNOWN_ERROR"]),originAddresses:w.z.array(w.z.string()),destinationAddresses:w.z.array(w.z.string()),rows:w.z.array(I)});class b{apiKey;cache=new Map;cacheTTL=9e5;constructor(){this.apiKey=process.env.GOOGLE_API_KEY||process.env.GOOGLE_MAPS_API_KEY}formatLocation(e){if(e.placeId)return`place_id:${e.placeId}`;if(void 0!==e.latitude&&void 0!==e.longitude)return`${e.latitude},${e.longitude}`;if(e.address)return e.address;throw Error("Location must have address, coordinates, or placeId")}generateCacheKey(e,t,n={}){let a=e.map(e=>this.formatLocation(e)).join("|"),i=t.map(e=>this.formatLocation(e)).join("|");return`dm:${a}:${i}:${n.mode||"driving"}:${n.trafficModel||""}`}async getDistanceMatrix(e,t,n={}){if(!this.apiKey)return console.warn("Google Distance Matrix API key not configured"),null;if(0===e.length||0===t.length)return null;e.length*t.length>100&&console.warn("Distance matrix request exceeds 100 elements. Consider batching.");let a=this.generateCacheKey(e,t,n),i=this.cache.get(a);if(i&&Date.now()-i.timestamp<this.cacheTTL)return i.data;try{let i=new URLSearchParams({key:this.apiKey,origins:e.map(e=>this.formatLocation(e)).join("|"),destinations:t.map(e=>this.formatLocation(e)).join("|")});if(n.mode&&i.set("mode",n.mode),n.departureTime){let e="now"===n.departureTime?Math.floor(Date.now()/1e3):Math.floor(n.departureTime.getTime()/1e3);i.set("departure_time",String(e))}n.arrivalTime&&i.set("arrival_time",String(Math.floor(n.arrivalTime.getTime()/1e3))),n.trafficModel&&i.set("traffic_model",n.trafficModel);let r=[];n.avoidTolls&&r.push("tolls"),n.avoidHighways&&r.push("highways"),n.avoidFerries&&r.push("ferries"),n.avoidIndoor&&r.push("indoor"),r.length>0&&i.set("avoid",r.join("|")),n.units&&i.set("units",n.units),n.transitMode&&n.transitMode.length>0&&i.set("transit_mode",n.transitMode.join("|")),n.transitRoutingPreference&&i.set("transit_routing_preference",n.transitRoutingPreference),n.region&&i.set("region",n.region),n.language&&i.set("language",n.language);let s=`https://maps.googleapis.com/maps/api/distancematrix/json?${i.toString()}`,o=await fetch(s,{headers:{"User-Agent":"Stratos-FMS/1.0 (support@stratos.app)"}});if(!o.ok)return console.error("Distance Matrix API error:",o.status),null;let d=await o.json();if("OK"!==d.status)return console.error("Distance Matrix API status:",d.status,d.error_message),null;let l=[];for(let e=0;e<d.rows.length;e++){let t=[];for(let n=0;n<d.rows[e].elements.length;n++){let a=d.rows[e].elements[n];t.push({originIndex:e,destinationIndex:n,originAddress:d.origin_addresses[e],destinationAddress:d.destination_addresses[n],distanceMeters:a.distance?.value||0,distanceText:a.distance?.text||"",durationSeconds:a.duration?.value||0,durationText:a.duration?.text||"",durationInTrafficSeconds:a.duration_in_traffic?.value,durationInTrafficText:a.duration_in_traffic?.text,status:a.status})}l.push(t)}let c={origins:d.origin_addresses,destinations:d.destination_addresses,matrix:l,totalElements:e.length*t.length,fetchedAt:new Date};return this.cache.set(a,{data:c,timestamp:Date.now()}),c}catch(e){return console.error("Distance Matrix API error:",e),null}}async getDistance(e,t,n={}){let a=await this.getDistanceMatrix([e],[t],n);return a&&0!==a.matrix.length&&0!==a.matrix[0].length?a.matrix[0][0]:null}async getTravelTime(e,t,n="now"){let a=await this.getDistance(e,t,{mode:"driving",departureTime:n,trafficModel:"best_guess"});return a&&"OK"===a.status?{seconds:a.durationSeconds,text:a.durationText,withTrafficSeconds:a.durationInTrafficSeconds,withTrafficText:a.durationInTrafficText}:null}async findNearestDestination(e,t,n={}){if(0===t.length)return null;let a=await this.getDistanceMatrix([e],t,n);if(!a||0===a.matrix.length)return null;let i=a.matrix[0],r=null;for(let e of i)"OK"===e.status&&(!r||e.durationSeconds<r.durationSeconds)&&(r={destinationIndex:e.destinationIndex,destinationAddress:e.destinationAddress,distanceMeters:e.distanceMeters,distanceText:e.distanceText,durationSeconds:e.durationSeconds,durationText:e.durationText,durationInTrafficSeconds:e.durationInTrafficSeconds});return r}async findNearestOrigin(e,t,n={}){if(0===e.length)return null;let a=await this.getDistanceMatrix(e,[t],n);if(!a||0===a.matrix.length)return null;let i=-1,r=1/0,s=0,o="";for(let e=0;e<a.matrix.length;e++){let t=a.matrix[e][0];if("OK"!==t.status)continue;let n=t.durationInTrafficSeconds||t.durationSeconds;n<r&&(i=e,r=n,s=t.distanceMeters,o=t.originAddress)}return -1===i?null:{originIndex:i,originAddress:o,distanceMeters:s,durationSeconds:r}}async calculateETA(e,t,n={}){let a=await this.getDistance(e,t,{...n,mode:n.mode||"driving",departureTime:"now",trafficModel:"best_guess"});if(!a||"OK"!==a.status)return null;let i=a.durationInTrafficSeconds||a.durationSeconds;return{eta:new Date(Date.now()+1e3*i),durationSeconds:i,durationText:a.durationInTrafficText||a.durationText,distanceText:a.distanceText}}async rankDestinationsByTime(e,t,n={}){if(0===t.length)return[];let a=await this.getDistanceMatrix([e],t,n);return a&&0!==a.matrix.length?a.matrix[0].filter(e=>"OK"===e.status).map(e=>({index:e.destinationIndex,address:e.destinationAddress,durationSeconds:e.durationInTrafficSeconds||e.durationSeconds,distanceMeters:e.distanceMeters})).sort((e,t)=>e.durationSeconds-t.durationSeconds):[]}async getTechnicianJobMatrix(e,t,n={}){if(0===e.length||0===t.length)return null;let a=await this.getDistanceMatrix(e.map(e=>e.location),t.map(e=>e.location),{...n,mode:n.mode||"driving",departureTime:n.departureTime||"now"});if(!a)return null;let i=[],r=[];for(let e of a.matrix)i.push(e.map(e=>e.distanceMeters)),r.push(e.map(e=>e.durationInTrafficSeconds||e.durationSeconds));return{technicianIds:e.map(e=>e.id),jobIds:t.map(e=>e.id),matrix:i,durations:r}}isConfigured(){return!!this.apiKey}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,ttlMs:this.cacheTTL}}}let z=new b,S=w.z.object({address:w.z.string().optional(),latitude:w.z.number().optional(),longitude:w.z.number().optional(),placeId:w.z.string().optional()}).refine(e=>e.address||void 0!==e.latitude&&void 0!==e.longitude||e.placeId,{message:"Location must have address, coordinates, or placeId"}),y=w.z.object({mode:w.z.enum(["driving","walking","bicycling","transit"]).optional(),departureTime:w.z.string().optional(),arrivalTime:w.z.string().optional(),trafficModel:w.z.enum(["best_guess","pessimistic","optimistic"]).optional(),avoidTolls:w.z.boolean().optional(),avoidHighways:w.z.boolean().optional(),avoidFerries:w.z.boolean().optional(),units:w.z.enum(["metric","imperial"]).optional()}).optional(),_=w.z.object({action:w.z.literal("matrix"),origins:w.z.array(S).min(1).max(25),destinations:w.z.array(S).min(1).max(25),options:y}),M=w.z.object({action:w.z.literal("single"),origin:S,destination:S,options:y}),j=w.z.object({action:w.z.literal("nearest_destination"),origin:S,destinations:w.z.array(S).min(1).max(25),options:y}),A=w.z.object({action:w.z.literal("nearest_origin"),origins:w.z.array(S).min(1).max(25),destination:S,options:y}),N=w.z.object({action:w.z.literal("eta"),origin:S,destination:S,options:y}),D=w.z.object({action:w.z.literal("rank"),origin:S,destinations:w.z.array(S).min(1).max(25),options:y}),O=w.z.object({action:w.z.literal("assignment"),technicians:w.z.array(w.z.object({id:w.z.string(),location:S})).min(1).max(25),jobs:w.z.array(w.z.object({id:w.z.string(),location:S})).min(1).max(25),options:y}),C=w.z.discriminatedUnion("action",[_,M,j,A,N,D,O]);function P(e){if(!e)return{};let t={mode:e.mode,trafficModel:e.trafficModel,avoidTolls:e.avoidTolls,avoidHighways:e.avoidHighways,avoidFerries:e.avoidFerries,units:e.units};return e.departureTime&&(t.departureTime="now"===e.departureTime?"now":new Date(e.departureTime)),e.arrivalTime&&(t.arrivalTime=new Date(e.arrivalTime)),t}async function U(e){try{let t=await (0,R.createClient)(),{data:{user:n}}=await t.auth.getUser();if(!n)return v.NextResponse.json({error:"Unauthorized"},{status:401});if(!z.isConfigured())return v.NextResponse.json({error:"Distance Matrix service is not configured. Set GOOGLE_API_KEY environment variable."},{status:503});let a=await e.json(),i=C.parse(a);switch(i.action){case"matrix":{let e=await z.getDistanceMatrix(i.origins,i.destinations,P(i.options));if(!e)return v.NextResponse.json({error:"Failed to calculate distance matrix"},{status:500});return v.NextResponse.json({success:!0,data:{...e,fetchedAt:e.fetchedAt.toISOString()}})}case"single":{let e=await z.getDistance(i.origin,i.destination,P(i.options));if(!e)return v.NextResponse.json({error:"Failed to calculate distance"},{status:500});return v.NextResponse.json({success:!0,data:e})}case"nearest_destination":{let e=await z.findNearestDestination(i.origin,i.destinations,P(i.options));if(!e)return v.NextResponse.json({error:"No reachable destinations found"},{status:404});return v.NextResponse.json({success:!0,data:e})}case"nearest_origin":{let e=await z.findNearestOrigin(i.origins,i.destination,P(i.options));if(!e)return v.NextResponse.json({error:"No reachable origins found"},{status:404});return v.NextResponse.json({success:!0,data:e})}case"eta":{let e=await z.calculateETA(i.origin,i.destination,P(i.options));if(!e)return v.NextResponse.json({error:"Failed to calculate ETA"},{status:500});return v.NextResponse.json({success:!0,data:{...e,eta:e.eta.toISOString()}})}case"rank":{let e=await z.rankDestinationsByTime(i.origin,i.destinations,P(i.options));return v.NextResponse.json({success:!0,data:{ranked:e,count:e.length}})}case"assignment":{let e=await z.getTechnicianJobMatrix(i.technicians.map(e=>({id:e.id,location:e.location})),i.jobs.map(e=>({id:e.id,location:e.location})),P(i.options));if(!e)return v.NextResponse.json({error:"Failed to calculate assignment matrix"},{status:500});let t=[],n=new Set,a=new Set,r=[];for(let t=0;t<e.durations.length;t++)for(let n=0;n<e.durations[t].length;n++)r.push({techIdx:t,jobIdx:n,duration:e.durations[t][n]});for(let i of(r.sort((e,t)=>e.duration-t.duration),r))a.has(i.techIdx)||n.has(i.jobIdx)||(t.push({technicianId:e.technicianIds[i.techIdx],jobId:e.jobIds[i.jobIdx],durationSeconds:i.duration}),a.add(i.techIdx),n.add(i.jobIdx));return v.NextResponse.json({success:!0,data:{matrix:e,suggestedAssignments:t,unassignedJobs:e.jobIds.filter((e,t)=>!n.has(t)),unassignedTechnicians:e.technicianIds.filter((e,t)=>!a.has(t))}})}default:return v.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){if(console.error("Distance Matrix API error:",e),e instanceof w.z.ZodError)return v.NextResponse.json({error:"Invalid request data",details:e.errors},{status:400});return v.NextResponse.json({error:"Failed to process distance request",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}e.s(["POST",()=>U],157267);var K=e.i(157267);let L=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/distance/route",pathname:"/api/distance",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/distance/route.ts",nextConfigOutput:"",userland:K}),{workAsyncStorage:k,workUnitAsyncStorage:H,serverHooks:F}=L;function q(){return(0,a.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:H})}async function $(e,t,a){L.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/distance/route";v=v.replace(/\/index$/,"")||"/";let w=await L.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:E,nextConfig:I,parsedUrl:b,isDraftMode:z,prerenderManifest:S,routerServerContext:y,isOnDemandRevalidate:_,revalidateOnlyGenerated:M,resolvedPathname:j,clientReferenceManifest:A,serverActionsManifest:N}=w,D=(0,d.normalizeAppPath)(v),O=!!(S.dynamicRoutes[D]||S.routes[j]),C=async()=>((null==y?void 0:y.render404)?await y.render404(e,t,b,!1):t.end("This page could not be found"),null);if(O&&!z){let e=!!S.routes[j],t=S.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await C();throw new x.NoFallbackError}}let P=null;!O||L.isDev||z||(P="/index"===(P=j)?"/":P);let U=!0===L.isDev||!O,K=O&&!U;N&&A&&(0,s.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:A,serverActionsManifest:N,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:N})});let k=e.method||"GET",H=(0,r.getTracer)(),F=H.getActiveScopeSpan(),q={params:E,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,a)=>L.onRequestError(e,t,a,y)},sharedContext:{buildId:R}},$=new l.NodeNextRequest(e),G=new l.NodeNextResponse(t),X=c.NextRequestAdapter.fromNodeNextRequest($,(0,c.signalFromNodeResponse)(t));try{let s=async e=>L.handle(X,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=H.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${k} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${v}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var r,d;let l=async({previousCacheEntry:n})=>{try{if(!o&&_&&M&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await s(i);e.fetchMetrics=q.renderOpts.fetchMetrics;let d=q.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let l=q.renderOpts.collectedTags;if(!O)return await (0,g.sendResponse)($,G,r,q.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(r.headers);l&&(t[m.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,a=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:T.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==n?void 0:n.isStale)&&await L.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:K,isOnDemandRevalidate:_})},y),t}},c=await L.handleResponse({req:e,nextConfig:I,cacheKey:P,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:_,revalidateOnlyGenerated:M,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:o});if(!O)return null;if((null==c||null==(r=c.value)?void 0:r.kind)!==T.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",_?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),z&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&O||u.delete(m.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,f.getCacheControlHeader)(c.cacheControl)),await (0,g.sendResponse)($,G,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};F?await d(F):await H.withPropagatedContext(e.headers,()=>H.trace(u.BaseServerSpan.handleRequest,{spanName:`${k} ${v}`,kind:r.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},d))}catch(t){if(t instanceof x.NoFallbackError||await L.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:K,isOnDemandRevalidate:_})}),O)throw t;return await (0,g.sendResponse)($,G,new Response(null,{status:500})),null}}e.s(["handler",()=>$,"patchFetch",()=>q,"routeModule",()=>L,"serverHooks",()=>F,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>H],406183)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_9971734c.js.map