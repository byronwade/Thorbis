module.exports=[947742,e=>{"use strict";var t=e.i(755535),a=e.i(377233),r=e.i(490003),i=e.i(492991),n=e.i(241970),o=e.i(357699),s=e.i(212454),l=e.i(48717),d=e.i(798301),c=e.i(986366),u=e.i(983537),_=e.i(147475),p=e.i(561930),m=e.i(803747),h=e.i(368557),g=e.i(42037),v=e.i(193695);e.i(432036);var f=e.i(573881),b=e.i(297676),w=e.i(273568);async function y(e){let t=e.headers.get("authorization"),a=process.env.CRON_SECRET;if(!a)return b.NextResponse.json({error:"Cron secret not configured"},{status:500});if(t!==`Bearer ${a}`)return b.NextResponse.json({error:"Unauthorized"},{status:401});try{let e=(0,w.createServiceSupabaseClient)(),t=[],{data:a,error:r}=await e.from("companies").select("id").is("deleted_at",null);if(r||!a)return b.NextResponse.json({error:"Failed to fetch companies",details:r?.message},{status:500});for(let r of a)try{let a=await R(e,r.id),i=await M(e,r.id),n=await C(e,r.id);t.push({companyId:r.id,dispatchProcessed:a,pricebookItemsProcessed:i,customersProcessed:n,success:!0})}catch(a){let e=a instanceof Error?a.message:"Unknown error";t.push({companyId:r.id,dispatchProcessed:!1,pricebookItemsProcessed:0,customersProcessed:0,success:!1,error:e})}let i=t.reduce((e,t)=>e+t.pricebookItemsProcessed,0),n=t.reduce((e,t)=>e+t.customersProcessed,0);return b.NextResponse.json({success:!0,totalPricebookItemsProcessed:i,totalCustomersProcessed:n,companiesProcessed:a.length,results:t})}catch(t){let e=t instanceof Error?t.message:"Unknown error";return b.NextResponse.json({error:"Failed",details:e},{status:500})}}async function R(e,t){let a=new Date().toISOString().split("T")[0],r=`${a}T00:00:00`,i=`${a}T23:59:59`,{data:n}=await e.from("appointments").select(`
			id, status, scheduled_start, scheduled_end, actual_start, actual_end,
			drive_time_minutes, drive_distance_miles, assigned_to,
			job:jobs(id, total_amount, priority)
		`).eq("company_id",t).gte("scheduled_start",r).lte("scheduled_start",i).is("deleted_at",null),o=n||[],s=o.length;if(0===s)return!1;let{data:l}=await e.from("users").select("id").eq("company_id",t).eq("role","technician").is("deleted_at",null),d=l?.length??0,c=8*d,u=0,_=0,p=0,m=0,h=0,g=0,v=0,f=0,b=0;for(let e of o){if(e.scheduled_start&&e.scheduled_end){let t=new Date(e.scheduled_start);u+=(new Date(e.scheduled_end).getTime()-t.getTime())/6e4}if(_+=e.drive_time_minutes??0,p+=e.drive_distance_miles??0,e.actual_start&&e.scheduled_start){let t=new Date(e.scheduled_start),a=(new Date(e.actual_start).getTime()-t.getTime())/6e4;a<=0?(g++,m++):a<=15?m++:h++}if("completed"===e.status){if(e.actual_end&&e.scheduled_end){let t=new Date(e.scheduled_end);new Date(e.actual_end)<=t?v++:f++}}else"rescheduled"===e.status&&b++}let{data:w}=await e.from("time_entries").select("duration_minutes, is_billable").eq("company_id",t).gte("start_time",r).lte("start_time",i).is("deleted_at",null),y=w?.filter(e=>e.is_billable)?.reduce((e,t)=>e+(t.duration_minutes??0),0)??0,R=u/60,M=y/60,C=s>1?_/(s-1):0,E=s>1?p/(s-1):0,S=u+_,T=S>0?_/S*100:0,x=s>0?m/s*100:0,j=s>0?g/s*100:0,k=s>0?h/s*100:0,D=s>0?b/s*100:0,I=d>0?s/d:0,O=o.reduce((e,t)=>{let a=t.job;return e+(a?.total_amount??0)},0)/100,P=p>0?O/p:0,A=d>0?O/d:0;return await e.from("analytics_dispatch_efficiency").upsert({company_id:t,date:a,total_available_hours:Math.round(100*c)/100,total_scheduled_hours:Math.round(100*R)/100,total_billable_hours:Math.round(100*M)/100,schedule_fill_rate:Math.round(100*(c>0?R/c*100:0))/100,utilization_rate:Math.round(100*(c>0?M/c*100:0))/100,total_jobs_dispatched:s,total_drive_time_minutes:_,total_drive_miles:Math.round(100*p)/100,avg_drive_time_between_jobs:Math.round(C),avg_drive_miles_between_jobs:Math.round(100*E)/100,drive_time_ratio:Math.round(100*T)/100,on_time_arrival_rate:Math.round(100*x)/100,early_arrival_rate:Math.round(100*j)/100,late_arrival_rate:Math.round(100*k)/100,jobs_completed_on_time:v,jobs_completed_late:f,jobs_rescheduled:b,reschedule_rate:Math.round(100*D)/100,active_technicians:d,avg_jobs_per_tech:Math.round(100*I)/100,revenue_per_hour:Math.round(100*(M>0?O/M:0))/100,revenue_per_mile:Math.round(100*P)/100,avg_revenue_per_tech:Math.round(100*A)/100,updated_at:new Date().toISOString()},{onConflict:"company_id,date"}),!0}async function M(e,t){let a=new Date,r=new Date(a);r.setDate(r.getDate()-30);let i=r.toISOString().split("T")[0],n=a.toISOString().split("T")[0],{data:o}=await e.from("invoice_items").select(`
			id, quantity, unit_price, cost_price, total_price, item_type,
			price_book_item_id,
			price_book_item:price_book_items(id, name, category, unit_price, cost, item_type, target_margin_percent),
			invoice:invoices!inner(id, job_id, created_at, deleted_at)
		`).eq("invoice.company_id",t).is("invoice.deleted_at",null).gte("invoice.created_at",r.toISOString());if(!o||0===o.length)return 0;let s={};for(let e of o){let t=e.price_book_item,a=e.invoice,r=e.price_book_item_id||`custom_${e.item_type}`;s[r]||(s[r]={priceBookItem:t,timesSold:0,totalQuantity:0,jobIds:new Set,prices:[],costs:[],totalRevenue:0,totalCost:0}),s[r].timesSold++,s[r].totalQuantity+=e.quantity??1,a?.job_id&&s[r].jobIds.add(a.job_id),e.unit_price&&s[r].prices.push(e.unit_price),e.cost_price&&s[r].costs.push(e.cost_price),s[r].totalRevenue+=(e.total_price??0)/100,s[r].totalCost+=(e.cost_price??0)*(e.quantity??1)/100}let l=0;for(let[a,r]of Object.entries(s)){let o=r.priceBookItem,s=r.prices.length>0?r.prices.reduce((e,t)=>e+t,0)/r.prices.length/100:0,d=r.prices.length>0?Math.min(...r.prices)/100:0,c=r.prices.length>0?Math.max(...r.prices)/100:0,u=(o?.unit_price??0)/100,_=u>0?(s-u)/u*100:0,p=u>0&&s<u?(u-s)/u*100:0,m=r.totalRevenue-r.totalCost,h=r.totalRevenue>0?m/r.totalRevenue*100:0,g=r.totalCost>0?m/r.totalCost*100:0,v=o?.target_margin_percent??30,f=h-v,b=h<v-10,w="stable",y="maintain";b?(y="increase",w="declining"):h>v+10&&(w="improving");let R=Math.min(Math.round(r.timesSold/30*100),100);await e.from("analytics_pricebook_performance").upsert({company_id:t,period_start:i,period_end:n,price_book_item_id:o?.id||null,item_name:o?.name||`Custom ${a}`,item_category:o?.category||"uncategorized",item_type:o?.item_type||"service",times_sold:r.timesSold,total_quantity_sold:Math.round(100*r.totalQuantity)/100,unique_jobs_used:r.jobIds.size,list_price:Math.round(100*u)/100,avg_sold_price:Math.round(100*s)/100,min_sold_price:Math.round(100*d)/100,max_sold_price:Math.round(100*c)/100,price_variance_percent:Math.round(100*_)/100,discount_rate:Math.round(100*p)/100,total_cost:Math.round(100*r.totalCost)/100,total_revenue:Math.round(100*r.totalRevenue)/100,total_profit:Math.round(100*m)/100,gross_margin_percent:Math.round(100*h)/100,markup_percent:Math.round(100*g)/100,target_margin_percent:v,margin_vs_target:Math.round(100*f)/100,sales_trend:"stable",margin_trend:w,demand_score:R,price_recommendation:y,margin_alert:b,updated_at:new Date().toISOString()},{onConflict:"company_id,period_start,period_end,price_book_item_id"}),l++}return l}async function C(e,t){let a=new Date,r=a.toISOString().split("T")[0],i=new Date(a);i.setFullYear(i.getFullYear()-1);let{data:n}=await e.from("customers").select(`
			id, created_at, customer_type, lifetime_value, total_jobs,
			last_service_date, avg_days_between_jobs, churn_risk,
			has_active_contract, contract_end_date
		`).eq("company_id",t).is("deleted_at",null).limit(500);if(!n||0===n.length)return 0;let o=0;for(let s of n)try{let{data:n}=await e.from("jobs").select("id, total_amount, created_at, status").eq("customer_id",s.id).is("deleted_at",null).order("created_at",{ascending:!1}).limit(50),l=n||[],d=l.filter(e=>new Date(e.created_at)>=i),c=s.last_service_date?Math.floor((a.getTime()-new Date(s.last_service_date).getTime())/864e5):365,{data:u}=await e.from("communications").select("id, created_at, direction").eq("customer_id",s.id).gte("created_at",new Date(a.getTime()-7776e6).toISOString()).is("deleted_at",null),_=u?.length??0,p=u?.filter(e=>new Date(e.created_at)>=new Date(a.getTime()-2592e6))?.length??0,m=u&&u.length>0?Math.floor((a.getTime()-new Date(u[0].created_at).getTime())/864e5):180,{data:h}=await e.from("invoices").select("balance_amount, due_date, status").eq("customer_id",s.id).not("status","in",'("paid", "void")').is("deleted_at",null),g=(h?.reduce((e,t)=>e+(t.balance_amount??0),0)/100)??0,v=h?.some(e=>e.due_date&&new Date(e.due_date)<a)??!1,f=s.total_jobs??l.length,b=d.length,w=(s.lifetime_value??0)/100,y=d.reduce((e,t)=>e+(t.total_amount??0),0)/100,R=f>0?w/f:0,M=s.avg_days_between_jobs??180,C=50;c<=90?C+=25:c<=180?C+=15:c<=365?C+=5:C-=10,_>=5?C+=15:_>=2?C+=10:_>=1&&(C+=5),b>=3?C+=20:b>=2?C+=15:b>=1&&(C+=10),s.has_active_contract&&(C+=15),v||0!==g?v&&(C-=10):C+=10,R>=500?C+=15:R>=200?C+=10:R>=100&&(C+=5),C=Math.max(0,Math.min(100,C));let E="healthy";E=C<30?"critical":C<50?"at_risk":"healthy";let S=Math.max(0,Math.min(1,(100-C)/100)),T="low";S>=.7?T="critical":S>=.5?T="high":S>=.3&&(T="medium");let x="regular";C>=80&&R>=300?x="vip":C>=70?x="loyal":c>365?x="dormant":c>180&&(x="occasional");let j="medium";w>=5e3?j="high":w<500&&(j="low");let k=50;C>=70&&(k+=20),s.has_active_contract||(k+=15),R<300&&(k+=10),k=Math.min(100,k);let D="maintain_relationship",I="low";"critical"===T?(D="urgent_outreach",I="urgent"):"high"===T?(D="schedule_check_in",I="high"):k>=70?(D="present_service_agreement",I="medium"):c>180&&(D="send_reminder",I="medium"),await e.from("analytics_customer_health").upsert({company_id:t,customer_id:s.id,analysis_date:r,health_score:C,health_status:E,days_since_last_service:c,days_since_last_contact:m,total_interactions_30d:p,total_interactions_90d:_,total_jobs_lifetime:f,total_jobs_12m:b,total_revenue_lifetime:Math.round(100*w)/100,total_revenue_12m:Math.round(100*y)/100,avg_job_value:Math.round(100*R)/100,avg_days_between_jobs:M,outstanding_balance:Math.round(100*g)/100,has_overdue_invoices:v,is_recurring_customer:f>=2,has_service_agreement:s.has_active_contract??!1,churn_probability:Math.round(1e4*S)/1e4,churn_risk_level:T,upsell_score:k,current_ltv:Math.round(100*w)/100,customer_segment:x,value_segment:j,recommended_action:D,recommended_action_priority:I,updated_at:new Date().toISOString()},{onConflict:"company_id,customer_id,analysis_date"}),o++}catch{continue}return o}e.s(["GET",()=>y,"maxDuration",0,300],42575);var E=e.i(42575);let S=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cron/calculate-dispatch-pricebook/route",pathname:"/api/cron/calculate-dispatch-pricebook",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/cron/calculate-dispatch-pricebook/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:T,workUnitAsyncStorage:x,serverHooks:j}=S;function k(){return(0,r.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:x})}async function D(e,t,r){S.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let b="/api/cron/calculate-dispatch-pricebook/route";b=b.replace(/\/index$/,"")||"/";let w=await S.prepare(e,t,{srcPage:b,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:y,params:R,nextConfig:M,parsedUrl:C,isDraftMode:E,prerenderManifest:T,routerServerContext:x,isOnDemandRevalidate:j,revalidateOnlyGenerated:k,resolvedPathname:D,clientReferenceManifest:I,serverActionsManifest:O}=w,P=(0,l.normalizeAppPath)(b),A=!!(T.dynamicRoutes[P]||T.routes[D]),N=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,C,!1):t.end("This page could not be found"),null);if(A&&!E){let e=!!T.routes[D],t=T.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(M.experimental.adapterPath)return await N();throw new v.NoFallbackError}}let q=null;!A||S.isDev||E||(q="/index"===(q=D)?"/":q);let U=!0===S.isDev||!A,H=A&&!U;O&&I&&(0,o.setReferenceManifestsSingleton)({page:b,clientReferenceManifest:I,serverActionsManifest:O,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:O})});let $=e.method||"GET",F=(0,n.getTracer)(),B=F.getActiveScopeSpan(),K={params:R,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!M.experimental.authInterrupts},cacheComponents:!!M.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:M.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>S.onRequestError(e,t,r,x)},sharedContext:{buildId:y}},z=new d.NodeNextRequest(e),L=new d.NodeNextResponse(t),G=c.NextRequestAdapter.fromNodeNextRequest(z,(0,c.signalFromNodeResponse)(t));try{let o=async e=>S.handle(G,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${$} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${b}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var n,l;let d=async({previousCacheEntry:a})=>{try{if(!s&&j&&k&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let d=K.renderOpts.collectedTags;if(!A)return await (0,p.sendResponse)(z,L,n,K.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,r=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:j})},x),t}},c=await S.handleResponse({req:e,nextConfig:M,cacheKey:q,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:j,revalidateOnlyGenerated:k,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:s});if(!A)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",j?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&A||u.delete(g.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(z,L,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};B?await l(B):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${$} ${b}`,kind:n.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:j})}),A)throw t;return await (0,p.sendResponse)(z,L,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>k,"routeModule",()=>S,"serverHooks",()=>j,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>x],947742)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_f80a38a7.js.map