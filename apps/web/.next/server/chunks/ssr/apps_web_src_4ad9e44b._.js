module.exports=[37836,a=>{"use strict";let b=(0,a.i(742210).registerClientReference)(function(){throw Error("Attempted to call SchedulePageClient() from the server but SchedulePageClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/apps/web/src/components/schedule/schedule-page-client.tsx <module evaluation>","SchedulePageClient");a.s(["SchedulePageClient",0,b])},78893,a=>{"use strict";let b=(0,a.i(742210).registerClientReference)(function(){throw Error("Attempted to call SchedulePageClient() from the server but SchedulePageClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/apps/web/src/components/schedule/schedule-page-client.tsx","SchedulePageClient");a.s(["SchedulePageClient",0,b])},117906,a=>{"use strict";a.i(37836);var b=a.i(78893);a.n(b)},662957,a=>{"use strict";var b=a.i(504348),c=a.i(208768),d=a.i(382865);function e(a,b,e){let f=(0,d.toDate)(a,e?.in);return isNaN(b)?(0,c.constructFrom)(e?.in||a,NaN):(b&&f.setDate(f.getDate()+b),f)}var f=a.i(429969),g=a.i(946445),h=a.i(8868);a.i(801791);var i=a.i(868553);a.i(174010);var j=a.i(705991);function k({context:a="this page",hasCompanies:c=!1}){let d=c?`Choose an active workspace from the switcher so we know which ${a} data to load.`:`You’re not part of any workspace yet. Ask an admin to invite you or create one to unlock ${a}.`;return(0,b.jsx)("div",{className:"flex min-h-[60vh] items-center justify-center px-6 py-12",children:(0,b.jsxs)(j.Card,{className:"max-w-xl shadow-lg",children:[(0,b.jsxs)(j.CardHeader,{className:"flex items-start gap-3",children:[(0,b.jsx)("div",{className:"bg-muted rounded-lg p-3",children:(0,b.jsx)(g.Building2,{className:"text-muted-foreground size-6"})}),(0,b.jsxs)("div",{children:[(0,b.jsx)(j.CardTitle,{children:"Connect a workspace to continue"}),(0,b.jsx)(j.CardDescription,{children:d})]})]}),(0,b.jsxs)(j.CardContent,{className:"flex flex-wrap gap-3",children:[(0,b.jsx)(i.Button,{asChild:!0,children:(0,b.jsx)(h.default,{href:"/dashboard/settings",children:"Open settings"})}),(0,b.jsx)(i.Button,{asChild:!0,variant:"outline",children:(0,b.jsx)(h.default,{href:"/dashboard",children:"Back to dashboard"})})]})]})})}var l=a.i(117906);a.i(467361);var m=a.i(445074);function n(a){var b;return{...a,startTime:a.startTime.toISOString(),endTime:a.endTime.toISOString(),createdAt:a.createdAt.toISOString(),updatedAt:a.updatedAt.toISOString(),customer:{...a.customer,createdAt:a.customer.createdAt.toISOString(),updatedAt:a.customer.updatedAt.toISOString()},recurrence:a.recurrence?{...b=a.recurrence,endDate:b.endDate?b.endDate.toISOString():void 0}:void 0}}function o(a){var b;return{...a,createdAt:a.createdAt.toISOString(),updatedAt:a.updatedAt.toISOString(),schedule:{...b=a.schedule,daysOff:b.daysOff.map(a=>a.toISOString())}}}let p={maxRetries:3,initialDelay:500,maxDelay:5e3,backoffFactor:2,shouldRetry:a=>{if(a instanceof Error){let b=a.message.toLowerCase();return b.includes("network")||b.includes("timeout")||b.includes("connection")||b.includes("fetch failed")||b.includes("econnreset")||b.includes("500")||b.includes("502")||b.includes("503")||b.includes("504")}return!1}};async function q(a,b,c={}){let d,e={...p,...c},f=e.initialDelay;for(let c=0;c<=e.maxRetries;c++)try{return await a()}catch(a){if(d=a,c===e.maxRetries||!e.shouldRetry(a))throw console.error(`[Schedule] ${b} failed after ${c+1} attempt(s):`,a instanceof Error?a.message:String(a)),a;console.warn(`[Schedule] ${b} attempt ${c+1} failed, retrying in ${f}ms...`,a instanceof Error?a.message:String(a)),await new Promise(a=>setTimeout(a,f)),f=Math.min(f*e.backoffFactor,e.maxDelay)}throw d}let r=`
  *,
  customer:customers(
    id,
    first_name,
    last_name,
    email,
    phone
  ),
  job:jobs(
    id,
    job_number,
    title,
    job_type,
    company_id,
    job_team_assignments:job_team_assignments!job_team_assignments_job_id_fkey(
      id,
      role,
      team_member_id,
      removed_at,
      team_member:team_members(
        id,
        company_id,
        status,
        job_title,
        department,
        archived_at,
        user_id,
        phone,
        email,
        invited_name,
        created_at,
        updated_at
      )
    )
  )
`,s=`
  *,
  customer:customers!customer_id(
    id,
    first_name,
    last_name,
    email,
    phone,
    created_at,
    updated_at
  ),
  property:properties!property_id(
    id,
    name,
    address,
    address2,
    city,
    state,
    zip_code,
    country,
    lat,
    lon
  ),
  job_team_assignments:job_team_assignments!job_team_assignments_job_id_fkey(
    id,
    role,
    team_member_id,
    removed_at,
    team_member:team_members(
      id,
      company_id,
      status,
      job_title,
      department,
      archived_at,
      user_id,
      phone,
      email,
      invited_name,
      created_at,
      updated_at
    )
  )
`,t={workingHours:{start:"08:00",end:"17:00"},daysOff:[],availableHours:{start:0,end:40}},u={address:{street:"",city:"",state:"",zip:"",country:""},coordinates:{lat:0,lng:0}};async function v({supabase:a,companyId:b,range:c,unscheduledLimit:d=50,unscheduledOffset:e=0,unscheduledSearch:f=""}){var g;let h,i,j,k,l,m,n,o,p=a.from("appointments").select(r).eq("company_id",b).is("deleted_at",null).is("archived_at",null).order("start_time",{ascending:!0});c&&(p.lte("start_time",c.end.toISOString()),p.gte("end_time",c.start.toISOString()));try{[l,m,n]=await q(()=>Promise.all([p,w(a,b),y(a,b,{limit:d,offset:e,search:f})]),"fetchScheduleData parallel queries")}catch(a){throw console.error("[Schedule] Failed to fetch schedule data:",a),Error(`Schedule data query failed: ${a instanceof Error?a.message:String(a)}`)}let s=l.data??[],v=l.error;if(v)throw console.error("Appointments query error:",v),Error(`Appointments query failed: ${v.message}`);let x=new Set(s.map(a=>a.job_id).filter(a=>!!a)),D=n.rows.filter(a=>!x.has(a.id)),E={totalCount:n.totalCount,hasMore:n.hasMore,fetchedCount:n.rows.length};try{o=await q(()=>{var b,c;let d;return z(a,(b=s,c=D,d=new Set,b.forEach(a=>{a.property_id&&d.add(a.property_id)}),c.forEach(a=>{a.property_id&&d.add(a.property_id)}),Array.from(d)))},"fetchPropertiesByIds")}catch(a){console.error("[Schedule] Failed to fetch properties:",a),o=new Map}let F=(g=m,h=[],i=new Map,j=new Map,k=new Map,g.forEach(a=>{let b=a.user_id??a.id;if(!b)return;let c=a.users,d={id:b,userId:a.user_id??void 0,teamMemberId:a.id,name:c?.name||a.invited_name||a.job_title||"Team Member",email:c?.email||a.email||void 0,phone:c?.phone||a.phone||void 0,avatar:c?.avatar||void 0,role:a.job_title||a.role||"Team Member",department:a.department||void 0,status:"active"===a.status?"available":"offline",isActive:"active"===a.status&&!a.archived_at,schedule:{...t},color:"#3B82F6",createdAt:new Date(a.created_at),updatedAt:new Date(a.updated_at)};h.push(d),i.set(d.id,d),d.userId&&j.set(d.userId,d),d.teamMemberId&&k.set(d.teamMemberId,d)}),{technicians:h,byId:i,byUserId:j,byTeamMemberId:k});return{jobs:[...s.map(a=>{var b,c,d,e;let f,g,h,i,j,k,l;return b=a,c=F,h=B(o.get(a.property_id??"")??null),i=(d=b,e=h.address.street,g=(f=d.customer)&&`${f.first_name??""} ${f.last_name??""}`.trim(),{id:f?.id||d.customer_id||`customer-${d.id}`,name:g&&g.length>0?g:"Unspecified Customer",email:f?.email||void 0,phone:f?.phone||void 0,location:{...u,address:{...u.address,street:e}},createdAt:new Date(d.created_at),updatedAt:new Date(d.updated_at)}),k=(j=function(a,b){let c=[];if(a.assigned_to){let d=b.byUserId.get(a.assigned_to)||b.byId.get(a.assigned_to);c.push({technicianId:d?.id??a.assigned_to,teamMemberId:d?.teamMemberId,displayName:d?.name||"Primary Technician",avatar:d?.avatar||null,role:"primary",status:d?.status??"available",isActive:d?.isActive??!0})}return(a.job?.job_team_assignments?.filter(a=>!a.removed_at)??[]).forEach(a=>{let d=a.team_member;if(!d)return;let e=d.user_id&&b.byUserId.get(d.user_id)||b.byTeamMemberId.get(d.id),f=e?.name||d.invited_name||d.job_title||"Crew Member";c.push({technicianId:e?.id??d.user_id??d.id,teamMemberId:d.id,displayName:f,avatar:e?.avatar||null,role:a.role||"crew",status:e?.status??C(d.status),isActive:e?.isActive??"active"===d.status})}),A(c)}(b,c)).find(a=>"primary"===a.role),l=k?.technicianId??"",{id:b.id,jobId:b.job_id||void 0,technicianId:l,assignments:j,isUnassigned:0===j.length,title:b.title||b.job?.title||"Appointment",description:b.description||void 0,jobType:b.job?.job_type||void 0,appointmentType:b.type||void 0,appointmentCategory:function(a,b){if(b)return"event";switch(a?.toLowerCase()){case"meeting":case"appointment":case"follow_up":case"consultation":case"call":return"meeting";case"event":case"training":case"conference":case"holiday":return"event";default:return"job"}}(b.type,b.all_day??!1),customer:i,location:h,startTime:new Date(b.start_time),endTime:new Date(b.end_time),allDay:b.all_day,status:b.status&&["scheduled","dispatched","arrived","in-progress","closed","completed","cancelled"].includes(b.status)?b.status:"scheduled",priority:"medium",recurrence:b.is_recurring?{frequency:"weekly",interval:1,endDate:b.recurrence_end_date?new Date(b.recurrence_end_date):void 0}:void 0,metadata:{estimatedDuration:b.duration,notes:b.notes||void 0},createdAt:new Date(b.created_at),updatedAt:new Date(b.updated_at)}}),...D.map(a=>{var b,c,d,e,f,g;let h,i,j,k,l,m,n,p;return b=a,c=F,j=B(o.get(a.property_id??"")??null),k=(d=b,e=j.address.street,h=Array.isArray(f=d.customer)?f[0]??null:f??null,i=[h?.first_name?.trim()??"",h?.last_name?.trim()??""].filter(Boolean).join(" ").trim(),{id:h?.id||d.customer_id||`customer-${d.id}`,name:i||d.title||"Unspecified Customer",email:h?.email||void 0,phone:h?.phone||void 0,location:{...u,address:{...u.address,street:e}},createdAt:new Date(h?.created_at??d.created_at),updatedAt:new Date(h?.updated_at??d.updated_at)}),l=function(a,b){let c=[];if(a.assigned_to){let d=b.byUserId.get(a.assigned_to)||b.byId.get(a.assigned_to);c.push({technicianId:null,teamMemberId:d?.teamMemberId,displayName:d?.name||"Primary Technician",avatar:d?.avatar??null,role:"primary",status:d?.status??"available",isActive:d?.isActive??!0})}return(Array.isArray(a.job_team_assignments)?a.job_team_assignments:a.job_team_assignments?[a.job_team_assignments]:[]).filter(a=>!a.removed_at).forEach(a=>{let d=a.team_member;if(!d)return;let e=d.user_id&&b.byUserId.get(d.user_id)||b.byTeamMemberId.get(d.id);c.push({technicianId:null,teamMemberId:d.id,displayName:e?.name||d.invited_name||d.job_title||"Crew Member",avatar:e?.avatar??null,role:a.role||"crew",status:e?.status??C(d.status),isActive:e?.isActive??"active"===d.status})}),A(c)}(b,c),m=new Date(b.scheduled_start?b.scheduled_start:b.created_at),n=new Date(b.scheduled_end?b.scheduled_end:m.getTime()+36e5),{id:b.id,jobId:b.id,technicianId:"",assignments:l,isUnassigned:!0,title:b.title||b.job_number||"Job",description:b.description||void 0,jobType:b.job_type||void 0,customer:k,location:j,startTime:m,endTime:n,status:function(a){if(!a)return"scheduled";let b=a.toLowerCase();switch(b){case"scheduled":case"dispatched":case"arrived":case"closed":case"cancelled":return b;case"in-progress":case"in_progress":case"inprogress":return"in-progress";case"completed":case"complete":case"done":return"completed";default:return"scheduled"}}(b.status),priority:function(a){if(!a)return"medium";let b=a.toLowerCase();switch(b){case"low":case"medium":case"high":case"urgent":return b;case"critical":case"emergency":return"urgent";default:return"medium"}}(b.priority),metadata:(p={...(g=b).metadata&&"object"==typeof g.metadata?g.metadata:{}},g.notes&&(p.notes=g.notes),p),createdAt:new Date(b.created_at),updatedAt:new Date(b.updated_at)}})],technicians:F.technicians,unassignedMeta:{limit:d,nextOffset:e+E.fetchedCount,hasMore:E.hasMore,search:f,totalCount:E.totalCount}}}async function w(a,b){let{data:c,error:d}=await a.from("company_memberships").select(`
			*,
			users:profiles!company_memberships_profile_id_fkey(
				id,
				full_name,
				email,
				phone,
				avatar_url
			)
		`).eq("company_id",b).eq("status","active").is("archived_at",null);return d?(console.warn("Join query failed, falling back to sequential queries:",d.message),x(a,b)):(c??[]).map(a=>({...a,users:a.users?{id:a.users.id,name:a.users.full_name,email:a.users.email,phone:a.users.phone,avatar:a.users.avatar_url}:null}))}async function x(a,b){let{data:c,error:d}=await a.from("company_memberships").select("*").eq("company_id",b).eq("status","active").is("archived_at",null);if(d)throw d;let e=Array.from(new Set((c??[]).map(a=>a.user_id).filter(a=>!!a))),f=new Map;if(e.length>0){let{data:b,error:c}=await a.from("profiles").select("id, full_name, email, phone, avatar_url").in("id",e);if(c)throw c;(b??[]).forEach(a=>{f.set(a.id,a)})}return(c??[]).map(a=>({...a,users:a.user_id?f.get(a.user_id)??null:null}))}async function y(a,b,c){let d,e,f,g=c.limit??50,h=c.offset??0,i=a.from("jobs").select(s,{count:"exact"}).eq("company_id",b).is("deleted_at",null).is("archived_at",null).is("scheduled_start",null).is("scheduled_end",null).not("status","in",'("completed","cancelled")').order("created_at",{ascending:!1}).range(h,h+g-1);if(c.search?.trim()){let a=c.search.trim().replace(/,/g,"\\,"),b=`%${a}%`;i=i.or(`title.ilike.${b},job_number.ilike.${b},description.ilike.${b}`)}try{let a=await i;d=a.data,e=a.count,f=a.error}catch(a){return console.error("[Schedule] Unscheduled jobs fetch failed:",a),{rows:[],totalCount:0,hasMore:!1}}if(f)return console.error("[Schedule] Unscheduled jobs query error:",f),{rows:[],totalCount:0,hasMore:!1};let j=d??[],k="number"==typeof e?e:j.length,l=h+j.length<k;return{rows:j,totalCount:k,hasMore:l}}async function z(a,b){let c=new Map;if(0===b.length)return c;for(let d=0;d<b.length;d+=100){let e=b.slice(d,d+100);try{let{data:b,error:d}=await a.from("properties").select("id, name, address, address2, city, state, zip_code, country, lat, lon").in("id",e);if(d){console.error("[Schedule] Properties query error:",d);continue}(b??[]).forEach(a=>c.set(a.id,a))}catch(a){console.error(`[Schedule] Failed to fetch properties chunk ${d/100+1}:`,a)}}return c}function A(a){let b=new Set;return a.filter(a=>{let c=`${a.role}-${a.technicianId??a.teamMemberId??""}`;return!b.has(c)&&(b.add(c),!0)})}function B(a){return a?{address:{street:a.address||a.address2||a.name||"",city:a.city||"",state:a.state||"",zip:a.zip_code||"",country:a.country||""},coordinates:{lat:a.lat||0,lng:a.lon||0}}:{...u}}function C(a){return"active"===a?"available":"offline"}var D=a.i(136874),E=a.i(933427);async function F(){try{let a=await (0,E.createServiceSupabaseClient)();if(a)return a;return console.warn("SUPABASE_SERVICE_ROLE_KEY not configured – falling back to authenticated client"),await (0,D.createClient)()}catch(a){return console.warn("Supabase service role client failed to initialize – falling back to authenticated client:",a instanceof Error?a.message:String(a)),await (0,D.createClient)()}}async function G(){let a,c=null,d=await (0,m.getActiveCompanyId)();if(!d){let a=await (0,m.getUserCompanies)();return(0,b.jsx)(k,{context:"scheduling",hasCompanies:(a??[]).length>0})}try{var f;let b=await F(),c=new Date,g={start:e(c,-7,void 0),end:e(c,30)},{jobs:h,technicians:i}=await v({supabase:b,companyId:d,range:g});a={companyId:(f={companyId:d,jobs:h,technicians:i,range:g,lastSync:new Date}).companyId,range:{start:f.range.start.toISOString(),end:f.range.end.toISOString()},lastSync:f.lastSync.toISOString(),jobs:f.jobs.map(n),technicians:f.technicians.map(o),unassignedMeta:f.unassignedMeta}}catch(a){console.error("Schedule data fetch failed:",a),a instanceof Error&&console.error("Error stack:",a.stack),c=a instanceof Error?a.message:"string"==typeof a?a:"Unable to load schedule data"}return(0,b.jsx)(l.SchedulePageClient,{bootstrapError:c,initialData:a})}function H(){return(0,b.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:(0,b.jsxs)("div",{className:"flex flex-col items-center gap-4",children:[(0,b.jsx)("div",{className:"border-primary/20 border-t-primary size-12 animate-spin rounded-full border-4"}),(0,b.jsx)("p",{className:"text-muted-foreground text-sm",children:"Loading schedule..."})]})})}function I(){return(0,b.jsx)(f.Suspense,{fallback:(0,b.jsx)(H,{}),children:(0,b.jsx)(G,{})})}a.s(["default",()=>I],662957)}];

//# sourceMappingURL=apps_web_src_4ad9e44b._.js.map