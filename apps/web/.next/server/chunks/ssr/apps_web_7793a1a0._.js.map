{"version":3,"sources":["../../../../../../apps/web/src/actions/settings/finance.ts","../../../../../../apps/web/.next-internal/server/app/%28dashboard%29/dashboard/settings/finance/accounting/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["/**\n * Finance Settings Server Actions\n *\n * Handles all finance-related settings including accounting, bookkeeping,\n * bank accounts, financing, cards, and virtual buckets\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport {\n\tActionError,\n\tERROR_CODES,\n\tERROR_MESSAGES,\n} from \"@/lib/errors/action-error\";\nimport {\n\ttype ActionResult,\n\tassertAuthenticated,\n\twithErrorHandling,\n} from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\nasync function getCompanyId(supabase: any, userId: string): Promise<string> {\n\tconst { data: teamMember } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(\"company_id\")\n\t\t.eq(\"user_id\", userId)\n\t\t.eq(\"status\", \"active\")\n\t\t.single();\n\n\tif (!teamMember?.company_id) {\n\t\tthrow new ActionError(\n\t\t\t\"You must be part of a company\",\n\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t403,\n\t\t);\n\t}\n\n\treturn teamMember.company_id;\n}\n\n// ============================================================================\n// ACCOUNTING SETTINGS\n// ============================================================================\n\nconst accountingSettingsSchema = z.object({\n\tprovider: z\n\t\t.enum([\"quickbooks\", \"xero\", \"sage\", \"freshbooks\", \"manual\", \"none\"])\n\t\t.optional(),\n\tproviderEnabled: z.boolean().default(false),\n\tapiKey: z.string().optional(),\n\tapiSecret: z.string().optional(),\n\tautoSyncEnabled: z.boolean().default(false),\n\tsyncFrequency: z\n\t\t.enum([\"realtime\", \"hourly\", \"daily\", \"weekly\", \"manual\"])\n\t\t.default(\"daily\"),\n\tincomeAccount: z.string().optional(),\n\texpenseAccount: z.string().optional(),\n\tassetAccount: z.string().optional(),\n\tliabilityAccount: z.string().optional(),\n\tsyncInvoices: z.boolean().default(true),\n\tsyncPayments: z.boolean().default(true),\n\tsyncExpenses: z.boolean().default(true),\n\tsyncCustomers: z.boolean().default(true),\n});\n\nexport async function updateAccountingSettings(\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst data = accountingSettingsSchema.parse({\n\t\t\tprovider: formData.get(\"provider\") || undefined,\n\t\t\tproviderEnabled: formData.get(\"providerEnabled\") === \"true\",\n\t\t\tapiKey: formData.get(\"apiKey\") || undefined,\n\t\t\tapiSecret: formData.get(\"apiSecret\") || undefined,\n\t\t\tautoSyncEnabled: formData.get(\"autoSyncEnabled\") === \"true\",\n\t\t\tsyncFrequency: formData.get(\"syncFrequency\") || \"daily\",\n\t\t\tincomeAccount: formData.get(\"incomeAccount\") || undefined,\n\t\t\texpenseAccount: formData.get(\"expenseAccount\") || undefined,\n\t\t\tassetAccount: formData.get(\"assetAccount\") || undefined,\n\t\t\tliabilityAccount: formData.get(\"liabilityAccount\") || undefined,\n\t\t\tsyncInvoices: formData.get(\"syncInvoices\") !== \"false\",\n\t\t\tsyncPayments: formData.get(\"syncPayments\") !== \"false\",\n\t\t\tsyncExpenses: formData.get(\"syncExpenses\") !== \"false\",\n\t\t\tsyncCustomers: formData.get(\"syncCustomers\") !== \"false\",\n\t\t});\n\n\t\t// Encrypt API credentials\n\t\tconst encryptedApiKey = data.apiKey\n\t\t\t? Buffer.from(data.apiKey).toString(\"base64\")\n\t\t\t: null;\n\t\tconst encryptedApiSecret = data.apiSecret\n\t\t\t? Buffer.from(data.apiSecret).toString(\"base64\")\n\t\t\t: null;\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"finance_accounting_settings\")\n\t\t\t.upsert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tprovider: data.provider,\n\t\t\t\tprovider_enabled: data.providerEnabled,\n\t\t\t\tapi_key_encrypted: encryptedApiKey,\n\t\t\t\tapi_secret_encrypted: encryptedApiSecret,\n\t\t\t\tauto_sync_enabled: data.autoSyncEnabled,\n\t\t\t\tsync_frequency: data.syncFrequency,\n\t\t\t\tincome_account: data.incomeAccount,\n\t\t\t\texpense_account: data.expenseAccount,\n\t\t\t\tasset_account: data.assetAccount,\n\t\t\t\tliability_account: data.liabilityAccount,\n\t\t\t\tsync_invoices: data.syncInvoices,\n\t\t\t\tsync_payments: data.syncPayments,\n\t\t\t\tsync_expenses: data.syncExpenses,\n\t\t\t\tsync_customers: data.syncCustomers,\n\t\t\t});\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update accounting settings\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/finance/accounting\");\n\t});\n}\n\nexport async function getAccountingSettings(): Promise<ActionResult<any>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"finance_accounting_settings\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error && error.code !== \"PGRST116\") {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch accounting settings\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn data || null;\n\t});\n}\n\n// ============================================================================\n// BOOKKEEPING SETTINGS\n// ============================================================================\n\nconst bookkeepingSettingsSchema = z.object({\n\tautoCategorizeTransactions: z.boolean().default(true),\n\tautoReconcilePayments: z.boolean().default(false),\n\tautoGenerateReports: z.boolean().default(false),\n\tdefaultIncomeCategory: z.string().default(\"Service Revenue\"),\n\tdefaultExpenseCategory: z.string().default(\"Operating Expenses\"),\n\tdefaultTaxCategory: z.string().default(\"Sales Tax\"),\n\treportFrequency: z\n\t\t.enum([\"weekly\", \"monthly\", \"quarterly\", \"yearly\"])\n\t\t.default(\"monthly\"),\n\temailReports: z.boolean().default(false),\n\treportRecipients: z.string().optional(),\n\tfiscalYearStartMonth: z.coerce.number().min(1).max(12).default(1),\n\tfiscalYearStartDay: z.coerce.number().min(1).max(31).default(1),\n\trequireReceiptAttachment: z.boolean().default(false),\n\tallowManualJournalEntries: z.boolean().default(false),\n});\n\nasync function updateBookkeepingSettings(\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst reportRecipientsStr = formData.get(\"reportRecipients\") as string;\n\t\tconst reportRecipients = reportRecipientsStr\n\t\t\t? reportRecipientsStr.split(\",\").map((email) => email.trim())\n\t\t\t: [];\n\n\t\tconst data = bookkeepingSettingsSchema.parse({\n\t\t\tautoCategorizeTransactions:\n\t\t\t\tformData.get(\"autoCategorizeTransactions\") !== \"false\",\n\t\t\tautoReconcilePayments: formData.get(\"autoReconcilePayments\") === \"true\",\n\t\t\tautoGenerateReports: formData.get(\"autoGenerateReports\") === \"true\",\n\t\t\tdefaultIncomeCategory:\n\t\t\t\tformData.get(\"defaultIncomeCategory\") || \"Service Revenue\",\n\t\t\tdefaultExpenseCategory:\n\t\t\t\tformData.get(\"defaultExpenseCategory\") || \"Operating Expenses\",\n\t\t\tdefaultTaxCategory: formData.get(\"defaultTaxCategory\") || \"Sales Tax\",\n\t\t\treportFrequency: formData.get(\"reportFrequency\") || \"monthly\",\n\t\t\temailReports: formData.get(\"emailReports\") === \"true\",\n\t\t\tfiscalYearStartMonth: formData.get(\"fiscalYearStartMonth\") || \"1\",\n\t\t\tfiscalYearStartDay: formData.get(\"fiscalYearStartDay\") || \"1\",\n\t\t\trequireReceiptAttachment:\n\t\t\t\tformData.get(\"requireReceiptAttachment\") === \"true\",\n\t\t\tallowManualJournalEntries:\n\t\t\t\tformData.get(\"allowManualJournalEntries\") === \"true\",\n\t\t});\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"finance_bookkeeping_settings\")\n\t\t\t.upsert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tauto_categorize_transactions: data.autoCategorizeTransactions,\n\t\t\t\tauto_reconcile_payments: data.autoReconcilePayments,\n\t\t\t\tauto_generate_reports: data.autoGenerateReports,\n\t\t\t\tdefault_income_category: data.defaultIncomeCategory,\n\t\t\t\tdefault_expense_category: data.defaultExpenseCategory,\n\t\t\t\tdefault_tax_category: data.defaultTaxCategory,\n\t\t\t\treport_frequency: data.reportFrequency,\n\t\t\t\temail_reports: data.emailReports,\n\t\t\t\treport_recipients: reportRecipients,\n\t\t\t\tfiscal_year_start_month: data.fiscalYearStartMonth,\n\t\t\t\tfiscal_year_start_day: data.fiscalYearStartDay,\n\t\t\t\trequire_receipt_attachment: data.requireReceiptAttachment,\n\t\t\t\tallow_manual_journal_entries: data.allowManualJournalEntries,\n\t\t\t});\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update bookkeeping settings\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/finance/bookkeeping\");\n\t});\n}\n\nasync function getBookkeepingSettings(): Promise<ActionResult<any>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"finance_bookkeeping_settings\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error && error.code !== \"PGRST116\") {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch bookkeeping settings\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn data || null;\n\t});\n}\n\n// ============================================================================\n// BANK ACCOUNTS\n// ============================================================================\n\nconst bankAccountSchema = z.object({\n\taccountName: z.string().min(1, \"Account name is required\"),\n\tbankName: z.string().min(1, \"Bank name is required\"),\n\taccountType: z\n\t\t.enum([\"checking\", \"savings\", \"business_checking\", \"credit_card\"])\n\t\t.default(\"checking\"),\n\taccountNumberLast4: z.string().max(4).optional(),\n\tcurrentBalance: z.coerce.number().default(0),\n\tavailableBalance: z.coerce.number().default(0),\n\tautoImportTransactions: z.boolean().default(false),\n\tisActive: z.boolean().default(true),\n\tisPrimary: z.boolean().default(false),\n});\n\nasync function createBankAccount(\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst data = bankAccountSchema.parse({\n\t\t\taccountName: formData.get(\"accountName\"),\n\t\t\tbankName: formData.get(\"bankName\"),\n\t\t\taccountType: formData.get(\"accountType\") || \"checking\",\n\t\t\taccountNumberLast4: formData.get(\"accountNumberLast4\") || undefined,\n\t\t\tcurrentBalance: formData.get(\"currentBalance\") || \"0\",\n\t\t\tavailableBalance: formData.get(\"availableBalance\") || \"0\",\n\t\t\tautoImportTransactions: formData.get(\"autoImportTransactions\") === \"true\",\n\t\t\tisActive: formData.get(\"isActive\") !== \"false\",\n\t\t\tisPrimary: formData.get(\"isPrimary\") === \"true\",\n\t\t});\n\n\t\tconst { error } = await supabase.from(\"finance_bank_accounts\").insert({\n\t\t\tcompany_id: companyId,\n\t\t\taccount_name: data.accountName,\n\t\t\tbank_name: data.bankName,\n\t\t\taccount_type: data.accountType,\n\t\t\taccount_number_last4: data.accountNumberLast4,\n\t\t\tcurrent_balance: data.currentBalance,\n\t\t\tavailable_balance: data.availableBalance,\n\t\t\tauto_import_transactions: data.autoImportTransactions,\n\t\t\tis_active: data.isActive,\n\t\t\tis_primary: data.isPrimary,\n\t\t});\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"create bank account\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/finance/bank-accounts\");\n\t});\n}\n\nasync function updateBankAccount(\n\taccountId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst data = bankAccountSchema.parse({\n\t\t\taccountName: formData.get(\"accountName\"),\n\t\t\tbankName: formData.get(\"bankName\"),\n\t\t\taccountType: formData.get(\"accountType\") || \"checking\",\n\t\t\taccountNumberLast4: formData.get(\"accountNumberLast4\") || undefined,\n\t\t\tcurrentBalance: formData.get(\"currentBalance\") || \"0\",\n\t\t\tavailableBalance: formData.get(\"availableBalance\") || \"0\",\n\t\t\tautoImportTransactions: formData.get(\"autoImportTransactions\") === \"true\",\n\t\t\tisActive: formData.get(\"isActive\") !== \"false\",\n\t\t\tisPrimary: formData.get(\"isPrimary\") === \"true\",\n\t\t});\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"finance_bank_accounts\")\n\t\t\t.update({\n\t\t\t\taccount_name: data.accountName,\n\t\t\t\tbank_name: data.bankName,\n\t\t\t\taccount_type: data.accountType,\n\t\t\t\taccount_number_last4: data.accountNumberLast4,\n\t\t\t\tcurrent_balance: data.currentBalance,\n\t\t\t\tavailable_balance: data.availableBalance,\n\t\t\t\tauto_import_transactions: data.autoImportTransactions,\n\t\t\t\tis_active: data.isActive,\n\t\t\t\tis_primary: data.isPrimary,\n\t\t\t})\n\t\t\t.eq(\"id\", accountId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update bank account\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/finance/bank-accounts\");\n\t});\n}\n\nasync function deleteBankAccount(\n\taccountId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"finance_bank_accounts\")\n\t\t\t.delete()\n\t\t\t.eq(\"id\", accountId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"delete bank account\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/finance/bank-accounts\");\n\t});\n}\n\n/**\n * Get the current user's company ID\n */\nasync function getUserCompanyId(): Promise<ActionResult<string>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\t\treturn companyId;\n\t});\n}\n\nasync function getBankAccounts(): Promise<ActionResult<any[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\t// Get bank accounts with payment processor connections\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"finance_bank_accounts\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        payment_processors:company_payment_processors!bank_account_id(\n          id,\n          processor_type,\n          status\n        )\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"is_primary\", { ascending: false })\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(50);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch bank accounts\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn data || [];\n\t});\n}\n\n/**\n * Get the primary bank account for a company\n */\nasync function getPrimaryBankAccount(): Promise<ActionResult<any>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\t// First try to get primary account\n\t\tconst { data: primaryAccount } = await supabase\n\t\t\t.from(\"finance_bank_accounts\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"is_primary\", true)\n\t\t\t.eq(\"is_active\", true)\n\t\t\t.single();\n\n\t\tif (primaryAccount) {\n\t\t\treturn primaryAccount;\n\t\t}\n\n\t\t// If no primary, get first active account\n\t\tconst { data: activeAccount } = await supabase\n\t\t\t.from(\"finance_bank_accounts\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"is_active\", true)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(1)\n\t\t\t.single();\n\n\t\treturn activeAccount || null;\n\t});\n}\n\n// ============================================================================\n// BUSINESS FINANCING SETTINGS\n// ============================================================================\n\nconst businessFinancingSchema = z.object({\n\tenableBusinessLoans: z.boolean().default(false),\n\tenableLineOfCredit: z.boolean().default(false),\n\tenableEquipmentFinancing: z.boolean().default(false),\n\tfinancingProvider: z.string().optional(),\n\tproviderApiKey: z.string().optional(),\n\tautoCalculateEligibility: z.boolean().default(false),\n\tshowOffersInDashboard: z.boolean().default(true),\n\tannualRevenue: z.coerce.number().optional(),\n\tyearsInBusiness: z.coerce.number().optional(),\n\tbusinessCreditScore: z.coerce.number().min(300).max(850).optional(),\n\tpreferredLoanAmount: z.coerce.number().optional(),\n\tpreferredTermMonths: z.coerce.number().optional(),\n\tmaxAcceptableApr: z.coerce.number().optional(),\n});\n\nasync function updateBusinessFinancingSettings(\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst data = businessFinancingSchema.parse({\n\t\t\tenableBusinessLoans: formData.get(\"enableBusinessLoans\") === \"true\",\n\t\t\tenableLineOfCredit: formData.get(\"enableLineOfCredit\") === \"true\",\n\t\t\tenableEquipmentFinancing:\n\t\t\t\tformData.get(\"enableEquipmentFinancing\") === \"true\",\n\t\t\tfinancingProvider: formData.get(\"financingProvider\") || undefined,\n\t\t\tproviderApiKey: formData.get(\"providerApiKey\") || undefined,\n\t\t\tautoCalculateEligibility:\n\t\t\t\tformData.get(\"autoCalculateEligibility\") === \"true\",\n\t\t\tshowOffersInDashboard: formData.get(\"showOffersInDashboard\") !== \"false\",\n\t\t\tannualRevenue: formData.get(\"annualRevenue\") || undefined,\n\t\t\tyearsInBusiness: formData.get(\"yearsInBusiness\") || undefined,\n\t\t\tbusinessCreditScore: formData.get(\"businessCreditScore\") || undefined,\n\t\t\tpreferredLoanAmount: formData.get(\"preferredLoanAmount\") || undefined,\n\t\t\tpreferredTermMonths: formData.get(\"preferredTermMonths\") || undefined,\n\t\t\tmaxAcceptableApr: formData.get(\"maxAcceptableApr\") || undefined,\n\t\t});\n\n\t\tconst encryptedApiKey = data.providerApiKey\n\t\t\t? Buffer.from(data.providerApiKey).toString(\"base64\")\n\t\t\t: null;\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"finance_business_financing_settings\")\n\t\t\t.upsert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tenable_business_loans: data.enableBusinessLoans,\n\t\t\t\tenable_line_of_credit: data.enableLineOfCredit,\n\t\t\t\tenable_equipment_financing: data.enableEquipmentFinancing,\n\t\t\t\tfinancing_provider: data.financingProvider,\n\t\t\t\tprovider_api_key_encrypted: encryptedApiKey,\n\t\t\t\tauto_calculate_eligibility: data.autoCalculateEligibility,\n\t\t\t\tshow_offers_in_dashboard: data.showOffersInDashboard,\n\t\t\t\tannual_revenue: data.annualRevenue,\n\t\t\t\tyears_in_business: data.yearsInBusiness,\n\t\t\t\tbusiness_credit_score: data.businessCreditScore,\n\t\t\t\tpreferred_loan_amount: data.preferredLoanAmount,\n\t\t\t\tpreferred_term_months: data.preferredTermMonths,\n\t\t\t\tmax_acceptable_apr: data.maxAcceptableApr,\n\t\t\t});\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update business financing settings\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/finance/business-financing\");\n\t});\n}\n\nasync function getBusinessFinancingSettings(): Promise<\n\tActionResult<any>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"finance_business_financing_settings\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error && error.code !== \"PGRST116\") {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch business financing settings\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn data || null;\n\t});\n}\n\n// ============================================================================\n// CONSUMER FINANCING SETTINGS\n// ============================================================================\n\nconst consumerFinancingSchema = z.object({\n\tfinancingEnabled: z.boolean().default(false),\n\tprovider: z\n\t\t.enum([\"affirm\", \"wisetack\", \"greensky\", \"servicefinance\", \"other\"])\n\t\t.optional(),\n\tproviderApiKey: z.string().optional(),\n\tproviderMerchantId: z.string().optional(),\n\tminAmount: z.coerce.number().default(500),\n\tmaxAmount: z.coerce.number().default(25_000),\n\tavailableTerms: z.string().optional(), // Comma-separated numbers\n\tshowInEstimates: z.boolean().default(true),\n\tshowInInvoices: z.boolean().default(true),\n\tshowMonthlyPayment: z.boolean().default(true),\n\tpromoteFinancing: z.boolean().default(true),\n\tallowInstantApproval: z.boolean().default(true),\n\trequireCreditCheck: z.boolean().default(true),\n\tcollectSsn: z.boolean().default(false),\n\tmarketingMessage: z\n\t\t.string()\n\t\t.default(\"Finance your service with flexible payment plans\"),\n});\n\nasync function updateConsumerFinancingSettings(\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst termsStr = formData.get(\"availableTerms\") as string;\n\t\tconst availableTerms = termsStr\n\t\t\t? termsStr.split(\",\").map((term) => Number.parseInt(term.trim(), 10))\n\t\t\t: [6, 12, 24, 36, 48, 60];\n\n\t\tconst data = consumerFinancingSchema.parse({\n\t\t\tfinancingEnabled: formData.get(\"financingEnabled\") === \"true\",\n\t\t\tprovider: formData.get(\"provider\") || undefined,\n\t\t\tproviderApiKey: formData.get(\"providerApiKey\") || undefined,\n\t\t\tproviderMerchantId: formData.get(\"providerMerchantId\") || undefined,\n\t\t\tminAmount: formData.get(\"minAmount\") || \"500\",\n\t\t\tmaxAmount: formData.get(\"maxAmount\") || \"25000\",\n\t\t\tshowInEstimates: formData.get(\"showInEstimates\") !== \"false\",\n\t\t\tshowInInvoices: formData.get(\"showInInvoices\") !== \"false\",\n\t\t\tshowMonthlyPayment: formData.get(\"showMonthlyPayment\") !== \"false\",\n\t\t\tpromoteFinancing: formData.get(\"promoteFinancing\") !== \"false\",\n\t\t\tallowInstantApproval: formData.get(\"allowInstantApproval\") !== \"false\",\n\t\t\trequireCreditCheck: formData.get(\"requireCreditCheck\") !== \"false\",\n\t\t\tcollectSsn: formData.get(\"collectSsn\") === \"true\",\n\t\t\tmarketingMessage:\n\t\t\t\tformData.get(\"marketingMessage\") ||\n\t\t\t\t\"Finance your service with flexible payment plans\",\n\t\t});\n\n\t\tconst encryptedApiKey = data.providerApiKey\n\t\t\t? Buffer.from(data.providerApiKey).toString(\"base64\")\n\t\t\t: null;\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"finance_consumer_financing_settings\")\n\t\t\t.upsert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tfinancing_enabled: data.financingEnabled,\n\t\t\t\tprovider: data.provider,\n\t\t\t\tprovider_api_key_encrypted: encryptedApiKey,\n\t\t\t\tprovider_merchant_id: data.providerMerchantId,\n\t\t\t\tmin_amount: data.minAmount,\n\t\t\t\tmax_amount: data.maxAmount,\n\t\t\t\tavailable_terms: availableTerms,\n\t\t\t\tshow_in_estimates: data.showInEstimates,\n\t\t\t\tshow_in_invoices: data.showInInvoices,\n\t\t\t\tshow_monthly_payment: data.showMonthlyPayment,\n\t\t\t\tpromote_financing: data.promoteFinancing,\n\t\t\t\tallow_instant_approval: data.allowInstantApproval,\n\t\t\t\trequire_credit_check: data.requireCreditCheck,\n\t\t\t\tcollect_ssn: data.collectSsn,\n\t\t\t\tmarketing_message: data.marketingMessage,\n\t\t\t});\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update consumer financing settings\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/finance/consumer-financing\");\n\t});\n}\n\nasync function getConsumerFinancingSettings(): Promise<\n\tActionResult<any>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"finance_consumer_financing_settings\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error && error.code !== \"PGRST116\") {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch consumer financing settings\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn data || null;\n\t});\n}\n\n// ============================================================================\n// DEBIT CARD SETTINGS\n// ============================================================================\n\nasync function getDebitCards(): Promise<ActionResult<any[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"finance_debit_cards\")\n\t\t\t.select(\"*, team_members(name, email)\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(100);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch debit cards\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn data || [];\n\t});\n}\n\n// ============================================================================\n// GAS CARD SETTINGS\n// ============================================================================\n\nasync function getGasCards(): Promise<ActionResult<any[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"finance_gas_cards\")\n\t\t\t.select(\"*, team_members(name, email)\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(100);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch gas cards\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn data || [];\n\t});\n}\n\n// ============================================================================\n// GIFT CARD SETTINGS\n// ============================================================================\n\nconst giftCardSettingsSchema = z.object({\n\tgiftCardsEnabled: z.boolean().default(false),\n\tprogramName: z.string().default(\"Gift Cards\"),\n\tfixedDenominations: z.boolean().default(true),\n\tavailableAmounts: z.string().optional(), // Comma-separated numbers\n\tminCustomAmount: z.coerce.number().default(10),\n\tmaxCustomAmount: z.coerce.number().default(1000),\n\tallowOnlinePurchase: z.boolean().default(true),\n\tallowInPersonPurchase: z.boolean().default(true),\n\trequireRecipientEmail: z.boolean().default(false),\n\tcardsExpire: z.boolean().default(false),\n\texpirationMonths: z.coerce.number().default(24),\n\tsendExpirationReminder: z.boolean().default(true),\n\treminderDaysBefore: z.coerce.number().default(30),\n\tallowPartialRedemption: z.boolean().default(true),\n\tallowMultipleCardsPerTransaction: z.boolean().default(true),\n\tcombineWithOtherDiscounts: z.boolean().default(false),\n\tallowCustomMessage: z.boolean().default(true),\n\tmaxMessageLength: z.coerce.number().default(200),\n\ttrackRedemptionAnalytics: z.boolean().default(true),\n});\n\nasync function updateGiftCardSettings(\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst amountsStr = formData.get(\"availableAmounts\") as string;\n\t\tconst availableAmounts = amountsStr\n\t\t\t? amountsStr.split(\",\").map((amount) => Number.parseFloat(amount.trim()))\n\t\t\t: [25, 50, 100, 250, 500];\n\n\t\tconst data = giftCardSettingsSchema.parse({\n\t\t\tgiftCardsEnabled: formData.get(\"giftCardsEnabled\") === \"true\",\n\t\t\tprogramName: formData.get(\"programName\") || \"Gift Cards\",\n\t\t\tfixedDenominations: formData.get(\"fixedDenominations\") !== \"false\",\n\t\t\tminCustomAmount: formData.get(\"minCustomAmount\") || \"10\",\n\t\t\tmaxCustomAmount: formData.get(\"maxCustomAmount\") || \"1000\",\n\t\t\tallowOnlinePurchase: formData.get(\"allowOnlinePurchase\") !== \"false\",\n\t\t\tallowInPersonPurchase: formData.get(\"allowInPersonPurchase\") !== \"false\",\n\t\t\trequireRecipientEmail: formData.get(\"requireRecipientEmail\") === \"true\",\n\t\t\tcardsExpire: formData.get(\"cardsExpire\") === \"true\",\n\t\t\texpirationMonths: formData.get(\"expirationMonths\") || \"24\",\n\t\t\tsendExpirationReminder:\n\t\t\t\tformData.get(\"sendExpirationReminder\") !== \"false\",\n\t\t\treminderDaysBefore: formData.get(\"reminderDaysBefore\") || \"30\",\n\t\t\tallowPartialRedemption:\n\t\t\t\tformData.get(\"allowPartialRedemption\") !== \"false\",\n\t\t\tallowMultipleCardsPerTransaction:\n\t\t\t\tformData.get(\"allowMultipleCardsPerTransaction\") !== \"false\",\n\t\t\tcombineWithOtherDiscounts:\n\t\t\t\tformData.get(\"combineWithOtherDiscounts\") === \"true\",\n\t\t\tallowCustomMessage: formData.get(\"allowCustomMessage\") !== \"false\",\n\t\t\tmaxMessageLength: formData.get(\"maxMessageLength\") || \"200\",\n\t\t\ttrackRedemptionAnalytics:\n\t\t\t\tformData.get(\"trackRedemptionAnalytics\") !== \"false\",\n\t\t});\n\n\t\tconst { error } = await supabase.from(\"finance_gift_card_settings\").upsert({\n\t\t\tcompany_id: companyId,\n\t\t\tgift_cards_enabled: data.giftCardsEnabled,\n\t\t\tprogram_name: data.programName,\n\t\t\tfixed_denominations: data.fixedDenominations,\n\t\t\tavailable_amounts: availableAmounts,\n\t\t\tmin_custom_amount: data.minCustomAmount,\n\t\t\tmax_custom_amount: data.maxCustomAmount,\n\t\t\tallow_online_purchase: data.allowOnlinePurchase,\n\t\t\tallow_in_person_purchase: data.allowInPersonPurchase,\n\t\t\trequire_recipient_email: data.requireRecipientEmail,\n\t\t\tcards_expire: data.cardsExpire,\n\t\t\texpiration_months: data.expirationMonths,\n\t\t\tsend_expiration_reminder: data.sendExpirationReminder,\n\t\t\treminder_days_before: data.reminderDaysBefore,\n\t\t\tallow_partial_redemption: data.allowPartialRedemption,\n\t\t\tallow_multiple_cards_per_transaction:\n\t\t\t\tdata.allowMultipleCardsPerTransaction,\n\t\t\tcombine_with_other_discounts: data.combineWithOtherDiscounts,\n\t\t\tallow_custom_message: data.allowCustomMessage,\n\t\t\tmax_message_length: data.maxMessageLength,\n\t\t\ttrack_redemption_analytics: data.trackRedemptionAnalytics,\n\t\t});\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update gift card settings\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/finance/gift-cards\");\n\t});\n}\n\nasync function getGiftCardSettings(): Promise<ActionResult<any>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"finance_gift_card_settings\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error && error.code !== \"PGRST116\") {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch gift card settings\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn data || null;\n\t});\n}\n\n// ============================================================================\n// VIRTUAL BUCKET SETTINGS\n// ============================================================================\n\nconst virtualBucketSettingsSchema = z.object({\n\tvirtualBucketsEnabled: z.boolean().default(false),\n\tautoAllocateFunds: z.boolean().default(false),\n\tallocationFrequency: z\n\t\t.enum([\"daily\", \"weekly\", \"biweekly\", \"monthly\"])\n\t\t.default(\"weekly\"),\n\toperatingExpensesPercentage: z.coerce.number().default(50),\n\ttaxReservePercentage: z.coerce.number().default(25),\n\tprofitPercentage: z.coerce.number().default(15),\n\temergencyFundPercentage: z.coerce.number().default(10),\n\tminOperatingBalance: z.coerce.number().default(5000),\n\temergencyFundTarget: z.coerce.number().default(10_000),\n\tnotifyLowBalance: z.boolean().default(true),\n\tlowBalanceThreshold: z.coerce.number().default(1000),\n\tnotifyBucketGoalsMet: z.boolean().default(true),\n});\n\nasync function updateVirtualBucketSettings(\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst data = virtualBucketSettingsSchema.parse({\n\t\t\tvirtualBucketsEnabled: formData.get(\"virtualBucketsEnabled\") === \"true\",\n\t\t\tautoAllocateFunds: formData.get(\"autoAllocateFunds\") === \"true\",\n\t\t\tallocationFrequency: formData.get(\"allocationFrequency\") || \"weekly\",\n\t\t\toperatingExpensesPercentage:\n\t\t\t\tformData.get(\"operatingExpensesPercentage\") || \"50\",\n\t\t\ttaxReservePercentage: formData.get(\"taxReservePercentage\") || \"25\",\n\t\t\tprofitPercentage: formData.get(\"profitPercentage\") || \"15\",\n\t\t\temergencyFundPercentage: formData.get(\"emergencyFundPercentage\") || \"10\",\n\t\t\tminOperatingBalance: formData.get(\"minOperatingBalance\") || \"5000\",\n\t\t\temergencyFundTarget: formData.get(\"emergencyFundTarget\") || \"10000\",\n\t\t\tnotifyLowBalance: formData.get(\"notifyLowBalance\") !== \"false\",\n\t\t\tlowBalanceThreshold: formData.get(\"lowBalanceThreshold\") || \"1000\",\n\t\t\tnotifyBucketGoalsMet: formData.get(\"notifyBucketGoalsMet\") !== \"false\",\n\t\t});\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"finance_virtual_bucket_settings\")\n\t\t\t.upsert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tvirtual_buckets_enabled: data.virtualBucketsEnabled,\n\t\t\t\tauto_allocate_funds: data.autoAllocateFunds,\n\t\t\t\tallocation_frequency: data.allocationFrequency,\n\t\t\t\toperating_expenses_percentage: data.operatingExpensesPercentage,\n\t\t\t\ttax_reserve_percentage: data.taxReservePercentage,\n\t\t\t\tprofit_percentage: data.profitPercentage,\n\t\t\t\temergency_fund_percentage: data.emergencyFundPercentage,\n\t\t\t\tmin_operating_balance: data.minOperatingBalance,\n\t\t\t\temergency_fund_target: data.emergencyFundTarget,\n\t\t\t\tnotify_low_balance: data.notifyLowBalance,\n\t\t\t\tlow_balance_threshold: data.lowBalanceThreshold,\n\t\t\t\tnotify_bucket_goals_met: data.notifyBucketGoalsMet,\n\t\t\t});\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update virtual bucket settings\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/finance/virtual-buckets\");\n\t});\n}\n\nasync function getVirtualBucketSettings(): Promise<ActionResult<any>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"finance_virtual_bucket_settings\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error && error.code !== \"PGRST116\") {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch virtual bucket settings\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn data || null;\n\t});\n}\n\nasync function getVirtualBuckets(): Promise<ActionResult<any[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getCompanyId(supabase, user.id);\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"finance_virtual_buckets\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"display_order\", { ascending: true })\n\t\t\t.limit(50);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch virtual buckets\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn data || [];\n\t});\n}\n","export {getCurrentUserRole as '001f005176797ef23488068124fb9a744915a477de'} from 'ACTIONS_MODULE0'\nexport {canDeleteTeamMember as '406f6624261c6dd1a908026fa1408a3f6d507b6e7d'} from 'ACTIONS_MODULE0'\nexport {getPayrixMerchantAccount as '40704f0e856ad801ef93b43436f219a36f7c0efd2c'} from 'ACTIONS_MODULE1'\nexport {getWebRTCCredentials as '000478fbf5363dae5000d525663da13e29908cb952'} from 'ACTIONS_MODULE2'\nexport {transcribeCallRecording as '4002f454c46f4c21ca6e9e26362583ccff69c9f914'} from 'ACTIONS_MODULE2'\nexport {getCompanyPhoneNumbers as '4019cf9f81eb3c06f82b5c2f8eb042f3d95d91e933'} from 'ACTIONS_MODULE2'\nexport {getCallRoutingRules as '40247c617842c31b242455a0961cbd2c3297606a16'} from 'ACTIONS_MODULE2'\nexport {updateCallRoutingRule as '40413bfa888916480edbc33ebb812158fddf960f89'} from 'ACTIONS_MODULE2'\nexport {startCallRecording as '404e47931374ad2a1b54bc11f357703790f6104530'} from 'ACTIONS_MODULE2'\nexport {transferActiveCall as '405a16958f97c37bd4b5711bd8761510bdab55839f'} from 'ACTIONS_MODULE2'\nexport {searchPhoneNumbers as '406864ae05b8b51c66cc2c335999e5011a41cb521f'} from 'ACTIONS_MODULE2'\nexport {makeCall as '40b2df540ec465c5dc19545c96486485bb50b5633b'} from 'ACTIONS_MODULE2'\nexport {sendTextMessage as '40d050abdabe2ee7293436c505c5f27b4408a2f27c'} from 'ACTIONS_MODULE2'\nexport {stopCallRecording as '40d5cc291162e2fd61245bdb851d5e8ed609e4ed19'} from 'ACTIONS_MODULE2'\nexport {sendMMSMessage as '40edd91786b2a482e617fb16f2474d26ec295435e7'} from 'ACTIONS_MODULE2'\nexport {purchasePhoneNumber as '40fd6a80b32792fab749933f98f07503d8e94c0305'} from 'ACTIONS_MODULE2'\nexport {deleteCallRoutingRule as '607d0f958daf66b2a0d5277cdda17600dace5156bb'} from 'ACTIONS_MODULE2'\nexport {toggleCallRoutingRule as '60853f1e409364f7e171e27229217994ff224414e6'} from 'ACTIONS_MODULE2'\nexport {createServiceSupabaseClient as '00a13dbd00149949fc1367d3e76ae7d789e07f5321'} from 'ACTIONS_MODULE3'\nexport {ensureMessagingBranding as '606753f8910b46d5792f4bdeb457cdf29d1a8bbadc'} from 'ACTIONS_MODULE4'\nexport {ensureMessagingCampaign as '70a648f43fa62ae3dcf2070eb90413e96e81591e77'} from 'ACTIONS_MODULE4'\nexport {checkTelnyxVerificationStatus as '007505a78985e53e083a498c97761ed8a463d3d379'} from 'ACTIONS_MODULE5'\nexport {submitAutomatedVerification as '4087f0badccd6aaf6a28b640ab4bbc513f0832d105'} from 'ACTIONS_MODULE5'\nexport {registerCompanyFor10DLC as '40ae25402a089e45aa071d979e8cc6ad136205cc98'} from 'ACTIONS_MODULE5'\nexport {sendVerificationSubmittedEmail as '70f58c5ba46ef02b620d7dc87bae8fc83f6d480755'} from 'ACTIONS_MODULE6'\nexport {sendEmail as '40f8c061cf84f884e77af3425bc24b8a8d72f598fb'} from 'ACTIONS_MODULE7'\nexport {handleComplaintWebhook as '6045f8436f9cdfdadb7bfe3955677adfc5f4102de0'} from 'ACTIONS_MODULE7'\nexport {handleBounceWebhook as '78a8ea4f1cfa571a366adccf36ac04b1c85d61ae2b'} from 'ACTIONS_MODULE7'\nexport {runHealthCheckForAllDomains as '00c53a1f02416c3261983f8096f19a3450bfd51775'} from 'ACTIONS_MODULE8'\nexport {getDomainHealth as '400b8fb96146bfd004a3166563a5ab5536bb610c70'} from 'ACTIONS_MODULE8'\nexport {recordDeliveryEvent as '404d6f2891af89c71d5bde33d110a216bdd3ee4729'} from 'ACTIONS_MODULE8'\nexport {getCompanyDomainsHealth as '405c57a8fed352b8679525b56014eb8c49105c850c'} from 'ACTIONS_MODULE8'\nexport {processResendWebhookEvent as '40ad037af6f6ab1a3004746d3a1b65afa65527002d'} from 'ACTIONS_MODULE8'\nexport {generateDeliverabilityReport as '40ecf2c792e84ef4b898fda98ec27277b4a9dddef2'} from 'ACTIONS_MODULE8'\nexport {resetHourlyCounters as '004cdde5e6ae8991bab4ba61ae40647c2b823200ba'} from 'ACTIONS_MODULE9'\nexport {resetDailyCounters as '006acf41615a2f7795c47b6d7a3016e18300f2ad17'} from 'ACTIONS_MODULE9'\nexport {incrementEmailCounter as '4029b163c1c0acfd806352a72fe8030c8ae4f7f8ac'} from 'ACTIONS_MODULE9'\nexport {getCompanyActiveDomain as '407a5a7d0a7dd7989a963eb2485a3527c1dcb20a70'} from 'ACTIONS_MODULE9'\nexport {checkRateLimit as '40af86a915f04df8d7cc189fe26e45e0cc24663080'} from 'ACTIONS_MODULE9'\nexport {isGmailIntegrationEnabled as '00fe74bdf14126b5ad89e9480e82978d6357f356b3'} from 'ACTIONS_MODULE10'\nexport {getUserGmailTokens as '400ce95360aaffa14a99dfdf969ba5166c69a59eb6'} from 'ACTIONS_MODULE10'\nexport {disconnectCompanyGmail as '401d3d830065dd7c4777fad67f642392f48735c4ab'} from 'ACTIONS_MODULE10'\nexport {disconnectUserGmail as '404575d602ef4c60c0058b592b8c3e42fbcd13fc4c'} from 'ACTIONS_MODULE10'\nexport {getCompanyEmailProvider as '40787b1598849126560f9f0b0f8fe8967338c7bf28'} from 'ACTIONS_MODULE10'\nexport {getCompanyGmailTokens as '40beeb56302a20d27cd8ba7a0988310f855633d7e6'} from 'ACTIONS_MODULE10'\nexport {refreshUserGmailToken as '602fab67313b110e6ccb66e54b1e16450b2a772cc7'} from 'ACTIONS_MODULE10'\nexport {sendCompanyGmailEmail as '60302947fc4caffa53a719728f3c2cebace926098c'} from 'ACTIONS_MODULE10'\nexport {syncUserInbox as '603643b13bf288cc628303bb4d12df0311b11434c7'} from 'ACTIONS_MODULE10'\nexport {checkCompanyGmailHealth as '60856182db5eaec7f85eda2a5a94c5d7d3524325d6'} from 'ACTIONS_MODULE10'\nexport {refreshCompanyGmailToken as '60eeb51685ac265a4ad793a230a515fe6e462f16f4'} from 'ACTIONS_MODULE10'\nexport {fetchUserInbox as '708daa303e36e37247e22b5b828b6aad8c73ac283b'} from 'ACTIONS_MODULE10'\nexport {setCompanyEmailProvider as '70dd3bc4222a87350dc137fa9cbcb849fa1913b397'} from 'ACTIONS_MODULE10'\nexport {storeGmailMessage as '78d41ef818e75fef94d65a87ea1f0faf418132e3c5'} from 'ACTIONS_MODULE10'\nexport {storeUserGmailTokens as '7e3a356960ddd52a3fa4dc6d981ae7202a59eb9a3d'} from 'ACTIONS_MODULE10'\nexport {storeCompanyGmailTokens as '7f06df826c4fff42950e712c0f548254e275be2a52'} from 'ACTIONS_MODULE10'\nexport {getProviderHealthDashboard as '00a122f9d5fe3a1603c636c3a251886129b66154f8'} from 'ACTIONS_MODULE11'\nexport {checkProviderAlert as '40c7885bdc4fe4cdd5f57e78579230c58088adbef4'} from 'ACTIONS_MODULE11'\nexport {cleanupOldEvents as '40d3c4ceeaee653aa257a28ed429a7fd272fa9fb66'} from 'ACTIONS_MODULE11'\nexport {recordProviderEvent as '40e06418f4b93b40c84a25511e0468e1e8a41ddecf'} from 'ACTIONS_MODULE11'\nexport {getProviderStats as '60c643a41ce1a8e6cc8338da6e2f3678c386910460'} from 'ACTIONS_MODULE11'\nexport {recordSendFailure as '78255c3fa8c9facf7c3f353202f2907836e8eb5539'} from 'ACTIONS_MODULE11'\nexport {recordSendSuccess as '783861d25688b32ba086bbe9e45444975c36a1b285'} from 'ACTIONS_MODULE11'\nexport {recordFallbackTriggered as '78766431b437b16f7cb00b4d64a2f3be5e092ed724'} from 'ACTIONS_MODULE11'\nexport {deleteNotification as '40fab1894acc5e3d1fdd8d8c6128a7cecee06e7e6a'} from 'ACTIONS_MODULE12'\nexport {markAllAsRead as '00cf212b0097820096122537beac12e3403b97d564'} from 'ACTIONS_MODULE12'\nexport {markAsRead as '4094cf679b4a10ca0f969f4fc1b55602aac4e0fbc3'} from 'ACTIONS_MODULE12'\nexport {makeCall as '40b2df540ec465c5dc19545c96486485bb50b5633b'} from 'ACTIONS_MODULE2'\nexport {getWebRTCCredentials as '000478fbf5363dae5000d525663da13e29908cb952'} from 'ACTIONS_MODULE2'\nexport {signOut as '0043ae510c3322ea499beb9e1bb77d06afb4ef19bd'} from 'ACTIONS_MODULE13'\nexport {switchCompany as '4097c3c574342661f9a3c8244961d001234449f36f'} from 'ACTIONS_MODULE14'\nexport {updateUserStatus as '4081009dd4dff14ff4ece62648bad23a83f2f9f63c'} from 'ACTIONS_MODULE15'\nexport {getTotalUnreadCountAction as '00ebc03a4ffc993aea7ec2e541686105c2bace2437'} from 'ACTIONS_MODULE16'\nexport {getCompanyPendingActions as '40e9589cb639f2902eb841bedc1247d966486d6fd7'} from 'ACTIONS_MODULE17'\nexport {checkIsCompanyOwner as '001be5cf82b793f19f6a7d010c91c14577fa7a130d'} from 'ACTIONS_MODULE17'\nexport {getCustomerByPhone as '6013add076e3eaed7dc37e8b800ce977d5abb8d49a'} from 'ACTIONS_MODULE18'\nexport {startCallRecording as '404e47931374ad2a1b54bc11f357703790f6104530'} from 'ACTIONS_MODULE2'\nexport {stopCallRecording as '40d5cc291162e2fd61245bdb851d5e8ed609e4ed19'} from 'ACTIONS_MODULE2'\nexport {deleteCustomer as '4082b52123c24a95685a53c36313418a95c259c65b'} from 'ACTIONS_MODULE18'\nexport {searchCustomers as '60193685409a9d118f1b364e14ecf57d05fa5638a9'} from 'ACTIONS_MODULE18'\nexport {getCustomersForDialer as '0077abd0cb1e555f91adaa482ad0b2f565bbd0629a'} from 'ACTIONS_MODULE18'\nexport {getPendingSupportSessions as '000f90f949d6a2f5484d061d5a738a59a8c846aeaa'} from 'ACTIONS_MODULE19'\nexport {getActiveSupportSessions as '00665c1bbcd52d612d5bb4bf3be5e7fc75554132e6'} from 'ACTIONS_MODULE19'\nexport {approveSupportSessionRequest as '602e89ae7ace85fc30cd3b4b1dd865d517c0cb1cd5'} from 'ACTIONS_MODULE19'\nexport {rejectSupportSessionRequest as '60886af124323873afd4d5b64bb4143abbcba2c154'} from 'ACTIONS_MODULE19'\nexport {endActiveSupportSession as '40369e8ea4eced7bdaef8203d369469ee7b630db8c'} from 'ACTIONS_MODULE19'\nexport {createEmailFolderAction as '408d3694fd0dd48e424f53c9bf5083b946ab3ec990'} from 'ACTIONS_MODULE20'\nexport {getEmailFolderCountsAction as '009e962eae57bf128b2023081fd7259048edd8884a'} from 'ACTIONS_MODULE16'\nexport {getEmailFoldersAction as '00235a0ba91f1ba226f33fa40dcf4c93a2c3548c70'} from 'ACTIONS_MODULE20'\nexport {deleteEmailFolderAction as '40c55f8e0922f2c7fd8d502e4c75395bf5f0470430'} from 'ACTIONS_MODULE20'\nexport {searchVendors as '404a3266e0319dbd8c24fec80bb69ecfe029d2a768'} from 'ACTIONS_MODULE21'\nexport {getSmsFolderCountsAction as '0006f7bd89b72f0836ec7bf4db73019f1b32e6c24a'} from 'ACTIONS_MODULE22'\nexport {getAccountingSettings as '003f6ed399054a0791fd9f0d0113a86aa4e90e57ff'} from 'ACTIONS_MODULE23'\nexport {updateAccountingSettings as '40f22259ba699198ced1c1ac73a5468a60a1387aaa'} from 'ACTIONS_MODULE23'\n"],"names":[],"mappings":"wCAKC,IAAA,EAAA,EAAA,CAAA,CAAA,QAID,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAKA,EAAA,EAAA,CAAA,CAAA,QAKA,EAAA,EAAA,CAAA,CAAA,sBAMA,eAAe,EAAa,CAAa,CAAE,CAAc,EACxD,GAAM,CAAE,KAAM,CAAU,CAAE,CAAG,MAAM,EACjC,IAAI,CAAC,uBACL,MAAM,CAAC,cACP,EAAE,CAAC,UAAW,GACd,EAAE,CAAC,SAAU,UACb,MAAM,GAER,GAAI,CAAC,GAAY,WAChB,CAD4B,KACtB,IAAI,EAAA,WAAW,CACpB,gCACA,EAAA,WAAW,CAAC,cAAc,CAC1B,KAIF,OAAO,EAAW,UAAU,AAC7B,CAMA,IAAM,EAA2B,EAAA,CAAC,CAAC,MAAM,CAAC,CACzC,SAAU,EAAA,CAAC,CACT,IAAI,CAAC,CAAC,aAAc,OAAQ,OAAQ,aAAc,SAAU,OAAO,EACnE,QAAQ,GACV,gBAAiB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACrC,OAAQ,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GAC3B,UAAW,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GAC9B,gBAAiB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACrC,cAAe,EAAA,CAAC,CACd,IAAI,CAAC,CAAC,WAAY,SAAU,QAAS,SAAU,SAAS,EACxD,OAAO,CAAC,SACV,cAAe,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GAClC,eAAgB,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GACnC,aAAc,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GACjC,iBAAkB,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GACrC,aAAc,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAClC,aAAc,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAClC,aAAc,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAClC,cAAe,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,CAAC,GACpC,GAEO,eAAe,EACrB,CAAkB,EAElB,MAAO,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,UACxB,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IACnC,GAAI,CAAC,EACJ,MAAM,EADQ,EACJ,EAAA,WAAW,CACpB,6BACA,EAAA,WAAW,CAAC,mBAAmB,EAIjC,GAAM,CACL,KAAM,MAAE,CAAI,CAAE,CACd,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAC/B,CAAA,EAAA,EAAA,mBAAA,AAAmB,EAAC,GAAM,IAE1B,IAAM,EAAY,MAAM,EAAa,EAAU,EAAK,EAAE,EAEhD,EAAO,EAAyB,KAAK,CAAC,CAC3C,SAAU,EAAS,GAAG,CAAC,kBAAe,EACtC,gBAAqD,SAApC,EAAS,GAAG,CAAC,mBAC9B,OAAQ,EAAS,GAAG,CAAC,gBAAa,EAClC,UAAW,EAAS,GAAG,CAAC,mBAAgB,EACxC,gBAAqD,AAApC,WAAS,GAAG,CAAC,mBAC9B,cAAe,EAAS,GAAG,CAAC,kBAAoB,QAChD,cAAe,EAAS,GAAG,CAAC,uBAAoB,EAChD,eAAgB,EAAS,GAAG,CAAC,wBAAqB,EAClD,aAAc,EAAS,GAAG,CAAC,sBAAmB,EAC9C,iBAAkB,EAAS,GAAG,CAAC,0BAAuB,EACtD,aAA+C,UAAjC,EAAS,GAAG,CAAC,gBAC3B,aAA+C,UAAjC,EAAS,GAAG,CAAC,gBAC3B,aAA+C,UAAjC,EAAS,GAAG,CAAC,gBAC3B,cAAiD,UAAlC,EAAS,GAAG,CAAC,gBAC7B,GAGM,EAAkB,EAAK,MAAM,CAChC,OAAO,IAAI,CAAC,EAAK,MAAM,EAAE,QAAQ,CAAC,UAClC,KACG,EAAqB,EAAK,SAAS,CACtC,OAAO,IAAI,CAAC,EAAK,SAAS,EAAE,QAAQ,CAAC,UACrC,KAEG,OAAE,CAAK,CAAE,CAAG,MAAM,EACtB,IAAI,CAAC,+BACL,MAAM,CAAC,CACP,WAAY,EACZ,SAAU,EAAK,QAAQ,CACvB,iBAAkB,EAAK,eAAe,CACtC,kBAAmB,EACnB,qBAAsB,EACtB,kBAAmB,EAAK,eAAe,CACvC,eAAgB,EAAK,aAAa,CAClC,eAAgB,EAAK,aAAa,CAClC,gBAAiB,EAAK,cAAc,CACpC,cAAe,EAAK,YAAY,CAChC,kBAAmB,EAAK,gBAAgB,CACxC,cAAe,EAAK,YAAY,CAChC,cAAe,EAAK,YAAY,CAChC,cAAe,EAAK,YAAY,CAChC,eAAgB,EAAK,aAAa,AACnC,GAED,GAAI,EACH,KADU,CACJ,IAAI,EAAA,WAAW,CACpB,EAAA,cAAc,CAAC,eAAe,CAAC,8BAC/B,EAAA,WAAW,CAAC,cAAc,EAI5B,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,yCAChB,EACD,CAEO,eAAe,IACrB,MAAO,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,UACxB,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IACnC,GAAI,CAAC,EACJ,MAAM,EADQ,EACJ,EAAA,WAAW,CACpB,6BACA,EAAA,WAAW,CAAC,mBAAmB,EAIjC,GAAM,CACL,KAAM,MAAE,CAAI,CAAE,CACd,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAC/B,CAAA,EAAA,EAAA,mBAAA,AAAmB,EAAC,GAAM,IAE1B,IAAM,EAAY,MAAM,EAAa,EAAU,EAAK,EAAE,EAEhD,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAC5B,IAAI,CAAC,+BACL,MAAM,CAAC,KACP,EAAE,CAAC,aAAc,GACjB,MAAM,GAER,GAAI,GAAwB,YAAY,CAA3B,EAAM,IAAI,CACtB,MAAM,IAAI,EAAA,WAAW,CACpB,EAAA,cAAc,CAAC,eAAe,CAAC,6BAC/B,EAAA,WAAW,CAAC,cAAc,EAI5B,OAAO,GAAQ,IAChB,EACD,CAMkC,EAAA,CAAC,CAAC,MAAM,CAAC,CAC1C,2BAA4B,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAChD,sBAAuB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAC3C,oBAAqB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACzC,sBAAuB,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,CAAC,mBAC1C,uBAAwB,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,CAAC,sBAC3C,mBAAoB,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,CAAC,aACvC,gBAAiB,EAAA,CAAC,CAChB,IAAI,CAAC,CAAC,SAAU,UAAW,YAAa,SAAS,EACjD,OAAO,CAAC,WACV,aAAc,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAClC,iBAAkB,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GACrC,qBAAsB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,IAAI,OAAO,CAAC,GAC/D,mBAAoB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,IAAI,OAAO,CAAC,GAC7D,yBAA0B,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAC9C,0BAA2B,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,EAChD,GAkH0B,EAAA,CAAC,CAAC,MAAM,CAAC,CAClC,YAAa,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,CAAC,EAAG,4BAC/B,SAAU,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,CAAC,EAAG,yBAC5B,YAAa,EAAA,CAAC,CACZ,IAAI,CAAC,CAAC,WAAY,UAAW,oBAAqB,cAAc,EAChE,OAAO,CAAC,YACV,mBAAoB,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,QAAQ,GAC9C,eAAgB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,GAC1C,iBAAkB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,GAC5C,uBAAwB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAC5C,SAAU,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAC9B,UAAW,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,EAChC,GAgRgC,EAAA,CAAC,CAAC,MAAM,CAAC,CACxC,oBAAqB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACzC,mBAAoB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACxC,yBAA0B,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAC9C,kBAAmB,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GACtC,eAAgB,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GACnC,yBAA0B,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAC9C,sBAAuB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAC3C,cAAe,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,QAAQ,GACzC,gBAAiB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,QAAQ,GAC3C,oBAAqB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,GAAG,CAAC,KAAK,GAAG,CAAC,KAAK,QAAQ,GACjE,oBAAqB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,QAAQ,GAC/C,oBAAqB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,QAAQ,GAC/C,iBAAkB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,QAAQ,EAC7C,GAiHgC,EAAA,CAAC,CAAC,MAAM,CAAC,CACxC,iBAAkB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACtC,SAAU,EAAA,CAAC,CACT,IAAI,CAAC,CAAC,SAAU,WAAY,WAAY,iBAAkB,QAAQ,EAClE,QAAQ,GACV,eAAgB,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GACnC,mBAAoB,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GACvC,UAAW,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,KACrC,UAAW,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,MACrC,eAAgB,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GACnC,gBAAiB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACrC,eAAgB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACpC,mBAAoB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACxC,iBAAkB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACtC,qBAAsB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,CAAC,IAC1C,mBAAoB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACxC,WAAY,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAChC,iBAAkB,EAAA,CAAC,CACjB,MAAM,GACN,OAAO,CAAC,mDACX,GAuM+B,EAAA,CAAC,CAAC,MAAM,CAAC,CACvC,iBAAkB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACtC,YAAa,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,CAAC,cAChC,mBAAoB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACxC,iBAAkB,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GACrC,gBAAiB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,IAC3C,gBAAiB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,KAC3C,oBAAqB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACzC,sBAAuB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAC3C,sBAAuB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAC3C,YAAa,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACjC,iBAAkB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,IAC5C,uBAAwB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAC5C,mBAAoB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,IAC9C,uBAAwB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,CAAC,IAC5C,iCAAkC,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACtD,0BAA2B,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAC/C,mBAAoB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACxC,iBAAkB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,KAC5C,yBAA0B,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,EAC/C,GA6HoC,EAAA,CAAC,CAAC,MAAM,CAAC,CAC5C,sBAAuB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GAC3C,kBAAmB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,GACvC,oBAAqB,EAAA,CAAC,CACpB,IAAI,CAAC,CAAC,QAAS,SAAU,WAAY,UAAU,EAC/C,OAAO,CAAC,UACV,4BAA6B,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,IACvD,qBAAsB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,IAChD,iBAAkB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,IAC5C,wBAAyB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,IACnD,oBAAqB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,KAC/C,oBAAqB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,KAC/C,iBAAkB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,CAAC,IACtC,oBAAqB,EAAA,CAAC,CAAC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC,KAC/C,qBAAsB,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,EAC3C,mCAzgCsB,EA2EA,IA3EA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA2EA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,4GClJtB,EAAA,CAAA,CAAA,QAEA,EAAA,CAAA,CAAA,QACA,EAAA,CAAA,CAAA,QAeA,EAAA,CAAA,CAAA,QACA,EAAA,CAAA,CAAA,OAEA,IAAA,EAAA,EAAA,CAAA,CAAA,QAGA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAGA,EAAA,CAAA,CAAA,QAMA,EAAA,CAAA,CAAA,QAKA,EAAA,CAAA,CAAA,QAgBA,EAAA,CAAA,CAAA,QAQA,EAAA,CAAA,CAAA,QAKA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,CAAA,CAAA,QACA,EAAA,CAAA,CAAA,QACA,EAAA,CAAA,CAAA,QACA,EAAA,CAAA,CAAA,QAEA,IAAA,EAAA,EAAA,CAAA,CAAA,QAMA,EAAA,CAAA,CAAA,QAKA,EAAA,CAAA,CAAA,QAIA,EAAA,CAAA,CAAA,QACA,EAAA,CAAA,CAAA,QACA,EAAA,CAAA,CAAA"}