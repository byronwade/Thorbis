module.exports=[514538,a=>a.a(async(b,c)=>{try{var d=a.i(780195),e=a.i(218188),f=a.i(146057),g=a.i(818944),h=a.i(974406),i=a.i(136874),j=a.i(873212),k=a.i(395731),l=b([j]);[j]=l.then?(await l)():l;let r=f.z.object({description:f.z.string().min(1,"Description is required"),quantity:f.z.number().min(.01,"Quantity must be greater than 0"),unitPrice:f.z.number().min(0,"Price must be positive"),total:f.z.number().min(0,"Total must be positive")});async function m(a,b){let{data:c}=await a.from("company_memberships").select("company_id").eq("user_id",b).single();if(!c?.company_id)throw new g.ActionError("You must be part of a company",g.ERROR_CODES.AUTH_FORBIDDEN,403);return c.company_id}async function n(a,b){return(0,h.withErrorHandling)(async()=>{let c=await (0,i.createClient)();if(!c)throw new g.ActionError("Database connection failed",g.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:d}}=await c.auth.getUser();(0,h.assertAuthenticated)(d?.id);let f=await m(c,d.id);if(!["draft","sent","viewed","accepted","rejected","expired"].includes(b))throw new g.ActionError("Invalid estimate status",g.ERROR_CODES.VALIDATION_FAILED);let{data:j}=await c.from("estimates").select("company_id, status, valid_until").eq("id",a).single();if((0,h.assertExists)(j,"Estimate"),j.company_id!==f)throw new g.ActionError(g.ERROR_MESSAGES.forbidden("estimate"),g.ERROR_CODES.AUTH_FORBIDDEN,403);let k={status:b};"sent"===b&&"draft"===j.status?k.sent_at=new Date().toISOString():"viewed"!==b||j.status.includes("viewed")?"accepted"===b?k.accepted_at=new Date().toISOString():"rejected"===b&&(k.rejected_at=new Date().toISOString()):k.viewed_at=new Date().toISOString();let{error:l}=await c.from("estimates").update(k).eq("id",a);if(l)throw new g.ActionError(g.ERROR_MESSAGES.operationFailed("update estimate status"),g.ERROR_CODES.DB_QUERY_ERROR);(0,e.revalidatePath)("/dashboard/work/estimates"),(0,e.revalidatePath)(`/dashboard/work/estimates/${a}`)})}async function o(a){return(0,h.withErrorHandling)(async()=>{let b=await (0,i.createClient)();if(!b)throw new g.ActionError("Database connection failed",g.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:c}}=await b.auth.getUser();(0,h.assertAuthenticated)(c?.id);let d=await m(b,c.id),{data:f}=await b.from("estimates").select("company_id, status").eq("id",a).single();if((0,h.assertExists)(f,"Estimate"),f.company_id!==d)throw new g.ActionError(g.ERROR_MESSAGES.forbidden("estimate"),g.ERROR_CODES.AUTH_FORBIDDEN,403);if("accepted"===f.status)throw new g.ActionError("Cannot archive accepted estimates. Accepted estimates must be retained for records.",g.ERROR_CODES.OPERATION_NOT_ALLOWED);let j=new Date().toISOString(),k=new Date(Date.now()+7776e6).toISOString(),{error:l}=await b.from("estimates").update({deleted_at:j,deleted_by:c.id,archived_at:j,permanent_delete_scheduled_at:k,status:"archived"}).eq("id",a);if(l)throw new g.ActionError(g.ERROR_MESSAGES.operationFailed("archive estimate"),g.ERROR_CODES.DB_QUERY_ERROR);(0,e.revalidatePath)("/dashboard/work/estimates"),(0,e.revalidatePath)("/dashboard/settings/archive")})}async function p(a){return(0,h.withErrorHandling)(async()=>{let b=await (0,i.createClient)();(0,h.assertSupabase)(b);let{data:c,error:d}=await b.from("estimates").select("id, job_id").eq("id",a).single();if(d||!c)throw new g.ActionError("Estimate not found",g.ERROR_CODES.DB_RECORD_NOT_FOUND);let f=c.job_id,{error:j}=await b.from("estimates").update({job_id:null}).eq("id",a);if(j)throw new g.ActionError("Failed to unlink estimate from job",g.ERROR_CODES.DB_QUERY_ERROR);(0,e.revalidatePath)(`/dashboard/work/estimates/${a}`),f&&(0,e.revalidatePath)(`/dashboard/work/${f}`),(0,e.revalidatePath)("/dashboard/work/estimates")})}async function q(a){return p(a)}f.z.object({customerId:f.z.string().uuid("Invalid customer ID"),propertyId:f.z.string().uuid("Invalid property ID").optional(),title:f.z.string().min(1,"Estimate title is required"),description:f.z.string().optional(),lineItems:f.z.array(r).min(1,"At least one line item is required"),taxRate:f.z.number().min(0).max(100).default(0),discountAmount:f.z.number().min(0).default(0),validDays:f.z.number().min(1).default(30),terms:f.z.string().optional(),notes:f.z.string().optional()}),f.z.object({title:f.z.string().min(1,"Estimate title is required").optional(),description:f.z.string().optional(),lineItems:f.z.array(r).optional(),taxRate:f.z.number().min(0).max(100).optional(),discountAmount:f.z.number().min(0).optional(),validDays:f.z.number().min(1).optional(),terms:f.z.string().optional(),notes:f.z.string().optional()}),(0,k.ensureServerEntryExports)([n,o,p,q]),(0,d.registerServerReference)(n,"6000f461c4ec361bbe70ae10ea940e9db4c5798bfc",null),(0,d.registerServerReference)(o,"406b96a90e525337bc8522ebd4b0b30d951ffa0c17",null),(0,d.registerServerReference)(p,"4061ad6aee59095b67c5dee4f0d9181255804795d7",null),(0,d.registerServerReference)(q,"40fa084fd200f8c2f4706e6c4b30b1e09394bb294d",null),a.s(["archiveEstimate",()=>o,"unlinkEstimateFromJob",()=>p,"unlinkJobFromEstimate",()=>q,"updateEstimateStatus",()=>n]),c()}catch(a){c(a)}},!1)];

//# sourceMappingURL=apps_web_src_actions_estimates_ts_264439e5._.js.map