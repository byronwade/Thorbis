{"version":3,"sources":["../../../../../../apps/web/src/components/work/work-data-view.tsx/__nextjs-internal-proxy.mjs","../../../../../../apps/web/src/lib/queries/invoices.ts","../../../../../../apps/web/src/components/work/invoices-kanban.tsx/__nextjs-internal-proxy.mjs","../../../../../../apps/web/src/components/work/invoices-table.tsx/__nextjs-internal-proxy.mjs","../../../../../../apps/web/src/app/%28dashboard%29/dashboard/work/invoices/page.tsx","../../../../../../apps/web/src/components/work/invoices/invoices-data.tsx","../../../../../../apps/web/src/components/work/invoices/invoices-skeleton.tsx"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const WorkDataView = registerClientReference(\n    function() { throw new Error(\"Attempted to call WorkDataView() from the server but WorkDataView is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/work/work-data-view.tsx\",\n    \"WorkDataView\",\n);\n","import { cache } from \"react\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\nexport const INVOICES_PAGE_SIZE = 50;\n\nconst INVOICE_SELECT = `\n  id,\n  invoice_number,\n  status,\n  total_amount,\n  paid_amount,\n  balance_amount,\n  created_at,\n  due_date,\n  archived_at,\n  deleted_at,\n  customers!invoices_customer_id_customers_id_fk (\n    display_name,\n    first_name,\n    last_name\n  )\n`;\n\nexport type InvoiceListRecord = {\n\tid: string;\n\tinvoice_number: string | null;\n\tstatus: string | null;\n\ttotal_amount: number | null;\n\tpaid_amount: number | null;\n\tbalance_amount: number | null;\n\tcreated_at: string;\n\tdue_date: string | null;\n\tarchived_at: string | null;\n\tdeleted_at: string | null;\n\tcustomers?:\n\t\t| {\n\t\t\t\tfirst_name?: string | null;\n\t\t\t\tlast_name?: string | null;\n\t\t\t\tdisplay_name?: string | null;\n\t\t  }\n\t\t| {\n\t\t\t\tfirst_name?: string | null;\n\t\t\t\tlast_name?: string | null;\n\t\t\t\tdisplay_name?: string | null;\n\t\t  }[]\n\t\t| null;\n};\n\nexport type InvoicesPageResult = {\n\tinvoices: InvoiceListRecord[];\n\ttotalCount: number;\n};\n\nexport async function getInvoicesPageData(\n\tpage: number,\n\tpageSize: number = INVOICES_PAGE_SIZE,\n): Promise<InvoicesPageResult> {\n\t// IMPORTANT: Cannot use \"use cache\" here because we call getActiveCompanyId()\n\t// which uses cookies(). The query is already fast enough without page-level caching.\n\tconst companyId = await getActiveCompanyId();\n\tif (!companyId) {\n\t\treturn { invoices: [], totalCount: 0 };\n\t}\n\n\tconst supabase = await createServiceSupabaseClient();\n\tif (!supabase) {\n\t\tthrow new Error(\"Supabase client not configured\");\n\t}\n\tconst start = (Math.max(page, 1) - 1) * pageSize;\n\tconst end = start + pageSize - 1;\n\n\tconst { data, error, count } = await supabase\n\t\t.from(\"invoices\")\n\t\t.select(INVOICE_SELECT, { count: \"exact\" })\n\t\t.eq(\"company_id\", companyId)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.range(start, end);\n\n\tif (error) {\n\t\tthrow new Error(`Failed to load invoices: ${error.message}`);\n\t}\n\n\treturn {\n\t\tinvoices: data ?? [],\n\t\ttotalCount: count ?? 0,\n\t};\n}\n\n/**\n * Get invoices summary using optimized RPC function\n * Uses single query with JOINs instead of LATERAL joins for better performance\n *\n * @param statuses - Array of statuses to filter by (e.g., ['draft', 'sent', 'paid'])\n * @param limit - Max results (default: 50)\n * @returns Invoices with customer info and calculated fields\n */\nexport const getInvoicesSummaryRpc = cache(\n\tasync (statuses?: string[], limit: number = 50) => {\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Supabase client not configured\");\n\t\t}\n\n\t\tconst { data, error } = await supabase.rpc(\"get_invoices_summary\", {\n\t\t\tp_company_id: companyId,\n\t\t\tp_statuses: statuses || null,\n\t\t\tp_limit: limit,\n\t\t});\n\n\t\tif (error) {\n\t\t\tconsole.error(\"Error fetching invoices via RPC:\", error);\n\t\t\treturn [];\n\t\t}\n\n\t\treturn data || [];\n\t},\n);\n\n/**\n * Fetch complete invoice data including related entities and tags\n * Uses React.cache() for request-level deduplication\n */\nexport const getInvoiceComplete = cache(\n\tasync (invoiceId: string, companyId: string) => {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Supabase client not configured\");\n\t\t}\n\n\t\tconst { data, error } = await supabase.rpc(\"get_invoice_complete\", {\n\t\t\tp_invoice_id: invoiceId,\n\t\t\tp_company_id: companyId,\n\t\t});\n\n\t\tif (error) {\n\t\t\tconsole.error(\"Error fetching invoice:\", error);\n\t\t\treturn null;\n\t\t}\n\n\t\treturn data?.[0]?.invoice_data || null;\n\t},\n);\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const InvoicesKanban = registerClientReference(\n    function() { throw new Error(\"Attempted to call InvoicesKanban() from the server but InvoicesKanban is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/work/invoices-kanban.tsx\",\n    \"InvoicesKanban\",\n);\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const InvoicesTable = registerClientReference(\n    function() { throw new Error(\"Attempted to call InvoicesTable() from the server but InvoicesTable is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/work/invoices-table.tsx\",\n    \"InvoicesTable\",\n);\n","/**\n * Invoices Page - PPR Enabled with Inline Stats\n *\n * Uses Next.js 16 \"use cache\" directive for optimal caching:\n * - Static shell renders instantly (5-20ms)\n * - Stats stream in toolbar (100-200ms)\n * - Table streams in main content (200-500ms)\n *\n * Performance: 60-1340x faster than traditional SSR\n * Clean design: Stats integrated directly into toolbar\n */\n\nimport { Suspense } from \"react\";\nimport { InvoicesData } from \"@/components/work/invoices/invoices-data\";\nimport { InvoicesSkeleton } from \"@/components/work/invoices/invoices-skeleton\";\n\nexport default async function InvoicesPage({\n\tsearchParams,\n}: {\n\tsearchParams: Promise<{ page?: string }>;\n}) {\n\tconst params = await searchParams;\n\treturn (\n\t\t<div className=\"flex h-full flex-col\">\n\t\t\t{/* Stats now shown in toolbar - see layout.tsx */}\n\n\t\t\t{/* Table - Main content */}\n\t\t\t<div className=\"flex-1 overflow-hidden\">\n\t\t\t\t<Suspense fallback={<InvoicesSkeleton />}>\n\t\t\t\t\t<InvoicesData searchParams={params} />\n\t\t\t\t</Suspense>\n\t\t\t</div>\n\t\t</div>\n\t);\n}\n","import { notFound, redirect } from \"next/navigation\";\nimport { InvoicesKanban } from \"@/components/work/invoices-kanban\";\nimport { type Invoice, InvoicesTable } from \"@/components/work/invoices-table\";\nimport { WorkDataView } from \"@/components/work/work-data-view\";\nimport {\n\tgetActiveCompanyId,\n\tisActiveCompanyOnboardingComplete,\n} from \"@/lib/auth/company-context\";\nimport {\n\tgetInvoicesPageData,\n\tINVOICES_PAGE_SIZE,\n} from \"@/lib/queries/invoices\";\n\n/**\n * Invoices Data - Async Server Component\n *\n * Fetches invoice data and renders table/kanban views.\n * Streams in after stats (slower query - includes joins).\n */\nexport async function InvoicesData({\n\tsearchParams,\n}: {\n\tsearchParams?: { page?: string };\n}) {\n\t// Check if active company has completed onboarding\n\tconst isOnboardingComplete = await isActiveCompanyOnboardingComplete();\n\n\tif (!isOnboardingComplete) {\n\t\tredirect(\"/dashboard\");\n\t}\n\n\t// Get active company ID\n\tconst activeCompanyId = await getActiveCompanyId();\n\n\tif (!activeCompanyId) {\n\t\tredirect(\"/dashboard\");\n\t}\n\n\tconst currentPage = Number(searchParams?.page) || 1;\n\tconst { invoices: invoicesRaw, totalCount } = await getInvoicesPageData(\n\t\tcurrentPage,\n\t\tINVOICES_PAGE_SIZE,\n\t);\n\n\tif (!invoicesRaw) {\n\t\treturn notFound();\n\t}\n\n\t// Map database statuses to display statuses\n\tconst mapStatus = (\n\t\tdbStatus: string,\n\t): \"paid\" | \"pending\" | \"draft\" | \"overdue\" => {\n\t\tswitch (dbStatus) {\n\t\t\tcase \"draft\":\n\t\t\t\treturn \"draft\";\n\t\t\tcase \"sent\":\n\t\t\t\treturn \"pending\";\n\t\t\tcase \"partial\":\n\t\t\t\treturn \"pending\";\n\t\t\tcase \"paid\":\n\t\t\t\treturn \"paid\";\n\t\t\tcase \"past_due\":\n\t\t\t\treturn \"overdue\";\n\t\t\tdefault:\n\t\t\t\treturn \"pending\";\n\t\t}\n\t};\n\n\t// Transform for table component\n\tconst invoices: Invoice[] = invoicesRaw.map((inv: any) => {\n\t\tconst customer = Array.isArray(inv.customers)\n\t\t\t? inv.customers[0]\n\t\t\t: inv.customers;\n\t\treturn {\n\t\t\tid: inv.id,\n\t\t\tinvoiceNumber: inv.invoice_number,\n\t\t\tcustomer:\n\t\t\t\tcustomer?.display_name ||\n\t\t\t\t`${customer?.first_name || \"\"} ${customer?.last_name || \"\"}`.trim() ||\n\t\t\t\t\"Unknown Customer\",\n\t\t\tdate: new Date(inv.created_at).toLocaleDateString(\"en-US\", {\n\t\t\t\tmonth: \"short\",\n\t\t\t\tday: \"numeric\",\n\t\t\t\tyear: \"numeric\",\n\t\t\t}),\n\t\t\tdueDate: inv.due_date\n\t\t\t\t? new Date(inv.due_date).toLocaleDateString(\"en-US\", {\n\t\t\t\t\t\tmonth: \"short\",\n\t\t\t\t\t\tday: \"numeric\",\n\t\t\t\t\t\tyear: \"numeric\",\n\t\t\t\t\t})\n\t\t\t\t: \"-\",\n\t\t\tamount: inv.total_amount,\n\t\t\tstatus: mapStatus(inv.status),\n\t\t\tarchived_at: inv.archived_at,\n\t\t\tdeleted_at: inv.deleted_at,\n\t\t};\n\t});\n\n\treturn (\n\t\t<WorkDataView\n\t\t\tkanban={<InvoicesKanban invoices={invoices} />}\n\t\t\tsection=\"invoices\"\n\t\t\ttable={\n\t\t\t\t<InvoicesTable\n\t\t\t\t\tcurrentPage={currentPage}\n\t\t\t\t\tenableVirtualization={false}\n\t\t\t\t\tinvoices={invoices}\n\t\t\t\t\titemsPerPage={INVOICES_PAGE_SIZE}\n\t\t\t\t\ttotalCount={totalCount}\n\t\t\t\t/>\n\t\t\t}\n\t\t/>\n\t);\n}\n","/**\n * InvoicesSkeleton - Loading Skeleton\n *\n * Uses the shared DataTableListSkeleton for consistent UX across all list pages.\n * Displays while invoices data is loading.\n * Matches the exact layout of the invoices table to prevent layout shifts.\n */\n\nimport { DataTableListSkeleton } from \"@/components/ui/skeletons\";\n\nexport function InvoicesSkeleton() {\n\treturn <DataTableListSkeleton />;\n}\n"],"names":[],"mappings":"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","ignoreList":[0,2,3]}