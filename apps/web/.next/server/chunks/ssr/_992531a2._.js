module.exports=[311487,a=>{"use strict";async function b(a,b,c,d){let{data:e,error:f}=await a.rpc("has_role",{user_uuid:b,required_role:c,company_uuid:d});return!f&&!0===e}async function c(a,b,c){let{data:d,error:e}=await a.rpc("get_user_role",{user_uuid:b,company_uuid:c});return e?null:d}async function d(a,b,c,d){let{data:e,error:f}=await a.rpc("has_permission",{user_uuid:b,permission_key:c,company_uuid:d});return!f&&!0===e}async function e(a,b,c){let{data:d,error:e}=await a.rpc("is_company_owner",{user_uuid:b,company_uuid:c});return!e&&!0===d}a.s(["getUserRole",()=>c,"hasPermission",()=>d,"hasRole",()=>b,"isCompanyOwner",()=>e])},997053,a=>{"use strict";a.i(311487),a.s([])},288344,a=>{"use strict";var b=a.i(780195);a.i(218188);var c=a.i(146057);a.i(467361);var d=a.i(445074);a.i(997053);var e=a.i(311487),f=a.i(974406),g=a.i(136874),h=a.i(395731);async function i(){return(0,f.withErrorHandling)(async()=>{let a=await (0,g.createClient)();if(!a)throw Error("Database connection not available");let{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Not authenticated");let c=await (0,d.getActiveCompanyId)();if(!c)throw Error("No active company");return await (0,e.getUserRole)(a,b.id,c)})}async function j(a){return(0,f.withErrorHandling)(async()=>{let b=await (0,g.createClient)();if(!b)throw Error("Database connection not available");let c=await (0,d.getActiveCompanyId)();if(!c)throw Error("No active company");let{data:e,error:f}=await b.from("company_memberships").select("user_id, role").eq("id",a).eq("company_id",c).single();if(f||!e)throw Error("Team member not found");let{data:h}=await b.from("companies").select("owner_id").eq("id",c).single();return h&&h.owner_id===e.user_id?{canDelete:!1,reason:"Cannot delete company owner. Transfer ownership first before removing this team member."}:{canDelete:!0}})}c.z.object({teamMemberId:c.z.string().uuid(),newRole:c.z.enum(["owner","admin","manager","dispatcher","technician","csr"]),reason:c.z.string().optional()}),c.z.object({teamMemberId:c.z.string().uuid(),permissions:c.z.record(c.z.string(),c.z.boolean())}),(0,h.ensureServerEntryExports)([i,j]),(0,b.registerServerReference)(i,"001f005176797ef23488068124fb9a744915a477de",null),(0,b.registerServerReference)(j,"406f6624261c6dd1a908026fa1408a3f6d507b6e7d",null),a.s(["canDeleteTeamMember",()=>j,"getCurrentUserRole",()=>i])},924237,a=>{"use strict";var b=a.i(288344),c=a.i(780195),d=a.i(136874);async function e(a){let b=process.env.TELNYX_API_KEY;if(!b)return{success:!1,error:"TELNYX_API_KEY is not configured"};try{let c=await fetch(`https://api.telnyx.com/v2/number_lookup/${encodeURIComponent(a)}`,{method:"GET",headers:{Authorization:`Bearer ${b}`},cache:"no-store"});if(!c.ok){let a=await c.json().catch(()=>({errors:[{detail:c.statusText}]}));return{success:!1,error:a?.errors?.[0]?.detail||`Telnyx lookup failed (${c.status})`}}let d=await c.json();return{success:!0,data:d.data}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error during lookup"}}}a.i(907279);var f=a.i(395731);async function g(a,b){try{let c=await (0,d.createClient)();if(!c)return{success:!1,error:"Database connection failed"};let e=a.replace(/\D/g,""),{data:f}=await c.from("customers").select("*").eq("company_id",b).or(`phone.eq.${a},phone.eq.${e},secondary_phone.eq.${a},secondary_phone.eq.${e}`).maybeSingle(),g=!!f,k=f?void 0:await h(a),l="unknown";f?l="database":k&&(l="telnyx");let m=f?await i(c,f.id):{jobs:[],invoices:[],estimates:[],appointments:[],properties:[],equipment:[],contracts:[]},n=j(f,m.jobs,m.invoices),o={customer:f??null,isKnownCustomer:g,source:l,stats:n,jobs:m.jobs,invoices:m.invoices,estimates:m.estimates,appointments:m.appointments,properties:m.properties,equipment:m.equipment,contracts:m.contracts,telnyxData:k};return{success:!0,data:o}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to fetch customer data"}}}async function h(a){let b=await e(a);if(!(b.success&&b.data))return;let c=b.data;return{callerName:c.caller_name||null,callerType:c.caller_type||null,lineType:c.line_type||null,carrier:c.carrier?.name||null,country:c.country_code||null,nationalFormat:c.national_format||null}}async function i(a,b){let[c,d,e,f,g,h]=await Promise.all([a.from("jobs").select(`
				id, job_number, title, description, status, priority, job_type,
				created_at, updated_at, scheduled_date,
				customer_id, property_id, company_id, created_by,
				financial:job_financial(total_amount, paid_amount, deposit_amount)
			`).eq("customer_id",b).is("deleted_at",null).order("created_at",{ascending:!1}).limit(10),a.from("invoices").select("*").eq("customer_id",b).order("status",{ascending:!0}).order("created_at",{ascending:!1}).limit(10),a.from("estimates").select("*").eq("customer_id",b).is("deleted_at",null).order("status",{ascending:!0}).order("created_at",{ascending:!1}).limit(10),a.from("appointments").select(`
        *,
        job:jobs!job_id(id, job_number, title),
        property:properties!property_id(id, name, address)
      `).eq("customer_id",b).is("deleted_at",null).gte("scheduled_start",new Date().toISOString()).order("scheduled_start",{ascending:!0}).limit(10),a.from("properties").select("*").eq("primary_contact_id",b).order("created_at",{ascending:!1}).limit(10),a.from("equipment").select("*").eq("customer_id",b).is("deleted_at",null).order("created_at",{ascending:!1}).limit(10)]);return{jobs:c.data||[],invoices:d.data||[],estimates:e.data||[],appointments:f.data||[],properties:g.data||[],equipment:h.data||[],contracts:[]}}function j(a,b,c){let d=c.filter(a=>"unpaid"===a.status||"partial"===a.status);return{totalJobs:b.length,activeJobs:b.filter(a=>"in_progress"===a.status||"scheduled"===a.status).length,totalRevenue:a?.total_revenue||0,openInvoices:d.length,openInvoicesAmount:d.reduce((a,b)=>a+(b.total_amount||0),0),customerSince:a?.created_at||null}}async function k(a,b){try{let c=await (0,d.createClient)();if(!c)return{success:!1,error:"Database connection failed"};let{data:e,error:f}=await c.from("customers").select("*").eq("id",a).eq("company_id",b).is("deleted_at",null).single();if(f||!e)return{success:!1,error:"Customer not found"};let g=await i(c,e.id),h=j(e,g.jobs,g.invoices),k={customer:e,isKnownCustomer:!0,source:"database",stats:h,jobs:g.jobs,invoices:g.invoices,estimates:g.estimates,appointments:g.appointments,properties:g.properties,equipment:g.equipment,contracts:[],telnyxData:void 0};return{success:!0,data:k}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to fetch customer data"}}}async function l(a,b){let c=await (0,d.createClient)();if(!c)return[];let e=new Date(a);e.setHours(0,0,0,0);let f=new Date(a);f.setHours(23,59,59,999);let{data:g,error:h}=await c.from("company_memberships").select(`
        user_id,
        role,
        users:user_id (
          id,
          email,
          raw_user_meta_data
        )
      `).eq("company_id",b).in("role",["technician","lead_technician","admin"]);if(h)throw h;if(!g||0===g.length)return[];let{data:i,error:j}=await c.from("jobs").select(`
        id,
        job_number,
        title,
        status,
        scheduled_start,
        scheduled_end,
        company_id,
        customer:customer_id (
          id,
          first_name,
          last_name
        ),
        property:property_id (
          address,
          city,
          state
        ),
        job_team_members:job_team_members (
          user_id,
          is_lead,
          users:user_id (
            id,
            email,
            raw_user_meta_data
          )
        )
      `).eq("company_id",b).gte("scheduled_start",e.toISOString()).lte("scheduled_start",f.toISOString()).order("scheduled_start");if(j)throw j;let k=["bg-blue-500","bg-green-500","bg-purple-500","bg-orange-500","bg-pink-500","bg-cyan-500","bg-red-500","bg-yellow-500","bg-indigo-500","bg-teal-500"];return g.map((a,b)=>{let c=a.users,d=c?.id||a.user_id,e=c?.raw_user_meta_data||{},f=e.full_name||e.name||c?.email?.split("@")[0]||"Unknown",g=(i||[]).filter(a=>a.job_team_members?.some(a=>a.user_id===d)).map(a=>{var b;let c=a.customer,d=a.property,e=c&&`${c.first_name||""} ${c.last_name||""}`.trim()||"Unknown Customer",f=new Date(a.scheduled_start),g=(new Date(a.scheduled_end).getTime()-f.getTime())/36e5,h=(a.job_team_members||[]).map(a=>{let b=a.users,c=b?.raw_user_meta_data||{};return{id:b?.id||a.user_id,name:c.full_name||c.name||b?.email?.split("@")[0]||"Unknown",avatar_url:c.avatar_url,is_lead:a.is_lead}});return{id:a.id,job_id:a.id,job_number:a.job_number||"N/A",customer_name:e,customer_id:c?.id||"",address:d?.address||"No address",city:d?.city||"",state:d?.state||"",job_type:a.title||"Service Call",scheduled_start:a.scheduled_start,scheduled_end:a.scheduled_end,duration_hours:Math.max(1,Math.round(2*g)/2),status:(b=a.status,({scheduled:"scheduled",in_progress:"in_progress",active:"in_progress",completed:"completed",done:"completed",cancelled:"cancelled",canceled:"cancelled"})[b?.toLowerCase()]||"scheduled"),assigned_technicians:h}});return{id:d,name:f,email:c?.email||"",avatar_url:e.avatar_url,color:k[b%k.length],role:a.role||"technician",appointments:g,working_hours:{start:8,end:18}}})}(0,f.ensureServerEntryExports)([g,k]),(0,c.registerServerReference)(g,"600f2001e85494de7547a5213c6143dced69476baf",null),(0,c.registerServerReference)(k,"60e51c1544e88202aee90bf80bbe297c22b52e59cc",null),(0,f.ensureServerEntryExports)([l]),(0,c.registerServerReference)(l,"60d61fe4e8976bdfeff5cf3386134c7b4b7b4f4bd0",null),a.s([],387308),a.i(387308),a.s(["001f005176797ef23488068124fb9a744915a477de",()=>b.getCurrentUserRole,"406f6624261c6dd1a908026fa1408a3f6d507b6e7d",()=>b.canDeleteTeamMember,"600f2001e85494de7547a5213c6143dced69476baf",()=>g,"60d61fe4e8976bdfeff5cf3386134c7b4b7b4f4bd0",()=>l,"60e51c1544e88202aee90bf80bbe297c22b52e59cc",()=>k],924237)},858982,a=>{a.v(b=>Promise.all(["server/chunks/ssr/3c0ae_next_4427392f._.js"].map(b=>a.l(b))).then(()=>b(857782)))}];

//# sourceMappingURL=_992531a2._.js.map