module.exports=[990744,a=>{"use strict";var b=a.i(780195),c=a.i(218188),d=a.i(146057),e=a.i(818944),f=a.i(974406),g=a.i(136874),h=a.i(395731);async function i(a,b){let{data:c}=await a.from("company_memberships").select("company_id").eq("user_id",b).eq("status","active").single();if(!c?.company_id)throw new e.ActionError("You must be part of a company",e.ERROR_CODES.AUTH_FORBIDDEN,403);return c.company_id}let j=d.z.object({smtpEnabled:d.z.boolean().default(!1),smtpHost:d.z.string().optional(),smtpPort:d.z.coerce.number().optional(),smtpUsername:d.z.string().optional(),smtpPassword:d.z.string().optional(),smtpFromEmail:d.z.string().email().optional().or(d.z.literal("")),smtpFromName:d.z.string().optional(),smtpUseTls:d.z.boolean().default(!0),defaultSignature:d.z.string().optional(),autoCcEnabled:d.z.boolean().default(!1),autoCcEmail:d.z.string().email().optional().or(d.z.literal("")),trackOpens:d.z.boolean().default(!0),trackClicks:d.z.boolean().default(!0),emailLogoUrl:d.z.string().optional(),primaryColor:d.z.string().regex(/^#[0-9A-F]{6}$/i).default("#3b82f6")});async function k(a){return(0,f.withErrorHandling)(async()=>{let b=await (0,g.createClient)();if(!b)throw new e.ActionError("Database connection failed",e.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:d}}=await b.auth.getUser();(0,f.assertAuthenticated)(d?.id);let h=await i(b,d.id),k=j.parse({smtpEnabled:"true"===a.get("smtpEnabled"),smtpHost:a.get("smtpHost")||void 0,smtpPort:a.get("smtpPort")||void 0,smtpUsername:a.get("smtpUsername")||void 0,smtpPassword:a.get("smtpPassword")||void 0,smtpFromEmail:a.get("smtpFromEmail")||void 0,smtpFromName:a.get("smtpFromName")||void 0,smtpUseTls:"false"!==a.get("smtpUseTls"),defaultSignature:a.get("defaultSignature")||void 0,autoCcEnabled:"true"===a.get("autoCcEnabled"),autoCcEmail:a.get("autoCcEmail")||void 0,trackOpens:"false"!==a.get("trackOpens"),trackClicks:"false"!==a.get("trackClicks"),emailLogoUrl:a.get("emailLogoUrl")||void 0,primaryColor:a.get("primaryColor")||"#3b82f6"}),l=k.smtpPassword?Buffer.from(k.smtpPassword).toString("base64"):null,{error:m}=await b.from("communication_email_settings").upsert({company_id:h,smtp_enabled:k.smtpEnabled,smtp_host:k.smtpHost,smtp_port:k.smtpPort,smtp_username:k.smtpUsername,smtp_password_encrypted:l,smtp_from_email:k.smtpFromEmail,smtp_from_name:k.smtpFromName,smtp_use_tls:k.smtpUseTls,default_signature:k.defaultSignature,auto_cc_enabled:k.autoCcEnabled,auto_cc_email:k.autoCcEmail,track_opens:k.trackOpens,track_clicks:k.trackClicks,email_logo_url:k.emailLogoUrl,primary_color:k.primaryColor});if(m)throw new e.ActionError(e.ERROR_MESSAGES.operationFailed("update email settings"),e.ERROR_CODES.DB_QUERY_ERROR);(0,c.revalidatePath)("/dashboard/settings/communications/email")})}async function l(){return(0,f.withErrorHandling)(async()=>{let a=await (0,g.createClient)();if(!a)throw new e.ActionError("Database connection failed",e.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:b}}=await a.auth.getUser();(0,f.assertAuthenticated)(b?.id);let c=await i(a,b.id),{data:d,error:h}=await a.from("communication_email_settings").select("*").eq("company_id",c).single();if(h&&"PGRST116"!==h.code)throw new e.ActionError(e.ERROR_MESSAGES.operationFailed("fetch email settings"),e.ERROR_CODES.DB_QUERY_ERROR);return d||null})}async function m(){return(0,f.withErrorHandling)(async()=>{let a=await (0,g.createClient)();if(!a)throw new e.ActionError("Database connection failed",e.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:b}}=await a.auth.getUser();(0,f.assertAuthenticated)(b?.id);let c=await i(a,b.id),[{data:d},{data:h}]=await Promise.all([a.from("company_email_domains").select("*").eq("company_id",c).order("created_at",{ascending:!1}).maybeSingle(),a.from("communication_email_inbound_routes").select("*").eq("company_id",c).maybeSingle()]);return{domain:d??null,inboundRoute:h??null}})}let n=d.z.object({provider:d.z.enum(["telnyx","twilio","other"]).default("telnyx"),providerApiKey:d.z.string().optional(),senderNumber:d.z.string().optional(),autoReplyEnabled:d.z.boolean().default(!1),autoReplyMessage:d.z.string().optional(),optOutMessage:d.z.string().default("Reply STOP to unsubscribe"),includeOptOut:d.z.boolean().default(!0),consentRequired:d.z.boolean().default(!0)});async function o(a){return(0,f.withErrorHandling)(async()=>{let b=await (0,g.createClient)();if(!b)throw new e.ActionError("Database connection failed",e.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:d}}=await b.auth.getUser();(0,f.assertAuthenticated)(d?.id);let h=await i(b,d.id),j=n.parse({provider:a.get("provider")||"telnyx",providerApiKey:a.get("providerApiKey")||void 0,senderNumber:a.get("senderNumber")||void 0,autoReplyEnabled:"true"===a.get("autoReplyEnabled"),autoReplyMessage:a.get("autoReplyMessage")||void 0,optOutMessage:a.get("optOutMessage")||"Reply STOP to unsubscribe",includeOptOut:"false"!==a.get("includeOptOut"),consentRequired:"false"!==a.get("consentRequired")}),k=j.providerApiKey?Buffer.from(j.providerApiKey).toString("base64"):null,{error:l}=await b.from("communication_sms_settings").upsert({company_id:h,provider:j.provider,provider_api_key_encrypted:k,sender_number:j.senderNumber,auto_reply_enabled:j.autoReplyEnabled,auto_reply_message:j.autoReplyMessage,opt_out_message:j.optOutMessage,include_opt_out:j.includeOptOut,consent_required:j.consentRequired});if(l)throw new e.ActionError(e.ERROR_MESSAGES.operationFailed("update SMS settings"),e.ERROR_CODES.DB_QUERY_ERROR);(0,c.revalidatePath)("/dashboard/settings/communications/sms")})}async function p(){return(0,f.withErrorHandling)(async()=>{let a=await (0,g.createClient)();if(!a)throw new e.ActionError("Database connection failed",e.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:b}}=await a.auth.getUser();(0,f.assertAuthenticated)(b?.id);let c=await i(a,b.id),{data:d,error:h}=await a.from("communication_sms_settings").select("*").eq("company_id",c).single();if(h&&"PGRST116"!==h.code)throw new e.ActionError(e.ERROR_MESSAGES.operationFailed("fetch SMS settings"),e.ERROR_CODES.DB_QUERY_ERROR);return d||null})}let q=d.z.object({routingStrategy:d.z.enum(["round_robin","skills_based","priority","simultaneous"]).default("round_robin"),fallbackNumber:d.z.string().optional(),businessHoursOnly:d.z.boolean().default(!1),voicemailEnabled:d.z.boolean().default(!0),voicemailGreetingUrl:d.z.string().optional(),voicemailEmailNotifications:d.z.boolean().default(!0),voicemailTranscriptionEnabled:d.z.boolean().default(!1),recordingEnabled:d.z.boolean().default(!1),recordingAnnouncement:d.z.string().default("This call may be recorded for quality assurance"),recordingConsentRequired:d.z.boolean().default(!0),ivrEnabled:d.z.boolean().default(!1),ivrMenu:d.z.string().optional()});async function r(a){return(0,f.withErrorHandling)(async()=>{let b=await (0,g.createClient)();if(!b)throw new e.ActionError("Database connection failed",e.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:d}}=await b.auth.getUser();(0,f.assertAuthenticated)(d?.id);let h=await i(b,d.id),j=a.get("ivrMenu"),k={};if(j)try{k=JSON.parse(j)}catch(a){}let l=q.parse({routingStrategy:a.get("routingStrategy")||"round_robin",fallbackNumber:a.get("fallbackNumber")||void 0,businessHoursOnly:"true"===a.get("businessHoursOnly"),voicemailEnabled:"false"!==a.get("voicemailEnabled"),voicemailGreetingUrl:a.get("voicemailGreetingUrl")||void 0,voicemailEmailNotifications:"false"!==a.get("voicemailEmailNotifications"),voicemailTranscriptionEnabled:"true"===a.get("voicemailTranscriptionEnabled"),recordingEnabled:"true"===a.get("recordingEnabled"),recordingAnnouncement:a.get("recordingAnnouncement")||"This call may be recorded for quality assurance",recordingConsentRequired:"false"!==a.get("recordingConsentRequired"),ivrEnabled:"true"===a.get("ivrEnabled"),ivrMenu:j||void 0}),{error:m}=await b.from("communication_phone_settings").upsert({company_id:h,routing_strategy:l.routingStrategy,fallback_number:l.fallbackNumber,business_hours_only:l.businessHoursOnly,voicemail_enabled:l.voicemailEnabled,voicemail_greeting_url:l.voicemailGreetingUrl,voicemail_email_notifications:l.voicemailEmailNotifications,voicemail_transcription_enabled:l.voicemailTranscriptionEnabled,recording_enabled:l.recordingEnabled,recording_announcement:l.recordingAnnouncement,recording_consent_required:l.recordingConsentRequired,ivr_enabled:l.ivrEnabled,ivr_menu:k});if(m)throw new e.ActionError(e.ERROR_MESSAGES.operationFailed("update phone settings"),e.ERROR_CODES.DB_QUERY_ERROR);(0,c.revalidatePath)("/dashboard/settings/communications/phone")})}async function s(){return(0,f.withErrorHandling)(async()=>{let a=await (0,g.createClient)();if(!a)throw new e.ActionError("Database connection failed",e.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:b}}=await a.auth.getUser();(0,f.assertAuthenticated)(b?.id);let c=await i(a,b.id),{data:d,error:h}=await a.from("communication_phone_settings").select("*").eq("company_id",c).single();if(h&&"PGRST116"!==h.code)throw new e.ActionError(e.ERROR_MESSAGES.operationFailed("fetch phone settings"),e.ERROR_CODES.DB_QUERY_ERROR);return d||null})}let t=d.z.object({notifyNewJobs:d.z.boolean().default(!0),notifyJobUpdates:d.z.boolean().default(!0),notifyJobCompletions:d.z.boolean().default(!0),notifyNewCustomers:d.z.boolean().default(!1),notifyCustomerUpdates:d.z.boolean().default(!1),notifyInvoiceSent:d.z.boolean().default(!0),notifyInvoicePaid:d.z.boolean().default(!0),notifyInvoiceOverdue:d.z.boolean().default(!0),notifyEstimateSent:d.z.boolean().default(!0),notifyEstimateApproved:d.z.boolean().default(!0),notifyEstimateDeclined:d.z.boolean().default(!1),notifyScheduleChanges:d.z.boolean().default(!0),notifyTechnicianAssigned:d.z.boolean().default(!0),emailNotifications:d.z.boolean().default(!0),smsNotifications:d.z.boolean().default(!1),pushNotifications:d.z.boolean().default(!0),inAppNotifications:d.z.boolean().default(!0)});async function u(a){return(0,f.withErrorHandling)(async()=>{let b=await (0,g.createClient)();if(!b)throw new e.ActionError("Database connection failed",e.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:d}}=await b.auth.getUser();(0,f.assertAuthenticated)(d?.id);let h=await i(b,d.id),j=t.parse({notifyNewJobs:"false"!==a.get("notifyNewJobs"),notifyJobUpdates:"false"!==a.get("notifyJobUpdates"),notifyJobCompletions:"false"!==a.get("notifyJobCompletions"),notifyNewCustomers:"true"===a.get("notifyNewCustomers"),notifyCustomerUpdates:"true"===a.get("notifyCustomerUpdates"),notifyInvoiceSent:"false"!==a.get("notifyInvoiceSent"),notifyInvoicePaid:"false"!==a.get("notifyInvoicePaid"),notifyInvoiceOverdue:"false"!==a.get("notifyInvoiceOverdue"),notifyEstimateSent:"false"!==a.get("notifyEstimateSent"),notifyEstimateApproved:"false"!==a.get("notifyEstimateApproved"),notifyEstimateDeclined:"true"===a.get("notifyEstimateDeclined"),notifyScheduleChanges:"false"!==a.get("notifyScheduleChanges"),notifyTechnicianAssigned:"false"!==a.get("notifyTechnicianAssigned"),emailNotifications:"false"!==a.get("emailNotifications"),smsNotifications:"true"===a.get("smsNotifications"),pushNotifications:"false"!==a.get("pushNotifications"),inAppNotifications:"false"!==a.get("inAppNotifications")}),{error:k}=await b.from("communication_notification_settings").upsert({company_id:h,notify_new_jobs:j.notifyNewJobs,notify_job_updates:j.notifyJobUpdates,notify_job_completions:j.notifyJobCompletions,notify_new_customers:j.notifyNewCustomers,notify_customer_updates:j.notifyCustomerUpdates,notify_invoice_sent:j.notifyInvoiceSent,notify_invoice_paid:j.notifyInvoicePaid,notify_invoice_overdue:j.notifyInvoiceOverdue,notify_estimate_sent:j.notifyEstimateSent,notify_estimate_approved:j.notifyEstimateApproved,notify_estimate_declined:j.notifyEstimateDeclined,notify_schedule_changes:j.notifyScheduleChanges,notify_technician_assigned:j.notifyTechnicianAssigned,email_notifications:j.emailNotifications,sms_notifications:j.smsNotifications,push_notifications:j.pushNotifications,in_app_notifications:j.inAppNotifications});if(k)throw new e.ActionError(e.ERROR_MESSAGES.operationFailed("update notification settings"),e.ERROR_CODES.DB_QUERY_ERROR);(0,c.revalidatePath)("/dashboard/settings/communications/notifications")})}async function v(){return(0,f.withErrorHandling)(async()=>{let a=await (0,g.createClient)();if(!a)throw new e.ActionError("Database connection failed",e.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:b}}=await a.auth.getUser();(0,f.assertAuthenticated)(b?.id);let c=await i(a,b.id),{data:d,error:h}=await a.from("communication_notification_settings").select("*").eq("company_id",c).single();if(h&&"PGRST116"!==h.code)throw new e.ActionError(e.ERROR_MESSAGES.operationFailed("fetch notification settings"),e.ERROR_CODES.DB_QUERY_ERROR);return d||null})}(0,h.ensureServerEntryExports)([k,l,m,o,p,r,s,u,v]),(0,b.registerServerReference)(k,"40b8bc01e2ef401ec5b50e46b762918f3242b60587",null),(0,b.registerServerReference)(l,"00b955879abf760599203f116bfebb32ab0ce00a27",null),(0,b.registerServerReference)(m,"008aacd234b3f9692ca225655a1007d3550ca65dd0",null),(0,b.registerServerReference)(o,"40703142390e16b4c8335ffe2f874a170ff11db169",null),(0,b.registerServerReference)(p,"001e268d704c80f5b89fb479dd6938d6e80fdd51dc",null),(0,b.registerServerReference)(r,"401cca6845d548abda02f3bdcdb3ab42d40d854807",null),(0,b.registerServerReference)(s,"007c45bbaae250a392ed7853919c1b624ff934f164",null),(0,b.registerServerReference)(u,"40c90ca7a60e4c2cfdde722c6dad00ad689c1d6adc",null),(0,b.registerServerReference)(v,"009ff0f49bdf23cbb78848a742f889feeb77363fe2",null),a.s(["getPhoneSettings",()=>s,"getSmsSettings",()=>p,"updateNotificationSettings",()=>u,"updatePhoneSettings",()=>r,"updateSmsSettings",()=>o])}];

//# sourceMappingURL=apps_web_src_actions_settings_communications_ts_953000c4._.js.map