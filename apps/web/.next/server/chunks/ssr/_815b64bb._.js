module.exports=[162803,a=>{"use strict";var b=a.i(780195),c=a.i(136874);async function d(a,b={}){let e=await (0,c.createClient)();if(!e)return{sms:[],total:0,hasMore:!1};let{limit:f=50,offset:g=0,type:h="all",folder:i,label:j,search:k,sortBy:l="created_at",sortOrder:m="desc"}=b,n=e.from("communications").select(`
			id,
			from_address,
			from_name,
			to_address,
			body,
			body_html,
			created_at,
			read_at,
			direction,
			customer_id,
			customer:customers!left(id, first_name, last_name, display_name, email, phone, company_name),
			sent_at,
			delivered_at,
			status,
			channel,
			provider_metadata,
			is_archived,
			snoozed_until,
			category,
			tags,
			telnyx_message_id
		`,{count:"exact"}).eq("company_id",a).eq("type","sms");if(i)switch(i){case"inbox":n=n.eq("direction","inbound").eq("is_archived",!1).is("deleted_at",null).or("snoozed_until.is.null,snoozed_until.lt.now()");break;case"sent":n=n.eq("direction","outbound").eq("is_archived",!1).is("deleted_at",null);break;case"archive":n=n.eq("is_archived",!0).is("deleted_at",null);break;case"trash":case"bin":n=n.not("deleted_at","is",null);break;default:n=n.is("deleted_at",null)}else n=n.is("deleted_at",null);if("sent"===h?n=n.eq("direction","outbound"):"received"===h&&(n=n.eq("direction","inbound")),k){let a=k.toLowerCase();n=n.or(`from_address.ilike.%${a}%,to_address.ilike.%${a}%,body.ilike.%${a}%`)}let o="asc"===m;n=(n="sent_at"===l?n.order("sent_at",{ascending:o,nullsFirst:!1}):n.order("created_at",{ascending:o})).range(g,g+f-1);let{data:p,error:q,count:r}=await n;if(q)return console.error("Error fetching SMS messages:",q),{sms:[],total:0,hasMore:!1};let s=(p||[]).map(a=>({...a,tags:a.tags||null,provider_metadata:a.provider_metadata||null})),t=j||i;if(t&&!["inbox","sent","archive","trash","bin"].includes(t))return{sms:s=s.filter(a=>{let b=a.tags||[];return Array.isArray(b)&&b.includes(t)}),total:s.length,hasMore:!1};let u=r||0,v=g+s.length<u;return{sms:s,total:u,hasMore:v}}async function e(a,b){let d=await (0,c.createClient)();if(!d)return null;let{data:e,error:f}=await d.from("communications").select(`
			id,
			from_address,
			from_name,
			to_address,
			body,
			body_html,
			created_at,
			read_at,
			direction,
			customer_id,
			customer:customers!left(id, first_name, last_name, display_name, email, phone, company_name),
			sent_at,
			delivered_at,
			status,
			channel,
			provider_metadata,
			is_archived,
			snoozed_until,
			category,
			tags,
			telnyx_message_id
		`).eq("id",b).eq("company_id",a).eq("type","sms").single();return f||!e?null:{...e,tags:e.tags||null,provider_metadata:e.provider_metadata||null}}async function f(a,b){let d=await (0,c.createClient)();if(!d)return console.error("❌ markSmsAsRead: Missing supabase"),!1;let e=new Date().toISOString(),{data:f,error:g}=await d.from("communications").update({read_at:e}).eq("id",b).eq("company_id",a).eq("type","sms").select("id, read_at").single();return g?(console.error("❌ markSmsAsRead error:",g),!1):!!f||(console.error("❌ markSmsAsRead: No data returned"),!1)}async function g(a,b){let d,e=await (0,c.createClient)();if(!e)return!1;let f=11===(d=b.replace(/[^0-9]/g,"")).length&&d.startsWith("1")?`+${d}`:10===d.length?`+1${d}`:b.startsWith("+")?b:`+${b}`,g=new Date().toISOString(),{data:h,error:i}=await e.from("communications").update({read_at:g}).eq("company_id",a).eq("type","sms").eq("direction","inbound").is("read_at",null).is("deleted_at",null).or(`from_address.eq.${f},to_address.eq.${f}`).select("id, read_at");return!i||(console.error("❌ markSmsConversationAsRead error:",i),!1)}var h=a.i(146057),i=a.i(395731);let j=h.z.object({limit:h.z.coerce.number().min(1).max(500).optional().default(50),offset:h.z.coerce.number().min(0).optional().default(0),type:h.z.enum(["sent","received","all"]).optional().default("all"),folder:h.z.enum(["inbox","sent","archive","trash","bin"]).optional(),label:h.z.string().optional(),search:h.z.string().optional().nullable(),sortBy:h.z.enum(["created_at","sent_at"]).optional().default("created_at"),sortOrder:h.z.enum(["asc","desc"]).optional().default("desc")}).passthrough(),k=h.z.object({smsId:h.z.string().min(1)});async function l(b){try{let c=j.safeParse(b);if(!c.success)throw Error(`Invalid input parameters: ${c.error.errors.map(a=>`${a.path.join(".")}: ${a.message}`).join(", ")}`);let e=c.data,{getActiveCompanyId:f}=await a.A(37652),g=await f();if(!g)throw Error("No active company found");return await d(g,e)}catch(a){throw console.error("❌ getSmsAction error:",a),a}}async function m(b){try{let{getActiveCompanyId:c}=await a.A(37652),d=await c();if(!d)return{success:!1,error:"No active company found"};let f=await e(d,b);if(!f)return{success:!1,error:"SMS not found"};return{success:!0,sms:f}}catch(a){return console.error("Error getting SMS by ID:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function n(b){try{let c=k.parse(b),{getActiveCompanyId:d}=await a.A(37652),e=await d();if(!e)throw Error("Invalid input parameters");return await f(e,c.smsId)}catch(a){if(a instanceof h.z.ZodError)throw Error("Invalid input parameters");throw a}}async function o(b){try{let{getActiveCompanyId:c}=await a.A(37652),d=await c();if(!d)return{success:!1,error:"No active company found"};return{success:await g(d,b)}}catch(a){return console.error("Error marking SMS conversation as read:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function p(b){try{let{getSmsConversation:c}=await a.A(467914),{getActiveCompanyId:d}=await a.A(37652),e=await d();if(!e)return{success:!1,error:"No active company found"};let f=await c(e,b);return{success:!0,messages:f}}catch(a){if(console.error("Error fetching SMS conversation:",a),a instanceof Error&&a.message.includes("cookies"))return{success:!1,error:"Request context not available. Please refresh the page."};return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function q(){try{let{createClient:b}=await a.A(710933),{getActiveCompanyId:c}=await a.A(37652),d=await c();if(!d)return{success:!1,error:"No active company found"};let e=await b();if(!e)return{success:!1,error:"Database connection failed"};let f=e.from("communications").select("*",{count:"exact",head:!0}).eq("company_id",d).eq("type","sms"),[g,h,i,j]=await Promise.all([f.eq("direction","inbound").eq("is_archived",!1).is("deleted_at",null).or("snoozed_until.is.null,snoozed_until.lt.now()"),f.eq("direction","outbound").eq("is_archived",!1).is("deleted_at",null),f.eq("is_archived",!0).is("deleted_at",null),f.not("deleted_at","is",null)]),k={inbox:g.count||0,sent:h.count||0,archive:i.count||0,trash:j.count||0};return{success:!0,counts:k}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function r(b){try{let{getActiveCompanyId:c}=await a.A(37652),d=await c();if(!d)return{success:!1,error:"No active company found"};let{createClient:e}=await a.A(710933),f=await e();if(!f)return{success:!1,error:"Database connection failed"};let g=[];for(let a of b){let b=a.name.split(".").pop(),c=`${Date.now()}-${Math.random().toString(36).substring(7)}.${b}`,e=`${d}/sms-attachments/${c}`,h=await a.arrayBuffer(),{data:i,error:j}=await f.storage.from("company-files").upload(e,h,{contentType:a.type,upsert:!1});if(j)return console.error("Upload error:",j),{success:!1,error:`Failed to upload ${a.name}: ${j.message}`};let{data:{publicUrl:k}}=f.storage.from("company-files").getPublicUrl(e);g.push(k)}return{success:!0,urls:g}}catch(a){return console.error("Error uploading SMS attachments:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function s(){try{let{getActiveCompany:b}=await a.A(37652),c=await b();if(!c)return{success:!1,error:"No active company found"};return{success:!0,context:{companyName:c.name,companyPhone:c.phone||void 0,companyEmail:c.email||void 0}}}catch(a){return console.error("Error getting company context:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}(0,i.ensureServerEntryExports)([l,m,n,o,p,q,r,s]),(0,b.registerServerReference)(l,"401da60f1a9391a303a1b16907796e4c0f50d69f2e",null),(0,b.registerServerReference)(m,"4044b52e9024b2d9706a0fecdc03f2b79b2581d95f",null),(0,b.registerServerReference)(n,"40b400ebd66fa044553037f011b7b9f79ac7991a54",null),(0,b.registerServerReference)(o,"40955555a6fefc5cd6fcbb13dbbda08c03e7c12997",null),(0,b.registerServerReference)(p,"40641943d0d58e4efdbd5a78b4dee1f49227c7ed47",null),(0,b.registerServerReference)(q,"0006f7bd89b72f0836ec7bf4db73019f1b32e6c24a",null),(0,b.registerServerReference)(r,"404c132f24569b4f654af19a6a5cb46969dc24f12a",null),(0,b.registerServerReference)(s,"00ac96dc81c57c5c0b6ef948993077a34552967467",null),a.s(["getCompanyContextAction",()=>s,"getSmsAction",()=>l,"getSmsByIdAction",()=>m,"getSmsConversationAction",()=>p,"getSmsFolderCountsAction",()=>q,"markSmsAsReadAction",()=>n,"markSmsConversationAsReadAction",()=>o,"uploadSmsAttachments",()=>r],162803)},823027,a=>{"use strict";var b=a.i(780195),c=a.i(218188),d=a.i(974406),e=a.i(136874),f=a.i(395731);let g={customer:{table:"customers",field:"tags",useMetadata:!1},job:{table:"jobs",field:"metadata",useMetadata:!0},property:{table:"properties",field:"metadata",useMetadata:!0},invoice:{table:"invoices",field:"metadata",useMetadata:!0},estimate:{table:"estimates",field:"metadata",useMetadata:!0},equipment:{table:"equipment",field:"metadata",useMetadata:!0},appointment:{table:"appointments",field:"metadata",useMetadata:!0},material:{table:"job_materials",field:"metadata",useMetadata:!0},vendor:{table:"vendors",field:"tags",useMetadata:!1}};async function h(a,b,c){return(0,d.withErrorHandling)(async()=>{let d=await (0,e.createClient)();if(!d)throw Error("Database connection not available");await i(d);let f=g[a];if(!f)throw Error(`Unsupported entity type: ${a}`);let h=await j({supabase:d,config:f,entityId:b,entityType:a,tags:c});return await k({supabase:d,config:f,entityId:b,entityType:a,updateData:h}),l(a,b),{entityId:b,entityType:a,tags:c}})}let i=async a=>{let{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Not authenticated");return b},j=async({supabase:a,config:b,entityId:c,entityType:d,tags:e})=>{if(!b.useMetadata)return{tags:e,updated_at:new Date().toISOString()};let{data:f,error:g}=await a.from(b.table).select("metadata").eq("id",c).single();if(g)throw Error(`Failed to load ${d} metadata: ${g.message}`);return{metadata:{...f&&"object"==typeof f.metadata&&null!==f.metadata?f.metadata:{},tags:e},updated_at:new Date().toISOString()}},k=async({supabase:a,config:b,entityId:c,entityType:d,updateData:e})=>{let{error:f}=await a.from(b.table).update(e).eq("id",c);if(f)throw Error(`Failed to update ${d} tags: ${f.message}`)},l=(a,b)=>{let d={customer:"customers",job:"work",property:"work/properties",invoice:"work/invoices",estimate:"work/estimates",equipment:"work/equipment",appointment:"schedule",material:null,vendor:"work/vendors"}[a]??null;d&&((0,c.revalidatePath)(`/dashboard/${d}/${b}`),(0,c.revalidatePath)(`/dashboard/${d}`)),(0,c.revalidatePath)("/dashboard")};(0,f.ensureServerEntryExports)([h]),(0,b.registerServerReference)(h,"70ff12ee81a60340f786414d0baa7af58484dd7488",null),a.s(["updateEntityTags",()=>h])},620778,a=>{"use strict";var b=a.i(136874);async function c(a,c){let e=await (0,b.createClient)();if(!e)return null;let{data:f}=await e.from("finance_bank_accounts").select("id").eq("company_id",a).eq("is_active",!0).limit(1);if(!f||0===f.length)return null;let{data:g}=await e.from("company_payment_processors").select("*").eq("company_id",a).eq("status","active").order("created_at",{ascending:!1});if(!g||0===g.length)return null;if(c?.forceProcessor){let a=g.find(a=>a.processor_type===c.forceProcessor);if(a)return d(a)}let h=c?.amount||0,i=c?.channel||"online";if(h>1e6&&g.some(a=>"adyen"===a.processor_type)){let a=g.find(a=>"adyen"===a.processor_type);if(a)return d(a)}if(("card_present"===i||"tap_to_pay"===i)&&g.some(a=>"adyen"===a.processor_type)){let a=g.find(a=>"adyen"===a.processor_type);if(a)return d(a)}if("ach"===i){let a=g.find(a=>"plaid"===a.processor_type);if(a)return d(a);let b=g.find(a=>"profitstars"===a.processor_type);if(b)return d(b)}return d(g[0])}async function d(b){switch(b.processor_type){case"adyen":{let{AdyenProcessor:c}=await a.A(806668);return new c({companyId:b.company_id,accountId:b.adyen_account_id,apiKey:b.adyen_api_key_encrypted,merchantAccount:b.adyen_merchant_account,liveMode:b.adyen_live_mode})}case"plaid":{let{PlaidProcessor:c}=await a.A(250422);return new c({companyId:b.company_id,clientId:b.plaid_client_id,secret:b.plaid_secret_encrypted,environment:b.plaid_environment||"sandbox"})}case"profitstars":{let{ProfitStarsProcessor:c}=await a.A(117002);return new c({companyId:b.company_id,merchantId:b.profitstars_merchant_id,apiKey:b.profitstars_api_key_encrypted,routingNumber:b.profitstars_routing_number})}case"stripe":{let{StripeProcessor:c}=await a.A(662670);return new c({companyId:b.company_id,liveMode:b.adyen_live_mode})}default:return null}}async function e(a,c){let d=await (0,b.createClient)();if(!d)return{score:0,allowed:!1,requiresApproval:!0,reason:"Database unavailable"};let{data:e}=await d.from("payment_trust_scores").select("*").eq("company_id",a).single();if(!e)return{score:50,allowed:!1,requiresApproval:!0,reason:"No trust score found"};let f=Number(e.overall_score),{data:g}=await d.from("company_payment_processors").select("max_payment_amount, requires_approval_above").eq("company_id",a).eq("status","active").single(),h=g?.max_payment_amount||1e5,i=g?.requires_approval_above||5e4,j=h,k=c<=(j=f>=90?h:f>=70?Math.floor(.5*h):f>=50?Math.floor(.25*h):1e4),l=c>i||f<70;return{score:f,allowed:k,requiresApproval:l,reason:k?l?"Payment requires manual approval":void 0:`Payment amount exceeds allowed limit for trust score. Max allowed: $${j/100}`}}async function f(a,c,d){let e=await (0,b.createClient)();if(!e)return;let{data:f}=await e.from("payment_trust_scores").select("*").eq("company_id",a).single();if(!f)return;let g={total_payments_count:(f.total_payments_count||0)+1,total_payments_volume:(f.total_payments_volume||0)+d,last_calculated_at:new Date().toISOString()};c?g.successful_payments_count=(f.successful_payments_count||0)+1:g.failed_payments_count=(f.failed_payments_count||0)+1,d>(f.largest_payment_amount||0)&&(g.largest_payment_amount=d);let h=g.total_payments_count,i=g.successful_payments_count||f.successful_payments_count||0;g.failed_payments_count||f.failed_payments_count;let j=Math.min(100,20*Math.log10((g.total_payments_volume||0)/100+1));g.overall_score=Math.min(100,Math.max(0,.4*(h>0?i/h*100:50)+.3*j+.2*Math.min(100,(f.account_age_days||0)/30*10)+10*!!f.business_verified+5*!!f.bank_account_verified+5*!!f.identity_verified)),g.refund_rate=h>0?(f.refunded_amount||0)/g.total_payments_volume*100:0,await e.from("payment_trust_scores").update(g).eq("company_id",a)}a.s(["calculatePaymentTrustScore",()=>e,"getPaymentProcessor",()=>c,"updateTrustScoreAfterPayment",()=>f])},769989,a=>{a.v(b=>Promise.all(["server/chunks/ssr/[root-of-the-server]__f6c731fd._.js","server/chunks/ssr/3c0ae_next_dist_compiled_d01f76b2._.js"].map(b=>a.l(b))).then(()=>b(227185)))},642757,a=>{a.v(a=>Promise.resolve().then(()=>a(149664)))},315292,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_email_email-tracking_ts_73b89830._.js"].map(b=>a.l(b))).then(()=>b(582891)))},449334,a=>{a.v(a=>Promise.resolve().then(()=>a(343860)))},37652,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_auth_company-context_ts_732d588b._.js"].map(b=>a.l(b))).then(()=>b(480513)))},710933,a=>{a.v(a=>Promise.resolve().then(()=>a(136874)))},463923,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_email_resend-domains_ts_fb6b2c6f._.js"].map(b=>a.l(b))).then(()=>b(73130)))},707466,a=>{a.v(a=>Promise.resolve().then(()=>a(933427)))},593976,a=>{a.v(a=>Promise.resolve().then(()=>a(198114)))},841477,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_emails_plain-text-email_tsx_5acac822._.js"].map(b=>a.l(b))).then(()=>b(917126)))},365581,a=>{a.v(a=>Promise.resolve().then(()=>a(869251)))},612244,a=>{a.v(a=>Promise.resolve().then(()=>a(918448)))},115593,a=>{a.v(a=>Promise.resolve().then(()=>a(111732)))},520183,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_ai_memory-service_ts_be9d7ea7._.js"].map(b=>a.l(b))).then(()=>b(294670)))},329699,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_services_weather-service_ts_313b9cab._.js"].map(b=>a.l(b))).then(()=>b(728951)))},809861,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_services_traffic-service_ts_a210ff55._.js"].map(b=>a.l(b))).then(()=>b(46443)))},404530,a=>{a.v(a=>Promise.resolve().then(()=>a(81441)))},420584,a=>{a.v(a=>Promise.resolve().then(()=>a(928660)))},467914,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_sms_sms-service_ts_617021c0._.js"].map(b=>a.l(b))).then(()=>b(227967)))},806668,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_payments_processors_adyen_ts_b021b35d._.js"].map(b=>a.l(b))).then(()=>b(189239)))},250422,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_payments_processors_plaid_ts_68d940a4._.js"].map(b=>a.l(b))).then(()=>b(22036)))},117002,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_payments_processors_profitstars_ts_eabbf2bd._.js"].map(b=>a.l(b))).then(()=>b(807124)))},662670,a=>{a.v(b=>Promise.all(["server/chunks/ssr/[root-of-the-server]__66a75d16._.js","server/chunks/ssr/node_modules__pnpm_f8367645._.js"].map(b=>a.l(b))).then(()=>b(397357)))}];

//# sourceMappingURL=_815b64bb._.js.map