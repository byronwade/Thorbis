module.exports=[311487,a=>{"use strict";async function b(a,b,c,d){let{data:e,error:f}=await a.rpc("has_role",{user_uuid:b,required_role:c,company_uuid:d});return!f&&!0===e}async function c(a,b,c){let{data:d,error:e}=await a.rpc("get_user_role",{user_uuid:b,company_uuid:c});return e?null:d}async function d(a,b,c,d){let{data:e,error:f}=await a.rpc("has_permission",{user_uuid:b,permission_key:c,company_uuid:d});return!f&&!0===e}async function e(a,b,c){let{data:d,error:e}=await a.rpc("is_company_owner",{user_uuid:b,company_uuid:c});return!e&&!0===d}a.s(["getUserRole",()=>c,"hasPermission",()=>d,"hasRole",()=>b,"isCompanyOwner",()=>e])},997053,a=>{"use strict";a.i(311487),a.s([])},288344,a=>{"use strict";var b=a.i(780195);a.i(218188);var c=a.i(146057);a.i(467361);var d=a.i(445074);a.i(997053);var e=a.i(311487),f=a.i(974406),g=a.i(136874),h=a.i(395731);async function i(){return(0,f.withErrorHandling)(async()=>{let a=await (0,g.createClient)();if(!a)throw Error("Database connection not available");let{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Not authenticated");let c=await (0,d.getActiveCompanyId)();if(!c)throw Error("No active company");return await (0,e.getUserRole)(a,b.id,c)})}async function j(a){return(0,f.withErrorHandling)(async()=>{let b=await (0,g.createClient)();if(!b)throw Error("Database connection not available");let c=await (0,d.getActiveCompanyId)();if(!c)throw Error("No active company");let{data:e,error:f}=await b.from("company_memberships").select("user_id, role").eq("id",a).eq("company_id",c).single();if(f||!e)throw Error("Team member not found");let{data:h}=await b.from("companies").select("owner_id").eq("id",c).single();return h&&h.owner_id===e.user_id?{canDelete:!1,reason:"Cannot delete company owner. Transfer ownership first before removing this team member."}:{canDelete:!0}})}c.z.object({teamMemberId:c.z.string().uuid(),newRole:c.z.enum(["owner","admin","manager","dispatcher","technician","csr"]),reason:c.z.string().optional()}),c.z.object({teamMemberId:c.z.string().uuid(),permissions:c.z.record(c.z.string(),c.z.boolean())}),(0,h.ensureServerEntryExports)([i,j]),(0,b.registerServerReference)(i,"001f005176797ef23488068124fb9a744915a477de",null),(0,b.registerServerReference)(j,"406f6624261c6dd1a908026fa1408a3f6d507b6e7d",null),a.s(["canDeleteTeamMember",()=>j,"getCurrentUserRole",()=>i])},254799,(a,b,c)=>{b.exports=a.x("crypto",()=>require("crypto"))},870547,730347,361300,a=>{"use strict";var b=a.i(313170);function c(){let a=["http://localhost:3000",process.env.SITE_URL,"http://localhost:3000",process.env.APP_URL],b="production"!==process.env.VERCEL_ENV||"production"!==process.env.DEPLOYMENT_ENV;for(let c of a)if(c&&c.trim()){let a=c.trim();if((a.includes("localhost")||a.includes("127.0.0.1")||a.includes("0.0.0.0"))&&!b)continue;let d=a.startsWith("http")?a:`https://${a}`;return`${d.replace(/\/+$/,"")}/api/webhooks/telnyx`}}async function d(a){let d=a||b.TELNYX_CONFIG.messagingProfileId,e={exists:!1,isActive:!1,hasWebhookUrl:!1,webhookUrl:null,webhookFailoverUrl:null,webhookApiVersion:null,needsFix:!1,issues:[]};if(!d||""===d.trim())return e.issues.push("Messaging profile ID is not configured"),e.needsFix=!0,e;try{let a=(await b.telnyxClient.messagingProfiles.retrieve(d)).data;if(!a)return e.issues.push(`Messaging profile ${d} not found in Telnyx`),e.needsFix=!0,e;e.exists=!0,e.isActive=!1!==a.enabled,e.webhookUrl=a.webhook_url||null,e.webhookFailoverUrl=a.webhook_failover_url||null,e.webhookApiVersion=a.webhook_api_version||null;let f=c();if(f)if(e.webhookUrl){let a=e.webhookUrl.split("?")[0];a===f||e.webhookUrl===f?e.hasWebhookUrl=!0:(e.issues.push(`Webhook URL base is not set correctly. Expected: ${f}, Current: ${a}`),e.needsFix=!0)}else e.issues.push(`Webhook URL is not set. Expected: ${f} (with optional ?company=... for multi-tenant)`),e.needsFix=!0;else"production"!==process.env.VERCEL_ENV||"production"!==process.env.DEPLOYMENT_ENV?e.issues.push("NEXT_PUBLIC_SITE_URL is not set. Set it to your production URL (e.g., https://yourdomain.com) or use a tool like ngrok for local testing."):e.issues.push("NEXT_PUBLIC_SITE_URL is not set to a valid production URL. Set it to your production domain (e.g., https://yourdomain.com) in your environment variables."),e.needsFix=!0;return"2"!==e.webhookApiVersion&&(e.issues.push(`Webhook API version should be "2", but is "${e.webhookApiVersion||"not set"}"`),e.needsFix=!0),e.isActive||(e.issues.push("Messaging profile is not enabled"),e.needsFix=!0),e}catch(a){return a?.statusCode===404?e.issues.push(`Messaging profile ${d} not found in Telnyx`):e.issues.push(a?.message||"Failed to retrieve messaging profile"),e.needsFix=!0,e}}async function e(a,e){let f=a||b.TELNYX_CONFIG.messagingProfileId,g=[];if(!f||""===f.trim())return{success:!1,fixed:!1,error:"Messaging profile ID is not configured",changes:[]};try{let a=await d(f);if(!a.needsFix)return{success:!0,fixed:!1,changes:[]};let h=e?.webhookUrl||c();if(!h)return{success:!1,fixed:!1,error:"NEXT_PUBLIC_SITE_URL must be set to a valid production URL to configure webhooks",changes:[]};let i={};a.webhookUrl!==h&&(i.webhook_url=h,g.push(`Updated webhook URL to ${h}`));let j=e?.webhookFailoverUrl||process.env.TELNYX_WEBHOOK_FAILOVER_URL||null;return a.webhookFailoverUrl!==j&&(i.webhook_failover_url=j,j?g.push(`Updated webhook failover URL to ${j}`):g.push("Removed webhook failover URL")),"2"!==a.webhookApiVersion&&(i.webhook_api_version="2",g.push("Updated webhook API version to 2")),a.isActive||(i.enabled=!0,g.push("Enabled messaging profile")),Object.keys(i).length>0&&await b.telnyxClient.messagingProfiles.update(f,i),{success:!0,fixed:g.length>0,changes:g}}catch(a){return{success:!1,fixed:!1,error:a?.message||"Failed to update messaging profile",changes:g}}}async function f(a){try{let c=await b.telnyxClient.availablePhoneNumbers.list({filter:{country_code:a.countryCode||"US",national_destination_code:a.areaCode,features:a.features,limit:a.limit||10,starts_with:a.startsWith,ends_with:a.endsWith,contains:a.contains}});return{success:!0,data:c.data}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to search numbers"}}}async function g(a){try{let c=await b.telnyxClient.numberOrders.create({phone_numbers:[{phone_number:a.phoneNumber}],messaging_profile_id:a.messagingProfileId,connection_id:a.connectionId,billing_group_id:a.billingGroupId,customer_reference:a.customerReference});return{success:!0,orderId:c.data?.id,data:c.data}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to purchase number"}}}async function h(a){try{let c=await b.telnyxClient.phoneNumbers.list({page:{size:a?.pageSize||20,number:a?.pageNumber||1},filter:{tag:a?.filterTag,status:a?.filterStatus}});return{success:!0,data:c.data,meta:c.meta}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to list numbers"}}}async function i(a){try{let c=await b.telnyxClient.phoneNumbers.retrieve(a);return{success:!0,data:c.data}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to retrieve number"}}}async function j(a){try{let c=await b.telnyxClient.phoneNumbers.update(a.phoneNumberId,{connection_id:a.connectionId,messaging_profile_id:a.messagingProfileId,billing_group_id:a.billingGroupId,tags:a.tags,customer_reference:a.customerReference});return{success:!0,data:c.data}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to update number"}}}async function k(a){try{return await b.telnyxClient.phoneNumbers.del(a),{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to release number"}}}async function l(a){try{let c=await b.telnyxClient.numberPortouts.create({phone_numbers:a.phoneNumbers,billing_group_id:a.billingGroupId,fast_port_eligible:a.fastPortEligible,customer_reference:{account_number:a.accountNumber,account_pin:a.accountPin,authorized_person:a.authorizedPerson},service_address:{address_line_1:a.addressLine1,city:a.city,state_or_province:a.stateOrProvince,zip_or_postal_code:a.zipOrPostalCode,country_code:a.countryCode||"US"}});return{success:!0,portingOrderId:c.data.id,data:c.data}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to initiate porting"}}}a.s(["fixMessagingProfile",()=>e,"verifyMessagingProfile",()=>d],870547),a.s(["getNumberDetails",()=>i,"initiatePorting",()=>l,"listOwnedNumbers",()=>h,"purchaseNumber",()=>g,"releaseNumber",()=>k,"searchAvailableNumbers",()=>f,"updateNumber",()=>j],730347);let m=["sms","mms","voice"],n="company_telnyx_settings";async function o(){for(let a of["http://localhost:3000",process.env.SITE_URL,"http://localhost:3000",process.env.APP_URL]){if(!a)continue;let b=a.trim();if(b&&!/localhost|127\.0\.0\.1|0\.0\.0\.0/i.test(b)){if(b.startsWith("http"))return b.replace(/\/+$/,"");return`https://${b.replace(/\/+$/,"")}`}}}async function p(a){let b=await o();if(b)return`${b}/api/webhooks/telnyx?company=${a}`}async function q(a,b,c,d){if(0!==c.length)for(let e of c){let c=e.phoneNumber.replace(/[^0-9]/g,""),f=c.startsWith("+")?c:c.startsWith("1")&&11===c.length?`+${c}`:`+1${c}`,g={company_id:b,phone_number:f,formatted_number:function(a){let b=a.replace(/[^0-9]/g,"");return 11===b.length&&b.startsWith("1")?`(${b.slice(1,4)}) ${b.slice(4,7)}-${b.slice(7)}`:10===b.length?`(${b.slice(0,3)}) ${b.slice(3,6)}-${b.slice(6)}`:a}(f),area_code:e.areaCode||f.slice(2,5),country_code:e.countryCode||"US",number_type:e.numberType||"local",status:"active",features:m,telnyx_phone_number_id:e.telnyxPhoneNumberId||null,telnyx_messaging_profile_id:d.messagingProfileId,telnyx_connection_id:d.connectionId},{data:h}=await a.from("phone_numbers").select("id").eq("company_id",b).eq("phone_number",f).maybeSingle();h?.id?await a.from("phone_numbers").update(g).eq("id",h.id):await a.from("phone_numbers").insert(g)}}async function r(a,c){return(await b.telnyxClient.messagingProfiles.create({name:`${a} - Thorbis`,enabled:!0,webhook_url:c,webhook_api_version:"2"})).data}async function s(a,c){return(await b.telnyxClient.callControlApplications.create({application_name:`${a} - Thorbis`,webhook_event_url:c,webhook_api_version:"2",answering_machine_detection:"premium"})).data}async function t(a,b){let c=await f({areaCode:b.areaCode,features:b.features||m,limit:Math.max(2*b.quantity,b.quantity)});if(!c.success||!c.data||0===c.data.length)throw Error("No available phone numbers found for requested criteria");let d=[];for(let e of c.data){if(d.length>=b.quantity)break;let c=e.phone_number,f=await g({phoneNumber:c,messagingProfileId:b.messagingProfileId,connectionId:b.connectionId,customerReference:`company:${a}`});if(!f.success)throw Error(f.error||`Failed to purchase number ${c} from Telnyx`);d.push({phoneNumber:c,areaCode:e.national_destination_code||e.area_code,telnyxPhoneNumberId:e.id||e.phone_number,numberType:e.number_type})}if(0===d.length)throw Error("Failed to purchase any phone numbers");for(let a of d)if(a.telnyxPhoneNumberId)try{let c=process.env.TELNYX_API_KEY;if(!c)throw Error("TELNYX_API_KEY not configured");await fetch(`https://api.telnyx.com/v2/phone_numbers/${a.telnyxPhoneNumberId}/messaging`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({messaging_profile_id:b.messagingProfileId})})}catch(b){console.warn(`Failed to enable messaging on ${a.phoneNumber}:`,b)}return d}async function u(a,b){let{data:c}=await a.from(n).select("*").eq("company_id",b).maybeSingle();return c??null}async function v(a){let{supabase:b,companyId:c}=a,d=[],e=await u(b,c);if(e&&"ready"===e.status&&e.messaging_profile_id&&e.call_control_application_id)return d.push("Existing Telnyx configuration found"),{success:!0,settings:e,log:d};let{data:f}=await b.from("companies").select("id, name").eq("id",c).maybeSingle();if(!f)return{success:!1,error:"Company not found",log:d};let g=await p(c);if(!g)return{success:!1,error:"NEXT_PUBLIC_SITE_URL must be configured with a public URL to provision Telnyx resources",log:d};try{d.push("Creating messaging profile");let e=await r(f.name||"Company",g),h=e?.id;d.push("Creating call control application");let i=await s(f.name||"Company",g),j=i?.id;if(!h||!j)throw Error("Failed to provision messaging profile or call control application");d.push("Purchasing phone numbers");let k=await t(c,{quantity:Math.max(a.numberQuantity||1,1),areaCode:a.areaCode,features:a.features||m,messagingProfileId:h,connectionId:j});await q(b,c,k,{messagingProfileId:h,connectionId:j});let l=k.find(a=>"toll-free"===a.numberType)||k[0],o=await b.from(n).upsert({company_id:c,status:"ready",messaging_profile_id:h,call_control_application_id:j,default_outbound_number:l?.phoneNumber||null,default_outbound_phone_number_id:l?.telnyxPhoneNumberId||null,metadata:{log:d,purchased_numbers:k.map(a=>a.phoneNumber)},last_provisioned_at:new Date().toISOString()},{onConflict:"company_id"}).select("*").single();return{success:!0,settings:o.data,log:d}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to provision Telnyx resources",log:d}}}async function w(a){let{supabase:b,companyId:c,quantity:d}=a,e=[],f=await u(b,c);if(!f||"ready"!==f.status||!f.messaging_profile_id||!f.call_control_application_id)return{success:!1,error:"Company Telnyx configuration is not ready. Run ensureCompanyTelnyxSetup first.",log:e};try{e.push(`Purchasing ${d} additional numbers`);let g=await t(c,{quantity:d,areaCode:a.areaCode,features:a.features||m,messagingProfileId:f.messaging_profile_id,connectionId:f.call_control_application_id});await q(b,c,g,{messagingProfileId:f.messaging_profile_id,connectionId:f.call_control_application_id});let h=g.find(a=>"toll-free"===a.numberType);return h&&f.default_outbound_number!==h.phoneNumber&&await b.from(n).update({default_outbound_number:h.phoneNumber,default_outbound_phone_number_id:h.telnyxPhoneNumberId||null}).eq("company_id",c),{success:!0,settings:f,log:e}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to purchase phone numbers",log:e}}}a.s(["ensureCompanyTelnyxSetup",()=>v,"fetchCompanyTelnyxSettings",()=>u,"purchaseAdditionalNumbers",()=>w],361300)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__edb7b9bc._.js.map