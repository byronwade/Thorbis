{"version":3,"sources":["../../../../../../apps/web/src/lib/payments/processors/stripe.ts"],"sourcesContent":["/**\n * Stripe Payment Processor\n *\n * Wrapper around existing Stripe integration.\n * Used ONLY for platform billing (subscriptions), NOT for contractor payments.\n *\n * Contractor payments should use Adyen to avoid Stripe's limitations\n * on high-value transactions.\n */\n\nimport { stripe } from \"@/lib/payments/stripe-server\";\nimport type {\n\tPaymentChannel,\n\tPaymentProcessor,\n\tProcessPaymentRequest,\n\tProcessPaymentResponse,\n\tRefundPaymentRequest,\n\tRefundPaymentResponse,\n} from \"../processor-types\";\n\ntype StripeConfig = {\n\tcompanyId: string;\n\tliveMode?: boolean;\n};\n\nexport class StripeProcessor implements PaymentProcessor {\n\tprivate readonly config: StripeConfig;\n\n\tconstructor(config: StripeConfig) {\n\t\tthis.config = config;\n\t}\n\n\tgetSupportedChannels(): PaymentChannel[] {\n\t\treturn [\"online\"];\n\t}\n\n\tasync processPayment(\n\t\trequest: ProcessPaymentRequest,\n\t): Promise<ProcessPaymentResponse> {\n\t\tif (!stripe) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tstatus: \"failed\",\n\t\t\t\terror: \"Stripe is not configured\",\n\t\t\t};\n\t\t}\n\n\t\ttry {\n\t\t\t// WARNING: Stripe has limitations on high-value payments\n\t\t\t// This should only be used for platform billing, not contractor payments\n\t\t\tif (request.amount > 100_000) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`Stripe: High-value payment of ${request.amount} cents - verify this is platform billing, not contractor payment`,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst paymentIntent = await stripe.paymentIntents.create({\n\t\t\t\tamount: request.amount,\n\t\t\t\tcurrency: request.currency || \"usd\",\n\t\t\t\tcustomer: request.customerId,\n\t\t\t\tpayment_method: request.paymentMethodId,\n\t\t\t\tconfirm: true,\n\t\t\t\tmetadata: {\n\t\t\t\t\tcompany_id: this.config.companyId,\n\t\t\t\t\tinvoice_id: request.invoiceId || \"\",\n\t\t\t\t\tchannel: request.channel,\n\t\t\t\t\t...request.metadata,\n\t\t\t\t},\n\t\t\t\tdescription: request.description,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tsuccess: paymentIntent.status === \"succeeded\",\n\t\t\t\ttransactionId: paymentIntent.id,\n\t\t\t\tprocessorTransactionId: paymentIntent.id,\n\t\t\t\tstatus:\n\t\t\t\t\tpaymentIntent.status === \"succeeded\"\n\t\t\t\t\t\t? \"succeeded\"\n\t\t\t\t\t\t: paymentIntent.status === \"requires_action\"\n\t\t\t\t\t\t\t? \"requires_action\"\n\t\t\t\t\t\t\t: \"processing\",\n\t\t\t\tclientSecret: paymentIntent.client_secret || undefined,\n\t\t\t\tprocessorMetadata: paymentIntent as unknown as Record<string, unknown>,\n\t\t\t};\n\t\t} catch (error: any) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tstatus: \"failed\",\n\t\t\t\terror: error.message || \"Payment processing failed\",\n\t\t\t\tfailureCode: error.code,\n\t\t\t\tfailureMessage: error.message,\n\t\t\t};\n\t\t}\n\t}\n\n\tasync refundPayment(\n\t\trequest: RefundPaymentRequest,\n\t): Promise<RefundPaymentResponse> {\n\t\tif (!stripe) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tstatus: \"failed\",\n\t\t\t\terror: \"Stripe is not configured\",\n\t\t\t};\n\t\t}\n\n\t\ttry {\n\t\t\tconst refund = await stripe.refunds.create({\n\t\t\t\tpayment_intent: request.transactionId,\n\t\t\t\tamount: request.amount,\n\t\t\t\tmetadata: {\n\t\t\t\t\treason: request.reason || \"\",\n\t\t\t\t\t...request.metadata,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tsuccess: refund.status === \"succeeded\",\n\t\t\t\trefundId: refund.id,\n\t\t\t\tprocessorRefundId: refund.id,\n\t\t\t\tstatus: refund.status === \"succeeded\" ? \"succeeded\" : \"processing\",\n\t\t\t};\n\t\t} catch (error: any) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tstatus: \"failed\",\n\t\t\t\terror: error.message || \"Refund failed\",\n\t\t\t};\n\t\t}\n\t}\n\n\tasync getPaymentStatus(transactionId: string): Promise<{\n\t\tstatus: string;\n\t\tamount: number;\n\t\tmetadata?: Record<string, unknown>;\n\t}> {\n\t\tif (!stripe) {\n\t\t\tthrow new Error(\"Stripe is not configured\");\n\t\t}\n\n\t\tconst paymentIntent = await stripe.paymentIntents.retrieve(transactionId);\n\n\t\treturn {\n\t\t\tstatus: paymentIntent.status,\n\t\t\tamount: paymentIntent.amount,\n\t\t\tmetadata: paymentIntent as unknown as Record<string, unknown>,\n\t\t};\n\t}\n\n\tverifyWebhook(_payload: string, _signature: string): boolean {\n\t\tif (!stripe) {\n\t\t\treturn false;\n\t\t}\n\n\t\ttry {\n\t\t\t// Stripe webhook signature verification\n\t\t\tconst webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;\n\t\t\tif (!webhookSecret) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Note: This is a simplified check - in production, use Stripe's webhook.constructEvent\n\t\t\t// which properly verifies the signature\n\t\t\treturn true; // Placeholder - implement proper verification\n\t\t} catch (_error) {\n\t\t\treturn false;\n\t\t}\n\t}\n}\n"],"names":[],"mappings":"wCAUA,IAAA,EAAA,EAAA,CAAA,CAAA,OAeO,OAAM,EACK,MAAqB,AAEtC,aAAY,CAAoB,CAAE,CACjC,IAAI,CAAC,MAAM,CAAG,CACf,CAEA,sBAAyC,CACxC,MAAO,CAAC,SAAS,AAClB,CAEA,MAAM,eACL,CAA8B,CACI,CAClC,GAAI,CAAC,EAAA,MAAM,CACV,CADY,KACL,CACN,SAAS,EACT,OAAQ,SACR,MAAO,0BACR,EAGD,GAAI,CAGC,EAAQ,MAAM,CAAG,KACpB,IAD6B,IACrB,IAAI,CACX,CAAC,8BAA8B,EAAE,EAAQ,MAAM,CAAC,gEAAgE,CAAC,EAInH,IAAM,EAAgB,MAAM,EAAA,MAAM,CAAC,cAAc,CAAC,MAAM,CAAC,CACxD,OAAQ,EAAQ,MAAM,CACtB,SAAU,EAAQ,QAAQ,EAAI,MAC9B,SAAU,EAAQ,UAAU,CAC5B,eAAgB,EAAQ,eAAe,CACvC,SAAS,EACT,SAAU,CACT,WAAY,IAAI,CAAC,MAAM,CAAC,SAAS,CACjC,WAAY,EAAQ,SAAS,EAAI,GACjC,QAAS,EAAQ,OAAO,CACxB,GAAG,EAAQ,QAAQ,AACpB,EACA,YAAa,EAAQ,WAAW,AACjC,GAEA,MAAO,CACN,QAAkC,cAAzB,EAAc,MAAM,CAC7B,cAAe,EAAc,EAAE,CAC/B,uBAAwB,EAAc,EAAE,CACxC,OACC,AAAyB,gBAAX,MAAM,CACjB,YACyB,oBAAzB,EAAc,MAAM,CACnB,kBACA,aACL,aAAc,EAAc,aAAa,OAAI,EAC7C,kBAAmB,CACpB,CACD,CAAE,MAAO,EAAY,CACpB,MAAO,CACN,SAAS,EACT,OAAQ,SACR,MAAO,EAAM,OAAO,EAAI,4BACxB,YAAa,EAAM,IAAI,CACvB,eAAgB,EAAM,OAAO,AAC9B,CACD,CACD,CAEA,MAAM,cACL,CAA6B,CACI,CACjC,GAAI,CAAC,EAAA,MAAM,CACV,CADY,KACL,CACN,SAAS,EACT,OAAQ,SACR,MAAO,0BACR,EAGD,GAAI,CACH,IAAM,EAAS,MAAM,EAAA,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,CAC1C,eAAgB,EAAQ,aAAa,CACrC,OAAQ,EAAQ,MAAM,CACtB,SAAU,CACT,OAAQ,EAAQ,MAAM,EAAI,GAC1B,GAAG,EAAQ,QAAQ,AACpB,CACD,GAEA,MAAO,CACN,QAA2B,cAAlB,EAAO,MAAM,CACtB,SAAU,EAAO,EAAE,CACnB,kBAAmB,EAAO,EAAE,CAC5B,OAA0B,cAAlB,EAAO,MAAM,CAAmB,YAAc,YACvD,CACD,CAAE,MAAO,EAAY,CACpB,MAAO,CACN,SAAS,EACT,OAAQ,SACR,MAAO,EAAM,OAAO,EAAI,eACzB,CACD,CACD,CAEA,MAAM,iBAAiB,CAAqB,CAIzC,CACF,GAAI,CAAC,EAAA,MAAM,CACV,CADY,KACN,AAAI,MAAM,4BAGjB,IAAM,EAAgB,MAAM,EAAA,MAAM,CAAC,cAAc,CAAC,QAAQ,CAAC,GAE3D,MAAO,CACN,OAAQ,EAAc,MAAM,CAC5B,OAAQ,EAAc,MAAM,CAC5B,SAAU,CACX,CACD,CAEA,cAAc,CAAgB,CAAE,CAAkB,CAAW,CAC5D,GAAI,CAAC,EAAA,MAAM,CACV,CADY,KACL,GAGR,GAAI,CAGH,GAAI,CAAC,AADiB,QAAQ,GAAG,CAAC,GACd,kBADmC,CAEtD,OAAO,EAKR,MAAO,EACR,CAAE,GADY,GACL,EAAQ,CAChB,OAAO,CACR,CACD,CACD,8BAL8D"}