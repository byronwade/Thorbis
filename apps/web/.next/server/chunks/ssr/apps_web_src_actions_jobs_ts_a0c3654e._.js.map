{"version":3,"sources":["../../../../../../apps/web/src/actions/jobs.ts","../../../../../../apps/web/src/lib/notifications/triggers.ts","../../../../../../apps/web/src/lib/validations/job-status-transitions.ts"],"sourcesContent":["/**\n * Jobs Server Actions - REFACTORED FOR DOMAIN TABLE STRUCTURE\n *\n * Handles job/work order management with comprehensive CRUD operations,\n * status transitions, scheduling, and assignment logic.\n *\n * MIGRATION NOTES:\n * - Core jobs table now has ~20 columns\n * - Domain-specific data moved to 11 domain tables\n * - Financial data -> job_financial\n * - Time tracking -> job_time_tracking\n * - Archive/deletion -> job_multi_entity\n * - All domain tables have CASCADE delete on job_id\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport {\n\tActionError,\n\tERROR_CODES,\n\tERROR_MESSAGES,\n} from \"@/lib/errors/action-error\";\nimport {\n\ttype ActionResult,\n\tassertAuthenticated,\n\tassertExists,\n\twithErrorHandling,\n} from \"@/lib/errors/with-error-handling\";\nimport { notifyJobCreated } from \"@/lib/notifications/triggers\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport {\n\ttype JobStatus,\n\ttype JobStatusTransitionContext,\n\tvalidateStatusTransition,\n} from \"@/lib/validations/job-status-transitions\";\n\n// Regex constants\nconst JOB_NUMBER_REGEX = /JOB-\\d{4}-(\\d+)/;\n\n// Validation Schemas\nconst createJobSchema = z.object({\n\tpropertyId: z.string().uuid(\"Invalid property ID\"),\n\tcustomerId: z.string().uuid(\"Invalid customer ID\").optional(),\n\ttitle: z.string().min(1, \"Job title is required\"),\n\tdescription: z.string().optional(),\n\tpriority: z.enum([\"low\", \"medium\", \"high\", \"urgent\"]).default(\"medium\"),\n\tjobType: z\n\t\t.enum([\n\t\t\t\"service\",\n\t\t\t\"installation\",\n\t\t\t\"repair\",\n\t\t\t\"maintenance\",\n\t\t\t\"inspection\",\n\t\t\t\"consultation\",\n\t\t])\n\t\t.optional(),\n\tscheduledStart: z.string().optional(),\n\tscheduledEnd: z.string().optional(),\n\tassignedTo: z.string().uuid(\"Invalid user ID\").optional(),\n\tnotes: z.string().optional(),\n\t// Enhanced scheduling fields\n\tisRecurring: z.boolean().optional(),\n\tschedulingMode: z.enum([\"specific\", \"window\"]).optional(),\n\ttimeWindow: z.string().optional(),\n\trecurrenceType: z\n\t\t.enum([\"daily\", \"weekly\", \"biweekly\", \"monthly\", \"quarterly\", \"yearly\"])\n\t\t.optional(),\n\trecurrenceEndDate: z.string().optional(),\n\trecurrenceCount: z.number().int().min(1).max(365).optional(),\n});\n\nconst updateJobSchema = z.object({\n\ttitle: z.string().min(1, \"Job title is required\").optional(),\n\tdescription: z.string().optional(),\n\tstatus: z\n\t\t.enum([\n\t\t\t\"quoted\",\n\t\t\t\"scheduled\",\n\t\t\t\"in_progress\",\n\t\t\t\"on_hold\",\n\t\t\t\"completed\",\n\t\t\t\"cancelled\",\n\t\t\t\"invoiced\",\n\t\t\t\"paid\",\n\t\t])\n\t\t.optional(),\n\tpriority: z.enum([\"low\", \"medium\", \"high\", \"urgent\"]).optional(),\n\tjobType: z\n\t\t.enum([\n\t\t\t\"service\",\n\t\t\t\"installation\",\n\t\t\t\"repair\",\n\t\t\t\"maintenance\",\n\t\t\t\"inspection\",\n\t\t\t\"consultation\",\n\t\t])\n\t\t.optional(),\n\tnotes: z.string().optional(),\n\t// Financial fields (now in job_financial domain table)\n\ttotalAmount: z.number().min(0).optional(),\n\tpaidAmount: z.number().min(0).optional(),\n\tdepositAmount: z.number().min(0).optional(),\n\tscheduledStart: z.string().optional(),\n\tscheduledEnd: z.string().optional(),\n\tassignedTo: z.string().uuid(\"Invalid user ID\").optional().nullable(),\n\tcustomerId: z.string().uuid(\"Invalid customer ID\").optional().nullable(),\n\tpropertyId: z.string().uuid(\"Invalid property ID\").optional().nullable(),\n});\n\n// Type for updateJobData - makes it easier to use programmatically\nexport type UpdateJobData = z.infer<typeof updateJobSchema>;\n\nconst scheduleJobSchema = z.object({\n\tscheduledStart: z.string(),\n\tscheduledEnd: z.string(),\n});\n\n/**\n * Generate unique job number\n */\nasync function generateJobNumber(\n\tsupabase: any,\n\tcompanyId: string,\n): Promise<string> {\n\t// Get the latest job number for this company\n\tconst { data: latestJob } = await supabase\n\t\t.from(\"jobs\")\n\t\t.select(\"job_number\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(1)\n\t\t.single();\n\n\tif (!latestJob) {\n\t\treturn `JOB-${new Date().getFullYear()}-001`;\n\t}\n\n\t// Extract number from format: JOB-YYYY-NNN\n\tconst match = latestJob.job_number.match(JOB_NUMBER_REGEX);\n\tif (match) {\n\t\tconst nextNumber = Number.parseInt(match[1], 10) + 1;\n\t\treturn `JOB-${new Date().getFullYear()}-${nextNumber.toString().padStart(3, \"0\")}`;\n\t}\n\n\t// Fallback\n\treturn `JOB-${new Date().getFullYear()}-${Date.now().toString().slice(-3)}`;\n}\n\n/**\n * Calculate next recurrence date\n */\nfunction calculateNextRecurrence(\n\tcurrentDate: Date,\n\trecurrenceType: string,\n): Date {\n\tconst nextDate = new Date(currentDate);\n\n\tswitch (recurrenceType) {\n\t\tcase \"daily\":\n\t\t\tnextDate.setDate(nextDate.getDate() + 1);\n\t\t\tbreak;\n\t\tcase \"weekly\":\n\t\t\tnextDate.setDate(nextDate.getDate() + 7);\n\t\t\tbreak;\n\t\tcase \"biweekly\":\n\t\t\tnextDate.setDate(nextDate.getDate() + 14);\n\t\t\tbreak;\n\t\tcase \"monthly\":\n\t\t\tnextDate.setMonth(nextDate.getMonth() + 1);\n\t\t\tbreak;\n\t\tcase \"quarterly\":\n\t\t\tnextDate.setMonth(nextDate.getMonth() + 3);\n\t\t\tbreak;\n\t\tcase \"yearly\":\n\t\t\tnextDate.setFullYear(nextDate.getFullYear() + 1);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t// Default to monthly if unknown type\n\t\t\tnextDate.setMonth(nextDate.getMonth() + 1);\n\t\t\tbreak;\n\t}\n\n\treturn nextDate;\n}\n\n/**\n * Create recurring jobs\n */\nasync function createRecurringJobs(\n\tsupabase: any,\n\tcompanyId: string,\n\tbaseJob: any,\n\trecurrenceType: string,\n\trecurrenceEndDate?: string,\n\trecurrenceCount?: number,\n): Promise<void> {\n\tif (!baseJob.scheduled_start) {\n\t\treturn; // Can't create recurring jobs without a start date\n\t}\n\n\tconst startDate = new Date(baseJob.scheduled_start);\n\tconst endDate = new Date(baseJob.scheduled_end || baseJob.scheduled_start);\n\tconst duration = endDate.getTime() - startDate.getTime();\n\n\t// Determine how many occurrences to create\n\tconst maxOccurrences = recurrenceCount || 52; // Default to 1 year of weekly jobs\n\tconst endDateLimit = recurrenceEndDate ? new Date(recurrenceEndDate) : null;\n\n\tconst recurringJobs: (typeof baseJob)[] = [];\n\tlet currentDate = new Date(startDate);\n\n\tfor (let i = 0; i < maxOccurrences - 1; i++) {\n\t\t// -1 because we already created the first job\n\t\tcurrentDate = calculateNextRecurrence(currentDate, recurrenceType);\n\n\t\t// Stop if we've reached the end date\n\t\tif (endDateLimit && currentDate > endDateLimit) {\n\t\t\tbreak;\n\t\t}\n\n\t\tconst currentEndDate = new Date(currentDate.getTime() + duration);\n\n\t\t// Generate a unique job number for this occurrence\n\t\tconst jobNumber = await generateJobNumber(supabase, companyId);\n\n\t\trecurringJobs.push({\n\t\t\t...baseJob,\n\t\t\tjob_number: jobNumber,\n\t\t\tscheduled_start: currentDate.toISOString(),\n\t\t\tscheduled_end: currentEndDate.toISOString(),\n\t\t\ttitle: `${baseJob.title} (${i + 2}/${maxOccurrences})`, // Add occurrence number\n\t\t});\n\n\t\t// Create jobs in batches of 10 to avoid memory issues\n\t\tif (recurringJobs.length >= 10) {\n\t\t\tawait supabase.from(\"jobs\").insert(recurringJobs);\n\t\t\trecurringJobs.length = 0; // Clear array\n\t\t}\n\t}\n\n\t// Insert any remaining jobs\n\tif (recurringJobs.length > 0) {\n\t\tawait supabase.from(\"jobs\").insert(recurringJobs);\n\t}\n}\n\n/**\n * Create a new job\n * ‚úÖ ALREADY MIGRATED - Creates core job + all 10 domain records in parallel\n */\nexport async function createJob(\n\tformData: FormData,\n): Promise<ActionResult<string>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst data = createJobSchema.parse({\n\t\t\tpropertyId: formData.get(\"propertyId\"),\n\t\t\tcustomerId: formData.get(\"customerId\") || undefined,\n\t\t\ttitle: formData.get(\"title\"),\n\t\t\tdescription: formData.get(\"description\") || undefined,\n\t\t\tpriority: formData.get(\"priority\") || \"medium\",\n\t\t\tjobType: formData.get(\"jobType\") || undefined,\n\t\t\tscheduledStart: formData.get(\"scheduledStart\") || undefined,\n\t\t\tscheduledEnd: formData.get(\"scheduledEnd\") || undefined,\n\t\t\tassignedTo: formData.get(\"assignedTo\") || undefined,\n\t\t\tnotes: formData.get(\"notes\") || undefined,\n\t\t\t// Enhanced scheduling fields\n\t\t\tisRecurring: formData.get(\"isRecurring\") === \"true\",\n\t\t\tschedulingMode: (formData.get(\"schedulingMode\") as any) || undefined,\n\t\t\ttimeWindow: formData.get(\"timeWindow\") || undefined,\n\t\t\trecurrenceType: (formData.get(\"recurrenceType\") as any) || undefined,\n\t\t\trecurrenceEndDate: formData.get(\"recurrenceEndDate\") || undefined,\n\t\t\trecurrenceCount: formData.get(\"recurrenceCount\")\n\t\t\t\t? Number.parseInt(formData.get(\"recurrenceCount\") as string, 10)\n\t\t\t\t: undefined,\n\t\t});\n\n\t\t// Verify property belongs to company\n\t\tconst { data: property } = await supabase\n\t\t\t.from(\"properties\")\n\t\t\t.select(\"company_id, customer_id, address\")\n\t\t\t.eq(\"id\", data.propertyId)\n\t\t\t.single();\n\n\t\tassertExists(property, \"Property\");\n\n\t\tif (property.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"property\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Use customer from property if not provided\n\t\tconst customerId = data.customerId || property.customer_id;\n\n\t\t// Generate unique job number\n\t\tconst jobNumber = await generateJobNumber(supabase, companyId);\n\n\t\t// Add time window info to notes if applicable\n\t\tlet jobNotes = data.notes || \"\";\n\t\tif (data.schedulingMode === \"window\" && data.timeWindow) {\n\t\t\tconst windowInfo = `\\n\\n[Scheduling] Customer preferred time window: ${data.timeWindow.charAt(0).toUpperCase() + data.timeWindow.slice(1)}`;\n\t\t\tjobNotes = jobNotes ? `${jobNotes}${windowInfo}` : windowInfo.trim();\n\t\t}\n\n\t\t// Create core job record\n\t\tconst { data: newJob, error: createError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tproperty_id: data.propertyId,\n\t\t\t\tcustomer_id: customerId,\n\t\t\t\tassigned_to: data.assignedTo,\n\t\t\t\tjob_number: jobNumber,\n\t\t\t\ttitle: data.title,\n\t\t\t\tdescription: data.description,\n\t\t\t\tstatus: \"quoted\",\n\t\t\t\tpriority: data.priority,\n\t\t\t\tjob_type: data.jobType,\n\t\t\t\tservice_type: data.jobType, // Default service_type to job_type\n\t\t\t\tscheduled_start: data.scheduledStart,\n\t\t\t\tscheduled_end: data.scheduledEnd,\n\t\t\t\tnotes: jobNotes,\n\t\t\t})\n\t\t\t.select(\"id\")\n\t\t\t.single();\n\n\t\tif (createError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"create job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Create domain records (parallel inserts for performance)\n\t\tconst domainInserts = await Promise.all([\n\t\t\t// Financial domain - always create with defaults\n\t\t\tsupabase\n\t\t\t\t.from(\"job_financial\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\ttotal_amount: 0,\n\t\t\t\t\tpaid_amount: 0,\n\t\t\t\t\tdeposit_amount: 0,\n\t\t\t\t}),\n\n\t\t\t// Workflow domain - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_workflow\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\tworkflow_completed_stages: [],\n\t\t\t\t}),\n\n\t\t\t// Time tracking - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_time_tracking\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\ttotal_labor_hours: 0,\n\t\t\t\t\tbreak_time_minutes: 0,\n\t\t\t\t}),\n\n\t\t\t// Customer approval - always create with pending\n\t\t\tsupabase\n\t\t\t\t.from(\"job_customer_approval\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\tcustomer_approval_status: \"pending\",\n\t\t\t\t}),\n\n\t\t\t// Equipment service - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_equipment_service\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\tequipment_service_history: [],\n\t\t\t\t\tequipment_serviced: [],\n\t\t\t\t}),\n\n\t\t\t// Dispatch - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_dispatch\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t}),\n\n\t\t\t// Quality - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_quality\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\tinspection_required: false,\n\t\t\t\t}),\n\n\t\t\t// Safety - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_safety\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\trequires_permit: false,\n\t\t\t\t}),\n\n\t\t\t// AI enrichment - create empty for future processing\n\t\t\tsupabase\n\t\t\t\t.from(\"job_ai_enrichment\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t}),\n\n\t\t\t// Multi-entity - always create\n\t\t\tsupabase\n\t\t\t\t.from(\"job_multi_entity\")\n\t\t\t\t.insert({\n\t\t\t\t\tjob_id: newJob.id,\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\trequires_multiple_properties: false,\n\t\t\t\t\trequires_multiple_customers: false,\n\t\t\t\t}),\n\t\t]);\n\n\t\t// Check for any domain insert errors\n\t\tconst domainErrors = domainInserts.filter((result) => result.error);\n\t\tif (domainErrors.length > 0) {\n\t\t\t// Rollback - delete the job (CASCADE will delete domain records)\n\t\t\tawait supabase.from(\"jobs\").delete().eq(\"id\", newJob.id);\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"create job domains\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Create recurring jobs if requested\n\t\tif (data.isRecurring && data.recurrenceType && data.scheduledStart) {\n\t\t\tconst baseJob = {\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tproperty_id: data.propertyId,\n\t\t\t\tcustomer_id: customerId,\n\t\t\t\tassigned_to: data.assignedTo,\n\t\t\t\ttitle: data.title,\n\t\t\t\tdescription: data.description,\n\t\t\t\tstatus: \"quoted\",\n\t\t\t\tpriority: data.priority,\n\t\t\t\tjob_type: data.jobType,\n\t\t\t\tscheduled_start: data.scheduledStart,\n\t\t\t\tscheduled_end: data.scheduledEnd,\n\t\t\t\tnotes: data.notes,\n\t\t\t};\n\n\t\t\tawait createRecurringJobs(\n\t\t\t\tsupabase,\n\t\t\t\tcompanyId,\n\t\t\t\tbaseJob,\n\t\t\t\tdata.recurrenceType,\n\t\t\t\tdata.recurrenceEndDate,\n\t\t\t\tdata.recurrenceCount,\n\t\t\t);\n\t\t}\n\n\t\t// Send notification to assigned user if job is assigned\n\t\tif (data.assignedTo && data.assignedTo !== user.id) {\n\t\t\tawait notifyJobCreated({\n\t\t\t\tuserId: data.assignedTo,\n\t\t\t\tcompanyId: companyId,\n\t\t\t\tjobId: newJob.id,\n\t\t\t\tjobTitle: data.title,\n\t\t\t\taddress: property.address || \"Unknown address\",\n\t\t\t\tpriority:\n\t\t\t\t\tdata.priority === \"urgent\"\n\t\t\t\t\t\t? \"urgent\"\n\t\t\t\t\t\t: data.priority === \"high\"\n\t\t\t\t\t\t\t? \"high\"\n\t\t\t\t\t\t\t: \"medium\",\n\t\t\t\tactionUrl: \"/dashboard/work\",\n\t\t\t});\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(\"/dashboard/work/jobs\");\n\t\treturn newJob.id;\n\t});\n}\n\n/**\n * Get a single job by ID\n * ‚úÖ ALREADY MIGRATED - Fetches job with all domain data\n */\nasync function getJob(jobId: string): Promise<ActionResult<any>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Get job with basic relationships\n\t\t// Simplified query - many domain tables don't exist yet\n\t\tconst { data: job, error: jobError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\n\t\t\t\t`\n\t\t\t\t*,\n\t\t\t\tproperty:properties(*),\n\t\t\t\tcustomer:customers!customer_id(id, first_name, last_name, email, phone, display_name)\n\t\t\t`,\n\t\t\t)\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (jobError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.notFound(\"Job\"),\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t404,\n\t\t\t);\n\t\t}\n\n\t\tassertExists(job, \"Job\");\n\n\t\t// Verify job belongs to company\n\t\tif (job.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\treturn job;\n\t});\n}\n\n/**\n * Update job details\n * üîß REFACTORED - Now updates both core jobs table and domain tables\n */\nexport async function updateJob(\n\tjobId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID\n\t\tconst activeCompanyId = await getActiveCompanyId();\n\t\tif (!activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Get user's role to check if they're admin/owner\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\n\t\t\t\t`\n        role_id,\n        custom_roles!role_id(name, is_system)\n      `,\n\t\t\t)\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"company_id\", activeCompanyId)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.maybeSingle();\n\n\t\tconst role = Array.isArray(teamMember?.custom_roles)\n\t\t\t? teamMember.custom_roles[0]\n\t\t\t: teamMember?.custom_roles;\n\n\t\tconst isAdminOrOwner =\n\t\t\trole?.name === \"Admin\" ||\n\t\t\trole?.name === \"Owner\" ||\n\t\t\trole?.is_system === true;\n\n\t\t// Verify job belongs to company\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, status\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== activeCompanyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Prevent editing completed or cancelled jobs (unless admin/owner)\n\t\tif (\n\t\t\t!isAdminOrOwner &&\n\t\t\t(existingJob.status === \"completed\" || existingJob.status === \"cancelled\")\n\t\t) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Cannot edit ${existingJob.status} jobs`,\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\tconst customerIdValue = formData.get(\"customerId\");\n\t\tconst propertyIdValue = formData.get(\"propertyId\");\n\n\t\t// Handle customerId: empty string or \"null\" string means remove (set to null)\n\t\t// undefined means don't change it\n\t\tlet parsedCustomerId: string | null | undefined;\n\t\tif (customerIdValue === null || customerIdValue === undefined) {\n\t\t\tparsedCustomerId = undefined; // Don't change\n\t\t} else if (customerIdValue === \"\" || customerIdValue === \"null\") {\n\t\t\tparsedCustomerId = null; // Remove customer\n\t\t} else {\n\t\t\tparsedCustomerId = customerIdValue as string; // Set to this customer\n\t\t}\n\n\t\t// Handle propertyId: empty string means remove (set to null), undefined means don't change\n\t\tlet parsedPropertyId: string | null | undefined;\n\t\tif (propertyIdValue === null || propertyIdValue === undefined) {\n\t\t\tparsedPropertyId = undefined; // Don't change\n\t\t} else if (propertyIdValue === \"\" || propertyIdValue === \"null\") {\n\t\t\tparsedPropertyId = null; // Remove property\n\t\t} else {\n\t\t\tparsedPropertyId = propertyIdValue as string; // Set to this property\n\t\t}\n\n\t\tconst data = updateJobSchema.parse({\n\t\t\ttitle: formData.get(\"title\") || undefined,\n\t\t\tdescription: formData.get(\"description\") || undefined,\n\t\t\tstatus: formData.get(\"status\") || undefined,\n\t\t\tpriority: formData.get(\"priority\") || undefined,\n\t\t\tjobType: formData.get(\"jobType\") || undefined,\n\t\t\tnotes: formData.get(\"notes\") || undefined,\n\t\t\t// Financial fields (now in job_financial domain table)\n\t\t\ttotalAmount: formData.get(\"totalAmount\")\n\t\t\t\t? Number.parseInt(formData.get(\"totalAmount\") as string, 10)\n\t\t\t\t: undefined,\n\t\t\tpaidAmount: formData.get(\"paidAmount\")\n\t\t\t\t? Number.parseInt(formData.get(\"paidAmount\") as string, 10)\n\t\t\t\t: undefined,\n\t\t\tdepositAmount: formData.get(\"depositAmount\")\n\t\t\t\t? Number.parseInt(formData.get(\"depositAmount\") as string, 10)\n\t\t\t\t: undefined,\n\t\t\tscheduledStart: formData.get(\"scheduledStart\") || undefined,\n\t\t\tscheduledEnd: formData.get(\"scheduledEnd\") || undefined,\n\t\t\tassignedTo: formData.get(\"assignedTo\") || null,\n\t\t\tcustomerId: parsedCustomerId,\n\t\t\tpropertyId: parsedPropertyId,\n\t\t});\n\n\t\t// If status is being changed, validate the transition\n\t\tif (data.status !== undefined && data.status !== existingJob.status) {\n\t\t\t// Fetch additional context for status validation\n\t\t\tconst { data: jobWithContext } = await supabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\n\t\t\t\t\t`\n\t\t\t\t\tid,\n\t\t\t\t\tstatus,\n\t\t\t\t\tscheduled_start,\n\t\t\t\t\tscheduled_end,\n\t\t\t\t\tassigned_to,\n\t\t\t\t\tcustomer_id,\n\t\t\t\t\tproperty_id,\n\t\t\t\t\ttotal_amount,\n\t\t\t\t\tinvoices:invoices(status, total_amount),\n\t\t\t\t\testimates:estimates(status),\n\t\t\t\t\tteam_assignments:job_team_assignments(team_member_id)\n\t\t\t\t`,\n\t\t\t\t)\n\t\t\t\t.eq(\"id\", jobId)\n\t\t\t\t.single();\n\n\t\t\tif (jobWithContext) {\n\t\t\t\tconst transitionContext: JobStatusTransitionContext = {\n\t\t\t\t\tcurrentStatus: jobWithContext.status as JobStatus,\n\t\t\t\t\tnewStatus: data.status as JobStatus,\n\t\t\t\t\tjob: {\n\t\t\t\t\t\tid: jobWithContext.id,\n\t\t\t\t\t\tscheduled_start:\n\t\t\t\t\t\t\tdata.scheduledStart || jobWithContext.scheduled_start,\n\t\t\t\t\t\tscheduled_end: data.scheduledEnd || jobWithContext.scheduled_end,\n\t\t\t\t\t\tassigned_to:\n\t\t\t\t\t\t\tdata.assignedTo !== undefined\n\t\t\t\t\t\t\t\t? data.assignedTo\n\t\t\t\t\t\t\t\t: jobWithContext.assigned_to,\n\t\t\t\t\t\tcustomer_id:\n\t\t\t\t\t\t\tdata.customerId !== undefined\n\t\t\t\t\t\t\t\t? data.customerId\n\t\t\t\t\t\t\t\t: jobWithContext.customer_id,\n\t\t\t\t\t\tproperty_id:\n\t\t\t\t\t\t\tdata.propertyId !== undefined\n\t\t\t\t\t\t\t\t? data.propertyId\n\t\t\t\t\t\t\t\t: jobWithContext.property_id,\n\t\t\t\t\t\ttotal_amount:\n\t\t\t\t\t\t\tdata.totalAmount !== undefined\n\t\t\t\t\t\t\t\t? data.totalAmount\n\t\t\t\t\t\t\t\t: jobWithContext.total_amount,\n\t\t\t\t\t\tinvoices: jobWithContext.invoices || [],\n\t\t\t\t\t\testimates: jobWithContext.estimates || [],\n\t\t\t\t\t\tteamAssignments: jobWithContext.team_assignments || [],\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\tconst validationResult = validateStatusTransition(transitionContext);\n\n\t\t\t\tif (!validationResult.allowed) {\n\t\t\t\t\tlet errorMessage =\n\t\t\t\t\t\tvalidationResult.reason || \"Status transition not allowed\";\n\n\t\t\t\t\tif (\n\t\t\t\t\t\tvalidationResult.requiredFields &&\n\t\t\t\t\t\tvalidationResult.requiredFields.length > 0\n\t\t\t\t\t) {\n\t\t\t\t\t\terrorMessage += `. Missing: ${validationResult.requiredFields.join(\", \")}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tthrow new ActionError(errorMessage, ERROR_CODES.VALIDATION_FAILED);\n\t\t\t\t}\n\n\t\t\t\t// Log warnings if present (non-blocking)\n\t\t\t\tif (validationResult.warnings && validationResult.warnings.length > 0) {\n\t\t\t\t\tconsole.warn(\"‚ö†Ô∏è Status transition warnings:\", {\n\t\t\t\t\t\tjobId,\n\t\t\t\t\t\tcurrentStatus: jobWithContext.status,\n\t\t\t\t\t\tnewStatus: data.status,\n\t\t\t\t\t\twarnings: validationResult.warnings,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Build core job update object with only defined values\n\t\tconst coreUpdateData: any = {};\n\t\tif (data.title !== undefined) {\n\t\t\tcoreUpdateData.title = data.title;\n\t\t}\n\t\tif (data.description !== undefined) {\n\t\t\tcoreUpdateData.description = data.description;\n\t\t}\n\t\tif (data.status !== undefined) {\n\t\t\tcoreUpdateData.status = data.status;\n\t\t}\n\t\tif (data.priority !== undefined) {\n\t\t\tcoreUpdateData.priority = data.priority;\n\t\t}\n\t\tif (data.jobType !== undefined) {\n\t\t\tcoreUpdateData.job_type = data.jobType;\n\t\t}\n\t\tif (data.notes !== undefined) {\n\t\t\tcoreUpdateData.notes = data.notes;\n\t\t}\n\t\tif (data.scheduledStart !== undefined) {\n\t\t\tcoreUpdateData.scheduled_start = data.scheduledStart;\n\t\t}\n\t\tif (data.scheduledEnd !== undefined) {\n\t\t\tcoreUpdateData.scheduled_end = data.scheduledEnd;\n\t\t}\n\t\tif (data.assignedTo !== undefined) {\n\t\t\tcoreUpdateData.assigned_to = data.assignedTo;\n\t\t}\n\t\tif (data.customerId !== undefined) {\n\t\t\tcoreUpdateData.customer_id = data.customerId;\n\t\t}\n\t\tif (data.propertyId !== undefined) {\n\t\t\tcoreUpdateData.property_id = data.propertyId;\n\t\t\t// If property is being set (not null), verify it belongs to the customer (if customer is set)\n\t\t\tif (\n\t\t\t\tdata.propertyId !== null &&\n\t\t\t\tdata.customerId !== undefined &&\n\t\t\t\tdata.customerId !== null\n\t\t\t) {\n\t\t\t\tconst { data: property } = await supabase\n\t\t\t\t\t.from(\"properties\")\n\t\t\t\t\t.select(\"customer_id\")\n\t\t\t\t\t.eq(\"id\", data.propertyId)\n\t\t\t\t\t.single();\n\n\t\t\t\tif (property && property.customer_id !== data.customerId) {\n\t\t\t\t\tthrow new ActionError(\n\t\t\t\t\t\t\"Property does not belong to the selected customer\",\n\t\t\t\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Build financial domain update object (if any financial fields provided)\n\t\tconst financialUpdateData: any = {};\n\t\tif (data.totalAmount !== undefined) {\n\t\t\tfinancialUpdateData.total_amount = data.totalAmount;\n\t\t}\n\t\tif (data.paidAmount !== undefined) {\n\t\t\tfinancialUpdateData.paid_amount = data.paidAmount;\n\t\t}\n\t\tif (data.depositAmount !== undefined) {\n\t\t\tfinancialUpdateData.deposit_amount = data.depositAmount;\n\t\t}\n\n\t\t// Execute updates in parallel for performance\n\t\tconst updates: Promise<any>[] = [];\n\n\t\t// Update core job table if there are changes\n\t\tif (Object.keys(coreUpdateData).length > 0) {\n\t\t\tupdates.push(\n\t\t\t\t(async () => await supabase.from(\"jobs\").update(coreUpdateData).eq(\"id\", jobId))(),\n\t\t\t);\n\t\t}\n\n\t\t// Update financial domain table if there are changes\n\t\tif (Object.keys(financialUpdateData).length > 0) {\n\t\t\tupdates.push(\n\t\t\t\t(async () =>\n\t\t\t\t\tawait supabase\n\t\t\t\t\t\t.from(\"job_financial\")\n\t\t\t\t\t\t.update(financialUpdateData)\n\t\t\t\t\t\t.eq(\"job_id\", jobId))(),\n\t\t\t);\n\t\t}\n\n\t\t// Execute all updates in parallel\n\t\tif (updates.length > 0) {\n\t\t\tconst results = await Promise.all(updates);\n\n\t\t\t// Check for errors in any update\n\t\t\tconst errors = results.filter((result) => result.error);\n\t\t\tif (errors.length > 0) {\n\t\t\t\tconst errorMessages = errors.map((e) => e.error.message).join(\", \");\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\t`${ERROR_MESSAGES.operationFailed(\"update job\")}: ${errorMessages}`,\n\t\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Update job with data object (easier for programmatic use)\n * Used by job editor for in-place updates\n */\nasync function updateJobData(\n\tjobId: string,\n\tdata: Partial<UpdateJobData>,\n): Promise<ActionResult<void>> {\n\t// Convert data object to FormData for compatibility with existing updateJob\n\tconst formData = new FormData();\n\n\t// Add all defined fields to FormData\n\tif (data.title !== undefined) formData.append(\"title\", data.title);\n\tif (data.description !== undefined)\n\t\tformData.append(\"description\", data.description);\n\tif (data.status !== undefined) formData.append(\"status\", data.status);\n\tif (data.priority !== undefined) formData.append(\"priority\", data.priority);\n\tif (data.jobType !== undefined) formData.append(\"jobType\", data.jobType);\n\tif (data.notes !== undefined) formData.append(\"notes\", data.notes);\n\tif (data.totalAmount !== undefined)\n\t\tformData.append(\"totalAmount\", data.totalAmount.toString());\n\tif (data.paidAmount !== undefined)\n\t\tformData.append(\"paidAmount\", data.paidAmount.toString());\n\tif (data.depositAmount !== undefined)\n\t\tformData.append(\"depositAmount\", data.depositAmount.toString());\n\tif (data.scheduledStart !== undefined)\n\t\tformData.append(\"scheduledStart\", data.scheduledStart);\n\tif (data.scheduledEnd !== undefined)\n\t\tformData.append(\"scheduledEnd\", data.scheduledEnd);\n\tif (data.assignedTo !== undefined)\n\t\tformData.append(\"assignedTo\", data.assignedTo || \"\");\n\tif (data.customerId !== undefined)\n\t\tformData.append(\"customerId\", data.customerId || \"\");\n\tif (data.propertyId !== undefined)\n\t\tformData.append(\"propertyId\", data.propertyId || \"\");\n\n\t// Reuse existing updateJob logic (which already handles errors)\n\treturn updateJob(jobId, formData);\n}\n\n/**\n * Update job status with validation\n * ‚úÖ NO CHANGES NEEDED - Only updates jobs.status\n */\nexport async function updateJobStatus(\n\tjobId: string,\n\tnewStatus: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Validate status value\n\t\tconst validStatuses: JobStatus[] = [\n\t\t\t\"quoted\",\n\t\t\t\"scheduled\",\n\t\t\t\"in_progress\",\n\t\t\t\"on_hold\",\n\t\t\t\"completed\",\n\t\t\t\"cancelled\",\n\t\t\t\"invoiced\",\n\t\t\t\"paid\",\n\t\t];\n\t\tif (!validStatuses.includes(newStatus as JobStatus)) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Invalid job status\",\n\t\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t\t);\n\t\t}\n\n\t\t// Fetch job with all context needed for transition validation\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\n\t\t\t\t`\n\t\t\t\tid,\n\t\t\t\tcompany_id,\n\t\t\t\tstatus,\n\t\t\t\tscheduled_start,\n\t\t\t\tscheduled_end,\n\t\t\t\tassigned_to,\n\t\t\t\tcustomer_id,\n\t\t\t\tproperty_id,\n\t\t\t\ttotal_amount,\n\t\t\t\tinvoices:invoices(status, total_amount),\n\t\t\t\testimates:estimates(status),\n\t\t\t\tteam_assignments:job_team_assignments(team_member_id)\n\t\t\t`,\n\t\t\t)\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Build context for transition validation\n\t\tconst transitionContext: JobStatusTransitionContext = {\n\t\t\tcurrentStatus: existingJob.status as JobStatus,\n\t\t\tnewStatus: newStatus as JobStatus,\n\t\t\tjob: {\n\t\t\t\tid: existingJob.id,\n\t\t\t\tscheduled_start: existingJob.scheduled_start,\n\t\t\t\tscheduled_end: existingJob.scheduled_end,\n\t\t\t\tassigned_to: existingJob.assigned_to,\n\t\t\t\tcustomer_id: existingJob.customer_id,\n\t\t\t\tproperty_id: existingJob.property_id,\n\t\t\t\ttotal_amount: existingJob.total_amount,\n\t\t\t\tinvoices: existingJob.invoices || [],\n\t\t\t\testimates: existingJob.estimates || [],\n\t\t\t\tteamAssignments: existingJob.team_assignments || [],\n\t\t\t},\n\t\t};\n\n\t\t// Validate transition with comprehensive business rules\n\t\tconst validationResult = validateStatusTransition(transitionContext);\n\n\t\tif (!validationResult.allowed) {\n\t\t\tlet errorMessage =\n\t\t\t\tvalidationResult.reason || \"Status transition not allowed\";\n\n\t\t\tif (\n\t\t\t\tvalidationResult.requiredFields &&\n\t\t\t\tvalidationResult.requiredFields.length > 0\n\t\t\t) {\n\t\t\t\terrorMessage += `. Missing: ${validationResult.requiredFields.join(\", \")}`;\n\t\t\t}\n\n\t\t\tthrow new ActionError(errorMessage, ERROR_CODES.VALIDATION_FAILED);\n\t\t}\n\n\t\t// Log warnings if present (non-blocking)\n\t\tif (validationResult.warnings && validationResult.warnings.length > 0) {\n\t\t\tconsole.warn(\"‚ö†Ô∏è Status transition warnings:\", {\n\t\t\t\tjobId,\n\t\t\t\tcurrentStatus: existingJob.status,\n\t\t\t\tnewStatus,\n\t\t\t\twarnings: validationResult.warnings,\n\t\t\t});\n\t\t}\n\n\t\t// Update status\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.update({ status: newStatus })\n\t\t\t.eq(\"id\", jobId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update job status\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconsole.log(\"‚úÖ Job status updated:\", {\n\t\t\tjobId,\n\t\t\toldStatus: existingJob.status,\n\t\t\tnewStatus,\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Assign job to a technician\n * ‚úÖ NO CHANGES NEEDED - Only updates jobs.assigned_to\n */\nasync function assignJob(\n\tjobId: string,\n\ttechnicianId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify technician belongs to company\n\t\tconst { data: technician } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"user_id\")\n\t\t\t.eq(\"user_id\", technicianId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!technician) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Technician not found in your company\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t404,\n\t\t\t);\n\t\t}\n\n\t\t// Assign job\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.update({ assigned_to: technicianId })\n\t\t\t.eq(\"id\", jobId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"assign job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Schedule a job\n * ‚úÖ NO CHANGES NEEDED - Only updates jobs table scheduling fields\n */\nasync function scheduleJob(\n\tjobId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst data = scheduleJobSchema.parse({\n\t\t\tscheduledStart: formData.get(\"scheduledStart\"),\n\t\t\tscheduledEnd: formData.get(\"scheduledEnd\"),\n\t\t});\n\n\t\t// Verify job belongs to company\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, status\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Update schedule and status\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.update({\n\t\t\t\tscheduled_start: data.scheduledStart,\n\t\t\t\tscheduled_end: data.scheduledEnd,\n\t\t\t\tstatus:\n\t\t\t\t\texistingJob.status === \"quoted\" ? \"scheduled\" : existingJob.status,\n\t\t\t})\n\t\t\t.eq(\"id\", jobId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"schedule job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(\"/dashboard/schedule\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Start a job\n * üîß REFACTORED - Now updates job_time_tracking.actual_start instead of jobs.actual_start\n */\nexport async function startJob(jobId: string): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, status\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Can only start scheduled jobs\n\t\tif (existingJob.status !== \"scheduled\" && existingJob.status !== \"quoted\") {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Job must be scheduled before starting\",\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\tconst now = new Date().toISOString();\n\n\t\t// Update both jobs table (status) and job_time_tracking table (actual_start) in parallel\n\t\tconst updates = await Promise.all([\n\t\t\tsupabase.from(\"jobs\").update({ status: \"in_progress\" }).eq(\"id\", jobId),\n\t\t\tsupabase\n\t\t\t\t.from(\"job_time_tracking\")\n\t\t\t\t.update({ actual_start: now })\n\t\t\t\t.eq(\"job_id\", jobId),\n\t\t]);\n\n\t\t// Check for errors in either update\n\t\tconst errors = updates.filter((result) => result.error);\n\t\tif (errors.length > 0) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"start job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Complete a job\n * üîß REFACTORED - Now updates job_time_tracking.actual_end and calculates total_labor_hours\n */\nexport async function completeJob(jobId: string): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company and get time tracking data\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, status, timeTracking:job_time_tracking(*)\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Can only complete in-progress jobs\n\t\tif (existingJob.status !== \"in_progress\") {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Job must be in progress to complete\",\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\tconst now = new Date().toISOString();\n\n\t\t// Calculate total labor hours if we have actual_start\n\t\tconst timeTracking = Array.isArray(existingJob.timeTracking)\n\t\t\t? existingJob.timeTracking[0]\n\t\t\t: existingJob.timeTracking;\n\n\t\tconst timeTrackingUpdate: any = { actual_end: now };\n\n\t\tif (timeTracking?.actual_start) {\n\t\t\tconst startTime = new Date(timeTracking.actual_start).getTime();\n\t\t\tconst endTime = new Date(now).getTime();\n\t\t\tconst hoursWorked = (endTime - startTime) / (1000 * 60 * 60); // Convert ms to hours\n\t\t\ttimeTrackingUpdate.total_labor_hours = hoursWorked;\n\t\t}\n\n\t\t// Update both jobs table (status) and job_time_tracking table (actual_end, total_labor_hours) in parallel\n\t\tconst updates = await Promise.all([\n\t\t\tsupabase.from(\"jobs\").update({ status: \"completed\" }).eq(\"id\", jobId),\n\t\t\tsupabase\n\t\t\t\t.from(\"job_time_tracking\")\n\t\t\t\t.update(timeTrackingUpdate)\n\t\t\t\t.eq(\"job_id\", jobId),\n\t\t]);\n\n\t\t// Check for errors in either update\n\t\tconst errors = updates.filter((result) => result.error);\n\t\tif (errors.length > 0) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"complete job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Cancel a job\n * ‚úÖ NO CHANGES NEEDED - Only updates jobs.status and jobs.notes\n */\nasync function cancelJob(\n\tjobId: string,\n\treason?: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company\n\t\tconst { data: existingJob } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, status, notes\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(existingJob, \"Job\");\n\n\t\tif (existingJob.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Cannot cancel completed jobs\n\t\tif (existingJob.status === \"completed\") {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Cannot cancel completed jobs\",\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\t// Add cancellation reason to notes\n\t\tconst updatedNotes = reason\n\t\t\t? `${existingJob.notes || \"\"}\\n\\n[CANCELLED]: ${reason}`.trim()\n\t\t\t: existingJob.notes;\n\n\t\t// Cancel job\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.update({\n\t\t\t\tstatus: \"cancelled\",\n\t\t\t\tnotes: updatedNotes,\n\t\t\t})\n\t\t\t.eq(\"id\", jobId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"cancel job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t});\n}\n\n/**\n * Search jobs with full-text search and ranking\n * ‚úÖ NO CHANGES NEEDED - Only searches jobs table\n */\nasync function searchJobs(\n\tsearchTerm: string,\n\toptions?: { limit?: number; offset?: number },\n): Promise<ActionResult<any[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Use full-text search with ranking for best matches\n\t\tconst { searchJobsFullText } = await import(\n\t\t\t\"@/lib/search/full-text-search\"\n\t\t);\n\n\t\tconst jobs = await searchJobsFullText(supabase, teamMember.company_id, searchTerm, {\n\t\t\tlimit: options?.limit || 50,\n\t\t\toffset: options?.offset || 0,\n\t\t});\n\n\t\treturn jobs;\n\t});\n}\n\n/**\n * Universal search across all entities\n * ‚úÖ NO CHANGES NEEDED - Only searches jobs table\n */\nasync function searchAll(\n\tsearchTerm: string,\n): Promise<ActionResult<any>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Use universal search RPC function\n\t\tconst { data, error } = await supabase.rpc(\"search_all_entities\", {\n\t\t\tcompany_id_param: teamMember.company_id,\n\t\t\tsearch_query: searchTerm,\n\t\t\tper_entity_limit: 5,\n\t\t});\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"search\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n// ============================================================================\n// JOB ARCHIVE & RESTORE\n// ============================================================================\n\n/**\n * Archive job (soft delete)\n * üîß REFACTORED - Now updates job_multi_entity.deleted_by and permanent_delete_scheduled_at\n */\nexport async function archiveJob(jobId: string): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company\n\t\tconst { data: job } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, status\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(job, \"Job\");\n\n\t\tif (job.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Cannot archive completed/paid jobs (business rule)\n\t\tif (job.status === \"completed\" || job.status === \"invoiced\") {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Cannot archive completed or invoiced jobs. These must be retained for records.\",\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\t// Archive job (soft delete)\n\t\tconst now = new Date().toISOString();\n\t\tconst scheduledDeletion = new Date(\n\t\t\tDate.now() + 90 * 24 * 60 * 60 * 1000,\n\t\t).toISOString();\n\n\t\t// Update both jobs table and job_multi_entity table in parallel\n\t\tconst updates = await Promise.all([\n\t\t\t// Update core jobs table with archive metadata\n\t\t\tsupabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.update({\n\t\t\t\t\tdeleted_at: now,\n\t\t\t\t\tarchived_at: now,\n\t\t\t\t\tstatus: \"archived\",\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", jobId),\n\n\t\t\t// Update job_multi_entity table with deletion tracking\n\t\t\tsupabase\n\t\t\t\t.from(\"job_multi_entity\")\n\t\t\t\t.update({\n\t\t\t\t\tdeleted_by: user.id,\n\t\t\t\t\tpermanent_delete_scheduled_at: scheduledDeletion,\n\t\t\t\t})\n\t\t\t\t.eq(\"job_id\", jobId),\n\t\t]);\n\n\t\t// Check for errors in either update\n\t\tconst errors = updates.filter((result) => result.error);\n\t\tif (errors.length > 0) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"archive job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(\"/dashboard/schedule\");\n\t\trevalidatePath(\"/dashboard/settings/archive\");\n\t});\n}\n\n/**\n * Restore archived job\n * üîß REFACTORED - Now clears job_multi_entity.deleted_by and permanent_delete_scheduled_at\n */\nasync function restoreJob(jobId: string): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company and is archived\n\t\tconst { data: job } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"company_id, deleted_at, status\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.single();\n\n\t\tassertExists(job, \"Job\");\n\n\t\tif (job.company_id !== teamMember.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"job\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tif (!job.deleted_at) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Job is not archived\",\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\t// Restore job - update both tables in parallel\n\t\tconst updates = await Promise.all([\n\t\t\t// Clear core jobs table archive metadata\n\t\t\tsupabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.update({\n\t\t\t\t\tdeleted_at: null,\n\t\t\t\t\tarchived_at: null,\n\t\t\t\t\tstatus: job.status === \"archived\" ? \"scheduled\" : job.status,\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", jobId),\n\n\t\t\t// Clear job_multi_entity table deletion tracking\n\t\t\tsupabase\n\t\t\t\t.from(\"job_multi_entity\")\n\t\t\t\t.update({\n\t\t\t\t\tdeleted_by: null,\n\t\t\t\t\tpermanent_delete_scheduled_at: null,\n\t\t\t\t})\n\t\t\t\t.eq(\"job_id\", jobId),\n\t\t]);\n\n\t\t// Check for errors in either update\n\t\tconst errors = updates.filter((result) => result.error);\n\t\tif (errors.length > 0) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"restore job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(\"/dashboard/schedule\");\n\t\trevalidatePath(\"/dashboard/settings/archive\");\n\t});\n}\n\n/**\n * Remove team assignment from job\n * ‚úÖ NO CHANGES NEEDED - Only deletes from job_team_assignments junction table\n */\nasync function removeTeamAssignment(\n\tassignmentId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's active company using helper (handles multi-company users)\n\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Get the junction record to find job_id for revalidation\n\t\tconst { data: record, error: fetchError } = await supabase\n\t\t\t.from(\"job_team_assignments\")\n\t\t\t.select(\"id, job_id, company_id\")\n\t\t\t.eq(\"id\", assignmentId)\n\t\t\t.single();\n\n\t\tif (fetchError || !record) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Team assignment not found\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t);\n\t\t}\n\n\t\tif (record.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"team assignment\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst jobId = record.job_id;\n\n\t\t// Delete junction table row\n\t\tconst { error: deleteError } = await supabase\n\t\t\t.from(\"job_team_assignments\")\n\t\t\t.delete()\n\t\t\t.eq(\"id\", assignmentId);\n\n\t\tif (deleteError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"remove team assignment from job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate job page and schedule\n\t\tif (jobId) {\n\t\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t\t}\n\t\trevalidatePath(\"/dashboard/schedule\");\n\t\trevalidatePath(\"/dashboard/work\");\n\t});\n}\n\n/**\n * Assign Customer and Property to Job\n *\n * Updates the job's customer_id and property_id.\n * Only one customer and property can be assigned per job.\n *\n * @param jobId - Job ID\n * @param customerId - Customer ID to assign\n * @param propertyId - Property ID to assign (optional)\n */\nexport async function assignCustomerToJob(\n\tjobId: string,\n\tcustomerId: string,\n\tpropertyId: string | null,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"company access\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job exists and belongs to company\n\t\tconst { data: job, error: jobError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tif (jobError) {\n\t\t\tconsole.error(\"Job query error:\", jobError);\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to find job: ${jobError.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t);\n\t\t}\n\n\t\tassertExists(job, \"Job\");\n\n\t\t// Verify customer exists and belongs to company\n\t\tconst { data: customer, error: customerError } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tif (customerError) {\n\t\t\tconsole.error(\"Customer query error:\", customerError);\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to find customer: ${customerError.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t);\n\t\t}\n\n\t\tassertExists(customer, \"Customer\");\n\n\t\t// If property is provided, verify it exists and belongs to customer\n\t\tif (propertyId) {\n\t\t\tconst { data: property } = await supabase\n\t\t\t\t.from(\"properties\")\n\t\t\t\t.select(\"id, customer_id\")\n\t\t\t\t.eq(\"id\", propertyId)\n\t\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t\t.single();\n\n\t\t\tif (!property) {\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\t\"Property not found or does not belong to this customer\",\n\t\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t\t404,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Update job with customer and property\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.update({\n\t\t\t\tcustomer_id: customerId,\n\t\t\t\tproperty_id: propertyId,\n\t\t\t})\n\t\t\t.eq(\"id\", jobId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"assign customer to job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Log activity\n\t\tawait supabase.from(\"job_activity_log\").insert({\n\t\t\tjob_id: jobId,\n\t\t\tcompany_id: companyId,\n\t\t\tuser_id: user.id,\n\t\t\tactivity_type: \"assigned\",\n\t\t\tentity_type: \"customer\",\n\t\t\tdescription: `Assigned customer${propertyId ? \" and property\" : \"\"}`,\n\t\t\tmetadata: {\n\t\t\t\tcustomer_id: customerId,\n\t\t\t\tproperty_id: propertyId,\n\t\t\t},\n\t\t});\n\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(\"/welcome\");\n\t});\n}\n\n/**\n * Remove Customer and Property from Job\n *\n * Removes the customer_id and property_id from the job.\n * Related data (appointments, invoices, etc.) remain but are no longer linked.\n *\n * @param jobId - Job ID\n */\nexport async function removeCustomerFromJob(\n\tjobId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"company access\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job exists and belongs to company\n\t\tconst { data: job } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id, company_id, customer_id, property_id\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tassertExists(job, \"Job\");\n\n\t\t// Update job to remove customer and property\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.update({\n\t\t\t\tcustomer_id: null,\n\t\t\t\tproperty_id: null,\n\t\t\t})\n\t\t\t.eq(\"id\", jobId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"remove customer from job\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Log activity\n\t\tawait supabase.from(\"job_activity_log\").insert({\n\t\t\tjob_id: jobId,\n\t\t\tcompany_id: companyId,\n\t\t\tuser_id: user.id,\n\t\t\tactivity_type: \"removed\",\n\t\t\tentity_type: \"customer\",\n\t\t\tdescription: \"Removed customer and property\",\n\t\t\tmetadata: {\n\t\t\t\tprevious_customer_id: job.customer_id,\n\t\t\t\tprevious_property_id: job.property_id,\n\t\t\t},\n\t\t});\n\n\t\trevalidatePath(`/dashboard/work/${jobId}`);\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(\"/welcome\");\n\t});\n}\n","/**\n * Notification Triggers\n *\n * Helper functions to create notifications for system events.\n * These functions check user preferences before creating notifications\n * and provide a consistent interface for triggering notifications across the app.\n *\n * Usage:\n * ```typescript\n * import { notifyJobCreated } from \"@/lib/notifications/triggers\";\n *\n * // In your server action:\n * await notifyJobCreated({\n *   userId: technician.id,\n *   companyId: job.company_id,\n *   jobId: job.id,\n *   jobTitle: job.title,\n *   address: job.property.address,\n *   priority: \"urgent\",\n * });\n * ```\n */\n\nimport type {\n\tNotificationPriority,\n\tNotificationType,\n} from \"@/lib/notifications/types\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// =====================================================================================\n// Types\n// =====================================================================================\n\ntype BaseNotificationParams = {\n\tuserId: string;\n\tcompanyId: string;\n\tpriority?: NotificationPriority;\n\tactionUrl?: string;\n};\n\ninterface JobNotificationParams extends BaseNotificationParams {\n\tjobId: string;\n\tjobTitle: string;\n\taddress: string;\n}\n\ninterface PaymentNotificationParams extends BaseNotificationParams {\n\tamount: number;\n\tcustomerName: string;\n\tinvoiceId?: string;\n}\n\ninterface MessageNotificationParams extends BaseNotificationParams {\n\tfrom: string;\n\tmessagePreview: string;\n\tmessageId: string;\n}\n\ninterface TeamNotificationParams extends BaseNotificationParams {\n\tmemberName: string;\n\trole?: string;\n}\n\ninterface AlertNotificationParams extends BaseNotificationParams {\n\talertTitle: string;\n\talertMessage: string;\n}\n\ninterface SystemNotificationParams extends BaseNotificationParams {\n\tsystemTitle: string;\n\tsystemMessage: string;\n}\n\n// =====================================================================================\n// Helper Functions\n// =====================================================================================\n\n/**\n * Create a notification in the database\n * Internal helper function used by all trigger functions\n */\nasync function createNotification(\n\ttype: NotificationType,\n\tuserId: string,\n\tcompanyId: string,\n\ttitle: string,\n\tmessage: string,\n\tpriority: NotificationPriority = \"medium\",\n\tactionUrl?: string,\n\tactionLabel?: string,\n\tmetadata?: Record<string, any>,\n) {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Supabase client not configured\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"notifications\")\n\t\t\t.insert({\n\t\t\t\tuser_id: userId,\n\t\t\t\tcompany_id: companyId,\n\t\t\t\ttype,\n\t\t\t\tpriority,\n\t\t\t\ttitle,\n\t\t\t\tmessage,\n\t\t\t\taction_url: actionUrl,\n\t\t\t\taction_label: actionLabel,\n\t\t\t\tmetadata: metadata || {},\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\treturn { success: true, data };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n\n/**\n * Check if user has notifications enabled for a specific event type.\n * Queries the notification_preferences table for user's preference.\n * Defaults to enabled if no preference is set.\n */\nasync function isNotificationEnabled(\n\tuserId: string,\n\tcompanyId: string,\n\teventType: string,\n): Promise<boolean> {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn true; // Default to enabled if Supabase not configured\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"notification_preferences\")\n\t\t\t.select(\"enabled\")\n\t\t\t.eq(\"user_id\", userId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"channel\", \"in_app\")\n\t\t\t.eq(\"event_type\", eventType)\n\t\t\t.single();\n\n\t\tif (error || !data) {\n\t\t\t// If no preference set, default to enabled\n\t\t\treturn true;\n\t\t}\n\n\t\treturn data.enabled;\n\t} catch {\n\t\t// Default to enabled on error\n\t\treturn true;\n\t}\n}\n\n// =====================================================================================\n// Job Notifications\n// =====================================================================================\n\n/**\n * Notify user when a new job is created/assigned\n */\nexport async function notifyJobCreated(params: JobNotificationParams) {\n\tconst enabled = await isNotificationEnabled(\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"job_created\",\n\t);\n\n\tif (!enabled) {\n\t\treturn { success: true, skipped: true };\n\t}\n\n\treturn createNotification(\n\t\t\"job\",\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"New Job Assignment\",\n\t\t`Job \"${params.jobTitle}\" has been assigned to you at ${params.address}`,\n\t\tparams.priority || \"medium\",\n\t\tparams.actionUrl || \"/dashboard/work\",\n\t\t\"View Job\",\n\t\t{\n\t\t\tjob_id: params.jobId,\n\t\t\taddress: params.address,\n\t\t},\n\t);\n}\n\n/**\n * Notify user when a job is updated\n */\nasync function notifyJobUpdated(params: JobNotificationParams) {\n\tconst enabled = await isNotificationEnabled(\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"job_updated\",\n\t);\n\n\tif (!enabled) {\n\t\treturn { success: true, skipped: true };\n\t}\n\n\treturn createNotification(\n\t\t\"job\",\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"Job Updated\",\n\t\t`Job \"${params.jobTitle}\" has been updated`,\n\t\tparams.priority || \"low\",\n\t\tparams.actionUrl || \"/dashboard/work\",\n\t\t\"View Job\",\n\t\t{\n\t\t\tjob_id: params.jobId,\n\t\t},\n\t);\n}\n\n/**\n * Notify user when a job is completed\n */\nasync function notifyJobCompleted(params: JobNotificationParams) {\n\tconst enabled = await isNotificationEnabled(\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"job_completed\",\n\t);\n\n\tif (!enabled) {\n\t\treturn { success: true, skipped: true };\n\t}\n\n\treturn createNotification(\n\t\t\"job\",\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"Job Completed\",\n\t\t`Job \"${params.jobTitle}\" at ${params.address} has been completed`,\n\t\tparams.priority || \"low\",\n\t\tparams.actionUrl || \"/dashboard/work\",\n\t\t\"View Job\",\n\t\t{\n\t\t\tjob_id: params.jobId,\n\t\t\tstatus: \"completed\",\n\t\t},\n\t);\n}\n\n// =====================================================================================\n// Payment Notifications\n// =====================================================================================\n\n/**\n * Notify user when a payment is received\n */\nexport async function notifyPaymentReceived(params: PaymentNotificationParams) {\n\tconst enabled = await isNotificationEnabled(\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"payment_received\",\n\t);\n\n\tif (!enabled) {\n\t\treturn { success: true, skipped: true };\n\t}\n\n\treturn createNotification(\n\t\t\"payment\",\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"Payment Received\",\n\t\t`Payment of $${params.amount.toFixed(2)} received from ${params.customerName}`,\n\t\tparams.priority || \"high\",\n\t\tparams.actionUrl || \"/dashboard/finance/invoices\",\n\t\t\"View Invoice\",\n\t\t{\n\t\t\tamount: params.amount,\n\t\t\tcustomer: params.customerName,\n\t\t\tinvoice_id: params.invoiceId,\n\t\t},\n\t);\n}\n\n/**\n * Notify user when an invoice payment is due soon\n */\nasync function notifyPaymentDue(\n\tparams: PaymentNotificationParams & { daysUntilDue: number },\n) {\n\tconst enabled = await isNotificationEnabled(\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"payment_due\",\n\t);\n\n\tif (!enabled) {\n\t\treturn { success: true, skipped: true };\n\t}\n\n\treturn createNotification(\n\t\t\"payment\",\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"Payment Reminder\",\n\t\t`Invoice payment of $${params.amount.toFixed(2)} from ${params.customerName} is due in ${params.daysUntilDue} days`,\n\t\tparams.priority || \"medium\",\n\t\tparams.actionUrl || \"/dashboard/finance/invoices\",\n\t\t\"View Invoice\",\n\t\t{\n\t\t\tamount: params.amount,\n\t\t\tcustomer: params.customerName,\n\t\t\tinvoice_id: params.invoiceId,\n\t\t\tdays_until_due: params.daysUntilDue,\n\t\t},\n\t);\n}\n\n// =====================================================================================\n// Message/Communication Notifications\n// =====================================================================================\n\n/**\n * Notify user when they receive a new message\n */\nasync function notifyNewMessage(params: MessageNotificationParams) {\n\tconst enabled = await isNotificationEnabled(\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"new_message\",\n\t);\n\n\tif (!enabled) {\n\t\treturn { success: true, skipped: true };\n\t}\n\n\treturn createNotification(\n\t\t\"message\",\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t`New Message from ${params.from}`,\n\t\tparams.messagePreview,\n\t\tparams.priority || \"medium\",\n\t\tparams.actionUrl || \"/dashboard/communication\",\n\t\t\"Reply\",\n\t\t{\n\t\t\tfrom: params.from,\n\t\t\tmessage_id: params.messageId,\n\t\t},\n\t);\n}\n\n/**\n * Notify user when they miss a call\n */\nasync function notifyMissedCall(params: MessageNotificationParams) {\n\tconst enabled = await isNotificationEnabled(\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"missed_call\",\n\t);\n\n\tif (!enabled) {\n\t\treturn { success: true, skipped: true };\n\t}\n\n\treturn createNotification(\n\t\t\"message\",\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"Missed Call\",\n\t\t`You missed a call from ${params.from}`,\n\t\tparams.priority || \"high\",\n\t\tparams.actionUrl || \"/dashboard/communication\",\n\t\t\"View Details\",\n\t\t{\n\t\t\tfrom: params.from,\n\t\t\tcall_id: params.messageId,\n\t\t},\n\t);\n}\n\n// =====================================================================================\n// Team Notifications\n// =====================================================================================\n\n/**\n * Notify user when a new team member joins\n */\nasync function notifyTeamMemberAdded(params: TeamNotificationParams) {\n\tconst enabled = await isNotificationEnabled(\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"team_member_added\",\n\t);\n\n\tif (!enabled) {\n\t\treturn { success: true, skipped: true };\n\t}\n\n\treturn createNotification(\n\t\t\"team\",\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"New Team Member\",\n\t\t`${params.memberName} has joined your team${params.role ? ` as a ${params.role}` : \"\"}`,\n\t\tparams.priority || \"low\",\n\t\tparams.actionUrl || \"/dashboard/settings/team\",\n\t\t\"View Team\",\n\t\t{\n\t\t\tmember_name: params.memberName,\n\t\t\trole: params.role,\n\t\t},\n\t);\n}\n\n/**\n * Notify user when they're assigned to a team\n */\nasync function notifyTeamAssignment(params: TeamNotificationParams) {\n\tconst enabled = await isNotificationEnabled(\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"team_assignment\",\n\t);\n\n\tif (!enabled) {\n\t\treturn { success: true, skipped: true };\n\t}\n\n\treturn createNotification(\n\t\t\"team\",\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"Team Assignment\",\n\t\t`You've been assigned to work with ${params.memberName}`,\n\t\tparams.priority || \"medium\",\n\t\tparams.actionUrl || \"/dashboard/settings/team\",\n\t\t\"View Details\",\n\t\t{\n\t\t\tmember_name: params.memberName,\n\t\t},\n\t);\n}\n\n// =====================================================================================\n// Alert Notifications\n// =====================================================================================\n\n/**\n * Notify user with a custom alert\n */\nasync function notifyAlert(params: AlertNotificationParams) {\n\tconst enabled = await isNotificationEnabled(\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\t\"system_alert\",\n\t);\n\n\tif (!enabled) {\n\t\treturn { success: true, skipped: true };\n\t}\n\n\treturn createNotification(\n\t\t\"alert\",\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\tparams.alertTitle,\n\t\tparams.alertMessage,\n\t\tparams.priority || \"medium\",\n\t\tparams.actionUrl,\n\t\t\"View Details\",\n\t);\n}\n\n// =====================================================================================\n// System Notifications\n// =====================================================================================\n\n/**\n * Notify user with a system message\n */\nasync function notifySystem(params: SystemNotificationParams) {\n\treturn createNotification(\n\t\t\"system\",\n\t\tparams.userId,\n\t\tparams.companyId,\n\t\tparams.systemTitle,\n\t\tparams.systemMessage,\n\t\tparams.priority || \"low\",\n\t\tparams.actionUrl,\n\t\t\"View Details\",\n\t);\n}\n","/**\n * Job Status Transition Validation\n *\n * Enforces business rules for job status changes:\n * - Valid transition paths (workflow validation)\n * - Required fields per status\n * - Blocking conditions\n *\n * Used by: updateJobStatus, updateJobData actions\n */\n\nexport type JobStatus =\n\t| \"quoted\"\n\t| \"scheduled\"\n\t| \"in_progress\"\n\t| \"on_hold\"\n\t| \"completed\"\n\t| \"cancelled\"\n\t| \"invoiced\"\n\t| \"paid\";\n\nexport type JobPriority = \"low\" | \"medium\" | \"high\" | \"urgent\";\n\nexport interface JobStatusTransitionContext {\n\tcurrentStatus: JobStatus;\n\tnewStatus: JobStatus;\n\tjob: {\n\t\tid: string;\n\t\tscheduled_start?: string | null;\n\t\tscheduled_end?: string | null;\n\t\tassigned_to?: string | null;\n\t\tcustomer_id?: string | null;\n\t\tproperty_id?: string | null;\n\t\ttotal_amount?: number | null;\n\t\tinvoices?: Array<{ status: string; total_amount: number }>;\n\t\testimates?: Array<{ status: string }>;\n\t\tteamAssignments?: Array<{ team_member_id: string }>;\n\t};\n}\n\nexport interface StatusTransitionResult {\n\tallowed: boolean;\n\treason?: string;\n\trequiredFields?: string[];\n\twarnings?: string[];\n}\n\n/**\n * Valid status transition paths\n * Key = current status, Value = allowed next statuses\n */\nconst VALID_TRANSITIONS: Record<JobStatus, JobStatus[]> = {\n\tquoted: [\"scheduled\", \"cancelled\"],\n\tscheduled: [\"in_progress\", \"on_hold\", \"cancelled\"],\n\tin_progress: [\"on_hold\", \"completed\", \"cancelled\"],\n\ton_hold: [\"scheduled\", \"in_progress\", \"cancelled\"],\n\tcompleted: [\"invoiced\"],\n\tcancelled: [\"quoted\", \"scheduled\"], // Allow re-opening cancelled jobs\n\tinvoiced: [\"paid\"],\n\tpaid: [], // Terminal state - no further transitions\n};\n\n/**\n * Required fields for each status\n */\nconst REQUIRED_FIELDS: Record<JobStatus, string[]> = {\n\tquoted: [\"customer_id\"], // At minimum need a customer\n\tscheduled: [\"customer_id\", \"scheduled_start\", \"scheduled_end\"],\n\tin_progress: [\"customer_id\", \"scheduled_start\", \"assigned_to\"],\n\ton_hold: [\"customer_id\"],\n\tcompleted: [\"customer_id\", \"scheduled_start\"],\n\tcancelled: [], // No required fields\n\tinvoiced: [\"customer_id\", \"total_amount\"],\n\tpaid: [\"customer_id\", \"total_amount\"],\n};\n\n/**\n * Field labels for user-friendly error messages\n */\nconst FIELD_LABELS: Record<string, string> = {\n\tcustomer_id: \"Customer\",\n\tscheduled_start: \"Start Date\",\n\tscheduled_end: \"End Date\",\n\tassigned_to: \"Assigned Team Member\",\n\tproperty_id: \"Property\",\n\ttotal_amount: \"Total Amount\",\n};\n\n/**\n * Validate if a status transition is allowed\n */\nexport function validateStatusTransition(\n\tcontext: JobStatusTransitionContext,\n): StatusTransitionResult {\n\tconst { currentStatus, newStatus, job } = context;\n\n\t// Same status - always allowed (no-op)\n\tif (currentStatus === newStatus) {\n\t\treturn { allowed: true };\n\t}\n\n\t// Check if transition is in allowed paths\n\tconst allowedNextStatuses = VALID_TRANSITIONS[currentStatus];\n\tif (!allowedNextStatuses.includes(newStatus)) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: `Cannot transition from \"${currentStatus}\" to \"${newStatus}\". Valid next statuses: ${allowedNextStatuses.join(\", \")}`,\n\t\t};\n\t}\n\n\t// Check required fields for target status\n\tconst requiredFields = REQUIRED_FIELDS[newStatus];\n\tconst missingFields: string[] = [];\n\n\tfor (const field of requiredFields) {\n\t\tconst value = job[field as keyof typeof job];\n\t\tif (value === null || value === undefined || value === \"\") {\n\t\t\tmissingFields.push(FIELD_LABELS[field] || field);\n\t\t}\n\t}\n\n\tif (missingFields.length > 0) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: `Cannot transition to \"${newStatus}\" - missing required fields`,\n\t\t\trequiredFields: missingFields,\n\t\t};\n\t}\n\n\t// Business rule validations\n\tconst warnings: string[] = [];\n\n\t// Scheduled ‚Üí In Progress: Should have team assignment\n\tif (currentStatus === \"scheduled\" && newStatus === \"in_progress\") {\n\t\tif (!job.teamAssignments || job.teamAssignments.length === 0) {\n\t\t\twarnings.push(\"No team members assigned to this job\");\n\t\t}\n\t}\n\n\t// Completed ‚Üí Invoiced: Should have estimates or total amount\n\tif (currentStatus === \"completed\" && newStatus === \"invoiced\") {\n\t\tconst hasEstimates = job.estimates && job.estimates.length > 0;\n\t\tconst hasTotalAmount = job.total_amount && job.total_amount > 0;\n\n\t\tif (!hasEstimates && !hasTotalAmount) {\n\t\t\treturn {\n\t\t\t\tallowed: false,\n\t\t\t\treason: \"Cannot create invoice - no estimates or total amount defined\",\n\t\t\t};\n\t\t}\n\t}\n\n\t// Invoiced ‚Üí Paid: Should have invoices\n\tif (currentStatus === \"invoiced\" && newStatus === \"paid\") {\n\t\tif (!job.invoices || job.invoices.length === 0) {\n\t\t\treturn {\n\t\t\t\tallowed: false,\n\t\t\t\treason: \"Cannot mark as paid - no invoices found\",\n\t\t\t};\n\t\t}\n\n\t\t// Check if all invoices are paid\n\t\tconst unpaidInvoices = job.invoices.filter(\n\t\t\t(inv) => inv.status !== \"paid\" && inv.status !== \"cancelled\",\n\t\t);\n\n\t\tif (unpaidInvoices.length > 0) {\n\t\t\treturn {\n\t\t\t\tallowed: false,\n\t\t\t\treason: `Cannot mark as paid - ${unpaidInvoices.length} invoice(s) still unpaid`,\n\t\t\t};\n\t\t}\n\t}\n\n\t// Paid ‚Üí any: Should not be allowed (terminal state)\n\tif (currentStatus === \"paid\") {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: \"Cannot change status of paid jobs. Create a new job if needed.\",\n\t\t};\n\t}\n\n\treturn {\n\t\tallowed: true,\n\t\twarnings: warnings.length > 0 ? warnings : undefined,\n\t};\n}\n\n/**\n * Get all allowed next statuses for current status\n */\nexport function getAllowedNextStatuses(currentStatus: JobStatus): JobStatus[] {\n\treturn VALID_TRANSITIONS[currentStatus] || [];\n}\n\n/**\n * Get required fields for a status\n */\nfunction getRequiredFieldsForStatus(status: JobStatus): string[] {\n\treturn REQUIRED_FIELDS[status] || [];\n}\n\n/**\n * Check if a specific transition is valid (simple check without context)\n */\nfunction isTransitionAllowed(from: JobStatus, to: JobStatus): boolean {\n\tif (from === to) return true;\n\treturn VALID_TRANSITIONS[from]?.includes(to) || false;\n}\n\n/**\n * Get user-friendly status name\n */\nexport function getStatusLabel(status: JobStatus): string {\n\tconst labels: Record<JobStatus, string> = {\n\t\tquoted: \"Quoted\",\n\t\tscheduled: \"Scheduled\",\n\t\tin_progress: \"In Progress\",\n\t\ton_hold: \"On Hold\",\n\t\tcompleted: \"Completed\",\n\t\tcancelled: \"Cancelled\",\n\t\tinvoiced: \"Invoiced\",\n\t\tpaid: \"Paid\",\n\t};\n\treturn labels[status] || status;\n}\n\n/**\n * Get status color/variant for UI\n */\nexport function getStatusVariant(\n\tstatus: JobStatus,\n): \"default\" | \"secondary\" | \"destructive\" | \"outline\" {\n\tconst variants: Record<\n\t\tJobStatus,\n\t\t\"default\" | \"secondary\" | \"destructive\" | \"outline\"\n\t> = {\n\t\tquoted: \"outline\",\n\t\tscheduled: \"secondary\",\n\t\tin_progress: \"default\",\n\t\ton_hold: \"secondary\",\n\t\tcompleted: \"default\",\n\t\tcancelled: \"destructive\",\n\t\tinvoiced: \"secondary\",\n\t\tpaid: \"default\",\n\t};\n\treturn variants[status] || \"default\";\n}\n\n/**\n * Get recommended next status based on current status\n */\nexport function getRecommendedNextStatus(\n\tcurrentStatus: JobStatus,\n): JobStatus | null {\n\tconst recommendations: Record<JobStatus, JobStatus | null> = {\n\t\tquoted: \"scheduled\",\n\t\tscheduled: \"in_progress\",\n\t\tin_progress: \"completed\",\n\t\ton_hold: \"in_progress\",\n\t\tcompleted: \"invoiced\",\n\t\tcancelled: null,\n\t\tinvoiced: \"paid\",\n\t\tpaid: null,\n\t};\n\treturn recommendations[currentStatus] || null;\n}\n"],"names":[],"mappings":"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"}