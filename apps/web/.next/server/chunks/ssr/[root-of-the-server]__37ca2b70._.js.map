{"version":3,"sources":["../../../../../../apps/web/src/lib/security/rate-limit.ts","../../../../../../apps/web/.next-internal/server/app/auth/verify-email/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["/**\n * Rate Limiting Utilities\n *\n * Provides rate limiting for authentication and API endpoints to prevent:\n * - Brute force password attacks\n * - Account enumeration\n * - Email spam/flooding\n * - DDoS attacks\n *\n * Implementation:\n * - Uses in-memory LRU cache for development/small scale\n * - Can be easily swapped with Redis/Upstash for production\n * - Sliding window algorithm for accurate rate limiting\n * - Per-identifier tracking (email, IP, user ID)\n */\n\n// Simple in-memory rate limiter using LRU cache\n// For production, replace with @upstash/ratelimit + @upstash/redis\nclass InMemoryRateLimiter {\n\tprivate requests: Map<\n\t\tstring,\n\t\t{ count: number; resetAt: number; requests: number[] }\n\t>;\n\tprivate readonly maxRequests: number;\n\tprivate readonly windowMs: number;\n\n\tconstructor(maxRequests: number, windowMs: number) {\n\t\tthis.requests = new Map();\n\t\tthis.maxRequests = maxRequests;\n\t\tthis.windowMs = windowMs;\n\n\t\t// Cleanup old entries every minute\n\t\tsetInterval(() => this.cleanup(), 60_000);\n\t}\n\n\tasync limit(identifier: string): Promise<{\n\t\tsuccess: boolean;\n\t\tlimit: number;\n\t\tremaining: number;\n\t\treset: number;\n\t}> {\n\t\tconst now = Date.now();\n\t\tconst key = identifier;\n\n\t\tlet record = this.requests.get(key);\n\n\t\t// Initialize if doesn't exist\n\t\tif (!record) {\n\t\t\trecord = {\n\t\t\t\tcount: 0,\n\t\t\t\tresetAt: now + this.windowMs,\n\t\t\t\trequests: [],\n\t\t\t};\n\t\t\tthis.requests.set(key, record);\n\t\t}\n\n\t\t// Remove requests outside the sliding window\n\t\trecord.requests = record.requests.filter(\n\t\t\t(timestamp) => timestamp > now - this.windowMs,\n\t\t);\n\n\t\t// Check if limit exceeded\n\t\tif (record.requests.length >= this.maxRequests) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tlimit: this.maxRequests,\n\t\t\t\tremaining: 0,\n\t\t\t\treset: Math.min(...record.requests) + this.windowMs,\n\t\t\t};\n\t\t}\n\n\t\t// Add new request\n\t\trecord.requests.push(now);\n\t\trecord.count = record.requests.length;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tlimit: this.maxRequests,\n\t\t\tremaining: this.maxRequests - record.count,\n\t\t\treset: now + this.windowMs,\n\t\t};\n\t}\n\n\tprivate cleanup() {\n\t\tconst now = Date.now();\n\t\tfor (const [key, record] of this.requests.entries()) {\n\t\t\trecord.requests = record.requests.filter(\n\t\t\t\t(timestamp) => timestamp > now - this.windowMs,\n\t\t\t);\n\t\t\tif (record.requests.length === 0) {\n\t\t\t\tthis.requests.delete(key);\n\t\t\t}\n\t\t}\n\t}\n\n\treset(identifier: string) {\n\t\tthis.requests.delete(identifier);\n\t}\n\n\tclear() {\n\t\tthis.requests.clear();\n\t}\n}\n\n// Rate limiter instances for different operations\nconst authRateLimiterInstance = new InMemoryRateLimiter(\n\t5, // 5 requests\n\t15 * 60 * 1000, // per 15 minutes\n);\n\nconst apiRateLimiterInstance = new InMemoryRateLimiter(\n\t100, // 100 requests\n\t60 * 1000, // per 1 minute\n);\n\nconst passwordResetRateLimiterInstance = new InMemoryRateLimiter(\n\t3, // 3 requests\n\t60 * 60 * 1000, // per 1 hour\n);\n\n/**\n * Auth Rate Limiter\n *\n * Use for: Sign in, Sign up, OAuth\n * Limit: 5 requests per 15 minutes per identifier\n */\nexport const authRateLimiter = {\n\tlimit: (identifier: string) => authRateLimiterInstance.limit(identifier),\n\treset: (identifier: string) => authRateLimiterInstance.reset(identifier),\n};\n\n/**\n * API Rate Limiter\n *\n * Use for: General API endpoints\n * Limit: 100 requests per minute per identifier\n */\nconst apiRateLimiter = {\n\tlimit: (identifier: string) => apiRateLimiterInstance.limit(identifier),\n\treset: (identifier: string) => apiRateLimiterInstance.reset(identifier),\n};\n\n/**\n * Password Reset Rate Limiter\n *\n * Use for: Password reset requests\n * Limit: 3 requests per hour per identifier\n */\nexport const passwordResetRateLimiter = {\n\tlimit: (identifier: string) =>\n\t\tpasswordResetRateLimiterInstance.limit(identifier),\n\treset: (identifier: string) =>\n\t\tpasswordResetRateLimiterInstance.reset(identifier),\n};\n\n/**\n * Rate Limit Error\n */\nexport class RateLimitError extends Error {\n\tconstructor(\n\t\tmessage: string,\n\t\tpublic limit: number,\n\t\tpublic remaining: number,\n\t\tpublic reset: number,\n\t) {\n\t\tsuper(message);\n\t\tthis.name = \"RateLimitError\";\n\t}\n}\n\n/**\n * Check Rate Limit\n *\n * Throws RateLimitError if rate limit exceeded.\n *\n * @param identifier - Unique identifier (email, IP, user ID)\n * @param limiter - Rate limiter instance to use\n */\nexport async function checkRateLimit(\n\tidentifier: string,\n\tlimiter: typeof authRateLimiter = apiRateLimiter,\n): Promise<void> {\n\tconst { success, limit, remaining, reset } = await limiter.limit(identifier);\n\n\tif (!success) {\n\t\tconst resetDate = new Date(reset);\n\t\tthrow new RateLimitError(\n\t\t\t`Too many requests. Please try again after ${resetDate.toLocaleTimeString()}.`,\n\t\t\tlimit,\n\t\t\tremaining,\n\t\t\treset,\n\t\t);\n\t}\n}\n\n/**\n * Get Client IP Address\n *\n * Extracts IP from request headers for rate limiting.\n * Supports various proxy headers.\n */\nfunction getClientIP(request: Request): string {\n\tconst headers = new Headers(request.headers);\n\n\t// Check common proxy headers\n\tconst forwarded = headers.get(\"x-forwarded-for\");\n\tif (forwarded) {\n\t\treturn forwarded.split(\",\")[0].trim();\n\t}\n\n\tconst realIP = headers.get(\"x-real-ip\");\n\tif (realIP) {\n\t\treturn realIP;\n\t}\n\n\tconst cfIP = headers.get(\"cf-connecting-ip\"); // Cloudflare\n\tif (cfIP) {\n\t\treturn cfIP;\n\t}\n\n\t// Fallback to unknown\n\treturn \"unknown\";\n}\n\n/**\n * Production Setup Instructions\n *\n * For production, replace in-memory limiter with Redis:\n *\n * 1. Install dependencies:\n *    ```bash\n *    pnpm add @upstash/ratelimit @upstash/redis\n *    ```\n *\n * 2. Update this file:\n *    ```typescript\n *    import { Ratelimit } from \"@upstash/ratelimit\";\n *    import { Redis } from \"@upstash/redis\";\n *\n *    const redis = new Redis({\n *      url: process.env.UPSTASH_REDIS_REST_URL!,\n *      token: process.env.UPSTASH_REDIS_REST_TOKEN!,\n *    });\n *\n *    export const authRateLimiter = new Ratelimit({\n *      redis,\n *      limiter: Ratelimit.slidingWindow(5, \"15 m\"),\n *      analytics: true,\n *      prefix: \"ratelimit:auth\",\n *    });\n *    ```\n *\n * 3. Add environment variables:\n *    ```\n *    UPSTASH_REDIS_REST_URL=https://...\n *    UPSTASH_REDIS_REST_TOKEN=...\n *    ```\n */\n","export {getCurrentUserRole as '001f005176797ef23488068124fb9a744915a477de'} from 'ACTIONS_MODULE0'\nexport {canDeleteTeamMember as '406f6624261c6dd1a908026fa1408a3f6d507b6e7d'} from 'ACTIONS_MODULE0'\nexport {signOut as '0043ae510c3322ea499beb9e1bb77d06afb4ef19bd'} from 'ACTIONS_MODULE1'\nexport {getCompanyIdAction as '00680f536cba89b363c5ca4650e4eb3bec15a811dc'} from 'ACTIONS_MODULE1'\nexport {signUp as '40104c6fe35e38f96ad479521960f3a0e1b163d436'} from 'ACTIONS_MODULE1'\nexport {completeProfile as '4029533ce31a3cebb2d524019c510908187c0a4cad'} from 'ACTIONS_MODULE1'\nexport {signIn as '405edbcad8d8902932627713a28c9047e6042d1151'} from 'ACTIONS_MODULE1'\nexport {verifyEmail as '40918c47ff3c08b28739e0d9c7004c9fe67f5bdad0'} from 'ACTIONS_MODULE1'\nexport {signInWithOAuth as '4092ddfc0e09825d6739a8441ea0b2f8f4c05296d4'} from 'ACTIONS_MODULE1'\nexport {createServiceSupabaseClient as '00a13dbd00149949fc1367d3e76ae7d789e07f5321'} from 'ACTIONS_MODULE2'\nexport {verifyAndConsumeToken as '607ca0c49bd3c63878cd80f74fe9ced74f4620a94a'} from 'ACTIONS_MODULE3'\nexport {createEmailVerificationToken as '70d04422f632904b350a5280b1b63420d279faee3b'} from 'ACTIONS_MODULE3'\nexport {sendPasswordChanged as '604c85253685ae051ef8022280e3a9b5fd68ce0fb8'} from 'ACTIONS_MODULE4'\nexport {sendPasswordReset as '6050491c49442320765de9f346f7b38b9e31868a1e'} from 'ACTIONS_MODULE4'\nexport {sendEmailVerification as '607be80a2ce0212d1982cec5856223012d0ec20ff4'} from 'ACTIONS_MODULE4'\nexport {sendWelcomeEmail as '60dca9b5901ef7148fbbfb2f0df6a1cc2fb4af3c13'} from 'ACTIONS_MODULE4'\nexport {sendEmail as '40f8c061cf84f884e77af3425bc24b8a8d72f598fb'} from 'ACTIONS_MODULE5'\nexport {handleComplaintWebhook as '6045f8436f9cdfdadb7bfe3955677adfc5f4102de0'} from 'ACTIONS_MODULE5'\nexport {handleBounceWebhook as '78a8ea4f1cfa571a366adccf36ac04b1c85d61ae2b'} from 'ACTIONS_MODULE5'\nexport {runHealthCheckForAllDomains as '00c53a1f02416c3261983f8096f19a3450bfd51775'} from 'ACTIONS_MODULE6'\nexport {getDomainHealth as '400b8fb96146bfd004a3166563a5ab5536bb610c70'} from 'ACTIONS_MODULE6'\nexport {recordDeliveryEvent as '404d6f2891af89c71d5bde33d110a216bdd3ee4729'} from 'ACTIONS_MODULE6'\nexport {getCompanyDomainsHealth as '405c57a8fed352b8679525b56014eb8c49105c850c'} from 'ACTIONS_MODULE6'\nexport {processResendWebhookEvent as '40ad037af6f6ab1a3004746d3a1b65afa65527002d'} from 'ACTIONS_MODULE6'\nexport {generateDeliverabilityReport as '40ecf2c792e84ef4b898fda98ec27277b4a9dddef2'} from 'ACTIONS_MODULE6'\nexport {resetHourlyCounters as '004cdde5e6ae8991bab4ba61ae40647c2b823200ba'} from 'ACTIONS_MODULE7'\nexport {resetDailyCounters as '006acf41615a2f7795c47b6d7a3016e18300f2ad17'} from 'ACTIONS_MODULE7'\nexport {incrementEmailCounter as '4029b163c1c0acfd806352a72fe8030c8ae4f7f8ac'} from 'ACTIONS_MODULE7'\nexport {getCompanyActiveDomain as '407a5a7d0a7dd7989a963eb2485a3527c1dcb20a70'} from 'ACTIONS_MODULE7'\nexport {checkRateLimit as '40af86a915f04df8d7cc189fe26e45e0cc24663080'} from 'ACTIONS_MODULE7'\nexport {isGmailIntegrationEnabled as '00fe74bdf14126b5ad89e9480e82978d6357f356b3'} from 'ACTIONS_MODULE8'\nexport {getUserGmailTokens as '400ce95360aaffa14a99dfdf969ba5166c69a59eb6'} from 'ACTIONS_MODULE8'\nexport {disconnectCompanyGmail as '401d3d830065dd7c4777fad67f642392f48735c4ab'} from 'ACTIONS_MODULE8'\nexport {disconnectUserGmail as '404575d602ef4c60c0058b592b8c3e42fbcd13fc4c'} from 'ACTIONS_MODULE8'\nexport {getCompanyEmailProvider as '40787b1598849126560f9f0b0f8fe8967338c7bf28'} from 'ACTIONS_MODULE8'\nexport {getCompanyGmailTokens as '40beeb56302a20d27cd8ba7a0988310f855633d7e6'} from 'ACTIONS_MODULE8'\nexport {refreshUserGmailToken as '602fab67313b110e6ccb66e54b1e16450b2a772cc7'} from 'ACTIONS_MODULE8'\nexport {sendCompanyGmailEmail as '60302947fc4caffa53a719728f3c2cebace926098c'} from 'ACTIONS_MODULE8'\nexport {syncUserInbox as '603643b13bf288cc628303bb4d12df0311b11434c7'} from 'ACTIONS_MODULE8'\nexport {checkCompanyGmailHealth as '60856182db5eaec7f85eda2a5a94c5d7d3524325d6'} from 'ACTIONS_MODULE8'\nexport {refreshCompanyGmailToken as '60eeb51685ac265a4ad793a230a515fe6e462f16f4'} from 'ACTIONS_MODULE8'\nexport {fetchUserInbox as '708daa303e36e37247e22b5b828b6aad8c73ac283b'} from 'ACTIONS_MODULE8'\nexport {setCompanyEmailProvider as '70dd3bc4222a87350dc137fa9cbcb849fa1913b397'} from 'ACTIONS_MODULE8'\nexport {storeGmailMessage as '78d41ef818e75fef94d65a87ea1f0faf418132e3c5'} from 'ACTIONS_MODULE8'\nexport {storeUserGmailTokens as '7e3a356960ddd52a3fa4dc6d981ae7202a59eb9a3d'} from 'ACTIONS_MODULE8'\nexport {storeCompanyGmailTokens as '7f06df826c4fff42950e712c0f548254e275be2a52'} from 'ACTIONS_MODULE8'\nexport {getProviderHealthDashboard as '00a122f9d5fe3a1603c636c3a251886129b66154f8'} from 'ACTIONS_MODULE9'\nexport {checkProviderAlert as '40c7885bdc4fe4cdd5f57e78579230c58088adbef4'} from 'ACTIONS_MODULE9'\nexport {cleanupOldEvents as '40d3c4ceeaee653aa257a28ed429a7fd272fa9fb66'} from 'ACTIONS_MODULE9'\nexport {recordProviderEvent as '40e06418f4b93b40c84a25511e0468e1e8a41ddecf'} from 'ACTIONS_MODULE9'\nexport {getProviderStats as '60c643a41ce1a8e6cc8338da6e2f3678c386910460'} from 'ACTIONS_MODULE9'\nexport {recordSendFailure as '78255c3fa8c9facf7c3f353202f2907836e8eb5539'} from 'ACTIONS_MODULE9'\nexport {recordSendSuccess as '783861d25688b32ba086bbe9e45444975c36a1b285'} from 'ACTIONS_MODULE9'\nexport {recordFallbackTriggered as '78766431b437b16f7cb00b4d64a2f3be5e092ed724'} from 'ACTIONS_MODULE9'\n"],"names":[],"mappings":"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"}