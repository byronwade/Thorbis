{"version":3,"sources":["../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/client/components/readonly-url-search-params.ts","../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/client/components/redirect-status-code.ts","../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/client/components/redirect-error.ts","../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/client/components/redirect.ts","../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/client/components/http-access-fallback/http-access-fallback.ts","../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/client/components/not-found.ts","../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/client/components/forbidden.ts","../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/client/components/unauthorized.ts","../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/server/lib/router-utils/is-postpone.ts","../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/client/components/is-next-router-error.ts","../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/client/components/unstable-rethrow.server.ts","../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/client/components/unstable-rethrow.ts","../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/client/components/navigation.react-server.ts","../../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/src/api/navigation.react-server.ts","../../../../../../packages/auth/src/permissions.ts","../../../../../../apps/web/src/lib/auth/permissions.ts","../../../../../../apps/web/src/actions/roles.ts"],"sourcesContent":["/**\n * ReadonlyURLSearchParams implementation shared between client and server.\n * This file is intentionally not marked as 'use client' or 'use server'\n * so it can be imported by both environments.\n */\n\n/** @internal */\nclass ReadonlyURLSearchParamsError extends Error {\n  constructor() {\n    super(\n      'Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams'\n    )\n  }\n}\n\n/**\n * A read-only version of URLSearchParams that throws errors when mutation methods are called.\n * This ensures that the URLSearchParams returned by useSearchParams() cannot be mutated.\n */\nexport class ReadonlyURLSearchParams extends URLSearchParams {\n  /** @deprecated Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams */\n  append() {\n    throw new ReadonlyURLSearchParamsError()\n  }\n  /** @deprecated Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams */\n  delete() {\n    throw new ReadonlyURLSearchParamsError()\n  }\n  /** @deprecated Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams */\n  set() {\n    throw new ReadonlyURLSearchParamsError()\n  }\n  /** @deprecated Method unavailable on `ReadonlyURLSearchParams`. Read more: https://nextjs.org/docs/app/api-reference/functions/use-search-params#updating-searchparams */\n  sort() {\n    throw new ReadonlyURLSearchParamsError()\n  }\n}\n","export enum RedirectStatusCode {\n  SeeOther = 303,\n  TemporaryRedirect = 307,\n  PermanentRedirect = 308,\n}\n","import { RedirectStatusCode } from './redirect-status-code'\n\nexport const REDIRECT_ERROR_CODE = 'NEXT_REDIRECT'\n\nexport enum RedirectType {\n  push = 'push',\n  replace = 'replace',\n}\n\nexport type RedirectError = Error & {\n  digest: `${typeof REDIRECT_ERROR_CODE};${RedirectType};${string};${RedirectStatusCode};`\n}\n\n/**\n * Checks an error to determine if it's an error generated by the\n * `redirect(url)` helper.\n *\n * @param error the error that may reference a redirect error\n * @returns true if the error is a redirect error\n */\nexport function isRedirectError(error: unknown): error is RedirectError {\n  if (\n    typeof error !== 'object' ||\n    error === null ||\n    !('digest' in error) ||\n    typeof error.digest !== 'string'\n  ) {\n    return false\n  }\n\n  const digest = error.digest.split(';')\n  const [errorCode, type] = digest\n  const destination = digest.slice(2, -2).join(';')\n  const status = digest.at(-2)\n\n  const statusCode = Number(status)\n\n  return (\n    errorCode === REDIRECT_ERROR_CODE &&\n    (type === 'replace' || type === 'push') &&\n    typeof destination === 'string' &&\n    !isNaN(statusCode) &&\n    statusCode in RedirectStatusCode\n  )\n}\n","import { RedirectStatusCode } from './redirect-status-code'\nimport {\n  RedirectType,\n  type RedirectError,\n  isRedirectError,\n  REDIRECT_ERROR_CODE,\n} from './redirect-error'\n\nconst actionAsyncStorage =\n  typeof window === 'undefined'\n    ? (\n        require('../../server/app-render/action-async-storage.external') as typeof import('../../server/app-render/action-async-storage.external')\n      ).actionAsyncStorage\n    : undefined\n\nexport function getRedirectError(\n  url: string,\n  type: RedirectType,\n  statusCode: RedirectStatusCode = RedirectStatusCode.TemporaryRedirect\n): RedirectError {\n  const error = new Error(REDIRECT_ERROR_CODE) as RedirectError\n  error.digest = `${REDIRECT_ERROR_CODE};${type};${url};${statusCode};`\n  return error\n}\n\n/**\n * This function allows you to redirect the user to another URL. It can be used in\n * [Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components),\n * [Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers), and\n * [Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations).\n *\n * - In a Server Component, this will insert a meta tag to redirect the user to the target page.\n * - In a Route Handler or Server Action, it will serve a 307/303 to the caller.\n * - In a Server Action, type defaults to 'push' and 'replace' elsewhere.\n *\n * Read more: [Next.js Docs: `redirect`](https://nextjs.org/docs/app/api-reference/functions/redirect)\n */\nexport function redirect(\n  /** The URL to redirect to */\n  url: string,\n  type?: RedirectType\n): never {\n  type ??= actionAsyncStorage?.getStore()?.isAction\n    ? RedirectType.push\n    : RedirectType.replace\n\n  throw getRedirectError(url, type, RedirectStatusCode.TemporaryRedirect)\n}\n\n/**\n * This function allows you to redirect the user to another URL. It can be used in\n * [Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components),\n * [Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers), and\n * [Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations).\n *\n * - In a Server Component, this will insert a meta tag to redirect the user to the target page.\n * - In a Route Handler or Server Action, it will serve a 308/303 to the caller.\n *\n * Read more: [Next.js Docs: `redirect`](https://nextjs.org/docs/app/api-reference/functions/redirect)\n */\nexport function permanentRedirect(\n  /** The URL to redirect to */\n  url: string,\n  type: RedirectType = RedirectType.replace\n): never {\n  throw getRedirectError(url, type, RedirectStatusCode.PermanentRedirect)\n}\n\n/**\n * Returns the encoded URL from the error if it's a RedirectError, null\n * otherwise. Note that this does not validate the URL returned.\n *\n * @param error the error that may be a redirect error\n * @return the url if the error was a redirect error\n */\nexport function getURLFromRedirectError(error: RedirectError): string\nexport function getURLFromRedirectError(error: unknown): string | null {\n  if (!isRedirectError(error)) return null\n\n  // Slices off the beginning of the digest that contains the code and the\n  // separating ';'.\n  return error.digest.split(';').slice(2, -2).join(';')\n}\n\nexport function getRedirectTypeFromError(error: RedirectError): RedirectType {\n  if (!isRedirectError(error)) {\n    throw new Error('Not a redirect error')\n  }\n\n  return error.digest.split(';', 2)[1] as RedirectType\n}\n\nexport function getRedirectStatusCodeFromError(error: RedirectError): number {\n  if (!isRedirectError(error)) {\n    throw new Error('Not a redirect error')\n  }\n\n  return Number(error.digest.split(';').at(-2))\n}\n","export const HTTPAccessErrorStatus = {\n  NOT_FOUND: 404,\n  FORBIDDEN: 403,\n  UNAUTHORIZED: 401,\n}\n\nconst ALLOWED_CODES = new Set(Object.values(HTTPAccessErrorStatus))\n\nexport const HTTP_ERROR_FALLBACK_ERROR_CODE = 'NEXT_HTTP_ERROR_FALLBACK'\n\nexport type HTTPAccessFallbackError = Error & {\n  digest: `${typeof HTTP_ERROR_FALLBACK_ERROR_CODE};${string}`\n}\n\n/**\n * Checks an error to determine if it's an error generated by\n * the HTTP navigation APIs `notFound()`, `forbidden()` or `unauthorized()`.\n *\n * @param error the error that may reference a HTTP access error\n * @returns true if the error is a HTTP access error\n */\nexport function isHTTPAccessFallbackError(\n  error: unknown\n): error is HTTPAccessFallbackError {\n  if (\n    typeof error !== 'object' ||\n    error === null ||\n    !('digest' in error) ||\n    typeof error.digest !== 'string'\n  ) {\n    return false\n  }\n  const [prefix, httpStatus] = error.digest.split(';')\n\n  return (\n    prefix === HTTP_ERROR_FALLBACK_ERROR_CODE &&\n    ALLOWED_CODES.has(Number(httpStatus))\n  )\n}\n\nexport function getAccessFallbackHTTPStatus(\n  error: HTTPAccessFallbackError\n): number {\n  const httpStatus = error.digest.split(';')[1]\n  return Number(httpStatus)\n}\n\nexport function getAccessFallbackErrorTypeByStatus(\n  status: number\n): 'not-found' | 'forbidden' | 'unauthorized' | undefined {\n  switch (status) {\n    case 401:\n      return 'unauthorized'\n    case 403:\n      return 'forbidden'\n    case 404:\n      return 'not-found'\n    default:\n      return\n  }\n}\n","import {\n  HTTP_ERROR_FALLBACK_ERROR_CODE,\n  type HTTPAccessFallbackError,\n} from './http-access-fallback/http-access-fallback'\n\n/**\n * This function allows you to render the [not-found.js file](https://nextjs.org/docs/app/api-reference/file-conventions/not-found)\n * within a route segment as well as inject a tag.\n *\n * `notFound()` can be used in\n * [Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components),\n * [Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers), and\n * [Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations).\n *\n * - In a Server Component, this will insert a `<meta name=\"robots\" content=\"noindex\" />` meta tag and set the status code to 404.\n * - In a Route Handler or Server Action, it will serve a 404 to the caller.\n *\n * Read more: [Next.js Docs: `notFound`](https://nextjs.org/docs/app/api-reference/functions/not-found)\n */\n\nconst DIGEST = `${HTTP_ERROR_FALLBACK_ERROR_CODE};404`\n\nexport function notFound(): never {\n  const error = new Error(DIGEST) as HTTPAccessFallbackError\n  ;(error as HTTPAccessFallbackError).digest = DIGEST\n\n  throw error\n}\n","import {\n  HTTP_ERROR_FALLBACK_ERROR_CODE,\n  type HTTPAccessFallbackError,\n} from './http-access-fallback/http-access-fallback'\n\n// TODO: Add `forbidden` docs\n/**\n * @experimental\n * This function allows you to render the [forbidden.js file](https://nextjs.org/docs/app/api-reference/file-conventions/forbidden)\n * within a route segment as well as inject a tag.\n *\n * `forbidden()` can be used in\n * [Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components),\n * [Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers), and\n * [Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations).\n *\n * Read more: [Next.js Docs: `forbidden`](https://nextjs.org/docs/app/api-reference/functions/forbidden)\n */\n\nconst DIGEST = `${HTTP_ERROR_FALLBACK_ERROR_CODE};403`\n\nexport function forbidden(): never {\n  if (!process.env.__NEXT_EXPERIMENTAL_AUTH_INTERRUPTS) {\n    throw new Error(\n      `\\`forbidden()\\` is experimental and only allowed to be enabled when \\`experimental.authInterrupts\\` is enabled.`\n    )\n  }\n\n  const error = new Error(DIGEST) as HTTPAccessFallbackError\n  ;(error as HTTPAccessFallbackError).digest = DIGEST\n  throw error\n}\n","import {\n  HTTP_ERROR_FALLBACK_ERROR_CODE,\n  type HTTPAccessFallbackError,\n} from './http-access-fallback/http-access-fallback'\n\n// TODO: Add `unauthorized` docs\n/**\n * @experimental\n * This function allows you to render the [unauthorized.js file](https://nextjs.org/docs/app/api-reference/file-conventions/unauthorized)\n * within a route segment as well as inject a tag.\n *\n * `unauthorized()` can be used in\n * [Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components),\n * [Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers), and\n * [Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations).\n *\n *\n * Read more: [Next.js Docs: `unauthorized`](https://nextjs.org/docs/app/api-reference/functions/unauthorized)\n */\n\nconst DIGEST = `${HTTP_ERROR_FALLBACK_ERROR_CODE};401`\n\nexport function unauthorized(): never {\n  if (!process.env.__NEXT_EXPERIMENTAL_AUTH_INTERRUPTS) {\n    throw new Error(\n      `\\`unauthorized()\\` is experimental and only allowed to be used when \\`experimental.authInterrupts\\` is enabled.`\n    )\n  }\n\n  const error = new Error(DIGEST) as HTTPAccessFallbackError\n  ;(error as HTTPAccessFallbackError).digest = DIGEST\n  throw error\n}\n","const REACT_POSTPONE_TYPE: symbol = Symbol.for('react.postpone')\n\nexport function isPostpone(error: any): boolean {\n  return (\n    typeof error === 'object' &&\n    error !== null &&\n    error.$$typeof === REACT_POSTPONE_TYPE\n  )\n}\n","import {\n  isHTTPAccessFallbackError,\n  type HTTPAccessFallbackError,\n} from './http-access-fallback/http-access-fallback'\nimport { isRedirectError, type RedirectError } from './redirect-error'\n\n/**\n * Returns true if the error is a navigation signal error. These errors are\n * thrown by user code to perform navigation operations and interrupt the React\n * render.\n */\nexport function isNextRouterError(\n  error: unknown\n): error is RedirectError | HTTPAccessFallbackError {\n  return isRedirectError(error) || isHTTPAccessFallbackError(error)\n}\n","import { isHangingPromiseRejectionError } from '../../server/dynamic-rendering-utils'\nimport { isPostpone } from '../../server/lib/router-utils/is-postpone'\nimport { isBailoutToCSRError } from '../../shared/lib/lazy-dynamic/bailout-to-csr'\nimport { isNextRouterError } from './is-next-router-error'\nimport {\n  isDynamicPostpone,\n  isPrerenderInterruptedError,\n} from '../../server/app-render/dynamic-rendering'\nimport { isDynamicServerError } from './hooks-server-context'\n\nexport function unstable_rethrow(error: unknown): void {\n  if (\n    isNextRouterError(error) ||\n    isBailoutToCSRError(error) ||\n    isDynamicServerError(error) ||\n    isDynamicPostpone(error) ||\n    isPostpone(error) ||\n    isHangingPromiseRejectionError(error) ||\n    isPrerenderInterruptedError(error)\n  ) {\n    throw error\n  }\n\n  if (error instanceof Error && 'cause' in error) {\n    unstable_rethrow(error.cause)\n  }\n}\n","/**\n * This function should be used to rethrow internal Next.js errors so that they can be handled by the framework.\n * When wrapping an API that uses errors to interrupt control flow, you should use this function before you do any error handling.\n * This function will rethrow the error if it is a Next.js error so it can be handled, otherwise it will do nothing.\n *\n * Read more: [Next.js Docs: `unstable_rethrow`](https://nextjs.org/docs/app/api-reference/functions/unstable_rethrow)\n */\nexport const unstable_rethrow =\n  typeof window === 'undefined'\n    ? (\n        require('./unstable-rethrow.server') as typeof import('./unstable-rethrow.server')\n      ).unstable_rethrow\n    : (\n        require('./unstable-rethrow.browser') as typeof import('./unstable-rethrow.browser')\n      ).unstable_rethrow\n","import { ReadonlyURLSearchParams } from './readonly-url-search-params'\n\nexport function unstable_isUnrecognizedActionError(): boolean {\n  throw new Error(\n    '`unstable_isUnrecognizedActionError` can only be used on the client.'\n  )\n}\n\nexport { redirect, permanentRedirect } from './redirect'\nexport { RedirectType } from './redirect-error'\nexport { notFound } from './not-found'\nexport { forbidden } from './forbidden'\nexport { unauthorized } from './unauthorized'\nexport { unstable_rethrow } from './unstable-rethrow'\nexport { ReadonlyURLSearchParams }\n","export * from '../client/components/navigation.react-server'\n","/**\n * Permission System - Server-Side Utilities\n *\n * Provides type-safe permission checking for role-based access control (RBAC).\n * Uses database functions for secure, centralized permission logic.\n *\n * Performance optimizations:\n * - Database functions are cached by Postgres\n * - Single query permission checks\n * - Prepared statements for security\n *\n * @example\n * ```typescript\n * // Check if user can delete jobs\n * const canDelete = await hasPermission(supabase, userId, \"delete_jobs\", companyId);\n *\n * // Check if user has manager role\n * const isManager = await hasRole(supabase, userId, \"manager\", companyId);\n *\n * // Get user's role\n * const role = await getUserRole(supabase, userId, companyId);\n * ```\n */\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/**\n * User roles in the system\n * Matches the user_role ENUM in database\n */\nexport type UserRole =\n\t| \"owner\"\n\t| \"admin\"\n\t| \"manager\"\n\t| \"dispatcher\"\n\t| \"technician\"\n\t| \"csr\";\n\n/**\n * Permission keys for fine-grained access control\n */\nexport type Permission =\n\t// Manager permissions\n\t| \"view_reports\"\n\t| \"manage_team\"\n\t| \"approve_estimates\"\n\t| \"handle_escalations\"\n\t// Dispatcher permissions\n\t| \"dispatch_jobs\"\n\t| \"manage_schedule\"\n\t| \"view_tech_locations\"\n\t// Technician permissions\n\t| \"update_job_status\"\n\t| \"create_invoices\"\n\t| \"upload_photos\"\n\t// CSR permissions\n\t| \"create_jobs\"\n\t| \"schedule_appointments\"\n\t| \"send_communications\"\n\t// View permissions\n\t| \"view_customers\"\n\t| \"view_jobs\"\n\t| \"view_schedule\"\n\t// Delete permissions\n\t| \"delete_jobs\"\n\t| \"delete_customers\"\n\t| \"delete_team_members\";\n\n/**\n * Role configuration with permissions and metadata\n */\nexport type RoleConfig = {\n\tid: UserRole;\n\tlabel: string;\n\tdescription: string;\n\tpermissions: Permission[];\n\tdashboardFeatures: string[];\n};\n\n// ============================================================================\n// Role Definitions\n// ============================================================================\n\n/**\n * Complete role configurations with their permissions\n * Used for UI display and permission reference\n */\nconst ROLES: Record<UserRole, RoleConfig> = {\n\towner: {\n\t\tid: \"owner\",\n\t\tlabel: \"Owner\",\n\t\tdescription:\n\t\t\t\"Full system access with focus on business financials and growth\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t\t\"delete_customers\",\n\t\t\t\"delete_team_members\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"financial-overview\",\n\t\t\t\"profit-margins\",\n\t\t\t\"cash-flow\",\n\t\t\t\"business-growth\",\n\t\t\t\"payroll-overview\",\n\t\t\t\"all-reports\",\n\t\t],\n\t},\n\tadmin: {\n\t\tid: \"admin\",\n\t\tlabel: \"Admin\",\n\t\tdescription: \"System administration and configuration\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t\t\"delete_customers\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"system-settings\",\n\t\t\t\"user-management\",\n\t\t\t\"integrations\",\n\t\t\t\"audit-logs\",\n\t\t],\n\t},\n\tmanager: {\n\t\tid: \"manager\",\n\t\tlabel: \"Manager\",\n\t\tdescription:\n\t\t\t\"Oversee team performance, customer satisfaction, and operations\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"team-performance\",\n\t\t\t\"customer-satisfaction\",\n\t\t\t\"callback-queue\",\n\t\t\t\"review-alerts\",\n\t\t\t\"kpi-tracking\",\n\t\t\t\"inventory-management\",\n\t\t],\n\t},\n\tdispatcher: {\n\t\tid: \"dispatcher\",\n\t\tlabel: \"Dispatcher\",\n\t\tdescription:\n\t\t\t\"Manage technician schedules, job assignments, and real-time operations\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"dispatch-map\",\n\t\t\t\"technician-locations\",\n\t\t\t\"unassigned-jobs\",\n\t\t\t\"emergency-queue\",\n\t\t\t\"quick-dispatch\",\n\t\t\t\"tech-status\",\n\t\t],\n\t},\n\ttechnician: {\n\t\tid: \"technician\",\n\t\tlabel: \"Technician\",\n\t\tdescription:\n\t\t\t\"View assigned jobs, update job status, and track personal performance\",\n\t\tpermissions: [\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"my-schedule\",\n\t\t\t\"active-job\",\n\t\t\t\"my-earnings\",\n\t\t\t\"my-performance\",\n\t\t\t\"parts-inventory\",\n\t\t\t\"time-tracking\",\n\t\t],\n\t},\n\tcsr: {\n\t\tid: \"csr\",\n\t\tlabel: \"Customer Service Rep\",\n\t\tdescription:\n\t\t\t\"Handle customer calls, schedule appointments, and manage customer relationships\",\n\t\tpermissions: [\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"create_invoices\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"call-queue\",\n\t\t\t\"booking-calendar\",\n\t\t\t\"customer-search\",\n\t\t\t\"follow-up-queue\",\n\t\t\t\"estimate-pipeline\",\n\t\t\t\"call-scripts\",\n\t\t],\n\t},\n};\n\n// ============================================================================\n// Permission Check Functions\n// ============================================================================\n\n/**\n * Check if user has a specific role in a company\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param role - Role to check for\n * @param companyId - Company ID\n * @returns true if user has the role\n *\n * @example\n * ```typescript\n * const isManager = await hasRole(supabase, userId, \"manager\", companyId);\n * if (!isManager) {\n *   throw new Error(\"Access denied: Manager role required\");\n * }\n * ```\n */\nexport async function hasRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\trole: UserRole,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_role\", {\n\t\tuser_uuid: userId,\n\t\trequired_role: role,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Check if user has ANY of the specified roles\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param roles - Array of roles to check\n * @param companyId - Company ID\n * @returns true if user has any of the roles\n *\n * @example\n * ```typescript\n * const canManage = await hasAnyRole(\n *   supabase,\n *   userId,\n *   [\"owner\", \"manager\", \"admin\"],\n *   companyId\n * );\n * ```\n */\nasync function hasAnyRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\troles: UserRole[],\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_any_role\", {\n\t\tuser_uuid: userId,\n\t\trequired_roles: roles,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Get user's role in a company\n *\n * @param supabase - Supabase client\n * @param userId - User ID\n * @param companyId - Company ID\n * @returns User's role or null if not found\n *\n * @example\n * ```typescript\n * const role = await getUserRole(supabase, userId, companyId);\n * console.log(`User role: ${role}`); // \"manager\"\n * ```\n */\nexport async function getUserRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tcompanyId: string,\n): Promise<UserRole | null> {\n\tconst { data, error } = await supabase.rpc(\"get_user_role\", {\n\t\tuser_uuid: userId,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn null;\n\t}\n\n\treturn data as UserRole | null;\n}\n\n/**\n * Check if user has a specific permission\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param permission - Permission key to check\n * @param companyId - Company ID\n * @returns true if user has the permission\n *\n * @example\n * ```typescript\n * const canDelete = await hasPermission(supabase, userId, \"delete_jobs\", companyId);\n * if (!canDelete) {\n *   return { error: \"You don't have permission to delete jobs\" };\n * }\n * ```\n */\nexport async function hasPermission(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tpermission: Permission,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_permission\", {\n\t\tuser_uuid: userId,\n\t\tpermission_key: permission,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Check if user is the company owner\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param companyId - Company ID\n * @returns true if user is the owner\n *\n * @example\n * ```typescript\n * const isOwner = await isCompanyOwner(supabase, userId, companyId);\n * if (!isOwner) {\n *   throw new Error(\"Only company owner can perform this action\");\n * }\n * ```\n */\nexport async function isCompanyOwner(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"is_company_owner\", {\n\t\tuser_uuid: userId,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\n/**\n * Get all permissions for a role\n *\n * @param role - Role to get permissions for\n * @returns Array of permission keys\n *\n * @example\n * ```typescript\n * const managerPerms = getRolePermissions(\"manager\");\n * console.log(managerPerms); // [\"view_reports\", \"manage_team\", ...]\n * ```\n */\nfunction getRolePermissions(role: UserRole): Permission[] {\n\treturn ROLES[role]?.permissions || [];\n}\n\n/**\n * Check if a role has a specific permission (client-side check only)\n *\n * @param role - Role to check\n * @param permission - Permission to check for\n * @returns true if role has the permission\n *\n * @example\n * ```typescript\n * const canDelete = roleHasPermission(\"manager\", \"delete_jobs\");\n * ```\n */\nfunction roleHasPermission(\n\trole: UserRole,\n\tpermission: Permission,\n): boolean {\n\treturn ROLES[role]?.permissions.includes(permission);\n}\n\n/**\n * Get role configuration\n *\n * @param role - Role to get config for\n * @returns Role configuration\n *\n * @example\n * ```typescript\n * const config = getRoleConfig(\"manager\");\n * console.log(config.label); // \"Manager\"\n * ```\n */\nfunction getRoleConfig(role: UserRole): RoleConfig {\n\treturn ROLES[role];\n}\n","// Re-export from @stratos/auth package for backwards compatibility\nexport * from \"@stratos/auth/permissions\";\n","/**\n * Role Actions - Server Actions\n *\n * Server-side actions for role management and permission checks.\n * Uses Supabase RLS and database functions for security.\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport {\n\tgetUserRole,\n\thasPermission,\n\thasRole,\n\tisCompanyOwner,\n\ttype Permission,\n\ttype UserRole,\n} from \"@/lib/auth/permissions\";\nimport { withErrorHandling } from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// ============================================================================\n// Validation Schemas\n// ============================================================================\n\nconst updateRoleSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tnewRole: z.enum([\n\t\t\"owner\",\n\t\t\"admin\",\n\t\t\"manager\",\n\t\t\"dispatcher\",\n\t\t\"technician\",\n\t\t\"csr\",\n\t]),\n\treason: z.string().optional(),\n});\n\nconst updatePermissionsSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tpermissions: z.record(z.string(), z.boolean()),\n});\n\n// ============================================================================\n// Query Actions\n// ============================================================================\n\n/**\n * Get current user's role in active company\n *\n * @returns User's role or null\n *\n * @example\n * ```typescript\n * const role = await getCurrentUserRole();\n * if (role.success && role.data === \"manager\") {\n *   // Show manager dashboard\n * }\n * ```\n */\nexport async function getCurrentUserRole() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst role = await getUserRole(supabase, user.id, companyId);\n\n\t\treturn role;\n\t});\n}\n\n/**\n * Check if current user has a specific permission\n *\n * @param permission - Permission to check\n * @returns true if user has permission\n *\n * @example\n * ```typescript\n * const result = await checkPermission(\"delete_jobs\");\n * if (!result.success || !result.data) {\n *   return { error: \"Access denied\" };\n * }\n * ```\n */\nasync function checkPermission(permission: Permission) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasPerm = await hasPermission(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t\tpermission,\n\t\t\tcompanyId,\n\t\t);\n\n\t\treturn hasPerm;\n\t});\n}\n\n/**\n * Check if current user has a specific role\n *\n * @param role - Role to check\n * @returns true if user has role\n *\n * @example\n * ```typescript\n * const result = await checkRole(\"manager\");\n * if (!result.success || !result.data) {\n *   redirect(\"/dashboard\");\n * }\n * ```\n */\nasync function checkRole(role: UserRole) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasRoleResult = await hasRole(supabase, user.id, role, companyId);\n\n\t\treturn hasRoleResult;\n\t});\n}\n\n/**\n * Check if current user is company owner\n *\n * @returns true if user is owner\n */\nasync function checkIsOwner() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\n\t\treturn isOwner;\n\t});\n}\n\n// ============================================================================\n// Mutation Actions\n// ============================================================================\n\n/**\n * Update team member's role\n * Only owners and admins can change roles\n *\n * @param input - Team member ID, new role, and optional reason\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberRole({\n *   teamMemberId: \"123...\",\n *   newRole: \"manager\",\n *   reason: \"Promoted to management\"\n * });\n * ```\n */\nasync function updateTeamMemberRole(\n\tinput: z.infer<typeof updateRoleSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updateRoleSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission - only owners and admins can change roles\n\t\tconst canManageRoles =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManageRoles) {\n\t\t\tthrow new Error(\"Only owners and admins can change roles\");\n\t\t}\n\n\t\t// Get current role for audit log\n\t\tconst { data: currentMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"role\")\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!currentMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Update role\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ role: validated.newRole })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\t// Log role change\n\t\tawait supabase.from(\"role_change_log\").insert({\n\t\t\tteam_member_id: validated.teamMemberId,\n\t\t\tchanged_by: user.id,\n\t\t\told_role: currentMember.role,\n\t\t\tnew_role: validated.newRole,\n\t\t\treason: validated.reason,\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Update team member's custom permissions\n * Only owners and admins can change permissions\n *\n * @param input - Team member ID and permissions object\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberPermissions({\n *   teamMemberId: \"123...\",\n *   permissions: {\n *     \"delete_jobs\": true,\n *     \"approve_estimates\": true\n *   }\n * });\n * ```\n */\nasync function updateTeamMemberPermissions(\n\tinput: z.infer<typeof updatePermissionsSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updatePermissionsSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission\n\t\tconst canManagePermissions =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManagePermissions) {\n\t\t\tthrow new Error(\"Only owners and admins can change permissions\");\n\t\t}\n\n\t\t// Update permissions\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ permissions: validated.permissions })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Get team members with their roles\n *\n * @returns List of team members with roles\n */\nasync function getTeamMembersWithRoles() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        users (\n          id,\n          name,\n          email,\n          avatar\n        )\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n// ============================================================================\n// Owner Protection Actions\n// ============================================================================\n\n/**\n * Transfer company ownership to another team member\n * Requires password verification and extensive validation\n *\n * @param input - Transfer details including new owner, password, and reason\n * @returns Transfer ID for audit\n *\n * @example\n * ```typescript\n * const result = await transferOwnership({\n *   newOwnerId: \"user-uuid\",\n *   password: \"current-password\",\n *   reason: \"Retiring from business\"\n * });\n * ```\n */\nasync function transferOwnership(input: {\n\tnewOwnerId: string;\n\tpassword: string;\n\treason?: string;\n\tipAddress?: string;\n\tuserAgent?: string;\n}) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Verify user is current owner\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\t\tif (!isOwner) {\n\t\t\tthrow new Error(\"Only the current owner can transfer ownership\");\n\t\t}\n\n\t\t// Verify password\n\t\tconst { error: signInError } = await supabase.auth.signInWithPassword({\n\t\t\temail: user.email || \"\",\n\t\t\tpassword: input.password,\n\t\t});\n\n\t\tif (signInError) {\n\t\t\tthrow new Error(\"Password verification failed\");\n\t\t}\n\n\t\t// Call database function to transfer ownership\n\t\tconst { data: transferId, error } = await supabase.rpc(\n\t\t\t\"transfer_company_ownership\",\n\t\t\t{\n\t\t\t\tp_company_id: companyId,\n\t\t\t\tp_current_owner_id: user.id,\n\t\t\t\tp_new_owner_id: input.newOwnerId,\n\t\t\t\tp_reason: input.reason,\n\t\t\t\tp_ip_address: input.ipAddress,\n\t\t\t\tp_user_agent: input.userAgent,\n\t\t\t},\n\t\t);\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message || \"Failed to transfer ownership\");\n\t\t}\n\n\t\t// Revalidate all relevant paths\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard\");\n\n\t\treturn transferId;\n\t});\n}\n\n/**\n * Get ownership transfer history for the company\n * Shows audit trail of all ownership changes\n *\n * @returns List of ownership transfers\n */\nasync function getOwnershipTransferHistory() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\t// Only owners and admins can view transfer history\n\t\tconst canView =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canView) {\n\t\t\tthrow new Error(\"Only owners and admins can view transfer history\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"ownership_transfers\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        previous_owner:users!ownership_transfers_previous_owner_id_fkey(id, name, email),\n        new_owner:users!ownership_transfers_new_owner_id_fkey(id, name, email),\n        initiated_by_user:users!ownership_transfers_initiated_by_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n/**\n * Check if a team member can be deleted\n * Prevents deletion of company owner\n *\n * @param teamMemberId - Team member to check\n * @returns Object with canDelete boolean and reason if not allowed\n */\nexport async function canDeleteTeamMember(teamMemberId: string) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Get team member details\n\t\tconst { data: teamMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"user_id, role\")\n\t\t\t.eq(\"id\", teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error || !teamMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Check if user is company owner\n\t\tconst { data: company } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"owner_id\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (company && company.owner_id === teamMember.user_id) {\n\t\t\treturn {\n\t\t\t\tcanDelete: false,\n\t\t\t\treason:\n\t\t\t\t\t\"Cannot delete company owner. Transfer ownership first before removing this team member.\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tcanDelete: true,\n\t\t};\n\t});\n}\n"],"names":["ReadonlyURLSearchParams","ReadonlyURLSearchParamsError","Error","constructor","URLSearchParams","append","delete","set","sort","RedirectStatusCode","REDIRECT_ERROR_CODE","RedirectType","isRedirectError","error","digest","split","errorCode","type","destination","slice","join","status","at","statusCode","Number","isNaN","getRedirectError","getRedirectStatusCodeFromError","getRedirectTypeFromError","getURLFromRedirectError","permanentRedirect","redirect","actionAsyncStorage","window","require","undefined","url","TemporaryRedirect","getStore","isAction","push","replace","PermanentRedirect","HTTPAccessErrorStatus","HTTP_ERROR_FALLBACK_ERROR_CODE","getAccessFallbackErrorTypeByStatus","getAccessFallbackHTTPStatus","isHTTPAccessFallbackError","NOT_FOUND","FORBIDDEN","UNAUTHORIZED","ALLOWED_CODES","Set","Object","values","prefix","httpStatus","has","notFound","DIGEST","forbidden","process","env","__NEXT_EXPERIMENTAL_AUTH_INTERRUPTS","unauthorized","isPostpone","REACT_POSTPONE_TYPE","Symbol","for","$$typeof","isNextRouterError","unstable_rethrow","isBailoutToCSRError","isDynamicServerError","isDynamicPostpone","isHangingPromiseRejectionError","isPrerenderInterruptedError","cause","unstable_isUnrecognizedActionError"],"mappings":"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","ignoreList":[0,1,2,3,4,5,6,7,8,9,10,11,12,13]}