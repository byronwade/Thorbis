{"version":3,"sources":["../../../../../../apps/web/src/lib/telnyx/webrtc.ts"],"sourcesContent":["/**\n * Telnyx WebRTC Service - Real-Time Communications\n *\n * Handles WebRTC operations for browser and React Native calling:\n * - WebRTC token generation\n * - Credential management\n * - Connection configuration\n *\n * Compatible with both web browsers and React Native apps.\n */\n\nimport { Buffer } from \"node:buffer\";\n\n/**\n * WebRTC connection options\n */\nexport type WebRTCConnectionOptions = {\n\tusername?: string;\n\tpassword?: string;\n\texpires_at?: number;\n\tttl?: number;\n};\n\n/**\n * WebRTC credential response\n */\nexport type WebRTCCredential = {\n\tusername: string;\n\tpassword: string;\n\texpires_at: number;\n\trealm: string;\n\tsip_uri: string;\n\tstun_servers: string[];\n\tturn_servers: Array<{\n\t\turls: string[];\n\t\tusername: string;\n\t\tcredential: string;\n\t}>;\n};\n\nconst TELNYX_CREDENTIAL_NAME_MAX_LENGTH = 64;\n\n/**\n * Generate WebRTC credentials for a user\n *\n * These credentials are used to authenticate the WebRTC client\n * and establish a connection to Telnyx's WebRTC platform.\n */\nexport async function generateWebRTCToken(params: {\n\tusername: string;\n\tttl?: number; // Time to live in seconds (default: 86400 = 24 hours)\n}): Promise<{\n\tsuccess: boolean;\n\tcredential?: WebRTCCredential;\n\terror?: string;\n}> {\n\ttry {\n\t\tconst apiKey = process.env.TELNYX_API_KEY;\n\n\t\tif (!apiKey) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"TELNYX_API_KEY is not configured\",\n\t\t\t};\n\t\t}\n\n\t\t// Sanitize username - Telnyx requires only letters and numbers\n\t\t// Remove all special characters (@, ., -, _, etc.) and replace with empty string\n\t\tconst sanitizedUsername = params.username.replace(/[^a-zA-Z0-9]/g, \"\");\n\n\t\tconst baseName =\n\t\t\tsanitizedUsername.length > 0\n\t\t\t\t? sanitizedUsername\n\t\t\t\t: Buffer.from(params.username || \"user\").toString(\"hex\");\n\t\tconst uniqueSuffix = Date.now().toString(36);\n\t\tconst prefixLength = Math.max(\n\t\t\t1,\n\t\t\tTELNYX_CREDENTIAL_NAME_MAX_LENGTH - uniqueSuffix.length,\n\t\t);\n\t\tconst credentialPrefix = baseName.slice(0, prefixLength);\n\t\tconst staticName = `${credentialPrefix}${uniqueSuffix}`;\n\t\tconst listResponse = await fetch(\n\t\t\t\"https://api.telnyx.com/v2/credential_connections\",\n\t\t\t{\n\t\t\t\tmethod: \"GET\",\n\t\t\t\theaders: {\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tif (listResponse.ok) {\n\t\t\tconst listData = await listResponse.json();\n\n\t\t\t// Delete old credentials that match this user's sanitized username\n\t\t\tif (listData.data && Array.isArray(listData.data)) {\n\t\t\t\tconst userCredentials = listData.data.filter((cred: any) =>\n\t\t\t\t\tcred.connection_name?.startsWith(credentialPrefix),\n\t\t\t\t);\n\n\t\t\t\tfor (const cred of userCredentials) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait fetch(\n\t\t\t\t\t\t\t`https://api.telnyx.com/v2/credential_connections/${cred.id}`,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tmethod: \"DELETE\",\n\t\t\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\t\t\t\t\t} catch (_error) {\n\t\t\t\t\t\t// Continue anyway - deletion errors shouldn't block new credential creation\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst generatedPassword = generateRandomPassword(32);\n\n\t\t// Use Telnyx REST API to create WebRTC credentials\n\t\t// Documentation: https://developers.telnyx.com/api/v2/webrtc/credentials\n\t\tconst response = await fetch(\n\t\t\t\"https://api.telnyx.com/v2/credential_connections\",\n\t\t\t{\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders: {\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tconnection_name: staticName,\n\t\t\t\t\tuser_name: staticName,\n\t\t\t\t\tpassword: generatedPassword,\n\t\t\t\t\tttl: params.ttl || 86_400,\n\t\t\t\t}),\n\t\t\t},\n\t\t);\n\n\t\tif (!response.ok) {\n\t\t\tconst errorText = await response.text();\n\n\t\t\t// If the API endpoint isn't available, try the simpler credentials endpoint\n\t\t\tconst altPassword = generateRandomPassword(32);\n\t\t\tconst altResponse = await fetch(\n\t\t\t\t\"https://api.telnyx.com/v2/texml_credentials\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t\t\t},\n\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\tconnection_name: staticName,\n\t\t\t\t\t\tuser_name: staticName, // Both must be unique!\n\t\t\t\t\t\tpassword: altPassword,\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t);\n\n\t\t\tif (!altResponse.ok) {\n\t\t\t\tconst _altErrorText = await altResponse.text();\n\t\t\t\tthrow new Error(`Telnyx API error: ${response.status} - ${errorText}`);\n\t\t\t}\n\n\t\t\tconst altData = await altResponse.json();\n\n\t\t\tconst credential: WebRTCCredential = {\n\t\t\t\tusername: altData.data?.user_name || staticName,\n\t\t\t\tpassword: altData.data?.password || altPassword,\n\t\t\t\texpires_at: Date.now() + (params.ttl || 86_400) * 1000,\n\t\t\t\trealm: \"sip.telnyx.com\",\n\t\t\t\tsip_uri: `sip:${staticName}@sip.telnyx.com`,\n\t\t\t\tstun_servers: [\n\t\t\t\t\t\"stun:stun.telnyx.com:3478\",\n\t\t\t\t\t\"stun:stun.telnyx.com:3479\",\n\t\t\t\t],\n\t\t\t\tturn_servers: [\n\t\t\t\t\t{\n\t\t\t\t\t\turls: [\n\t\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=udp\",\n\t\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=tcp\",\n\t\t\t\t\t\t],\n\t\t\t\t\t\tusername: altData.data?.user_name || staticName,\n\t\t\t\t\t\tcredential: altData.data?.password || generateRandomPassword(24),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t};\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tcredential,\n\t\t\t};\n\t\t}\n\t\tconst data = await response.json();\n\n\t\t// Map Telnyx API response to our credential format\n\t\tconst credential: WebRTCCredential = {\n\t\t\tusername: data.data?.user_name || staticName,\n\t\t\tpassword: data.data?.password || generatedPassword,\n\t\t\texpires_at: data.data?.expires_at\n\t\t\t\t? new Date(data.data.expires_at).getTime()\n\t\t\t\t: Date.now() + (params.ttl || 86_400) * 1000,\n\t\t\trealm: data.data?.realm || \"sip.telnyx.com\",\n\t\t\tsip_uri: data.data?.sip_uri || `sip:${staticName}@sip.telnyx.com`,\n\t\t\tstun_servers: data.data?.ice_servers?.stun || [\n\t\t\t\t\"stun:stun.telnyx.com:3478\",\n\t\t\t\t\"stun:stun.telnyx.com:3479\",\n\t\t\t],\n\t\t\tturn_servers: data.data?.ice_servers?.turn || [\n\t\t\t\t{\n\t\t\t\t\turls: [\n\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=udp\",\n\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=tcp\",\n\t\t\t\t\t],\n\t\t\t\t\tusername: data.data?.user_name || staticName,\n\t\t\t\t\tcredential: data.data?.password,\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcredential,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to generate WebRTC token\",\n\t\t};\n\t}\n}\n\n/**\n * Validate WebRTC credential expiration\n */\nfunction isCredentialExpired(credential: WebRTCCredential): boolean {\n\treturn Date.now() >= credential.expires_at;\n}\n\n/**\n * Get time until credential expires (in seconds)\n */\nfunction getCredentialTimeToLive(credential: WebRTCCredential): number {\n\tconst ttl = Math.floor((credential.expires_at - Date.now()) / 1000);\n\treturn Math.max(0, ttl);\n}\n\n/**\n * Format SIP URI for calling\n */\nfunction formatSIPUri(\n\tphoneNumber: string,\n\trealm = \"sip.telnyx.com\",\n): string {\n\t// Remove any non-digit characters\n\tconst cleanNumber = phoneNumber.replace(/\\D/g, \"\");\n\n\t// Format as SIP URI\n\treturn `sip:${cleanNumber}@${realm}`;\n}\n\n/**\n * Generate a random password for WebRTC credentials\n */\nfunction generateRandomPassword(length = 32): string {\n\tconst characters =\n\t\t\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*\";\n\tlet password = \"\";\n\n\tfor (let i = 0; i < length; i++) {\n\t\tpassword += characters.charAt(\n\t\t\tMath.floor(Math.random() * characters.length),\n\t\t);\n\t}\n\n\treturn password;\n}\n\n/**\n * WebRTC connection configuration for @telnyx/webrtc client\n */\nexport type WebRTCClientConfig = {\n\tcredential: WebRTCCredential;\n\ticeServers: RTCIceServer[];\n\tdebug?: boolean;\n\tringbackFile?: string;\n\tringtoneFile?: string;\n};\n\n/**\n * Create WebRTC client configuration\n */\nfunction createWebRTCConfig(\n\tcredential: WebRTCCredential,\n\tdebug = false,\n): WebRTCClientConfig {\n\t// Convert Telnyx credential format to RTCIceServer format\n\tconst iceServers: RTCIceServer[] = [\n\t\t// STUN servers\n\t\t...credential.stun_servers.map((url) => ({\n\t\t\turls: url,\n\t\t})),\n\t\t// TURN servers\n\t\t...credential.turn_servers.map((server) => ({\n\t\t\turls: server.urls,\n\t\t\tusername: server.username,\n\t\t\tcredential: server.credential,\n\t\t})),\n\t];\n\n\treturn {\n\t\tcredential,\n\t\ticeServers,\n\t\tdebug,\n\t};\n}\n\n/**\n * React Native WebRTC configuration helper\n *\n * Provides configuration specific to React Native apps\n */\nfunction createReactNativeWebRTCConfig(\n\tcredential: WebRTCCredential,\n): WebRTCClientConfig {\n\treturn createWebRTCConfig(credential, true); // Enable debug for mobile\n}\n\n/**\n * Web browser WebRTC configuration helper\n */\nfunction createBrowserWebRTCConfig(\n\tcredential: WebRTCCredential,\n): WebRTCClientConfig {\n\treturn createWebRTCConfig(credential, false);\n}\n\n/**\n * Test WebRTC connectivity\n *\n * Checks if the browser/device can connect to STUN/TURN servers\n */\nasync function testWebRTCConnectivity(\n\tcredential: WebRTCCredential,\n): Promise<{\n\tsuccess: boolean;\n\tstunReachable: boolean;\n\tturnReachable: boolean;\n\terror?: string;\n}> {\n\ttry {\n\t\t// Create a test peer connection\n\t\tconst pc = new RTCPeerConnection({\n\t\t\ticeServers: [\n\t\t\t\t{ urls: credential.stun_servers },\n\t\t\t\t...credential.turn_servers.map((server) => ({\n\t\t\t\t\turls: server.urls,\n\t\t\t\t\tusername: server.username,\n\t\t\t\t\tcredential: server.credential,\n\t\t\t\t})),\n\t\t\t],\n\t\t});\n\n\t\tlet stunReachable = false;\n\t\tlet turnReachable = false;\n\n\t\t// Listen for ICE candidates to test connectivity\n\t\tpc.onicecandidate = (event) => {\n\t\t\tif (event.candidate) {\n\t\t\t\tconst candidateType = event.candidate.type;\n\t\t\t\tif (candidateType === \"srflx\") {\n\t\t\t\t\tstunReachable = true;\n\t\t\t\t}\n\t\t\t\tif (candidateType === \"relay\") {\n\t\t\t\t\tturnReachable = true;\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\t// Create a dummy offer to trigger ICE gathering\n\t\tconst offer = await pc.createOffer();\n\t\tawait pc.setLocalDescription(offer);\n\n\t\t// Wait for ICE gathering to complete\n\t\tawait new Promise<void>((resolve) => {\n\t\t\tconst checkState = () => {\n\t\t\t\tif (pc.iceGatheringState === \"complete\") {\n\t\t\t\t\tresolve();\n\t\t\t\t} else {\n\t\t\t\t\tsetTimeout(checkState, 100);\n\t\t\t\t}\n\t\t\t};\n\t\t\tcheckState();\n\t\t});\n\n\t\t// Clean up\n\t\tpc.close();\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tstunReachable,\n\t\t\tturnReachable,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tstunReachable: false,\n\t\t\tturnReachable: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to test connectivity\",\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"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"}