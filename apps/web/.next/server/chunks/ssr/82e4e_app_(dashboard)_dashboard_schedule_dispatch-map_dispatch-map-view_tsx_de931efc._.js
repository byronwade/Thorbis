module.exports=[140813,a=>{"use strict";var b=a.i(861467),c=a.i(783281),d=a.i(97997),e=a.i(916680),f=a.i(653095),g=a.i(204922),h=a.i(805763),h=h,i=a.i(766153),j=a.i(779184),k=a.i(337850),l=a.i(624126),m=a.i(896080),n=a.i(481423),n=n,o=a.i(824124),p=a.i(699756),q=a.i(898062),r=a.i(638727),s=a.i(246840),t=a.i(808249),u=a.i(50900),v=a.i(841269),w=a.i(870693),x=a.i(320091),y=a.i(101482),z=a.i(300298),A=a.i(821278),B=a.i(337241),C=a.i(773608),D=a.i(587969),E=a.i(198803),F=a.i(362841),G=a.i(176498),H=a.i(766291);a.i(445255);var I=a.i(18170);a.i(19256);var J=a.i(417132);a.i(839984);var K=a.i(372712);a.i(458393);var L=a.i(82012);a.i(40744);var M=a.i(419573);a.i(897346);var N=a.i(75892),O=a.i(700760);let P=[{value:"emergency",label:"Emergency / Urgent",color:"text-red-500 dark:text-red-400"},{value:"follow_up",label:"Callback / Follow Up",color:"text-orange-500 dark:text-orange-400"},{value:"maintenance",label:"Maintenance / Recurring",color:"text-purple-500 dark:text-purple-400"},{value:"installation",label:"Install / New Work",color:"text-green-500 dark:text-green-400"},{value:"service_call",label:"Service Call",color:"text-blue-500 dark:text-blue-400"},{value:"inspection",label:"Inspection",color:"text-slate-500 dark:text-slate-400"},{value:"estimate",label:"Estimate",color:"text-amber-500 dark:text-amber-400"},{value:"repair",label:"Repair",color:"text-cyan-500 dark:text-cyan-400"},{value:"winterization",label:"Winterization",color:"text-indigo-500 dark:text-indigo-400"}],Q=[{value:"low",label:"Low",color:"text-slate-500 dark:text-slate-400"},{value:"normal",label:"Normal",color:"text-blue-500 dark:text-blue-400"},{value:"high",label:"High",color:"text-orange-500 dark:text-orange-400"},{value:"urgent",label:"Urgent",color:"text-red-500 dark:text-red-400"}],R=[{value:30,label:"30 min"},{value:60,label:"1 hour"},{value:90,label:"1.5 hours"},{value:120,label:"2 hours"},{value:180,label:"3 hours"},{value:240,label:"4 hours"},{value:480,label:"Full day"}];function S({open:a,onOpenChange:d,location:f,technicians:g=[],nearbyCustomers:h=[],onSuccess:i,onCreateCustomer:j,defaultTechnicianId:k,defaultDateTime:m,defaultDuration:n}){let[p,q]=(0,c.useTransition)(),[r,s]=(0,c.useState)(null),[t,u]=(0,c.useState)(null),[v,w]=(0,c.useState)(null),[y,z]=(0,c.useState)(""),[A,B]=(0,c.useState)("service_call"),[S,T]=(0,c.useState)("normal"),[U,V]=(0,c.useState)(""),[W,X]=(0,c.useState)(60),[Y,Z]=(0,c.useState)("");(0,c.useEffect)(()=>{if(a){if(k&&V(k),m){let a=new Date,b=m;m<a&&((b=new Date).setMinutes(0,0,0),b.setHours(b.getHours()+1)),aa((0,C.format)(b,"yyyy-MM-dd'T'HH:mm"))}n&&X([30,60,90,120,180,240,480].reduce((a,b)=>Math.abs(b-n)<Math.abs(a-n)?b:a))}},[a,k,m,n]);let $=()=>{let a=new Date;return a.setMinutes(0,0,0),a.setHours(a.getHours()+1),a.toISOString().slice(0,16)},[_,aa]=(0,c.useState)($()),ab=(0,c.useCallback)(()=>{let a=new Date(_);return a.setMinutes(a.getMinutes()+W),a.toISOString()},[_,W]),ac=(0,c.useCallback)(()=>{u(null),w(null),z(""),B("service_call"),T("normal"),V(""),X(60),Z(""),aa($()),s(null)},[]),ad=a=>{a||ac(),d(a)},ae=async a=>{(a.preventDefault(),s(null),v)?y.trim()?q(async()=>{try{let a=new FormData;if(a.set("customerId",v),a.set("title",y.trim()),a.set("scheduledStart",new Date(_).toISOString()),a.set("scheduledEnd",ab()),a.set("type",A),a.set("priority",S),a.set("category","job_appointment"),U&&"unassigned"!==U&&a.set("assignedTo",U),Y.trim()&&a.set("notes",Y.trim()),f?.address){let b=Y.trim(),c=`Location: ${f.address}`;a.set("notes",b?`${b}

${c}`:c)}let b=await (0,G.createAppointment)(a);b.success&&b.data?(i?.(b.data),ad(!1)):s(b.error||"Failed to create appointment")}catch(a){console.error("Failed to create appointment:",a),s("An unexpected error occurred")}}):s("Please enter a title"):s("Please select a customer")};return(0,b.jsx)(J.Dialog,{open:a,onOpenChange:ad,children:(0,b.jsxs)(J.DialogContent,{className:"sm:max-w-[500px]",children:[(0,b.jsxs)(J.DialogHeader,{children:[(0,b.jsxs)(J.DialogTitle,{className:"flex items-center gap-2",children:[(0,b.jsx)(D.Calendar,{className:"h-5 w-5 text-primary"}),"Quick Appointment"]}),(0,b.jsx)(J.DialogDescription,{children:f?.address?(0,b.jsxs)("span",{className:"flex items-center gap-1 text-sm",children:[(0,b.jsx)(o.MapPin,{className:"h-3.5 w-3.5"}),f.address]}):"Create a new appointment from the dispatch map"})]}),(0,b.jsxs)("form",{onSubmit:ae,className:"space-y-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(L.Label,{htmlFor:"customer",children:"Customer *"}),(0,b.jsx)(H.CustomerAutocomplete,{value:v,onChange:(a,b)=>{if(w(a),u(b),b&&!y){let a=b.display_name||`${b.first_name||""} ${b.last_name||""}`.trim()||b.company_name||"Customer";z(`Service call - ${a}`)}},placeholder:"Search or select customer...",showCreateNew:!0,onCreateNew:j,showRecent:!0,recentCustomers:h,error:r?.includes("customer")})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(L.Label,{htmlFor:"title",children:"Title *"}),(0,b.jsx)(K.Input,{id:"title",value:y,onChange:a=>z(a.target.value),placeholder:"e.g., AC Repair, Plumbing Inspection",className:(0,O.cn)(r?.includes("title")&&"border-destructive")})]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(L.Label,{htmlFor:"jobType",children:"Job Type"}),(0,b.jsxs)(M.Select,{value:A,onValueChange:B,children:[(0,b.jsx)(M.SelectTrigger,{id:"jobType",children:(0,b.jsx)(M.SelectValue,{})}),(0,b.jsx)(M.SelectContent,{children:P.map(a=>(0,b.jsx)(M.SelectItem,{value:a.value,children:(0,b.jsxs)("span",{className:(0,O.cn)("flex items-center gap-2",a.color),children:[(0,b.jsx)(F.Wrench,{className:"h-3.5 w-3.5"}),a.label]})},a.value))})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(L.Label,{htmlFor:"priority",children:"Priority"}),(0,b.jsxs)(M.Select,{value:S,onValueChange:T,children:[(0,b.jsx)(M.SelectTrigger,{id:"priority",children:(0,b.jsx)(M.SelectValue,{})}),(0,b.jsx)(M.SelectContent,{children:Q.map(a=>(0,b.jsx)(M.SelectItem,{value:a.value,children:(0,b.jsxs)("span",{className:(0,O.cn)("flex items-center gap-2",a.color),children:["urgent"===a.value&&(0,b.jsx)(e.AlertTriangle,{className:"h-3.5 w-3.5"}),a.label]})},a.value))})]})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(L.Label,{htmlFor:"scheduledStart",children:"Date & Time"}),(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)(l.Clock,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),(0,b.jsx)(K.Input,{id:"scheduledStart",type:"datetime-local",value:_,onChange:a=>aa(a.target.value),className:"pl-9"})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(L.Label,{htmlFor:"duration",children:"Duration"}),(0,b.jsxs)(M.Select,{value:W.toString(),onValueChange:a=>X(Number(a)),children:[(0,b.jsx)(M.SelectTrigger,{id:"duration",children:(0,b.jsx)(M.SelectValue,{})}),(0,b.jsx)(M.SelectContent,{children:R.map(a=>(0,b.jsx)(M.SelectItem,{value:a.value.toString(),children:a.label},a.value))})]})]})]}),g.length>0&&(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(L.Label,{htmlFor:"technician",children:"Assign Technician"}),(0,b.jsxs)(M.Select,{value:U,onValueChange:V,children:[(0,b.jsx)(M.SelectTrigger,{id:"technician",children:(0,b.jsx)(M.SelectValue,{placeholder:"Select technician (optional)"})}),(0,b.jsxs)(M.SelectContent,{children:[(0,b.jsx)(M.SelectItem,{value:"unassigned",children:"Unassigned"}),g.map(a=>(0,b.jsx)(M.SelectItem,{value:a.id,children:(0,b.jsxs)("span",{className:"flex items-center gap-2",children:[(0,b.jsx)(x.User,{className:"h-3.5 w-3.5"}),a.name]})},a.id))]})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(L.Label,{htmlFor:"notes",children:"Notes"}),(0,b.jsx)(N.Textarea,{id:"notes",value:Y,onChange:a=>Z(a.target.value),placeholder:"Additional notes or instructions...",rows:2})]}),r&&(0,b.jsx)("div",{className:"rounded-md bg-destructive/10 p-3 text-sm text-destructive",children:r}),(0,b.jsxs)(J.DialogFooter,{children:[(0,b.jsx)(I.Button,{type:"button",variant:"outline",onClick:()=>ad(!1),disabled:p,children:"Cancel"}),(0,b.jsx)(I.Button,{type:"submit",disabled:p||!v,children:p?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(E.Loader2,{className:"mr-2 h-4 w-4 animate-spin"}),"Creating..."]}):"Create Appointment"})]})]})]})})}a.i(516775);var T=a.i(560272);a.i(288007);var U=a.i(986990);a.i(380934);var V=a.i(347421);a.i(413309);var W=a.i(54210);a.i(928414);var X=a.i(745250),Y=a.i(562991);let Z="Thorbis-FMS/1.0 (support@thorbis.app)",$=Y.z.object({lat:Y.z.number(),lng:Y.z.number()}),_=Y.z.object({distance:Y.z.number(),duration:Y.z.number(),durationInTraffic:Y.z.number(),from:$,to:$,polyline:Y.z.string().optional(),summary:Y.z.string().optional(),warnings:Y.z.array(Y.z.string()).optional(),trafficDelay:Y.z.number()}),aa=Y.z.object({originIndex:Y.z.number(),destinationIndex:Y.z.number(),distance:Y.z.number(),duration:Y.z.number(),durationInTraffic:Y.z.number(),status:Y.z.enum(["OK","NOT_FOUND","ZERO_RESULTS"])}),ab=Y.z.object({elements:Y.z.array(aa),originAddresses:Y.z.array(Y.z.string()).optional(),destinationAddresses:Y.z.array(Y.z.string()).optional()}),ac=Y.z.object({totalDistance:Y.z.number(),totalDuration:Y.z.number(),totalDurationInTraffic:Y.z.number(),optimizedOrder:Y.z.array(Y.z.number()),legs:Y.z.array(Y.z.object({from:$,to:$,distance:Y.z.number(),duration:Y.z.number(),durationInTraffic:Y.z.number(),polyline:Y.z.string().optional()})),polyline:Y.z.string().optional()});class ad{apiKey;routeCache=new Map;matrixCache=new Map;constructor(){this.apiKey=process.env.GOOGLE_API_KEY||"AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0"}isAvailable(){return!!this.apiKey}async getRoute(a,b){if(!this.apiKey)return console.warn("Google Routes Service: No API key configured"),this.getFallbackRoute(a,b);let c=`route:${a.lat.toFixed(5)},${a.lng.toFixed(5)}-${b.lat.toFixed(5)},${b.lng.toFixed(5)}`,d=this.routeCache.get(c);if(d&&Date.now()-d.timestamp<3e5)return d.data;try{let d=new URL("https://maps.googleapis.com/maps/api/directions/json");d.searchParams.set("origin",`${a.lat},${a.lng}`),d.searchParams.set("destination",`${b.lat},${b.lng}`),d.searchParams.set("departure_time","now"),d.searchParams.set("traffic_model","best_guess"),d.searchParams.set("key",this.apiKey);let e=await fetch(d.toString(),{headers:{"User-Agent":Z}});if(!e.ok)return console.error(`Google Routes API error: ${e.status} ${e.statusText}`),this.getFallbackRoute(a,b);let f=await e.json();if("OK"!==f.status||!f.routes?.[0])return console.warn(`Google Routes API returned status: ${f.status}`),this.getFallbackRoute(a,b);let g=f.routes[0],h=g.legs[0],i=h.duration?.value||0,j=h.duration_in_traffic?.value||i,k={distance:h.distance?.value||0,duration:i,durationInTraffic:j,from:a,to:b,polyline:g.overview_polyline?.points,summary:g.summary,warnings:g.warnings||[],trafficDelay:Math.max(0,j-i)},l=_.parse(k);return this.routeCache.set(c,{data:l,timestamp:Date.now()}),this.cleanCache(this.routeCache,3e5),l}catch(c){return console.error("Google Routes Service error:",c),this.getFallbackRoute(a,b)}}async getRouteMatrix(a,b){if(!this.apiKey)return console.warn("Google Routes Service: No API key configured for matrix"),null;if(0===a.length||0===b.length)return null;let c=a.slice(0,25),d=b.slice(0,25),e=`matrix:${c.map(a=>`${a.lat.toFixed(4)},${a.lng.toFixed(4)}`).join("|")}-${d.map(a=>`${a.lat.toFixed(4)},${a.lng.toFixed(4)}`).join("|")}`,f=this.matrixCache.get(e);if(f&&Date.now()-f.timestamp<6e5)return f.data;try{let a=new URL("https://maps.googleapis.com/maps/api/distancematrix/json");a.searchParams.set("origins",c.map(a=>`${a.lat},${a.lng}`).join("|")),a.searchParams.set("destinations",d.map(a=>`${a.lat},${a.lng}`).join("|")),a.searchParams.set("departure_time","now"),a.searchParams.set("traffic_model","best_guess"),a.searchParams.set("key",this.apiKey);let b=await fetch(a.toString(),{headers:{"User-Agent":Z}});if(!b.ok)return console.error(`Google Distance Matrix API error: ${b.status} ${b.statusText}`),null;let f=await b.json();if("OK"!==f.status)return console.warn(`Google Distance Matrix API status: ${f.status}`),null;let g=[];for(let a=0;a<f.rows.length;a++)for(let b=0;b<f.rows[a].elements.length;b++){let c=f.rows[a].elements[b],d=c.duration?.value||0,e=c.duration_in_traffic?.value||d;g.push({originIndex:a,destinationIndex:b,distance:c.distance?.value||0,duration:d,durationInTraffic:e,status:"OK"===c.status?"OK":"ZERO_RESULTS"===c.status?"ZERO_RESULTS":"NOT_FOUND"})}let h={elements:g,originAddresses:f.origin_addresses,destinationAddresses:f.destination_addresses},i=ab.parse(h);return this.matrixCache.set(e,{data:i,timestamp:Date.now()}),this.cleanCache(this.matrixCache,6e5),i}catch(a){return console.error("Google Distance Matrix error:",a),null}}async getETA(a,b){let c=await this.getRoute(a,b);if(!c)return null;let d=new Date(new Date().getTime()+1e3*c.durationInTraffic),e=Math.ceil(c.durationInTraffic/60),f=Math.ceil(c.trafficDelay/60);return{eta:d,durationMinutes:e,durationText:this.formatDuration(c.durationInTraffic),trafficDelayMinutes:f}}async rankTechniciansByETA(a,b){if(0===a.length)return[];let c=a.map(a=>a.location),d=await this.getRouteMatrix(c,[b]);return d?a.map((a,b)=>{let c=d.elements.find(a=>a.originIndex===b&&0===a.destinationIndex);return c&&"OK"===c.status?{id:a.id,name:a.name,etaMinutes:Math.ceil(c.durationInTraffic/60),distanceKm:c.distance/1e3,trafficDelayMinutes:Math.ceil((c.durationInTraffic-c.duration)/60)}:{id:a.id,name:a.name,etaMinutes:1/0,distanceKm:0,trafficDelayMinutes:0}}).sort((a,b)=>a.etaMinutes-b.etaMinutes):(await Promise.all(a.map(async a=>{let c=await this.getRoute(a.location,b);return{id:a.id,name:a.name,etaMinutes:c?Math.ceil(c.durationInTraffic/60):1/0,distanceKm:c?c.distance/1e3:0,trafficDelayMinutes:c?Math.ceil(c.trafficDelay/60):0}}))).sort((a,b)=>a.etaMinutes-b.etaMinutes)}async getMultiStopRoute(a,b,c=!1){if(0===b.length)return null;if(1===b.length){let c=await this.getRoute(a,b[0]);return c?{totalDistance:c.distance,totalDuration:c.duration,totalDurationInTraffic:c.durationInTraffic,optimizedOrder:[0],legs:[{from:a,to:b[0],distance:c.distance,duration:c.duration,durationInTraffic:c.durationInTraffic,polyline:c.polyline}],polyline:c.polyline}:null}let d=[a,...b],e=await this.getRouteMatrix(d,d);if(!e)return this.getSequentialRoute(a,b,c);let f=new Set,g=[],h=0;for(;g.length<b.length;){let a=-1,c=1/0;for(let d=1;d<=b.length;d++){if(f.has(d))continue;let b=e.elements.find(a=>a.originIndex===h&&a.destinationIndex===d);b&&"OK"===b.status&&b.durationInTraffic<c&&(c=b.durationInTraffic,a=d)}if(-1===a)break;f.add(a),g.push(a-1),h=a}let i=[],j=0,k=0,l=0,m=a;for(let a of g){let c=b[a],d=await this.getRoute(m,c);d&&(i.push({from:m,to:c,distance:d.distance,duration:d.duration,durationInTraffic:d.durationInTraffic,polyline:d.polyline}),j+=d.distance,k+=d.duration,l+=d.durationInTraffic),m=c}if(c&&i.length>0){let b=await this.getRoute(m,a);b&&(i.push({from:m,to:a,distance:b.distance,duration:b.duration,durationInTraffic:b.durationInTraffic,polyline:b.polyline}),j+=b.distance,k+=b.duration,l+=b.durationInTraffic)}return ac.parse({totalDistance:j,totalDuration:k,totalDurationInTraffic:l,optimizedOrder:g,legs:i})}async getSequentialRoute(a,b,c){let d=[],e=0,f=0,g=0,h=a;for(let a=0;a<b.length;a++){let c=await this.getRoute(h,b[a]);c&&(d.push({from:h,to:b[a],distance:c.distance,duration:c.duration,durationInTraffic:c.durationInTraffic,polyline:c.polyline}),e+=c.distance,f+=c.duration,g+=c.durationInTraffic),h=b[a]}if(c){let b=await this.getRoute(h,a);b&&(d.push({from:h,to:a,distance:b.distance,duration:b.duration,durationInTraffic:b.durationInTraffic,polyline:b.polyline}),e+=b.distance,f+=b.duration,g+=b.durationInTraffic)}return{totalDistance:e,totalDuration:f,totalDurationInTraffic:g,optimizedOrder:b.map((a,b)=>b),legs:d}}getFallbackRoute(a,b){let c=this.calculateHaversineDistance(a,b),d=Math.round(c/4e4*3600);return{distance:Math.round(c),duration:d,durationInTraffic:d,from:a,to:b,trafficDelay:0,warnings:["Using estimated route - Google API unavailable"]}}calculateHaversineDistance(a,b){let c=a.lat*Math.PI/180,d=b.lat*Math.PI/180,e=(b.lat-a.lat)*Math.PI/180,f=(b.lng-a.lng)*Math.PI/180,g=Math.sin(e/2)*Math.sin(e/2)+Math.cos(c)*Math.cos(d)*Math.sin(f/2)*Math.sin(f/2);return 2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g))*6371e3}formatDuration(a){if(a<60)return`${Math.round(a)} sec`;if(a<3600)return`${Math.round(a/60)} min`;let b=Math.floor(a/3600),c=Math.round(a%3600/60);return`${b}h ${c}min`}formatDistance(a){return a<1e3?`${Math.round(a)} m`:`${(a/1e3*.621371).toFixed(1)} mi`}cleanCache(a,b){let c=Date.now();for(let[d,e]of a.entries())c-e.timestamp>2*b&&a.delete(d);if(a.size>500){let b=Array.from(a.entries());for(let[c,d]of(b.sort((a,b)=>b[1].timestamp-a[1].timestamp),a.clear(),b.slice(0,250)))a.set(c,d)}}clearCache(){this.routeCache.clear(),this.matrixCache.clear()}}let ae=new ad,af="Thorbis-FMS/1.0 (support@thorbis.app)",ag=Y.z.object({code:Y.z.string(),description:Y.z.string(),icon:Y.z.string()}),ah=Y.z.object({temperature:Y.z.number(),temperatureFeelsLike:Y.z.number(),humidity:Y.z.number(),pressure:Y.z.number(),windSpeed:Y.z.number(),windDirection:Y.z.number(),windGust:Y.z.number().optional(),visibility:Y.z.number().optional(),uvIndex:Y.z.number().optional(),cloudCover:Y.z.number().optional(),precipitation:Y.z.number().optional(),condition:ag,observationTime:Y.z.string()}),ai=Y.z.object({time:Y.z.string(),temperature:Y.z.number(),temperatureFeelsLike:Y.z.number(),humidity:Y.z.number(),windSpeed:Y.z.number(),windDirection:Y.z.number(),precipitationProbability:Y.z.number(),precipitationAmount:Y.z.number().optional(),condition:ag,uvIndex:Y.z.number().optional(),solarRadiation:Y.z.number().optional()}),aj=Y.z.object({date:Y.z.string(),temperatureHigh:Y.z.number(),temperatureLow:Y.z.number(),humidity:Y.z.number(),windSpeed:Y.z.number(),windDirection:Y.z.number(),precipitationProbability:Y.z.number(),precipitationAmount:Y.z.number().optional(),condition:ag,uvIndexMax:Y.z.number().optional(),sunrise:Y.z.string().optional(),sunset:Y.z.string().optional(),moonPhase:Y.z.string().optional(),solarRadiation:Y.z.number().optional()}),ak=Y.z.object({event:Y.z.string(),headline:Y.z.string(),description:Y.z.string(),severity:Y.z.enum(["Extreme","Severe","Moderate","Minor","Unknown"]),urgency:Y.z.enum(["Immediate","Expected","Future","Past","Unknown"]),start:Y.z.string().optional(),end:Y.z.string().optional(),instruction:Y.z.string().optional(),source:Y.z.string().optional()});Y.z.object({location:Y.z.object({lat:Y.z.number(),lng:Y.z.number(),name:Y.z.string().optional(),timezone:Y.z.string().optional()}),current:ah.optional(),hourly:Y.z.array(ai).optional(),daily:Y.z.array(aj).optional(),alerts:Y.z.array(ak),source:Y.z.enum(["google","nws","openmeteo"]),enrichedAt:Y.z.string()});class al{apiKey;cache=new Map;constructor(){this.apiKey=process.env.GOOGLE_API_KEY||"AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0"}isAvailable(){return!!this.apiKey}async getWeatherData(a,b){let c=`weather:${a.toFixed(4)},${b.toFixed(4)}`,d=this.cache.get(c);if(d&&Date.now()-d.timestamp<18e5)return d.data;try{let d=await this.fetchFromOpenMeteo(a,b);if(d)return this.cache.set(c,{data:d,timestamp:Date.now()}),this.cleanCache(),d;if(this.isUSLocation(a,b)){let d=await this.fetchFromNWS(a,b);if(d)return this.cache.set(c,{data:d,timestamp:Date.now()}),d}return null}catch(a){return console.error("Weather service error:",a),null}}async fetchFromOpenMeteo(a,b){try{let c=new URL("https://api.open-meteo.com/v1/forecast");c.searchParams.set("latitude",a.toString()),c.searchParams.set("longitude",b.toString()),c.searchParams.set("current","temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,cloud_cover,pressure_msl,wind_speed_10m,wind_direction_10m,wind_gusts_10m,uv_index"),c.searchParams.set("hourly","temperature_2m,relative_humidity_2m,apparent_temperature,precipitation_probability,precipitation,weather_code,wind_speed_10m,wind_direction_10m,uv_index,direct_radiation"),c.searchParams.set("daily","weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,wind_speed_10m_max,wind_direction_10m_dominant,uv_index_max,sunrise,sunset"),c.searchParams.set("timezone","auto"),c.searchParams.set("forecast_days","10");let d=await fetch(c.toString(),{headers:{"User-Agent":af}});if(!d.ok)return console.error(`Open-Meteo API error: ${d.status}`),null;let e=await d.json(),f={temperature:e.current.temperature_2m,temperatureFeelsLike:e.current.apparent_temperature,humidity:e.current.relative_humidity_2m,pressure:e.current.pressure_msl,windSpeed:e.current.wind_speed_10m/3.6,windDirection:e.current.wind_direction_10m,windGust:e.current.wind_gusts_10m?e.current.wind_gusts_10m/3.6:void 0,uvIndex:e.current.uv_index,cloudCover:e.current.cloud_cover,precipitation:e.current.precipitation,condition:this.getConditionFromCode(e.current.weather_code),observationTime:e.current.time},g=[],h=Math.min(48,e.hourly.time.length);for(let a=0;a<h;a++)g.push({time:e.hourly.time[a],temperature:e.hourly.temperature_2m[a],temperatureFeelsLike:e.hourly.apparent_temperature[a],humidity:e.hourly.relative_humidity_2m[a],windSpeed:e.hourly.wind_speed_10m[a]/3.6,windDirection:e.hourly.wind_direction_10m[a],precipitationProbability:e.hourly.precipitation_probability[a],precipitationAmount:e.hourly.precipitation[a],condition:this.getConditionFromCode(e.hourly.weather_code[a]),uvIndex:e.hourly.uv_index[a],solarRadiation:e.hourly.direct_radiation?.[a]});let i=[];for(let a=0;a<e.daily.time.length;a++)i.push({date:e.daily.time[a],temperatureHigh:e.daily.temperature_2m_max[a],temperatureLow:e.daily.temperature_2m_min[a],humidity:0,windSpeed:e.daily.wind_speed_10m_max[a]/3.6,windDirection:e.daily.wind_direction_10m_dominant[a],precipitationProbability:e.daily.precipitation_probability_max[a],precipitationAmount:e.daily.precipitation_sum[a],condition:this.getConditionFromCode(e.daily.weather_code[a]),uvIndexMax:e.daily.uv_index_max[a],sunrise:e.daily.sunrise[a],sunset:e.daily.sunset[a]});return{location:{lat:a,lng:b,timezone:e.timezone},current:f,hourly:g,daily:i,alerts:[],source:"openmeteo",enrichedAt:new Date().toISOString()}}catch(a){return console.error("Open-Meteo fetch error:",a),null}}async fetchFromNWS(a,b){try{let c=await fetch(`https://api.weather.gov/points/${a.toFixed(4)},${b.toFixed(4)}`,{headers:{"User-Agent":af,Accept:"application/geo+json"}});if(!c.ok)return null;let d=(await c.json()).properties,[e,f]=await Promise.all([fetch(d.forecast,{headers:{"User-Agent":af,Accept:"application/geo+json"}}),fetch(`https://api.weather.gov/alerts/active?point=${a},${b}`,{headers:{"User-Agent":af,Accept:"application/geo+json"}})]),g=e.ok?await e.json():null,h=f.ok?await f.json():null,i=(h?.features||[]).map(a=>({event:a.properties.event||"Unknown",headline:a.properties.headline||"",description:a.properties.description||"",severity:this.mapNWSSeverity(a.properties.severity),urgency:this.mapNWSUrgency(a.properties.urgency),start:a.properties.onset,end:a.properties.expires,instruction:a.properties.instruction,source:"NWS"})),j=[];if(g?.properties?.periods){let a=g.properties.periods;for(let b=0;b<a.length;b+=2){let c=a[b],d=a[b+1];j.push({date:c.startTime.split("T")[0],temperatureHigh:c.isDaytime?c.temperature:d?.temperature||c.temperature,temperatureLow:d?.temperature||c.temperature,humidity:0,windSpeed:this.parseWindSpeed(c.windSpeed),windDirection:this.parseWindDirection(c.windDirection),precipitationProbability:0,condition:this.mapNWSCondition(c.shortForecast),uvIndexMax:void 0})}}return{location:{lat:a,lng:b,name:d.relativeLocation?.properties?.city,timezone:d.timeZone},daily:j,alerts:i,source:"nws",enrichedAt:new Date().toISOString()}}catch(a){return console.error("NWS fetch error:",a),null}}getConditionFromCode(a){return({0:{code:"CLEAR",description:"Clear sky",icon:"01d"},1:{code:"MOSTLY_CLEAR",description:"Mostly clear",icon:"02d"},2:{code:"PARTLY_CLOUDY",description:"Partly cloudy",icon:"03d"},3:{code:"OVERCAST",description:"Overcast",icon:"04d"},45:{code:"FOG",description:"Foggy",icon:"50d"},48:{code:"FOG",description:"Freezing fog",icon:"50d"},51:{code:"DRIZZLE",description:"Light drizzle",icon:"09d"},53:{code:"DRIZZLE",description:"Moderate drizzle",icon:"09d"},55:{code:"DRIZZLE",description:"Dense drizzle",icon:"09d"},56:{code:"FREEZING_DRIZZLE",description:"Freezing drizzle",icon:"09d"},57:{code:"FREEZING_DRIZZLE",description:"Dense freezing drizzle",icon:"09d"},61:{code:"RAIN",description:"Light rain",icon:"10d"},63:{code:"RAIN",description:"Moderate rain",icon:"10d"},65:{code:"RAIN",description:"Heavy rain",icon:"10d"},66:{code:"FREEZING_RAIN",description:"Freezing rain",icon:"13d"},67:{code:"FREEZING_RAIN",description:"Heavy freezing rain",icon:"13d"},71:{code:"SNOW",description:"Light snow",icon:"13d"},73:{code:"SNOW",description:"Moderate snow",icon:"13d"},75:{code:"SNOW",description:"Heavy snow",icon:"13d"},77:{code:"SNOW_GRAINS",description:"Snow grains",icon:"13d"},80:{code:"RAIN_SHOWERS",description:"Light rain showers",icon:"09d"},81:{code:"RAIN_SHOWERS",description:"Moderate rain showers",icon:"09d"},82:{code:"RAIN_SHOWERS",description:"Heavy rain showers",icon:"09d"},85:{code:"SNOW_SHOWERS",description:"Light snow showers",icon:"13d"},86:{code:"SNOW_SHOWERS",description:"Heavy snow showers",icon:"13d"},95:{code:"THUNDERSTORM",description:"Thunderstorm",icon:"11d"},96:{code:"THUNDERSTORM",description:"Thunderstorm with hail",icon:"11d"},99:{code:"THUNDERSTORM",description:"Severe thunderstorm",icon:"11d"}})[a]||{code:"UNKNOWN",description:"Unknown",icon:"03d"}}mapNWSCondition(a){let b=a.toLowerCase();return b.includes("thunder")?{code:"THUNDERSTORM",description:a,icon:"11d"}:b.includes("snow")?{code:"SNOW",description:a,icon:"13d"}:b.includes("rain")||b.includes("showers")?{code:"RAIN",description:a,icon:"10d"}:b.includes("cloudy")||b.includes("overcast")?{code:"CLOUDY",description:a,icon:"04d"}:b.includes("partly")?{code:"PARTLY_CLOUDY",description:a,icon:"03d"}:b.includes("clear")||b.includes("sunny")?{code:"CLEAR",description:a,icon:"01d"}:{code:"UNKNOWN",description:a,icon:"03d"}}mapNWSSeverity(a){switch(a?.toLowerCase()){case"extreme":return"Extreme";case"severe":return"Severe";case"moderate":return"Moderate";case"minor":return"Minor";default:return"Unknown"}}mapNWSUrgency(a){switch(a?.toLowerCase()){case"immediate":return"Immediate";case"expected":return"Expected";case"future":return"Future";case"past":return"Past";default:return"Unknown"}}parseWindSpeed(a){let b=a.match(/(\d+)\s*(?:to\s*(\d+))?\s*mph/i);if(b){let a=parseInt(b[1]),c=b[2]?parseInt(b[2]):a;return(a+c)/2*.44704}return 0}parseWindDirection(a){return({N:0,NNE:22.5,NE:45,ENE:67.5,E:90,ESE:112.5,SE:135,SSE:157.5,S:180,SSW:202.5,SW:225,WSW:247.5,W:270,WNW:292.5,NW:315,NNW:337.5})[a.toUpperCase()]||0}isUSLocation(a,b){return a>=24.5&&a<=49.5&&b>=-125&&b<=-66.9||a>=51&&a<=71.5&&b>=-180&&b<=-130||a>=18.5&&a<=22.5&&b>=-161&&b<=-154}isSuitableForOutdoorWork(a){let b=a.alerts.filter(a=>"Extreme"===a.severity||"Severe"===a.severity);if(b.length>0)return{suitable:!1,reason:b[0].headline||b[0].event,severity:"high"};if(a.current){let{condition:b,temperature:c,windSpeed:d}=a.current;if("THUNDERSTORM"===b.code||b.code.includes("FREEZING"))return{suitable:!1,reason:b.description,severity:"high"};if(c<-10)return{suitable:!1,reason:"Extreme cold (-10°C or below)",severity:"high"};if(c>40)return{suitable:!1,reason:"Extreme heat (40°C or above)",severity:"high"};if(d>20)return{suitable:!1,reason:"High winds",severity:"medium"};if("RAIN"===b.code||"SNOW"===b.code)return{suitable:!0,reason:b.description,severity:"medium"};if(c<0||c>35)return{suitable:!0,reason:`Temperature: ${Math.round(c)}\xb0C`,severity:"low"}}return{suitable:!0,severity:"none"}}getWeatherSummary(a){let b=a.current,c=this.isSuitableForOutdoorWork(a);return{temperature:b?`${Math.round(b.temperature)}\xb0C / ${Math.round(1.8*b.temperature+32)}\xb0F`:"N/A",condition:b?.condition.description||"Unknown",icon:b?.condition.icon||"03d",feelsLike:b?`${Math.round(b.temperatureFeelsLike)}\xb0C`:"N/A",humidity:b?`${Math.round(b.humidity)}%`:"N/A",wind:b?`${Math.round(2.237*b.windSpeed)} mph`:"N/A",alerts:a.alerts.length,suitableForWork:c.suitable}}cleanCache(){let a=Date.now();for(let[b,c]of this.cache.entries())a-c.timestamp>36e5&&this.cache.delete(b);if(this.cache.size>100){let a=Array.from(this.cache.entries());for(let[b,c]of(a.sort((a,b)=>b[1].timestamp-a[1].timestamp),this.cache.clear(),a.slice(0,50)))this.cache.set(b,c)}}clearCache(){this.cache.clear()}}let am=new al;var an=a.i(132440);function ao(a){return Math.PI/180*a}async function ap(a){return"undefined"!=typeof google&&google.maps?new Promise(b=>{new google.maps.Geocoder().geocode({location:{lat:a.lat,lng:a.lng}},(a,c)=>{c===google.maps.GeocoderStatus.OK&&a?.[0]?b(a[0].formatted_address):b(null)})}):null}class aq extends c.Component{constructor(a){super(a),this.state={hasError:!1,error:null}}static getDerivedStateFromError(a){return{hasError:!0,error:a}}componentDidCatch(a,b){console.error("Map error caught:",a,b)}render(){return this.state.hasError?this.props.fallback||(0,b.jsx)("div",{className:"flex h-full w-full items-center justify-center bg-muted",children:(0,b.jsxs)("div",{className:"text-center max-w-md p-6",children:[(0,b.jsx)("div",{className:"mx-auto h-12 w-12 text-amber-500 mb-4",children:"⚠️"}),(0,b.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Map Error"}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground mb-4",children:this.state.error?.message||"An error occurred while loading the map."}),(0,b.jsx)("button",{onClick:()=>this.setState({hasError:!1,error:null}),className:"px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm",children:"Try Again"})]})}):this.props.children}}let ar=!1,as=!1,at=[],au={available:{bg:"bg-emerald-500",text:"text-emerald-500",border:"border-emerald-500"},active:{bg:"bg-emerald-500",text:"text-emerald-500",border:"border-emerald-500"},"on-job":{bg:"bg-blue-500",text:"text-blue-500",border:"border-blue-500"},"in-transit":{bg:"bg-amber-500",text:"text-amber-500",border:"border-amber-500"},"on-break":{bg:"bg-orange-500",text:"text-orange-500",border:"border-orange-500"},offline:{bg:"bg-gray-400",text:"text-gray-400",border:"border-gray-400"},inactive:{bg:"bg-gray-400",text:"text-gray-400",border:"border-gray-400"}},av={pending:"#f59e0b",scheduled:"#3b82f6",dispatched:"#8b5cf6","in-progress":"#10b981",completed:"#6b7280",cancelled:"#ef4444"},aw={emergency:{bg:"bg-red-500/20",text:"text-red-500"},high:{bg:"bg-orange-500/20",text:"text-orange-500"},normal:{bg:"bg-blue-500/20",text:"text-blue-500"},low:{bg:"bg-gray-500/20",text:"text-gray-500"}};function ax(a){return a?a.split(" ").map(a=>a[0]).join("").toUpperCase().slice(0,2):"??"}function ay(a){let b=a.property,c=a.customer;return b?.address?`${b.address}, ${b.city||""} ${b.state||""}`.trim():c?.address?`${c.address}, ${c.city||""} ${c.state||""}`.trim():"No address"}function az(a){return a.property?.lat&&a.property?.lon?{lat:a.property.lat,lng:a.property.lon}:a.customer?.lat&&a.customer?.lon?{lat:a.customer.lat,lng:a.customer.lon}:null}function aA({tech:a,isSelected:c,onClick:d}){let e=au[a.status]||au.offline,i=!!a.gpsLocation,j=a.gpsLocation?.battery_level;return(0,b.jsxs)("div",{className:(0,O.cn)("flex items-center gap-3 p-3 cursor-pointer transition-all","hover:bg-accent/50 border-b border-border/50",c&&"bg-accent"),onClick:d,children:[(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsxs)(T.Avatar,{className:"h-10 w-10",children:[(0,b.jsx)(T.AvatarImage,{src:a.avatar||void 0}),(0,b.jsx)(T.AvatarFallback,{className:"bg-muted text-sm",children:ax(a.name)})]}),(0,b.jsx)("div",{className:(0,O.cn)("absolute -bottom-0.5 -right-0.5 h-3.5 w-3.5 rounded-full border-2 border-background",e.bg)})]}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("span",{className:"font-medium text-sm truncate",children:a.name}),i&&(0,b.jsx)(v.Signal,{className:"h-3 w-3 text-emerald-500 flex-shrink-0"})]}),(0,b.jsx)("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:a.currentJob?(0,b.jsx)("span",{className:"truncate",children:a.currentJob.title}):a.nextJob?(0,b.jsxs)("span",{className:"truncate",children:["Next: ",a.nextJob.title]}):(0,b.jsx)("span",{children:"No jobs scheduled"})}),a.etaToNextJob&&a.nextJob&&(0,b.jsxs)("div",{className:"flex items-center gap-1 text-xs text-blue-500 mt-0.5",children:[(0,b.jsx)(p.Navigation,{className:"h-3 w-3"}),(0,b.jsxs)("span",{children:[a.etaToNextJob.durationMinutes," min (",a.etaToNextJob.distanceKm.toFixed(1)," km)"]})]})]}),(0,b.jsxs)("div",{className:"flex flex-col items-end gap-1",children:[(0,b.jsx)(U.Badge,{variant:"outline",className:(0,O.cn)("text-[10px] px-1.5 py-0",e.border,e.text),children:"on-job"===a.status?"On Job":a.status}),null!=j&&(0,b.jsxs)("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[j<20?(0,b.jsx)(g.BatteryLow,{className:"h-3 w-3 text-red-500"}):j<50?(0,b.jsx)(h.default,{className:"h-3 w-3 text-amber-500"}):(0,b.jsx)(f.Battery,{className:"h-3 w-3 text-emerald-500"}),(0,b.jsxs)("span",{children:[Math.round(j),"%"]})]})]})]})}function aB({tech:a,onClose:c,onNavigate:d}){if(!a)return null;let e=au[a.status]||au.offline;return(0,b.jsx)("div",{className:"absolute bottom-0 left-0 right-0 z-20 bg-background border-t shadow-lg animate-in slide-in-from-bottom duration-300",children:(0,b.jsxs)("div",{className:"max-w-4xl mx-auto p-4",children:[(0,b.jsxs)("div",{className:"flex items-start justify-between mb-4",children:[(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsxs)(T.Avatar,{className:"h-14 w-14",children:[(0,b.jsx)(T.AvatarImage,{src:a.avatar||void 0}),(0,b.jsx)(T.AvatarFallback,{className:"text-lg",children:ax(a.name)})]}),(0,b.jsx)("div",{className:(0,O.cn)("absolute -bottom-1 -right-1 h-4 w-4 rounded-full border-2 border-background",e.bg)})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h3",{className:"text-lg font-semibold",children:a.name}),(0,b.jsxs)("div",{className:"flex items-center gap-3 text-sm text-muted-foreground",children:[(0,b.jsx)("span",{className:"capitalize",children:a.role?.replace(/_/g," ")}),a.gpsLocation&&(0,b.jsxs)("span",{className:"flex items-center gap-1",children:[(0,b.jsx)(v.Signal,{className:"h-3 w-3 text-emerald-500"}),function(a){let b=new Date,c="string"==typeof a?new Date(a):a,d=Math.floor((b.getTime()-c.getTime())/6e4);if(d<1)return"Just now";if(1===d)return"1 min ago";if(d<60)return`${d} mins ago`;let e=Math.floor(d/60);return 1===e?"1 hour ago":e<24?`${e} hours ago`:"Over a day ago"}(a.gpsLocation.updated_at)]})]})]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsxs)(I.Button,{variant:"outline",size:"sm",onClick:d,children:[(0,b.jsx)(x.User,{className:"h-4 w-4 mr-2"}),"View Schedule"]}),a.phone&&(0,b.jsx)(I.Button,{variant:"outline",size:"sm",asChild:!0,children:(0,b.jsxs)("a",{href:`tel:${a.phone}`,children:[(0,b.jsx)(q.Phone,{className:"h-4 w-4 mr-2"}),"Call"]})}),(0,b.jsx)(I.Button,{variant:"ghost",size:"icon",onClick:c,children:(0,b.jsx)(z.X,{className:"h-4 w-4"})})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,b.jsx)(V.Card,{className:"bg-muted/30",children:(0,b.jsxs)(V.CardContent,{className:"p-4",children:[(0,b.jsx)("div",{className:"text-sm text-muted-foreground mb-1",children:"Today's Jobs"}),(0,b.jsx)("div",{className:"text-2xl font-bold",children:a.appointments.length}),(0,b.jsxs)("div",{className:"text-xs text-muted-foreground",children:[a.appointments.filter(a=>"completed"===a.status).length," ","completed"]})]})}),(0,b.jsx)(V.Card,{className:"md:col-span-2 bg-muted/30",children:(0,b.jsx)(V.CardContent,{className:"p-4",children:a.currentJob?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-1",children:[(0,b.jsx)(A.Zap,{className:"h-3 w-3"}),"Current Job"]}),(0,b.jsx)("div",{className:"font-medium",children:a.currentJob.title}),(0,b.jsxs)("div",{className:"text-sm text-muted-foreground flex items-center gap-1",children:[(0,b.jsx)(o.MapPin,{className:"h-3 w-3"}),ay(a.currentJob)]})]}):a.nextJob?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-1",children:[(0,b.jsx)(l.Clock,{className:"h-3 w-3"}),"Next Job"]}),(0,b.jsx)("div",{className:"font-medium",children:a.nextJob.title}),(0,b.jsxs)("div",{className:"text-sm text-muted-foreground flex items-center gap-1",children:[(0,b.jsx)(o.MapPin,{className:"h-3 w-3"}),ay(a.nextJob)]})]}):(0,b.jsx)("div",{className:"text-muted-foreground",children:"No upcoming jobs scheduled"})})})]})]})})}function aC({jobs:a,isOpen:c,onToggle:e,onJobSelect:f}){return 0===a.length?null:(0,b.jsx)("div",{className:"absolute top-4 right-4 z-10",children:(0,b.jsxs)(V.Card,{className:(0,O.cn)("transition-all duration-300",c?"w-80":"w-auto"),children:[(0,b.jsx)(V.CardHeader,{className:"p-3 cursor-pointer hover:bg-accent/50",onClick:e,children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(d.AlertCircle,{className:"h-4 w-4 text-amber-500"}),(0,b.jsxs)("span",{className:"text-sm font-medium",children:["Unassigned (",a.length,")"]})]}),(0,b.jsx)(i.ChevronDown,{className:(0,O.cn)("h-4 w-4 transition-transform",c&&"rotate-180")})]})}),c&&(0,b.jsx)(V.CardContent,{className:"p-0",children:(0,b.jsx)(W.ScrollArea,{className:"max-h-64",children:a.slice(0,10).map(a=>{let c=aw[a.priority||"normal"];return(0,b.jsx)("div",{className:"p-3 border-t cursor-pointer hover:bg-accent/50",onClick:()=>f(a),children:(0,b.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsx)("div",{className:"font-medium text-sm truncate",children:a.title}),(0,b.jsx)("div",{className:"text-xs text-muted-foreground truncate",children:a.customer?.display_name})]}),a.priority&&(0,b.jsx)(U.Badge,{variant:"outline",className:(0,O.cn)("text-[10px]",c?.bg,c?.text),children:a.priority})]})},a.id)})})})]})})}function aD({technicians:a,gpsLocations:d,appointments:f,unassignedJobs:g,companyId:h}){let i=(0,B.useRouter)(),l=(0,c.useRef)(null),o=(0,c.useRef)(null),p=(0,c.useRef)(new Map),q=(0,c.useRef)(new Map),v=(0,c.useRef)(null),[x,z]=(0,c.useState)(!1),[A,C]=(0,c.useState)(null),[D,E]=(0,c.useState)(!0),[F,G]=(0,c.useState)(null),[H,J]=(0,c.useState)(null),[L,M]=(0,c.useState)(!1),[N,P]=(0,c.useState)(""),[Q,R]=(0,c.useState)(new Map(d.map(a=>[a.technician_id,a]))),[T,Y]=(0,c.useState)(!1),[Z,$]=(0,c.useState)(null),[_,aa]=(0,c.useState)([]),[ab,ac]=(0,c.useState)(null),[ad,af]=(0,c.useState)(new Map),[ag,ah]=(0,c.useState)(!1),ai="AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0",aj=(0,c.useMemo)(()=>a.map(a=>({id:a.id,name:a.name,avatar:a.avatar})),[a]),ak=(0,c.useCallback)(async a=>{if(!a.latLng)return;let b=a.latLng.lat(),c=a.latLng.lng(),d=await ap({lat:b,lng:c});$({lat:b,lng:c,address:d||void 0});let e=[];for(let a of g)if(a.customer){let b=a.property?.lat&&a.property?.lon?{lat:a.property.lat,lng:a.property.lon}:a.customer?.lat&&a.customer?.lon?{lat:a.customer.lat,lng:a.customer.lon}:null;b&&e.push({id:a.customer.id,display_name:a.customer.display_name,phone:a.customer.phone||void 0,lat:b.lat,lng:b.lng})}let f=function(a,b,c=5){let d=[];for(let e of b){let b=e.lng??e.lon;if(null==e.lat||null==b)continue;let f=function(a,b){let c=ao(b.lat-a.lat),d=ao(b.lng-a.lng),e=Math.sin(c/2)*Math.sin(c/2)+Math.cos(ao(a.lat))*Math.cos(ao(b.lat))*Math.sin(d/2)*Math.sin(d/2);return 2*Math.atan2(Math.sqrt(e),Math.sqrt(1-e))*3959}(a,{lat:e.lat,lng:b});f<=c&&d.push({...e,distance:f})}return d.sort((a,b)=>a.distance-b.distance)}({lat:b,lng:c},e,5),h=new Map;for(let a of f)h.has(a.id)||h.set(a.id,{id:a.id,display_name:a.display_name,phone:a.phone});aa(Array.from(h.values()).slice(0,5)),Y(!0)},[g]);(0,c.useEffect)(()=>{v.current=ak},[ak]);let al=(0,c.useMemo)(()=>a.map(a=>{let b=Q.get(a.id),c=f.filter(b=>b.assigned_technician_ids?.includes(a.id));c.sort((a,b)=>new Date(a.scheduled_start).getTime()-new Date(b.scheduled_start).getTime());let d=c.find(a=>"in-progress"===a.status||"arrived"===a.status),e=c.find(a=>"scheduled"===a.status||"dispatched"===a.status),g=ad.get(a.id);return{...a,gpsLocation:b,appointments:c,currentJob:d?.job,nextJob:e?.job,etaToNextJob:g}}),[a,Q,f,ad]),aq=(0,c.useMemo)(()=>{if(!N.trim())return al;let a=N.toLowerCase();return al.filter(b=>b.name?.toLowerCase().includes(a)||b.currentJob?.title?.toLowerCase().includes(a)||b.nextJob?.title?.toLowerCase().includes(a))},[al,N]),aw=(0,c.useMemo)(()=>al.find(a=>a.id===F)||null,[al,F]);(0,c.useEffect)(()=>{let a=!0;return(async()=>{try{if(await new Promise((a,b)=>{if(ar||window.google?.maps){ar=!0,a();return}if(as)return void at.push(a);let c=document.querySelector('script[src*="maps.googleapis.com"]');if(c){as=!0,c.addEventListener("load",()=>{ar=!0,as=!1,a(),at.forEach(a=>a()),at.length=0});return}as=!0;let d=document.createElement("script");d.src=`https://maps.googleapis.com/maps/api/js?key=${ai}&libraries=marker`,d.async=!0,d.defer=!0,d.onload=()=>{ar=!0,as=!1,a(),at.forEach(a=>a()),at.length=0},d.onerror=()=>{as=!1,b(Error("Failed to load Google Maps"))},document.head.appendChild(d)}),!a||!l.current)return;let{Map:b}=await google.maps.importLibrary("maps"),c=new b(l.current,{center:{lat:37.7749,lng:-122.4194},zoom:11,mapId:"dispatch-map",disableDefaultUI:!0,zoomControl:!0,fullscreenControl:!0,styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]}]});o.current=c,z(!0),c.addListener("click",a=>{v.current&&v.current(a)})}catch(b){a&&C(b instanceof Error?b.message:"Failed to load map")}})(),()=>{for(let b of(a=!1,p.current.values()))try{b.map=null}catch(a){}for(let a of(p.current.clear(),q.current.values()))try{a.setMap(null)}catch(a){}q.current.clear(),o.current=null,l.current&&(l.current.innerHTML="")}},[ai]),(0,c.useEffect)(()=>{o.current&&x&&(async()=>{try{let{AdvancedMarkerElement:a}=await google.maps.importLibrary("marker"),b=o.current;if(!b)return;let c=new Set;for(let d of al){let e=d.gpsLocation;if(!e)continue;let f=`tech-${d.id}`;c.add(f);let g={lat:Number(e.lat),lng:Number(e.lng)},h=au[d.status]||au.offline,i=p.current.get(f);if(i)i.position=g;else{let c=document.createElement("div");c.className="relative cursor-pointer",c.innerHTML=`
							<div class="relative">
								<div class="w-10 h-10 rounded-full bg-white shadow-lg border-2 ${h.border.replace("border-","border-")} flex items-center justify-center overflow-hidden">
									${d.avatar?`<img src="${d.avatar}" class="w-full h-full object-cover" />`:`<span class="text-sm font-medium text-gray-700">${ax(d.name)}</span>`}
								</div>
								<div class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full ${h.bg} border-2 border-white"></div>
							</div>
						`,(i=new a({map:b,position:g,content:c,title:d.name})).addListener("click",()=>{G(d.id),J(null)}),p.current.set(f,i)}}for(let d of f){if(!d.job)continue;let e=az(d.job);if(!e)continue;let f=`job-${d.job.id}`;c.add(f);let g=av[d.status]||av.pending,h=p.current.get(f);if(!h){let c=document.createElement("div");c.className="cursor-pointer",c.innerHTML=`
							<div class="w-6 h-6 rounded-full shadow-md flex items-center justify-center" style="background-color: ${g}">
								<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
									<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
									<circle cx="12" cy="10" r="3"/>
								</svg>
							</div>
						`,(h=new a({map:b,position:e,content:c,title:d.job.title})).addListener("click",()=>{J(d.job),G(null)}),p.current.set(f,h)}}for(let[a,b]of p.current)c.has(a)||(b.map=null,p.current.delete(a))}catch(a){console.error("Error updating markers:",a)}})()},[al,f,x]),(0,c.useEffect)(()=>{if(!o.current||!x)return;let a=o.current,b=["#3b82f6","#10b981","#f59e0b","#8b5cf6","#ef4444","#ec4899"];for(let a of q.current.values())a.setMap(null);q.current.clear(),al.forEach((c,d)=>{if(!c.gpsLocation||0===c.appointments.length)return;let e=[];for(let a of(e.push({lat:Number(c.gpsLocation.lat),lng:Number(c.gpsLocation.lng)}),c.appointments)){if(!a.job)continue;let b=az(a.job);b&&e.push(b)}if(e.length<2)return;let f=new google.maps.Polyline({path:e,geodesic:!0,strokeColor:b[d%b.length],strokeOpacity:.7,strokeWeight:3,map:a});q.current.set(`route-${c.id}`,f)})},[al,x]),(0,c.useEffect)(()=>{let a=(0,an.createClient)(),b=a.channel("dispatch-gps-updates").on("postgres_changes",{event:"*",schema:"public",table:"technician_locations",filter:`company_id=eq.${h}`},a=>{if(a.new&&"object"==typeof a.new){let b=a.new;R(a=>{let c=new Map(a);return c.set(b.technician_id,b),c})}}).subscribe();return()=>{a.removeChannel(b)}},[h]),(0,c.useEffect)(()=>{let a=async()=>{let a=al.find(a=>a.gpsLocation);if(a?.gpsLocation)try{let b=await am.getWeatherData(a.gpsLocation.lat,a.gpsLocation.lng);b&&ac({temperature:b.current.temperature,condition:b.current.conditions,icon:b.current.icon,alerts:b.alerts})}catch(a){console.error("Error fetching weather:",a)}};a();let b=setInterval(a,6e5);return()=>clearInterval(b)},[al]),(0,c.useEffect)(()=>{let a=async()=>{let a=[],b=new Map;for(let c of al){if(!c.gpsLocation||!c.nextJob)continue;let d=az(c.nextJob);if(!d)continue;let e=(async()=>{try{let a=await ae.getETA({lat:c.gpsLocation.lat,lon:c.gpsLocation.lng},{lat:d.lat,lon:d.lng});a&&b.set(c.id,{durationMinutes:a.durationMinutes,distanceKm:a.distanceKm,arrivalTime:a.arrivalTime})}catch(a){console.error(`Error fetching ETA for tech ${c.id}:`,a)}})();a.push(e)}await Promise.all(a),b.size>0&&af(b)};if(al.some(a=>a.gpsLocation&&a.nextJob)){a();let b=setInterval(a,12e4);return()=>clearInterval(b)}},[al]);let aD=(0,c.useCallback)(async()=>{ah(!0);try{let a=o.current;if(!a)return;for(let a of q.current.values())a.setMap(null);q.current.clear();let b=["#3b82f6","#10b981","#f59e0b","#8b5cf6","#ef4444","#ec4899"];for(let c=0;c<al.length;c++){let d=al[c];if(!d.gpsLocation||0===d.appointments.length)continue;let e=[{lat:d.gpsLocation.lat,lon:d.gpsLocation.lng}];for(let a of d.appointments){if(!a.job)continue;let b=az(a.job);b&&e.push({lat:b.lat,lon:b.lng,address:ay(a.job),jobId:a.job.id})}if(!(e.length<2))try{let f=await ae.getMultiStopRoute(e,!0);if(f&&f.polyline){let e=google.maps.geometry?.encoding?.decodePath(f.polyline);if(e){let f=new google.maps.Polyline({path:e,geodesic:!0,strokeColor:b[c%b.length],strokeOpacity:.8,strokeWeight:4,map:a});q.current.set(`route-${d.id}`,f)}}}catch(h){console.error(`Error optimizing route for tech ${d.id}:`,h);let f=e.map(a=>({lat:a.lat,lng:a.lon})),g=new google.maps.Polyline({path:f,geodesic:!0,strokeColor:b[c%b.length],strokeOpacity:.7,strokeWeight:3,map:a});q.current.set(`route-${d.id}`,g)}}}catch(a){console.error("Error optimizing routes:",a)}finally{ah(!1)}},[al]),aE=(0,c.useCallback)(()=>{if(!o.current)return;let a=new google.maps.LatLngBounds,b=!1;for(let c of al)c.gpsLocation&&(a.extend({lat:Number(c.gpsLocation.lat),lng:Number(c.gpsLocation.lng)}),b=!0);for(let c of f)if(c.job){let d=az(c.job);d&&(a.extend(d),b=!0)}b&&o.current.fitBounds(a,50)},[al,f]);(0,c.useEffect)(()=>{o.current&&aw?.gpsLocation&&(o.current.panTo({lat:Number(aw.gpsLocation.lat),lng:Number(aw.gpsLocation.lng)}),o.current.setZoom(15))},[aw]);let aF=al.filter(a=>a.gpsLocation).length;return(0,b.jsxs)("div",{className:"relative h-full w-full overflow-hidden",children:[(0,b.jsx)("div",{className:(0,O.cn)("absolute top-4 left-4 bottom-4 z-10 transition-all duration-300",D?"w-80":"w-12"),children:(0,b.jsxs)(V.Card,{className:"h-full flex flex-col overflow-hidden",children:[(0,b.jsx)(V.CardHeader,{className:"p-3 border-b flex-shrink-0",children:(0,b.jsx)("div",{className:"flex items-center justify-between",children:D?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(y.Users,{className:"h-4 w-4"}),(0,b.jsx)("span",{className:"font-medium",children:"Technicians"}),(0,b.jsx)(U.Badge,{variant:"secondary",className:"text-xs",children:a.length})]}),(0,b.jsx)(I.Button,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>E(!1),children:(0,b.jsx)(j.ChevronLeft,{className:"h-4 w-4"})})]}):(0,b.jsx)(I.Button,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>E(!0),children:(0,b.jsx)(k.ChevronRight,{className:"h-4 w-4"})})})}),D&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{className:"p-3 border-b",children:(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)(u.Search,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),(0,b.jsx)(K.Input,{placeholder:"Search technicians...",className:"pl-9",value:N,onChange:a=>P(a.target.value)})]})}),(0,b.jsx)(W.ScrollArea,{className:"flex-1",children:aq.length>0?aq.map(a=>(0,b.jsx)(aA,{tech:a,isSelected:F===a.id,onClick:()=>{G(a.id),J(null)}},a.id)):0===a.length?(0,b.jsxs)("div",{className:"p-4 text-center",children:[(0,b.jsx)(e.AlertTriangle,{className:"h-8 w-8 mx-auto mb-2 text-amber-500"}),(0,b.jsx)("p",{className:"text-sm font-medium",children:"No technicians found"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"Add technicians to your team to see them here"})]}):(0,b.jsxs)("div",{className:"p-4 text-center text-sm text-muted-foreground",children:['No results for "',N,'"']})}),(0,b.jsx)("div",{className:"p-3 border-t bg-muted/30",children:(0,b.jsxs)("div",{className:"flex items-center justify-between text-xs",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("div",{className:"h-2 w-2 rounded-full bg-emerald-500 animate-pulse"}),(0,b.jsx)("span",{className:"text-muted-foreground",children:"Live GPS Tracking"})]}),(0,b.jsxs)("span",{className:"text-muted-foreground",children:[aF,"/",a.length," active"]})]})})]})]})}),ab&&(0,b.jsx)("div",{className:"absolute top-4 left-[21rem] z-10",children:(0,b.jsx)(V.Card,{className:"p-3 bg-background/95 backdrop-blur shadow-lg",children:(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[ab.condition.toLowerCase().includes("rain")||ab.condition.toLowerCase().includes("storm")?(0,b.jsx)(m.CloudRain,{className:"h-5 w-5 text-blue-500"}):ab.condition.toLowerCase().includes("cloud")?(0,b.jsx)(m.CloudRain,{className:"h-5 w-5 text-gray-500"}):(0,b.jsx)(w.Sun,{className:"h-5 w-5 text-amber-500"}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsxs)("span",{className:"font-semibold",children:[Math.round(ab.temperature),"°F"]}),(0,b.jsx)("span",{className:"text-sm text-muted-foreground",children:ab.condition})]}),ab.alerts.length>0&&(0,b.jsxs)("div",{className:"flex items-center gap-1 text-xs text-amber-600",children:[(0,b.jsx)(e.AlertTriangle,{className:"h-3 w-3"}),(0,b.jsx)("span",{children:ab.alerts[0].headline})]})]})]})})}),(0,b.jsx)("div",{className:"absolute bottom-4 right-4 z-10 flex flex-col gap-2",children:(0,b.jsxs)(X.TooltipProvider,{children:[(0,b.jsxs)(X.Tooltip,{children:[(0,b.jsx)(X.TooltipTrigger,{asChild:!0,children:(0,b.jsx)(I.Button,{variant:"secondary",size:"icon",className:"shadow-lg",onClick:aD,disabled:ag,children:ag?(0,b.jsx)(s.RefreshCw,{className:"h-4 w-4 animate-spin"}):(0,b.jsx)(t.Route,{className:"h-4 w-4"})})}),(0,b.jsxs)(X.TooltipContent,{side:"left",children:[(0,b.jsx)("p",{className:"font-medium",children:"Optimize Routes"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:"Get optimal routes for all technicians"})]})]}),(0,b.jsxs)(X.Tooltip,{children:[(0,b.jsx)(X.TooltipTrigger,{asChild:!0,children:(0,b.jsx)(I.Button,{variant:"secondary",size:"icon",className:"shadow-lg",onClick:()=>Y(!0),children:(0,b.jsx)(r.Plus,{className:"h-4 w-4"})})}),(0,b.jsxs)(X.TooltipContent,{side:"left",children:[(0,b.jsx)("p",{className:"font-medium",children:"Quick Appointment"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:"Or click anywhere on map"})]})]}),(0,b.jsxs)(X.Tooltip,{children:[(0,b.jsx)(X.TooltipTrigger,{asChild:!0,children:(0,b.jsx)(I.Button,{variant:"secondary",size:"icon",className:"shadow-lg",onClick:aE,children:(0,b.jsx)(n.default,{className:"h-4 w-4"})})}),(0,b.jsx)(X.TooltipContent,{side:"left",children:"Fit all markers"})]})]})}),(0,b.jsx)(aC,{jobs:g,isOpen:L,onToggle:()=>M(!L),onJobSelect:a=>{J(a),G(null);let b=az(a);b&&o.current&&(o.current.panTo(b),o.current.setZoom(15))}}),(0,b.jsxs)("div",{className:"h-full w-full bg-muted relative",children:[(0,b.jsx)("div",{ref:l,className:"absolute inset-0",suppressHydrationWarning:!0}),!x&&!A&&(0,b.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-muted z-10",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)(s.RefreshCw,{className:"mx-auto h-8 w-8 animate-spin text-muted-foreground"}),(0,b.jsx)("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading map..."})]})}),A&&(0,b.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-muted z-10",children:(0,b.jsxs)("div",{className:"text-center max-w-md",children:[(0,b.jsx)(e.AlertTriangle,{className:"mx-auto h-12 w-12 text-amber-500 mb-4"}),(0,b.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Map Unavailable"}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground mb-4",children:A}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:"Please ensure the Google Maps API key is configured in your environment variables."})]})})]}),(0,b.jsx)(aB,{tech:aw,onClose:()=>G(null),onNavigate:()=>{aw&&i.push(`/dashboard/schedule/technician/${aw.id}`)}}),(0,b.jsx)(S,{open:T,onOpenChange:Y,location:Z,technicians:aj,nearbyCustomers:_,onSuccess:a=>{},onCreateCustomer:()=>{i.push("/dashboard/customers/new")}})]})}function aE(a){return(0,b.jsx)(aq,{children:(0,b.jsx)(aD,{...a})})}a.s(["DispatchMapView",()=>aE],140813)}];

//# sourceMappingURL=82e4e_app_%28dashboard%29_dashboard_schedule_dispatch-map_dispatch-map-view_tsx_de931efc._.js.map