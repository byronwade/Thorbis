{"version":3,"sources":["../../../../../../apps/web/src/lib/email/email-tracking.ts"],"sourcesContent":["/**\n * Email Tracking Utilities\n *\n * Adds tracking pixels and link tracking to all outgoing emails\n * to track opens, clicks, and delivery status.\n */\n\n/**\n * Generate a tracking pixel URL for email opens\n */\nfunction generateTrackingPixelUrl(\n\tcommunicationId: string,\n\tbaseUrl: string = process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\",\n): string {\n\treturn `${baseUrl}/api/email/track/open?c=${encodeURIComponent(communicationId)}`;\n}\n\n/**\n * Generate a tracking URL for link clicks\n */\nfunction generateTrackingClickUrl(\n\tcommunicationId: string,\n\toriginalUrl: string,\n\tbaseUrl: string = process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\",\n): string {\n\treturn `${baseUrl}/api/email/track/click?c=${encodeURIComponent(communicationId)}&u=${encodeURIComponent(originalUrl)}`;\n}\n\n/**\n * Inject tracking pixel into HTML email\n * Adds a 1x1 transparent pixel at the end of the email body\n */\nfunction injectTrackingPixel(\n\thtml: string,\n\tcommunicationId: string,\n\tbaseUrl?: string,\n): string {\n\tconst trackingUrl = generateTrackingPixelUrl(communicationId, baseUrl);\n\n\t// Create tracking pixel\n\tconst trackingPixel = `<img src=\"${trackingUrl}\" width=\"1\" height=\"1\" style=\"display:none;width:1px;height:1px;border:0;\" alt=\"\" />`;\n\n\t// Try to inject before closing body tag, otherwise append to end\n\tif (html.includes(\"</body>\")) {\n\t\treturn html.replace(\"</body>\", `${trackingPixel}</body>`);\n\t}\n\n\t// If no body tag, append to end\n\treturn `${html}${trackingPixel}`;\n}\n\n/**\n * Wrap all links in HTML with tracking URLs\n * Preserves original link behavior while tracking clicks\n */\nfunction wrapLinksWithTracking(\n\thtml: string,\n\tcommunicationId: string,\n\tbaseUrl?: string,\n): string {\n\t// Regex to find all href attributes in anchor tags\n\tconst linkRegex = /<a\\s+([^>]*\\s+)?href=[\"']([^\"']+)[\"']([^>]*)>/gi;\n\n\treturn html.replace(linkRegex, (match, before, url, after) => {\n\t\t// Skip if already a tracking URL or mailto/tel links\n\t\tif (\n\t\t\turl.startsWith(\"mailto:\") ||\n\t\t\turl.startsWith(\"tel:\") ||\n\t\t\turl.startsWith(\"#\") ||\n\t\t\turl.includes(\"/api/email/track/\")\n\t\t) {\n\t\t\treturn match;\n\t\t}\n\n\t\t// Generate tracking URL\n\t\tconst trackingUrl = generateTrackingClickUrl(communicationId, url, baseUrl);\n\n\t\t// Replace href with tracking URL\n\t\treturn `<a ${before || \"\"}href=\"${trackingUrl}\"${after || \"\"}>`;\n\t});\n}\n\n/**\n * Add complete tracking to email HTML\n * - Injects tracking pixel for opens\n * - Wraps all links for click tracking\n */\nexport function addEmailTracking(\n\thtml: string,\n\tcommunicationId: string,\n\tbaseUrl?: string,\n): string {\n\t// First wrap links, then add tracking pixel\n\tlet trackedHtml = wrapLinksWithTracking(html, communicationId, baseUrl);\n\ttrackedHtml = injectTrackingPixel(trackedHtml, communicationId, baseUrl);\n\n\treturn trackedHtml;\n}\n"],"names":[],"mappings":"wCAuFO,SAAS,EACf,CAAY,CACZ,CAAuB,CACvB,CAAgB,YArDV,EAGA,EAqDF,EAAoC,AA9BjC,EAAK,OAAO,CAFD,AAEE,EA8BF,gDA9Ba,CAAC,EAAO,EAAQ,EAAK,KAEnD,GACC,EAAI,UAAU,CAAC,YACf,EAAI,UAAU,CAAC,SACf,EAAI,UAAU,CAAC,MACf,EAAI,QAAQ,CAAC,qBAEb,CADC,MACM,EAIR,IAAM,EAAc,AAvDtB,SACC,AADQ,CACe,CACvB,CAAmB,CACnB,EAAkB,QAAA,EAoD4B,aApD8B,EAE5E,GAFqD,GAE9C,CAAA,EAAG,EAAQ,yBAAyB,EAAE,mBAAmB,GAAiB,GAAG,EAAE,mBAAmB,GAAA,CAAc,AACxH,EAmE+C,EAlBiB,EAkBA,GAlBK,AAGnE,MAAO,CAAC,GAAG,EAAE,GAAU,GAAG,MAAM,EAAE,EAAY,CAAC,EAAE,GAAS,GAAG,CAAC,CAAC,AAChE,GAiBA,OAAO,AA/DP,EA6DkC,EA7DtB,EAvBb,AAwBC,AAGoB,SA3BZ,AACR,CAAuB,CACvB,EAAkB,EAsBK,EACvB,IAvBkB,GAuBF,CAE6B,WAzB+B,EAE5E,GAFqD,CAyBS,EAvBvD,CAAA,EAAG,EAAQ,wBAAwB,EAAE,mBAAmB,GAAA,CAAkB,AAClF,EA+EgD,EAAiB,KAtD1C,CAAC,UAAU,EAAE,EAAY,oFAAoF,CAAC,CAsDpI,EAnDA,AAAI,EAAK,QAAQ,CAAC,CAmDJ,UAlDN,CADsB,CACjB,OAAO,CAAC,UAAW,CAAA,EAAG,EAAc,OAAO,CAAC,EAIlD,CAAA,EAAG,EAAA,EAAO,EAAA,CAAe,AAiDjC"}