module.exports=[770897,a=>{"use strict";var b=a.i(780195),c=a.i(218188),d=a.i(146057);a.i(467361);var e=a.i(445074),f=a.i(818944),g=a.i(974406),h=a.i(81441),i=a.i(136874),j=a.i(395731);let k=d.z.object({customerId:d.z.string().uuid("Customer is required"),name:d.z.string().min(1,"Property name is required").max(200),address:d.z.string().min(1,"Address is required").max(200),address2:d.z.string().max(100).optional(),city:d.z.string().min(1,"City is required").max(100),state:d.z.string().min(1,"State is required").max(50),zipCode:d.z.string().min(1,"ZIP code is required").max(20),country:d.z.string().max(50).default("USA"),propertyType:d.z.enum(["residential","commercial","industrial"]).optional(),squareFootage:d.z.number().int().min(0).optional(),yearBuilt:d.z.number().int().min(1800).max(new Date().getFullYear()+5).optional(),notes:d.z.string().optional(),lat:d.z.number().optional(),lon:d.z.number().optional()});async function l(a){return(0,g.withErrorHandling)(async()=>{let b=await (0,i.createClient)();if(!b)throw new f.ActionError("Database connection failed",f.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:d}}=await b.auth.getUser();(0,g.assertAuthenticated)(d?.id);let j=await (0,e.getActiveCompanyId)();if(!j)throw new f.ActionError("You must be part of a company",f.ERROR_CODES.AUTH_FORBIDDEN,403);let l=k.parse({customerId:a.get("customerId"),name:a.get("name"),address:a.get("address"),address2:a.get("address2")||void 0,city:a.get("city"),state:a.get("state"),zipCode:a.get("zipCode"),country:a.get("country")||"USA",propertyType:a.get("propertyType")||void 0,squareFootage:a.get("squareFootage")?Number(a.get("squareFootage")):void 0,yearBuilt:a.get("yearBuilt")?Number(a.get("yearBuilt")):void 0,notes:a.get("notes")||void 0,lat:a.get("lat")?Number(a.get("lat")):void 0,lon:a.get("lon")?Number(a.get("lon")):void 0}),{data:m}=await b.from("customers").select("id, company_id").eq("id",l.customerId).is("deleted_at",null).single();if((0,g.assertExists)(m,"Customer"),m.company_id!==j)throw new f.ActionError("Customer not found",f.ERROR_CODES.AUTH_FORBIDDEN,403);let{data:n}=await b.from("properties").select("id").eq("customer_id",l.customerId).eq("address",l.address).eq("city",l.city).eq("state",l.state).eq("zip_code",l.zipCode).eq("company_id",j).maybeSingle();if(n)return n.id;l.address,l.city,l.state,l.zipCode;let o={company_id:j,customer_id:l.customerId,name:l.name,address:l.address,city:l.city,state:l.state,zip_code:l.zipCode,country:l.country,notes:l.notes};l.address2&&(o.address2=l.address2),l.squareFootage&&(o.square_footage=l.squareFootage),l.yearBuilt&&(o.year_built=l.yearBuilt),l.lat&&l.lon&&(o.lat=l.lat,o.lon=l.lon);let{data:p,error:q}=await b.from("properties").insert(o).select("id").single();if(!p?.id||l.lat||l.lon||(0,h.geocodeAddressSilent)(l.address,l.city,l.state,l.zipCode,l.country).then(a=>{a&&b.from("properties").update({lat:a.lat,lon:a.lon}).eq("id",p.id)}).catch(a=>{}),q)throw new f.ActionError(f.ERROR_MESSAGES.operationFailed("create property"),f.ERROR_CODES.DB_QUERY_ERROR);return(0,g.assertExists)(p,"Property"),(0,c.revalidatePath)("/dashboard/customers"),(0,c.revalidatePath)(`/dashboard/customers/${l.customerId}`),p.id})}async function m(a,b){return(0,g.withErrorHandling)(async()=>{let d=await (0,i.createClient)();if(!d)throw new f.ActionError("Database connection failed",f.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:e}}=await d.auth.getUser();(0,g.assertAuthenticated)(e?.id);let{data:h}=await d.from("company_memberships").select("company_id").eq("user_id",e.id).single();if(!h?.company_id)throw new f.ActionError("You must be part of a company",f.ERROR_CODES.AUTH_FORBIDDEN,403);let{data:j}=await d.from("properties").select("id, company_id, customer_id").eq("id",a).single();if((0,g.assertExists)(j,"Property"),j.company_id!==h.company_id)throw new f.ActionError("Property not found",f.ERROR_CODES.AUTH_FORBIDDEN,403);let l=k.parse({customerId:j.customer_id,name:b.get("name"),address:b.get("address"),address2:b.get("address2")||void 0,city:b.get("city"),state:b.get("state"),zipCode:b.get("zipCode"),country:b.get("country")||"USA",propertyType:b.get("propertyType")||void 0,squareFootage:b.get("squareFootage")?Number(b.get("squareFootage")):void 0,yearBuilt:b.get("yearBuilt")?Number(b.get("yearBuilt")):void 0,notes:b.get("notes")||void 0}),{error:m}=await d.from("properties").update({name:l.name,address:l.address,address2:l.address2,city:l.city,state:l.state,zip_code:l.zipCode,country:l.country,property_type:l.propertyType,square_footage:l.squareFootage,year_built:l.yearBuilt,notes:l.notes}).eq("id",a);if(m)throw new f.ActionError(f.ERROR_MESSAGES.operationFailed("update property"),f.ERROR_CODES.DB_QUERY_ERROR);(0,c.revalidatePath)("/dashboard/customers"),(0,c.revalidatePath)(`/dashboard/customers/${j.customer_id}`)})}async function n(a){return(0,g.withErrorHandling)(async()=>{let b=await (0,i.createClient)();if(!b)throw new f.ActionError("Database connection failed",f.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:d}}=await b.auth.getUser();(0,g.assertAuthenticated)(d?.id);let{data:e}=await b.from("company_memberships").select("company_id").eq("user_id",d.id).single();if(!e?.company_id)throw new f.ActionError("You must be part of a company",f.ERROR_CODES.AUTH_FORBIDDEN,403);let{data:h}=await b.from("properties").select("id, company_id, customer_id").eq("id",a).single();if((0,g.assertExists)(h,"Property"),h.company_id!==e.company_id)throw new f.ActionError("Property not found",f.ERROR_CODES.AUTH_FORBIDDEN,403);let{data:j}=await b.from("equipment").select("id").eq("property_id",a).is("deleted_at",null).limit(1);if(j&&j.length>0)throw new f.ActionError("Cannot archive property with equipment. Remove or reassign equipment first.",f.ERROR_CODES.BUSINESS_RULE_VIOLATION);let{data:k}=await b.from("jobs").select("id").eq("property_id",a).is("deleted_at",null).limit(1);if(k&&k.length>0)throw new f.ActionError("Cannot archive property with job history.",f.ERROR_CODES.BUSINESS_RULE_VIOLATION);let l=new Date().toISOString(),m=new Date(Date.now()+7776e6).toISOString(),{error:n}=await b.from("properties").update({deleted_at:l,deleted_by:d.id,archived_at:l,permanent_delete_scheduled_at:m}).eq("id",a);if(n)throw new f.ActionError(f.ERROR_MESSAGES.operationFailed("archive property"),f.ERROR_CODES.DB_QUERY_ERROR);(0,c.revalidatePath)("/dashboard/customers"),(0,c.revalidatePath)(`/dashboard/customers/${h.customer_id}`),(0,c.revalidatePath)("/dashboard/settings/archive")})}(0,j.ensureServerEntryExports)([l,m,n]),(0,b.registerServerReference)(l,"408e80b3cde6acbbf52029b5b34cf969f275e65d9d",null),(0,b.registerServerReference)(m,"60bc2c83da6158cf177ce1d0c73aba3655e921db94",null),(0,b.registerServerReference)(n,"40c4dabc91a1b3abfcb02e70294b84f9e59c59d1e8",null),a.s(["_updateProperty",()=>m,"archiveProperty",()=>n,"findOrCreateProperty",()=>l])}];

//# sourceMappingURL=apps_web_src_actions_properties_ts_925b32a0._.js.map