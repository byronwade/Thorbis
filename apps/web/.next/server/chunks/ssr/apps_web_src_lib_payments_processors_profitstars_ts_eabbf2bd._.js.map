{"version":3,"sources":["../../../../../../apps/web/src/lib/payments/processors/profitstars.ts"],"sourcesContent":["/**\n * ProfitStars (Jack Henry) Payment Processor\n *\n * Handles ACH and check processing through ProfitStars/Jack Henry:\n * - ACH payments\n * - Check processing\n * - Bank account verification\n * - High-volume ACH processing\n *\n * ProfitStars is ideal for:\n * - Large ACH transactions\n * - Check processing\n * - Businesses that need bank-rail specialists\n * - Reduced ACH returns and better compliance\n */\n\nimport crypto from \"crypto\";\nimport type {\n\tPaymentChannel,\n\tPaymentProcessor,\n\tProcessPaymentRequest,\n\tProcessPaymentResponse,\n\tRefundPaymentRequest,\n\tRefundPaymentResponse,\n} from \"../processor-types\";\n\ntype ProfitStarsConfig = {\n\tcompanyId: string;\n\tmerchantId: string;\n\tapiKey: string;\n\troutingNumber: string;\n\twebhookSecret?: string; // Secret key for webhook HMAC verification\n};\n\nexport class ProfitStarsProcessor implements PaymentProcessor {\n\tprivate readonly config: ProfitStarsConfig;\n\tprivate readonly apiUrl = \"https://api.profitstars.com\"; // Update with actual API URL\n\n\tconstructor(config: ProfitStarsConfig) {\n\t\tthis.config = config;\n\t}\n\n\tgetSupportedChannels(): PaymentChannel[] {\n\t\treturn [\"ach\", \"check\"];\n\t}\n\n\tasync processPayment(\n\t\trequest: ProcessPaymentRequest,\n\t): Promise<ProcessPaymentResponse> {\n\t\ttry {\n\t\t\tif (!request.paymentMethodId) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tstatus: \"failed\",\n\t\t\t\t\terror: \"Payment method (bank account) is required for ACH payments\",\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// ProfitStars ACH payment request\n\t\t\tconst achRequest = {\n\t\t\t\tmerchant_id: this.config.merchantId,\n\t\t\t\ttransaction_type: \"ACH_DEBIT\",\n\t\t\t\tamount: request.amount / 100, // Convert cents to dollars\n\t\t\t\taccount_number: request.paymentMethodId, // Bank account identifier\n\t\t\t\trouting_number: this.config.routingNumber,\n\t\t\t\treference_number: request.invoiceId || `invoice-${Date.now()}`,\n\t\t\t\tdescription: request.description || \"Invoice payment\",\n\t\t\t\tmetadata: {\n\t\t\t\t\tcompany_id: this.config.companyId,\n\t\t\t\t\tcustomer_id: request.customerId,\n\t\t\t\t\tinvoice_id: request.invoiceId,\n\t\t\t\t\t...request.metadata,\n\t\t\t\t},\n\t\t\t};\n\n\t\t\t// Make API call to ProfitStars\n\t\t\tconst response = await fetch(`${this.apiUrl}/v1/payments/ach`, {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders: {\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\tAuthorization: `Bearer ${this.config.apiKey}`,\n\t\t\t\t\t\"X-Merchant-ID\": this.config.merchantId,\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify(achRequest),\n\t\t\t});\n\n\t\t\tconst data = await response.json();\n\n\t\t\tif (!response.ok) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tstatus: \"failed\",\n\t\t\t\t\terror: data.message || \"ACH payment processing failed\",\n\t\t\t\t\tfailureCode: data.error_code,\n\t\t\t\t\tfailureMessage: data.message,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\ttransactionId: data.transaction_id,\n\t\t\t\tprocessorTransactionId: data.transaction_id,\n\t\t\t\tstatus: data.status === \"processed\" ? \"succeeded\" : \"processing\",\n\t\t\t\tprocessorMetadata: data,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tstatus: \"failed\",\n\t\t\t\terror:\n\t\t\t\t\terror instanceof Error ? error.message : \"Payment processing failed\",\n\t\t\t};\n\t\t}\n\t}\n\n\tasync refundPayment(\n\t\trequest: RefundPaymentRequest,\n\t): Promise<RefundPaymentResponse> {\n\t\ttry {\n\t\t\tconst refundRequest = {\n\t\t\t\tmerchant_id: this.config.merchantId,\n\t\t\t\toriginal_transaction_id: request.transactionId,\n\t\t\t\tamount: request.amount ? request.amount / 100 : undefined, // Convert cents to dollars\n\t\t\t\treason: request.reason,\n\t\t\t};\n\n\t\t\tconst response = await fetch(`${this.apiUrl}/v1/payments/refund`, {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders: {\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\tAuthorization: `Bearer ${this.config.apiKey}`,\n\t\t\t\t\t\"X-Merchant-ID\": this.config.merchantId,\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify(refundRequest),\n\t\t\t});\n\n\t\t\tconst data = await response.json();\n\n\t\t\tif (!response.ok) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tstatus: \"failed\",\n\t\t\t\t\terror: data.message || \"Refund failed\",\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\trefundId: data.refund_id,\n\t\t\t\tprocessorRefundId: data.refund_id,\n\t\t\t\tstatus: data.status === \"processed\" ? \"succeeded\" : \"processing\",\n\t\t\t};\n\t\t} catch (error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tstatus: \"failed\",\n\t\t\t\terror: error instanceof Error ? error.message : \"Refund failed\",\n\t\t\t};\n\t\t}\n\t}\n\n\tasync getPaymentStatus(transactionId: string): Promise<{\n\t\tstatus: string;\n\t\tamount: number;\n\t\tmetadata?: Record<string, unknown>;\n\t}> {\n\t\tconst response = await fetch(\n\t\t\t`${this.apiUrl}/v1/payments/${transactionId}`,\n\t\t\t{\n\t\t\t\tmethod: \"GET\",\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${this.config.apiKey}`,\n\t\t\t\t\t\"X-Merchant-ID\": this.config.merchantId,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tconst data = await response.json();\n\n\t\tif (!response.ok) {\n\t\t\tthrow new Error(data.message || \"Failed to get payment status\");\n\t\t}\n\n\t\treturn {\n\t\t\tstatus: data.status || \"unknown\",\n\t\t\tamount: (data.amount || 0) * 100, // Convert dollars to cents\n\t\t\tmetadata: data,\n\t\t};\n\t}\n\n\t/**\n\t * Verify ProfitStars/Jack Henry webhook signature using HMAC SHA256\n\t *\n\t * ProfitStars typically signs webhooks using HMAC SHA256 with a shared secret.\n\t * The signature is sent in the X-Signature header.\n\t *\n\t * @param payload - The raw webhook body\n\t * @param signature - The X-Signature header value\n\t * @returns true if signature is valid\n\t */\n\tverifyWebhook(payload: string, signature: string): boolean {\n\t\tif (!this.config.webhookSecret) {\n\t\t\tconsole.warn(\n\t\t\t\t\"[ProfitStars] No webhook secret configured - skipping verification\",\n\t\t\t);\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!signature) {\n\t\t\tconsole.error(\"[ProfitStars] No webhook signature provided\");\n\t\t\treturn false;\n\t\t}\n\n\t\ttry {\n\t\t\t// Calculate expected HMAC SHA256 signature\n\t\t\tconst expectedSignature = crypto\n\t\t\t\t.createHmac(\"sha256\", this.config.webhookSecret)\n\t\t\t\t.update(payload, \"utf8\")\n\t\t\t\t.digest(\"hex\");\n\n\t\t\t// Compare signatures using timing-safe comparison\n\t\t\t// Signature may be prefixed with \"sha256=\" depending on their format\n\t\t\tconst receivedSignature = signature.startsWith(\"sha256=\")\n\t\t\t\t? signature.slice(7)\n\t\t\t\t: signature;\n\n\t\t\t// Ensure both signatures are same length for timing-safe comparison\n\t\t\tconst expectedBuffer = Buffer.from(expectedSignature, \"hex\");\n\t\t\tconst receivedBuffer = Buffer.from(receivedSignature, \"hex\");\n\n\t\t\tif (expectedBuffer.length !== receivedBuffer.length) {\n\t\t\t\tconsole.error(\"[ProfitStars] Webhook signature length mismatch\");\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tconst isValid = crypto.timingSafeEqual(expectedBuffer, receivedBuffer);\n\n\t\t\tif (!isValid) {\n\t\t\t\tconsole.error(\"[ProfitStars] Webhook signature verification failed\");\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Optionally verify timestamp to prevent replay attacks\n\t\t\ttry {\n\t\t\t\tconst webhookData = JSON.parse(payload);\n\t\t\t\tif (webhookData.timestamp) {\n\t\t\t\t\tconst webhookTime = new Date(webhookData.timestamp).getTime();\n\t\t\t\t\tconst now = Date.now();\n\t\t\t\t\t// Reject webhooks older than 5 minutes\n\t\t\t\t\tif (Math.abs(now - webhookTime) > 300000) {\n\t\t\t\t\t\tconsole.error(\"[ProfitStars] Webhook timestamp too old\");\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// If no timestamp, skip this check\n\t\t\t}\n\n\t\t\treturn true;\n\t\t} catch (error) {\n\t\t\tconsole.error(\"[ProfitStars] Webhook verification error:\", error);\n\t\t\treturn false;\n\t\t}\n\t}\n}\n"],"names":[],"mappings":"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"}