module.exports=[162803,a=>{"use strict";var b=a.i(780195),c=a.i(136874);async function d(a,b={}){let e=await (0,c.createClient)();if(!e)return{sms:[],total:0,hasMore:!1};let{limit:f=50,offset:g=0,type:h="all",folder:i,label:j,search:k,sortBy:l="created_at",sortOrder:m="desc"}=b,n=e.from("communications").select(`
			id,
			from_address,
			from_name,
			to_address,
			body,
			body_html,
			created_at,
			read_at,
			direction,
			customer_id,
			customer:customers!left(id, first_name, last_name, display_name, email, phone, company_name),
			sent_at,
			delivered_at,
			status,
			channel,
			provider_metadata,
			is_archived,
			snoozed_until,
			category,
			tags,
			telnyx_message_id
		`,{count:"exact"}).eq("company_id",a).eq("type","sms");if(i)switch(i){case"inbox":n=n.eq("direction","inbound").eq("is_archived",!1).is("deleted_at",null).or("snoozed_until.is.null,snoozed_until.lt.now()");break;case"sent":n=n.eq("direction","outbound").eq("is_archived",!1).is("deleted_at",null);break;case"archive":n=n.eq("is_archived",!0).is("deleted_at",null);break;case"trash":case"bin":n=n.not("deleted_at","is",null);break;default:n=n.is("deleted_at",null)}else n=n.is("deleted_at",null);if("sent"===h?n=n.eq("direction","outbound"):"received"===h&&(n=n.eq("direction","inbound")),k){let a=k.toLowerCase();n=n.or(`from_address.ilike.%${a}%,to_address.ilike.%${a}%,body.ilike.%${a}%`)}let o="asc"===m;n=(n="sent_at"===l?n.order("sent_at",{ascending:o,nullsFirst:!1}):n.order("created_at",{ascending:o})).range(g,g+f-1);let{data:p,error:q,count:r}=await n;if(q)return console.error("Error fetching SMS messages:",q),{sms:[],total:0,hasMore:!1};let s=(p||[]).map(a=>({...a,tags:a.tags||null,provider_metadata:a.provider_metadata||null})),t=j||i;if(t&&!["inbox","sent","archive","trash","bin"].includes(t))return{sms:s=s.filter(a=>{let b=a.tags||[];return Array.isArray(b)&&b.includes(t)}),total:s.length,hasMore:!1};let u=r||0,v=g+s.length<u;return{sms:s,total:u,hasMore:v}}async function e(a,b){let d=await (0,c.createClient)();if(!d)return null;let{data:e,error:f}=await d.from("communications").select(`
			id,
			from_address,
			from_name,
			to_address,
			body,
			body_html,
			created_at,
			read_at,
			direction,
			customer_id,
			customer:customers!left(id, first_name, last_name, display_name, email, phone, company_name),
			sent_at,
			delivered_at,
			status,
			channel,
			provider_metadata,
			is_archived,
			snoozed_until,
			category,
			tags,
			telnyx_message_id
		`).eq("id",b).eq("company_id",a).eq("type","sms").single();return f||!e?null:{...e,tags:e.tags||null,provider_metadata:e.provider_metadata||null}}async function f(a,b){let d=await (0,c.createClient)();if(!d)return console.error("❌ markSmsAsRead: Missing supabase"),!1;let e=new Date().toISOString(),{data:f,error:g}=await d.from("communications").update({read_at:e}).eq("id",b).eq("company_id",a).eq("type","sms").select("id, read_at").single();return g?(console.error("❌ markSmsAsRead error:",g),!1):!!f||(console.error("❌ markSmsAsRead: No data returned"),!1)}async function g(a,b){let d,e=await (0,c.createClient)();if(!e)return!1;let f=11===(d=b.replace(/[^0-9]/g,"")).length&&d.startsWith("1")?`+${d}`:10===d.length?`+1${d}`:b.startsWith("+")?b:`+${b}`,g=new Date().toISOString(),{data:h,error:i}=await e.from("communications").update({read_at:g}).eq("company_id",a).eq("type","sms").eq("direction","inbound").is("read_at",null).is("deleted_at",null).or(`from_address.eq.${f},to_address.eq.${f}`).select("id, read_at");return!i||(console.error("❌ markSmsConversationAsRead error:",i),!1)}var h=a.i(146057),i=a.i(395731);let j=h.z.object({limit:h.z.coerce.number().min(1).max(500).optional().default(50),offset:h.z.coerce.number().min(0).optional().default(0),type:h.z.enum(["sent","received","all"]).optional().default("all"),folder:h.z.enum(["inbox","sent","archive","trash","bin"]).optional(),label:h.z.string().optional(),search:h.z.string().optional().nullable(),sortBy:h.z.enum(["created_at","sent_at"]).optional().default("created_at"),sortOrder:h.z.enum(["asc","desc"]).optional().default("desc")}).passthrough(),k=h.z.object({smsId:h.z.string().min(1)});async function l(b){try{let c=j.safeParse(b);if(!c.success)throw Error(`Invalid input parameters: ${c.error.errors.map(a=>`${a.path.join(".")}: ${a.message}`).join(", ")}`);let e=c.data,{getActiveCompanyId:f}=await a.A(37652),g=await f();if(!g)throw Error("No active company found");return await d(g,e)}catch(a){throw console.error("❌ getSmsAction error:",a),a}}async function m(b){try{let{getActiveCompanyId:c}=await a.A(37652),d=await c();if(!d)return{success:!1,error:"No active company found"};let f=await e(d,b);if(!f)return{success:!1,error:"SMS not found"};return{success:!0,sms:f}}catch(a){return console.error("Error getting SMS by ID:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function n(b){try{let c=k.parse(b),{getActiveCompanyId:d}=await a.A(37652),e=await d();if(!e)throw Error("Invalid input parameters");return await f(e,c.smsId)}catch(a){if(a instanceof h.z.ZodError)throw Error("Invalid input parameters");throw a}}async function o(b){try{let{getActiveCompanyId:c}=await a.A(37652),d=await c();if(!d)return{success:!1,error:"No active company found"};return{success:await g(d,b)}}catch(a){return console.error("Error marking SMS conversation as read:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function p(b){try{let{getSmsConversation:c}=await a.A(467914),{getActiveCompanyId:d}=await a.A(37652),e=await d();if(!e)return{success:!1,error:"No active company found"};let f=await c(e,b);return{success:!0,messages:f}}catch(a){if(console.error("Error fetching SMS conversation:",a),a instanceof Error&&a.message.includes("cookies"))return{success:!1,error:"Request context not available. Please refresh the page."};return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function q(){try{let{createClient:b}=await a.A(710933),{getActiveCompanyId:c}=await a.A(37652),d=await c();if(!d)return{success:!1,error:"No active company found"};let e=await b();if(!e)return{success:!1,error:"Database connection failed"};let f=e.from("communications").select("*",{count:"exact",head:!0}).eq("company_id",d).eq("type","sms"),[g,h,i,j]=await Promise.all([f.eq("direction","inbound").eq("is_archived",!1).is("deleted_at",null).or("snoozed_until.is.null,snoozed_until.lt.now()"),f.eq("direction","outbound").eq("is_archived",!1).is("deleted_at",null),f.eq("is_archived",!0).is("deleted_at",null),f.not("deleted_at","is",null)]),k={inbox:g.count||0,sent:h.count||0,archive:i.count||0,trash:j.count||0};return{success:!0,counts:k}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function r(b){try{let{getActiveCompanyId:c}=await a.A(37652),d=await c();if(!d)return{success:!1,error:"No active company found"};let{createClient:e}=await a.A(710933),f=await e();if(!f)return{success:!1,error:"Database connection failed"};let g=[];for(let a of b){let b=a.name.split(".").pop(),c=`${Date.now()}-${Math.random().toString(36).substring(7)}.${b}`,e=`${d}/sms-attachments/${c}`,h=await a.arrayBuffer(),{data:i,error:j}=await f.storage.from("company-files").upload(e,h,{contentType:a.type,upsert:!1});if(j)return console.error("Upload error:",j),{success:!1,error:`Failed to upload ${a.name}: ${j.message}`};let{data:{publicUrl:k}}=f.storage.from("company-files").getPublicUrl(e);g.push(k)}return{success:!0,urls:g}}catch(a){return console.error("Error uploading SMS attachments:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function s(){try{let{getActiveCompany:b}=await a.A(37652),c=await b();if(!c)return{success:!1,error:"No active company found"};return{success:!0,context:{companyName:c.name,companyPhone:c.phone||void 0,companyEmail:c.email||void 0}}}catch(a){return console.error("Error getting company context:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}(0,i.ensureServerEntryExports)([l,m,n,o,p,q,r,s]),(0,b.registerServerReference)(l,"401da60f1a9391a303a1b16907796e4c0f50d69f2e",null),(0,b.registerServerReference)(m,"4044b52e9024b2d9706a0fecdc03f2b79b2581d95f",null),(0,b.registerServerReference)(n,"40b400ebd66fa044553037f011b7b9f79ac7991a54",null),(0,b.registerServerReference)(o,"40955555a6fefc5cd6fcbb13dbbda08c03e7c12997",null),(0,b.registerServerReference)(p,"40641943d0d58e4efdbd5a78b4dee1f49227c7ed47",null),(0,b.registerServerReference)(q,"0006f7bd89b72f0836ec7bf4db73019f1b32e6c24a",null),(0,b.registerServerReference)(r,"404c132f24569b4f654af19a6a5cb46969dc24f12a",null),(0,b.registerServerReference)(s,"00ac96dc81c57c5c0b6ef948993077a34552967467",null),a.s(["getCompanyContextAction",()=>s,"getSmsAction",()=>l,"getSmsByIdAction",()=>m,"getSmsConversationAction",()=>p,"getSmsFolderCountsAction",()=>q,"markSmsAsReadAction",()=>n,"markSmsConversationAsReadAction",()=>o,"uploadSmsAttachments",()=>r],162803)},366398,a=>{"use strict";var b=a.i(780195),c=a.i(218188),d=a.i(146057);a.i(467361);var e=a.i(445074),f=a.i(818944),g=a.i(974406),h=a.i(136874),i=a.i(395731);let j=/APT-(\d+)/,k=async()=>{let a=await (0,h.createClient)();if(!a)throw new f.ActionError("Database connection failed",f.ERROR_CODES.DB_CONNECTION_ERROR);return a},l=d.z.object({customerId:d.z.string().uuid("Invalid customer ID"),propertyId:d.z.string().uuid("Invalid property ID").optional(),jobId:d.z.string().uuid("Invalid job ID").optional(),assignedTo:d.z.string().uuid("Invalid user ID").optional(),title:d.z.string().min(1,"Appointment title is required"),description:d.z.string().optional(),category:d.z.enum(["job_appointment","estimate_appointment","event","meeting","follow_up","recurring_service"]).default("job_appointment"),type:d.z.enum(["service_call","installation","maintenance","inspection","repair","estimate","follow_up","winterization","emergency"]).optional(),priority:d.z.enum(["low","normal","high","urgent"]).default("normal"),scheduledStart:d.z.string().min(1,"Start time is required"),scheduledEnd:d.z.string().min(1,"End time is required"),notes:d.z.string().optional(),travelTimeMinutes:d.z.number().int().min(0).optional()});async function m(a,b){let{data:c,error:d}=await a.rpc("generate_appointment_number",{p_company_id:b});if(d||!c){let{data:c}=await a.from("appointments").select("appointment_number").eq("company_id",b).order("created_at",{ascending:!1}).limit(1).single();if(!c)return"APT-000001";let d=c.appointment_number.match(j);if(d){let a=Number.parseInt(d[1],10)+1;return`APT-${a.toString().padStart(6,"0")}`}return`APT-${Date.now().toString().slice(-6)}`}return c}async function n(a){return await (0,g.withErrorHandling)(async()=>{var b,d;let h,i=await k(),{data:{user:j}}=await i.auth.getUser();(0,g.assertAuthenticated)(j?.id);let n=await (0,e.getActiveCompanyId)();(0,g.assertExists)(n,"Company not found for user");let o={customerId:a.get("customerId"),propertyId:a.get("propertyId")||void 0,jobId:a.get("jobId")||void 0,assignedTo:a.get("assignedTo")||void 0,title:a.get("title"),description:a.get("description")||void 0,category:a.get("category")||"job_appointment",type:a.get("type")||void 0,priority:a.get("priority")||"normal",scheduledStart:a.get("scheduledStart"),scheduledEnd:a.get("scheduledEnd"),notes:a.get("notes")||void 0,travelTimeMinutes:a.get("travelTimeMinutes")?Number.parseInt(a.get("travelTimeMinutes"),10):void 0},p=l.parse(o);!function(a,b){let c=new Date(a);if(new Date(b)<=c)throw new f.ActionError("End time must be after start time",f.ERROR_CODES.VALIDATION_FAILED);if(c<new Date)throw new f.ActionError("Cannot schedule appointments in the past",f.ERROR_CODES.VALIDATION_FAILED)}(p.scheduledStart,p.scheduledEnd);let q=(b=p.scheduledStart,d=p.scheduledEnd,h=new Date(b),Math.round((new Date(d).getTime()-h.getTime())/6e4)),r=await m(i,n),{data:s,error:t}=await i.from("appointments").insert({company_id:n,customer_id:p.customerId,property_id:p.propertyId,job_id:p.jobId,assigned_to:p.assignedTo,appointment_number:r,title:p.title,description:p.description,category:p.category,type:p.type,priority:p.priority,scheduled_start:p.scheduledStart,scheduled_end:p.scheduledEnd,duration_minutes:q,notes:p.notes,travel_time_minutes:p.travelTimeMinutes,status:"scheduled",created_by:j.id}).select("id").single();if(t)throw new f.ActionError(`Failed to create appointment: ${t.message}`,f.ERROR_CODES.DB_QUERY_ERROR);return(0,c.revalidatePath)("/dashboard/work/appointments"),(0,c.revalidatePath)("/dashboard/schedule"),p.jobId&&(0,c.revalidatePath)(`/dashboard/work/${p.jobId}`),s.id})}async function o(a){return await (0,g.withErrorHandling)(async()=>{let b=await k(),{data:{user:c}}=await b.auth.getUser();(0,g.assertAuthenticated)(c?.id);let d=await (0,e.getActiveCompanyId)();(0,g.assertExists)(d,"Company not found for user");let h=new Date().toISOString(),{error:i}=await b.from("appointments").update({archived_at:h,deleted_at:h,deleted_by:c.id,status:"cancelled"}).eq("id",a).eq("company_id",d);if(i)throw new f.ActionError(`Failed to archive appointment: ${i.message}`,f.ERROR_CODES.DB_QUERY_ERROR);return!0})}d.z.object({title:d.z.string().min(1,"Appointment title is required").optional(),description:d.z.string().optional(),status:d.z.enum(["scheduled","confirmed","in_progress","completed","cancelled","no_show","rescheduled"]).optional(),type:d.z.enum(["service","consultation","estimate","follow_up","maintenance","emergency","inspection"]).optional(),priority:d.z.enum(["low","normal","high","urgent"]).optional(),scheduledStart:d.z.string().optional(),scheduledEnd:d.z.string().optional(),actualStart:d.z.string().optional(),actualEnd:d.z.string().optional(),assignedTo:d.z.string().uuid("Invalid user ID").optional().nullable(),notes:d.z.string().optional(),cancellationReason:d.z.string().optional()}),d.z.object({scheduledStart:d.z.string().min(1,"Start time is required"),scheduledEnd:d.z.string().min(1,"End time is required"),reason:d.z.string().optional()}),(0,i.ensureServerEntryExports)([n,o]),(0,b.registerServerReference)(n,"40f01c38bcd0dedd8819f5121a098e2ffd43eb6e19",null),(0,b.registerServerReference)(o,"4011aa566ca79fb24d9075e5c8afddde5f0ff63c2c",null),a.s(["archiveAppointment",()=>o,"createAppointment",()=>n])},769989,a=>{a.v(b=>Promise.all(["server/chunks/ssr/[root-of-the-server]__f6c731fd._.js","server/chunks/ssr/3c0ae_next_dist_compiled_d01f76b2._.js"].map(b=>a.l(b))).then(()=>b(227185)))},642757,a=>{a.v(a=>Promise.resolve().then(()=>a(149664)))},315292,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_email_email-tracking_ts_73b89830._.js"].map(b=>a.l(b))).then(()=>b(582891)))},449334,a=>{a.v(a=>Promise.resolve().then(()=>a(343860)))},37652,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_auth_company-context_ts_732d588b._.js"].map(b=>a.l(b))).then(()=>b(480513)))},710933,a=>{a.v(a=>Promise.resolve().then(()=>a(136874)))},463923,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_email_resend-domains_ts_fb6b2c6f._.js"].map(b=>a.l(b))).then(()=>b(73130)))},707466,a=>{a.v(a=>Promise.resolve().then(()=>a(933427)))},593976,a=>{a.v(a=>Promise.resolve().then(()=>a(198114)))},841477,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_emails_plain-text-email_tsx_5acac822._.js"].map(b=>a.l(b))).then(()=>b(917126)))},365581,a=>{a.v(a=>Promise.resolve().then(()=>a(869251)))},612244,a=>{a.v(a=>Promise.resolve().then(()=>a(918448)))},115593,a=>{a.v(a=>Promise.resolve().then(()=>a(111732)))},520183,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_ai_memory-service_ts_be9d7ea7._.js"].map(b=>a.l(b))).then(()=>b(294670)))},329699,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_services_weather-service_ts_313b9cab._.js"].map(b=>a.l(b))).then(()=>b(728951)))},809861,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_services_traffic-service_ts_a210ff55._.js"].map(b=>a.l(b))).then(()=>b(46443)))},404530,a=>{a.v(a=>Promise.resolve().then(()=>a(81441)))},420584,a=>{a.v(a=>Promise.resolve().then(()=>a(928660)))},467914,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_sms_sms-service_ts_617021c0._.js"].map(b=>a.l(b))).then(()=>b(227967)))}];

//# sourceMappingURL=_9f3f2e22._.js.map