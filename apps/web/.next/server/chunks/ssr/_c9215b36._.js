module.exports=[162803,a=>{"use strict";var b=a.i(780195),c=a.i(136874);async function d(a,b={}){let e=await (0,c.createClient)();if(!e)return{sms:[],total:0,hasMore:!1};let{limit:f=50,offset:g=0,type:h="all",folder:i,label:j,search:k,sortBy:l="created_at",sortOrder:m="desc"}=b,n=e.from("communications").select(`
			id,
			from_address,
			from_name,
			to_address,
			body,
			body_html,
			created_at,
			read_at,
			direction,
			customer_id,
			customer:customers!left(id, first_name, last_name, display_name, email, phone, company_name),
			sent_at,
			delivered_at,
			status,
			channel,
			provider_metadata,
			is_archived,
			snoozed_until,
			category,
			tags,
			telnyx_message_id
		`,{count:"exact"}).eq("company_id",a).eq("type","sms");if(i)switch(i){case"inbox":n=n.eq("direction","inbound").eq("is_archived",!1).is("deleted_at",null).or("snoozed_until.is.null,snoozed_until.lt.now()");break;case"sent":n=n.eq("direction","outbound").eq("is_archived",!1).is("deleted_at",null);break;case"archive":n=n.eq("is_archived",!0).is("deleted_at",null);break;case"trash":case"bin":n=n.not("deleted_at","is",null);break;default:n=n.is("deleted_at",null)}else n=n.is("deleted_at",null);if("sent"===h?n=n.eq("direction","outbound"):"received"===h&&(n=n.eq("direction","inbound")),k){let a=k.toLowerCase();n=n.or(`from_address.ilike.%${a}%,to_address.ilike.%${a}%,body.ilike.%${a}%`)}let o="asc"===m;n=(n="sent_at"===l?n.order("sent_at",{ascending:o,nullsFirst:!1}):n.order("created_at",{ascending:o})).range(g,g+f-1);let{data:p,error:q,count:r}=await n;if(q)return console.error("Error fetching SMS messages:",q),{sms:[],total:0,hasMore:!1};let s=(p||[]).map(a=>({...a,tags:a.tags||null,provider_metadata:a.provider_metadata||null})),t=j||i;if(t&&!["inbox","sent","archive","trash","bin"].includes(t))return{sms:s=s.filter(a=>{let b=a.tags||[];return Array.isArray(b)&&b.includes(t)}),total:s.length,hasMore:!1};let u=r||0,v=g+s.length<u;return{sms:s,total:u,hasMore:v}}async function e(a,b){let d=await (0,c.createClient)();if(!d)return null;let{data:e,error:f}=await d.from("communications").select(`
			id,
			from_address,
			from_name,
			to_address,
			body,
			body_html,
			created_at,
			read_at,
			direction,
			customer_id,
			customer:customers!left(id, first_name, last_name, display_name, email, phone, company_name),
			sent_at,
			delivered_at,
			status,
			channel,
			provider_metadata,
			is_archived,
			snoozed_until,
			category,
			tags,
			telnyx_message_id
		`).eq("id",b).eq("company_id",a).eq("type","sms").single();return f||!e?null:{...e,tags:e.tags||null,provider_metadata:e.provider_metadata||null}}async function f(a,b){let d=await (0,c.createClient)();if(!d)return console.error("❌ markSmsAsRead: Missing supabase"),!1;let e=new Date().toISOString(),{data:f,error:g}=await d.from("communications").update({read_at:e}).eq("id",b).eq("company_id",a).eq("type","sms").select("id, read_at").single();return g?(console.error("❌ markSmsAsRead error:",g),!1):!!f||(console.error("❌ markSmsAsRead: No data returned"),!1)}async function g(a,b){let d,e=await (0,c.createClient)();if(!e)return!1;let f=11===(d=b.replace(/[^0-9]/g,"")).length&&d.startsWith("1")?`+${d}`:10===d.length?`+1${d}`:b.startsWith("+")?b:`+${b}`,g=new Date().toISOString(),{data:h,error:i}=await e.from("communications").update({read_at:g}).eq("company_id",a).eq("type","sms").eq("direction","inbound").is("read_at",null).is("deleted_at",null).or(`from_address.eq.${f},to_address.eq.${f}`).select("id, read_at");return!i||(console.error("❌ markSmsConversationAsRead error:",i),!1)}var h=a.i(146057),i=a.i(395731);let j=h.z.object({limit:h.z.coerce.number().min(1).max(500).optional().default(50),offset:h.z.coerce.number().min(0).optional().default(0),type:h.z.enum(["sent","received","all"]).optional().default("all"),folder:h.z.enum(["inbox","sent","archive","trash","bin"]).optional(),label:h.z.string().optional(),search:h.z.string().optional().nullable(),sortBy:h.z.enum(["created_at","sent_at"]).optional().default("created_at"),sortOrder:h.z.enum(["asc","desc"]).optional().default("desc")}).passthrough(),k=h.z.object({smsId:h.z.string().min(1)});async function l(b){try{let c=j.safeParse(b);if(!c.success)throw Error(`Invalid input parameters: ${c.error.errors.map(a=>`${a.path.join(".")}: ${a.message}`).join(", ")}`);let e=c.data,{getActiveCompanyId:f}=await a.A(37652),g=await f();if(!g)throw Error("No active company found");return await d(g,e)}catch(a){throw console.error("❌ getSmsAction error:",a),a}}async function m(b){try{let{getActiveCompanyId:c}=await a.A(37652),d=await c();if(!d)return{success:!1,error:"No active company found"};let f=await e(d,b);if(!f)return{success:!1,error:"SMS not found"};return{success:!0,sms:f}}catch(a){return console.error("Error getting SMS by ID:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function n(b){try{let c=k.parse(b),{getActiveCompanyId:d}=await a.A(37652),e=await d();if(!e)throw Error("Invalid input parameters");return await f(e,c.smsId)}catch(a){if(a instanceof h.z.ZodError)throw Error("Invalid input parameters");throw a}}async function o(b){try{let{getActiveCompanyId:c}=await a.A(37652),d=await c();if(!d)return{success:!1,error:"No active company found"};return{success:await g(d,b)}}catch(a){return console.error("Error marking SMS conversation as read:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function p(b){try{let{getSmsConversation:c}=await a.A(467914),{getActiveCompanyId:d}=await a.A(37652),e=await d();if(!e)return{success:!1,error:"No active company found"};let f=await c(e,b);return{success:!0,messages:f}}catch(a){if(console.error("Error fetching SMS conversation:",a),a instanceof Error&&a.message.includes("cookies"))return{success:!1,error:"Request context not available. Please refresh the page."};return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function q(){try{let{createClient:b}=await a.A(710933),{getActiveCompanyId:c}=await a.A(37652),d=await c();if(!d)return{success:!1,error:"No active company found"};let e=await b();if(!e)return{success:!1,error:"Database connection failed"};let f=e.from("communications").select("*",{count:"exact",head:!0}).eq("company_id",d).eq("type","sms"),[g,h,i,j]=await Promise.all([f.eq("direction","inbound").eq("is_archived",!1).is("deleted_at",null).or("snoozed_until.is.null,snoozed_until.lt.now()"),f.eq("direction","outbound").eq("is_archived",!1).is("deleted_at",null),f.eq("is_archived",!0).is("deleted_at",null),f.not("deleted_at","is",null)]),k={inbox:g.count||0,sent:h.count||0,archive:i.count||0,trash:j.count||0};return{success:!0,counts:k}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function r(b){try{let{getActiveCompanyId:c}=await a.A(37652),d=await c();if(!d)return{success:!1,error:"No active company found"};let{createClient:e}=await a.A(710933),f=await e();if(!f)return{success:!1,error:"Database connection failed"};let g=[];for(let a of b){let b=a.name.split(".").pop(),c=`${Date.now()}-${Math.random().toString(36).substring(7)}.${b}`,e=`${d}/sms-attachments/${c}`,h=await a.arrayBuffer(),{data:i,error:j}=await f.storage.from("company-files").upload(e,h,{contentType:a.type,upsert:!1});if(j)return console.error("Upload error:",j),{success:!1,error:`Failed to upload ${a.name}: ${j.message}`};let{data:{publicUrl:k}}=f.storage.from("company-files").getPublicUrl(e);g.push(k)}return{success:!0,urls:g}}catch(a){return console.error("Error uploading SMS attachments:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function s(){try{let{getActiveCompany:b}=await a.A(37652),c=await b();if(!c)return{success:!1,error:"No active company found"};return{success:!0,context:{companyName:c.name,companyPhone:c.phone||void 0,companyEmail:c.email||void 0}}}catch(a){return console.error("Error getting company context:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}(0,i.ensureServerEntryExports)([l,m,n,o,p,q,r,s]),(0,b.registerServerReference)(l,"401da60f1a9391a303a1b16907796e4c0f50d69f2e",null),(0,b.registerServerReference)(m,"4044b52e9024b2d9706a0fecdc03f2b79b2581d95f",null),(0,b.registerServerReference)(n,"40b400ebd66fa044553037f011b7b9f79ac7991a54",null),(0,b.registerServerReference)(o,"40955555a6fefc5cd6fcbb13dbbda08c03e7c12997",null),(0,b.registerServerReference)(p,"40641943d0d58e4efdbd5a78b4dee1f49227c7ed47",null),(0,b.registerServerReference)(q,"0006f7bd89b72f0836ec7bf4db73019f1b32e6c24a",null),(0,b.registerServerReference)(r,"404c132f24569b4f654af19a6a5cb46969dc24f12a",null),(0,b.registerServerReference)(s,"00ac96dc81c57c5c0b6ef948993077a34552967467",null),a.s(["getCompanyContextAction",()=>s,"getSmsAction",()=>l,"getSmsByIdAction",()=>m,"getSmsConversationAction",()=>p,"getSmsFolderCountsAction",()=>q,"markSmsAsReadAction",()=>n,"markSmsConversationAsReadAction",()=>o,"uploadSmsAttachments",()=>r],162803)},305145,a=>{"use strict";var b=a.i(780195),c=a.i(869251),d=a.i(136874);async function e(a,b=72,f=1){try{let e=await (0,d.createClient)();if(!e)return null;let{data:g,error:h}=await e.rpc("generate_invoice_payment_token",{p_invoice_id:a,p_expiry_hours:b,p_max_uses:f});if(h||!g||0===g.length)return null;let i=g[0],j=`${c.emailConfig.appUrl}/pay/${a}?token=${i.token}`;return{token:i.token,expiresAt:i.expires_at,paymentLink:j}}catch(a){return null}}async function f(a,b){try{let b=await (0,d.createClient)();if(!b)return{isValid:!1,invoiceId:null,message:"Unable to connect to database"};let{data:c,error:e}=await b.rpc("check_payment_token",{p_token:a});if(e||!c||0===c.length)return{isValid:!1,invoiceId:null,message:"Invalid payment token"};let f=c[0];return{isValid:f.is_valid,invoiceId:f.invoice_id,message:f.message}}catch(a){return{isValid:!1,invoiceId:null,message:"Error validating payment token"}}}async function g(a,b){try{let c=await (0,d.createClient)();if(!c)return!1;let{data:e,error:f}=await c.from("invoice_payment_tokens").select("use_count").eq("token",a).limit(1);if(f||!e||0===e.length)return!1;let g=e[0]?.use_count??0,{error:h}=await c.from("invoice_payment_tokens").update({is_active:!1,used_at:new Date().toISOString(),used_by_ip:b||null,use_count:g+1}).eq("token",a);if(h)return!1;return!0}catch(a){return!1}}async function h(a,b=72,e=1){try{let f=await (0,d.createClient)();if(!f)return{};let g=a.map(async a=>{let{data:d,error:g}=await f.rpc("generate_invoice_payment_token",{p_invoice_id:a,p_expiry_hours:b,p_max_uses:e});if(g||!d||0===d.length)return{invoiceId:a,token:null};let h=d[0],i=`${c.emailConfig.appUrl}/pay/${a}?token=${h.token}`;return{invoiceId:a,token:{token:h.token,expiresAt:h.expires_at,paymentLink:i}}});return(await Promise.all(g)).reduce((a,{invoiceId:b,token:c})=>(c&&(a[b]=c),a),{})}catch(a){return{}}}(0,a.i(395731).ensureServerEntryExports)([e,f,g,h]),(0,b.registerServerReference)(e,"7026bc9768ad3ab0b96efecd8a3b9c44d5e7e57eba",null),(0,b.registerServerReference)(f,"608ae817ddec034f2780624908f1db97356ccd42ef",null),(0,b.registerServerReference)(g,"6048aff7615b24bbed5fff047d510e54bb65e77646",null),(0,b.registerServerReference)(h,"709bb1978cd77dad33a458251234f8c68f743d5f4c",null),a.s(["generatePaymentToken",()=>e,"generatePaymentTokensBatch",()=>h,"markTokenAsUsed",()=>g,"validatePaymentToken",()=>f])},382865,118489,208768,a=>{"use strict";let b=Symbol.for("constructDateFrom");function c(a,c){return"function"==typeof a?a(c):a&&"object"==typeof a&&b in a?a[b](c):a instanceof Date?new a.constructor(c):new Date(c)}function d(a,b){return c(b||a,a)}a.s(["constructFromSymbol",0,b,"millisecondsInDay",0,864e5,"millisecondsInWeek",0,6048e5,"minutesInDay",0,1440,"minutesInMonth",0,43200],118489),a.s(["constructFrom",()=>c],208768),a.s(["toDate",()=>d],382865)},102688,26291,359732,770414,a=>{"use strict";let b={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}};function c(a){return (b={})=>{let c=b.width?String(b.width):a.defaultWidth;return a.formats[c]||a.formats[a.defaultWidth]}}let d={date:c({formats:{full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},defaultWidth:"full"}),time:c({formats:{full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},defaultWidth:"full"}),dateTime:c({formats:{full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},defaultWidth:"full"})},e={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"};function f(a){return(b,c)=>{let d;if("formatting"===(c?.context?String(c.context):"standalone")&&a.formattingValues){let b=a.defaultFormattingWidth||a.defaultWidth,e=c?.width?String(c.width):b;d=a.formattingValues[e]||a.formattingValues[b]}else{let b=a.defaultWidth,e=c?.width?String(c.width):a.defaultWidth;d=a.values[e]||a.values[b]}return d[a.argumentCallback?a.argumentCallback(b):b]}}let g={ordinalNumber:(a,b)=>{let c=Number(a),d=c%100;if(d>20||d<10)switch(d%10){case 1:return c+"st";case 2:return c+"nd";case 3:return c+"rd"}return c+"th"},era:f({values:{narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},defaultWidth:"wide"}),quarter:f({values:{narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},defaultWidth:"wide",argumentCallback:a=>a-1}),month:f({values:{narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},defaultWidth:"wide"}),day:f({values:{narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},defaultWidth:"wide"}),dayPeriod:f({values:{narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},defaultWidth:"wide",formattingValues:{narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},defaultFormattingWidth:"wide"})};function h(a){return(b,c={})=>{let d,e=c.width,f=e&&a.matchPatterns[e]||a.matchPatterns[a.defaultMatchWidth],g=b.match(f);if(!g)return null;let h=g[0],i=e&&a.parsePatterns[e]||a.parsePatterns[a.defaultParseWidth],j=Array.isArray(i)?function(a,b){for(let c=0;c<a.length;c++)if(b(a[c]))return c}(i,a=>a.test(h)):function(a,b){for(let c in a)if(Object.prototype.hasOwnProperty.call(a,c)&&b(a[c]))return c}(i,a=>a.test(h));return d=a.valueCallback?a.valueCallback(j):j,{value:d=c.valueCallback?c.valueCallback(d):d,rest:b.slice(h.length)}}}let i={ordinalNumber:(l={matchPattern:/^(\d+)(th|st|nd|rd)?/i,parsePattern:/\d+/i,valueCallback:a=>parseInt(a,10)},(a,b={})=>{let c=a.match(l.matchPattern);if(!c)return null;let d=c[0],e=a.match(l.parsePattern);if(!e)return null;let f=l.valueCallback?l.valueCallback(e[0]):e[0];return{value:f=b.valueCallback?b.valueCallback(f):f,rest:a.slice(d.length)}}),era:h({matchPatterns:{narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},defaultMatchWidth:"wide",parsePatterns:{any:[/^b/i,/^(a|c)/i]},defaultParseWidth:"any"}),quarter:h({matchPatterns:{narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},defaultMatchWidth:"wide",parsePatterns:{any:[/1/i,/2/i,/3/i,/4/i]},defaultParseWidth:"any",valueCallback:a=>a+1}),month:h({matchPatterns:{narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},defaultMatchWidth:"wide",parsePatterns:{narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},defaultParseWidth:"any"}),day:h({matchPatterns:{narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},defaultMatchWidth:"wide",parsePatterns:{narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},defaultParseWidth:"any"}),dayPeriod:h({matchPatterns:{narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},defaultMatchWidth:"any",parsePatterns:{any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},defaultParseWidth:"any"})};a.s(["defaultLocale",0,{code:"en-US",formatDistance:(a,c,d)=>{let e,f=b[a];if(e="string"==typeof f?f:1===c?f.one:f.other.replace("{{count}}",c.toString()),d?.addSuffix)if(d.comparison&&d.comparison>0)return"in "+e;else return e+" ago";return e},formatLong:d,formatRelative:(a,b,c,d)=>e[a],localize:g,match:i,options:{weekStartsOn:0,firstWeekContainsDate:1}}],102688);let j={};function k(){return j}a.s(["getDefaultOptions",()=>k],26291);var l,m=a.i(382865);function n(a){let b=(0,m.toDate)(a),c=new Date(Date.UTC(b.getFullYear(),b.getMonth(),b.getDate(),b.getHours(),b.getMinutes(),b.getSeconds(),b.getMilliseconds()));return c.setUTCFullYear(b.getFullYear()),a-c}a.s(["getTimezoneOffsetInMilliseconds",()=>n],359732);var o=a.i(208768);function p(a,...b){let c=o.constructFrom.bind(null,a||b.find(a=>"object"==typeof a));return b.map(c)}a.s(["normalizeDates",()=>p],770414)},832265,a=>{"use strict";var b=a.i(780195);a.i(218188);var c=a.i(136874);async function d(){try{let a=await (0,c.createClient)();if(!a)return{success:!1,error:"Unable to connect to database"};let{data:{user:b}}=await a.auth.getUser();if(!b)return{success:!1,error:"Not authenticated"};let{data:d}=await a.from("company_memberships").select("company_id").eq("user_id",b.id).eq("status","active").limit(1).single();if(!d)return{success:!1,error:"No active company membership found"};let{data:e}=await a.from("communication_templates").select("subject, body, metadata").eq("company_id",d.company_id).eq("type","email").eq("category","invoice").eq("is_active",!0).maybeSingle();if(e)return{success:!0,data:{subject:e.subject||"",body:e.body||"",footer:e.metadata?.footer||""}};return{success:!0,data:{subject:"Invoice {{invoice_number}} from {{company_name}}",body:`Hi {{customer_name}},

Please find attached your invoice {{invoice_number}} for {{invoice_amount}}.

Payment is due by {{due_date}}.

You can securely pay your invoice online by clicking the link below:
{{payment_link}}

If you have any questions about this invoice, please contact us at {{company_email}} or {{company_phone}}.

Thank you for your business!

Best regards,
{{company_name}}`,footer:"This is an automated message. Please do not reply to this email."}}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to load template"}}}(0,a.i(395731).ensureServerEntryExports)([d]),(0,b.registerServerReference)(d,"00c90e29da67b2bf4dc222f6bea2e7e005b50d0b31",null),a.s(["loadInvoiceEmailTemplate",()=>d])},837627,a=>a.a(async(b,c)=>{try{var d=a.i(198114),e=b([d]);function f(a){return new Promise(b=>setTimeout(b,a))}async function g(a,b={}){let{batchSize:c=10,batchDelay:e=1e3,maxRetries:h=2,retryDelay:i=5e3}=b,j={total:a.length,successful:0,failed:0,results:[],allSuccessful:!1};for(let b=0;b<a.length;b+=c){let g=a.slice(b,b+c).map(async a=>{let b,c=0;for(;c<=h;){try{let e=await (0,d.sendEmail)({to:a.to,subject:a.subject,template:a.template,templateType:a.templateType,replyTo:a.replyTo,tags:[...a.tags||[],{name:"bulk_send",value:"true"},{name:"attempt",value:String(c+1)}]});if(e.success)return{to:a.to,itemId:a.itemId,success:!0,emailId:e.data?.id};b=e.error,c<h&&await f(i)}catch(a){b=a instanceof Error?a.message:"Unknown error",c<h&&await f(i)}c++}return{to:a.to,itemId:a.itemId,success:!1,error:b||"Failed to send after retries"}}),k=await Promise.all(g);for(let a of(j.results.push(...k),k))a.success?j.successful++:j.failed++;b+c<a.length&&await f(e)}return j.allSuccessful=0===j.failed,j}[d]=e.then?(await e)():e,a.s(["sendBulkEmails",()=>g]),c()}catch(a){c(a)}},!1),404309,a=>a.a(async(b,c)=>{try{var d=a.i(780195),e=a.i(254413),f=a.i(218188),g=a.i(832265),h=a.i(837627),i=a.i(463556);a.i(305145);var j=a.i(136874),k=a.i(395731),l=b([h]);[h]=l.then?(await l)():l;let o="http://localhost:3000",p={subject:"Invoice {{invoice_number}} from {{company_name}}",body:"Hi {{customer_name}},\n\nPlease find attached your invoice {{invoice_number}} for {{invoice_amount}}.\n\nPayment is due by {{due_date}}.\n\nYou can securely pay your invoice online:\n{{payment_link}}\n\nThank you!",footer:""};class q extends Error{userMessage;details;constructor(a,b){super(a),this.name="BulkSendError",this.userMessage=a,this.details=b}}async function m(a,b){try{let c=await r(),d=await s(c),e=await t(c,d.id),f=await u(c,a,e),g=v(f).filter(w);if(0===g.length)throw new q("No valid invoices to send","None of the selected invoices have customer email addresses");let[i,j]=await Promise.all([x(),y(c,e)]),k=await z({invoices:g,emailTemplate:i,company:j}),l=await (0,h.sendBulkEmails)(k,b),m=D(l);return m.length>0&&await E(c,m),F(m),{success:l.allSuccessful,message:G({results:l,total:f.length,valid:g.length}),results:l}}catch(a){return I("Failed to send invoices",a)}}let r=async()=>{let a=await (0,j.createClient)();if(!a)throw new q("Database connection failed","Unable to connect to database");return a},s=async a=>{let{data:{user:b}}=await a.auth.getUser();if(!b)throw new q("Authentication required","You must be logged in to send invoices");return b},t=async(a,b)=>{let{data:c,error:d}=await a.from("company_memberships").select("company_id").eq("user_id",b).eq("status","active").limit(1).single();if(d)throw new q("Failed to verify company membership",d.message);if(!c?.company_id)throw new q("Company association required","You must be part of a company to send invoices");return c.company_id},u=async(a,b,c)=>{let{data:d,error:e}=await a.from("invoices").select(`
        id,
        invoice_number,
        total_amount,
        status,
        company_id,
        customer_id,
        job_id,
        created_at,
        due_date,
        notes,
        customer:customers!customer_id(
          id,
          first_name,
          last_name,
          email,
          company_name
        )
      `).in("id",b).eq("company_id",c);if(e||!d)throw new q("Failed to fetch invoices",e?.message||"Unable to retrieve invoices");return d},v=a=>a.map(a=>{let b=a.customer,c=Array.isArray(b)?b[0]??null:b;return{...a,customer:c}}),w=a=>!!a.customer?.email,x=async()=>{let a=await (0,g.loadInvoiceEmailTemplate)();return a.success&&a.data?a.data:p},y=async(a,b)=>{let{data:c,error:d}=await a.from("companies").select("name, email, phone").eq("id",b).single();if(d)throw new q("Failed to load company profile",d.message);return c??null},z=async({invoices:b,emailTemplate:c,company:d})=>{let{InvoiceEmail:e}=await a.A(726079),{generatePaymentTokensBatch:f}=await a.A(994696),g=await f(b.map(a=>a.id),72,1);return b.map(a=>{let b=g[a.id]?.paymentLink||`${o}/pay/${encodeURIComponent(a.id)}`,f=A(a.customer),h={"{{customer_name}}":f,"{{invoice_number}}":a.invoice_number,"{{invoice_amount}}":B(a.total_amount),"{{due_date}}":C(a.due_date),"{{payment_link}}":b,"{{company_name}}":d?.name||"Company","{{company_email}}":d?.email||"","{{company_phone}}":d?.phone||""},j=c.subject,k=c.body,l=c.footer;for(let[a,b]of Object.entries(h)){let c=RegExp(a,"g");j=j.replace(c,b),k=k.replace(c,b),l=l.replace(c,b)}return{to:a.customer.email,subject:j,template:e({invoiceNumber:a.invoice_number,customerName:f,invoiceDate:a.created_at??new Date().toISOString(),dueDate:a.due_date??void 0,totalAmount:a.total_amount??0,notes:a.notes??void 0,invoiceUrl:`${o}/dashboard/work/invoices/${a.id}`,paymentLink:b,customBody:k,customFooter:l}),templateType:i.EmailTemplate.INVOICE,itemId:a.id,tags:[{name:"invoice_id",value:a.id},{name:"invoice_number",value:a.invoice_number},{name:"has_payment_link",value:"true"}]}})},A=a=>a?.company_name||`${a?.first_name??""} ${a?.last_name??""}`.trim()||"Valued Customer",B=a=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format((a??0)/100),C=a=>a?(0,e.format)(new Date(a),"MMMM dd, yyyy"):"Upon receipt",D=a=>(a.results??[]).filter(a=>!!a.itemId&&a.success).map(a=>a.itemId),E=async(a,b)=>{let{error:c}=await a.from("invoices").update({sent_at:new Date().toISOString(),status:"sent"}).in("id",b);if(c)throw new q("Failed to update invoice statuses",c.message)},F=a=>{for(let b of((0,f.revalidatePath)("/dashboard/work/invoices"),a))(0,f.revalidatePath)(`/dashboard/work/invoices/${b}`)},G=({results:a,total:b,valid:c})=>{let d=b-c,e=[`Successfully sent ${a.successful} invoice${1!==a.successful?"s":""}`];return a.failed>0&&e.push(`${a.failed} failed`),d>0&&e.push(`${d} skipped (no email)`),e.join(", ")},H=async b=>{let{EstimateEmail:c}=await a.A(726079);return b.map(a=>({to:a.customer.email,subject:`Estimate ${a.invoice_number}`,template:c({estimateNumber:a.invoice_number,customerName:A(a.customer),estimateDate:a.created_at??new Date().toISOString(),validUntil:a.due_date??void 0,totalAmount:a.total_amount??0,notes:a.notes??void 0,estimateUrl:`http://localhost:3000/dashboard/work/estimates/${a.id}`}),templateType:i.EmailTemplate.ESTIMATE,itemId:a.id,tags:[{name:"estimate_id",value:a.id},{name:"estimate_number",value:a.invoice_number}]}))},I=(a,b)=>b instanceof q?{success:!1,message:b.userMessage,error:b.details??b.userMessage}:{success:!1,message:a,error:b instanceof Error?b.message:"Unknown error"};async function n(a,b){try{let c=await r(),d=await s(c),e=await t(c,d.id),g=await u(c,a,e),i=v(g).filter(w);if(0===i.length)throw new q("No valid estimates to send","None of the selected estimates have customer email addresses");let j=await H(i),k=await (0,h.sendBulkEmails)(j,b),l=D(k);l.length>0&&await E(c,l);for(let a of((0,f.revalidatePath)("/dashboard/work/estimates"),l))(0,f.revalidatePath)(`/dashboard/work/estimates/${a}`);return{success:k.allSuccessful,message:(({results:a,total:b,valid:c})=>{let d=b-c,e=[`Successfully sent ${a.successful} estimate${1!==a.successful?"s":""}`];return a.failed>0&&e.push(`${a.failed} failed`),d>0&&e.push(`${d} skipped (no email)`),e.join(", ")})({results:k,total:g.length,valid:i.length}),results:k}}catch(a){return I("Failed to send estimates",a)}}(0,k.ensureServerEntryExports)([m,n]),(0,d.registerServerReference)(m,"6050e425a7385bd0b0f913f4694f52604f6bdbc4cf",null),(0,d.registerServerReference)(n,"60b18dc886c03a02ed84dd5d16db62590ebcf42ba1",null),a.s(["bulkSendEstimates",()=>n,"bulkSendInvoices",()=>m]),c()}catch(a){c(a)}},!1),790442,a=>a.a(async(b,c)=>{try{a.i(288344),a.i(285956),a.i(336176),a.i(933427),a.i(82608);var d=a.i(970552),e=a.i(765839),f=a.i(198114);a.i(103984),a.i(941771),a.i(854963),a.i(672766),a.i(404352);var g=a.i(304381);a.i(371603),a.i(396829),a.i(444057),a.i(910711);var h=a.i(571708);a.i(495405),a.i(417781),a.i(890375),a.i(162803);var i=a.i(514538),j=a.i(404309),k=b([d,e,f,g,h,i,j]);[d,e,f,g,h,i,j]=k.then?(await k)():k,a.s([]),c()}catch(a){c(a)}},!1),608672,a=>a.a(async(b,c)=>{try{var d=a.i(790442),e=a.i(288344),f=a.i(285956),g=a.i(336176),h=a.i(933427),i=a.i(82608),j=a.i(970552),k=a.i(765839),l=a.i(198114),m=a.i(103984),n=a.i(941771),o=a.i(854963),p=a.i(672766),q=a.i(404352),r=a.i(304381),s=a.i(371603),t=a.i(396829),u=a.i(444057),v=a.i(910711),w=a.i(571708),x=a.i(495405),y=a.i(417781),z=a.i(890375),A=a.i(162803),B=a.i(514538),C=a.i(404309),D=b([d,j,k,l,r,w,B,C]);[d,j,k,l,r,w,B,C]=D.then?(await D)():D,a.s(["000478fbf5363dae5000d525663da13e29908cb952",()=>g.getWebRTCCredentials,"0006f7bd89b72f0836ec7bf4db73019f1b32e6c24a",()=>A.getSmsFolderCountsAction,"000f90f949d6a2f5484d061d5a738a59a8c846aeaa",()=>x.getPendingSupportSessions,"001be5cf82b793f19f6a7d010c91c14577fa7a130d",()=>v.checkIsCompanyOwner,"001f005176797ef23488068124fb9a744915a477de",()=>e.getCurrentUserRole,"00235a0ba91f1ba226f33fa40dcf4c93a2c3548c70",()=>y.getEmailFoldersAction,"0043ae510c3322ea499beb9e1bb77d06afb4ef19bd",()=>r.signOut,"004cdde5e6ae8991bab4ba61ae40647c2b823200ba",()=>n.resetHourlyCounters,"00665c1bbcd52d612d5bb4bf3be5e7fc75554132e6",()=>x.getActiveSupportSessions,"006acf41615a2f7795c47b6d7a3016e18300f2ad17",()=>n.resetDailyCounters,"007505a78985e53e083a498c97761ed8a463d3d379",()=>j.checkTelnyxVerificationStatus,"0077abd0cb1e555f91adaa482ad0b2f565bbd0629a",()=>w.getCustomersForDialer,"009e962eae57bf128b2023081fd7259048edd8884a",()=>u.getEmailFolderCountsAction,"00a122f9d5fe3a1603c636c3a251886129b66154f8",()=>p.getProviderHealthDashboard,"00a13dbd00149949fc1367d3e76ae7d789e07f5321",()=>h.createServiceSupabaseClient,"00c53a1f02416c3261983f8096f19a3450bfd51775",()=>m.runHealthCheckForAllDomains,"00cf212b0097820096122537beac12e3403b97d564",()=>q.markAllAsRead,"00ebc03a4ffc993aea7ec2e541686105c2bace2437",()=>u.getTotalUnreadCountAction,"00fe74bdf14126b5ad89e9480e82978d6357f356b3",()=>o.isGmailIntegrationEnabled,"4002f454c46f4c21ca6e9e26362583ccff69c9f914",()=>g.transcribeCallRecording,"400a1d2ad802f64b4321ab5a1b846d7d38699e1447",()=>B.archiveEstimate,"400b8fb96146bfd004a3166563a5ab5536bb610c70",()=>m.getDomainHealth,"400ce95360aaffa14a99dfdf969ba5166c69a59eb6",()=>o.getUserGmailTokens,"4019cf9f81eb3c06f82b5c2f8eb042f3d95d91e933",()=>g.getCompanyPhoneNumbers,"401d3d830065dd7c4777fad67f642392f48735c4ab",()=>o.disconnectCompanyGmail,"40247c617842c31b242455a0961cbd2c3297606a16",()=>g.getCallRoutingRules,"4029b163c1c0acfd806352a72fe8030c8ae4f7f8ac",()=>n.incrementEmailCounter,"40369e8ea4eced7bdaef8203d369469ee7b630db8c",()=>x.endActiveSupportSession,"40413bfa888916480edbc33ebb812158fddf960f89",()=>g.updateCallRoutingRule,"404575d602ef4c60c0058b592b8c3e42fbcd13fc4c",()=>o.disconnectUserGmail,"404a3266e0319dbd8c24fec80bb69ecfe029d2a768",()=>z.searchVendors,"404d6f2891af89c71d5bde33d110a216bdd3ee4729",()=>m.recordDeliveryEvent,"404e47931374ad2a1b54bc11f357703790f6104530",()=>g.startCallRecording,"405a16958f97c37bd4b5711bd8761510bdab55839f",()=>g.transferActiveCall,"405c57a8fed352b8679525b56014eb8c49105c850c",()=>m.getCompanyDomainsHealth,"406864ae05b8b51c66cc2c335999e5011a41cb521f",()=>g.searchPhoneNumbers,"406f6624261c6dd1a908026fa1408a3f6d507b6e7d",()=>e.canDeleteTeamMember,"40704f0e856ad801ef93b43436f219a36f7c0efd2c",()=>f.getPayrixMerchantAccount,"40787b1598849126560f9f0b0f8fe8967338c7bf28",()=>o.getCompanyEmailProvider,"407a5a7d0a7dd7989a963eb2485a3527c1dcb20a70",()=>n.getCompanyActiveDomain,"4081009dd4dff14ff4ece62648bad23a83f2f9f63c",()=>t.updateUserStatus,"4082b52123c24a95685a53c36313418a95c259c65b",()=>w.deleteCustomer,"4087f0badccd6aaf6a28b640ab4bbc513f0832d105",()=>j.submitAutomatedVerification,"408d3694fd0dd48e424f53c9bf5083b946ab3ec990",()=>y.createEmailFolderAction,"4094cf679b4a10ca0f969f4fc1b55602aac4e0fbc3",()=>q.markAsRead,"4097c3c574342661f9a3c8244961d001234449f36f",()=>s.switchCompany,"40ad037af6f6ab1a3004746d3a1b65afa65527002d",()=>m.processResendWebhookEvent,"40ae25402a089e45aa071d979e8cc6ad136205cc98",()=>j.registerCompanyFor10DLC,"40af86a915f04df8d7cc189fe26e45e0cc24663080",()=>n.checkRateLimit,"40b2df540ec465c5dc19545c96486485bb50b5633b",()=>g.makeCall,"40beeb56302a20d27cd8ba7a0988310f855633d7e6",()=>o.getCompanyGmailTokens,"40c55f8e0922f2c7fd8d502e4c75395bf5f0470430",()=>y.deleteEmailFolderAction,"40c7885bdc4fe4cdd5f57e78579230c58088adbef4",()=>p.checkProviderAlert,"40d050abdabe2ee7293436c505c5f27b4408a2f27c",()=>g.sendTextMessage,"40d3c4ceeaee653aa257a28ed429a7fd272fa9fb66",()=>p.cleanupOldEvents,"40d5cc291162e2fd61245bdb851d5e8ed609e4ed19",()=>g.stopCallRecording,"40e06418f4b93b40c84a25511e0468e1e8a41ddecf",()=>p.recordProviderEvent,"40e2aa0d05076ccd3498ded44cdcc1b488052809cf",()=>B.unlinkJobFromEstimate,"40e9589cb639f2902eb841bedc1247d966486d6fd7",()=>v.getCompanyPendingActions,"40ecf2c792e84ef4b898fda98ec27277b4a9dddef2",()=>m.generateDeliverabilityReport,"40edd91786b2a482e617fb16f2474d26ec295435e7",()=>g.sendMMSMessage,"40f3ec53c0664a911f329a975c4b02ddbf55ef70c4",()=>B.unlinkEstimateFromJob,"40f8c061cf84f884e77af3425bc24b8a8d72f598fb",()=>l.sendEmail,"40fab1894acc5e3d1fdd8d8c6128a7cecee06e7e6a",()=>q.deleteNotification,"40fd6a80b32792fab749933f98f07503d8e94c0305",()=>g.purchasePhoneNumber,"6013add076e3eaed7dc37e8b800ce977d5abb8d49a",()=>w.getCustomerByPhone,"60193685409a9d118f1b364e14ecf57d05fa5638a9",()=>w.searchCustomers,"602e89ae7ace85fc30cd3b4b1dd865d517c0cb1cd5",()=>x.approveSupportSessionRequest,"602fab67313b110e6ccb66e54b1e16450b2a772cc7",()=>o.refreshUserGmailToken,"60302947fc4caffa53a719728f3c2cebace926098c",()=>o.sendCompanyGmailEmail,"603643b13bf288cc628303bb4d12df0311b11434c7",()=>o.syncUserInbox,"6045f8436f9cdfdadb7bfe3955677adfc5f4102de0",()=>l.handleComplaintWebhook,"6050e425a7385bd0b0f913f4694f52604f6bdbc4cf",()=>C.bulkSendInvoices,"606753f8910b46d5792f4bdeb457cdf29d1a8bbadc",()=>i.ensureMessagingBranding,"607d0f958daf66b2a0d5277cdda17600dace5156bb",()=>g.deleteCallRoutingRule,"60853f1e409364f7e171e27229217994ff224414e6",()=>g.toggleCallRoutingRule,"60856182db5eaec7f85eda2a5a94c5d7d3524325d6",()=>o.checkCompanyGmailHealth,"60886af124323873afd4d5b64bb4143abbcba2c154",()=>x.rejectSupportSessionRequest,"60b18dc886c03a02ed84dd5d16db62590ebcf42ba1",()=>C.bulkSendEstimates,"60c643a41ce1a8e6cc8338da6e2f3678c386910460",()=>p.getProviderStats,"60eeb51685ac265a4ad793a230a515fe6e462f16f4",()=>o.refreshCompanyGmailToken,"708daa303e36e37247e22b5b828b6aad8c73ac283b",()=>o.fetchUserInbox,"70a648f43fa62ae3dcf2070eb90413e96e81591e77",()=>i.ensureMessagingCampaign,"70dd3bc4222a87350dc137fa9cbcb849fa1913b397",()=>o.setCompanyEmailProvider,"70f58c5ba46ef02b620d7dc87bae8fc83f6d480755",()=>k.sendVerificationSubmittedEmail,"78255c3fa8c9facf7c3f353202f2907836e8eb5539",()=>p.recordSendFailure,"783861d25688b32ba086bbe9e45444975c36a1b285",()=>p.recordSendSuccess,"78766431b437b16f7cb00b4d64a2f3be5e092ed724",()=>p.recordFallbackTriggered,"78a8ea4f1cfa571a366adccf36ac04b1c85d61ae2b",()=>l.handleBounceWebhook,"78d41ef818e75fef94d65a87ea1f0faf418132e3c5",()=>o.storeGmailMessage,"7e3a356960ddd52a3fa4dc6d981ae7202a59eb9a3d",()=>o.storeUserGmailTokens,"7f06df826c4fff42950e712c0f548254e275be2a52",()=>o.storeCompanyGmailTokens]),c()}catch(a){c(a)}},!1),769989,a=>{a.v(b=>Promise.all(["server/chunks/ssr/[root-of-the-server]__f6c731fd._.js","server/chunks/ssr/3c0ae_next_dist_compiled_d01f76b2._.js"].map(b=>a.l(b))).then(()=>b(227185)))},642757,a=>{a.v(a=>Promise.resolve().then(()=>a(149664)))},315292,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_email_email-tracking_ts_73b89830._.js"].map(b=>a.l(b))).then(()=>b(582891)))},449334,a=>{a.v(a=>Promise.resolve().then(()=>a(343860)))},37652,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_auth_company-context_ts_732d588b._.js"].map(b=>a.l(b))).then(()=>b(480513)))},710933,a=>{a.v(a=>Promise.resolve().then(()=>a(136874)))},463923,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_email_resend-domains_ts_fb6b2c6f._.js"].map(b=>a.l(b))).then(()=>b(73130)))},707466,a=>{a.v(a=>Promise.resolve().then(()=>a(933427)))},593976,a=>{a.v(a=>Promise.resolve().then(()=>a(198114)))},841477,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_emails_plain-text-email_tsx_5acac822._.js"].map(b=>a.l(b))).then(()=>b(917126)))},365581,a=>{a.v(a=>Promise.resolve().then(()=>a(869251)))},612244,a=>{a.v(a=>Promise.resolve().then(()=>a(918448)))},115593,a=>{a.v(a=>Promise.resolve().then(()=>a(111732)))},520183,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_ai_memory-service_ts_be9d7ea7._.js"].map(b=>a.l(b))).then(()=>b(294670)))},329699,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_services_weather-service_ts_313b9cab._.js"].map(b=>a.l(b))).then(()=>b(728951)))},809861,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_services_traffic-service_ts_a210ff55._.js"].map(b=>a.l(b))).then(()=>b(46443)))},404530,a=>{a.v(a=>Promise.resolve().then(()=>a(81441)))},420584,a=>{a.v(a=>Promise.resolve().then(()=>a(928660)))},467914,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_sms_sms-service_ts_617021c0._.js"].map(b=>a.l(b))).then(()=>b(227967)))},538088,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_emails_templates_billing_estimate-sent_tsx_f7e3e348._.js"].map(b=>a.l(b))).then(()=>b(895040)))},726079,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_email_templates_ts_46a05501._.js"].map(b=>a.l(b))).then(()=>b(258017)))},994696,a=>{a.v(a=>Promise.resolve().then(()=>a(305145)))}];

//# sourceMappingURL=_c9215b36._.js.map