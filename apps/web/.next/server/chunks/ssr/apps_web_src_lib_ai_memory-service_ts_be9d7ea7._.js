module.exports=[294670,a=>{"use strict";var b=a.i(933427),c=a.i(254799);async function d(a){let b=process.env.OPENAI_API_KEY;if(b)try{let c=await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{Authorization:`Bearer ${b}`,"Content-Type":"application/json"},body:JSON.stringify({model:"text-embedding-3-small",input:a,dimensions:1536})});if(c.ok)return(await c.json()).data[0].embedding}catch(a){console.error("Failed to generate OpenAI embedding:",a)}let d=c.default.createHash("sha256").update(a).digest("hex"),e=[];for(let a=0;a<1536;a++){let b=d.charCodeAt(a%d.length);e.push((b/128-1)*Math.sin(a))}let f=Math.sqrt(e.reduce((a,b)=>a+b*b,0));return e.map(a=>a/f)}async function e(a,e,f){let g=(0,b.createServiceSupabaseClient)(),h=c.default.randomUUID(),i=await d(f.content),j=c.default.createHash("sha256").update(f.content).digest("hex"),{data:k}=await g.from("ai_memory").select("id").eq("company_id",a).eq("content_hash",j).maybeSingle();if(k)return await g.from("ai_memory").update({access_count:g.rpc("increment",{x:1}),last_accessed_at:new Date().toISOString()}).eq("id",k.id),k.id;let{error:l}=await g.from("ai_memory").insert({id:h,company_id:a,user_id:e,content:f.content,content_hash:j,memory_type:f.memoryType,scope:f.scope,entity_type:f.entityType,entity_id:f.entityId,source_message_id:f.sourceMessageId,source_chat_id:f.sourceChatId,embedding:i,importance:f.importance||.5,access_count:0,tags:f.tags||[],metadata:f.metadata||{},created_at:new Date().toISOString()});if(l)throw console.error("Failed to store memory:",l),l;return h}async function f(a,b,c){let d=[];for(let f of c)try{let c=await e(a,b,f);d.push(c)}catch(a){console.error("Failed to store memory:",a)}return d}async function g(a,c,e){let f=(0,b.createServiceSupabaseClient)(),g=e?.limit||10,j=e?.minSimilarity||.5,k=await d(c),{data:l,error:m}=await f.rpc("vector_memory_search",{p_company_id:a,p_query_embedding:k,p_user_id:e?.userId||null,p_scope:e?.scope||null,p_memory_types:e?.memoryTypes||null,p_entity_type:e?.entityType||null,p_entity_id:e?.entityId||null,p_limit:g,p_min_similarity:j});if(m)return console.error("Failed to search memories:",m),h(a,c,e);if(l&&l.length>0){let b=l.map(a=>a.id);await i(a,b)}return(l||[]).map(a=>({id:a.id,content:a.content,memoryType:a.memory_type,similarity:a.similarity,importance:a.importance,createdAt:a.created_at,accessCount:a.access_count}))}async function h(a,c,d){let e=(0,b.createServiceSupabaseClient)(),f=d?.limit||10,g=e.from("ai_memory").select("id, content, memory_type, importance, created_at, access_count").eq("company_id",a).is("deleted_at",null).order("importance",{ascending:!1}).limit(f);d?.userId&&(g=g.eq("user_id",d.userId)),d?.scope&&(g=g.eq("scope",d.scope)),d?.memoryTypes&&d.memoryTypes.length>0&&(g=g.in("memory_type",d.memoryTypes)),d?.entityType&&(g=g.eq("entity_type",d.entityType)),d?.entityId&&(g=g.eq("entity_id",d.entityId)),g=g.ilike("content",`%${c}%`);let{data:h,error:i}=await g;return i?(console.error("Fallback search failed:",i),[]):(h||[]).map(a=>({id:a.id,content:a.content,memoryType:a.memory_type,similarity:.5,importance:a.importance,createdAt:a.created_at,accessCount:a.access_count}))}async function i(a,c){let d=(0,b.createServiceSupabaseClient)();for(let b of c)await d.from("ai_memory").update({access_count:d.sql`access_count + 1`,last_accessed_at:new Date().toISOString()}).eq("id",b).eq("company_id",a)}async function j(a,c,d,e){let f=(0,b.createServiceSupabaseClient)(),g=e?.limit||20,h=f.from("ai_memory").select("id, content, memory_type, importance, created_at").eq("company_id",a).eq("entity_type",c).eq("entity_id",d).is("deleted_at",null).order("importance",{ascending:!1}).limit(g);e?.memoryTypes&&e.memoryTypes.length>0&&(h=h.in("memory_type",e.memoryTypes));let{data:i,error:j}=await h;return j?(console.error("Failed to get entity memories:",j),[]):(i||[]).map(a=>({id:a.id,content:a.content,memoryType:a.memory_type,importance:a.importance,createdAt:a.created_at}))}async function k(a,c,d){let e=(0,b.createServiceSupabaseClient)(),{error:f}=await e.from("ai_memory").update({importance:Math.max(0,Math.min(1,d))}).eq("id",c).eq("company_id",a);f&&console.error("Failed to update memory importance:",f)}async function l(a,c){let d=(0,b.createServiceSupabaseClient)(),{error:e}=await d.from("ai_memory").update({deleted_at:new Date().toISOString()}).eq("id",c).eq("company_id",a);return!e||(console.error("Failed to delete memory:",e),!1)}async function m(a,b,c,d,e,g){let h=[];for(let a of(h.push({content:e.substring(0,500),memoryType:"interaction",scope:b?"user":"company",sourceMessageId:d,sourceChatId:c,importance:.5,metadata:{role:g}}),[/(?:remember|note|important)[:\s]+(.+?)(?:\.|$)/gi,/(?:always|never|usually)[:\s]+(.+?)(?:\.|$)/gi]))for(let f of e.matchAll(a))f[1]&&f[1].length>10&&h.push({content:f[1].trim(),memoryType:"fact",scope:b?"user":"company",sourceMessageId:d,sourceChatId:c,importance:.7});return f(a,b,h)}async function n(a){let c=(0,b.createServiceSupabaseClient)(),{data:d,error:e}=await c.from("ai_memory").select("memory_type, scope, importance, access_count, created_at").eq("company_id",a).is("deleted_at",null);if(e||!d)return{totalMemories:0,byType:{},byScope:{},averageImportance:0,totalAccessCount:0,memoriesLast7Days:0};let f={},g={},h=0,i=0,j=new Date(Date.now()-6048e5),k=0;for(let a of d)f[a.memory_type]=(f[a.memory_type]||0)+1,g[a.scope]=(g[a.scope]||0)+1,h+=a.importance,i+=a.access_count,new Date(a.created_at)>j&&k++;return{totalMemories:d.length,byType:f,byScope:g,averageImportance:d.length>0?h/d.length:0,totalAccessCount:i,memoriesLast7Days:k}}async function o(a){return{consolidated:0,deleted:0}}async function p(a,c){let d=(0,b.createServiceSupabaseClient)(),e=c?.maxAge||90,f=c?.minAccessCount||1,g=new Date(Date.now()-24*e*36e5),{data:h,error:i}=await d.from("ai_memory").select("id").eq("company_id",a).is("deleted_at",null).lt("created_at",g.toISOString()).lte("access_count",f);if(i||!h)return{affected:0,deleted:0};if(c?.dryRun)return{affected:h.length,deleted:0};let j=h.map(a=>a.id);return j.length>0&&await d.from("ai_memory").update({deleted_at:new Date().toISOString()}).in("id",j).eq("company_id",a),{affected:h.length,deleted:h.length}}a.s(["consolidateMemories",()=>o,"decayOldMemories",()=>p,"deleteMemory",()=>l,"extractMemoriesFromConversation",()=>m,"getEntityMemories",()=>j,"getMemoryStatistics",()=>n,"searchMemories",()=>g,"storeMemories",()=>f,"storeMemory",()=>e,"updateMemoryImportance",()=>k])}];

//# sourceMappingURL=apps_web_src_lib_ai_memory-service_ts_be9d7ea7._.js.map