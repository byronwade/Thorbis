{"version":3,"sources":["../../../../../../apps/web/src/components/emails/password-reset-template.tsx","../../../../../../apps/web/src/actions/team.ts"],"sourcesContent":["/**\n * Password Reset Email Template\n *\n * Sent when an owner/manager resets a team member's password\n */\n\nimport {\n\tBody,\n\tButton,\n\tContainer,\n\tHead,\n\tHeading,\n\tHr,\n\tHtml,\n\tLink,\n\tPreview,\n\tSection,\n\tText,\n} from \"@react-email/components\";\n\ntype PasswordResetTemplateProps = {\n\tteamMemberName: string;\n\tresetByName: string;\n\tresetLink: string;\n\tcompanyName: string;\n\texpiresInHours?: number;\n};\n\nexport function PasswordResetTemplate({\n\tteamMemberName,\n\tresetByName,\n\tresetLink,\n\tcompanyName,\n\texpiresInHours = 24,\n}: PasswordResetTemplateProps) {\n\treturn (\n\t\t<Html>\n\t\t\t<Head />\n\t\t\t<Preview>Password reset for {companyName}</Preview>\n\t\t\t<Body style={main}>\n\t\t\t\t<Container style={container}>\n\t\t\t\t\t<Heading style={h1}>Password Reset</Heading>\n\n\t\t\t\t\t<Text style={text}>Hi {teamMemberName},</Text>\n\n\t\t\t\t\t<Text style={text}>\n\t\t\t\t\t\t{resetByName} from {companyName} has initiated a password reset for\n\t\t\t\t\t\tyour account.\n\t\t\t\t\t</Text>\n\n\t\t\t\t\t<Text style={text}>\n\t\t\t\t\t\tClick the button below to set a new password for your account:\n\t\t\t\t\t</Text>\n\n\t\t\t\t\t<Section style={buttonContainer}>\n\t\t\t\t\t\t<Button href={resetLink} style={button}>\n\t\t\t\t\t\t\tReset Password\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</Section>\n\n\t\t\t\t\t<Text style={text}>\n\t\t\t\t\t\tOr copy and paste this URL into your browser:\n\t\t\t\t\t</Text>\n\n\t\t\t\t\t<Link href={resetLink} style={link}>\n\t\t\t\t\t\t{resetLink}\n\t\t\t\t\t</Link>\n\n\t\t\t\t\t<Hr style={hr} />\n\n\t\t\t\t\t<Text style={footer}>\n\t\t\t\t\t\tThis link will expire in {expiresInHours} hours. If you didn't\n\t\t\t\t\t\trequest this password reset, please contact your administrator\n\t\t\t\t\t\timmediately.\n\t\t\t\t\t</Text>\n\n\t\t\t\t\t<Text style={footer}>\n\t\t\t\t\t\tBest regards,\n\t\t\t\t\t\t<br />\n\t\t\t\t\t\tThe {companyName} Team\n\t\t\t\t\t</Text>\n\t\t\t\t</Container>\n\t\t\t</Body>\n\t\t</Html>\n\t);\n}\n\n// Styles\nconst main = {\n\tbackgroundColor: \"#f6f9fc\",\n\tfontFamily:\n\t\t'-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,\"Helvetica Neue\",Ubuntu,sans-serif',\n};\n\nconst container = {\n\tbackgroundColor: \"#f3f7fd\",\n\tmargin: \"0 auto\",\n\tpadding: \"20px 0 48px\",\n\tmarginBottom: \"64px\",\n};\n\nconst h1 = {\n\tcolor: \"#333\",\n\tfontSize: \"24px\",\n\tfontWeight: \"bold\",\n\ttextAlign: \"center\" as const,\n\tmargin: \"30px 0\",\n\tpadding: \"0\",\n};\n\nconst text = {\n\tcolor: \"#333\",\n\tfontSize: \"16px\",\n\tlineHeight: \"26px\",\n\ttextAlign: \"left\" as const,\n\tpadding: \"0 48px\",\n};\n\nconst buttonContainer = {\n\tpadding: \"27px 48px\",\n};\n\nconst button = {\n\tbackgroundColor: \"#1f2938\",\n\tborderRadius: \"5px\",\n\tcolor: \"#f8fafe\",\n\tfontSize: \"16px\",\n\tfontWeight: \"bold\",\n\ttextDecoration: \"none\",\n\ttextAlign: \"center\" as const,\n\tdisplay: \"block\",\n\twidth: \"100%\",\n\tpadding: \"12px 20px\",\n};\n\nconst link = {\n\tcolor: \"#0066cc\",\n\tfontSize: \"14px\",\n\ttextDecoration: \"underline\",\n\tpadding: \"0 48px\",\n\twordBreak: \"break-all\" as const,\n};\n\nconst hr = {\n\tborderColor: \"#e6ebf1\",\n\tmargin: \"20px 48px\",\n};\n\nconst footer = {\n\tcolor: \"#8898aa\",\n\tfontSize: \"12px\",\n\tlineHeight: \"16px\",\n\tpadding: \"0 48px\",\n};\n","/**\n * Team Management Server Actions\n *\n * Handles team member and role management with server-side validation\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { PasswordResetTemplate } from \"@/components/emails/password-reset-template\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport { hasRole, isCompanyOwner } from \"@/lib/auth/permissions\";\nimport { sendEmail } from \"@/lib/email/email-sender\";\nimport {\n\tActionError,\n\tERROR_CODES,\n\tERROR_MESSAGES,\n} from \"@/lib/errors/action-error\";\nimport {\n\ttype ActionResult,\n\tassertAuthenticated,\n\tassertExists,\n\twithErrorHandling,\n} from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// Schema for inviting team members\nconst inviteTeamMemberSchema = z.object({\n\temail: z.string().email(\"Invalid email address\"),\n\tfirstName: z.string().min(1, \"First name is required\"),\n\tlastName: z.string().min(1, \"Last name is required\"),\n\trole: z.enum([\"admin\", \"manager\", \"technician\", \"dispatcher\"], {\n\t\tmessage: \"Role is required\",\n\t}),\n\tdepartment: z.string().optional(),\n});\n\n// Schema for creating roles\nconst createRoleSchema = z.object({\n\tname: z.string().min(1, \"Role name is required\"),\n\tdescription: z.string().optional(),\n\tcolor: z\n\t\t.string()\n\t\t.regex(/^#([0-9A-Fa-f]{6})$/, \"Color must be a hex value\")\n\t\t.optional(),\n\tpermissions: z\n\t\t.array(z.string())\n\t\t.min(1, \"At least one permission is required\"),\n});\n\n// Schema for creating departments\nconst createDepartmentSchema = z.object({\n\tname: z.string().min(1, \"Department name is required\"),\n\tdescription: z.string().optional(),\n\tmanagerId: z.string().optional(),\n});\n\n/**\n * Create team member directly with full employee management data\n */\nexport async function createTeamMemberDirect(\n\tformData: FormData,\n): Promise<ActionResult<string>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst { data: companyMembership } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!companyMembership?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company to create team members\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst email = formData.get(\"email\") as string;\n\t\tconst firstName = formData.get(\"firstName\") as string;\n\t\tconst lastName = formData.get(\"lastName\") as string;\n\t\tconst role = formData.get(\"role\") as string;\n\n\t\t// Basic validation\n\t\tif (!email || !firstName || !lastName || !role) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Email, first name, last name, and role are required\",\n\t\t\t\tERROR_CODES.INVALID_INPUT,\n\t\t\t);\n\t\t}\n\n\t\t// Create or get user profile\n\t\tlet userId: string;\n\t\tconst { data: existingProfile } = await supabase\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"email\", email)\n\t\t\t.single();\n\n\t\tif (existingProfile) {\n\t\t\tuserId = existingProfile.id;\n\t\t} else {\n\t\t\t// Create Supabase Auth user with temporary password\n\t\t\tconst tempPassword = formData.get(\"temp_password\") as string;\n\t\t\tif (!tempPassword) {\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\t\"Temporary password is required for direct creation\",\n\t\t\t\t\tERROR_CODES.INVALID_INPUT,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst { data: authUser, error: authError } =\n\t\t\t\tawait supabase.auth.admin.createUser({\n\t\t\t\t\temail,\n\t\t\t\t\tpassword: tempPassword,\n\t\t\t\t\temail_confirm: true,\n\t\t\t\t\tuser_metadata: {\n\t\t\t\t\t\tfull_name: `${firstName} ${lastName}`,\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\tif (authError || !authUser.user) {\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\t`Failed to create user: ${authError?.message}`,\n\t\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tuserId = authUser.user.id;\n\n\t\t\t// Create profile record\n\t\t\tconst { error: profileError } = await supabase.from(\"profiles\").insert({\n\t\t\t\tid: userId,\n\t\t\t\temail,\n\t\t\t\tfull_name: `${firstName} ${lastName}`,\n\t\t\t\tphone: (formData.get(\"phone\") as string) || null,\n\t\t\t});\n\n\t\t\tif (profileError) {\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\tERROR_MESSAGES.operationFailed(\"create profile\"),\n\t\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Parse skills, licenses, service areas (comma-separated)\n\t\tconst skills = ((formData.get(\"skills\") as string) || \"\")\n\t\t\t.split(\",\")\n\t\t\t.map((s) => s.trim())\n\t\t\t.filter(Boolean);\n\t\tconst licenses = ((formData.get(\"licenses\") as string) || \"\")\n\t\t\t.split(\",\")\n\t\t\t.map((l) => l.trim())\n\t\t\t.filter(Boolean);\n\t\tconst serviceAreas = ((formData.get(\"service_areas\") as string) || \"\")\n\t\t\t.split(\",\")\n\t\t\t.map((a) => a.trim())\n\t\t\t.filter(Boolean);\n\t\tconst preferredJobTypes = (\n\t\t\t(formData.get(\"preferred_job_types\") as string) || \"\"\n\t\t)\n\t\t\t.split(\",\")\n\t\t\t.map((t) => t.trim())\n\t\t\t.filter(Boolean);\n\n\t\t// Parse certifications (expecting JSON string or comma-separated)\n\t\tlet certifications = null;\n\t\tconst certificationsInput = formData.get(\"certifications\") as string;\n\t\tif (certificationsInput) {\n\t\t\ttry {\n\t\t\t\tcertifications = JSON.parse(certificationsInput);\n\t\t\t} catch {\n\t\t\t\t// If not valid JSON, treat as comma-separated list\n\t\t\t\tcertifications = certificationsInput\n\t\t\t\t\t.split(\",\")\n\t\t\t\t\t.map((c) => c.trim())\n\t\t\t\t\t.filter(Boolean);\n\t\t\t}\n\t\t}\n\n\t\t// Parse commission_structure (expecting JSON string)\n\t\tlet commissionStructure = null;\n\t\tconst commissionStructureInput = formData.get(\n\t\t\t\"commission_structure\",\n\t\t) as string;\n\t\tif (commissionStructureInput) {\n\t\t\ttry {\n\t\t\t\tcommissionStructure = JSON.parse(commissionStructureInput);\n\t\t\t} catch {\n\t\t\t\t// Invalid JSON - leave as null\n\t\t\t\tconsole.warn(\n\t\t\t\t\t\"Invalid JSON for commission_structure:\",\n\t\t\t\t\tcommissionStructureInput,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Parse availability_schedule (expecting JSON string)\n\t\tlet availabilitySchedule = null;\n\t\tconst availabilityScheduleInput = formData.get(\n\t\t\t\"availability_schedule\",\n\t\t) as string;\n\t\tif (availabilityScheduleInput) {\n\t\t\ttry {\n\t\t\t\tavailabilitySchedule = JSON.parse(availabilityScheduleInput);\n\t\t\t} catch {\n\t\t\t\t// Invalid JSON - leave as null\n\t\t\t\tconsole.warn(\n\t\t\t\t\t\"Invalid JSON for availability_schedule:\",\n\t\t\t\t\tavailabilityScheduleInput,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Create company membership with ALL employee management fields\n\t\tconst { data: membership, error: membershipError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyMembership.company_id,\n\t\t\t\tuser_id: userId,\n\t\t\t\trole: role as\n\t\t\t\t\t| \"owner\"\n\t\t\t\t\t| \"admin\"\n\t\t\t\t\t| \"manager\"\n\t\t\t\t\t| \"member\"\n\t\t\t\t\t| \"technician\"\n\t\t\t\t\t| \"dispatcher\"\n\t\t\t\t\t| \"csr\",\n\t\t\t\tstatus: \"active\",\n\t\t\t\tjob_title: (formData.get(\"job_title\") as string) || null,\n\t\t\t\tdepartment_id: (formData.get(\"department_id\") as string) || null,\n\n\t\t\t\t// Emergency Contact\n\t\t\t\temergency_contact_name:\n\t\t\t\t\t(formData.get(\"emergency_contact_name\") as string) || null,\n\t\t\t\temergency_contact_phone:\n\t\t\t\t\t(formData.get(\"emergency_contact_phone\") as string) || null,\n\t\t\t\temergency_contact_relationship:\n\t\t\t\t\t(formData.get(\"emergency_contact_relationship\") as string) || null,\n\n\t\t\t\t// Employment Details\n\t\t\t\temployee_id: (formData.get(\"employee_id\") as string) || null,\n\t\t\t\thire_date: (formData.get(\"hire_date\") as string) || null,\n\t\t\t\temployment_type: (formData.get(\"employment_type\") as string) || null,\n\t\t\t\twork_schedule: (formData.get(\"work_schedule\") as string) || null,\n\t\t\t\twork_location: (formData.get(\"work_location\") as string) || null,\n\n\t\t\t\t// Compensation\n\t\t\t\tpay_type: (formData.get(\"pay_type\") as string) || null,\n\t\t\t\thourly_rate: formData.get(\"hourly_rate\")\n\t\t\t\t\t? parseFloat(formData.get(\"hourly_rate\") as string)\n\t\t\t\t\t: null,\n\t\t\t\tannual_salary: formData.get(\"annual_salary\")\n\t\t\t\t\t? parseFloat(formData.get(\"annual_salary\") as string)\n\t\t\t\t\t: null,\n\t\t\t\tcommission_rate: formData.get(\"commission_rate\")\n\t\t\t\t\t? parseFloat(formData.get(\"commission_rate\") as string)\n\t\t\t\t\t: null,\n\t\t\t\tcommission_structure: commissionStructure,\n\t\t\t\tovertime_eligible: formData.get(\"overtime_eligible\") === \"true\",\n\n\t\t\t\t// Address\n\t\t\t\tstreet_address: (formData.get(\"street_address\") as string) || null,\n\t\t\t\tcity: (formData.get(\"city\") as string) || null,\n\t\t\t\tstate: (formData.get(\"state\") as string) || null,\n\t\t\t\tpostal_code: (formData.get(\"postal_code\") as string) || null,\n\t\t\t\tcountry: (formData.get(\"country\") as string) || \"US\",\n\n\t\t\t\t// Skills & Certifications\n\t\t\t\tskills: skills.length > 0 ? skills : null,\n\t\t\t\tcertifications: certifications,\n\t\t\t\tlicenses: licenses.length > 0 ? licenses : null,\n\n\t\t\t\t// Work Preferences\n\t\t\t\tservice_areas: serviceAreas.length > 0 ? serviceAreas : null,\n\t\t\t\tavailability_schedule: availabilitySchedule,\n\t\t\t\tmax_weekly_hours: formData.get(\"max_weekly_hours\")\n\t\t\t\t\t? parseInt(formData.get(\"max_weekly_hours\") as string)\n\t\t\t\t\t: null,\n\t\t\t\tpreferred_job_types:\n\t\t\t\t\tpreferredJobTypes.length > 0 ? preferredJobTypes : null,\n\n\t\t\t\t// Performance\n\t\t\t\tperformance_notes:\n\t\t\t\t\t(formData.get(\"performance_notes\") as string) || null,\n\t\t\t\tlast_review_date: (formData.get(\"last_review_date\") as string) || null,\n\t\t\t\tnext_review_date: (formData.get(\"next_review_date\") as string) || null,\n\n\t\t\t\t// Notes\n\t\t\t\tnotes: (formData.get(\"notes\") as string) || null,\n\n\t\t\t\t// Timestamps\n\t\t\t\tinvited_at: new Date().toISOString(),\n\t\t\t\taccepted_at: new Date().toISOString(),\n\t\t\t})\n\t\t\t.select(\"id\")\n\t\t\t.single();\n\n\t\tif (membershipError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"create team member\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Send welcome email if requested\n\t\tconst shouldSendWelcomeEmail =\n\t\t\tformData.get(\"send_welcome_email\") === \"true\";\n\t\tif (shouldSendWelcomeEmail && email) {\n\t\t\ttry {\n\t\t\t\t// Get company name for the email\n\t\t\t\tconst { data: company } = await supabase\n\t\t\t\t\t.from(\"companies\")\n\t\t\t\t\t.select(\"name\")\n\t\t\t\t\t.eq(\"id\", companyMembership.company_id)\n\t\t\t\t\t.single();\n\n\t\t\t\tconst companyName = company?.name || \"the team\";\n\t\t\t\tconst fullName = `${firstName} ${lastName}`;\n\n\t\t\t\tawait sendEmail({\n\t\t\t\t\tto: email,\n\t\t\t\t\tsubject: `Welcome to ${companyName}!`,\n\t\t\t\t\ttext: `Hi ${fullName},\\n\\nYou've been added as a team member at ${companyName}. You can now log in to access your dashboard and start working.\\n\\nLogin here: ${process.env.NEXT_PUBLIC_SITE_URL}/login\\n\\nIf you have any questions, please reach out to your team administrator.\\n\\nWelcome aboard!`,\n\t\t\t\t});\n\t\t\t} catch (emailError) {\n\t\t\t\t// Don't fail the whole operation if email fails\n\t\t\t\tconsole.error(\"Failed to send welcome email:\", emailError);\n\t\t\t}\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard/work/team\");\n\t\treturn membership.id;\n\t});\n}\n\n/**\n * Invite team member\n */\nasync function inviteTeamMember(\n\tformData: FormData,\n): Promise<ActionResult<string>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst { data: companyMembership } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!companyMembership?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company to invite team members\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst data = inviteTeamMemberSchema.parse({\n\t\t\temail: formData.get(\"email\"),\n\t\t\tfirstName: formData.get(\"firstName\"),\n\t\t\tlastName: formData.get(\"lastName\"),\n\t\t\trole: formData.get(\"role\"),\n\t\t\tdepartment: formData.get(\"department\") || undefined,\n\t\t});\n\n\t\t// Check if user already exists in profiles\n\t\tlet userId: string;\n\t\tconst { data: existingProfile } = await supabase\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"email\", data.email)\n\t\t\t.single();\n\n\t\tif (existingProfile) {\n\t\t\tuserId = existingProfile.id;\n\t\t} else {\n\t\t\t// Create profile record (they'll complete registration via invitation link)\n\t\t\tconst { data: newProfile, error: profileError } = await supabase\n\t\t\t\t.from(\"profiles\")\n\t\t\t\t.insert({\n\t\t\t\t\temail: data.email,\n\t\t\t\t\tfull_name: `${data.firstName} ${data.lastName}`,\n\t\t\t\t})\n\t\t\t\t.select(\"id\")\n\t\t\t\t.single();\n\n\t\t\tif (profileError) {\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\tERROR_MESSAGES.operationFailed(\"create profile\"),\n\t\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tuserId = newProfile.id;\n\t\t}\n\n\t\t// Get role ID if role is specified\n\t\tlet roleId: string | undefined;\n\t\tif (data.role) {\n\t\t\tconst { data: role } = await supabase\n\t\t\t\t.from(\"custom_roles\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"name\", data.role)\n\t\t\t\t.eq(\"company_id\", companyMembership.company_id)\n\t\t\t\t.single();\n\n\t\t\troleId = role?.id;\n\t\t}\n\n\t\t// Get department ID if department is specified\n\t\tlet departmentId: string | undefined;\n\t\tif (data.department) {\n\t\t\tconst { data: dept } = await supabase\n\t\t\t\t.from(\"departments\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"id\", data.department)\n\t\t\t\t.eq(\"company_id\", companyMembership.company_id)\n\t\t\t\t.single();\n\n\t\t\tdepartmentId = dept?.id;\n\t\t}\n\n\t\t// Create company membership invitation\n\t\tconst { data: invitation, error: inviteError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyMembership.company_id,\n\t\t\t\tuser_id: userId,\n\t\t\t\trole: data.role as\n\t\t\t\t\t| \"owner\"\n\t\t\t\t\t| \"admin\"\n\t\t\t\t\t| \"manager\"\n\t\t\t\t\t| \"member\"\n\t\t\t\t\t| \"technician\"\n\t\t\t\t\t| \"dispatcher\"\n\t\t\t\t\t| \"csr\",\n\t\t\t\tdepartment_id: departmentId,\n\t\t\t\tstatus: \"invited\",\n\t\t\t\tinvited_at: new Date().toISOString(),\n\t\t\t})\n\t\t\t.select(\"id\")\n\t\t\t.single();\n\n\t\tif (inviteError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"send invitation\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Send magic link invitation email\n\t\ttry {\n\t\t\tconst { sendSingleTeamInvitation } = await import(\n\t\t\t\t\"@/actions/team-invitations\"\n\t\t\t);\n\n\t\t\t// Create FormData for the invitation\n\t\t\tconst invitationFormData = new FormData();\n\t\t\tinvitationFormData.append(\"email\", formData.get(\"email\") as string);\n\t\t\tinvitationFormData.append(\n\t\t\t\t\"firstName\",\n\t\t\t\t(formData.get(\"first_name\") as string) || \"\",\n\t\t\t);\n\t\t\tinvitationFormData.append(\n\t\t\t\t\"lastName\",\n\t\t\t\t(formData.get(\"last_name\") as string) || \"\",\n\t\t\t);\n\t\t\tinvitationFormData.append(\"role\", formData.get(\"role\") as string);\n\t\t\tinvitationFormData.append(\n\t\t\t\t\"phone\",\n\t\t\t\t(formData.get(\"phone\") as string) || \"\",\n\t\t\t);\n\n\t\t\tconst invitationResult =\n\t\t\t\tawait sendSingleTeamInvitation(invitationFormData);\n\n\t\t\tif (!invitationResult.success) {\n\t\t\t\t// Don't fail the whole operation if email fails\n\t\t\t}\n\t\t} catch (_error) {\n\t\t\t// Don't fail the whole operation if email fails\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\treturn invitation.id;\n\t});\n}\n\n/**\n * Update team member\n */\nasync function updateTeamMember(\n\tmemberId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company to verify permissions\n\t\tconst { data: currentUserMembership } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!currentUserMembership?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify team member belongs to same company\n\t\tconst { data: targetMembership } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id, user_id\")\n\t\t\t.eq(\"id\", memberId)\n\t\t\t.single();\n\n\t\tassertExists(targetMembership, \"Team member\");\n\n\t\tif (targetMembership.company_id !== currentUserMembership.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"team member\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Get role if specified (now stored directly in company_memberships.role)\n\t\tconst roleInput = formData.get(\"role\") as string;\n\n\t\t// Get department ID if department is specified\n\t\tlet departmentId: string | null = null;\n\t\tconst departmentInput = formData.get(\"department\") as string;\n\t\tif (departmentInput) {\n\t\t\tconst { data: dept } = await supabase\n\t\t\t\t.from(\"departments\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"id\", departmentInput)\n\t\t\t\t.eq(\"company_id\", currentUserMembership.company_id)\n\t\t\t\t.single();\n\n\t\t\tdepartmentId = dept?.id || null;\n\t\t}\n\n\t\t// Check if trying to change owner's status\n\t\tconst newStatus = formData.get(\"status\") as string;\n\t\tif (newStatus && newStatus !== \"active\") {\n\t\t\t// Check if this team member is the company owner\n\t\t\tconst { data: company } = await supabase\n\t\t\t\t.from(\"companies\")\n\t\t\t\t.select(\"owner_id\")\n\t\t\t\t.eq(\"id\", currentUserMembership.company_id)\n\t\t\t\t.single();\n\n\t\t\tif (company && company.owner_id === targetMembership.user_id) {\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\t\"Cannot archive or deactivate company owner. Transfer ownership first.\",\n\t\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tconst updateData: any = {\n\t\t\trole: roleInput as\n\t\t\t\t| \"owner\"\n\t\t\t\t| \"admin\"\n\t\t\t\t| \"manager\"\n\t\t\t\t| \"member\"\n\t\t\t\t| \"technician\"\n\t\t\t\t| \"dispatcher\"\n\t\t\t\t| \"csr\",\n\t\t\tdepartment_id: departmentId,\n\t\t\tstatus: newStatus as \"active\" | \"invited\" | \"suspended\",\n\t\t\tjob_title: formData.get(\"jobTitle\") as string,\n\t\t};\n\n\t\t// Update company membership\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update(updateData)\n\t\t\t.eq(\"id\", memberId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update team member\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${memberId}`);\n\t});\n}\n\n/**\n * Remove team member\n */\nasync function removeTeamMember(memberId: string): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company to verify permissions\n\t\tconst { data: currentUserTeam } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!currentUserTeam?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify team member belongs to same company\n\t\tconst { data: targetMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id, user_id\")\n\t\t\t.eq(\"id\", memberId)\n\t\t\t.single();\n\n\t\tassertExists(targetMember, \"Team member\");\n\n\t\tif (targetMember.company_id !== currentUserTeam.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"team member\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Prevent removing yourself\n\t\tif (targetMember.user_id === user.id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You cannot remove yourself from the team\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Check if team member can be deleted (prevents owner deletion)\n\t\tconst { canDeleteTeamMember } = await import(\"./roles\");\n\t\tconst canDeleteResult = await canDeleteTeamMember(memberId);\n\n\t\tif (\n\t\t\tcanDeleteResult.success &&\n\t\t\tcanDeleteResult.data &&\n\t\t\t!canDeleteResult.data.canDelete\n\t\t) {\n\t\t\tthrow new ActionError(\n\t\t\t\tcanDeleteResult.data.reason || \"Cannot delete this team member\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Soft delete: set status to 'suspended'\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ status: \"suspended\" })\n\t\t\t.eq(\"id\", memberId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"remove team member\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard/work/team\");\n\t});\n}\n\n/**\n * Suspend team member - sets status to 'suspended'\n */\nexport async function suspendTeamMember(\n\tmemberId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify team member belongs to same company\n\t\tconst { data: targetMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id, user_id, status\")\n\t\t\t.eq(\"id\", memberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tassertExists(targetMember, \"Team member\");\n\n\t\t// Prevent suspending yourself\n\t\tif (targetMember.user_id === user.id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You cannot suspend yourself\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Check if already suspended\n\t\tif (targetMember.status === \"suspended\") {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Team member is already suspended\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Check if team member can be suspended (prevents owner suspension)\n\t\tconst { canDeleteTeamMember } = await import(\"./roles\");\n\t\tconst canSuspendResult = await canDeleteTeamMember(memberId);\n\n\t\tif (\n\t\t\tcanSuspendResult.success &&\n\t\t\tcanSuspendResult.data &&\n\t\t\t!canSuspendResult.data.canDelete\n\t\t) {\n\t\t\tthrow new ActionError(\n\t\t\t\tcanSuspendResult.data.reason || \"Cannot suspend this team member\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Update status to suspended\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ status: \"suspended\" })\n\t\t\t.eq(\"id\", memberId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"suspend team member\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard/work/team\");\n\t\trevalidatePath(`/dashboard/work/team/${memberId}`);\n\t});\n}\n\n/**\n * Activate team member - sets status to 'active'\n */\nexport async function activateTeamMember(\n\tmemberId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify team member belongs to same company\n\t\tconst { data: targetMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id, status\")\n\t\t\t.eq(\"id\", memberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tassertExists(targetMember, \"Team member\");\n\n\t\t// Check if already active\n\t\tif (targetMember.status === \"active\") {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Team member is already active\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Update status to active\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ status: \"active\" })\n\t\t\t.eq(\"id\", memberId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"activate team member\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard/work/team\");\n\t\trevalidatePath(`/dashboard/work/team/${memberId}`);\n\t});\n}\n\n/**\n * Archive team member - permanently removes from team\n */\nexport async function archiveTeamMember(\n\tmemberId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify team member belongs to same company\n\t\tconst { data: targetMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id, user_id\")\n\t\t\t.eq(\"id\", memberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tassertExists(targetMember, \"Team member\");\n\n\t\t// Prevent archiving yourself\n\t\tif (targetMember.user_id === user.id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You cannot archive yourself\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Check if team member can be archived (prevents owner archival)\n\t\tconst { canDeleteTeamMember } = await import(\"./roles\");\n\t\tconst canArchiveResult = await canDeleteTeamMember(memberId);\n\n\t\tif (\n\t\t\tcanArchiveResult.success &&\n\t\t\tcanArchiveResult.data &&\n\t\t\t!canArchiveResult.data.canDelete\n\t\t) {\n\t\t\tthrow new ActionError(\n\t\t\t\tcanArchiveResult.data.reason || \"Cannot archive this team member\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Soft delete the team member record (set archived_at timestamp)\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ archived_at: new Date().toISOString() })\n\t\t\t.eq(\"id\", memberId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"archive team member\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Log the archive action\n\t\tawait supabase.from(\"activity_logs\").insert({\n\t\t\tcompany_id: companyId,\n\t\t\tuser_id: user.id,\n\t\t\taction_type: \"team_member_archived\",\n\t\t\tentity_type: \"team_member\",\n\t\t\tentity_id: memberId,\n\t\t\tmetadata: {\n\t\t\t\tarchived_by_name:\n\t\t\t\t\t(\n\t\t\t\t\t\tawait supabase\n\t\t\t\t\t\t\t.from(\"profiles\")\n\t\t\t\t\t\t\t.select(\"full_name\")\n\t\t\t\t\t\t\t.eq(\"id\", user.id)\n\t\t\t\t\t\t\t.single()\n\t\t\t\t\t).data?.full_name || \"Unknown\",\n\t\t\t},\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard/work/team\");\n\t});\n}\n\n/**\n * Restore an archived team member\n */\nexport async function restoreTeamMember(\n\tmemberId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Check if user is owner or manager\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\t\tconst isManager = await hasRole(supabase, user.id, \"manager\", companyId);\n\n\t\tif (!(isOwner || isManager)) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Only owners and managers can restore team members\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify team member belongs to same company and is archived\n\t\tconst { data: targetMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id, user_id, archived_at\")\n\t\t\t.eq(\"id\", memberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tassertExists(targetMember, \"Team member\");\n\n\t\tif (!targetMember.archived_at) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Team member is not archived\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Restore the team member (clear archived_at timestamp)\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ archived_at: null })\n\t\t\t.eq(\"id\", memberId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"restore team member\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Log the restore action\n\t\tawait supabase.from(\"activity_logs\").insert({\n\t\t\tcompany_id: companyId,\n\t\t\tuser_id: user.id,\n\t\t\taction_type: \"team_member_restored\",\n\t\t\tentity_type: \"team_member\",\n\t\t\tentity_id: memberId,\n\t\t\tmetadata: {\n\t\t\t\trestored_by_name:\n\t\t\t\t\t(\n\t\t\t\t\t\tawait supabase\n\t\t\t\t\t\t\t.from(\"profiles\")\n\t\t\t\t\t\t\t.select(\"name\")\n\t\t\t\t\t\t\t.eq(\"id\", user.id)\n\t\t\t\t\t\t\t.single()\n\t\t\t\t\t).data?.name || \"Unknown\",\n\t\t\t},\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard/work/team\");\n\t});\n}\n\n/**\n * Send password reset email to team member\n * Only accessible by owners and managers\n */\nexport async function sendPasswordResetEmail(\n\tmemberId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Check if user is owner or manager\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\t\tconst isManager = await hasRole(supabase, user.id, \"manager\", companyId);\n\n\t\tif (!(isOwner || isManager)) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Only owners and managers can reset passwords\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Fetch team member details\n\t\tconst { data: targetMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"user_id, company_id\")\n\t\t\t.eq(\"id\", memberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tassertExists(targetMember, \"Team member\");\n\n\t\t// Get user details for email\n\t\tconst { data: userData } = await supabase\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"full_name, email\")\n\t\t\t.eq(\"id\", targetMember.user_id)\n\t\t\t.single();\n\n\t\tconst { data: currentUserData } = await supabase\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"full_name\")\n\t\t\t.eq(\"id\", user.id)\n\t\t\t.single();\n\n\t\tconst { data: companyData } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"name\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (!userData?.email) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Team member email not found\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t);\n\t\t}\n\n\t\t// Generate password reset link via Supabase Admin API\n\t\tconst { data: resetData, error: resetError } =\n\t\t\tawait supabase.auth.admin.generateLink({\n\t\t\t\ttype: \"recovery\",\n\t\t\t\temail: userData.email,\n\t\t\t});\n\n\t\tif (resetError || !resetData?.properties?.action_link) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to generate password reset link\",\n\t\t\t\tERROR_CODES.INTERNAL_SERVER_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Send password reset email\n\t\tconst emailResult = await sendEmail({\n\t\t\tto: userData.email,\n\t\t\tsubject: `Password Reset - ${companyData?.name || \"Your Account\"}`,\n\t\t\ttemplate: PasswordResetTemplate({\n\t\t\t\tteamMemberName: userData.full_name || \"Team Member\",\n\t\t\t\tresetByName: currentUserData?.full_name || \"Your Manager\",\n\t\t\t\tresetLink: resetData.properties.action_link,\n\t\t\t\tcompanyName: companyData?.name || \"Your Company\",\n\t\t\t\texpiresInHours: 24,\n\t\t\t}),\n\t\t\ttemplateType: \"password_reset\" as any,\n\t\t\ttags: [\n\t\t\t\t{ name: \"action\", value: \"password_reset\" },\n\t\t\t\t{ name: \"initiated_by\", value: user.id },\n\t\t\t],\n\t\t});\n\n\t\tif (!emailResult.success) {\n\t\t\tthrow new ActionError(\n\t\t\t\temailResult.error || \"Failed to send password reset email\",\n\t\t\t\tERROR_CODES.INTERNAL_SERVER_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Log the password reset action\n\t\tawait supabase.from(\"activity_logs\").insert({\n\t\t\tcompany_id: companyId,\n\t\t\tuser_id: user.id,\n\t\t\taction_type: \"password_reset_sent\",\n\t\t\tresource_type: \"team_member\",\n\t\t\tresource_id: memberId,\n\t\t\tmetadata: {\n\t\t\t\ttarget_user_id: targetMember.user_id,\n\t\t\t\ttarget_email: userData.email,\n\t\t\t},\n\t\t});\n\t});\n}\n\n/**\n * Check if current user can manage team member\n * Returns true if current user is owner or manager\n */\nexport async function canManageTeamMember(\n\t_memberId: string,\n): Promise<ActionResult<boolean>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Check if user is owner or manager\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\t\tconst isManager = await hasRole(supabase, user.id, \"manager\", companyId);\n\t\tconst isAdmin = await hasRole(supabase, user.id, \"admin\", companyId);\n\n\t\treturn isOwner || isManager || isAdmin;\n\t});\n}\n\n/**\n * Get team member permissions and settings\n * Only accessible by owners and managers\n */\nasync function getTeamMemberPermissions(memberId: string): Promise<\n\tActionResult<{\n\t\trole: string;\n\t\tpermissions: Record<string, boolean>;\n\t\tcanManage: boolean;\n\t}>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Check if user can manage team members\n\t\tconst canManageResult = await canManageTeamMember(memberId);\n\t\tconst canManage = canManageResult.success && canManageResult.data === true;\n\n\t\t// Fetch team member details\n\t\tconst { data: targetMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"role, permissions, company_id\")\n\t\t\t.eq(\"id\", memberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tassertExists(targetMember, \"Team member\");\n\n\t\treturn {\n\t\t\trole: targetMember.role || \"unknown\",\n\t\t\tpermissions: (targetMember.permissions as Record<string, boolean>) || {},\n\t\t\tcanManage,\n\t\t};\n\t});\n}\n\n/**\n * Update team member permissions\n * Only accessible by owners and managers\n */\nasync function updateTeamMemberPermissions(\n\tmemberId: string,\n\tnewRole: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Check if user is owner or manager\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\t\tconst isManager = await hasRole(supabase, user.id, \"manager\", companyId);\n\t\tconst isAdmin = await hasRole(supabase, user.id, \"admin\", companyId);\n\n\t\tif (!(isOwner || isManager || isAdmin)) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Only owners, admins, and managers can update permissions\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify team member belongs to same company\n\t\tconst { data: targetMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id, user_id\")\n\t\t\t.eq(\"id\", memberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tassertExists(targetMember, \"Team member\");\n\n\t\t// Prevent changing your own role\n\t\tif (targetMember.user_id === user.id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You cannot change your own role\",\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Get the new role ID\n\t\tconst { data: roleData } = await supabase\n\t\t\t.from(\"custom_roles\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"name\", newRole)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!roleData) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Role '${newRole}' not found`,\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t);\n\t\t}\n\n\t\t// Update team member role\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ role_id: roleData.id })\n\t\t\t.eq(\"id\", memberId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update permissions\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Log the permission change\n\t\tawait supabase.from(\"activity_logs\").insert({\n\t\t\tcompany_id: companyId,\n\t\t\tuser_id: user.id,\n\t\t\taction_type: \"permissions_updated\",\n\t\t\tresource_type: \"team_member\",\n\t\t\tresource_id: memberId,\n\t\t\tmetadata: {\n\t\t\t\tnew_role: newRole,\n\t\t\t\ttarget_user_id: targetMember.user_id,\n\t\t\t},\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard/work/team\");\n\t\trevalidatePath(`/dashboard/work/team/${memberId}`);\n\t});\n}\n\n/**\n * Create role\n */\nasync function createRole(formData: FormData): Promise<ActionResult<string>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst { data: currentUserTeam } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!currentUserTeam?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst permissionsString = formData.get(\"permissions\") as string;\n\t\tconst permissions = permissionsString ? permissionsString.split(\",\") : [];\n\n\t\tconst data = createRoleSchema.parse({\n\t\t\tname: formData.get(\"name\"),\n\t\t\tdescription: formData.get(\"description\") || undefined,\n\t\t\tcolor: (formData.get(\"color\") as string) || undefined,\n\t\t\tpermissions,\n\t\t});\n\n\t\t// Check if role name already exists in company\n\t\tconst { data: existingRole } = await supabase\n\t\t\t.from(\"custom_roles\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"name\", data.name)\n\t\t\t.eq(\"company_id\", currentUserTeam.company_id)\n\t\t\t.single();\n\n\t\tif (existingRole) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.alreadyExists(\"Role\"),\n\t\t\t\tERROR_CODES.DB_DUPLICATE_ENTRY,\n\t\t\t);\n\t\t}\n\n\t\t// Create role\n\t\tconst { data: newRole, error: createError } = await supabase\n\t\t\t.from(\"custom_roles\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: currentUserTeam.company_id,\n\t\t\t\tname: data.name,\n\t\t\t\tdescription: data.description,\n\t\t\t\tcolor: data.color,\n\t\t\t\tpermissions: data.permissions,\n\t\t\t\tis_system: false,\n\t\t\t})\n\t\t\t.select(\"id\")\n\t\t\t.single();\n\n\t\tif (createError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"create role\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team/roles\");\n\t\treturn newRole.id;\n\t});\n}\n\n/**\n * Update role\n */\nasync function updateRole(\n\troleId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst { data: currentUserTeam } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!currentUserTeam?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify role belongs to company and is not a system role\n\t\tconst { data: existingRole } = await supabase\n\t\t\t.from(\"custom_roles\")\n\t\t\t.select(\"company_id, is_system\")\n\t\t\t.eq(\"id\", roleId)\n\t\t\t.single();\n\n\t\tassertExists(existingRole, \"Role\");\n\n\t\tif (existingRole.company_id !== currentUserTeam.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"role\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tif (existingRole.is_system) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"System roles cannot be modified\",\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\tconst permissionsString = formData.get(\"permissions\") as string;\n\t\tconst permissions = permissionsString ? permissionsString.split(\",\") : [];\n\n\t\tconst data = createRoleSchema.parse({\n\t\t\tname: formData.get(\"name\"),\n\t\t\tdescription: formData.get(\"description\") || undefined,\n\t\t\tcolor: (formData.get(\"color\") as string) || undefined,\n\t\t\tpermissions,\n\t\t});\n\n\t\t// Update role\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"custom_roles\")\n\t\t\t.update({\n\t\t\t\tname: data.name,\n\t\t\t\tdescription: data.description,\n\t\t\t\tcolor: data.color,\n\t\t\t\tpermissions: data.permissions,\n\t\t\t})\n\t\t\t.eq(\"id\", roleId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update role\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team/roles\");\n\t\trevalidatePath(`/dashboard/settings/team/roles/${roleId}`);\n\t});\n}\n\n/**\n * Delete role\n */\nasync function deleteRole(roleId: string): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst { data: currentUserTeam } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!currentUserTeam?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify role belongs to company and is not a system role\n\t\tconst { data: existingRole } = await supabase\n\t\t\t.from(\"custom_roles\")\n\t\t\t.select(\"company_id, is_system, name\")\n\t\t\t.eq(\"id\", roleId)\n\t\t\t.single();\n\n\t\tassertExists(existingRole, \"Role\");\n\n\t\tif (existingRole.company_id !== currentUserTeam.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"role\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tif (existingRole.is_system) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"System roles cannot be deleted\",\n\t\t\t\tERROR_CODES.OPERATION_NOT_ALLOWED,\n\t\t\t);\n\t\t}\n\n\t\t// Check if role is in use by any team members\n\t\tconst { data: teamMembersWithRole, error: checkError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"role_id\", roleId)\n\t\t\t.limit(1);\n\n\t\tif (checkError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to check role usage\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tif (teamMembersWithRole && teamMembersWithRole.length > 0) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.cannotDelete(\n\t\t\t\t\t\"role\",\n\t\t\t\t\t\"it is currently assigned to team members\",\n\t\t\t\t),\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Delete role\n\t\tconst { error: deleteError } = await supabase\n\t\t\t.from(\"custom_roles\")\n\t\t\t.delete()\n\t\t\t.eq(\"id\", roleId);\n\n\t\tif (deleteError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"delete role\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team/roles\");\n\t});\n}\n\n/**\n * Create department\n */\nasync function createDepartment(\n\tformData: FormData,\n): Promise<ActionResult<string>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst { data: currentUserTeam } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!currentUserTeam?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst data = createDepartmentSchema.parse({\n\t\t\tname: formData.get(\"name\"),\n\t\t\tdescription: formData.get(\"description\") || undefined,\n\t\t\tmanagerId: formData.get(\"managerId\") || undefined,\n\t\t});\n\n\t\t// Check if department name already exists in company\n\t\tconst { data: existingDepartment } = await supabase\n\t\t\t.from(\"departments\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"name\", data.name)\n\t\t\t.eq(\"company_id\", currentUserTeam.company_id)\n\t\t\t.single();\n\n\t\tif (existingDepartment) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.alreadyExists(\"Department\"),\n\t\t\t\tERROR_CODES.DB_DUPLICATE_ENTRY,\n\t\t\t);\n\t\t}\n\n\t\t// Create department\n\t\tconst { data: newDepartment, error: createError } = await supabase\n\t\t\t.from(\"departments\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: currentUserTeam.company_id,\n\t\t\t\tname: data.name,\n\t\t\t\tdescription: data.description,\n\t\t\t})\n\t\t\t.select(\"id\")\n\t\t\t.single();\n\n\t\tif (createError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"create department\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team/departments\");\n\t\treturn newDepartment.id;\n\t});\n}\n\n/**\n * Update department\n */\nasync function updateDepartment(\n\tdepartmentId: string,\n\tformData: FormData,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst { data: currentUserTeam } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!currentUserTeam?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify department belongs to company\n\t\tconst { data: existingDepartment } = await supabase\n\t\t\t.from(\"departments\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"id\", departmentId)\n\t\t\t.single();\n\n\t\tassertExists(existingDepartment, \"Department\");\n\n\t\tif (existingDepartment.company_id !== currentUserTeam.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"department\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst data = createDepartmentSchema.parse({\n\t\t\tname: formData.get(\"name\"),\n\t\t\tdescription: formData.get(\"description\") || undefined,\n\t\t\tmanagerId: formData.get(\"managerId\") || undefined,\n\t\t});\n\n\t\t// Update department\n\t\tconst { error: updateError } = await supabase\n\t\t\t.from(\"departments\")\n\t\t\t.update({\n\t\t\t\tname: data.name,\n\t\t\t\tdescription: data.description,\n\t\t\t})\n\t\t\t.eq(\"id\", departmentId);\n\n\t\tif (updateError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"update department\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team/departments\");\n\t});\n}\n\n/**\n * Delete department\n */\nasync function deleteDepartment(\n\tdepartmentId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst { data: currentUserTeam } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!currentUserTeam?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify department belongs to company\n\t\tconst { data: existingDepartment } = await supabase\n\t\t\t.from(\"departments\")\n\t\t\t.select(\"company_id, name\")\n\t\t\t.eq(\"id\", departmentId)\n\t\t\t.single();\n\n\t\tassertExists(existingDepartment, \"Department\");\n\n\t\tif (existingDepartment.company_id !== currentUserTeam.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"department\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Check if department has members\n\t\tconst { data: teamMembersInDept, error: checkError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"department_id\", departmentId)\n\t\t\t.limit(1);\n\n\t\tif (checkError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to check department usage\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tif (teamMembersInDept && teamMembersInDept.length > 0) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.cannotDelete(\n\t\t\t\t\t\"department\",\n\t\t\t\t\t\"it still has team members assigned\",\n\t\t\t\t),\n\t\t\t\tERROR_CODES.BUSINESS_RULE_VIOLATION,\n\t\t\t);\n\t\t}\n\n\t\t// Delete department\n\t\tconst { error: deleteError } = await supabase\n\t\t\t.from(\"departments\")\n\t\t\t.delete()\n\t\t\t.eq(\"id\", departmentId);\n\n\t\tif (deleteError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"delete department\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team/departments\");\n\t});\n}\n\n// ============================================================================\n// FETCH FUNCTIONS\n// ============================================================================\n\nexport type TeamMemberWithDetails = {\n\tid: string;\n\tuser_id: string | null;\n\tcompany_id: string;\n\trole_id: string | null;\n\tdepartment_id: string | null;\n\tstatus: string;\n\tjob_title: string | null;\n\tphone: string | null;\n\temail: string | null;\n\tinvited_name: string | null;\n\tinvited_email: string | null;\n\tinvited_at: string | null;\n\tjoined_at: string | null;\n\tlast_active_at: string | null;\n\tcreated_at: string;\n\tarchived_at: string | null;\n\tuser: {\n\t\tid: string;\n\t\tname: string;\n\t\temail: string;\n\t\tavatar: string | null;\n\t} | null;\n\trole: {\n\t\tid: string;\n\t\tname: string;\n\t\tcolor: string | null;\n\t} | null;\n\tdepartment: {\n\t\tid: string;\n\t\tname: string;\n\t\tcolor: string | null;\n\t} | null;\n};\n\n/**\n * Get all team members for current user's company\n */\nasync function getTeamMembers() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get active company ID (handles users in multiple companies)\n\t\tconst companyId = await getActiveCompanyId();\n\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Fetch all team members for the company (including archived)\n\t\tconst { data: members, error: membersError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\n\t\t\t\t`\n        id,\n        user_id,\n        company_id,\n        role_id,\n        department_id,\n        status,\n        job_title,\n        phone,\n        email,\n        invited_at,\n        joined_at,\n        last_active_at,\n        created_at,\n        archived_at,\n        invited_name,\n        invited_email\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (membersError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch team members\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\tundefined,\n\t\t\t\tmembersError,\n\t\t\t);\n\t\t}\n\n\t\tif (!members || members.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\t// Get unique user IDs and role IDs\n\t\tconst userIds = [\n\t\t\t...new Set(\n\t\t\t\tmembers\n\t\t\t\t\t.map((m) => m.user_id)\n\t\t\t\t\t.filter((value): value is string => typeof value === \"string\"),\n\t\t\t),\n\t\t];\n\t\tconst roleIds = [...new Set(members.map((m) => m.role_id).filter(Boolean))];\n\n\t\t// Fetch user details from profiles\n\t\tconst { data: users } =\n\t\t\tuserIds.length > 0\n\t\t\t\t? await supabase\n\t\t\t\t\t\t.from(\"profiles\")\n\t\t\t\t\t\t.select(\"id, full_name, email, avatar_url\")\n\t\t\t\t\t\t.in(\"id\", userIds)\n\t\t\t\t: { data: [] };\n\n\t\t// Fetch role details\n\t\tconst { data: roles } = await supabase\n\t\t\t.from(\"custom_roles\")\n\t\t\t.select(\"id, name, color\")\n\t\t\t.in(\"id\", roleIds);\n\n\t\t// Create lookup maps\n\t\tconst usersMap = new Map(users?.map((u) => [u.id, u]) || []);\n\t\tconst rolesMap = new Map(roles?.map((r) => [r.id, r]) || []);\n\n\t\t// Transform the data to match expected structure\n\t\tconst transformedMembers = members.map((member: any) => {\n\t\t\tconst resolvedUser =\n\t\t\t\tmember.user_id && usersMap.get(member.user_id)\n\t\t\t\t\t? usersMap.get(member.user_id)\n\t\t\t\t\t: null;\n\n\t\t\treturn {\n\t\t\t\tid: member.id,\n\t\t\t\tuser_id: member.user_id,\n\t\t\t\tcompany_id: member.company_id,\n\t\t\t\trole: member.role,\n\t\t\t\tdepartment_id: member.department_id,\n\t\t\t\tstatus: member.status,\n\t\t\t\tjob_title: member.job_title,\n\t\t\t\tinvited_at: member.invited_at,\n\t\t\t\taccepted_at: member.accepted_at,\n\t\t\t\tcreated_at: member.created_at,\n\t\t\t\tupdated_at: member.updated_at,\n\t\t\t\tuser: resolvedUser || null,\n\t\t\t\tdepartment: null, // Department FK will be resolved when departments table is linked\n\t\t\t};\n\t\t});\n\n\t\treturn transformedMembers;\n\t});\n}\n\n/**\n * Get all roles for current user's company\n */\nasync function getRoles(): Promise<\n\tActionResult<\n\t\tArray<{\n\t\t\tid: string;\n\t\t\tname: string;\n\t\t\tdescription: string | null;\n\t\t\tcolor: string | null;\n\t\t\tpermissions: string[];\n\t\t\tis_system: boolean;\n\t\t\tmember_count?: number;\n\t\t}>\n\t>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Fetch roles\n\t\tconst { data: roles, error } = await supabase\n\t\t\t.from(\"custom_roles\")\n\t\t\t.select(\"id, name, description, color, permissions, is_system\")\n\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t.order(\"name\");\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch roles\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// PERFORMANCE OPTIMIZED: Pattern #5 Fix - Single query + in-memory aggregation\n\t\t// BEFORE: 20 COUNT queries (1 per role)\n\t\t// AFTER: 1 query + in-memory GROUP BY\n\t\t// Performance gain: ~5 seconds saved (95% reduction)\n\n\t\t// Single query to get all role_id counts\n\t\tconst { data: roleCounts } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"role_id\")\n\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t.not(\"role_id\", \"is\", null);\n\n\t\t// Aggregate counts by role in-memory\n\t\tconst countsMap = (roleCounts || []).reduce(\n\t\t\t(acc, member) => {\n\t\t\t\tacc[member.role_id] = (acc[member.role_id] || 0) + 1;\n\t\t\t\treturn acc;\n\t\t\t},\n\t\t\t{} as Record<string, number>,\n\t\t);\n\n\t\t// Map roles with their counts\n\t\tconst rolesWithCounts = roles.map((role) => ({\n\t\t\t...role,\n\t\t\tmember_count: countsMap[role.id] || 0,\n\t\t}));\n\n\t\treturn rolesWithCounts;\n\t});\n}\n\nasync function getRoleDetails(roleId: string): Promise<\n\tActionResult<{\n\t\tid: string;\n\t\tname: string;\n\t\tdescription: string | null;\n\t\tcolor: string | null;\n\t\tpermissions: string[];\n\t\tis_system: boolean;\n\t\tmember_count: number;\n\t}>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst { data: role, error } = await supabase\n\t\t\t.from(\"custom_roles\")\n\t\t\t.select(\n\t\t\t\t\"id, name, description, color, permissions, is_system, company_id\",\n\t\t\t)\n\t\t\t.eq(\"id\", roleId)\n\t\t\t.single();\n\n\t\tif (error || !role) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.notFound(\"role\"),\n\t\t\t\tERROR_CODES.NOT_FOUND,\n\t\t\t);\n\t\t}\n\n\t\tif (role.company_id !== companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.forbidden(\"role\"),\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst { count } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"*\", { count: \"exact\", head: true })\n\t\t\t.eq(\"role_id\", roleId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\treturn {\n\t\t\tid: role.id,\n\t\t\tname: role.name,\n\t\t\tdescription: role.description,\n\t\t\tcolor: role.color,\n\t\t\tpermissions: Array.isArray(role.permissions)\n\t\t\t\t? (role.permissions as string[])\n\t\t\t\t: [],\n\t\t\tis_system: role.is_system,\n\t\t\tmember_count: count ?? 0,\n\t\t};\n\t});\n}\n\n/**\n * Get all departments for current user's company\n */\nasync function getDepartments(): Promise<\n\tActionResult<\n\t\tArray<{\n\t\t\tid: string;\n\t\t\tname: string;\n\t\t\tdescription: string | null;\n\t\t\tcolor: string | null;\n\t\t\tmember_count?: number;\n\t\t}>\n\t>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Fetch departments\n\t\tconst { data: departments, error } = await supabase\n\t\t\t.from(\"departments\")\n\t\t\t.select(\"id, name, description, color\")\n\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t.order(\"name\");\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch departments\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// PERFORMANCE OPTIMIZED: Pattern #6 Fix - Single query + in-memory aggregation\n\t\t// BEFORE: 10 COUNT queries (1 per department)\n\t\t// AFTER: 1 query + in-memory GROUP BY\n\t\t// Performance gain: ~3 seconds saved (90% reduction)\n\n\t\t// Single query to get all department_id counts\n\t\tconst { data: deptCounts } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"department_id\")\n\t\t\t.eq(\"company_id\", teamMember.company_id)\n\t\t\t.not(\"department_id\", \"is\", null);\n\n\t\t// Aggregate counts by department in-memory\n\t\tconst deptCountsMap = (deptCounts || []).reduce(\n\t\t\t(acc, member) => {\n\t\t\t\tacc[member.department_id] = (acc[member.department_id] || 0) + 1;\n\t\t\t\treturn acc;\n\t\t\t},\n\t\t\t{} as Record<string, number>,\n\t\t);\n\n\t\t// Map departments with their counts\n\t\tconst departmentsWithCounts = departments.map((dept) => ({\n\t\t\t...dept,\n\t\t\tmember_count: deptCountsMap[dept.id] || 0,\n\t\t}));\n\n\t\treturn departmentsWithCounts;\n\t});\n}\n\n// ============================================================================\n// TEAM OVERVIEW SNAPSHOT\n// ============================================================================\n\nexport type TeamOverviewSnapshot = {\n\tgeneratedAt: string;\n\treadinessScore: number;\n\tstepsCompleted: number;\n\ttotalSteps: number;\n\ttotals: {\n\t\tmembers: number;\n\t\tactive: number;\n\t\tinvited: number;\n\t\tsuspended: number;\n\t};\n\tlastInviteAt: string | null;\n\tonboardingAcceptanceRate: number;\n\troles: {\n\t\ttotal: number;\n\t\tsystem: number;\n\t\tcustom: number;\n\t};\n\tdepartments: {\n\t\ttotal: number;\n\t\tmembersAssigned: number;\n\t};\n};\n\nasync function getTeamOverview(): Promise<ActionResult<TeamOverviewSnapshot>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst [membersResult, rolesResult, departmentsResult] = await Promise.all([\n\t\t\tsupabase\n\t\t\t\t.from(\"company_memberships\")\n\t\t\t\t.select(\"status, invited_at, joined_at, department_id\")\n\t\t\t\t.eq(\"company_id\", companyId),\n\t\t\tsupabase\n\t\t\t\t.from(\"custom_roles\")\n\t\t\t\t.select(\"id, is_system\")\n\t\t\t\t.eq(\"company_id\", companyId),\n\t\t\tsupabase.from(\"departments\").select(\"id\").eq(\"company_id\", companyId),\n\t\t]);\n\n\t\tif (membersResult.error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch team members\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\t\tif (rolesResult.error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch roles\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\t\tif (departmentsResult.error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"fetch departments\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst members = membersResult.data ?? [];\n\t\tconst roles = rolesResult.data ?? [];\n\t\tconst departments = departmentsResult.data ?? [];\n\n\t\tconst totals = members.reduce(\n\t\t\t(acc, member) => {\n\t\t\t\tacc.members += 1;\n\t\t\t\tif (member.status === \"active\") {\n\t\t\t\t\tacc.active += 1;\n\t\t\t\t} else if (member.status === \"invited\" || member.status === \"pending\") {\n\t\t\t\t\tacc.invited += 1;\n\t\t\t\t} else if (\n\t\t\t\t\tmember.status === \"suspended\" ||\n\t\t\t\t\tmember.status === \"inactive\" ||\n\t\t\t\t\tmember.status === \"disabled\" ||\n\t\t\t\t\tmember.status === \"archived\"\n\t\t\t\t) {\n\t\t\t\t\tacc.suspended += 1;\n\t\t\t\t}\n\t\t\t\treturn acc;\n\t\t\t},\n\t\t\t{ members: 0, active: 0, invited: 0, suspended: 0 },\n\t\t);\n\n\t\tconst lastInviteAt =\n\t\t\tmembers\n\t\t\t\t.filter((member) => member.invited_at)\n\t\t\t\t.sort(\n\t\t\t\t\t(a, b) =>\n\t\t\t\t\t\tnew Date(b.invited_at!).getTime() -\n\t\t\t\t\t\tnew Date(a.invited_at!).getTime(),\n\t\t\t\t)[0]?.invited_at ?? null;\n\n\t\tconst onboardingAcceptanceRate =\n\t\t\ttotals.active + totals.invited === 0\n\t\t\t\t? 1\n\t\t\t\t: totals.active / (totals.active + totals.invited);\n\n\t\tconst systemRoles = roles.filter((role) => role.is_system).length;\n\t\tconst customRoles = roles.length - systemRoles;\n\n\t\tconst membersWithDepartments = members.filter(\n\t\t\t(member) => member.department_id,\n\t\t).length;\n\n\t\tconst readinessSteps = [\n\t\t\ttotals.active > 0,\n\t\t\tcustomRoles > 0,\n\t\t\tdepartments.length > 0,\n\t\t\tonboardingAcceptanceRate >= 0.6 || totals.invited === 0,\n\t\t\tmembersWithDepartments > 0,\n\t\t];\n\n\t\tconst stepsCompleted = readinessSteps.filter(Boolean).length;\n\t\tconst readinessScore = Math.round(\n\t\t\t(stepsCompleted / readinessSteps.length) * 100,\n\t\t);\n\n\t\treturn {\n\t\t\tgeneratedAt: new Date().toISOString(),\n\t\t\treadinessScore,\n\t\t\tstepsCompleted,\n\t\t\ttotalSteps: readinessSteps.length,\n\t\t\ttotals,\n\t\t\tlastInviteAt,\n\t\t\tonboardingAcceptanceRate,\n\t\t\troles: {\n\t\t\t\ttotal: roles.length,\n\t\t\t\tsystem: systemRoles,\n\t\t\t\tcustom: customRoles,\n\t\t\t},\n\t\t\tdepartments: {\n\t\t\t\ttotal: departments.length,\n\t\t\t\tmembersAssigned: membersWithDepartments,\n\t\t\t},\n\t\t};\n\t});\n}\n"],"names":[],"mappings":"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"}