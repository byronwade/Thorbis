module.exports=[839691,a=>{"use strict";var b=a.i(780195),c=a.i(218188),d=a.i(146057);a.i(467361);var e=a.i(445074),f=a.i(818944),g=a.i(974406),h=a.i(136874);async function i(a,b,c,d,e,f="medium",g,j,k){try{let i=await (0,h.createClient)();if(!i)return{success:!1,error:"Supabase client not configured"};let{data:l,error:m}=await i.from("notifications").insert({user_id:b,company_id:c,type:a,priority:f,title:d,message:e,action_url:g,action_label:j,metadata:k||{}}).select().single();if(m)return{success:!1,error:m.message};return{success:!0,data:l}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function j(a,b,c){try{let d=await (0,h.createClient)();if(!d)return!0;let{data:e,error:f}=await d.from("notification_preferences").select("enabled").eq("user_id",a).eq("company_id",b).eq("channel","in_app").eq("event_type",c).single();if(f||!e)return!0;return e.enabled}catch{return!0}}async function k(a){return await j(a.userId,a.companyId,"job_created")?i("job",a.userId,a.companyId,"New Job Assignment",`Job "${a.jobTitle}" has been assigned to you at ${a.address}`,a.priority||"medium",a.actionUrl||"/dashboard/work","View Job",{job_id:a.jobId,address:a.address}):{success:!0,skipped:!0}}let l={quoted:["scheduled","cancelled"],scheduled:["in_progress","on_hold","cancelled"],in_progress:["on_hold","completed","cancelled"],on_hold:["scheduled","in_progress","cancelled"],completed:["invoiced"],cancelled:["quoted","scheduled"],invoiced:["paid"],paid:[]},m={quoted:["customer_id"],scheduled:["customer_id","scheduled_start","scheduled_end"],in_progress:["customer_id","scheduled_start","assigned_to"],on_hold:["customer_id"],completed:["customer_id","scheduled_start"],cancelled:[],invoiced:["customer_id","total_amount"],paid:["customer_id","total_amount"]},n={customer_id:"Customer",scheduled_start:"Start Date",scheduled_end:"End Date",assigned_to:"Assigned Team Member",property_id:"Property",total_amount:"Total Amount"};function o(a){let{currentStatus:b,newStatus:c,job:d}=a;if(b===c)return{allowed:!0};let e=l[b];if(!e.includes(c))return{allowed:!1,reason:`Cannot transition from "${b}" to "${c}". Valid next statuses: ${e.join(", ")}`};let f=m[c],g=[];for(let a of f){let b=d[a];(null==b||""===b)&&g.push(n[a]||a)}if(g.length>0)return{allowed:!1,reason:`Cannot transition to "${c}" - missing required fields`,requiredFields:g};let h=[];if("scheduled"!==b||"in_progress"!==c||d.teamAssignments&&0!==d.teamAssignments.length||h.push("No team members assigned to this job"),"completed"===b&&"invoiced"===c){let a=d.estimates&&d.estimates.length>0,b=d.total_amount&&d.total_amount>0;if(!a&&!b)return{allowed:!1,reason:"Cannot create invoice - no estimates or total amount defined"}}if("invoiced"===b&&"paid"===c){if(!d.invoices||0===d.invoices.length)return{allowed:!1,reason:"Cannot mark as paid - no invoices found"};let a=d.invoices.filter(a=>"paid"!==a.status&&"cancelled"!==a.status);if(a.length>0)return{allowed:!1,reason:`Cannot mark as paid - ${a.length} invoice(s) still unpaid`}}return"paid"===b?{allowed:!1,reason:"Cannot change status of paid jobs. Create a new job if needed."}:{allowed:!0,warnings:h.length>0?h:void 0}}var p=a.i(395731);let q=/JOB-\d{4}-(\d+)/,r=d.z.object({propertyId:d.z.string().uuid("Invalid property ID"),customerId:d.z.string().uuid("Invalid customer ID").optional(),title:d.z.string().min(1,"Job title is required"),description:d.z.string().optional(),priority:d.z.enum(["low","medium","high","urgent"]).default("medium"),jobType:d.z.enum(["service","installation","repair","maintenance","inspection","consultation"]).optional(),scheduledStart:d.z.string().optional(),scheduledEnd:d.z.string().optional(),assignedTo:d.z.string().uuid("Invalid user ID").optional(),notes:d.z.string().optional(),isRecurring:d.z.boolean().optional(),schedulingMode:d.z.enum(["specific","window"]).optional(),timeWindow:d.z.string().optional(),recurrenceType:d.z.enum(["daily","weekly","biweekly","monthly","quarterly","yearly"]).optional(),recurrenceEndDate:d.z.string().optional(),recurrenceCount:d.z.number().int().min(1).max(365).optional()}),s=d.z.object({title:d.z.string().min(1,"Job title is required").optional(),description:d.z.string().optional(),status:d.z.enum(["quoted","scheduled","in_progress","on_hold","completed","cancelled","invoiced","paid"]).optional(),priority:d.z.enum(["low","medium","high","urgent"]).optional(),jobType:d.z.enum(["service","installation","repair","maintenance","inspection","consultation"]).optional(),notes:d.z.string().optional(),totalAmount:d.z.number().min(0).optional(),paidAmount:d.z.number().min(0).optional(),depositAmount:d.z.number().min(0).optional(),scheduledStart:d.z.string().optional(),scheduledEnd:d.z.string().optional(),assignedTo:d.z.string().uuid("Invalid user ID").optional().nullable(),customerId:d.z.string().uuid("Invalid customer ID").optional().nullable(),propertyId:d.z.string().uuid("Invalid property ID").optional().nullable()});async function t(a,b){let{data:c}=await a.from("jobs").select("job_number").eq("company_id",b).order("created_at",{ascending:!1}).limit(1).single();if(!c)return`JOB-${new Date().getFullYear()}-001`;let d=c.job_number.match(q);if(d){let a=Number.parseInt(d[1],10)+1;return`JOB-${new Date().getFullYear()}-${a.toString().padStart(3,"0")}`}return`JOB-${new Date().getFullYear()}-${Date.now().toString().slice(-3)}`}async function u(a,b,c,d,e,f){if(!c.scheduled_start)return;let g=new Date(c.scheduled_start),h=new Date(c.scheduled_end||c.scheduled_start).getTime()-g.getTime(),i=f||52,j=e?new Date(e):null,k=[],l=new Date(g);for(let e=0;e<i-1&&(l=function(a,b){let c=new Date(a);switch(b){case"daily":c.setDate(c.getDate()+1);break;case"weekly":c.setDate(c.getDate()+7);break;case"biweekly":c.setDate(c.getDate()+14);break;case"monthly":default:c.setMonth(c.getMonth()+1);break;case"quarterly":c.setMonth(c.getMonth()+3);break;case"yearly":c.setFullYear(c.getFullYear()+1)}return c}(l,d),!j||!(l>j));e++){let d=new Date(l.getTime()+h),f=await t(a,b);k.push({...c,job_number:f,scheduled_start:l.toISOString(),scheduled_end:d.toISOString(),title:`${c.title} (${e+2}/${i})`}),k.length>=10&&(await a.from("jobs").insert(k),k.length=0)}k.length>0&&await a.from("jobs").insert(k)}async function v(b){return(0,g.withErrorHandling)(async()=>{let d=await (0,h.createClient)();if(!d)throw new f.ActionError("Database connection failed",f.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:e}}=await d.auth.getUser();(0,g.assertAuthenticated)(e?.id);let{getActiveCompanyId:i}=await a.A(37652),j=await i();if(!j)throw new f.ActionError("You must be part of a company",f.ERROR_CODES.AUTH_FORBIDDEN,403);let l=r.parse({propertyId:b.get("propertyId"),customerId:b.get("customerId")||void 0,title:b.get("title"),description:b.get("description")||void 0,priority:b.get("priority")||"medium",jobType:b.get("jobType")||void 0,scheduledStart:b.get("scheduledStart")||void 0,scheduledEnd:b.get("scheduledEnd")||void 0,assignedTo:b.get("assignedTo")||void 0,notes:b.get("notes")||void 0,isRecurring:"true"===b.get("isRecurring"),schedulingMode:b.get("schedulingMode")||void 0,timeWindow:b.get("timeWindow")||void 0,recurrenceType:b.get("recurrenceType")||void 0,recurrenceEndDate:b.get("recurrenceEndDate")||void 0,recurrenceCount:b.get("recurrenceCount")?Number.parseInt(b.get("recurrenceCount"),10):void 0}),{data:m}=await d.from("properties").select("company_id, customer_id, address").eq("id",l.propertyId).single();if((0,g.assertExists)(m,"Property"),m.company_id!==j)throw new f.ActionError(f.ERROR_MESSAGES.forbidden("property"),f.ERROR_CODES.AUTH_FORBIDDEN,403);let n=l.customerId||m.customer_id,o=await t(d,j),p=l.notes||"";if("window"===l.schedulingMode&&l.timeWindow){let a=`

[Scheduling] Customer preferred time window: ${l.timeWindow.charAt(0).toUpperCase()+l.timeWindow.slice(1)}`;p=p?`${p}${a}`:a.trim()}let{data:q,error:s}=await d.from("jobs").insert({company_id:j,property_id:l.propertyId,customer_id:n,assigned_to:l.assignedTo,job_number:o,title:l.title,description:l.description,status:"quoted",priority:l.priority,job_type:l.jobType,service_type:l.jobType,scheduled_start:l.scheduledStart,scheduled_end:l.scheduledEnd,notes:p}).select("id").single();if(s)throw new f.ActionError(f.ERROR_MESSAGES.operationFailed("create job"),f.ERROR_CODES.DB_QUERY_ERROR);if((await Promise.all([d.from("job_financial").insert({job_id:q.id,company_id:j,total_amount:0,paid_amount:0,deposit_amount:0}),d.from("job_workflow").insert({job_id:q.id,company_id:j,workflow_completed_stages:[]}),d.from("job_time_tracking").insert({job_id:q.id,company_id:j,total_labor_hours:0,break_time_minutes:0}),d.from("job_customer_approval").insert({job_id:q.id,company_id:j,customer_approval_status:"pending"}),d.from("job_equipment_service").insert({job_id:q.id,company_id:j,equipment_service_history:[],equipment_serviced:[]}),d.from("job_dispatch").insert({job_id:q.id,company_id:j}),d.from("job_quality").insert({job_id:q.id,company_id:j,inspection_required:!1}),d.from("job_safety").insert({job_id:q.id,company_id:j,requires_permit:!1}),d.from("job_ai_enrichment").insert({job_id:q.id,company_id:j}),d.from("job_multi_entity").insert({job_id:q.id,company_id:j,requires_multiple_properties:!1,requires_multiple_customers:!1})])).filter(a=>a.error).length>0)throw await d.from("jobs").delete().eq("id",q.id),new f.ActionError(f.ERROR_MESSAGES.operationFailed("create job domains"),f.ERROR_CODES.DB_QUERY_ERROR);if(l.isRecurring&&l.recurrenceType&&l.scheduledStart){let a={company_id:j,property_id:l.propertyId,customer_id:n,assigned_to:l.assignedTo,title:l.title,description:l.description,status:"quoted",priority:l.priority,job_type:l.jobType,scheduled_start:l.scheduledStart,scheduled_end:l.scheduledEnd,notes:l.notes};await u(d,j,a,l.recurrenceType,l.recurrenceEndDate,l.recurrenceCount)}return l.assignedTo&&l.assignedTo!==e.id&&await k({userId:l.assignedTo,companyId:j,jobId:q.id,jobTitle:l.title,address:m.address||"Unknown address",priority:"urgent"===l.priority?"urgent":"high"===l.priority?"high":"medium",actionUrl:"/dashboard/work"}),(0,c.revalidatePath)("/dashboard/work"),(0,c.revalidatePath)("/dashboard/work/jobs"),q.id})}async function w(a,b){return(0,g.withErrorHandling)(async()=>{let d=await (0,h.createClient)();if(!d)throw new f.ActionError("Database connection failed",f.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:i}}=await d.auth.getUser();(0,g.assertAuthenticated)(i?.id);let j=await (0,e.getActiveCompanyId)();if(!j)throw new f.ActionError("You must be part of a company",f.ERROR_CODES.AUTH_FORBIDDEN,403);let{data:k}=await d.from("company_memberships").select(`
        role_id,
        custom_roles!role_id(name, is_system)
      `).eq("user_id",i.id).eq("company_id",j).eq("status","active").maybeSingle(),l=Array.isArray(k?.custom_roles)?k.custom_roles[0]:k?.custom_roles,m=l?.name==="Admin"||l?.name==="Owner"||l?.is_system===!0,{data:n}=await d.from("jobs").select("company_id, status").eq("id",a).single();if((0,g.assertExists)(n,"Job"),n.company_id!==j)throw new f.ActionError(f.ERROR_MESSAGES.forbidden("job"),f.ERROR_CODES.AUTH_FORBIDDEN,403);if(!m&&("completed"===n.status||"cancelled"===n.status))throw new f.ActionError(`Cannot edit ${n.status} jobs`,f.ERROR_CODES.OPERATION_NOT_ALLOWED);let p=b.get("customerId"),q=b.get("propertyId"),r=s.parse({title:b.get("title")||void 0,description:b.get("description")||void 0,status:b.get("status")||void 0,priority:b.get("priority")||void 0,jobType:b.get("jobType")||void 0,notes:b.get("notes")||void 0,totalAmount:b.get("totalAmount")?Number.parseInt(b.get("totalAmount"),10):void 0,paidAmount:b.get("paidAmount")?Number.parseInt(b.get("paidAmount"),10):void 0,depositAmount:b.get("depositAmount")?Number.parseInt(b.get("depositAmount"),10):void 0,scheduledStart:b.get("scheduledStart")||void 0,scheduledEnd:b.get("scheduledEnd")||void 0,assignedTo:b.get("assignedTo")||null,customerId:null==p?void 0:""===p||"null"===p?null:p,propertyId:null==q?void 0:""===q||"null"===q?null:q});if(void 0!==r.status&&r.status!==n.status){let{data:b}=await d.from("jobs").select(`
					id,
					status,
					scheduled_start,
					scheduled_end,
					assigned_to,
					customer_id,
					property_id,
					total_amount,
					invoices:invoices(status, total_amount),
					estimates:estimates(status),
					team_assignments:job_team_assignments(team_member_id)
				`).eq("id",a).single();if(b){let c=o({currentStatus:b.status,newStatus:r.status,job:{id:b.id,scheduled_start:r.scheduledStart||b.scheduled_start,scheduled_end:r.scheduledEnd||b.scheduled_end,assigned_to:void 0!==r.assignedTo?r.assignedTo:b.assigned_to,customer_id:void 0!==r.customerId?r.customerId:b.customer_id,property_id:void 0!==r.propertyId?r.propertyId:b.property_id,total_amount:void 0!==r.totalAmount?r.totalAmount:b.total_amount,invoices:b.invoices||[],estimates:b.estimates||[],teamAssignments:b.team_assignments||[]}});if(!c.allowed){let a=c.reason||"Status transition not allowed";throw c.requiredFields&&c.requiredFields.length>0&&(a+=`. Missing: ${c.requiredFields.join(", ")}`),new f.ActionError(a,f.ERROR_CODES.VALIDATION_FAILED)}c.warnings&&c.warnings.length>0&&console.warn("⚠️ Status transition warnings:",{jobId:a,currentStatus:b.status,newStatus:r.status,warnings:c.warnings})}}let t={};if(void 0!==r.title&&(t.title=r.title),void 0!==r.description&&(t.description=r.description),void 0!==r.status&&(t.status=r.status),void 0!==r.priority&&(t.priority=r.priority),void 0!==r.jobType&&(t.job_type=r.jobType),void 0!==r.notes&&(t.notes=r.notes),void 0!==r.scheduledStart&&(t.scheduled_start=r.scheduledStart),void 0!==r.scheduledEnd&&(t.scheduled_end=r.scheduledEnd),void 0!==r.assignedTo&&(t.assigned_to=r.assignedTo),void 0!==r.customerId&&(t.customer_id=r.customerId),void 0!==r.propertyId&&(t.property_id=r.propertyId,null!==r.propertyId&&void 0!==r.customerId&&null!==r.customerId)){let{data:a}=await d.from("properties").select("customer_id").eq("id",r.propertyId).single();if(a&&a.customer_id!==r.customerId)throw new f.ActionError("Property does not belong to the selected customer",f.ERROR_CODES.VALIDATION_FAILED)}let u={};void 0!==r.totalAmount&&(u.total_amount=r.totalAmount),void 0!==r.paidAmount&&(u.paid_amount=r.paidAmount),void 0!==r.depositAmount&&(u.deposit_amount=r.depositAmount);let v=[];if(Object.keys(t).length>0&&v.push((async()=>await d.from("jobs").update(t).eq("id",a))()),Object.keys(u).length>0&&v.push((async()=>await d.from("job_financial").update(u).eq("job_id",a))()),v.length>0){let a=(await Promise.all(v)).filter(a=>a.error);if(a.length>0){let b=a.map(a=>a.error.message).join(", ");throw new f.ActionError(`${f.ERROR_MESSAGES.operationFailed("update job")}: ${b}`,f.ERROR_CODES.DB_QUERY_ERROR)}}(0,c.revalidatePath)("/dashboard/work"),(0,c.revalidatePath)(`/dashboard/work/${a}`)})}async function x(b,d){return(0,g.withErrorHandling)(async()=>{let e=await (0,h.createClient)();if(!e)throw new f.ActionError("Database connection failed",f.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:i}}=await e.auth.getUser();(0,g.assertAuthenticated)(i?.id);let{getActiveCompanyId:j}=await a.A(37652),k=await j();if(!k)throw new f.ActionError("You must be part of a company",f.ERROR_CODES.AUTH_FORBIDDEN,403);if(!["quoted","scheduled","in_progress","on_hold","completed","cancelled","invoiced","paid"].includes(d))throw new f.ActionError("Invalid job status",f.ERROR_CODES.VALIDATION_FAILED);let{data:l}=await e.from("jobs").select(`
				id,
				company_id,
				status,
				scheduled_start,
				scheduled_end,
				assigned_to,
				customer_id,
				property_id,
				total_amount,
				invoices:invoices(status, total_amount),
				estimates:estimates(status),
				team_assignments:job_team_assignments(team_member_id)
			`).eq("id",b).single();if((0,g.assertExists)(l,"Job"),l.company_id!==k)throw new f.ActionError(f.ERROR_MESSAGES.forbidden("job"),f.ERROR_CODES.AUTH_FORBIDDEN,403);let m=o({currentStatus:l.status,newStatus:d,job:{id:l.id,scheduled_start:l.scheduled_start,scheduled_end:l.scheduled_end,assigned_to:l.assigned_to,customer_id:l.customer_id,property_id:l.property_id,total_amount:l.total_amount,invoices:l.invoices||[],estimates:l.estimates||[],teamAssignments:l.team_assignments||[]}});if(!m.allowed){let a=m.reason||"Status transition not allowed";throw m.requiredFields&&m.requiredFields.length>0&&(a+=`. Missing: ${m.requiredFields.join(", ")}`),new f.ActionError(a,f.ERROR_CODES.VALIDATION_FAILED)}m.warnings&&m.warnings.length>0&&console.warn("⚠️ Status transition warnings:",{jobId:b,currentStatus:l.status,newStatus:d,warnings:m.warnings});let{error:n}=await e.from("jobs").update({status:d}).eq("id",b);if(n)throw new f.ActionError(f.ERROR_MESSAGES.operationFailed("update job status"),f.ERROR_CODES.DB_QUERY_ERROR);(0,c.revalidatePath)("/dashboard/work"),(0,c.revalidatePath)(`/dashboard/work/${b}`)})}async function y(b){return(0,g.withErrorHandling)(async()=>{let d=await (0,h.createClient)();if(!d)throw new f.ActionError("Database connection failed",f.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:e}}=await d.auth.getUser();(0,g.assertAuthenticated)(e?.id);let{getActiveCompanyId:i}=await a.A(37652),j=await i();if(!j)throw new f.ActionError("You must be part of a company",f.ERROR_CODES.AUTH_FORBIDDEN,403);let{data:k}=await d.from("jobs").select("company_id, status").eq("id",b).single();if((0,g.assertExists)(k,"Job"),k.company_id!==j)throw new f.ActionError(f.ERROR_MESSAGES.forbidden("job"),f.ERROR_CODES.AUTH_FORBIDDEN,403);if("scheduled"!==k.status&&"quoted"!==k.status)throw new f.ActionError("Job must be scheduled before starting",f.ERROR_CODES.OPERATION_NOT_ALLOWED);let l=new Date().toISOString();if((await Promise.all([d.from("jobs").update({status:"in_progress"}).eq("id",b),d.from("job_time_tracking").update({actual_start:l}).eq("job_id",b)])).filter(a=>a.error).length>0)throw new f.ActionError(f.ERROR_MESSAGES.operationFailed("start job"),f.ERROR_CODES.DB_QUERY_ERROR);(0,c.revalidatePath)("/dashboard/work"),(0,c.revalidatePath)(`/dashboard/work/${b}`)})}async function z(b){return(0,g.withErrorHandling)(async()=>{let d=await (0,h.createClient)();if(!d)throw new f.ActionError("Database connection failed",f.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:e}}=await d.auth.getUser();(0,g.assertAuthenticated)(e?.id);let{getActiveCompanyId:i}=await a.A(37652),j=await i();if(!j)throw new f.ActionError("You must be part of a company",f.ERROR_CODES.AUTH_FORBIDDEN,403);let{data:k}=await d.from("jobs").select("company_id, status, timeTracking:job_time_tracking(*)").eq("id",b).single();if((0,g.assertExists)(k,"Job"),k.company_id!==j)throw new f.ActionError(f.ERROR_MESSAGES.forbidden("job"),f.ERROR_CODES.AUTH_FORBIDDEN,403);if("in_progress"!==k.status)throw new f.ActionError("Job must be in progress to complete",f.ERROR_CODES.OPERATION_NOT_ALLOWED);let l=new Date().toISOString(),m=Array.isArray(k.timeTracking)?k.timeTracking[0]:k.timeTracking,n={actual_end:l};if(m?.actual_start){let a=new Date(m.actual_start).getTime();n.total_labor_hours=(new Date(l).getTime()-a)/36e5}if((await Promise.all([d.from("jobs").update({status:"completed"}).eq("id",b),d.from("job_time_tracking").update(n).eq("job_id",b)])).filter(a=>a.error).length>0)throw new f.ActionError(f.ERROR_MESSAGES.operationFailed("complete job"),f.ERROR_CODES.DB_QUERY_ERROR);(0,c.revalidatePath)("/dashboard/work"),(0,c.revalidatePath)(`/dashboard/work/${b}`)})}async function A(a){return(0,g.withErrorHandling)(async()=>{let b=await (0,h.createClient)();if(!b)throw new f.ActionError("Database connection failed",f.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:d}}=await b.auth.getUser();(0,g.assertAuthenticated)(d?.id);let{data:e}=await b.from("company_memberships").select("company_id").eq("user_id",d.id).single();if(!e?.company_id)throw new f.ActionError("You must be part of a company",f.ERROR_CODES.AUTH_FORBIDDEN,403);let{data:i}=await b.from("jobs").select("company_id, status").eq("id",a).single();if((0,g.assertExists)(i,"Job"),i.company_id!==e.company_id)throw new f.ActionError(f.ERROR_MESSAGES.forbidden("job"),f.ERROR_CODES.AUTH_FORBIDDEN,403);if("completed"===i.status||"invoiced"===i.status)throw new f.ActionError("Cannot archive completed or invoiced jobs. These must be retained for records.",f.ERROR_CODES.OPERATION_NOT_ALLOWED);let j=new Date().toISOString(),k=new Date(Date.now()+7776e6).toISOString();if((await Promise.all([b.from("jobs").update({deleted_at:j,archived_at:j,status:"archived"}).eq("id",a),b.from("job_multi_entity").update({deleted_by:d.id,permanent_delete_scheduled_at:k}).eq("job_id",a)])).filter(a=>a.error).length>0)throw new f.ActionError(f.ERROR_MESSAGES.operationFailed("archive job"),f.ERROR_CODES.DB_QUERY_ERROR);(0,c.revalidatePath)("/dashboard/work"),(0,c.revalidatePath)("/dashboard/schedule"),(0,c.revalidatePath)("/dashboard/settings/archive")})}async function B(a,b,d){return(0,g.withErrorHandling)(async()=>{let i=await (0,h.createClient)();if(!i)throw new f.ActionError("Database connection failed",f.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:j}}=await i.auth.getUser();(0,g.assertAuthenticated)(j?.id);let k=await (0,e.getActiveCompanyId)();if(!k)throw new f.ActionError(f.ERROR_MESSAGES.forbidden("company access"),f.ERROR_CODES.AUTH_FORBIDDEN,403);let{data:l,error:m}=await i.from("jobs").select("id, company_id").eq("id",a).eq("company_id",k).is("deleted_at",null).single();if(m)throw console.error("Job query error:",m),new f.ActionError(`Failed to find job: ${m.message}`,f.ERROR_CODES.DB_QUERY_ERROR,500);(0,g.assertExists)(l,"Job");let{data:n,error:o}=await i.from("customers").select("id, company_id").eq("id",b).eq("company_id",k).is("deleted_at",null).single();if(o)throw console.error("Customer query error:",o),new f.ActionError(`Failed to find customer: ${o.message}`,f.ERROR_CODES.DB_QUERY_ERROR,500);if((0,g.assertExists)(n,"Customer"),d){let{data:a}=await i.from("properties").select("id, customer_id").eq("id",d).eq("customer_id",b).single();if(!a)throw new f.ActionError("Property not found or does not belong to this customer",f.ERROR_CODES.DB_RECORD_NOT_FOUND,404)}let{error:p}=await i.from("jobs").update({customer_id:b,property_id:d}).eq("id",a);if(p)throw new f.ActionError(f.ERROR_MESSAGES.operationFailed("assign customer to job"),f.ERROR_CODES.DB_QUERY_ERROR);await i.from("job_activity_log").insert({job_id:a,company_id:k,user_id:j.id,activity_type:"assigned",entity_type:"customer",description:`Assigned customer${d?" and property":""}`,metadata:{customer_id:b,property_id:d}}),(0,c.revalidatePath)(`/dashboard/work/${a}`),(0,c.revalidatePath)("/dashboard/work"),(0,c.revalidatePath)("/welcome")})}async function C(a){return(0,g.withErrorHandling)(async()=>{let b=await (0,h.createClient)();if(!b)throw new f.ActionError("Database connection failed",f.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:d}}=await b.auth.getUser();(0,g.assertAuthenticated)(d?.id);let i=await (0,e.getActiveCompanyId)();if(!i)throw new f.ActionError(f.ERROR_MESSAGES.forbidden("company access"),f.ERROR_CODES.AUTH_FORBIDDEN,403);let{data:j}=await b.from("jobs").select("id, company_id, customer_id, property_id").eq("id",a).eq("company_id",i).is("deleted_at",null).single();(0,g.assertExists)(j,"Job");let{error:k}=await b.from("jobs").update({customer_id:null,property_id:null}).eq("id",a);if(k)throw new f.ActionError(f.ERROR_MESSAGES.operationFailed("remove customer from job"),f.ERROR_CODES.DB_QUERY_ERROR);await b.from("job_activity_log").insert({job_id:a,company_id:i,user_id:d.id,activity_type:"removed",entity_type:"customer",description:"Removed customer and property",metadata:{previous_customer_id:j.customer_id,previous_property_id:j.property_id}}),(0,c.revalidatePath)(`/dashboard/work/${a}`),(0,c.revalidatePath)("/dashboard/work"),(0,c.revalidatePath)("/welcome")})}d.z.object({scheduledStart:d.z.string(),scheduledEnd:d.z.string()}),(0,p.ensureServerEntryExports)([v,w,x,y,z,A,B,C]),(0,b.registerServerReference)(v,"408f2eddf6255a715790f9a11f14210ea274b2e78d",null),(0,b.registerServerReference)(w,"60bf12d3a68e94c633a7e9d497193a941352366440",null),(0,b.registerServerReference)(x,"6051341b8d529700efe5c97d24b240b10261c41c24",null),(0,b.registerServerReference)(y,"40476f28520347a1729b9ea174da32aecad624030f",null),(0,b.registerServerReference)(z,"4004d04472f111406e5071089348187cb2348b7158",null),(0,b.registerServerReference)(A,"40563821f5d8019be8bdc5665393cdee0e819a5aad",null),(0,b.registerServerReference)(B,"709525d101fa2f4a94cded27ff747a3f860051b58f",null),(0,b.registerServerReference)(C,"40bf4d7745a43f234b3ea00ac7d525734214db997e",null),a.s(["archiveJob",()=>A,"assignCustomerToJob",()=>B,"completeJob",()=>z,"createJob",()=>v,"removeCustomerFromJob",()=>C,"startJob",()=>y,"updateJob",()=>w,"updateJobStatus",()=>x],839691)}];

//# sourceMappingURL=apps_web_src_actions_jobs_ts_a0c3654e._.js.map