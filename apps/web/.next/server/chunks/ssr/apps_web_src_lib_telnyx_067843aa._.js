module.exports=[538271,140621,a=>{"use strict";let b={debug:0,info:1,warn:2,error:3},c=process.env.TELNYX_LOG_LEVEL||"info",d=["phone","phoneNumber","phone_number","from","to","fromNumber","toNumber","from_number","to_number","apiKey","api_key","authToken","auth_token","password","secret","token"];function e(a){let b=a.replace(/\D/g,"");return b.length<4?"****":`***${b.slice(-4)}`}function f(a){let[b,c]=a.split("@");if(!c)return"***@***";let d=b.length>2?`${b[0]}***${b[b.length-1]}`:"***";return`${d}@${c}`}class g{parent;context;constructor(a,b){this.parent=a,this.context=b}debug(a,b){this.parent.debug(a,{...this.context,...b})}info(a,b){this.parent.info(a,{...this.context,...b})}warn(a,b){this.parent.warn(a,{...this.context,...b})}error(a,b){this.parent.error(a,{...this.context,...b})}}let h=new class{service="telnyx";defaultContext={};setDefaultContext(a){this.defaultContext={...this.defaultContext,...a}}clearDefaultContext(){this.defaultContext={}}shouldLog(a){return b[a]>=b[c]}log(a,b,c){if(!this.shouldLog(a))return;let g={timestamp:new Date().toISOString(),level:a,service:this.service,message:b},h={...this.defaultContext,...c};Object.keys(h).length>0&&(g.context=function a(b,c=0){if(c>10)return"[MAX_DEPTH]";if(null==b)return b;if("string"==typeof b)return b.replace(/\+?1?\d{10,15}/g,a=>e(a)).replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,a=>f(a));if("number"==typeof b||"boolean"==typeof b)return b;if(Array.isArray(b))return b.map(b=>a(b,c+1));if("object"==typeof b){let g={};for(let[h,i]of Object.entries(b))d.some(a=>h.toLowerCase().includes(a.toLowerCase()))?"string"==typeof i?i.includes("@")?g[h]=f(i):/\d/.test(i)?g[h]=e(i):g[h]="[REDACTED]":g[h]="[REDACTED]":g[h]=a(i,c+1);return g}return b}(h));{let b=JSON.stringify(g);switch(a){case"error":console.error(b);break;case"warn":console.warn(b)}}}debug(a,b){this.log("debug",a,b)}info(a,b){this.log("info",a,b)}warn(a,b){this.log("warn",a,b)}error(a,b){this.log("error",a,b)}child(a){return new g(this,a)}logRequestStart(a,b,c){let d=c?.correlationId||`tlx_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,e=Date.now();return this.debug(`${a} ${b} started`,{...c,correlationId:d,endpoint:b}),{correlationId:d,startTime:e}}logRequestEnd(a,b,c,d,e){let f=Date.now()-d;(c>=400?this.warn.bind(this):this.info.bind(this))(`${a} ${b} completed`,{...e,endpoint:b,statusCode:c,latencyMs:f})}logRequestError(a,b,c,d,e){let f=Date.now()-d;this.error(`${a} ${b} failed`,{...e,endpoint:b,error:c.message,latencyMs:f})}};a.s(["telnyxLogger",0,h],538271);let i={maxRetries:5,baseDelayMs:1e3,maxDelayMs:32e3,jitterFactor:.3,retryableStatusCodes:[408,429,500,502,503,504],retryableErrorCodes:["ECONNRESET","ETIMEDOUT","ECONNREFUSED","EPIPE","ENOTFOUND","ENETUNREACH","EAI_AGAIN"]},j={failureThreshold:5,resetTimeoutMs:6e4,halfOpenRequests:3},k=new Map;function l(a){return k.has(a)||k.set(a,{state:"closed",failures:0,lastFailureTime:0,halfOpenSuccesses:0,halfOpenFailures:0}),k.get(a)}function m(a,b,c=j){let d=l(a),e=Date.now();b?"half-open"===d.state?(d.halfOpenSuccesses++,d.halfOpenSuccesses>=c.halfOpenRequests&&(d.state="closed",d.failures=0,d.halfOpenSuccesses=0,d.halfOpenFailures=0,h.info("Circuit breaker closed",{endpoint:a}))):"closed"===d.state&&(d.failures=0):(d.lastFailureTime=e,"half-open"===d.state?(d.halfOpenFailures++,d.state="open",d.halfOpenSuccesses=0,d.halfOpenFailures=0,h.warn("Circuit breaker reopened",{endpoint:a})):"closed"===d.state&&(d.failures++,d.failures>=c.failureThreshold&&(d.state="open",h.error("Circuit breaker opened",{endpoint:a,failures:d.failures}))))}function n(a,b){let c=Error(a);return c.name="RetryError",c.statusCode=b.statusCode,c.errorCode=b.errorCode,c.retryable=b.retryable,c.attempts=b.attempts,c.lastError=b.lastError,c}function o(a){return new Promise(b=>setTimeout(b,a))}async function p(a,b={}){let c,d={...i,...b.config},e={...j,...b.circuitBreakerConfig},f=b.endpoint||"default",g=b.correlationId||q();if(!function(a,b=j){let c=l(a),d=Date.now();return"closed"===c.state||"open"!==c.state||d-c.lastFailureTime>=b.resetTimeoutMs&&(c.state="half-open",c.halfOpenSuccesses=0,c.halfOpenFailures=0,h.info("Circuit breaker half-open",{endpoint:a}),!0)}(f,e)){let a=n(`Circuit breaker open for endpoint: ${f}`,{retryable:!1,attempts:0});throw h.warn("Request blocked by circuit breaker",{endpoint:f,correlationId:g}),a}let k=0;for(;k<=d.maxRetries;)try{let b=await a();return m(f,!0,e),k>0&&h.info("Request succeeded after retry",{endpoint:f,attempt:k,correlationId:g}),b}catch(l){c=l instanceof Error?l:Error(String(l));let a=function(a,b=i){if(!a)return!1;if(a instanceof Error){let c=a.code;if(c&&b.retryableErrorCodes.includes(c)||a.message.includes("fetch failed")||a.message.includes("network")||a.message.includes("timeout")||a.message.includes("ECONNRESET"))return!0}if("object"==typeof a&&null!==a){let c=a.statusCode||a.status;if(c&&b.retryableStatusCodes.includes(c))return!0}return!1}(l,d);if(h.warn("Request failed",{endpoint:f,attempt:k,retryable:a,error:c.message,correlationId:g}),m(f,!1,e),!a||k>=d.maxRetries)throw n(`Request failed after ${k+1} attempt(s): ${c.message}`,{retryable:a,attempts:k+1,lastError:c,statusCode:l.statusCode,errorCode:l.code});let j=function(a,b=i){let c=Math.min(b.baseDelayMs*Math.pow(2,a),b.maxDelayMs),d=c*b.jitterFactor*Math.random();return Math.floor(c+d)}(k,d);if("object"==typeof l&&null!==l&&"response"in l){let a=l.response;if(a){let b=function(a){let b=a.headers.get("Retry-After");if(!b)return null;let c=parseInt(b,10);if(!isNaN(c))return 1e3*c;let d=Date.parse(b);return isNaN(d)?null:Math.max(0,d-Date.now())}(a);b&&(j=Math.min(b,d.maxDelayMs))}}b.onRetry&&b.onRetry(k,c,j),h.info("Retrying request",{endpoint:f,attempt:k+1,delayMs:j,correlationId:g}),await o(j),k++}throw n(`Request failed after ${d.maxRetries+1} attempts`,{retryable:!1,attempts:d.maxRetries+1,lastError:c})}function q(){return`tlx_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}a.s(["generateCorrelationId",()=>q,"sleep",()=>o,"withRetry",()=>p],140621)},111732,a=>{"use strict";var b=a.i(538271),c=a.i(140621);async function d(a,d,e){let f=process.env.TELNYX_API_KEY;if(!f)return{success:!1,error:"TELNYX_API_KEY is not configured"};let g=e?.operation||a,h=e?.timeout??15e3,i=async()=>{let c=new AbortController,e=setTimeout(()=>c.abort(),h);try{b.telnyxLogger.debug("Call API request",{endpoint:a,operation:g});let h=await fetch(`https://api.telnyx.com/v2${a}`,{method:"POST",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json"},body:JSON.stringify(d),signal:c.signal});clearTimeout(e);let i=await h.json();if(!h.ok){let c=i?.errors?.[0]?.detail||i?.errors?.[0]||h.statusText;b.telnyxLogger.warn("Call API error response",{endpoint:a,operation:g,status:h.status,error:c});let d=Error(`Telnyx ${h.status}: ${c}`);throw d.statusCode=h.status,d}return b.telnyxLogger.debug("Call API success",{endpoint:a,operation:g}),{success:!0,data:i.data}}catch(c){if(clearTimeout(e),c instanceof Error&&"AbortError"===c.name)throw b.telnyxLogger.error("Call API timeout",{endpoint:a,operation:g,timeoutMs:h}),Error(`Request timeout after ${h}ms`);throw c}};try{if(e?.skipRetry)return await i();return await (0,c.withRetry)(i,{endpoint:`calls:${g}`,config:{maxRetries:2,baseDelayMs:500,maxDelayMs:2e3},onRetry:(c,d,e)=>{b.telnyxLogger.warn("Retrying call API request",{endpoint:a,operation:g,attempt:c,error:d.message,delayMs:e})}})}catch(c){return b.telnyxLogger.error("Call API request failed",{endpoint:a,operation:g,error:c instanceof Error?c.message:"Unknown error"}),{success:!1,error:c instanceof Error?c.message:"Request failed"}}}async function e(a){let b=await d("/calls",{to:a.to,from:a.from,connection_id:a.connectionId,webhook_url:a.webhookUrl,answering_machine_detection:a.answeringMachineDetection||"disabled",custom_headers:a.customHeaders},{operation:"initiate"});return b.success&&b.data?{success:!0,callControlId:b.data.call_control_id,callSessionId:b.data.call_session_id,data:b.data}:{success:!1,error:b.error||"Failed to initiate call"}}async function f(a){return d(`/calls/${a.callControlId}/actions/answer`,{webhook_url:a.webhookUrl,client_state:a.clientState},{operation:"answer",skipRetry:!0})}async function g(a){return d(`/calls/${a.callControlId}/actions/reject`,{cause:a.cause||"CALL_REJECTED"},{operation:"reject",skipRetry:!0})}async function h(a){return d(`/calls/${a.callControlId}/actions/hangup`,{},{operation:"hangup"})}async function i(a){return d(`/calls/${a.callControlId}/actions/record_start`,{format:a.format||"mp3",channels:a.channels||"single"},{operation:"record_start"})}async function j(a){return d(`/calls/${a.callControlId}/actions/record_stop`,{},{operation:"record_stop"})}async function k(a){return d(`/calls/${a.callControlId}/actions/playback_start`,{audio_url:a.audioUrl,loop:a.loop},{operation:"playback_start"})}async function l(a){return d(`/calls/${a.callControlId}/actions/speak`,{payload:a.text,voice:a.voice||"female",language:a.language||"en-US"},{operation:"speak"})}async function m(a){return d(`/calls/${a.callControlId}/actions/transfer`,{to:a.to,from:a.from},{operation:"transfer"})}async function n(a){return d(`/calls/${a.callControlId}/actions/send_dtmf`,{digits:a.digits},{operation:"send_dtmf"})}async function o(a){let b=!!a.audioUrl;return d(b?`/calls/${a.callControlId}/actions/gather_using_audio`:`/calls/${a.callControlId}/actions/gather_using_speak`,b?{audio_url:a.audioUrl,valid_digits:a.validDigits,max:a.maxDigits,min:a.minDigits,timeout_millis:a.timeout,terminating_digit:a.terminatingDigit||"#"}:{payload:a.speakText||"",valid_digits:a.validDigits,max:a.maxDigits,min:a.minDigits,timeout_millis:a.timeout,terminating_digit:a.terminatingDigit||"#"},{operation:b?"gather_audio":"gather_speak"})}a.s(["answerCall",()=>f,"gatherInput",()=>o,"hangupCall",()=>h,"initiateCall",()=>e,"playAudio",()=>k,"rejectCall",()=>g,"sendDTMF",()=>n,"speakText",()=>l,"startRecording",()=>i,"stopRecording",()=>j,"transferCall",()=>m])},918448,a=>{"use strict";var b=a.i(933427),c=a.i(538271),d=a.i(140621);async function e(a,b){let d=function(){let a=process.env.TELNYX_API_KEY;if(!a)throw Error("TELNYX_API_KEY is not configured");return a}(),e=new URL(`https://api.telnyx.com/v2${a}`);if(b?.query)for(let[a,c]of Object.entries(b.query))null!=c&&e.searchParams.set(a,String(c));c.telnyxLogger.debug("Telnyx API request",{method:b?.method||"GET",path:a});let f=new AbortController,g=b?.timeout??3e4,h=setTimeout(()=>f.abort(),g);try{let g=await fetch(e,{...b,headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`,...b?.headers||{}},signal:f.signal});clearTimeout(h);let i=await g.json();if(!g.ok){let b=i?.errors?.[0]?.detail||g.statusText,d=i?.errors?.[0]?.code;throw c.telnyxLogger.error("Telnyx API error",{status:g.status,detail:b,errorCode:d,path:a}),Error(`Telnyx ${g.status}: ${b}`)}return i}catch(b){if(clearTimeout(h),b instanceof Error&&"AbortError"===b.name)throw c.telnyxLogger.error("Telnyx API timeout",{path:a,timeoutMs:g}),Error(`Request timeout after ${g}ms`);throw b}}async function f(a){return e("/messages",{method:"POST",body:JSON.stringify(a)})}async function g(a){try{let d=await (0,b.createServiceSupabaseClient)();if(!d)return{isConfigured:!1,warnings:["Database not available - cannot verify 10DLC status"]};let{data:e,error:f}=await d.from("company_telnyx_settings").select("ten_dlc_brand_id, ten_dlc_campaign_id, messaging_profile_id, status").eq("company_id",a).maybeSingle();if(f)return c.telnyxLogger.error("Failed to check 10DLC status",{companyId:a,error:f.message}),{isConfigured:!1,warnings:["Failed to verify 10DLC status"]};if(!e)return{isConfigured:!1,warnings:["No Telnyx settings configured for company"]};let g=[];return e.ten_dlc_brand_id||g.push("10DLC brand not registered - US SMS may be filtered"),e.ten_dlc_campaign_id||g.push("10DLC campaign not registered - US SMS may be filtered"),e.messaging_profile_id||g.push("Messaging profile not configured"),{isConfigured:!!e.ten_dlc_brand_id&&!!e.ten_dlc_campaign_id&&!!e.messaging_profile_id,brandId:e.ten_dlc_brand_id||void 0,campaignId:e.ten_dlc_campaign_id||void 0,messagingProfileId:e.messaging_profile_id||void 0,warnings:g}}catch(b){return c.telnyxLogger.error("10DLC check error",{companyId:a,error:b instanceof Error?b.message:"Unknown error"}),{isConfigured:!1,warnings:["Error checking 10DLC status"]}}}async function h(a,d="default"){try{let e=await (0,b.createServiceSupabaseClient)();if(!e)return{allowed:!0,currentCount:0,limit:60};let{data:f,error:g}=await e.rpc("increment_rate_limit",{p_company_id:a,p_resource:"sms",p_identifier:d,p_window_size_seconds:60});if(g)return c.telnyxLogger.error("Rate limit check failed",{companyId:a,error:g.message}),{allowed:!0,currentCount:0,limit:60};let h=(f?.[0]||{current_count:1}).current_count,i=h<=60;return i||c.telnyxLogger.warn("SMS rate limit exceeded",{companyId:a,currentCount:h,limit:60}),{allowed:i,currentCount:h,limit:60}}catch(b){return c.telnyxLogger.error("Rate limit error",{companyId:a,error:b instanceof Error?b.message:"Unknown error"}),{allowed:!0,currentCount:0,limit:60}}}async function i(a){let b=[];try{if(c.telnyxLogger.info("Sending SMS",{companyId:a.companyId,to:a.to.substring(0,6)+"****",textLength:a.text.length}),!a.skip10DLCCheck){let d=await g(a.companyId);d.isConfigured||(b.push(...d.warnings),c.telnyxLogger.warn("SMS sent without 10DLC registration",{companyId:a.companyId,warnings:d.warnings})),!a.messagingProfileId&&d.messagingProfileId&&(a.messagingProfileId=d.messagingProfileId)}if(!a.skipRateLimit){let c=await h(a.companyId);if(!c.allowed)return{success:!1,error:`Rate limit exceeded: ${c.currentCount}/${c.limit} messages per minute`,warnings:b}}let e=await (0,d.withRetry)(async()=>{let b={to:a.to,from:a.from,text:a.text,messaging_profile_id:a.messagingProfileId,webhook_url:a.webhookUrl,webhook_failover_url:a.webhookFailoverUrl,use_profile_webhooks:a.useProfileWebhooks??!0};return f(b)},{endpoint:"messaging:send_sms",config:{maxRetries:3,baseDelayMs:500,maxDelayMs:5e3}});return c.telnyxLogger.info("SMS sent successfully",{companyId:a.companyId,messageId:e.data.id,status:e.data.status}),{success:!0,messageId:e.data.id,data:e.data,warnings:b.length>0?b:void 0}}catch(d){return c.telnyxLogger.error("SMS send failed",{companyId:a.companyId,error:d instanceof Error?d.message:"Unknown error"}),{success:!1,error:d instanceof Error?d.message:"Failed to send SMS",warnings:b.length>0?b:void 0}}}async function j(a){try{let b=await h(a.companyId);if(!b.allowed)return{success:!1,error:`Rate limit exceeded: ${b.currentCount}/${b.limit} messages per minute`};let e=await (0,d.withRetry)(async()=>f({to:a.to,from:a.from,text:a.text,media_urls:a.mediaUrls,messaging_profile_id:a.messagingProfileId,webhook_url:a.webhookUrl,webhook_failover_url:a.webhookFailoverUrl,subject:a.subject,type:"MMS"}),{endpoint:"messaging:send_mms",config:{maxRetries:3,baseDelayMs:500}});return c.telnyxLogger.info("MMS sent successfully",{companyId:a.companyId,messageId:e.data.id,mediaCount:a.mediaUrls.length}),{success:!0,messageId:e.data.id,data:e.data}}catch(b){return c.telnyxLogger.error("MMS send failed",{companyId:a.companyId,error:b instanceof Error?b.message:"Unknown error"}),{success:!1,error:b instanceof Error?b.message:"Failed to send MMS"}}}async function k(a){let b=[],d=0,e=0;c.telnyxLogger.info("Starting bulk SMS",{companyId:a.companyId,recipientCount:a.to.length});for(let c=0;c<a.to.length;c+=5){let f=a.to.slice(c,c+5);for(let g of(await Promise.all(f.map(async b=>{let d=await i({companyId:a.companyId,to:b,from:a.from,text:a.text,webhookUrl:a.webhookUrl,messagingProfileId:a.messagingProfileId,skip10DLCCheck:c>0});return{to:b,result:d}}))))b.push(g),g.result.success?d++:e++;c+5<a.to.length&&await new Promise(a=>setTimeout(a,100))}return c.telnyxLogger.info("Bulk SMS completed",{companyId:a.companyId,total:a.to.length,successful:d,failed:e}),{success:0===e,total:a.to.length,successful:d,failed:e,results:b}}async function l(a){try{let b=await e(`/messages/${a}`);return{success:!0,data:b.data}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to retrieve message"}}}async function m(a){try{let b=await e("/messages",{query:{"page[size]":a?.pageSize??20,"page[number]":a?.pageNumber??1,"filter[from]":a?.filterFrom,"filter[to]":a?.filterTo,"filter[direction]":a?.filterDirection}});return{success:!0,data:b.data,meta:b.meta}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to list messages"}}}function n(a){try{let b=a.replace(/\D/g,"");if(b.length<10||b.length>15)return{success:!1,error:"Invalid phone number length (must be 10-15 digits)"};let c=o(b);return{success:!0,formattedNumber:c}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to validate phone number"}}}function o(a){let b=a.replace(/[^\d+]/g,"").replace(/(?!^)\+/g,"");return b.startsWith("+")?b:11===b.length&&b.startsWith("1")?`+${b}`:10===b.length?`+1${b}`:`+${b}`}function p(a){let b=o(a);return b.startsWith("+1")&&12===b.length}a.s(["check10DLCStatus",()=>g,"checkSMSRateLimit",()=>h,"formatPhoneNumber",()=>o,"getMessage",()=>l,"isUSPhoneNumber",()=>p,"listMessages",()=>m,"sendBulkSMS",()=>k,"sendMMS",()=>j,"sendSMS",()=>i,"validatePhoneNumber",()=>n])},870547,730347,361300,a=>{"use strict";var b=a.i(313170);function c(){let a=["http://localhost:3000",process.env.SITE_URL,"http://localhost:3000",process.env.APP_URL],b="production"!==process.env.VERCEL_ENV||"production"!==process.env.DEPLOYMENT_ENV;for(let c of a)if(c&&c.trim()){let a=c.trim();if((a.includes("localhost")||a.includes("127.0.0.1")||a.includes("0.0.0.0"))&&!b)continue;let d=a.startsWith("http")?a:`https://${a}`;return`${d.replace(/\/+$/,"")}/api/webhooks/telnyx`}}async function d(a){let d=a||b.TELNYX_CONFIG.messagingProfileId,e={exists:!1,isActive:!1,hasWebhookUrl:!1,webhookUrl:null,webhookFailoverUrl:null,webhookApiVersion:null,needsFix:!1,issues:[]};if(!d||""===d.trim())return e.issues.push("Messaging profile ID is not configured"),e.needsFix=!0,e;try{let a=(await b.telnyxClient.messagingProfiles.retrieve(d)).data;if(!a)return e.issues.push(`Messaging profile ${d} not found in Telnyx`),e.needsFix=!0,e;e.exists=!0,e.isActive=!1!==a.enabled,e.webhookUrl=a.webhook_url||null,e.webhookFailoverUrl=a.webhook_failover_url||null,e.webhookApiVersion=a.webhook_api_version||null;let f=c();if(f)if(e.webhookUrl){let a=e.webhookUrl.split("?")[0];a===f||e.webhookUrl===f?e.hasWebhookUrl=!0:(e.issues.push(`Webhook URL base is not set correctly. Expected: ${f}, Current: ${a}`),e.needsFix=!0)}else e.issues.push(`Webhook URL is not set. Expected: ${f} (with optional ?company=... for multi-tenant)`),e.needsFix=!0;else"production"!==process.env.VERCEL_ENV||"production"!==process.env.DEPLOYMENT_ENV?e.issues.push("NEXT_PUBLIC_SITE_URL is not set. Set it to your production URL (e.g., https://yourdomain.com) or use a tool like ngrok for local testing."):e.issues.push("NEXT_PUBLIC_SITE_URL is not set to a valid production URL. Set it to your production domain (e.g., https://yourdomain.com) in your environment variables."),e.needsFix=!0;return"2"!==e.webhookApiVersion&&(e.issues.push(`Webhook API version should be "2", but is "${e.webhookApiVersion||"not set"}"`),e.needsFix=!0),e.isActive||(e.issues.push("Messaging profile is not enabled"),e.needsFix=!0),e}catch(a){return a?.statusCode===404?e.issues.push(`Messaging profile ${d} not found in Telnyx`):e.issues.push(a?.message||"Failed to retrieve messaging profile"),e.needsFix=!0,e}}async function e(a,e){let f=a||b.TELNYX_CONFIG.messagingProfileId,g=[];if(!f||""===f.trim())return{success:!1,fixed:!1,error:"Messaging profile ID is not configured",changes:[]};try{let a=await d(f);if(!a.needsFix)return{success:!0,fixed:!1,changes:[]};let h=e?.webhookUrl||c();if(!h)return{success:!1,fixed:!1,error:"NEXT_PUBLIC_SITE_URL must be set to a valid production URL to configure webhooks",changes:[]};let i={};a.webhookUrl!==h&&(i.webhook_url=h,g.push(`Updated webhook URL to ${h}`));let j=e?.webhookFailoverUrl||process.env.TELNYX_WEBHOOK_FAILOVER_URL||null;return a.webhookFailoverUrl!==j&&(i.webhook_failover_url=j,j?g.push(`Updated webhook failover URL to ${j}`):g.push("Removed webhook failover URL")),"2"!==a.webhookApiVersion&&(i.webhook_api_version="2",g.push("Updated webhook API version to 2")),a.isActive||(i.enabled=!0,g.push("Enabled messaging profile")),Object.keys(i).length>0&&await b.telnyxClient.messagingProfiles.update(f,i),{success:!0,fixed:g.length>0,changes:g}}catch(a){return{success:!1,fixed:!1,error:a?.message||"Failed to update messaging profile",changes:g}}}async function f(a){try{let c=await b.telnyxClient.availablePhoneNumbers.list({filter:{country_code:a.countryCode||"US",national_destination_code:a.areaCode,features:a.features,limit:a.limit||10,starts_with:a.startsWith,ends_with:a.endsWith,contains:a.contains}});return{success:!0,data:c.data}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to search numbers"}}}async function g(a){try{let c=await b.telnyxClient.numberOrders.create({phone_numbers:[{phone_number:a.phoneNumber}],messaging_profile_id:a.messagingProfileId,connection_id:a.connectionId,billing_group_id:a.billingGroupId,customer_reference:a.customerReference});return{success:!0,orderId:c.data?.id,data:c.data}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to purchase number"}}}async function h(a){try{let c=await b.telnyxClient.phoneNumbers.list({page:{size:a?.pageSize||20,number:a?.pageNumber||1},filter:{tag:a?.filterTag,status:a?.filterStatus}});return{success:!0,data:c.data,meta:c.meta}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to list numbers"}}}async function i(a){try{let c=await b.telnyxClient.phoneNumbers.retrieve(a);return{success:!0,data:c.data}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to retrieve number"}}}async function j(a){try{let c=await b.telnyxClient.phoneNumbers.update(a.phoneNumberId,{connection_id:a.connectionId,messaging_profile_id:a.messagingProfileId,billing_group_id:a.billingGroupId,tags:a.tags,customer_reference:a.customerReference});return{success:!0,data:c.data}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to update number"}}}async function k(a){try{return await b.telnyxClient.phoneNumbers.del(a),{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to release number"}}}async function l(a){try{let c=await b.telnyxClient.numberPortouts.create({phone_numbers:a.phoneNumbers,billing_group_id:a.billingGroupId,fast_port_eligible:a.fastPortEligible,customer_reference:{account_number:a.accountNumber,account_pin:a.accountPin,authorized_person:a.authorizedPerson},service_address:{address_line_1:a.addressLine1,city:a.city,state_or_province:a.stateOrProvince,zip_or_postal_code:a.zipOrPostalCode,country_code:a.countryCode||"US"}});return{success:!0,portingOrderId:c.data.id,data:c.data}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to initiate porting"}}}a.s(["fixMessagingProfile",()=>e,"verifyMessagingProfile",()=>d],870547),a.s(["getNumberDetails",()=>i,"initiatePorting",()=>l,"listOwnedNumbers",()=>h,"purchaseNumber",()=>g,"releaseNumber",()=>k,"searchAvailableNumbers",()=>f,"updateNumber",()=>j],730347);let m=["sms","mms","voice"],n="company_telnyx_settings";async function o(){for(let a of["http://localhost:3000",process.env.SITE_URL,"http://localhost:3000",process.env.APP_URL]){if(!a)continue;let b=a.trim();if(b&&!/localhost|127\.0\.0\.1|0\.0\.0\.0/i.test(b)){if(b.startsWith("http"))return b.replace(/\/+$/,"");return`https://${b.replace(/\/+$/,"")}`}}}async function p(a){let b=await o();if(b)return`${b}/api/webhooks/telnyx?company=${a}`}async function q(a,b,c,d){if(0!==c.length)for(let e of c){let c=e.phoneNumber.replace(/[^0-9]/g,""),f=c.startsWith("+")?c:c.startsWith("1")&&11===c.length?`+${c}`:`+1${c}`,g={company_id:b,phone_number:f,formatted_number:function(a){let b=a.replace(/[^0-9]/g,"");return 11===b.length&&b.startsWith("1")?`(${b.slice(1,4)}) ${b.slice(4,7)}-${b.slice(7)}`:10===b.length?`(${b.slice(0,3)}) ${b.slice(3,6)}-${b.slice(6)}`:a}(f),area_code:e.areaCode||f.slice(2,5),country_code:e.countryCode||"US",number_type:e.numberType||"local",status:"active",features:m,telnyx_phone_number_id:e.telnyxPhoneNumberId||null,telnyx_messaging_profile_id:d.messagingProfileId,telnyx_connection_id:d.connectionId},{data:h}=await a.from("phone_numbers").select("id").eq("company_id",b).eq("phone_number",f).maybeSingle();h?.id?await a.from("phone_numbers").update(g).eq("id",h.id):await a.from("phone_numbers").insert(g)}}async function r(a,c){return(await b.telnyxClient.messagingProfiles.create({name:`${a} - Thorbis`,enabled:!0,webhook_url:c,webhook_api_version:"2"})).data}async function s(a,c){return(await b.telnyxClient.callControlApplications.create({application_name:`${a} - Thorbis`,webhook_event_url:c,webhook_api_version:"2",answering_machine_detection:"premium"})).data}async function t(a,b){let c=await f({areaCode:b.areaCode,features:b.features||m,limit:Math.max(2*b.quantity,b.quantity)});if(!c.success||!c.data||0===c.data.length)throw Error("No available phone numbers found for requested criteria");let d=[];for(let e of c.data){if(d.length>=b.quantity)break;let c=e.phone_number,f=await g({phoneNumber:c,messagingProfileId:b.messagingProfileId,connectionId:b.connectionId,customerReference:`company:${a}`});if(!f.success)throw Error(f.error||`Failed to purchase number ${c} from Telnyx`);d.push({phoneNumber:c,areaCode:e.national_destination_code||e.area_code,telnyxPhoneNumberId:e.id||e.phone_number,numberType:e.number_type})}if(0===d.length)throw Error("Failed to purchase any phone numbers");for(let a of d)if(a.telnyxPhoneNumberId)try{let c=process.env.TELNYX_API_KEY;if(!c)throw Error("TELNYX_API_KEY not configured");await fetch(`https://api.telnyx.com/v2/phone_numbers/${a.telnyxPhoneNumberId}/messaging`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({messaging_profile_id:b.messagingProfileId})})}catch(b){console.warn(`Failed to enable messaging on ${a.phoneNumber}:`,b)}return d}async function u(a,b){let{data:c}=await a.from(n).select("*").eq("company_id",b).maybeSingle();return c??null}async function v(a){let{supabase:b,companyId:c}=a,d=[],e=await u(b,c);if(e&&"ready"===e.status&&e.messaging_profile_id&&e.call_control_application_id)return d.push("Existing Telnyx configuration found"),{success:!0,settings:e,log:d};let{data:f}=await b.from("companies").select("id, name").eq("id",c).maybeSingle();if(!f)return{success:!1,error:"Company not found",log:d};let g=await p(c);if(!g)return{success:!1,error:"NEXT_PUBLIC_SITE_URL must be configured with a public URL to provision Telnyx resources",log:d};try{d.push("Creating messaging profile");let e=await r(f.name||"Company",g),h=e?.id;d.push("Creating call control application");let i=await s(f.name||"Company",g),j=i?.id;if(!h||!j)throw Error("Failed to provision messaging profile or call control application");d.push("Purchasing phone numbers");let k=await t(c,{quantity:Math.max(a.numberQuantity||1,1),areaCode:a.areaCode,features:a.features||m,messagingProfileId:h,connectionId:j});await q(b,c,k,{messagingProfileId:h,connectionId:j});let l=k.find(a=>"toll-free"===a.numberType)||k[0],o=await b.from(n).upsert({company_id:c,status:"ready",messaging_profile_id:h,call_control_application_id:j,default_outbound_number:l?.phoneNumber||null,default_outbound_phone_number_id:l?.telnyxPhoneNumberId||null,metadata:{log:d,purchased_numbers:k.map(a=>a.phoneNumber)},last_provisioned_at:new Date().toISOString()},{onConflict:"company_id"}).select("*").single();return{success:!0,settings:o.data,log:d}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to provision Telnyx resources",log:d}}}async function w(a){let{supabase:b,companyId:c,quantity:d}=a,e=[],f=await u(b,c);if(!f||"ready"!==f.status||!f.messaging_profile_id||!f.call_control_application_id)return{success:!1,error:"Company Telnyx configuration is not ready. Run ensureCompanyTelnyxSetup first.",log:e};try{e.push(`Purchasing ${d} additional numbers`);let g=await t(c,{quantity:d,areaCode:a.areaCode,features:a.features||m,messagingProfileId:f.messaging_profile_id,connectionId:f.call_control_application_id});await q(b,c,g,{messagingProfileId:f.messaging_profile_id,connectionId:f.call_control_application_id});let h=g.find(a=>"toll-free"===a.numberType);return h&&f.default_outbound_number!==h.phoneNumber&&await b.from(n).update({default_outbound_number:h.phoneNumber,default_outbound_phone_number_id:h.telnyxPhoneNumberId||null}).eq("company_id",c),{success:!0,settings:f,log:e}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to purchase phone numbers",log:e}}}a.s(["ensureCompanyTelnyxSetup",()=>v,"fetchCompanyTelnyxSettings",()=>u,"purchaseAdditionalNumbers",()=>w],361300)}];

//# sourceMappingURL=apps_web_src_lib_telnyx_067843aa._.js.map