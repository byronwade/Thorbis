module.exports=[103984,a=>{"use strict";var b=a.i(780195),c=a.i(933427);async function d(a){let b=await (0,c.createServiceSupabaseClient)(),{error:d}=await b.rpc("update_domain_reputation",{p_domain_id:a.domainId,p_event_type:a.eventType});return d?(console.error("Error recording delivery event:",d),{success:!1,error:d.message}):{success:!0}}async function e(a){let b=await (0,c.createServiceSupabaseClient)(),e={"email.delivered":"delivered","email.bounced":"bounced","email.complained":"complained","email.opened":"opened","email.clicked":"clicked","email.delivery_delayed":"soft_bounce"}[a.type];if(!e)return{success:!0};let f=a.data.from;if(!f)return{success:!0};let g=f.includes("@")?f.split("@")[1]:f,{data:h}=await b.from("company_email_domains").select("id").eq("domain_name",g).maybeSingle();return h?d({domainId:h.id,eventType:e,emailId:a.data.email_id,metadata:a.data}):{success:!0}}async function f(a){let b=await (0,c.createServiceSupabaseClient)(),{data:d,error:e}=await b.from("company_email_domains").select("id, domain_name, reputation_score, bounce_rate, total_emails_sent, hard_bounces, soft_bounces, spam_complaints, is_suspended, last_health_check").eq("id",a).single();if(e||!d)return null;let f=d.total_emails_sent+d.hard_bounces+d.soft_bounces,g=f>0?(d.hard_bounces+d.soft_bounces)/f*100:0,h=d.total_emails_sent>0?d.spam_complaints/d.total_emails_sent*100:0,i=f>0?d.total_emails_sent/f*100:100,j="healthy";return d.is_suspended?j="suspended":d.reputation_score<30||g>10||h>.5?j="critical":(d.reputation_score<60||g>5||h>.2)&&(j="warning"),{domainId:d.id,domain:d.domain_name,reputationScore:Number(d.reputation_score),bounceRate:Number(g.toFixed(2)),complaintRate:Number(h.toFixed(3)),deliveryRate:Number(i.toFixed(2)),status:j,totalEmailsSent:d.total_emails_sent,hardBounces:d.hard_bounces,softBounces:d.soft_bounces,complaints:d.spam_complaints,lastHealthCheck:d.last_health_check}}async function g(a){let b=await (0,c.createServiceSupabaseClient)(),{data:d,error:e}=await b.from("company_email_domains").select("id, domain_name, reputation_score, bounce_rate, total_emails_sent, hard_bounces, soft_bounces, spam_complaints, is_suspended, last_health_check").eq("company_id",a);return e||!d?[]:d.map(a=>{let b=a.total_emails_sent+a.hard_bounces+a.soft_bounces,c=b>0?(a.hard_bounces+a.soft_bounces)/b*100:0,d=a.total_emails_sent>0?a.spam_complaints/a.total_emails_sent*100:0,e=b>0?a.total_emails_sent/b*100:100,f="healthy";return a.is_suspended?f="suspended":a.reputation_score<30||c>10||d>.5?f="critical":(a.reputation_score<60||c>5||d>.2)&&(f="warning"),{domainId:a.id,domain:a.domain_name,reputationScore:Number(a.reputation_score),bounceRate:Number(c.toFixed(2)),complaintRate:Number(d.toFixed(3)),deliveryRate:Number(e.toFixed(2)),status:f,totalEmailsSent:a.total_emails_sent,hardBounces:a.hard_bounces,softBounces:a.soft_bounces,complaints:a.spam_complaints,lastHealthCheck:a.last_health_check}})}async function h(){let a=await (0,c.createServiceSupabaseClient)(),{data:b}=await a.from("company_email_domains").select("id, reputation_score, hard_bounces, soft_bounces, spam_complaints, total_emails_sent").eq("is_suspended",!1);if(!b)return{checked:0,suspended:0,warnings:0};let d=0,e=0;for(let c of b){let b=c.total_emails_sent+c.hard_bounces+c.soft_bounces,f=b>100?(c.hard_bounces+c.soft_bounces)/b*100:0,g=c.total_emails_sent>100?c.spam_complaints/c.total_emails_sent*100:0;c.reputation_score<20||f>15||g>1?(await a.from("company_email_domains").update({is_suspended:!0,suspension_reason:`Auto-suspended: Reputation ${c.reputation_score}, Bounce rate ${f.toFixed(1)}%, Complaint rate ${g.toFixed(2)}%`,suspended_at:new Date().toISOString(),last_health_check:new Date().toISOString()}).eq("id",c.id),d++):c.reputation_score<50||f>8||g>.3?(await a.from("company_email_domains").update({last_health_check:new Date().toISOString()}).eq("id",c.id),e++):await a.from("company_email_domains").update({last_health_check:new Date().toISOString()}).eq("id",c.id)}return{checked:b.length,suspended:d,warnings:e}}async function i(a){let b=await f(a);if(!b)return null;let c=[];return b.bounceRate>5&&c.push("High bounce rate detected. Clean your email list and remove invalid addresses."),b.complaintRate>.1&&c.push("Spam complaints detected. Ensure recipients have opted in and make unsubscribe easy."),b.reputationScore<70&&c.push("Reputation score is below optimal. Reduce sending volume temporarily and focus on engagement."),("warning"===b.status||"critical"===b.status)&&c.push("Domain health is degraded. Review your email content and sending practices."),0===c.length&&c.push("Domain health is good. Continue monitoring and maintain current practices."),{domain:b.domain,period:{start:new Date(Date.now()-2592e6).toISOString(),end:new Date().toISOString()},metrics:{totalSent:b.totalEmailsSent,delivered:b.totalEmailsSent-b.hardBounces,bounced:b.hardBounces+b.softBounces,complained:b.complaints,deliveryRate:b.deliveryRate,bounceRate:b.bounceRate,complaintRate:b.complaintRate},reputation:{current:b.reputationScore,change:0,status:b.status},recommendations:c}}(0,a.i(395731).ensureServerEntryExports)([d,e,f,g,h,i]),(0,b.registerServerReference)(d,"404d6f2891af89c71d5bde33d110a216bdd3ee4729",null),(0,b.registerServerReference)(e,"40ad037af6f6ab1a3004746d3a1b65afa65527002d",null),(0,b.registerServerReference)(f,"400b8fb96146bfd004a3166563a5ab5536bb610c70",null),(0,b.registerServerReference)(g,"405c57a8fed352b8679525b56014eb8c49105c850c",null),(0,b.registerServerReference)(h,"00c53a1f02416c3261983f8096f19a3450bfd51775",null),(0,b.registerServerReference)(i,"40ecf2c792e84ef4b898fda98ec27277b4a9dddef2",null),a.s(["generateDeliverabilityReport",()=>i,"getCompanyDomainsHealth",()=>g,"getDomainHealth",()=>f,"processResendWebhookEvent",()=>e,"recordDeliveryEvent",()=>d,"runHealthCheckForAllDomains",()=>h])},463556,a=>{"use strict";var b,c=a.i(146057);let d=c.z.string().email("Invalid email address").min(1,"Email is required"),e=c.z.object({to:c.z.union([d,c.z.array(d)]),subject:c.z.string().min(1,"Subject is required").max(200),replyTo:d.optional()});var f=((b={}).WELCOME="welcome",b.EMAIL_VERIFICATION="email-verification",b.PASSWORD_RESET="password-reset",b.PASSWORD_CHANGED="password-changed",b.MAGIC_LINK="magic-link",b.JOB_CONFIRMATION="job-confirmation",b.APPOINTMENT_REMINDER="appointment-reminder",b.TECH_EN_ROUTE="tech-en-route",b.JOB_COMPLETE="job-complete",b.INVOICE="invoice",b.ESTIMATE="estimate",b.INVOICE_SENT="invoice-sent",b.PAYMENT_RECEIVED="payment-received",b.PAYMENT_REMINDER="payment-reminder",b.ESTIMATE_SENT="estimate-sent",b.REVIEW_REQUEST="review-request",b.SERVICE_REMINDER="service-reminder",b.WELCOME_CUSTOMER="welcome-customer",b.PORTAL_INVITATION="portal-invitation",b.TEAM_INVITATION="team-invitation",b.VERIFICATION_SUBMITTED="verification-submitted",b.VERIFICATION_COMPLETE="verification-complete",b.WAITLIST_SUBSCRIPTION="waitlist-subscription",b.WAITLIST_ADMIN_NOTIFICATION="waitlist-admin-notification",b.GENERIC="generic",b);a.s(["EmailTemplate",()=>f,"emailSendSchema",0,e])},941771,a=>{"use strict";var b=a.i(780195),c=a.i(933427),d=a.i(395731);let e=new Map;async function f(a){let b=await (0,c.createServiceSupabaseClient)(),{data:d,error:e}=await b.from("company_email_domains").select(`
			id,
			domain_name,
			reply_to_email,
			daily_limit,
			hourly_limit,
			emails_sent_today,
			emails_sent_this_hour,
			is_platform_subdomain
		`).eq("company_id",a).eq("status","verified").eq("sending_enabled",!0).eq("is_suspended",!1).order("is_platform_subdomain",{ascending:!0}).order("created_at",{ascending:!1}).maybeSingle();return e?(console.error("Error fetching company email domain:",e),null):d?{domainId:d.id,domain:d.domain_name,replyToEmail:d.reply_to_email,dailyLimit:d.daily_limit||1e3,hourlyLimit:d.hourly_limit||100,emailsSentToday:d.emails_sent_today||0,emailsSentThisHour:d.emails_sent_this_hour||0}:null}async function g(a){let b=await (0,c.createServiceSupabaseClient)(),{data:d,error:f}=await b.from("company_email_domains").select(`
			daily_limit,
			hourly_limit,
			emails_sent_today,
			emails_sent_this_hour,
			is_suspended,
			daily_limit_reset_at,
			hourly_limit_reset_at
		`).eq("id",a).single();if(f||!d)return{allowed:!1,reason:"Domain not found or error fetching limits"};if(d.is_suspended)return{allowed:!1,reason:"Domain is suspended due to reputation issues"};let g=d.daily_limit||1e3,h=d.hourly_limit||100,i=d.emails_sent_today||0,m=d.emails_sent_this_hour||0;if(i>=g)return{allowed:!1,reason:`Daily email limit reached (${g} emails/day)`,remaining:0,resetAt:d.daily_limit_reset_at||k()};if(m>=h)return{allowed:!1,reason:`Hourly email limit reached (${h} emails/hour)`,remaining:0,resetAt:d.hourly_limit_reset_at||l()};let n=`${a}:minute`,o=j(),p=e.get(n);return p&&p.windowStart===o&&p.count>=10?{allowed:!1,reason:"Rate limit: Too many emails per minute (10/min)",remaining:0}:{allowed:!0,remaining:Math.min(g-i,h-m)}}async function h(a){let b=await (0,c.createServiceSupabaseClient)(),{data:d,error:e}=await b.rpc("increment_email_counter",{p_domain_id:a});return e?"PGRST202"===e.code||e.message.includes("function")?await i(a):(console.error("Error incrementing email counter:",e),{allowed:!1,reason:e.message}):d&&"object"==typeof d?{allowed:d.allowed,reason:d.reason,remaining:d.remaining}:{allowed:!0}}async function i(a){let b=await (0,c.createServiceSupabaseClient)(),{data:d,error:f}=await b.from("company_email_domains").select("emails_sent_today, emails_sent_this_hour, daily_limit, hourly_limit").eq("id",a).single();if(f||!d)return{allowed:!1,reason:"Domain not found"};let g=d.daily_limit||1e3,h=d.hourly_limit||100;if((d.emails_sent_today||0)>=g)return{allowed:!1,reason:"Daily limit reached"};if((d.emails_sent_this_hour||0)>=h)return{allowed:!1,reason:"Hourly limit reached"};let{error:i}=await b.from("company_email_domains").update({emails_sent_today:(d.emails_sent_today||0)+1,emails_sent_this_hour:(d.emails_sent_this_hour||0)+1}).eq("id",a);if(i)return console.error("Error updating email counters:",i),{allowed:!1,reason:i.message};let k=`${a}:minute`,l=j(),m=e.get(k);return m&&m.windowStart===l?m.count++:e.set(k,{count:1,windowStart:l}),{allowed:!0,remaining:Math.min(g-(d.emails_sent_today||0)-1,h-(d.emails_sent_this_hour||0)-1)}}function j(){return Math.floor(Date.now()/6e4)}function k(){let a=new Date(new Date);return a.setUTCDate(a.getUTCDate()+1),a.setUTCHours(0,0,0,0),a.toISOString()}function l(){let a=new Date(new Date);return a.setUTCHours(a.getUTCHours()+1,0,0,0),a.toISOString()}async function m(){let a=await (0,c.createServiceSupabaseClient)(),{error:b}=await a.from("company_email_domains").update({emails_sent_today:0,daily_limit_reset_at:k()}).neq("id","");return b?(console.error("Error resetting daily counters:",b),{success:!1,error:b.message}):{success:!0}}async function n(){let a=await (0,c.createServiceSupabaseClient)(),{error:b}=await a.from("company_email_domains").update({emails_sent_this_hour:0,hourly_limit_reset_at:l()}).neq("id","");return b?(console.error("Error resetting hourly counters:",b),{success:!1,error:b.message}):{success:!0}}(0,d.ensureServerEntryExports)([f,g,h,m,n]),(0,b.registerServerReference)(f,"407a5a7d0a7dd7989a963eb2485a3527c1dcb20a70",null),(0,b.registerServerReference)(g,"40af86a915f04df8d7cc189fe26e45e0cc24663080",null),(0,b.registerServerReference)(h,"4029b163c1c0acfd806352a72fe8030c8ae4f7f8ac",null),(0,b.registerServerReference)(m,"006acf41615a2f7795c47b6d7a3016e18300f2ad17",null),(0,b.registerServerReference)(n,"004cdde5e6ae8991bab4ba61ae40647c2b823200ba",null),a.s(["checkRateLimit",()=>g,"getCompanyActiveDomain",()=>f,"incrementEmailCounter",()=>h,"resetDailyCounters",()=>m,"resetHourlyCounters",()=>n])},854963,a=>{"use strict";var b=a.i(780195),c=a.i(933427),d=a.i(254799);let e="aes-256-gcm",f="base64";function g(){let a=process.env.TOKEN_ENCRYPTION_KEY;if(!a)throw Error("TOKEN_ENCRYPTION_KEY environment variable not set. Generate with: openssl rand -hex 32");if(64!==a.length)throw Error("TOKEN_ENCRYPTION_KEY must be 32 bytes (64 hex characters). Generate with: openssl rand -hex 32");let b=Buffer.from(a,"hex");if(32!==b.length)throw Error("Invalid TOKEN_ENCRYPTION_KEY format");return b}function h(a){try{let b=g(),c=d.default.randomBytes(12),h=d.default.createCipheriv(e,b,c),i=h.update(a,"utf8",f);i+=h.final(f);let j=h.getAuthTag();return[c.toString(f),j.toString(f),i].join(":")}catch(a){throw console.error("[Token Encryption] Encryption failed:",a),Error("Failed to encrypt token")}}function i(a){try{let b=g(),c=a.split(":");if(3!==c.length)throw Error("Invalid encrypted token format");let[h,i,j]=c,k=Buffer.from(h,f),l=Buffer.from(i,f);if(12!==k.length)throw Error("Invalid IV length");if(16!==l.length)throw Error("Invalid auth tag length");let m=d.default.createDecipheriv(e,b,k);m.setAuthTag(l);let n=m.update(j,f,"utf8");return n+=m.final("utf8")}catch(a){throw console.error("[Token Encryption] Decryption failed:",a),Error("Failed to decrypt token")}}let j=new Map,k=new Map,l=new Set,m=null;function n(a){let b=Date.now(),c=k.get(a);if(c){let a=b-c;if(a<3e5)return{allowed:!1,reason:"Sync cooldown active",retryAfter:Math.ceil((3e5-a)/1e3)}}if(function(){let a=Date.now();for(let b of l)a>b.expiresAt&&l.delete(b);return l.size}()>=10)return{allowed:!1,reason:"Maximum concurrent syncs reached",retryAfter:60};let d=Array.from(l).find(b=>b.teamMemberId===a);if(d)if(!(b>d.expiresAt))return{allowed:!1,reason:"Sync already in progress",retryAfter:Math.ceil((d.expiresAt-b)/1e3)};else l.delete(d);return{allowed:!0}}async function o(a,b={},d="info",e){try{let f=function(a,b){let c=b.userName||b.teamMemberId||"User";switch(a){case"gmail_connected":return`${c} connected Gmail account (${b.gmailEmail})`;case"gmail_disconnected":return`${c} disconnected Gmail account (${b.gmailEmail})`;case"gmail_token_refreshed":return`Gmail token refreshed for ${b.gmailEmail}`;case"gmail_token_refresh_failed":return`Failed to refresh Gmail token for ${b.gmailEmail}: ${b.error}`;case"gmail_token_revoked":return`Gmail token revoked for ${b.gmailEmail}`;case"permission_granted":return`${b.grantedBy} granted ${b.category} permissions to ${b.grantedTo}`;case"permission_revoked":return`${b.grantedBy} revoked ${b.category} permissions from ${b.grantedTo}`;case"permission_updated":return`${b.grantedBy} updated ${b.category} permissions for ${b.grantedTo}`;case"permission_check_failed":return`Permission check failed for ${c}: ${b.error}`;case"sync_started":return`${c} started inbox sync`;case"sync_completed":return`${c} completed inbox sync (${b.syncMessageCount} messages)`;case"sync_failed":return`Inbox sync failed for ${c}: ${b.error}`;case"sync_rate_limited":return`${c} sync rate limited (retry after ${b.retryAfter}s)`;case"email_accessed":return`${c} accessed email: ${b.emailSubject}`;case"email_sent":return`${c} sent email to ${b.toAddress}: ${b.emailSubject}`;case"email_assigned":return`${c} assigned email to ${b.grantedTo}`;case"unauthorized_access_attempt":return`Unauthorized access attempt by ${c}: ${b.error}`;case"permission_escalation_attempt":return`Permission escalation attempt by ${c}: ${b.error}`;case"invalid_oauth_state":return`Invalid OAuth state detected: ${b.error}`;case"token_cleanup_executed":return`Token cleanup executed: ${b.syncMessageCount} tokens removed`;case"rate_limit_exceeded":return`Rate limit exceeded for ${c} (${b.requestsPerMinute} req/min)`;default:return`${a} event for ${c}`}}(a,b),g={timestamp:new Date().toISOString(),eventType:a,severity:d,message:e||f,metadata:b};try{let e=await (0,c.createServiceSupabaseClient)();e&&await e.from("email_audit_log").insert({company_id:b.companyId||null,event_type:a,severity:d,message:g.message,team_member_id:b.teamMemberId||null,user_id:b.userId||null,gmail_email:b.gmailEmail||null,metadata:b,ip_address:b.ipAddress||null,user_agent:b.userAgent||null})}catch(a){console.error("[Email Audit] Failed to store in database:",a)}return{success:!0}}catch(a){return console.error("[Email Audit] Failed to log event:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function p(a,b,c){await o("gmail_token_refresh_failed",{teamMemberId:a,gmailEmail:b,error:c},"warning")}m||(m=setInterval(function(){let a=Date.now();for(let[b,c]of j.entries())a-c.lastRequest>36e5&&j.delete(b);for(let[b,c]of k.entries())a-c>36e5&&k.delete(b);for(let b of l)a>b.expiresAt&&l.delete(b)},3e5));var q=a.i(395731);let r="https://oauth2.googleapis.com/token",s="https://gmail.googleapis.com/gmail/v1",t="https://www.googleapis.com/auth/gmail.send",u="https://www.googleapis.com/auth/gmail.readonly",v="https://www.googleapis.com/auth/gmail.modify";async function w(a){try{let b=await (0,c.createServiceSupabaseClient)(),{data:d}=await b.from("companies").select("email_provider").eq("id",a).single();return d?.email_provider||"managed"}catch(a){return console.error("[Gmail] Error getting company email provider:",a),"managed"}}async function x(a,b,d){try{if("gmail"===b){let b=await y(a);if(!b||!b.isValid)return{success:!1,error:"Gmail is not connected. Please connect Gmail first."}}let e=await (0,c.createServiceSupabaseClient)(),{error:f}=await e.from("companies").update({email_provider:b,email_provider_updated_at:new Date().toISOString(),email_provider_updated_by:d||null}).eq("id",a);if(f)return{success:!1,error:f.message};return{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function y(a){try{let b=await (0,c.createServiceSupabaseClient)(),{data:d,error:e}=await b.from("company_gmail_tokens").select("*").eq("company_id",a).maybeSingle();if(e||!d)return null;let f={companyId:d.company_id,gmailEmail:d.gmail_email,gmailDisplayName:d.gmail_display_name,accessToken:d.access_token,refreshToken:d.refresh_token,tokenExpiresAt:new Date(d.token_expires_at),isValid:d.is_valid,scopes:d.scopes||[t],connectedBy:d.connected_by,connectedByName:d.connected_by_name};if(z(f.tokenExpiresAt)){let b=await A(a,f.refreshToken);if(b)return b;console.warn("[Gmail] Token refresh failed, using existing token")}return f}catch(a){return console.error("[Gmail] Error getting company tokens:",a),null}}function z(a){return a.getTime()-Date.now()<3e5}async function A(a,b){try{let d=process.env.GOOGLE_CLIENT_ID,e=process.env.GOOGLE_CLIENT_SECRET;if(!d||!e)return console.error("[Gmail] Missing GOOGLE_CLIENT_ID or GOOGLE_CLIENT_SECRET"),null;let f=await fetch(r,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:d,client_secret:e,refresh_token:b,grant_type:"refresh_token"})});if(!f.ok){let b=await f.text();return console.error(`[Gmail] Token refresh failed: ${f.status}`,b),(400===f.status||401===f.status)&&await B(a,`Refresh failed: ${f.status}`),null}let g=await f.json(),h=new Date(Date.now()+1e3*g.expires_in),i=await (0,c.createServiceSupabaseClient)(),{data:j,error:k}=await i.from("company_gmail_tokens").update({access_token:g.access_token,token_expires_at:h.toISOString(),...g.refresh_token&&{refresh_token:g.refresh_token},is_valid:!0,last_error:null}).eq("company_id",a).select("*").single();if(k||!j)return console.error("[Gmail] Failed to update refreshed token:",k?.message),null;return{companyId:j.company_id,gmailEmail:j.gmail_email,gmailDisplayName:j.gmail_display_name,accessToken:j.access_token,refreshToken:j.refresh_token,tokenExpiresAt:new Date(j.token_expires_at),isValid:j.is_valid,scopes:j.scopes||[t],connectedBy:j.connected_by,connectedByName:j.connected_by_name}}catch(a){return console.error("[Gmail] Token refresh error:",a),null}}async function B(a,b){try{let d=await (0,c.createServiceSupabaseClient)();await d.from("company_gmail_tokens").update({is_valid:!1,last_error:b}).eq("company_id",a)}catch(a){console.error("[Gmail] Failed to mark token invalid:",a)}}async function C(a,b,d,e,f,g,h,i,j){try{if(!h.includes(t))return{success:!1,error:`Missing required scope: ${t}`};let k=await (0,c.createServiceSupabaseClient)(),l=new Date(Date.now()+1e3*g),{error:m}=await k.from("company_gmail_tokens").upsert({company_id:a,gmail_email:b,gmail_display_name:d,access_token:e,refresh_token:f,token_expires_at:l.toISOString(),scopes:h,is_valid:!0,last_error:null,connected_by:i||null,connected_by_name:j||null},{onConflict:"company_id"});if(m)return console.error("[Gmail] Failed to store tokens:",m.message),{success:!1,error:m.message};return{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function D(a){try{let b=await (0,c.createServiceSupabaseClient)(),{data:d}=await b.from("company_gmail_tokens").select("access_token").eq("company_id",a).single(),{error:e}=await b.from("company_gmail_tokens").delete().eq("company_id",a);if(e)return{success:!1,error:e.message};if(await x(a,"managed"),d?.access_token)try{await fetch(`https://oauth2.googleapis.com/revoke?token=${d.access_token}`,{method:"POST"})}catch{console.warn("[Gmail] Token revocation request failed (non-critical)")}return{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function E(a,b){try{var d;let e=await y(a);if(!e)return{success:!1,error:"Gmail not connected for this company"};if(!e.isValid)return{success:!1,error:`Gmail connection invalid: ${e.gmailEmail}`};let f=(d=function(a){let b=`boundary_${Date.now()}_${Math.random().toString(36).substring(7)}`,c=[`From: ${a.from}`,`To: ${a.to}`,`Subject: =?UTF-8?B?${Buffer.from(a.subject).toString("base64")}?=`,"MIME-Version: 1.0"];if(a.replyTo&&c.push(`Reply-To: ${a.replyTo}`),a.cc&&c.push(`Cc: ${a.cc}`),a.bcc&&c.push(`Bcc: ${a.bcc}`),a.headers)for(let[b,d]of Object.entries(a.headers))c.push(`${b}: ${d}`);c.push(`Content-Type: multipart/alternative; boundary="${b}"`),c.push("");let d=a.text||a.html.replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();return c.push(`--${b}`),c.push("Content-Type: text/plain; charset=UTF-8"),c.push("Content-Transfer-Encoding: base64"),c.push(""),c.push(Buffer.from(d).toString("base64")),c.push(`--${b}`),c.push("Content-Type: text/html; charset=UTF-8"),c.push("Content-Transfer-Encoding: base64"),c.push(""),c.push(Buffer.from(a.html).toString("base64")),c.push(`--${b}--`),c.join("\r\n")}({from:e.gmailDisplayName?`${e.gmailDisplayName} <${e.gmailEmail}>`:e.gmailEmail,to:Array.isArray(b.to)?b.to.join(", "):b.to,subject:b.subject,html:b.html,text:b.text,replyTo:b.replyTo,cc:b.cc?Array.isArray(b.cc)?b.cc.join(", "):b.cc:void 0,bcc:b.bcc?Array.isArray(b.bcc)?b.bcc.join(", "):b.bcc:void 0,headers:b.headers}),Buffer.from(d).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")),g=await fetch(`${s}/users/me/messages/send`,{method:"POST",headers:{Authorization:`Bearer ${e.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({raw:f})});if(!g.ok){let b=await g.json().catch(()=>({})),c=b.error?.message||`Gmail API error: ${g.status}`;return console.error(`[Gmail] Send failed: ${c}`),401===g.status&&await B(a,"Authentication failed"),{success:!1,error:c}}let h=await g.json(),i=await (0,c.createServiceSupabaseClient)();return await i.from("company_gmail_tokens").update({last_used_at:new Date().toISOString()}).eq("company_id",a),{success:!0,messageId:h.id,threadId:h.threadId,labelIds:h.labelIds}}catch(b){let a=b instanceof Error?b.message:"Unknown error";return console.error("[Gmail] Send error:",a),{success:!1,error:a}}}async function F(a,b=!1){try{let c=await y(a);if(!c)return{connected:!1,tokenValid:!1};let d={connected:!0,email:c.gmailEmail,displayName:c.gmailDisplayName,tokenValid:c.isValid,tokenExpiresAt:c.tokenExpiresAt,connectedBy:c.connectedByName,apiHealthy:void 0};if(b&&c.isValid)try{d.apiHealthy=(await fetch(`${s}/users/me/profile`,{headers:{Authorization:`Bearer ${c.accessToken}`}})).ok}catch{d.apiHealthy=!1}return d}catch(a){return{connected:!1,tokenValid:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function G(a){try{let b=await (0,c.createServiceSupabaseClient)(),{data:d,error:e}=await b.from("user_gmail_tokens").select("*, user_email_accounts!inner(email_address)").eq("team_member_id",a).eq("sync_enabled",!0).maybeSingle();if(e||!d)return null;let f=i(d.access_token),g=i(d.refresh_token),h={teamMemberId:d.team_member_id,emailAccountId:d.user_email_account_id,gmailEmail:d.user_email_accounts.email_address,accessToken:f,refreshToken:g,tokenExpiresAt:new Date(d.token_expiry),scopes:d.scopes||[],syncEnabled:d.sync_enabled,lastSyncedAt:d.last_synced_at?new Date(d.last_synced_at):void 0};if(z(h.tokenExpiresAt)){let b=await H(a,h.refreshToken);if(b)return b;console.warn("[Gmail] User token refresh failed, using existing token")}return h}catch(a){return console.error("[Gmail] Error getting user tokens:",a),null}}async function H(a,b){try{let d=process.env.GOOGLE_CLIENT_ID,e=process.env.GOOGLE_CLIENT_SECRET;if(!d||!e)return console.error("[Gmail] Missing GOOGLE_CLIENT_ID or GOOGLE_CLIENT_SECRET"),null;let f=await fetch(r,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:d,client_secret:e,refresh_token:b,grant_type:"refresh_token"})});if(!f.ok){let b=await f.text();return console.error(`[Gmail] User token refresh failed: ${f.status}`,b),await p(a,"Unknown",`Token refresh failed: ${f.status} - ${b}`),(400===f.status||401===f.status)&&await I(a,`Refresh failed: ${f.status}`),null}let g=await f.json(),j=new Date(Date.now()+1e3*g.expires_in),k=h(g.access_token),l=g.refresh_token?h(g.refresh_token):void 0,m=await (0,c.createServiceSupabaseClient)(),{data:n,error:o}=await m.from("user_gmail_tokens").update({access_token:k,token_expiry:j.toISOString(),...l&&{refresh_token:l}}).eq("team_member_id",a).select("*, user_email_accounts!inner(email_address)").single();if(o||!n)return console.error("[Gmail] Failed to update refreshed user token:",o?.message),null;let q=i(n.access_token),s=i(n.refresh_token);return{teamMemberId:n.team_member_id,emailAccountId:n.user_email_account_id,gmailEmail:n.user_email_accounts.email_address,accessToken:q,refreshToken:s,tokenExpiresAt:new Date(n.token_expiry),scopes:n.scopes||[],syncEnabled:n.sync_enabled,lastSyncedAt:n.last_synced_at?new Date(n.last_synced_at):void 0}}catch(a){return console.error("[Gmail] User token refresh error:",a),null}}async function I(a,b){try{let b=await (0,c.createServiceSupabaseClient)();await b.from("user_gmail_tokens").update({sync_enabled:!1}).eq("team_member_id",a)}catch(a){console.error("[Gmail] Failed to mark user token invalid:",a)}}async function J(a,b,d,e,f,g){try{if(!g.includes(u)&&!g.includes(v))return{success:!1,error:`Missing required scope: ${u} or ${v}`};let i=await (0,c.createServiceSupabaseClient)(),j=new Date(Date.now()+1e3*f),k=h(d),l=h(e),{error:m}=await i.from("user_gmail_tokens").upsert({team_member_id:a,user_email_account_id:b,access_token:k,refresh_token:l,token_expiry:j.toISOString(),scopes:g,sync_enabled:!0,last_synced_at:null},{onConflict:"user_email_account_id"});if(m)return console.error("[Gmail] Failed to store user tokens:",m.message),{success:!1,error:m.message};return{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function K(a){try{let b=await (0,c.createServiceSupabaseClient)(),{data:d}=await b.from("user_gmail_tokens").select("access_token").eq("team_member_id",a).single(),{error:e}=await b.from("user_gmail_tokens").delete().eq("team_member_id",a);if(e)return{success:!1,error:e.message};if(d?.access_token)try{await fetch(`https://oauth2.googleapis.com/revoke?token=${d.access_token}`,{method:"POST"})}catch{console.warn("[Gmail] User token revocation request failed (non-critical)")}return{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function L(a,b=50,c){try{let d=await G(a);if(!d)return{messages:[],error:"Gmail not connected for this user"};let e=new URLSearchParams({maxResults:b.toString(),q:"in:inbox",...c&&{pageToken:c}}),f=await fetch(`${s}/users/me/messages?${e}`,{headers:{Authorization:`Bearer ${d.accessToken}`}});if(!f.ok){let a=await f.text();return console.error(`[Gmail] Inbox fetch failed: ${f.status}`,a),{messages:[],error:`API error: ${f.status}`}}let g=await f.json(),h=g.messages||[],i=[];for(let a of h){let b=await fetch(`${s}/users/me/messages/${a.id}`,{headers:{Authorization:`Bearer ${d.accessToken}`}});if(b.ok){let a=await b.json();i.push(a)}}return{messages:i,nextPageToken:g.nextPageToken}}catch(b){let a=b instanceof Error?b.message:"Unknown error";return console.error("[Gmail] Inbox fetch error:",a),{messages:[],error:a}}}async function M(a,b,d,e){try{let f=await (0,c.createServiceSupabaseClient)(),{data:g}=await f.from("communications").select("id").eq("gmail_message_id",e.gmailMessageId).maybeSingle();if(g)return{success:!0,communicationId:g.id};let h=e.from.match(/<(.+?)>/)?.[1]||e.from,{data:i}=await f.from("customers").select("id").eq("company_id",a).eq("email",h).maybeSingle(),{data:j,error:k}=await f.from("communications").insert({company_id:a,type:"email",direction:"inbound",status:"received",from_address:h,to_address:e.to[0]||"",subject:e.subject,body:e.htmlBody||e.textBody||"",customer_id:i?.id||null,mailbox_owner_id:b,email_account_id:d,visibility_scope:"private",gmail_message_id:e.gmailMessageId,gmail_thread_id:e.gmailThreadId}).select("id").single();if(k)return console.error("[Gmail] Failed to store message:",k.message),{success:!1,error:k.message};return{success:!0,communicationId:j.id}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function N(a,b){let d=new Date,e=0,f=0,g=[],h=null;try{let i,j=n(b);if(!j.allowed)return await o("sync_rate_limited",{teamMemberId:b,retryAfter:j.retryAfter},"warning"),{success:!1,messagesFetched:0,messagesStored:0,errors:[j.reason||"Rate limit exceeded"],lastSyncedAt:d};if(!(h=function(a){if(!n(a).allowed)return null;let b=Date.now(),c={teamMemberId:a,startedAt:b,expiresAt:b+18e5};return l.add(c),k.set(a,b),c}(b)))return{success:!1,messagesFetched:0,messagesStored:0,errors:["Could not acquire sync lock - another sync may be in progress"],lastSyncedAt:d};await o("sync_started",{teamMemberId:b},"info");let m=await G(b);if(!m)return{success:!1,messagesFetched:0,messagesStored:0,errors:["Gmail not connected"],lastSyncedAt:d};let p=!0;for(;p;){let{messages:c,nextPageToken:d,error:h}=await L(b,50,i);if(h){g.push(h);break}for(let d of(e+=c.length,c)){let c=function(a){let b,c,d=a.payload.headers,e=a=>d.find(b=>b.name.toLowerCase()===a.toLowerCase())?.value||"",f=e("From"),g=e("To").split(",").map(a=>a.trim()).filter(Boolean),h=e("Cc")?.split(",").map(a=>a.trim()).filter(Boolean),i=e("Subject"),j=a=>{"text/plain"===a.mimeType&&a.body?.data?b=Buffer.from(a.body.data,"base64").toString("utf-8"):"text/html"===a.mimeType&&a.body?.data&&(c=Buffer.from(a.body.data,"base64").toString("utf-8")),a.parts&&a.parts.forEach(j)};return a.payload.parts?a.payload.parts.forEach(j):a.payload.body?.data&&("text/plain"===a.payload.mimeType?b=Buffer.from(a.payload.body.data,"base64").toString("utf-8"):"text/html"===a.payload.mimeType&&(c=Buffer.from(a.payload.body.data,"base64").toString("utf-8"))),{gmailMessageId:a.id,gmailThreadId:a.threadId,from:f,to:g,cc:h,subject:i,textBody:b,htmlBody:c,receivedAt:new Date(parseInt(a.internalDate)),hasAttachments:a.payload.parts?.some(a=>a.body.size>0&&a.mimeType.startsWith("attachment/"))||!1,labels:a.labelIds}}(d),{success:e,error:h}=await M(a,b,m.emailAccountId,c);e?f++:h&&g.push(h)}i=d,p=!!d&&c.length>0}let q=await (0,c.createServiceSupabaseClient)();return await q.from("user_gmail_tokens").update({last_synced_at:d.toISOString()}).eq("team_member_id",b),await o("sync_completed",{teamMemberId:b,syncMessageCount:f},"info"),{success:0===g.length,messagesFetched:e,messagesStored:f,errors:g,lastSyncedAt:d}}catch(c){let a=c instanceof Error?c.message:"Unknown error";return g.push(a),await o("sync_failed",{teamMemberId:b,error:a},"error"),{success:!1,messagesFetched:e,messagesStored:f,errors:g,lastSyncedAt:d}}finally{var i;h&&(i=h,l.delete(i))}}async function O(){return!!(process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET&&1)}(0,q.ensureServerEntryExports)([w,x,y,A,C,D,E,F,G,H,J,K,L,M,N,O]),(0,b.registerServerReference)(w,"40787b1598849126560f9f0b0f8fe8967338c7bf28",null),(0,b.registerServerReference)(x,"70dd3bc4222a87350dc137fa9cbcb849fa1913b397",null),(0,b.registerServerReference)(y,"40beeb56302a20d27cd8ba7a0988310f855633d7e6",null),(0,b.registerServerReference)(A,"60eeb51685ac265a4ad793a230a515fe6e462f16f4",null),(0,b.registerServerReference)(C,"7f06df826c4fff42950e712c0f548254e275be2a52",null),(0,b.registerServerReference)(D,"401d3d830065dd7c4777fad67f642392f48735c4ab",null),(0,b.registerServerReference)(E,"60302947fc4caffa53a719728f3c2cebace926098c",null),(0,b.registerServerReference)(F,"60856182db5eaec7f85eda2a5a94c5d7d3524325d6",null),(0,b.registerServerReference)(G,"400ce95360aaffa14a99dfdf969ba5166c69a59eb6",null),(0,b.registerServerReference)(H,"602fab67313b110e6ccb66e54b1e16450b2a772cc7",null),(0,b.registerServerReference)(J,"7e3a356960ddd52a3fa4dc6d981ae7202a59eb9a3d",null),(0,b.registerServerReference)(K,"404575d602ef4c60c0058b592b8c3e42fbcd13fc4c",null),(0,b.registerServerReference)(L,"708daa303e36e37247e22b5b828b6aad8c73ac283b",null),(0,b.registerServerReference)(M,"78d41ef818e75fef94d65a87ea1f0faf418132e3c5",null),(0,b.registerServerReference)(N,"603643b13bf288cc628303bb4d12df0311b11434c7",null),(0,b.registerServerReference)(O,"00fe74bdf14126b5ad89e9480e82978d6357f356b3",null),a.s(["checkCompanyGmailHealth",()=>F,"disconnectCompanyGmail",()=>D,"disconnectUserGmail",()=>K,"fetchUserInbox",()=>L,"getCompanyEmailProvider",()=>w,"getCompanyGmailTokens",()=>y,"getUserGmailTokens",()=>G,"isGmailIntegrationEnabled",()=>O,"refreshCompanyGmailToken",()=>A,"refreshUserGmailToken",()=>H,"sendCompanyGmailEmail",()=>E,"setCompanyEmailProvider",()=>x,"storeCompanyGmailTokens",()=>C,"storeGmailMessage",()=>M,"storeUserGmailTokens",()=>J,"syncUserInbox",()=>N],854963)},66625,a=>{"use strict";var b=a.i(869251);a.i(666680);let c={apiKey:process.env.POSTMARK_API_KEY||"",webhookSecret:process.env.POSTMARK_WEBHOOK_SECRET||"",from:process.env.POSTMARK_FROM_EMAIL||process.env.EMAIL_FROM||"notifications@stratos.app",isConfigured:!!process.env.POSTMARK_API_KEY,providerName:"postmark"};async function d(a,b){if(!c.apiKey)return{success:!1,error:"Postmark API key is not configured. Set POSTMARK_API_KEY environment variable."};try{let d=await fetch(`https://api.postmarkapp.com${a}`,{...b,headers:{"X-Postmark-Server-Token":c.apiKey,"Content-Type":"application/json",Accept:"application/json",...b.headers}}),e=await d.json().catch(()=>({}));if(!d.ok)return{success:!1,error:e.Message||e.message||d.statusText,errorCode:e.ErrorCode};return{success:!0,data:e}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Postmark request failed"}}}async function e(a){let{to:b,subject:e,html:f,text:g,from:h=c.from,replyTo:i,tag:j,trackOpens:k=!0,trackLinks:l=!0,metadata:m,messageStream:n="outbound"}=a,o=Array.isArray(b)?b.join(", "):b,p=await d("/email",{method:"POST",body:JSON.stringify({From:h,To:o,Subject:e,HtmlBody:f,TextBody:g,ReplyTo:i,Tag:j,TrackOpens:k,TrackLinks:l?"HtmlAndText":"None",MessageStream:n,Metadata:m})});return p.success||console.error(`[Postmark] Email send failed: ${p.error}`),p}function f(){return c.isConfigured}var g=a.i(854963);let h="resend",i="postmark";function j(a){switch(a){case"resend":return(0,b.isResendConfigured)();case"postmark":return f();default:return!1}}async function k(a){if(!(0,b.isResendConfigured)()||!b.resend)return{success:!1,error:"Resend is not configured"};try{let c=[];if(a.tags)for(let[b,d]of Object.entries(a.tags))c.push({name:b,value:d});a.communicationId&&c.push({name:"communication_id",value:a.communicationId});let{data:d,error:e}=await b.resend.emails.send({from:a.from||b.emailConfig.from,to:a.to,subject:a.subject,html:a.html,text:a.text,replyTo:a.replyTo,tags:c.length>0?c:void 0});if(e)return{success:!1,error:e.message||"Resend send failed"};return{success:!0,messageId:d?.id}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Resend send failed"}}}async function l(a){if(!f())return{success:!1,error:"Postmark is not configured"};try{let b={...a.tags};a.communicationId&&(b.communication_id=a.communicationId),a.companyId&&(b.company_id=a.companyId);let d=a.tags?.template||a.tags?.type||"transactional",f=await e({to:a.to,subject:a.subject,html:a.html,text:a.text,from:a.from||c.from,replyTo:a.replyTo,tag:d,metadata:b});if(!f.success)return{success:!1,error:f.error};return{success:!0,messageId:f.data.MessageID}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Postmark send failed"}}}async function m(a,b){try{let c=await (0,g.sendCompanyGmailEmail)(a,{to:b.to,subject:b.subject,html:b.html,text:b.text,replyTo:b.replyTo,cc:b.cc,bcc:b.bcc});if(!c.success)return{success:!1,error:c.error};return{success:!0,messageId:c.messageId}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Gmail send failed"}}}async function n(a){try{if(!await (0,g.isGmailIntegrationEnabled)())return!1;let b=await (0,g.getCompanyGmailTokens)(a);return null!==b&&b.isValid}catch{return!1}}async function o(a){let b=[];if(Array.isArray(a.to)?a.to.join(", "):a.to,a.companyId){let c=await (0,g.getCompanyEmailProvider)(a.companyId);if("disabled"===c)return{success:!1,error:"Email is disabled for this company",usedFallback:!1,attempts:[]};if("gmail"===c&&await n(a.companyId)){let c=Date.now(),d=await m(a.companyId,a),e=Date.now()-c;if(b.push({provider:"gmail",success:d.success,messageId:d.messageId,error:d.error,latencyMs:e}),d.success)return{success:!0,provider:"gmail",messageId:d.messageId,usedFallback:!1,attempts:b};console.warn(`[EmailProvider] ✗ Gmail send failed in ${e}ms: ${d.error}`)}}if(j(h)){let c=Date.now(),d=await k(a),e=Date.now()-c;if(b.push({provider:h,success:d.success,messageId:d.messageId,error:d.error,latencyMs:e}),d.success)return{success:!0,provider:h,messageId:d.messageId,usedFallback:!1,attempts:b};console.warn(`[EmailProvider] ✗ Primary provider failed in ${e}ms: ${d.error}`)}else console.warn(`[EmailProvider] Primary provider (${h}) not configured`);if(j(i)){let c=Date.now(),d=await l(a),e=Date.now()-c;if(b.push({provider:i,success:d.success,messageId:d.messageId,error:d.error,latencyMs:e}),d.success)return{success:!0,provider:i,messageId:d.messageId,usedFallback:!0,attempts:b};console.error(`[EmailProvider] ✗ Fallback provider also failed in ${e}ms: ${d.error}`)}else console.warn(`[EmailProvider] Fallback provider (${i}) not configured`);let c=b.map(a=>`${a.provider}: ${a.error}`).join("; ");return console.error(`[EmailProvider] ✗ All providers failed: ${c}`),{success:!1,error:`All email providers failed. ${c}`,usedFallback:b.length>1,attempts:b}}function p(){let a,c,d=j(h),e=j(i),g=(c=[],(0,b.isResendConfigured)()&&c.push("resend"),f()&&c.push("postmark"),c);return a=d&&e?"fully_configured":d?"primary_only":e?"fallback_only":"not_configured",{primaryConfigured:d,fallbackConfigured:e,fallbackEnabled:!0,configuredProviders:g,status:a}}a.s(["getProviderSetupInfo",()=>p,"sendEmailWithFallback",()=>o],66625)},672766,a=>{"use strict";var b=a.i(780195),c=a.i(933427);async function d(a){try{let b=await (0,c.createServiceSupabaseClient)();a.eventType.includes("success");let{error:d}=await b.from("email_provider_events").insert({provider:a.provider,event_type:a.eventType,message_id:a.messageId||null,latency_ms:a.latencyMs||null,error_message:a.error||null,metadata:a.metadata||null,company_id:a.companyId||null,domain_id:a.domainId||null,created_at:new Date().toISOString()});if(d)return console.error(`[ProviderMonitor] Failed to record event: ${d.message}`),{success:!1,error:d.message};return{success:!0}}catch(a){return console.error(`[ProviderMonitor] Error recording event: ${a instanceof Error?a.message:"Unknown error"}`),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function e(a,b,c,e){await d({provider:a,eventType:"send_success",messageId:b,latencyMs:c,...e})}async function f(a,b,c,e){await d({provider:a,eventType:"send_failure",error:b,latencyMs:c,...e})}async function g(a,b,c,e){await d({provider:a,eventType:"fallback_triggered",error:c,metadata:{fallback_provider:b,...e?.metadata},...e})}async function h(a,b="24h"){try{let d=await (0,c.createServiceSupabaseClient)(),e=new Date,f=new Date(e.getTime()-({"1h":36e5,"24h":864e5,"7d":6048e5,"30d":2592e6})[b]).toISOString(),{data:g,error:h}=await d.from("email_provider_events").select("event_type, latency_ms, error_message, created_at").eq("provider",a).gte("created_at",f).order("created_at",{ascending:!1});if(h)return console.error(`[ProviderMonitor] Failed to get stats: ${h.message}`),null;if(!g||0===g.length)return{provider:a,period:b,totalEvents:0,successCount:0,failureCount:0,successRate:0,averageLatencyMs:0,p95LatencyMs:0,fallbackCount:0,lastEventAt:null,lastError:null};let i=g.filter(a=>"send_success"===a.event_type||"send_failure"===a.event_type),j=g.filter(a=>"send_success"===a.event_type),k=g.filter(a=>"send_failure"===a.event_type),l=g.filter(a=>"fallback_triggered"===a.event_type),m=j.map(a=>a.latency_ms).filter(a=>null!==a).sort((a,b)=>a-b),n=m.length>0?m.reduce((a,b)=>a+b,0)/m.length:0,o=Math.floor(.95*m.length),p=m.length>0?m[o]||m[m.length-1]:0,q=k[0];return{provider:a,period:b,totalEvents:g.length,successCount:j.length,failureCount:k.length,successRate:i.length>0?j.length/i.length*100:0,averageLatencyMs:Math.round(n),p95LatencyMs:Math.round(p),fallbackCount:l.length,lastEventAt:g[0]?new Date(g[0].created_at):null,lastError:q?.error_message||null}}catch(a){return console.error(`[ProviderMonitor] Error getting stats: ${a instanceof Error?a.message:"Unknown error"}`),null}}async function i(){let a,[b,c]=await Promise.all([h("resend","24h"),h("postmark","24h")]),d=a=>a&&0!==a.totalEvents?a.successRate>=99?"healthy":a.successRate>=95?"degraded":"down":"unknown",e=(b?.fallbackCount||0)+(c?.fallbackCount||0),f=(b?.successCount||0)+(b?.failureCount||0)+(c?.successCount||0)+(c?.failureCount||0),g=f>0?e/f*100:0,i=d(b),j=d(c);return"down"===i&&"down"===j?a="CRITICAL: Both providers are down. Check API keys and provider status.":"down"===i?a="Primary provider (Resend) is down. Traffic is using fallback.":g>10?a="High fallback rate detected. Review primary provider health.":"degraded"===i&&(a="Primary provider showing degraded performance. Monitor closely."),{resend:{status:i,successRate24h:b?.successRate||0,avgLatencyMs:b?.averageLatencyMs||0,totalSent24h:b?.successCount||0,lastError:b?.lastError||void 0,lastSuccessAt:b?.lastEventAt||void 0},postmark:{status:j,successRate24h:c?.successRate||0,avgLatencyMs:c?.averageLatencyMs||0,totalSent24h:c?.successCount||0,lastError:c?.lastError||void 0,lastSuccessAt:c?.lastEventAt||void 0},overall:{primaryProvider:"resend",fallbackProvider:"postmark",fallbackRate24h:g,recommendedAction:a}}}async function j(a=30){try{let b=await (0,c.createServiceSupabaseClient)(),d=new Date;d.setDate(d.getDate()-a);let{data:e,error:f}=await b.from("email_provider_events").delete().lt("created_at",d.toISOString()).select("id");if(f)return console.error(`[ProviderMonitor] Cleanup failed: ${f.message}`),{deleted:0,error:f.message};return{deleted:e?.length||0}}catch(b){let a=b instanceof Error?b.message:"Unknown error";return console.error(`[ProviderMonitor] Cleanup error: ${a}`),{deleted:0,error:a}}}async function k(a){let b=await h(a,"1h");return b&&0!==b.totalEvents?b.successRate<90?{shouldAlert:!0,severity:"critical",reason:`${a} success rate is ${b.successRate.toFixed(1)}% (below 90%)`}:b.successRate<99?{shouldAlert:!0,severity:"warning",reason:`${a} success rate is ${b.successRate.toFixed(1)}% (below 99%)`}:b.averageLatencyMs>5e3?{shouldAlert:!0,severity:"warning",reason:`${a} average latency is ${b.averageLatencyMs}ms (above 5s)`}:{shouldAlert:!1,severity:"info"}:{shouldAlert:!1,severity:"info"}}(0,a.i(395731).ensureServerEntryExports)([d,e,f,g,h,i,j,k]),(0,b.registerServerReference)(d,"40e06418f4b93b40c84a25511e0468e1e8a41ddecf",null),(0,b.registerServerReference)(e,"783861d25688b32ba086bbe9e45444975c36a1b285",null),(0,b.registerServerReference)(f,"78255c3fa8c9facf7c3f353202f2907836e8eb5539",null),(0,b.registerServerReference)(g,"78766431b437b16f7cb00b4d64a2f3be5e092ed724",null),(0,b.registerServerReference)(h,"60c643a41ce1a8e6cc8338da6e2f3678c386910460",null),(0,b.registerServerReference)(i,"00a122f9d5fe3a1603c636c3a251886129b66154f8",null),(0,b.registerServerReference)(j,"40d3c4ceeaee653aa257a28ed429a7fd272fa9fb66",null),(0,b.registerServerReference)(k,"40c7885bdc4fe4cdd5f57e78579230c58088adbef4",null),a.s(["checkProviderAlert",()=>k,"cleanupOldEvents",()=>j,"getProviderHealthDashboard",()=>i,"getProviderStats",()=>h,"recordFallbackTriggered",()=>g,"recordProviderEvent",()=>d,"recordSendFailure",()=>f,"recordSendSuccess",()=>e])},198114,a=>a.a(async(b,c)=>{try{var d=a.i(780195),e=a.i(149664),f=a.i(146057),g=a.i(136874),h=a.i(103984),i=a.i(463556),j=a.i(343860),k=a.i(941771),l=a.i(869251),m=a.i(66625),n=a.i(672766),o=a.i(395731),p=b([e]);async function q({to:b,subject:c,template:d,templateType:o,replyTo:p,tags:q=[],companyId:s,communicationId:u,fromOverride:v,cc:w,bcc:x,attachments:y,isMarketingEmail:z=!1,skipPreSendChecks:A=!1,textContent:B="",unsubscribeUrl:C,listId:D}){let E=null,F=null,G=null;try{if(l.emailConfig.isDevelopment)return{success:!0,data:{id:`dev-mode-${Date.now()}`,message:"Email logged in development mode (not actually sent)"}};let f=(0,m.getProviderSetupInfo)();if("not_configured"===f.status)return{success:!1,error:"Email service not configured. Please add RESEND_API_KEY or POSTMARK_API_KEY to environment variables."};let H=await (0,g.createClient)();if(s){if(!(G=await (0,k.getCompanyActiveDomain)(s)))return{success:!1,error:"No active email domain configured for this company. Please set up email in settings."};E=G.domainId,F=G.replyToEmail?G.replyToEmail:`support@${G.domain}`}let I=p||F||void 0,J=i.emailSendSchema.parse({to:b,subject:c,replyTo:I}),K=Array.isArray(J.to)?J.to:[J.to];if(s&&E){let a=await (0,k.checkRateLimit)(G.domainId);if(!a.allowed)return{success:!1,error:a.reason||"Rate limit exceeded"};if(A){let a=await (0,j.checkSuppressionList)(s,K),b=K.filter(b=>{let c=a.get(b.toLowerCase());return!c?.suppressed});if(0===b.length)return{success:!1,error:"All recipients are on suppression list"};b.length<K.length&&(J.to=1===b.length?b[0]:b)}else{let a=await (0,e.render)(d),b=B||t(a),f=await (0,j.runPreSendChecks)(s,G.domainId,K,c,a,b,z);if(!f.allowed)return{success:!1,error:`Deliverability check failed: ${f.errors.join("; ")}`,data:{spamScore:f.spamScore,warnings:f.warnings,suggestions:f.suggestions}};let g=K.filter(a=>{let b=f.recipientStatus?.find(b=>b.email.toLowerCase()===a.toLowerCase());return!b?.suppressed});if(0===g.length)return{success:!1,error:"All recipients are on suppression list - no emails sent"};g.length<K.length&&(J.to=1===g.length?g[0]:g),f.warnings.length>0&&console.warn("[Email Deliverability Warnings]",f.warnings)}let b=await (0,k.incrementEmailCounter)(G.domainId);if(!b.allowed)return{success:!1,error:b.reason||"Rate limit exceeded"}}let L=v||l.emailConfig.from;if(s&&H){let a=await r(H,s);a&&(L=a)}let M=await (0,e.render)(d);if(u){let{addEmailTracking:b}=await a.A(315292);M=b(M,u)}let N=[...q,{name:"template",value:o},{name:"environment",value:"production"}];u&&N.push({name:"communication_id",value:u}),s&&N.push({name:"company_id",value:s});let O={"X-Priority":"3","X-Mailer":"Stratos Email System"};z&&C&&(O["List-Unsubscribe"]=`<${C}>`,O["List-Unsubscribe-Post"]="List-Unsubscribe=One-Click"),D&&(O["List-Id"]=D),z||(O["Auto-Submitted"]="auto-generated",O.Precedence="bulk");let P={};for(let a of N)P[a.name]=a.value;let Q=Date.now(),R=await (0,m.sendEmailWithFallback)({to:J.to,subject:J.subject,html:M,text:B||t(M),from:L,replyTo:J.replyTo,tags:P,communicationId:u,companyId:s,cc:w,bcc:x,attachments:y}),S=Date.now()-Q;for(let a of R.attempts)a.success?await (0,n.recordSendSuccess)(a.provider,a.messageId||"",a.latencyMs,{companyId:s,domainId:E||void 0,metadata:{template:o}}):await (0,n.recordSendFailure)(a.provider,a.error||"Unknown error",a.latencyMs,{companyId:s,domainId:E||void 0,metadata:{template:o}});if(R.usedFallback&&R.success){let a=R.attempts.find(a=>"resend"===a.provider);await (0,n.recordFallbackTriggered)("resend","postmark",a?.error||"Primary failed",{companyId:s,metadata:{template:o}})}if(R.success){try{H&&await H.from("email_logs").insert({to:Array.isArray(J.to)?J.to.join(", "):J.to,from:L,subject:J.subject,html_body:M,status:"sent",message_id:R.messageId,company_id:s||null,metadata:{template:o,tags:N,provider:R.provider,usedFallback:R.usedFallback,latencyMs:S},sent_at:new Date().toISOString()})}catch(a){}if(E)try{await (0,h.recordDeliveryEvent)({domainId:E,eventType:"delivered",emailId:R.messageId,metadata:{template:o,provider:R.provider}})}catch(a){}return{success:!0,data:{id:R.messageId,message:`Email sent successfully via ${R.provider}${R.usedFallback?" (fallback)":""}`}}}console.error(`[EmailSender] ✗ All providers failed: ${R.error}`);try{H&&await H.from("email_logs").insert({to:Array.isArray(J.to)?J.to.join(", "):J.to,from:L,subject:J.subject,html_body:M,status:"failed",error_message:R.error||"All providers failed",company_id:s||null,metadata:{template:o,tags:N,attempts:R.attempts,latencyMs:S},retry_count:0,max_retries:3,next_retry_at:new Date(Date.now()+3e5).toISOString()})}catch(a){}if(E)try{await (0,h.recordDeliveryEvent)({domainId:E,eventType:"bounced",metadata:{error:R.error,template:o,attempts:R.attempts.length}})}catch(a){}return{success:!1,error:R.error||"Failed to send email (all providers failed)"}}catch(a){if(a instanceof f.z.ZodError)return{success:!1,error:a.issues[0]?.message||"Invalid email data"};return{success:!1,error:a instanceof Error?a.message:"Failed to send email"}}}async function r(a,b){let{data:c}=await a.from("companies").select("name").eq("id",b).single(),d=c?.name||"Notification",{data:e}=await a.from("company_email_domains").select("domain_name, is_platform_subdomain").eq("company_id",b).eq("status","verified").eq("sending_enabled",!0).eq("is_suspended",!1).order("is_platform_subdomain",{ascending:!0}).order("created_at",{ascending:!1}).maybeSingle();if(e?.domain_name)return s(d,`notifications@${e.domain_name}`);let{data:f}=await a.from("communication_email_settings").select("smtp_from_email, smtp_from_name").eq("company_id",b).maybeSingle();return f?.smtp_from_email?s(f.smtp_from_name,f.smtp_from_email):null}function s(a,b){return a?.trim()?`${a} <${b}>`:b}function t(a){let b=a.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"");return b=(b=(b=(b=(b=(b=(b=b.replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"")).replace(/<\/(p|div|h[1-6]|li|br|tr)>/gi,"\n")).replace(/<(br|hr)\s*\/?>/gi,"\n")).replace(/<[^>]+>/g," ")).replace(/&nbsp;/gi," ").replace(/&amp;/gi,"&").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&quot;/gi,'"').replace(/&#39;/gi,"'").replace(/&mdash;/gi,"—").replace(/&ndash;/gi,"–")).replace(/\s+/g," ").trim()).replace(/\n\s*\n/g,"\n\n")}async function u(b,c,d,e){let{addToSuppressionList:f,addToGlobalBounceList:g}=await a.A(449334);"hard"===d&&await f(b,c,"bounce",e),await g(c,d,e)}async function v(b,c){let{addToSuppressionList:d}=await a.A(449334);await d(b,c,"complaint","User reported email as spam")}[e]=p.then?(await p)():p,(0,o.ensureServerEntryExports)([q,u,v]),(0,d.registerServerReference)(q,"40f8c061cf84f884e77af3425bc24b8a8d72f598fb",null),(0,d.registerServerReference)(u,"78a8ea4f1cfa571a366adccf36ac04b1c85d61ae2b",null),(0,d.registerServerReference)(v,"6045f8436f9cdfdadb7bfe3955677adfc5f4102de0",null),a.s(["handleBounceWebhook",()=>u,"handleComplaintWebhook",()=>v,"sendEmail",()=>q]),c()}catch(a){c(a)}},!1)];

//# sourceMappingURL=apps_web_src_lib_email_388c15fd._.js.map