module.exports=[82608,a=>{"use strict";var b=a.i(780195),c=a.i(218188),d=a.i(136874),e=a.i(494218),f=a.i(395731);let g=process.env.TELNYX_DEFAULT_MESSAGING_PROFILE_ID||process.env.NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID||"",h=/\s+/;function i(a){if(!a)return null;let b=a.replace(/\D/g,"");return b?11===b.length&&b.startsWith("1")?`+${b}`:10===b.length?`+1${b}`:a.startsWith("+")?a:`+${b}`:null}async function j(a,b){let{data:c}=await a.from("messaging_brands").select("id").eq("company_id",b.company_id).maybeSingle();c?await a.from("messaging_brands").update({...b,updated_at:new Date().toISOString()}).eq("id",c.id):await a.from("messaging_brands").insert(b)}async function k(a,b){let{data:c}=await a.from("messaging_campaigns").select("id").eq("messaging_brand_id",b.messaging_brand_id).eq("usecase",b.usecase).maybeSingle();if(c)return await a.from("messaging_campaigns").update({...b,updated_at:new Date().toISOString()}).eq("id",c.id),c.id;let{data:d}=await a.from("messaging_campaigns").insert(b).select("id").single();return d?.id??null}async function l(a,b){let f=b?.supabase??await (0,d.createClient)();if(!f)return{success:!1,error:"Supabase unavailable"};let{data:g,error:k}=await f.from("companies").select("id, name, legal_name, doing_business_as, phone, support_email, support_phone, website, website_url, brand_color, industry, address, city, state, zip_code, owner_id, ein, tax_id").eq("id",a).single();if(k||!g)return{success:!1,error:k?.message||"Company not found"};let{data:l}=await f.from("profiles").select("full_name, email, phone").eq("id",g.owner_id).maybeSingle(),m=function(a){if(!a)return{first:"Support",last:"Team"};let b=a.trim().split(h);return 1===b.length?{first:b[0],last:"Team"}:{first:b[0],last:b.slice(1).join(" ")}}(l?.full_name),n=l?.email||g.support_email||"support@example.com",o=i(l?.phone)||i(g.support_phone)||i(g.phone)||"+18314280176",{data:p}=await f.from("messaging_brands").select("*").eq("company_id",a).maybeSingle();if(p?.telnyx_brand_id){let a=await (0,e.getTenDlcBrand)(p.telnyx_brand_id);a.success&&a.data&&await f.from("messaging_brands").update({status:a.data.status,updated_at:new Date().toISOString()}).eq("id",p.id)}if(!p?.telnyx_brand_id){let b={customer_reference:a,brand_name:g.legal_name||g.name,ein:g.ein||g.tax_id||process.env.FALLBACK_TEST_EIN||"00-0000000",ein_issuing_country:"US",vertical:function(a){if(!a)return"PROFESSIONAL";let b=a.toLowerCase();return b.includes("plumb")||b.includes("hvac")||b.includes("electric")?"HOME_SERVICES":(b.includes("clean"),"PROFESSIONAL")}(g.industry),website:g.website||g.website_url||null,company_type:"PRIVATE_PROFIT",address:{line1:g.address||"115 Flintlock Lane",city:g.city||"Ben Lomond",state:g.state||"CA",postal_code:g.zip_code||"95005",country:"US"},contact:{first_name:m.first,last_name:m.last,email:n,phone:o},optional_attributes:{doing_business_as:g.doing_business_as||g.name}},c=await (0,e.createTenDlcBrand)(b);if(!(c.success&&c.data))return{success:!1,error:c.error||"Failed to create 10DLC brand"};await j(f,{company_id:a,telnyx_brand_id:c.data.id,status:"submitted",legal_name:b.brand_name,doing_business_as:g.doing_business_as||g.name,ein:b.ein,vertical:b.vertical,website:b.website,support_email:n,support_phone:o,address_line1:b.address.line1,city:b.address.city,state:b.address.state,postal_code:b.address.postal_code,brand_color:g.brand_color})}return(0,c.revalidatePath)("/dashboard/settings/communications/brand"),{success:!0}}async function m(a,b,f){let h=f?.supabase??await (0,d.createClient)();if(!h)return{success:!1,error:"Supabase unavailable"};let{data:i}=await h.from("messaging_brands").select("*").eq("company_id",a).maybeSingle();if(!i?.telnyx_brand_id){let c=await l(a,{supabase:h});return c.success?m(a,b):c}let j="CUSTOMER_CARE",{data:n}=await h.from("messaging_campaigns").select("*").eq("messaging_brand_id",i.id).eq("usecase",j).maybeSingle();if(n?.telnyx_campaign_id){let a=await (0,e.getTenDlcCampaign)(n.telnyx_campaign_id);a.success&&a.data&&await h.from("messaging_campaigns").update({status:a.data.status,updated_at:new Date().toISOString()}).eq("id",n.id)}let o=n?.id??null,p=n?.telnyx_campaign_id??null;if(!n?.telnyx_campaign_id){if(!g)return{success:!1,error:"TELNYX_DEFAULT_MESSAGING_PROFILE_ID not configured"};let b=`${i.doing_business_as||i.legal_name} provides appointment updates, reminders, and service notifications to existing customers.`,c=`Hi {{customer_name}}, this is ${i.doing_business_as||i.legal_name} confirming your upcoming appointment. Reply HELP for assistance or STOP to opt out.`,d={brand_id:i.telnyx_brand_id,campaign_alias:`${a}-customer-care`,usecase:j,description:b,sample_messages:[c],message_flow:"Customers opt in during onboarding or by texting our business line. They receive service updates and can opt out by replying STOP.",terms_and_conditions:"Msg & data rates may apply. Reply STOP to opt out, HELP for help.",help_message:`Thanks for contacting ${i.doing_business_as||i.legal_name}. Reply STOP to unsubscribe.`,help_phone_number:i.support_phone||"+18314280176",help_email:i.support_email||"support@example.com",auto_renewal:!0,message_fee_credits:0,opt_in_keywords:["START","YES"],opt_out_keywords:["STOP","UNSUBSCRIBE"],opt_in_message:"Thanks for opting in to receive messages from us. Reply STOP to opt out.",opt_out_message:"You have successfully been unsubscribed and will no longer receive messages. Reply START to opt in again."},f=await (0,e.createTenDlcCampaign)(d);if(!(f.success&&f.data))return{success:!1,error:f.error||"Failed to create 10DLC campaign"};o=await k(h,{messaging_brand_id:i.id,telnyx_campaign_id:f.data.id,status:"submitted",usecase:j,description:b,sample_messages:d.sample_messages,messaging_profile_id:g})||n?.id||null,p=f.data.id}if(!(o&&p))return{success:!1,error:"Campaign not ready"};let{data:q}=await h.from("messaging_campaign_phone_numbers").select("*").eq("messaging_campaign_id",o).eq("phone_number_id",b.id).maybeSingle();if(!q?.telnyx_relationship_id){let a=await (0,e.attachNumberToCampaign)(p,b.e164);if(!(a.success&&a.data))return{success:!1,error:a.error||"Failed to link number to campaign"};q?await h.from("messaging_campaign_phone_numbers").update({telnyx_relationship_id:a.data.id,status:"submitted"}).eq("id",q.id):await h.from("messaging_campaign_phone_numbers").insert({messaging_campaign_id:o,phone_number_id:b.id,telnyx_relationship_id:a.data.id,status:"submitted"})}return await h.from("phone_numbers").update({telnyx_messaging_profile_id:g,metadata:{ten_dlc_campaign_id:p}}).eq("id",b.id),(0,c.revalidatePath)("/dashboard/settings/communications/phone-numbers"),{success:!0}}(0,f.ensureServerEntryExports)([l,m]),(0,b.registerServerReference)(l,"606753f8910b46d5792f4bdeb457cdf29d1a8bbadc",null),(0,b.registerServerReference)(m,"70a648f43fa62ae3dcf2070eb90413e96e81591e77",null),a.s(["ensureMessagingBranding",()=>l,"ensureMessagingCampaign",()=>m])},336176,a=>{"use strict";var b=a.i(780195),c=a.i(218188),d=a.i(857782),e=a.i(136874),f=a.i(111732),g=a.i(313170);function h(a){let b=a.toLowerCase();return b.includes("localhost")||b.includes("127.0.0.1")||b.includes("0.0.0.0")||b.endsWith(".local")||b.includes("://local")}function i(){let a=[],b=[],c={apiKey:!1,connectionId:!1,messagingProfileId:!1,webhookSecret:!1,publicKey:!1,siteUrl:!1};g.TELNYX_CONFIG.apiKey&&""!==g.TELNYX_CONFIG.apiKey.trim()?g.TELNYX_CONFIG.apiKey.length<20?a.push("TELNYX_API_KEY appears to be invalid (too short). Get your API key from https://portal.telnyx.com"):c.apiKey=!0:a.push("TELNYX_API_KEY is not set. This is required for all Telnyx operations."),g.TELNYX_CONFIG.connectionId&&""!==g.TELNYX_CONFIG.connectionId.trim()?c.connectionId=!0:a.push("NEXT_PUBLIC_TELNYX_CONNECTION_ID is not set. This is required for phone calls. Get it from Telnyx Portal → Mission Control → Connections."),g.TELNYX_CONFIG.messagingProfileId&&""!==g.TELNYX_CONFIG.messagingProfileId.trim()?c.messagingProfileId=!0:a.push("TELNYX_DEFAULT_MESSAGING_PROFILE_ID or NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID is not set. This is required for SMS/MMS. Run getDefaultMessagingProfile() to fetch it automatically from Telnyx."),g.TELNYX_CONFIG.webhookSecret&&""!==g.TELNYX_CONFIG.webhookSecret.trim()?c.webhookSecret=!0:b.push("TELNYX_WEBHOOK_SECRET is not set. Webhook signature verification will be disabled. Set this in production for security."),g.TELNYX_CONFIG.publicKey&&""!==g.TELNYX_CONFIG.publicKey.trim()?c.publicKey=!0:b.push("TELNYX_PUBLIC_KEY is not set. Webhook signature verification may not work correctly. Get it from Telnyx Portal → API Keys.");let d=function(){for(let a of["http://localhost:3000",process.env.SITE_URL,"http://localhost:3000",process.env.APP_URL])if(a&&a.trim()){let b=a.trim();if(!h(b))return b.startsWith("http")?b:`https://${b}`}let a=process.env.VERCEL_URL;if(a&&!h(a))return a.startsWith("http")?a:`https://${a}`}();return d?h(d)?"production"===process.env.VERCEL_ENV||"production"===process.env.DEPLOYMENT_ENV?a.push(`Site URL is set to localhost (${d}) but you're in production. Set NEXT_PUBLIC_SITE_URL to your production domain.`):b.push(`Site URL is set to localhost (${d}). This will not work in production.`):c.siteUrl=!0:a.push("NEXT_PUBLIC_SITE_URL or SITE_URL is not set to a valid production URL. This is required for webhook callbacks. Set it to your production domain (e.g., https://thorbis.co)."),{valid:0===a.length,errors:a,warnings:b,config:c}}async function j(){let b=i();if(!b.config.apiKey)return{valid:!1,error:"TELNYX_API_KEY is required for SMS operations"};if(!b.config.messagingProfileId){try{let{getDefaultMessagingProfile:b}=await a.A(44464),c=await b();if(c.success&&c.profile)return{valid:!1,error:"TELNYX_DEFAULT_MESSAGING_PROFILE_ID is required for SMS operations.",suggestedProfileId:c.profile.id}}catch{}return{valid:!1,error:"TELNYX_DEFAULT_MESSAGING_PROFILE_ID is required for SMS operations. Run getDefaultMessagingProfile() to fetch it automatically from Telnyx."}}return b.config.siteUrl?{valid:!0}:{valid:!1,error:"NEXT_PUBLIC_SITE_URL must be set to a valid production URL for SMS webhooks."}}function k(){let a=i();return a.config.apiKey?a.config.connectionId?a.config.siteUrl?{valid:!0}:{valid:!1,error:"NEXT_PUBLIC_SITE_URL must be set to a valid production URL for call webhooks."}:{valid:!1,error:"NEXT_PUBLIC_TELNYX_CONNECTION_ID is required for phone calls. Get it from Telnyx Portal → Mission Control → Connections."}:{valid:!1,error:"TELNYX_API_KEY is required for phone calls"}}var l=a.i(918448),m=a.i(870547),n=a.i(730347);async function o(a){try{let b=a.replace(/\D/g,""),c=b.startsWith("+")?a:b.startsWith("1")&&11===b.length?`+${b}`:`+1${b}`,d=await (0,n.listOwnedNumbers)({pageSize:100});if(!d.success||!d.data)return{success:!1,error:"Failed to list phone numbers from Telnyx"};let e=(Array.isArray(d.data)?d.data:[d.data]).find(d=>d.phone_number===c||d.phone_number===a||d.phone_number?.replace(/\D/g,"")===b);if(!e)return{success:!1,error:`Phone number ${a} not found in Telnyx account`};return{success:!0,phoneNumberId:e.id}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to find phone number"}}}async function p(a){let b={exists:!1,hasMessagingProfile:!1,hasConnection:!1,capabilities:{sms:!1,voice:!1,mms:!1},needsFix:!1,issues:[]};try{let c=await o(a);if(!c.success||!c.phoneNumberId)return b.issues.push(c.error||"Phone number not found in Telnyx"),b.needsFix=!0,b;b.exists=!0;let d=await (0,n.getNumberDetails)(c.phoneNumberId);if(!d.success||!d.data)return b.issues.push("Failed to retrieve phone number details"),b.needsFix=!0,b;let e=d.data;e.messaging_profile_id?b.hasMessagingProfile=!0:(b.issues.push("Phone number is not associated with a messaging profile"),b.needsFix=!0),e.connection_id?b.hasConnection=!0:(b.issues.push("Phone number is not associated with a connection"),b.needsFix=!0);let f=e.features||[],g=f.includes("sms"),h=f.includes("voice"),i=f.includes("mms"),j=!1;try{let a=process.env.TELNYX_API_KEY;if(a){let b=await fetch(`https://api.telnyx.com/v2/phone_numbers/${c.phoneNumberId}/messaging`,{headers:{Authorization:`Bearer ${a}`}});if(b.ok){let a=await b.json(),c=a?.data?.features;(c?.sms?.domestic_two_way||c?.mms?.domestic_two_way)&&(j=!0)}}}catch{}return b.capabilities.sms=g||j,b.capabilities.voice=h,b.capabilities.mms=i||j,b.capabilities.sms||b.issues.push("Phone number does not have SMS capability"),b.capabilities.voice||b.issues.push("Phone number does not have voice capability"),b}catch(a){return b.issues.push(a instanceof Error?a.message:"Unknown error"),b.needsFix=!0,b}}async function q(a){let b=await p(a);return b.exists?b.capabilities.sms?b.hasMessagingProfile?{hasSms:!0}:{hasSms:!1,error:"Phone number is not associated with a messaging profile"}:{hasSms:!1,error:"Phone number does not have SMS capability"}:{hasSms:!1,error:"Phone number not found in Telnyx"}}var r=a.i(361300),s=a.i(82608),t=a.i(395731);function u(a){return(0,l.formatPhoneNumber)(a)}function v(a){let b=a.replace(/\D/g,"");return 11===b.length&&b.startsWith("1")?b.slice(1,4):10===b.length?b.slice(0,3):null}let w=process.env.TELNYX_DEFAULT_MESSAGING_PROFILE_ID||process.env.NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID||"",x=["voice","sms","mms"];function y(a){let b=a.replace(/\D/g,"");return 11===b.length&&b.startsWith("1")?`+1 (${b.slice(1,4)}) ${b.slice(4,7)}-${b.slice(7)}`:10===b.length?`(${b.slice(0,3)}) ${b.slice(3,6)}-${b.slice(6)}`:a}async function z(a,b){if(!b)return null;let c=await (0,r.fetchCompanyTelnyxSettings)(a,b);if(c&&"ready"===c.status)return c;let d=await (0,r.ensureCompanyTelnyxSetup)({companyId:b,supabase:a});return d.success?d.settings??null:null}function A(a){let b=a.trim().replace(/\/+$/,"");return/^https?:\/\//i.test(b)?/^http:\/\//i.test(b)&&!B(b)?b.replace(/^http:\/\//i,"https://"):b:`https://${b}`}function B(a){let b=a.toLowerCase();return b.includes("localhost")||b.includes("127.0.0.1")||b.includes("0.0.0.0")||b.endsWith(".local")||b.includes("://local")}function C(a){if(!a)return!1;let b=a.trim();return!(!b||("1"===process.env.VERCEL&&"production"===process.env.VERCEL_ENV||"production"===process.env.DEPLOYMENT_ENV)&&B(b))}async function D(){for(let a of["http://localhost:3000",process.env.SITE_URL,"http://localhost:3000",process.env.APP_URL])if(a&&C(a))return A(a);let a=process.env.VERCEL_URL;if(a&&C(a))return A(a.startsWith("http")?a:`https://${a}`);try{let a=await (0,d.headers)(),b=a.get("origin");if(b&&C(b))return A(b);let c=a.get("host");if(c&&C(c)){let a=c.includes("localhost")?"http":"https";return A(`${a}://${c}`)}}catch{}}async function E(a){let b=await D();if(!b)return;let c=a.startsWith("/")?a:`/${a}`;return`${b}${c}`}async function F(a){return a?E(`/api/webhooks/telnyx?company=${a}`):E("/api/webhooks/telnyx")}async function G(a,b){let c=u(b),{data:d}=await a.from("phone_numbers").select("id").eq("phone_number",c).is("deleted_at",null).maybeSingle();return d?.id??null}async function H(a,b,c){if(!c)return;let d=u(c),{data:e}=await a.from("phone_numbers").select("id").eq("company_id",b).eq("phone_number",d).limit(1);e&&e.length>0||await a.from("phone_numbers").insert({company_id:b,phone_number:d,formatted_number:y(d),country_code:"US",area_code:v(d),number_type:"local",status:"active",features:x})}async function I(a,b,c,d){if(c)return u(c);let e=d?u(d):null;try{let{data:c}=await a.from("phone_numbers").select("phone_number, number_type").eq("company_id",b).eq("status","active");if(c&&c.length>0){let a=c.find(a=>"toll-free"===a.number_type);if(a)return u(a.phone_number);if(e&&c.some(a=>u(a.phone_number)===e))return e;return u(c[0].phone_number)}}catch(a){console.warn("Failed to load company phone numbers for outbound selection:",a)}return e}async function J(a,b,c){let{data:d}=await a.from("communications").select("provider_metadata").eq("id",b).maybeSingle(),e={...d?.provider_metadata??{},...c};await a.from("communications").update({provider_metadata:e}).eq("id",b)}async function K(a){try{return await (0,n.searchAvailableNumbers)({countryCode:"US",areaCode:a.areaCode,numberType:a.numberType,features:a.features,limit:a.limit||10})}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to search phone numbers"}}}async function L(a){try{let b=await j(),d=k();if(!b.valid||!d.valid){let a="Telnyx configuration is incomplete. Please configure all required environment variables.";return b.suggestedProfileId&&(a+=` Found messaging profile "${b.suggestedProfileId}" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${b.suggestedProfileId} to use it.`),{success:!1,error:a}}let f=await (0,e.createClient)();if(!f)return{success:!1,error:"Service unavailable"};let h=u(a.phoneNumber),i=y(h),l=v(h),m=await (0,n.purchaseNumber)({phoneNumber:h,connectionId:g.TELNYX_CONFIG.connectionId,messagingProfileId:w||void 0,billingGroupId:a.billingGroupId,customerReference:`company_${a.companyId}`});if(!m.success)return m;let{data:o,error:p}=await f.from("phone_numbers").insert({company_id:a.companyId,telnyx_phone_number_id:m.orderId,telnyx_connection_id:g.TELNYX_CONFIG.connectionId,phone_number:h,formatted_number:i,country_code:"US",area_code:l,number_type:"local",features:["voice","sms"],status:"pending"}).select().single();if(p)throw p;(0,c.revalidatePath)("/dashboard/settings/communications/phone-numbers");try{await (0,s.ensureMessagingCampaign)(a.companyId,{id:o.id,e164:h},{supabase:f})}catch(a){}return{success:!0,data:o}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to purchase phone number"}}}async function M(a){try{let b=await (0,e.createClient)();if(!b)return{success:!1,error:"Service unavailable"};let{data:c,error:d}=await b.from("phone_numbers").select("*").eq("company_id",a).is("deleted_at",null).order("created_at",{ascending:!1});if(d)throw d;return{success:!0,data:c||[]}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to get phone numbers"}}}async function N(a){try{let b=k();if(!b.valid)return{success:!1,error:b.error||"Call configuration is invalid"};let c=await (0,e.createClient)();if(!c)return{success:!1,error:"Service unavailable"};let d=await z(c,a.companyId);await H(c,a.companyId,d?.default_outbound_number||null);let h=d?.call_control_application_id||g.TELNYX_CONFIG.connectionId,i=await I(c,a.companyId,a.from,d?.default_outbound_number||null);if(!h)return{success:!1,error:"No Telnyx connection configured for this company."};if(!i)return{success:!1,error:"Company does not have a default outbound phone number configured. Please provision numbers first."};let j=u(a.to),l=await F(a.companyId);if(!l)return{success:!1,error:"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain."};let m=await (0,f.initiateCall)({to:j,from:i,connectionId:h,webhookUrl:l,answeringMachineDetection:"premium"});if(!m.success)return m;let n=await G(c,i),{data:o,error:p}=await c.from("communications").insert({company_id:companyId,customer_id:a.customerId,job_id:a.jobId??null,property_id:a.propertyId??null,invoice_id:a.invoiceId??null,estimate_id:a.estimateId??null,type:"phone",channel:"telnyx",direction:"outbound",from_address:i,to_address:j,body:"",status:"queued",priority:"normal",phone_number_id:n,is_archived:!1,is_automated:!1,is_internal:!1,is_thread_starter:!0,telnyx_call_control_id:m.callControlId,telnyx_call_session_id:m.callSessionId}).select().single();if(p)throw p;return{success:!0,callControlId:m.callControlId,data:o}}catch(a){return console.error("❌ makeCall error:",a),console.error("Error details:",{message:a instanceof Error?a.message:String(a),stack:a instanceof Error?a.stack:void 0}),{success:!1,error:a instanceof Error?a.message:"Failed to make call"}}}async function O(a){try{return await (0,f.startRecording)({callControlId:a,format:"mp3",channels:"single"})}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to start recording"}}}async function P(a){try{return await (0,f.stopRecording)({callControlId:a})}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to stop recording"}}}async function Q(b){try{let{transferCall:c}=await a.A(115593);return await c({callControlId:b.callControlId,to:b.to,from:b.from})}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to transfer call"}}}async function R(b){try{let{submitTranscription:c}=await a.A(408788),d=await (0,e.createClient)();if(!d)return{success:!1,error:"Service unavailable"};let f=await E("/api/webhooks/assemblyai");if(!f)return{success:!1,error:"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL."};let g=await c({audio_url:b.recordingUrl,speaker_labels:!0,webhook_url:f});if(!(g.success&&g.data))return{success:!1,error:g.error||"Failed to submit transcription"};return await J(d,b.communicationId,{assemblyai_transcription_id:g.data.id,assemblyai_status:g.data.status}),{success:!0,transcriptionId:g.data.id,status:g.data.status}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to transcribe recording"}}}async function S(b){try{let d=await (0,e.createClient)();if(!d)return console.error("❌ Supabase client unavailable"),{success:!1,error:"Service unavailable"};let f=b.companyId;if(!f){let{getActiveCompanyId:b}=await a.A(37652);if(!(f=await b()))return{success:!1,error:"No active company found"}}let g=await z(d,f);if(!g)return console.error("❌ Company settings not found"),{success:!1,error:"Unable to provision Telnyx resources for this company. Please verify the company's onboarding is complete and try again."};await H(d,f,g.default_outbound_number);let h=await j();if(!h.valid&&!g?.messaging_profile_id){let a=h.error||"SMS configuration is invalid";return h.suggestedProfileId&&(a+=` Found messaging profile "${h.suggestedProfileId}" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${h.suggestedProfileId} or provision company-specific settings.`),console.error("❌ SMS config invalid:",a),{success:!1,error:a}}let i=g?.messaging_profile_id||w;if(!i)return console.error("❌ No messaging profile ID"),{success:!1,error:"Messaging profile is not configured for this company. Please provision communications before sending SMS."};if(i){let a=await (0,m.verifyMessagingProfile)(i);if(a.needsFix)return console.error("❌ Messaging profile needs fix:",a.issues),{success:!1,error:`Messaging profile configuration issue: ${a.issues.join(", ")}. Run fixMessagingProfile() or reprovision the company.`}}let k=await I(d,f,b.from,g.default_outbound_number);if(!k)return console.error("❌ No from number available"),{success:!1,error:"Company does not have a default outbound phone number configured. Please provision numbers first."};let n=u(b.to),o=await q(k);if(!o.hasSms)return console.error("❌ SMS capability check failed:",o.error),{success:!1,error:o.error||"Phone number does not support SMS"};let p=await F(f);if(!p)return console.error("❌ No webhook URL"),{success:!1,error:"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain."};let r=await (0,l.sendSMS)({to:n,from:k,text:b.text,webhookUrl:p,messagingProfileId:i});if(!r.success){if(console.error("❌ Telnyx API failed:",r.error),!(r.error&&(r.error.includes("10DLC")||r.error.includes("Not 10DLC registered")||r.error.includes("A2P"))))return r;{let{registerCompanyFor10DLC:c}=await a.A(141196),d=await c(f);if(!d.success)return{success:!1,error:`10DLC registration failed: ${d.error}. Original error: ${r.error}`};{let a=await (0,l.sendSMS)({to:n,from:k,text:b.text,webhookUrl:p,messagingProfileId:i});if(!a.success)return{success:!1,error:`10DLC registration completed but SMS still failed: ${a.error}. The campaign may need additional approval time.`};r.success=!0,r.messageId=a.messageId}}}let s=await G(d,k),{data:t,error:v}=await d.from("communications").insert({company_id:f,customer_id:b.customerId,job_id:b.jobId??null,invoice_id:b.invoiceId??null,estimate_id:b.estimateId??null,type:"sms",channel:"telnyx",direction:"outbound",from_address:k,to_address:n,body:b.text,status:"queued",priority:"normal",phone_number_id:s,is_archived:!1,is_automated:!1,is_internal:!1,is_thread_starter:!0,telnyx_message_id:r.messageId}).select().single();if(v)throw v;return(0,c.revalidatePath)("/dashboard/communication"),{success:!0,messageId:r.messageId,data:t}}catch(a){return console.error("SMS send error:",a),console.error("Error details:",{message:a instanceof Error?a.message:String(a),stack:a instanceof Error?a.stack:void 0,type:typeof a,stringified:JSON.stringify(a,null,2)}),{success:!1,error:a instanceof Error?a.message:`Failed to send SMS: ${String(a)}`}}}async function T(b){try{let d=await (0,e.createClient)();if(!d)return{success:!1,error:"Service unavailable"};let f=b.companyId;if(!f){let{getActiveCompanyId:b}=await a.A(37652);if(!(f=await b()))return{success:!1,error:"No active company found"}}let g=await z(d,f);if(!g)return{success:!1,error:"Unable to provision Telnyx resources for this company. Please verify onboarding is complete."};await H(d,f,g.default_outbound_number);let h=await j();if(!h.valid&&!g.messaging_profile_id){let a=h.error||"SMS configuration is invalid";return h.suggestedProfileId&&(a+=` Found messaging profile "${h.suggestedProfileId}" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${h.suggestedProfileId} or reprovision the company.`),{success:!1,error:a}}let i=g.messaging_profile_id||w;if(!i)return{success:!1,error:"Messaging profile is not configured for this company. Please provision communications before sending MMS."};let k=await I(d,f,b.from,g.default_outbound_number);if(!k)return{success:!1,error:"Company does not have a default outbound phone number configured."};let n=u(b.to),o=await F(f);if(!o)return{success:!1,error:"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain."};if(i){let a=await (0,m.verifyMessagingProfile)(i);if(a.needsFix)return{success:!1,error:`Messaging profile configuration issue: ${a.issues.join(", ")}. Run fixMessagingProfile() or reprovision the company.`}}let p=await q(k);if(!p.hasSms)return{success:!1,error:p.error||"Phone number does not support SMS/MMS"};let r=await (0,l.sendMMS)({to:n,from:k,text:b.text,mediaUrls:b.mediaUrls,webhookUrl:o,messagingProfileId:i});if(!r.success)return r;let s=await G(d,k),{data:t,error:v}=await d.from("communications").insert({company_id:f,customer_id:b.customerId,job_id:b.jobId??null,property_id:b.propertyId??null,invoice_id:b.invoiceId??null,estimate_id:b.estimateId??null,type:"sms",channel:"telnyx",direction:"outbound",from_address:k,to_address:n,body:b.text||"",attachments:b.mediaUrls.map(a=>({url:a,type:"image"})),attachment_count:b.mediaUrls.length,status:"queued",priority:"normal",phone_number_id:s,is_archived:!1,is_automated:!1,is_internal:!1,is_thread_starter:!0,telnyx_message_id:r.messageId}).select().single();if(v)throw v;return(0,c.revalidatePath)("/dashboard/communication"),{success:!0,messageId:r.messageId,data:t}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to send MMS"}}}async function U(){try{let b=await (0,e.createClient)();if(!b)return{success:!1,error:"Service unavailable"};let{data:{user:c},error:d}=await b.auth.getUser();if(d||!c)return{success:!1,error:"User not authenticated"};let f=process.env.TELNYX_WEBRTC_USERNAME,g=process.env.TELNYX_WEBRTC_PASSWORD;if(f&&g){let a={username:f,password:g,expires_at:Date.now()+864e5,realm:"sip.telnyx.com",sip_uri:`sip:${f}@sip.telnyx.com`,stun_servers:["stun:stun.telnyx.com:3478","stun:stun.telnyx.com:3479"],turn_servers:[{urls:["turn:turn.telnyx.com:3478?transport=udp","turn:turn.telnyx.com:3478?transport=tcp"],username:f,credential:g}]};return{success:!0,credential:a}}let{generateWebRTCToken:h}=await a.A(877662),i=await h({username:c.email||c.id,ttl:86400});if(!i.success)return i;return{success:!0,credential:i.credential}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to get WebRTC credentials"}}}async function V(a){try{let b=await (0,e.createClient)();if(!b)return{success:!1,error:"Service unavailable"};let{data:c,error:d}=await b.from("call_routing_rules").select(`
        *,
        created_by_user:users!call_routing_rules_created_by_fkey(id, name, email),
        forward_to_user:users!call_routing_rules_forward_to_user_id_fkey(id, name, email)
      `).eq("company_id",a).is("deleted_at",null).order("priority",{ascending:!1});if(d)throw d;return{success:!0,data:c||[]}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to get call routing rules"}}}async function W(a){try{let b=await (0,e.createClient)();if(!b)return{success:!1,error:"Service unavailable"};let d={};void 0!==a.name&&(d.name=a.name),void 0!==a.description&&(d.description=a.description),void 0!==a.priority&&(d.priority=a.priority),void 0!==a.businessHours&&(d.business_hours=a.businessHours),void 0!==a.timezone&&(d.timezone=a.timezone),void 0!==a.afterHoursAction&&(d.after_hours_action=a.afterHoursAction),void 0!==a.afterHoursForwardTo&&(d.after_hours_forward_to=a.afterHoursForwardTo),void 0!==a.teamMembers&&(d.team_members=a.teamMembers),void 0!==a.ringTimeout&&(d.ring_timeout=a.ringTimeout),void 0!==a.ivrMenu&&(d.ivr_menu=a.ivrMenu),void 0!==a.ivrGreetingUrl&&(d.ivr_greeting_url=a.ivrGreetingUrl),void 0!==a.forwardToNumber&&(d.forward_to_number=a.forwardToNumber),void 0!==a.forwardToUserId&&(d.forward_to_user_id=a.forwardToUserId),void 0!==a.enableVoicemail&&(d.enable_voicemail=a.enableVoicemail),void 0!==a.voicemailGreetingUrl&&(d.voicemail_greeting_url=a.voicemailGreetingUrl),void 0!==a.voicemailTranscriptionEnabled&&(d.voicemail_transcription_enabled=a.voicemailTranscriptionEnabled),void 0!==a.voicemailEmailNotifications&&(d.voicemail_email_notifications=a.voicemailEmailNotifications),void 0!==a.recordCalls&&(d.record_calls=a.recordCalls),void 0!==a.isActive&&(d.is_active=a.isActive);let{data:f,error:g}=await b.from("call_routing_rules").update(d).eq("id",a.ruleId).select().single();if(g)throw g;return(0,c.revalidatePath)("/dashboard/settings/communications/call-routing"),{success:!0,data:f}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to update call routing rule"}}}async function X(a,b){try{let d=await (0,e.createClient)();if(!d)return{success:!1,error:"Service unavailable"};let{error:f}=await d.from("call_routing_rules").update({deleted_at:new Date().toISOString(),deleted_by:b}).eq("id",a);if(f)throw f;return(0,c.revalidatePath)("/dashboard/settings/communications/call-routing"),{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to delete call routing rule"}}}async function Y(a,b){try{let d=await (0,e.createClient)();if(!d)return{success:!1,error:"Service unavailable"};let{data:f,error:g}=await d.from("call_routing_rules").update({is_active:b}).eq("id",a).select().single();if(g)throw g;return(0,c.revalidatePath)("/dashboard/settings/communications/call-routing"),{success:!0,data:f}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to toggle call routing rule"}}}(0,t.ensureServerEntryExports)([K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y]),(0,b.registerServerReference)(K,"406864ae05b8b51c66cc2c335999e5011a41cb521f",null),(0,b.registerServerReference)(L,"40fd6a80b32792fab749933f98f07503d8e94c0305",null),(0,b.registerServerReference)(M,"4019cf9f81eb3c06f82b5c2f8eb042f3d95d91e933",null),(0,b.registerServerReference)(N,"40b2df540ec465c5dc19545c96486485bb50b5633b",null),(0,b.registerServerReference)(O,"404e47931374ad2a1b54bc11f357703790f6104530",null),(0,b.registerServerReference)(P,"40d5cc291162e2fd61245bdb851d5e8ed609e4ed19",null),(0,b.registerServerReference)(Q,"405a16958f97c37bd4b5711bd8761510bdab55839f",null),(0,b.registerServerReference)(R,"4002f454c46f4c21ca6e9e26362583ccff69c9f914",null),(0,b.registerServerReference)(S,"40d050abdabe2ee7293436c505c5f27b4408a2f27c",null),(0,b.registerServerReference)(T,"40edd91786b2a482e617fb16f2474d26ec295435e7",null),(0,b.registerServerReference)(U,"000478fbf5363dae5000d525663da13e29908cb952",null),(0,b.registerServerReference)(V,"40247c617842c31b242455a0961cbd2c3297606a16",null),(0,b.registerServerReference)(W,"40413bfa888916480edbc33ebb812158fddf960f89",null),(0,b.registerServerReference)(X,"607d0f958daf66b2a0d5277cdda17600dace5156bb",null),(0,b.registerServerReference)(Y,"60853f1e409364f7e171e27229217994ff224414e6",null),a.s(["deleteCallRoutingRule",()=>X,"getCallRoutingRules",()=>V,"getCompanyPhoneNumbers",()=>M,"getWebRTCCredentials",()=>U,"makeCall",()=>N,"purchasePhoneNumber",()=>L,"searchPhoneNumbers",()=>K,"sendMMSMessage",()=>T,"sendTextMessage",()=>S,"startCallRecording",()=>O,"stopCallRecording",()=>P,"toggleCallRoutingRule",()=>Y,"transcribeCallRecording",()=>R,"transferActiveCall",()=>Q,"updateCallRoutingRule",()=>W],336176)}];

//# sourceMappingURL=apps_web_src_actions_9afc6b06._.js.map