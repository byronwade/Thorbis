{"version":3,"sources":["../../../../../../packages/auth/src/permissions.ts","../../../../../../apps/web/src/lib/auth/permissions.ts","../../../../../../apps/web/src/actions/roles.ts","../../../../../../apps/web/src/lib/email/pre-send-checks.ts"],"sourcesContent":["/**\n * Permission System - Server-Side Utilities\n *\n * Provides type-safe permission checking for role-based access control (RBAC).\n * Uses database functions for secure, centralized permission logic.\n *\n * Performance optimizations:\n * - Database functions are cached by Postgres\n * - Single query permission checks\n * - Prepared statements for security\n *\n * @example\n * ```typescript\n * // Check if user can delete jobs\n * const canDelete = await hasPermission(supabase, userId, \"delete_jobs\", companyId);\n *\n * // Check if user has manager role\n * const isManager = await hasRole(supabase, userId, \"manager\", companyId);\n *\n * // Get user's role\n * const role = await getUserRole(supabase, userId, companyId);\n * ```\n */\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/**\n * User roles in the system\n * Matches the user_role ENUM in database\n */\nexport type UserRole =\n\t| \"owner\"\n\t| \"admin\"\n\t| \"manager\"\n\t| \"dispatcher\"\n\t| \"technician\"\n\t| \"csr\";\n\n/**\n * Permission keys for fine-grained access control\n */\nexport type Permission =\n\t// Manager permissions\n\t| \"view_reports\"\n\t| \"manage_team\"\n\t| \"approve_estimates\"\n\t| \"handle_escalations\"\n\t// Dispatcher permissions\n\t| \"dispatch_jobs\"\n\t| \"manage_schedule\"\n\t| \"view_tech_locations\"\n\t// Technician permissions\n\t| \"update_job_status\"\n\t| \"create_invoices\"\n\t| \"upload_photos\"\n\t// CSR permissions\n\t| \"create_jobs\"\n\t| \"schedule_appointments\"\n\t| \"send_communications\"\n\t// View permissions\n\t| \"view_customers\"\n\t| \"view_jobs\"\n\t| \"view_schedule\"\n\t// Delete permissions\n\t| \"delete_jobs\"\n\t| \"delete_customers\"\n\t| \"delete_team_members\";\n\n/**\n * Role configuration with permissions and metadata\n */\nexport type RoleConfig = {\n\tid: UserRole;\n\tlabel: string;\n\tdescription: string;\n\tpermissions: Permission[];\n\tdashboardFeatures: string[];\n};\n\n// ============================================================================\n// Role Definitions\n// ============================================================================\n\n/**\n * Complete role configurations with their permissions\n * Used for UI display and permission reference\n */\nconst ROLES: Record<UserRole, RoleConfig> = {\n\towner: {\n\t\tid: \"owner\",\n\t\tlabel: \"Owner\",\n\t\tdescription:\n\t\t\t\"Full system access with focus on business financials and growth\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t\t\"delete_customers\",\n\t\t\t\"delete_team_members\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"financial-overview\",\n\t\t\t\"profit-margins\",\n\t\t\t\"cash-flow\",\n\t\t\t\"business-growth\",\n\t\t\t\"payroll-overview\",\n\t\t\t\"all-reports\",\n\t\t],\n\t},\n\tadmin: {\n\t\tid: \"admin\",\n\t\tlabel: \"Admin\",\n\t\tdescription: \"System administration and configuration\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t\t\"delete_customers\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"system-settings\",\n\t\t\t\"user-management\",\n\t\t\t\"integrations\",\n\t\t\t\"audit-logs\",\n\t\t],\n\t},\n\tmanager: {\n\t\tid: \"manager\",\n\t\tlabel: \"Manager\",\n\t\tdescription:\n\t\t\t\"Oversee team performance, customer satisfaction, and operations\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"team-performance\",\n\t\t\t\"customer-satisfaction\",\n\t\t\t\"callback-queue\",\n\t\t\t\"review-alerts\",\n\t\t\t\"kpi-tracking\",\n\t\t\t\"inventory-management\",\n\t\t],\n\t},\n\tdispatcher: {\n\t\tid: \"dispatcher\",\n\t\tlabel: \"Dispatcher\",\n\t\tdescription:\n\t\t\t\"Manage technician schedules, job assignments, and real-time operations\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"dispatch-map\",\n\t\t\t\"technician-locations\",\n\t\t\t\"unassigned-jobs\",\n\t\t\t\"emergency-queue\",\n\t\t\t\"quick-dispatch\",\n\t\t\t\"tech-status\",\n\t\t],\n\t},\n\ttechnician: {\n\t\tid: \"technician\",\n\t\tlabel: \"Technician\",\n\t\tdescription:\n\t\t\t\"View assigned jobs, update job status, and track personal performance\",\n\t\tpermissions: [\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"my-schedule\",\n\t\t\t\"active-job\",\n\t\t\t\"my-earnings\",\n\t\t\t\"my-performance\",\n\t\t\t\"parts-inventory\",\n\t\t\t\"time-tracking\",\n\t\t],\n\t},\n\tcsr: {\n\t\tid: \"csr\",\n\t\tlabel: \"Customer Service Rep\",\n\t\tdescription:\n\t\t\t\"Handle customer calls, schedule appointments, and manage customer relationships\",\n\t\tpermissions: [\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"create_invoices\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"call-queue\",\n\t\t\t\"booking-calendar\",\n\t\t\t\"customer-search\",\n\t\t\t\"follow-up-queue\",\n\t\t\t\"estimate-pipeline\",\n\t\t\t\"call-scripts\",\n\t\t],\n\t},\n};\n\n// ============================================================================\n// Permission Check Functions\n// ============================================================================\n\n/**\n * Check if user has a specific role in a company\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param role - Role to check for\n * @param companyId - Company ID\n * @returns true if user has the role\n *\n * @example\n * ```typescript\n * const isManager = await hasRole(supabase, userId, \"manager\", companyId);\n * if (!isManager) {\n *   throw new Error(\"Access denied: Manager role required\");\n * }\n * ```\n */\nexport async function hasRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\trole: UserRole,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_role\", {\n\t\tuser_uuid: userId,\n\t\trequired_role: role,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Check if user has ANY of the specified roles\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param roles - Array of roles to check\n * @param companyId - Company ID\n * @returns true if user has any of the roles\n *\n * @example\n * ```typescript\n * const canManage = await hasAnyRole(\n *   supabase,\n *   userId,\n *   [\"owner\", \"manager\", \"admin\"],\n *   companyId\n * );\n * ```\n */\nasync function hasAnyRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\troles: UserRole[],\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_any_role\", {\n\t\tuser_uuid: userId,\n\t\trequired_roles: roles,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Get user's role in a company\n *\n * @param supabase - Supabase client\n * @param userId - User ID\n * @param companyId - Company ID\n * @returns User's role or null if not found\n *\n * @example\n * ```typescript\n * const role = await getUserRole(supabase, userId, companyId);\n * console.log(`User role: ${role}`); // \"manager\"\n * ```\n */\nexport async function getUserRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tcompanyId: string,\n): Promise<UserRole | null> {\n\tconst { data, error } = await supabase.rpc(\"get_user_role\", {\n\t\tuser_uuid: userId,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn null;\n\t}\n\n\treturn data as UserRole | null;\n}\n\n/**\n * Check if user has a specific permission\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param permission - Permission key to check\n * @param companyId - Company ID\n * @returns true if user has the permission\n *\n * @example\n * ```typescript\n * const canDelete = await hasPermission(supabase, userId, \"delete_jobs\", companyId);\n * if (!canDelete) {\n *   return { error: \"You don't have permission to delete jobs\" };\n * }\n * ```\n */\nexport async function hasPermission(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tpermission: Permission,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_permission\", {\n\t\tuser_uuid: userId,\n\t\tpermission_key: permission,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Check if user is the company owner\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param companyId - Company ID\n * @returns true if user is the owner\n *\n * @example\n * ```typescript\n * const isOwner = await isCompanyOwner(supabase, userId, companyId);\n * if (!isOwner) {\n *   throw new Error(\"Only company owner can perform this action\");\n * }\n * ```\n */\nexport async function isCompanyOwner(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"is_company_owner\", {\n\t\tuser_uuid: userId,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\n/**\n * Get all permissions for a role\n *\n * @param role - Role to get permissions for\n * @returns Array of permission keys\n *\n * @example\n * ```typescript\n * const managerPerms = getRolePermissions(\"manager\");\n * console.log(managerPerms); // [\"view_reports\", \"manage_team\", ...]\n * ```\n */\nfunction getRolePermissions(role: UserRole): Permission[] {\n\treturn ROLES[role]?.permissions || [];\n}\n\n/**\n * Check if a role has a specific permission (client-side check only)\n *\n * @param role - Role to check\n * @param permission - Permission to check for\n * @returns true if role has the permission\n *\n * @example\n * ```typescript\n * const canDelete = roleHasPermission(\"manager\", \"delete_jobs\");\n * ```\n */\nfunction roleHasPermission(\n\trole: UserRole,\n\tpermission: Permission,\n): boolean {\n\treturn ROLES[role]?.permissions.includes(permission);\n}\n\n/**\n * Get role configuration\n *\n * @param role - Role to get config for\n * @returns Role configuration\n *\n * @example\n * ```typescript\n * const config = getRoleConfig(\"manager\");\n * console.log(config.label); // \"Manager\"\n * ```\n */\nfunction getRoleConfig(role: UserRole): RoleConfig {\n\treturn ROLES[role];\n}\n","// Re-export from @stratos/auth package for backwards compatibility\nexport * from \"@stratos/auth/permissions\";\n","/**\n * Role Actions - Server Actions\n *\n * Server-side actions for role management and permission checks.\n * Uses Supabase RLS and database functions for security.\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport {\n\tgetUserRole,\n\thasPermission,\n\thasRole,\n\tisCompanyOwner,\n\ttype Permission,\n\ttype UserRole,\n} from \"@/lib/auth/permissions\";\nimport { withErrorHandling } from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// ============================================================================\n// Validation Schemas\n// ============================================================================\n\nconst updateRoleSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tnewRole: z.enum([\n\t\t\"owner\",\n\t\t\"admin\",\n\t\t\"manager\",\n\t\t\"dispatcher\",\n\t\t\"technician\",\n\t\t\"csr\",\n\t]),\n\treason: z.string().optional(),\n});\n\nconst updatePermissionsSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tpermissions: z.record(z.string(), z.boolean()),\n});\n\n// ============================================================================\n// Query Actions\n// ============================================================================\n\n/**\n * Get current user's role in active company\n *\n * @returns User's role or null\n *\n * @example\n * ```typescript\n * const role = await getCurrentUserRole();\n * if (role.success && role.data === \"manager\") {\n *   // Show manager dashboard\n * }\n * ```\n */\nexport async function getCurrentUserRole() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst role = await getUserRole(supabase, user.id, companyId);\n\n\t\treturn role;\n\t});\n}\n\n/**\n * Check if current user has a specific permission\n *\n * @param permission - Permission to check\n * @returns true if user has permission\n *\n * @example\n * ```typescript\n * const result = await checkPermission(\"delete_jobs\");\n * if (!result.success || !result.data) {\n *   return { error: \"Access denied\" };\n * }\n * ```\n */\nasync function checkPermission(permission: Permission) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasPerm = await hasPermission(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t\tpermission,\n\t\t\tcompanyId,\n\t\t);\n\n\t\treturn hasPerm;\n\t});\n}\n\n/**\n * Check if current user has a specific role\n *\n * @param role - Role to check\n * @returns true if user has role\n *\n * @example\n * ```typescript\n * const result = await checkRole(\"manager\");\n * if (!result.success || !result.data) {\n *   redirect(\"/dashboard\");\n * }\n * ```\n */\nasync function checkRole(role: UserRole) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasRoleResult = await hasRole(supabase, user.id, role, companyId);\n\n\t\treturn hasRoleResult;\n\t});\n}\n\n/**\n * Check if current user is company owner\n *\n * @returns true if user is owner\n */\nasync function checkIsOwner() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\n\t\treturn isOwner;\n\t});\n}\n\n// ============================================================================\n// Mutation Actions\n// ============================================================================\n\n/**\n * Update team member's role\n * Only owners and admins can change roles\n *\n * @param input - Team member ID, new role, and optional reason\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberRole({\n *   teamMemberId: \"123...\",\n *   newRole: \"manager\",\n *   reason: \"Promoted to management\"\n * });\n * ```\n */\nasync function updateTeamMemberRole(\n\tinput: z.infer<typeof updateRoleSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updateRoleSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission - only owners and admins can change roles\n\t\tconst canManageRoles =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManageRoles) {\n\t\t\tthrow new Error(\"Only owners and admins can change roles\");\n\t\t}\n\n\t\t// Get current role for audit log\n\t\tconst { data: currentMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"role\")\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!currentMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Update role\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ role: validated.newRole })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\t// Log role change\n\t\tawait supabase.from(\"role_change_log\").insert({\n\t\t\tteam_member_id: validated.teamMemberId,\n\t\t\tchanged_by: user.id,\n\t\t\told_role: currentMember.role,\n\t\t\tnew_role: validated.newRole,\n\t\t\treason: validated.reason,\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Update team member's custom permissions\n * Only owners and admins can change permissions\n *\n * @param input - Team member ID and permissions object\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberPermissions({\n *   teamMemberId: \"123...\",\n *   permissions: {\n *     \"delete_jobs\": true,\n *     \"approve_estimates\": true\n *   }\n * });\n * ```\n */\nasync function updateTeamMemberPermissions(\n\tinput: z.infer<typeof updatePermissionsSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updatePermissionsSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission\n\t\tconst canManagePermissions =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManagePermissions) {\n\t\t\tthrow new Error(\"Only owners and admins can change permissions\");\n\t\t}\n\n\t\t// Update permissions\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ permissions: validated.permissions })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Get team members with their roles\n *\n * @returns List of team members with roles\n */\nasync function getTeamMembersWithRoles() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        users (\n          id,\n          name,\n          email,\n          avatar\n        )\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n// ============================================================================\n// Owner Protection Actions\n// ============================================================================\n\n/**\n * Transfer company ownership to another team member\n * Requires password verification and extensive validation\n *\n * @param input - Transfer details including new owner, password, and reason\n * @returns Transfer ID for audit\n *\n * @example\n * ```typescript\n * const result = await transferOwnership({\n *   newOwnerId: \"user-uuid\",\n *   password: \"current-password\",\n *   reason: \"Retiring from business\"\n * });\n * ```\n */\nasync function transferOwnership(input: {\n\tnewOwnerId: string;\n\tpassword: string;\n\treason?: string;\n\tipAddress?: string;\n\tuserAgent?: string;\n}) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Verify user is current owner\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\t\tif (!isOwner) {\n\t\t\tthrow new Error(\"Only the current owner can transfer ownership\");\n\t\t}\n\n\t\t// Verify password\n\t\tconst { error: signInError } = await supabase.auth.signInWithPassword({\n\t\t\temail: user.email || \"\",\n\t\t\tpassword: input.password,\n\t\t});\n\n\t\tif (signInError) {\n\t\t\tthrow new Error(\"Password verification failed\");\n\t\t}\n\n\t\t// Call database function to transfer ownership\n\t\tconst { data: transferId, error } = await supabase.rpc(\n\t\t\t\"transfer_company_ownership\",\n\t\t\t{\n\t\t\t\tp_company_id: companyId,\n\t\t\t\tp_current_owner_id: user.id,\n\t\t\t\tp_new_owner_id: input.newOwnerId,\n\t\t\t\tp_reason: input.reason,\n\t\t\t\tp_ip_address: input.ipAddress,\n\t\t\t\tp_user_agent: input.userAgent,\n\t\t\t},\n\t\t);\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message || \"Failed to transfer ownership\");\n\t\t}\n\n\t\t// Revalidate all relevant paths\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard\");\n\n\t\treturn transferId;\n\t});\n}\n\n/**\n * Get ownership transfer history for the company\n * Shows audit trail of all ownership changes\n *\n * @returns List of ownership transfers\n */\nasync function getOwnershipTransferHistory() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\t// Only owners and admins can view transfer history\n\t\tconst canView =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canView) {\n\t\t\tthrow new Error(\"Only owners and admins can view transfer history\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"ownership_transfers\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        previous_owner:users!ownership_transfers_previous_owner_id_fkey(id, name, email),\n        new_owner:users!ownership_transfers_new_owner_id_fkey(id, name, email),\n        initiated_by_user:users!ownership_transfers_initiated_by_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n/**\n * Check if a team member can be deleted\n * Prevents deletion of company owner\n *\n * @param teamMemberId - Team member to check\n * @returns Object with canDelete boolean and reason if not allowed\n */\nexport async function canDeleteTeamMember(teamMemberId: string) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Get team member details\n\t\tconst { data: teamMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"user_id, role\")\n\t\t\t.eq(\"id\", teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error || !teamMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Check if user is company owner\n\t\tconst { data: company } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"owner_id\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (company && company.owner_id === teamMember.user_id) {\n\t\t\treturn {\n\t\t\t\tcanDelete: false,\n\t\t\t\treason:\n\t\t\t\t\t\"Cannot delete company owner. Transfer ownership first before removing this team member.\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tcanDelete: true,\n\t\t};\n\t});\n}\n","import { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\n/**\n * Pre-Send Email Deliverability Checks\n *\n * Comprehensive checks before sending any email:\n * 1. Suppression list check (bounces, complaints, unsubscribes)\n * 2. Domain verification status\n * 3. Content spam score analysis\n * 4. Reputation check\n * 5. Rate/volume considerations for warm-up\n */\n\nexport interface PreSendCheckResult {\n\tallowed: boolean;\n\twarnings: string[];\n\terrors: string[];\n\tsuggestions: string[];\n\tspamScore?: number;\n\trecipientStatus?: {\n\t\temail: string;\n\t\tsuppressed: boolean;\n\t\treason?: string;\n\t}[];\n}\n\n// Spam trigger words and patterns\nconst SPAM_TRIGGERS = {\n\turgency: [\n\t\t\"act now\",\n\t\t\"limited time\",\n\t\t\"urgent\",\n\t\t\"immediate\",\n\t\t\"expires\",\n\t\t\"hurry\",\n\t\t\"don't miss\",\n\t\t\"last chance\",\n\t\t\"final notice\",\n\t\t\"deadline\",\n\t],\n\tmoney: [\n\t\t\"free\",\n\t\t\"$$$\",\n\t\t\"cash\",\n\t\t\"discount\",\n\t\t\"save big\",\n\t\t\"best price\",\n\t\t\"cheap\",\n\t\t\"bargain\",\n\t\t\"bonus\",\n\t\t\"prize\",\n\t\t\"winner\",\n\t\t\"congratulations\",\n\t],\n\tsuspicious: [\n\t\t\"click here\",\n\t\t\"click below\",\n\t\t\"buy now\",\n\t\t\"order now\",\n\t\t\"subscribe now\",\n\t\t\"sign up free\",\n\t\t\"no obligation\",\n\t\t\"risk free\",\n\t\t\"100% free\",\n\t\t\"act immediately\",\n\t],\n\tformatting: [\n\t\t\"ALL CAPS WORDS\",\n\t\t\"!!!\",\n\t\t\"???\",\n\t\t\"$$$\",\n\t\t\"***\",\n\t\t\"###\",\n\t],\n};\n\n// Weight multipliers for spam scoring\nconst SPAM_WEIGHTS = {\n\turgency: 2,\n\tmoney: 3,\n\tsuspicious: 4,\n\tformatting: 1.5,\n\texcessiveLinks: 5,\n\tnoUnsubscribe: 3,\n\tshortContent: 2,\n\timageHeavy: 3,\n};\n\n/**\n * Check if recipient is on suppression list (bounces, complaints, unsubscribes)\n */\nexport async function checkSuppressionList(\n\tcompanyId: string,\n\trecipientEmails: string[]\n): Promise<Map<string, { suppressed: boolean; reason?: string; suppressedAt?: string }>> {\n\tconst supabase = await createServiceSupabaseClient();\n\tconst results = new Map<string, { suppressed: boolean; reason?: string; suppressedAt?: string }>();\n\n\t// Initialize all as not suppressed\n\tfor (const email of recipientEmails) {\n\t\tresults.set(email.toLowerCase(), { suppressed: false });\n\t}\n\n\t// Check suppression list\n\tconst { data: suppressions } = await supabase\n\t\t.from(\"email_suppressions\")\n\t\t.select(\"email, reason, created_at\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.in(\"email\", recipientEmails.map((e) => e.toLowerCase()));\n\n\tif (suppressions) {\n\t\tfor (const suppression of suppressions) {\n\t\t\tresults.set(suppression.email, {\n\t\t\t\tsuppressed: true,\n\t\t\t\treason: suppression.reason,\n\t\t\t\tsuppressedAt: suppression.created_at,\n\t\t\t});\n\t\t}\n\t}\n\n\t// Also check global hard bounces (cross-company)\n\tconst { data: globalBounces } = await supabase\n\t\t.from(\"email_global_bounces\")\n\t\t.select(\"email, bounce_type, created_at\")\n\t\t.in(\"email\", recipientEmails.map((e) => e.toLowerCase()))\n\t\t.eq(\"bounce_type\", \"hard\");\n\n\tif (globalBounces) {\n\t\tfor (const bounce of globalBounces) {\n\t\t\tconst existing = results.get(bounce.email);\n\t\t\tif (!existing?.suppressed) {\n\t\t\t\tresults.set(bounce.email, {\n\t\t\t\t\tsuppressed: true,\n\t\t\t\t\treason: `Global hard bounce: ${bounce.bounce_type}`,\n\t\t\t\t\tsuppressedAt: bounce.created_at,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\treturn results;\n}\n\n/**\n * Calculate spam score for email content\n * Lower is better: 0-30 = good, 30-60 = warning, 60+ = likely spam\n */\nexport function calculateSpamScore(\n\tsubject: string,\n\thtmlContent: string,\n\ttextContent: string,\n\thasUnsubscribeLink: boolean\n): { score: number; issues: string[] } {\n\tlet score = 0;\n\tconst issues: string[] = [];\n\n\tconst fullText = `${subject} ${textContent}`.toLowerCase();\n\tconst htmlLower = htmlContent.toLowerCase();\n\n\t// Check spam trigger words\n\tfor (const [category, words] of Object.entries(SPAM_TRIGGERS)) {\n\t\tconst weight = SPAM_WEIGHTS[category as keyof typeof SPAM_WEIGHTS] || 1;\n\t\tfor (const word of words) {\n\t\t\tconst regex = new RegExp(word.toLowerCase(), \"gi\");\n\t\t\tconst matches = fullText.match(regex);\n\t\t\tif (matches) {\n\t\t\t\tscore += matches.length * weight;\n\t\t\t\tif (matches.length > 1) {\n\t\t\t\t\tissues.push(`Contains \"${word}\" ${matches.length} times`);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Check for ALL CAPS in subject\n\tconst capsWords = subject.split(\" \").filter((w) => w.length > 3 && w === w.toUpperCase());\n\tif (capsWords.length > 0) {\n\t\tscore += capsWords.length * 3;\n\t\tissues.push(`Subject contains ${capsWords.length} ALL CAPS words`);\n\t}\n\n\t// Check excessive punctuation\n\tconst exclamations = (subject.match(/!/g) || []).length;\n\tif (exclamations > 1) {\n\t\tscore += exclamations * 2;\n\t\tissues.push(`Excessive exclamation marks in subject (${exclamations})`);\n\t}\n\n\t// Check link density\n\tconst links = (htmlLower.match(/<a\\s/gi) || []).length;\n\tconst wordCount = textContent.split(/\\s+/).length;\n\tif (wordCount > 0 && links / wordCount > 0.1) {\n\t\tscore += SPAM_WEIGHTS.excessiveLinks;\n\t\tissues.push(`High link density (${links} links in ${wordCount} words)`);\n\t}\n\n\t// Check image-to-text ratio\n\tconst images = (htmlLower.match(/<img\\s/gi) || []).length;\n\tif (images > 0 && textContent.length < 200) {\n\t\tscore += SPAM_WEIGHTS.imageHeavy;\n\t\tissues.push(\"Image-heavy email with little text\");\n\t}\n\n\t// Check for unsubscribe link\n\tif (!hasUnsubscribeLink) {\n\t\tscore += SPAM_WEIGHTS.noUnsubscribe;\n\t\tissues.push(\"Missing unsubscribe link (required for marketing emails)\");\n\t}\n\n\t// Check content length (very short emails look suspicious)\n\tif (textContent.length < 50) {\n\t\tscore += SPAM_WEIGHTS.shortContent;\n\t\tissues.push(\"Very short email content\");\n\t}\n\n\t// Check for suspicious patterns\n\tif (htmlLower.includes(\"display:none\") || htmlLower.includes(\"font-size:0\")) {\n\t\tscore += 10;\n\t\tissues.push(\"Contains hidden text (spam technique)\");\n\t}\n\n\t// Check for deceptive link text\n\tconst deceptiveLinkPattern = /<a[^>]*href=[\"']([^\"']+)[\"'][^>]*>([^<]+)<\\/a>/gi;\n\tlet match;\n\twhile ((match = deceptiveLinkPattern.exec(htmlContent)) !== null) {\n\t\tconst href = match[1].toLowerCase();\n\t\tconst text = match[2].toLowerCase();\n\t\tif (\n\t\t\ttext.includes(\"click here\") ||\n\t\t\ttext.includes(\"click this\") ||\n\t\t\t(text.startsWith(\"http\") && !text.includes(new URL(href).hostname))\n\t\t) {\n\t\t\tscore += 5;\n\t\t\tissues.push(\"Contains deceptive or vague link text\");\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn { score: Math.min(score, 100), issues };\n}\n\n/**\n * Check domain warm-up status and recommend volume\n */\nexport async function checkDomainWarmup(\n\tdomainId: string\n): Promise<{\n\tinWarmup: boolean;\n\tdaysSinceCreation: number;\n\trecommendedDailyLimit: number;\n\tcurrentDaySent: number;\n\tsuggestions: string[];\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data: domain } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"created_at, emails_sent_today, total_emails_sent, warmup_completed\")\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (!domain) {\n\t\treturn {\n\t\t\tinWarmup: true,\n\t\t\tdaysSinceCreation: 0,\n\t\t\trecommendedDailyLimit: 10,\n\t\t\tcurrentDaySent: 0,\n\t\t\tsuggestions: [\"Domain not found\"],\n\t\t};\n\t}\n\n\tconst createdAt = new Date(domain.created_at);\n\tconst now = new Date();\n\tconst daysSinceCreation = Math.floor((now.getTime() - createdAt.getTime()) / (1000 * 60 * 60 * 24));\n\n\t// Warm-up schedule (days -> max emails per day)\n\t// Gradual increase over 4-6 weeks for best deliverability\n\tconst warmupSchedule: Record<number, number> = {\n\t\t0: 20, // Day 0-1: 20 emails\n\t\t2: 50, // Day 2-3: 50 emails\n\t\t4: 100, // Day 4-6: 100 emails\n\t\t7: 200, // Week 2: 200 emails\n\t\t14: 500, // Week 3: 500 emails\n\t\t21: 1000, // Week 4: 1000 emails\n\t\t28: 2500, // Week 5: 2500 emails\n\t\t35: 5000, // Week 6: 5000 emails\n\t\t42: 10000, // Week 7+: 10000 emails\n\t};\n\n\tlet recommendedLimit = 20;\n\tfor (const [day, limit] of Object.entries(warmupSchedule)) {\n\t\tif (daysSinceCreation >= parseInt(day)) {\n\t\t\trecommendedLimit = limit;\n\t\t}\n\t}\n\n\tconst inWarmup = daysSinceCreation < 42 && !domain.warmup_completed;\n\tconst suggestions: string[] = [];\n\n\tif (inWarmup) {\n\t\tsuggestions.push(\n\t\t\t`Domain is in warm-up period (day ${daysSinceCreation}/42). Recommended daily limit: ${recommendedLimit} emails.`\n\t\t);\n\n\t\tif (domain.emails_sent_today >= recommendedLimit * 0.8) {\n\t\t\tsuggestions.push(\n\t\t\t\t\"Approaching daily warm-up limit. Consider spreading sends across multiple days.\"\n\t\t\t);\n\t\t}\n\t}\n\n\treturn {\n\t\tinWarmup,\n\t\tdaysSinceCreation,\n\t\trecommendedDailyLimit: recommendedLimit,\n\t\tcurrentDaySent: domain.emails_sent_today || 0,\n\t\tsuggestions,\n\t};\n}\n\n/**\n * Verify domain is properly configured for sending\n */\nexport async function verifyDomainStatus(\n\tdomainId: string\n): Promise<{\n\tcanSend: boolean;\n\tissues: string[];\n\tdnsStatus: {\n\t\tspf: boolean;\n\t\tdkim: boolean;\n\t\tdmarc: boolean;\n\t};\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data: domain } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"status, is_suspended, sending_enabled, spf_verified, dkim_verified, dmarc_verified\")\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (!domain) {\n\t\treturn {\n\t\t\tcanSend: false,\n\t\t\tissues: [\"Domain not found\"],\n\t\t\tdnsStatus: { spf: false, dkim: false, dmarc: false },\n\t\t};\n\t}\n\n\tconst issues: string[] = [];\n\n\tif (domain.status !== \"verified\") {\n\t\tissues.push(`Domain not verified (status: ${domain.status})`);\n\t}\n\n\tif (domain.is_suspended) {\n\t\tissues.push(\"Domain is suspended\");\n\t}\n\n\tif (!domain.sending_enabled) {\n\t\tissues.push(\"Sending is disabled for this domain\");\n\t}\n\n\tif (!domain.spf_verified) {\n\t\tissues.push(\"SPF record not verified - emails may fail authentication\");\n\t}\n\n\tif (!domain.dkim_verified) {\n\t\tissues.push(\"DKIM not verified - emails may fail authentication\");\n\t}\n\n\tif (!domain.dmarc_verified) {\n\t\tissues.push(\"DMARC not configured - reduces deliverability\");\n\t}\n\n\treturn {\n\t\tcanSend: issues.length === 0,\n\t\tissues,\n\t\tdnsStatus: {\n\t\t\tspf: domain.spf_verified || false,\n\t\t\tdkim: domain.dkim_verified || false,\n\t\t\tdmarc: domain.dmarc_verified || false,\n\t\t},\n\t};\n}\n\n/**\n * Comprehensive pre-send check combining all validations\n */\nexport async function runPreSendChecks(\n\tcompanyId: string,\n\tdomainId: string,\n\trecipientEmails: string[],\n\tsubject: string,\n\thtmlContent: string,\n\ttextContent: string,\n\tisMarketingEmail: boolean = false\n): Promise<PreSendCheckResult> {\n\tconst warnings: string[] = [];\n\tconst errors: string[] = [];\n\tconst suggestions: string[] = [];\n\n\t// 1. Check domain status\n\tconst domainStatus = await verifyDomainStatus(domainId);\n\tif (!domainStatus.canSend) {\n\t\terrors.push(...domainStatus.issues);\n\t} else {\n\t\t// Add warnings for missing DNS records\n\t\tif (!domainStatus.dnsStatus.dmarc) {\n\t\t\twarnings.push(\"DMARC not configured - consider adding for better deliverability\");\n\t\t}\n\t}\n\n\t// 2. Check suppression list\n\tconst suppressions = await checkSuppressionList(companyId, recipientEmails);\n\tconst recipientStatus: PreSendCheckResult[\"recipientStatus\"] = [];\n\tlet suppressedCount = 0;\n\n\tfor (const [email, status] of suppressions) {\n\t\trecipientStatus.push({\n\t\t\temail,\n\t\t\tsuppressed: status.suppressed,\n\t\t\treason: status.reason,\n\t\t});\n\t\tif (status.suppressed) {\n\t\t\tsuppressedCount++;\n\t\t}\n\t}\n\n\tif (suppressedCount > 0) {\n\t\twarnings.push(\n\t\t\t`${suppressedCount} recipient(s) on suppression list and will be skipped`\n\t\t);\n\t}\n\n\tif (suppressedCount === recipientEmails.length) {\n\t\terrors.push(\"All recipients are on suppression list - no emails will be sent\");\n\t}\n\n\t// 3. Calculate spam score\n\tconst hasUnsubscribe =\n\t\thtmlContent.includes(\"unsubscribe\") ||\n\t\thtmlContent.includes(\"List-Unsubscribe\");\n\tconst spamAnalysis = calculateSpamScore(\n\t\tsubject,\n\t\thtmlContent,\n\t\ttextContent,\n\t\thasUnsubscribe || !isMarketingEmail\n\t);\n\n\tif (spamAnalysis.score >= 60) {\n\t\terrors.push(\n\t\t\t`High spam score (${spamAnalysis.score}/100) - email likely to be filtered`\n\t\t);\n\t\terrors.push(...spamAnalysis.issues);\n\t} else if (spamAnalysis.score >= 30) {\n\t\twarnings.push(\n\t\t\t`Moderate spam score (${spamAnalysis.score}/100) - consider improvements`\n\t\t);\n\t\twarnings.push(...spamAnalysis.issues);\n\t}\n\n\t// 4. Check warm-up status\n\tconst warmupStatus = await checkDomainWarmup(domainId);\n\tif (warmupStatus.inWarmup) {\n\t\tsuggestions.push(...warmupStatus.suggestions);\n\n\t\tconst activeRecipients = recipientEmails.length - suppressedCount;\n\t\tconst remainingCapacity =\n\t\t\twarmupStatus.recommendedDailyLimit - warmupStatus.currentDaySent;\n\n\t\tif (activeRecipients > remainingCapacity) {\n\t\t\twarnings.push(\n\t\t\t\t`Sending ${activeRecipients} emails exceeds warm-up limit (${remainingCapacity} remaining today). ` +\n\t\t\t\t\t`Consider sending over multiple days.`\n\t\t\t);\n\t\t}\n\t}\n\n\t// 5. Content-specific suggestions\n\tif (!htmlContent.includes(\"<!DOCTYPE\") && !htmlContent.includes(\"<html\")) {\n\t\tsuggestions.push(\n\t\t\t\"Consider using proper HTML structure with DOCTYPE for better rendering\"\n\t\t);\n\t}\n\n\tif (textContent.length < 100) {\n\t\tsuggestions.push(\n\t\t\t\"Consider adding more text content - very short emails may look suspicious\"\n\t\t);\n\t}\n\n\tif (isMarketingEmail && !hasUnsubscribe) {\n\t\terrors.push(\n\t\t\t\"Marketing emails MUST include an unsubscribe link (CAN-SPAM requirement)\"\n\t\t);\n\t}\n\n\t// Check for personalization\n\tif (\n\t\t!htmlContent.includes(\"{{\") &&\n\t\t!htmlContent.includes(\"{name}\") &&\n\t\t!subject.includes(\"{{\")\n\t) {\n\t\tsuggestions.push(\n\t\t\t\"Consider adding personalization (recipient name, company) for better engagement\"\n\t\t);\n\t}\n\n\treturn {\n\t\tallowed: errors.length === 0,\n\t\twarnings,\n\t\terrors,\n\t\tsuggestions,\n\t\tspamScore: spamAnalysis.score,\n\t\trecipientStatus,\n\t};\n}\n\n/**\n * Add email to suppression list\n */\nexport async function addToSuppressionList(\n\tcompanyId: string,\n\temail: string,\n\treason: \"bounce\" | \"complaint\" | \"unsubscribe\" | \"manual\",\n\tdetails?: string\n): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase.from(\"email_suppressions\").upsert(\n\t\t{\n\t\t\tcompany_id: companyId,\n\t\t\temail: email.toLowerCase(),\n\t\t\treason,\n\t\t\tdetails,\n\t\t\tcreated_at: new Date().toISOString(),\n\t\t},\n\t\t{\n\t\t\tonConflict: \"company_id,email\",\n\t\t}\n\t);\n\n\tif (error) {\n\t\tconsole.error(\"Error adding to suppression list:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Add email to global bounce list (cross-company hard bounces)\n */\nexport async function addToGlobalBounceList(\n\temail: string,\n\tbounceType: \"hard\" | \"soft\",\n\tbounceReason?: string\n): Promise<{ success: boolean; error?: string }> {\n\t// Only track hard bounces globally\n\tif (bounceType !== \"hard\") {\n\t\treturn { success: true };\n\t}\n\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase.from(\"email_global_bounces\").upsert(\n\t\t{\n\t\t\temail: email.toLowerCase(),\n\t\t\tbounce_type: bounceType,\n\t\t\tbounce_reason: bounceReason,\n\t\t\tbounce_count: 1,\n\t\t\tlast_bounce_at: new Date().toISOString(),\n\t\t\tcreated_at: new Date().toISOString(),\n\t\t},\n\t\t{\n\t\t\tonConflict: \"email\",\n\t\t}\n\t);\n\n\tif (error) {\n\t\tconsole.error(\"Error adding to global bounce list:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Remove email from suppression list (for manual review cases)\n */\nexport async function removeFromSuppressionList(\n\tcompanyId: string,\n\temail: string\n): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase\n\t\t.from(\"email_suppressions\")\n\t\t.delete()\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"email\", email.toLowerCase());\n\n\tif (error) {\n\t\tconsole.error(\"Error removing from suppression list:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Get suppression list for a company\n */\nexport async function getSuppressionList(\n\tcompanyId: string,\n\tlimit: number = 100,\n\toffset: number = 0\n): Promise<{\n\tdata: Array<{\n\t\temail: string;\n\t\treason: string;\n\t\tdetails?: string;\n\t\tcreated_at: string;\n\t}>;\n\ttotal: number;\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data, count, error } = await supabase\n\t\t.from(\"email_suppressions\")\n\t\t.select(\"email, reason, details, created_at\", { count: \"exact\" })\n\t\t.eq(\"company_id\", companyId)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.range(offset, offset + limit - 1);\n\n\tif (error) {\n\t\tconsole.error(\"Error fetching suppression list:\", error);\n\t\treturn { data: [], total: 0 };\n\t}\n\n\treturn { data: data || [], total: count || 0 };\n}\n"],"names":[],"mappings":"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"}