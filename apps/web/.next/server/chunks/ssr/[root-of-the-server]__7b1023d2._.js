module.exports=[311487,a=>{"use strict";async function b(a,b,c,d){let{data:e,error:f}=await a.rpc("has_role",{user_uuid:b,required_role:c,company_uuid:d});return!f&&!0===e}async function c(a,b,c){let{data:d,error:e}=await a.rpc("get_user_role",{user_uuid:b,company_uuid:c});return e?null:d}async function d(a,b,c,d){let{data:e,error:f}=await a.rpc("has_permission",{user_uuid:b,permission_key:c,company_uuid:d});return!f&&!0===e}async function e(a,b,c){let{data:d,error:e}=await a.rpc("is_company_owner",{user_uuid:b,company_uuid:c});return!e&&!0===d}a.s(["getUserRole",()=>c,"hasPermission",()=>d,"hasRole",()=>b,"isCompanyOwner",()=>e])},997053,a=>{"use strict";a.i(311487),a.s([])},288344,a=>{"use strict";var b=a.i(780195);a.i(218188);var c=a.i(146057);a.i(467361);var d=a.i(445074);a.i(997053);var e=a.i(311487),f=a.i(974406),g=a.i(136874),h=a.i(395731);async function i(){return(0,f.withErrorHandling)(async()=>{let a=await (0,g.createClient)();if(!a)throw Error("Database connection not available");let{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Not authenticated");let c=await (0,d.getActiveCompanyId)();if(!c)throw Error("No active company");return await (0,e.getUserRole)(a,b.id,c)})}async function j(a){return(0,f.withErrorHandling)(async()=>{let b=await (0,g.createClient)();if(!b)throw Error("Database connection not available");let c=await (0,d.getActiveCompanyId)();if(!c)throw Error("No active company");let{data:e,error:f}=await b.from("company_memberships").select("user_id, role").eq("id",a).eq("company_id",c).single();if(f||!e)throw Error("Team member not found");let{data:h}=await b.from("companies").select("owner_id").eq("id",c).single();return h&&h.owner_id===e.user_id?{canDelete:!1,reason:"Cannot delete company owner. Transfer ownership first before removing this team member."}:{canDelete:!0}})}c.z.object({teamMemberId:c.z.string().uuid(),newRole:c.z.enum(["owner","admin","manager","dispatcher","technician","csr"]),reason:c.z.string().optional()}),c.z.object({teamMemberId:c.z.string().uuid(),permissions:c.z.record(c.z.string(),c.z.boolean())}),(0,h.ensureServerEntryExports)([i,j]),(0,b.registerServerReference)(i,"001f005176797ef23488068124fb9a744915a477de",null),(0,b.registerServerReference)(j,"406f6624261c6dd1a908026fa1408a3f6d507b6e7d",null),a.s(["canDeleteTeamMember",()=>j,"getCurrentUserRole",()=>i])},254799,(a,b,c)=>{b.exports=a.x("crypto",()=>require("crypto"))},666680,(a,b,c)=>{b.exports=a.x("node:crypto",()=>require("node:crypto"))},81111,(a,b,c)=>{b.exports=a.x("node:stream",()=>require("node:stream"))},575202,a=>a.a(async(b,c)=>{try{let b=await a.y("prettier/plugins/html");a.n(b),c()}catch(a){c(a)}},!0),535167,a=>a.a(async(b,c)=>{try{let b=await a.y("prettier/standalone");a.n(b),c()}catch(a){c(a)}},!0),343860,a=>{"use strict";var b=a.i(933427);let c={urgency:["act now","limited time","urgent","immediate","expires","hurry","don't miss","last chance","final notice","deadline"],money:["free","$$$","cash","discount","save big","best price","cheap","bargain","bonus","prize","winner","congratulations"],suspicious:["click here","click below","buy now","order now","subscribe now","sign up free","no obligation","risk free","100% free","act immediately"],formatting:["ALL CAPS WORDS","!!!","???","$$$","***","###"]},d={urgency:2,money:3,suspicious:4,formatting:1.5,excessiveLinks:5,noUnsubscribe:3,shortContent:2,imageHeavy:3};async function e(a,c){let d=await (0,b.createServiceSupabaseClient)(),e=new Map;for(let a of c)e.set(a.toLowerCase(),{suppressed:!1});let{data:f}=await d.from("email_suppressions").select("email, reason, created_at").eq("company_id",a).in("email",c.map(a=>a.toLowerCase()));if(f)for(let a of f)e.set(a.email,{suppressed:!0,reason:a.reason,suppressedAt:a.created_at});let{data:g}=await d.from("email_global_bounces").select("email, bounce_type, created_at").in("email",c.map(a=>a.toLowerCase())).eq("bounce_type","hard");if(g)for(let a of g){let b=e.get(a.email);b?.suppressed||e.set(a.email,{suppressed:!0,reason:`Global hard bounce: ${a.bounce_type}`,suppressedAt:a.created_at})}return e}function f(a,b,e,f){let g,h=0,i=[],j=`${a} ${e}`.toLowerCase(),k=b.toLowerCase();for(let[a,b]of Object.entries(c)){let c=d[a]||1;for(let a of b){let b=RegExp(a.toLowerCase(),"gi"),d=j.match(b);d&&(h+=d.length*c,d.length>1&&i.push(`Contains "${a}" ${d.length} times`))}}let l=a.split(" ").filter(a=>a.length>3&&a===a.toUpperCase());l.length>0&&(h+=3*l.length,i.push(`Subject contains ${l.length} ALL CAPS words`));let m=(a.match(/!/g)||[]).length;m>1&&(h+=2*m,i.push(`Excessive exclamation marks in subject (${m})`));let n=(k.match(/<a\s/gi)||[]).length,o=e.split(/\s+/).length;o>0&&n/o>.1&&(h+=d.excessiveLinks,i.push(`High link density (${n} links in ${o} words)`)),(k.match(/<img\s/gi)||[]).length>0&&e.length<200&&(h+=d.imageHeavy,i.push("Image-heavy email with little text")),f||(h+=d.noUnsubscribe,i.push("Missing unsubscribe link (required for marketing emails)")),e.length<50&&(h+=d.shortContent,i.push("Very short email content")),(k.includes("display:none")||k.includes("font-size:0"))&&(h+=10,i.push("Contains hidden text (spam technique)"));let p=/<a[^>]*href=["']([^"']+)["'][^>]*>([^<]+)<\/a>/gi;for(;null!==(g=p.exec(b));){let a=g[1].toLowerCase(),b=g[2].toLowerCase();if(b.includes("click here")||b.includes("click this")||b.startsWith("http")&&!b.includes(new URL(a).hostname)){h+=5,i.push("Contains deceptive or vague link text");break}}return{score:Math.min(h,100),issues:i}}async function g(a){let c=await (0,b.createServiceSupabaseClient)(),{data:d}=await c.from("company_email_domains").select("created_at, emails_sent_today, total_emails_sent, warmup_completed").eq("id",a).single();if(!d)return{inWarmup:!0,daysSinceCreation:0,recommendedDailyLimit:10,currentDaySent:0,suggestions:["Domain not found"]};let e=new Date(d.created_at),f=Math.floor((new Date().getTime()-e.getTime())/864e5),g=20;for(let[a,b]of Object.entries({0:20,2:50,4:100,7:200,14:500,21:1e3,28:2500,35:5e3,42:1e4}))f>=parseInt(a)&&(g=b);let h=f<42&&!d.warmup_completed,i=[];return h&&(i.push(`Domain is in warm-up period (day ${f}/42). Recommended daily limit: ${g} emails.`),d.emails_sent_today>=.8*g&&i.push("Approaching daily warm-up limit. Consider spreading sends across multiple days.")),{inWarmup:h,daysSinceCreation:f,recommendedDailyLimit:g,currentDaySent:d.emails_sent_today||0,suggestions:i}}async function h(a){let c=await (0,b.createServiceSupabaseClient)(),{data:d}=await c.from("company_email_domains").select("status, is_suspended, sending_enabled, spf_verified, dkim_verified, dmarc_verified").eq("id",a).single();if(!d)return{canSend:!1,issues:["Domain not found"],dnsStatus:{spf:!1,dkim:!1,dmarc:!1}};let e=[];return"verified"!==d.status&&e.push(`Domain not verified (status: ${d.status})`),d.is_suspended&&e.push("Domain is suspended"),d.sending_enabled||e.push("Sending is disabled for this domain"),d.spf_verified||e.push("SPF record not verified - emails may fail authentication"),d.dkim_verified||e.push("DKIM not verified - emails may fail authentication"),d.dmarc_verified||e.push("DMARC not configured - reduces deliverability"),{canSend:0===e.length,issues:e,dnsStatus:{spf:d.spf_verified||!1,dkim:d.dkim_verified||!1,dmarc:d.dmarc_verified||!1}}}async function i(a,b,c,d,j,k,l=!1){let m=[],n=[],o=[],p=await h(b);p.canSend?p.dnsStatus.dmarc||m.push("DMARC not configured - consider adding for better deliverability"):n.push(...p.issues);let q=await e(a,c),r=[],s=0;for(let[a,b]of q)r.push({email:a,suppressed:b.suppressed,reason:b.reason}),b.suppressed&&s++;s>0&&m.push(`${s} recipient(s) on suppression list and will be skipped`),s===c.length&&n.push("All recipients are on suppression list - no emails will be sent");let t=j.includes("unsubscribe")||j.includes("List-Unsubscribe"),u=f(d,j,k,t||!l);u.score>=60?(n.push(`High spam score (${u.score}/100) - email likely to be filtered`),n.push(...u.issues)):u.score>=30&&(m.push(`Moderate spam score (${u.score}/100) - consider improvements`),m.push(...u.issues));let v=await g(b);if(v.inWarmup){o.push(...v.suggestions);let a=c.length-s,b=v.recommendedDailyLimit-v.currentDaySent;a>b&&m.push(`Sending ${a} emails exceeds warm-up limit (${b} remaining today). Consider sending over multiple days.`)}return j.includes("<!DOCTYPE")||j.includes("<html")||o.push("Consider using proper HTML structure with DOCTYPE for better rendering"),k.length<100&&o.push("Consider adding more text content - very short emails may look suspicious"),l&&!t&&n.push("Marketing emails MUST include an unsubscribe link (CAN-SPAM requirement)"),j.includes("{{")||j.includes("{name}")||d.includes("{{")||o.push("Consider adding personalization (recipient name, company) for better engagement"),{allowed:0===n.length,warnings:m,errors:n,suggestions:o,spamScore:u.score,recipientStatus:r}}async function j(a,c,d,e){let f=await (0,b.createServiceSupabaseClient)(),{error:g}=await f.from("email_suppressions").upsert({company_id:a,email:c.toLowerCase(),reason:d,details:e,created_at:new Date().toISOString()},{onConflict:"company_id,email"});return g?(console.error("Error adding to suppression list:",g),{success:!1,error:g.message}):{success:!0}}async function k(a,c,d){if("hard"!==c)return{success:!0};let e=await (0,b.createServiceSupabaseClient)(),{error:f}=await e.from("email_global_bounces").upsert({email:a.toLowerCase(),bounce_type:c,bounce_reason:d,bounce_count:1,last_bounce_at:new Date().toISOString(),created_at:new Date().toISOString()},{onConflict:"email"});return f?(console.error("Error adding to global bounce list:",f),{success:!1,error:f.message}):{success:!0}}async function l(a,c){let d=await (0,b.createServiceSupabaseClient)(),{error:e}=await d.from("email_suppressions").delete().eq("company_id",a).eq("email",c.toLowerCase());return e?(console.error("Error removing from suppression list:",e),{success:!1,error:e.message}):{success:!0}}async function m(a,c=100,d=0){let e=await (0,b.createServiceSupabaseClient)(),{data:f,count:g,error:h}=await e.from("email_suppressions").select("email, reason, details, created_at",{count:"exact"}).eq("company_id",a).order("created_at",{ascending:!1}).range(d,d+c-1);return h?(console.error("Error fetching suppression list:",h),{data:[],total:0}):{data:f||[],total:g||0}}a.s(["addToGlobalBounceList",()=>k,"addToSuppressionList",()=>j,"calculateSpamScore",()=>f,"checkDomainWarmup",()=>g,"checkSuppressionList",()=>e,"getSuppressionList",()=>m,"removeFromSuppressionList",()=>l,"runPreSendChecks",()=>i,"verifyDomainStatus",()=>h])}];

//# sourceMappingURL=%5Broot-of-the-server%5D__7b1023d2._.js.map