{"version":3,"sources":["../../../../../../packages/auth/src/permissions.ts","../../../../../../apps/web/src/lib/auth/permissions.ts","../../../../../../apps/web/src/actions/roles.ts","../../../../../../apps/web/.next-internal/server/app/call/page/actions.js%20%28server%20actions%20loader%29","../../../../../../apps/web/src/actions/call-customer-data.ts","../../../../../../apps/web/src/lib/telnyx/number-lookup.ts","../../../../../../apps/web/src/actions/schedule.ts"],"sourcesContent":["/**\n * Permission System - Server-Side Utilities\n *\n * Provides type-safe permission checking for role-based access control (RBAC).\n * Uses database functions for secure, centralized permission logic.\n *\n * Performance optimizations:\n * - Database functions are cached by Postgres\n * - Single query permission checks\n * - Prepared statements for security\n *\n * @example\n * ```typescript\n * // Check if user can delete jobs\n * const canDelete = await hasPermission(supabase, userId, \"delete_jobs\", companyId);\n *\n * // Check if user has manager role\n * const isManager = await hasRole(supabase, userId, \"manager\", companyId);\n *\n * // Get user's role\n * const role = await getUserRole(supabase, userId, companyId);\n * ```\n */\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/**\n * User roles in the system\n * Matches the user_role ENUM in database\n */\nexport type UserRole =\n\t| \"owner\"\n\t| \"admin\"\n\t| \"manager\"\n\t| \"dispatcher\"\n\t| \"technician\"\n\t| \"csr\";\n\n/**\n * Permission keys for fine-grained access control\n */\nexport type Permission =\n\t// Manager permissions\n\t| \"view_reports\"\n\t| \"manage_team\"\n\t| \"approve_estimates\"\n\t| \"handle_escalations\"\n\t// Dispatcher permissions\n\t| \"dispatch_jobs\"\n\t| \"manage_schedule\"\n\t| \"view_tech_locations\"\n\t// Technician permissions\n\t| \"update_job_status\"\n\t| \"create_invoices\"\n\t| \"upload_photos\"\n\t// CSR permissions\n\t| \"create_jobs\"\n\t| \"schedule_appointments\"\n\t| \"send_communications\"\n\t// View permissions\n\t| \"view_customers\"\n\t| \"view_jobs\"\n\t| \"view_schedule\"\n\t// Delete permissions\n\t| \"delete_jobs\"\n\t| \"delete_customers\"\n\t| \"delete_team_members\";\n\n/**\n * Role configuration with permissions and metadata\n */\nexport type RoleConfig = {\n\tid: UserRole;\n\tlabel: string;\n\tdescription: string;\n\tpermissions: Permission[];\n\tdashboardFeatures: string[];\n};\n\n// ============================================================================\n// Role Definitions\n// ============================================================================\n\n/**\n * Complete role configurations with their permissions\n * Used for UI display and permission reference\n */\nconst ROLES: Record<UserRole, RoleConfig> = {\n\towner: {\n\t\tid: \"owner\",\n\t\tlabel: \"Owner\",\n\t\tdescription:\n\t\t\t\"Full system access with focus on business financials and growth\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t\t\"delete_customers\",\n\t\t\t\"delete_team_members\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"financial-overview\",\n\t\t\t\"profit-margins\",\n\t\t\t\"cash-flow\",\n\t\t\t\"business-growth\",\n\t\t\t\"payroll-overview\",\n\t\t\t\"all-reports\",\n\t\t],\n\t},\n\tadmin: {\n\t\tid: \"admin\",\n\t\tlabel: \"Admin\",\n\t\tdescription: \"System administration and configuration\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t\t\"delete_customers\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"system-settings\",\n\t\t\t\"user-management\",\n\t\t\t\"integrations\",\n\t\t\t\"audit-logs\",\n\t\t],\n\t},\n\tmanager: {\n\t\tid: \"manager\",\n\t\tlabel: \"Manager\",\n\t\tdescription:\n\t\t\t\"Oversee team performance, customer satisfaction, and operations\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"team-performance\",\n\t\t\t\"customer-satisfaction\",\n\t\t\t\"callback-queue\",\n\t\t\t\"review-alerts\",\n\t\t\t\"kpi-tracking\",\n\t\t\t\"inventory-management\",\n\t\t],\n\t},\n\tdispatcher: {\n\t\tid: \"dispatcher\",\n\t\tlabel: \"Dispatcher\",\n\t\tdescription:\n\t\t\t\"Manage technician schedules, job assignments, and real-time operations\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"dispatch-map\",\n\t\t\t\"technician-locations\",\n\t\t\t\"unassigned-jobs\",\n\t\t\t\"emergency-queue\",\n\t\t\t\"quick-dispatch\",\n\t\t\t\"tech-status\",\n\t\t],\n\t},\n\ttechnician: {\n\t\tid: \"technician\",\n\t\tlabel: \"Technician\",\n\t\tdescription:\n\t\t\t\"View assigned jobs, update job status, and track personal performance\",\n\t\tpermissions: [\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"my-schedule\",\n\t\t\t\"active-job\",\n\t\t\t\"my-earnings\",\n\t\t\t\"my-performance\",\n\t\t\t\"parts-inventory\",\n\t\t\t\"time-tracking\",\n\t\t],\n\t},\n\tcsr: {\n\t\tid: \"csr\",\n\t\tlabel: \"Customer Service Rep\",\n\t\tdescription:\n\t\t\t\"Handle customer calls, schedule appointments, and manage customer relationships\",\n\t\tpermissions: [\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"create_invoices\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"call-queue\",\n\t\t\t\"booking-calendar\",\n\t\t\t\"customer-search\",\n\t\t\t\"follow-up-queue\",\n\t\t\t\"estimate-pipeline\",\n\t\t\t\"call-scripts\",\n\t\t],\n\t},\n};\n\n// ============================================================================\n// Permission Check Functions\n// ============================================================================\n\n/**\n * Check if user has a specific role in a company\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param role - Role to check for\n * @param companyId - Company ID\n * @returns true if user has the role\n *\n * @example\n * ```typescript\n * const isManager = await hasRole(supabase, userId, \"manager\", companyId);\n * if (!isManager) {\n *   throw new Error(\"Access denied: Manager role required\");\n * }\n * ```\n */\nexport async function hasRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\trole: UserRole,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_role\", {\n\t\tuser_uuid: userId,\n\t\trequired_role: role,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Check if user has ANY of the specified roles\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param roles - Array of roles to check\n * @param companyId - Company ID\n * @returns true if user has any of the roles\n *\n * @example\n * ```typescript\n * const canManage = await hasAnyRole(\n *   supabase,\n *   userId,\n *   [\"owner\", \"manager\", \"admin\"],\n *   companyId\n * );\n * ```\n */\nasync function hasAnyRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\troles: UserRole[],\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_any_role\", {\n\t\tuser_uuid: userId,\n\t\trequired_roles: roles,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Get user's role in a company\n *\n * @param supabase - Supabase client\n * @param userId - User ID\n * @param companyId - Company ID\n * @returns User's role or null if not found\n *\n * @example\n * ```typescript\n * const role = await getUserRole(supabase, userId, companyId);\n * console.log(`User role: ${role}`); // \"manager\"\n * ```\n */\nexport async function getUserRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tcompanyId: string,\n): Promise<UserRole | null> {\n\tconst { data, error } = await supabase.rpc(\"get_user_role\", {\n\t\tuser_uuid: userId,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn null;\n\t}\n\n\treturn data as UserRole | null;\n}\n\n/**\n * Check if user has a specific permission\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param permission - Permission key to check\n * @param companyId - Company ID\n * @returns true if user has the permission\n *\n * @example\n * ```typescript\n * const canDelete = await hasPermission(supabase, userId, \"delete_jobs\", companyId);\n * if (!canDelete) {\n *   return { error: \"You don't have permission to delete jobs\" };\n * }\n * ```\n */\nexport async function hasPermission(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tpermission: Permission,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_permission\", {\n\t\tuser_uuid: userId,\n\t\tpermission_key: permission,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Check if user is the company owner\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param companyId - Company ID\n * @returns true if user is the owner\n *\n * @example\n * ```typescript\n * const isOwner = await isCompanyOwner(supabase, userId, companyId);\n * if (!isOwner) {\n *   throw new Error(\"Only company owner can perform this action\");\n * }\n * ```\n */\nexport async function isCompanyOwner(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"is_company_owner\", {\n\t\tuser_uuid: userId,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\n/**\n * Get all permissions for a role\n *\n * @param role - Role to get permissions for\n * @returns Array of permission keys\n *\n * @example\n * ```typescript\n * const managerPerms = getRolePermissions(\"manager\");\n * console.log(managerPerms); // [\"view_reports\", \"manage_team\", ...]\n * ```\n */\nfunction getRolePermissions(role: UserRole): Permission[] {\n\treturn ROLES[role]?.permissions || [];\n}\n\n/**\n * Check if a role has a specific permission (client-side check only)\n *\n * @param role - Role to check\n * @param permission - Permission to check for\n * @returns true if role has the permission\n *\n * @example\n * ```typescript\n * const canDelete = roleHasPermission(\"manager\", \"delete_jobs\");\n * ```\n */\nfunction roleHasPermission(\n\trole: UserRole,\n\tpermission: Permission,\n): boolean {\n\treturn ROLES[role]?.permissions.includes(permission);\n}\n\n/**\n * Get role configuration\n *\n * @param role - Role to get config for\n * @returns Role configuration\n *\n * @example\n * ```typescript\n * const config = getRoleConfig(\"manager\");\n * console.log(config.label); // \"Manager\"\n * ```\n */\nfunction getRoleConfig(role: UserRole): RoleConfig {\n\treturn ROLES[role];\n}\n","// Re-export from @stratos/auth package for backwards compatibility\nexport * from \"@stratos/auth/permissions\";\n","/**\n * Role Actions - Server Actions\n *\n * Server-side actions for role management and permission checks.\n * Uses Supabase RLS and database functions for security.\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport {\n\tgetUserRole,\n\thasPermission,\n\thasRole,\n\tisCompanyOwner,\n\ttype Permission,\n\ttype UserRole,\n} from \"@/lib/auth/permissions\";\nimport { withErrorHandling } from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// ============================================================================\n// Validation Schemas\n// ============================================================================\n\nconst updateRoleSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tnewRole: z.enum([\n\t\t\"owner\",\n\t\t\"admin\",\n\t\t\"manager\",\n\t\t\"dispatcher\",\n\t\t\"technician\",\n\t\t\"csr\",\n\t]),\n\treason: z.string().optional(),\n});\n\nconst updatePermissionsSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tpermissions: z.record(z.string(), z.boolean()),\n});\n\n// ============================================================================\n// Query Actions\n// ============================================================================\n\n/**\n * Get current user's role in active company\n *\n * @returns User's role or null\n *\n * @example\n * ```typescript\n * const role = await getCurrentUserRole();\n * if (role.success && role.data === \"manager\") {\n *   // Show manager dashboard\n * }\n * ```\n */\nexport async function getCurrentUserRole() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst role = await getUserRole(supabase, user.id, companyId);\n\n\t\treturn role;\n\t});\n}\n\n/**\n * Check if current user has a specific permission\n *\n * @param permission - Permission to check\n * @returns true if user has permission\n *\n * @example\n * ```typescript\n * const result = await checkPermission(\"delete_jobs\");\n * if (!result.success || !result.data) {\n *   return { error: \"Access denied\" };\n * }\n * ```\n */\nasync function checkPermission(permission: Permission) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasPerm = await hasPermission(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t\tpermission,\n\t\t\tcompanyId,\n\t\t);\n\n\t\treturn hasPerm;\n\t});\n}\n\n/**\n * Check if current user has a specific role\n *\n * @param role - Role to check\n * @returns true if user has role\n *\n * @example\n * ```typescript\n * const result = await checkRole(\"manager\");\n * if (!result.success || !result.data) {\n *   redirect(\"/dashboard\");\n * }\n * ```\n */\nasync function checkRole(role: UserRole) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasRoleResult = await hasRole(supabase, user.id, role, companyId);\n\n\t\treturn hasRoleResult;\n\t});\n}\n\n/**\n * Check if current user is company owner\n *\n * @returns true if user is owner\n */\nasync function checkIsOwner() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\n\t\treturn isOwner;\n\t});\n}\n\n// ============================================================================\n// Mutation Actions\n// ============================================================================\n\n/**\n * Update team member's role\n * Only owners and admins can change roles\n *\n * @param input - Team member ID, new role, and optional reason\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberRole({\n *   teamMemberId: \"123...\",\n *   newRole: \"manager\",\n *   reason: \"Promoted to management\"\n * });\n * ```\n */\nasync function updateTeamMemberRole(\n\tinput: z.infer<typeof updateRoleSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updateRoleSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission - only owners and admins can change roles\n\t\tconst canManageRoles =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManageRoles) {\n\t\t\tthrow new Error(\"Only owners and admins can change roles\");\n\t\t}\n\n\t\t// Get current role for audit log\n\t\tconst { data: currentMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"role\")\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!currentMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Update role\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ role: validated.newRole })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\t// Log role change\n\t\tawait supabase.from(\"role_change_log\").insert({\n\t\t\tteam_member_id: validated.teamMemberId,\n\t\t\tchanged_by: user.id,\n\t\t\told_role: currentMember.role,\n\t\t\tnew_role: validated.newRole,\n\t\t\treason: validated.reason,\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Update team member's custom permissions\n * Only owners and admins can change permissions\n *\n * @param input - Team member ID and permissions object\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberPermissions({\n *   teamMemberId: \"123...\",\n *   permissions: {\n *     \"delete_jobs\": true,\n *     \"approve_estimates\": true\n *   }\n * });\n * ```\n */\nasync function updateTeamMemberPermissions(\n\tinput: z.infer<typeof updatePermissionsSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updatePermissionsSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission\n\t\tconst canManagePermissions =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManagePermissions) {\n\t\t\tthrow new Error(\"Only owners and admins can change permissions\");\n\t\t}\n\n\t\t// Update permissions\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ permissions: validated.permissions })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Get team members with their roles\n *\n * @returns List of team members with roles\n */\nasync function getTeamMembersWithRoles() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        users (\n          id,\n          name,\n          email,\n          avatar\n        )\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n// ============================================================================\n// Owner Protection Actions\n// ============================================================================\n\n/**\n * Transfer company ownership to another team member\n * Requires password verification and extensive validation\n *\n * @param input - Transfer details including new owner, password, and reason\n * @returns Transfer ID for audit\n *\n * @example\n * ```typescript\n * const result = await transferOwnership({\n *   newOwnerId: \"user-uuid\",\n *   password: \"current-password\",\n *   reason: \"Retiring from business\"\n * });\n * ```\n */\nasync function transferOwnership(input: {\n\tnewOwnerId: string;\n\tpassword: string;\n\treason?: string;\n\tipAddress?: string;\n\tuserAgent?: string;\n}) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Verify user is current owner\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\t\tif (!isOwner) {\n\t\t\tthrow new Error(\"Only the current owner can transfer ownership\");\n\t\t}\n\n\t\t// Verify password\n\t\tconst { error: signInError } = await supabase.auth.signInWithPassword({\n\t\t\temail: user.email || \"\",\n\t\t\tpassword: input.password,\n\t\t});\n\n\t\tif (signInError) {\n\t\t\tthrow new Error(\"Password verification failed\");\n\t\t}\n\n\t\t// Call database function to transfer ownership\n\t\tconst { data: transferId, error } = await supabase.rpc(\n\t\t\t\"transfer_company_ownership\",\n\t\t\t{\n\t\t\t\tp_company_id: companyId,\n\t\t\t\tp_current_owner_id: user.id,\n\t\t\t\tp_new_owner_id: input.newOwnerId,\n\t\t\t\tp_reason: input.reason,\n\t\t\t\tp_ip_address: input.ipAddress,\n\t\t\t\tp_user_agent: input.userAgent,\n\t\t\t},\n\t\t);\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message || \"Failed to transfer ownership\");\n\t\t}\n\n\t\t// Revalidate all relevant paths\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard\");\n\n\t\treturn transferId;\n\t});\n}\n\n/**\n * Get ownership transfer history for the company\n * Shows audit trail of all ownership changes\n *\n * @returns List of ownership transfers\n */\nasync function getOwnershipTransferHistory() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\t// Only owners and admins can view transfer history\n\t\tconst canView =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canView) {\n\t\t\tthrow new Error(\"Only owners and admins can view transfer history\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"ownership_transfers\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        previous_owner:users!ownership_transfers_previous_owner_id_fkey(id, name, email),\n        new_owner:users!ownership_transfers_new_owner_id_fkey(id, name, email),\n        initiated_by_user:users!ownership_transfers_initiated_by_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n/**\n * Check if a team member can be deleted\n * Prevents deletion of company owner\n *\n * @param teamMemberId - Team member to check\n * @returns Object with canDelete boolean and reason if not allowed\n */\nexport async function canDeleteTeamMember(teamMemberId: string) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Get team member details\n\t\tconst { data: teamMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"user_id, role\")\n\t\t\t.eq(\"id\", teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error || !teamMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Check if user is company owner\n\t\tconst { data: company } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"owner_id\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (company && company.owner_id === teamMember.user_id) {\n\t\t\treturn {\n\t\t\t\tcanDelete: false,\n\t\t\t\treason:\n\t\t\t\t\t\"Cannot delete company owner. Transfer ownership first before removing this team member.\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tcanDelete: true,\n\t\t};\n\t});\n}\n","export {getCurrentUserRole as '001f005176797ef23488068124fb9a744915a477de'} from 'ACTIONS_MODULE0'\nexport {canDeleteTeamMember as '406f6624261c6dd1a908026fa1408a3f6d507b6e7d'} from 'ACTIONS_MODULE0'\nexport {getCustomerCallData as '600f2001e85494de7547a5213c6143dced69476baf'} from 'ACTIONS_MODULE1'\nexport {getCustomerCallDataById as '60e51c1544e88202aee90bf80bbe297c22b52e59cc'} from 'ACTIONS_MODULE1'\nexport {getTechnicianSchedules as '60d61fe4e8976bdfeff5cf3386134c7b4b7b4f4bd0'} from 'ACTIONS_MODULE2'\n","\"use server\";\n\n/**\n * Call Customer Data Actions\n *\n * Server actions for fetching comprehensive customer data during calls.\n * Priority: Database first, Telnyx caller lookup as fallback.\n */\n\nimport { createClient } from \"@/lib/supabase/server\";\nimport { lookupCallerInfo } from \"@/lib/telnyx/number-lookup\";\nimport type { ActionResult } from \"@/types/actions\";\nimport type {\n\tCustomerCallData,\n\tCustomerStats,\n\tTelnyxEnrichmentData,\n} from \"@/types/call\";\n\ntype SupabaseServerClient = Exclude<\n\tAwaited<ReturnType<typeof createClient>>,\n\tnull\n>;\n\ntype RelatedCustomerData = {\n\tjobs: CustomerCallData[\"jobs\"];\n\tinvoices: CustomerCallData[\"invoices\"];\n\testimates: CustomerCallData[\"estimates\"];\n\tappointments: CustomerCallData[\"appointments\"];\n\tproperties: CustomerCallData[\"properties\"];\n\tequipment: CustomerCallData[\"equipment\"];\n\tcontracts: CustomerCallData[\"contracts\"];\n};\n\n/**\n * Get comprehensive customer data for call window\n *\n * @param phoneNumber - Caller's phone number\n * @param companyId - Company ID for database lookup\n * @returns CustomerCallData with all related records\n */\nexport async function getCustomerCallData(\n\tphoneNumber: string,\n\tcompanyId: string,\n): Promise<ActionResult<CustomerCallData>> {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Database connection failed\",\n\t\t\t};\n\t\t}\n\n\t\tconst typedSupabase = supabase as SupabaseServerClient;\n\n\t\t// Normalize phone number\n\t\tconst normalizedPhone = phoneNumber.replace(/\\D/g, \"\");\n\n\t\t// 1. Try database lookup first\n\t\tconst { data: customer } = await typedSupabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.or(\n\t\t\t\t`phone.eq.${phoneNumber},phone.eq.${normalizedPhone},secondary_phone.eq.${phoneNumber},secondary_phone.eq.${normalizedPhone}`,\n\t\t\t)\n\t\t\t.maybeSingle();\n\n\t\tconst isKnownCustomer = !!customer;\n\n\t\t// 2. Enrich with Telnyx data if customer is not found\n\t\tconst telnyxData = customer\n\t\t\t? undefined\n\t\t\t: await getTelnyxEnrichmentData(phoneNumber);\n\n\t\tlet source: \"database\" | \"telnyx\" | \"unknown\" = \"unknown\";\n\t\tif (customer) {\n\t\t\tsource = \"database\";\n\t\t} else if (telnyxData) {\n\t\t\tsource = \"telnyx\";\n\t\t}\n\n\t\t// 3. Fetch related data (jobs, invoices, etc.)\n\t\tconst related: RelatedCustomerData = customer\n\t\t\t? await fetchRelatedCustomerData(typedSupabase, customer.id)\n\t\t\t: getEmptyRelatedCustomerData();\n\n\t\t// 4. Calculate quick stats\n\t\tconst stats = buildCustomerStats(customer, related.jobs, related.invoices);\n\n\t\t// 5. Return comprehensive data\n\t\tconst result: CustomerCallData = {\n\t\t\tcustomer: customer ?? null,\n\t\t\tisKnownCustomer,\n\t\t\tsource,\n\t\t\tstats,\n\t\t\tjobs: related.jobs,\n\t\t\tinvoices: related.invoices,\n\t\t\testimates: related.estimates,\n\t\t\tappointments: related.appointments,\n\t\t\tproperties: related.properties,\n\t\t\tequipment: related.equipment,\n\t\t\tcontracts: related.contracts,\n\t\t\ttelnyxData,\n\t\t};\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: result,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to fetch customer data\",\n\t\t};\n\t}\n}\n\ntype TelnyxLookupPayload = {\n\tcaller_name?: string | null;\n\tcaller_type?: string | null;\n\tline_type?: string | null;\n\tcarrier?: { name?: string | null } | null;\n\tcountry_code?: string | null;\n\tnational_format?: string | null;\n};\n\nasync function getTelnyxEnrichmentData(\n\tphoneNumber: string,\n): Promise<TelnyxEnrichmentData | undefined> {\n\tconst lookupResult = await lookupCallerInfo(phoneNumber);\n\n\tif (!(lookupResult.success && lookupResult.data)) {\n\t\treturn;\n\t}\n\n\tconst data = lookupResult.data as TelnyxLookupPayload;\n\n\treturn {\n\t\tcallerName: data.caller_name || null,\n\t\tcallerType: data.caller_type || null,\n\t\tlineType: data.line_type || null,\n\t\tcarrier: data.carrier?.name || null,\n\t\tcountry: data.country_code || null,\n\t\tnationalFormat: data.national_format || null,\n\t};\n}\n\nfunction getEmptyRelatedCustomerData(): RelatedCustomerData {\n\treturn {\n\t\tjobs: [],\n\t\tinvoices: [],\n\t\testimates: [],\n\t\tappointments: [],\n\t\tproperties: [],\n\t\tequipment: [],\n\t\tcontracts: [],\n\t};\n}\n\nasync function fetchRelatedCustomerData(\n\tsupabase: SupabaseServerClient,\n\tcustomerId: string,\n): Promise<RelatedCustomerData> {\n\tconst [\n\t\tjobsResult,\n\t\tinvoicesResult,\n\t\testimatesResult,\n\t\tappointmentsResult,\n\t\tpropertiesResult,\n\t\tequipmentResult,\n\t] = await Promise.all([\n\t\t// Jobs (last 10, ordered by created date)\n\t\t// Use getJobListSelect() to get core + financial data (total_amount, paid_amount needed for call window)\n\t\tsupabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\n\t\t\t\t`\n\t\t\t\tid, job_number, title, description, status, priority, job_type,\n\t\t\t\tcreated_at, updated_at, scheduled_date,\n\t\t\t\tcustomer_id, property_id, company_id, created_by,\n\t\t\t\tfinancial:job_financial(total_amount, paid_amount, deposit_amount)\n\t\t\t`,\n\t\t\t)\n\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(10),\n\n\t\t// Invoices (unpaid first, then recent)\n\t\tsupabase\n\t\t\t.from(\"invoices\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t.order(\"status\", { ascending: true }) // unpaid first\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(10),\n\n\t\t// Estimates (pending first, then recent)\n\t\tsupabase\n\t\t\t.from(\"estimates\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"status\", { ascending: true })\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(10),\n\n\t\t// Appointments (upcoming only)\n\t\tsupabase\n\t\t\t.from(\"appointments\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        job:jobs!job_id(id, job_number, title),\n        property:properties!property_id(id, name, address)\n      `,\n\t\t\t)\n\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.gte(\"scheduled_start\", new Date().toISOString())\n\t\t\t.order(\"scheduled_start\", { ascending: true })\n\t\t\t.limit(10),\n\n\t\t// Properties\n\t\tsupabase\n\t\t\t.from(\"properties\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"primary_contact_id\", customerId)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(10),\n\n\t\t// Equipment\n\t\tsupabase\n\t\t\t.from(\"equipment\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"customer_id\", customerId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(10),\n\t]);\n\n\treturn {\n\t\tjobs: (jobsResult.data || []) as CustomerCallData[\"jobs\"],\n\t\tinvoices: (invoicesResult.data || []) as CustomerCallData[\"invoices\"],\n\t\testimates: (estimatesResult.data || []) as CustomerCallData[\"estimates\"],\n\t\tappointments: (appointmentsResult.data ||\n\t\t\t[]) as CustomerCallData[\"appointments\"],\n\t\tproperties: (propertiesResult.data || []) as CustomerCallData[\"properties\"],\n\t\tequipment: (equipmentResult.data || []) as CustomerCallData[\"equipment\"],\n\t\t// Note: Contracts table may not exist, handle gracefully\n\t\tcontracts: [] as CustomerCallData[\"contracts\"],\n\t};\n}\n\nfunction buildCustomerStats(\n\tcustomer: CustomerCallData[\"customer\"],\n\tjobs: CustomerCallData[\"jobs\"],\n\tinvoices: CustomerCallData[\"invoices\"],\n): CustomerStats {\n\tconst openInvoices = invoices.filter(\n\t\t(invoice) => invoice.status === \"unpaid\" || invoice.status === \"partial\",\n\t);\n\n\treturn {\n\t\ttotalJobs: jobs.length,\n\t\tactiveJobs: jobs.filter(\n\t\t\t(job) => job.status === \"in_progress\" || job.status === \"scheduled\",\n\t\t).length,\n\t\ttotalRevenue: customer?.total_revenue || 0,\n\t\topenInvoices: openInvoices.length,\n\t\topenInvoicesAmount: openInvoices.reduce(\n\t\t\t(sum, invoice) => sum + (invoice.total_amount || 0),\n\t\t\t0,\n\t\t),\n\t\tcustomerSince: customer?.created_at || null,\n\t};\n}\n\n/**\n * Get customer data by ID (for outbound calls where we already know the customer)\n */\nexport async function getCustomerCallDataById(\n\tcustomerId: string,\n\tcompanyId: string,\n): Promise<ActionResult<CustomerCallData>> {\n\ttry {\n\t\tconst supabase = await createClient();\n\n\t\tif (!supabase) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Database connection failed\",\n\t\t\t};\n\t\t}\n\n\t\tconst typedSupabase = supabase as SupabaseServerClient;\n\n\t\t// Get customer\n\t\tconst { data: customer, error: customerError } = await typedSupabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"id\", customerId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.single();\n\n\t\tif (customerError || !customer) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Customer not found\",\n\t\t\t};\n\t\t}\n\n\t\t// Fetch related data (same as above)\n\t\tconst related = await fetchRelatedCustomerData(typedSupabase, customer.id);\n\n\t\tconst stats = buildCustomerStats(customer, related.jobs, related.invoices);\n\n\t\tconst result: CustomerCallData = {\n\t\t\tcustomer,\n\t\t\tisKnownCustomer: true,\n\t\t\tsource: \"database\",\n\t\t\tstats,\n\t\t\tjobs: related.jobs,\n\t\t\tinvoices: related.invoices,\n\t\t\testimates: related.estimates,\n\t\t\tappointments: related.appointments,\n\t\t\tproperties: related.properties,\n\t\t\tequipment: related.equipment,\n\t\t\tcontracts: [],\n\t\t\ttelnyxData: undefined,\n\t\t};\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: result,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to fetch customer data\",\n\t\t};\n\t}\n}\n","import \"server-only\";\n\nconst TELNYX_API_BASE = \"https://api.telnyx.com/v2\";\n\ntype NumberLookupResponse = {\n\tcaller_name?: string | null;\n\tcarrier?: {\n\t\tname?: string | null;\n\t\ttype?: string | null;\n\t} | null;\n\tcountry_code?: string | null;\n\tnational_format?: string | null;\n\tsanitized_number?: string | null;\n};\n\nexport async function lookupCallerInfo(phoneNumber: string) {\n\tconst apiKey = process.env.TELNYX_API_KEY;\n\n\tif (!apiKey) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"TELNYX_API_KEY is not configured\",\n\t\t};\n\t}\n\n\ttry {\n\t\tconst response = await fetch(\n\t\t\t`${TELNYX_API_BASE}/number_lookup/${encodeURIComponent(phoneNumber)}`,\n\t\t\t{\n\t\t\t\tmethod: \"GET\",\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t\t},\n\t\t\t\tcache: \"no-store\",\n\t\t\t},\n\t\t);\n\n\t\tif (!response.ok) {\n\t\t\tconst errorPayload = await response\n\t\t\t\t.json()\n\t\t\t\t.catch(() => ({ errors: [{ detail: response.statusText }] }));\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\terrorPayload?.errors?.[0]?.detail ||\n\t\t\t\t\t`Telnyx lookup failed (${response.status})`,\n\t\t\t};\n\t\t}\n\n\t\tconst payload = (await response.json()) as { data?: NumberLookupResponse };\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: payload.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Unknown error during lookup\",\n\t\t};\n\t}\n}\n","\"use server\";\n\n/**\n * Schedule Server Actions\n *\n * Fetch real schedule data for all technicians including:\n * - All team members (not just leads)\n * - Real jobs from database\n * - Available time slots\n * - Current time tracking\n */\n\nimport { createClient } from \"@/lib/supabase/server\";\n\nexport type ScheduleAppointment = {\n\tid: string;\n\tjob_id: string;\n\tjob_number: string;\n\tcustomer_name: string;\n\tcustomer_id: string;\n\taddress: string;\n\tcity: string;\n\tstate: string;\n\tjob_type: string;\n\tscheduled_start: string;\n\tscheduled_end: string;\n\tduration_hours: number;\n\tstatus: \"scheduled\" | \"in_progress\" | \"completed\" | \"cancelled\";\n\tassigned_technicians: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tavatar_url?: string;\n\t\tis_lead: boolean;\n\t}>;\n};\n\nexport type TechnicianSchedule = {\n\tid: string;\n\tname: string;\n\temail: string;\n\tavatar_url?: string;\n\tcolor: string;\n\trole: string;\n\tappointments: ScheduleAppointment[];\n\tworking_hours: {\n\t\tstart: number; // 8 for 8 AM\n\t\tend: number; // 18 for 6 PM\n\t};\n};\n\nexport async function getTechnicianSchedules(date: Date, companyId: string) {\n\tconst supabase = await createClient();\n\n\tif (!supabase) {\n\t\treturn [];\n\t}\n\t// Get start and end of day\n\tconst startOfDay = new Date(date);\n\tstartOfDay.setHours(0, 0, 0, 0);\n\n\tconst endOfDay = new Date(date);\n\tendOfDay.setHours(23, 59, 59, 999);\n\n\t// Fetch all technicians/team members for the company\n\tconst { data: technicians, error: techError } = await supabase\n\t\t.from(\"company_memberships\")\n\t\t.select(\n\t\t\t`\n        user_id,\n        role,\n        users:user_id (\n          id,\n          email,\n          raw_user_meta_data\n        )\n      `,\n\t\t)\n\t\t.eq(\"company_id\", companyId)\n\t\t.in(\"role\", [\"technician\", \"lead_technician\", \"admin\"]);\n\n\tif (techError) {\n\t\tthrow techError;\n\t}\n\n\tif (!technicians || technicians.length === 0) {\n\t\treturn [];\n\t}\n\n\t// Fetch all jobs for the day with assigned team members\n\tconst { data: jobs, error: jobsError } = await supabase\n\t\t.from(\"jobs\")\n\t\t.select(\n\t\t\t`\n        id,\n        job_number,\n        title,\n        status,\n        scheduled_start,\n        scheduled_end,\n        company_id,\n        customer:customer_id (\n          id,\n          first_name,\n          last_name\n        ),\n        property:property_id (\n          address,\n          city,\n          state\n        ),\n        job_team_members:job_team_members (\n          user_id,\n          is_lead,\n          users:user_id (\n            id,\n            email,\n            raw_user_meta_data\n          )\n        )\n      `,\n\t\t)\n\t\t.eq(\"company_id\", companyId)\n\t\t.gte(\"scheduled_start\", startOfDay.toISOString())\n\t\t.lte(\"scheduled_start\", endOfDay.toISOString())\n\t\t.order(\"scheduled_start\");\n\n\tif (jobsError) {\n\t\tthrow jobsError;\n\t}\n\n\t// Assign colors to technicians (cycling through a palette)\n\tconst colorPalette = [\n\t\t\"bg-blue-500\",\n\t\t\"bg-green-500\",\n\t\t\"bg-purple-500\",\n\t\t\"bg-orange-500\",\n\t\t\"bg-pink-500\",\n\t\t\"bg-cyan-500\",\n\t\t\"bg-red-500\",\n\t\t\"bg-yellow-500\",\n\t\t\"bg-indigo-500\",\n\t\t\"bg-teal-500\",\n\t];\n\n\t// Build technician schedules\n\tconst schedules: TechnicianSchedule[] = technicians.map((tech, index) => {\n\t\tconst user = tech.users as any;\n\t\tconst userId = user?.id || tech.user_id;\n\t\tconst metadata = user?.raw_user_meta_data || {};\n\t\tconst fullName =\n\t\t\tmetadata.full_name ||\n\t\t\tmetadata.name ||\n\t\t\tuser?.email?.split(\"@\")[0] ||\n\t\t\t\"Unknown\";\n\n\t\t// Find all jobs assigned to this technician\n\t\tconst techJobs = (jobs || [])\n\t\t\t.filter((job: any) =>\n\t\t\t\tjob.job_team_members?.some((member: any) => member.user_id === userId),\n\t\t\t)\n\t\t\t.map((job: any) => {\n\t\t\t\tconst customer = job.customer as any;\n\t\t\t\tconst property = job.property as any;\n\t\t\t\tconst customerName = customer\n\t\t\t\t\t? `${customer.first_name || \"\"} ${customer.last_name || \"\"}`.trim() ||\n\t\t\t\t\t\t\"Unknown Customer\"\n\t\t\t\t\t: \"Unknown Customer\";\n\n\t\t\t\t// Calculate duration\n\t\t\t\tconst start = new Date(job.scheduled_start);\n\t\t\t\tconst end = new Date(job.scheduled_end);\n\t\t\t\tconst durationHours =\n\t\t\t\t\t(end.getTime() - start.getTime()) / (1000 * 60 * 60);\n\n\t\t\t\t// Get all assigned technicians for this job\n\t\t\t\tconst assignedTechs = (job.job_team_members || []).map(\n\t\t\t\t\t(member: any) => {\n\t\t\t\t\t\tconst memberUser = member.users as any;\n\t\t\t\t\t\tconst memberMetadata = memberUser?.raw_user_meta_data || {};\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tid: memberUser?.id || member.user_id,\n\t\t\t\t\t\t\tname:\n\t\t\t\t\t\t\t\tmemberMetadata.full_name ||\n\t\t\t\t\t\t\t\tmemberMetadata.name ||\n\t\t\t\t\t\t\t\tmemberUser?.email?.split(\"@\")[0] ||\n\t\t\t\t\t\t\t\t\"Unknown\",\n\t\t\t\t\t\t\tavatar_url: memberMetadata.avatar_url,\n\t\t\t\t\t\t\tis_lead: member.is_lead,\n\t\t\t\t\t\t};\n\t\t\t\t\t},\n\t\t\t\t);\n\n\t\t\t\treturn {\n\t\t\t\t\tid: job.id,\n\t\t\t\t\tjob_id: job.id,\n\t\t\t\t\tjob_number: job.job_number || \"N/A\",\n\t\t\t\t\tcustomer_name: customerName,\n\t\t\t\t\tcustomer_id: customer?.id || \"\",\n\t\t\t\t\taddress: property?.address || \"No address\",\n\t\t\t\t\tcity: property?.city || \"\",\n\t\t\t\t\tstate: property?.state || \"\",\n\t\t\t\t\tjob_type: job.title || \"Service Call\",\n\t\t\t\t\tscheduled_start: job.scheduled_start,\n\t\t\t\t\tscheduled_end: job.scheduled_end,\n\t\t\t\t\tduration_hours: Math.max(1, Math.round(durationHours * 2) / 2), // Round to nearest 0.5\n\t\t\t\t\tstatus: mapJobStatus(job.status),\n\t\t\t\t\tassigned_technicians: assignedTechs,\n\t\t\t\t};\n\t\t\t});\n\n\t\treturn {\n\t\t\tid: userId,\n\t\t\tname: fullName,\n\t\t\temail: user?.email || \"\",\n\t\t\tavatar_url: metadata.avatar_url,\n\t\t\tcolor: colorPalette[index % colorPalette.length],\n\t\t\trole: tech.role || \"technician\",\n\t\t\tappointments: techJobs,\n\t\t\tworking_hours: {\n\t\t\t\tstart: 8, // 8 AM\n\t\t\t\tend: 18, // 6 PM\n\t\t\t},\n\t\t};\n\t});\n\n\treturn schedules;\n}\n\n// Map job status to appointment status\nfunction mapJobStatus(\n\tjobStatus: string,\n): \"scheduled\" | \"in_progress\" | \"completed\" | \"cancelled\" {\n\tconst statusMap: Record<\n\t\tstring,\n\t\t\"scheduled\" | \"in_progress\" | \"completed\" | \"cancelled\"\n\t> = {\n\t\tscheduled: \"scheduled\",\n\t\tin_progress: \"in_progress\",\n\t\tactive: \"in_progress\",\n\t\tcompleted: \"completed\",\n\t\tdone: \"completed\",\n\t\tcancelled: \"cancelled\",\n\t\tcanceled: \"cancelled\",\n\t};\n\n\treturn statusMap[jobStatus?.toLowerCase()] || \"scheduled\";\n}\n"],"names":[],"mappings":"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"}