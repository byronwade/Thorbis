module.exports=[311487,a=>{"use strict";async function b(a,b,c,d){let{data:e,error:f}=await a.rpc("has_role",{user_uuid:b,required_role:c,company_uuid:d});return!f&&!0===e}async function c(a,b,c){let{data:d,error:e}=await a.rpc("get_user_role",{user_uuid:b,company_uuid:c});return e?null:d}async function d(a,b,c,d){let{data:e,error:f}=await a.rpc("has_permission",{user_uuid:b,permission_key:c,company_uuid:d});return!f&&!0===e}async function e(a,b,c){let{data:d,error:e}=await a.rpc("is_company_owner",{user_uuid:b,company_uuid:c});return!e&&!0===d}a.s(["getUserRole",()=>c,"hasPermission",()=>d,"hasRole",()=>b,"isCompanyOwner",()=>e])},997053,a=>{"use strict";a.i(311487),a.s([])},288344,a=>{"use strict";var b=a.i(780195);a.i(218188);var c=a.i(146057);a.i(467361);var d=a.i(445074);a.i(997053);var e=a.i(311487),f=a.i(974406),g=a.i(136874),h=a.i(395731);async function i(){return(0,f.withErrorHandling)(async()=>{let a=await (0,g.createClient)();if(!a)throw Error("Database connection not available");let{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Not authenticated");let c=await (0,d.getActiveCompanyId)();if(!c)throw Error("No active company");return await (0,e.getUserRole)(a,b.id,c)})}async function j(a){return(0,f.withErrorHandling)(async()=>{let b=await (0,g.createClient)();if(!b)throw Error("Database connection not available");let c=await (0,d.getActiveCompanyId)();if(!c)throw Error("No active company");let{data:e,error:f}=await b.from("company_memberships").select("user_id, role").eq("id",a).eq("company_id",c).single();if(f||!e)throw Error("Team member not found");let{data:h}=await b.from("companies").select("owner_id").eq("id",c).single();return h&&h.owner_id===e.user_id?{canDelete:!1,reason:"Cannot delete company owner. Transfer ownership first before removing this team member."}:{canDelete:!0}})}c.z.object({teamMemberId:c.z.string().uuid(),newRole:c.z.enum(["owner","admin","manager","dispatcher","technician","csr"]),reason:c.z.string().optional()}),c.z.object({teamMemberId:c.z.string().uuid(),permissions:c.z.record(c.z.string(),c.z.boolean())}),(0,h.ensureServerEntryExports)([i,j]),(0,b.registerServerReference)(i,"001f005176797ef23488068124fb9a744915a477de",null),(0,b.registerServerReference)(j,"406f6624261c6dd1a908026fa1408a3f6d507b6e7d",null),a.s(["canDeleteTeamMember",()=>j,"getCurrentUserRole",()=>i])},447480,a=>{"use strict";var b=a.i(288344),c=a.i(780195),d=a.i(218188),e=a.i(146057),f=a.i(818944),g=a.i(974406),h=a.i(136874),i=a.i(395731);let j=e.z.object({token:e.z.string().min(1,"Token is required"),firstName:e.z.string().min(1,"First name is required"),lastName:e.z.string().min(1,"Last name is required"),email:e.z.string().email("Invalid email"),phone:e.z.string().optional(),password:e.z.string().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain at least one uppercase letter").regex(/[a-z]/,"Password must contain at least one lowercase letter").regex(/[0-9]/,"Password must contain at least one number")});async function k(a){return await (0,g.withErrorHandling)(async()=>{let b=await (0,h.createClient)();if(!b)throw new f.ActionError("Database connection failed",f.ERROR_CODES.DB_CONNECTION_ERROR);let c=a.get("token"),e=a.get("firstName"),g=a.get("lastName"),i=a.get("email"),k=a.get("phone")||"",q=a.get("password"),r=a.get("photo"),s=j.parse({token:c,firstName:e,lastName:g,email:i,phone:k,password:q}),t=await l(b,s.token);var u=t,v=s.email;if(new Date(u.expires_at)<new Date)throw new f.ActionError("Invitation has expired",f.ERROR_CODES.VALIDATION_ERROR,410);if(u.email!==v)throw new f.ActionError("Email does not match invitation",f.ERROR_CODES.VALIDATION_ERROR,400);let w=await m(b,s),x=null;return r&&r.size>0&&(x=await n(b,w.id,r)),await o({supabase:b,invitation:t,userId:w.id,phone:s.phone,photoUrl:x}),await p(b,t.id),(0,d.revalidatePath)("/dashboard/settings/team"),"Invitation accepted successfully"})}async function l(a,b){let{data:c,error:d}=await a.from("team_invitations").select("*").eq("token",b).is("used_at",null).single();if(d||!c)throw new f.ActionError("Invalid or expired invitation",f.ERROR_CODES.DB_RECORD_NOT_FOUND,404);return c}async function m(a,b){let{data:c,error:d}=await a.auth.signUp({email:b.email,password:b.password,options:{data:{first_name:b.firstName,last_name:b.lastName,phone:b.phone||""}}});if(c.user)return c.user;if(d?.message?.includes("already registered")){let{data:c,error:d}=await a.auth.signInWithPassword({email:b.email,password:b.password});if(d||!c.user)throw new f.ActionError("An account with this email already exists. Please log in or reset your password.",f.ERROR_CODES.AUTH_FORBIDDEN,409);return c.user}throw new f.ActionError(d?.message||"Failed to create account",f.ERROR_CODES.AUTH_UNAUTHORIZED,500)}async function n(a,b,c){let d=`team-member-photos/${b}/${Date.now()}-${c.name}`,{error:e}=await a.storage.from("avatars").upload(d,c);if(e)return null;let{data:{publicUrl:f}}=a.storage.from("avatars").getPublicUrl(d);return f}async function o({supabase:a,invitation:b,userId:c,phone:d}){let{error:e}=await a.from("team_members").upsert({user_id:c,company_id:b.company_id,role:b.role,status:"active",phone:d||b.phone||null,email:b.email,invited_email:b.email,invited_name:`${b.first_name} ${b.last_name}`,invited_by:b.invited_by,invited_at:b.created_at,joined_at:new Date().toISOString()},{onConflict:"user_id,company_id"});if(e)throw new f.ActionError(f.ERROR_MESSAGES.operationFailed("join team"),f.ERROR_CODES.DB_QUERY_ERROR)}async function p(a,b){let{error:c}=await a.from("team_invitations").update({used_at:new Date().toISOString()}).eq("id",b);if(c)throw new f.ActionError(f.ERROR_MESSAGES.operationFailed("update invitation status"),f.ERROR_CODES.DB_QUERY_ERROR)}(0,i.ensureServerEntryExports)([k]),(0,c.registerServerReference)(k,"40b17c6e2f31505c0fb75484ff7f8b005e7bcf1c97",null),a.s([],299547),a.i(299547),a.s(["001f005176797ef23488068124fb9a744915a477de",()=>b.getCurrentUserRole,"406f6624261c6dd1a908026fa1408a3f6d507b6e7d",()=>b.canDeleteTeamMember,"40b17c6e2f31505c0fb75484ff7f8b005e7bcf1c97",()=>k],447480)},858982,a=>{a.v(b=>Promise.all(["server/chunks/ssr/3c0ae_next_4427392f._.js"].map(b=>a.l(b))).then(()=>b(857782)))}];

//# sourceMappingURL=_f79972b0._.js.map