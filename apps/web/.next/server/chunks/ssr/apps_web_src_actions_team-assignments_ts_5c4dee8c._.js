module.exports=[670078,a=>{"use strict";var b=a.i(780195),c=a.i(218188),d=a.i(146057);a.i(467361);var e=a.i(445074),f=a.i(974406),g=a.i(818944),h=a.i(136874),i=a.i(933427),j=a.i(395731);let k=d.z.object({jobId:d.z.string().uuid(),teamMemberId:d.z.string().uuid(),role:d.z.enum(["primary","assistant","crew","supervisor"]).default("crew"),notes:d.z.string().optional()}),l=d.z.object({jobId:d.z.string().uuid(),teamMemberId:d.z.string().uuid()});async function m(){return(0,f.withErrorHandling)(async()=>{let a=await (0,h.createClient)();if(!a)throw new g.ActionError("Database connection failed",g.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:b}}=await a.auth.getUser();if(!b)throw new g.ActionError("Unauthorized",g.ERROR_CODES.AUTH_UNAUTHORIZED,401);let c=await (0,e.getActiveCompanyId)();if(!c)throw new g.ActionError("No active company selected",g.ERROR_CODES.AUTH_FORBIDDEN,403);let d=await (0,i.createServiceSupabaseClient)();if(!d)throw new g.ActionError("Database connection failed",g.ERROR_CODES.DB_CONNECTION_ERROR);let{data:f,error:j}=await d.from("company_memberships").select("id, user_id, job_title, status, company_id").eq("company_id",c).eq("status","active").limit(200);if(j)throw new g.ActionError("Failed to load team members",g.ERROR_CODES.DB_QUERY_ERROR,500,{hint:j.hint,details:j.details});if(!f||0===f.length)return[];let k=f.map(a=>a.user_id).filter(Boolean),{data:l,error:m}=await d.from("profiles").select("id, email, full_name, avatar_url, phone").in("id",k);if(m)throw new g.ActionError("Failed to load user details",g.ERROR_CODES.DB_QUERY_ERROR,500,{hint:m.hint,details:m.details});let n=new Map((l||[]).map(a=>[a.id,a])),o=f.map(a=>{let b=n.get(a.user_id);return{id:a.id,userId:a.user_id,jobTitle:a.job_title,status:a.status,user:b?{id:b.id,email:b.email,firstName:b.full_name?.split(" ")[0]||null,lastName:b.full_name?.split(" ").slice(1).join(" ")||null,avatarUrl:b.avatar_url,phone:b.phone}:{id:a.user_id??a.id,email:"",firstName:null,lastName:null,avatarUrl:null,phone:null}}});return o.sort((a,b)=>{let c=[a.user.firstName,a.user.lastName].filter(Boolean).join(" ").toLowerCase(),d=[b.user.firstName,b.user.lastName].filter(Boolean).join(" ").toLowerCase();return c.localeCompare(d)}),o})}async function n(a){return(0,f.withErrorHandling)(async()=>{let b=k.parse(a),d=await (0,h.createClient)();if(!d)throw new g.ActionError("Database connection failed",g.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:f}}=await d.auth.getUser();if(!f)throw new g.ActionError("Unauthorized",g.ERROR_CODES.AUTH_UNAUTHORIZED,401);let i=await (0,e.getActiveCompanyId)();if(!i)throw new g.ActionError("No active company selected",g.ERROR_CODES.AUTH_FORBIDDEN,403);let{data:j,error:l}=await d.from("jobs").select("id").eq("id",b.jobId).eq("company_id",i).maybeSingle();if(l)throw new g.ActionError("Failed to load job",g.ERROR_CODES.DB_QUERY_ERROR,500,{hint:l.hint,details:l.details});if(!j)throw new g.ActionError("Job not found",g.ERROR_CODES.DB_RECORD_NOT_FOUND,404);let{data:m,error:n}=await d.from("company_memberships").select("id, user_id").eq("id",b.teamMemberId).eq("company_id",i).maybeSingle();if(n)throw new g.ActionError("Failed to load team member",g.ERROR_CODES.DB_QUERY_ERROR,500,{hint:n.hint,details:n.details});if(!m)throw new g.ActionError("Team member not found",g.ERROR_CODES.DB_RECORD_NOT_FOUND,404);let{data:o,error:p}=await d.from("team_members").select("id").eq("user_id",m.user_id).eq("company_id",i).maybeSingle();if(p)throw new g.ActionError("Failed to load team member record",g.ERROR_CODES.DB_QUERY_ERROR,500,{hint:p.hint,details:p.details});if(!o)throw new g.ActionError("Team member record not found. Please ensure the team member has a corresponding team_members record.",g.ERROR_CODES.DB_RECORD_NOT_FOUND,404);let q=o.id;if("primary"===b.role){let{error:a}=await d.from("job_team_assignments").update({role:"crew"}).eq("job_id",b.jobId).eq("role","primary").is("removed_at",null);if(a)throw new g.ActionError("Failed to update primary assignment",g.ERROR_CODES.DB_UPDATE_ERROR,500,{hint:a.hint,details:a.details})}let{data:r}=await d.from("job_team_assignments").select("id, removed_at").eq("job_id",b.jobId).eq("team_member_id",q).maybeSingle(),s=null,t=null,u=!!r;if(r){let a=await d.from("job_team_assignments").update({role:b.role,assigned_by:f.id,notes:b.notes||null,removed_at:null,assigned_at:new Date().toISOString()}).eq("id",r.id).select("id").single();s=a.data,t=a.error}else{let a=await d.from("job_team_assignments").insert({job_id:b.jobId,team_member_id:q,role:b.role,assigned_by:f.id,notes:b.notes||null}).select("id").single();s=a.data,t=a.error}if(t||!s)throw console.error("Assignment error details:",{error:t,teamMemberId:b.teamMemberId,jobId:b.jobId,role:b.role,existingAssignment:r}),new g.ActionError(t?.message||"Failed to assign team member",g.ERROR_CODES.DB_UPDATE_ERROR,500,{hint:t?.hint,details:t?.details,code:t?.code,message:t?.message});return(0,c.revalidatePath)("/dashboard/work"),(0,c.revalidatePath)(`/dashboard/work/jobs/${b.jobId}`),(0,c.revalidatePath)(`/dashboard/work/${b.jobId}`),{id:s.id,wasReassignment:u}})}async function o(a){return(0,f.withErrorHandling)(async()=>{let b=l.parse(a),d=await (0,h.createClient)();if(!d)throw new g.ActionError("Database connection failed",g.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:f}}=await d.auth.getUser();if(!f)throw new g.ActionError("Unauthorized",g.ERROR_CODES.AUTH_UNAUTHORIZED,401);let i=await (0,e.getActiveCompanyId)();if(!i)throw new g.ActionError("No active company selected",g.ERROR_CODES.AUTH_FORBIDDEN,403);let{data:j,error:k}=await d.from("jobs").select("id").eq("id",b.jobId).eq("company_id",i).maybeSingle();if(k)throw new g.ActionError("Failed to load job",g.ERROR_CODES.DB_QUERY_ERROR,500,{hint:k.hint,details:k.details});if(!j)throw new g.ActionError("Job not found",g.ERROR_CODES.DB_RECORD_NOT_FOUND,404);let{error:m}=await d.from("job_team_assignments").update({removed_at:new Date().toISOString(),removed_by:f.id}).eq("job_id",b.jobId).eq("team_member_id",b.teamMemberId).is("removed_at",null);if(m||!assignment)throw new g.ActionError("Failed to remove team member",g.ERROR_CODES.DB_UPDATE_ERROR,500,{hint:m.hint,details:m.details});(0,c.revalidatePath)("/dashboard/work"),(0,c.revalidatePath)(`/dashboard/work/jobs/${b.jobId}`),(0,c.revalidatePath)(`/dashboard/work/${b.jobId}`)})}d.z.object({jobId:d.z.string().uuid(),teamMemberIds:d.z.array(d.z.string().uuid()),role:d.z.enum(["primary","assistant","crew","supervisor"]).default("crew")}),(0,j.ensureServerEntryExports)([m,n,o]),(0,b.registerServerReference)(m,"0047ccac2f82e9969542d3f6672186d3cd828b7bd3",null),(0,b.registerServerReference)(n,"408f899c6c9ae9bf0d3ddd5dc5f59d9eb034eefefe",null),(0,b.registerServerReference)(o,"40bc97e60829c913eadb2dcb8c0210e5703090afdf",null),a.s(["assignTeamMemberToJob",()=>n,"getAvailableTeamMembers",()=>m,"removeTeamMemberFromJob",()=>o])}];

//# sourceMappingURL=apps_web_src_actions_team-assignments_ts_5c4dee8c._.js.map