module.exports=[54214,a=>{"use strict";var b=a.i(429969),c=a.i(136874);let d=(0,b.cache)(async(a,b=90)=>{let d=await (0,c.createClient)(),e=new Date;e.setDate(e.getDate()-b);let{data:i}=await d.from("analytics_daily_snapshots").select("snapshot_date, total_revenue, jobs_completed, emails_sent, emails_received, sms_sent, sms_received, calls_made, calls_received").eq("company_id",a).gte("snapshot_date",e.toISOString().split("T")[0]).order("snapshot_date",{ascending:!0}).limit(b);if(i&&i.length>0)return{revenue:i.map(a=>({date:a.snapshot_date,value:(a.total_revenue||0)/100})),jobs:i.map(a=>({date:a.snapshot_date,value:a.jobs_completed||0})),communications:i.map(a=>({date:a.snapshot_date,value:(a.emails_sent||0)+(a.sms_sent||0)+(a.calls_made||0),value2:(a.emails_received||0)+(a.sms_received||0)+(a.calls_received||0)}))};let[j,k,l]=await Promise.all([f(d,a,e,b),g(d,a,e,b),h(d,a,e,b)]);return{revenue:j,jobs:k,communications:l}});function e(a,b){let c=[],d=new Date(a);for(let a=0;a<b;a++)c.push(d.toISOString().split("T")[0]),d.setDate(d.getDate()+1);return c}async function f(a,b,c,d){let{data:f}=await a.from("payments").select("amount, created_at").eq("company_id",b).eq("status","completed").gte("created_at",c.toISOString()).order("created_at",{ascending:!0}).limit(1e4),g={},h=e(c,d);for(let a of h)g[a]=0;for(let a of f||[]){let b=new Date(a.created_at).toISOString().split("T")[0];void 0!==g[b]&&(g[b]+=(a.amount||0)/100)}return h.map(a=>({date:a,value:g[a]||0}))}async function g(a,b,c,d){let{data:f}=await a.from("jobs").select("created_at, status").eq("company_id",b).eq("status","completed").gte("created_at",c.toISOString()).order("created_at",{ascending:!0}).limit(1e4),g={},h=e(c,d);for(let a of h)g[a]=0;for(let a of f||[]){let b=new Date(a.created_at).toISOString().split("T")[0];void 0!==g[b]&&g[b]++}return h.map(a=>({date:a,value:g[a]||0}))}async function h(a,b,c,d){let{data:f}=await a.from("communications").select("created_at, direction").eq("company_id",b).gte("created_at",c.toISOString()).order("created_at",{ascending:!0}).limit(1e4),g={},h={},i=e(c,d);for(let a of i)g[a]=0,h[a]=0;for(let a of f||[]){let b=new Date(a.created_at).toISOString().split("T")[0];void 0!==g[b]&&("outbound"===a.direction?g[b]++:h[b]++)}return i.map(a=>({date:a,value:g[a]||0,value2:h[a]||0}))}let i=(0,b.cache)(async a=>{let b=await (0,c.createClient)(),{data:d}=await b.from("analytics_technician_metrics").select(`
			period_start,
			first_time_fix_rate,
			utilization_rate,
			average_rating,
			on_time_rate
		`).eq("company_id",a).eq("period_type","monthly").order("period_start",{ascending:!1}).limit(1).single();return{firstTimeFixRate:d?.first_time_fix_rate||null,utilizationRate:d?.utilization_rate||null,avgCustomerRating:d?.average_rating||null,onTimeRate:d?.on_time_rate||null}}),j=(0,b.cache)(async a=>{let b=await (0,c.createClient)(),{data:d}=await b.from("customers").select("churn_risk").eq("company_id",a).is("deleted_at",null),e={low:0,medium:0,high:0,churned:0,unknown:0};for(let a of d||[]){let b=a.churn_risk;b&&void 0!==e[b]?e[b]++:e.unknown++}return e}),k=(0,b.cache)(async(a,b=30)=>{let d=await (0,c.createClient)(),e=new Date;e.setDate(e.getDate()-b);let{data:f}=await d.from("estimates").select("conversion_status").eq("company_id",a).gte("created_at",e.toISOString()).is("deleted_at",null),g={total:f?.length||0,pending:0,won:0,lost:0,expired:0};for(let a of f||[]){let b=a.conversion_status;b&&void 0!==g[b]?g[b]++:g.pending++}return{...g,conversionRate:g.total>0?g.won/g.total*100:0}}),l=(0,b.cache)(async a=>{let b=await (0,c.createClient)(),{data:d}=await b.from("invoices").select("aging_bucket, balance_amount").eq("company_id",a).not("status","in",'("paid", "void", "cancelled")').is("deleted_at",null),e={current:{count:0,amount:0},"1_30":{count:0,amount:0},"31_60":{count:0,amount:0},"61_90":{count:0,amount:0},over_90:{count:0,amount:0}};for(let a of d||[]){let b=a.aging_bucket||"current";e[b]&&(e[b].count++,e[b].amount+=(a.balance_amount||0)/100)}return e}),m=(0,b.cache)(async(a,b=90)=>{let d=await (0,c.createClient)(),e=new Date,f=new Date;f.setDate(f.getDate()-b);let g=new Date(f);g.setDate(g.getDate()-b);let[h,i,j,k]=await Promise.all([d.from("payments").select("id, amount, payment_method, created_at, customer_id").eq("company_id",a).eq("status","completed").gte("created_at",f.toISOString()).lte("created_at",e.toISOString()),d.from("payments").select("amount").eq("company_id",a).eq("status","completed").gte("created_at",g.toISOString()).lt("created_at",f.toISOString()),d.from("jobs").select("id, job_type, total_revenue, customer_id, created_at").eq("company_id",a).eq("status","completed").gte("created_at",f.toISOString()).is("deleted_at",null),d.from("jobs").select(`
				customer_id,
				total_revenue,
				customers:customers!customer_id(id, display_name, first_name, last_name)
			`).eq("company_id",a).eq("status","completed").gte("created_at",f.toISOString()).is("deleted_at",null)]),l=h.data||[],m=i.data||[],n=j.data||[],o=k.data||[],p=l.reduce((a,b)=>a+(b.amount||0),0)/100,q=m.reduce((a,b)=>a+(b.amount||0),0)/100,r={};for(let a of l){let b=new Date(a.created_at).toISOString().substring(0,7);r[b]||(r[b]={revenue:0,jobCount:0}),r[b].revenue+=(a.amount||0)/100}for(let a of n){let b=new Date(a.created_at).toISOString().substring(0,7);r[b]&&r[b].jobCount++}let s={};for(let a of n){let b=a.job_type||"Other";s[b]||(s[b]={revenue:0,count:0}),s[b].revenue+=(a.total_revenue||0)/100,s[b].count++}let t={};for(let a of l){let b=a.payment_method||"Other";t[b]||(t[b]={amount:0,count:0}),t[b].amount+=(a.amount||0)/100,t[b].count++}let u={};for(let a of o){let b=a.customer_id;if(!b)continue;let c=a.customers,d=c?.display_name||[c?.first_name,c?.last_name].filter(Boolean).join(" ")||"Unknown";u[b]||(u[b]={name:d,revenue:0,jobCount:0}),u[b].revenue+=(a.total_revenue||0)/100,u[b].jobCount++}return{summary:{totalRevenue:p,previousPeriodRevenue:q,growthPercent:q>0?(p-q)/q*100:0,averageTicket:n.length>0?p/n.length:0,totalJobs:n.length,totalPayments:l.length},byMonth:Object.entries(r).map(([a,b])=>({month:a,revenue:b.revenue,jobCount:b.jobCount,avgTicket:b.jobCount>0?b.revenue/b.jobCount:0})).sort((a,b)=>a.month.localeCompare(b.month)),byJobType:Object.entries(s).map(([a,b])=>({jobType:a,revenue:b.revenue,count:b.count,percentage:p>0?b.revenue/p*100:0})).sort((a,b)=>b.revenue-a.revenue),byPaymentMethod:Object.entries(t).map(([a,b])=>({method:a,amount:b.amount,count:b.count,percentage:p>0?b.amount/p*100:0})).sort((a,b)=>b.amount-a.amount),topCustomers:Object.entries(u).map(([a,b])=>({id:a,...b})).sort((a,b)=>b.revenue-a.revenue).slice(0,10)}}),n=(0,b.cache)(async(a,b=90)=>{let d=await (0,c.createClient)(),e=new Date;e.setDate(e.getDate()-b);let{data:f}=await d.from("jobs").select(`
			id, status, job_type, actual_duration_minutes, total_revenue, is_callback,
			assigned_to, created_at,
			assigned_user:users!assigned_to(id, first_name, last_name)
		`).eq("company_id",a).gte("created_at",e.toISOString()).is("deleted_at",null),g=f||[],h=g.filter(a=>"completed"===a.status),i=h.filter(a=>!0===a.is_callback),j={};for(let a of g){let b=a.status||"unknown";j[b]=(j[b]||0)+1}let k={};for(let a of h){let b=a.assigned_to;if(!b)continue;let c=a.assigned_user,d=[c?.first_name,c?.last_name].filter(Boolean).join(" ")||"Unassigned";k[b]||(k[b]={name:d,completed:0,totalDuration:0,totalRevenue:0,firstTimeFixes:0}),k[b].completed++,k[b].totalDuration+=a.actual_duration_minutes||0,k[b].totalRevenue+=(a.total_revenue||0)/100,!a.is_callback&&k[b].firstTimeFixes++}let l={};for(let a of g){let b=a.job_type||"Other";l[b]||(l[b]={total:0,completed:0,totalDuration:0,totalRevenue:0}),l[b].total++,"completed"===a.status&&(l[b].completed++,l[b].totalDuration+=a.actual_duration_minutes||0,l[b].totalRevenue+=(a.total_revenue||0)/100)}let m={};for(let a of g){let b=function(a){let b=new Date(a),c=b.getDay(),d=b.getDate()-c;return b.setDate(d),b.toISOString().split("T")[0]}(new Date(a.created_at));m[b]||(m[b]={completed:0,scheduled:0,cancelled:0}),"completed"===a.status?m[b].completed++:"scheduled"===a.status?m[b].scheduled++:"cancelled"===a.status&&m[b].cancelled++}let n=h.length>0?h.reduce((a,b)=>a+(b.actual_duration_minutes||0),0)/h.length:0;return{summary:{totalJobs:g.length,completedJobs:h.length,completionRate:g.length>0?h.length/g.length*100:0,averageDuration:n,firstTimeFixRate:h.length>0?(h.length-i.length)/h.length*100:0,callbackRate:h.length>0?i.length/h.length*100:0},byStatus:Object.entries(j).map(([a,b])=>({status:a,count:b,percentage:g.length>0?b/g.length*100:0})).sort((a,b)=>b.count-a.count),byTechnician:Object.entries(k).map(([a,b])=>({id:a,name:b.name,jobsCompleted:b.completed,avgDuration:b.completed>0?b.totalDuration/b.completed:0,avgRevenue:b.completed>0?b.totalRevenue/b.completed:0,firstTimeFixRate:b.completed>0?b.firstTimeFixes/b.completed*100:0})).sort((a,b)=>b.jobsCompleted-a.jobsCompleted),byJobType:Object.entries(l).map(([a,b])=>({jobType:a,count:b.total,avgDuration:b.completed>0?b.totalDuration/b.completed:0,avgRevenue:b.completed>0?b.totalRevenue/b.completed:0,completionRate:b.total>0?b.completed/b.total*100:0})).sort((a,b)=>b.count-a.count),trendsWeekly:Object.entries(m).map(([a,b])=>({week:a,...b})).sort((a,b)=>a.week.localeCompare(b.week))}}),o=(0,b.cache)(async(a,b=365)=>{let d=await (0,c.createClient)(),e=new Date;e.setDate(e.getDate()-b);let f=new Date,[g,h,i]=await Promise.all([d.from("payments").select("amount, created_at").eq("company_id",a).eq("status","completed").gte("created_at",e.toISOString()),d.from("invoices").select("id, balance_amount, due_date, status").eq("company_id",a).not("status","in",'("paid", "void", "cancelled")').is("deleted_at",null),d.from("jobs").select("total_revenue, total_cost_actual, created_at").eq("company_id",a).eq("status","completed").gte("created_at",e.toISOString()).is("deleted_at",null)]),j=g.data||[],k=h.data||[],l=i.data||[],m=l.reduce((a,b)=>a+(b.total_revenue||0)/100,0),n=l.reduce((a,b)=>a+(b.total_cost_actual||0)/100,0),o=m-n,p={current:{count:0,amount:0},days1_30:{count:0,amount:0},days31_60:{count:0,amount:0},days61_90:{count:0,amount:0},over90:{count:0,amount:0}},q=0,r=0;for(let a of k){let b=(a.balance_amount||0)/100;if(q+=b,!a.due_date){p.current.count++,p.current.amount+=b;continue}let c=new Date(a.due_date),d=Math.floor((f.getTime()-c.getTime())/864e5);d<=0?(p.current.count++,p.current.amount+=b):(d<=30?(p.days1_30.count++,p.days1_30.amount+=b):d<=60?(p.days31_60.count++,p.days31_60.amount+=b):d<=90?(p.days61_90.count++,p.days61_90.amount+=b):(p.over90.count++,p.over90.amount+=b),r+=b)}let s={};for(let a of l){let b=new Date(a.created_at).toISOString().substring(0,7);s[b]||(s[b]={revenue:0,cost:0}),s[b].revenue+=(a.total_revenue||0)/100,s[b].cost+=(a.total_cost_actual||0)/100}let t={};for(let a of j){let b=new Date(a.created_at).toISOString().substring(0,7);t[b]||(t[b]={inflows:0,outflows:0}),t[b].inflows+=(a.amount||0)/100}return{summary:{totalRevenue:m,totalCost:n,grossProfit:o,grossMargin:m>0?o/m*100:0,outstandingAR:q,overdueAR:r},arAging:p,monthlyPL:Object.entries(s).map(([a,b])=>({month:a,revenue:b.revenue,cost:b.cost,profit:b.revenue-b.cost,margin:b.revenue>0?(b.revenue-b.cost)/b.revenue*100:0})).sort((a,b)=>a.month.localeCompare(b.month)),cashFlow:Object.entries(t).map(([a,b])=>({month:a,inflows:b.inflows,outflows:b.outflows,net:b.inflows-b.outflows})).sort((a,b)=>a.month.localeCompare(b.month))}}),p=(0,b.cache)(async(a,b=30)=>{let d=await (0,c.createClient)(),e=new Date;e.setDate(e.getDate()-b);let{data:f}=await d.from("jobs").select(`
			id, status, total_revenue, actual_duration_minutes, is_callback, assigned_to,
			assigned_user:users!assigned_to(id, first_name, last_name)
		`).eq("company_id",a).eq("status","completed").gte("created_at",e.toISOString()).is("deleted_at",null),g={};for(let a of f||[]){let b=a.assigned_to;if(!b)continue;let c=a.assigned_user,d=[c?.first_name,c?.last_name].filter(Boolean).join(" ")||"Unknown";g[b]||(g[b]={name:d,completed:0,revenue:0,totalDuration:0,firstTimeFixes:0}),g[b].completed++,g[b].revenue+=(a.total_revenue||0)/100,g[b].totalDuration+=a.actual_duration_minutes||0,!a.is_callback&&g[b].firstTimeFixes++}let h=Object.entries(g).map(([a,b])=>{let c=b.completed>0?b.firstTimeFixes/b.completed*100:0,d=b.completed>0?b.totalDuration/b.completed:0,e=10*b.completed+b.revenue/100+2*c;return{id:a,name:b.name,rank:0,jobsCompleted:b.completed,revenue:b.revenue,avgRating:4.5,firstTimeFixRate:c,avgJobDuration:d,utilizationRate:75,score:e}}).sort((a,b)=>b.score-a.score).map((a,b)=>({...a,rank:b+1})),i=h.length,j={jobsPerTech:i>0?h.reduce((a,b)=>a+b.jobsCompleted,0)/i:0,revenuePerTech:i>0?h.reduce((a,b)=>a+b.revenue,0)/i:0,avgRating:i>0?h.reduce((a,b)=>a+b.avgRating,0)/i:0,firstTimeFixRate:i>0?h.reduce((a,b)=>a+b.firstTimeFixRate,0)/i:0};return{technicians:h,topPerformer:h.length>0?{id:h[0].id,name:h[0].name,highlight:`${h[0].jobsCompleted} jobs completed, $${h[0].revenue.toLocaleString()} revenue`}:null,teamAverages:j}}),q=(0,b.cache)(async(a,b=365)=>{let d=await (0,c.createClient)(),e=new Date;e.setDate(e.getDate()-b);let f=new Date;f.setDate(f.getDate()-30);let[g,h]=await Promise.all([d.from("customers").select("id, display_name, first_name, last_name, created_at, customer_type, churn_risk, lifetime_value, total_jobs, last_service_date").eq("company_id",a).is("deleted_at",null),d.from("jobs").select("customer_id, total_revenue, created_at").eq("company_id",a).eq("status","completed").gte("created_at",e.toISOString()).is("deleted_at",null)]),i=g.data||[],j=h.data||[],k=i.filter(a=>a.created_at&&new Date(a.created_at)>=f).length,l=i.filter(a=>(a.total_jobs||0)>1).length,m=i.filter(a=>"churned"===a.churn_risk).length,n=i.length,o=n>0?i.reduce((a,b)=>a+(b.lifetime_value||0)/100,0)/n:0,p={};for(let a of i){let b=a.customer_type||"Residential";p[b]||(p[b]={count:0,revenue:0,jobs:0}),p[b].count++}let q={};for(let a of i)q[a.id]=a.customer_type||"Residential";for(let a of j){let b=q[a.customer_id]||"Residential";p[b]&&(p[b].revenue+=(a.total_revenue||0)/100,p[b].jobs++)}let r={};for(let a of i){let b=a.display_name||[a.first_name,a.last_name].filter(Boolean).join(" ")||"Unknown";r[a.id]={name:b,revenue:0,jobCount:a.total_jobs||0,lastService:a.last_service_date,ltv:(a.lifetime_value||0)/100}}for(let a of j)r[a.customer_id]&&(r[a.customer_id].revenue+=(a.total_revenue||0)/100);let s={};for(let a of i)if(a.created_at){let b=new Date(a.created_at).toISOString().substring(0,7);s[b]||(s[b]={new:0,churned:0}),s[b].new++}let t={low:0,medium:0,high:0};for(let a of i){let b=a.churn_risk;b&&void 0!==t[b]?t[b]++:t.low++}return{summary:{totalCustomers:n,newCustomers:k,repeatCustomers:l,churnedCustomers:m,retentionRate:n>0?(n-m)/n*100:100,avgLifetimeValue:o},bySegment:Object.entries(p).map(([a,b])=>({segment:a,count:b.count,revenue:b.revenue,avgTicket:b.jobs>0?b.revenue/b.jobs:0})).sort((a,b)=>b.revenue-a.revenue),topCustomers:Object.entries(r).map(([a,b])=>({id:a,name:b.name,totalRevenue:b.revenue,jobCount:b.jobCount,lastServiceDate:b.lastService,lifetimeValue:b.ltv})).sort((a,b)=>b.totalRevenue-a.totalRevenue).slice(0,10),acquisitionTrend:Object.entries(s).map(([a,b])=>({month:a,newCustomers:b.new,churned:b.churned,net:b.new-b.churned})).sort((a,b)=>a.month.localeCompare(b.month)),riskDistribution:t}}),r=(0,b.cache)(async(a,b=5)=>{let d=await (0,c.createClient)(),{data:e}=await d.from("communications").select(`
			id,
			type,
			direction,
			subject,
			body,
			read_at,
			created_at,
			customer:customers(name)
		`).eq("company_id",a).is("deleted_at",null).order("created_at",{ascending:!1}).limit(b);return e&&0!==e.length?e.map(a=>{let b,c,d=new Date(a.created_at),e=Math.floor((new Date().getTime()-d.getTime())/6e4),f=Math.floor(e/60),g=Math.floor(f/24);b=e<1?"Just now":e<60?`${e}m ago`:f<24?`${f}h ago`:`${g}d ago`,c="inbound"===a.direction?a.read_at?"read":"unread":"sent";let h=a.customer?.name||"Unknown";return{id:a.id,type:a.type||"email",direction:a.direction||"inbound",sender:h,subject:a.subject||a.body?.substring(0,50)+"...",time:b,status:c}}):[]}),s=(0,b.cache)(async(a,b=5)=>{let d=await (0,c.createClient)(),{data:e}=await d.from("communications").select(`
			id,
			customer_id,
			body,
			subject,
			created_at,
			read_at,
			direction,
			customer:customers(id, name)
		`).eq("company_id",a).is("deleted_at",null).not("customer_id","is",null).order("created_at",{ascending:!1}).limit(50);if(!e||0===e.length)return[];let f=new Map;for(let a of e){let b=a.customer_id;if(!b)continue;let c=a.customer?.name||"Unknown",d=f.get(b),e=a.subject||a.body?.substring(0,50)||"No message",g=new Date(a.created_at),h="inbound"===a.direction&&!a.read_at;d?(h&&d.unread++,g>d.lastTime&&(d.lastMessage=e,d.lastTime=g,d.id=a.id)):f.set(b,{customer:c,lastMessage:e,lastTime:g,unread:+!!h,id:a.id})}let g=new Date;return Array.from(f.values()).sort((a,b)=>b.lastTime.getTime()-a.lastTime.getTime()).slice(0,b).map(a=>{let b,c=Math.floor((g.getTime()-a.lastTime.getTime())/6e4),d=Math.floor(c/60),e=Math.floor(d/24);return b=c<1?"Just now":c<60?`${c}m ago`:d<24?`${d}h ago`:`${e}d ago`,{id:a.id,customer:a.customer,lastMessage:a.lastMessage.length>40?a.lastMessage.substring(0,40)+"...":a.lastMessage,time:b,unread:a.unread}})});(0,b.cache)(async(a,b=90)=>{let d=await (0,c.createClient)(),e=new Date;e.setDate(e.getDate()-b);let{data:f}=await d.from("jobs").select(`
			id, title, total_amount,
			labor_cost_actual, materials_cost_actual, equipment_cost_actual,
			total_cost_actual, overhead_cost, drive_time_cost,
			profit_actual, gross_margin_percent, budget_status,
			customer:customers(name, display_name)
		`).eq("company_id",a).eq("status","completed").gte("created_at",e.toISOString()).is("deleted_at",null).not("total_cost_actual","is",null),g=f||[],h=g.reduce((a,b)=>a+(b.labor_cost_actual||0)/100,0),i=g.reduce((a,b)=>a+(b.materials_cost_actual||0)/100,0),j=g.reduce((a,b)=>a+(b.equipment_cost_actual||0)/100,0),k=g.reduce((a,b)=>a+(b.overhead_cost||0)/100,0),l=g.reduce((a,b)=>a+(b.drive_time_cost||0)/100,0),m=g.length>0?g.reduce((a,b)=>a+(b.profit_actual||0)/100,0)/g.length:0,n=g.length>0?g.reduce((a,b)=>a+(b.gross_margin_percent||0),0)/g.length:0,o=g.filter(a=>"under_budget"===a.budget_status).length,p=g.filter(a=>"on_budget"===a.budget_status).length,q=g.filter(a=>"over_budget"===a.budget_status).length,r={under_budget:{count:0,revenue:0,cost:0},on_budget:{count:0,revenue:0,cost:0},over_budget:{count:0,revenue:0,cost:0}};for(let a of g){let b=a.budget_status||"on_budget";r[b]&&(r[b].count++,r[b].revenue+=(a.total_amount||0)/100,r[b].cost+=(a.total_cost_actual||0)/100)}let s=g.map(a=>{let b=a.customer;return{id:a.id,title:a.title||"Untitled Job",customer:b?.display_name||b?.name||"Unknown",revenue:(a.total_amount||0)/100,cost:(a.total_cost_actual||0)/100,profit:(a.profit_actual||0)/100,margin:a.gross_margin_percent||0}}).sort((a,b)=>b.profit-a.profit).slice(0,10);return{summary:{avgJobProfit:m,avgGrossMargin:n,totalLaborCost:h,totalMaterialsCost:i,totalEquipmentCost:j,jobsUnderBudget:o,jobsOnBudget:p,jobsOverBudget:q,avgCostVariance:0},byBudgetStatus:Object.entries(r).map(([a,b])=>({status:a,count:b.count,totalRevenue:b.revenue,totalCost:b.cost,avgMargin:b.revenue>0?(b.revenue-b.cost)/b.revenue*100:0})),topProfitableJobs:s,costBreakdown:{labor:h,materials:i,equipment:j,overhead:k,driveTime:l}}}),(0,b.cache)(async a=>{let b=await (0,c.createClient)(),{data:d}=await b.from("analytics_company_summary").select("*").eq("company_id",a).order("created_at",{ascending:!1}).limit(1).single();return d?{financial:{quoteToCloseRate:d.quote_to_close_rate||0,avgQuoteAccuracy:d.avg_quote_accuracy||0,avgDaysToPayment:d.avg_days_to_payment||0,collectionRate:d.collection_rate||0,cashFlow30Day:(d.cash_flow_30_day_forecast||0)/100},operational:{capacityUtilization:d.capacity_utilization_percent||0,billableHoursRatio:d.billable_hours_ratio||0,firstCallResolution:d.first_call_resolution_rate||0,avgResponseTimeHours:d.avg_response_time_hours||0,technicianUtilization:d.technician_utilization_rate||0},customer:{avgLifetimeValue:(d.avg_customer_lifetime_value||0)/100,customerAcquisitionCost:(d.customer_acquisition_cost||0)/100,ltvToCacRatio:d.ltv_to_cac_ratio||0,retentionRate:d.customer_retention_rate||0,recurringRevenuePercent:d.recurring_revenue_percent||0}}:null}),(0,b.cache)(async a=>{let b=await (0,c.createClient)(),{data:d}=await b.from("analytics_equipment_health").select(`
			equipment_id, health_score, condition_rating,
			days_until_maintenance, maintenance_overdue,
			total_maintenance_cost, age_years,
			equipment:equipment(id, name, model)
		`).eq("company_id",a).order("period_start",{ascending:!1}).limit(5e3),e=new Map;for(let a of d||[])e.has(a.equipment_id)||e.set(a.equipment_id,a);let f=Array.from(e.values()),g=f.length,h=f.filter(a=>a.health_score>=70).length,i=f.filter(a=>a.health_score>=40&&a.health_score<70).length,j=f.filter(a=>a.health_score<40).length,k=f.filter(a=>a.maintenance_overdue).length,l=g>0?f.reduce((a,b)=>a+(b.health_score||0),0)/g:0,m={};for(let a of f){let b=a.condition_rating||"unknown";m[b]||(m[b]={count:0,totalAge:0,totalCost:0}),m[b].count++,m[b].totalAge+=a.age_years||0,m[b].totalCost+=(a.total_maintenance_cost||0)/100}let n=f.filter(a=>(a.days_until_maintenance||0)>0&&30>=(a.days_until_maintenance||0)).map(a=>{let b=a.equipment;return{equipmentId:a.equipment_id,name:b?.name||b?.model||"Unknown Equipment",daysUntilMaintenance:a.days_until_maintenance||0,lastMaintenanceCost:(a.total_maintenance_cost||0)/100}}).sort((a,b)=>a.daysUntilMaintenance-b.daysUntilMaintenance).slice(0,10);return{summary:{totalEquipment:g,healthyCount:h,warningCount:i,criticalCount:j,avgHealthScore:l,maintenanceOverdue:k},byCondition:Object.entries(m).map(([a,b])=>({condition:a,count:b.count,avgAge:b.count>0?b.totalAge/b.count:0,avgMaintenanceCost:b.count>0?b.totalCost/b.count:0})),upcomingMaintenance:n}}),(0,b.cache)(async(a,b=30)=>{let d=await (0,c.createClient)(),e=new Date;e.setDate(e.getDate()-b);let{data:f}=await d.from("analytics_technician_metrics").select("*").eq("company_id",a).gte("period_start",e.toISOString().split("T")[0]).order("overall_performance_score",{ascending:!1}),g=(f||[]).map((a,b)=>({id:a.user_id,name:a.name||"Unknown",jobsCompleted:a.jobs_completed||0,revenue:(a.total_revenue||0)/100,avgJobProfit:(a.avg_job_profit||0)/100,profitMargin:a.profit_margin_percent||0,billableRatio:a.billable_ratio||0,callbacks:a.callbacks||0,callbackRate:a.callback_rate||0,upsellCount:a.upsell_count||0,upsellRevenue:(a.upsell_revenue||0)/100,overallScore:a.overall_performance_score||0,rank:b+1})),h=g.length,i={avgJobsPerTech:h>0?g.reduce((a,b)=>a+b.jobsCompleted,0)/h:0,avgRevenuePerTech:h>0?g.reduce((a,b)=>a+b.revenue,0)/h:0,avgProfitMargin:h>0?g.reduce((a,b)=>a+b.profitMargin,0)/h:0,avgBillableRatio:h>0?g.reduce((a,b)=>a+b.billableRatio,0)/h:0,totalCallbacks:g.reduce((a,b)=>a+b.callbacks,0)};return{technicians:g,teamMetrics:i}}),(0,b.cache)(async(a,b=90)=>{let d=await (0,c.createClient)(),e=new Date;e.setDate(e.getDate()-b);let{data:f}=await d.from("marketing_campaigns").select("id, name, channel, status, budget_amount, actual_spend, total_revenue, total_leads, total_booked_jobs, start_date, end_date, created_at").eq("company_id",a).is("deleted_at",null).order("created_at",{ascending:!1}).limit(1e3),{data:g}=await d.from("analytics_marketing_attribution").select("*").eq("company_id",a).gte("date",e.toISOString().split("T")[0]).order("date",{ascending:!0}).limit(1e4),h=f||[],i=h.reduce((a,b)=>a+(b.actual_spend||0),0),j=h.reduce((a,b)=>a+(b.total_revenue||0),0),k=h.reduce((a,b)=>a+(b.total_leads||0),0),l=h.reduce((a,b)=>a+(b.total_booked_jobs||0),0),m=h.map(a=>({id:a.id,name:a.name,channel:a.channel,status:a.status,budget:a.budget_amount||0,spend:a.actual_spend||0,leads:a.total_leads||0,bookedJobs:a.total_booked_jobs||0,revenue:a.total_revenue||0,roas:a.return_on_ad_spend||0,roi:a.roi_percent||0,costPerLead:a.cost_per_lead||0})),n={};for(let a of h){let b=a.channel||"other";n[b]||(n[b]={spend:0,leads:0,bookedJobs:0,revenue:0}),n[b].spend+=a.actual_spend||0,n[b].leads+=a.total_leads||0,n[b].bookedJobs+=a.total_booked_jobs||0,n[b].revenue+=a.total_revenue||0}let o=Object.entries(n).map(([a,b])=>({channel:a,spend:b.spend,leads:b.leads,bookedJobs:b.bookedJobs,revenue:b.revenue,roas:b.spend>0?b.revenue/b.spend:0,costPerLead:b.leads>0?b.spend/b.leads:0})).sort((a,b)=>b.revenue-a.revenue),p={};for(let a of g||[]){let b=a.date;p[b]||(p[b]={spend:0,leads:0,revenue:0}),p[b].spend+=a.daily_spend||0,p[b].leads+=a.total_leads||0,p[b].revenue+=a.total_revenue||0}return{summary:{totalSpend:i,totalRevenue:j,totalLeads:k,totalBookedJobs:l,overallROAS:i>0?j/i:0,overallROI:i>0?(j-i)/i*100:0,avgCostPerLead:k>0?i/k:0,avgCostPerAcquisition:l>0?i/l:0},campaigns:m,byChannel:o,trendDaily:Object.entries(p).map(([a,b])=>({date:a,spend:b.spend,leads:b.leads,revenue:b.revenue,roas:b.spend>0?b.revenue/b.spend:0})).sort((a,b)=>a.date.localeCompare(b.date))}}),(0,b.cache)(async(a,b=30)=>{let d=await (0,c.createClient)(),e=new Date;e.setDate(e.getDate()-b);let{data:f}=await d.from("analytics_csr_metrics").select("*").eq("company_id",a).gte("date",e.toISOString().split("T")[0]).order("date",{ascending:!1}),g=f||[],h=new Map;for(let a of g)(!h.has(a.user_id)||a.date>(h.get(a.user_id)?.date||""))&&h.set(a.user_id,a);let i=Array.from(h.values()).map(a=>({id:a.user_id,name:a.csr_name||"Unknown",callsAnswered:a.total_calls_answered||0,callsMissed:a.total_calls_missed||0,callAnswerRate:a.call_answer_rate||0,opportunities:a.total_opportunities||0,jobsBooked:a.jobs_booked||0,bookingRate:a.booking_rate||0,bookedRevenue:a.booked_revenue||0,avgTicket:a.avg_booked_ticket||0,revenuePerCall:a.revenue_per_call||0,avgTalkTime:a.avg_talk_time_seconds||0,qualityScore:a.avg_call_quality_score||0,performanceScore:a.overall_performance_score||0,bookingRateRank:a.booking_rate_rank||0,revenueRank:a.revenue_rank||0,vsTarget:a.booking_rate_vs_target||0})).sort((a,b)=>b.bookingRate-a.bookingRate),j=i.length,k=i.reduce((a,b)=>a+b.callsAnswered,0),l=j>0?i.reduce((a,b)=>a+b.bookingRate,0)/j:0,m=j>0?i.reduce((a,b)=>a+b.callAnswerRate,0)/j:0,n=i.reduce((a,b)=>a+b.bookedRevenue,0),o=i.length>0?i[0].bookingRate:0,p=i.slice(0,5).map((a,b)=>({rank:b+1,name:a.name,bookingRate:a.bookingRate,revenue:a.bookedRevenue})),q={};for(let a of g){let b=a.date;q[b]||(q[b]={totalCalls:0,answered:0,booked:0}),q[b].totalCalls+=a.total_calls_received||0,q[b].answered+=a.total_calls_answered||0,q[b].booked+=a.jobs_booked||0}return{summary:{totalCSRs:j,totalCallsHandled:k,avgBookingRate:l,avgCallAnswerRate:m,totalBookedRevenue:n,avgRevenuePerCall:k>0?n/k:0,topPerformerBookingRate:o,teamTarget:80},csrList:i,leaderboard:p,trendDaily:Object.entries(q).map(([a,b])=>({date:a,totalCalls:b.totalCalls,answered:b.answered,booked:b.booked,bookingRate:b.answered>0?b.booked/b.answered*100:0})).sort((a,b)=>a.date.localeCompare(b.date))}}),(0,b.cache)(async(a,b=30)=>{let d=await (0,c.createClient)(),e=new Date;e.setDate(e.getDate()-b);let{data:f}=await d.from("marketing_call_tracking").select(`
			*,
			campaign:marketing_campaigns(name, channel)
		`).eq("company_id",a).gte("call_start",e.toISOString()).order("call_start",{ascending:!1}).limit(500),g=f||[],h=g.length,i=g.filter(a=>a.answered).length,j=g.filter(a=>a.missed_call).length,k=g.filter(a=>a.booked_job).length,l=i>0?g.filter(a=>a.answered).reduce((a,b)=>a+(b.duration_seconds||0),0)/i:0,m=g.filter(a=>a.is_new_customer).length,n={};for(let a of g){let b=a.call_outcome||"unknown";n[b]=(n[b]||0)+1}let o=Object.entries(n).map(([a,b])=>({outcome:a,count:b,percentage:h>0?b/h*100:0})).sort((a,b)=>b.count-a.count),p={};for(let a of g){let b=a.campaign,c=b?.channel||a.utm_source||"direct";p[c]||(p[c]={calls:0,booked:0,revenue:0}),p[c].calls++,a.booked_job&&p[c].booked++,p[c].revenue+=a.attributed_revenue||0}let q=Object.entries(p).map(([a,b])=>({source:a,calls:b.calls,booked:b.booked,bookingRate:b.calls>0?b.booked/b.calls*100:0,revenue:b.revenue})).sort((a,b)=>b.calls-a.calls),r=new Date;return{summary:{totalCalls:h,answeredCalls:i,missedCalls:j,callAnswerRate:h>0?i/h*100:0,bookedCalls:k,bookingRate:i>0?k/i*100:0,avgCallDuration:l,newCustomerCalls:m},byOutcome:o,bySource:q,recentCalls:g.slice(0,20).map(a=>{let b,c=a.campaign,d=new Date(a.call_start),e=Math.floor((r.getTime()-d.getTime())/6e4),f=Math.floor(e/60);return b=e<60?`${e}m ago`:f<24?`${f}h ago`:`${Math.floor(f/24)}d ago`,{id:a.id,callerNumber:a.caller_number||"Unknown",callerName:a.caller_name,duration:a.duration_seconds||0,outcome:a.call_outcome||"unknown",booked:a.booked_job||!1,campaign:c?.name||null,time:b}})}}),(0,b.cache)(async(a,b=30)=>{let d=await (0,c.createClient)(),e=new Date;e.setDate(e.getDate()-b);let{data:f}=await d.from("analytics_dispatch_efficiency").select("*").eq("company_id",a).gte("date",e.toISOString().split("T")[0]).order("date",{ascending:!1}),g=f||[],h=new Map;for(let a of g)a.technician_id&&!h.has(a.technician_id)&&h.set(a.technician_id,a);let i=g.length,j=i>0?g.reduce((a,b)=>a+(b.schedule_fill_rate||0),0)/i:0,k=i>0?g.reduce((a,b)=>a+(b.avg_drive_time_minutes||0),0)/i:0,l=i>0?g.reduce((a,b)=>a+(b.avg_drive_distance_miles||0),0)/i:0,m=i>0?g.reduce((a,b)=>a+(b.on_time_arrival_rate||0),0)/i:0,n=i>0?g.reduce((a,b)=>a+(b.sla_compliance_rate||0),0)/i:0,o=i>0?g.reduce((a,b)=>a+(b.avg_jobs_per_tech_per_day||0),0)/i:0,p=i>0?g.reduce((a,b)=>a+(b.technician_utilization_rate||0),0)/i:0,q=g.reduce((a,b)=>a+(b.total_drive_distance_miles||0),0),r=g.reduce((a,b)=>a+(b.total_drive_cost||0),0),s=Array.from(h.values()).map(a=>({id:a.technician_id||"",name:a.technician_name||"Unknown",scheduleFillRate:a.schedule_fill_rate||0,avgDriveTime:a.avg_drive_time_minutes||0,onTimeRate:a.on_time_arrival_rate||0,jobsCompleted:a.total_jobs_completed||0,utilizationRate:a.technician_utilization_rate||0,driveTimeOptimization:a.drive_time_optimization_score||0})).sort((a,b)=>b.scheduleFillRate-a.scheduleFillRate),t={};for(let a of g){let b=a.service_zone||"Unassigned";t[b]||(t[b]={appointments:0,totalDriveTime:0,totalDriveDistance:0,onTimeCount:0,totalCount:0,revenue:0}),t[b].appointments+=a.total_jobs_scheduled||0,t[b].totalDriveTime+=a.total_drive_time_minutes||0,t[b].totalDriveDistance+=a.total_drive_distance_miles||0,t[b].onTimeCount+=(a.on_time_arrival_rate||0)*(a.total_jobs_completed||0)/100,t[b].totalCount+=a.total_jobs_completed||0,t[b].revenue+=a.revenue_per_mile||0}let u=Object.entries(t).map(([a,b])=>({zone:a,appointments:b.appointments,avgDriveTime:b.totalCount>0?b.totalDriveTime/b.totalCount:0,avgDriveDistance:b.totalCount>0?b.totalDriveDistance/b.totalCount:0,onTimeRate:b.totalCount>0?b.onTimeCount/b.totalCount*100:0,revenue:b.revenue})).sort((a,b)=>b.appointments-a.appointments),v={};for(let a of g){let b=a.date;v[b]||(v[b]={fillRates:[],driveTimes:[],onTimeRates:[],scheduled:0,completed:0}),v[b].fillRates.push(a.schedule_fill_rate||0),v[b].driveTimes.push(a.avg_drive_time_minutes||0),v[b].onTimeRates.push(a.on_time_arrival_rate||0),v[b].scheduled+=a.total_jobs_scheduled||0,v[b].completed+=a.total_jobs_completed||0}let w=Object.entries(v).map(([a,b])=>({date:a,scheduleFillRate:b.fillRates.length>0?b.fillRates.reduce((a,b)=>a+b,0)/b.fillRates.length:0,avgDriveTime:b.driveTimes.length>0?b.driveTimes.reduce((a,b)=>a+b,0)/b.driveTimes.length:0,onTimeRate:b.onTimeRates.length>0?b.onTimeRates.reduce((a,b)=>a+b,0)/b.onTimeRates.length:0,jobsScheduled:b.scheduled,jobsCompleted:b.completed})).sort((a,b)=>a.date.localeCompare(b.date)),x=[];return j<70&&x.push({type:"schedule_fill",severity:j<50?"high":"medium",message:`Schedule fill rate is ${j.toFixed(1)}% - optimize technician scheduling`,potentialSavings:(80-j)*100}),k>30&&x.push({type:"drive_time",severity:k>45?"high":"medium",message:`Average drive time is ${k.toFixed(0)} minutes - consider route optimization`,potentialSavings:(k-20)*r/k}),m<85&&x.push({type:"on_time",severity:m<70?"high":"medium",message:`On-time arrival rate is ${m.toFixed(1)}% - review scheduling practices`,potentialSavings:0}),{summary:{scheduleFillRate:j,avgDriveTimeMinutes:k,avgDriveDistanceMiles:l,onTimeArrivalRate:m,slaComplianceRate:n,avgJobsPerTechPerDay:o,utilizationRate:p,totalDriveMiles:q,totalDriveCost:r},byTechnician:s,byZone:u,dailyTrends:w,optimizationAlerts:x}}),(0,b.cache)(async(a,b=90)=>{let d=await (0,c.createClient)(),e=new Date;e.setDate(e.getDate()-b);let{data:f}=await d.from("analytics_pricebook_performance").select("*").eq("company_id",a).gte("period_start",e.toISOString().split("T")[0]).order("total_revenue",{ascending:!1}),g=f||[],h=g.length,i=h>0?g.reduce((a,b)=>a+(b.profit_margin_percent||0),0)/h:0,j=h>0?g.reduce((a,b)=>a+(b.markup_percent||0),0)/h:0,k=g.reduce((a,b)=>a+(b.total_revenue||0),0),l=g.reduce((a,b)=>a+(b.total_profit||0),0),m=g.filter(a=>!0===a.margin_alert).length,n=g.filter(a=>20>(a.profit_margin_percent||0)).length,o=g.filter(a=>(a.times_sold||0)>10&&(a.profit_margin_percent||0)>30).length,p={};for(let a of g){let b=a.category||"Uncategorized";p[b]||(p[b]={itemCount:0,totalSold:0,revenue:0,profit:0,margins:[],markups:[]}),p[b].itemCount++,p[b].totalSold+=a.times_sold||0,p[b].revenue+=a.total_revenue||0,p[b].profit+=a.total_profit||0,p[b].margins.push(a.profit_margin_percent||0),p[b].markups.push(a.markup_percent||0)}let q=Object.entries(p).map(([a,b])=>({category:a,itemCount:b.itemCount,totalSold:b.totalSold,revenue:b.revenue,profit:b.profit,avgMargin:b.margins.length>0?b.margins.reduce((a,b)=>a+b,0)/b.margins.length:0,avgMarkup:b.markups.length>0?b.markups.reduce((a,b)=>a+b,0)/b.markups.length:0})).sort((a,b)=>b.revenue-a.revenue),r=g.filter(a=>(a.times_sold||0)>0).slice(0,10).map(a=>({id:a.item_id,name:a.item_name||"Unknown",category:a.category||"Uncategorized",timesSold:a.times_sold||0,revenue:a.total_revenue||0,profit:a.total_profit||0,margin:a.profit_margin_percent||0,trend:(a.period_over_period_change||0)>5?"up":-5>(a.period_over_period_change||0)?"down":"stable"}));return{summary:{totalItems:h,avgMargin:i,avgMarkup:j,totalRevenue:k,totalProfit:l,itemsNeedingReview:m,lowMarginItems:n,highPerformingItems:o},byCategory:q,topPerformers:r,lowMarginAlerts:g.filter(a=>!0===a.margin_alert&&(a.times_sold||0)>0).slice(0,10).map(a=>({id:a.item_id,name:a.item_name||"Unknown",currentMargin:a.profit_margin_percent||0,targetMargin:a.target_margin_percent||30,recommendation:a.pricing_recommendation||"Review pricing",potentialProfit:a.potential_profit_increase||0})),pricingRecommendations:g.filter(a=>a.recommended_price&&a.recommended_price!==a.current_price).slice(0,10).map(a=>({itemId:a.item_id,itemName:a.item_name||"Unknown",currentPrice:a.current_price||0,recommendedPrice:a.recommended_price||0,reason:a.pricing_recommendation||"Based on market analysis",confidence:a.price_competitiveness_score||50}))}}),(0,b.cache)(async a=>{let b=await (0,c.createClient)(),{data:d}=await b.from("analytics_customer_health").select("*").eq("company_id",a).order("health_score",{ascending:!1}).limit(5e3),e=d||[],f=e.length,g=f>0?e.reduce((a,b)=>a+(b.health_score||0),0)/f:0,h=f>0?e.reduce((a,b)=>a+(b.churn_probability||0),0)/f:0,i=e.filter(a=>"vip"===a.segment).length,j=e.filter(a=>"loyal"===a.segment).length,k=e.filter(a=>"at_risk"===a.segment||(a.churn_probability||0)>50).length,l=e.filter(a=>"dormant"===a.segment).length,m=e.filter(a=>(a.churn_probability||0)>70&&(a.days_since_last_service||0)>60).length,n={};for(let a of e){let b=a.segment||"unknown";n[b]||(n[b]={count:0,healthScores:[],lifetimeValues:[],churnProbabilities:[],revenue:0}),n[b].count++,n[b].healthScores.push(a.health_score||0),n[b].lifetimeValues.push(a.lifetime_value||0),n[b].churnProbabilities.push(a.churn_probability||0),n[b].revenue+=a.total_revenue||0}let o=Object.entries(n).map(([a,b])=>({segment:a,count:b.count,avgHealthScore:b.healthScores.length>0?b.healthScores.reduce((a,b)=>a+b,0)/b.healthScores.length:0,avgLifetimeValue:b.lifetimeValues.length>0?b.lifetimeValues.reduce((a,b)=>a+b,0)/b.lifetimeValues.length:0,avgChurnProbability:b.churnProbabilities.length>0?b.churnProbabilities.reduce((a,b)=>a+b,0)/b.churnProbabilities.length:0,revenue:b.revenue})).sort((a,b)=>b.count-a.count),p=e.filter(a=>(a.churn_probability||0)>40).slice(0,20).map(a=>{let b=[];(a.days_since_last_service||0)>180&&b.push("No service in 6+ months"),30>(a.engagement_score||0)&&b.push("Low engagement"),30>(a.transaction_score||0)&&b.push("Low transaction activity"),50>(a.payment_score||0)&&b.push("Payment issues"),30>(a.contract_score||0)&&b.push("No active contracts");let c="Schedule follow-up call";return"vip"===a.segment?c="Priority outreach by manager":(a.days_since_last_service||0)>365?c="Reactivation campaign":30>(a.contract_score||0)&&(c="Offer service agreement"),{id:a.customer_id,name:a.customer_name||"Unknown",healthScore:a.health_score||0,churnProbability:a.churn_probability||0,daysSinceLastService:a.days_since_last_service||0,lifetimeValue:a.lifetime_value||0,riskFactors:b,recommendedAction:c}}).sort((a,b)=>b.churnProbability-a.churnProbability),q=e.filter(a=>(a.total_services||0)>1).length,r=f>0?e.reduce((a,b)=>a+(b.avg_days_between_services||0),0)/f:0,s=e.filter(a=>90>(a.days_since_last_service||0)&&(a.total_services||0)>1).length,t=e.filter(a=>(a.days_since_last_service||365)>180).length,u=[],v=new Date;for(let a=29;a>=0;a--){let b=new Date(v);b.setDate(b.getDate()-a),u.push({date:b.toISOString().split("T")[0],avgHealthScore:g+(Math.random()-.5)*5,atRiskCount:k+Math.floor((Math.random()-.5)*5),dormantCount:l+Math.floor((Math.random()-.5)*3)})}return{summary:{totalCustomers:f,avgHealthScore:g,vipCustomers:i,loyalCustomers:j,atRiskCustomers:k,dormantCustomers:l,avgChurnProbability:h,predictedChurnNext30Days:m},bySegment:o,atRiskCustomers:p,healthTrends:u,retentionMetrics:{retentionRate90Day:f>0?(f-3*m)/f*100:100,reactivationRate:t>0?s/t*100:0,avgDaysBetweenServices:r,repeatCustomerRate:f>0?q/f*100:0}}}),a.s(["getActiveThreads",0,s,"getAnalyticsTrends",0,d,"getCustomerAnalytics",0,q,"getCustomerHealthDistribution",0,j,"getEstimateConversionFunnel",0,k,"getFinancialReport",0,o,"getInvoiceAgingSummary",0,l,"getJobPerformanceReport",0,n,"getKPISummary",0,i,"getRecentCommunications",0,r,"getRevenueReport",0,m,"getTeamLeaderboard",0,p])}];

//# sourceMappingURL=apps_web_src_lib_queries_analytics_ts_0b47c0d4._.js.map