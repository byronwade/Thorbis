{"version":3,"sources":["../../../../../../apps/web/src/lib/payments/processors/adyen.ts"],"sourcesContent":["/**\n * Adyen Payment Processor\n *\n * Handles high-value payments through Adyen for Platforms:\n * - Card-present payments (card readers)\n * - Tap-to-Pay on iPhone/Android\n * - Online payments\n * - ACH payments (via Adyen's ACH integration)\n *\n * Adyen is ideal for high-value payments because:\n * - No hard limits on payment amounts\n * - Trust-based approval system\n * - Platform model supports sub-merchant onboarding\n * - Better suited for B2B and high-ticket transactions\n */\n\nimport crypto from \"crypto\";\nimport type {\n\tPaymentChannel,\n\tPaymentProcessor,\n\tProcessPaymentRequest,\n\tProcessPaymentResponse,\n\tRefundPaymentRequest,\n\tRefundPaymentResponse,\n} from \"../processor-types\";\n\ntype AdyenConfig = {\n\tcompanyId: string;\n\taccountId: string;\n\tapiKey: string;\n\tmerchantAccount: string;\n\tliveMode: boolean;\n\twebhookHmacKey?: string; // HMAC key for webhook signature verification\n};\n\nexport class AdyenProcessor implements PaymentProcessor {\n\tprivate readonly config: AdyenConfig;\n\tprivate readonly apiUrl: string;\n\n\tconstructor(config: AdyenConfig) {\n\t\tthis.config = config;\n\t\tthis.apiUrl = config.liveMode\n\t\t\t? \"https://api.adyen.com\"\n\t\t\t: \"https://api-adyen-test.adyen.com\";\n\t}\n\n\tgetSupportedChannels(): PaymentChannel[] {\n\t\treturn [\"online\", \"card_present\", \"tap_to_pay\", \"ach\"];\n\t}\n\n\tasync processPayment(\n\t\trequest: ProcessPaymentRequest,\n\t): Promise<ProcessPaymentResponse> {\n\t\ttry {\n\t\t\t// For Adyen, we need to create a payment request\n\t\t\tconst paymentRequest = {\n\t\t\t\tamount: {\n\t\t\t\t\tvalue: request.amount,\n\t\t\t\t\tcurrency: request.currency || \"USD\",\n\t\t\t\t},\n\t\t\t\tmerchantAccount: this.config.merchantAccount,\n\t\t\t\treference: request.invoiceId || `invoice-${Date.now()}`,\n\t\t\t\tpaymentMethod: request.paymentMethodId\n\t\t\t\t\t? {\n\t\t\t\t\t\t\ttype: \"scheme\", // Credit card\n\t\t\t\t\t\t\tstoredPaymentMethodId: request.paymentMethodId,\n\t\t\t\t\t\t}\n\t\t\t\t\t: undefined,\n\t\t\t\treturnUrl: `${process.env.NEXT_PUBLIC_SITE_URL}/dashboard/work/invoices/${request.invoiceId}`,\n\t\t\t\tmetadata: {\n\t\t\t\t\tcompany_id: this.config.companyId,\n\t\t\t\t\tcustomer_id: request.customerId,\n\t\t\t\t\tinvoice_id: request.invoiceId,\n\t\t\t\t\tchannel: request.channel,\n\t\t\t\t\t...request.metadata,\n\t\t\t\t},\n\t\t\t};\n\n\t\t\t// Make API call to Adyen\n\t\t\tconst response = await fetch(`${this.apiUrl}/v68/payments`, {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders: {\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\"X-API-Key\": this.config.apiKey,\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify(paymentRequest),\n\t\t\t});\n\n\t\t\tconst data = await response.json();\n\n\t\t\tif (!response.ok) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tstatus: \"failed\",\n\t\t\t\t\terror: data.message || \"Payment processing failed\",\n\t\t\t\t\tfailureCode: data.errorCode,\n\t\t\t\t\tfailureMessage: data.message,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// Handle different response types\n\t\t\tif (data.resultCode === \"Authorised\" || data.resultCode === \"Received\") {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\ttransactionId: data.pspReference,\n\t\t\t\t\tprocessorTransactionId: data.pspReference,\n\t\t\t\t\tstatus: \"succeeded\",\n\t\t\t\t\tprocessorMetadata: data,\n\t\t\t\t};\n\t\t\t}\n\t\t\tif (\n\t\t\t\tdata.resultCode === \"Pending\" ||\n\t\t\t\tdata.resultCode === \"RedirectShopper\"\n\t\t\t) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\ttransactionId: data.pspReference,\n\t\t\t\t\tprocessorTransactionId: data.pspReference,\n\t\t\t\t\tstatus: \"requires_action\",\n\t\t\t\t\tclientSecret: data.action?.paymentData || data.pspReference,\n\t\t\t\t\tprocessorMetadata: data,\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tstatus: \"failed\",\n\t\t\t\terror: data.refusalReason || \"Payment was refused\",\n\t\t\t\tfailureCode: data.refusalReasonCode,\n\t\t\t\tfailureMessage: data.refusalReason,\n\t\t\t\tprocessorMetadata: data,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tstatus: \"failed\",\n\t\t\t\terror:\n\t\t\t\t\terror instanceof Error ? error.message : \"Payment processing failed\",\n\t\t\t};\n\t\t}\n\t}\n\n\tasync refundPayment(\n\t\trequest: RefundPaymentRequest,\n\t): Promise<RefundPaymentResponse> {\n\t\ttry {\n\t\t\tconst refundRequest = {\n\t\t\t\tmerchantAccount: this.config.merchantAccount,\n\t\t\t\toriginalReference: request.transactionId,\n\t\t\t\tamount: request.amount\n\t\t\t\t\t? {\n\t\t\t\t\t\t\tvalue: request.amount,\n\t\t\t\t\t\t\tcurrency: \"USD\",\n\t\t\t\t\t\t}\n\t\t\t\t\t: undefined, // Full refund if amount not specified\n\t\t\t\treference: `refund-${Date.now()}`,\n\t\t\t\tmetadata: {\n\t\t\t\t\treason: request.reason,\n\t\t\t\t\t...request.metadata,\n\t\t\t\t},\n\t\t\t};\n\n\t\t\tconst response = await fetch(\n\t\t\t\t`${this.apiUrl}/v68/payments/${request.transactionId}/refunds`,\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\t\"X-API-Key\": this.config.apiKey,\n\t\t\t\t\t},\n\t\t\t\t\tbody: JSON.stringify(refundRequest),\n\t\t\t\t},\n\t\t\t);\n\n\t\t\tconst data = await response.json();\n\n\t\t\tif (!response.ok) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tstatus: \"failed\",\n\t\t\t\t\terror: data.message || \"Refund failed\",\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\trefundId: data.pspReference,\n\t\t\t\tprocessorRefundId: data.pspReference,\n\t\t\t\tstatus: data.status === \"received\" ? \"succeeded\" : \"processing\",\n\t\t\t};\n\t\t} catch (error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tstatus: \"failed\",\n\t\t\t\terror: error instanceof Error ? error.message : \"Refund failed\",\n\t\t\t};\n\t\t}\n\t}\n\n\tasync getPaymentStatus(transactionId: string): Promise<{\n\t\tstatus: string;\n\t\tamount: number;\n\t\tmetadata?: Record<string, unknown>;\n\t}> {\n\t\tconst response = await fetch(\n\t\t\t`${this.apiUrl}/v68/payments/${transactionId}`,\n\t\t\t{\n\t\t\t\tmethod: \"GET\",\n\t\t\t\theaders: {\n\t\t\t\t\t\"X-API-Key\": this.config.apiKey,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tconst data = await response.json();\n\n\t\tif (!response.ok) {\n\t\t\tthrow new Error(data.message || \"Failed to get payment status\");\n\t\t}\n\n\t\treturn {\n\t\t\tstatus: data.status || \"unknown\",\n\t\t\tamount: data.amount?.value || 0,\n\t\t\tmetadata: data,\n\t\t};\n\t}\n\n\t/**\n\t * Verify Adyen webhook signature using HMAC SHA256\n\t *\n\t * Adyen signs webhooks using HMAC SHA256 with a key from the Customer Area.\n\t * The signature is sent in the \"HmacSignature\" field of the notification.\n\t *\n\t * @param payload - The raw webhook payload\n\t * @param signature - The HMAC signature from the webhook header\n\t * @returns true if signature is valid\n\t */\n\tverifyWebhook(payload: string, signature: string): boolean {\n\t\tif (!this.config.webhookHmacKey) {\n\t\t\tconsole.warn(\"[Adyen] No webhook HMAC key configured - skipping verification\");\n\t\t\treturn false;\n\t\t}\n\n\t\ttry {\n\t\t\t// Parse the notification to get the fields for HMAC calculation\n\t\t\tconst notification = JSON.parse(payload);\n\t\t\tconst notificationItems = notification.notificationItems || [];\n\n\t\t\tif (notificationItems.length === 0) {\n\t\t\t\tconsole.error(\"[Adyen] No notification items in webhook\");\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// For each notification item, verify the HMAC\n\t\t\tfor (const item of notificationItems) {\n\t\t\t\tconst notificationRequestItem = item.NotificationRequestItem;\n\n\t\t\t\t// Build the HMAC data string in Adyen's specific format\n\t\t\t\t// Format: pspReference:originalReference:merchantAccountCode:merchantReference:amount.value:amount.currency:eventCode:success\n\t\t\t\tconst hmacData = [\n\t\t\t\t\tnotificationRequestItem.pspReference || \"\",\n\t\t\t\t\tnotificationRequestItem.originalReference || \"\",\n\t\t\t\t\tnotificationRequestItem.merchantAccountCode || \"\",\n\t\t\t\t\tnotificationRequestItem.merchantReference || \"\",\n\t\t\t\t\tnotificationRequestItem.amount?.value?.toString() || \"\",\n\t\t\t\t\tnotificationRequestItem.amount?.currency || \"\",\n\t\t\t\t\tnotificationRequestItem.eventCode || \"\",\n\t\t\t\t\tnotificationRequestItem.success || \"\",\n\t\t\t\t].join(\":\");\n\n\t\t\t\t// Calculate HMAC SHA256\n\t\t\t\tconst hmacKey = Buffer.from(this.config.webhookHmacKey, \"hex\");\n\t\t\t\tconst calculatedHmac = crypto\n\t\t\t\t\t.createHmac(\"sha256\", hmacKey)\n\t\t\t\t\t.update(hmacData, \"utf8\")\n\t\t\t\t\t.digest(\"base64\");\n\n\t\t\t\t// Get the provided HMAC from the notification\n\t\t\t\tconst providedHmac =\n\t\t\t\t\tnotificationRequestItem.additionalData?.hmacSignature || signature;\n\n\t\t\t\t// Compare using timing-safe comparison to prevent timing attacks\n\t\t\t\tif (\n\t\t\t\t\t!providedHmac ||\n\t\t\t\t\t!crypto.timingSafeEqual(\n\t\t\t\t\t\tBuffer.from(calculatedHmac),\n\t\t\t\t\t\tBuffer.from(providedHmac)\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tconsole.error(\"[Adyen] HMAC signature verification failed\");\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn true;\n\t\t} catch (error) {\n\t\t\tconsole.error(\"[Adyen] Webhook verification error:\", error);\n\t\t\treturn false;\n\t\t}\n\t}\n}\n"],"names":[],"mappings":"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"}