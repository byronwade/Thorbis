module.exports=[139052,a=>{"use strict";var b=a.i(780195),c=a.i(218188),d=a.i(146057),e=a.i(818944),f=a.i(974406),g=a.i(136874),h=a.i(395731);async function i(a,b){let{data:c}=await a.from("company_memberships").select("company_id").eq("user_id",b).eq("status","active").single();if(!c?.company_id)throw new e.ActionError("You must be part of a company",e.ERROR_CODES.AUTH_FORBIDDEN,403);return c.company_id}d.z.object({defaultContactMethod:d.z.enum(["email","sms","phone","app"]).default("email"),allowMarketingEmails:d.z.boolean().default(!0),allowMarketingSms:d.z.boolean().default(!1),requestFeedback:d.z.boolean().default(!0),feedbackDelayHours:d.z.coerce.number().default(24),sendAppointmentReminders:d.z.boolean().default(!0),reminderHoursBefore:d.z.coerce.number().default(24),requireServiceAddress:d.z.boolean().default(!0),autoTagCustomers:d.z.boolean().default(!1)});let j=d.z.object({fieldName:d.z.string().min(1,"Field name is required"),fieldKey:d.z.string().min(1,"Field key is required"),fieldType:d.z.enum(["text","number","date","boolean","select","multi_select","textarea"]),fieldOptions:d.z.string().optional(),isRequired:d.z.boolean().default(!1),showInList:d.z.boolean().default(!1),displayOrder:d.z.coerce.number().default(0),isActive:d.z.boolean().default(!0)});async function k(a){return(0,f.withErrorHandling)(async()=>{let b=await (0,g.createClient)();if(!b)throw new e.ActionError("Database connection failed",e.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:d}}=await b.auth.getUser();(0,f.assertAuthenticated)(d?.id);let h=await i(b,d.id),k=j.parse({fieldName:a.get("fieldName"),fieldKey:a.get("fieldKey"),fieldType:a.get("fieldType"),fieldOptions:a.get("fieldOptions")||void 0,isRequired:"true"===a.get("isRequired"),showInList:"true"===a.get("showInList"),displayOrder:a.get("displayOrder")||"0",isActive:"false"!==a.get("isActive")}),l=null;if(k.fieldOptions)try{l=JSON.parse(k.fieldOptions)}catch(a){throw new e.ActionError("Invalid field options JSON",e.ERROR_CODES.VALIDATION_FAILED)}let{data:m,error:n}=await b.from("customer_custom_fields").insert({company_id:h,field_name:k.fieldName,field_key:k.fieldKey,field_type:k.fieldType,field_options:l,is_required:k.isRequired,show_in_list:k.showInList,display_order:k.displayOrder,is_active:k.isActive}).select("id").single();if(n)throw new e.ActionError(e.ERROR_MESSAGES.operationFailed("create custom field"),e.ERROR_CODES.DB_QUERY_ERROR);return(0,c.revalidatePath)("/dashboard/settings/customers/custom-fields"),m.id})}async function l(a,b){return(0,f.withErrorHandling)(async()=>{let d=await (0,g.createClient)();if(!d)throw new e.ActionError("Database connection failed",e.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:h}}=await d.auth.getUser();(0,f.assertAuthenticated)(h?.id);let k=await i(d,h.id),l=j.parse({fieldName:b.get("fieldName"),fieldKey:b.get("fieldKey"),fieldType:b.get("fieldType"),fieldOptions:b.get("fieldOptions")||void 0,isRequired:"true"===b.get("isRequired"),showInList:"true"===b.get("showInList"),displayOrder:b.get("displayOrder")||"0",isActive:"false"!==b.get("isActive")}),m=null;if(l.fieldOptions)try{m=JSON.parse(l.fieldOptions)}catch(a){throw new e.ActionError("Invalid field options JSON",e.ERROR_CODES.VALIDATION_FAILED)}let{error:n}=await d.from("customer_custom_fields").update({field_name:l.fieldName,field_key:l.fieldKey,field_type:l.fieldType,field_options:m,is_required:l.isRequired,show_in_list:l.showInList,display_order:l.displayOrder,is_active:l.isActive}).eq("id",a).eq("company_id",k);if(n)throw new e.ActionError(e.ERROR_MESSAGES.operationFailed("update custom field"),e.ERROR_CODES.DB_QUERY_ERROR);(0,c.revalidatePath)("/dashboard/settings/customers/custom-fields")})}async function m(a){return(0,f.withErrorHandling)(async()=>{let b=await (0,g.createClient)();if(!b)throw new e.ActionError("Database connection failed",e.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:d}}=await b.auth.getUser();(0,f.assertAuthenticated)(d?.id);let h=await i(b,d.id),{error:j}=await b.from("customer_custom_fields").delete().eq("id",a).eq("company_id",h);if(j)throw new e.ActionError(e.ERROR_MESSAGES.operationFailed("delete custom field"),e.ERROR_CODES.DB_QUERY_ERROR);(0,c.revalidatePath)("/dashboard/settings/customers/custom-fields")})}async function n(){return(0,f.withErrorHandling)(async()=>{let a=await (0,g.createClient)();if(!a)throw new e.ActionError("Database connection failed",e.ERROR_CODES.DB_CONNECTION_ERROR);let{data:{user:b}}=await a.auth.getUser();(0,f.assertAuthenticated)(b?.id);let c=await i(a,b.id),{data:d,error:h}=await a.from("customer_custom_fields").select("*").eq("company_id",c).order("display_order",{ascending:!0}).limit(100);if(h)throw new e.ActionError(e.ERROR_MESSAGES.operationFailed("fetch custom fields"),e.ERROR_CODES.DB_QUERY_ERROR);return d||[]})}d.z.object({loyaltyEnabled:d.z.boolean().default(!1),programName:d.z.string().default("Loyalty Rewards"),pointsPerDollarSpent:d.z.coerce.number().default(1),pointsPerReferral:d.z.coerce.number().default(100),pointsExpiryDays:d.z.coerce.number().optional(),rewardTiers:d.z.string().optional(),autoApplyRewards:d.z.boolean().default(!1),notifyOnPointsEarned:d.z.boolean().default(!0)}),d.z.object({dataRetentionYears:d.z.coerce.number().default(7),autoDeleteInactiveCustomers:d.z.boolean().default(!1),inactiveThresholdYears:d.z.coerce.number().default(3),requireMarketingConsent:d.z.boolean().default(!0),requireDataProcessingConsent:d.z.boolean().default(!0),privacyPolicyUrl:d.z.string().url().optional().or(d.z.literal("")),termsOfServiceUrl:d.z.string().url().optional().or(d.z.literal("")),enableRightToDeletion:d.z.boolean().default(!0),enableDataExport:d.z.boolean().default(!0)}),d.z.object({portalEnabled:d.z.boolean().default(!1),requireAccountApproval:d.z.boolean().default(!1),allowBooking:d.z.boolean().default(!0),allowInvoicePayment:d.z.boolean().default(!0),allowEstimateApproval:d.z.boolean().default(!0),showServiceHistory:d.z.boolean().default(!0),showInvoices:d.z.boolean().default(!0),showEstimates:d.z.boolean().default(!0),allowMessaging:d.z.boolean().default(!0),portalLogoUrl:d.z.string().optional(),primaryColor:d.z.string().regex(/^#[0-9A-F]{6}$/i).default("#3b82f6"),welcomeMessage:d.z.string().optional(),notifyOnNewInvoice:d.z.boolean().default(!0),notifyOnNewEstimate:d.z.boolean().default(!0),notifyOnAppointment:d.z.boolean().default(!0)}),d.z.object({requirePhone:d.z.boolean().default(!0),requireEmail:d.z.boolean().default(!0),requireAddress:d.z.boolean().default(!0),requirePropertyType:d.z.boolean().default(!1),customQuestions:d.z.string().optional(),trackLeadSource:d.z.boolean().default(!0),requireLeadSource:d.z.boolean().default(!1),autoAssignTechnician:d.z.boolean().default(!1),autoCreateJob:d.z.boolean().default(!1),sendWelcomeEmail:d.z.boolean().default(!0),welcomeEmailTemplateId:d.z.string().optional()}),(0,h.ensureServerEntryExports)([k,l,m,n]),(0,b.registerServerReference)(k,"40c1d6594218b74badc7a64a5c2bc088a1c0a2115d",null),(0,b.registerServerReference)(l,"60b47a861ad12a1166adefeeea562df6beb10df9c4",null),(0,b.registerServerReference)(m,"40bf179578be4462c8da4194511f34c3b99d4c19c9",null),(0,b.registerServerReference)(n,"0061c516ac6bf1356785ce988d98aebd0d07d60110",null),a.s(["createCustomField",()=>k,"deleteCustomField",()=>m,"getCustomFields",()=>n,"updateCustomField",()=>l])}];

//# sourceMappingURL=apps_web_src_actions_settings_customers_ts_4d94a7fa._.js.map