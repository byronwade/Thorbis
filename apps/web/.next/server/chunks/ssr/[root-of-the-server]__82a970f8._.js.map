{"version":3,"sources":["../../../../../../apps/web/src/lib/email/pre-send-checks.ts","../../../../../../apps/web/src/lib/security/rate-limit.ts","../../../../../../apps/web/src/lib/services/geocoding.ts","../../../../../../apps/web/src/lib/search/full-text-search.ts"],"sourcesContent":["import { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\n/**\n * Pre-Send Email Deliverability Checks\n *\n * Comprehensive checks before sending any email:\n * 1. Suppression list check (bounces, complaints, unsubscribes)\n * 2. Domain verification status\n * 3. Content spam score analysis\n * 4. Reputation check\n * 5. Rate/volume considerations for warm-up\n */\n\nexport interface PreSendCheckResult {\n\tallowed: boolean;\n\twarnings: string[];\n\terrors: string[];\n\tsuggestions: string[];\n\tspamScore?: number;\n\trecipientStatus?: {\n\t\temail: string;\n\t\tsuppressed: boolean;\n\t\treason?: string;\n\t}[];\n}\n\n// Spam trigger words and patterns\nconst SPAM_TRIGGERS = {\n\turgency: [\n\t\t\"act now\",\n\t\t\"limited time\",\n\t\t\"urgent\",\n\t\t\"immediate\",\n\t\t\"expires\",\n\t\t\"hurry\",\n\t\t\"don't miss\",\n\t\t\"last chance\",\n\t\t\"final notice\",\n\t\t\"deadline\",\n\t],\n\tmoney: [\n\t\t\"free\",\n\t\t\"$$$\",\n\t\t\"cash\",\n\t\t\"discount\",\n\t\t\"save big\",\n\t\t\"best price\",\n\t\t\"cheap\",\n\t\t\"bargain\",\n\t\t\"bonus\",\n\t\t\"prize\",\n\t\t\"winner\",\n\t\t\"congratulations\",\n\t],\n\tsuspicious: [\n\t\t\"click here\",\n\t\t\"click below\",\n\t\t\"buy now\",\n\t\t\"order now\",\n\t\t\"subscribe now\",\n\t\t\"sign up free\",\n\t\t\"no obligation\",\n\t\t\"risk free\",\n\t\t\"100% free\",\n\t\t\"act immediately\",\n\t],\n\tformatting: [\n\t\t\"ALL CAPS WORDS\",\n\t\t\"!!!\",\n\t\t\"???\",\n\t\t\"$$$\",\n\t\t\"***\",\n\t\t\"###\",\n\t],\n};\n\n// Weight multipliers for spam scoring\nconst SPAM_WEIGHTS = {\n\turgency: 2,\n\tmoney: 3,\n\tsuspicious: 4,\n\tformatting: 1.5,\n\texcessiveLinks: 5,\n\tnoUnsubscribe: 3,\n\tshortContent: 2,\n\timageHeavy: 3,\n};\n\n/**\n * Check if recipient is on suppression list (bounces, complaints, unsubscribes)\n */\nexport async function checkSuppressionList(\n\tcompanyId: string,\n\trecipientEmails: string[]\n): Promise<Map<string, { suppressed: boolean; reason?: string; suppressedAt?: string }>> {\n\tconst supabase = await createServiceSupabaseClient();\n\tconst results = new Map<string, { suppressed: boolean; reason?: string; suppressedAt?: string }>();\n\n\t// Initialize all as not suppressed\n\tfor (const email of recipientEmails) {\n\t\tresults.set(email.toLowerCase(), { suppressed: false });\n\t}\n\n\t// Check suppression list\n\tconst { data: suppressions } = await supabase\n\t\t.from(\"email_suppressions\")\n\t\t.select(\"email, reason, created_at\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.in(\"email\", recipientEmails.map((e) => e.toLowerCase()));\n\n\tif (suppressions) {\n\t\tfor (const suppression of suppressions) {\n\t\t\tresults.set(suppression.email, {\n\t\t\t\tsuppressed: true,\n\t\t\t\treason: suppression.reason,\n\t\t\t\tsuppressedAt: suppression.created_at,\n\t\t\t});\n\t\t}\n\t}\n\n\t// Also check global hard bounces (cross-company)\n\tconst { data: globalBounces } = await supabase\n\t\t.from(\"email_global_bounces\")\n\t\t.select(\"email, bounce_type, created_at\")\n\t\t.in(\"email\", recipientEmails.map((e) => e.toLowerCase()))\n\t\t.eq(\"bounce_type\", \"hard\");\n\n\tif (globalBounces) {\n\t\tfor (const bounce of globalBounces) {\n\t\t\tconst existing = results.get(bounce.email);\n\t\t\tif (!existing?.suppressed) {\n\t\t\t\tresults.set(bounce.email, {\n\t\t\t\t\tsuppressed: true,\n\t\t\t\t\treason: `Global hard bounce: ${bounce.bounce_type}`,\n\t\t\t\t\tsuppressedAt: bounce.created_at,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\treturn results;\n}\n\n/**\n * Calculate spam score for email content\n * Lower is better: 0-30 = good, 30-60 = warning, 60+ = likely spam\n */\nexport function calculateSpamScore(\n\tsubject: string,\n\thtmlContent: string,\n\ttextContent: string,\n\thasUnsubscribeLink: boolean\n): { score: number; issues: string[] } {\n\tlet score = 0;\n\tconst issues: string[] = [];\n\n\tconst fullText = `${subject} ${textContent}`.toLowerCase();\n\tconst htmlLower = htmlContent.toLowerCase();\n\n\t// Check spam trigger words\n\tfor (const [category, words] of Object.entries(SPAM_TRIGGERS)) {\n\t\tconst weight = SPAM_WEIGHTS[category as keyof typeof SPAM_WEIGHTS] || 1;\n\t\tfor (const word of words) {\n\t\t\tconst regex = new RegExp(word.toLowerCase(), \"gi\");\n\t\t\tconst matches = fullText.match(regex);\n\t\t\tif (matches) {\n\t\t\t\tscore += matches.length * weight;\n\t\t\t\tif (matches.length > 1) {\n\t\t\t\t\tissues.push(`Contains \"${word}\" ${matches.length} times`);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Check for ALL CAPS in subject\n\tconst capsWords = subject.split(\" \").filter((w) => w.length > 3 && w === w.toUpperCase());\n\tif (capsWords.length > 0) {\n\t\tscore += capsWords.length * 3;\n\t\tissues.push(`Subject contains ${capsWords.length} ALL CAPS words`);\n\t}\n\n\t// Check excessive punctuation\n\tconst exclamations = (subject.match(/!/g) || []).length;\n\tif (exclamations > 1) {\n\t\tscore += exclamations * 2;\n\t\tissues.push(`Excessive exclamation marks in subject (${exclamations})`);\n\t}\n\n\t// Check link density\n\tconst links = (htmlLower.match(/<a\\s/gi) || []).length;\n\tconst wordCount = textContent.split(/\\s+/).length;\n\tif (wordCount > 0 && links / wordCount > 0.1) {\n\t\tscore += SPAM_WEIGHTS.excessiveLinks;\n\t\tissues.push(`High link density (${links} links in ${wordCount} words)`);\n\t}\n\n\t// Check image-to-text ratio\n\tconst images = (htmlLower.match(/<img\\s/gi) || []).length;\n\tif (images > 0 && textContent.length < 200) {\n\t\tscore += SPAM_WEIGHTS.imageHeavy;\n\t\tissues.push(\"Image-heavy email with little text\");\n\t}\n\n\t// Check for unsubscribe link\n\tif (!hasUnsubscribeLink) {\n\t\tscore += SPAM_WEIGHTS.noUnsubscribe;\n\t\tissues.push(\"Missing unsubscribe link (required for marketing emails)\");\n\t}\n\n\t// Check content length (very short emails look suspicious)\n\tif (textContent.length < 50) {\n\t\tscore += SPAM_WEIGHTS.shortContent;\n\t\tissues.push(\"Very short email content\");\n\t}\n\n\t// Check for suspicious patterns\n\tif (htmlLower.includes(\"display:none\") || htmlLower.includes(\"font-size:0\")) {\n\t\tscore += 10;\n\t\tissues.push(\"Contains hidden text (spam technique)\");\n\t}\n\n\t// Check for deceptive link text\n\tconst deceptiveLinkPattern = /<a[^>]*href=[\"']([^\"']+)[\"'][^>]*>([^<]+)<\\/a>/gi;\n\tlet match;\n\twhile ((match = deceptiveLinkPattern.exec(htmlContent)) !== null) {\n\t\tconst href = match[1].toLowerCase();\n\t\tconst text = match[2].toLowerCase();\n\t\tif (\n\t\t\ttext.includes(\"click here\") ||\n\t\t\ttext.includes(\"click this\") ||\n\t\t\t(text.startsWith(\"http\") && !text.includes(new URL(href).hostname))\n\t\t) {\n\t\t\tscore += 5;\n\t\t\tissues.push(\"Contains deceptive or vague link text\");\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn { score: Math.min(score, 100), issues };\n}\n\n/**\n * Check domain warm-up status and recommend volume\n */\nexport async function checkDomainWarmup(\n\tdomainId: string\n): Promise<{\n\tinWarmup: boolean;\n\tdaysSinceCreation: number;\n\trecommendedDailyLimit: number;\n\tcurrentDaySent: number;\n\tsuggestions: string[];\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data: domain } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"created_at, emails_sent_today, total_emails_sent, warmup_completed\")\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (!domain) {\n\t\treturn {\n\t\t\tinWarmup: true,\n\t\t\tdaysSinceCreation: 0,\n\t\t\trecommendedDailyLimit: 10,\n\t\t\tcurrentDaySent: 0,\n\t\t\tsuggestions: [\"Domain not found\"],\n\t\t};\n\t}\n\n\tconst createdAt = new Date(domain.created_at);\n\tconst now = new Date();\n\tconst daysSinceCreation = Math.floor((now.getTime() - createdAt.getTime()) / (1000 * 60 * 60 * 24));\n\n\t// Warm-up schedule (days -> max emails per day)\n\t// Gradual increase over 4-6 weeks for best deliverability\n\tconst warmupSchedule: Record<number, number> = {\n\t\t0: 20, // Day 0-1: 20 emails\n\t\t2: 50, // Day 2-3: 50 emails\n\t\t4: 100, // Day 4-6: 100 emails\n\t\t7: 200, // Week 2: 200 emails\n\t\t14: 500, // Week 3: 500 emails\n\t\t21: 1000, // Week 4: 1000 emails\n\t\t28: 2500, // Week 5: 2500 emails\n\t\t35: 5000, // Week 6: 5000 emails\n\t\t42: 10000, // Week 7+: 10000 emails\n\t};\n\n\tlet recommendedLimit = 20;\n\tfor (const [day, limit] of Object.entries(warmupSchedule)) {\n\t\tif (daysSinceCreation >= parseInt(day)) {\n\t\t\trecommendedLimit = limit;\n\t\t}\n\t}\n\n\tconst inWarmup = daysSinceCreation < 42 && !domain.warmup_completed;\n\tconst suggestions: string[] = [];\n\n\tif (inWarmup) {\n\t\tsuggestions.push(\n\t\t\t`Domain is in warm-up period (day ${daysSinceCreation}/42). Recommended daily limit: ${recommendedLimit} emails.`\n\t\t);\n\n\t\tif (domain.emails_sent_today >= recommendedLimit * 0.8) {\n\t\t\tsuggestions.push(\n\t\t\t\t\"Approaching daily warm-up limit. Consider spreading sends across multiple days.\"\n\t\t\t);\n\t\t}\n\t}\n\n\treturn {\n\t\tinWarmup,\n\t\tdaysSinceCreation,\n\t\trecommendedDailyLimit: recommendedLimit,\n\t\tcurrentDaySent: domain.emails_sent_today || 0,\n\t\tsuggestions,\n\t};\n}\n\n/**\n * Verify domain is properly configured for sending\n */\nexport async function verifyDomainStatus(\n\tdomainId: string\n): Promise<{\n\tcanSend: boolean;\n\tissues: string[];\n\tdnsStatus: {\n\t\tspf: boolean;\n\t\tdkim: boolean;\n\t\tdmarc: boolean;\n\t};\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data: domain } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"status, is_suspended, sending_enabled, spf_verified, dkim_verified, dmarc_verified\")\n\t\t.eq(\"id\", domainId)\n\t\t.single();\n\n\tif (!domain) {\n\t\treturn {\n\t\t\tcanSend: false,\n\t\t\tissues: [\"Domain not found\"],\n\t\t\tdnsStatus: { spf: false, dkim: false, dmarc: false },\n\t\t};\n\t}\n\n\tconst issues: string[] = [];\n\n\tif (domain.status !== \"verified\") {\n\t\tissues.push(`Domain not verified (status: ${domain.status})`);\n\t}\n\n\tif (domain.is_suspended) {\n\t\tissues.push(\"Domain is suspended\");\n\t}\n\n\tif (!domain.sending_enabled) {\n\t\tissues.push(\"Sending is disabled for this domain\");\n\t}\n\n\tif (!domain.spf_verified) {\n\t\tissues.push(\"SPF record not verified - emails may fail authentication\");\n\t}\n\n\tif (!domain.dkim_verified) {\n\t\tissues.push(\"DKIM not verified - emails may fail authentication\");\n\t}\n\n\tif (!domain.dmarc_verified) {\n\t\tissues.push(\"DMARC not configured - reduces deliverability\");\n\t}\n\n\treturn {\n\t\tcanSend: issues.length === 0,\n\t\tissues,\n\t\tdnsStatus: {\n\t\t\tspf: domain.spf_verified || false,\n\t\t\tdkim: domain.dkim_verified || false,\n\t\t\tdmarc: domain.dmarc_verified || false,\n\t\t},\n\t};\n}\n\n/**\n * Comprehensive pre-send check combining all validations\n */\nexport async function runPreSendChecks(\n\tcompanyId: string,\n\tdomainId: string,\n\trecipientEmails: string[],\n\tsubject: string,\n\thtmlContent: string,\n\ttextContent: string,\n\tisMarketingEmail: boolean = false\n): Promise<PreSendCheckResult> {\n\tconst warnings: string[] = [];\n\tconst errors: string[] = [];\n\tconst suggestions: string[] = [];\n\n\t// 1. Check domain status\n\tconst domainStatus = await verifyDomainStatus(domainId);\n\tif (!domainStatus.canSend) {\n\t\terrors.push(...domainStatus.issues);\n\t} else {\n\t\t// Add warnings for missing DNS records\n\t\tif (!domainStatus.dnsStatus.dmarc) {\n\t\t\twarnings.push(\"DMARC not configured - consider adding for better deliverability\");\n\t\t}\n\t}\n\n\t// 2. Check suppression list\n\tconst suppressions = await checkSuppressionList(companyId, recipientEmails);\n\tconst recipientStatus: PreSendCheckResult[\"recipientStatus\"] = [];\n\tlet suppressedCount = 0;\n\n\tfor (const [email, status] of suppressions) {\n\t\trecipientStatus.push({\n\t\t\temail,\n\t\t\tsuppressed: status.suppressed,\n\t\t\treason: status.reason,\n\t\t});\n\t\tif (status.suppressed) {\n\t\t\tsuppressedCount++;\n\t\t}\n\t}\n\n\tif (suppressedCount > 0) {\n\t\twarnings.push(\n\t\t\t`${suppressedCount} recipient(s) on suppression list and will be skipped`\n\t\t);\n\t}\n\n\tif (suppressedCount === recipientEmails.length) {\n\t\terrors.push(\"All recipients are on suppression list - no emails will be sent\");\n\t}\n\n\t// 3. Calculate spam score\n\tconst hasUnsubscribe =\n\t\thtmlContent.includes(\"unsubscribe\") ||\n\t\thtmlContent.includes(\"List-Unsubscribe\");\n\tconst spamAnalysis = calculateSpamScore(\n\t\tsubject,\n\t\thtmlContent,\n\t\ttextContent,\n\t\thasUnsubscribe || !isMarketingEmail\n\t);\n\n\tif (spamAnalysis.score >= 60) {\n\t\terrors.push(\n\t\t\t`High spam score (${spamAnalysis.score}/100) - email likely to be filtered`\n\t\t);\n\t\terrors.push(...spamAnalysis.issues);\n\t} else if (spamAnalysis.score >= 30) {\n\t\twarnings.push(\n\t\t\t`Moderate spam score (${spamAnalysis.score}/100) - consider improvements`\n\t\t);\n\t\twarnings.push(...spamAnalysis.issues);\n\t}\n\n\t// 4. Check warm-up status\n\tconst warmupStatus = await checkDomainWarmup(domainId);\n\tif (warmupStatus.inWarmup) {\n\t\tsuggestions.push(...warmupStatus.suggestions);\n\n\t\tconst activeRecipients = recipientEmails.length - suppressedCount;\n\t\tconst remainingCapacity =\n\t\t\twarmupStatus.recommendedDailyLimit - warmupStatus.currentDaySent;\n\n\t\tif (activeRecipients > remainingCapacity) {\n\t\t\twarnings.push(\n\t\t\t\t`Sending ${activeRecipients} emails exceeds warm-up limit (${remainingCapacity} remaining today). ` +\n\t\t\t\t\t`Consider sending over multiple days.`\n\t\t\t);\n\t\t}\n\t}\n\n\t// 5. Content-specific suggestions\n\tif (!htmlContent.includes(\"<!DOCTYPE\") && !htmlContent.includes(\"<html\")) {\n\t\tsuggestions.push(\n\t\t\t\"Consider using proper HTML structure with DOCTYPE for better rendering\"\n\t\t);\n\t}\n\n\tif (textContent.length < 100) {\n\t\tsuggestions.push(\n\t\t\t\"Consider adding more text content - very short emails may look suspicious\"\n\t\t);\n\t}\n\n\tif (isMarketingEmail && !hasUnsubscribe) {\n\t\terrors.push(\n\t\t\t\"Marketing emails MUST include an unsubscribe link (CAN-SPAM requirement)\"\n\t\t);\n\t}\n\n\t// Check for personalization\n\tif (\n\t\t!htmlContent.includes(\"{{\") &&\n\t\t!htmlContent.includes(\"{name}\") &&\n\t\t!subject.includes(\"{{\")\n\t) {\n\t\tsuggestions.push(\n\t\t\t\"Consider adding personalization (recipient name, company) for better engagement\"\n\t\t);\n\t}\n\n\treturn {\n\t\tallowed: errors.length === 0,\n\t\twarnings,\n\t\terrors,\n\t\tsuggestions,\n\t\tspamScore: spamAnalysis.score,\n\t\trecipientStatus,\n\t};\n}\n\n/**\n * Add email to suppression list\n */\nexport async function addToSuppressionList(\n\tcompanyId: string,\n\temail: string,\n\treason: \"bounce\" | \"complaint\" | \"unsubscribe\" | \"manual\",\n\tdetails?: string\n): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase.from(\"email_suppressions\").upsert(\n\t\t{\n\t\t\tcompany_id: companyId,\n\t\t\temail: email.toLowerCase(),\n\t\t\treason,\n\t\t\tdetails,\n\t\t\tcreated_at: new Date().toISOString(),\n\t\t},\n\t\t{\n\t\t\tonConflict: \"company_id,email\",\n\t\t}\n\t);\n\n\tif (error) {\n\t\tconsole.error(\"Error adding to suppression list:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Add email to global bounce list (cross-company hard bounces)\n */\nexport async function addToGlobalBounceList(\n\temail: string,\n\tbounceType: \"hard\" | \"soft\",\n\tbounceReason?: string\n): Promise<{ success: boolean; error?: string }> {\n\t// Only track hard bounces globally\n\tif (bounceType !== \"hard\") {\n\t\treturn { success: true };\n\t}\n\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase.from(\"email_global_bounces\").upsert(\n\t\t{\n\t\t\temail: email.toLowerCase(),\n\t\t\tbounce_type: bounceType,\n\t\t\tbounce_reason: bounceReason,\n\t\t\tbounce_count: 1,\n\t\t\tlast_bounce_at: new Date().toISOString(),\n\t\t\tcreated_at: new Date().toISOString(),\n\t\t},\n\t\t{\n\t\t\tonConflict: \"email\",\n\t\t}\n\t);\n\n\tif (error) {\n\t\tconsole.error(\"Error adding to global bounce list:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Remove email from suppression list (for manual review cases)\n */\nexport async function removeFromSuppressionList(\n\tcompanyId: string,\n\temail: string\n): Promise<{ success: boolean; error?: string }> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { error } = await supabase\n\t\t.from(\"email_suppressions\")\n\t\t.delete()\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"email\", email.toLowerCase());\n\n\tif (error) {\n\t\tconsole.error(\"Error removing from suppression list:\", error);\n\t\treturn { success: false, error: error.message };\n\t}\n\n\treturn { success: true };\n}\n\n/**\n * Get suppression list for a company\n */\nexport async function getSuppressionList(\n\tcompanyId: string,\n\tlimit: number = 100,\n\toffset: number = 0\n): Promise<{\n\tdata: Array<{\n\t\temail: string;\n\t\treason: string;\n\t\tdetails?: string;\n\t\tcreated_at: string;\n\t}>;\n\ttotal: number;\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tconst { data, count, error } = await supabase\n\t\t.from(\"email_suppressions\")\n\t\t.select(\"email, reason, details, created_at\", { count: \"exact\" })\n\t\t.eq(\"company_id\", companyId)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.range(offset, offset + limit - 1);\n\n\tif (error) {\n\t\tconsole.error(\"Error fetching suppression list:\", error);\n\t\treturn { data: [], total: 0 };\n\t}\n\n\treturn { data: data || [], total: count || 0 };\n}\n","/**\n * Rate Limiting Utilities\n *\n * Provides rate limiting for authentication and API endpoints to prevent:\n * - Brute force password attacks\n * - Account enumeration\n * - Email spam/flooding\n * - DDoS attacks\n *\n * Implementation:\n * - Uses in-memory LRU cache for development/small scale\n * - Can be easily swapped with Redis/Upstash for production\n * - Sliding window algorithm for accurate rate limiting\n * - Per-identifier tracking (email, IP, user ID)\n */\n\n// Simple in-memory rate limiter using LRU cache\n// For production, replace with @upstash/ratelimit + @upstash/redis\nclass InMemoryRateLimiter {\n\tprivate requests: Map<\n\t\tstring,\n\t\t{ count: number; resetAt: number; requests: number[] }\n\t>;\n\tprivate readonly maxRequests: number;\n\tprivate readonly windowMs: number;\n\n\tconstructor(maxRequests: number, windowMs: number) {\n\t\tthis.requests = new Map();\n\t\tthis.maxRequests = maxRequests;\n\t\tthis.windowMs = windowMs;\n\n\t\t// Cleanup old entries every minute\n\t\tsetInterval(() => this.cleanup(), 60_000);\n\t}\n\n\tasync limit(identifier: string): Promise<{\n\t\tsuccess: boolean;\n\t\tlimit: number;\n\t\tremaining: number;\n\t\treset: number;\n\t}> {\n\t\tconst now = Date.now();\n\t\tconst key = identifier;\n\n\t\tlet record = this.requests.get(key);\n\n\t\t// Initialize if doesn't exist\n\t\tif (!record) {\n\t\t\trecord = {\n\t\t\t\tcount: 0,\n\t\t\t\tresetAt: now + this.windowMs,\n\t\t\t\trequests: [],\n\t\t\t};\n\t\t\tthis.requests.set(key, record);\n\t\t}\n\n\t\t// Remove requests outside the sliding window\n\t\trecord.requests = record.requests.filter(\n\t\t\t(timestamp) => timestamp > now - this.windowMs,\n\t\t);\n\n\t\t// Check if limit exceeded\n\t\tif (record.requests.length >= this.maxRequests) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tlimit: this.maxRequests,\n\t\t\t\tremaining: 0,\n\t\t\t\treset: Math.min(...record.requests) + this.windowMs,\n\t\t\t};\n\t\t}\n\n\t\t// Add new request\n\t\trecord.requests.push(now);\n\t\trecord.count = record.requests.length;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tlimit: this.maxRequests,\n\t\t\tremaining: this.maxRequests - record.count,\n\t\t\treset: now + this.windowMs,\n\t\t};\n\t}\n\n\tprivate cleanup() {\n\t\tconst now = Date.now();\n\t\tfor (const [key, record] of this.requests.entries()) {\n\t\t\trecord.requests = record.requests.filter(\n\t\t\t\t(timestamp) => timestamp > now - this.windowMs,\n\t\t\t);\n\t\t\tif (record.requests.length === 0) {\n\t\t\t\tthis.requests.delete(key);\n\t\t\t}\n\t\t}\n\t}\n\n\treset(identifier: string) {\n\t\tthis.requests.delete(identifier);\n\t}\n\n\tclear() {\n\t\tthis.requests.clear();\n\t}\n}\n\n// Rate limiter instances for different operations\nconst authRateLimiterInstance = new InMemoryRateLimiter(\n\t5, // 5 requests\n\t15 * 60 * 1000, // per 15 minutes\n);\n\nconst apiRateLimiterInstance = new InMemoryRateLimiter(\n\t100, // 100 requests\n\t60 * 1000, // per 1 minute\n);\n\nconst passwordResetRateLimiterInstance = new InMemoryRateLimiter(\n\t3, // 3 requests\n\t60 * 60 * 1000, // per 1 hour\n);\n\n/**\n * Auth Rate Limiter\n *\n * Use for: Sign in, Sign up, OAuth\n * Limit: 5 requests per 15 minutes per identifier\n */\nexport const authRateLimiter = {\n\tlimit: (identifier: string) => authRateLimiterInstance.limit(identifier),\n\treset: (identifier: string) => authRateLimiterInstance.reset(identifier),\n};\n\n/**\n * API Rate Limiter\n *\n * Use for: General API endpoints\n * Limit: 100 requests per minute per identifier\n */\nconst apiRateLimiter = {\n\tlimit: (identifier: string) => apiRateLimiterInstance.limit(identifier),\n\treset: (identifier: string) => apiRateLimiterInstance.reset(identifier),\n};\n\n/**\n * Password Reset Rate Limiter\n *\n * Use for: Password reset requests\n * Limit: 3 requests per hour per identifier\n */\nexport const passwordResetRateLimiter = {\n\tlimit: (identifier: string) =>\n\t\tpasswordResetRateLimiterInstance.limit(identifier),\n\treset: (identifier: string) =>\n\t\tpasswordResetRateLimiterInstance.reset(identifier),\n};\n\n/**\n * Rate Limit Error\n */\nexport class RateLimitError extends Error {\n\tconstructor(\n\t\tmessage: string,\n\t\tpublic limit: number,\n\t\tpublic remaining: number,\n\t\tpublic reset: number,\n\t) {\n\t\tsuper(message);\n\t\tthis.name = \"RateLimitError\";\n\t}\n}\n\n/**\n * Check Rate Limit\n *\n * Throws RateLimitError if rate limit exceeded.\n *\n * @param identifier - Unique identifier (email, IP, user ID)\n * @param limiter - Rate limiter instance to use\n */\nexport async function checkRateLimit(\n\tidentifier: string,\n\tlimiter: typeof authRateLimiter = apiRateLimiter,\n): Promise<void> {\n\tconst { success, limit, remaining, reset } = await limiter.limit(identifier);\n\n\tif (!success) {\n\t\tconst resetDate = new Date(reset);\n\t\tthrow new RateLimitError(\n\t\t\t`Too many requests. Please try again after ${resetDate.toLocaleTimeString()}.`,\n\t\t\tlimit,\n\t\t\tremaining,\n\t\t\treset,\n\t\t);\n\t}\n}\n\n/**\n * Get Client IP Address\n *\n * Extracts IP from request headers for rate limiting.\n * Supports various proxy headers.\n */\nfunction getClientIP(request: Request): string {\n\tconst headers = new Headers(request.headers);\n\n\t// Check common proxy headers\n\tconst forwarded = headers.get(\"x-forwarded-for\");\n\tif (forwarded) {\n\t\treturn forwarded.split(\",\")[0].trim();\n\t}\n\n\tconst realIP = headers.get(\"x-real-ip\");\n\tif (realIP) {\n\t\treturn realIP;\n\t}\n\n\tconst cfIP = headers.get(\"cf-connecting-ip\"); // Cloudflare\n\tif (cfIP) {\n\t\treturn cfIP;\n\t}\n\n\t// Fallback to unknown\n\treturn \"unknown\";\n}\n\n/**\n * Production Setup Instructions\n *\n * For production, replace in-memory limiter with Redis:\n *\n * 1. Install dependencies:\n *    ```bash\n *    pnpm add @upstash/ratelimit @upstash/redis\n *    ```\n *\n * 2. Update this file:\n *    ```typescript\n *    import { Ratelimit } from \"@upstash/ratelimit\";\n *    import { Redis } from \"@upstash/redis\";\n *\n *    const redis = new Redis({\n *      url: process.env.UPSTASH_REDIS_REST_URL!,\n *      token: process.env.UPSTASH_REDIS_REST_TOKEN!,\n *    });\n *\n *    export const authRateLimiter = new Ratelimit({\n *      redis,\n *      limiter: Ratelimit.slidingWindow(5, \"15 m\"),\n *      analytics: true,\n *      prefix: \"ratelimit:auth\",\n *    });\n *    ```\n *\n * 3. Add environment variables:\n *    ```\n *    UPSTASH_REDIS_REST_URL=https://...\n *    UPSTASH_REDIS_REST_TOKEN=...\n *    ```\n */\n","/**\n * Google Geocoding API Utility\n *\n * Automatically acquires GPS coordinates (lat/lon) from addresses\n * Used during customer creation, property creation, and company onboarding\n */\n\ntype GeocodeResult = {\n\tlat: number;\n\tlon: number;\n\tformattedAddress?: string;\n};\n\ntype GeocodeResponse = {\n\tsuccess: boolean;\n\tcoordinates?: GeocodeResult;\n\terror?: string;\n};\n\n/**\n * Geocode an address to get GPS coordinates\n *\n * @param address - Street address\n * @param city - City\n * @param state - State\n * @param zipCode - ZIP code\n * @param country - Country (defaults to \"USA\")\n * @returns Coordinates {lat, lon} or null if geocoding fails\n */\nasync function geocodeAddress(\n\taddress: string,\n\tcity: string,\n\tstate: string,\n\tzipCode: string,\n\tcountry = \"USA\",\n): Promise<GeocodeResponse> {\n\ttry {\n\t\t// Build full address string\n\t\tconst fullAddress = `${address}, ${city}, ${state} ${zipCode}, ${country}`;\n\n\t\t// Get API key from environment\n\t\tconst apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY;\n\n\t\tif (!apiKey) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Geocoding API key not configured\",\n\t\t\t};\n\t\t}\n\n\t\t// Call Google Geocoding API\n\t\tconst encodedAddress = encodeURIComponent(fullAddress);\n\t\tconst url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodedAddress}&key=${apiKey}`;\n\n\t\tconst response = await fetch(url);\n\n\t\tif (!response.ok) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Geocoding failed with status ${response.status}`,\n\t\t\t};\n\t\t}\n\n\t\tconst data = await response.json();\n\n\t\t// Check if we got results\n\t\tif (data.status === \"OK\" && data.results && data.results.length > 0) {\n\t\t\tconst location = data.results[0].geometry.location;\n\t\t\tconst formattedAddress = data.results[0].formatted_address;\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tcoordinates: {\n\t\t\t\t\tlat: location.lat,\n\t\t\t\t\tlon: location.lng,\n\t\t\t\t\tformattedAddress,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\t\tif (data.status === \"ZERO_RESULTS\") {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Address not found\",\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: data.error_message || `Geocoding failed: ${data.status}`,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown geocoding error\",\n\t\t};\n\t}\n}\n\n/**\n * Geocode an address silently in the background\n * Does not throw errors - returns null on failure\n *\n * Useful for non-critical geocoding where we don't want to block\n * the main operation if geocoding fails\n */\nexport async function geocodeAddressSilent(\n\taddress: string,\n\tcity: string,\n\tstate: string,\n\tzipCode: string,\n\tcountry = \"USA\",\n): Promise<GeocodeResult | null> {\n\ttry {\n\t\tconst result = await geocodeAddress(address, city, state, zipCode, country);\n\t\treturn result.success && result.coordinates ? result.coordinates : null;\n\t} catch (_error) {\n\t\treturn null;\n\t}\n}\n","/**\n * Full-Text Search Utilities\n *\n * Provides enterprise-grade PostgreSQL full-text search with:\n * - Weighted ranking (ts_rank) for best match results\n * - Multi-field search across all relevant columns\n * - Fuzzy matching with pg_trgm for typo tolerance\n * - Company-scoped security (RLS enforced)\n *\n * Performance:\n * - Uses GIN indexes for sub-millisecond search\n * - Searches millions of records efficiently\n * - Returns top 50 results by default (configurable)\n *\n * Search Features:\n * - Multi-word queries: \"john plumber\" matches both words\n * - Phrase search: Use quotes for exact phrases\n * - Fuzzy matching: Handles typos and variations\n * - Weighted fields: Name matches rank higher than notes\n */\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\n\n/**\n * Search result with ranking score\n */\nexport type SearchResult<T> = T & {\n\tsearch_rank?: number;\n\tsearch_similarity?: number;\n};\n\n/**\n * Search options for customization\n */\nexport type SearchOptions = {\n\tlimit?: number;\n\toffset?: number;\n\tminSimilarity?: number; // 0-1, default 0.3\n\tuseFullTextSearch?: boolean; // Default true\n\tuseFuzzyMatch?: boolean; // Default true\n\torderBy?: string; // Additional ordering after rank\n};\n\n/**\n * Search customers with full-text search and ranking\n *\n * Searches across: first_name, last_name, display_name, email, phone, company_name, address\n * Returns results ordered by relevance (best matches first)\n *\n * @example\n * const results = await searchCustomersFullText(supabase, companyId, \"john plumber\");\n * // Returns customers matching \"john\" AND \"plumber\" ranked by relevance\n */\nexport async function searchCustomersFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst {\n\t\tlimit = 50,\n\t\toffset = 0,\n\t\tminSimilarity = 0.3,\n\t\tuseFullTextSearch = true,\n\t\tuseFuzzyMatch = true,\n\t} = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_customers_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search if full-text search not available or fails\n\tconst { data } = await supabase\n\t\t.from(\"customers\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.or(\n\t\t\t`display_name.ilike.%${query}%,email.ilike.%${query}%,phone.ilike.%${query}%,company_name.ilike.%${query}%,address.ilike.%${query}%,city.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"display_name\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search jobs with full-text search and ranking\n *\n * Searches across: job_number, title, description, notes, job_type, status, priority\n * Returns results ordered by relevance\n */\nexport async function searchJobsFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 50, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_jobs_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"jobs\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.or(\n\t\t\t`job_number.ilike.%${query}%,title.ilike.%${query}%,description.ilike.%${query}%,notes.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search properties with full-text search and ranking\n *\n * Searches across: name, address, city, state, zip_code, notes\n * Returns results ordered by relevance\n */\nasync function searchPropertiesFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 50, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_properties_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"properties\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.or(\n\t\t\t`name.ilike.%${query}%,address.ilike.%${query}%,city.ilike.%${query}%,state.ilike.%${query}%,zip_code.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"address\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search price book items with full-text search and ranking\n *\n * Searches across: name, sku, supplier_sku, description, category, subcategory\n * Returns results ordered by relevance\n */\nasync function searchPriceBookItemsFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 100, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\n\t\t\t\"search_price_book_items_ranked\",\n\t\t\t{\n\t\t\t\tcompany_id_param: companyId,\n\t\t\t\tsearch_query: query,\n\t\t\t\tresult_limit: limit,\n\t\t\t\tresult_offset: offset,\n\t\t\t},\n\t\t);\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"price_book_items\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.or(\n\t\t\t`name.ilike.%${query}%,sku.ilike.%${query}%,supplier_sku.ilike.%${query}%,description.ilike.%${query}%,category.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"name\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Search equipment with full-text search and ranking\n *\n * Searches across: equipment_number, name, type, manufacturer, model, serial_number\n * Returns results ordered by relevance\n */\nasync function searchEquipmentFullText(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<SearchResult<any>[]> {\n\tconst { limit = 50, offset = 0, useFullTextSearch = true } = options;\n\n\tif (!searchTerm || searchTerm.trim().length === 0) {\n\t\treturn [];\n\t}\n\n\tconst query = searchTerm.trim();\n\n\t// Use full-text search with ranking\n\tif (useFullTextSearch) {\n\t\tconst { data, error } = await supabase.rpc(\"search_equipment_ranked\", {\n\t\t\tcompany_id_param: companyId,\n\t\t\tsearch_query: query,\n\t\t\tresult_limit: limit,\n\t\t\tresult_offset: offset,\n\t\t});\n\n\t\tif (!error && data) {\n\t\t\treturn data;\n\t\t}\n\t}\n\n\t// Fallback to ILIKE search\n\tconst { data } = await supabase\n\t\t.from(\"equipment\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.or(\n\t\t\t`equipment_number.ilike.%${query}%,name.ilike.%${query}%,type.ilike.%${query}%,manufacturer.ilike.%${query}%,model.ilike.%${query}%,serial_number.ilike.%${query}%`,\n\t\t)\n\t\t.order(\"name\", { ascending: true })\n\t\t.limit(limit)\n\t\t.range(offset, offset + limit - 1);\n\n\treturn data || [];\n}\n\n/**\n * Universal search function - searches across ALL entities\n *\n * Returns combined results from customers, jobs, properties, equipment, etc.\n * Useful for global search functionality\n */\nexport async function searchAllEntities(\n\tsupabase: SupabaseClient,\n\tcompanyId: string,\n\tsearchTerm: string,\n\toptions: SearchOptions = {},\n): Promise<{\n\tcustomers: SearchResult<any>[];\n\tjobs: SearchResult<any>[];\n\tproperties: SearchResult<any>[];\n\tequipment: SearchResult<any>[];\n\tpriceBookItems: SearchResult<any>[];\n}> {\n\tconst defaultLimit = options.limit || 10; // Limit per entity\n\n\tconst [customers, jobs, properties, equipment, priceBookItems] =\n\t\tawait Promise.all([\n\t\t\tsearchCustomersFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchJobsFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchPropertiesFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchEquipmentFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t\tsearchPriceBookItemsFullText(supabase, companyId, searchTerm, {\n\t\t\t\t...options,\n\t\t\t\tlimit: defaultLimit,\n\t\t\t}),\n\t\t]);\n\n\treturn {\n\t\tcustomers,\n\t\tjobs,\n\t\tproperties,\n\t\tequipment,\n\t\tpriceBookItems,\n\t};\n}\n"],"names":[],"mappings":"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"}