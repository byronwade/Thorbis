module.exports=[305145,a=>{"use strict";var b=a.i(780195),c=a.i(869251),d=a.i(136874);async function e(a,b=72,f=1){try{let e=await (0,d.createClient)();if(!e)return null;let{data:g,error:h}=await e.rpc("generate_invoice_payment_token",{p_invoice_id:a,p_expiry_hours:b,p_max_uses:f});if(h||!g||0===g.length)return null;let i=g[0],j=`${c.emailConfig.appUrl}/pay/${a}?token=${i.token}`;return{token:i.token,expiresAt:i.expires_at,paymentLink:j}}catch(a){return null}}async function f(a,b){try{let b=await (0,d.createClient)();if(!b)return{isValid:!1,invoiceId:null,message:"Unable to connect to database"};let{data:c,error:e}=await b.rpc("check_payment_token",{p_token:a});if(e||!c||0===c.length)return{isValid:!1,invoiceId:null,message:"Invalid payment token"};let f=c[0];return{isValid:f.is_valid,invoiceId:f.invoice_id,message:f.message}}catch(a){return{isValid:!1,invoiceId:null,message:"Error validating payment token"}}}async function g(a,b){try{let c=await (0,d.createClient)();if(!c)return!1;let{data:e,error:f}=await c.from("invoice_payment_tokens").select("use_count").eq("token",a).limit(1);if(f||!e||0===e.length)return!1;let g=e[0]?.use_count??0,{error:h}=await c.from("invoice_payment_tokens").update({is_active:!1,used_at:new Date().toISOString(),used_by_ip:b||null,use_count:g+1}).eq("token",a);if(h)return!1;return!0}catch(a){return!1}}async function h(a,b=72,e=1){try{let f=await (0,d.createClient)();if(!f)return{};let g=a.map(async a=>{let{data:d,error:g}=await f.rpc("generate_invoice_payment_token",{p_invoice_id:a,p_expiry_hours:b,p_max_uses:e});if(g||!d||0===d.length)return{invoiceId:a,token:null};let h=d[0],i=`${c.emailConfig.appUrl}/pay/${a}?token=${h.token}`;return{invoiceId:a,token:{token:h.token,expiresAt:h.expires_at,paymentLink:i}}});return(await Promise.all(g)).reduce((a,{invoiceId:b,token:c})=>(c&&(a[b]=c),a),{})}catch(a){return{}}}(0,a.i(395731).ensureServerEntryExports)([e,f,g,h]),(0,b.registerServerReference)(e,"7026bc9768ad3ab0b96efecd8a3b9c44d5e7e57eba",null),(0,b.registerServerReference)(f,"608ae817ddec034f2780624908f1db97356ccd42ef",null),(0,b.registerServerReference)(g,"6048aff7615b24bbed5fff047d510e54bb65e77646",null),(0,b.registerServerReference)(h,"709bb1978cd77dad33a458251234f8c68f743d5f4c",null),a.s(["generatePaymentToken",()=>e,"generatePaymentTokensBatch",()=>h,"markTokenAsUsed",()=>g,"validatePaymentToken",()=>f])},620778,a=>{"use strict";var b=a.i(136874);async function c(a,c){let e=await (0,b.createClient)();if(!e)return null;let{data:f}=await e.from("finance_bank_accounts").select("id").eq("company_id",a).eq("is_active",!0).limit(1);if(!f||0===f.length)return null;let{data:g}=await e.from("company_payment_processors").select("*").eq("company_id",a).eq("status","active").order("created_at",{ascending:!1});if(!g||0===g.length)return null;if(c?.forceProcessor){let a=g.find(a=>a.processor_type===c.forceProcessor);if(a)return d(a)}let h=c?.amount||0,i=c?.channel||"online";if(h>1e6&&g.some(a=>"adyen"===a.processor_type)){let a=g.find(a=>"adyen"===a.processor_type);if(a)return d(a)}if(("card_present"===i||"tap_to_pay"===i)&&g.some(a=>"adyen"===a.processor_type)){let a=g.find(a=>"adyen"===a.processor_type);if(a)return d(a)}if("ach"===i){let a=g.find(a=>"plaid"===a.processor_type);if(a)return d(a);let b=g.find(a=>"profitstars"===a.processor_type);if(b)return d(b)}return d(g[0])}async function d(b){switch(b.processor_type){case"adyen":{let{AdyenProcessor:c}=await a.A(806668);return new c({companyId:b.company_id,accountId:b.adyen_account_id,apiKey:b.adyen_api_key_encrypted,merchantAccount:b.adyen_merchant_account,liveMode:b.adyen_live_mode})}case"plaid":{let{PlaidProcessor:c}=await a.A(250422);return new c({companyId:b.company_id,clientId:b.plaid_client_id,secret:b.plaid_secret_encrypted,environment:b.plaid_environment||"sandbox"})}case"profitstars":{let{ProfitStarsProcessor:c}=await a.A(117002);return new c({companyId:b.company_id,merchantId:b.profitstars_merchant_id,apiKey:b.profitstars_api_key_encrypted,routingNumber:b.profitstars_routing_number})}case"stripe":{let{StripeProcessor:c}=await a.A(662670);return new c({companyId:b.company_id,liveMode:b.adyen_live_mode})}default:return null}}async function e(a,c){let d=await (0,b.createClient)();if(!d)return{score:0,allowed:!1,requiresApproval:!0,reason:"Database unavailable"};let{data:e}=await d.from("payment_trust_scores").select("*").eq("company_id",a).single();if(!e)return{score:50,allowed:!1,requiresApproval:!0,reason:"No trust score found"};let f=Number(e.overall_score),{data:g}=await d.from("company_payment_processors").select("max_payment_amount, requires_approval_above").eq("company_id",a).eq("status","active").single(),h=g?.max_payment_amount||1e5,i=g?.requires_approval_above||5e4,j=h,k=c<=(j=f>=90?h:f>=70?Math.floor(.5*h):f>=50?Math.floor(.25*h):1e4),l=c>i||f<70;return{score:f,allowed:k,requiresApproval:l,reason:k?l?"Payment requires manual approval":void 0:`Payment amount exceeds allowed limit for trust score. Max allowed: $${j/100}`}}async function f(a,c,d){let e=await (0,b.createClient)();if(!e)return;let{data:f}=await e.from("payment_trust_scores").select("*").eq("company_id",a).single();if(!f)return;let g={total_payments_count:(f.total_payments_count||0)+1,total_payments_volume:(f.total_payments_volume||0)+d,last_calculated_at:new Date().toISOString()};c?g.successful_payments_count=(f.successful_payments_count||0)+1:g.failed_payments_count=(f.failed_payments_count||0)+1,d>(f.largest_payment_amount||0)&&(g.largest_payment_amount=d);let h=g.total_payments_count,i=g.successful_payments_count||f.successful_payments_count||0;g.failed_payments_count||f.failed_payments_count;let j=Math.min(100,20*Math.log10((g.total_payments_volume||0)/100+1));g.overall_score=Math.min(100,Math.max(0,.4*(h>0?i/h*100:50)+.3*j+.2*Math.min(100,(f.account_age_days||0)/30*10)+10*!!f.business_verified+5*!!f.bank_account_verified+5*!!f.identity_verified)),g.refund_rate=h>0?(f.refunded_amount||0)/g.total_payments_volume*100:0,await e.from("payment_trust_scores").update(g).eq("company_id",a)}a.s(["calculatePaymentTrustScore",()=>e,"getPaymentProcessor",()=>c,"updateTrustScoreAfterPayment",()=>f])},194125,a=>{"use strict";var b=a.i(249177),c=a.i(933427);let d=new b.Resend(process.env.RESEND_API_KEY);async function e(a){let b=await (0,c.createServiceSupabaseClient)();if(!b)return null;let{data:d}=await b.from("company_email_domains").select("*").eq("company_id",a).eq("status","verified").eq("sending_enabled",!0).eq("is_suspended",!1).order("is_platform_subdomain",{ascending:!0}).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(!d)return null;let e=`${d.subdomain}.${d.domain_name}`;return{id:d.id,domain_name:d.domain_name,subdomain:d.subdomain,full_domain:e,status:d.status,sending_addresses:d.sending_addresses||[],reply_to_email:d.reply_to_email}}async function f(a){let b=await (0,c.createServiceSupabaseClient)();if(!b)return null;let{data:d}=await b.from("company_email_domains").select("domain_name, reply_to_email").eq("company_id",a).eq("is_platform_subdomain",!0).eq("status","verified").maybeSingle();return d?d.reply_to_email?d.reply_to_email:`support@${d.domain_name}`:null}async function g({companyId:b,companyName:c,type:g="notification",to:h,subject:i,html:j,text:k,replyTo:l,attachments:m,communicationId:n}){let o=await e(b);if(!o)throw Error("Company domain not verified. Please verify your email domain in settings before sending emails.");let p=function(a,b,c){let d=a.sending_addresses.find(a=>a.type===b);if(d)return`${c} <${d.email}>`;let e=`${b}@${a.full_domain}`;return`${c} <${e}>`}(o,g,c),q=await f(b),r=l||q||`support@${o.full_domain}`,s=j;if(n){let{addEmailTracking:b}=await a.A(315292);s=b(j,n)}try{let{data:a,error:b}=await d.emails.send({from:p,to:h,subject:i,html:s,text:k,replyTo:r,attachments:m});if(b)throw Error(`Failed to send email: ${b.message}`);return{success:!0,messageId:a?.id}}catch(a){throw console.error("Email send error:",a),a}}a.s(["sendCompanyEmail",()=>g])},37933,a=>a.a(async(b,c)=>{try{var d=a.i(780195),e=a.i(149664),f=a.i(194125),g=a.i(198114),h=a.i(395731),i=b([e,g]);async function j(a){if("platform"===a.category)return await (0,g.sendEmail)({to:a.to,subject:a.subject,template:a.template,templateType:a.templateType,replyTo:a.replyTo,tags:a.tags,fromOverride:"Thorbis <noreply@thorbis.com>"});{let b=await (0,e.render)(a.template);return await (0,f.sendCompanyEmail)({companyId:a.companyId,companyName:a.companyName,type:a.emailType||"notification",to:a.to,subject:a.subject,html:b,replyTo:a.replyTo,communicationId:a.communicationId})}}async function k(a){return j({...a,category:"platform"})}async function l(a){return j({...a,category:"company"})}[e,g]=i.then?(await i)():i,(0,h.ensureServerEntryExports)([k,l]),(0,d.registerServerReference)(k,"408c508c267fcd2e1ff09ec30f3465256e45367723",null),(0,d.registerServerReference)(l,"40b271177f27fa853615b9469b91b83ce9f448c839",null),a.s(["sendCompanyBrandedEmail",()=>l,"sendPlatformEmail",()=>k]),c()}catch(a){c(a)}},!1),492612,a=>a.a(async(b,c)=>{try{var d=a.i(780195),e=a.i(218188),f=a.i(37933),g=a.i(463556),h=a.i(305145),i=a.i(620778),j=a.i(136874),k=a.i(395731),l=b([f]);async function m(b){try{let c,d,{invoiceId:k,token:l,paymentMethod:m,amount:n,paymentDetails:o}=b,p=await (0,h.validatePaymentToken)(l);if(!p.isValid||p.invoiceId!==k)return{success:!1,error:p.message||"Invalid payment token"};let q=await (0,j.createClient)();if(!q)return{success:!1,error:"Unable to connect to database"};let{data:r,error:s}=await q.from("invoices").select(`
        *,
        customer:customers!customer_id(
          id,
          first_name,
          last_name,
          display_name,
          email
        ),
        company:companies!company_id(
          id,
          name,
          email
        )
      `).eq("id",k).single();if(s||!r)return{success:!1,error:"Invoice not found"};if("paid"===r.status)return{success:!1,error:"Invoice has already been paid"};if(n!==r.total_amount)return{success:!1,error:"Payment amount does not match invoice total"};let t="card"===m?"online":"ach",u=await (0,i.getPaymentProcessor)(r.company_id,{amount:n,channel:t});if(!u)return{success:!1,error:"Payment processing is not configured for this company. Please contact the service provider."};{let a=Array.isArray(r.customer)?r.customer[0]:r.customer,b=await u.processPayment({amount:n,currency:"USD",invoiceId:k,customerId:a?.id||r.customer_id,channel:t,metadata:{invoice_number:r.invoice_number,payment_method:m}});if(!b.success)return await (0,i.updateTrustScoreAfterPayment)(r.company_id,!1,n),{success:!1,error:b.error||b.failureMessage||"Payment processing failed"};if("requires_action"===b.status)return{success:!1,error:"Additional authentication required. Please contact support for assistance."};c=b.transactionId||`txn_${Date.now()}`,d=b.processorMetadata,await (0,i.updateTrustScoreAfterPayment)(r.company_id,!0,n)}let{error:v}=await q.from("invoices").update({status:"paid",paid_at:new Date().toISOString(),payment_method:m,updated_at:new Date().toISOString()}).eq("id",k);if(v)return{success:!1,error:"Payment processed but failed to update invoice. Please contact support."};await q.from("payment_processor_transactions").insert({company_id:r.company_id,invoice_id:k,processor_type:u?"adyen":"manual",transaction_id:c,amount:n,currency:"USD",status:"success",channel:t,metadata:{payment_method:m,processor_response:d,simulated:!u}}),await (0,h.markTokenAsUsed)(l);let w=Array.isArray(r.customer)?r.customer[0]:r.customer,x=Array.isArray(r.company)?r.company[0]:r.company;if(w?.email&&x)try{let b=(await a.A(498156)).default,d=w.display_name||`${w.first_name} ${w.last_name}`.trim()||"Customer",e=`$${(n/100).toFixed(2)}`,h="card"===m?"Credit Card":"ACH Bank Transfer",i=new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});await (0,f.sendCompanyBrandedEmail)({companyId:x.id,companyName:x.name,to:w.email,subject:`Payment Received - Invoice ${r.invoice_number}`,template:b({customerName:d,invoiceNumber:r.invoice_number,paymentAmount:e,paymentMethod:h,paymentDate:i,receiptUrl:`http://localhost:3000/portal/invoices/${k}/receipt?token=${l}`,company:{companyName:x.name,supportEmail:x.email}}),templateType:g.EmailTemplate.PAYMENT_RECEIVED,emailType:"notification",tags:[{name:"invoice_id",value:k},{name:"transaction_id",value:c}]})}catch(a){console.error("Failed to send payment confirmation email:",a)}return(0,e.revalidatePath)(`/dashboard/work/invoices/${k}`),(0,e.revalidatePath)("/dashboard/work/invoices"),{success:!0,transactionId:c}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Payment processing failed"}}}[f]=l.then?(await l)():l,(0,k.ensureServerEntryExports)([m]),(0,d.registerServerReference)(m,"4077d2f57527e7371b466b60fd322576f930d6cd64",null),a.s(["processInvoicePayment",()=>m]),c()}catch(a){c(a)}},!1),485619,a=>a.a(async(b,c)=>{try{a.i(288344);var d=a.i(492612);a.i(305145);var e=b([d]);[d]=e.then?(await e)():e,a.s([]),c()}catch(a){c(a)}},!1),771416,a=>a.a(async(b,c)=>{try{var d=a.i(485619),e=a.i(288344),f=a.i(492612),g=a.i(305145),h=b([d,f]);[d,f]=h.then?(await h)():h,a.s(["001f005176797ef23488068124fb9a744915a477de",()=>e.getCurrentUserRole,"406f6624261c6dd1a908026fa1408a3f6d507b6e7d",()=>e.canDeleteTeamMember,"4077d2f57527e7371b466b60fd322576f930d6cd64",()=>f.processInvoicePayment,"6048aff7615b24bbed5fff047d510e54bb65e77646",()=>g.markTokenAsUsed,"608ae817ddec034f2780624908f1db97356ccd42ef",()=>g.validatePaymentToken,"7026bc9768ad3ab0b96efecd8a3b9c44d5e7e57eba",()=>g.generatePaymentToken,"709bb1978cd77dad33a458251234f8c68f743d5f4c",()=>g.generatePaymentTokensBatch]),c()}catch(a){c(a)}},!1),858982,a=>{a.v(b=>Promise.all(["server/chunks/ssr/3c0ae_next_4427392f._.js"].map(b=>a.l(b))).then(()=>b(857782)))},769989,a=>{a.v(b=>Promise.all(["server/chunks/ssr/[root-of-the-server]__f6c731fd._.js","server/chunks/ssr/3c0ae_next_dist_compiled_d01f76b2._.js"].map(b=>a.l(b))).then(()=>b(227185)))},642757,a=>{a.v(a=>Promise.resolve().then(()=>a(149664)))},315292,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_email_email-tracking_ts_73b89830._.js"].map(b=>a.l(b))).then(()=>b(582891)))},449334,a=>{a.v(a=>Promise.resolve().then(()=>a(343860)))},806668,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_payments_processors_adyen_ts_b021b35d._.js"].map(b=>a.l(b))).then(()=>b(189239)))},250422,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_payments_processors_plaid_ts_68d940a4._.js"].map(b=>a.l(b))).then(()=>b(22036)))},117002,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_src_lib_payments_processors_profitstars_ts_eabbf2bd._.js"].map(b=>a.l(b))).then(()=>b(807124)))},662670,a=>{a.v(b=>Promise.all(["server/chunks/ssr/[root-of-the-server]__66a75d16._.js","server/chunks/ssr/node_modules__pnpm_f8367645._.js"].map(b=>a.l(b))).then(()=>b(397357)))},498156,a=>{a.v(b=>Promise.all(["server/chunks/ssr/apps_web_emails_5210b5de._.js","server/chunks/ssr/node_modules__pnpm_f6ce1303._.js"].map(b=>a.l(b))).then(()=>b(453648)))}];

//# sourceMappingURL=_23154a23._.js.map