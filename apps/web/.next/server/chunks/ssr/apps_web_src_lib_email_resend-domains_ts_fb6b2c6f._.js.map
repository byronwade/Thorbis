{"version":3,"sources":["../../../../../../apps/web/src/lib/email/resend-domains.ts","../../../../../../apps/web/src/lib/email/domain-validation.ts"],"sourcesContent":["\"use server\";\n\nimport crypto from \"node:crypto\";\nimport {\n\tvalidateDomain,\n\tgeneratePlatformSubdomain,\n\tgetDomainConfig,\n\tcanRegisterMoreDomains,\n\tsuggestSubdomains,\n\ttype DomainValidationResult,\n} from \"./domain-validation\";\n\nconst RESEND_API_BASE = \"https://api.resend.com\";\n\ntype ResendResponse<T> =\n\t| { success: true; data: T }\n\t| { success: false; error: string };\n\ninterface ResendDomainData {\n\tid: string;\n\tname: string;\n\tstatus: string;\n\tregion: string;\n\trecords: Array<{\n\t\ttype: string;\n\t\tname: string;\n\t\tvalue: string;\n\t\tpriority?: number;\n\t\tttl?: string;\n\t}>;\n\tcreated_at: string;\n}\n\ninterface ResendInboundRouteData {\n\tid: string;\n\tname: string;\n\trecipients: string[];\n\turl: string;\n\tenabled: boolean;\n\tcreated_at: string;\n}\n\nasync function resendRequest<T>(\n\tpath: string,\n\tinit: RequestInit\n): Promise<ResendResponse<T>> {\n\tconst apiKey = process.env.RESEND_API_KEY;\n\tif (!apiKey) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Resend API key is not configured\",\n\t\t};\n\t}\n\n\tconst response = await fetch(`${RESEND_API_BASE}${path}`, {\n\t\t...init,\n\t\theaders: {\n\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t...init.headers,\n\t\t},\n\t});\n\n\tif (!response.ok) {\n\t\tconst message =\n\t\t\t(await response.json().catch(() => null))?.message || response.statusText;\n\t\treturn { success: false, error: message };\n\t}\n\n\tconst data = (await response.json().catch(() => ({}))) as T;\n\treturn { success: true, data };\n}\n\n/**\n * Validate and create a Resend domain\n */\nexport async function createResendDomainWithValidation(params: {\n\tdomain: string;\n\tcurrentDomainCount: number;\n\tcompanySlug: string;\n}): Promise<\n\tResendResponse<ResendDomainData> & {\n\t\tvalidation?: DomainValidationResult;\n\t\tsuggestions?: string[];\n\t}\n> {\n\tconst { domain, currentDomainCount } = params;\n\n\t// Check if company can register more domains\n\tconst canRegister = canRegisterMoreDomains(currentDomainCount);\n\tif (!canRegister.allowed) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: canRegister.reason || \"Cannot register more domains\",\n\t\t};\n\t}\n\n\t// Validate the domain\n\tconst validation = validateDomain(domain);\n\tif (!validation.valid) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: validation.error || \"Invalid domain\",\n\t\t\tvalidation,\n\t\t};\n\t}\n\n\t// Create domain in Resend\n\tconst result = await resendRequest<ResendDomainData>(\"/domains\", {\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify({ name: validation.normalizedDomain }),\n\t});\n\n\treturn {\n\t\t...result,\n\t\tvalidation,\n\t};\n}\n\n/**\n * Create a Resend domain (basic, without validation - for internal use)\n */\nexport async function createResendDomain(name: string) {\n\treturn resendRequest<ResendDomainData>(\"/domains\", {\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify({ name }),\n\t});\n}\n\n/**\n * Get domain details from Resend\n */\nexport async function getResendDomain(domainId: string) {\n\treturn resendRequest<ResendDomainData>(`/domains/${domainId}`, {\n\t\tmethod: \"GET\",\n\t});\n}\n\n/**\n * Trigger domain verification in Resend\n */\nexport async function verifyResendDomain(domainId: string) {\n\treturn resendRequest<ResendDomainData>(`/domains/${domainId}/verify`, {\n\t\tmethod: \"POST\",\n\t});\n}\n\n/**\n * Delete a domain from Resend\n */\nexport async function deleteResendDomain(domainId: string) {\n\treturn resendRequest<void>(`/domains/${domainId}`, {\n\t\tmethod: \"DELETE\",\n\t});\n}\n\n/**\n * List all domains in Resend account\n */\nexport async function listResendDomains() {\n\treturn resendRequest<{ data: ResendDomainData[] }>(\"/domains\", {\n\t\tmethod: \"GET\",\n\t});\n}\n\n/**\n * Create an inbound email route\n */\nexport async function createInboundRoute(params: {\n\tname: string;\n\trecipients: string[];\n\turl: string;\n}) {\n\treturn resendRequest<ResendInboundRouteData>(\"/inbound\", {\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify(params),\n\t});\n}\n\n/**\n * Delete an inbound route\n */\nexport async function deleteInboundRoute(routeId: string) {\n\treturn resendRequest<void>(`/inbound/${routeId}`, {\n\t\tmethod: \"DELETE\",\n\t});\n}\n\n/**\n * List all inbound routes\n */\nexport async function listInboundRoutes() {\n\treturn resendRequest<{ data: ResendInboundRouteData[] }>(\"/inbound\", {\n\t\tmethod: \"GET\",\n\t});\n}\n\n/**\n * Get domain metrics from Resend (for deliverability monitoring)\n */\nexport async function getResendDomainMetrics(domainId: string) {\n\t// Resend doesn't have a direct metrics endpoint per domain\n\t// We track metrics in our database via webhook events\n\treturn resendRequest<any>(`/domains/${domainId}`, {\n\t\tmethod: \"GET\",\n\t});\n}\n\n/**\n * Verify Resend webhook signature (Svix)\n */\nexport async function verifyResendWebhookSignature({\n\tpayload,\n\theaders,\n}: {\n\tpayload: string;\n\theaders: {\n\t\tsvixId?: string;\n\t\tsvixTimestamp?: string;\n\t\tsvixSignature?: string;\n\t};\n}): Promise<boolean> {\n\tconst secret = process.env.RESEND_WEBHOOK_SECRET;\n\tconst { svixId, svixTimestamp, svixSignature } = headers;\n\n\tif (!secret || !svixId || !svixTimestamp || !svixSignature) {\n\t\treturn false;\n\t}\n\n\t// Svix signature format: v1,<base64_signature>\n\tconst signatures = svixSignature.split(\" \");\n\tconst signedPayload = `${svixId}.${svixTimestamp}.${payload}`;\n\n\t// Try to decode the secret (Svix uses whsec_ prefix)\n\tconst secretBytes = secret.startsWith(\"whsec_\")\n\t\t? Buffer.from(secret.slice(6), \"base64\")\n\t\t: Buffer.from(secret);\n\n\tconst computed = crypto\n\t\t.createHmac(\"sha256\", secretBytes)\n\t\t.update(signedPayload)\n\t\t.digest(\"base64\");\n\n\t// Check against all provided signatures\n\tfor (const sig of signatures) {\n\t\tconst [version, expectedSig] = sig.split(\",\");\n\t\tif (version === \"v1\" && expectedSig === computed) {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\treturn false;\n}\n\n// =============================================================================\n// RECEIVED EMAIL FUNCTIONS (Inbound)\n// =============================================================================\n\ninterface ReceivedEmailData {\n\tid: string;\n\tfrom: string;\n\tto: string[];\n\tsubject: string;\n\ttext?: string;\n\thtml?: string;\n\tcreated_at: string;\n\tattachments?: { id: string; filename: string; content_type: string }[];\n}\n\ninterface ReceivedAttachmentData {\n\tid: string;\n\tfilename: string;\n\tcontent_type: string;\n\tcontent: string; // base64 encoded\n}\n\n/**\n * Get a received email by ID\n */\nexport async function getReceivedEmail(\n\temailId: string\n): Promise<ResendResponse<ReceivedEmailData>> {\n\treturn resendRequest<ReceivedEmailData>(`/emails/${emailId}`, {\n\t\tmethod: \"GET\",\n\t});\n}\n\n/**\n * List attachments for a received email\n */\nexport async function listReceivedEmailAttachments(\n\temailId: string\n): Promise<ResendResponse<{ data: ReceivedAttachmentData[] }>> {\n\treturn resendRequest<{ data: ReceivedAttachmentData[] }>(\n\t\t`/emails/${emailId}/attachments`,\n\t\t{ method: \"GET\" }\n\t);\n}\n\n/**\n * Get a specific attachment from a received email\n */\nexport async function getReceivedEmailAttachment(\n\temailId: string,\n\tattachmentId: string\n): Promise<ResendResponse<ReceivedAttachmentData>> {\n\treturn resendRequest<ReceivedAttachmentData>(\n\t\t`/emails/${emailId}/attachments/${attachmentId}`,\n\t\t{ method: \"GET\" }\n\t);\n}\n\n/**\n * Verify DNS records for a domain (for onboarding tracker)\n */\nexport async function verifyDomainDNS(domain: string): Promise<{\n\tsuccess: boolean;\n\trecords: Array<{\n\t\tid: string;\n\t\ttype: string;\n\t\tname: string;\n\t\tvalue: string;\n\t\tpurpose: string;\n\t\tverified: boolean;\n\t}>;\n\terror?: string;\n}> {\n\ttry {\n\t\t// First, get all domains to find the one matching our domain\n\t\tconst listResult = await listResendDomains();\n\n\t\tif (!listResult.success || !listResult.data) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\trecords: [],\n\t\t\t\terror: \"Failed to fetch domains from Resend\",\n\t\t\t};\n\t\t}\n\n\t\t// Find the domain by name\n\t\tconst domainData = listResult.data.data?.find((d) => d.name === domain);\n\n\t\tif (!domainData) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\trecords: [],\n\t\t\t\terror: `Domain ${domain} not found in Resend`,\n\t\t\t};\n\t\t}\n\n\t\t// Trigger verification\n\t\tawait verifyResendDomain(domainData.id);\n\n\t\t// Get fresh domain data after verification\n\t\tconst verifyResult = await getResendDomain(domainData.id);\n\n\t\tif (!verifyResult.success || !verifyResult.data) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\trecords: [],\n\t\t\t\terror: \"Failed to verify domain\",\n\t\t\t};\n\t\t}\n\n\t\t// Format records for the tracker\n\t\tconst records = (verifyResult.data.records || []).map((record, index) => ({\n\t\t\tid: `${record.type.toLowerCase()}-${index}`,\n\t\t\ttype: record.type,\n\t\t\tname: record.name,\n\t\t\tvalue: record.value,\n\t\t\tpurpose: getPurposeLabel(record.type),\n\t\t\tverified: verifyResult.data.status === \"verified\",\n\t\t}));\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\trecords,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\trecords: [],\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n\n/**\n * Get purpose label for DNS record type\n */\nfunction getPurposeLabel(type: string): string {\n\tconst purposes: Record<string, string> = {\n\t\tTXT: \"SPF - Authorizes sending\",\n\t\tCNAME: \"DKIM - Email signing\",\n\t\tMX: \"Email routing\",\n\t\tDMARC: \"DMARC - Policy\",\n\t};\n\treturn purposes[type] || \"Email authentication\";\n}\n\n// Re-export validation utilities for convenience\nexport {\n\tvalidateDomain,\n\tgeneratePlatformSubdomain,\n\tgetDomainConfig,\n\tcanRegisterMoreDomains,\n\tsuggestSubdomains,\n\ttype DomainValidationResult,\n};\n","/**\n * Domain Validation Utilities for Multi-Tenant Email System\n *\n * Features:\n * - Subdomain enforcement for reputation isolation\n * - Domain ownership validation\n * - Blocked domain detection (public email providers)\n * - Tier-based domain allocation\n */\n\n// Blocked domains - public email providers that shouldn't be registered\nconst BLOCKED_DOMAINS = new Set([\n\t// Major providers\n\t\"gmail.com\",\n\t\"yahoo.com\",\n\t\"hotmail.com\",\n\t\"outlook.com\",\n\t\"live.com\",\n\t\"msn.com\",\n\t\"aol.com\",\n\t\"icloud.com\",\n\t\"me.com\",\n\t\"mac.com\",\n\t// Other common providers\n\t\"protonmail.com\",\n\t\"proton.me\",\n\t\"zoho.com\",\n\t\"mail.com\",\n\t\"gmx.com\",\n\t\"yandex.com\",\n\t\"fastmail.com\",\n\t// Temporary email services\n\t\"tempmail.com\",\n\t\"guerrillamail.com\",\n\t\"mailinator.com\",\n\t\"10minutemail.com\",\n\t\"throwaway.email\",\n\t// Big tech\n\t\"google.com\",\n\t\"microsoft.com\",\n\t\"apple.com\",\n\t\"amazon.com\",\n\t\"facebook.com\",\n\t\"meta.com\",\n]);\n\n// Reserved subdomains that companies cannot use\nconst RESERVED_SUBDOMAINS = new Set([\n\t\"mail\",\n\t\"email\",\n\t\"smtp\",\n\t\"pop\",\n\t\"imap\",\n\t\"webmail\",\n\t\"mx\",\n\t\"ns\",\n\t\"dns\",\n\t\"www\",\n\t\"api\",\n\t\"app\",\n\t\"admin\",\n\t\"support\",\n\t\"help\",\n\t\"billing\",\n\t\"status\",\n]);\n\nexport interface DomainValidationResult {\n\tvalid: boolean;\n\terror?: string;\n\tnormalizedDomain?: string;\n\tisSubdomain?: boolean;\n\trootDomain?: string;\n\tsubdomain?: string;\n}\n\nexport interface DomainConfig {\n\tallowCustomDomain: boolean;\n\trequireSubdomain: boolean;\n\tmaxDomainsAllowed: number;\n}\n\n/**\n * Get domain configuration - all companies have the same config (no tiers)\n */\nexport function getDomainConfig(): DomainConfig {\n\treturn {\n\t\tallowCustomDomain: true,\n\t\trequireSubdomain: false, // Can use root domain or subdomain\n\t\tmaxDomainsAllowed: 10, // Reasonable limit for organization\n\t};\n}\n\n/**\n * Parse a domain into its components\n */\nexport function parseDomain(domain: string): {\n\tsubdomain: string | null;\n\trootDomain: string;\n\ttld: string;\n} {\n\tconst normalized = domain.toLowerCase().trim();\n\tconst parts = normalized.split(\".\");\n\n\tif (parts.length < 2) {\n\t\treturn { subdomain: null, rootDomain: normalized, tld: \"\" };\n\t}\n\n\t// Handle common multi-part TLDs (co.uk, com.au, etc.)\n\tconst multiPartTlds = [\"co.uk\", \"com.au\", \"co.nz\", \"com.br\", \"co.jp\"];\n\tconst lastTwo = parts.slice(-2).join(\".\");\n\n\tif (multiPartTlds.includes(lastTwo) && parts.length > 2) {\n\t\tconst tld = lastTwo;\n\t\tconst rootDomain = parts.slice(-3).join(\".\");\n\t\tconst subdomain = parts.length > 3 ? parts.slice(0, -3).join(\".\") : null;\n\t\treturn { subdomain, rootDomain, tld };\n\t}\n\n\tconst tld = parts[parts.length - 1];\n\tconst rootDomain = parts.slice(-2).join(\".\");\n\tconst subdomain = parts.length > 2 ? parts.slice(0, -2).join(\".\") : null;\n\n\treturn { subdomain, rootDomain, tld };\n}\n\n/**\n * Validate a domain for registration\n */\nexport function validateDomain(domain: string): DomainValidationResult {\n\tif (!domain || typeof domain !== \"string\") {\n\t\treturn { valid: false, error: \"Domain is required\" };\n\t}\n\n\tconst normalized = domain.toLowerCase().trim();\n\n\t// Basic format validation\n\tconst domainRegex = /^[a-z0-9]([a-z0-9-]*[a-z0-9])?(\\.[a-z0-9]([a-z0-9-]*[a-z0-9])?)*\\.[a-z]{2,}$/;\n\tif (!domainRegex.test(normalized)) {\n\t\treturn { valid: false, error: \"Invalid domain format\" };\n\t}\n\n\t// Check for blocked domains\n\tconst { rootDomain, subdomain } = parseDomain(normalized);\n\tif (BLOCKED_DOMAINS.has(rootDomain)) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: `Cannot register public email provider domain: ${rootDomain}`,\n\t\t};\n\t}\n\n\t// Check for reserved subdomains\n\tif (subdomain && RESERVED_SUBDOMAINS.has(subdomain.split(\".\")[0])) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: `Subdomain \"${subdomain}\" is reserved. Please use a different subdomain.`,\n\t\t};\n\t}\n\n\treturn {\n\t\tvalid: true,\n\t\tnormalizedDomain: normalized,\n\t\tisSubdomain: !!subdomain,\n\t\trootDomain,\n\t\tsubdomain: subdomain || undefined,\n\t};\n}\n\n/**\n * Generate platform subdomain for companies without custom domains\n * Format: {company-slug}.mail.stratos.app\n */\nexport function generatePlatformSubdomain(companySlug: string): string {\n\tconst sanitized = companySlug\n\t\t.toLowerCase()\n\t\t.replace(/[^a-z0-9-]/g, \"-\")\n\t\t.replace(/-+/g, \"-\")\n\t\t.replace(/^-|-$/g, \"\");\n\n\tconst platformDomain = process.env.PLATFORM_EMAIL_DOMAIN || \"mail.stratos.app\";\n\treturn `${sanitized}.${platformDomain}`;\n}\n\n/**\n * Generate default sending address for a company\n */\nexport function generateSendingAddress(\n\tcompanySlug: string,\n\tdomain: string,\n\ttype: \"notifications\" | \"support\" | \"billing\" | \"noreply\" = \"notifications\"\n): string {\n\treturn `${type}@${domain}`;\n}\n\n/**\n * Check if company can register more domains\n */\nexport function canRegisterMoreDomains(\n\tcurrentDomainCount: number\n): { allowed: boolean; reason?: string } {\n\tconst config = getDomainConfig();\n\n\tif (currentDomainCount >= config.maxDomainsAllowed) {\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: `Maximum ${config.maxDomainsAllowed} domain(s) allowed. Contact support if you need more.`,\n\t\t};\n\t}\n\n\treturn { allowed: true };\n}\n\n/**\n * Suggest subdomain options for a domain\n */\nexport function suggestSubdomains(rootDomain: string): string[] {\n\treturn [\n\t\t`mail.${rootDomain}`,\n\t\t`notifications.${rootDomain}`,\n\t\t`updates.${rootDomain}`,\n\t\t`alerts.${rootDomain}`,\n\t\t`messages.${rootDomain}`,\n\t];\n}\n\n/**\n * Validate email address format\n */\nexport function validateEmailAddress(email: string): {\n\tvalid: boolean;\n\terror?: string;\n\tlocal?: string;\n\tdomain?: string;\n} {\n\tconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n\n\tif (!emailRegex.test(email)) {\n\t\treturn { valid: false, error: \"Invalid email format\" };\n\t}\n\n\tconst [local, domain] = email.split(\"@\");\n\n\tif (local.length > 64) {\n\t\treturn { valid: false, error: \"Local part of email is too long\" };\n\t}\n\n\tif (domain.length > 255) {\n\t\treturn { valid: false, error: \"Domain part of email is too long\" };\n\t}\n\n\treturn { valid: true, local, domain };\n}\n"],"names":[],"mappings":"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"}