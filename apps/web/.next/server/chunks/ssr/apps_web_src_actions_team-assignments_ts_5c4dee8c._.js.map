{"version":3,"sources":["../../../../../../apps/web/src/actions/team-assignments.ts"],"sourcesContent":["/**\n * Team Assignment Actions\n *\n * Server actions for managing job team member assignments.\n * Handles adding, removing, and updating team member assignments.\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport {\n\tActionError,\n\ttype ActionResult,\n\tERROR_CODES,\n\twithErrorHandling,\n} from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\n// ============================================================================\n// VALIDATION SCHEMAS\n// ============================================================================\n\nconst assignTeamMemberSchema = z.object({\n\tjobId: z.string().uuid(),\n\tteamMemberId: z.string().uuid(),\n\trole: z.enum([\"primary\", \"assistant\", \"crew\", \"supervisor\"]).default(\"crew\"),\n\tnotes: z.string().optional(),\n});\n\nconst removeTeamMemberSchema = z.object({\n\tjobId: z.string().uuid(),\n\tteamMemberId: z.string().uuid(),\n});\n\nconst bulkAssignTeamMembersSchema = z.object({\n\tjobId: z.string().uuid(),\n\tteamMemberIds: z.array(z.string().uuid()),\n\trole: z.enum([\"primary\", \"assistant\", \"crew\", \"supervisor\"]).default(\"crew\"),\n});\n\n// ============================================================================\n// TEAM MEMBER TYPES\n// ============================================================================\n\nexport type TeamMemberAssignment = {\n\tid: string;\n\tjobId: string;\n\tteamMemberId: string;\n\trole: \"primary\" | \"assistant\" | \"crew\" | \"supervisor\";\n\tassignedAt: string;\n\tassignedBy: string | null;\n\tnotes: string | null;\n\tteamMember: {\n\t\tid: string;\n\t\tuserId: string;\n\t\tjobTitle: string | null;\n\t\tuser: {\n\t\t\tid: string;\n\t\t\temail: string;\n\t\t\tfirstName: string | null;\n\t\t\tlastName: string | null;\n\t\t\tavatarUrl: string | null;\n\t\t\tphone: string | null;\n\t\t};\n\t};\n};\n\n// ============================================================================\n// ACTIONS\n// ============================================================================\n\n/**\n * Get team assignments for a job\n */\nasync function getJobTeamAssignments(\n\tjobId: string,\n): Promise<ActionResult<TeamMemberAssignment[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Verify user authentication\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new ActionError(\"Unauthorized\", ERROR_CODES.AUTH_UNAUTHORIZED, 401);\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"No active company selected\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst serviceSupabase = await createServiceSupabaseClient();\n\t\tif (!serviceSupabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company\n\t\tconst { data: job, error: jobError } = await serviceSupabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.maybeSingle();\n\n\t\tif (jobError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to load job\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: jobError.hint,\n\t\t\t\t\tdetails: jobError.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\tif (!job) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Job not found\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t404,\n\t\t\t);\n\t\t}\n\n\t\t// Get team assignments with member details\n\t\tconst { data: assignments, error: assignmentsError} = await serviceSupabase\n\t\t\t.from(\"job_team_assignments\")\n\t\t\t.select(\n\t\t\t\t`\n        id,\n        job_id,\n        team_member_id,\n        role,\n        assigned_at,\n        assigned_by,\n        notes,\n        company_memberships!inner (\n          id,\n          user_id,\n          job_title,\n          company_id\n        )\n      `,\n\t\t\t)\n\t\t\t.eq(\"job_id\", jobId)\n\t\t\t.eq(\"company_memberships.company_id\", companyId)\n\t\t\t.is(\"removed_at\", null)\n\t\t\t.order(\"assigned_at\", { ascending: true })\n\t\t\t.limit(50);\n\n\t\tif (assignmentsError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to load team assignments\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: assignmentsError.hint,\n\t\t\t\t\tdetails: assignmentsError.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\tif (!assignments || assignments.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\t// Get user details from public.users table\n\t\tconst userIds = assignments\n\t\t\t.map((a: any) => a.company_memberships?.user_id)\n\t\t\t.filter(Boolean);\n\t\tconst { data: users, error: usersError } = await serviceSupabase\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"id, email, full_name, avatar_url, phone\")\n\t\t\t.in(\"id\", userIds);\n\n\t\tif (usersError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to load user details\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: usersError.hint,\n\t\t\t\t\tdetails: usersError.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\t// Create a map of users by ID for quick lookup\n\t\tconst usersMap = new Map((users || []).map((user) => [user.id, user]));\n\n\t\t// Transform to expected format\n\t\tconst transformed = assignments.map((assignment: any) => {\n\t\t\tconst memberUser = usersMap.get(assignment.company_memberships?.user_id);\n\n\t\t\treturn {\n\t\t\t\tid: assignment.id,\n\t\t\t\tjobId: assignment.job_id,\n\t\t\t\tteamMemberId: assignment.team_member_id,\n\t\t\t\trole: assignment.role,\n\t\t\t\tassignedAt: assignment.assigned_at,\n\t\t\t\tassignedBy: assignment.assigned_by,\n\t\t\t\tnotes: assignment.notes,\n\t\t\t\tteamMember: {\n\t\t\t\t\tid: assignment.company_memberships.id,\n\t\t\t\t\tuserId: assignment.company_memberships.user_id,\n\t\t\t\t\tjobTitle: assignment.company_memberships.job_title,\n\t\t\t\t\tuser: memberUser\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\tid: memberUser.id,\n\t\t\t\t\t\t\t\temail: memberUser.email,\n\t\t\t\t\t\t\t\tfirstName: memberUser.full_name?.split(\" \")[0] || null,\n\t\t\t\t\t\t\t\tlastName:\n\t\t\t\t\t\t\t\t\tmemberUser.full_name?.split(\" \").slice(1).join(\" \") || null,\n\t\t\t\t\t\t\t\tavatarUrl: memberUser.avatar_url,\n\t\t\t\t\t\t\t\tphone: memberUser.phone,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t: {\n\t\t\t\t\t\t\t\tid:\n\t\t\t\t\t\t\t\t\tassignment.company_memberships.user_id ?? assignment.company_memberships.id,\n\t\t\t\t\t\t\t\temail: \"\",\n\t\t\t\t\t\t\t\tfirstName: null,\n\t\t\t\t\t\t\t\tlastName: null,\n\t\t\t\t\t\t\t\tavatarUrl: null,\n\t\t\t\t\t\t\t\tphone: null,\n\t\t\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t};\n\t\t});\n\n\t\treturn transformed;\n\t});\n}\n\n/**\n * Get all team members available for assignment in the company\n */\nexport async function getAvailableTeamMembers(): Promise<\n\tActionResult<\n\t\tArray<{\n\t\t\tid: string;\n\t\t\tuserId: string;\n\t\t\tjobTitle: string | null;\n\t\t\tstatus: string;\n\t\t\tuser: {\n\t\t\t\tid: string;\n\t\t\t\temail: string;\n\t\t\t\tfirstName: string | null;\n\t\t\t\tlastName: string | null;\n\t\t\t\tavatarUrl: string | null;\n\t\t\t\tphone: string | null;\n\t\t\t};\n\t\t}>\n\t>\n> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Verify user authentication\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new ActionError(\"Unauthorized\", ERROR_CODES.AUTH_UNAUTHORIZED, 401);\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"No active company selected\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst serviceSupabase = await createServiceSupabaseClient();\n\t\tif (!serviceSupabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get all active team members in company\n\t\tconst { data: members, error: membersError } = await serviceSupabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"id, user_id, job_title, status, company_id\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.limit(200);\n\n\t\tif (membersError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to load team members\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: membersError.hint,\n\t\t\t\t\tdetails: membersError.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\tif (!members || members.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\t// Get user details from public.users table\n\t\tconst userIds = members.map((m) => m.user_id).filter(Boolean);\n\t\tconst { data: users, error: usersError } = await serviceSupabase\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"id, email, full_name, avatar_url, phone\")\n\t\t\t.in(\"id\", userIds);\n\n\t\tif (usersError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to load user details\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: usersError.hint,\n\t\t\t\t\tdetails: usersError.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\t// Create a map of users by ID for quick lookup\n\t\tconst usersMap = new Map((users || []).map((user) => [user.id, user]));\n\n\t\t// Transform to expected format\n\t\tconst transformed = members.map((member) => {\n\t\t\tconst memberUser = usersMap.get(member.user_id);\n\n\t\t\treturn {\n\t\t\t\tid: member.id,\n\t\t\t\tuserId: member.user_id,\n\t\t\t\tjobTitle: member.job_title,\n\t\t\t\tstatus: member.status,\n\t\t\t\tuser: memberUser\n\t\t\t\t\t? {\n\t\t\t\t\t\t\tid: memberUser.id,\n\t\t\t\t\t\t\temail: memberUser.email,\n\t\t\t\t\t\t\tfirstName: memberUser.full_name?.split(\" \")[0] || null,\n\t\t\t\t\t\t\tlastName:\n\t\t\t\t\t\t\t\tmemberUser.full_name?.split(\" \").slice(1).join(\" \") || null,\n\t\t\t\t\t\t\tavatarUrl: memberUser.avatar_url,\n\t\t\t\t\t\t\tphone: memberUser.phone,\n\t\t\t\t\t\t}\n\t\t\t\t\t: {\n\t\t\t\t\t\t\tid: member.user_id ?? member.id,\n\t\t\t\t\t\t\temail: \"\",\n\t\t\t\t\t\t\tfirstName: null,\n\t\t\t\t\t\t\tlastName: null,\n\t\t\t\t\t\t\tavatarUrl: null,\n\t\t\t\t\t\t\tphone: null,\n\t\t\t\t\t\t},\n\t\t\t};\n\t\t});\n\n\t\t// Sort by user name\n\t\ttransformed.sort((a, b) => {\n\t\t\tconst nameA = [a.user.firstName, a.user.lastName]\n\t\t\t\t.filter(Boolean)\n\t\t\t\t.join(\" \")\n\t\t\t\t.toLowerCase();\n\t\t\tconst nameB = [b.user.firstName, b.user.lastName]\n\t\t\t\t.filter(Boolean)\n\t\t\t\t.join(\" \")\n\t\t\t\t.toLowerCase();\n\t\t\treturn nameA.localeCompare(nameB);\n\t\t});\n\n\t\treturn transformed;\n\t});\n}\n\n/**\n * Assign a team member to a job\n */\nexport async function assignTeamMemberToJob(\n\tinput: z.infer<typeof assignTeamMemberSchema>,\n): Promise<ActionResult<{ id: string }>> {\n\treturn withErrorHandling(async () => {\n\t\tconst validated = assignTeamMemberSchema.parse(input);\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Verify user authentication\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new ActionError(\"Unauthorized\", ERROR_CODES.AUTH_UNAUTHORIZED, 401);\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"No active company selected\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company\n\t\tconst { data: job, error: jobError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"id\", validated.jobId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.maybeSingle();\n\n\t\tif (jobError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to load job\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: jobError.hint,\n\t\t\t\t\tdetails: jobError.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\tif (!job) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Job not found\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t404,\n\t\t\t);\n\t\t}\n\n\t\t// Verify team member belongs to company\n\t\t// Note: job_team_assignments.team_member_id references team_members(id), not company_memberships(id)\n\t\t// So we need to check if the company_memberships.id corresponds to a team_members.id\n\t\t// First, get the company_membership to find the user_id\n\t\tconst { data: companyMembership, error: membershipError } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"id, user_id\")\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.maybeSingle();\n\n\t\tif (membershipError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to load team member\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: membershipError.hint,\n\t\t\t\t\tdetails: membershipError.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\tif (!companyMembership) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Team member not found\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t404,\n\t\t\t);\n\t\t}\n\n\t\t// Now find the corresponding team_members record\n\t\tconst { data: targetMember, error: targetError } = await supabase\n\t\t\t.from(\"team_members\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"user_id\", companyMembership.user_id)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.maybeSingle();\n\n\t\tif (targetError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to load team member record\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: targetError.hint,\n\t\t\t\t\tdetails: targetError.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\tif (!targetMember) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Team member record not found. Please ensure the team member has a corresponding team_members record.\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t404,\n\t\t\t);\n\t\t}\n\n\t\t// Use the team_members.id for the assignment (not company_memberships.id)\n\t\tconst actualTeamMemberId = targetMember.id;\n\n\t\t// If assigning as primary, remove other primary assignments\n\t\tif (validated.role === \"primary\") {\n\t\t\tconst { error: demoteError } = await supabase\n\t\t\t\t.from(\"job_team_assignments\")\n\t\t\t\t.update({ role: \"crew\" })\n\t\t\t\t.eq(\"job_id\", validated.jobId)\n\t\t\t\t.eq(\"role\", \"primary\")\n\t\t\t\t.is(\"removed_at\", null);\n\n\t\t\tif (demoteError) {\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\t\"Failed to update primary assignment\",\n\t\t\t\t\tERROR_CODES.DB_UPDATE_ERROR,\n\t\t\t\t\t500,\n\t\t\t\t\t{ hint: demoteError.hint, details: demoteError.details },\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t// Check if assignment already exists (active or soft-deleted)\n\t// Use actualTeamMemberId (team_members.id) not company_memberships.id\n\tconst { data: existingAssignment } = await supabase\n\t\t.from(\"job_team_assignments\")\n\t\t.select(\"id, removed_at\")\n\t\t.eq(\"job_id\", validated.jobId)\n\t\t.eq(\"team_member_id\", actualTeamMemberId)\n\t\t.maybeSingle();\n\n\tlet assignment: { id: string } | null = null;\n\tlet error = null;\n\tconst isReassignment = !!existingAssignment;\n\n\tif (existingAssignment) {\n\t\t// UPDATE existing assignment (handle re-assignments)\n\t\tconst result = await supabase\n\t\t\t.from(\"job_team_assignments\")\n\t\t\t.update({\n\t\t\t\trole: validated.role,\n\t\t\t\tassigned_by: user.id,\n\t\t\t\tnotes: validated.notes || null,\n\t\t\t\tremoved_at: null,\n\t\t\t\tassigned_at: new Date().toISOString(),\n\t\t\t})\n\t\t\t.eq(\"id\", existingAssignment.id)\n\t\t\t.select(\"id\")\n\t\t\t.single();\n\n\t\tassignment = result.data;\n\t\terror = result.error;\n\t} else {\n\t\t// INSERT new assignment\n\t\t// Use actualTeamMemberId (team_members.id) not company_memberships.id\n\t\tconst result = await supabase\n\t\t\t.from(\"job_team_assignments\")\n\t\t\t.insert({\n\t\t\t\tjob_id: validated.jobId,\n\t\t\t\tteam_member_id: actualTeamMemberId,\n\t\t\t\trole: validated.role,\n\t\t\t\tassigned_by: user.id,\n\t\t\t\tnotes: validated.notes || null,\n\t\t\t})\n\t\t\t.select(\"id\")\n\t\t\t.single();\n\n\t\tassignment = result.data;\n\t\terror = result.error;\n\t}\n\n\tif (error || !assignment) {\n\t\tconsole.error(\"Assignment error details:\", {\n\t\t\terror,\n\t\t\tteamMemberId: validated.teamMemberId,\n\t\t\tjobId: validated.jobId,\n\t\t\trole: validated.role,\n\t\t\texistingAssignment,\n\t\t});\n\t\tthrow new ActionError(\n\t\t\terror?.message || \"Failed to assign team member\",\n\t\t\tERROR_CODES.DB_UPDATE_ERROR,\n\t\t\t500,\n\t\t\t{\n\t\t\t\thint: error?.hint,\n\t\t\t\tdetails: error?.details,\n\t\t\t\tcode: error?.code,\n\t\t\t\tmessage: error?.message,\n\t\t\t},\n\t\t);\n\t}\n\n\n\t\t// NOTE: We do NOT auto-assign to appointments anymore\n\t\t// Job-level assignments are for planning/oversight\n\t\t// Appointment-level assignments are explicit scheduling decisions\n\t\t// The UI will suggest job-level team members when creating appointments\n\n\t\t// Revalidate paths\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/jobs/${validated.jobId}`);\n\t\trevalidatePath(`/dashboard/work/${validated.jobId}`);\n\n\t\treturn { id: assignment.id, wasReassignment: isReassignment };\n\t});\n}\n\n/**\n * Remove a team member from a job (soft delete)\n */\nexport async function removeTeamMemberFromJob(\n\tinput: z.infer<typeof removeTeamMemberSchema>,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst validated = removeTeamMemberSchema.parse(input);\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Verify user authentication\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new ActionError(\"Unauthorized\", ERROR_CODES.AUTH_UNAUTHORIZED, 401);\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"No active company selected\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company before removing assignments\n\t\tconst { data: job, error: jobError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"id\", validated.jobId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.maybeSingle();\n\n\t\tif (jobError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to load job\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: jobError.hint,\n\t\t\t\t\tdetails: jobError.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\tif (!job) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Job not found\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t404,\n\t\t\t);\n\t\t}\n\n\t\t// Soft delete the assignment\n\t\tconst { error } = await supabase\n\t\t\t.from(\"job_team_assignments\")\n\t\t\t.update({\n\t\t\t\tremoved_at: new Date().toISOString(),\n\t\t\t\tremoved_by: user.id,\n\t\t\t})\n\t\t\t.eq(\"job_id\", validated.jobId)\n\t\t\t.eq(\"team_member_id\", validated.teamMemberId)\n\t\t\t.is(\"removed_at\", null);\n\n\t\tif (error || !assignment) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to remove team member\",\n\t\t\t\tERROR_CODES.DB_UPDATE_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: error.hint,\n\t\t\t\t\tdetails: error.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\t// NOTE: We do NOT remove from appointments when removing from job\n\t\t// Appointment assignments are independent - may want to keep scheduled team member\n\t\t// even if they're no longer on the job-level team\n\n\t\t// Revalidate paths\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/jobs/${validated.jobId}`);\n\t\trevalidatePath(`/dashboard/work/${validated.jobId}`);\n\t});\n}\n\n/**\n * Bulk assign team members to a job\n */\nasync function bulkAssignTeamMembers(\n\tinput: z.infer<typeof bulkAssignTeamMembersSchema>,\n): Promise<ActionResult<{ assigned: number }>> {\n\treturn withErrorHandling(async () => {\n\t\tconst validated = bulkAssignTeamMembersSchema.parse(input);\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Verify user authentication\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new ActionError(\"Unauthorized\", ERROR_CODES.AUTH_UNAUTHORIZED, 401);\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"No active company selected\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company\n\t\tconst { data: job, error: jobError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"id\", validated.jobId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.maybeSingle();\n\n\t\tif (jobError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to load job\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: jobError.hint,\n\t\t\t\t\tdetails: jobError.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\tif (!job) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Job not found\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t404,\n\t\t\t);\n\t\t}\n\n\t\t// Create assignments in bulk\n\t\tconst assignments = validated.teamMemberIds.map((teamMemberId) => ({\n\t\t\tjob_id: validated.jobId,\n\t\t\tteam_member_id: teamMemberId,\n\t\t\trole: validated.role,\n\t\t\tassigned_by: user.id,\n\t\t}));\n\n\t\tconst { error, count } = await supabase\n\t\t\t.from(\"job_team_assignments\")\n\t\t\t.upsert(assignments, {\n\t\t\t\tonConflict: \"job_id,team_member_id\",\n\t\t\t});\n\n\t\tif (error || !assignment) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to assign team members\",\n\t\t\t\tERROR_CODES.DB_UPDATE_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: error.hint,\n\t\t\t\t\tdetails: error.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate paths\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/jobs/${validated.jobId}`);\n\n\t\treturn { assigned: count || 0 };\n\t});\n}\n\n/**\n * Update team member role on a job\n */\nasync function updateTeamMemberRole(\n\tjobId: string,\n\tteamMemberId: string,\n\tnewRole: \"primary\" | \"assistant\" | \"crew\" | \"supervisor\",\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Verify user authentication\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new ActionError(\"Unauthorized\", ERROR_CODES.AUTH_UNAUTHORIZED, 401);\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"No active company selected\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\t// Verify job belongs to company\n\t\tconst { data: job, error: jobError } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"id\", jobId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.maybeSingle();\n\n\t\tif (jobError) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to load job\",\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: jobError.hint,\n\t\t\t\t\tdetails: jobError.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\tif (!job) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Job not found\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t404,\n\t\t\t);\n\t\t}\n\n\t\t// If updating to primary, remove other primary assignments first\n\t\tif (newRole === \"primary\") {\n\t\t\tconst { error: demoteError } = await supabase\n\t\t\t\t.from(\"job_team_assignments\")\n\t\t\t\t.update({ role: \"crew\" })\n\t\t\t\t.eq(\"job_id\", jobId)\n\t\t\t\t.eq(\"role\", \"primary\")\n\t\t\t\t.is(\"removed_at\", null);\n\n\t\t\tif (demoteError) {\n\t\t\t\tthrow new ActionError(\n\t\t\t\t\t\"Failed to update primary assignment\",\n\t\t\t\t\tERROR_CODES.DB_UPDATE_ERROR,\n\t\t\t\t\t500,\n\t\t\t\t\t{ hint: demoteError.hint, details: demoteError.details },\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Update the role\n\t\tconst { error } = await supabase\n\t\t\t.from(\"job_team_assignments\")\n\t\t\t.update({ role: newRole })\n\t\t\t.eq(\"job_id\", jobId)\n\t\t\t.eq(\"team_member_id\", teamMemberId)\n\t\t\t.is(\"removed_at\", null);\n\n\t\tif (error || !assignment) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Failed to update team member role\",\n\t\t\t\tERROR_CODES.DB_UPDATE_ERROR,\n\t\t\t\t500,\n\t\t\t\t{\n\t\t\t\t\thint: error.hint,\n\t\t\t\t\tdetails: error.details,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate paths\n\t\trevalidatePath(\"/dashboard/work\");\n\t\trevalidatePath(`/dashboard/work/jobs/${jobId}`);\n\t});\n}\n"],"names":[],"mappings":"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"}