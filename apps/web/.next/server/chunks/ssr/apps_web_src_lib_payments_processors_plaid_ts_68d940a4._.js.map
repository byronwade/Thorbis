{"version":3,"sources":["../../../../../../apps/web/src/lib/payments/processors/plaid.ts"],"sourcesContent":["/**\n * Plaid Payment Processor\n *\n * Handles ACH payments and bank account linking via Plaid:\n * - Bank account verification\n * - ACH payment processing\n * - Account balance checks\n * - Transaction history\n *\n * Plaid is used for secure bank account linking and ACH processing,\n * often in combination with Adyen or ProfitStars for actual payment processing.\n */\n\nimport crypto from \"crypto\";\nimport type {\n\tPaymentChannel,\n\tPaymentProcessor,\n\tProcessPaymentRequest,\n\tProcessPaymentResponse,\n\tRefundPaymentRequest,\n\tRefundPaymentResponse,\n} from \"../processor-types\";\n\ntype PlaidConfig = {\n\tcompanyId: string;\n\tclientId: string;\n\tsecret: string;\n\tenvironment: \"sandbox\" | \"development\" | \"production\";\n\twebhookVerificationKey?: string; // Current webhook verification key from Plaid\n};\n\nexport class PlaidProcessor implements PaymentProcessor {\n\tprivate readonly config: PlaidConfig;\n\tprivate readonly apiUrl: string;\n\n\tconstructor(config: PlaidConfig) {\n\t\tthis.config = config;\n\t\tthis.apiUrl =\n\t\t\tconfig.environment === \"production\"\n\t\t\t\t? \"https://production.plaid.com\"\n\t\t\t\t: config.environment === \"development\"\n\t\t\t\t\t? \"https://development.plaid.com\"\n\t\t\t\t\t: \"https://sandbox.plaid.com\";\n\t}\n\n\tgetSupportedChannels(): PaymentChannel[] {\n\t\treturn [\"ach\"];\n\t}\n\n\tasync processPayment(\n\t\trequest: ProcessPaymentRequest,\n\t): Promise<ProcessPaymentResponse> {\n\t\ttry {\n\t\t\t// Plaid is primarily for bank account linking\n\t\t\t// Actual ACH processing is typically done through a partner like Adyen or ProfitStars\n\t\t\t// This is a simplified implementation - in production, you'd integrate with\n\t\t\t// Plaid's Payment Initiation API or use it with Adyen's ACH integration\n\n\t\t\tif (!request.paymentMethodId) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tstatus: \"failed\",\n\t\t\t\t\terror: \"Payment method (bank account) is required for ACH payments\",\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// For ACH via Plaid, you typically:\n\t\t\t// 1. Use Plaid to link/verify bank account (already done, paymentMethodId exists)\n\t\t\t// 2. Use Adyen or ProfitStars to actually process the ACH payment\n\t\t\t// 3. Or use Plaid's Payment Initiation API if available\n\n\t\t\t// This is a placeholder - actual implementation would depend on your ACH processor\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tstatus: \"failed\",\n\t\t\t\terror:\n\t\t\t\t\t\"ACH processing via Plaid requires integration with ACH processor (Adyen/ProfitStars)\",\n\t\t\t};\n\t\t} catch (error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tstatus: \"failed\",\n\t\t\t\terror:\n\t\t\t\t\terror instanceof Error ? error.message : \"Payment processing failed\",\n\t\t\t};\n\t\t}\n\t}\n\n\tasync refundPayment(\n\t\t_request: RefundPaymentRequest,\n\t): Promise<RefundPaymentResponse> {\n\t\t// ACH refunds are typically processed through the same ACH processor\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tstatus: \"failed\",\n\t\t\terror:\n\t\t\t\t\"ACH refunds must be processed through ACH processor (Adyen/ProfitStars)\",\n\t\t};\n\t}\n\n\tasync getPaymentStatus(_transactionId: string): Promise<{\n\t\tstatus: string;\n\t\tamount: number;\n\t\tmetadata?: Record<string, unknown>;\n\t}> {\n\t\t// Plaid doesn't directly process payments, so status would come from ACH processor\n\t\tthrow new Error(\"Payment status must be retrieved from ACH processor\");\n\t}\n\n\t/**\n\t * Verify Plaid webhook using JWT signature verification\n\t *\n\t * Plaid signs webhooks using JWT (RS256) with a rotating verification key.\n\t * The key can be fetched from Plaid's /webhook_verification_key/get endpoint.\n\t *\n\t * @param payload - The raw webhook body\n\t * @param signature - The Plaid-Verification header (JWT token)\n\t * @returns true if signature is valid\n\t */\n\tverifyWebhook(payload: string, signature: string): boolean {\n\t\tif (!signature) {\n\t\t\tconsole.error(\"[Plaid] No webhook signature provided\");\n\t\t\treturn false;\n\t\t}\n\n\t\ttry {\n\t\t\t// Plaid webhooks include a Plaid-Verification header containing a JWT\n\t\t\t// The JWT contains: { iat, request_body_sha256 } signed with Plaid's key\n\n\t\t\t// Parse the JWT header to get the key ID\n\t\t\tconst [headerB64, payloadB64, signatureB64] = signature.split(\".\");\n\n\t\t\tif (!headerB64 || !payloadB64 || !signatureB64) {\n\t\t\t\tconsole.error(\"[Plaid] Invalid JWT format in webhook signature\");\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Decode JWT payload\n\t\t\tconst jwtPayload = JSON.parse(\n\t\t\t\tBuffer.from(payloadB64, \"base64url\").toString(\"utf8\")\n\t\t\t);\n\n\t\t\t// Verify timestamp is within 5 minutes\n\t\t\tconst issuedAt = jwtPayload.iat;\n\t\t\tconst now = Math.floor(Date.now() / 1000);\n\t\t\tif (Math.abs(now - issuedAt) > 300) {\n\t\t\t\tconsole.error(\"[Plaid] Webhook signature too old or from future\");\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Calculate SHA256 of the request body\n\t\t\tconst bodyHash = crypto\n\t\t\t\t.createHash(\"sha256\")\n\t\t\t\t.update(payload)\n\t\t\t\t.digest(\"hex\");\n\n\t\t\t// Verify the body hash matches\n\t\t\tif (jwtPayload.request_body_sha256 !== bodyHash) {\n\t\t\t\tconsole.error(\"[Plaid] Webhook body hash mismatch\");\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// For full verification, you would also verify the JWT signature\n\t\t\t// using Plaid's public key from /webhook_verification_key/get\n\t\t\t// This requires async key fetching, so in production you might\n\t\t\t// want to cache the key or verify asynchronously\n\n\t\t\tif (this.config.webhookVerificationKey) {\n\t\t\t\t// If we have a verification key cached, use it to verify the signature\n\t\t\t\tconst signedInput = `${headerB64}.${payloadB64}`;\n\t\t\t\tconst verify = crypto.createVerify(\"RSA-SHA256\");\n\t\t\t\tverify.update(signedInput);\n\n\t\t\t\tconst isValid = verify.verify(\n\t\t\t\t\tthis.config.webhookVerificationKey,\n\t\t\t\t\tBuffer.from(signatureB64, \"base64url\")\n\t\t\t\t);\n\n\t\t\t\tif (!isValid) {\n\t\t\t\t\tconsole.error(\"[Plaid] JWT signature verification failed\");\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t\"[Plaid] No webhook verification key configured - verifying body hash only\"\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn true;\n\t\t} catch (error) {\n\t\t\tconsole.error(\"[Plaid] Webhook verification error:\", error);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Link a bank account using Plaid Link\n\t * This would typically be called from the frontend using Plaid Link\n\t */\n\tasync createLinkToken(userId: string): Promise<{ linkToken: string } | null> {\n\t\ttry {\n\t\t\tconst response = await fetch(`${this.apiUrl}/link/token/create`, {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders: {\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\"PLAID-CLIENT-ID\": this.config.clientId,\n\t\t\t\t\t\"PLAID-SECRET\": this.config.secret,\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tclient_name: \"Thorbis\",\n\t\t\t\t\tuser: {\n\t\t\t\t\t\tclient_user_id: userId,\n\t\t\t\t\t},\n\t\t\t\t\tproducts: [\"auth\", \"transactions\"],\n\t\t\t\t\tcountry_codes: [\"US\"],\n\t\t\t\t\tlanguage: \"en\",\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tconst data = await response.json();\n\n\t\t\tif (!response.ok) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\treturn { linkToken: data.link_token };\n\t\t} catch (_error) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Exchange public token for access token after Plaid Link success\n\t */\n\tasync exchangePublicToken(\n\t\tpublicToken: string,\n\t): Promise<{ accessToken: string } | null> {\n\t\ttry {\n\t\t\tconst response = await fetch(\n\t\t\t\t`${this.apiUrl}/item/public_token/exchange`,\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\t\"PLAID-CLIENT-ID\": this.config.clientId,\n\t\t\t\t\t\t\"PLAID-SECRET\": this.config.secret,\n\t\t\t\t\t},\n\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\tpublic_token: publicToken,\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t);\n\n\t\t\tconst data = await response.json();\n\n\t\t\tif (!response.ok) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\treturn { accessToken: data.access_token };\n\t\t} catch (_error) {\n\t\t\treturn null;\n\t\t}\n\t}\n}\n"],"names":[],"mappings":"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"}