{"version":3,"sources":["../../../../../../apps/web/src/emails/components/button.tsx","../../../../../../apps/web/src/emails/theme.ts","../../../../../../apps/web/src/emails/components/card.tsx","../../../../../../apps/web/src/emails/components/heading.tsx","../../../../../../apps/web/src/emails/layouts/base-layout.tsx","../../../../../../apps/web/src/lib/email/company-domain-sender.ts","../../../../../../apps/web/src/lib/email/email-router.ts"],"sourcesContent":["/**\n * Email Button Component - Matches dashboard button design\n *\n * Design:\n * - Primary variant with Thorbis Electric Blue\n * - Outline variant for secondary actions\n * - Responsive and accessible\n * - Supports both link and button styles\n */\n\nimport { Button as EmailButton } from \"@react-email/components\";\nimport { EMAIL_COLORS } from \"../theme\";\n\ntype ButtonProps = {\n\thref: string;\n\tchildren: React.ReactNode;\n\tvariant?: \"primary\" | \"outline\";\n};\n\nexport function Button({ href, children, variant = \"primary\" }: ButtonProps) {\n\tconst baseStyle = {\n\t\tdisplay: \"inline-block\",\n\t\tpadding: \"12px 24px\",\n\t\tfontSize: \"16px\",\n\t\tfontWeight: \"600\",\n\t\ttextDecoration: \"none\",\n\t\tborderRadius: \"8px\",\n\t\ttextAlign: \"center\" as const,\n\t\ttransition: \"all 0.2s ease\",\n\t};\n\n\tconst variantStyles = {\n\t\tprimary: {\n\t\t\tbackgroundColor: EMAIL_COLORS.primary, // Thorbis Electric Blue\n\t\t\tcolor: EMAIL_COLORS.primaryText,\n\t\t\tborder: \"none\",\n\t\t},\n\t\toutline: {\n\t\t\tbackgroundColor: \"transparent\",\n\t\t\tcolor: EMAIL_COLORS.primary,\n\t\t\tborder: `2px solid ${EMAIL_COLORS.primary}`,\n\t\t},\n\t};\n\n\treturn (\n\t\t<EmailButton\n\t\t\thref={href}\n\t\t\tstyle={{\n\t\t\t\t...baseStyle,\n\t\t\t\t...variantStyles[variant],\n\t\t\t}}\n\t\t>\n\t\t\t{children}\n\t\t</EmailButton>\n\t);\n}\n","export const EMAIL_COLORS = {\n\tbackground: \"#fafafa\",\n\tsurface: \"#fcfcfc\",\n\tsurfaceStrong: \"#f2f2f2\",\n\tprimary: \"#3c6ff5\",\n\tprimaryText: \"#fafafa\",\n\theading: \"#171717\",\n\ttext: \"#171717\",\n\tmuted: \"#737373\",\n\tborder: \"#e6e6e6\",\n\tsuccess: \"#22c55e\",\n\twarning: \"#f59e0b\",\n\terror: \"#ef4444\",\n};\n","/**\n * Email Card Component - Information card matching dashboard cards\n *\n * Design:\n * - Clean white background with subtle border\n * - Rounded corners\n * - Padding for content spacing\n * - Optional header and footer sections\n */\n\nimport { Section, Text } from \"@react-email/components\";\nimport type { ReactNode } from \"react\";\nimport { EMAIL_COLORS } from \"../theme\";\n\ntype CardProps = {\n\tchildren: ReactNode;\n\ttitle?: string;\n\tstyle?: React.CSSProperties;\n};\n\nexport function Card({ children, title, style }: CardProps) {\n\treturn (\n\t\t<Section\n\t\t\tstyle={{\n\t\t\t\t...cardStyle,\n\t\t\t\t...style,\n\t\t\t}}\n\t\t>\n\t\t\t{title && <Text style={titleStyle}>{title}</Text>}\n\t\t\t{children}\n\t\t</Section>\n\t);\n}\n\nconst cardStyle = {\n\tbackgroundColor: EMAIL_COLORS.surface,\n\tborder: `1px solid ${EMAIL_COLORS.border}`,\n\tborderRadius: \"8px\",\n\tpadding: \"24px\",\n\tmargin: \"16px 0\",\n};\n\nconst titleStyle = {\n\tfontSize: \"18px\",\n\tfontWeight: \"600\",\n\tcolor: EMAIL_COLORS.heading,\n\tmargin: \"0 0 16px 0\",\n};\n","/**\n * Email Heading Component - Typography for email headings\n *\n * Design:\n * - H1, H2, H3 variants\n * - Matches dashboard typography\n * - Proper spacing and hierarchy\n */\n\nimport { Heading as EmailHeading } from \"@react-email/components\";\nimport { EMAIL_COLORS } from \"../theme\";\n\ntype HeadingProps = {\n\tchildren: React.ReactNode;\n\tlevel?: 1 | 2 | 3;\n\tstyle?: React.CSSProperties;\n};\n\nexport function Heading({ children, level = 1, style }: HeadingProps) {\n\tconst headingTag = `h${level}` as \"h1\" | \"h2\" | \"h3\";\n\tconst headingStyles = {\n\t\t1: {\n\t\t\tfontSize: \"32px\",\n\t\t\tfontWeight: \"700\",\n\t\t\tcolor: EMAIL_COLORS.heading,\n\t\t\tmargin: \"0 0 16px 0\",\n\t\t\tlineHeight: \"1.2\",\n\t\t},\n\t\t2: {\n\t\t\tfontSize: \"24px\",\n\t\t\tfontWeight: \"600\",\n\t\t\tcolor: EMAIL_COLORS.text,\n\t\t\tmargin: \"0 0 12px 0\",\n\t\t\tlineHeight: \"1.3\",\n\t\t},\n\t\t3: {\n\t\t\tfontSize: \"18px\",\n\t\t\tfontWeight: \"600\",\n\t\t\tcolor: EMAIL_COLORS.muted,\n\t\t\tmargin: \"0 0 8px 0\",\n\t\t\tlineHeight: \"1.4\",\n\t\t},\n\t};\n\n\treturn (\n\t\t<EmailHeading\n\t\t\tas={headingTag}\n\t\t\tstyle={{\n\t\t\t\t...headingStyles[level],\n\t\t\t\t...style,\n\t\t\t}}\n\t\t>\n\t\t\t{children}\n\t\t</EmailHeading>\n\t);\n}\n","/**\n * Thorbis-Branded Email Layout\n *\n * For platform/system emails:\n * - Clean, full-width design (no cards)\n * - Thorbis logo image from CDN/env\n * - Thorbis Electric Blue branding\n * - Professional footer with Thorbis info\n *\n * Uses environment variables for:\n * - Logo URL\n * - App URL\n * - Support email\n * - Company info\n */\n\nimport {\n\tBody,\n\tContainer,\n\tHead,\n\tHr,\n\tHtml,\n\tImg,\n\tLink,\n\tPreview,\n\tSection,\n\tText,\n} from \"@react-email/components\";\nimport type { ReactNode } from \"react\";\nimport { EMAIL_COLORS } from \"../theme\";\n\ntype BaseLayoutProps = {\n\tchildren: ReactNode;\n\tpreviewText?: string;\n};\n\n// Environment-based configuration\nconst THORBIS_LOGO_URL =\n\tprocess.env.NEXT_PUBLIC_THORBIS_LOGO_URL ||\n\t\"https://thorbis.com/logo-white.png\";\nconst THORBIS_APP_URL =\n\tprocess.env.NEXT_PUBLIC_APP_URL || \"https://app.thorbis.com\";\nconst THORBIS_WEBSITE =\n\tprocess.env.NEXT_PUBLIC_WEBSITE_URL || \"https://thorbis.com\";\nconst THORBIS_SUPPORT_EMAIL =\n\tprocess.env.THORBIS_SUPPORT_EMAIL || \"support@thorbis.com\";\nconst THORBIS_DOCS_URL = `${THORBIS_WEBSITE}/docs`;\nconst THORBIS_PRIVACY_URL = `${THORBIS_WEBSITE}/privacy`;\nconst THORBIS_TERMS_URL = `${THORBIS_WEBSITE}/terms`;\n\nexport function BaseLayout({ children, previewText }: BaseLayoutProps) {\n\treturn (\n\t\t<Html>\n\t\t\t<Head>\n\t\t\t\t<style>{`\n          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');\n\n          /* Reset email client styles */\n          body { margin: 0; padding: 0; }\n          table { border-collapse: collapse; }\n          img { border: 0; }\n\n          /* Responsive */\n          @media only screen and (max-width: 600px) {\n            .mobile-padding { padding: 20px !important; }\n            .mobile-text { font-size: 14px !important; }\n            .mobile-heading { font-size: 24px !important; }\n          }\n        `}</style>\n\t\t\t</Head>\n\t\t\t{previewText && <Preview>{previewText}</Preview>}\n\t\t\t<Body style={main}>\n\t\t\t\t<Container style={container}>\n\t\t\t\t\t{/* Header with Thorbis logo on blue background */}\n\t\t\t\t\t<Section style={header}>\n\t\t\t\t\t\t<Img\n\t\t\t\t\t\t\tsrc={THORBIS_LOGO_URL}\n\t\t\t\t\t\t\talt=\"Thorbis\"\n\t\t\t\t\t\t\twidth=\"160\"\n\t\t\t\t\t\t\theight=\"40\"\n\t\t\t\t\t\t\tstyle={logo}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</Section>\n\n\t\t\t\t\t{/* Main content - full width, no cards */}\n\t\t\t\t\t<Section style={content} className=\"mobile-padding\">\n\t\t\t\t\t\t{children}\n\t\t\t\t\t</Section>\n\n\t\t\t\t\t{/* Divider */}\n\t\t\t\t\t<Hr style={divider} />\n\n\t\t\t\t\t{/* Footer */}\n\t\t\t\t\t<Section style={footer} className=\"mobile-padding\">\n\t\t\t\t\t\t{/* Support Links */}\n\t\t\t\t\t\t<Text style={footerText}>\n\t\t\t\t\t\t\tNeed help?{\" \"}\n\t\t\t\t\t\t\t<Link href={`mailto:${THORBIS_SUPPORT_EMAIL}`} style={footerLink}>\n\t\t\t\t\t\t\t\tContact Support\n\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t\t{\" • \"}\n\t\t\t\t\t\t\t<Link href={THORBIS_DOCS_URL} style={footerLink}>\n\t\t\t\t\t\t\t\tDocumentation\n\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t</Text>\n\n\t\t\t\t\t\t{/* Legal Links */}\n\t\t\t\t\t\t<Text style={footerText}>\n\t\t\t\t\t\t\t<Link href={THORBIS_PRIVACY_URL} style={footerLink}>\n\t\t\t\t\t\t\t\tPrivacy Policy\n\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t\t{\" • \"}\n\t\t\t\t\t\t\t<Link href={THORBIS_TERMS_URL} style={footerLink}>\n\t\t\t\t\t\t\t\tTerms of Service\n\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t</Text>\n\n\t\t\t\t\t\t{/* Company Info */}\n\t\t\t\t\t\t<Text style={footerCopyright}>\n\t\t\t\t\t\t\t© {new Date().getFullYear()} Thorbis. All rights reserved.\n\t\t\t\t\t\t</Text>\n\n\t\t\t\t\t\t<Text style={footerAddress}>\n\t\t\t\t\t\t\tThorbis • 123 Innovation Drive, San Francisco, CA 94105\n\t\t\t\t\t\t</Text>\n\n\t\t\t\t\t\t{/* Unsubscribe - required for CAN-SPAM compliance */}\n\t\t\t\t\t\t<Text style={footerUnsubscribe}>\n\t\t\t\t\t\t\tYou're receiving this email because you have an account with\n\t\t\t\t\t\t\tThorbis.{\" \"}\n\t\t\t\t\t\t\t<Link href=\"{{unsubscribe_url}}\" style={footerLink}>\n\t\t\t\t\t\t\t\tUnsubscribe from marketing emails\n\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t</Text>\n\t\t\t\t\t</Section>\n\t\t\t\t</Container>\n\t\t\t</Body>\n\t\t</Html>\n\t);\n}\n\n// Styles - Clean, full-width design\nconst main = {\n\tbackgroundColor: EMAIL_COLORS.background,\n\tfontFamily:\n\t\t'Inter, -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif',\n\tWebkitFontSmoothing: \"antialiased\" as const,\n\tMozOsxFontSmoothing: \"grayscale\" as const,\n};\n\nconst container = {\n\tbackgroundColor: EMAIL_COLORS.surface,\n\tmaxWidth: \"600px\",\n\tmargin: \"0 auto\",\n};\n\nconst header = {\n\tbackgroundColor: EMAIL_COLORS.primary, // Thorbis Electric Blue\n\tpadding: \"40px 0\",\n\ttextAlign: \"center\" as const,\n};\n\nconst logo = {\n\tmargin: \"0 auto\",\n\tdisplay: \"block\",\n};\n\nconst content = {\n\tpadding: \"48px 40px\",\n\tcolor: EMAIL_COLORS.text,\n\tfontSize: \"16px\",\n\tlineHeight: \"24px\",\n};\n\nconst divider = {\n\tborderColor: EMAIL_COLORS.border,\n\tborderWidth: \"1px\",\n\tmargin: \"0\",\n};\n\nconst footer = {\n\tpadding: \"32px 40px\",\n\ttextAlign: \"center\" as const,\n\tbackgroundColor: EMAIL_COLORS.surfaceStrong,\n};\n\nconst footerText = {\n\tcolor: EMAIL_COLORS.muted,\n\tfontSize: \"14px\",\n\tlineHeight: \"24px\",\n\tmargin: \"8px 0\",\n};\n\nconst footerLink = {\n\tcolor: EMAIL_COLORS.primary,\n\ttextDecoration: \"none\",\n\tfontWeight: \"500\",\n};\n\nconst footerCopyright = {\n\tcolor: EMAIL_COLORS.muted,\n\tfontSize: \"13px\",\n\tmargin: \"16px 0 0 0\",\n\tfontWeight: \"600\",\n};\n\nconst footerAddress = {\n\tcolor: EMAIL_COLORS.muted,\n\tfontSize: \"12px\",\n\tmargin: \"8px 0\",\n};\n\nconst footerUnsubscribe = {\n\tcolor: EMAIL_COLORS.muted,\n\tfontSize: \"11px\",\n\tmargin: \"16px 0 0 0\",\n\tlineHeight: \"18px\",\n};\n","/**\n * Company Domain Email Sender\n *\n * CRITICAL RULE - Reply-To Addresses:\n * ====================================\n * Reply-to ALWAYS uses the platform subdomain (mail.thorbis.com), regardless of:\n * - Which email provider is used (platform, custom domain, Gmail)\n * - What the FROM address is\n * - Whether they have a custom domain or not\n *\n * Examples:\n * - FROM: notifications@acme-plumbing.com (custom domain)\n *   REPLY-TO: support@acme-plumbing.mail.thorbis.com (platform subdomain)\n *\n * - FROM: john@gmail.com (personal Gmail)\n *   REPLY-TO: support@acme-plumbing.mail.thorbis.com (platform subdomain)\n *\n * - FROM: notifications@acme-plumbing.mail.thorbis.com (platform subdomain)\n *   REPLY-TO: support@acme-plumbing.mail.thorbis.com (same platform subdomain)\n *\n * Why?\n * - Centralizes all replies to one inbox per company\n * - Prevents replies going to custom domains or personal emails\n * - Each company controls their reply-to prefix (support@, help@, etc.)\n * - Stored in company_email_domains.reply_to_email\n */\n\nimport { Resend } from \"resend\";\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\nconst resend = new Resend(process.env.RESEND_API_KEY);\n\ntype CompanyDomain = {\n\tid: string;\n\tdomain_name: string;\n\tsubdomain: string; // REQUIRED: Always use subdomain to prevent SPF conflicts\n\tfull_domain: string;\n\tstatus: string;\n\tsending_addresses: Array<{\n\t\ttype: string;\n\t\temail: string;\n\t}>;\n\treply_to_email: string | null;\n};\n\ntype EmailType =\n\t| \"invoice\"\n\t| \"estimate\"\n\t| \"reminder\"\n\t| \"notification\"\n\t| \"marketing\"\n\t| \"general\";\n\n/**\n * Get the verified email domain for a company\n * Returns null if no domain is verified\n */\nasync function getCompanyVerifiedDomain(\n\tcompanyId: string,\n): Promise<CompanyDomain | null> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tif (!supabase) {\n\t\treturn null;\n\t}\n\n\tconst { data: domain } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"verified\")\n\t\t.eq(\"sending_enabled\", true)\n\t\t.eq(\"is_suspended\", false)\n\t\t.order(\"is_platform_subdomain\", { ascending: true }) // Prefer custom domains for FROM\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(1)\n\t\t.maybeSingle();\n\n\tif (!domain) {\n\t\treturn null;\n\t}\n\n\t// Construct full domain (subdomain is always required)\n\tconst fullDomain = `${domain.subdomain}.${domain.domain_name}`;\n\n\treturn {\n\t\tid: domain.id,\n\t\tdomain_name: domain.domain_name,\n\t\tsubdomain: domain.subdomain,\n\t\tfull_domain: fullDomain,\n\t\tstatus: domain.status,\n\t\tsending_addresses: domain.sending_addresses || [],\n\t\treply_to_email: domain.reply_to_email,\n\t};\n}\n\n/**\n * Get the company's platform subdomain for reply-to\n * Reply-to ALWAYS uses the platform subdomain (mail.thorbis.com)\n * This ensures replies are isolated per company, never using custom domains\n */\nasync function getCompanyPlatformReplyTo(\n\tcompanyId: string,\n): Promise<string | null> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tif (!supabase) {\n\t\treturn null;\n\t}\n\n\t// Get the platform subdomain for this company\n\tconst { data: platformDomain } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"domain_name, reply_to_email\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"is_platform_subdomain\", true)\n\t\t.eq(\"status\", \"verified\")\n\t\t.maybeSingle();\n\n\tif (!platformDomain) {\n\t\treturn null;\n\t}\n\n\t// Use configured reply-to if set, otherwise default to support@\n\tif (platformDomain.reply_to_email) {\n\t\treturn platformDomain.reply_to_email;\n\t}\n\n\t// Default: support@{company}.mail.thorbis.com\n\treturn `support@${platformDomain.domain_name}`;\n}\n\n/**\n * Get the appropriate sending address for a specific email type\n */\nfunction getSendingAddress(\n\tdomain: CompanyDomain,\n\ttype: EmailType,\n\tcompanyName: string,\n): string {\n\t// Check if company has custom sending addresses configured\n\tconst customAddress = domain.sending_addresses.find(\n\t\t(addr) => addr.type === type,\n\t);\n\n\tif (customAddress) {\n\t\treturn `${companyName} <${customAddress.email}>`;\n\t}\n\n\t// Default sending addresses based on type\n\tconst defaultEmail = `${type}@${domain.full_domain}`;\n\treturn `${companyName} <${defaultEmail}>`;\n}\n\n/**\n * Send email using company's verified domain\n * This is the PRIMARY function for ALL email sending in the platform\n */\nexport async function sendCompanyEmail({\n\tcompanyId,\n\tcompanyName,\n\ttype = \"notification\",\n\tto,\n\tsubject,\n\thtml,\n\ttext,\n\treplyTo,\n\tattachments,\n\tcommunicationId,\n}: {\n\tcompanyId: string;\n\tcompanyName: string;\n\ttype?: EmailType;\n\tto: string | string[];\n\tsubject: string;\n\thtml: string;\n\ttext?: string;\n\treplyTo?: string;\n\tattachments?: Array<{\n\t\tfilename: string;\n\t\tcontent: string;\n\t}>;\n\tcommunicationId?: string;\n}) {\n\t// 1. Get company's verified domain (for FROM address)\n\tconst domain = await getCompanyVerifiedDomain(companyId);\n\n\tif (!domain) {\n\t\tthrow new Error(\n\t\t\t`Company domain not verified. Please verify your email domain in settings before sending emails.`,\n\t\t);\n\t}\n\n\t// 2. Get appropriate sending address\n\tconst fromAddress = getSendingAddress(domain, type, companyName);\n\n\t// 3. Get reply-to from platform subdomain (NEVER custom domain)\n\t// Reply-to ALWAYS uses mail.thorbis.com, even when FROM uses a custom domain\n\t// This ensures all replies are centralized to the company's platform subdomain\n\tconst platformReplyTo = await getCompanyPlatformReplyTo(companyId);\n\tconst replyToAddress = replyTo || platformReplyTo || `support@${domain.full_domain}`;\n\n\t// 4. Add email tracking if communicationId is provided\n\tlet trackedHtml = html;\n\tif (communicationId) {\n\t\tconst { addEmailTracking } = await import(\"./email-tracking\");\n\t\ttrackedHtml = addEmailTracking(html, communicationId);\n\t}\n\n\t// 5. Send email via Resend\n\ttry {\n\t\tconst { data, error } = await resend.emails.send({\n\t\t\tfrom: fromAddress,\n\t\t\tto,\n\t\t\tsubject,\n\t\t\thtml: trackedHtml,\n\t\t\ttext,\n\t\t\treplyTo: replyToAddress,\n\t\t\tattachments,\n\t\t});\n\n\t\tif (error) {\n\t\t\tthrow new Error(`Failed to send email: ${error.message}`);\n\t\t}\n\n\t\treturn { success: true, messageId: data?.id };\n\t} catch (error) {\n\t\tconsole.error(\"Email send error:\", error);\n\t\tthrow error;\n\t}\n}\n\n/**\n * Check if company can send emails (has verified domain)\n */\nasync function canCompanySendEmail(companyId: string): Promise<boolean> {\n\tconst domain = await getCompanyVerifiedDomain(companyId);\n\treturn domain !== null && domain.status === \"verified\";\n}\n\n/**\n * Get company's email sending status and instructions\n */\nasync function getCompanyEmailStatus(companyId: string): Promise<{\n\tcanSend: boolean;\n\tdomain?: CompanyDomain;\n\tmessage: string;\n}> {\n\tconst supabase = await createServiceSupabaseClient();\n\n\tif (!supabase) {\n\t\treturn {\n\t\t\tcanSend: false,\n\t\t\tmessage: \"Database connection failed\",\n\t\t};\n\t}\n\n\tconst { data: domain } = await supabase\n\t\t.from(\"company_email_domains\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.single();\n\n\tif (!domain) {\n\t\treturn {\n\t\t\tcanSend: false,\n\t\t\tmessage:\n\t\t\t\t\"No email domain configured. Please add and verify your email domain in Settings → Email Domain.\",\n\t\t};\n\t}\n\n\t// Subdomain is always required\n\tconst fullDomain = `${domain.subdomain}.${domain.domain_name}`;\n\n\tif (domain.status === \"verified\") {\n\t\treturn {\n\t\t\tcanSend: true,\n\t\t\tdomain: {\n\t\t\t\tid: domain.id,\n\t\t\t\tdomain_name: domain.domain_name,\n\t\t\t\tsubdomain: domain.subdomain,\n\t\t\t\tfull_domain: fullDomain,\n\t\t\t\tstatus: domain.status,\n\t\t\t\tsending_addresses: domain.sending_addresses || [],\n\t\t\t\treply_to_email: domain.reply_to_email,\n\t\t\t},\n\t\t\tmessage: `Ready to send from ${fullDomain}`,\n\t\t};\n\t}\n\n\tif (domain.status === \"pending\" || domain.status === \"verifying\") {\n\t\treturn {\n\t\t\tcanSend: false,\n\t\t\tdomain: {\n\t\t\t\tid: domain.id,\n\t\t\t\tdomain_name: domain.domain_name,\n\t\t\t\tsubdomain: domain.subdomain,\n\t\t\t\tfull_domain: fullDomain,\n\t\t\t\tstatus: domain.status,\n\t\t\t\tsending_addresses: domain.sending_addresses || [],\n\t\t\t\treply_to_email: domain.reply_to_email,\n\t\t\t},\n\t\t\tmessage: `Email domain ${fullDomain} is pending verification. Please add the required DNS records to verify.`,\n\t\t};\n\t}\n\n\treturn {\n\t\tcanSend: false,\n\t\tdomain: {\n\t\t\tid: domain.id,\n\t\t\tdomain_name: domain.domain_name,\n\t\t\tsubdomain: domain.subdomain,\n\t\t\tfull_domain: fullDomain,\n\t\t\tstatus: domain.status,\n\t\t\tsending_addresses: domain.sending_addresses || [],\n\t\t\treply_to_email: domain.reply_to_email,\n\t\t},\n\t\tmessage: `Email domain verification failed. Please check your DNS records or contact support.`,\n\t};\n}\n","/**\n * Email Router - Determines which email system to use\n *\n * Two email systems:\n * 1. Thorbis Platform Emails - System notifications, auth, team invites\n * 2. Company Branded Emails - Customer communications, invoices, estimates\n *\n * This router ensures emails use the correct sender and branding.\n */\n\"use server\";\n\nimport { render } from \"@react-email/components\";\nimport type { ReactElement } from \"react\";\nimport { sendCompanyEmail } from \"./company-domain-sender\";\nimport { sendEmail } from \"./email-sender\";\nimport type { EmailTemplate } from \"./email-types\";\n\n// Platform email options (Thorbis branding)\ntype PlatformEmailOptions = {\n\tcategory: \"platform\";\n\tto: string | string[];\n\tsubject: string;\n\ttemplate: ReactElement;\n\ttemplateType: EmailTemplate;\n\treplyTo?: string;\n\ttags?: { name: string; value: string }[];\n};\n\n// Company email options (Company branding)\ntype CompanyEmailOptions = {\n\tcategory: \"company\";\n\tcompanyId: string;\n\tcompanyName: string;\n\tto: string | string[];\n\tsubject: string;\n\ttemplate: ReactElement;\n\ttemplateType: EmailTemplate;\n\temailType?:\n\t\t| \"invoice\"\n\t\t| \"estimate\"\n\t\t| \"reminder\"\n\t\t| \"notification\"\n\t\t| \"marketing\"\n\t\t| \"general\";\n\treplyTo?: string;\n\ttags?: { name: string; value: string }[];\n\tcommunicationId?: string;\n};\n\ntype EmailOptions = PlatformEmailOptions | CompanyEmailOptions;\n\n/**\n * Smart email router - Automatically uses correct email system\n *\n * Usage:\n * ```typescript\n * // Platform email (Thorbis)\n * await routeEmail({\n *   category: \"platform\",\n *   to: \"user@example.com\",\n *   subject: \"Welcome to Thorbis\",\n *   template: <WelcomeEmail />,\n *   templateType: \"auth-welcome\"\n * });\n *\n * // Company email (Branded)\n * await routeEmail({\n *   category: \"company\",\n *   companyId: \"xxx\",\n *   companyName: \"ACME Plumbing\",\n *   to: \"customer@example.com\",\n *   subject: \"Invoice #1234\",\n *   template: <InvoiceEmail />,\n *   templateType: \"customer-invoice\",\n *   emailType: \"invoice\"\n * });\n * ```\n */\nasync function routeEmail(options: EmailOptions) {\n\tif (options.category === \"platform\") {\n\t\t// Use Thorbis platform email system\n\t\treturn await sendEmail({\n\t\t\tto: options.to,\n\t\t\tsubject: options.subject,\n\t\t\ttemplate: options.template,\n\t\t\ttemplateType: options.templateType,\n\t\t\treplyTo: options.replyTo,\n\t\t\ttags: options.tags,\n\t\t\tfromOverride: \"Thorbis <noreply@thorbis.com>\", // Always use Thorbis domain\n\t\t});\n\t} else {\n\t\t// Use company branded email system\n\t\tconst html = await render(options.template);\n\n\t\treturn await sendCompanyEmail({\n\t\t\tcompanyId: options.companyId,\n\t\t\tcompanyName: options.companyName,\n\t\t\ttype: options.emailType || \"notification\",\n\t\t\tto: options.to,\n\t\t\tsubject: options.subject,\n\t\t\thtml,\n\t\t\treplyTo: options.replyTo,\n\t\t\tcommunicationId: options.communicationId,\n\t\t});\n\t}\n}\n\n/**\n * Helper: Send platform email (Thorbis branding)\n */\nexport async function sendPlatformEmail(\n\toptions: Omit<PlatformEmailOptions, \"category\">,\n) {\n\treturn routeEmail({ ...options, category: \"platform\" });\n}\n\n/**\n * Helper: Send company email (Company branding)\n */\nexport async function sendCompanyBrandedEmail(\n\toptions: Omit<CompanyEmailOptions, \"category\">,\n) {\n\treturn routeEmail({ ...options, category: \"company\" });\n}\n"],"names":[],"mappings":"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"}