{"version":3,"sources":["../../../../../../apps/web/src/emails/templates/team/invitation.tsx","../../../../../../apps/web/src/lib/auth/invitation-tokens.ts","../../../../../../apps/web/src/actions/team-invitations.ts"],"sourcesContent":["/**\n * Team Invitation Email Template - Invitation to join team\n *\n * Features:\n * - Invitation to join company team\n * - Secure invitation link with expiration\n * - Role and access information\n * - Getting started guide\n */\n\nimport { Text } from \"@react-email/components\";\nimport { Button } from \"@/emails/components/button\";\nimport { Card } from \"@/emails/components/card\";\nimport { Heading } from \"@/emails/components/heading\";\nimport { BaseLayout } from \"@/emails/layouts/base-layout\";\nimport { EMAIL_COLORS } from \"@/emails/theme\";\n\nexport type TeamInvitationProps = {\n\tinviteeName: string;\n\tinviterName: string;\n\tcompanyName: string;\n\trole: string;\n\tjobTitle?: string;\n\tinvitationUrl: string;\n\texpiresInDays?: number;\n\tsupportEmail?: string;\n\tsupportPhone?: string;\n\tpreviewText?: string;\n};\n\nexport default function TeamInvitationEmail({\n\tinviteeName,\n\tinviterName,\n\tcompanyName,\n\trole,\n\tjobTitle,\n\tinvitationUrl,\n\texpiresInDays = 7,\n\tsupportEmail = \"support@thorbis.com\",\n\tsupportPhone = \"(555) 123-4567\",\n\tpreviewText = `You've been invited to join ${companyName}`,\n}: TeamInvitationProps) {\n\tconst roleDisplay = role.charAt(0).toUpperCase() + role.slice(1);\n\n\treturn (\n\t\t<BaseLayout previewText={previewText}>\n\t\t\t<Heading level={1}>Welcome to the Team!</Heading>\n\n\t\t\t<Text style={paragraph}>Hi {inviteeName},</Text>\n\n\t\t\t<Text style={paragraph}>\n\t\t\t\t{inviterName} has invited you to join <strong>{companyName}</strong> on\n\t\t\t\tThorbis. We're excited to have you on board!\n\t\t\t</Text>\n\n\t\t\t<Card style={invitationCard}>\n\t\t\t\t<div style={invitationIcon}>üéâ</div>\n\t\t\t\t<Text style={invitationTitle}>You're Invited!</Text>\n\t\t\t\t<Text style={invitationText}>\n\t\t\t\t\tYou've been invited as a <strong>{roleDisplay}</strong>\n\t\t\t\t\t{jobTitle ? ` - ${jobTitle}` : \"\"}.\n\t\t\t\t</Text>\n\t\t\t\t<Text style={invitationText}>\n\t\t\t\t\tClick the button below to accept your invitation and set up your\n\t\t\t\t\taccount.\n\t\t\t\t</Text>\n\t\t\t</Card>\n\n\t\t\t<div style={buttonContainer}>\n\t\t\t\t<Button href={invitationUrl}>Accept Invitation</Button>\n\t\t\t</div>\n\n\t\t\t<Card style={expiryCard}>\n\t\t\t\t<Text style={expiryText}>\n\t\t\t\t\t‚è∞ This invitation link will expire in{\" \"}\n\t\t\t\t\t<strong>{expiresInDays} days</strong>. Please accept your invitation\n\t\t\t\t\tsoon.\n\t\t\t\t</Text>\n\t\t\t</Card>\n\n\t\t\t<Card style={featuresCard}>\n\t\t\t\t<Heading level={3}>What you can do with Thorbis:</Heading>\n\t\t\t\t<ul style={featuresList}>\n\t\t\t\t\t<li style={featureItem}>\n\t\t\t\t\t\t<strong>üìÖ Manage Jobs & Schedule:</strong> Create and track jobs,\n\t\t\t\t\t\tschedule appointments, and coordinate with your team\n\t\t\t\t\t</li>\n\t\t\t\t\t<li style={featureItem}>\n\t\t\t\t\t\t<strong>üë• Customer Management:</strong> Access complete customer\n\t\t\t\t\t\tinformation, history, and communication logs\n\t\t\t\t\t</li>\n\t\t\t\t\t<li style={featureItem}>\n\t\t\t\t\t\t<strong>üí∞ Invoicing & Payments:</strong> Generate invoices,\n\t\t\t\t\t\testimates, and track payments in real-time\n\t\t\t\t\t</li>\n\t\t\t\t\t<li style={featureItem}>\n\t\t\t\t\t\t<strong>üìä Reports & Analytics:</strong> View performance metrics\n\t\t\t\t\t\tand business insights\n\t\t\t\t\t</li>\n\t\t\t\t\t<li style={featureItem}>\n\t\t\t\t\t\t<strong>üí¨ Team Communication:</strong> Collaborate with your team\n\t\t\t\t\t\tthrough built-in messaging\n\t\t\t\t\t</li>\n\t\t\t\t\t<li style={featureItem}>\n\t\t\t\t\t\t<strong>üì± Mobile Access:</strong> Access your work from any device,\n\t\t\t\t\t\tanywhere\n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t</Card>\n\n\t\t\t<Card style={securityCard}>\n\t\t\t\t<Heading level={3}>Secure & Reliable</Heading>\n\t\t\t\t<Text style={securityText}>\n\t\t\t\t\tYour account is protected with industry-standard security. All data is\n\t\t\t\t\tencrypted and backed up regularly to keep your business safe.\n\t\t\t\t</Text>\n\t\t\t</Card>\n\n\t\t\t<Card style={stepsCard}>\n\t\t\t\t<Heading level={3}>Getting Started is Easy</Heading>\n\t\t\t\t<div style={stepGrid}>\n\t\t\t\t\t<div style={step}>\n\t\t\t\t\t\t<div style={stepNumber}>1</div>\n\t\t\t\t\t\t<Text style={stepText}>\n\t\t\t\t\t\t\tClick the \"Accept Invitation\" button above\n\t\t\t\t\t\t</Text>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div style={step}>\n\t\t\t\t\t\t<div style={stepNumber}>2</div>\n\t\t\t\t\t\t<Text style={stepText}>\n\t\t\t\t\t\t\tComplete your profile and set a secure password\n\t\t\t\t\t\t</Text>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div style={step}>\n\t\t\t\t\t\t<div style={stepNumber}>3</div>\n\t\t\t\t\t\t<Text style={stepText}>\n\t\t\t\t\t\t\tExplore the platform and start collaborating!\n\t\t\t\t\t\t</Text>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</Card>\n\n\t\t\t<Card style={helpCard}>\n\t\t\t\t<Heading level={3}>Need Help?</Heading>\n\t\t\t\t<Text style={helpText}>\n\t\t\t\t\tIf you have any questions about getting started or need assistance,\n\t\t\t\t\tour support team is here to help.\n\t\t\t\t</Text>\n\t\t\t\t<div style={contactGrid}>\n\t\t\t\t\t<div style={contactMethod}>\n\t\t\t\t\t\t<Text style={contactLabel}>Email:</Text>\n\t\t\t\t\t\t<a href={`mailto:${supportEmail}`} style={contactLink}>\n\t\t\t\t\t\t\t{supportEmail}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div style={contactMethod}>\n\t\t\t\t\t\t<Text style={contactLabel}>Phone:</Text>\n\t\t\t\t\t\t<a href={`tel:${supportPhone}`} style={contactLink}>\n\t\t\t\t\t\t\t{supportPhone}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</Card>\n\n\t\t\t<Text style={footerNote}>\n\t\t\t\t<strong>Note:</strong> If you didn't expect this invitation or believe\n\t\t\t\tyou received this email in error, please contact us at{\" \"}\n\t\t\t\t<a href={`mailto:${supportEmail}`} style={inlineLink}>\n\t\t\t\t\t{supportEmail}\n\t\t\t\t</a>\n\t\t\t\t.\n\t\t\t</Text>\n\t\t</BaseLayout>\n\t);\n}\n\n// Styles\nconst paragraph = {\n\tcolor: \"#374151\",\n\tfontSize: \"16px\",\n\tlineHeight: \"24px\",\n\tmargin: \"0 0 16px 0\",\n};\n\nconst invitationCard = {\n\tbackground:\n\t\t\"linear-gradient(135deg, hsl(217 91% 60%) 0%, hsl(217 91% 50%) 100%)\",\n\tborderRadius: \"12px\",\n\tpadding: \"40px\",\n\tmargin: \"24px 0\",\n\ttextAlign: \"center\" as const,\n};\n\nconst invitationIcon = {\n\tfontSize: \"64px\",\n\tmargin: \"0 0 16px 0\",\n};\n\nconst invitationTitle = {\n\tcolor: EMAIL_COLORS.primaryText,\n\tfontSize: \"24px\",\n\tfontWeight: \"600\",\n\tmargin: \"0 0 12px 0\",\n};\n\nconst invitationText = {\n\tcolor: EMAIL_COLORS.primaryText,\n\tfontSize: \"16px\",\n\tlineHeight: \"24px\",\n\tmargin: \"0 0 12px 0\",\n\topacity: \"0.95\",\n};\n\nconst buttonContainer = {\n\tmargin: \"32px 0\",\n\ttextAlign: \"center\" as const,\n};\n\nconst expiryCard = {\n\tbackgroundColor: \"#fef3c7\",\n\tborder: \"1px solid #fde68a\",\n\tborderRadius: \"8px\",\n\tpadding: \"16px\",\n\tmargin: \"24px 0\",\n\ttextAlign: \"center\" as const,\n};\n\nconst expiryText = {\n\tcolor: \"#92400e\",\n\tfontSize: \"14px\",\n\tlineHeight: \"20px\",\n\tmargin: \"0\",\n};\n\nconst featuresCard = {\n\tbackgroundColor: \"#f0fdf4\",\n\tborder: \"1px solid #bbf7d0\",\n\tmargin: \"24px 0\",\n};\n\nconst featuresList = {\n\tcolor: \"#166534\",\n\tfontSize: \"14px\",\n\tlineHeight: \"22px\",\n\tmargin: \"12px 0 0 20px\",\n\tpadding: \"0\",\n};\n\nconst featureItem = {\n\tmargin: \"0 0 12px 0\",\n};\n\nconst securityCard = {\n\tbackgroundColor: \"#f5f3ff\",\n\tborder: \"1px solid #ddd6fe\",\n\tmargin: \"24px 0\",\n};\n\nconst securityText = {\n\tcolor: \"#5b21b6\",\n\tfontSize: \"15px\",\n\tlineHeight: \"22px\",\n\tmargin: \"12px 0 0 0\",\n};\n\nconst stepsCard = {\n\tbackgroundColor: \"#eff6ff\",\n\tborder: \"1px solid #bfdbfe\",\n\tmargin: \"24px 0\",\n};\n\nconst stepGrid = {\n\tdisplay: \"grid\" as const,\n\tgridTemplateColumns: \"1fr 1fr 1fr\",\n\tgap: \"20px\",\n\tmargin: \"20px 0 0 0\",\n};\n\nconst step = {\n\ttextAlign: \"center\" as const,\n};\n\nconst stepNumber = {\n\twidth: \"40px\",\n\theight: \"40px\",\n\tbackgroundColor: \"hsl(217 91% 60%)\",\n\tcolor: EMAIL_COLORS.primaryText,\n\tborderRadius: \"50%\",\n\tdisplay: \"inline-flex\",\n\talignItems: \"center\",\n\tjustifyContent: \"center\",\n\tfontSize: \"18px\",\n\tfontWeight: \"600\",\n\tmargin: \"0 auto 12px auto\",\n};\n\nconst stepText = {\n\tcolor: \"#1e40af\",\n\tfontSize: \"13px\",\n\tlineHeight: \"18px\",\n\tmargin: \"0\",\n};\n\nconst helpCard = {\n\tbackgroundColor: \"#fef2f2\",\n\tborder: \"1px solid #fecaca\",\n\tmargin: \"24px 0\",\n};\n\nconst helpText = {\n\tcolor: \"#991b1b\",\n\tfontSize: \"15px\",\n\tlineHeight: \"22px\",\n\tmargin: \"12px 0 20px 0\",\n};\n\nconst contactGrid = {\n\tdisplay: \"grid\" as const,\n\tgridTemplateColumns: \"1fr 1fr\",\n\tgap: \"16px\",\n};\n\nconst contactMethod = {\n\ttextAlign: \"center\" as const,\n};\n\nconst contactLabel = {\n\tcolor: \"#6b7280\",\n\tfontSize: \"12px\",\n\ttextTransform: \"uppercase\" as const,\n\tletterSpacing: \"0.05em\",\n\tmargin: \"0 0 8px 0\",\n};\n\nconst contactLink = {\n\tcolor: \"hsl(217 91% 60%)\",\n\tfontSize: \"15px\",\n\tfontWeight: \"600\",\n\ttextDecoration: \"underline\",\n};\n\nconst footerNote = {\n\tcolor: \"#6b7280\",\n\tfontSize: \"13px\",\n\tlineHeight: \"20px\",\n\tmargin: \"32px 0 0 0\",\n\tpadding: \"20px\",\n\tbackgroundColor: \"#f9fafb\",\n\tborderRadius: \"8px\",\n\ttextAlign: \"center\" as const,\n};\n\nconst inlineLink = {\n\tcolor: \"hsl(217 91% 60%)\",\n\ttextDecoration: \"underline\",\n};\n","/**\n * Team Invitation Token Utilities\n *\n * Handles generation and verification of invitation tokens\n */\n\nimport { createHmac, randomBytes } from \"node:crypto\";\n\nconst INVITATION_SECRET =\n\tprocess.env.INVITATION_SECRET || \"fallback-secret-change-in-production\";\nconst INVITATION_EXPIRY_DAYS = 7;\n\n/**\n * Generate a secure token for invitation\n */\nexport function generateInvitationToken(payload: {\n\temail: string;\n\tcompanyId: string;\n\trole: string;\n}): string {\n\tconst data = {\n\t\t...payload,\n\t\texp: Date.now() + INVITATION_EXPIRY_DAYS * 24 * 60 * 60 * 1000,\n\t\tnonce: randomBytes(16).toString(\"hex\"),\n\t};\n\n\tconst encoded = Buffer.from(JSON.stringify(data)).toString(\"base64url\");\n\tconst signature = createHmac(\"sha256\", INVITATION_SECRET)\n\t\t.update(encoded)\n\t\t.digest(\"base64url\");\n\n\treturn `${encoded}.${signature}`;\n}\n\n/**\n * Verify an invitation token\n */\nfunction verifyInvitationToken(token: string): {\n\tvalid: boolean;\n\tpayload?: { email: string; companyId: string; role: string; exp: number };\n\terror?: string;\n} {\n\ttry {\n\t\tconst [encoded, signature] = token.split(\".\");\n\t\tif (!(encoded && signature)) {\n\t\t\treturn { valid: false, error: \"Invalid token format\" };\n\t\t}\n\n\t\t// Verify signature\n\t\tconst expectedSignature = createHmac(\"sha256\", INVITATION_SECRET)\n\t\t\t.update(encoded)\n\t\t\t.digest(\"base64url\");\n\n\t\tif (signature !== expectedSignature) {\n\t\t\treturn { valid: false, error: \"Invalid token signature\" };\n\t\t}\n\n\t\t// Decode payload\n\t\tconst payload = JSON.parse(Buffer.from(encoded, \"base64url\").toString());\n\n\t\t// Check expiration\n\t\tif (Date.now() > payload.exp) {\n\t\t\treturn { valid: false, error: \"Token expired\" };\n\t\t}\n\n\t\treturn { valid: true, payload };\n\t} catch (_error) {\n\t\treturn { valid: false, error: \"Token verification failed\" };\n\t}\n}\n","/**\n * Team Invitations - Magic Link System\n *\n * Handles sending and managing team member invitations with magic links\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport TeamInvitationEmail from \"@/emails/templates/team/invitation\";\nimport { sendPlatformEmail } from \"@/lib/email/email-router\";\nimport { EmailTemplate } from \"@/lib/email/email-types\";\nimport {\n\tActionError,\n\tERROR_CODES,\n\tERROR_MESSAGES,\n} from \"@/lib/errors/action-error\";\nimport {\n\ttype ActionResult,\n\tassertAuthenticated,\n\twithErrorHandling,\n} from \"@/lib/errors/with-error-handling\";\nimport { generateInvitationToken } from \"@/lib/auth/invitation-tokens\";\nimport { createClient } from \"@/lib/supabase/server\";\n\nconst INVITATION_EXPIRY_DAYS = 7;\n\nfunction requireSiteUrl(): string {\n\tconst siteUrl = process.env.NEXT_PUBLIC_SITE_URL;\n\tif (!siteUrl) {\n\t\tthrow new ActionError(\n\t\t\t\"NEXT_PUBLIC_SITE_URL is not configured\",\n\t\t\tERROR_CODES.INTERNAL_SERVER_ERROR,\n\t\t);\n\t}\n\treturn siteUrl.replace(/\\/$/, \"\");\n}\n\n/**\n * Send team member invitations after onboarding payment\n */\nexport async function sendTeamMemberInvitations(\n\tcompanyId: string,\n): Promise<ActionResult<{ sent: number; failed: number }>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get company and onboarding progress\n\t\tconst { data: company, error: companyError } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"id, name, onboarding_progress\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (companyError || !company) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Company not found\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t\t404,\n\t\t\t);\n\t\t}\n\n\t\t// Get team members from onboarding progress\n\t\tconst teamMembers =\n\t\t\t(company.onboarding_progress as any)?.step2?.teamMembers || [];\n\n\t\tif (!Array.isArray(teamMembers) || teamMembers.length === 0) {\n\t\t\treturn { sent: 0, failed: 0 };\n\t\t}\n\n\t\t// Get current user (the one who completed onboarding)\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\tconst { data: inviter } = await supabase\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"full_name, email\")\n\t\t\t.eq(\"id\", user.id)\n\t\t\t.single();\n\n\t\tlet sentCount = 0;\n\t\tlet failedCount = 0;\n\n\t\tconst siteUrl = requireSiteUrl();\n\n\t\t// Process each team member\n\t\tfor (const member of teamMembers) {\n\t\t\t// Skip current user\n\t\t\tif (member.isCurrentUser) {\n\t\t\t\t// Create team_members record for current user (owner)\n\t\t\t\tconst { error: ownerError } = await supabase\n\t\t\t\t\t.from(\"company_memberships\")\n\t\t\t\t\t.upsert(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\t\t\tuser_id: user.id,\n\t\t\t\t\t\t\trole: member.role,\n\t\t\t\t\t\t\tstatus: \"active\",\n\t\t\t\t\t\t\tjob_title: \"Owner\",\n\t\t\t\t\t\t\tphone: member.phone || null,\n\t\t\t\t\t\t\tjoined_at: new Date().toISOString(),\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tonConflict: \"user_id,company_id\",\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\n\t\t\t\tif (ownerError) {\n\t\t\t\t\tconsole.error(\"Failed to upsert owner membership:\", ownerError.message);\n\t\t\t\t\t// Continue - user may already have membership with different settings\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\t// Generate invitation token\n\t\t\t\tconst token = generateInvitationToken({\n\t\t\t\t\temail: member.email,\n\t\t\t\t\tcompanyId: company.id,\n\t\t\t\t\trole: member.role,\n\t\t\t\t});\n\n\t\t\t\tconst expiresAt = new Date();\n\t\t\t\texpiresAt.setDate(expiresAt.getDate() + INVITATION_EXPIRY_DAYS);\n\n\t\t\t\t// Store invitation in database\n\t\t\t\tconst { error: invitationError } = await supabase\n\t\t\t\t\t.from(\"team_invitations\")\n\t\t\t\t\t.insert({\n\t\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\t\temail: member.email,\n\t\t\t\t\t\tfirst_name: member.firstName,\n\t\t\t\t\t\tlast_name: member.lastName,\n\t\t\t\t\t\trole: member.role,\n\t\t\t\t\t\tphone: member.phone || null,\n\t\t\t\t\t\ttoken,\n\t\t\t\t\t\tinvited_by: user.id,\n\t\t\t\t\t\texpires_at: expiresAt.toISOString(),\n\t\t\t\t\t});\n\n\t\t\t\tif (invitationError) {\n\t\t\t\t\tfailedCount++;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Send invitation email\n\t\t\t\tconst magicLink = `${siteUrl}/accept-invitation?token=${token}`;\n\n\t\t\t\tconst emailResult = await sendPlatformEmail({\n\t\t\t\t\tto: member.email,\n\t\t\t\t\tsubject: `You've been invited to join ${company.name} on Thorbis`,\n\t\t\t\t\ttemplate: TeamInvitationEmail({\n\t\t\t\t\t\tinviteeName: `${member.firstName} ${member.lastName}`,\n\t\t\t\t\t\tinviterName: inviter?.name || inviter?.email || \"Your colleague\",\n\t\t\t\t\t\tcompanyName: company.name,\n\t\t\t\t\t\trole: member.role,\n\t\t\t\t\t\tmagicLink,\n\t\t\t\t\t\texpiresInDays: INVITATION_EXPIRY_DAYS,\n\t\t\t\t\t}),\n\t\t\t\t\ttemplateType: EmailTemplate.TEAM_INVITATION,\n\t\t\t\t});\n\n\t\t\t\tif (emailResult.success) {\n\t\t\t\t\tsentCount++;\n\t\t\t\t} else {\n\t\t\t\t\tfailedCount++;\n\t\t\t\t}\n\t\t\t} catch (_error) {\n\t\t\t\tfailedCount++;\n\t\t\t}\n\t\t}\n\n\t\treturn { sent: sentCount, failed: failedCount };\n\t});\n}\n\n/**\n * Send a single team invitation (for adding members after onboarding)\n */\nexport async function sendSingleTeamInvitation(\n\tformData: FormData,\n): Promise<ActionResult<string>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst { data: teamMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"company_id, companies!inner(name)\")\n\t\t\t.eq(\"user_id\", user.id)\n\t\t\t.eq(\"status\", \"active\")\n\t\t\t.single();\n\n\t\tif (!teamMember?.company_id) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"You must be part of a company to invite team members\",\n\t\t\t\tERROR_CODES.AUTH_FORBIDDEN,\n\t\t\t\t403,\n\t\t\t);\n\t\t}\n\n\t\tconst email = formData.get(\"email\") as string;\n\t\tconst firstName = formData.get(\"firstName\") as string;\n\t\tconst lastName = formData.get(\"lastName\") as string;\n\t\tconst role = formData.get(\"role\") as string;\n\t\tconst phone = formData.get(\"phone\") as string | null;\n\n\t\t// Validate inputs\n\t\tconst schema = z.object({\n\t\t\temail: z.string().email(),\n\t\t\tfirstName: z.string().min(1),\n\t\t\tlastName: z.string().min(1),\n\t\t\trole: z.enum([\"owner\", \"admin\", \"manager\", \"technician\", \"dispatcher\"]),\n\t\t});\n\n\t\tconst validated = schema.parse({ email, firstName, lastName, role });\n\n\t\t// Generate invitation token\n\t\tconst token = generateInvitationToken({\n\t\t\temail: validated.email,\n\t\t\tcompanyId: teamMember.company_id,\n\t\t\trole: validated.role,\n\t\t});\n\n\t\tconst expiresAt = new Date();\n\t\texpiresAt.setDate(expiresAt.getDate() + INVITATION_EXPIRY_DAYS);\n\n\t\t// Store invitation\n\t\tconst { error: invitationError } = await supabase\n\t\t\t.from(\"team_invitations\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: teamMember.company_id,\n\t\t\t\temail: validated.email,\n\t\t\t\tfirst_name: validated.firstName,\n\t\t\t\tlast_name: validated.lastName,\n\t\t\t\trole: validated.role,\n\t\t\t\tphone: phone || null,\n\t\t\t\ttoken,\n\t\t\t\tinvited_by: user.id,\n\t\t\t\texpires_at: expiresAt.toISOString(),\n\t\t\t});\n\n\t\tif (invitationError) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"send invitation\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Send invitation email\n\t\tconst siteUrl = requireSiteUrl();\n\t\tconst magicLink = `${siteUrl}/accept-invitation?token=${token}`;\n\n\t\tconst companies = Array.isArray(teamMember.companies)\n\t\t\t? teamMember.companies[0]\n\t\t\t: teamMember.companies;\n\n\t\tconst { data: inviter } = await supabase\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"full_name, email\")\n\t\t\t.eq(\"id\", user.id)\n\t\t\t.single();\n\n\t\tconst emailResult = await sendPlatformEmail({\n\t\t\tto: validated.email,\n\t\t\tsubject: `You've been invited to join ${companies?.name} on Thorbis`,\n\t\t\ttemplate: TeamInvitationEmail({\n\t\t\t\tinviteeName: `${validated.firstName} ${validated.lastName}`,\n\t\t\t\tinviterName: inviter?.name || inviter?.email || \"Your colleague\",\n\t\t\t\tcompanyName: companies?.name || \"the team\",\n\t\t\t\trole: validated.role,\n\t\t\t\tmagicLink,\n\t\t\t\texpiresInDays: INVITATION_EXPIRY_DAYS,\n\t\t\t}),\n\t\t\ttemplateType: \"team-invitation\",\n\t\t});\n\n\t\tif (!emailResult.success) {\n\t\t\t// Don't fail the whole operation if email fails\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\treturn \"Invitation sent successfully\";\n\t});\n}\n\n/**\n * Cancel/revoke an invitation\n */\nasync function cancelTeamInvitation(\n\tinvitationId: string,\n): Promise<ActionResult<void>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Delete invitation (RLS will ensure user has permission)\n\t\tconst { error } = await supabase\n\t\t\t.from(\"team_invitations\")\n\t\t\t.delete()\n\t\t\t.eq(\"id\", invitationId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\tERROR_MESSAGES.operationFailed(\"cancel invitation\"),\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t});\n}\n"],"names":[],"mappings":"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"}