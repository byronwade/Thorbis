{"version":3,"sources":["../../../../../../apps/web/src/actions/messaging-branding.ts","../../../../../../apps/web/src/actions/telnyx.ts","../../../../../../apps/web/src/lib/telnyx/config-validator.ts","../../../../../../apps/web/src/lib/telnyx/phone-number-setup.ts"],"sourcesContent":["\"use server\";\n\nimport type { SupabaseClient as SupabaseJsClient } from \"@supabase/supabase-js\";\nimport { revalidatePath } from \"next/cache\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport {\n\tattachNumberToCampaign,\n\tcreateTenDlcBrand,\n\tcreateTenDlcCampaign,\n\tgetTenDlcBrand,\n\tgetTenDlcCampaign,\n} from \"@/lib/telnyx/ten-dlc\";\nimport type { Database } from \"@/types/supabase\";\n\ntype TypedSupabaseClient = SupabaseJsClient<Database>;\n\ntype OwnerContactRow = {\n\tfull_name?: string | null;\n\temail?: string | null;\n\tphone?: string | null;\n};\n\nconst DEFAULT_MESSAGING_PROFILE_ID =\n\tprocess.env.TELNYX_DEFAULT_MESSAGING_PROFILE_ID ||\n\tprocess.env.NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID ||\n\t\"\";\n\nconst NANP_WITH_COUNTRY_DIGITS = 11;\nconst NANP_LOCAL_DIGITS = 10;\nconst WHITESPACE_SPLIT_REGEX = /\\s+/;\n\nfunction formatPhone(phone?: string | null): string | null {\n\tif (!phone) {\n\t\treturn null;\n\t}\n\tconst digits = phone.replace(/\\D/g, \"\");\n\tif (!digits) {\n\t\treturn null;\n\t}\n\tif (digits.length === NANP_WITH_COUNTRY_DIGITS && digits.startsWith(\"1\")) {\n\t\treturn `+${digits}`;\n\t}\n\tif (digits.length === NANP_LOCAL_DIGITS) {\n\t\treturn `+1${digits}`;\n\t}\n\treturn phone.startsWith(\"+\") ? phone : `+${digits}`;\n}\n\nfunction splitName(fullName?: string | null) {\n\tif (!fullName) {\n\t\treturn { first: \"Support\", last: \"Team\" };\n\t}\n\tconst parts = fullName.trim().split(WHITESPACE_SPLIT_REGEX);\n\tif (parts.length === 1) {\n\t\treturn { first: parts[0], last: \"Team\" };\n\t}\n\treturn { first: parts[0], last: parts.slice(1).join(\" \") };\n}\n\nfunction mapIndustryToVertical(industry?: string | null) {\n\tif (!industry) {\n\t\treturn \"PROFESSIONAL\";\n\t}\n\tconst normalized = industry.toLowerCase();\n\tif (normalized.includes(\"plumb\")) {\n\t\treturn \"HOME_SERVICES\";\n\t}\n\tif (normalized.includes(\"hvac\")) {\n\t\treturn \"HOME_SERVICES\";\n\t}\n\tif (normalized.includes(\"electric\")) {\n\t\treturn \"HOME_SERVICES\";\n\t}\n\tif (normalized.includes(\"clean\")) {\n\t\treturn \"PROFESSIONAL\";\n\t}\n\treturn \"PROFESSIONAL\";\n}\n\nasync function upsertBrandRecord(\n\tsupabase: TypedSupabaseClient,\n\tdata: Partial<Database[\"public\"][\"Tables\"][\"messaging_brands\"][\"Insert\"]> & {\n\t\tcompany_id: string;\n\t},\n) {\n\tconst { data: existing } = await supabase\n\t\t.from(\"messaging_brands\")\n\t\t.select(\"id\")\n\t\t.eq(\"company_id\", data.company_id)\n\t\t.maybeSingle();\n\n\tif (existing) {\n\t\tawait supabase\n\t\t\t.from(\"messaging_brands\")\n\t\t\t.update({ ...data, updated_at: new Date().toISOString() })\n\t\t\t.eq(\"id\", existing.id);\n\t} else {\n\t\tawait supabase\n\t\t\t.from(\"messaging_brands\")\n\t\t\t.insert(\n\t\t\t\tdata as Database[\"public\"][\"Tables\"][\"messaging_brands\"][\"Insert\"],\n\t\t\t);\n\t}\n}\n\nasync function upsertCampaignRecord(\n\tsupabase: TypedSupabaseClient,\n\tdata: Partial<\n\t\tDatabase[\"public\"][\"Tables\"][\"messaging_campaigns\"][\"Insert\"]\n\t> & {\n\t\tmessaging_brand_id: string;\n\t\tusecase: string;\n\t},\n) {\n\tconst { data: existing } = await supabase\n\t\t.from(\"messaging_campaigns\")\n\t\t.select(\"id\")\n\t\t.eq(\"messaging_brand_id\", data.messaging_brand_id)\n\t\t.eq(\"usecase\", data.usecase)\n\t\t.maybeSingle();\n\n\tif (existing) {\n\t\tawait supabase\n\t\t\t.from(\"messaging_campaigns\")\n\t\t\t.update({ ...data, updated_at: new Date().toISOString() })\n\t\t\t.eq(\"id\", existing.id);\n\t\treturn existing.id;\n\t}\n\n\tconst { data: inserted } = await supabase\n\t\t.from(\"messaging_campaigns\")\n\t\t.insert(data)\n\t\t.select(\"id\")\n\t\t.single();\n\n\treturn inserted?.id ?? null;\n}\n\n// Telnyx onboarding requires multiple guarded steps\nexport async function ensureMessagingBranding(\n\tcompanyId: string,\n\toptions?: { supabase?: TypedSupabaseClient | null },\n) {\n\tconst supabase = options?.supabase ?? (await createClient());\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Supabase unavailable\" };\n\t}\n\n\tconst { data: company, error } = await supabase\n\t\t.from(\"companies\")\n\t\t.select(\n\t\t\t\"id, name, legal_name, doing_business_as, phone, support_email, support_phone, website, website_url, brand_color, industry, address, city, state, zip_code, owner_id, ein, tax_id\",\n\t\t)\n\t\t.eq(\"id\", companyId)\n\t\t.single();\n\n\tif (error || !company) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error?.message || \"Company not found\",\n\t\t};\n\t}\n\n\tconst { data: ownerContact } = await supabase\n\t\t.from(\"profiles\")\n\t\t.select(\"full_name, email, phone\")\n\t\t.eq(\"id\", company.owner_id)\n\t\t.maybeSingle<OwnerContactRow>();\n\n\tconst contactName = splitName(ownerContact?.full_name);\n\tconst contactEmail =\n\t\townerContact?.email || company.support_email || \"support@example.com\";\n\tconst contactPhone =\n\t\tformatPhone(ownerContact?.phone) ||\n\t\tformatPhone(company.support_phone) ||\n\t\tformatPhone(company.phone) ||\n\t\t\"+18314280176\";\n\n\tconst { data: brandRow } = await supabase\n\t\t.from(\"messaging_brands\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.maybeSingle();\n\n\tif (brandRow?.telnyx_brand_id) {\n\t\tconst brandStatus = await getTenDlcBrand(brandRow.telnyx_brand_id);\n\t\tif (brandStatus.success && brandStatus.data) {\n\t\t\tawait supabase\n\t\t\t\t.from(\"messaging_brands\")\n\t\t\t\t.update({\n\t\t\t\t\tstatus: brandStatus.data.status,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", brandRow.id);\n\t\t}\n\t}\n\n\tif (!brandRow?.telnyx_brand_id) {\n\t\tconst brandPayload = {\n\t\t\tcustomer_reference: companyId,\n\t\t\tbrand_name: company.legal_name || company.name,\n\t\t\tein:\n\t\t\t\tcompany.ein ||\n\t\t\t\tcompany.tax_id ||\n\t\t\t\tprocess.env.FALLBACK_TEST_EIN ||\n\t\t\t\t\"00-0000000\",\n\t\t\tein_issuing_country: \"US\",\n\t\t\tvertical: mapIndustryToVertical(company.industry),\n\t\t\twebsite: company.website || company.website_url || null,\n\t\t\tcompany_type: \"PRIVATE_PROFIT\" as const,\n\t\t\taddress: {\n\t\t\t\tline1: company.address || \"115 Flintlock Lane\",\n\t\t\t\tcity: company.city || \"Ben Lomond\",\n\t\t\t\tstate: company.state || \"CA\",\n\t\t\t\tpostal_code: company.zip_code || \"95005\",\n\t\t\t\tcountry: \"US\",\n\t\t\t},\n\t\t\tcontact: {\n\t\t\t\tfirst_name: contactName.first,\n\t\t\t\tlast_name: contactName.last,\n\t\t\t\temail: contactEmail,\n\t\t\t\tphone: contactPhone,\n\t\t\t},\n\t\t\toptional_attributes: {\n\t\t\t\tdoing_business_as: company.doing_business_as || company.name,\n\t\t\t},\n\t\t};\n\n\t\tconst brandResult = await createTenDlcBrand(brandPayload);\n\t\tif (!(brandResult.success && brandResult.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: brandResult.error || \"Failed to create 10DLC brand\",\n\t\t\t};\n\t\t}\n\n\t\tawait upsertBrandRecord(supabase, {\n\t\t\tcompany_id: companyId,\n\t\t\ttelnyx_brand_id: brandResult.data.id,\n\t\t\tstatus: \"submitted\",\n\t\t\tlegal_name: brandPayload.brand_name,\n\t\t\tdoing_business_as: company.doing_business_as || company.name,\n\t\t\tein: brandPayload.ein,\n\t\t\tvertical: brandPayload.vertical,\n\t\t\twebsite: brandPayload.website,\n\t\t\tsupport_email: contactEmail,\n\t\t\tsupport_phone: contactPhone,\n\t\t\taddress_line1: brandPayload.address.line1,\n\t\t\tcity: brandPayload.address.city,\n\t\t\tstate: brandPayload.address.state,\n\t\t\tpostal_code: brandPayload.address.postal_code,\n\t\t\tbrand_color: company.brand_color,\n\t\t});\n\t}\n\n\trevalidatePath(\"/dashboard/settings/communications/brand\");\n\treturn { success: true };\n}\n\n// Linking campaigns touches several Telnyx APIs sequentially\nexport async function ensureMessagingCampaign(\n\tcompanyId: string,\n\tphoneNumber: { id: string; e164: string },\n\toptions?: { supabase?: TypedSupabaseClient | null },\n) {\n\tconst supabase = options?.supabase ?? (await createClient());\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Supabase unavailable\" };\n\t}\n\n\tconst { data: brand } = await supabase\n\t\t.from(\"messaging_brands\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.maybeSingle();\n\n\tif (!brand?.telnyx_brand_id) {\n\t\tconst brandResult = await ensureMessagingBranding(companyId, {\n\t\t\tsupabase,\n\t\t});\n\t\tif (!brandResult.success) {\n\t\t\treturn brandResult;\n\t\t}\n\t\treturn ensureMessagingCampaign(companyId, phoneNumber);\n\t}\n\n\tconst usecase = \"CUSTOMER_CARE\";\n\n\tconst { data: campaignRow } = await supabase\n\t\t.from(\"messaging_campaigns\")\n\t\t.select(\"*\")\n\t\t.eq(\"messaging_brand_id\", brand.id)\n\t\t.eq(\"usecase\", usecase)\n\t\t.maybeSingle();\n\n\tif (campaignRow?.telnyx_campaign_id) {\n\t\tconst campaignStatus = await getTenDlcCampaign(\n\t\t\tcampaignRow.telnyx_campaign_id,\n\t\t);\n\t\tif (campaignStatus.success && campaignStatus.data) {\n\t\t\tawait supabase\n\t\t\t\t.from(\"messaging_campaigns\")\n\t\t\t\t.update({\n\t\t\t\t\tstatus: campaignStatus.data.status,\n\t\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", campaignRow.id);\n\t\t}\n\t}\n\n\tlet campaignId = campaignRow?.id ?? null;\n\tlet telnyxCampaignId = campaignRow?.telnyx_campaign_id ?? null;\n\n\tif (!campaignRow?.telnyx_campaign_id) {\n\t\tif (!DEFAULT_MESSAGING_PROFILE_ID) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"TELNYX_DEFAULT_MESSAGING_PROFILE_ID not configured\",\n\t\t\t};\n\t\t}\n\n\t\tconst description = `${brand.doing_business_as || brand.legal_name} provides appointment updates, reminders, and service notifications to existing customers.`;\n\t\tconst sampleMessage = `Hi {{customer_name}}, this is ${\n\t\t\tbrand.doing_business_as || brand.legal_name\n\t\t} confirming your upcoming appointment. Reply HELP for assistance or STOP to opt out.`;\n\n\t\tconst campaignPayload = {\n\t\t\tbrand_id: brand.telnyx_brand_id,\n\t\t\tcampaign_alias: `${companyId}-customer-care`,\n\t\t\tusecase,\n\t\t\tdescription,\n\t\t\tsample_messages: [sampleMessage],\n\t\t\tmessage_flow:\n\t\t\t\t\"Customers opt in during onboarding or by texting our business line. They receive service updates and can opt out by replying STOP.\",\n\t\t\tterms_and_conditions:\n\t\t\t\t\"Msg & data rates may apply. Reply STOP to opt out, HELP for help.\",\n\t\t\thelp_message: `Thanks for contacting ${brand.doing_business_as || brand.legal_name}. Reply STOP to unsubscribe.`,\n\t\t\thelp_phone_number: brand.support_phone || \"+18314280176\",\n\t\t\thelp_email: brand.support_email || \"support@example.com\",\n\t\t\tauto_renewal: true,\n\t\t\tmessage_fee_credits: 0,\n\t\t\topt_in_keywords: [\"START\", \"YES\"],\n\t\t\topt_out_keywords: [\"STOP\", \"UNSUBSCRIBE\"],\n\t\t\topt_in_message:\n\t\t\t\t\"Thanks for opting in to receive messages from us. Reply STOP to opt out.\",\n\t\t\topt_out_message:\n\t\t\t\t\"You have successfully been unsubscribed and will no longer receive messages. Reply START to opt in again.\",\n\t\t};\n\n\t\tconst campaignResult = await createTenDlcCampaign(campaignPayload);\n\t\tif (!(campaignResult.success && campaignResult.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: campaignResult.error || \"Failed to create 10DLC campaign\",\n\t\t\t};\n\t\t}\n\n\t\tcampaignId =\n\t\t\t(await upsertCampaignRecord(supabase, {\n\t\t\t\tmessaging_brand_id: brand.id,\n\t\t\t\ttelnyx_campaign_id: campaignResult.data.id,\n\t\t\t\tstatus: \"submitted\",\n\t\t\t\tusecase,\n\t\t\t\tdescription,\n\t\t\t\tsample_messages: campaignPayload.sample_messages,\n\t\t\t\tmessaging_profile_id: DEFAULT_MESSAGING_PROFILE_ID,\n\t\t\t})) ||\n\t\t\tcampaignRow?.id ||\n\t\t\tnull;\n\t\ttelnyxCampaignId = campaignResult.data.id;\n\t}\n\n\tif (!(campaignId && telnyxCampaignId)) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Campaign not ready\",\n\t\t};\n\t}\n\n\tconst { data: linkRecord } = await supabase\n\t\t.from(\"messaging_campaign_phone_numbers\")\n\t\t.select(\"*\")\n\t\t.eq(\"messaging_campaign_id\", campaignId)\n\t\t.eq(\"phone_number_id\", phoneNumber.id)\n\t\t.maybeSingle();\n\n\tif (!linkRecord?.telnyx_relationship_id) {\n\t\tconst attachResult = await attachNumberToCampaign(\n\t\t\ttelnyxCampaignId,\n\t\t\tphoneNumber.e164,\n\t\t);\n\t\tif (!(attachResult.success && attachResult.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: attachResult.error || \"Failed to link number to campaign\",\n\t\t\t};\n\t\t}\n\n\t\tif (linkRecord) {\n\t\t\tawait supabase\n\t\t\t\t.from(\"messaging_campaign_phone_numbers\")\n\t\t\t\t.update({\n\t\t\t\t\ttelnyx_relationship_id: attachResult.data.id,\n\t\t\t\t\tstatus: \"submitted\",\n\t\t\t\t})\n\t\t\t\t.eq(\"id\", linkRecord.id);\n\t\t} else {\n\t\t\tawait supabase.from(\"messaging_campaign_phone_numbers\").insert({\n\t\t\t\tmessaging_campaign_id: campaignId,\n\t\t\t\tphone_number_id: phoneNumber.id,\n\t\t\t\ttelnyx_relationship_id: attachResult.data.id,\n\t\t\t\tstatus: \"submitted\",\n\t\t\t});\n\t\t}\n\t}\n\n\tawait supabase\n\t\t.from(\"phone_numbers\")\n\t\t.update({\n\t\t\ttelnyx_messaging_profile_id: DEFAULT_MESSAGING_PROFILE_ID,\n\t\t\tmetadata: {\n\t\t\t\tten_dlc_campaign_id: telnyxCampaignId,\n\t\t\t},\n\t\t})\n\t\t.eq(\"id\", phoneNumber.id);\n\n\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\treturn { success: true };\n}\n","/**\n * Telnyx Server Actions\n *\n * Server-side actions for Telnyx VoIP operations:\n * - Phone number management\n * - Call operations\n * - SMS operations\n * - Voicemail operations\n *\n * All actions include proper authentication and authorization checks.\n */\n\n\"use server\";\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { revalidatePath } from \"next/cache\";\nimport { headers } from \"next/headers\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport {\n\tanswerCall,\n\thangupCall,\n\tinitiateCall,\n\trejectCall,\n\tstartRecording,\n\tstopRecording,\n} from \"@/lib/telnyx/calls\";\nimport { TELNYX_CONFIG } from \"@/lib/telnyx/client\";\nimport {\n\tvalidateCallConfig,\n\tvalidateSmsConfig,\n} from \"@/lib/telnyx/config-validator\";\nimport { verifyConnection } from \"@/lib/telnyx/connection-setup\";\nimport { formatPhoneNumber, sendMMS, sendSMS } from \"@/lib/telnyx/messaging\";\nimport { verifyMessagingProfile } from \"@/lib/telnyx/messaging-profile-setup\";\nimport {\n\ttype NumberFeature,\n\ttype NumberType,\n\tpurchaseNumber,\n\treleaseNumber,\n\tsearchAvailableNumbers,\n} from \"@/lib/telnyx/numbers\";\nimport {\n\tverifySmsCapability,\n\tverifyVoiceCapability,\n} from \"@/lib/telnyx/phone-number-setup\";\nimport {\n\ttype CompanyTelnyxSettingsRow,\n\tensureCompanyTelnyxSetup,\n\tfetchCompanyTelnyxSettings,\n} from \"@/lib/telnyx/provision-company\";\nimport type { Database, Json } from \"@/types/supabase\";\nimport { ensureMessagingCampaign } from \"./messaging-branding\";\n\ntype TypedSupabaseClient = SupabaseClient<Database>;\n\nfunction normalizePhoneNumber(phoneNumber: string): string {\n\treturn formatPhoneNumber(phoneNumber);\n}\n\nfunction extractAreaCode(phoneNumber: string): string | null {\n\tconst digits = phoneNumber.replace(/\\D/g, \"\");\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn digits.slice(1, 4);\n\t}\n\tif (digits.length === 10) {\n\t\treturn digits.slice(0, 3);\n\t}\n\treturn null;\n}\n\nconst DEFAULT_MESSAGING_PROFILE_ID =\n\tprocess.env.TELNYX_DEFAULT_MESSAGING_PROFILE_ID ||\n\tprocess.env.NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID ||\n\t\"\";\n\nconst DEFAULT_PHONE_NUMBER_FEATURES: Json = [\"voice\", \"sms\", \"mms\"];\n\nfunction formatDisplayPhoneNumber(phoneNumber: string): string {\n\tconst digits = phoneNumber.replace(/\\D/g, \"\");\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn `+1 (${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;\n\t}\n\tif (digits.length === 10) {\n\t\treturn `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;\n\t}\n\treturn phoneNumber;\n}\n\nasync function getCompanyTelnyxSettings(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string | null,\n): Promise<CompanyTelnyxSettingsRow | null> {\n\tif (!companyId) {\n\t\treturn null;\n\t}\n\n\tconst existing = await fetchCompanyTelnyxSettings(supabase, companyId);\n\tif (existing && existing.status === \"ready\") {\n\t\treturn existing;\n\t}\n\n\tconst provisionResult = await ensureCompanyTelnyxSetup({\n\t\tcompanyId,\n\t\tsupabase,\n\t});\n\n\tif (!provisionResult.success) {\n\t\treturn null;\n\t}\n\n\treturn provisionResult.settings ?? null;\n}\n\nfunction normalizeBaseUrl(url: string): string {\n\tconst trimmed = url.trim().replace(/\\/+$/, \"\");\n\tif (/^https?:\\/\\//i.test(trimmed)) {\n\t\tif (/^http:\\/\\//i.test(trimmed) && !isLocalUrl(trimmed)) {\n\t\t\treturn trimmed.replace(/^http:\\/\\//i, \"https://\");\n\t\t}\n\t\treturn trimmed;\n\t}\n\treturn `https://${trimmed}`;\n}\n\nfunction isLocalUrl(url: string): boolean {\n\tconst lowered = url.toLowerCase();\n\treturn (\n\t\tlowered.includes(\"localhost\") ||\n\t\tlowered.includes(\"127.0.0.1\") ||\n\t\tlowered.includes(\"0.0.0.0\") ||\n\t\tlowered.endsWith(\".local\") ||\n\t\tlowered.includes(\"://local\")\n\t);\n}\n\nfunction shouldUseUrl(url: string): boolean {\n\tif (!url) {\n\t\treturn false;\n\t}\n\tconst trimmed = url.trim();\n\tif (!trimmed) {\n\t\treturn false;\n\t}\n\tconst isHostedProduction =\n\t\t(process.env.VERCEL === \"1\" && process.env.VERCEL_ENV === \"production\") ||\n\t\tprocess.env.DEPLOYMENT_ENV === \"production\";\n\n\tif (isHostedProduction && isLocalUrl(trimmed)) {\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nasync function getBaseAppUrl(): Promise<string | undefined> {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\tfor (const candidate of candidates) {\n\t\tif (candidate && shouldUseUrl(candidate)) {\n\t\t\treturn normalizeBaseUrl(candidate);\n\t\t}\n\t}\n\n\tconst vercelUrl = process.env.VERCEL_URL;\n\tif (vercelUrl && shouldUseUrl(vercelUrl)) {\n\t\treturn normalizeBaseUrl(\n\t\t\tvercelUrl.startsWith(\"http\") ? vercelUrl : `https://${vercelUrl}`,\n\t\t);\n\t}\n\n\ttry {\n\t\tconst hdrs = await headers();\n\t\tconst origin = hdrs.get(\"origin\");\n\t\tif (origin && shouldUseUrl(origin)) {\n\t\t\treturn normalizeBaseUrl(origin);\n\t\t}\n\t\tconst host = hdrs.get(\"host\");\n\t\tif (host && shouldUseUrl(host)) {\n\t\t\tconst protocol = host.includes(\"localhost\") ? \"http\" : \"https\";\n\t\t\treturn normalizeBaseUrl(`${protocol}://${host}`);\n\t\t}\n\t} catch {\n\t\t// headers() not available outside of a request context\n\t}\n\n\treturn undefined;\n}\n\nasync function buildAbsoluteUrl(path: string): Promise<string | undefined> {\n\tconst base = await getBaseAppUrl();\n\tif (!base) {\n\t\treturn undefined;\n\t}\n\tconst normalizedPath = path.startsWith(\"/\") ? path : `/${path}`;\n\treturn `${base}${normalizedPath}`;\n}\n\nasync function getTelnyxWebhookUrl(\n\tcompanyId?: string,\n): Promise<string | undefined> {\n\tif (companyId) {\n\t\treturn buildAbsoluteUrl(`/api/webhooks/telnyx?company=${companyId}`);\n\t}\n\treturn buildAbsoluteUrl(\"/api/webhooks/telnyx\");\n}\n\nasync function getPhoneNumberId(\n\tsupabase: TypedSupabaseClient,\n\tphoneNumber: string,\n): Promise<string | null> {\n\tconst normalized = normalizePhoneNumber(phoneNumber);\n\tconst { data } = await supabase\n\t\t.from(\"phone_numbers\")\n\t\t.select(\"id\")\n\t\t.eq(\"phone_number\", normalized)\n\t\t.is(\"deleted_at\", null)\n\t\t.maybeSingle();\n\n\treturn data?.id ?? null;\n}\n\nasync function ensurePhoneNumberRecordExists(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n\tphoneNumber: string | null,\n): Promise<void> {\n\tif (!phoneNumber) {\n\t\treturn;\n\t}\n\n\tconst normalized = normalizePhoneNumber(phoneNumber);\n\tconst { data } = await supabase\n\t\t.from(\"phone_numbers\")\n\t\t.select(\"id\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"phone_number\", normalized)\n\t\t.limit(1);\n\n\tif (data && data.length > 0) {\n\t\treturn;\n\t}\n\n\tawait supabase.from(\"phone_numbers\").insert({\n\t\tcompany_id: companyId,\n\t\tphone_number: normalized,\n\t\tformatted_number: formatDisplayPhoneNumber(normalized),\n\t\tcountry_code: \"US\",\n\t\tarea_code: extractAreaCode(normalized),\n\t\tnumber_type: \"local\",\n\t\tstatus: \"active\",\n\t\tfeatures: DEFAULT_PHONE_NUMBER_FEATURES,\n\t});\n}\n\nasync function resolveOutboundPhoneNumber(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n\texplicitFrom?: string | null,\n\tdefaultNumber?: string | null,\n): Promise<string | null> {\n\tif (explicitFrom) {\n\t\treturn normalizePhoneNumber(explicitFrom);\n\t}\n\n\tconst normalizedDefault = defaultNumber\n\t\t? normalizePhoneNumber(defaultNumber)\n\t\t: null;\n\n\ttry {\n\t\tconst { data } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"phone_number, number_type\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"active\");\n\n\t\tif (data && data.length > 0) {\n\t\t\tconst tollFree = data.find((n) => n.number_type === \"toll-free\");\n\t\t\tif (tollFree) {\n\t\t\t\treturn normalizePhoneNumber(tollFree.phone_number);\n\t\t\t}\n\n\t\t\tif (normalizedDefault) {\n\t\t\t\tconst defaultExists = data.some(\n\t\t\t\t\t(n) => normalizePhoneNumber(n.phone_number) === normalizedDefault,\n\t\t\t\t);\n\t\t\t\tif (defaultExists) {\n\t\t\t\t\treturn normalizedDefault;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn normalizePhoneNumber(data[0].phone_number);\n\t\t}\n\t} catch (error) {\n\t\tconsole.warn(\n\t\t\t\"Failed to load company phone numbers for outbound selection:\",\n\t\t\terror,\n\t\t);\n\t}\n\n\treturn normalizedDefault;\n}\n\nasync function mergeProviderMetadata(\n\tsupabase: TypedSupabaseClient,\n\tcommunicationId: string,\n\tpatch: Record<string, Json>,\n): Promise<void> {\n\tconst { data } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\"provider_metadata\")\n\t\t.eq(\"id\", communicationId)\n\t\t.maybeSingle();\n\n\tconst currentMetadata =\n\t\t(data?.provider_metadata as Record<string, Json> | null) ?? {};\n\tconst mergedMetadata: Record<string, Json> = {\n\t\t...currentMetadata,\n\t\t...patch,\n\t};\n\n\tawait supabase\n\t\t.from(\"communications\")\n\t\t.update({\n\t\t\tprovider_metadata: mergedMetadata,\n\t\t})\n\t\t.eq(\"id\", communicationId);\n}\n\n// =====================================================================================\n// PHONE NUMBER MANAGEMENT ACTIONS\n// =====================================================================================\n\n/**\n * Search for available phone numbers to purchase\n */\nexport async function searchPhoneNumbers(params: {\n\tareaCode?: string;\n\tnumberType?: NumberType;\n\tfeatures?: NumberFeature[];\n\tlimit?: number;\n}) {\n\ttry {\n\t\tconst result = await searchAvailableNumbers({\n\t\t\tcountryCode: \"US\",\n\t\t\tareaCode: params.areaCode,\n\t\t\tnumberType: params.numberType,\n\t\t\tfeatures: params.features,\n\t\t\tlimit: params.limit || 10,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to search phone numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Purchase a phone number and associate it with the current company\n */\nexport async function purchasePhoneNumber(params: {\n\tphoneNumber: string;\n\tcompanyId: string;\n\tbillingGroupId?: string;\n}) {\n\ttry {\n\t\t// Validate configuration\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tconst callConfig = validateCallConfig();\n\t\tif (!smsConfig.valid || !callConfig.valid) {\n\t\t\tlet errorMessage =\n\t\t\t\t\"Telnyx configuration is incomplete. Please configure all required environment variables.\";\n\n\t\t\t// If we have a suggested profile ID, include it in the error\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} to use it.`;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst normalizedPhoneNumber = normalizePhoneNumber(params.phoneNumber);\n\t\tconst formattedNumber = formatDisplayPhoneNumber(normalizedPhoneNumber);\n\t\tconst areaCode = extractAreaCode(normalizedPhoneNumber);\n\n\t\t// Purchase number from Telnyx\n\t\tconst messagingProfileId = DEFAULT_MESSAGING_PROFILE_ID || undefined;\n\n\t\tconst result = await purchaseNumber({\n\t\t\tphoneNumber: normalizedPhoneNumber,\n\t\t\tconnectionId: TELNYX_CONFIG.connectionId,\n\t\t\tmessagingProfileId,\n\t\t\tbillingGroupId: params.billingGroupId,\n\t\t\tcustomerReference: `company_${params.companyId}`,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\t// Store in database\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: params.companyId,\n\t\t\t\ttelnyx_phone_number_id: result.orderId,\n\t\t\t\ttelnyx_connection_id: TELNYX_CONFIG.connectionId,\n\t\t\t\tphone_number: normalizedPhoneNumber,\n\t\t\t\tformatted_number: formattedNumber,\n\t\t\t\tcountry_code: \"US\",\n\t\t\t\tarea_code: areaCode,\n\t\t\t\tnumber_type: \"local\",\n\t\t\t\tfeatures: [\"voice\", \"sms\"],\n\t\t\t\tstatus: \"pending\",\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\ttry {\n\t\t\tawait ensureMessagingCampaign(\n\t\t\t\tparams.companyId,\n\t\t\t\t{ id: data.id, e164: normalizedPhoneNumber },\n\t\t\t\t{ supabase },\n\t\t\t);\n\t\t} catch (_campaignError) {}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to purchase phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Get all phone numbers for a company\n */\nexport async function getCompanyPhoneNumbers(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get phone numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Update phone number configuration\n */\nasync function updatePhoneNumber(params: {\n\tphoneNumberId: string;\n\troutingRuleId?: string;\n\tforwardToNumber?: string;\n\tvoicemailEnabled?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.update({\n\t\t\t\tcall_routing_rule_id: params.routingRuleId,\n\t\t\t\tforward_to_number: params.forwardToNumber,\n\t\t\t\tvoicemail_enabled: params.voicemailEnabled,\n\t\t\t})\n\t\t\t.eq(\"id\", params.phoneNumberId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to update phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Release (delete) a phone number\n */\nasync function deletePhoneNumber(phoneNumberId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get phone number details\n\t\tconst { data: phoneNumber } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"id\", phoneNumberId)\n\t\t\t.single();\n\n\t\tif (!phoneNumber) {\n\t\t\treturn { success: false, error: \"Phone number not found\" };\n\t\t}\n\n\t\t// Release from Telnyx if we have the ID\n\t\tif (phoneNumber.telnyx_phone_number_id) {\n\t\t\tawait releaseNumber(phoneNumber.telnyx_phone_number_id);\n\t\t}\n\n\t\t// Soft delete in database\n\t\tconst { error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tstatus: \"deleted\",\n\t\t\t})\n\t\t\t.eq(\"id\", phoneNumberId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to delete phone number\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// CALL OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Initiate an outbound call\n */\nexport async function makeCall(params: {\n\tto: string;\n\tfrom: string;\n\tcompanyId: string;\n\tcustomerId?: string;\n\tjobId?: string;\n\tpropertyId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconsole.log(\"üìû makeCall called with params:\", params);\n\n\t\tconst callConfig = validateCallConfig();\n\t\tconsole.log(\"üîç Call config validation:\", callConfig);\n\t\tif (!callConfig.valid) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: callConfig.error || \"Call configuration is invalid\",\n\t\t\t};\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t);\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t\tcompanySettings?.default_outbound_number || null,\n\t\t);\n\n\t\tconst connectionOverride =\n\t\t\tcompanySettings?.call_control_application_id ||\n\t\t\tTELNYX_CONFIG.connectionId;\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings?.default_outbound_number || null,\n\t\t);\n\n\t\tif (!connectionOverride) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"No Telnyx connection configured for this company.\",\n\t\t\t};\n\t\t}\n\n\t\tif (!fromAddress) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured. Please provision numbers first.\",\n\t\t\t};\n\t\t}\n\n\t\t// TEMP: Skip connection verification - Level 2 required for API access\n\t\t// const connectionStatus = await verifyConnection(connectionOverride);\n\t\t// if (connectionStatus.needsFix) {\n\t\t// \treturn {\n\t\t// \t\tsuccess: false,\n\t\t// \t\terror: `Connection configuration issue: ${connectionStatus.issues.join(\", \")}. Run fixConnection() to auto-fix.`,\n\t\t// \t};\n\t\t// }\n\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\n\t\t// TEMP: Skip voice capability check - Level 2 required for API access\n\t\t// const voiceCapability = await verifyVoiceCapability(fromAddress);\n\t\t// if (!voiceCapability.hasVoice) {\n\t\t// \treturn {\n\t\t// \t\tsuccess: false,\n\t\t// \t\terror:\n\t\t// \t\t\tvoiceCapability.error || \"Phone number does not support voice calls\",\n\t\t// \t};\n\t\t// }\n\n\t\tconst telnyxWebhookUrl = await getTelnyxWebhookUrl(params.companyId);\n\t\tconsole.log(\"üîó Webhook URL:\", telnyxWebhookUrl);\n\t\tif (!telnyxWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\n\t\tconsole.log(\"üì§ Initiating call:\", {\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\tconnectionId: connectionOverride,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t});\n\n\t\tconst result = await initiateCall({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\tconnectionId: connectionOverride,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t\tansweringMachineDetection: \"premium\",\n\t\t});\n\n\t\tconsole.log(\"üì• Telnyx API response:\", result);\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tproperty_id: params.propertyId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"phone\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: \"\",\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_call_control_id: result.callControlId,\n\t\t\t\ttelnyx_call_session_id: result.callSessionId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\tconsole.log(\"‚úÖ Call created successfully:\", {\n\t\t\tcallControlId: result.callControlId,\n\t\t\tcommunicationId: data.id,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcallControlId: result.callControlId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"‚ùå makeCall error:\", error);\n\t\tconsole.error(\"Error details:\", {\n\t\t\tmessage: error instanceof Error ? error.message : String(error),\n\t\t\tstack: error instanceof Error ? error.stack : undefined,\n\t\t});\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to make call\",\n\t\t};\n\t}\n}\n\n/**\n * Answer an incoming call\n/**\n * Answer an incoming call\n */\nasync function acceptCall(callControlId: string) {\n\ttry {\n\t\tconst telnyxWebhookUrl = await getTelnyxWebhookUrl();\n\t\tif (!telnyxWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\t\tconst result = await answerCall({\n\t\t\tcallControlId,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to answer call\",\n\t\t};\n\t}\n}\n\n/**\n * Reject an incoming call\n */\nasync function declineCall(callControlId: string) {\n\ttry {\n\t\tconst result = await rejectCall({\n\t\t\tcallControlId,\n\t\t\tcause: \"CALL_REJECTED\",\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to reject call\",\n\t\t};\n\t}\n}\n\n/**\n * End an active call\n */\nasync function endCall(callControlId: string) {\n\ttry {\n\t\tconst result = await hangupCall({ callControlId });\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to end call\",\n\t\t};\n\t}\n}\n\n/**\n * Start recording a call\n */\nexport async function startCallRecording(callControlId: string) {\n\ttry {\n\t\tconst result = await startRecording({\n\t\t\tcallControlId,\n\t\t\tformat: \"mp3\",\n\t\t\tchannels: \"single\",\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to start recording\",\n\t\t};\n\t}\n}\n\n/**\n * Stop recording a call\n */\nexport async function stopCallRecording(callControlId: string) {\n\ttry {\n\t\tconst result = await stopRecording({ callControlId });\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to stop recording\",\n\t\t};\n\t}\n}\n\n/**\n * Transfer an active call to another number\n */\nexport async function transferActiveCall(params: {\n\tcallControlId: string;\n\tto: string;\n\tfrom: string;\n}) {\n\ttry {\n\t\tconst { transferCall } = await import(\"@/lib/telnyx/calls\");\n\t\tconst result = await transferCall({\n\t\t\tcallControlId: params.callControlId,\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to transfer call\",\n\t\t};\n\t}\n}\n\n/**\n * Transcribe a call recording using AssemblyAI\n *\n * Submits the recording URL to AssemblyAI for post-call transcription.\n * AssemblyAI will process the audio and send the transcript via webhook.\n *\n * @param recordingUrl - URL of the call recording (from Telnyx)\n * @param communicationId - Database ID of the communication record\n * @returns Success/error response with transcription job ID\n */\nexport async function transcribeCallRecording(params: {\n\trecordingUrl: string;\n\tcommunicationId: string;\n}) {\n\ttry {\n\t\tconst { submitTranscription } = await import(\"@/lib/assemblyai/client\");\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst webhookUrl = await buildAbsoluteUrl(\"/api/webhooks/assemblyai\");\n\t\tif (!webhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL.\",\n\t\t\t};\n\t\t}\n\n\t\t// Submit to AssemblyAI\n\t\tconst result = await submitTranscription({\n\t\t\taudio_url: params.recordingUrl,\n\t\t\tspeaker_labels: true, // Enable speaker diarization\n\t\t\twebhook_url: webhookUrl,\n\t\t});\n\n\t\tif (!(result.success && result.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: result.error || \"Failed to submit transcription\",\n\t\t\t};\n\t\t}\n\n\t\t// Store transcription job ID in database\n\t\tawait mergeProviderMetadata(supabase, params.communicationId, {\n\t\t\tassemblyai_transcription_id: result.data.id,\n\t\t\tassemblyai_status: result.data.status,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\ttranscriptionId: result.data.id,\n\t\t\tstatus: result.data.status,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to transcribe recording\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// SMS OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Send an SMS message\n */\nexport async function sendTextMessage(params: {\n\tto: string;\n\tfrom: string;\n\ttext: string;\n\tcompanyId?: string; // Optional - will be fetched if not provided\n\tcustomerId?: string;\n\tjobId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tconsole.error(\"‚ùå Supabase client unavailable\");\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get company ID if not provided\n\t\tlet companyId = params.companyId;\n\t\tif (!companyId) {\n\t\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\t\tcompanyId = await getActiveCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t\t}\n\t\t}\n\n\t\tconsole.log(\"üì± SMS Send Request:\", {\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t\tcompanyId,\n\t\t});\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t);\n\t\tif (!companySettings) {\n\t\t\tconsole.error(\"‚ùå Company settings not found\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Unable to provision Telnyx resources for this company. Please verify the company's onboarding is complete and try again.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\"‚úÖ Company settings loaded:\", {\n\t\t\tmessagingProfileId: companySettings.messaging_profile_id,\n\t\t\tdefaultNumber: companySettings.default_outbound_number,\n\t\t});\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tif (!smsConfig.valid && !companySettings?.messaging_profile_id) {\n\t\t\tlet errorMessage = smsConfig.error || \"SMS configuration is invalid\";\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} or provision company-specific settings.`;\n\t\t\t}\n\t\t\tconsole.error(\"‚ùå SMS config invalid:\", errorMessage);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\t\tconsole.log(\"‚úÖ SMS config valid\");\n\n\t\tconst messagingProfileId =\n\t\t\tcompanySettings?.messaging_profile_id || DEFAULT_MESSAGING_PROFILE_ID;\n\t\tif (!messagingProfileId) {\n\t\t\tconsole.error(\"‚ùå No messaging profile ID\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Messaging profile is not configured for this company. Please provision communications before sending SMS.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\"‚úÖ Using messaging profile:\", messagingProfileId);\n\n\t\tif (messagingProfileId) {\n\t\t\tconst messagingProfileStatus =\n\t\t\t\tawait verifyMessagingProfile(messagingProfileId);\n\t\t\tif (messagingProfileStatus.needsFix) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t\"‚ùå Messaging profile needs fix:\",\n\t\t\t\t\tmessagingProfileStatus.issues,\n\t\t\t\t);\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Messaging profile configuration issue: ${messagingProfileStatus.issues.join(\", \")}. Run fixMessagingProfile() or reprovision the company.`,\n\t\t\t\t};\n\t\t\t}\n\t\t\tconsole.log(\"‚úÖ Messaging profile verified\");\n\t\t}\n\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\t\tif (!fromAddress) {\n\t\t\tconsole.error(\"‚ùå No from number available\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured. Please provision numbers first.\",\n\t\t\t};\n\t\t}\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\t\tconsole.log(\"‚úÖ Phone numbers normalized:\", {\n\t\t\tfrom: fromAddress,\n\t\t\tto: toAddress,\n\t\t});\n\n\t\t// Verify phone number has SMS capability\n\t\tconsole.log(\"üîç Verifying SMS capability for:\", fromAddress);\n\t\tconst smsCapability = await verifySmsCapability(fromAddress);\n\t\tif (!smsCapability.hasSms) {\n\t\t\tconsole.error(\"‚ùå SMS capability check failed:\", smsCapability.error);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: smsCapability.error || \"Phone number does not support SMS\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\"‚úÖ SMS capability verified\");\n\n\t\tconst webhookUrl = await getTelnyxWebhookUrl(companyId);\n\t\tif (!webhookUrl) {\n\t\t\tconsole.error(\"‚ùå No webhook URL\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\"‚úÖ Webhook URL:\", webhookUrl);\n\n\t\t// Send SMS via Telnyx\n\t\tconsole.log(\"üì§ Sending SMS via Telnyx API...\");\n\t\tconst result = await sendSMS({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\ttext: params.text,\n\t\t\twebhookUrl,\n\t\t\tmessagingProfileId,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\tconsole.error(\"‚ùå Telnyx API failed:\", result.error);\n\n\t\t\t// Check if error is 10DLC registration required\n\t\t\tif (\n\t\t\t\tresult.error &&\n\t\t\t\t(result.error.includes(\"10DLC\") ||\n\t\t\t\t\tresult.error.includes(\"Not 10DLC registered\") ||\n\t\t\t\t\tresult.error.includes(\"A2P\"))\n\t\t\t) {\n\t\t\t\tconsole.log(\n\t\t\t\t\t\"üîÑ Detected 10DLC registration required, attempting auto-registration...\",\n\t\t\t\t);\n\n\t\t\t\t// Import 10DLC registration function\n\t\t\t\tconst { registerCompanyFor10DLC } = await import(\n\t\t\t\t\t\"@/actions/ten-dlc-registration\"\n\t\t\t\t);\n\n\t\t\t\tconst registrationResult = await registerCompanyFor10DLC(\n\t\t\t\t\tcompanyId,\n\t\t\t\t);\n\n\t\t\t\tif (registrationResult.success) {\n\t\t\t\t\tconsole.log(\"‚úÖ 10DLC registration successful, retrying SMS send...\");\n\n\t\t\t\t\t// Retry the SMS send now that 10DLC is registered\n\t\t\t\t\tconst retryResult = await sendSMS({\n\t\t\t\t\t\tto: toAddress,\n\t\t\t\t\t\tfrom: fromAddress,\n\t\t\t\t\t\ttext: params.text,\n\t\t\t\t\t\twebhookUrl,\n\t\t\t\t\t\tmessagingProfileId,\n\t\t\t\t\t});\n\n\t\t\t\t\tif (!retryResult.success) {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\terror: `10DLC registration completed but SMS still failed: ${retryResult.error}. The campaign may need additional approval time.`,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\t// Update result with retry success\n\t\t\t\t\tresult.success = true;\n\t\t\t\t\tresult.messageId = retryResult.messageId;\n\t\t\t\t\tconsole.log(\"‚úÖ SMS retry successful after 10DLC registration\");\n\t\t\t\t} else {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: `10DLC registration failed: ${registrationResult.error}. Original error: ${result.error}`,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treturn result;\n\t\t\t}\n\t\t}\n\t\tconsole.log(\"‚úÖ Telnyx API success:\", result.messageId);\n\n\t\t// Create communication record\n\t\tconsole.log(\"üíæ Creating communication record in database...\");\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"sms\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: params.text,\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_message_id: result.messageId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.messageId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"SMS send error:\", error);\n\t\tconsole.error(\"Error details:\", {\n\t\t\tmessage: error instanceof Error ? error.message : String(error),\n\t\t\tstack: error instanceof Error ? error.stack : undefined,\n\t\t\ttype: typeof error,\n\t\t\tstringified: JSON.stringify(error, null, 2),\n\t\t});\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: `Failed to send SMS: ${String(error)}`,\n\t\t};\n\t}\n}\n\n/**\n * Send an MMS message with media\n */\nexport async function sendMMSMessage(params: {\n\tto: string;\n\tfrom: string;\n\ttext?: string;\n\tmediaUrls: string[];\n\tcompanyId?: string; // Optional - will be fetched if not provided\n\tcustomerId?: string;\n\tjobId?: string;\n\tpropertyId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get company ID if not provided\n\t\tlet companyId = params.companyId;\n\t\tif (!companyId) {\n\t\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\t\tcompanyId = await getActiveCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t\t}\n\t\t}\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t);\n\t\tif (!companySettings) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Unable to provision Telnyx resources for this company. Please verify onboarding is complete.\",\n\t\t\t};\n\t\t}\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tif (!smsConfig.valid && !companySettings.messaging_profile_id) {\n\t\t\tlet errorMessage = smsConfig.error || \"SMS configuration is invalid\";\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} or reprovision the company.`;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\n\t\tconst messagingProfileId =\n\t\t\tcompanySettings.messaging_profile_id || DEFAULT_MESSAGING_PROFILE_ID;\n\t\tif (!messagingProfileId) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Messaging profile is not configured for this company. Please provision communications before sending MMS.\",\n\t\t\t};\n\t\t}\n\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\t\tif (!fromAddress) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured.\",\n\t\t\t};\n\t\t}\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\n\t\tconst webhookUrl = await getTelnyxWebhookUrl(companyId);\n\t\tif (!webhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\n\t\tif (messagingProfileId) {\n\t\t\tconst messagingProfileStatus =\n\t\t\t\tawait verifyMessagingProfile(messagingProfileId);\n\t\t\tif (messagingProfileStatus.needsFix) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Messaging profile configuration issue: ${messagingProfileStatus.issues.join(\", \")}. Run fixMessagingProfile() or reprovision the company.`,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tconst smsCapability = await verifySmsCapability(fromAddress);\n\t\tif (!smsCapability.hasSms) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: smsCapability.error || \"Phone number does not support SMS/MMS\",\n\t\t\t};\n\t\t}\n\n\t\tconst result = await sendMMS({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\ttext: params.text,\n\t\t\tmediaUrls: params.mediaUrls,\n\t\t\twebhookUrl,\n\t\t\tmessagingProfileId,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tproperty_id: params.propertyId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"sms\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: params.text || \"\",\n\t\t\t\tattachments: params.mediaUrls.map((url) => ({ url, type: \"image\" })),\n\t\t\t\tattachment_count: params.mediaUrls.length,\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_message_id: result.messageId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.messageId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to send MMS\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// WEBRTC OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Generate WebRTC credentials for browser calling\n */\nexport async function getWebRTCCredentials() {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t\terror: userError,\n\t\t} = await supabase.auth.getUser();\n\t\tif (userError || !user) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"User not authenticated\",\n\t\t\t};\n\t\t}\n\n\t\t// OPTION 1: Use static credentials from environment (recommended for production)\n\t\tconst staticUsername = process.env.TELNYX_WEBRTC_USERNAME;\n\t\tconst staticPassword = process.env.TELNYX_WEBRTC_PASSWORD;\n\n\t\tif (staticUsername && staticPassword) {\n\t\t\tconst credential = {\n\t\t\t\tusername: staticUsername,\n\t\t\t\tpassword: staticPassword,\n\t\t\t\texpires_at: Date.now() + 86_400 * 1000, // 24 hours from now\n\t\t\t\trealm: \"sip.telnyx.com\",\n\t\t\t\tsip_uri: `sip:${staticUsername}@sip.telnyx.com`,\n\t\t\t\tstun_servers: [\n\t\t\t\t\t\"stun:stun.telnyx.com:3478\",\n\t\t\t\t\t\"stun:stun.telnyx.com:3479\",\n\t\t\t\t],\n\t\t\t\tturn_servers: [\n\t\t\t\t\t{\n\t\t\t\t\t\turls: [\n\t\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=udp\",\n\t\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=tcp\",\n\t\t\t\t\t\t],\n\t\t\t\t\t\tusername: staticUsername,\n\t\t\t\t\t\tcredential: staticPassword,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t};\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tcredential,\n\t\t\t};\n\t\t}\n\n\t\tconst { generateWebRTCToken } = await import(\"@/lib/telnyx/webrtc\");\n\t\tconst result = await generateWebRTCToken({\n\t\t\tusername: user.email || user.id,\n\t\t\tttl: 86_400, // 24 hours\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcredential: result.credential,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get WebRTC credentials\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// VOICEMAIL OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Get all voicemails for a company\n */\nasync function getVoicemails(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        customer:customers(id, first_name, last_name, email, phone),\n        phone_number:phone_numbers(phone_number, formatted_number)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"received_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get voicemails\",\n\t\t};\n\t}\n}\n\n/**\n * Mark voicemail as read\n */\nasync function markVoicemailAsRead(voicemailId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.update({\n\t\t\t\tis_read: true,\n\t\t\t\tread_at: new Date().toISOString(),\n\t\t\t\tread_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", voicemailId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to mark voicemail as read\",\n\t\t};\n\t}\n}\n\n/**\n * Delete voicemail\n */\nasync function deleteVoicemail(voicemailId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", voicemailId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to delete voicemail\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// CALL ROUTING RULES ACTIONS\n// =====================================================================================\n\n/**\n * Get all call routing rules for a company\n */\nexport async function getCallRoutingRules(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        created_by_user:users!call_routing_rules_created_by_fkey(id, name, email),\n        forward_to_user:users!call_routing_rules_forward_to_user_id_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"priority\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get call routing rules\",\n\t\t};\n\t}\n}\n\n/**\n * Create a new call routing rule\n */\nasync function createCallRoutingRule(params: {\n\tcompanyId: string;\n\tuserId: string;\n\tname: string;\n\tdescription?: string;\n\troutingType:\n\t\t| \"direct\"\n\t\t| \"round_robin\"\n\t\t| \"ivr\"\n\t\t| \"business_hours\"\n\t\t| \"conditional\";\n\tpriority?: number;\n\tbusinessHours?: Record<string, unknown>;\n\ttimezone?: string;\n\tafterHoursAction?: \"voicemail\" | \"forward\" | \"hangup\";\n\tafterHoursForwardTo?: string;\n\tteamMembers?: string[];\n\tringTimeout?: number;\n\tivrMenu?: Record<string, unknown>;\n\tivrGreetingUrl?: string;\n\tforwardToNumber?: string;\n\tforwardToUserId?: string;\n\tenableVoicemail?: boolean;\n\tvoicemailGreetingUrl?: string;\n\tvoicemailTranscriptionEnabled?: boolean;\n\tvoicemailEmailNotifications?: boolean;\n\trecordCalls?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: params.companyId,\n\t\t\t\tcreated_by: params.userId,\n\t\t\t\tname: params.name,\n\t\t\t\tdescription: params.description,\n\t\t\t\trouting_type: params.routingType,\n\t\t\t\tpriority: params.priority || 0,\n\t\t\t\tbusiness_hours: params.businessHours,\n\t\t\t\ttimezone: params.timezone || \"America/Los_Angeles\",\n\t\t\t\tafter_hours_action: params.afterHoursAction,\n\t\t\t\tafter_hours_forward_to: params.afterHoursForwardTo,\n\t\t\t\tteam_members: params.teamMembers,\n\t\t\t\tring_timeout: params.ringTimeout || 20,\n\t\t\t\tivr_menu: params.ivrMenu,\n\t\t\t\tivr_greeting_url: params.ivrGreetingUrl,\n\t\t\t\tforward_to_number: params.forwardToNumber,\n\t\t\t\tforward_to_user_id: params.forwardToUserId,\n\t\t\t\tenable_voicemail: params.enableVoicemail !== false,\n\t\t\t\tvoicemail_greeting_url: params.voicemailGreetingUrl,\n\t\t\t\tvoicemail_transcription_enabled:\n\t\t\t\t\tparams.voicemailTranscriptionEnabled !== false,\n\t\t\t\tvoicemail_email_notifications:\n\t\t\t\t\tparams.voicemailEmailNotifications !== false,\n\t\t\t\trecord_calls: params.recordCalls,\n\t\t\t\tis_active: true,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to create call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Update an existing call routing rule\n */\nexport async function updateCallRoutingRule(params: {\n\truleId: string;\n\tname?: string;\n\tdescription?: string;\n\tpriority?: number;\n\tbusinessHours?: Record<string, unknown>;\n\ttimezone?: string;\n\tafterHoursAction?: \"voicemail\" | \"forward\" | \"hangup\";\n\tafterHoursForwardTo?: string;\n\tteamMembers?: string[];\n\tringTimeout?: number;\n\tivrMenu?: Record<string, unknown>;\n\tivrGreetingUrl?: string;\n\tforwardToNumber?: string;\n\tforwardToUserId?: string;\n\tenableVoicemail?: boolean;\n\tvoicemailGreetingUrl?: string;\n\tvoicemailTranscriptionEnabled?: boolean;\n\tvoicemailEmailNotifications?: boolean;\n\trecordCalls?: boolean;\n\tisActive?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst updateData: Record<string, unknown> = {};\n\n\t\tif (params.name !== undefined) {\n\t\t\tupdateData.name = params.name;\n\t\t}\n\t\tif (params.description !== undefined) {\n\t\t\tupdateData.description = params.description;\n\t\t}\n\t\tif (params.priority !== undefined) {\n\t\t\tupdateData.priority = params.priority;\n\t\t}\n\t\tif (params.businessHours !== undefined) {\n\t\t\tupdateData.business_hours = params.businessHours;\n\t\t}\n\t\tif (params.timezone !== undefined) {\n\t\t\tupdateData.timezone = params.timezone;\n\t\t}\n\t\tif (params.afterHoursAction !== undefined) {\n\t\t\tupdateData.after_hours_action = params.afterHoursAction;\n\t\t}\n\t\tif (params.afterHoursForwardTo !== undefined) {\n\t\t\tupdateData.after_hours_forward_to = params.afterHoursForwardTo;\n\t\t}\n\t\tif (params.teamMembers !== undefined) {\n\t\t\tupdateData.team_members = params.teamMembers;\n\t\t}\n\t\tif (params.ringTimeout !== undefined) {\n\t\t\tupdateData.ring_timeout = params.ringTimeout;\n\t\t}\n\t\tif (params.ivrMenu !== undefined) {\n\t\t\tupdateData.ivr_menu = params.ivrMenu;\n\t\t}\n\t\tif (params.ivrGreetingUrl !== undefined) {\n\t\t\tupdateData.ivr_greeting_url = params.ivrGreetingUrl;\n\t\t}\n\t\tif (params.forwardToNumber !== undefined) {\n\t\t\tupdateData.forward_to_number = params.forwardToNumber;\n\t\t}\n\t\tif (params.forwardToUserId !== undefined) {\n\t\t\tupdateData.forward_to_user_id = params.forwardToUserId;\n\t\t}\n\t\tif (params.enableVoicemail !== undefined) {\n\t\t\tupdateData.enable_voicemail = params.enableVoicemail;\n\t\t}\n\t\tif (params.voicemailGreetingUrl !== undefined) {\n\t\t\tupdateData.voicemail_greeting_url = params.voicemailGreetingUrl;\n\t\t}\n\t\tif (params.voicemailTranscriptionEnabled !== undefined) {\n\t\t\tupdateData.voicemail_transcription_enabled =\n\t\t\t\tparams.voicemailTranscriptionEnabled;\n\t\t}\n\t\tif (params.voicemailEmailNotifications !== undefined) {\n\t\t\tupdateData.voicemail_email_notifications =\n\t\t\t\tparams.voicemailEmailNotifications;\n\t\t}\n\t\tif (params.recordCalls !== undefined) {\n\t\t\tupdateData.record_calls = params.recordCalls;\n\t\t}\n\t\tif (params.isActive !== undefined) {\n\t\t\tupdateData.is_active = params.isActive;\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update(updateData)\n\t\t\t.eq(\"id\", params.ruleId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to update call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Delete a call routing rule\n */\nexport async function deleteCallRoutingRule(ruleId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", ruleId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to delete call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Toggle call routing rule active status\n */\nexport async function toggleCallRoutingRule(ruleId: string, isActive: boolean) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update({ is_active: isActive })\n\t\t\t.eq(\"id\", ruleId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to toggle call routing rule\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// PHONE NUMBER USAGE STATISTICS ACTIONS\n// =====================================================================================\n\n/**\n * Get usage statistics for a phone number\n */\nasync function getPhoneNumberUsageStats(\n\tphoneNumberId: string,\n\tdays = 30,\n) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\t// Get call statistics\n\t\tconst { data: callStats, error: callError } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, call_duration, created_at\")\n\t\t\t.eq(\"type\", \"phone\")\n\t\t\t.eq(\"phone_number_id\", phoneNumberId)\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (callError) {\n\t\t\tthrow callError;\n\t\t}\n\n\t\t// Get SMS statistics\n\t\tconst { data: smsStats, error: smsError } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, created_at\")\n\t\t\t.eq(\"type\", \"sms\")\n\t\t\t.eq(\"phone_number_id\", phoneNumberId)\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (smsError) {\n\t\t\tthrow smsError;\n\t\t}\n\n\t\t// Calculate aggregates\n\t\tconst calls = callStats || [];\n\t\tconst sms = smsStats || [];\n\n\t\tconst incomingCalls = calls.filter((c) => c.direction === \"inbound\").length;\n\t\tconst outgoingCalls = calls.filter(\n\t\t\t(c) => c.direction === \"outbound\",\n\t\t).length;\n\t\tconst totalCallDuration = calls.reduce(\n\t\t\t(sum, c) => sum + (c.call_duration || 0),\n\t\t\t0,\n\t\t);\n\t\tconst incomingSms = sms.filter((s) => s.direction === \"inbound\").length;\n\t\tconst outgoingSms = sms.filter((s) => s.direction === \"outbound\").length;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tincomingCalls,\n\t\t\t\toutgoingCalls,\n\t\t\t\ttotalCalls: incomingCalls + outgoingCalls,\n\t\t\t\ttotalCallDuration,\n\t\t\t\tincomingSms,\n\t\t\t\toutgoingSms,\n\t\t\t\ttotalSms: incomingSms + outgoingSms,\n\t\t\t\tdailyStats: aggregateDailyStats([...calls, ...sms], days),\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get usage statistics\",\n\t\t};\n\t}\n}\n\n/**\n * Get company-wide usage statistics\n */\nasync function getCompanyUsageStats(companyId: string, days = 30) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\t// Get all communications for the company\n\t\tconst { data: communications, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, call_duration, created_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.in(\"type\", [\"phone\", \"sms\"])\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\tconst items = communications || [];\n\t\tconst calls = items.filter((i) => i.type === \"phone\");\n\t\tconst sms = items.filter((i) => i.type === \"sms\");\n\n\t\tconst incomingCalls = calls.filter((c) => c.direction === \"inbound\").length;\n\t\tconst outgoingCalls = calls.filter(\n\t\t\t(c) => c.direction === \"outbound\",\n\t\t).length;\n\t\tconst totalCallDuration = calls.reduce(\n\t\t\t(sum, c) => sum + (c.call_duration || 0),\n\t\t\t0,\n\t\t);\n\t\tconst incomingSms = sms.filter((s) => s.direction === \"inbound\").length;\n\t\tconst outgoingSms = sms.filter((s) => s.direction === \"outbound\").length;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tincomingCalls,\n\t\t\t\toutgoingCalls,\n\t\t\t\ttotalCalls: incomingCalls + outgoingCalls,\n\t\t\t\ttotalCallDuration,\n\t\t\t\taverageCallDuration:\n\t\t\t\t\tcalls.length > 0 ? totalCallDuration / calls.length : 0,\n\t\t\t\tincomingSms,\n\t\t\t\toutgoingSms,\n\t\t\t\ttotalSms: incomingSms + outgoingSms,\n\t\t\t\tdailyStats: aggregateDailyStats(items, days),\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get usage statistics\",\n\t\t};\n\t}\n}\n\n/**\n * Helper function to aggregate daily statistics\n */\nfunction aggregateDailyStats(\n\titems: Array<{ created_at: string; type: string; call_duration?: number }>,\n\tdays: number,\n) {\n\tconst dailyStats: Record<\n\t\tstring,\n\t\t{ date: string; calls: number; sms: number; duration: number }\n\t> = {};\n\n\t// Initialize all days\n\tfor (let i = 0; i < days; i++) {\n\t\tconst date = new Date();\n\t\tdate.setDate(date.getDate() - i);\n\t\tconst dateStr = date.toISOString().split(\"T\")[0];\n\t\tdailyStats[dateStr] = { date: dateStr, calls: 0, sms: 0, duration: 0 };\n\t}\n\n\t// Aggregate data\n\titems.forEach((item) => {\n\t\tconst dateStr = item.created_at.split(\"T\")[0];\n\t\tif (dailyStats[dateStr]) {\n\t\t\tif (item.type === \"phone\") {\n\t\t\t\tdailyStats[dateStr].calls += 1;\n\t\t\t\tdailyStats[dateStr].duration += item.call_duration || 0;\n\t\t\t} else if (item.type === \"sms\") {\n\t\t\t\tdailyStats[dateStr].sms += 1;\n\t\t\t}\n\t\t}\n\t});\n\n\treturn Object.values(dailyStats).sort((a, b) => a.date.localeCompare(b.date));\n}\n","/**\n * Telnyx Configuration Validator\n *\n * Validates all required Telnyx environment variables and configuration.\n * Provides clear error messages for missing or invalid configuration.\n */\n\nimport { TELNYX_CONFIG } from \"./client\";\n\nexport type ValidationResult = {\n\tvalid: boolean;\n\terrors: string[];\n\twarnings: string[];\n\tconfig: {\n\t\tapiKey: boolean;\n\t\tconnectionId: boolean;\n\t\tmessagingProfileId: boolean;\n\t\twebhookSecret: boolean;\n\t\tpublicKey: boolean;\n\t\tsiteUrl: boolean;\n\t};\n};\n\nfunction isLocalUrl(url: string): boolean {\n\tconst lowered = url.toLowerCase();\n\treturn (\n\t\tlowered.includes(\"localhost\") ||\n\t\tlowered.includes(\"127.0.0.1\") ||\n\t\tlowered.includes(\"0.0.0.0\") ||\n\t\tlowered.endsWith(\".local\") ||\n\t\tlowered.includes(\"://local\")\n\t);\n}\n\nfunction getBaseAppUrl(): string | undefined {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\tfor (const candidate of candidates) {\n\t\tif (candidate && candidate.trim()) {\n\t\t\tconst trimmed = candidate.trim();\n\t\t\tif (!isLocalUrl(trimmed)) {\n\t\t\t\treturn trimmed.startsWith(\"http\") ? trimmed : `https://${trimmed}`;\n\t\t\t}\n\t\t}\n\t}\n\n\tconst vercelUrl = process.env.VERCEL_URL;\n\tif (vercelUrl && !isLocalUrl(vercelUrl)) {\n\t\treturn vercelUrl.startsWith(\"http\") ? vercelUrl : `https://${vercelUrl}`;\n\t}\n\n\treturn undefined;\n}\n\n/**\n * Validate all Telnyx configuration\n */\nexport function validateTelnyxConfig(): ValidationResult {\n\tconst errors: string[] = [];\n\tconst warnings: string[] = [];\n\tconst config = {\n\t\tapiKey: false,\n\t\tconnectionId: false,\n\t\tmessagingProfileId: false,\n\t\twebhookSecret: false,\n\t\tpublicKey: false,\n\t\tsiteUrl: false,\n\t};\n\n\t// Check API Key (required)\n\tif (!TELNYX_CONFIG.apiKey || TELNYX_CONFIG.apiKey.trim() === \"\") {\n\t\terrors.push(\n\t\t\t\"TELNYX_API_KEY is not set. This is required for all Telnyx operations.\",\n\t\t);\n\t} else if (TELNYX_CONFIG.apiKey.length < 20) {\n\t\terrors.push(\n\t\t\t\"TELNYX_API_KEY appears to be invalid (too short). Get your API key from https://portal.telnyx.com\",\n\t\t);\n\t} else {\n\t\tconfig.apiKey = true;\n\t}\n\n\t// Check Connection ID (required for voice calls)\n\tif (!TELNYX_CONFIG.connectionId || TELNYX_CONFIG.connectionId.trim() === \"\") {\n\t\terrors.push(\n\t\t\t\"NEXT_PUBLIC_TELNYX_CONNECTION_ID is not set. This is required for phone calls. Get it from Telnyx Portal ‚Üí Mission Control ‚Üí Connections.\",\n\t\t);\n\t} else {\n\t\tconfig.connectionId = true;\n\t}\n\n\t// Check Messaging Profile ID (required for SMS)\n\tif (\n\t\t!TELNYX_CONFIG.messagingProfileId ||\n\t\tTELNYX_CONFIG.messagingProfileId.trim() === \"\"\n\t) {\n\t\terrors.push(\n\t\t\t\"TELNYX_DEFAULT_MESSAGING_PROFILE_ID or NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID is not set. This is required for SMS/MMS. Run getDefaultMessagingProfile() to fetch it automatically from Telnyx.\",\n\t\t);\n\t} else {\n\t\tconfig.messagingProfileId = true;\n\t}\n\n\t// Check Webhook Secret (recommended for production)\n\tif (\n\t\t!TELNYX_CONFIG.webhookSecret ||\n\t\tTELNYX_CONFIG.webhookSecret.trim() === \"\"\n\t) {\n\t\twarnings.push(\n\t\t\t\"TELNYX_WEBHOOK_SECRET is not set. Webhook signature verification will be disabled. Set this in production for security.\",\n\t\t);\n\t} else {\n\t\tconfig.webhookSecret = true;\n\t}\n\n\t// Check Public Key (recommended for production)\n\tif (!TELNYX_CONFIG.publicKey || TELNYX_CONFIG.publicKey.trim() === \"\") {\n\t\twarnings.push(\n\t\t\t\"TELNYX_PUBLIC_KEY is not set. Webhook signature verification may not work correctly. Get it from Telnyx Portal ‚Üí API Keys.\",\n\t\t);\n\t} else {\n\t\tconfig.publicKey = true;\n\t}\n\n\t// Check Site URL (required for webhooks)\n\tconst siteUrl = getBaseAppUrl();\n\tif (!siteUrl) {\n\t\terrors.push(\n\t\t\t\"NEXT_PUBLIC_SITE_URL or SITE_URL is not set to a valid production URL. This is required for webhook callbacks. Set it to your production domain (e.g., https://thorbis.co).\",\n\t\t);\n\t} else if (isLocalUrl(siteUrl)) {\n\t\tconst isProduction =\n\t\t\tprocess.env.VERCEL_ENV === \"production\" ||\n\t\t\tprocess.env.DEPLOYMENT_ENV === \"production\";\n\t\tif (isProduction) {\n\t\t\terrors.push(\n\t\t\t\t`Site URL is set to localhost (${siteUrl}) but you're in production. Set NEXT_PUBLIC_SITE_URL to your production domain.`,\n\t\t\t);\n\t\t} else {\n\t\t\twarnings.push(\n\t\t\t\t`Site URL is set to localhost (${siteUrl}). This will not work in production.`,\n\t\t\t);\n\t\t}\n\t} else {\n\t\tconfig.siteUrl = true;\n\t}\n\n\treturn {\n\t\tvalid: errors.length === 0,\n\t\terrors,\n\t\twarnings,\n\t\tconfig,\n\t};\n}\n\n/**\n * Validate configuration for SMS operations\n */\nexport async function validateSmsConfig(): Promise<{\n\tvalid: boolean;\n\terror?: string;\n\tsuggestedProfileId?: string;\n}> {\n\tconst validation = validateTelnyxConfig();\n\n\tif (!validation.config.apiKey) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: \"TELNYX_API_KEY is required for SMS operations\",\n\t\t};\n\t}\n\n\tif (!validation.config.messagingProfileId) {\n\t\t// Try to fetch messaging profile automatically\n\t\ttry {\n\t\t\tconst { getDefaultMessagingProfile } = await import(\n\t\t\t\t\"./messaging-profile-fetcher\"\n\t\t\t);\n\t\t\tconst profileResult = await getDefaultMessagingProfile();\n\n\t\t\tif (profileResult.success && profileResult.profile) {\n\t\t\t\treturn {\n\t\t\t\t\tvalid: false,\n\t\t\t\t\terror:\n\t\t\t\t\t\t\"TELNYX_DEFAULT_MESSAGING_PROFILE_ID is required for SMS operations.\",\n\t\t\t\t\tsuggestedProfileId: profileResult.profile.id,\n\t\t\t\t};\n\t\t\t}\n\t\t} catch {\n\t\t\t// If fetch fails, return generic error\n\t\t}\n\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"TELNYX_DEFAULT_MESSAGING_PROFILE_ID is required for SMS operations. Run getDefaultMessagingProfile() to fetch it automatically from Telnyx.\",\n\t\t};\n\t}\n\n\tif (!validation.config.siteUrl) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be set to a valid production URL for SMS webhooks.\",\n\t\t};\n\t}\n\n\treturn { valid: true };\n}\n\n/**\n * Validate configuration for voice call operations\n */\nexport function validateCallConfig(): {\n\tvalid: boolean;\n\terror?: string;\n} {\n\tconst validation = validateTelnyxConfig();\n\n\tif (!validation.config.apiKey) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: \"TELNYX_API_KEY is required for phone calls\",\n\t\t};\n\t}\n\n\tif (!validation.config.connectionId) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_TELNYX_CONNECTION_ID is required for phone calls. Get it from Telnyx Portal ‚Üí Mission Control ‚Üí Connections.\",\n\t\t};\n\t}\n\n\tif (!validation.config.siteUrl) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be set to a valid production URL for call webhooks.\",\n\t\t};\n\t}\n\n\treturn { valid: true };\n}\n\n/**\n * Get formatted error message for display to users\n */\nfunction getFormattedErrorMessage(validation: ValidationResult): string {\n\tif (validation.valid) {\n\t\treturn \"\";\n\t}\n\n\tconst lines = [\"Telnyx configuration errors:\"];\n\tvalidation.errors.forEach((error, index) => {\n\t\tlines.push(`${index + 1}. ${error}`);\n\t});\n\n\tif (validation.warnings.length > 0) {\n\t\tlines.push(\"\");\n\t\tlines.push(\"Warnings:\");\n\t\tvalidation.warnings.forEach((warning, index) => {\n\t\t\tlines.push(`${index + 1}. ${warning}`);\n\t\t});\n\t}\n\n\treturn lines.join(\"\\n\");\n}\n","/**\n * Phone Number Setup & Verification\n *\n * Verifies phone numbers are properly configured in Telnyx and can auto-fix issues.\n */\n\nimport { TELNYX_CONFIG } from \"./client\";\nimport {\n\tgetNumberDetails,\n\tlistOwnedNumbers,\n\ttype NumberFeature,\n\tupdateNumber,\n} from \"./numbers\";\n\nexport type PhoneNumberStatus = {\n\texists: boolean;\n\thasMessagingProfile: boolean;\n\thasConnection: boolean;\n\tcapabilities: {\n\t\tsms: boolean;\n\t\tvoice: boolean;\n\t\tmms: boolean;\n\t};\n\tneedsFix: boolean;\n\tissues: string[];\n};\n\nexport type PhoneNumberFixResult = {\n\tsuccess: boolean;\n\tfixed: boolean;\n\terror?: string;\n\tchanges: string[];\n};\n\n/**\n * Find phone number ID by phone number string\n */\nasync function findPhoneNumberId(\n\tphoneNumber: string,\n): Promise<{ success: boolean; phoneNumberId?: string; error?: string }> {\n\ttry {\n\t\t// Normalize phone number (E.164 format)\n\t\tconst normalized = phoneNumber.replace(/\\D/g, \"\");\n\t\tconst e164 = normalized.startsWith(\"+\")\n\t\t\t? phoneNumber\n\t\t\t: normalized.startsWith(\"1\") && normalized.length === 11\n\t\t\t\t? `+${normalized}`\n\t\t\t\t: `+1${normalized}`;\n\n\t\t// List all owned numbers and find matching one\n\t\tconst result = await listOwnedNumbers({ pageSize: 100 });\n\t\tif (!result.success || !result.data) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Failed to list phone numbers from Telnyx\",\n\t\t\t};\n\t\t}\n\n\t\tconst numbers = Array.isArray(result.data) ? result.data : [result.data];\n\t\tconst matching = numbers.find(\n\t\t\t(num: any) =>\n\t\t\t\tnum.phone_number === e164 ||\n\t\t\t\tnum.phone_number === phoneNumber ||\n\t\t\t\tnum.phone_number?.replace(/\\D/g, \"\") === normalized,\n\t\t);\n\n\t\tif (!matching) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Phone number ${phoneNumber} not found in Telnyx account`,\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tphoneNumberId: matching.id,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to find phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Verify phone number configuration\n */\nexport async function verifyPhoneNumber(\n\tphoneNumber: string,\n): Promise<PhoneNumberStatus> {\n\tconst status: PhoneNumberStatus = {\n\t\texists: false,\n\t\thasMessagingProfile: false,\n\t\thasConnection: false,\n\t\tcapabilities: {\n\t\t\tsms: false,\n\t\t\tvoice: false,\n\t\t\tmms: false,\n\t\t},\n\t\tneedsFix: false,\n\t\tissues: [],\n\t};\n\n\ttry {\n\t\t// Find phone number ID\n\t\tconst findResult = await findPhoneNumberId(phoneNumber);\n\t\tif (!findResult.success || !findResult.phoneNumberId) {\n\t\t\tstatus.issues.push(\n\t\t\t\tfindResult.error || \"Phone number not found in Telnyx\",\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t\treturn status;\n\t\t}\n\n\t\tstatus.exists = true;\n\n\t\t// Get phone number details\n\t\tconst detailsResult = await getNumberDetails(findResult.phoneNumberId);\n\t\tif (!detailsResult.success || !detailsResult.data) {\n\t\t\tstatus.issues.push(\"Failed to retrieve phone number details\");\n\t\t\tstatus.needsFix = true;\n\t\t\treturn status;\n\t\t}\n\n\t\tconst numberData = detailsResult.data as any;\n\n\t\t// Check messaging profile\n\t\tif (numberData.messaging_profile_id) {\n\t\t\tstatus.hasMessagingProfile = true;\n\t\t} else {\n\t\t\tstatus.issues.push(\n\t\t\t\t\"Phone number is not associated with a messaging profile\",\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\t// Check connection\n\t\tif (numberData.connection_id) {\n\t\t\tstatus.hasConnection = true;\n\t\t} else {\n\t\t\tstatus.issues.push(\"Phone number is not associated with a connection\");\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\t// Check capabilities from phone number features\n\t\tconst features = (numberData.features || []) as string[];\n\t\tconst hasFeaturesSms = features.includes(\"sms\");\n\t\tconst hasFeaturesVoice = features.includes(\"voice\");\n\t\tconst hasFeaturesMms = features.includes(\"mms\");\n\n\t\t// Also check messaging settings endpoint for SMS/MMS status\n\t\tlet messagingEnabled = false;\n\t\ttry {\n\t\t\tconst TELNYX_API_KEY = process.env.TELNYX_API_KEY;\n\t\t\tif (TELNYX_API_KEY) {\n\t\t\t\tconst messagingResponse = await fetch(\n\t\t\t\t\t`https://api.telnyx.com/v2/phone_numbers/${findResult.phoneNumberId}/messaging`,\n\t\t\t\t\t{\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\tAuthorization: `Bearer ${TELNYX_API_KEY}`,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tif (messagingResponse.ok) {\n\t\t\t\t\tconst messagingData = await messagingResponse.json();\n\t\t\t\t\tconst messagingFeatures = messagingData?.data?.features;\n\t\t\t\t\tif (\n\t\t\t\t\t\tmessagingFeatures?.sms?.domestic_two_way ||\n\t\t\t\t\t\tmessagingFeatures?.mms?.domestic_two_way\n\t\t\t\t\t) {\n\t\t\t\t\t\tmessagingEnabled = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\t// Ignore errors - fall back to features check\n\t\t}\n\n\t\t// Consider SMS enabled if either features include it OR messaging settings confirm it\n\t\tstatus.capabilities.sms = hasFeaturesSms || messagingEnabled;\n\t\tstatus.capabilities.voice = hasFeaturesVoice;\n\t\tstatus.capabilities.mms = hasFeaturesMms || messagingEnabled;\n\n\t\tif (!status.capabilities.sms) {\n\t\t\tstatus.issues.push(\"Phone number does not have SMS capability\");\n\t\t}\n\t\tif (!status.capabilities.voice) {\n\t\t\tstatus.issues.push(\"Phone number does not have voice capability\");\n\t\t}\n\n\t\treturn status;\n\t} catch (error) {\n\t\tstatus.issues.push(\n\t\t\terror instanceof Error ? error.message : \"Unknown error\",\n\t\t);\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n}\n\n/**\n * Auto-fix phone number configuration\n */\nexport async function fixPhoneNumber(\n\tphoneNumber: string,\n\toptions?: {\n\t\tmessagingProfileId?: string;\n\t\tconnectionId?: string;\n\t},\n): Promise<PhoneNumberFixResult> {\n\tconst changes: string[] = [];\n\n\ttry {\n\t\t// Find phone number ID\n\t\tconst findResult = await findPhoneNumberId(phoneNumber);\n\t\tif (!findResult.success || !findResult.phoneNumberId) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tfixed: false,\n\t\t\t\terror: findResult.error || \"Phone number not found\",\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Get current status\n\t\tconst status = await verifyPhoneNumber(phoneNumber);\n\t\tif (!status.needsFix) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tfixed: false,\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Prepare update parameters\n\t\tconst updateParams: {\n\t\t\tphoneNumberId: string;\n\t\t\tmessagingProfileId?: string;\n\t\t\tconnectionId?: string;\n\t\t} = {\n\t\t\tphoneNumberId: findResult.phoneNumberId,\n\t\t};\n\n\t\t// Fix messaging profile\n\t\tif (!status.hasMessagingProfile) {\n\t\t\tconst messagingProfileId =\n\t\t\t\toptions?.messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\t\t\tif (messagingProfileId) {\n\t\t\t\tupdateParams.messagingProfileId = messagingProfileId;\n\t\t\t\tchanges.push(\n\t\t\t\t\t`Assigned messaging profile ${messagingProfileId} to phone number`,\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tfixed: false,\n\t\t\t\t\terror:\n\t\t\t\t\t\t\"Messaging profile ID is required but not configured. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID.\",\n\t\t\t\t\tchanges: [],\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Fix connection\n\t\tif (!status.hasConnection) {\n\t\t\tconst connectionId = options?.connectionId || TELNYX_CONFIG.connectionId;\n\t\t\tif (connectionId) {\n\t\t\t\tupdateParams.connectionId = connectionId;\n\t\t\t\tchanges.push(`Assigned connection ${connectionId} to phone number`);\n\t\t\t} else {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tfixed: false,\n\t\t\t\t\terror:\n\t\t\t\t\t\t\"Connection ID is required but not configured. Set NEXT_PUBLIC_TELNYX_CONNECTION_ID.\",\n\t\t\t\t\tchanges: [],\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Apply updates if needed\n\t\tif (updateParams.messagingProfileId || updateParams.connectionId) {\n\t\t\tconst updateResult = await updateNumber(updateParams);\n\t\t\tif (!updateResult.success) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tfixed: false,\n\t\t\t\t\terror: updateResult.error || \"Failed to update phone number\",\n\t\t\t\t\tchanges,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tfixed: changes.length > 0,\n\t\t\tchanges,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\tchanges,\n\t\t};\n\t}\n}\n\n/**\n * Verify phone number has SMS capability\n */\nexport async function verifySmsCapability(\n\tphoneNumber: string,\n): Promise<{ hasSms: boolean; error?: string }> {\n\tconst status = await verifyPhoneNumber(phoneNumber);\n\n\tif (!status.exists) {\n\t\treturn {\n\t\t\thasSms: false,\n\t\t\terror: \"Phone number not found in Telnyx\",\n\t\t};\n\t}\n\n\tif (!status.capabilities.sms) {\n\t\treturn {\n\t\t\thasSms: false,\n\t\t\terror: \"Phone number does not have SMS capability\",\n\t\t};\n\t}\n\n\tif (!status.hasMessagingProfile) {\n\t\treturn {\n\t\t\thasSms: false,\n\t\t\terror: \"Phone number is not associated with a messaging profile\",\n\t\t};\n\t}\n\n\treturn { hasSms: true };\n}\n\n/**\n * Verify phone number has voice capability\n */\nexport async function verifyVoiceCapability(\n\tphoneNumber: string,\n): Promise<{ hasVoice: boolean; error?: string }> {\n\tconst status = await verifyPhoneNumber(phoneNumber);\n\n\tif (!status.exists) {\n\t\treturn {\n\t\t\thasVoice: false,\n\t\t\terror: \"Phone number not found in Telnyx\",\n\t\t};\n\t}\n\n\tif (!status.capabilities.voice) {\n\t\treturn {\n\t\t\thasVoice: false,\n\t\t\terror: \"Phone number does not have voice capability\",\n\t\t};\n\t}\n\n\tif (!status.hasConnection) {\n\t\treturn {\n\t\t\thasVoice: false,\n\t\t\terror: \"Phone number is not associated with a connection\",\n\t\t};\n\t}\n\n\treturn { hasVoice: true };\n}\n"],"names":[],"mappings":"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"}