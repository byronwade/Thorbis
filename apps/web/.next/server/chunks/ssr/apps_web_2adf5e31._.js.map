{"version":3,"sources":["../../../../../../apps/web/src/actions/maintenance-plans.ts","../../../../../../apps/web/.next-internal/server/app/%28dashboard%29/dashboard/work/maintenance-plans/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["/**\n * Maintenance Plans Server Actions\n *\n * Handles recurring maintenance plan management with comprehensive CRUD operations,\n * service scheduling, billing, and customer relationship management.\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport { ActionError, ERROR_CODES } from \"@/lib/errors/action-error\";\nimport {\n\ttype ActionResult,\n\tassertAuthenticated,\n\tassertExists,\n\twithErrorHandling,\n} from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// Validation Schemas\nconst createMaintenancePlanSchema = z.object({\n\tcustomerId: z.string().uuid(\"Invalid customer ID\"),\n\tpropertyId: z.string().uuid(\"Invalid property ID\").optional(),\n\tname: z.string().min(1, \"Plan name is required\"),\n\tdescription: z.string().optional(),\n\tfrequency: z.enum([\n\t\t\"weekly\",\n\t\t\"biweekly\",\n\t\t\"monthly\",\n\t\t\"quarterly\",\n\t\t\"semiannual\",\n\t\t\"annual\",\n\t\t\"custom\",\n\t]),\n\tcustomFrequencyDays: z.number().int().min(1).optional(),\n\tstartDate: z.string().min(1, \"Start date is required\"),\n\tendDate: z.string().optional(),\n\tamount: z.number().min(0).optional(),\n\tcurrency: z.string().default(\"USD\"),\n\tbillingFrequency: z\n\t\t.enum([\"monthly\", \"quarterly\", \"annual\", \"one_time\"])\n\t\t.optional(),\n\tautoRenew: z.boolean().default(true),\n\tservicesIncluded: z.array(z.any()).optional(),\n\tterms: z.string().optional(),\n\tnotes: z.string().optional(),\n});\n\nconst updateMaintenancePlanSchema = z.object({\n\tname: z.string().min(1, \"Plan name is required\").optional(),\n\tdescription: z.string().optional(),\n\tstatus: z\n\t\t.enum([\"draft\", \"active\", \"paused\", \"expired\", \"cancelled\"])\n\t\t.optional(),\n\tfrequency: z\n\t\t.enum([\n\t\t\t\"weekly\",\n\t\t\t\"biweekly\",\n\t\t\t\"monthly\",\n\t\t\t\"quarterly\",\n\t\t\t\"semiannual\",\n\t\t\t\"annual\",\n\t\t\t\"custom\",\n\t\t])\n\t\t.optional(),\n\tcustomFrequencyDays: z.number().int().min(1).optional(),\n\tstartDate: z.string().optional(),\n\tendDate: z.string().optional(),\n\tnextServiceDate: z.string().optional(),\n\tamount: z.number().min(0).optional(),\n\tbillingFrequency: z\n\t\t.enum([\"monthly\", \"quarterly\", \"annual\", \"one_time\"])\n\t\t.optional(),\n\tautoRenew: z.boolean().optional(),\n\tservicesIncluded: z.array(z.any()).optional(),\n\tterms: z.string().optional(),\n\tnotes: z.string().optional(),\n});\n\n/**\n * Generate unique maintenance plan number using database function\n */\n// Maintenance plan number regex pattern (at top level for performance)\nconst MAINTENANCE_PLAN_NUMBER_REGEX = /MP-(\\d+)/;\n\nasync function generateMaintenancePlanNumber(\n\tsupabase: Awaited<ReturnType<typeof createClient>>,\n\tcompanyId: string,\n): Promise<string> {\n\tconst { data, error } = await supabase.rpc(\n\t\t\"generate_maintenance_plan_number\",\n\t\t{\n\t\t\tp_company_id: companyId,\n\t\t},\n\t);\n\n\tif (error || !data) {\n\t\t// Fallback to manual generation\n\t\tconst { data: latestPlan } = await supabase\n\t\t\t.from(\"maintenance_plans\")\n\t\t\t.select(\"plan_number\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(1)\n\t\t\t.single();\n\n\t\tif (!latestPlan) {\n\t\t\treturn \"MP-000001\";\n\t\t}\n\n\t\tconst match = latestPlan.plan_number.match(MAINTENANCE_PLAN_NUMBER_REGEX);\n\t\tif (match) {\n\t\t\tconst nextNumber = Number.parseInt(match[1], 10) + 1;\n\t\t\treturn `MP-${nextNumber.toString().padStart(6, \"0\")}`;\n\t\t}\n\n\t\treturn `MP-${Date.now().toString().slice(-6)}`;\n\t}\n\n\treturn data;\n}\n\n/**\n * Calculate next service date based on frequency\n */\nasync function calculateNextServiceDate(\n\tsupabase: any,\n\tlastServiceDate: string,\n\tfrequency: string,\n\tcustomFrequencyDays?: number,\n): Promise<string> {\n\tconst { data, error } = await supabase.rpc(\"calculate_next_service_date\", {\n\t\tp_last_service_date: lastServiceDate,\n\t\tp_frequency: frequency,\n\t\tp_custom_frequency_days: customFrequencyDays,\n\t});\n\n\tif (error || !data) {\n\t\t// Fallback calculation\n\t\tconst date = new Date(lastServiceDate);\n\n\t\tswitch (frequency) {\n\t\t\tcase \"weekly\":\n\t\t\t\tdate.setDate(date.getDate() + 7);\n\t\t\t\tbreak;\n\t\t\tcase \"biweekly\":\n\t\t\t\tdate.setDate(date.getDate() + 14);\n\t\t\t\tbreak;\n\t\t\tcase \"monthly\":\n\t\t\t\tdate.setMonth(date.getMonth() + 1);\n\t\t\t\tbreak;\n\t\t\tcase \"quarterly\":\n\t\t\t\tdate.setMonth(date.getMonth() + 3);\n\t\t\t\tbreak;\n\t\t\tcase \"semiannual\":\n\t\t\t\tdate.setMonth(date.getMonth() + 6);\n\t\t\t\tbreak;\n\t\t\tcase \"annual\":\n\t\t\t\tdate.setFullYear(date.getFullYear() + 1);\n\t\t\t\tbreak;\n\t\t\tcase \"custom\":\n\t\t\t\tif (customFrequencyDays) {\n\t\t\t\t\tdate.setDate(date.getDate() + customFrequencyDays);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t}\n\n\t\treturn date.toISOString().split(\"T\")[0];\n\t}\n\n\treturn data;\n}\n\n/**\n * Validate maintenance plan dates\n */\nfunction validateMaintenancePlanDates(\n\tstartDate: string,\n\tendDate?: string,\n): void {\n\tconst start = new Date(startDate);\n\tconst now = new Date();\n\tnow.setHours(0, 0, 0, 0);\n\n\tif (start < now) {\n\t\tthrow new ActionError(\n\t\t\t\"Start date cannot be in the past\",\n\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t);\n\t}\n\n\tif (endDate) {\n\t\tconst end = new Date(endDate);\n\t\tif (end <= start) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"End date must be after start date\",\n\t\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t\t);\n\t\t}\n\t}\n}\n\n/**\n * Create a new maintenance plan\n */\nasync function createMaintenancePlan(\n\tformData: FormData,\n): Promise<ActionResult<string>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Parse services included if provided\n\t\tlet servicesIncluded: any[] = [];\n\t\tconst servicesStr = formData.get(\"servicesIncluded\") as string;\n\t\tif (servicesStr) {\n\t\t\ttry {\n\t\t\t\tservicesIncluded = JSON.parse(servicesStr);\n\t\t\t} catch {\n\t\t\t\t// Ignore parse errors, use empty array\n\t\t\t}\n\t\t}\n\n\t\t// Parse and validate form data\n\t\tconst rawData = {\n\t\t\tcustomerId: formData.get(\"customerId\") as string,\n\t\t\tpropertyId: (formData.get(\"propertyId\") as string) || undefined,\n\t\t\tname: formData.get(\"name\") as string,\n\t\t\tdescription: (formData.get(\"description\") as string) || undefined,\n\t\t\tfrequency: formData.get(\"frequency\") as string,\n\t\t\tcustomFrequencyDays: formData.get(\"customFrequencyDays\")\n\t\t\t\t? Number.parseInt(formData.get(\"customFrequencyDays\") as string, 10)\n\t\t\t\t: undefined,\n\t\t\tstartDate: formData.get(\"startDate\") as string,\n\t\t\tendDate: (formData.get(\"endDate\") as string) || undefined,\n\t\t\tamount: formData.get(\"amount\")\n\t\t\t\t? Number.parseFloat(formData.get(\"amount\") as string)\n\t\t\t\t: undefined,\n\t\t\tcurrency: (formData.get(\"currency\") as string) || \"USD\",\n\t\t\tbillingFrequency:\n\t\t\t\t(formData.get(\"billingFrequency\") as string) || undefined,\n\t\t\tautoRenew: formData.get(\"autoRenew\") === \"true\",\n\t\t\tservicesIncluded,\n\t\t\tterms: (formData.get(\"terms\") as string) || undefined,\n\t\t\tnotes: (formData.get(\"notes\") as string) || undefined,\n\t\t};\n\n\t\tconst validatedData = createMaintenancePlanSchema.parse(rawData);\n\n\t\t// Validate dates\n\t\tvalidateMaintenancePlanDates(\n\t\t\tvalidatedData.startDate,\n\t\t\tvalidatedData.endDate,\n\t\t);\n\n\t\t// Validate custom frequency\n\t\tif (\n\t\t\tvalidatedData.frequency === \"custom\" &&\n\t\t\t!validatedData.customFrequencyDays\n\t\t) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Custom frequency days is required for custom frequency\",\n\t\t\t\tERROR_CODES.VALIDATION_FAILED,\n\t\t\t);\n\t\t}\n\n\t\t// Calculate next service date\n\t\tconst nextServiceDate = await calculateNextServiceDate(\n\t\t\tsupabase,\n\t\t\tvalidatedData.startDate,\n\t\t\tvalidatedData.frequency,\n\t\t\tvalidatedData.customFrequencyDays,\n\t\t);\n\n\t\t// Generate plan number\n\t\tconst planNumber = await generateMaintenancePlanNumber(supabase, companyId);\n\n\t\t// Create maintenance plan\n\t\tconst { data: plan, error } = await supabase\n\t\t\t.from(\"maintenance_plans\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: validatedData.customerId,\n\t\t\t\tproperty_id: validatedData.propertyId,\n\t\t\t\tplan_number: planNumber,\n\t\t\t\tname: validatedData.name,\n\t\t\t\tdescription: validatedData.description,\n\t\t\t\tfrequency: validatedData.frequency,\n\t\t\t\tcustom_frequency_days: validatedData.customFrequencyDays,\n\t\t\t\tstart_date: validatedData.startDate,\n\t\t\t\tend_date: validatedData.endDate,\n\t\t\t\tnext_service_date: nextServiceDate,\n\t\t\t\tamount: validatedData.amount,\n\t\t\t\tcurrency: validatedData.currency,\n\t\t\t\tbilling_frequency: validatedData.billingFrequency,\n\t\t\t\tauto_renew: validatedData.autoRenew,\n\t\t\t\tservices_included: validatedData.servicesIncluded,\n\t\t\t\tterms: validatedData.terms,\n\t\t\t\tnotes: validatedData.notes,\n\t\t\t\tstatus: \"active\",\n\t\t\t\tcreated_by: user.id,\n\t\t\t})\n\t\t\t.select(\"id\")\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to create maintenance plan: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate relevant paths\n\t\trevalidatePath(\"/dashboard/work/maintenance-plans\");\n\t\trevalidatePath(\"/dashboard/customers\");\n\n\t\treturn plan.id;\n\t});\n}\n\n/**\n * Update an existing maintenance plan\n */\nasync function updateMaintenancePlan(\n\tplanId: string,\n\tformData: FormData,\n): Promise<ActionResult<boolean>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Verify plan exists and belongs to company\n\t\tconst { data: existingPlan, error: fetchError } = await supabase\n\t\t\t.from(\"maintenance_plans\")\n\t\t\t.select(\"id, company_id\")\n\t\t\t.eq(\"id\", planId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (fetchError || !existingPlan) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Maintenance plan not found\",\n\t\t\t\tERROR_CODES.DB_RECORD_NOT_FOUND,\n\t\t\t);\n\t\t}\n\n\t\t// Parse and validate form data\n\t\tconst rawData: any = {};\n\t\tconst fields = [\n\t\t\t\"name\",\n\t\t\t\"description\",\n\t\t\t\"status\",\n\t\t\t\"frequency\",\n\t\t\t\"customFrequencyDays\",\n\t\t\t\"startDate\",\n\t\t\t\"endDate\",\n\t\t\t\"nextServiceDate\",\n\t\t\t\"amount\",\n\t\t\t\"billingFrequency\",\n\t\t\t\"autoRenew\",\n\t\t\t\"servicesIncluded\",\n\t\t\t\"terms\",\n\t\t\t\"notes\",\n\t\t];\n\n\t\tfields.forEach((field) => {\n\t\t\tconst value = formData.get(field);\n\t\t\tif (value !== null && value !== undefined && value !== \"\") {\n\t\t\t\tif (field === \"amount\") {\n\t\t\t\t\trawData[field] = Number.parseFloat(value as string);\n\t\t\t\t} else if (field === \"customFrequencyDays\") {\n\t\t\t\t\trawData[field] = Number.parseInt(value as string, 10);\n\t\t\t\t} else if (field === \"autoRenew\") {\n\t\t\t\t\trawData[field] = value === \"true\";\n\t\t\t\t} else if (field === \"servicesIncluded\") {\n\t\t\t\t\ttry {\n\t\t\t\t\t\trawData[field] = JSON.parse(value as string);\n\t\t\t\t\t} catch {\n\t\t\t\t\t\t// Ignore parse errors\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\trawData[field] = value;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tconst validatedData = updateMaintenancePlanSchema.parse(rawData);\n\n\t\t// Validate dates if both are provided\n\t\tif (validatedData.startDate && validatedData.endDate) {\n\t\t\tvalidateMaintenancePlanDates(\n\t\t\t\tvalidatedData.startDate,\n\t\t\t\tvalidatedData.endDate,\n\t\t\t);\n\t\t}\n\n\t\t// Convert camelCase to snake_case for database\n\t\tconst dbUpdateData: any = {};\n\t\tObject.entries(validatedData).forEach(([key, value]) => {\n\t\t\tconst snakeKey = key.replace(/([A-Z])/g, \"_$1\").toLowerCase();\n\t\t\tdbUpdateData[snakeKey] = value;\n\t\t});\n\n\t\t// Update maintenance plan\n\t\tconst { error } = await supabase\n\t\t\t.from(\"maintenance_plans\")\n\t\t\t.update(dbUpdateData)\n\t\t\t.eq(\"id\", planId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to update maintenance plan: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Revalidate relevant paths\n\t\trevalidatePath(\"/dashboard/work/maintenance-plans\");\n\t\trevalidatePath(`/dashboard/work/maintenance-plans/${planId}`);\n\n\t\treturn true;\n\t});\n}\n\n/**\n * Activate a maintenance plan\n */\nasync function activateMaintenancePlan(\n\tplanId: string,\n): Promise<ActionResult<boolean>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Update plan status to active\n\t\tconst { error } = await supabase\n\t\t\t.from(\"maintenance_plans\")\n\t\t\t.update({ status: \"active\" })\n\t\t\t.eq(\"id\", planId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to activate maintenance plan: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work/maintenance-plans\");\n\t\trevalidatePath(`/dashboard/work/maintenance-plans/${planId}`);\n\n\t\treturn true;\n\t});\n}\n\n/**\n * Pause a maintenance plan\n */\nasync function pauseMaintenancePlan(\n\tplanId: string,\n): Promise<ActionResult<boolean>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Update plan status to paused\n\t\tconst { error } = await supabase\n\t\t\t.from(\"maintenance_plans\")\n\t\t\t.update({ status: \"paused\" })\n\t\t\t.eq(\"id\", planId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to pause maintenance plan: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work/maintenance-plans\");\n\t\trevalidatePath(`/dashboard/work/maintenance-plans/${planId}`);\n\n\t\treturn true;\n\t});\n}\n\n/**\n * Cancel a maintenance plan\n */\nasync function cancelMaintenancePlan(\n\tplanId: string,\n): Promise<ActionResult<boolean>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Update plan status to cancelled\n\t\tconst { error } = await supabase\n\t\t\t.from(\"maintenance_plans\")\n\t\t\t.update({ status: \"cancelled\" })\n\t\t\t.eq(\"id\", planId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to cancel maintenance plan: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work/maintenance-plans\");\n\t\trevalidatePath(`/dashboard/work/maintenance-plans/${planId}`);\n\n\t\treturn true;\n\t});\n}\n\n/**\n * Delete a maintenance plan\n */\nasync function deleteMaintenancePlan(\n\tplanId: string,\n): Promise<ActionResult<boolean>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Delete maintenance plan\n\t\tconst { error } = await supabase\n\t\t\t.from(\"maintenance_plans\")\n\t\t\t.delete()\n\t\t\t.eq(\"id\", planId)\n\t\t\t.eq(\"company_id\", companyId);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Failed to delete maintenance plan: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work/maintenance-plans\");\n\n\t\treturn true;\n\t});\n}\n\n/**\n * Search maintenance plans\n */\nasync function searchMaintenancePlans(\n\tsearchQuery: string,\n\toptions?: {\n\t\tlimit?: number;\n\t\toffset?: number;\n\t},\n): Promise<ActionResult<any[]>> {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new ActionError(\n\t\t\t\t\"Database connection failed\",\n\t\t\t\tERROR_CODES.DB_CONNECTION_ERROR,\n\t\t\t);\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tassertAuthenticated(user?.id);\n\n\t\t// Get user's company\n\t\tconst companyId = await getActiveCompanyId();\n\t\tassertExists(companyId, \"Company not found for user\");\n\n\t\t// Use the RPC function for ranked search\n\t\tconst { data, error } = await supabase.rpc(\n\t\t\t\"search_maintenance_plans_ranked\",\n\t\t\t{\n\t\t\t\tp_company_id: companyId,\n\t\t\t\tp_search_query: searchQuery,\n\t\t\t\tp_limit: options?.limit || 50,\n\t\t\t\tp_offset: options?.offset || 0,\n\t\t\t},\n\t\t);\n\n\t\tif (error) {\n\t\t\tthrow new ActionError(\n\t\t\t\t`Search failed: ${error.message}`,\n\t\t\t\tERROR_CODES.DB_QUERY_ERROR,\n\t\t\t);\n\t\t}\n\n\t\treturn data || [];\n\t});\n}\n\n/**\n * Archive a maintenance plan (soft delete)\n */\nexport async function archiveMaintenancePlan(\n\tplanId: string,\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Database connection not available\" };\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\treturn { success: false, error: \"Unauthorized\" };\n\t\t}\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"maintenance_plans\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t})\n\t\t\t.eq(\"id\", planId);\n\n\t\tif (error) {\n\t\t\treturn { success: false, error: error.message };\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/work/maintenance-plans\");\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t};\n\t}\n}\n","export {getCurrentUserRole as '001f005176797ef23488068124fb9a744915a477de'} from 'ACTIONS_MODULE0'\nexport {canDeleteTeamMember as '406f6624261c6dd1a908026fa1408a3f6d507b6e7d'} from 'ACTIONS_MODULE0'\nexport {getPayrixMerchantAccount as '40704f0e856ad801ef93b43436f219a36f7c0efd2c'} from 'ACTIONS_MODULE1'\nexport {getWebRTCCredentials as '000478fbf5363dae5000d525663da13e29908cb952'} from 'ACTIONS_MODULE2'\nexport {transcribeCallRecording as '4002f454c46f4c21ca6e9e26362583ccff69c9f914'} from 'ACTIONS_MODULE2'\nexport {getCompanyPhoneNumbers as '4019cf9f81eb3c06f82b5c2f8eb042f3d95d91e933'} from 'ACTIONS_MODULE2'\nexport {getCallRoutingRules as '40247c617842c31b242455a0961cbd2c3297606a16'} from 'ACTIONS_MODULE2'\nexport {updateCallRoutingRule as '40413bfa888916480edbc33ebb812158fddf960f89'} from 'ACTIONS_MODULE2'\nexport {startCallRecording as '404e47931374ad2a1b54bc11f357703790f6104530'} from 'ACTIONS_MODULE2'\nexport {transferActiveCall as '405a16958f97c37bd4b5711bd8761510bdab55839f'} from 'ACTIONS_MODULE2'\nexport {searchPhoneNumbers as '406864ae05b8b51c66cc2c335999e5011a41cb521f'} from 'ACTIONS_MODULE2'\nexport {makeCall as '40b2df540ec465c5dc19545c96486485bb50b5633b'} from 'ACTIONS_MODULE2'\nexport {sendTextMessage as '40d050abdabe2ee7293436c505c5f27b4408a2f27c'} from 'ACTIONS_MODULE2'\nexport {stopCallRecording as '40d5cc291162e2fd61245bdb851d5e8ed609e4ed19'} from 'ACTIONS_MODULE2'\nexport {sendMMSMessage as '40edd91786b2a482e617fb16f2474d26ec295435e7'} from 'ACTIONS_MODULE2'\nexport {purchasePhoneNumber as '40fd6a80b32792fab749933f98f07503d8e94c0305'} from 'ACTIONS_MODULE2'\nexport {deleteCallRoutingRule as '607d0f958daf66b2a0d5277cdda17600dace5156bb'} from 'ACTIONS_MODULE2'\nexport {toggleCallRoutingRule as '60853f1e409364f7e171e27229217994ff224414e6'} from 'ACTIONS_MODULE2'\nexport {createServiceSupabaseClient as '00a13dbd00149949fc1367d3e76ae7d789e07f5321'} from 'ACTIONS_MODULE3'\nexport {ensureMessagingBranding as '606753f8910b46d5792f4bdeb457cdf29d1a8bbadc'} from 'ACTIONS_MODULE4'\nexport {ensureMessagingCampaign as '70a648f43fa62ae3dcf2070eb90413e96e81591e77'} from 'ACTIONS_MODULE4'\nexport {checkTelnyxVerificationStatus as '007505a78985e53e083a498c97761ed8a463d3d379'} from 'ACTIONS_MODULE5'\nexport {submitAutomatedVerification as '4087f0badccd6aaf6a28b640ab4bbc513f0832d105'} from 'ACTIONS_MODULE5'\nexport {registerCompanyFor10DLC as '40ae25402a089e45aa071d979e8cc6ad136205cc98'} from 'ACTIONS_MODULE5'\nexport {sendVerificationSubmittedEmail as '70f58c5ba46ef02b620d7dc87bae8fc83f6d480755'} from 'ACTIONS_MODULE6'\nexport {sendEmail as '40f8c061cf84f884e77af3425bc24b8a8d72f598fb'} from 'ACTIONS_MODULE7'\nexport {handleComplaintWebhook as '6045f8436f9cdfdadb7bfe3955677adfc5f4102de0'} from 'ACTIONS_MODULE7'\nexport {handleBounceWebhook as '78a8ea4f1cfa571a366adccf36ac04b1c85d61ae2b'} from 'ACTIONS_MODULE7'\nexport {runHealthCheckForAllDomains as '00c53a1f02416c3261983f8096f19a3450bfd51775'} from 'ACTIONS_MODULE8'\nexport {getDomainHealth as '400b8fb96146bfd004a3166563a5ab5536bb610c70'} from 'ACTIONS_MODULE8'\nexport {recordDeliveryEvent as '404d6f2891af89c71d5bde33d110a216bdd3ee4729'} from 'ACTIONS_MODULE8'\nexport {getCompanyDomainsHealth as '405c57a8fed352b8679525b56014eb8c49105c850c'} from 'ACTIONS_MODULE8'\nexport {processResendWebhookEvent as '40ad037af6f6ab1a3004746d3a1b65afa65527002d'} from 'ACTIONS_MODULE8'\nexport {generateDeliverabilityReport as '40ecf2c792e84ef4b898fda98ec27277b4a9dddef2'} from 'ACTIONS_MODULE8'\nexport {resetHourlyCounters as '004cdde5e6ae8991bab4ba61ae40647c2b823200ba'} from 'ACTIONS_MODULE9'\nexport {resetDailyCounters as '006acf41615a2f7795c47b6d7a3016e18300f2ad17'} from 'ACTIONS_MODULE9'\nexport {incrementEmailCounter as '4029b163c1c0acfd806352a72fe8030c8ae4f7f8ac'} from 'ACTIONS_MODULE9'\nexport {getCompanyActiveDomain as '407a5a7d0a7dd7989a963eb2485a3527c1dcb20a70'} from 'ACTIONS_MODULE9'\nexport {checkRateLimit as '40af86a915f04df8d7cc189fe26e45e0cc24663080'} from 'ACTIONS_MODULE9'\nexport {isGmailIntegrationEnabled as '00fe74bdf14126b5ad89e9480e82978d6357f356b3'} from 'ACTIONS_MODULE10'\nexport {getUserGmailTokens as '400ce95360aaffa14a99dfdf969ba5166c69a59eb6'} from 'ACTIONS_MODULE10'\nexport {disconnectCompanyGmail as '401d3d830065dd7c4777fad67f642392f48735c4ab'} from 'ACTIONS_MODULE10'\nexport {disconnectUserGmail as '404575d602ef4c60c0058b592b8c3e42fbcd13fc4c'} from 'ACTIONS_MODULE10'\nexport {getCompanyEmailProvider as '40787b1598849126560f9f0b0f8fe8967338c7bf28'} from 'ACTIONS_MODULE10'\nexport {getCompanyGmailTokens as '40beeb56302a20d27cd8ba7a0988310f855633d7e6'} from 'ACTIONS_MODULE10'\nexport {refreshUserGmailToken as '602fab67313b110e6ccb66e54b1e16450b2a772cc7'} from 'ACTIONS_MODULE10'\nexport {sendCompanyGmailEmail as '60302947fc4caffa53a719728f3c2cebace926098c'} from 'ACTIONS_MODULE10'\nexport {syncUserInbox as '603643b13bf288cc628303bb4d12df0311b11434c7'} from 'ACTIONS_MODULE10'\nexport {checkCompanyGmailHealth as '60856182db5eaec7f85eda2a5a94c5d7d3524325d6'} from 'ACTIONS_MODULE10'\nexport {refreshCompanyGmailToken as '60eeb51685ac265a4ad793a230a515fe6e462f16f4'} from 'ACTIONS_MODULE10'\nexport {fetchUserInbox as '708daa303e36e37247e22b5b828b6aad8c73ac283b'} from 'ACTIONS_MODULE10'\nexport {setCompanyEmailProvider as '70dd3bc4222a87350dc137fa9cbcb849fa1913b397'} from 'ACTIONS_MODULE10'\nexport {storeGmailMessage as '78d41ef818e75fef94d65a87ea1f0faf418132e3c5'} from 'ACTIONS_MODULE10'\nexport {storeUserGmailTokens as '7e3a356960ddd52a3fa4dc6d981ae7202a59eb9a3d'} from 'ACTIONS_MODULE10'\nexport {storeCompanyGmailTokens as '7f06df826c4fff42950e712c0f548254e275be2a52'} from 'ACTIONS_MODULE10'\nexport {getProviderHealthDashboard as '00a122f9d5fe3a1603c636c3a251886129b66154f8'} from 'ACTIONS_MODULE11'\nexport {checkProviderAlert as '40c7885bdc4fe4cdd5f57e78579230c58088adbef4'} from 'ACTIONS_MODULE11'\nexport {cleanupOldEvents as '40d3c4ceeaee653aa257a28ed429a7fd272fa9fb66'} from 'ACTIONS_MODULE11'\nexport {recordProviderEvent as '40e06418f4b93b40c84a25511e0468e1e8a41ddecf'} from 'ACTIONS_MODULE11'\nexport {getProviderStats as '60c643a41ce1a8e6cc8338da6e2f3678c386910460'} from 'ACTIONS_MODULE11'\nexport {recordSendFailure as '78255c3fa8c9facf7c3f353202f2907836e8eb5539'} from 'ACTIONS_MODULE11'\nexport {recordSendSuccess as '783861d25688b32ba086bbe9e45444975c36a1b285'} from 'ACTIONS_MODULE11'\nexport {recordFallbackTriggered as '78766431b437b16f7cb00b4d64a2f3be5e092ed724'} from 'ACTIONS_MODULE11'\nexport {deleteNotification as '40fab1894acc5e3d1fdd8d8c6128a7cecee06e7e6a'} from 'ACTIONS_MODULE12'\nexport {markAllAsRead as '00cf212b0097820096122537beac12e3403b97d564'} from 'ACTIONS_MODULE12'\nexport {markAsRead as '4094cf679b4a10ca0f969f4fc1b55602aac4e0fbc3'} from 'ACTIONS_MODULE12'\nexport {makeCall as '40b2df540ec465c5dc19545c96486485bb50b5633b'} from 'ACTIONS_MODULE2'\nexport {getWebRTCCredentials as '000478fbf5363dae5000d525663da13e29908cb952'} from 'ACTIONS_MODULE2'\nexport {signOut as '0043ae510c3322ea499beb9e1bb77d06afb4ef19bd'} from 'ACTIONS_MODULE13'\nexport {switchCompany as '4097c3c574342661f9a3c8244961d001234449f36f'} from 'ACTIONS_MODULE14'\nexport {updateUserStatus as '4081009dd4dff14ff4ece62648bad23a83f2f9f63c'} from 'ACTIONS_MODULE15'\nexport {getTotalUnreadCountAction as '00ebc03a4ffc993aea7ec2e541686105c2bace2437'} from 'ACTIONS_MODULE16'\nexport {getCompanyPendingActions as '40e9589cb639f2902eb841bedc1247d966486d6fd7'} from 'ACTIONS_MODULE17'\nexport {checkIsCompanyOwner as '001be5cf82b793f19f6a7d010c91c14577fa7a130d'} from 'ACTIONS_MODULE17'\nexport {getCustomerByPhone as '6013add076e3eaed7dc37e8b800ce977d5abb8d49a'} from 'ACTIONS_MODULE18'\nexport {startCallRecording as '404e47931374ad2a1b54bc11f357703790f6104530'} from 'ACTIONS_MODULE2'\nexport {stopCallRecording as '40d5cc291162e2fd61245bdb851d5e8ed609e4ed19'} from 'ACTIONS_MODULE2'\nexport {deleteCustomer as '4082b52123c24a95685a53c36313418a95c259c65b'} from 'ACTIONS_MODULE18'\nexport {searchCustomers as '60193685409a9d118f1b364e14ecf57d05fa5638a9'} from 'ACTIONS_MODULE18'\nexport {getCustomersForDialer as '0077abd0cb1e555f91adaa482ad0b2f565bbd0629a'} from 'ACTIONS_MODULE18'\nexport {getPendingSupportSessions as '000f90f949d6a2f5484d061d5a738a59a8c846aeaa'} from 'ACTIONS_MODULE19'\nexport {getActiveSupportSessions as '00665c1bbcd52d612d5bb4bf3be5e7fc75554132e6'} from 'ACTIONS_MODULE19'\nexport {approveSupportSessionRequest as '602e89ae7ace85fc30cd3b4b1dd865d517c0cb1cd5'} from 'ACTIONS_MODULE19'\nexport {rejectSupportSessionRequest as '60886af124323873afd4d5b64bb4143abbcba2c154'} from 'ACTIONS_MODULE19'\nexport {endActiveSupportSession as '40369e8ea4eced7bdaef8203d369469ee7b630db8c'} from 'ACTIONS_MODULE19'\nexport {createEmailFolderAction as '408d3694fd0dd48e424f53c9bf5083b946ab3ec990'} from 'ACTIONS_MODULE20'\nexport {getEmailFolderCountsAction as '009e962eae57bf128b2023081fd7259048edd8884a'} from 'ACTIONS_MODULE16'\nexport {getEmailFoldersAction as '00235a0ba91f1ba226f33fa40dcf4c93a2c3548c70'} from 'ACTIONS_MODULE20'\nexport {deleteEmailFolderAction as '40c55f8e0922f2c7fd8d502e4c75395bf5f0470430'} from 'ACTIONS_MODULE20'\nexport {searchVendors as '404a3266e0319dbd8c24fec80bb69ecfe029d2a768'} from 'ACTIONS_MODULE21'\nexport {getSmsFolderCountsAction as '0006f7bd89b72f0836ec7bf4db73019f1b32e6c24a'} from 'ACTIONS_MODULE22'\nexport {archiveMaintenancePlan as '401ec8be029b0a5f4cc99a3e93a7ea7f61b4352f51'} from 'ACTIONS_MODULE23'\n"],"names":[],"mappings":"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"}