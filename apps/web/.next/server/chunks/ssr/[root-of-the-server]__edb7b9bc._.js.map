{"version":3,"sources":["../../../../../../packages/auth/src/permissions.ts","../../../../../../apps/web/src/lib/auth/permissions.ts","../../../../../../apps/web/src/actions/roles.ts","../../../../../../apps/web/src/lib/telnyx/messaging-profile-setup.ts","../../../../../../apps/web/src/lib/telnyx/numbers.ts","../../../../../../apps/web/src/lib/telnyx/provision-company.ts"],"sourcesContent":["/**\n * Permission System - Server-Side Utilities\n *\n * Provides type-safe permission checking for role-based access control (RBAC).\n * Uses database functions for secure, centralized permission logic.\n *\n * Performance optimizations:\n * - Database functions are cached by Postgres\n * - Single query permission checks\n * - Prepared statements for security\n *\n * @example\n * ```typescript\n * // Check if user can delete jobs\n * const canDelete = await hasPermission(supabase, userId, \"delete_jobs\", companyId);\n *\n * // Check if user has manager role\n * const isManager = await hasRole(supabase, userId, \"manager\", companyId);\n *\n * // Get user's role\n * const role = await getUserRole(supabase, userId, companyId);\n * ```\n */\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/**\n * User roles in the system\n * Matches the user_role ENUM in database\n */\nexport type UserRole =\n\t| \"owner\"\n\t| \"admin\"\n\t| \"manager\"\n\t| \"dispatcher\"\n\t| \"technician\"\n\t| \"csr\";\n\n/**\n * Permission keys for fine-grained access control\n */\nexport type Permission =\n\t// Manager permissions\n\t| \"view_reports\"\n\t| \"manage_team\"\n\t| \"approve_estimates\"\n\t| \"handle_escalations\"\n\t// Dispatcher permissions\n\t| \"dispatch_jobs\"\n\t| \"manage_schedule\"\n\t| \"view_tech_locations\"\n\t// Technician permissions\n\t| \"update_job_status\"\n\t| \"create_invoices\"\n\t| \"upload_photos\"\n\t// CSR permissions\n\t| \"create_jobs\"\n\t| \"schedule_appointments\"\n\t| \"send_communications\"\n\t// View permissions\n\t| \"view_customers\"\n\t| \"view_jobs\"\n\t| \"view_schedule\"\n\t// Delete permissions\n\t| \"delete_jobs\"\n\t| \"delete_customers\"\n\t| \"delete_team_members\";\n\n/**\n * Role configuration with permissions and metadata\n */\nexport type RoleConfig = {\n\tid: UserRole;\n\tlabel: string;\n\tdescription: string;\n\tpermissions: Permission[];\n\tdashboardFeatures: string[];\n};\n\n// ============================================================================\n// Role Definitions\n// ============================================================================\n\n/**\n * Complete role configurations with their permissions\n * Used for UI display and permission reference\n */\nconst ROLES: Record<UserRole, RoleConfig> = {\n\towner: {\n\t\tid: \"owner\",\n\t\tlabel: \"Owner\",\n\t\tdescription:\n\t\t\t\"Full system access with focus on business financials and growth\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t\t\"delete_customers\",\n\t\t\t\"delete_team_members\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"financial-overview\",\n\t\t\t\"profit-margins\",\n\t\t\t\"cash-flow\",\n\t\t\t\"business-growth\",\n\t\t\t\"payroll-overview\",\n\t\t\t\"all-reports\",\n\t\t],\n\t},\n\tadmin: {\n\t\tid: \"admin\",\n\t\tlabel: \"Admin\",\n\t\tdescription: \"System administration and configuration\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t\t\"delete_customers\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"system-settings\",\n\t\t\t\"user-management\",\n\t\t\t\"integrations\",\n\t\t\t\"audit-logs\",\n\t\t],\n\t},\n\tmanager: {\n\t\tid: \"manager\",\n\t\tlabel: \"Manager\",\n\t\tdescription:\n\t\t\t\"Oversee team performance, customer satisfaction, and operations\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"manage_team\",\n\t\t\t\"approve_estimates\",\n\t\t\t\"handle_escalations\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t\t\"delete_jobs\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"team-performance\",\n\t\t\t\"customer-satisfaction\",\n\t\t\t\"callback-queue\",\n\t\t\t\"review-alerts\",\n\t\t\t\"kpi-tracking\",\n\t\t\t\"inventory-management\",\n\t\t],\n\t},\n\tdispatcher: {\n\t\tid: \"dispatcher\",\n\t\tlabel: \"Dispatcher\",\n\t\tdescription:\n\t\t\t\"Manage technician schedules, job assignments, and real-time operations\",\n\t\tpermissions: [\n\t\t\t\"view_reports\",\n\t\t\t\"dispatch_jobs\",\n\t\t\t\"manage_schedule\",\n\t\t\t\"view_tech_locations\",\n\t\t\t\"update_job_status\",\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"dispatch-map\",\n\t\t\t\"technician-locations\",\n\t\t\t\"unassigned-jobs\",\n\t\t\t\"emergency-queue\",\n\t\t\t\"quick-dispatch\",\n\t\t\t\"tech-status\",\n\t\t],\n\t},\n\ttechnician: {\n\t\tid: \"technician\",\n\t\tlabel: \"Technician\",\n\t\tdescription:\n\t\t\t\"View assigned jobs, update job status, and track personal performance\",\n\t\tpermissions: [\n\t\t\t\"update_job_status\",\n\t\t\t\"create_invoices\",\n\t\t\t\"upload_photos\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"my-schedule\",\n\t\t\t\"active-job\",\n\t\t\t\"my-earnings\",\n\t\t\t\"my-performance\",\n\t\t\t\"parts-inventory\",\n\t\t\t\"time-tracking\",\n\t\t],\n\t},\n\tcsr: {\n\t\tid: \"csr\",\n\t\tlabel: \"Customer Service Rep\",\n\t\tdescription:\n\t\t\t\"Handle customer calls, schedule appointments, and manage customer relationships\",\n\t\tpermissions: [\n\t\t\t\"create_jobs\",\n\t\t\t\"schedule_appointments\",\n\t\t\t\"send_communications\",\n\t\t\t\"create_invoices\",\n\t\t\t\"view_customers\",\n\t\t\t\"view_jobs\",\n\t\t\t\"view_schedule\",\n\t\t],\n\t\tdashboardFeatures: [\n\t\t\t\"call-queue\",\n\t\t\t\"booking-calendar\",\n\t\t\t\"customer-search\",\n\t\t\t\"follow-up-queue\",\n\t\t\t\"estimate-pipeline\",\n\t\t\t\"call-scripts\",\n\t\t],\n\t},\n};\n\n// ============================================================================\n// Permission Check Functions\n// ============================================================================\n\n/**\n * Check if user has a specific role in a company\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param role - Role to check for\n * @param companyId - Company ID\n * @returns true if user has the role\n *\n * @example\n * ```typescript\n * const isManager = await hasRole(supabase, userId, \"manager\", companyId);\n * if (!isManager) {\n *   throw new Error(\"Access denied: Manager role required\");\n * }\n * ```\n */\nexport async function hasRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\trole: UserRole,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_role\", {\n\t\tuser_uuid: userId,\n\t\trequired_role: role,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Check if user has ANY of the specified roles\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param roles - Array of roles to check\n * @param companyId - Company ID\n * @returns true if user has any of the roles\n *\n * @example\n * ```typescript\n * const canManage = await hasAnyRole(\n *   supabase,\n *   userId,\n *   [\"owner\", \"manager\", \"admin\"],\n *   companyId\n * );\n * ```\n */\nasync function hasAnyRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\troles: UserRole[],\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_any_role\", {\n\t\tuser_uuid: userId,\n\t\trequired_roles: roles,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Get user's role in a company\n *\n * @param supabase - Supabase client\n * @param userId - User ID\n * @param companyId - Company ID\n * @returns User's role or null if not found\n *\n * @example\n * ```typescript\n * const role = await getUserRole(supabase, userId, companyId);\n * console.log(`User role: ${role}`); // \"manager\"\n * ```\n */\nexport async function getUserRole(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tcompanyId: string,\n): Promise<UserRole | null> {\n\tconst { data, error } = await supabase.rpc(\"get_user_role\", {\n\t\tuser_uuid: userId,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn null;\n\t}\n\n\treturn data as UserRole | null;\n}\n\n/**\n * Check if user has a specific permission\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param permission - Permission key to check\n * @param companyId - Company ID\n * @returns true if user has the permission\n *\n * @example\n * ```typescript\n * const canDelete = await hasPermission(supabase, userId, \"delete_jobs\", companyId);\n * if (!canDelete) {\n *   return { error: \"You don't have permission to delete jobs\" };\n * }\n * ```\n */\nexport async function hasPermission(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tpermission: Permission,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"has_permission\", {\n\t\tuser_uuid: userId,\n\t\tpermission_key: permission,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n/**\n * Check if user is the company owner\n *\n * @param supabase - Supabase client\n * @param userId - User ID to check\n * @param companyId - Company ID\n * @returns true if user is the owner\n *\n * @example\n * ```typescript\n * const isOwner = await isCompanyOwner(supabase, userId, companyId);\n * if (!isOwner) {\n *   throw new Error(\"Only company owner can perform this action\");\n * }\n * ```\n */\nexport async function isCompanyOwner(\n\tsupabase: SupabaseClient,\n\tuserId: string,\n\tcompanyId: string,\n): Promise<boolean> {\n\tconst { data, error } = await supabase.rpc(\"is_company_owner\", {\n\t\tuser_uuid: userId,\n\t\tcompany_uuid: companyId,\n\t});\n\n\tif (error) {\n\t\treturn false;\n\t}\n\n\treturn data === true;\n}\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\n/**\n * Get all permissions for a role\n *\n * @param role - Role to get permissions for\n * @returns Array of permission keys\n *\n * @example\n * ```typescript\n * const managerPerms = getRolePermissions(\"manager\");\n * console.log(managerPerms); // [\"view_reports\", \"manage_team\", ...]\n * ```\n */\nfunction getRolePermissions(role: UserRole): Permission[] {\n\treturn ROLES[role]?.permissions || [];\n}\n\n/**\n * Check if a role has a specific permission (client-side check only)\n *\n * @param role - Role to check\n * @param permission - Permission to check for\n * @returns true if role has the permission\n *\n * @example\n * ```typescript\n * const canDelete = roleHasPermission(\"manager\", \"delete_jobs\");\n * ```\n */\nfunction roleHasPermission(\n\trole: UserRole,\n\tpermission: Permission,\n): boolean {\n\treturn ROLES[role]?.permissions.includes(permission);\n}\n\n/**\n * Get role configuration\n *\n * @param role - Role to get config for\n * @returns Role configuration\n *\n * @example\n * ```typescript\n * const config = getRoleConfig(\"manager\");\n * console.log(config.label); // \"Manager\"\n * ```\n */\nfunction getRoleConfig(role: UserRole): RoleConfig {\n\treturn ROLES[role];\n}\n","// Re-export from @stratos/auth package for backwards compatibility\nexport * from \"@stratos/auth/permissions\";\n","/**\n * Role Actions - Server Actions\n *\n * Server-side actions for role management and permission checks.\n * Uses Supabase RLS and database functions for security.\n */\n\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport {\n\tgetUserRole,\n\thasPermission,\n\thasRole,\n\tisCompanyOwner,\n\ttype Permission,\n\ttype UserRole,\n} from \"@/lib/auth/permissions\";\nimport { withErrorHandling } from \"@/lib/errors/with-error-handling\";\nimport { createClient } from \"@/lib/supabase/server\";\n\n// ============================================================================\n// Validation Schemas\n// ============================================================================\n\nconst updateRoleSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tnewRole: z.enum([\n\t\t\"owner\",\n\t\t\"admin\",\n\t\t\"manager\",\n\t\t\"dispatcher\",\n\t\t\"technician\",\n\t\t\"csr\",\n\t]),\n\treason: z.string().optional(),\n});\n\nconst updatePermissionsSchema = z.object({\n\tteamMemberId: z.string().uuid(),\n\tpermissions: z.record(z.string(), z.boolean()),\n});\n\n// ============================================================================\n// Query Actions\n// ============================================================================\n\n/**\n * Get current user's role in active company\n *\n * @returns User's role or null\n *\n * @example\n * ```typescript\n * const role = await getCurrentUserRole();\n * if (role.success && role.data === \"manager\") {\n *   // Show manager dashboard\n * }\n * ```\n */\nexport async function getCurrentUserRole() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst role = await getUserRole(supabase, user.id, companyId);\n\n\t\treturn role;\n\t});\n}\n\n/**\n * Check if current user has a specific permission\n *\n * @param permission - Permission to check\n * @returns true if user has permission\n *\n * @example\n * ```typescript\n * const result = await checkPermission(\"delete_jobs\");\n * if (!result.success || !result.data) {\n *   return { error: \"Access denied\" };\n * }\n * ```\n */\nasync function checkPermission(permission: Permission) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasPerm = await hasPermission(\n\t\t\tsupabase,\n\t\t\tuser.id,\n\t\t\tpermission,\n\t\t\tcompanyId,\n\t\t);\n\n\t\treturn hasPerm;\n\t});\n}\n\n/**\n * Check if current user has a specific role\n *\n * @param role - Role to check\n * @returns true if user has role\n *\n * @example\n * ```typescript\n * const result = await checkRole(\"manager\");\n * if (!result.success || !result.data) {\n *   redirect(\"/dashboard\");\n * }\n * ```\n */\nasync function checkRole(role: UserRole) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst hasRoleResult = await hasRole(supabase, user.id, role, companyId);\n\n\t\treturn hasRoleResult;\n\t});\n}\n\n/**\n * Check if current user is company owner\n *\n * @returns true if user is owner\n */\nasync function checkIsOwner() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\n\t\treturn isOwner;\n\t});\n}\n\n// ============================================================================\n// Mutation Actions\n// ============================================================================\n\n/**\n * Update team member's role\n * Only owners and admins can change roles\n *\n * @param input - Team member ID, new role, and optional reason\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberRole({\n *   teamMemberId: \"123...\",\n *   newRole: \"manager\",\n *   reason: \"Promoted to management\"\n * });\n * ```\n */\nasync function updateTeamMemberRole(\n\tinput: z.infer<typeof updateRoleSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updateRoleSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission - only owners and admins can change roles\n\t\tconst canManageRoles =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManageRoles) {\n\t\t\tthrow new Error(\"Only owners and admins can change roles\");\n\t\t}\n\n\t\t// Get current role for audit log\n\t\tconst { data: currentMember } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"role\")\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (!currentMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Update role\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ role: validated.newRole })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\t// Log role change\n\t\tawait supabase.from(\"role_change_log\").insert({\n\t\t\tteam_member_id: validated.teamMemberId,\n\t\t\tchanged_by: user.id,\n\t\t\told_role: currentMember.role,\n\t\t\tnew_role: validated.newRole,\n\t\t\treason: validated.reason,\n\t\t});\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Update team member's custom permissions\n * Only owners and admins can change permissions\n *\n * @param input - Team member ID and permissions object\n * @returns Updated team member\n *\n * @example\n * ```typescript\n * const result = await updateTeamMemberPermissions({\n *   teamMemberId: \"123...\",\n *   permissions: {\n *     \"delete_jobs\": true,\n *     \"approve_estimates\": true\n *   }\n * });\n * ```\n */\nasync function updateTeamMemberPermissions(\n\tinput: z.infer<typeof updatePermissionsSchema>,\n) {\n\treturn withErrorHandling(async () => {\n\t\t// Validate input\n\t\tconst validated = updatePermissionsSchema.parse(input);\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Check permission\n\t\tconst canManagePermissions =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canManagePermissions) {\n\t\t\tthrow new Error(\"Only owners and admins can change permissions\");\n\t\t}\n\n\t\t// Update permissions\n\t\tconst { data: updatedMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.update({ permissions: validated.permissions })\n\t\t\t.eq(\"id\", validated.teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(`/dashboard/settings/team/${validated.teamMemberId}`);\n\n\t\treturn updatedMember;\n\t});\n}\n\n/**\n * Get team members with their roles\n *\n * @returns List of team members with roles\n */\nasync function getTeamMembersWithRoles() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        users (\n          id,\n          name,\n          email,\n          avatar\n        )\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n// ============================================================================\n// Owner Protection Actions\n// ============================================================================\n\n/**\n * Transfer company ownership to another team member\n * Requires password verification and extensive validation\n *\n * @param input - Transfer details including new owner, password, and reason\n * @returns Transfer ID for audit\n *\n * @example\n * ```typescript\n * const result = await transferOwnership({\n *   newOwnerId: \"user-uuid\",\n *   password: \"current-password\",\n *   reason: \"Retiring from business\"\n * });\n * ```\n */\nasync function transferOwnership(input: {\n\tnewOwnerId: string;\n\tpassword: string;\n\treason?: string;\n\tipAddress?: string;\n\tuserAgent?: string;\n}) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Verify user is current owner\n\t\tconst isOwner = await isCompanyOwner(supabase, user.id, companyId);\n\t\tif (!isOwner) {\n\t\t\tthrow new Error(\"Only the current owner can transfer ownership\");\n\t\t}\n\n\t\t// Verify password\n\t\tconst { error: signInError } = await supabase.auth.signInWithPassword({\n\t\t\temail: user.email || \"\",\n\t\t\tpassword: input.password,\n\t\t});\n\n\t\tif (signInError) {\n\t\t\tthrow new Error(\"Password verification failed\");\n\t\t}\n\n\t\t// Call database function to transfer ownership\n\t\tconst { data: transferId, error } = await supabase.rpc(\n\t\t\t\"transfer_company_ownership\",\n\t\t\t{\n\t\t\t\tp_company_id: companyId,\n\t\t\t\tp_current_owner_id: user.id,\n\t\t\t\tp_new_owner_id: input.newOwnerId,\n\t\t\t\tp_reason: input.reason,\n\t\t\t\tp_ip_address: input.ipAddress,\n\t\t\t\tp_user_agent: input.userAgent,\n\t\t\t},\n\t\t);\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message || \"Failed to transfer ownership\");\n\t\t}\n\n\t\t// Revalidate all relevant paths\n\t\trevalidatePath(\"/dashboard/settings/team\");\n\t\trevalidatePath(\"/dashboard\");\n\n\t\treturn transferId;\n\t});\n}\n\n/**\n * Get ownership transfer history for the company\n * Shows audit trail of all ownership changes\n *\n * @returns List of ownership transfers\n */\nasync function getOwnershipTransferHistory() {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\tconst {\n\t\t\tdata: { user },\n\t\t} = await supabase.auth.getUser();\n\t\tif (!user) {\n\t\t\tthrow new Error(\"Not authenticated\");\n\t\t}\n\n\t\t// Only owners and admins can view transfer history\n\t\tconst canView =\n\t\t\t(await isCompanyOwner(supabase, user.id, companyId)) ||\n\t\t\t(await hasRole(supabase, user.id, \"admin\", companyId));\n\n\t\tif (!canView) {\n\t\t\tthrow new Error(\"Only owners and admins can view transfer history\");\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"ownership_transfers\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        previous_owner:users!ownership_transfers_previous_owner_id_fkey(id, name, email),\n        new_owner:users!ownership_transfers_new_owner_id_fkey(id, name, email),\n        initiated_by_user:users!ownership_transfers_initiated_by_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow new Error(error.message);\n\t\t}\n\n\t\treturn data;\n\t});\n}\n\n/**\n * Check if a team member can be deleted\n * Prevents deletion of company owner\n *\n * @param teamMemberId - Team member to check\n * @returns Object with canDelete boolean and reason if not allowed\n */\nexport async function canDeleteTeamMember(teamMemberId: string) {\n\treturn withErrorHandling(async () => {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Database connection not available\");\n\t\t}\n\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\tthrow new Error(\"No active company\");\n\t\t}\n\n\t\t// Get team member details\n\t\tconst { data: teamMember, error } = await supabase\n\t\t\t.from(\"company_memberships\")\n\t\t\t.select(\"user_id, role\")\n\t\t\t.eq(\"id\", teamMemberId)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.single();\n\n\t\tif (error || !teamMember) {\n\t\t\tthrow new Error(\"Team member not found\");\n\t\t}\n\n\t\t// Check if user is company owner\n\t\tconst { data: company } = await supabase\n\t\t\t.from(\"companies\")\n\t\t\t.select(\"owner_id\")\n\t\t\t.eq(\"id\", companyId)\n\t\t\t.single();\n\n\t\tif (company && company.owner_id === teamMember.user_id) {\n\t\t\treturn {\n\t\t\t\tcanDelete: false,\n\t\t\t\treason:\n\t\t\t\t\t\"Cannot delete company owner. Transfer ownership first before removing this team member.\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tcanDelete: true,\n\t\t};\n\t});\n}\n","/**\n * Messaging Profile Setup & Verification\n *\n * Verifies messaging profile configuration and can auto-update webhook URLs.\n */\n\nimport { TELNYX_CONFIG, telnyxClient } from \"./client\";\n\nexport type MessagingProfileStatus = {\n\texists: boolean;\n\tisActive: boolean;\n\thasWebhookUrl: boolean;\n\twebhookUrl: string | null;\n\twebhookFailoverUrl: string | null;\n\twebhookApiVersion: string | null;\n\tneedsFix: boolean;\n\tissues: string[];\n};\n\nexport type MessagingProfileFixResult = {\n\tsuccess: boolean;\n\tfixed: boolean;\n\terror?: string;\n\tchanges: string[];\n};\n\nfunction getWebhookUrl(): string | undefined {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\t\n\tconst isDevelopment = \n\t\tprocess.env.NODE_ENV === \"development\" ||\n\t\tprocess.env.VERCEL_ENV !== \"production\" ||\n\t\tprocess.env.DEPLOYMENT_ENV !== \"production\";\n\t\n\tfor (const candidate of candidates) {\n\t\tif (candidate && candidate.trim()) {\n\t\t\tconst trimmed = candidate.trim();\n\t\t\tconst isLocal =\n\t\t\t\ttrimmed.includes(\"localhost\") ||\n\t\t\t\ttrimmed.includes(\"127.0.0.1\") ||\n\t\t\t\ttrimmed.includes(\"0.0.0.0\");\n\t\t\t\n\t\t\t// In development, allow localhost URLs (useful for testing with ngrok or similar)\n\t\t\t// In production, reject localhost\n\t\t\tif (isLocal && !isDevelopment) {\n\t\t\t\tcontinue; // Skip localhost in production\n\t\t\t}\n\t\t\t\n\t\t\tconst normalized = trimmed.startsWith(\"http\")\n\t\t\t\t? trimmed\n\t\t\t\t: `https://${trimmed}`;\n\t\t\treturn `${normalized.replace(/\\/+$/, \"\")}/api/webhooks/telnyx`;\n\t\t}\n\t}\n\treturn undefined;\n}\n\n/**\n * Verify messaging profile configuration\n */\nexport async function verifyMessagingProfile(\n\tmessagingProfileId?: string,\n): Promise<MessagingProfileStatus> {\n\tconst profileId = messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\n\tconst status: MessagingProfileStatus = {\n\t\texists: false,\n\t\tisActive: false,\n\t\thasWebhookUrl: false,\n\t\twebhookUrl: null,\n\t\twebhookFailoverUrl: null,\n\t\twebhookApiVersion: null,\n\t\tneedsFix: false,\n\t\tissues: [],\n\t};\n\n\tif (!profileId || profileId.trim() === \"\") {\n\t\tstatus.issues.push(\"Messaging profile ID is not configured\");\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n\n\ttry {\n\t\tconst profile = await telnyxClient.messagingProfiles.retrieve(profileId);\n\t\tconst profileData = profile.data as any;\n\n\t\tif (!profileData) {\n\t\t\tstatus.issues.push(`Messaging profile ${profileId} not found in Telnyx`);\n\t\t\tstatus.needsFix = true;\n\t\t\treturn status;\n\t\t}\n\n\t\tstatus.exists = true;\n\t\tstatus.isActive = profileData.enabled !== false;\n\t\tstatus.webhookUrl = profileData.webhook_url || null;\n\t\tstatus.webhookFailoverUrl = profileData.webhook_failover_url || null;\n\t\tstatus.webhookApiVersion = profileData.webhook_api_version || null;\n\n\t\t// Check webhook URL\n\t\tconst expectedWebhookUrl = getWebhookUrl();\n\t\tif (!expectedWebhookUrl) {\n\t\t\tconst isDevelopment = \n\t\t\t\tprocess.env.NODE_ENV === \"development\" ||\n\t\t\t\tprocess.env.VERCEL_ENV !== \"production\" ||\n\t\t\t\tprocess.env.DEPLOYMENT_ENV !== \"production\";\n\t\t\t\n\t\t\tif (isDevelopment) {\n\t\t\t\tstatus.issues.push(\n\t\t\t\t\t\"NEXT_PUBLIC_SITE_URL is not set. Set it to your production URL (e.g., https://yourdomain.com) or use a tool like ngrok for local testing.\",\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tstatus.issues.push(\n\t\t\t\t\t\"NEXT_PUBLIC_SITE_URL is not set to a valid production URL. Set it to your production domain (e.g., https://yourdomain.com) in your environment variables.\",\n\t\t\t\t);\n\t\t\t}\n\t\t\tstatus.needsFix = true;\n\t\t} else if (!status.webhookUrl) {\n\t\t\tstatus.issues.push(\n\t\t\t\t`Webhook URL is not set. Expected: ${expectedWebhookUrl} (with optional ?company=... for multi-tenant)`,\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t} else {\n\t\t\t// Accept both base webhook URL and company-specific URLs (with query params)\n\t\t\tconst baseUrl = status.webhookUrl.split(\"?\")[0];\n\t\t\tif (\n\t\t\t\tbaseUrl === expectedWebhookUrl ||\n\t\t\t\tstatus.webhookUrl === expectedWebhookUrl\n\t\t\t) {\n\t\t\t\tstatus.hasWebhookUrl = true;\n\t\t\t} else {\n\t\t\t\tstatus.issues.push(\n\t\t\t\t\t`Webhook URL base is not set correctly. Expected: ${expectedWebhookUrl}, Current: ${baseUrl}`,\n\t\t\t\t);\n\t\t\t\tstatus.needsFix = true;\n\t\t\t}\n\t\t}\n\n\t\t// Check webhook API version\n\t\tif (status.webhookApiVersion !== \"2\") {\n\t\t\tstatus.issues.push(\n\t\t\t\t`Webhook API version should be \"2\", but is \"${status.webhookApiVersion || \"not set\"}\"`,\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\t// Check if profile is active\n\t\tif (!status.isActive) {\n\t\t\tstatus.issues.push(\"Messaging profile is not enabled\");\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\treturn status;\n\t} catch (error: any) {\n\t\tif (error?.statusCode === 404) {\n\t\t\tstatus.issues.push(`Messaging profile ${profileId} not found in Telnyx`);\n\t\t} else {\n\t\t\tstatus.issues.push(\n\t\t\t\terror?.message || \"Failed to retrieve messaging profile\",\n\t\t\t);\n\t\t}\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n}\n\n/**\n * Auto-fix messaging profile configuration\n */\nexport async function fixMessagingProfile(\n\tmessagingProfileId?: string,\n\toptions?: {\n\t\twebhookUrl?: string;\n\t\twebhookFailoverUrl?: string;\n\t},\n): Promise<MessagingProfileFixResult> {\n\tconst profileId = messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\tconst changes: string[] = [];\n\n\tif (!profileId || profileId.trim() === \"\") {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: \"Messaging profile ID is not configured\",\n\t\t\tchanges: [],\n\t\t};\n\t}\n\n\ttry {\n\t\t// Get current status\n\t\tconst status = await verifyMessagingProfile(profileId);\n\t\tif (!status.needsFix) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tfixed: false,\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Get expected webhook URL\n\t\tconst expectedWebhookUrl = options?.webhookUrl || getWebhookUrl();\n\t\tif (!expectedWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tfixed: false,\n\t\t\t\terror:\n\t\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be set to a valid production URL to configure webhooks\",\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Prepare update\n\t\tconst updateData: Record<string, unknown> = {};\n\n\t\t// Fix webhook URL\n\t\tif (status.webhookUrl !== expectedWebhookUrl) {\n\t\t\tupdateData.webhook_url = expectedWebhookUrl;\n\t\t\tchanges.push(`Updated webhook URL to ${expectedWebhookUrl}`);\n\t\t}\n\n\t\t// Fix webhook failover URL\n\t\tconst expectedFailoverUrl =\n\t\t\toptions?.webhookFailoverUrl ||\n\t\t\tprocess.env.TELNYX_WEBHOOK_FAILOVER_URL ||\n\t\t\tnull;\n\t\tif (status.webhookFailoverUrl !== expectedFailoverUrl) {\n\t\t\tupdateData.webhook_failover_url = expectedFailoverUrl;\n\t\t\tif (expectedFailoverUrl) {\n\t\t\t\tchanges.push(`Updated webhook failover URL to ${expectedFailoverUrl}`);\n\t\t\t} else {\n\t\t\t\tchanges.push(\"Removed webhook failover URL\");\n\t\t\t}\n\t\t}\n\n\t\t// Fix webhook API version\n\t\tif (status.webhookApiVersion !== \"2\") {\n\t\t\tupdateData.webhook_api_version = \"2\";\n\t\t\tchanges.push(\"Updated webhook API version to 2\");\n\t\t}\n\n\t\t// Fix profile enabled status\n\t\tif (!status.isActive) {\n\t\t\tupdateData.enabled = true;\n\t\t\tchanges.push(\"Enabled messaging profile\");\n\t\t}\n\n\t\t// Apply updates if needed\n\t\tif (Object.keys(updateData).length > 0) {\n\t\t\tawait telnyxClient.messagingProfiles.update(profileId, updateData);\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tfixed: changes.length > 0,\n\t\t\tchanges,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: error?.message || \"Failed to update messaging profile\",\n\t\t\tchanges,\n\t\t};\n\t}\n}\n\n/**\n * Get messaging profile details\n */\nasync function getMessagingProfileDetails(\n\tmessagingProfileId?: string,\n): Promise<{\n\tsuccess: boolean;\n\tdata?: any;\n\terror?: string;\n}> {\n\tconst profileId = messagingProfileId || TELNYX_CONFIG.messagingProfileId;\n\n\tif (!profileId || profileId.trim() === \"\") {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Messaging profile ID is not configured\",\n\t\t};\n\t}\n\n\ttry {\n\t\tconst profile = await telnyxClient.messagingProfiles.retrieve(profileId);\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: profile.data,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error?.message || \"Failed to retrieve messaging profile\",\n\t\t};\n\t}\n}\n","/**\n * Telnyx Phone Numbers Service - Number Management\n *\n * Handles all phone number operations including:\n * - Searching available numbers\n * - Purchasing numbers\n * - Porting numbers\n * - Configuring number settings\n * - Releasing numbers\n */\n\nimport { telnyxClient } from \"./client\";\n\n/**\n * Number type for search\n */\nexport type NumberType =\n\t| \"local\"\n\t| \"toll-free\"\n\t| \"national\"\n\t| \"mobile\"\n\t| \"shared_cost\";\n\n/**\n * Number features\n */\nexport type NumberFeature = \"sms\" | \"mms\" | \"voice\" | \"fax\";\n\n/**\n * Search for available phone numbers\n */\nexport async function searchAvailableNumbers(params: {\n\tcountryCode?: string;\n\tareaCode?: string;\n\tnumberType?: NumberType;\n\tfeatures?: NumberFeature[];\n\tlimit?: number;\n\tstartsWith?: string;\n\tendsWith?: string;\n\tcontains?: string;\n}) {\n\ttry {\n\t\tconst numbers = await (telnyxClient.availablePhoneNumbers as any).list({\n\t\t\tfilter: {\n\t\t\t\tcountry_code: params.countryCode || \"US\",\n\t\t\t\tnational_destination_code: params.areaCode,\n\t\t\t\tfeatures: params.features,\n\t\t\t\tlimit: params.limit || 10,\n\t\t\t\tstarts_with: params.startsWith,\n\t\t\t\tends_with: params.endsWith,\n\t\t\t\tcontains: params.contains,\n\t\t\t} as any,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: numbers.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to search numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Purchase a phone number\n */\nexport async function purchaseNumber(params: {\n\tphoneNumber: string;\n\tmessagingProfileId?: string;\n\tconnectionId?: string;\n\tbillingGroupId?: string;\n\tcustomerReference?: string;\n}) {\n\ttry {\n\t\tconst number = await telnyxClient.numberOrders.create({\n\t\t\tphone_numbers: [\n\t\t\t\t{\n\t\t\t\t\tphone_number: params.phoneNumber,\n\t\t\t\t},\n\t\t\t],\n\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\tconnection_id: params.connectionId,\n\t\t\tbilling_group_id: params.billingGroupId,\n\t\t\tcustomer_reference: params.customerReference,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\torderId: number.data?.id,\n\t\t\tdata: number.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to purchase number\",\n\t\t};\n\t}\n}\n\n/**\n * List all owned phone numbers\n */\nexport async function listOwnedNumbers(params?: {\n\tpageSize?: number;\n\tpageNumber?: number;\n\tfilterTag?: string;\n\tfilterStatus?: \"active\" | \"pending\" | \"suspended\" | \"deleted\";\n}) {\n\ttry {\n\t\tconst numbers = await (telnyxClient.phoneNumbers as any).list({\n\t\t\tpage: {\n\t\t\t\tsize: params?.pageSize || 20,\n\t\t\t\tnumber: params?.pageNumber || 1,\n\t\t\t},\n\t\t\tfilter: {\n\t\t\t\ttag: params?.filterTag,\n\t\t\t\tstatus: params?.filterStatus,\n\t\t\t} as any,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: numbers.data,\n\t\t\tmeta: numbers.meta,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to list numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Get phone number details\n */\nexport async function getNumberDetails(phoneNumberId: string) {\n\ttry {\n\t\tconst number = await (telnyxClient.phoneNumbers as any).retrieve(\n\t\t\tphoneNumberId,\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: number.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to retrieve number\",\n\t\t};\n\t}\n}\n\n/**\n * Update phone number configuration\n */\nexport async function updateNumber(params: {\n\tphoneNumberId: string;\n\tconnectionId?: string;\n\tmessagingProfileId?: string;\n\tbillingGroupId?: string;\n\ttags?: string[];\n\tcustomerReference?: string;\n}) {\n\ttry {\n\t\tconst number = await (telnyxClient.phoneNumbers as any).update(\n\t\t\tparams.phoneNumberId,\n\t\t\t{\n\t\t\t\tconnection_id: params.connectionId,\n\t\t\t\tmessaging_profile_id: params.messagingProfileId,\n\t\t\t\tbilling_group_id: params.billingGroupId,\n\t\t\t\ttags: params.tags,\n\t\t\t\tcustomer_reference: params.customerReference,\n\t\t\t} as any,\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: number.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to update number\",\n\t\t};\n\t}\n}\n\n/**\n * Release (delete) a phone number\n */\nexport async function releaseNumber(phoneNumberId: string) {\n\ttry {\n\t\tawait (telnyxClient.phoneNumbers as any).del(phoneNumberId);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to release number\",\n\t\t};\n\t}\n}\n\n/**\n * Initiate number porting request\n */\nexport async function initiatePorting(params: {\n\tphoneNumbers: string[];\n\tbillingGroupId?: string;\n\tfastPortEligible?: boolean;\n\t// Account information\n\taccountNumber?: string;\n\taccountPin?: string;\n\tauthorizedPerson?: string;\n\t// Service address\n\taddressLine1?: string;\n\tcity?: string;\n\tstateOrProvince?: string;\n\tzipOrPostalCode?: string;\n\tcountryCode?: string;\n}) {\n\ttry {\n\t\tconst portingOrder = await (telnyxClient as any).numberPortouts.create({\n\t\t\tphone_numbers: params.phoneNumbers,\n\t\t\tbilling_group_id: params.billingGroupId,\n\t\t\tfast_port_eligible: params.fastPortEligible,\n\t\t\tcustomer_reference: {\n\t\t\t\taccount_number: params.accountNumber,\n\t\t\t\taccount_pin: params.accountPin,\n\t\t\t\tauthorized_person: params.authorizedPerson,\n\t\t\t},\n\t\t\tservice_address: {\n\t\t\t\taddress_line_1: params.addressLine1,\n\t\t\t\tcity: params.city,\n\t\t\t\tstate_or_province: params.stateOrProvince,\n\t\t\t\tzip_or_postal_code: params.zipOrPostalCode,\n\t\t\t\tcountry_code: params.countryCode || \"US\",\n\t\t\t},\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tportingOrderId: portingOrder.data.id,\n\t\t\tdata: portingOrder.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to initiate porting\",\n\t\t};\n\t}\n}\n\n/**\n * Get porting order status\n */\nasync function getPortingStatus(portingOrderId: string) {\n\ttry {\n\t\tconst order = await (telnyxClient as any).numberPortouts.retrieve(\n\t\t\tportingOrderId,\n\t\t);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tstatus: order.data.status,\n\t\t\tdata: order.data,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get porting status\",\n\t\t};\n\t}\n}\n\n/**\n * Estimate number costs\n */\nasync function estimateNumberCost(params: {\n\tcountryCode: string;\n\tnumberType: NumberType;\n}) {\n\t// Cost estimates based on Telnyx pricing (as of 2025)\n\tconst costs = {\n\t\tUS: {\n\t\t\tlocal: { monthly: 1.0, setup: 0.0 },\n\t\t\t\"toll-free\": { monthly: 2.0, setup: 0.0 },\n\t\t\tmobile: { monthly: 5.0, setup: 0.0 },\n\t\t},\n\t\tCA: {\n\t\t\tlocal: { monthly: 1.5, setup: 0.0 },\n\t\t\t\"toll-free\": { monthly: 2.5, setup: 0.0 },\n\t\t},\n\t\tGB: {\n\t\t\tlocal: { monthly: 2.0, setup: 0.0 },\n\t\t\t\"toll-free\": { monthly: 3.0, setup: 0.0 },\n\t\t},\n\t};\n\n\tconst countryCode = params.countryCode.toUpperCase();\n\tconst pricing = costs[countryCode as keyof typeof costs];\n\n\tif (!pricing) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: `Pricing not available for country: ${countryCode}`,\n\t\t};\n\t}\n\n\tconst typePricing = pricing[params.numberType as keyof typeof pricing];\n\n\tif (!typePricing) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: `Number type ${params.numberType} not available in ${countryCode}`,\n\t\t};\n\t}\n\n\treturn {\n\t\tsuccess: true,\n\t\tcosts: {\n\t\t\tmonthly: typePricing.monthly,\n\t\t\tsetup: typePricing.setup,\n\t\t\tcurrency: \"USD\",\n\t\t},\n\t};\n}\n\n/**\n * Validate if a number can be ported\n */\nasync function validatePortability(phoneNumber: string) {\n\ttry {\n\t\t// This would typically call Telnyx's LNP (Local Number Portability) check API\n\t\t// For now, we'll do basic validation\n\n\t\tconst cleanNumber = phoneNumber.replace(/\\D/g, \"\");\n\n\t\t// Must be at least 10 digits\n\t\tif (cleanNumber.length < 10) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tportable: false,\n\t\t\t\treason: \"Phone number must be at least 10 digits\",\n\t\t\t};\n\t\t}\n\n\t\t// In a real implementation, you would check with Telnyx's LNP API\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tportable: true,\n\t\t\testimatedPortingDays: 7, // Typical porting timeline\n\t\t\tfastPortEligible: false,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to validate portability\",\n\t\t};\n\t}\n}\n","import type { SupabaseClient } from \"@supabase/supabase-js\";\nimport type { Database } from \"@/types/supabase\";\nimport { telnyxClient } from \"./client\";\nimport {\n\ttype NumberFeature,\n\ttype NumberType,\n\tpurchaseNumber,\n\tsearchAvailableNumbers,\n} from \"./numbers\";\n\nexport type CompanyTelnyxSettingsRow = {\n\tcompany_id: string;\n\tstatus: string;\n\tmessaging_profile_id: string | null;\n\tcall_control_application_id: string | null;\n\tdefault_outbound_number: string | null;\n\tdefault_outbound_phone_number_id: string | null;\n\tten_dlc_brand_id: string | null;\n\tten_dlc_campaign_id: string | null;\n\twebhook_secret: string | null;\n\tmetadata: Record<string, unknown> | null;\n\tlast_provisioned_at: string | null;\n\tcreated_at: string | null;\n\tupdated_at: string | null;\n};\n\ntype TypedSupabaseClient = SupabaseClient<Database>;\n\ntype ProvisionOptions = {\n\tcompanyId: string;\n\tsupabase: TypedSupabaseClient;\n\tareaCode?: string;\n\tnumberQuantity?: number;\n\tfeatures?: NumberFeature[];\n};\n\nconst DEFAULT_FEATURES: NumberFeature[] = [\"sms\", \"mms\", \"voice\"];\nconst COMPANY_SETTINGS_TABLE = \"company_telnyx_settings\";\n\nasync function getBaseAppUrl(): Promise<string | undefined> {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\n\tfor (const candidate of candidates) {\n\t\tif (!candidate) continue;\n\t\tconst trimmed = candidate.trim();\n\t\tif (!trimmed) continue;\n\t\tconst isLocal = /localhost|127\\.0\\.0\\.1|0\\.0\\.0\\.0/i.test(trimmed);\n\t\tif (isLocal) {\n\t\t\tcontinue;\n\t\t}\n\t\tif (trimmed.startsWith(\"http\")) {\n\t\t\treturn trimmed.replace(/\\/+$/, \"\");\n\t\t}\n\t\treturn `https://${trimmed.replace(/\\/+$/, \"\")}`;\n\t}\n\n\treturn undefined;\n}\n\nasync function buildCompanyWebhookUrl(\n\tcompanyId: string,\n): Promise<string | undefined> {\n\tconst base = await getBaseAppUrl();\n\tif (!base) {\n\t\treturn undefined;\n\t}\n\treturn `${base}/api/webhooks/telnyx?company=${companyId}`;\n}\n\nfunction formatDisplay(phoneNumber: string): string {\n\tconst digits = phoneNumber.replace(/[^0-9]/g, \"\");\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn `(${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;\n\t}\n\tif (digits.length === 10) {\n\t\treturn `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;\n\t}\n\treturn phoneNumber;\n}\n\ntype ProvisionResult = {\n\tsuccess: boolean;\n\tsettings?: CompanyTelnyxSettingsRow;\n\terror?: string;\n\tlog: string[];\n};\n\nasync function ensurePhoneNumbersInserted(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n\tphoneNumbers: Array<{\n\t\tphoneNumber: string;\n\t\tareaCode?: string;\n\t\tcountryCode?: string;\n\t\ttelnyxPhoneNumberId?: string;\n\t\tnumberType?: NumberType;\n\t}>,\n\tdefaults: {\n\t\tmessagingProfileId: string | null;\n\t\tconnectionId: string | null;\n\t},\n): Promise<void> {\n\tif (phoneNumbers.length === 0) {\n\t\treturn;\n\t}\n\n\tfor (const number of phoneNumbers) {\n\t\tconst digits = number.phoneNumber.replace(/[^0-9]/g, \"\");\n\t\tconst e164 = digits.startsWith(\"+\")\n\t\t\t? digits\n\t\t\t: digits.startsWith(\"1\") && digits.length === 11\n\t\t\t\t? `+${digits}`\n\t\t\t\t: `+1${digits}`;\n\n\t\tconst row = {\n\t\t\tcompany_id: companyId,\n\t\t\tphone_number: e164,\n\t\t\tformatted_number: formatDisplay(e164),\n\t\t\tarea_code: number.areaCode || e164.slice(2, 5),\n\t\t\tcountry_code: number.countryCode || \"US\",\n\t\t\tnumber_type: number.numberType || \"local\",\n\t\t\tstatus: \"active\",\n\t\t\tfeatures: DEFAULT_FEATURES,\n\t\t\ttelnyx_phone_number_id: number.telnyxPhoneNumberId || null,\n\t\t\ttelnyx_messaging_profile_id: defaults.messagingProfileId,\n\t\t\ttelnyx_connection_id: defaults.connectionId,\n\t\t};\n\n\t\tconst { data: existing } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"phone_number\", e164)\n\t\t\t.maybeSingle();\n\n\t\tif (existing?.id) {\n\t\t\tawait supabase.from(\"phone_numbers\").update(row).eq(\"id\", existing.id);\n\t\t} else {\n\t\t\tawait supabase.from(\"phone_numbers\").insert(row);\n\t\t}\n\t}\n}\n\nasync function createMessagingProfile(companyName: string, webhookUrl: string) {\n\tconst response = await telnyxClient.messagingProfiles.create({\n\t\tname: `${companyName} - Thorbis`,\n\t\tenabled: true,\n\t\twebhook_url: webhookUrl,\n\t\twebhook_api_version: \"2\",\n\t});\n\treturn response.data as any;\n}\n\nasync function createCallControlApplication(\n\tcompanyName: string,\n\twebhookUrl: string,\n) {\n\tconst response = await telnyxClient.callControlApplications.create({\n\t\tapplication_name: `${companyName} - Thorbis`,\n\t\twebhook_event_url: webhookUrl,\n\t\twebhook_api_version: \"2\",\n\t\tanswering_machine_detection: \"premium\",\n\t});\n\treturn response.data as any;\n}\n\nasync function purchaseNumbers(\n\tcompanyId: string,\n\toptions: {\n\t\tquantity: number;\n\t\tareaCode?: string;\n\t\tfeatures?: NumberFeature[];\n\t\tmessagingProfileId: string;\n\t\tconnectionId: string;\n\t},\n): Promise<\n\tArray<{\n\t\tphoneNumber: string;\n\t\ttelnyxPhoneNumberId?: string;\n\t\tareaCode?: string;\n\t\tnumberType?: NumberType;\n\t}>\n> {\n\tconst search = await searchAvailableNumbers({\n\t\tareaCode: options.areaCode,\n\t\tfeatures: options.features || DEFAULT_FEATURES,\n\t\tlimit: Math.max(options.quantity * 2, options.quantity),\n\t});\n\n\tif (!search.success || !search.data || search.data.length === 0) {\n\t\tthrow new Error(\"No available phone numbers found for requested criteria\");\n\t}\n\n\tconst purchased: Array<{\n\t\tphoneNumber: string;\n\t\ttelnyxPhoneNumberId?: string;\n\t\tareaCode?: string;\n\t\tnumberType?: NumberType;\n\t}> = [];\n\tconst candidates = search.data as any[];\n\n\tfor (const candidate of candidates) {\n\t\tif (purchased.length >= options.quantity) {\n\t\t\tbreak;\n\t\t}\n\n\t\tconst number = candidate.phone_number as string;\n\t\tconst purchaseResult = await purchaseNumber({\n\t\t\tphoneNumber: number,\n\t\t\tmessagingProfileId: options.messagingProfileId,\n\t\t\tconnectionId: options.connectionId,\n\t\t\tcustomerReference: `company:${companyId}`,\n\t\t});\n\n\t\tif (!purchaseResult.success) {\n\t\t\tthrow new Error(\n\t\t\t\tpurchaseResult.error ||\n\t\t\t\t\t`Failed to purchase number ${number} from Telnyx`,\n\t\t\t);\n\t\t}\n\n\t\tpurchased.push({\n\t\t\tphoneNumber: number,\n\t\t\tareaCode: candidate.national_destination_code || candidate.area_code,\n\t\t\ttelnyxPhoneNumberId: candidate.id || candidate.phone_number,\n\t\t\tnumberType: candidate.number_type,\n\t\t});\n\t}\n\n\tif (purchased.length === 0) {\n\t\tthrow new Error(\"Failed to purchase any phone numbers\");\n\t}\n\n\t// Enable messaging on all purchased numbers\n\tfor (const number of purchased) {\n\t\tif (number.telnyxPhoneNumberId) {\n\t\t\ttry {\n\t\t\t\tconst TELNYX_API_KEY = process.env.TELNYX_API_KEY;\n\t\t\t\tif (!TELNYX_API_KEY) {\n\t\t\t\t\tthrow new Error(\"TELNYX_API_KEY not configured\");\n\t\t\t\t}\n\n\t\t\t\tawait fetch(\n\t\t\t\t\t`https://api.telnyx.com/v2/phone_numbers/${number.telnyxPhoneNumberId}/messaging`,\n\t\t\t\t\t{\n\t\t\t\t\t\tmethod: \"PATCH\",\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\t\tAuthorization: `Bearer ${TELNYX_API_KEY}`,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\t\tmessaging_profile_id: options.messagingProfileId,\n\t\t\t\t\t\t}),\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\t// Log but don't fail - messaging can be enabled later\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`Failed to enable messaging on ${number.phoneNumber}:`,\n\t\t\t\t\terror,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn purchased;\n}\n\nexport async function fetchCompanyTelnyxSettings(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n): Promise<CompanyTelnyxSettingsRow | null> {\n\tconst { data } = await (supabase as any)\n\t\t.from(COMPANY_SETTINGS_TABLE)\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.maybeSingle();\n\n\treturn (data as CompanyTelnyxSettingsRow | null) ?? null;\n}\n\nexport async function ensureCompanyTelnyxSetup(\n\toptions: ProvisionOptions,\n): Promise<ProvisionResult> {\n\tconst { supabase, companyId } = options;\n\tconst log: string[] = [];\n\n\tconst existing = await fetchCompanyTelnyxSettings(supabase, companyId);\n\tif (\n\t\texisting &&\n\t\texisting.status === \"ready\" &&\n\t\texisting.messaging_profile_id &&\n\t\texisting.call_control_application_id\n\t) {\n\t\tlog.push(\"Existing Telnyx configuration found\");\n\t\treturn { success: true, settings: existing, log };\n\t}\n\n\tconst { data: company } = await supabase\n\t\t.from(\"companies\")\n\t\t.select(\"id, name\")\n\t\t.eq(\"id\", companyId)\n\t\t.maybeSingle();\n\n\tif (!company) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Company not found\",\n\t\t\tlog,\n\t\t};\n\t}\n\n\tconst webhookUrl = await buildCompanyWebhookUrl(companyId);\n\tif (!webhookUrl) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be configured with a public URL to provision Telnyx resources\",\n\t\t\tlog,\n\t\t};\n\t}\n\n\ttry {\n\t\tlog.push(\"Creating messaging profile\");\n\t\tconst messagingProfile = await createMessagingProfile(\n\t\t\tcompany.name || \"Company\",\n\t\t\twebhookUrl,\n\t\t);\n\t\tconst messagingProfileId = messagingProfile?.id as string;\n\n\t\tlog.push(\"Creating call control application\");\n\t\tconst callApplication = await createCallControlApplication(\n\t\t\tcompany.name || \"Company\",\n\t\t\twebhookUrl,\n\t\t);\n\t\tconst connectionId = callApplication?.id as string;\n\n\t\tif (!messagingProfileId || !connectionId) {\n\t\t\tthrow new Error(\n\t\t\t\t\"Failed to provision messaging profile or call control application\",\n\t\t\t);\n\t\t}\n\n\t\tlog.push(\"Purchasing phone numbers\");\n\t\tconst purchasedNumbers = await purchaseNumbers(companyId, {\n\t\t\tquantity: Math.max(options.numberQuantity || 1, 1),\n\t\t\tareaCode: options.areaCode,\n\t\t\tfeatures: options.features || DEFAULT_FEATURES,\n\t\t\tmessagingProfileId,\n\t\t\tconnectionId,\n\t\t});\n\n\t\tawait ensurePhoneNumbersInserted(supabase, companyId, purchasedNumbers, {\n\t\t\tmessagingProfileId,\n\t\t\tconnectionId,\n\t\t});\n\n\t\tconst defaultNumber =\n\t\t\tpurchasedNumbers.find((n) => n.numberType === \"toll-free\") ||\n\t\t\tpurchasedNumbers[0];\n\n\t\tconst upsertResult = await (supabase as any)\n\t\t\t.from(COMPANY_SETTINGS_TABLE)\n\t\t\t.upsert(\n\t\t\t\t{\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\tstatus: \"ready\",\n\t\t\t\t\tmessaging_profile_id: messagingProfileId,\n\t\t\t\t\tcall_control_application_id: connectionId,\n\t\t\t\t\tdefault_outbound_number: defaultNumber?.phoneNumber || null,\n\t\t\t\t\tdefault_outbound_phone_number_id:\n\t\t\t\t\t\tdefaultNumber?.telnyxPhoneNumberId || null,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\tlog,\n\t\t\t\t\t\tpurchased_numbers: purchasedNumbers.map((n) => n.phoneNumber),\n\t\t\t\t\t},\n\t\t\t\t\tlast_provisioned_at: new Date().toISOString(),\n\t\t\t\t},\n\t\t\t\t{ onConflict: \"company_id\" },\n\t\t\t)\n\t\t\t.select(\"*\")\n\t\t\t.single();\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tsettings: upsertResult.data as CompanyTelnyxSettingsRow,\n\t\t\tlog,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to provision Telnyx resources\",\n\t\t\tlog,\n\t\t};\n\t}\n}\n\nexport async function purchaseAdditionalNumbers(\n\toptions: ProvisionOptions & { quantity: number },\n): Promise<ProvisionResult> {\n\tconst { supabase, companyId, quantity } = options;\n\tconst log: string[] = [];\n\n\tconst settings = await fetchCompanyTelnyxSettings(supabase, companyId);\n\tif (\n\t\t!settings ||\n\t\tsettings.status !== \"ready\" ||\n\t\t!settings.messaging_profile_id ||\n\t\t!settings.call_control_application_id\n\t) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\t\"Company Telnyx configuration is not ready. Run ensureCompanyTelnyxSetup first.\",\n\t\t\tlog,\n\t\t};\n\t}\n\n\ttry {\n\t\tlog.push(`Purchasing ${quantity} additional numbers`);\n\t\tconst purchasedNumbers = await purchaseNumbers(companyId, {\n\t\t\tquantity,\n\t\t\tareaCode: options.areaCode,\n\t\t\tfeatures: options.features || DEFAULT_FEATURES,\n\t\t\tmessagingProfileId: settings.messaging_profile_id,\n\t\t\tconnectionId: settings.call_control_application_id,\n\t\t});\n\n\t\tawait ensurePhoneNumbersInserted(supabase, companyId, purchasedNumbers, {\n\t\t\tmessagingProfileId: settings.messaging_profile_id,\n\t\t\tconnectionId: settings.call_control_application_id,\n\t\t});\n\n\t\t// Prefer toll-free numbers as the default outbound if available\n\t\tconst tollFreeNumber = purchasedNumbers.find(\n\t\t\t(n) => n.numberType === \"toll-free\",\n\t\t);\n\t\tif (\n\t\t\ttollFreeNumber &&\n\t\t\tsettings.default_outbound_number !== tollFreeNumber.phoneNumber\n\t\t) {\n\t\t\tawait supabase\n\t\t\t\t.from(COMPANY_SETTINGS_TABLE)\n\t\t\t\t.update({\n\t\t\t\t\tdefault_outbound_number: tollFreeNumber.phoneNumber,\n\t\t\t\t\tdefault_outbound_phone_number_id:\n\t\t\t\t\t\ttollFreeNumber.telnyxPhoneNumberId || null,\n\t\t\t\t})\n\t\t\t\t.eq(\"company_id\", companyId);\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tsettings,\n\t\t\tlog,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to purchase phone numbers\",\n\t\t\tlog,\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"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"}