{"version":3,"sources":["../../../../../../apps/web/.next-internal/server/app/test-webhook-fix/page/actions.js%20%28server%20actions%20loader%29","../../../../../../apps/web/src/actions/telnyx-provisioning.ts"],"sourcesContent":["export {getCurrentUserRole as '001f005176797ef23488068124fb9a744915a477de'} from 'ACTIONS_MODULE0'\nexport {canDeleteTeamMember as '406f6624261c6dd1a908026fa1408a3f6d507b6e7d'} from 'ACTIONS_MODULE0'\nexport {enablePhoneNumberMessaging as '40e18cfbd64c1c29c2bc1c090326c6641bbac47e1b'} from 'ACTIONS_MODULE1'\nexport {fixCompanyTelnyxWebhooks as '406c6b0465a4a880dc5b4941deaa6865c4c201462c'} from 'ACTIONS_MODULE1'\n","\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport { telnyxClient } from \"@/lib/telnyx/client\";\nimport { fixMessagingProfile } from \"@/lib/telnyx/messaging-profile-setup\";\nimport {\n\ttype CompanyTelnyxSettingsRow,\n\tensureCompanyTelnyxSetup,\n\tfetchCompanyTelnyxSettings,\n\tpurchaseAdditionalNumbers,\n} from \"@/lib/telnyx/provision-company\";\n\nasync function provisionCompanyTelnyx(companyId: string) {\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Service unavailable\" };\n\t}\n\n\tconst result = await ensureCompanyTelnyxSetup({\n\t\tcompanyId,\n\t\tsupabase,\n\t});\n\n\tif (result.success) {\n\t\trevalidatePath(`/dashboard/communication`);\n\t}\n\n\treturn result;\n}\n\nasync function purchaseCompanyPhoneNumbers(\n\tcompanyId: string,\n\tquantity: number,\n\tareaCode?: string,\n) {\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Service unavailable\" };\n\t}\n\n\tconst result = await purchaseAdditionalNumbers({\n\t\tcompanyId,\n\t\tsupabase,\n\t\tquantity,\n\t\tareaCode,\n\t});\n\n\tif (result.success) {\n\t\trevalidatePath(`/dashboard/communication`);\n\t}\n\n\treturn result;\n}\n\n/**\n * Fix webhook URLs for a company's Telnyx configuration\n * Updates both messaging profile and call control application webhooks\n */\nexport async function fixCompanyTelnyxWebhooks(companyId: string) {\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Service unavailable\" };\n\t}\n\n\ttry {\n\t\tconst settings = await fetchCompanyTelnyxSettings(supabase, companyId);\n\t\tif (\n\t\t\t!settings ||\n\t\t\t!settings.messaging_profile_id ||\n\t\t\t!settings.call_control_application_id\n\t\t) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Company Telnyx settings not found. Run provisioning first.\",\n\t\t\t};\n\t\t}\n\n\t\tconst changes: string[] = [];\n\t\tconst CORRECT_WEBHOOK_URL = `https://thorbis.com/api/webhooks/telnyx?company=${companyId}`;\n\n\t\t// Fix messaging profile\n\t\tconst messagingResult = await fixMessagingProfile(\n\t\t\tsettings.messaging_profile_id,\n\t\t\t{\n\t\t\t\twebhookUrl: CORRECT_WEBHOOK_URL,\n\t\t\t},\n\t\t);\n\n\t\tif (messagingResult.success && messagingResult.fixed) {\n\t\t\tchanges.push(...messagingResult.changes);\n\t\t} else if (!messagingResult.success) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Failed to update messaging profile: ${messagingResult.error}`,\n\t\t\t};\n\t\t}\n\n\t\t// Fix call control application\n\t\ttry {\n\t\t\tconst callApp = await telnyxClient.callControlApplications.retrieve(\n\t\t\t\tsettings.call_control_application_id,\n\t\t\t);\n\t\t\tconst currentWebhook = (callApp.data as any)?.webhook_event_url;\n\n\t\t\tif (currentWebhook !== CORRECT_WEBHOOK_URL) {\n\t\t\t\tawait telnyxClient.callControlApplications.update(\n\t\t\t\t\tsettings.call_control_application_id,\n\t\t\t\t\t{\n\t\t\t\t\t\twebhook_event_url: CORRECT_WEBHOOK_URL,\n\t\t\t\t\t\twebhook_api_version: \"2\",\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tchanges.push(\n\t\t\t\t\t`Updated call control webhook URL to ${CORRECT_WEBHOOK_URL}`,\n\t\t\t\t);\n\t\t\t\tchanges.push(\"Updated call control webhook API version to 2\");\n\t\t\t}\n\t\t} catch (error: any) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Failed to update call control application: ${error?.message || error}`,\n\t\t\t};\n\t\t}\n\n\t\trevalidatePath(`/dashboard/communication`);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tfixed: changes.length > 0,\n\t\t\tchanges,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error?.message || \"Failed to fix webhooks\",\n\t\t};\n\t}\n}\n\n/**\n * Enable SMS/MMS on a company's phone number\n * Updates the phone number messaging settings using the correct Telnyx API\n */\nexport async function enablePhoneNumberMessaging(companyId: string) {\n\tconst supabase = await createClient();\n\tif (!supabase) {\n\t\treturn { success: false, error: \"Service unavailable\" };\n\t}\n\n\ttry {\n\t\tconst settings = await fetchCompanyTelnyxSettings(supabase, companyId);\n\t\tif (\n\t\t\t!settings ||\n\t\t\t!settings.default_outbound_phone_number_id ||\n\t\t\t!settings.messaging_profile_id\n\t\t) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Company Telnyx settings incomplete. Run provisioning first.\",\n\t\t\t};\n\t\t}\n\n\t\t// Use the messaging settings endpoint to enable messaging\n\t\tconst TELNYX_API_KEY = process.env.TELNYX_API_KEY;\n\t\tif (!TELNYX_API_KEY) {\n\t\t\treturn { success: false, error: \"TELNYX_API_KEY not configured\" };\n\t\t}\n\n\t\tconst response = await fetch(\n\t\t\t`https://api.telnyx.com/v2/phone_numbers/${settings.default_outbound_phone_number_id}/messaging`,\n\t\t\t{\n\t\t\t\tmethod: \"PATCH\",\n\t\t\t\theaders: {\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\tAuthorization: `Bearer ${TELNYX_API_KEY}`,\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tmessaging_profile_id: settings.messaging_profile_id,\n\t\t\t\t}),\n\t\t\t},\n\t\t);\n\n\t\tconst data = await response.json();\n\n\t\tif (!response.ok) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `${response.status} ${JSON.stringify(data)}`,\n\t\t\t};\n\t\t}\n\n\t\trevalidatePath(`/dashboard/communication`);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data.data,\n\t\t\tmessage: `Phone number ${settings.default_outbound_number} enabled for SMS/MMS`,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error?.message || \"Failed to enable messaging on phone number\",\n\t\t};\n\t}\n}\n\nexport type { CompanyTelnyxSettingsRow };\n"],"names":[],"mappings":"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"}