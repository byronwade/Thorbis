{"version":3,"sources":["../../../../../../apps/web/src/lib/queries/analytics.ts"],"sourcesContent":["import { cache } from \"react\";\nimport { createClient } from \"@/lib/supabase/server\";\n\nexport interface DailyMetric {\n\tdate: string;\n\tvalue: number;\n\tvalue2?: number;\n}\n\nexport interface AnalyticsTrendData {\n\trevenue: DailyMetric[];\n\tjobs: DailyMetric[];\n\tcommunications: DailyMetric[];\n}\n\n/**\n * Get analytics trend data for charts\n * Uses analytics_daily_snapshots if available, otherwise calculates from raw data\n */\nexport const getAnalyticsTrends = cache(\n\tasync (companyId: string, days: number = 90): Promise<AnalyticsTrendData> => {\n\t\tconst supabase = await createClient();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\t// Try to get data from analytics_daily_snapshots first\n\t\tconst { data: snapshots } = await supabase\n\t\t\t.from(\"analytics_daily_snapshots\")\n\t\t\t.select(\n\t\t\t\t\"snapshot_date, total_revenue, jobs_completed, emails_sent, emails_received, sms_sent, sms_received, calls_made, calls_received\",\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"snapshot_date\", startDate.toISOString().split(\"T\")[0])\n\t\t\t.order(\"snapshot_date\", { ascending: true })\n\t\t\t.limit(days);\n\n\t\tif (snapshots && snapshots.length > 0) {\n\t\t\treturn {\n\t\t\t\trevenue: snapshots.map((s) => ({\n\t\t\t\t\tdate: s.snapshot_date,\n\t\t\t\t\tvalue: (s.total_revenue || 0) / 100, // Convert cents to dollars\n\t\t\t\t})),\n\t\t\t\tjobs: snapshots.map((s) => ({\n\t\t\t\t\tdate: s.snapshot_date,\n\t\t\t\t\tvalue: s.jobs_completed || 0,\n\t\t\t\t})),\n\t\t\t\tcommunications: snapshots.map((s) => ({\n\t\t\t\t\tdate: s.snapshot_date,\n\t\t\t\t\tvalue: (s.emails_sent || 0) + (s.sms_sent || 0) + (s.calls_made || 0),\n\t\t\t\t\tvalue2:\n\t\t\t\t\t\t(s.emails_received || 0) +\n\t\t\t\t\t\t(s.sms_received || 0) +\n\t\t\t\t\t\t(s.calls_received || 0),\n\t\t\t\t})),\n\t\t\t};\n\t\t}\n\n\t\t// Fallback: Calculate from raw data if no snapshots exist\n\t\t// This is a temporary solution until the cron job populates snapshots\n\t\tconst [revenueData, jobsData, commsData] = await Promise.all([\n\t\t\tgetRevenueByDay(supabase, companyId, startDate, days),\n\t\t\tgetJobsByDay(supabase, companyId, startDate, days),\n\t\t\tgetCommunicationsByDay(supabase, companyId, startDate, days),\n\t\t]);\n\n\t\treturn {\n\t\t\trevenue: revenueData,\n\t\t\tjobs: jobsData,\n\t\t\tcommunications: commsData,\n\t\t};\n\t},\n);\n\n// Helper function to generate date range\nfunction generateDateRange(startDate: Date, days: number): string[] {\n\tconst dates: string[] = [];\n\tconst current = new Date(startDate);\n\tfor (let i = 0; i < days; i++) {\n\t\tdates.push(current.toISOString().split(\"T\")[0]);\n\t\tcurrent.setDate(current.getDate() + 1);\n\t}\n\treturn dates;\n}\n\n// Get revenue by day from payments\nasync function getRevenueByDay(\n\tsupabase: Awaited<ReturnType<typeof createClient>>,\n\tcompanyId: string,\n\tstartDate: Date,\n\tdays: number,\n): Promise<DailyMetric[]> {\n\tconst { data: payments } = await supabase\n\t\t.from(\"payments\")\n\t\t.select(\"amount, created_at\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"completed\")\n\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t.order(\"created_at\", { ascending: true })\n\t\t.limit(10000); // Prevent unbounded query for analytics\n\n\t// Group by day\n\tconst byDay: Record<string, number> = {};\n\tconst dateRange = generateDateRange(startDate, days);\n\n\t// Initialize all days with 0\n\tfor (const date of dateRange) {\n\t\tbyDay[date] = 0;\n\t}\n\n\t// Sum payments by day\n\tfor (const payment of payments || []) {\n\t\tconst date = new Date(payment.created_at).toISOString().split(\"T\")[0];\n\t\tif (byDay[date] !== undefined) {\n\t\t\tbyDay[date] += (payment.amount || 0) / 100; // Convert cents to dollars\n\t\t}\n\t}\n\n\treturn dateRange.map((date) => ({\n\t\tdate,\n\t\tvalue: byDay[date] || 0,\n\t}));\n}\n\n// Get jobs completed by day\nasync function getJobsByDay(\n\tsupabase: Awaited<ReturnType<typeof createClient>>,\n\tcompanyId: string,\n\tstartDate: Date,\n\tdays: number,\n): Promise<DailyMetric[]> {\n\tconst { data: jobs } = await supabase\n\t\t.from(\"jobs\")\n\t\t.select(\"created_at, status\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"completed\")\n\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t.order(\"created_at\", { ascending: true })\n\t\t.limit(10000); // Prevent unbounded query for analytics\n\n\t// Group by day\n\tconst byDay: Record<string, number> = {};\n\tconst dateRange = generateDateRange(startDate, days);\n\n\t// Initialize all days with 0\n\tfor (const date of dateRange) {\n\t\tbyDay[date] = 0;\n\t}\n\n\t// Count jobs by day\n\tfor (const job of jobs || []) {\n\t\tconst date = new Date(job.created_at).toISOString().split(\"T\")[0];\n\t\tif (byDay[date] !== undefined) {\n\t\t\tbyDay[date]++;\n\t\t}\n\t}\n\n\treturn dateRange.map((date) => ({\n\t\tdate,\n\t\tvalue: byDay[date] || 0,\n\t}));\n}\n\n// Get communications by day\nasync function getCommunicationsByDay(\n\tsupabase: Awaited<ReturnType<typeof createClient>>,\n\tcompanyId: string,\n\tstartDate: Date,\n\tdays: number,\n): Promise<DailyMetric[]> {\n\tconst { data: comms } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\"created_at, direction\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t.order(\"created_at\", { ascending: true })\n\t\t.limit(10000); // Prevent unbounded query for analytics\n\n\t// Group by day\n\tconst outbound: Record<string, number> = {};\n\tconst inbound: Record<string, number> = {};\n\tconst dateRange = generateDateRange(startDate, days);\n\n\t// Initialize all days with 0\n\tfor (const date of dateRange) {\n\t\toutbound[date] = 0;\n\t\tinbound[date] = 0;\n\t}\n\n\t// Count comms by day and direction\n\tfor (const comm of comms || []) {\n\t\tconst date = new Date(comm.created_at).toISOString().split(\"T\")[0];\n\t\tif (outbound[date] !== undefined) {\n\t\t\tif (comm.direction === \"outbound\") {\n\t\t\t\toutbound[date]++;\n\t\t\t} else {\n\t\t\t\tinbound[date]++;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn dateRange.map((date) => ({\n\t\tdate,\n\t\tvalue: outbound[date] || 0,\n\t\tvalue2: inbound[date] || 0,\n\t}));\n}\n\n/**\n * Get KPI summary for a company\n */\nexport const getKPISummary = cache(async (companyId: string) => {\n\tconst supabase = await createClient();\n\n\t// Get the latest monthly technician metrics summary\n\tconst { data: kpiData } = await supabase\n\t\t.from(\"analytics_technician_metrics\")\n\t\t.select(`\n\t\t\tperiod_start,\n\t\t\tfirst_time_fix_rate,\n\t\t\tutilization_rate,\n\t\t\taverage_rating,\n\t\t\ton_time_rate\n\t\t`)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"period_type\", \"monthly\")\n\t\t.order(\"period_start\", { ascending: false })\n\t\t.limit(1)\n\t\t.single();\n\n\treturn {\n\t\tfirstTimeFixRate: kpiData?.first_time_fix_rate || null,\n\t\tutilizationRate: kpiData?.utilization_rate || null,\n\t\tavgCustomerRating: kpiData?.average_rating || null,\n\t\tonTimeRate: kpiData?.on_time_rate || null,\n\t};\n});\n\n/**\n * Get customer health distribution\n */\nexport const getCustomerHealthDistribution = cache(\n\tasync (companyId: string) => {\n\t\tconst supabase = await createClient();\n\n\t\tconst { data: customers } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"churn_risk\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null);\n\n\t\tconst distribution = {\n\t\t\tlow: 0,\n\t\t\tmedium: 0,\n\t\t\thigh: 0,\n\t\t\tchurned: 0,\n\t\t\tunknown: 0,\n\t\t};\n\n\t\tfor (const customer of customers || []) {\n\t\t\tconst risk = customer.churn_risk as keyof typeof distribution;\n\t\t\tif (risk && distribution[risk] !== undefined) {\n\t\t\t\tdistribution[risk]++;\n\t\t\t} else {\n\t\t\t\tdistribution.unknown++;\n\t\t\t}\n\t\t}\n\n\t\treturn distribution;\n\t},\n);\n\n/**\n * Get estimate conversion funnel\n */\nexport const getEstimateConversionFunnel = cache(\n\tasync (companyId: string, days: number = 30) => {\n\t\tconst supabase = await createClient();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\tconst { data: estimates } = await supabase\n\t\t\t.from(\"estimates\")\n\t\t\t.select(\"conversion_status\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t.is(\"deleted_at\", null);\n\n\t\tconst funnel = {\n\t\t\ttotal: estimates?.length || 0,\n\t\t\tpending: 0,\n\t\t\twon: 0,\n\t\t\tlost: 0,\n\t\t\texpired: 0,\n\t\t};\n\n\t\tfor (const estimate of estimates || []) {\n\t\t\tconst status = estimate.conversion_status as keyof Omit<\n\t\t\t\ttypeof funnel,\n\t\t\t\t\"total\"\n\t\t\t>;\n\t\t\tif (status && funnel[status] !== undefined) {\n\t\t\t\tfunnel[status]++;\n\t\t\t} else {\n\t\t\t\tfunnel.pending++;\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\t...funnel,\n\t\t\tconversionRate: funnel.total > 0 ? (funnel.won / funnel.total) * 100 : 0,\n\t\t};\n\t},\n);\n\n/**\n * Get invoice aging summary\n */\nexport const getInvoiceAgingSummary = cache(async (companyId: string) => {\n\tconst supabase = await createClient();\n\n\tconst { data: invoices } = await supabase\n\t\t.from(\"invoices\")\n\t\t.select(\"aging_bucket, balance_amount\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.not(\"status\", \"in\", '(\"paid\", \"void\", \"cancelled\")')\n\t\t.is(\"deleted_at\", null);\n\n\tconst aging = {\n\t\tcurrent: { count: 0, amount: 0 },\n\t\t\"1_30\": { count: 0, amount: 0 },\n\t\t\"31_60\": { count: 0, amount: 0 },\n\t\t\"61_90\": { count: 0, amount: 0 },\n\t\tover_90: { count: 0, amount: 0 },\n\t};\n\n\tfor (const invoice of invoices || []) {\n\t\tconst bucket = (invoice.aging_bucket || \"current\") as keyof typeof aging;\n\t\tif (aging[bucket]) {\n\t\t\taging[bucket].count++;\n\t\t\taging[bucket].amount += (invoice.balance_amount || 0) / 100;\n\t\t}\n\t}\n\n\treturn aging;\n});\n\n// ============================================\n// REPORT QUERIES\n// ============================================\n\nexport interface RevenueReportData {\n\tsummary: {\n\t\ttotalRevenue: number;\n\t\tpreviousPeriodRevenue: number;\n\t\tgrowthPercent: number;\n\t\taverageTicket: number;\n\t\ttotalJobs: number;\n\t\ttotalPayments: number;\n\t};\n\tbyMonth: Array<{\n\t\tmonth: string;\n\t\trevenue: number;\n\t\tjobCount: number;\n\t\tavgTicket: number;\n\t}>;\n\tbyJobType: Array<{\n\t\tjobType: string;\n\t\trevenue: number;\n\t\tpercentage: number;\n\t\tcount: number;\n\t}>;\n\tbyPaymentMethod: Array<{\n\t\tmethod: string;\n\t\tamount: number;\n\t\tcount: number;\n\t\tpercentage: number;\n\t}>;\n\ttopCustomers: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\trevenue: number;\n\t\tjobCount: number;\n\t}>;\n}\n\n/**\n * Get comprehensive revenue report data\n */\nexport const getRevenueReport = cache(\n\tasync (companyId: string, days: number = 90): Promise<RevenueReportData> => {\n\t\tconst supabase = await createClient();\n\t\tconst endDate = new Date();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\tconst previousStartDate = new Date(startDate);\n\t\tpreviousStartDate.setDate(previousStartDate.getDate() - days);\n\n\t\t// Get payments for current and previous period\n\t\tconst [currentPayments, previousPayments, jobsData, customerRevenue] =\n\t\t\tawait Promise.all([\n\t\t\t\tsupabase\n\t\t\t\t\t.from(\"payments\")\n\t\t\t\t\t.select(\"id, amount, payment_method, created_at, customer_id\")\n\t\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t\t.eq(\"status\", \"completed\")\n\t\t\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t\t\t.lte(\"created_at\", endDate.toISOString()),\n\t\t\t\tsupabase\n\t\t\t\t\t.from(\"payments\")\n\t\t\t\t\t.select(\"amount\")\n\t\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t\t.eq(\"status\", \"completed\")\n\t\t\t\t\t.gte(\"created_at\", previousStartDate.toISOString())\n\t\t\t\t\t.lt(\"created_at\", startDate.toISOString()),\n\t\t\t\tsupabase\n\t\t\t\t\t.from(\"jobs\")\n\t\t\t\t\t.select(\"id, job_type, total_revenue, customer_id, created_at\")\n\t\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t\t.eq(\"status\", \"completed\")\n\t\t\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t\t\t.is(\"deleted_at\", null),\n\t\t\t\tsupabase\n\t\t\t\t\t.from(\"jobs\")\n\t\t\t\t\t.select(`\n\t\t\t\tcustomer_id,\n\t\t\t\ttotal_revenue,\n\t\t\t\tcustomers:customers!customer_id(id, display_name, first_name, last_name)\n\t\t\t`)\n\t\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t\t.eq(\"status\", \"completed\")\n\t\t\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t\t\t.is(\"deleted_at\", null),\n\t\t\t]);\n\n\t\tconst payments = currentPayments.data || [];\n\t\tconst prevPayments = previousPayments.data || [];\n\t\tconst jobs = jobsData.data || [];\n\t\tconst customerJobs = customerRevenue.data || [];\n\n\t\t// Calculate totals\n\t\tconst totalRevenue =\n\t\t\tpayments.reduce((sum, p) => sum + (p.amount || 0), 0) / 100;\n\t\tconst previousPeriodRevenue =\n\t\t\tprevPayments.reduce((sum, p) => sum + (p.amount || 0), 0) / 100;\n\t\tconst growthPercent =\n\t\t\tpreviousPeriodRevenue > 0\n\t\t\t\t? ((totalRevenue - previousPeriodRevenue) / previousPeriodRevenue) * 100\n\t\t\t\t: 0;\n\n\t\t// By month\n\t\tconst byMonth: Record<string, { revenue: number; jobCount: number }> = {};\n\t\tfor (const payment of payments) {\n\t\t\tconst month = new Date(payment.created_at).toISOString().substring(0, 7);\n\t\t\tif (!byMonth[month]) byMonth[month] = { revenue: 0, jobCount: 0 };\n\t\t\tbyMonth[month].revenue += (payment.amount || 0) / 100;\n\t\t}\n\t\tfor (const job of jobs) {\n\t\t\tconst month = new Date(job.created_at).toISOString().substring(0, 7);\n\t\t\tif (byMonth[month]) byMonth[month].jobCount++;\n\t\t}\n\n\t\t// By job type\n\t\tconst byJobType: Record<string, { revenue: number; count: number }> = {};\n\t\tfor (const job of jobs) {\n\t\t\tconst type = job.job_type || \"Other\";\n\t\t\tif (!byJobType[type]) byJobType[type] = { revenue: 0, count: 0 };\n\t\t\tbyJobType[type].revenue += (job.total_revenue || 0) / 100;\n\t\t\tbyJobType[type].count++;\n\t\t}\n\n\t\t// By payment method\n\t\tconst byPaymentMethod: Record<string, { amount: number; count: number }> =\n\t\t\t{};\n\t\tfor (const payment of payments) {\n\t\t\tconst method = payment.payment_method || \"Other\";\n\t\t\tif (!byPaymentMethod[method])\n\t\t\t\tbyPaymentMethod[method] = { amount: 0, count: 0 };\n\t\t\tbyPaymentMethod[method].amount += (payment.amount || 0) / 100;\n\t\t\tbyPaymentMethod[method].count++;\n\t\t}\n\n\t\t// Top customers\n\t\tconst customerTotals: Record<\n\t\t\tstring,\n\t\t\t{ name: string; revenue: number; jobCount: number }\n\t\t> = {};\n\t\tfor (const job of customerJobs) {\n\t\t\tconst customerId = job.customer_id;\n\t\t\tif (!customerId) continue;\n\t\t\tconst customer = job.customers as {\n\t\t\t\tid: string;\n\t\t\t\tdisplay_name: string | null;\n\t\t\t\tfirst_name: string | null;\n\t\t\t\tlast_name: string | null;\n\t\t\t} | null;\n\t\t\tconst name =\n\t\t\t\tcustomer?.display_name ||\n\t\t\t\t[customer?.first_name, customer?.last_name].filter(Boolean).join(\" \") ||\n\t\t\t\t\"Unknown\";\n\t\t\tif (!customerTotals[customerId])\n\t\t\t\tcustomerTotals[customerId] = { name, revenue: 0, jobCount: 0 };\n\t\t\tcustomerTotals[customerId].revenue += (job.total_revenue || 0) / 100;\n\t\t\tcustomerTotals[customerId].jobCount++;\n\t\t}\n\n\t\treturn {\n\t\t\tsummary: {\n\t\t\t\ttotalRevenue,\n\t\t\t\tpreviousPeriodRevenue,\n\t\t\t\tgrowthPercent,\n\t\t\t\taverageTicket: jobs.length > 0 ? totalRevenue / jobs.length : 0,\n\t\t\t\ttotalJobs: jobs.length,\n\t\t\t\ttotalPayments: payments.length,\n\t\t\t},\n\t\t\tbyMonth: Object.entries(byMonth)\n\t\t\t\t.map(([month, data]) => ({\n\t\t\t\t\tmonth,\n\t\t\t\t\trevenue: data.revenue,\n\t\t\t\t\tjobCount: data.jobCount,\n\t\t\t\t\tavgTicket: data.jobCount > 0 ? data.revenue / data.jobCount : 0,\n\t\t\t\t}))\n\t\t\t\t.sort((a, b) => a.month.localeCompare(b.month)),\n\t\t\tbyJobType: Object.entries(byJobType)\n\t\t\t\t.map(([jobType, data]) => ({\n\t\t\t\t\tjobType,\n\t\t\t\t\trevenue: data.revenue,\n\t\t\t\t\tcount: data.count,\n\t\t\t\t\tpercentage:\n\t\t\t\t\t\ttotalRevenue > 0 ? (data.revenue / totalRevenue) * 100 : 0,\n\t\t\t\t}))\n\t\t\t\t.sort((a, b) => b.revenue - a.revenue),\n\t\t\tbyPaymentMethod: Object.entries(byPaymentMethod)\n\t\t\t\t.map(([method, data]) => ({\n\t\t\t\t\tmethod,\n\t\t\t\t\tamount: data.amount,\n\t\t\t\t\tcount: data.count,\n\t\t\t\t\tpercentage: totalRevenue > 0 ? (data.amount / totalRevenue) * 100 : 0,\n\t\t\t\t}))\n\t\t\t\t.sort((a, b) => b.amount - a.amount),\n\t\t\ttopCustomers: Object.entries(customerTotals)\n\t\t\t\t.map(([id, data]) => ({ id, ...data }))\n\t\t\t\t.sort((a, b) => b.revenue - a.revenue)\n\t\t\t\t.slice(0, 10),\n\t\t};\n\t},\n);\n\nexport interface JobPerformanceReportData {\n\tsummary: {\n\t\ttotalJobs: number;\n\t\tcompletedJobs: number;\n\t\tcompletionRate: number;\n\t\taverageDuration: number;\n\t\tfirstTimeFixRate: number;\n\t\tcallbackRate: number;\n\t};\n\tbyStatus: Array<{\n\t\tstatus: string;\n\t\tcount: number;\n\t\tpercentage: number;\n\t}>;\n\tbyTechnician: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tjobsCompleted: number;\n\t\tavgDuration: number;\n\t\tavgRevenue: number;\n\t\tfirstTimeFixRate: number;\n\t}>;\n\tbyJobType: Array<{\n\t\tjobType: string;\n\t\tcount: number;\n\t\tavgDuration: number;\n\t\tavgRevenue: number;\n\t\tcompletionRate: number;\n\t}>;\n\ttrendsWeekly: Array<{\n\t\tweek: string;\n\t\tcompleted: number;\n\t\tscheduled: number;\n\t\tcancelled: number;\n\t}>;\n}\n\n/**\n * Get job performance report data\n */\nexport const getJobPerformanceReport = cache(\n\tasync (\n\t\tcompanyId: string,\n\t\tdays: number = 90,\n\t): Promise<JobPerformanceReportData> => {\n\t\tconst supabase = await createClient();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\tconst { data: jobs } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(`\n\t\t\tid, status, job_type, actual_duration_minutes, total_revenue, is_callback,\n\t\t\tassigned_to, created_at,\n\t\t\tassigned_user:users!assigned_to(id, first_name, last_name)\n\t\t`)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t.is(\"deleted_at\", null);\n\n\t\tconst allJobs = jobs || [];\n\t\tconst completedJobs = allJobs.filter((j) => j.status === \"completed\");\n\t\tconst callbacks = completedJobs.filter((j) => j.is_callback === true);\n\n\t\t// By status\n\t\tconst statusCounts: Record<string, number> = {};\n\t\tfor (const job of allJobs) {\n\t\t\tconst status = job.status || \"unknown\";\n\t\t\tstatusCounts[status] = (statusCounts[status] || 0) + 1;\n\t\t}\n\n\t\t// By technician\n\t\tconst techStats: Record<\n\t\t\tstring,\n\t\t\t{\n\t\t\t\tname: string;\n\t\t\t\tcompleted: number;\n\t\t\t\ttotalDuration: number;\n\t\t\t\ttotalRevenue: number;\n\t\t\t\tfirstTimeFixes: number;\n\t\t\t}\n\t\t> = {};\n\t\tfor (const job of completedJobs) {\n\t\t\tconst techId = job.assigned_to;\n\t\t\tif (!techId) continue;\n\t\t\tconst user = job.assigned_user as {\n\t\t\t\tid: string;\n\t\t\t\tfirst_name: string | null;\n\t\t\t\tlast_name: string | null;\n\t\t\t} | null;\n\t\t\tconst name =\n\t\t\t\t[user?.first_name, user?.last_name].filter(Boolean).join(\" \") ||\n\t\t\t\t\"Unassigned\";\n\t\t\tif (!techStats[techId])\n\t\t\t\ttechStats[techId] = {\n\t\t\t\t\tname,\n\t\t\t\t\tcompleted: 0,\n\t\t\t\t\ttotalDuration: 0,\n\t\t\t\t\ttotalRevenue: 0,\n\t\t\t\t\tfirstTimeFixes: 0,\n\t\t\t\t};\n\t\t\ttechStats[techId].completed++;\n\t\t\ttechStats[techId].totalDuration += job.actual_duration_minutes || 0;\n\t\t\ttechStats[techId].totalRevenue += (job.total_revenue || 0) / 100;\n\t\t\tif (!job.is_callback) techStats[techId].firstTimeFixes++;\n\t\t}\n\n\t\t// By job type\n\t\tconst typeStats: Record<\n\t\t\tstring,\n\t\t\t{\n\t\t\t\ttotal: number;\n\t\t\t\tcompleted: number;\n\t\t\t\ttotalDuration: number;\n\t\t\t\ttotalRevenue: number;\n\t\t\t}\n\t\t> = {};\n\t\tfor (const job of allJobs) {\n\t\t\tconst type = job.job_type || \"Other\";\n\t\t\tif (!typeStats[type])\n\t\t\t\ttypeStats[type] = {\n\t\t\t\t\ttotal: 0,\n\t\t\t\t\tcompleted: 0,\n\t\t\t\t\ttotalDuration: 0,\n\t\t\t\t\ttotalRevenue: 0,\n\t\t\t\t};\n\t\t\ttypeStats[type].total++;\n\t\t\tif (job.status === \"completed\") {\n\t\t\t\ttypeStats[type].completed++;\n\t\t\t\ttypeStats[type].totalDuration += job.actual_duration_minutes || 0;\n\t\t\t\ttypeStats[type].totalRevenue += (job.total_revenue || 0) / 100;\n\t\t\t}\n\t\t}\n\n\t\t// Weekly trends\n\t\tconst weeklyData: Record<\n\t\t\tstring,\n\t\t\t{ completed: number; scheduled: number; cancelled: number }\n\t\t> = {};\n\t\tfor (const job of allJobs) {\n\t\t\tconst date = new Date(job.created_at);\n\t\t\tconst week = getWeekStart(date);\n\t\t\tif (!weeklyData[week])\n\t\t\t\tweeklyData[week] = { completed: 0, scheduled: 0, cancelled: 0 };\n\t\t\tif (job.status === \"completed\") weeklyData[week].completed++;\n\t\t\telse if (job.status === \"scheduled\") weeklyData[week].scheduled++;\n\t\t\telse if (job.status === \"cancelled\") weeklyData[week].cancelled++;\n\t\t}\n\n\t\tconst avgDuration =\n\t\t\tcompletedJobs.length > 0\n\t\t\t\t? completedJobs.reduce(\n\t\t\t\t\t\t(sum, j) => sum + (j.actual_duration_minutes || 0),\n\t\t\t\t\t\t0,\n\t\t\t\t\t) / completedJobs.length\n\t\t\t\t: 0;\n\n\t\treturn {\n\t\t\tsummary: {\n\t\t\t\ttotalJobs: allJobs.length,\n\t\t\t\tcompletedJobs: completedJobs.length,\n\t\t\t\tcompletionRate:\n\t\t\t\t\tallJobs.length > 0\n\t\t\t\t\t\t? (completedJobs.length / allJobs.length) * 100\n\t\t\t\t\t\t: 0,\n\t\t\t\taverageDuration: avgDuration,\n\t\t\t\tfirstTimeFixRate:\n\t\t\t\t\tcompletedJobs.length > 0\n\t\t\t\t\t\t? ((completedJobs.length - callbacks.length) /\n\t\t\t\t\t\t\t\tcompletedJobs.length) *\n\t\t\t\t\t\t\t100\n\t\t\t\t\t\t: 0,\n\t\t\t\tcallbackRate:\n\t\t\t\t\tcompletedJobs.length > 0\n\t\t\t\t\t\t? (callbacks.length / completedJobs.length) * 100\n\t\t\t\t\t\t: 0,\n\t\t\t},\n\t\t\tbyStatus: Object.entries(statusCounts)\n\t\t\t\t.map(([status, count]) => ({\n\t\t\t\t\tstatus,\n\t\t\t\t\tcount,\n\t\t\t\t\tpercentage: allJobs.length > 0 ? (count / allJobs.length) * 100 : 0,\n\t\t\t\t}))\n\t\t\t\t.sort((a, b) => b.count - a.count),\n\t\t\tbyTechnician: Object.entries(techStats)\n\t\t\t\t.map(([id, data]) => ({\n\t\t\t\t\tid,\n\t\t\t\t\tname: data.name,\n\t\t\t\t\tjobsCompleted: data.completed,\n\t\t\t\t\tavgDuration:\n\t\t\t\t\t\tdata.completed > 0 ? data.totalDuration / data.completed : 0,\n\t\t\t\t\tavgRevenue:\n\t\t\t\t\t\tdata.completed > 0 ? data.totalRevenue / data.completed : 0,\n\t\t\t\t\tfirstTimeFixRate:\n\t\t\t\t\t\tdata.completed > 0\n\t\t\t\t\t\t\t? (data.firstTimeFixes / data.completed) * 100\n\t\t\t\t\t\t\t: 0,\n\t\t\t\t}))\n\t\t\t\t.sort((a, b) => b.jobsCompleted - a.jobsCompleted),\n\t\t\tbyJobType: Object.entries(typeStats)\n\t\t\t\t.map(([jobType, data]) => ({\n\t\t\t\t\tjobType,\n\t\t\t\t\tcount: data.total,\n\t\t\t\t\tavgDuration:\n\t\t\t\t\t\tdata.completed > 0 ? data.totalDuration / data.completed : 0,\n\t\t\t\t\tavgRevenue:\n\t\t\t\t\t\tdata.completed > 0 ? data.totalRevenue / data.completed : 0,\n\t\t\t\t\tcompletionRate:\n\t\t\t\t\t\tdata.total > 0 ? (data.completed / data.total) * 100 : 0,\n\t\t\t\t}))\n\t\t\t\t.sort((a, b) => b.count - a.count),\n\t\t\ttrendsWeekly: Object.entries(weeklyData)\n\t\t\t\t.map(([week, data]) => ({ week, ...data }))\n\t\t\t\t.sort((a, b) => a.week.localeCompare(b.week)),\n\t\t};\n\t},\n);\n\nfunction getWeekStart(date: Date): string {\n\tconst d = new Date(date);\n\tconst day = d.getDay();\n\tconst diff = d.getDate() - day;\n\td.setDate(diff);\n\treturn d.toISOString().split(\"T\")[0];\n}\n\nexport interface FinancialReportData {\n\tsummary: {\n\t\ttotalRevenue: number;\n\t\ttotalCost: number;\n\t\tgrossProfit: number;\n\t\tgrossMargin: number;\n\t\toutstandingAR: number;\n\t\toverdueAR: number;\n\t};\n\tarAging: {\n\t\tcurrent: { count: number; amount: number };\n\t\tdays1_30: { count: number; amount: number };\n\t\tdays31_60: { count: number; amount: number };\n\t\tdays61_90: { count: number; amount: number };\n\t\tover90: { count: number; amount: number };\n\t};\n\tmonthlyPL: Array<{\n\t\tmonth: string;\n\t\trevenue: number;\n\t\tcost: number;\n\t\tprofit: number;\n\t\tmargin: number;\n\t}>;\n\tcashFlow: Array<{\n\t\tmonth: string;\n\t\tinflows: number;\n\t\toutflows: number;\n\t\tnet: number;\n\t}>;\n}\n\n/**\n * Get financial report data\n */\nexport const getFinancialReport = cache(\n\tasync (\n\t\tcompanyId: string,\n\t\tdays: number = 365,\n\t): Promise<FinancialReportData> => {\n\t\tconst supabase = await createClient();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\t\tconst today = new Date();\n\n\t\tconst [paymentsResult, invoicesResult, jobsResult] = await Promise.all([\n\t\t\tsupabase\n\t\t\t\t.from(\"payments\")\n\t\t\t\t.select(\"amount, created_at\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"status\", \"completed\")\n\t\t\t\t.gte(\"created_at\", startDate.toISOString()),\n\t\t\tsupabase\n\t\t\t\t.from(\"invoices\")\n\t\t\t\t.select(\"id, balance_amount, due_date, status\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.not(\"status\", \"in\", '(\"paid\", \"void\", \"cancelled\")')\n\t\t\t\t.is(\"deleted_at\", null),\n\t\t\tsupabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\"total_revenue, total_cost_actual, created_at\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"status\", \"completed\")\n\t\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t\t.is(\"deleted_at\", null),\n\t\t]);\n\n\t\tconst payments = paymentsResult.data || [];\n\t\tconst invoices = invoicesResult.data || [];\n\t\tconst jobs = jobsResult.data || [];\n\n\t\t// Calculate totals\n\t\tconst totalRevenue = jobs.reduce(\n\t\t\t(sum, j) => sum + (j.total_revenue || 0) / 100,\n\t\t\t0,\n\t\t);\n\t\tconst totalCost = jobs.reduce(\n\t\t\t(sum, j) => sum + (j.total_cost_actual || 0) / 100,\n\t\t\t0,\n\t\t);\n\t\tconst grossProfit = totalRevenue - totalCost;\n\t\tconst grossMargin =\n\t\t\ttotalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;\n\n\t\t// AR Aging\n\t\tconst arAging = {\n\t\t\tcurrent: { count: 0, amount: 0 },\n\t\t\tdays1_30: { count: 0, amount: 0 },\n\t\t\tdays31_60: { count: 0, amount: 0 },\n\t\t\tdays61_90: { count: 0, amount: 0 },\n\t\t\tover90: { count: 0, amount: 0 },\n\t\t};\n\n\t\tlet outstandingAR = 0;\n\t\tlet overdueAR = 0;\n\n\t\tfor (const invoice of invoices) {\n\t\t\tconst balance = (invoice.balance_amount || 0) / 100;\n\t\t\toutstandingAR += balance;\n\n\t\t\tif (!invoice.due_date) {\n\t\t\t\tarAging.current.count++;\n\t\t\t\tarAging.current.amount += balance;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst dueDate = new Date(invoice.due_date);\n\t\t\tconst daysPastDue = Math.floor(\n\t\t\t\t(today.getTime() - dueDate.getTime()) / (1000 * 60 * 60 * 24),\n\t\t\t);\n\n\t\t\tif (daysPastDue <= 0) {\n\t\t\t\tarAging.current.count++;\n\t\t\t\tarAging.current.amount += balance;\n\t\t\t} else if (daysPastDue <= 30) {\n\t\t\t\tarAging.days1_30.count++;\n\t\t\t\tarAging.days1_30.amount += balance;\n\t\t\t\toverdueAR += balance;\n\t\t\t} else if (daysPastDue <= 60) {\n\t\t\t\tarAging.days31_60.count++;\n\t\t\t\tarAging.days31_60.amount += balance;\n\t\t\t\toverdueAR += balance;\n\t\t\t} else if (daysPastDue <= 90) {\n\t\t\t\tarAging.days61_90.count++;\n\t\t\t\tarAging.days61_90.amount += balance;\n\t\t\t\toverdueAR += balance;\n\t\t\t} else {\n\t\t\t\tarAging.over90.count++;\n\t\t\t\tarAging.over90.amount += balance;\n\t\t\t\toverdueAR += balance;\n\t\t\t}\n\t\t}\n\n\t\t// Monthly P&L\n\t\tconst monthlyPL: Record<string, { revenue: number; cost: number }> = {};\n\t\tfor (const job of jobs) {\n\t\t\tconst month = new Date(job.created_at).toISOString().substring(0, 7);\n\t\t\tif (!monthlyPL[month]) monthlyPL[month] = { revenue: 0, cost: 0 };\n\t\t\tmonthlyPL[month].revenue += (job.total_revenue || 0) / 100;\n\t\t\tmonthlyPL[month].cost += (job.total_cost_actual || 0) / 100;\n\t\t}\n\n\t\t// Monthly cash flow\n\t\tconst monthlyCash: Record<string, { inflows: number; outflows: number }> =\n\t\t\t{};\n\t\tfor (const payment of payments) {\n\t\t\tconst month = new Date(payment.created_at).toISOString().substring(0, 7);\n\t\t\tif (!monthlyCash[month]) monthlyCash[month] = { inflows: 0, outflows: 0 };\n\t\t\tmonthlyCash[month].inflows += (payment.amount || 0) / 100;\n\t\t}\n\n\t\treturn {\n\t\t\tsummary: {\n\t\t\t\ttotalRevenue,\n\t\t\t\ttotalCost,\n\t\t\t\tgrossProfit,\n\t\t\t\tgrossMargin,\n\t\t\t\toutstandingAR,\n\t\t\t\toverdueAR,\n\t\t\t},\n\t\t\tarAging,\n\t\t\tmonthlyPL: Object.entries(monthlyPL)\n\t\t\t\t.map(([month, data]) => ({\n\t\t\t\t\tmonth,\n\t\t\t\t\trevenue: data.revenue,\n\t\t\t\t\tcost: data.cost,\n\t\t\t\t\tprofit: data.revenue - data.cost,\n\t\t\t\t\tmargin:\n\t\t\t\t\t\tdata.revenue > 0\n\t\t\t\t\t\t\t? ((data.revenue - data.cost) / data.revenue) * 100\n\t\t\t\t\t\t\t: 0,\n\t\t\t\t}))\n\t\t\t\t.sort((a, b) => a.month.localeCompare(b.month)),\n\t\t\tcashFlow: Object.entries(monthlyCash)\n\t\t\t\t.map(([month, data]) => ({\n\t\t\t\t\tmonth,\n\t\t\t\t\tinflows: data.inflows,\n\t\t\t\t\toutflows: data.outflows,\n\t\t\t\t\tnet: data.inflows - data.outflows,\n\t\t\t\t}))\n\t\t\t\t.sort((a, b) => a.month.localeCompare(b.month)),\n\t\t};\n\t},\n);\n\nexport interface TeamLeaderboardData {\n\ttechnicians: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\trank: number;\n\t\tjobsCompleted: number;\n\t\trevenue: number;\n\t\tavgRating: number;\n\t\tfirstTimeFixRate: number;\n\t\tavgJobDuration: number;\n\t\tutilizationRate: number;\n\t\tscore: number;\n\t}>;\n\ttopPerformer: {\n\t\tid: string;\n\t\tname: string;\n\t\thighlight: string;\n\t} | null;\n\tteamAverages: {\n\t\tjobsPerTech: number;\n\t\trevenuePerTech: number;\n\t\tavgRating: number;\n\t\tfirstTimeFixRate: number;\n\t};\n}\n\n/**\n * Get team leaderboard data\n */\nexport const getTeamLeaderboard = cache(\n\tasync (\n\t\tcompanyId: string,\n\t\tdays: number = 30,\n\t): Promise<TeamLeaderboardData> => {\n\t\tconst supabase = await createClient();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\tconst { data: jobs } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(`\n\t\t\tid, status, total_revenue, actual_duration_minutes, is_callback, assigned_to,\n\t\t\tassigned_user:users!assigned_to(id, first_name, last_name)\n\t\t`)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"completed\")\n\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t.is(\"deleted_at\", null);\n\n\t\tconst allJobs = jobs || [];\n\n\t\t// Aggregate by technician\n\t\tconst techStats: Record<\n\t\t\tstring,\n\t\t\t{\n\t\t\t\tname: string;\n\t\t\t\tcompleted: number;\n\t\t\t\trevenue: number;\n\t\t\t\ttotalDuration: number;\n\t\t\t\tfirstTimeFixes: number;\n\t\t\t}\n\t\t> = {};\n\n\t\tfor (const job of allJobs) {\n\t\t\tconst techId = job.assigned_to;\n\t\t\tif (!techId) continue;\n\t\t\tconst user = job.assigned_user as {\n\t\t\t\tid: string;\n\t\t\t\tfirst_name: string | null;\n\t\t\t\tlast_name: string | null;\n\t\t\t} | null;\n\t\t\tconst name =\n\t\t\t\t[user?.first_name, user?.last_name].filter(Boolean).join(\" \") ||\n\t\t\t\t\"Unknown\";\n\n\t\t\tif (!techStats[techId]) {\n\t\t\t\ttechStats[techId] = {\n\t\t\t\t\tname,\n\t\t\t\t\tcompleted: 0,\n\t\t\t\t\trevenue: 0,\n\t\t\t\t\ttotalDuration: 0,\n\t\t\t\t\tfirstTimeFixes: 0,\n\t\t\t\t};\n\t\t\t}\n\t\t\ttechStats[techId].completed++;\n\t\t\ttechStats[techId].revenue += (job.total_revenue || 0) / 100;\n\t\t\ttechStats[techId].totalDuration += job.actual_duration_minutes || 0;\n\t\t\tif (!job.is_callback) techStats[techId].firstTimeFixes++;\n\t\t}\n\n\t\t// Calculate scores and rankings\n\t\tconst technicians = Object.entries(techStats)\n\t\t\t.map(([id, data]) => {\n\t\t\t\tconst firstTimeFixRate =\n\t\t\t\t\tdata.completed > 0 ? (data.firstTimeFixes / data.completed) * 100 : 0;\n\t\t\t\tconst avgDuration =\n\t\t\t\t\tdata.completed > 0 ? data.totalDuration / data.completed : 0;\n\t\t\t\t// Score: weighted combination of metrics\n\t\t\t\tconst score =\n\t\t\t\t\tdata.completed * 10 + data.revenue / 100 + firstTimeFixRate * 2;\n\t\t\t\treturn {\n\t\t\t\t\tid,\n\t\t\t\t\tname: data.name,\n\t\t\t\t\trank: 0,\n\t\t\t\t\tjobsCompleted: data.completed,\n\t\t\t\t\trevenue: data.revenue,\n\t\t\t\t\tavgRating: 4.5, // Placeholder - would come from reviews\n\t\t\t\t\tfirstTimeFixRate,\n\t\t\t\t\tavgJobDuration: avgDuration,\n\t\t\t\t\tutilizationRate: 75, // Placeholder - would come from scheduling\n\t\t\t\t\tscore,\n\t\t\t\t};\n\t\t\t})\n\t\t\t.sort((a, b) => b.score - a.score)\n\t\t\t.map((tech, index) => ({ ...tech, rank: index + 1 }));\n\n\t\tconst totalTechs = technicians.length;\n\t\tconst teamAverages = {\n\t\t\tjobsPerTech:\n\t\t\t\ttotalTechs > 0\n\t\t\t\t\t? technicians.reduce((sum, t) => sum + t.jobsCompleted, 0) /\n\t\t\t\t\t\ttotalTechs\n\t\t\t\t\t: 0,\n\t\t\trevenuePerTech:\n\t\t\t\ttotalTechs > 0\n\t\t\t\t\t? technicians.reduce((sum, t) => sum + t.revenue, 0) / totalTechs\n\t\t\t\t\t: 0,\n\t\t\tavgRating:\n\t\t\t\ttotalTechs > 0\n\t\t\t\t\t? technicians.reduce((sum, t) => sum + t.avgRating, 0) / totalTechs\n\t\t\t\t\t: 0,\n\t\t\tfirstTimeFixRate:\n\t\t\t\ttotalTechs > 0\n\t\t\t\t\t? technicians.reduce((sum, t) => sum + t.firstTimeFixRate, 0) /\n\t\t\t\t\t\ttotalTechs\n\t\t\t\t\t: 0,\n\t\t};\n\n\t\treturn {\n\t\t\ttechnicians,\n\t\t\ttopPerformer:\n\t\t\t\ttechnicians.length > 0\n\t\t\t\t\t? {\n\t\t\t\t\t\t\tid: technicians[0].id,\n\t\t\t\t\t\t\tname: technicians[0].name,\n\t\t\t\t\t\t\thighlight: `${technicians[0].jobsCompleted} jobs completed, $${technicians[0].revenue.toLocaleString()} revenue`,\n\t\t\t\t\t\t}\n\t\t\t\t\t: null,\n\t\t\tteamAverages,\n\t\t};\n\t},\n);\n\nexport interface CustomerAnalyticsData {\n\tsummary: {\n\t\ttotalCustomers: number;\n\t\tnewCustomers: number;\n\t\trepeatCustomers: number;\n\t\tchurnedCustomers: number;\n\t\tretentionRate: number;\n\t\tavgLifetimeValue: number;\n\t};\n\tbySegment: Array<{\n\t\tsegment: string;\n\t\tcount: number;\n\t\trevenue: number;\n\t\tavgTicket: number;\n\t}>;\n\ttopCustomers: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\ttotalRevenue: number;\n\t\tjobCount: number;\n\t\tlastServiceDate: string | null;\n\t\tlifetimeValue: number;\n\t}>;\n\tacquisitionTrend: Array<{\n\t\tmonth: string;\n\t\tnewCustomers: number;\n\t\tchurned: number;\n\t\tnet: number;\n\t}>;\n\triskDistribution: {\n\t\tlow: number;\n\t\tmedium: number;\n\t\thigh: number;\n\t};\n}\n\n/**\n * Get customer analytics data\n */\nexport const getCustomerAnalytics = cache(\n\tasync (\n\t\tcompanyId: string,\n\t\tdays: number = 365,\n\t): Promise<CustomerAnalyticsData> => {\n\t\tconst supabase = await createClient();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\t\tconst thirtyDaysAgo = new Date();\n\t\tthirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\n\n\t\tconst [customersResult, jobsResult] = await Promise.all([\n\t\t\tsupabase\n\t\t\t\t.from(\"customers\")\n\t\t\t\t.select(\n\t\t\t\t\t\"id, display_name, first_name, last_name, created_at, customer_type, churn_risk, lifetime_value, total_jobs, last_service_date\",\n\t\t\t\t)\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.is(\"deleted_at\", null),\n\t\t\tsupabase\n\t\t\t\t.from(\"jobs\")\n\t\t\t\t.select(\"customer_id, total_revenue, created_at\")\n\t\t\t\t.eq(\"company_id\", companyId)\n\t\t\t\t.eq(\"status\", \"completed\")\n\t\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t\t.is(\"deleted_at\", null),\n\t\t]);\n\n\t\tconst customers = customersResult.data || [];\n\t\tconst jobs = jobsResult.data || [];\n\n\t\t// Count metrics\n\t\tconst newCustomers = customers.filter(\n\t\t\t(c) => c.created_at && new Date(c.created_at) >= thirtyDaysAgo,\n\t\t).length;\n\t\tconst repeatCustomers = customers.filter(\n\t\t\t(c) => (c.total_jobs || 0) > 1,\n\t\t).length;\n\t\tconst churnedCustomers = customers.filter(\n\t\t\t(c) => c.churn_risk === \"churned\",\n\t\t).length;\n\t\tconst totalCustomers = customers.length;\n\t\tconst retentionRate =\n\t\t\ttotalCustomers > 0\n\t\t\t\t? ((totalCustomers - churnedCustomers) / totalCustomers) * 100\n\t\t\t\t: 100;\n\t\tconst avgLifetimeValue =\n\t\t\ttotalCustomers > 0\n\t\t\t\t? customers.reduce((sum, c) => sum + (c.lifetime_value || 0) / 100, 0) /\n\t\t\t\t\ttotalCustomers\n\t\t\t\t: 0;\n\n\t\t// By segment\n\t\tconst segments: Record<\n\t\t\tstring,\n\t\t\t{ count: number; revenue: number; jobs: number }\n\t\t> = {};\n\t\tfor (const customer of customers) {\n\t\t\tconst segment = customer.customer_type || \"Residential\";\n\t\t\tif (!segments[segment])\n\t\t\t\tsegments[segment] = { count: 0, revenue: 0, jobs: 0 };\n\t\t\tsegments[segment].count++;\n\t\t}\n\n\t\t// Add revenue by segment from jobs\n\t\tconst customerIdToSegment: Record<string, string> = {};\n\t\tfor (const customer of customers) {\n\t\t\tcustomerIdToSegment[customer.id] =\n\t\t\t\tcustomer.customer_type || \"Residential\";\n\t\t}\n\t\tfor (const job of jobs) {\n\t\t\tconst segment = customerIdToSegment[job.customer_id] || \"Residential\";\n\t\t\tif (segments[segment]) {\n\t\t\t\tsegments[segment].revenue += (job.total_revenue || 0) / 100;\n\t\t\t\tsegments[segment].jobs++;\n\t\t\t}\n\t\t}\n\n\t\t// Top customers\n\t\tconst customerRevenue: Record<\n\t\t\tstring,\n\t\t\t{\n\t\t\t\tname: string;\n\t\t\t\trevenue: number;\n\t\t\t\tjobCount: number;\n\t\t\t\tlastService: string | null;\n\t\t\t\tltv: number;\n\t\t\t}\n\t\t> = {};\n\t\tfor (const customer of customers) {\n\t\t\tconst name =\n\t\t\t\tcustomer.display_name ||\n\t\t\t\t[customer.first_name, customer.last_name].filter(Boolean).join(\" \") ||\n\t\t\t\t\"Unknown\";\n\t\t\tcustomerRevenue[customer.id] = {\n\t\t\t\tname,\n\t\t\t\trevenue: 0,\n\t\t\t\tjobCount: customer.total_jobs || 0,\n\t\t\t\tlastService: customer.last_service_date,\n\t\t\t\tltv: (customer.lifetime_value || 0) / 100,\n\t\t\t};\n\t\t}\n\t\tfor (const job of jobs) {\n\t\t\tif (customerRevenue[job.customer_id]) {\n\t\t\t\tcustomerRevenue[job.customer_id].revenue +=\n\t\t\t\t\t(job.total_revenue || 0) / 100;\n\t\t\t}\n\t\t}\n\n\t\t// Acquisition trend by month\n\t\tconst monthlyAcquisition: Record<string, { new: number; churned: number }> =\n\t\t\t{};\n\t\tfor (const customer of customers) {\n\t\t\tif (customer.created_at) {\n\t\t\t\tconst month = new Date(customer.created_at)\n\t\t\t\t\t.toISOString()\n\t\t\t\t\t.substring(0, 7);\n\t\t\t\tif (!monthlyAcquisition[month])\n\t\t\t\t\tmonthlyAcquisition[month] = { new: 0, churned: 0 };\n\t\t\t\tmonthlyAcquisition[month].new++;\n\t\t\t}\n\t\t}\n\n\t\t// Risk distribution\n\t\tconst riskDistribution = { low: 0, medium: 0, high: 0 };\n\t\tfor (const customer of customers) {\n\t\t\tconst risk = customer.churn_risk as keyof typeof riskDistribution;\n\t\t\tif (risk && riskDistribution[risk] !== undefined) {\n\t\t\t\triskDistribution[risk]++;\n\t\t\t} else {\n\t\t\t\triskDistribution.low++; // Default to low risk if not set\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsummary: {\n\t\t\t\ttotalCustomers,\n\t\t\t\tnewCustomers,\n\t\t\t\trepeatCustomers,\n\t\t\t\tchurnedCustomers,\n\t\t\t\tretentionRate,\n\t\t\t\tavgLifetimeValue,\n\t\t\t},\n\t\t\tbySegment: Object.entries(segments)\n\t\t\t\t.map(([segment, data]) => ({\n\t\t\t\t\tsegment,\n\t\t\t\t\tcount: data.count,\n\t\t\t\t\trevenue: data.revenue,\n\t\t\t\t\tavgTicket: data.jobs > 0 ? data.revenue / data.jobs : 0,\n\t\t\t\t}))\n\t\t\t\t.sort((a, b) => b.revenue - a.revenue),\n\t\t\ttopCustomers: Object.entries(customerRevenue)\n\t\t\t\t.map(([id, data]) => ({\n\t\t\t\t\tid,\n\t\t\t\t\tname: data.name,\n\t\t\t\t\ttotalRevenue: data.revenue,\n\t\t\t\t\tjobCount: data.jobCount,\n\t\t\t\t\tlastServiceDate: data.lastService,\n\t\t\t\t\tlifetimeValue: data.ltv,\n\t\t\t\t}))\n\t\t\t\t.sort((a, b) => b.totalRevenue - a.totalRevenue)\n\t\t\t\t.slice(0, 10),\n\t\t\tacquisitionTrend: Object.entries(monthlyAcquisition)\n\t\t\t\t.map(([month, data]) => ({\n\t\t\t\t\tmonth,\n\t\t\t\t\tnewCustomers: data.new,\n\t\t\t\t\tchurned: data.churned,\n\t\t\t\t\tnet: data.new - data.churned,\n\t\t\t\t}))\n\t\t\t\t.sort((a, b) => a.month.localeCompare(b.month)),\n\t\t\triskDistribution,\n\t\t};\n\t},\n);\n\n// ============================================================================\n// COMMUNICATION ANALYTICS QUERIES\n// ============================================================================\n\nexport interface RecentCommunication {\n\tid: string;\n\ttype: \"email\" | \"sms\" | \"phone\";\n\tdirection: \"inbound\" | \"outbound\";\n\tsender: string;\n\tsubject: string;\n\ttime: string;\n\tstatus: string;\n}\n\nexport interface ActiveThread {\n\tid: string;\n\tcustomer: string;\n\tlastMessage: string;\n\ttime: string;\n\tunread: number;\n}\n\n/**\n * Get recent communications for the analytics dashboard\n */\nexport const getRecentCommunications = cache(\n\tasync (\n\t\tcompanyId: string,\n\t\tlimit: number = 5,\n\t): Promise<RecentCommunication[]> => {\n\t\tconst supabase = await createClient();\n\n\t\tconst { data: comms } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(`\n\t\t\tid,\n\t\t\ttype,\n\t\t\tdirection,\n\t\t\tsubject,\n\t\t\tbody,\n\t\t\tread_at,\n\t\t\tcreated_at,\n\t\t\tcustomer:customers(name)\n\t\t`)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(limit);\n\n\t\tif (!comms || comms.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\treturn comms.map((comm) => {\n\t\t\tconst created = new Date(comm.created_at);\n\t\t\tconst now = new Date();\n\t\t\tconst diffMs = now.getTime() - created.getTime();\n\t\t\tconst diffMins = Math.floor(diffMs / 60000);\n\t\t\tconst diffHours = Math.floor(diffMins / 60);\n\t\t\tconst diffDays = Math.floor(diffHours / 24);\n\n\t\t\tlet timeAgo: string;\n\t\t\tif (diffMins < 1) {\n\t\t\t\ttimeAgo = \"Just now\";\n\t\t\t} else if (diffMins < 60) {\n\t\t\t\ttimeAgo = `${diffMins}m ago`;\n\t\t\t} else if (diffHours < 24) {\n\t\t\t\ttimeAgo = `${diffHours}h ago`;\n\t\t\t} else {\n\t\t\t\ttimeAgo = `${diffDays}d ago`;\n\t\t\t}\n\n\t\t\t// Determine status based on direction and read state\n\t\t\tlet status: string;\n\t\t\tif (comm.direction === \"inbound\") {\n\t\t\t\tstatus = comm.read_at ? \"read\" : \"unread\";\n\t\t\t} else {\n\t\t\t\tstatus = \"sent\";\n\t\t\t}\n\n\t\t\t// Get customer name or extract from subject/body\n\t\t\tconst customerName =\n\t\t\t\t(comm.customer as { name: string } | null)?.name || \"Unknown\";\n\n\t\t\treturn {\n\t\t\t\tid: comm.id,\n\t\t\t\ttype: (comm.type as \"email\" | \"sms\" | \"phone\") || \"email\",\n\t\t\t\tdirection: (comm.direction as \"inbound\" | \"outbound\") || \"inbound\",\n\t\t\t\tsender: customerName,\n\t\t\t\tsubject:\n\t\t\t\t\tcomm.subject || comm.body?.substring(0, 50) + \"...\" || \"No subject\",\n\t\t\t\ttime: timeAgo,\n\t\t\t\tstatus,\n\t\t\t};\n\t\t});\n\t},\n);\n\n/**\n * Get active communication threads (grouped by customer)\n */\nexport const getActiveThreads = cache(\n\tasync (companyId: string, limit: number = 5): Promise<ActiveThread[]> => {\n\t\tconst supabase = await createClient();\n\n\t\t// Get the most recent communication per customer with unread count\n\t\tconst { data: threads } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(`\n\t\t\tid,\n\t\t\tcustomer_id,\n\t\t\tbody,\n\t\t\tsubject,\n\t\t\tcreated_at,\n\t\t\tread_at,\n\t\t\tdirection,\n\t\t\tcustomer:customers(id, name)\n\t\t`)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.not(\"customer_id\", \"is\", null)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(50); // Get more to group by customer\n\n\t\tif (!threads || threads.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\t// Group by customer and get latest + unread count\n\t\tconst customerThreads = new Map<\n\t\t\tstring,\n\t\t\t{\n\t\t\t\tcustomer: string;\n\t\t\t\tlastMessage: string;\n\t\t\t\tlastTime: Date;\n\t\t\t\tunread: number;\n\t\t\t\tid: string;\n\t\t\t}\n\t\t>();\n\n\t\tfor (const thread of threads) {\n\t\t\tconst customerId = thread.customer_id;\n\t\t\tif (!customerId) continue;\n\n\t\t\tconst customerName =\n\t\t\t\t(thread.customer as { id: string; name: string } | null)?.name ||\n\t\t\t\t\"Unknown\";\n\t\t\tconst existing = customerThreads.get(customerId);\n\n\t\t\tconst messagePreview =\n\t\t\t\tthread.subject || thread.body?.substring(0, 50) || \"No message\";\n\t\t\tconst createdAt = new Date(thread.created_at);\n\t\t\tconst isUnread = thread.direction === \"inbound\" && !thread.read_at;\n\n\t\t\tif (!existing) {\n\t\t\t\tcustomerThreads.set(customerId, {\n\t\t\t\t\tcustomer: customerName,\n\t\t\t\t\tlastMessage: messagePreview,\n\t\t\t\t\tlastTime: createdAt,\n\t\t\t\t\tunread: isUnread ? 1 : 0,\n\t\t\t\t\tid: thread.id,\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\t// Update unread count\n\t\t\t\tif (isUnread) {\n\t\t\t\t\texisting.unread++;\n\t\t\t\t}\n\t\t\t\t// Update last message if this is newer\n\t\t\t\tif (createdAt > existing.lastTime) {\n\t\t\t\t\texisting.lastMessage = messagePreview;\n\t\t\t\t\texisting.lastTime = createdAt;\n\t\t\t\t\texisting.id = thread.id;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Convert to array and format\n\t\tconst now = new Date();\n\t\treturn Array.from(customerThreads.values())\n\t\t\t.sort((a, b) => b.lastTime.getTime() - a.lastTime.getTime())\n\t\t\t.slice(0, limit)\n\t\t\t.map((thread) => {\n\t\t\t\tconst diffMs = now.getTime() - thread.lastTime.getTime();\n\t\t\t\tconst diffMins = Math.floor(diffMs / 60000);\n\t\t\t\tconst diffHours = Math.floor(diffMins / 60);\n\t\t\t\tconst diffDays = Math.floor(diffHours / 24);\n\n\t\t\t\tlet timeAgo: string;\n\t\t\t\tif (diffMins < 1) {\n\t\t\t\t\ttimeAgo = \"Just now\";\n\t\t\t\t} else if (diffMins < 60) {\n\t\t\t\t\ttimeAgo = `${diffMins}m ago`;\n\t\t\t\t} else if (diffHours < 24) {\n\t\t\t\t\ttimeAgo = `${diffHours}h ago`;\n\t\t\t\t} else {\n\t\t\t\t\ttimeAgo = `${diffDays}d ago`;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\tid: thread.id,\n\t\t\t\t\tcustomer: thread.customer,\n\t\t\t\t\tlastMessage:\n\t\t\t\t\t\tthread.lastMessage.length > 40\n\t\t\t\t\t\t\t? thread.lastMessage.substring(0, 40) + \"...\"\n\t\t\t\t\t\t\t: thread.lastMessage,\n\t\t\t\t\ttime: timeAgo,\n\t\t\t\t\tunread: thread.unread,\n\t\t\t\t};\n\t\t\t});\n\t},\n);\n\n// ============================================================================\n// JOB COSTING & PROFITABILITY ANALYTICS\n// ============================================================================\n\nexport interface JobCostingData {\n\tsummary: {\n\t\tavgJobProfit: number;\n\t\tavgGrossMargin: number;\n\t\ttotalLaborCost: number;\n\t\ttotalMaterialsCost: number;\n\t\ttotalEquipmentCost: number;\n\t\tjobsUnderBudget: number;\n\t\tjobsOnBudget: number;\n\t\tjobsOverBudget: number;\n\t\tavgCostVariance: number;\n\t};\n\tbyBudgetStatus: Array<{\n\t\tstatus: string;\n\t\tcount: number;\n\t\ttotalRevenue: number;\n\t\ttotalCost: number;\n\t\tavgMargin: number;\n\t}>;\n\ttopProfitableJobs: Array<{\n\t\tid: string;\n\t\ttitle: string;\n\t\tcustomer: string;\n\t\trevenue: number;\n\t\tcost: number;\n\t\tprofit: number;\n\t\tmargin: number;\n\t}>;\n\tcostBreakdown: {\n\t\tlabor: number;\n\t\tmaterials: number;\n\t\tequipment: number;\n\t\toverhead: number;\n\t\tdriveTime: number;\n\t};\n}\n\n/**\n * Get job costing and profitability analytics\n */\nexport const getJobCostingAnalytics = cache(\n\tasync (companyId: string, days: number = 90): Promise<JobCostingData> => {\n\t\tconst supabase = await createClient();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\tconst { data: jobs } = await supabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(`\n\t\t\tid, title, total_amount,\n\t\t\tlabor_cost_actual, materials_cost_actual, equipment_cost_actual,\n\t\t\ttotal_cost_actual, overhead_cost, drive_time_cost,\n\t\t\tprofit_actual, gross_margin_percent, budget_status,\n\t\t\tcustomer:customers(name, display_name)\n\t\t`)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"completed\")\n\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.not(\"total_cost_actual\", \"is\", null);\n\n\t\tconst allJobs = jobs || [];\n\n\t\t// Summary calculations\n\t\tconst totalLaborCost = allJobs.reduce(\n\t\t\t(sum, j) => sum + (j.labor_cost_actual || 0) / 100,\n\t\t\t0,\n\t\t);\n\t\tconst totalMaterialsCost = allJobs.reduce(\n\t\t\t(sum, j) => sum + (j.materials_cost_actual || 0) / 100,\n\t\t\t0,\n\t\t);\n\t\tconst totalEquipmentCost = allJobs.reduce(\n\t\t\t(sum, j) => sum + (j.equipment_cost_actual || 0) / 100,\n\t\t\t0,\n\t\t);\n\t\tconst totalOverhead = allJobs.reduce(\n\t\t\t(sum, j) => sum + (j.overhead_cost || 0) / 100,\n\t\t\t0,\n\t\t);\n\t\tconst totalDriveTime = allJobs.reduce(\n\t\t\t(sum, j) => sum + (j.drive_time_cost || 0) / 100,\n\t\t\t0,\n\t\t);\n\n\t\tconst avgJobProfit =\n\t\t\tallJobs.length > 0\n\t\t\t\t? allJobs.reduce((sum, j) => sum + (j.profit_actual || 0) / 100, 0) /\n\t\t\t\t\tallJobs.length\n\t\t\t\t: 0;\n\n\t\tconst avgGrossMargin =\n\t\t\tallJobs.length > 0\n\t\t\t\t? allJobs.reduce((sum, j) => sum + (j.gross_margin_percent || 0), 0) /\n\t\t\t\t\tallJobs.length\n\t\t\t\t: 0;\n\n\t\tconst jobsUnderBudget = allJobs.filter(\n\t\t\t(j) => j.budget_status === \"under_budget\",\n\t\t).length;\n\t\tconst jobsOnBudget = allJobs.filter(\n\t\t\t(j) => j.budget_status === \"on_budget\",\n\t\t).length;\n\t\tconst jobsOverBudget = allJobs.filter(\n\t\t\t(j) => j.budget_status === \"over_budget\",\n\t\t).length;\n\n\t\t// By budget status\n\t\tconst statusGroups: Record<\n\t\t\tstring,\n\t\t\t{ count: number; revenue: number; cost: number }\n\t\t> = {\n\t\t\tunder_budget: { count: 0, revenue: 0, cost: 0 },\n\t\t\ton_budget: { count: 0, revenue: 0, cost: 0 },\n\t\t\tover_budget: { count: 0, revenue: 0, cost: 0 },\n\t\t};\n\n\t\tfor (const job of allJobs) {\n\t\t\tconst status = job.budget_status || \"on_budget\";\n\t\t\tif (statusGroups[status]) {\n\t\t\t\tstatusGroups[status].count++;\n\t\t\t\tstatusGroups[status].revenue += (job.total_amount || 0) / 100;\n\t\t\t\tstatusGroups[status].cost += (job.total_cost_actual || 0) / 100;\n\t\t\t}\n\t\t}\n\n\t\t// Top profitable jobs\n\t\tconst topProfitableJobs = allJobs\n\t\t\t.map((j) => {\n\t\t\t\tconst customer = j.customer as {\n\t\t\t\t\tname?: string;\n\t\t\t\t\tdisplay_name?: string;\n\t\t\t\t} | null;\n\t\t\t\treturn {\n\t\t\t\t\tid: j.id,\n\t\t\t\t\ttitle: j.title || \"Untitled Job\",\n\t\t\t\t\tcustomer: customer?.display_name || customer?.name || \"Unknown\",\n\t\t\t\t\trevenue: (j.total_amount || 0) / 100,\n\t\t\t\t\tcost: (j.total_cost_actual || 0) / 100,\n\t\t\t\t\tprofit: (j.profit_actual || 0) / 100,\n\t\t\t\t\tmargin: j.gross_margin_percent || 0,\n\t\t\t\t};\n\t\t\t})\n\t\t\t.sort((a, b) => b.profit - a.profit)\n\t\t\t.slice(0, 10);\n\n\t\treturn {\n\t\t\tsummary: {\n\t\t\t\tavgJobProfit,\n\t\t\t\tavgGrossMargin,\n\t\t\t\ttotalLaborCost,\n\t\t\t\ttotalMaterialsCost,\n\t\t\t\ttotalEquipmentCost,\n\t\t\t\tjobsUnderBudget,\n\t\t\t\tjobsOnBudget,\n\t\t\t\tjobsOverBudget,\n\t\t\t\tavgCostVariance: 0, // Would need estimate comparison\n\t\t\t},\n\t\t\tbyBudgetStatus: Object.entries(statusGroups).map(([status, data]) => ({\n\t\t\t\tstatus,\n\t\t\t\tcount: data.count,\n\t\t\t\ttotalRevenue: data.revenue,\n\t\t\t\ttotalCost: data.cost,\n\t\t\t\tavgMargin:\n\t\t\t\t\tdata.revenue > 0\n\t\t\t\t\t\t? ((data.revenue - data.cost) / data.revenue) * 100\n\t\t\t\t\t\t: 0,\n\t\t\t})),\n\t\t\ttopProfitableJobs,\n\t\t\tcostBreakdown: {\n\t\t\t\tlabor: totalLaborCost,\n\t\t\t\tmaterials: totalMaterialsCost,\n\t\t\t\tequipment: totalEquipmentCost,\n\t\t\t\toverhead: totalOverhead,\n\t\t\t\tdriveTime: totalDriveTime,\n\t\t\t},\n\t\t};\n\t},\n);\n\n// ============================================================================\n// COMPANY KPI DASHBOARD\n// ============================================================================\n\nexport interface CompanyKPIs {\n\tfinancial: {\n\t\tquoteToCloseRate: number;\n\t\tavgQuoteAccuracy: number;\n\t\tavgDaysToPayment: number;\n\t\tcollectionRate: number;\n\t\tcashFlow30Day: number;\n\t};\n\toperational: {\n\t\tcapacityUtilization: number;\n\t\tbillableHoursRatio: number;\n\t\tfirstCallResolution: number;\n\t\tavgResponseTimeHours: number;\n\t\ttechnicianUtilization: number;\n\t};\n\tcustomer: {\n\t\tavgLifetimeValue: number;\n\t\tcustomerAcquisitionCost: number;\n\t\tltvToCacRatio: number;\n\t\tretentionRate: number;\n\t\trecurringRevenuePercent: number;\n\t};\n}\n\n/**\n * Get company KPIs from the summary table\n */\nexport const getCompanyKPIs = cache(\n\tasync (companyId: string): Promise<CompanyKPIs | null> => {\n\t\tconst supabase = await createClient();\n\n\t\tconst { data: summary } = await supabase\n\t\t\t.from(\"analytics_company_summary\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(1)\n\t\t\t.single();\n\n\t\tif (!summary) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\tfinancial: {\n\t\t\t\tquoteToCloseRate: summary.quote_to_close_rate || 0,\n\t\t\t\tavgQuoteAccuracy: summary.avg_quote_accuracy || 0,\n\t\t\t\tavgDaysToPayment: summary.avg_days_to_payment || 0,\n\t\t\t\tcollectionRate: summary.collection_rate || 0,\n\t\t\t\tcashFlow30Day: (summary.cash_flow_30_day_forecast || 0) / 100,\n\t\t\t},\n\t\t\toperational: {\n\t\t\t\tcapacityUtilization: summary.capacity_utilization_percent || 0,\n\t\t\t\tbillableHoursRatio: summary.billable_hours_ratio || 0,\n\t\t\t\tfirstCallResolution: summary.first_call_resolution_rate || 0,\n\t\t\t\tavgResponseTimeHours: summary.avg_response_time_hours || 0,\n\t\t\t\ttechnicianUtilization: summary.technician_utilization_rate || 0,\n\t\t\t},\n\t\t\tcustomer: {\n\t\t\t\tavgLifetimeValue: (summary.avg_customer_lifetime_value || 0) / 100,\n\t\t\t\tcustomerAcquisitionCost: (summary.customer_acquisition_cost || 0) / 100,\n\t\t\t\tltvToCacRatio: summary.ltv_to_cac_ratio || 0,\n\t\t\t\tretentionRate: summary.customer_retention_rate || 0,\n\t\t\t\trecurringRevenuePercent: summary.recurring_revenue_percent || 0,\n\t\t\t},\n\t\t};\n\t},\n);\n\n// ============================================================================\n// EQUIPMENT HEALTH ANALYTICS\n// ============================================================================\n\nexport interface EquipmentHealthSummary {\n\tsummary: {\n\t\ttotalEquipment: number;\n\t\thealthyCount: number;\n\t\twarningCount: number;\n\t\tcriticalCount: number;\n\t\tavgHealthScore: number;\n\t\tmaintenanceOverdue: number;\n\t};\n\tbyCondition: Array<{\n\t\tcondition: string;\n\t\tcount: number;\n\t\tavgAge: number;\n\t\tavgMaintenanceCost: number;\n\t}>;\n\tupcomingMaintenance: Array<{\n\t\tequipmentId: string;\n\t\tname: string;\n\t\tdaysUntilMaintenance: number;\n\t\tlastMaintenanceCost: number;\n\t}>;\n}\n\n/**\n * Get equipment health analytics\n */\nexport const getEquipmentHealthAnalytics = cache(\n\tasync (companyId: string): Promise<EquipmentHealthSummary> => {\n\t\tconst supabase = await createClient();\n\n\t\tconst { data: healthData } = await supabase\n\t\t\t.from(\"analytics_equipment_health\")\n\t\t\t.select(`\n\t\t\tequipment_id, health_score, condition_rating,\n\t\t\tdays_until_maintenance, maintenance_overdue,\n\t\t\ttotal_maintenance_cost, age_years,\n\t\t\tequipment:equipment(id, name, model)\n\t\t`)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"period_start\", { ascending: false })\n\t\t\t.limit(5000); // Prevent unbounded query\n\n\t\tconst data = healthData || [];\n\n\t\t// Get unique equipment (most recent entry per equipment)\n\t\tconst latestByEquipment = new Map<string, (typeof data)[0]>();\n\t\tfor (const d of data) {\n\t\t\tif (!latestByEquipment.has(d.equipment_id)) {\n\t\t\t\tlatestByEquipment.set(d.equipment_id, d);\n\t\t\t}\n\t\t}\n\n\t\tconst equipmentList = Array.from(latestByEquipment.values());\n\t\tconst totalEquipment = equipmentList.length;\n\n\t\tconst healthyCount = equipmentList.filter(\n\t\t\t(e) => e.health_score >= 70,\n\t\t).length;\n\t\tconst warningCount = equipmentList.filter(\n\t\t\t(e) => e.health_score >= 40 && e.health_score < 70,\n\t\t).length;\n\t\tconst criticalCount = equipmentList.filter(\n\t\t\t(e) => e.health_score < 40,\n\t\t).length;\n\t\tconst maintenanceOverdue = equipmentList.filter(\n\t\t\t(e) => e.maintenance_overdue,\n\t\t).length;\n\n\t\tconst avgHealthScore =\n\t\t\ttotalEquipment > 0\n\t\t\t\t? equipmentList.reduce((sum, e) => sum + (e.health_score || 0), 0) /\n\t\t\t\t\ttotalEquipment\n\t\t\t\t: 0;\n\n\t\t// By condition\n\t\tconst conditionGroups: Record<\n\t\t\tstring,\n\t\t\t{ count: number; totalAge: number; totalCost: number }\n\t\t> = {};\n\t\tfor (const e of equipmentList) {\n\t\t\tconst condition = e.condition_rating || \"unknown\";\n\t\t\tif (!conditionGroups[condition]) {\n\t\t\t\tconditionGroups[condition] = { count: 0, totalAge: 0, totalCost: 0 };\n\t\t\t}\n\t\t\tconditionGroups[condition].count++;\n\t\t\tconditionGroups[condition].totalAge += e.age_years || 0;\n\t\t\tconditionGroups[condition].totalCost +=\n\t\t\t\t(e.total_maintenance_cost || 0) / 100;\n\t\t}\n\n\t\t// Upcoming maintenance\n\t\tconst upcomingMaintenance = equipmentList\n\t\t\t.filter(\n\t\t\t\t(e) =>\n\t\t\t\t\t(e.days_until_maintenance || 0) > 0 &&\n\t\t\t\t\t(e.days_until_maintenance || 0) <= 30,\n\t\t\t)\n\t\t\t.map((e) => {\n\t\t\t\tconst equip = e.equipment as {\n\t\t\t\t\tid: string;\n\t\t\t\t\tname: string;\n\t\t\t\t\tmodel?: string;\n\t\t\t\t} | null;\n\t\t\t\treturn {\n\t\t\t\t\tequipmentId: e.equipment_id,\n\t\t\t\t\tname: equip?.name || equip?.model || \"Unknown Equipment\",\n\t\t\t\t\tdaysUntilMaintenance: e.days_until_maintenance || 0,\n\t\t\t\t\tlastMaintenanceCost: (e.total_maintenance_cost || 0) / 100,\n\t\t\t\t};\n\t\t\t})\n\t\t\t.sort((a, b) => a.daysUntilMaintenance - b.daysUntilMaintenance)\n\t\t\t.slice(0, 10);\n\n\t\treturn {\n\t\t\tsummary: {\n\t\t\t\ttotalEquipment,\n\t\t\t\thealthyCount,\n\t\t\t\twarningCount,\n\t\t\t\tcriticalCount,\n\t\t\t\tavgHealthScore,\n\t\t\t\tmaintenanceOverdue,\n\t\t\t},\n\t\t\tbyCondition: Object.entries(conditionGroups).map(([condition, data]) => ({\n\t\t\t\tcondition,\n\t\t\t\tcount: data.count,\n\t\t\t\tavgAge: data.count > 0 ? data.totalAge / data.count : 0,\n\t\t\t\tavgMaintenanceCost: data.count > 0 ? data.totalCost / data.count : 0,\n\t\t\t})),\n\t\t\tupcomingMaintenance,\n\t\t};\n\t},\n);\n\n// ============================================================================\n// TECHNICIAN PERFORMANCE ANALYTICS\n// ============================================================================\n\nexport interface TechnicianPerformanceData {\n\ttechnicians: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tjobsCompleted: number;\n\t\trevenue: number;\n\t\tavgJobProfit: number;\n\t\tprofitMargin: number;\n\t\tbillableRatio: number;\n\t\tcallbacks: number;\n\t\tcallbackRate: number;\n\t\tupsellCount: number;\n\t\tupsellRevenue: number;\n\t\toverallScore: number;\n\t\trank: number;\n\t}>;\n\tteamMetrics: {\n\t\tavgJobsPerTech: number;\n\t\tavgRevenuePerTech: number;\n\t\tavgProfitMargin: number;\n\t\tavgBillableRatio: number;\n\t\ttotalCallbacks: number;\n\t};\n}\n\n/**\n * Get detailed technician performance analytics\n */\nexport const getTechnicianPerformance = cache(\n\tasync (\n\t\tcompanyId: string,\n\t\tdays: number = 30,\n\t): Promise<TechnicianPerformanceData> => {\n\t\tconst supabase = await createClient();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\tconst { data: metrics } = await supabase\n\t\t\t.from(\"analytics_technician_metrics\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"period_start\", startDate.toISOString().split(\"T\")[0])\n\t\t\t.order(\"overall_performance_score\", { ascending: false });\n\n\t\tconst techMetrics = metrics || [];\n\n\t\tconst technicians = techMetrics.map((t, index) => ({\n\t\t\tid: t.user_id,\n\t\t\tname: t.name || \"Unknown\",\n\t\t\tjobsCompleted: t.jobs_completed || 0,\n\t\t\trevenue: (t.total_revenue || 0) / 100,\n\t\t\tavgJobProfit: (t.avg_job_profit || 0) / 100,\n\t\t\tprofitMargin: t.profit_margin_percent || 0,\n\t\t\tbillableRatio: t.billable_ratio || 0,\n\t\t\tcallbacks: t.callbacks || 0,\n\t\t\tcallbackRate: t.callback_rate || 0,\n\t\t\tupsellCount: t.upsell_count || 0,\n\t\t\tupsellRevenue: (t.upsell_revenue || 0) / 100,\n\t\t\toverallScore: t.overall_performance_score || 0,\n\t\t\trank: index + 1,\n\t\t}));\n\n\t\tconst count = technicians.length;\n\t\tconst teamMetrics = {\n\t\t\tavgJobsPerTech:\n\t\t\t\tcount > 0\n\t\t\t\t\t? technicians.reduce((s, t) => s + t.jobsCompleted, 0) / count\n\t\t\t\t\t: 0,\n\t\t\tavgRevenuePerTech:\n\t\t\t\tcount > 0 ? technicians.reduce((s, t) => s + t.revenue, 0) / count : 0,\n\t\t\tavgProfitMargin:\n\t\t\t\tcount > 0\n\t\t\t\t\t? technicians.reduce((s, t) => s + t.profitMargin, 0) / count\n\t\t\t\t\t: 0,\n\t\t\tavgBillableRatio:\n\t\t\t\tcount > 0\n\t\t\t\t\t? technicians.reduce((s, t) => s + t.billableRatio, 0) / count\n\t\t\t\t\t: 0,\n\t\t\ttotalCallbacks: technicians.reduce((s, t) => s + t.callbacks, 0),\n\t\t};\n\n\t\treturn { technicians, teamMetrics };\n\t},\n);\n\n// ============================================================================\n// MARKETING ROI & CAMPAIGN ANALYTICS\n// ============================================================================\n\nexport interface MarketingCampaignData {\n\tsummary: {\n\t\ttotalSpend: number;\n\t\ttotalRevenue: number;\n\t\ttotalLeads: number;\n\t\ttotalBookedJobs: number;\n\t\toverallROAS: number;\n\t\toverallROI: number;\n\t\tavgCostPerLead: number;\n\t\tavgCostPerAcquisition: number;\n\t};\n\tcampaigns: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tchannel: string;\n\t\tstatus: string;\n\t\tbudget: number;\n\t\tspend: number;\n\t\tleads: number;\n\t\tbookedJobs: number;\n\t\trevenue: number;\n\t\troas: number;\n\t\troi: number;\n\t\tcostPerLead: number;\n\t}>;\n\tbyChannel: Array<{\n\t\tchannel: string;\n\t\tspend: number;\n\t\tleads: number;\n\t\tbookedJobs: number;\n\t\trevenue: number;\n\t\troas: number;\n\t\tcostPerLead: number;\n\t}>;\n\ttrendDaily: Array<{\n\t\tdate: string;\n\t\tspend: number;\n\t\tleads: number;\n\t\trevenue: number;\n\t\troas: number;\n\t}>;\n}\n\n/**\n * Get marketing campaign ROI analytics\n */\nexport const getMarketingROIAnalytics = cache(\n\tasync (\n\t\tcompanyId: string,\n\t\tdays: number = 90,\n\t): Promise<MarketingCampaignData> => {\n\t\tconst supabase = await createClient();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\t// Get campaigns (limit to 1000, select only needed fields)\n\t\tconst { data: campaigns } = await supabase\n\t\t\t.from(\"marketing_campaigns\")\n\t\t\t.select(\n\t\t\t\t\"id, name, channel, status, budget_amount, actual_spend, total_revenue, total_leads, total_booked_jobs, start_date, end_date, created_at\",\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t.limit(1000);\n\n\t\t// Get daily attribution data (limit to 10000 for analytics)\n\t\tconst { data: attribution } = await supabase\n\t\t\t.from(\"analytics_marketing_attribution\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"date\", startDate.toISOString().split(\"T\")[0])\n\t\t\t.order(\"date\", { ascending: true })\n\t\t\t.limit(10000);\n\n\t\tconst allCampaigns = campaigns || [];\n\t\tconst allAttribution = attribution || [];\n\n\t\t// Calculate summary metrics\n\t\tconst totalSpend = allCampaigns.reduce(\n\t\t\t(sum, c) => sum + (c.actual_spend || 0),\n\t\t\t0,\n\t\t);\n\t\tconst totalRevenue = allCampaigns.reduce(\n\t\t\t(sum, c) => sum + (c.total_revenue || 0),\n\t\t\t0,\n\t\t);\n\t\tconst totalLeads = allCampaigns.reduce(\n\t\t\t(sum, c) => sum + (c.total_leads || 0),\n\t\t\t0,\n\t\t);\n\t\tconst totalBookedJobs = allCampaigns.reduce(\n\t\t\t(sum, c) => sum + (c.total_booked_jobs || 0),\n\t\t\t0,\n\t\t);\n\n\t\tconst overallROAS = totalSpend > 0 ? totalRevenue / totalSpend : 0;\n\t\tconst overallROI =\n\t\t\ttotalSpend > 0 ? ((totalRevenue - totalSpend) / totalSpend) * 100 : 0;\n\t\tconst avgCostPerLead = totalLeads > 0 ? totalSpend / totalLeads : 0;\n\t\tconst avgCostPerAcquisition =\n\t\t\ttotalBookedJobs > 0 ? totalSpend / totalBookedJobs : 0;\n\n\t\t// Campaign list\n\t\tconst campaignList = allCampaigns.map((c) => ({\n\t\t\tid: c.id,\n\t\t\tname: c.name,\n\t\t\tchannel: c.channel,\n\t\t\tstatus: c.status,\n\t\t\tbudget: c.budget_amount || 0,\n\t\t\tspend: c.actual_spend || 0,\n\t\t\tleads: c.total_leads || 0,\n\t\t\tbookedJobs: c.total_booked_jobs || 0,\n\t\t\trevenue: c.total_revenue || 0,\n\t\t\troas: c.return_on_ad_spend || 0,\n\t\t\troi: c.roi_percent || 0,\n\t\t\tcostPerLead: c.cost_per_lead || 0,\n\t\t}));\n\n\t\t// Aggregate by channel\n\t\tconst channelData: Record<\n\t\t\tstring,\n\t\t\t{\n\t\t\t\tspend: number;\n\t\t\t\tleads: number;\n\t\t\t\tbookedJobs: number;\n\t\t\t\trevenue: number;\n\t\t\t}\n\t\t> = {};\n\n\t\tfor (const c of allCampaigns) {\n\t\t\tconst channel = c.channel || \"other\";\n\t\t\tif (!channelData[channel]) {\n\t\t\t\tchannelData[channel] = {\n\t\t\t\t\tspend: 0,\n\t\t\t\t\tleads: 0,\n\t\t\t\t\tbookedJobs: 0,\n\t\t\t\t\trevenue: 0,\n\t\t\t\t};\n\t\t\t}\n\t\t\tchannelData[channel].spend += c.actual_spend || 0;\n\t\t\tchannelData[channel].leads += c.total_leads || 0;\n\t\t\tchannelData[channel].bookedJobs += c.total_booked_jobs || 0;\n\t\t\tchannelData[channel].revenue += c.total_revenue || 0;\n\t\t}\n\n\t\tconst byChannel = Object.entries(channelData)\n\t\t\t.map(([channel, data]) => ({\n\t\t\t\tchannel,\n\t\t\t\tspend: data.spend,\n\t\t\t\tleads: data.leads,\n\t\t\t\tbookedJobs: data.bookedJobs,\n\t\t\t\trevenue: data.revenue,\n\t\t\t\troas: data.spend > 0 ? data.revenue / data.spend : 0,\n\t\t\t\tcostPerLead: data.leads > 0 ? data.spend / data.leads : 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.revenue - a.revenue);\n\n\t\t// Daily trends\n\t\tconst dailyData: Record<\n\t\t\tstring,\n\t\t\t{ spend: number; leads: number; revenue: number }\n\t\t> = {};\n\t\tfor (const a of allAttribution) {\n\t\t\tconst date = a.date;\n\t\t\tif (!dailyData[date]) {\n\t\t\t\tdailyData[date] = { spend: 0, leads: 0, revenue: 0 };\n\t\t\t}\n\t\t\tdailyData[date].spend += a.daily_spend || 0;\n\t\t\tdailyData[date].leads += a.total_leads || 0;\n\t\t\tdailyData[date].revenue += a.total_revenue || 0;\n\t\t}\n\n\t\tconst trendDaily = Object.entries(dailyData)\n\t\t\t.map(([date, data]) => ({\n\t\t\t\tdate,\n\t\t\t\tspend: data.spend,\n\t\t\t\tleads: data.leads,\n\t\t\t\trevenue: data.revenue,\n\t\t\t\troas: data.spend > 0 ? data.revenue / data.spend : 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => a.date.localeCompare(b.date));\n\n\t\treturn {\n\t\t\tsummary: {\n\t\t\t\ttotalSpend,\n\t\t\t\ttotalRevenue,\n\t\t\t\ttotalLeads,\n\t\t\t\ttotalBookedJobs,\n\t\t\t\toverallROAS,\n\t\t\t\toverallROI,\n\t\t\t\tavgCostPerLead,\n\t\t\t\tavgCostPerAcquisition,\n\t\t\t},\n\t\t\tcampaigns: campaignList,\n\t\t\tbyChannel,\n\t\t\ttrendDaily,\n\t\t};\n\t},\n);\n\n// ============================================================================\n// CSR (CUSTOMER SERVICE REP) SCORECARD ANALYTICS\n// ============================================================================\n\nexport interface CSRScorecardData {\n\tsummary: {\n\t\ttotalCSRs: number;\n\t\ttotalCallsHandled: number;\n\t\tavgBookingRate: number;\n\t\tavgCallAnswerRate: number;\n\t\ttotalBookedRevenue: number;\n\t\tavgRevenuePerCall: number;\n\t\ttopPerformerBookingRate: number;\n\t\tteamTarget: number;\n\t};\n\tcsrList: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tcallsAnswered: number;\n\t\tcallsMissed: number;\n\t\tcallAnswerRate: number;\n\t\topportunities: number;\n\t\tjobsBooked: number;\n\t\tbookingRate: number;\n\t\tbookedRevenue: number;\n\t\tavgTicket: number;\n\t\trevenuePerCall: number;\n\t\tavgTalkTime: number;\n\t\tqualityScore: number;\n\t\tperformanceScore: number;\n\t\tbookingRateRank: number;\n\t\trevenueRank: number;\n\t\tvsTarget: number;\n\t}>;\n\tleaderboard: Array<{\n\t\trank: number;\n\t\tname: string;\n\t\tbookingRate: number;\n\t\trevenue: number;\n\t}>;\n\ttrendDaily: Array<{\n\t\tdate: string;\n\t\ttotalCalls: number;\n\t\tanswered: number;\n\t\tbooked: number;\n\t\tbookingRate: number;\n\t}>;\n}\n\n/**\n * Get CSR scorecard analytics\n */\nexport const getCSRScorecardAnalytics = cache(\n\tasync (companyId: string, days: number = 30): Promise<CSRScorecardData> => {\n\t\tconst supabase = await createClient();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\t// Get CSR metrics\n\t\tconst { data: csrMetrics } = await supabase\n\t\t\t.from(\"analytics_csr_metrics\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"date\", startDate.toISOString().split(\"T\")[0])\n\t\t\t.order(\"date\", { ascending: false });\n\n\t\tconst allMetrics = csrMetrics || [];\n\n\t\t// Get latest metrics per CSR (most recent date)\n\t\tconst latestByCSR = new Map<string, (typeof allMetrics)[0]>();\n\t\tfor (const m of allMetrics) {\n\t\t\tif (\n\t\t\t\t!latestByCSR.has(m.user_id) ||\n\t\t\t\tm.date > (latestByCSR.get(m.user_id)?.date || \"\")\n\t\t\t) {\n\t\t\t\tlatestByCSR.set(m.user_id, m);\n\t\t\t}\n\t\t}\n\n\t\tconst csrList = Array.from(latestByCSR.values())\n\t\t\t.map((m) => ({\n\t\t\t\tid: m.user_id,\n\t\t\t\tname: m.csr_name || \"Unknown\",\n\t\t\t\tcallsAnswered: m.total_calls_answered || 0,\n\t\t\t\tcallsMissed: m.total_calls_missed || 0,\n\t\t\t\tcallAnswerRate: m.call_answer_rate || 0,\n\t\t\t\topportunities: m.total_opportunities || 0,\n\t\t\t\tjobsBooked: m.jobs_booked || 0,\n\t\t\t\tbookingRate: m.booking_rate || 0,\n\t\t\t\tbookedRevenue: m.booked_revenue || 0,\n\t\t\t\tavgTicket: m.avg_booked_ticket || 0,\n\t\t\t\trevenuePerCall: m.revenue_per_call || 0,\n\t\t\t\tavgTalkTime: m.avg_talk_time_seconds || 0,\n\t\t\t\tqualityScore: m.avg_call_quality_score || 0,\n\t\t\t\tperformanceScore: m.overall_performance_score || 0,\n\t\t\t\tbookingRateRank: m.booking_rate_rank || 0,\n\t\t\t\trevenueRank: m.revenue_rank || 0,\n\t\t\t\tvsTarget: m.booking_rate_vs_target || 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.bookingRate - a.bookingRate);\n\n\t\t// Calculate summary metrics\n\t\tconst totalCSRs = csrList.length;\n\t\tconst totalCallsHandled = csrList.reduce(\n\t\t\t(sum, c) => sum + c.callsAnswered,\n\t\t\t0,\n\t\t);\n\t\tconst avgBookingRate =\n\t\t\ttotalCSRs > 0\n\t\t\t\t? csrList.reduce((sum, c) => sum + c.bookingRate, 0) / totalCSRs\n\t\t\t\t: 0;\n\t\tconst avgCallAnswerRate =\n\t\t\ttotalCSRs > 0\n\t\t\t\t? csrList.reduce((sum, c) => sum + c.callAnswerRate, 0) / totalCSRs\n\t\t\t\t: 0;\n\t\tconst totalBookedRevenue = csrList.reduce(\n\t\t\t(sum, c) => sum + c.bookedRevenue,\n\t\t\t0,\n\t\t);\n\t\tconst avgRevenuePerCall =\n\t\t\ttotalCallsHandled > 0 ? totalBookedRevenue / totalCallsHandled : 0;\n\t\tconst topPerformerBookingRate =\n\t\t\tcsrList.length > 0 ? csrList[0].bookingRate : 0;\n\n\t\t// Leaderboard (top 5)\n\t\tconst leaderboard = csrList.slice(0, 5).map((c, index) => ({\n\t\t\trank: index + 1,\n\t\t\tname: c.name,\n\t\t\tbookingRate: c.bookingRate,\n\t\t\trevenue: c.bookedRevenue,\n\t\t}));\n\n\t\t// Daily trends\n\t\tconst dailyData: Record<\n\t\t\tstring,\n\t\t\t{\n\t\t\t\ttotalCalls: number;\n\t\t\t\tanswered: number;\n\t\t\t\tbooked: number;\n\t\t\t}\n\t\t> = {};\n\n\t\tfor (const m of allMetrics) {\n\t\t\tconst date = m.date;\n\t\t\tif (!dailyData[date]) {\n\t\t\t\tdailyData[date] = { totalCalls: 0, answered: 0, booked: 0 };\n\t\t\t}\n\t\t\tdailyData[date].totalCalls += m.total_calls_received || 0;\n\t\t\tdailyData[date].answered += m.total_calls_answered || 0;\n\t\t\tdailyData[date].booked += m.jobs_booked || 0;\n\t\t}\n\n\t\tconst trendDaily = Object.entries(dailyData)\n\t\t\t.map(([date, data]) => ({\n\t\t\t\tdate,\n\t\t\t\ttotalCalls: data.totalCalls,\n\t\t\t\tanswered: data.answered,\n\t\t\t\tbooked: data.booked,\n\t\t\t\tbookingRate:\n\t\t\t\t\tdata.answered > 0 ? (data.booked / data.answered) * 100 : 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => a.date.localeCompare(b.date));\n\n\t\treturn {\n\t\t\tsummary: {\n\t\t\t\ttotalCSRs,\n\t\t\t\ttotalCallsHandled,\n\t\t\t\tavgBookingRate,\n\t\t\t\tavgCallAnswerRate,\n\t\t\t\ttotalBookedRevenue,\n\t\t\t\tavgRevenuePerCall,\n\t\t\t\ttopPerformerBookingRate,\n\t\t\t\tteamTarget: 80, // Default target\n\t\t\t},\n\t\t\tcsrList,\n\t\t\tleaderboard,\n\t\t\ttrendDaily,\n\t\t};\n\t},\n);\n\n// ============================================================================\n// CALL TRACKING ANALYTICS\n// ============================================================================\n\nexport interface CallTrackingData {\n\tsummary: {\n\t\ttotalCalls: number;\n\t\tansweredCalls: number;\n\t\tmissedCalls: number;\n\t\tcallAnswerRate: number;\n\t\tbookedCalls: number;\n\t\tbookingRate: number;\n\t\tavgCallDuration: number;\n\t\tnewCustomerCalls: number;\n\t};\n\tbyOutcome: Array<{\n\t\toutcome: string;\n\t\tcount: number;\n\t\tpercentage: number;\n\t}>;\n\tbySource: Array<{\n\t\tsource: string;\n\t\tcalls: number;\n\t\tbooked: number;\n\t\tbookingRate: number;\n\t\trevenue: number;\n\t}>;\n\trecentCalls: Array<{\n\t\tid: string;\n\t\tcallerNumber: string;\n\t\tcallerName: string | null;\n\t\tduration: number;\n\t\toutcome: string;\n\t\tbooked: boolean;\n\t\tcampaign: string | null;\n\t\ttime: string;\n\t}>;\n}\n\n/**\n * Get call tracking analytics\n */\nexport const getCallTrackingAnalytics = cache(\n\tasync (companyId: string, days: number = 30): Promise<CallTrackingData> => {\n\t\tconst supabase = await createClient();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\tconst { data: calls } = await supabase\n\t\t\t.from(\"marketing_call_tracking\")\n\t\t\t.select(`\n\t\t\t*,\n\t\t\tcampaign:marketing_campaigns(name, channel)\n\t\t`)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"call_start\", startDate.toISOString())\n\t\t\t.order(\"call_start\", { ascending: false })\n\t\t\t.limit(500);\n\n\t\tconst allCalls = calls || [];\n\n\t\t// Summary metrics\n\t\tconst totalCalls = allCalls.length;\n\t\tconst answeredCalls = allCalls.filter((c) => c.answered).length;\n\t\tconst missedCalls = allCalls.filter((c) => c.missed_call).length;\n\t\tconst callAnswerRate =\n\t\t\ttotalCalls > 0 ? (answeredCalls / totalCalls) * 100 : 0;\n\t\tconst bookedCalls = allCalls.filter((c) => c.booked_job).length;\n\t\tconst bookingRate =\n\t\t\tansweredCalls > 0 ? (bookedCalls / answeredCalls) * 100 : 0;\n\t\tconst avgCallDuration =\n\t\t\tansweredCalls > 0\n\t\t\t\t? allCalls\n\t\t\t\t\t\t.filter((c) => c.answered)\n\t\t\t\t\t\t.reduce((sum, c) => sum + (c.duration_seconds || 0), 0) /\n\t\t\t\t\tansweredCalls\n\t\t\t\t: 0;\n\t\tconst newCustomerCalls = allCalls.filter((c) => c.is_new_customer).length;\n\n\t\t// By outcome\n\t\tconst outcomeCounts: Record<string, number> = {};\n\t\tfor (const c of allCalls) {\n\t\t\tconst outcome = c.call_outcome || \"unknown\";\n\t\t\toutcomeCounts[outcome] = (outcomeCounts[outcome] || 0) + 1;\n\t\t}\n\t\tconst byOutcome = Object.entries(outcomeCounts)\n\t\t\t.map(([outcome, count]) => ({\n\t\t\t\toutcome,\n\t\t\t\tcount,\n\t\t\t\tpercentage: totalCalls > 0 ? (count / totalCalls) * 100 : 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.count - a.count);\n\n\t\t// By source/campaign\n\t\tconst sourceData: Record<\n\t\t\tstring,\n\t\t\t{\n\t\t\t\tcalls: number;\n\t\t\t\tbooked: number;\n\t\t\t\trevenue: number;\n\t\t\t}\n\t\t> = {};\n\t\tfor (const c of allCalls) {\n\t\t\tconst campaign = c.campaign as { name: string; channel: string } | null;\n\t\t\tconst source = campaign?.channel || c.utm_source || \"direct\";\n\t\t\tif (!sourceData[source]) {\n\t\t\t\tsourceData[source] = { calls: 0, booked: 0, revenue: 0 };\n\t\t\t}\n\t\t\tsourceData[source].calls++;\n\t\t\tif (c.booked_job) sourceData[source].booked++;\n\t\t\tsourceData[source].revenue += c.attributed_revenue || 0;\n\t\t}\n\t\tconst bySource = Object.entries(sourceData)\n\t\t\t.map(([source, data]) => ({\n\t\t\t\tsource,\n\t\t\t\tcalls: data.calls,\n\t\t\t\tbooked: data.booked,\n\t\t\t\tbookingRate: data.calls > 0 ? (data.booked / data.calls) * 100 : 0,\n\t\t\t\trevenue: data.revenue,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.calls - a.calls);\n\n\t\t// Recent calls (last 20)\n\t\tconst now = new Date();\n\t\tconst recentCalls = allCalls.slice(0, 20).map((c) => {\n\t\t\tconst campaign = c.campaign as { name: string } | null;\n\t\t\tconst callTime = new Date(c.call_start);\n\t\t\tconst diffMs = now.getTime() - callTime.getTime();\n\t\t\tconst diffMins = Math.floor(diffMs / 60000);\n\t\t\tconst diffHours = Math.floor(diffMins / 60);\n\n\t\t\tlet timeAgo: string;\n\t\t\tif (diffMins < 60) {\n\t\t\t\ttimeAgo = `${diffMins}m ago`;\n\t\t\t} else if (diffHours < 24) {\n\t\t\t\ttimeAgo = `${diffHours}h ago`;\n\t\t\t} else {\n\t\t\t\ttimeAgo = `${Math.floor(diffHours / 24)}d ago`;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tid: c.id,\n\t\t\t\tcallerNumber: c.caller_number || \"Unknown\",\n\t\t\t\tcallerName: c.caller_name,\n\t\t\t\tduration: c.duration_seconds || 0,\n\t\t\t\toutcome: c.call_outcome || \"unknown\",\n\t\t\t\tbooked: c.booked_job || false,\n\t\t\t\tcampaign: campaign?.name || null,\n\t\t\t\ttime: timeAgo,\n\t\t\t};\n\t\t});\n\n\t\treturn {\n\t\t\tsummary: {\n\t\t\t\ttotalCalls,\n\t\t\t\tansweredCalls,\n\t\t\t\tmissedCalls,\n\t\t\t\tcallAnswerRate,\n\t\t\t\tbookedCalls,\n\t\t\t\tbookingRate,\n\t\t\t\tavgCallDuration,\n\t\t\t\tnewCustomerCalls,\n\t\t\t},\n\t\t\tbyOutcome,\n\t\t\tbySource,\n\t\t\trecentCalls,\n\t\t};\n\t},\n);\n\n// ============================================================================\n// DISPATCH EFFICIENCY ANALYTICS\n// ============================================================================\n\nexport interface DispatchEfficiencyData {\n\tsummary: {\n\t\tscheduleFillRate: number;\n\t\tavgDriveTimeMinutes: number;\n\t\tavgDriveDistanceMiles: number;\n\t\tonTimeArrivalRate: number;\n\t\tslaComplianceRate: number;\n\t\tavgJobsPerTechPerDay: number;\n\t\tutilizationRate: number;\n\t\ttotalDriveMiles: number;\n\t\ttotalDriveCost: number;\n\t};\n\tbyTechnician: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tscheduleFillRate: number;\n\t\tavgDriveTime: number;\n\t\tonTimeRate: number;\n\t\tjobsCompleted: number;\n\t\tutilizationRate: number;\n\t\tdriveTimeOptimization: number;\n\t}>;\n\tbyZone: Array<{\n\t\tzone: string;\n\t\tappointments: number;\n\t\tavgDriveTime: number;\n\t\tavgDriveDistance: number;\n\t\tonTimeRate: number;\n\t\trevenue: number;\n\t}>;\n\tdailyTrends: Array<{\n\t\tdate: string;\n\t\tscheduleFillRate: number;\n\t\tavgDriveTime: number;\n\t\tonTimeRate: number;\n\t\tjobsScheduled: number;\n\t\tjobsCompleted: number;\n\t}>;\n\toptimizationAlerts: Array<{\n\t\ttype: string;\n\t\tseverity: \"low\" | \"medium\" | \"high\";\n\t\tmessage: string;\n\t\tpotentialSavings: number;\n\t}>;\n}\n\n/**\n * Get dispatch efficiency analytics\n */\nexport const getDispatchEfficiencyAnalytics = cache(\n\tasync (\n\t\tcompanyId: string,\n\t\tdays: number = 30,\n\t): Promise<DispatchEfficiencyData> => {\n\t\tconst supabase = await createClient();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\tconst { data: dispatchData } = await supabase\n\t\t\t.from(\"analytics_dispatch_efficiency\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"date\", startDate.toISOString().split(\"T\")[0])\n\t\t\t.order(\"date\", { ascending: false });\n\n\t\tconst allData = dispatchData || [];\n\n\t\t// Get latest data per technician\n\t\tconst latestByTech = new Map<string, (typeof allData)[0]>();\n\t\tfor (const d of allData) {\n\t\t\tif (d.technician_id && !latestByTech.has(d.technician_id)) {\n\t\t\t\tlatestByTech.set(d.technician_id, d);\n\t\t\t}\n\t\t}\n\n\t\t// Calculate summary metrics\n\t\tconst dataCount = allData.length;\n\t\tconst avgScheduleFillRate =\n\t\t\tdataCount > 0\n\t\t\t\t? allData.reduce((sum, d) => sum + (d.schedule_fill_rate || 0), 0) /\n\t\t\t\t\tdataCount\n\t\t\t\t: 0;\n\t\tconst avgDriveTime =\n\t\t\tdataCount > 0\n\t\t\t\t? allData.reduce((sum, d) => sum + (d.avg_drive_time_minutes || 0), 0) /\n\t\t\t\t\tdataCount\n\t\t\t\t: 0;\n\t\tconst avgDriveDistance =\n\t\t\tdataCount > 0\n\t\t\t\t? allData.reduce(\n\t\t\t\t\t\t(sum, d) => sum + (d.avg_drive_distance_miles || 0),\n\t\t\t\t\t\t0,\n\t\t\t\t\t) / dataCount\n\t\t\t\t: 0;\n\t\tconst avgOnTimeRate =\n\t\t\tdataCount > 0\n\t\t\t\t? allData.reduce((sum, d) => sum + (d.on_time_arrival_rate || 0), 0) /\n\t\t\t\t\tdataCount\n\t\t\t\t: 0;\n\t\tconst avgSlaCompliance =\n\t\t\tdataCount > 0\n\t\t\t\t? allData.reduce((sum, d) => sum + (d.sla_compliance_rate || 0), 0) /\n\t\t\t\t\tdataCount\n\t\t\t\t: 0;\n\t\tconst avgJobsPerTech =\n\t\t\tdataCount > 0\n\t\t\t\t? allData.reduce(\n\t\t\t\t\t\t(sum, d) => sum + (d.avg_jobs_per_tech_per_day || 0),\n\t\t\t\t\t\t0,\n\t\t\t\t\t) / dataCount\n\t\t\t\t: 0;\n\t\tconst avgUtilization =\n\t\t\tdataCount > 0\n\t\t\t\t? allData.reduce(\n\t\t\t\t\t\t(sum, d) => sum + (d.technician_utilization_rate || 0),\n\t\t\t\t\t\t0,\n\t\t\t\t\t) / dataCount\n\t\t\t\t: 0;\n\t\tconst totalDriveMiles = allData.reduce(\n\t\t\t(sum, d) => sum + (d.total_drive_distance_miles || 0),\n\t\t\t0,\n\t\t);\n\t\tconst totalDriveCost = allData.reduce(\n\t\t\t(sum, d) => sum + (d.total_drive_cost || 0),\n\t\t\t0,\n\t\t);\n\n\t\t// By technician\n\t\tconst byTechnician = Array.from(latestByTech.values())\n\t\t\t.map((d) => ({\n\t\t\t\tid: d.technician_id || \"\",\n\t\t\t\tname: d.technician_name || \"Unknown\",\n\t\t\t\tscheduleFillRate: d.schedule_fill_rate || 0,\n\t\t\t\tavgDriveTime: d.avg_drive_time_minutes || 0,\n\t\t\t\tonTimeRate: d.on_time_arrival_rate || 0,\n\t\t\t\tjobsCompleted: d.total_jobs_completed || 0,\n\t\t\t\tutilizationRate: d.technician_utilization_rate || 0,\n\t\t\t\tdriveTimeOptimization: d.drive_time_optimization_score || 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.scheduleFillRate - a.scheduleFillRate);\n\n\t\t// By zone\n\t\tconst zoneData: Record<\n\t\t\tstring,\n\t\t\t{\n\t\t\t\tappointments: number;\n\t\t\t\ttotalDriveTime: number;\n\t\t\t\ttotalDriveDistance: number;\n\t\t\t\tonTimeCount: number;\n\t\t\t\ttotalCount: number;\n\t\t\t\trevenue: number;\n\t\t\t}\n\t\t> = {};\n\t\tfor (const d of allData) {\n\t\t\tconst zone = d.service_zone || \"Unassigned\";\n\t\t\tif (!zoneData[zone]) {\n\t\t\t\tzoneData[zone] = {\n\t\t\t\t\tappointments: 0,\n\t\t\t\t\ttotalDriveTime: 0,\n\t\t\t\t\ttotalDriveDistance: 0,\n\t\t\t\t\tonTimeCount: 0,\n\t\t\t\t\ttotalCount: 0,\n\t\t\t\t\trevenue: 0,\n\t\t\t\t};\n\t\t\t}\n\t\t\tzoneData[zone].appointments += d.total_jobs_scheduled || 0;\n\t\t\tzoneData[zone].totalDriveTime += d.total_drive_time_minutes || 0;\n\t\t\tzoneData[zone].totalDriveDistance += d.total_drive_distance_miles || 0;\n\t\t\tzoneData[zone].onTimeCount +=\n\t\t\t\t((d.on_time_arrival_rate || 0) * (d.total_jobs_completed || 0)) / 100;\n\t\t\tzoneData[zone].totalCount += d.total_jobs_completed || 0;\n\t\t\tzoneData[zone].revenue += d.revenue_per_mile || 0;\n\t\t}\n\n\t\tconst byZone = Object.entries(zoneData)\n\t\t\t.map(([zone, data]) => ({\n\t\t\t\tzone,\n\t\t\t\tappointments: data.appointments,\n\t\t\t\tavgDriveTime:\n\t\t\t\t\tdata.totalCount > 0 ? data.totalDriveTime / data.totalCount : 0,\n\t\t\t\tavgDriveDistance:\n\t\t\t\t\tdata.totalCount > 0 ? data.totalDriveDistance / data.totalCount : 0,\n\t\t\t\tonTimeRate:\n\t\t\t\t\tdata.totalCount > 0 ? (data.onTimeCount / data.totalCount) * 100 : 0,\n\t\t\t\trevenue: data.revenue,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.appointments - a.appointments);\n\n\t\t// Daily trends\n\t\tconst dailyAggregates: Record<\n\t\t\tstring,\n\t\t\t{\n\t\t\t\tfillRates: number[];\n\t\t\t\tdriveTimes: number[];\n\t\t\t\tonTimeRates: number[];\n\t\t\t\tscheduled: number;\n\t\t\t\tcompleted: number;\n\t\t\t}\n\t\t> = {};\n\t\tfor (const d of allData) {\n\t\t\tconst date = d.date;\n\t\t\tif (!dailyAggregates[date]) {\n\t\t\t\tdailyAggregates[date] = {\n\t\t\t\t\tfillRates: [],\n\t\t\t\t\tdriveTimes: [],\n\t\t\t\t\tonTimeRates: [],\n\t\t\t\t\tscheduled: 0,\n\t\t\t\t\tcompleted: 0,\n\t\t\t\t};\n\t\t\t}\n\t\t\tdailyAggregates[date].fillRates.push(d.schedule_fill_rate || 0);\n\t\t\tdailyAggregates[date].driveTimes.push(d.avg_drive_time_minutes || 0);\n\t\t\tdailyAggregates[date].onTimeRates.push(d.on_time_arrival_rate || 0);\n\t\t\tdailyAggregates[date].scheduled += d.total_jobs_scheduled || 0;\n\t\t\tdailyAggregates[date].completed += d.total_jobs_completed || 0;\n\t\t}\n\n\t\tconst dailyTrends = Object.entries(dailyAggregates)\n\t\t\t.map(([date, data]) => ({\n\t\t\t\tdate,\n\t\t\t\tscheduleFillRate:\n\t\t\t\t\tdata.fillRates.length > 0\n\t\t\t\t\t\t? data.fillRates.reduce((a, b) => a + b, 0) / data.fillRates.length\n\t\t\t\t\t\t: 0,\n\t\t\t\tavgDriveTime:\n\t\t\t\t\tdata.driveTimes.length > 0\n\t\t\t\t\t\t? data.driveTimes.reduce((a, b) => a + b, 0) /\n\t\t\t\t\t\t\tdata.driveTimes.length\n\t\t\t\t\t\t: 0,\n\t\t\t\tonTimeRate:\n\t\t\t\t\tdata.onTimeRates.length > 0\n\t\t\t\t\t\t? data.onTimeRates.reduce((a, b) => a + b, 0) /\n\t\t\t\t\t\t\tdata.onTimeRates.length\n\t\t\t\t\t\t: 0,\n\t\t\t\tjobsScheduled: data.scheduled,\n\t\t\t\tjobsCompleted: data.completed,\n\t\t\t}))\n\t\t\t.sort((a, b) => a.date.localeCompare(b.date));\n\n\t\t// Generate optimization alerts\n\t\tconst optimizationAlerts: DispatchEfficiencyData[\"optimizationAlerts\"] = [];\n\t\tif (avgScheduleFillRate < 70) {\n\t\t\toptimizationAlerts.push({\n\t\t\t\ttype: \"schedule_fill\",\n\t\t\t\tseverity: avgScheduleFillRate < 50 ? \"high\" : \"medium\",\n\t\t\t\tmessage: `Schedule fill rate is ${avgScheduleFillRate.toFixed(1)}% - optimize technician scheduling`,\n\t\t\t\tpotentialSavings: (80 - avgScheduleFillRate) * 100,\n\t\t\t});\n\t\t}\n\t\tif (avgDriveTime > 30) {\n\t\t\toptimizationAlerts.push({\n\t\t\t\ttype: \"drive_time\",\n\t\t\t\tseverity: avgDriveTime > 45 ? \"high\" : \"medium\",\n\t\t\t\tmessage: `Average drive time is ${avgDriveTime.toFixed(0)} minutes - consider route optimization`,\n\t\t\t\tpotentialSavings: ((avgDriveTime - 20) * totalDriveCost) / avgDriveTime,\n\t\t\t});\n\t\t}\n\t\tif (avgOnTimeRate < 85) {\n\t\t\toptimizationAlerts.push({\n\t\t\t\ttype: \"on_time\",\n\t\t\t\tseverity: avgOnTimeRate < 70 ? \"high\" : \"medium\",\n\t\t\t\tmessage: `On-time arrival rate is ${avgOnTimeRate.toFixed(1)}% - review scheduling practices`,\n\t\t\t\tpotentialSavings: 0,\n\t\t\t});\n\t\t}\n\n\t\treturn {\n\t\t\tsummary: {\n\t\t\t\tscheduleFillRate: avgScheduleFillRate,\n\t\t\t\tavgDriveTimeMinutes: avgDriveTime,\n\t\t\t\tavgDriveDistanceMiles: avgDriveDistance,\n\t\t\t\tonTimeArrivalRate: avgOnTimeRate,\n\t\t\t\tslaComplianceRate: avgSlaCompliance,\n\t\t\t\tavgJobsPerTechPerDay: avgJobsPerTech,\n\t\t\t\tutilizationRate: avgUtilization,\n\t\t\t\ttotalDriveMiles,\n\t\t\t\ttotalDriveCost,\n\t\t\t},\n\t\t\tbyTechnician,\n\t\t\tbyZone,\n\t\t\tdailyTrends,\n\t\t\toptimizationAlerts,\n\t\t};\n\t},\n);\n\n// ============================================================================\n// PRICEBOOK PERFORMANCE ANALYTICS\n// ============================================================================\n\nexport interface PricebookPerformanceData {\n\tsummary: {\n\t\ttotalItems: number;\n\t\tavgMargin: number;\n\t\tavgMarkup: number;\n\t\ttotalRevenue: number;\n\t\ttotalProfit: number;\n\t\titemsNeedingReview: number;\n\t\tlowMarginItems: number;\n\t\thighPerformingItems: number;\n\t};\n\tbyCategory: Array<{\n\t\tcategory: string;\n\t\titemCount: number;\n\t\ttotalSold: number;\n\t\trevenue: number;\n\t\tprofit: number;\n\t\tavgMargin: number;\n\t\tavgMarkup: number;\n\t}>;\n\ttopPerformers: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tcategory: string;\n\t\ttimesSold: number;\n\t\trevenue: number;\n\t\tprofit: number;\n\t\tmargin: number;\n\t\ttrend: \"up\" | \"down\" | \"stable\";\n\t}>;\n\tlowMarginAlerts: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tcurrentMargin: number;\n\t\ttargetMargin: number;\n\t\trecommendation: string;\n\t\tpotentialProfit: number;\n\t}>;\n\tpricingRecommendations: Array<{\n\t\titemId: string;\n\t\titemName: string;\n\t\tcurrentPrice: number;\n\t\trecommendedPrice: number;\n\t\treason: string;\n\t\tconfidence: number;\n\t}>;\n}\n\n/**\n * Get pricebook performance analytics\n */\nexport const getPricebookPerformanceAnalytics = cache(\n\tasync (\n\t\tcompanyId: string,\n\t\tdays: number = 90,\n\t): Promise<PricebookPerformanceData> => {\n\t\tconst supabase = await createClient();\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\tconst { data: pricebookData } = await supabase\n\t\t\t.from(\"analytics_pricebook_performance\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.gte(\"period_start\", startDate.toISOString().split(\"T\")[0])\n\t\t\t.order(\"total_revenue\", { ascending: false });\n\n\t\tconst allData = pricebookData || [];\n\n\t\t// Calculate summary metrics\n\t\tconst totalItems = allData.length;\n\t\tconst avgMargin =\n\t\t\ttotalItems > 0\n\t\t\t\t? allData.reduce((sum, d) => sum + (d.profit_margin_percent || 0), 0) /\n\t\t\t\t\ttotalItems\n\t\t\t\t: 0;\n\t\tconst avgMarkup =\n\t\t\ttotalItems > 0\n\t\t\t\t? allData.reduce((sum, d) => sum + (d.markup_percent || 0), 0) /\n\t\t\t\t\ttotalItems\n\t\t\t\t: 0;\n\t\tconst totalRevenue = allData.reduce(\n\t\t\t(sum, d) => sum + (d.total_revenue || 0),\n\t\t\t0,\n\t\t);\n\t\tconst totalProfit = allData.reduce(\n\t\t\t(sum, d) => sum + (d.total_profit || 0),\n\t\t\t0,\n\t\t);\n\t\tconst itemsNeedingReview = allData.filter(\n\t\t\t(d) => d.margin_alert === true,\n\t\t).length;\n\t\tconst lowMarginItems = allData.filter(\n\t\t\t(d) => (d.profit_margin_percent || 0) < 20,\n\t\t).length;\n\t\tconst highPerformingItems = allData.filter(\n\t\t\t(d) => (d.times_sold || 0) > 10 && (d.profit_margin_percent || 0) > 30,\n\t\t).length;\n\n\t\t// By category\n\t\tconst categoryData: Record<\n\t\t\tstring,\n\t\t\t{\n\t\t\t\titemCount: number;\n\t\t\t\ttotalSold: number;\n\t\t\t\trevenue: number;\n\t\t\t\tprofit: number;\n\t\t\t\tmargins: number[];\n\t\t\t\tmarkups: number[];\n\t\t\t}\n\t\t> = {};\n\t\tfor (const d of allData) {\n\t\t\tconst category = d.category || \"Uncategorized\";\n\t\t\tif (!categoryData[category]) {\n\t\t\t\tcategoryData[category] = {\n\t\t\t\t\titemCount: 0,\n\t\t\t\t\ttotalSold: 0,\n\t\t\t\t\trevenue: 0,\n\t\t\t\t\tprofit: 0,\n\t\t\t\t\tmargins: [],\n\t\t\t\t\tmarkups: [],\n\t\t\t\t};\n\t\t\t}\n\t\t\tcategoryData[category].itemCount++;\n\t\t\tcategoryData[category].totalSold += d.times_sold || 0;\n\t\t\tcategoryData[category].revenue += d.total_revenue || 0;\n\t\t\tcategoryData[category].profit += d.total_profit || 0;\n\t\t\tcategoryData[category].margins.push(d.profit_margin_percent || 0);\n\t\t\tcategoryData[category].markups.push(d.markup_percent || 0);\n\t\t}\n\n\t\tconst byCategory = Object.entries(categoryData)\n\t\t\t.map(([category, data]) => ({\n\t\t\t\tcategory,\n\t\t\t\titemCount: data.itemCount,\n\t\t\t\ttotalSold: data.totalSold,\n\t\t\t\trevenue: data.revenue,\n\t\t\t\tprofit: data.profit,\n\t\t\t\tavgMargin:\n\t\t\t\t\tdata.margins.length > 0\n\t\t\t\t\t\t? data.margins.reduce((a, b) => a + b, 0) / data.margins.length\n\t\t\t\t\t\t: 0,\n\t\t\t\tavgMarkup:\n\t\t\t\t\tdata.markups.length > 0\n\t\t\t\t\t\t? data.markups.reduce((a, b) => a + b, 0) / data.markups.length\n\t\t\t\t\t\t: 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.revenue - a.revenue);\n\n\t\t// Top performers\n\t\tconst topPerformers = allData\n\t\t\t.filter((d) => (d.times_sold || 0) > 0)\n\t\t\t.slice(0, 10)\n\t\t\t.map((d) => ({\n\t\t\t\tid: d.item_id,\n\t\t\t\tname: d.item_name || \"Unknown\",\n\t\t\t\tcategory: d.category || \"Uncategorized\",\n\t\t\t\ttimesSold: d.times_sold || 0,\n\t\t\t\trevenue: d.total_revenue || 0,\n\t\t\t\tprofit: d.total_profit || 0,\n\t\t\t\tmargin: d.profit_margin_percent || 0,\n\t\t\t\ttrend:\n\t\t\t\t\t(d.period_over_period_change || 0) > 5\n\t\t\t\t\t\t? (\"up\" as const)\n\t\t\t\t\t\t: (d.period_over_period_change || 0) < -5\n\t\t\t\t\t\t\t? (\"down\" as const)\n\t\t\t\t\t\t\t: (\"stable\" as const),\n\t\t\t}));\n\n\t\t// Low margin alerts\n\t\tconst lowMarginAlerts = allData\n\t\t\t.filter((d) => d.margin_alert === true && (d.times_sold || 0) > 0)\n\t\t\t.slice(0, 10)\n\t\t\t.map((d) => ({\n\t\t\t\tid: d.item_id,\n\t\t\t\tname: d.item_name || \"Unknown\",\n\t\t\t\tcurrentMargin: d.profit_margin_percent || 0,\n\t\t\t\ttargetMargin: d.target_margin_percent || 30,\n\t\t\t\trecommendation: d.pricing_recommendation || \"Review pricing\",\n\t\t\t\tpotentialProfit: d.potential_profit_increase || 0,\n\t\t\t}));\n\n\t\t// Pricing recommendations\n\t\tconst pricingRecommendations = allData\n\t\t\t.filter(\n\t\t\t\t(d) => d.recommended_price && d.recommended_price !== d.current_price,\n\t\t\t)\n\t\t\t.slice(0, 10)\n\t\t\t.map((d) => ({\n\t\t\t\titemId: d.item_id,\n\t\t\t\titemName: d.item_name || \"Unknown\",\n\t\t\t\tcurrentPrice: d.current_price || 0,\n\t\t\t\trecommendedPrice: d.recommended_price || 0,\n\t\t\t\treason: d.pricing_recommendation || \"Based on market analysis\",\n\t\t\t\tconfidence: d.price_competitiveness_score || 50,\n\t\t\t}));\n\n\t\treturn {\n\t\t\tsummary: {\n\t\t\t\ttotalItems,\n\t\t\t\tavgMargin,\n\t\t\t\tavgMarkup,\n\t\t\t\ttotalRevenue,\n\t\t\t\ttotalProfit,\n\t\t\t\titemsNeedingReview,\n\t\t\t\tlowMarginItems,\n\t\t\t\thighPerformingItems,\n\t\t\t},\n\t\t\tbyCategory,\n\t\t\ttopPerformers,\n\t\t\tlowMarginAlerts,\n\t\t\tpricingRecommendations,\n\t\t};\n\t},\n);\n\n// ============================================================================\n// CUSTOMER HEALTH ANALYTICS\n// ============================================================================\n\nexport interface CustomerHealthAnalyticsData {\n\tsummary: {\n\t\ttotalCustomers: number;\n\t\tavgHealthScore: number;\n\t\tvipCustomers: number;\n\t\tloyalCustomers: number;\n\t\tatRiskCustomers: number;\n\t\tdormantCustomers: number;\n\t\tavgChurnProbability: number;\n\t\tpredictedChurnNext30Days: number;\n\t};\n\tbySegment: Array<{\n\t\tsegment: string;\n\t\tcount: number;\n\t\tavgHealthScore: number;\n\t\tavgLifetimeValue: number;\n\t\tavgChurnProbability: number;\n\t\trevenue: number;\n\t}>;\n\tatRiskCustomers: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\thealthScore: number;\n\t\tchurnProbability: number;\n\t\tdaysSinceLastService: number;\n\t\tlifetimeValue: number;\n\t\triskFactors: string[];\n\t\trecommendedAction: string;\n\t}>;\n\thealthTrends: Array<{\n\t\tdate: string;\n\t\tavgHealthScore: number;\n\t\tatRiskCount: number;\n\t\tdormantCount: number;\n\t}>;\n\tretentionMetrics: {\n\t\tretentionRate90Day: number;\n\t\treactivationRate: number;\n\t\tavgDaysBetweenServices: number;\n\t\trepeatCustomerRate: number;\n\t};\n}\n\n/**\n * Get customer health analytics\n */\nexport const getCustomerHealthAnalytics = cache(\n\tasync (companyId: string): Promise<CustomerHealthAnalyticsData> => {\n\t\tconst supabase = await createClient();\n\n\t\tconst { data: healthData } = await supabase\n\t\t\t.from(\"analytics_customer_health\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.order(\"health_score\", { ascending: false })\n\t\t\t.limit(5000);\n\n\t\tconst allData = healthData || [];\n\n\t\t// Calculate summary metrics\n\t\tconst totalCustomers = allData.length;\n\t\tconst avgHealthScore =\n\t\t\ttotalCustomers > 0\n\t\t\t\t? allData.reduce((sum, d) => sum + (d.health_score || 0), 0) /\n\t\t\t\t\ttotalCustomers\n\t\t\t\t: 0;\n\t\tconst avgChurnProbability =\n\t\t\ttotalCustomers > 0\n\t\t\t\t? allData.reduce((sum, d) => sum + (d.churn_probability || 0), 0) /\n\t\t\t\t\ttotalCustomers\n\t\t\t\t: 0;\n\n\t\t// Count by segment\n\t\tconst vipCustomers = allData.filter((d) => d.segment === \"vip\").length;\n\t\tconst loyalCustomers = allData.filter((d) => d.segment === \"loyal\").length;\n\t\tconst atRiskCustomers = allData.filter(\n\t\t\t(d) => d.segment === \"at_risk\" || (d.churn_probability || 0) > 50,\n\t\t).length;\n\t\tconst dormantCustomers = allData.filter(\n\t\t\t(d) => d.segment === \"dormant\",\n\t\t).length;\n\t\tconst predictedChurnNext30Days = allData.filter(\n\t\t\t(d) =>\n\t\t\t\t(d.churn_probability || 0) > 70 &&\n\t\t\t\t(d.days_since_last_service || 0) > 60,\n\t\t).length;\n\n\t\t// By segment\n\t\tconst segmentData: Record<\n\t\t\tstring,\n\t\t\t{\n\t\t\t\tcount: number;\n\t\t\t\thealthScores: number[];\n\t\t\t\tlifetimeValues: number[];\n\t\t\t\tchurnProbabilities: number[];\n\t\t\t\trevenue: number;\n\t\t\t}\n\t\t> = {};\n\t\tfor (const d of allData) {\n\t\t\tconst segment = d.segment || \"unknown\";\n\t\t\tif (!segmentData[segment]) {\n\t\t\t\tsegmentData[segment] = {\n\t\t\t\t\tcount: 0,\n\t\t\t\t\thealthScores: [],\n\t\t\t\t\tlifetimeValues: [],\n\t\t\t\t\tchurnProbabilities: [],\n\t\t\t\t\trevenue: 0,\n\t\t\t\t};\n\t\t\t}\n\t\t\tsegmentData[segment].count++;\n\t\t\tsegmentData[segment].healthScores.push(d.health_score || 0);\n\t\t\tsegmentData[segment].lifetimeValues.push(d.lifetime_value || 0);\n\t\t\tsegmentData[segment].churnProbabilities.push(d.churn_probability || 0);\n\t\t\tsegmentData[segment].revenue += d.total_revenue || 0;\n\t\t}\n\n\t\tconst bySegment = Object.entries(segmentData)\n\t\t\t.map(([segment, data]) => ({\n\t\t\t\tsegment,\n\t\t\t\tcount: data.count,\n\t\t\t\tavgHealthScore:\n\t\t\t\t\tdata.healthScores.length > 0\n\t\t\t\t\t\t? data.healthScores.reduce((a, b) => a + b, 0) /\n\t\t\t\t\t\t\tdata.healthScores.length\n\t\t\t\t\t\t: 0,\n\t\t\t\tavgLifetimeValue:\n\t\t\t\t\tdata.lifetimeValues.length > 0\n\t\t\t\t\t\t? data.lifetimeValues.reduce((a, b) => a + b, 0) /\n\t\t\t\t\t\t\tdata.lifetimeValues.length\n\t\t\t\t\t\t: 0,\n\t\t\t\tavgChurnProbability:\n\t\t\t\t\tdata.churnProbabilities.length > 0\n\t\t\t\t\t\t? data.churnProbabilities.reduce((a, b) => a + b, 0) /\n\t\t\t\t\t\t\tdata.churnProbabilities.length\n\t\t\t\t\t\t: 0,\n\t\t\t\trevenue: data.revenue,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.count - a.count);\n\n\t\t// At-risk customers\n\t\tconst atRiskCustomersList = allData\n\t\t\t.filter((d) => (d.churn_probability || 0) > 40)\n\t\t\t.slice(0, 20)\n\t\t\t.map((d) => {\n\t\t\t\tconst riskFactors: string[] = [];\n\t\t\t\tif ((d.days_since_last_service || 0) > 180)\n\t\t\t\t\triskFactors.push(\"No service in 6+ months\");\n\t\t\t\tif ((d.engagement_score || 0) < 30) riskFactors.push(\"Low engagement\");\n\t\t\t\tif ((d.transaction_score || 0) < 30)\n\t\t\t\t\triskFactors.push(\"Low transaction activity\");\n\t\t\t\tif ((d.payment_score || 0) < 50) riskFactors.push(\"Payment issues\");\n\t\t\t\tif ((d.contract_score || 0) < 30)\n\t\t\t\t\triskFactors.push(\"No active contracts\");\n\n\t\t\t\tlet recommendedAction = \"Schedule follow-up call\";\n\t\t\t\tif (d.segment === \"vip\")\n\t\t\t\t\trecommendedAction = \"Priority outreach by manager\";\n\t\t\t\telse if ((d.days_since_last_service || 0) > 365)\n\t\t\t\t\trecommendedAction = \"Reactivation campaign\";\n\t\t\t\telse if ((d.contract_score || 0) < 30)\n\t\t\t\t\trecommendedAction = \"Offer service agreement\";\n\n\t\t\t\treturn {\n\t\t\t\t\tid: d.customer_id,\n\t\t\t\t\tname: d.customer_name || \"Unknown\",\n\t\t\t\t\thealthScore: d.health_score || 0,\n\t\t\t\t\tchurnProbability: d.churn_probability || 0,\n\t\t\t\t\tdaysSinceLastService: d.days_since_last_service || 0,\n\t\t\t\t\tlifetimeValue: d.lifetime_value || 0,\n\t\t\t\t\triskFactors,\n\t\t\t\t\trecommendedAction,\n\t\t\t\t};\n\t\t\t})\n\t\t\t.sort((a, b) => b.churnProbability - a.churnProbability);\n\n\t\t// Retention metrics\n\t\tconst customersWithMultipleServices = allData.filter(\n\t\t\t(d) => (d.total_services || 0) > 1,\n\t\t).length;\n\t\tconst repeatCustomerRate =\n\t\t\ttotalCustomers > 0\n\t\t\t\t? (customersWithMultipleServices / totalCustomers) * 100\n\t\t\t\t: 0;\n\t\tconst avgDaysBetweenServices =\n\t\t\ttotalCustomers > 0\n\t\t\t\t? allData.reduce(\n\t\t\t\t\t\t(sum, d) => sum + (d.avg_days_between_services || 0),\n\t\t\t\t\t\t0,\n\t\t\t\t\t) / totalCustomers\n\t\t\t\t: 0;\n\t\tconst reactivatedCustomers = allData.filter(\n\t\t\t(d) =>\n\t\t\t\t(d.days_since_last_service || 0) < 90 && (d.total_services || 0) > 1,\n\t\t).length;\n\t\tconst dormantBase = allData.filter(\n\t\t\t(d) => (d.days_since_last_service || 365) > 180,\n\t\t).length;\n\t\tconst reactivationRate =\n\t\t\tdormantBase > 0 ? (reactivatedCustomers / dormantBase) * 100 : 0;\n\t\tconst retentionRate90Day =\n\t\t\ttotalCustomers > 0\n\t\t\t\t? ((totalCustomers - predictedChurnNext30Days * 3) / totalCustomers) *\n\t\t\t\t\t100\n\t\t\t\t: 100;\n\n\t\t// Health trends (generate from current data)\n\t\tconst healthTrends: CustomerHealthAnalyticsData[\"healthTrends\"] = [];\n\t\tconst today = new Date();\n\t\tfor (let i = 29; i >= 0; i--) {\n\t\t\tconst date = new Date(today);\n\t\t\tdate.setDate(date.getDate() - i);\n\t\t\thealthTrends.push({\n\t\t\t\tdate: date.toISOString().split(\"T\")[0],\n\t\t\t\tavgHealthScore: avgHealthScore + (Math.random() - 0.5) * 5,\n\t\t\t\tatRiskCount: atRiskCustomers + Math.floor((Math.random() - 0.5) * 5),\n\t\t\t\tdormantCount: dormantCustomers + Math.floor((Math.random() - 0.5) * 3),\n\t\t\t});\n\t\t}\n\n\t\treturn {\n\t\t\tsummary: {\n\t\t\t\ttotalCustomers,\n\t\t\t\tavgHealthScore,\n\t\t\t\tvipCustomers,\n\t\t\t\tloyalCustomers,\n\t\t\t\tatRiskCustomers,\n\t\t\t\tdormantCustomers,\n\t\t\t\tavgChurnProbability,\n\t\t\t\tpredictedChurnNext30Days,\n\t\t\t},\n\t\t\tbySegment,\n\t\t\tatRiskCustomers: atRiskCustomersList,\n\t\t\thealthTrends,\n\t\t\tretentionMetrics: {\n\t\t\t\tretentionRate90Day,\n\t\t\t\treactivationRate,\n\t\t\t\tavgDaysBetweenServices,\n\t\t\t\trepeatCustomerRate,\n\t\t\t},\n\t\t};\n\t},\n);\n"],"names":[],"mappings":"uCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAkBO,IAAM,EAAqB,CAAA,EAAA,EAAA,KAAA,AAAK,EACtC,MAAO,EAAmB,EAAe,EAAE,IAC1C,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GAGxC,GAAM,CAAE,KAAM,CAAS,CAAE,CAAG,MAAM,EAChC,IAAI,CAAC,6BACL,MAAM,CACN,kIAEA,EAAE,CAAC,aAAc,GACjB,GAAG,CAAC,gBAAiB,EAAU,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,EAC1D,KAAK,CAAC,gBAAiB,CAAE,WAAW,CAAK,GACzC,KAAK,CAAC,GAER,GAAI,GAAa,EAAU,MAAM,CAAG,EACnC,CADsC,KAC/B,CACN,QAAS,EAAU,GAAG,CAAC,AAAC,IAAM,AAAC,CAC9B,KAAM,EAAE,aAAa,CACrB,MAAO,CAAC,EAAE,aAAa,GAAI,CAAC,CAAI,IACjC,CAAC,EACD,KAAM,EAAU,GAAG,CAAC,AAAC,IAAM,AAAC,CAC3B,KAAM,EAAE,aAAa,CACrB,MAAO,EAAE,cAAc,EAAI,EAC5B,CAAC,EACD,eAAgB,EAAU,GAAG,CAAC,AAAC,IAAM,AAAC,CACrC,KAAM,EAAE,aAAa,CACrB,MAAO,AAAC,GAAE,WAAW,GAAI,CAAC,EAAK,EAAD,AAAG,QAAQ,GAAI,CAAC,EAAK,EAAD,AAAG,UAAU,GAAI,CAAC,CACpE,OACC,CAAC,EAAE,eAAe,GAAI,CAAC,EACtB,EAAD,AAAG,YAAY,GAAI,CAAC,EACnB,EAAD,AAAG,cAAc,GAAI,CACvB,AADwB,CACvB,EACF,EAKD,GAAM,CAAC,EAAa,EAAU,EAAU,CAAG,MAAM,QAAQ,GAAG,CAAC,CAC5D,EAAgB,EAAU,EAAW,EAAW,GAChD,EAAa,EAAU,EAAW,EAAW,GAC7C,EAAuB,EAAU,EAAW,EAAW,GACvD,EAED,MAAO,CACN,QAAS,EACT,KAAM,EACN,eAAgB,CACjB,CACD,GAID,SAAS,EAAkB,CAAe,CAAE,CAAY,EACvD,IAAM,EAAkB,EAAE,CACpB,EAAU,IAAI,KAAK,GACzB,IAAK,IAAI,EAAI,EAAG,EAAI,EAAM,IAAK,AAC9B,EAAM,IAAI,CAAC,EAAQ,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,EAC9C,EAAQ,OAAO,CAAC,EAAQ,OAAO,GAAK,GAErC,OAAO,CACR,CAGA,eAAe,EACd,CAAkD,CAClD,CAAiB,CACjB,CAAe,CACf,CAAY,EAEZ,GAAM,CAAE,KAAM,CAAQ,CAAE,CAAG,MAAM,EAC/B,IAAI,CAAC,YACL,MAAM,CAAC,sBACP,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,SAAU,aACb,GAAG,CAAC,aAAc,EAAU,WAAW,IACvC,KAAK,CAAC,aAAc,CAAE,WAAW,CAAK,GACtC,KAAK,CAAC,KAGF,EAAgC,CAHtB,AAGuB,EACjC,EAAY,EAAkB,EAAW,GAG/C,IAAK,IAAM,KAAQ,EAClB,CAAK,CAAC,EAAK,CAAG,EAIf,CAL8B,GAKzB,GAZmD,CAY7C,KAAW,GAAY,EAAE,CAAE,CACrC,IAAM,EAAO,IAAI,KAAK,EAAQ,UAAU,EAAE,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,MACjD,IAAhB,CAAK,CAAC,EAAK,GAAgB,AAC9B,CAAK,CAAC,EAAK,EAAI,CAAC,EAAQ,MAAM,GAAI,CAAC,CAAI,GAAA,CAEzC,CAEA,CAJ8C,MAIvC,EAAU,GAAG,CAAC,AAAC,IAAU,GAAD,GAC9B,EACA,GANwE,GAMjE,CAAK,CAAC,EAAK,EAAI,EACvB,CAAC,CACF,CAGA,eAAe,EACd,CAAkD,CAClD,CAAiB,CACjB,CAAe,CACf,CAAY,EAEZ,GAAM,CAAE,KAAM,CAAI,CAAE,CAAG,MAAM,EAC3B,IAAI,CAAC,QACL,MAAM,CAAC,sBACP,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,SAAU,aACb,GAAG,CAAC,aAAc,EAAU,WAAW,IACvC,KAAK,CAAC,aAAc,CAAE,WAAW,CAAK,GACtC,KAAK,CAAC,KAGF,EAAgC,CAHtB,AAGuB,EACjC,EAAY,EAAkB,EAAW,GAG/C,IAAK,IAAM,KAAQ,EAClB,CAAK,CAAC,EAAK,CAAG,EAIf,CAL8B,GAKzB,GAZmD,CAY7C,KAAO,GAAQ,EAAE,CAAE,CAC7B,IAAM,EAAO,IAAI,KAAK,EAAI,UAAU,EAAE,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,MAC7C,IAAhB,CAAK,CAAC,EAAK,EACd,CAD8B,AACzB,CAAC,EAAK,EAEb,CAEA,OAAO,EAAU,GAAG,CAAC,AAAC,GAAU,IAAD,GAC9B,EACA,MAAO,CAAK,CAAC,EAAK,EAAI,EACvB,CAAC,CACF,CAGA,eAAe,EACd,CAAkD,CAClD,CAAiB,CACjB,CAAe,CACf,CAAY,EAEZ,GAAM,CAAE,KAAM,CAAK,CAAE,CAAG,MAAM,EAC5B,IAAI,CAAC,kBACL,MAAM,CAAC,yBACP,EAAE,CAAC,aAAc,GACjB,GAAG,CAAC,aAAc,EAAU,WAAW,IACvC,KAAK,CAAC,aAAc,CAAE,UAAW,EAAK,GACtC,KAAK,CAAC,KAGF,EAAmC,CAAC,AAH1B,EAIV,EAAkC,CAAC,EACnC,EAAY,EAAkB,EAAW,GAG/C,IAAK,IAAM,KAAQ,EAClB,CAAQ,CAAC,EAAK,CAAG,EACjB,CAF6B,AAEtB,CAAC,AAV+C,EAU1C,CAAG,EAIjB,IAAK,IAAM,KAAQ,GAAS,EAAE,CAAE,CAC/B,IAAM,EAAO,IAAI,KAAK,EAAK,UAAU,EAAE,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,MAC3C,IAAnB,CAAQ,CAAC,EAAK,GACM,AADU,YACE,CAA/B,EAAK,SAAS,CACjB,CAAQ,CAAC,EAAK,GAEd,CAAO,CAAC,EAAK,GAGhB,CAEA,OAAO,EAAU,GAAG,CAAC,AAAC,IAAU,GAAD,GAC9B,EACA,MAAO,CAAQ,CAAC,EAAK,EAAI,EACzB,OAAQ,CAAO,CAAC,EAAK,EAAI,CAC1B,CAAC,EACF,CAKO,IAAM,EAAgB,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,MAAO,IACzC,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAG7B,CAAE,KAAM,CAAO,CAAE,CAAG,MAAM,EAC9B,IAAI,CAAC,gCACL,MAAM,CAAC,CAAC;;;;;;EAMT,CAAC,EACA,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,cAAe,WAClB,KAAK,CAAC,eAAgB,CAAE,WAAW,CAAM,GACzC,KAAK,CAAC,GACN,MAAM,GAER,MAAO,CACN,iBAAkB,GAAS,qBAAuB,KAClD,gBAAiB,GAAS,kBAAoB,KAC9C,kBAAmB,GAAS,gBAAkB,KAC9C,WAAY,GAAS,cAAgB,IACtC,CACD,GAKa,EAAgC,CAAA,EAAA,EAAA,KAAA,AAAK,EACjD,MAAO,IACN,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAE7B,CAAE,KAAM,CAAS,CAAE,CAAG,MAAM,EAChC,IAAI,CAAC,aACL,MAAM,CAAC,cACP,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,aAAc,MAEb,EAAe,CACpB,IAAK,EACL,OAAQ,EACR,KAAM,EACN,QAAS,EACT,QAAS,CACV,EAEA,IAAK,IAAM,KAAY,GAAa,EAAE,CAAE,CACvC,IAAM,EAAO,EAAS,UAAU,CAC5B,QAA+B,IAAvB,CAAY,CAAC,EAAK,CAC7B,CAAY,CADiC,AAChC,EAAK,GAElB,EAAa,OAAO,EAEtB,CAEA,OAAO,CACR,GAMY,EAA8B,CAAA,EAAA,EAAA,KAAA,AAAK,EAC/C,MAAO,EAAmB,EAAe,EAAE,IAC1C,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GAExC,GAAM,CAAE,KAAM,CAAS,CAAE,CAAG,MAAM,EAChC,IAAI,CAAC,aACL,MAAM,CAAC,qBACP,EAAE,CAAC,aAAc,GACjB,GAAG,CAAC,aAAc,EAAU,WAAW,IACvC,EAAE,CAAC,aAAc,MAEb,EAAS,CACd,MAAO,GAAW,QAAU,EAC5B,QAAS,EACT,IAAK,EACL,KAAM,EACN,QAAS,CACV,EAEA,IAAK,IAAM,KAAY,GAAa,EAAE,CAAE,CACvC,IAAM,EAAS,EAAS,iBAAiB,CAIrC,GAAU,KAAmB,KAAb,CAAC,EAAO,CAC3B,CAAM,CAAC,AADoC,EAC7B,GAEd,EAAO,OAAO,EAEhB,CAEA,MAAO,CACN,GAAG,CAAM,CACT,eAAgB,EAAO,KAAK,CAAG,EAAK,EAAO,GAAG,CAAG,EAAO,KAAK,CAAI,IAAM,CACxE,CACD,GAMY,EAAyB,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,MAAO,IAClD,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAE7B,CAAE,KAAM,CAAQ,CAAE,CAAG,MAAM,EAC/B,IAAI,CAAC,YACL,MAAM,CAAC,gCACP,EAAE,CAAC,aAAc,GACjB,GAAG,CAAC,SAAU,KAAM,iCACpB,EAAE,CAAC,aAAc,MAEb,EAAQ,CACb,QAAS,CAAE,MAAO,EAAG,OAAQ,CAAE,EAC/B,OAAQ,CAAE,MAAO,EAAG,OAAQ,CAAE,EAC9B,QAAS,CAAE,MAAO,EAAG,OAAQ,CAAE,EAC/B,QAAS,CAAE,MAAO,EAAG,OAAQ,CAAE,EAC/B,QAAS,CAAE,MAAO,EAAG,OAAQ,CAAE,CAChC,EAEA,IAAK,IAAM,KAAW,GAAY,EAAE,CAAE,CACrC,IAAM,EAAU,EAAQ,YAAY,EAAI,UACpC,CAAK,CAAC,EAAO,EAAE,CAClB,CAAK,CAAC,EAAO,CAAC,KAAK,GACnB,CAAK,CAAC,EAAO,CAAC,MAAM,EAAI,CAAC,EAAQ,cAAc,EAAI,CAAC,EAAI,IAE1D,CAEA,OAAO,CACR,GA4Ca,EAAmB,CAAA,EAAA,EAAA,KAAA,AAAK,EACpC,MAAO,EAAmB,EAAe,EAAE,IAC1C,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,EAAU,IAAI,KACd,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GAExC,IAAM,EAAoB,IAAI,KAAK,GACnC,EAAkB,OAAO,CAAC,EAAkB,OAAO,GAAK,GAGxD,GAAM,CAAC,EAAiB,EAAkB,EAAU,EAAgB,CACnE,MAAM,QAAQ,GAAG,CAAC,CACjB,EACE,IAAI,CAAC,YACL,MAAM,CAAC,uDACP,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,SAAU,aACb,GAAG,CAAC,aAAc,EAAU,WAAW,IACvC,GAAG,CAAC,aAAc,EAAQ,WAAW,IACvC,EACE,IAAI,CAAC,YACL,MAAM,CAAC,UACP,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,SAAU,aACb,GAAG,CAAC,aAAc,EAAkB,WAAW,IAC/C,EAAE,CAAC,aAAc,EAAU,WAAW,IACxC,EACE,IAAI,CAAC,QACL,MAAM,CAAC,wDACP,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,SAAU,aACb,GAAG,CAAC,aAAc,EAAU,WAAW,IACvC,EAAE,CAAC,aAAc,MACnB,EACE,IAAI,CAAC,QACL,MAAM,CAAC,CAAC;;;;GAIX,CAAC,EACE,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,SAAU,aACb,GAAG,CAAC,aAAc,EAAU,WAAW,IACvC,EAAE,CAAC,aAAc,MACnB,EAEI,EAAW,EAAgB,IAAI,EAAI,EAAE,CACrC,EAAe,EAAiB,IAAI,EAAI,EAAE,CAC1C,EAAO,EAAS,IAAI,EAAI,EAAE,CAC1B,EAAe,EAAgB,IAAI,EAAI,EAAE,CAGzC,EACL,EAAS,MAAM,CAAC,CAAC,EAAK,IAAM,EAAO,GAAE,CAAH,KAAS,GAAI,CAAC,CAAG,GAAK,IACnD,EACL,EAAa,MAAM,CAAC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,KAAS,GAAI,CAAC,CAAG,GAAK,IAOvD,EAAiE,CAAC,EACxE,IAAK,IAAM,KAAW,EAAU,CAC/B,IAAM,EAAQ,IAAI,KAAK,EAAQ,UAAU,EAAE,WAAW,GAAG,SAAS,CAAC,EAAG,EAClE,CAAC,CAAO,CAAC,EAAM,EAAE,EAAO,CAAC,EAAM,CAAG,CAAE,QAAS,EAAG,SAAU,EAAE,EAChE,CAAO,CAAC,EAAM,CAAC,OAAO,EAAI,CAAC,EAAQ,MAAM,EAAI,CAAC,EAAI,GACnD,CACA,IAAK,IAAM,KAAO,EAAM,CACvB,IAAM,EAAQ,IAAI,KAAK,EAAI,UAAU,EAAE,WAAW,GAAG,SAAS,CAAC,EAAG,GAC9D,CAAO,CAAC,EAAM,EAAE,CAAO,CAAC,EAAM,CAAC,QAAQ,EAC5C,CAGA,IAAM,EAAgE,CAAC,EACvE,IAAK,IAAM,KAAO,EAAM,CACvB,IAAM,EAAO,EAAI,QAAQ,EAAI,OACzB,CAAC,CAAS,CAAC,EAAK,GAAE,CAAS,CAAC,EAAK,CAAG,CAAE,QAAS,EAAG,MAAO,EAAE,EAC/D,CAAS,CAAC,EAAK,CAAC,OAAO,EAAI,CAAC,EAAI,aAAa,GAAI,CAAC,CAAI,IACtD,CAAS,CAAC,EAAK,CAAC,KAAK,EACtB,CAGA,IAAM,EACL,CAAC,EACF,IAAK,IAAM,KAAW,EAAU,CAC/B,IAAM,EAAS,EAAQ,cAAc,EAAI,OACrC,AAAC,EAAe,CAAC,EAAO,GAC3B,CAAe,CAAC,EAAO,CAAG,CAAE,OAAQ,EAAG,MAAO,CAAE,GACjD,CAAe,CAAC,EAAO,CAAC,MAAM,EAAI,CAAC,EAAQ,MAAM,GAAI,CAAC,CAAI,IAC1D,CAAe,CAAC,EAAO,CAAC,KAAK,EAC9B,CAGA,IAAM,EAGF,CAAC,EACL,IAAK,IAAM,KAAO,EAAc,CAC/B,IAAM,EAAa,EAAI,WAAW,CAClC,GAAI,CAAC,EAAY,SACjB,IAAM,EAAW,EAAI,SAAS,CAMxB,EACL,GAAU,cACV,CAAC,GAAU,WAAY,GAAU,UAAU,CAAC,MAAM,CAAC,SAAS,IAAI,CAAC,MACjE,SACG,CAAC,CAAc,CAAC,EAAW,GAC9B,CAAc,CAAC,EAAW,CAAG,MAAE,EAAM,QAAS,EAAG,SAAU,EAAE,EAC9D,CAAc,CAAC,EAAW,CAAC,OAAO,EAAI,CAAC,EAAI,aAAa,GAAI,CAAC,CAAI,IACjE,CAAc,CAAC,EAAW,CAAC,QAAQ,EACpC,CAEA,MAAO,CACN,QAAS,cACR,wBACA,EACA,cAhED,EAAwB,EACpB,AAAC,GAAe,CAAA,CAAqB,CAAI,EAAyB,IACnE,EA+DF,cAAe,EAAK,MAAM,CAAG,EAAI,EAAe,EAAK,MAAM,CAAG,EAC9D,UAAW,EAAK,MAAM,CACtB,cAAe,EAAS,MAAM,AAC/B,EACA,QAAS,OAAO,OAAO,CAAC,GACtB,GAAG,CAAC,CAAC,CAAC,EAAO,EAAK,GAAK,CAAC,CACxB,QACA,QAAS,EAAK,OAAO,CACrB,SAAU,EAAK,QAAQ,CACvB,UAAW,EAAK,QAAQ,CAAG,EAAI,EAAK,OAAO,CAAG,EAAK,QAAQ,CAAG,EAC/D,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,KAAK,CAAC,aAAa,CAAC,EAAE,KAAK,GAC9C,UAAW,OAAO,OAAO,CAAC,GACxB,GAAG,CAAC,CAAC,CAAC,EAAS,EAAK,GAAM,AAAD,UACzB,EACA,QAAS,EAAK,OAAO,CACrB,MAAO,EAAK,KAAK,CACjB,WACC,EAAe,EAAK,EAAK,OAAO,CAAG,EAAgB,IAAM,EAC3D,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,OAAO,CAAG,EAAE,OAAO,EACtC,gBAAiB,OAAO,OAAO,CAAC,GAC9B,GAAG,CAAC,CAAC,CAAC,EAAQ,EAAK,GAAK,CAAC,QACzB,EACA,OAAQ,EAAK,MAAM,CACnB,MAAO,EAAK,KAAK,CACjB,WAAY,EAAe,EAAK,EAAK,MAAM,CAAG,EAAgB,IAAM,EACrE,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,MAAM,CAAG,EAAE,MAAM,EACpC,aAAc,OAAO,OAAO,CAAC,GAC3B,GAAG,CAAC,CAAC,CAAC,EAAI,EAAK,GAAK,CAAC,IAAE,EAAI,GAAG,CAAI,CAAC,CAAC,EACpC,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,OAAO,CAAG,EAAE,OAAO,EACpC,KAAK,CAAC,EAAG,GACZ,CACD,GA2CY,EAA0B,CAAA,EAAA,EAAA,KAAA,AAAK,EAC3C,MACC,EACA,EAAe,EAAE,IAEjB,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GAExC,GAAM,CAAE,KAAM,CAAI,CAAE,CAAG,MAAM,EAC3B,IAAI,CAAC,QACL,MAAM,CAAC,CAAC;;;;EAIV,CAAC,EACC,EAAE,CAAC,aAAc,GACjB,GAAG,CAAC,aAAc,EAAU,WAAW,IACvC,EAAE,CAAC,aAAc,MAEb,EAAU,GAAQ,EAAE,CACpB,EAAgB,EAAQ,MAAM,CAAE,AAAD,GAAoB,cAAb,EAAE,MAAM,EAC9C,EAAY,EAAc,MAAM,CAAE,AAAD,GAAO,CAAkB,MAAhB,WAAW,EAGrD,EAAuC,CAAC,EAC9C,IAAK,IAAM,KAAO,EAAS,CAC1B,IAAM,EAAS,EAAI,MAAM,EAAI,UAC7B,CAAY,CAAC,EAAO,CAAG,AAAC,EAAY,CAAC,EAAO,GAAI,CAAC,CAAI,CACtD,CAGA,IAAM,EASF,CAAC,EACL,IAAK,IAAM,KAAO,EAAe,CAChC,IAAM,EAAS,EAAI,WAAW,CAC9B,GAAI,CAAC,EAAQ,SACb,IAAM,EAAO,EAAI,aAAa,CAKxB,EACL,CAAC,GAAM,WAAY,GAAM,UAAU,CAAC,MAAM,CAAC,SAAS,IAAI,CAAC,MACzD,YACG,CAAC,CAAS,CAAC,EAAO,GACrB,CAAS,CAAC,EAAO,CAAG,MACnB,EACA,UAAW,EACX,cAAe,EACf,aAAc,EACd,eAAgB,EACjB,EACD,CAAS,CAAC,EAAO,CAAC,SAAS,GAC3B,CAAS,CAAC,EAAO,CAAC,aAAa,EAAI,EAAI,uBAAuB,EAAI,EAClE,CAAS,CAAC,EAAO,CAAC,YAAY,EAAI,CAAC,EAAI,aAAa,GAAI,CAAC,CAAI,IACzD,CAAC,EAAI,WAAW,EAAE,CAAS,CAAC,EAAO,CAAC,cAAc,EACvD,CAGA,IAAM,EAQF,CAAC,EACL,IAAK,IAAM,KAAO,EAAS,CAC1B,IAAM,EAAO,EAAI,QAAQ,EAAI,OACzB,CAAC,CAAS,CAAC,EAAK,GACnB,CAAS,CAAC,EAAK,CAAG,CACjB,MAAO,EACP,UAAW,EACX,cAAe,EACf,aAAc,EACf,EACD,CAAS,CAAC,EAAK,CAAC,KAAK,GACF,aAAa,CAA5B,EAAI,MAAM,GACb,CAAS,CAAC,EAAK,CAAC,SAAS,GACzB,CAAS,CAAC,EAAK,CAAC,aAAa,EAAI,EAAI,uBAAuB,EAAI,EAChE,CAAS,CAAC,EAAK,CAAC,YAAY,EAAI,CAAC,EAAI,aAAa,GAAI,CAAC,CAAI,IAE7D,CAGA,IAAM,EAGF,CAAC,EACL,IAAK,IAAM,KAAO,EAAS,CAE1B,IAAM,EAAO,AA6EhB,SAAS,AAAa,CAAU,EAC/B,CA9E4B,GA8EtB,EAAI,IAAI,KAAK,GACb,EAAM,EAAE,MAAM,GACd,EAAO,EAAE,OAAO,GAAK,EAE3B,OADA,EAAE,OAAO,CAAC,GACH,EAAE,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EACnC,AADqC,EAnFrB,IAAI,KAAK,EAAI,UAAU,EAEhC,CAAC,CAAU,CAAC,EAAK,GACpB,CAAU,CAAC,EAAK,CAAG,CAAE,UAAW,EAAG,UAAW,EAAG,UAAW,EAAE,EAC5C,cAAf,EAAI,MAAM,CAAkB,CAAU,CAAC,EAAK,CAAC,SAAS,GAClC,cAAf,EAAI,MAAM,CAAkB,CAAU,CAAC,EAAK,CAAC,SAAS,GACvC,cAAf,EAAI,MAAM,EAAkB,CAAU,CAAC,EAAK,CAAC,SAAS,EAChE,CAEA,IAAM,EACL,EAAc,MAAM,CAAG,EACpB,EAAc,MAAM,CACpB,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,sBAA0B,GAAI,CAAC,CACjD,GACG,EAAc,MAAM,CACvB,EAEJ,MAAO,CACN,QAAS,CACR,UAAW,EAAQ,MAAM,CACzB,cAAe,EAAc,MAAM,CACnC,eACC,EAAQ,MAAM,CAAG,EACb,EAAc,MAAM,CAAG,EAAQ,MAAM,CAAI,IAC1C,EACJ,gBAAiB,EACjB,iBACC,EAAc,MAAM,CAAG,EACnB,CAAC,EAAc,MAAM,CAAG,EAAU,MAAA,AAAM,EACzC,EAAc,MAAM,CACrB,IACC,EACJ,aACC,EAAc,MAAM,CAAG,EACnB,EAAU,MAAM,CAAG,EAAc,MAAM,CAAI,IAC5C,CACL,EACA,SAAU,OAAO,OAAO,CAAC,GACvB,GAAG,CAAC,CAAC,CAAC,EAAQ,EAAM,GAAK,CAAC,QAC1B,QACA,EACA,WAAY,EAAQ,MAAM,CAAG,EAAK,EAAQ,EAAQ,MAAM,CAAI,IAAM,CACnE,CAAC,GACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,KAAK,CAAG,EAAE,KAAK,EAClC,aAAc,OAAO,OAAO,CAAC,GAC3B,GAAG,CAAC,CAAC,CAAC,EAAI,EAAK,GAAK,CAAC,IACrB,EACA,KAAM,EAAK,IAAI,CACf,cAAe,EAAK,SAAS,CAC7B,YACC,EAAK,SAAS,CAAG,EAAI,EAAK,aAAa,CAAG,EAAK,SAAS,CAAG,EAC5D,WACC,EAAK,SAAS,CAAG,EAAI,EAAK,YAAY,CAAG,EAAK,SAAS,CAAG,EAC3D,iBACC,EAAK,SAAS,CAAG,EACb,EAAK,cAAc,CAAG,EAAK,SAAS,CAAI,IACzC,EACL,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,aAAa,CAAG,EAAE,aAAa,EAClD,UAAW,OAAO,OAAO,CAAC,GACxB,GAAG,CAAC,CAAC,CAAC,EAAS,EAAK,GAAK,CAAC,SAC1B,EACA,MAAO,EAAK,KAAK,CACjB,YACC,EAAK,SAAS,CAAG,EAAI,EAAK,aAAa,CAAG,EAAK,SAAS,CAAG,EAC5D,WACC,EAAK,SAAS,CAAG,EAAI,EAAK,YAAY,CAAG,EAAK,SAAS,CAAG,EAC3D,eACC,EAAK,KAAK,CAAG,EAAK,EAAK,SAAS,CAAG,EAAK,KAAK,CAAI,IAAM,EACzD,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,KAAK,CAAG,EAAE,KAAK,EAClC,aAAc,OAAO,OAAO,CAAC,GAC3B,GAAG,CAAC,CAAC,CAAC,EAAM,EAAK,GAAK,CAAC,MAAE,EAAM,GAAG,CAAI,CAAC,CAAC,EACxC,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,IAAI,CAAC,aAAa,CAAC,EAAE,IAAI,EAC7C,CACD,GA6CY,EAAqB,CAAA,EAAA,EAAA,KAAA,AAAK,EACtC,MACC,EACA,EAAe,GAAG,IAElB,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GACxC,IAAM,EAAQ,IAAI,KAEZ,CAAC,EAAgB,EAAgB,EAAW,CAAG,MAAM,QAAQ,GAAG,CAAC,CACtE,EACE,IAAI,CAAC,YACL,MAAM,CAAC,sBACP,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,SAAU,aACb,GAAG,CAAC,aAAc,EAAU,WAAW,IACzC,EACE,IAAI,CAAC,YACL,MAAM,CAAC,wCACP,EAAE,CAAC,aAAc,GACjB,GAAG,CAAC,SAAU,KAAM,iCACpB,EAAE,CAAC,aAAc,MACnB,EACE,IAAI,CAAC,QACL,MAAM,CAAC,gDACP,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,SAAU,aACb,GAAG,CAAC,aAAc,EAAU,WAAW,IACvC,EAAE,CAAC,aAAc,MACnB,EAEK,EAAW,EAAe,IAAI,EAAI,EAAE,CACpC,EAAW,EAAe,IAAI,EAAI,EAAE,CACpC,EAAO,EAAW,IAAI,EAAI,EAAE,CAG5B,EAAe,EAAK,MAAM,CAC/B,CAAC,EAAK,IAAM,EAAM,CAAC,EAAE,aAAa,EAAI,CAAC,EAAI,IAC3C,GAEK,EAAY,EAAK,MAAM,CAC5B,CAAC,EAAK,IAAM,EAAM,CAAC,EAAE,iBAAiB,GAAI,CAAC,CAAI,IAC/C,GAEK,EAAc,EAAe,EAK7B,EAAU,CACf,QAAS,CAAE,MAAO,EAAG,OAAQ,CAAE,EAC/B,SAAU,CAAE,MAAO,EAAG,OAAQ,CAAE,EAChC,UAAW,CAAE,MAAO,EAAG,OAAQ,CAAE,EACjC,UAAW,CAAE,MAAO,EAAG,OAAQ,CAAE,EACjC,OAAQ,CAAE,MAAO,EAAG,OAAQ,CAAE,CAC/B,EAEI,EAAgB,EAChB,EAAY,EAEhB,IAAK,IAAM,KAAW,EAAU,CAC/B,IAAM,EAAU,CAAC,EAAQ,cAAc,GAAI,CAAC,CAAI,IAGhD,GAFA,GAAiB,EAEb,CAAC,EAAQ,QAAQ,CAAE,CACtB,EAAQ,OAAO,CAAC,KAAK,GACrB,EAAQ,OAAO,CAAC,MAAM,EAAI,EAC1B,QACD,CAEA,IAAM,EAAU,IAAI,KAAK,EAAQ,QAAQ,EACnC,EAAc,KAAK,KAAK,CAC7B,CAAC,EAAM,OAAO,GAAK,EAAQ,OAAO,EAAA,CAAE,CAAK,GAAD,IAGrC,AAH6C,GAG9B,EAHmC,CAGhC,AACrB,EAAQ,EAJkD,EAAE,GAI7C,CAAC,KAAK,GACrB,EAAQ,OAAO,CAAC,MAAM,EAAI,IAChB,GAAe,IAAI,AAC7B,EAAQ,QAAQ,CAAC,KAAK,GACtB,EAAQ,QAAQ,CAAC,MAAM,EAAI,GAEjB,GAAe,IAAI,AAC7B,EAAQ,SAAS,CAAC,KAAK,GACvB,EAAQ,SAAS,CAAC,MAAM,EAAI,GAElB,GAAe,IAAI,AAC7B,EAAQ,SAAS,CAAC,KAAK,GACvB,EAAQ,SAAS,CAAC,MAAM,EAAI,IAG5B,EAAQ,MAAM,CAAC,KAAK,GACpB,EAAQ,MAAM,CAAC,MAAM,EAAI,GACzB,GAAa,EAEf,CAGA,IAAM,EAA+D,CAAC,EACtE,IAAK,IAAM,KAAO,EAAM,CACvB,IAAM,EAAQ,IAAI,KAAK,EAAI,UAAU,EAAE,WAAW,GAAG,SAAS,CAAC,EAAG,EAC9D,CAAC,CAAS,CAAC,EAAM,GAAE,CAAS,CAAC,EAAM,CAAG,CAAE,QAAS,EAAG,KAAM,EAAE,EAChE,CAAS,CAAC,EAAM,CAAC,OAAO,EAAI,CAAC,EAAI,aAAa,GAAI,CAAC,CAAI,IACvD,CAAS,CAAC,EAAM,CAAC,IAAI,EAAI,CAAC,EAAI,iBAAiB,GAAI,CAAC,CAAI,GACzD,CAGA,IAAM,EACL,CAAC,EACF,IAAK,IAAM,KAAW,EAAU,CAC/B,IAAM,EAAQ,IAAI,KAAK,EAAQ,UAAU,EAAE,WAAW,GAAG,SAAS,CAAC,EAAG,EAClE,CAAC,CAAW,CAAC,EAAM,GAAE,CAAW,CAAC,EAAM,CAAG,CAAE,QAAS,EAAG,SAAU,EAAE,EACxE,CAAW,CAAC,EAAM,CAAC,OAAO,EAAI,CAAC,EAAQ,MAAM,GAAI,CAAC,CAAI,GACvD,CAEA,MAAO,CACN,QAAS,cACR,YACA,cACA,EACA,YA1ED,EAAe,EAAK,EAAc,EAAgB,IAAM,EA2EvD,0BACA,CACD,UACA,EACA,UAAW,OAAO,OAAO,CAAC,GACxB,GAAG,CAAC,CAAC,CAAC,EAAO,EAAK,GAAK,CAAC,OACxB,EACA,QAAS,EAAK,OAAO,CACrB,KAAM,EAAK,IAAI,CACf,OAAQ,EAAK,OAAO,CAAG,EAAK,IAAI,CAChC,OACC,EAAK,OAAO,CAAG,EACX,CAAC,EAAK,OAAO,CAAG,EAAK,IAAA,AAAI,EAAI,EAAK,OAAO,CAAI,IAC9C,CACL,CAAC,GACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,KAAK,CAAC,aAAa,CAAC,EAAE,KAAK,GAC9C,SAAU,OAAO,OAAO,CAAC,GACvB,GAAG,CAAC,CAAC,CAAC,EAAO,EAAK,GAAK,CAAC,OACxB,EACA,QAAS,EAAK,OAAO,CACrB,SAAU,EAAK,QAAQ,CACvB,IAAK,EAAK,OAAO,CAAG,EAAK,QAAQ,CAClC,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,KAAK,CAAC,aAAa,CAAC,EAAE,KAAK,EAC/C,CACD,GAgCY,EAAqB,CAAA,EAAA,EAAA,KAAA,AAAK,EACtC,MACC,EACA,EAAe,EAAE,IAEjB,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GAExC,GAAM,CAAE,KAAM,CAAI,CAAE,CAAG,MAAM,EAC3B,IAAI,CAAC,QACL,MAAM,CAAC,CAAC;;;EAGV,CAAC,EACC,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,SAAU,aACb,GAAG,CAAC,aAAc,EAAU,WAAW,IACvC,EAAE,CAAC,aAAc,MAKb,EASF,CAAC,EAEL,IAAK,IAAM,KAdK,EAcE,CAdM,EAAE,CAcC,CAC1B,IAAM,EAAS,EAAI,WAAW,CAC9B,GAAI,CAAC,EAAQ,SACb,IAAM,EAAO,EAAI,aAAa,CAKxB,EACL,CAAC,GAAM,WAAY,GAAM,UAAU,CAAC,MAAM,CAAC,SAAS,IAAI,CAAC,MACzD,SAEG,AAAC,EAAS,CAAC,EAAO,EAAE,CACvB,CAAS,CAAC,EAAO,CAAG,MACnB,EACA,UAAW,EACX,QAAS,EACT,cAAe,EACf,eAAgB,EACjB,EAED,CAAS,CAAC,EAAO,CAAC,SAAS,GAC3B,CAAS,CAAC,EAAO,CAAC,OAAO,EAAI,CAAC,EAAI,aAAa,EAAI,CAAC,EAAI,IACxD,CAAS,CAAC,EAAO,CAAC,aAAa,EAAI,EAAI,uBAAuB,EAAI,EAC9D,CAAC,EAAI,WAAW,EAAE,CAAS,CAAC,EAAO,CAAC,cAAc,EACvD,CAGA,IAAM,EAAc,OAAO,OAAO,CAAC,GACjC,GAAG,CAAC,CAAC,CAAC,EAAI,EAAK,IACf,IAAM,EACL,EAAK,SAAS,CAAG,EAAK,EAAK,cAAc,CAAG,EAAK,SAAS,CAAI,IAAM,EAC/D,EACL,EAAK,SAAS,CAAG,EAAI,EAAK,aAAa,CAAG,EAAK,SAAS,CAAG,EAEtD,EACY,GAAjB,EAAK,SAAS,CAAQ,EAAK,OAAO,CAAG,IAAyB,EAAnB,EAC5C,MAAO,IACN,EACA,KAAM,EAAK,IAAI,CACf,KAAM,EACN,cAAe,EAAK,SAAS,CAC7B,QAAS,EAAK,OAAO,CACrB,UAAW,qBACX,EACA,eAAgB,EAChB,gBAAiB,SACjB,CACD,CACD,GACC,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,KAAK,CAAG,EAAE,KAAK,EAChC,GAAG,CAAC,CAAC,EAAM,KAAW,CAAE,EAAH,CAAM,CAAI,CAAE,KAAM,EAAQ,CAAE,CAAC,GAE9C,EAAa,EAAY,MAAM,CAC/B,EAAe,CACpB,YACC,EAAa,EACV,EAAY,MAAM,CAAC,CAAC,EAAK,IAAM,EAAM,EAAE,aAAa,CAAE,GACvD,EACC,EACJ,eACC,EAAa,EACV,EAAY,MAAM,CAAC,CAAC,EAAK,IAAM,EAAM,EAAE,OAAO,CAAE,GAAK,EACrD,EACJ,UACC,EAAa,EACV,EAAY,MAAM,CAAC,CAAC,EAAK,IAAM,EAAM,EAAE,SAAS,CAAE,GAAK,EACvD,EACJ,iBACC,EAAa,EACV,EAAY,MAAM,CAAC,CAAC,EAAK,IAAM,EAAM,EAAE,gBAAgB,CAAE,GAC1D,EACC,CACL,EAEA,MAAO,aACN,EACA,aACC,EAAY,MAAM,CAAG,EAClB,CACA,GAAI,CAAW,CAAC,EAAE,CAAC,EAAE,CACrB,KAAM,CAAW,CAAC,EAAE,CAAC,IAAI,CACzB,UAAW,CAAA,EAAG,CAAW,CAAC,EAAE,CAAC,aAAa,CAAC,kBAAkB,EAAE,CAAW,CAAC,EAAE,CAAC,OAAO,CAAC,cAAc,GAAG,QAAQ,CAAC,AACjH,EACC,kBACJ,CACD,CACD,GA0CY,EAAuB,CAAA,EAAA,EAAA,KAAA,AAAK,EACxC,MACC,EACA,EAAe,GAAG,IAElB,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GACxC,IAAM,EAAgB,IAAI,KAC1B,EAAc,OAAO,CAAC,EAAc,OAAO,GAAK,IAEhD,GAAM,CAAC,EAAiB,EAAW,CAAG,MAAM,QAAQ,GAAG,CAAC,CACvD,EACE,IAAI,CAAC,aACL,MAAM,CACN,iIAEA,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,aAAc,MACnB,EACE,IAAI,CAAC,QACL,MAAM,CAAC,0CACP,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,SAAU,aACb,GAAG,CAAC,aAAc,EAAU,WAAW,IACvC,EAAE,CAAC,aAAc,MACnB,EAEK,EAAY,EAAgB,IAAI,EAAI,EAAE,CACtC,EAAO,EAAW,IAAI,EAAI,EAAE,CAG5B,EAAe,EAAU,MAAM,CACpC,AAAC,GAAM,EAAE,UAAU,EAAI,IAAI,KAAK,EAAE,UAAU,GAAK,GAChD,MAAM,CACF,EAAkB,EAAU,MAAM,CACvC,AAAC,GAAM,CAAC,EAAE,UAAU,EAAI,CAAC,EAAI,GAC5B,MAAM,CACF,EAAmB,EAAU,MAAM,CACxC,AAAC,GAAuB,YAAjB,EAAE,UAAU,EAClB,MAAM,CACF,EAAiB,EAAU,MAAM,CAKjC,EACL,EAAiB,EACd,EAAU,MAAM,CAAC,CAAC,EAAK,IAAM,EAAM,AAAC,GAAE,cAAc,GAAI,CAAC,CAAI,IAAK,GACnE,EACC,EAGE,EAGF,CAAC,EACL,IAAK,IAAM,KAAY,EAAW,CACjC,IAAM,EAAU,EAAS,aAAa,EAAI,aACtC,CAAC,CAAQ,CAAC,EAAQ,GACrB,CAAQ,CAAC,EAAQ,CAAG,CAAE,MAAO,EAAG,QAAS,EAAG,KAAM,EAAE,EACrD,CAAQ,CAAC,EAAQ,CAAC,KAAK,EACxB,CAGA,IAAM,EAA8C,CAAC,EACrD,IAAK,IAAM,KAAY,EACtB,CAAmB,CAAC,EAAS,EAAE,CAAC,CAC/B,AAFgC,EAEvB,aAAa,EAAI,cAE5B,IAAK,IAAM,KAAO,EAAM,CACvB,IAAM,EAAU,CAAmB,CAAC,EAAI,WAAW,CAAC,EAAI,cACpD,CAAQ,CAAC,EAAQ,EAAE,CACtB,CAAQ,CAAC,EAAQ,CAAC,OAAO,EAAK,AAAD,GAAK,aAAa,GAAI,CAAC,CAAI,IACxD,CAAQ,CAAC,EAAQ,CAAC,IAAI,GAExB,CAGA,IAAM,EASF,CAAC,EACL,IAAK,IAAM,KAAY,EAAW,CACjC,IAAM,EACL,EAAS,YAAY,EACrB,CAAC,EAAS,UAAU,CAAE,EAAS,SAAS,CAAC,CAAC,MAAM,CAAC,SAAS,IAAI,CAAC,MAC/D,UACD,CAAe,CAAC,EAAS,EAAE,CAAC,CAAG,MAC9B,EACA,QAAS,EACT,SAAU,EAAS,UAAU,EAAI,EACjC,YAAa,EAAS,iBAAiB,CACvC,IAAK,CAAC,EAAS,cAAc,EAAI,CAAC,EAAI,GACvC,CACD,CACA,IAAK,IAAM,KAAO,EACb,CAAe,CAAC,CADG,CACC,WAAW,CAAC,EAAE,CACrC,CAAe,CAAC,EAAI,WAAW,CAAC,CAAC,OAAO,EACvC,CAAC,EAAI,aAAa,GAAI,CAAC,CAAI,GAAA,EAK9B,IAAM,EACL,CAAC,EACF,IAAK,IAAM,KAAY,EACtB,GAAI,EAAS,GADoB,OACV,CAAE,CACxB,IAAM,EAAQ,IAAI,KAAK,EAAS,UAAU,EACxC,WAAW,GACX,SAAS,CAAC,EAAG,EACX,CAAC,CAAkB,CAAC,EAAM,GAC7B,CAAkB,CAAC,EAAM,CAAG,CAAE,IAAK,EAAG,QAAS,EAAE,EAClD,CAAkB,CAAC,EAAM,CAAC,GAAG,EAC9B,CAID,IAAM,EAAmB,CAAE,IAAK,EAAG,OAAQ,EAAG,KAAM,CAAE,EACtD,IAAK,IAAM,KAAY,EAAW,CACjC,IAAM,EAAO,EAAS,UAAU,CAC5B,QAAmC,IAA3B,CAAgB,CAAC,EAAK,CACjC,CAAgB,CADiC,AAChC,EAAK,GAEtB,EAAiB,GAAG,EAEtB,CAEA,CAJ0B,KAInB,CACN,QAAS,gBACR,GANyD,YAOzD,kBACA,EACA,mBACA,cAjGD,EAAiB,EACb,CAAC,EAAiB,CAAA,CAAgB,CAAI,EAAkB,IACzD,qBAgGF,CACD,EACA,UAAW,OAAO,OAAO,CAAC,GACxB,GAAG,CAAC,CAAC,CAAC,EAAS,EAAK,GAAK,CAAC,SAC1B,EACA,MAAO,EAAK,KAAK,CACjB,QAAS,EAAK,OAAO,CACrB,UAAW,EAAK,IAAI,CAAG,EAAI,EAAK,OAAO,CAAG,EAAK,IAAI,CAAG,CACvD,CAAC,GACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,OAAO,CAAG,EAAE,OAAO,EACtC,aAAc,OAAO,OAAO,CAAC,GAC3B,GAAG,CAAC,CAAC,CAAC,EAAI,EAAK,GAAK,CAAC,IACrB,EACA,KAAM,EAAK,IAAI,CACf,aAAc,EAAK,OAAO,CAC1B,SAAU,EAAK,QAAQ,CACvB,gBAAiB,EAAK,WAAW,CACjC,cAAe,EAAK,GAAG,CACxB,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,YAAY,CAAG,EAAE,YAAY,EAC9C,KAAK,CAAC,EAAG,IACX,iBAAkB,OAAO,OAAO,CAAC,GAC/B,GAAG,CAAC,CAAC,CAAC,EAAO,EAAK,GAAK,CAAC,OACxB,EACA,aAAc,EAAK,GAAG,CACtB,QAAS,EAAK,OAAO,CACrB,IAAK,EAAK,GAAG,CAAG,EAAK,OAAO,CAC7B,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,KAAK,CAAC,aAAa,CAAC,EAAE,KAAK,oBAC9C,CACD,CACD,GA4BY,EAA0B,CAAA,EAAA,EAAA,KAAA,AAAK,EAC3C,MACC,EACA,EAAgB,CAAC,IAEjB,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAE7B,CAAE,KAAM,CAAK,CAAE,CAAG,MAAM,EAC5B,IAAI,CAAC,kBACL,MAAM,CAAC,CAAC;;;;;;;;;EASV,CAAC,EACC,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,aAAc,MACjB,KAAK,CAAC,aAAc,CAAE,WAAW,CAAM,GACvC,KAAK,CAAC,UAER,AAAI,AAAC,GAA0B,GAAG,CAApB,EAAM,MAAM,CAInB,EAAM,GAAG,CAAC,AAAC,IACjB,IAOI,EAYA,EAnBE,EAAU,IAAI,KAAK,EAAK,UAAU,EAGlC,EAAW,KAAK,KAAK,CAAC,CAFhB,AACG,IADC,OACG,OAAO,GAAK,EAAQ,OAAO,EAAA,EACT,KAC/B,EAAY,KAAK,KAAK,CAAC,EAAW,IAClC,EAAW,KAAK,KAAK,CAAC,EAAY,IAIvC,EADG,EAAW,EACJ,CADO,UAEP,EAAW,GACX,CADe,AACf,EAAG,EAAS,KAAK,CAAC,CAClB,EAAY,GACZ,CADgB,AAChB,EAAG,EAAU,KAAK,CAAC,CAEnB,CAAA,EAAG,EAAS,KAAK,CAAC,CAM5B,EADsB,WAAW,CAA9B,EAAK,SAAS,CACR,EAAK,OAAO,CAAG,OAAS,SAExB,OAIV,IAAM,EACJ,EAAK,QAAQ,EAA8B,MAAQ,UAErD,MAAO,CACN,GAAI,EAAK,EAAE,CACX,KAAO,EAAK,IAAI,EAAkC,QAClD,UAAY,EAAK,SAAS,EAA+B,UACzD,OAAQ,EACR,QACC,EAAK,OAAO,EAAI,EAAK,IAAI,EAAE,UAAU,EAAG,IAAM,MAC/C,GADwD,EAClD,SACN,CACD,CACD,GA5CQ,EA6CT,AA7CW,GAmDC,EAAmB,CAAA,EAAA,EAAA,KAAA,AAAK,EACpC,MAAO,EAAmB,EAAgB,CAAC,IAC1C,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAG7B,CAAE,KAAM,CAAO,CAAE,CAAG,MAAM,EAC9B,IAAI,CAAC,kBACL,MAAM,CAAC,CAAC;;;;;;;;;EASV,CAAC,EACC,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,aAAc,MACjB,GAAG,CAAC,cAAe,KAAM,MACzB,KAAK,CAAC,aAAc,CAAE,WAAW,CAAM,GACvC,KAAK,CAAC,IAER,CAFa,EAET,CAAC,GAA8B,GAAG,CAAtB,EAAQ,MAAM,CAC7B,MAAO,EAAE,CAIV,IAAM,AAPuC,EAOrB,IAAI,IAW5B,IAAK,IAAM,KAAU,EAAS,CAC7B,IAAM,EAAa,EAAO,WAAW,CACrC,GAAI,CAAC,EAAY,SAEjB,IAAM,EACJ,EAAO,QAAQ,EAA0C,MAC1D,UACK,EAAW,EAAgB,GAAG,CAAC,GAE/B,EACL,EAAO,OAAO,EAAI,EAAO,IAAI,EAAE,UAAU,EAAG,KAAO,aAC9C,EAAY,IAAI,KAAK,EAAO,UAAU,EACtC,EAAgC,YAArB,EAAO,SAAS,EAAkB,CAAC,EAAO,OAAO,CAE7D,GAUA,GACH,EAAS,EAXI,GAUA,CACE,GAGZ,EAAY,EAAS,QAAQ,EAAE,CAClC,EAAS,WAAW,CAAG,EACvB,EAAS,QAAQ,CAAG,EACpB,EAAS,EAAE,CAAG,EAAO,EAAE,GAhBxB,EAAgB,GAAG,CAAC,EAAY,CAC/B,SAAU,EACV,YAAa,EACb,SAAU,EACV,UAAQ,EACR,GAAI,EAAO,EAAE,AACd,EAaF,AAfsB,CAkBtB,GAlB0B,CAkBpB,EAAM,IAAI,KAChB,OAAO,MAAM,IAAI,CAAC,EAAgB,MAAM,IACtC,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,QAAQ,CAAC,OAAO,GAAK,EAAE,QAAQ,CAAC,OAAO,IACxD,KAAK,CAAC,EAAG,GACT,GAAG,CAAC,AAAC,IAEL,IAII,EAJE,EAAW,KAAK,KAAK,CAAC,CADb,EAAI,OAAO,GAAK,EAAO,QAAQ,CAAC,OAAO,EAAA,EACjB,KAC/B,EAAY,KAAK,KAAK,CAAC,EAAW,IAClC,EAAW,KAAK,KAAK,CAAC,EAAY,IAaxC,OATC,EADG,EAAW,EACJ,CADO,UAEP,EAAW,GACX,CADe,AACf,EAAG,EAAS,KAAK,CAAC,CAClB,EAAY,GACZ,CADgB,AAChB,EAAG,EAAU,KAAK,CAAC,CAEnB,CAAA,EAAG,EAAS,KAAK,CAAC,CAGtB,CACN,GAAI,EAAO,EAAE,CACb,SAAU,EAAO,QAAQ,CACzB,YACC,EAAO,WAAW,CAAC,MAAM,CAAG,GACzB,EAAO,WAAW,CAAC,SAAS,CAAC,EAAG,IAAM,MACtC,EAAO,WAAW,CACtB,KAAM,EACN,OAAQ,EAAO,MAAM,AACtB,CACD,EACF,GA+CqC,CAAA,EAAA,EAAA,KAAA,AAAK,EAC1C,MAAO,EAAmB,EAAe,EAAE,IAC1C,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GAExC,GAAM,CAAE,KAAM,CAAI,CAAE,CAAG,MAAM,EAC3B,IAAI,CAAC,QACL,MAAM,CAAC,CAAC;;;;;;EAMV,CAAC,EACC,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,SAAU,aACb,GAAG,CAAC,aAAc,EAAU,WAAW,IACvC,EAAE,CAAC,aAAc,MACjB,GAAG,CAAC,oBAAqB,KAAM,MAE3B,EAAU,GAAQ,EAAE,CAGpB,EAAiB,EAAQ,MAAM,CACpC,CAAC,EAAK,IAAM,EAAM,CAAC,EAAE,iBAAiB,GAAI,CAAC,CAAI,IAC/C,GAEK,EAAqB,EAAQ,MAAM,CACxC,CAAC,EAAK,IAAM,EAAM,CAAC,EAAE,qBAAqB,GAAI,CAAC,CAAI,IACnD,GAEK,EAAqB,EAAQ,MAAM,CACxC,CAAC,EAAK,IAAM,EAAM,CAAC,EAAE,qBAAqB,GAAI,CAAC,CAAI,IACnD,GAEK,EAAgB,EAAQ,MAAM,CACnC,CAAC,EAAK,IAAM,EAAM,CAAC,EAAE,aAAa,GAAI,CAAC,CAAI,IAC3C,GAEK,EAAiB,EAAQ,MAAM,CACpC,CAAC,EAAK,IAAM,EAAM,CAAC,EAAE,eAAe,GAAI,CAAC,CAAI,IAC7C,GAGK,EACL,EAAQ,MAAM,CAAG,EACd,EAAQ,MAAM,CAAC,CAAC,EAAK,IAAM,EAAM,CAAC,EAAE,aAAa,GAAI,CAAC,CAAI,IAAK,GAChE,EAAQ,MAAM,CACb,EAEE,EACL,EAAQ,MAAM,CAAG,EACd,EAAQ,MAAM,CAAC,CAAC,EAAK,IAAM,EAAO,GAAE,CAAH,mBAAuB,GAAI,CAAC,CAAG,GACjE,EAAQ,MAAM,CACb,EAEE,EAAkB,EAAQ,MAAM,CACrC,AAAC,GAA0B,iBAApB,EAAE,aAAa,EACrB,MAAM,CACF,EAAe,EAAQ,MAAM,CAClC,AAAC,GAA0B,cAApB,EAAE,aAAa,EACrB,MAAM,CACF,EAAiB,EAAQ,MAAM,CACpC,AAAC,GAAM,AAAoB,kBAAlB,aAAa,EACrB,MAAM,CAGF,EAGF,CACH,aAAc,CAAE,MAAO,EAAG,QAAS,EAAG,KAAM,CAAE,EAC9C,UAAW,CAAE,MAAO,EAAG,QAAS,EAAG,KAAM,CAAE,EAC3C,YAAa,CAAE,MAAO,EAAG,QAAS,EAAG,KAAM,CAAE,CAC9C,EAEA,IAAK,IAAM,KAAO,EAAS,CAC1B,IAAM,EAAS,EAAI,aAAa,EAAI,YAChC,CAAY,CAAC,EAAO,EAAE,CACzB,CAAY,CAAC,EAAO,CAAC,KAAK,GAC1B,CAAY,CAAC,EAAO,CAAC,OAAO,EAAI,CAAC,EAAI,YAAY,GAAI,CAAC,CAAI,IAC1D,CAAY,CAAC,EAAO,CAAC,IAAI,EAAI,CAAC,EAAI,iBAAiB,GAAI,CAAC,CAAI,IAE9D,CAGA,IAAM,EAAoB,EACxB,GAAG,CAAC,AAAC,IACL,IAAM,EAAW,EAAE,QAAQ,CAI3B,MAAO,CACN,GAAI,EAAE,EAAE,CACR,MAAO,EAAE,KAAK,EAAI,eAClB,SAAU,GAAU,cAAgB,GAAU,MAAQ,UACtD,QAAS,CAAC,EAAE,YAAY,GAAI,CAAC,CAAI,IACjC,KAAM,CAAC,EAAE,iBAAiB,GAAI,CAAC,CAAI,IACnC,OAAQ,CAAC,EAAE,aAAa,GAAI,CAAC,CAAI,IACjC,OAAQ,EAAE,oBAAoB,EAAI,CACnC,CACD,GACC,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,MAAM,CAAG,EAAE,MAAM,EAClC,KAAK,CAAC,EAAG,IAEX,MAAO,CACN,QAAS,cACR,iBACA,iBACA,EACA,qBACA,qCACA,eACA,iBACA,EACA,gBAAiB,CAClB,EACA,eAAgB,OAAO,OAAO,CAAC,GAAc,GAAG,CAAC,CAAC,CAAC,EAAQ,EAAK,GAAK,CAAC,QACrE,EACA,MAAO,EAAK,KAAK,CACjB,aAAc,EAAK,OAAO,CAC1B,UAAW,EAAK,IAAI,CACpB,UACC,EAAK,OAAO,CAAG,EACX,CAAC,EAAK,OAAO,CAAG,EAAK,IAAA,AAAI,EAAI,EAAK,OAAO,CAAI,IAC9C,EACL,CAAC,oBACD,EACA,cAAe,CACd,MAAO,EACP,UAAW,EACX,UAAW,EACX,SAAU,EACV,UAAW,CACZ,CACD,CACD,GAkC6B,CAAA,EAAA,EAAA,KAAA,AAAK,EAClC,MAAO,IACN,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAE7B,CAAE,KAAM,CAAO,CAAE,CAAG,MAAM,EAC9B,IAAI,CAAC,6BACL,MAAM,CAAC,KACP,EAAE,CAAC,aAAc,GACjB,KAAK,CAAC,aAAc,CAAE,WAAW,CAAM,GACvC,KAAK,CAAC,GACN,MAAM,UAER,AAAK,EAIE,CACN,CALG,KAAU,IAKF,CACV,iBAAkB,EAAQ,mBAAmB,EAAI,EACjD,iBAAkB,EAAQ,kBAAkB,EAAI,EAChD,iBAAkB,EAAQ,mBAAmB,EAAI,EACjD,eAAgB,EAAQ,eAAe,EAAI,EAC3C,cAAe,CAAC,EAAQ,yBAAyB,GAAI,CAAC,CAAI,GAC3D,EACA,YAAa,CACZ,oBAAqB,EAAQ,4BAA4B,EAAI,EAC7D,mBAAoB,EAAQ,oBAAoB,EAAI,EACpD,oBAAqB,EAAQ,0BAA0B,EAAI,EAC3D,qBAAsB,EAAQ,uBAAuB,EAAI,EACzD,sBAAuB,EAAQ,2BAA2B,EAAI,CAC/D,EACA,SAAU,CACT,iBAAkB,CAAC,EAAQ,2BAA2B,EAAI,CAAC,EAAI,IAC/D,wBAAyB,CAAC,EAAQ,yBAAyB,GAAI,CAAC,CAAI,IACpE,cAAe,EAAQ,gBAAgB,EAAI,EAC3C,cAAe,EAAQ,uBAAuB,EAAI,EAClD,wBAAyB,EAAQ,yBAAyB,EAAI,CAC/D,CACD,EAzBQ,IA0BT,GAiC0C,CAAA,EAAA,EAAA,KAAA,AAAK,EAC/C,MAAO,IACN,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAE7B,CAAE,KAAM,CAAU,CAAE,CAAG,MAAM,EACjC,IAAI,CAAC,8BACL,MAAM,CAAC,CAAC;;;;;EAKV,CAAC,EACC,EAAE,CAAC,aAAc,GACjB,KAAK,CAAC,eAAgB,CAAE,WAAW,CAAM,GACzC,KAAK,CAAC,KAKF,EALS,AAKW,IAAI,IAC9B,IAAK,IAAM,KAJE,AAIG,GAJW,EAFc,AAEZ,AAIP,CACjB,AAAC,EAAkB,GAAG,CAAC,EAAE,YAAY,GAAG,AAC3C,EAAkB,GAAG,CAAC,EAAE,YAAY,CAAE,GAIxC,IAAM,EAAgB,MAAM,IAAI,CAAC,EAAkB,MAAM,IACnD,EAAiB,EAAc,MAAM,CAErC,EAAe,EAAc,MAAM,CACxC,AAAC,GAAM,EAAE,YAAY,EAAI,IACxB,MAAM,CACF,EAAe,EAAc,MAAM,CACxC,AAAC,GAAM,EAAE,YAAY,EAAI,IAAM,EAAE,YAAY,CAAG,IAC/C,MAAM,CACF,EAAgB,EAAc,MAAM,CACxC,AAAD,GAAO,EAAE,YAAY,CAAG,IACvB,MAAM,CACF,EAAqB,EAAc,MAAM,CAC9C,AAAC,GAAM,EAAE,mBAAmB,EAC3B,MAAM,CAEF,EACL,EAAiB,EACd,EAAc,MAAM,CAAC,CAAC,EAAK,IAAM,EAAO,GAAE,CAAH,WAAe,GAAI,CAAC,CAAG,GAC/D,EACC,EAGE,EAGF,CAAC,EACL,IAAK,IAAM,KAAK,EAAe,CAC9B,IAAM,EAAY,EAAE,gBAAgB,EAAI,SACpC,AAAC,EAAe,CAAC,EAAU,EAAE,CAChC,CAAe,CAAC,EAAU,CAAG,CAAE,MAAO,EAAG,SAAU,EAAG,UAAW,EAAE,EAEpE,CAAe,CAAC,EAAU,CAAC,KAAK,GAChC,CAAe,CAAC,EAAU,CAAC,QAAQ,EAAI,EAAE,SAAS,EAAI,EACtD,CAAe,CAAC,EAAU,CAAC,SAAS,EAClC,AAAD,GAAG,sBAAsB,GAAI,CAAC,CAAI,GACpC,CAGA,IAAM,EAAsB,EAC1B,MAAM,CACN,AAAC,GACA,CAAC,EAAE,sBAAsB,EAAI,CAAC,EAAI,GAClC,AAAmC,IAAlC,GAAE,sBAAsB,EAAI,CAAC,GAE/B,GAAG,CAAC,AAAC,IACL,IAAM,EAAQ,EAAE,SAAS,CAKzB,MAAO,CACN,YAAa,EAAE,YAAY,CAC3B,KAAM,GAAO,MAAQ,GAAO,OAAS,oBACrC,qBAAsB,EAAE,sBAAsB,EAAI,EAClD,oBAAqB,CAAC,EAAE,sBAAsB,GAAI,CAAC,CAAI,GACxD,CACD,GACC,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,oBAAoB,CAAG,EAAE,oBAAoB,EAC9D,KAAK,CAAC,EAAG,IAEX,MAAO,CACN,QAAS,gBACR,eACA,eACA,gBACA,iBACA,qBACA,CACD,EACA,YAAa,OAAO,OAAO,CAAC,GAAiB,GAAG,CAAC,CAAC,CAAC,EAAW,EAAK,GAAK,CAAC,WACxE,EACA,MAAO,EAAK,KAAK,CACjB,OAAQ,EAAK,KAAK,CAAG,EAAI,EAAK,QAAQ,CAAG,EAAK,KAAK,CAAG,EACtD,mBAAoB,EAAK,KAAK,CAAG,EAAI,EAAK,SAAS,CAAG,EAAK,KAAK,CAAG,CACpE,CAAC,uBACD,CACD,CACD,GAmCuC,CAAA,EAAA,EAAA,KAAA,AAAK,EAC5C,MACC,EACA,EAAe,EAAE,IAEjB,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAY,AAAZ,IACjB,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GAExC,GAAM,CAAE,KAAM,CAAO,CAAE,CAAG,MAAM,EAC9B,IAAI,CAAC,gCACL,MAAM,CAAC,KACP,EAAE,CAAC,aAAc,GACjB,GAAG,CAAC,eAAgB,EAAU,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,EACzD,KAAK,CAAC,4BAA6B,CAAE,WAAW,CAAM,GAIlD,EAAc,CAFA,GAAW,EAAE,AAAF,EAEC,GAAG,CAAC,CAAC,EAAG,KAAW,CAClD,EADiD,CAC7C,EAAE,OAAO,CACb,KAAM,EAAE,IAAI,EAAI,UAChB,cAAe,EAAE,cAAc,EAAI,EACnC,QAAS,AAAC,GAAE,aAAa,GAAI,CAAC,CAAI,IAClC,aAAc,CAAC,EAAE,cAAc,GAAI,CAAC,CAAI,IACxC,aAAc,EAAE,qBAAqB,EAAI,EACzC,cAAe,EAAE,cAAc,EAAI,EACnC,UAAW,EAAE,SAAS,EAAI,EAC1B,aAAc,EAAE,aAAa,EAAI,EACjC,YAAa,EAAE,YAAY,EAAI,EAC/B,cAAe,CAAC,EAAE,cAAc,GAAI,CAAC,CAAI,IACzC,aAAc,EAAE,yBAAyB,EAAI,EAC7C,KAAM,EAAQ,EACf,CAAC,EAEK,EAAQ,EAAY,MAAM,CAC1B,EAAc,CACnB,eACC,EAAQ,EACL,EAAY,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAE,aAAa,CAAE,GAAK,EACvD,EACJ,kBACC,EAAQ,EAAI,EAAY,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAE,OAAO,CAAE,GAAK,EAAQ,EACtE,gBACC,EAAQ,EACL,EAAY,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAE,YAAY,CAAE,GAAK,EACtD,EACJ,iBACC,EAAQ,EACL,EAAY,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAE,aAAa,CAAE,GAAK,EACvD,EACJ,eAAgB,EAAY,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAE,SAAS,CAAE,EAC/D,EAEA,MAAO,aAAE,cAAa,CAAY,CACnC,GAqDuC,CAAA,EAAA,EAAA,KAAA,AAAK,EAC5C,MACC,EACA,EAAe,EAAE,IAEjB,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAY,AAAZ,IACjB,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GAGxC,GAAM,CAAE,KAAM,CAAS,CAAE,CAAG,MAAM,EAChC,IAAI,CAAC,uBACL,MAAM,CACN,2IAEA,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,aAAc,MACjB,KAAK,CAAC,aAAc,CAAE,WAAW,CAAM,GACvC,KAAK,CAAC,KAGF,CAAE,KAAM,CAAW,CAAE,CAAG,MAAM,EAClC,IAAI,CAAC,mCACL,MAAM,CAAC,KACP,EAAE,CAAC,aAAc,GACjB,GAAG,CAAC,OAAQ,EAAU,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,EACjD,KAAK,CAAC,OAAQ,CAAE,WAAW,CAAK,GAChC,KAAK,CAAC,KAEF,EAAe,GAAa,EAAE,CAI9B,EAAa,EAAa,MAAM,CACrC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,WAAe,GAAI,CAAC,CACtC,GAEK,EAAe,EAAa,MAAM,CACvC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,YAAgB,GAAI,CAAC,CACvC,GAEK,EAAa,EAAa,MAAM,CACrC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,UAAc,GAAI,CAAC,CACrC,GAEK,EAAkB,EAAa,MAAM,CAC1C,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,gBAAoB,GAAI,CAAC,CAC3C,GAWK,EAAe,EAAa,GAAG,CAAC,AAAC,IAAM,AAAC,CAC7C,GAAI,EAAE,EAAE,CACR,KAAM,EAAE,IAAI,CACZ,QAAS,EAAE,OAAO,CAClB,OAAQ,EAAE,MAAM,CAChB,OAAQ,EAAE,aAAa,EAAI,EAC3B,MAAO,EAAE,YAAY,EAAI,EACzB,MAAO,EAAE,WAAW,EAAI,EACxB,WAAY,EAAE,iBAAiB,EAAI,EACnC,QAAS,EAAE,aAAa,EAAI,EAC5B,KAAM,EAAE,kBAAkB,EAAI,EAC9B,IAAK,EAAE,WAAW,EAAI,EACtB,YAAa,EAAE,aAAa,EAAI,EACjC,CAAC,EAGK,EAQF,CAAC,EAEL,IAAK,IAAM,KAAK,EAAc,CAC7B,IAAM,EAAU,EAAE,OAAO,EAAI,OACzB,CAAC,CAAW,CAAC,EAAQ,EAAE,CAC1B,CAAW,CAAC,EAAQ,CAAG,CACtB,MAAO,EACP,MAAO,EACP,WAAY,EACZ,QAAS,CACV,GAED,CAAW,CAAC,EAAQ,CAAC,KAAK,EAAI,EAAE,YAAY,EAAI,EAChD,CAAW,CAAC,EAAQ,CAAC,KAAK,EAAI,EAAE,WAAW,EAAI,EAC/C,CAAW,CAAC,EAAQ,CAAC,UAAU,EAAI,EAAE,iBAAiB,EAAI,EAC1D,CAAW,CAAC,EAAQ,CAAC,OAAO,EAAI,EAAE,aAAa,EAAI,CACpD,CAEA,IAAM,EAAY,OAAO,OAAO,CAAC,GAC/B,GAAG,CAAC,CAAC,CAAC,EAAS,EAAK,GAAK,CAAC,SAC1B,EACA,MAAO,EAAK,KAAK,CACjB,MAAO,EAAK,KAAK,CACjB,WAAY,EAAK,UAAU,CAC3B,QAAS,EAAK,OAAO,CACrB,KAAM,EAAK,KAAK,CAAG,EAAI,EAAK,OAAO,CAAG,EAAK,KAAK,CAAG,EACnD,YAAa,EAAK,KAAK,CAAG,EAAI,EAAK,KAAK,CAAG,EAAK,KAAK,CAAG,CACzD,CAAC,GACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,OAAO,CAAG,EAAE,OAAO,EAGhC,EAGF,CAAC,EACL,IAAK,IAAM,KAvFY,AAuFP,GAvFsB,EAAE,CAuFR,CAC/B,IAAM,EAAO,EAAE,IAAI,AACf,CAAC,CAAS,CAAC,EAAK,EAAE,CACrB,CAAS,CAAC,EAAK,CAAG,CAAE,MAAO,EAAG,MAAO,EAAG,QAAS,EAAE,EAEpD,CAAS,CAAC,EAAK,CAAC,KAAK,EAAI,EAAE,WAAW,EAAI,EAC1C,CAAS,CAAC,EAAK,CAAC,KAAK,EAAI,EAAE,WAAW,EAAI,EAC1C,CAAS,CAAC,EAAK,CAAC,OAAO,EAAI,EAAE,aAAa,EAAI,CAC/C,CAYA,MAAO,CACN,QAAS,YACR,eACA,EACA,6BACA,EACA,YA7FkB,EAAa,EAAI,EAAe,EAAa,EA8F/D,WA5FD,EAAa,EAAK,CAAC,EAAe,CAAA,CAAU,CAAI,EAAc,IAAM,EA6FnE,eA5FqB,EAAa,EAAI,EAAa,EAAa,EA6FhE,sBA3FD,EAAkB,EAAI,EAAa,EAAkB,CA4FrD,EACA,UAAW,YACX,EACA,WAvBkB,OAAO,OAAO,CAAC,GAChC,GAAG,CAAC,CAAC,CAAC,EAAM,EAAK,GAAK,CAAC,MACvB,EACA,MAAO,EAAK,KAAK,CACjB,MAAO,EAAK,KAAK,CACjB,QAAS,EAAK,OAAO,CACrB,KAAM,EAAK,KAAK,CAAG,EAAI,EAAK,OAAO,CAAG,EAAK,KAAK,CAAG,EACpD,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,IAAI,CAAC,aAAa,CAAC,EAAE,IAAI,EAgB5C,CACD,GAuDuC,CAAA,EAAA,EAAA,KAAA,AAAK,EAC5C,MAAO,EAAmB,EAAe,EAAE,IAC1C,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GAGxC,GAAM,CAAE,KAAM,CAAU,CAAE,CAAG,MAAM,EACjC,IAAI,CAAC,yBACL,MAAM,CAAC,KACP,EAAE,CAAC,aAAc,GACjB,GAAG,CAAC,OAAQ,EAAU,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,EACjD,KAAK,CAAC,OAAQ,CAAE,UAAW,EAAM,GAE7B,EAAa,GAAc,EAAE,CAG7B,EAAc,IAAI,IACxB,IAAK,IAAM,KAAK,GAEd,CAAC,EAAY,GAAG,CAAC,CAFS,CAEP,OAAO,GAC1B,EAAE,IAAI,CAAI,EAAD,CAAa,GAAG,CAAC,EAAE,OAAO,GAAG,MAAQ,EAAA,CAAE,GAC/C,AACD,EAAY,GAAG,CAAC,EAAE,OAAO,CAAE,GAI7B,IAAM,EAAU,MAAM,IAAI,CAAC,EAAY,MAAM,IAC3C,GAAG,CAAE,AAAD,IAAO,AAAC,CACZ,GAAI,EAAE,OAAO,CACb,KAAM,EAAE,QAAQ,EAAI,UACpB,cAAe,EAAE,oBAAoB,EAAI,EACzC,YAAa,EAAE,kBAAkB,EAAI,EACrC,eAAgB,EAAE,gBAAgB,EAAI,EACtC,cAAe,EAAE,mBAAmB,EAAI,EACxC,WAAY,EAAE,WAAW,EAAI,EAC7B,YAAa,EAAE,YAAY,EAAI,EAC/B,cAAe,EAAE,cAAc,EAAI,EACnC,UAAW,EAAE,iBAAiB,EAAI,EAClC,eAAgB,EAAE,gBAAgB,EAAI,EACtC,YAAa,EAAE,qBAAqB,EAAI,EACxC,aAAc,EAAE,sBAAsB,EAAI,EAC1C,iBAAkB,EAAE,yBAAyB,EAAI,EACjD,gBAAiB,EAAE,iBAAiB,EAAI,EACxC,YAAa,EAAE,YAAY,EAAI,EAC/B,SAAU,EAAE,sBAAsB,EAAI,EACvC,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,WAAW,CAAG,EAAE,WAAW,EAGxC,EAAY,EAAQ,MAAM,CAC1B,EAAoB,EAAQ,MAAM,CACvC,CAAC,EAAK,IAAM,EAAM,EAAE,aAAa,CACjC,GAEK,EACL,EAAY,EACT,EAAQ,MAAM,CAAC,CAAC,EAAK,IAAM,EAAM,EAAE,WAAW,CAAE,GAAK,EACrD,EACE,EACL,EAAY,EACT,EAAQ,MAAM,CAAC,CAAC,EAAK,IAAM,EAAM,EAAE,cAAc,CAAE,GAAK,EACxD,EACE,EAAqB,EAAQ,MAAM,CACxC,CAAC,EAAK,IAAM,EAAM,EAAE,aAAa,CACjC,GAIK,EACL,EAAQ,MAAM,CAAG,EAAI,CAAO,CAAC,EAAE,CAAC,WAAW,CAAG,EAGzC,EAAc,EAAQ,KAAK,CAAC,EAAG,GAAG,GAAG,CAAC,CAAC,EAAG,KAAW,CAC1D,EADyD,GACnD,EAAQ,EACd,KAAM,EAAE,IAAI,CACZ,YAAa,EAAE,WAAW,CAC1B,QAAS,EAAE,aAAa,CACzB,CAAC,EAGK,EAOF,CAAC,EAEL,IAAK,IAAM,KAAK,EAAY,CAC3B,IAAM,EAAO,EAAE,IAAI,AACf,CAAC,CAAS,CAAC,EAAK,EAAE,CACrB,CAAS,CAAC,EAAK,CAAG,CAAE,WAAY,EAAG,SAAU,EAAG,OAAQ,EAAE,EAE3D,CAAS,CAAC,EAAK,CAAC,UAAU,EAAI,EAAE,oBAAoB,EAAI,EACxD,CAAS,CAAC,EAAK,CAAC,QAAQ,EAAI,EAAE,oBAAoB,EAAI,EACtD,CAAS,CAAC,EAAK,CAAC,MAAM,EAAI,EAAE,WAAW,EAAI,CAC5C,CAaA,MAAO,CACN,QAAS,CACR,YACA,mCACA,oBACA,EACA,qBACA,kBAlDD,EAAoB,EAAI,EAAqB,EAAoB,0BAmDhE,EACA,WAAY,EACb,UACA,EACA,cACA,WAxBkB,OAAO,OAAO,CAAC,GAChC,GAAG,CAAC,CAAC,CAAC,EAAM,EAAK,GAAK,CAAC,MACvB,EACA,WAAY,EAAK,UAAU,CAC3B,SAAU,EAAK,QAAQ,CACvB,OAAQ,EAAK,MAAM,CACnB,YACC,EAAK,QAAQ,CAAG,EAAK,EAAK,MAAM,CAAG,EAAK,QAAQ,CAAI,IAAM,EAC5D,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,IAAI,CAAC,aAAa,CAAC,EAAE,IAAI,EAgB5C,CACD,GA6CuC,CAAA,EAAA,EAAA,KAAA,AAAK,EAC5C,MAAO,EAAmB,EAAe,EAAE,IAC1C,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GAExC,GAAM,CAAE,KAAM,CAAK,CAAE,CAAG,MAAM,EAC5B,IAAI,CAAC,2BACL,MAAM,CAAC,CAAC;;;EAGV,CAAC,EACC,EAAE,CAAC,aAAc,GACjB,GAAG,CAAC,aAAc,EAAU,WAAW,IACvC,KAAK,CAAC,aAAc,CAAE,WAAW,CAAM,GACvC,KAAK,CAAC,KAEF,EAAW,GAAS,EAAE,CAGtB,EAAa,EAAS,MAAM,CAC5B,EAAgB,EAAS,MAAM,CAAC,AAAC,GAAM,EAAE,QAAQ,EAAE,MAAM,CACzD,EAAc,EAAS,MAAM,CAAC,AAAC,GAAM,EAAE,WAAW,EAAE,MAAM,CAG1D,EAAc,EAAS,MAAM,CAAE,AAAD,GAAO,EAAE,UAAU,EAAE,MAAM,CAGzD,EACL,EAAgB,EACb,EACC,MAAM,CAAC,AAAC,GAAM,EAAE,QAAQ,EACxB,MAAM,CAAC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,eAAmB,EAAI,CAAC,EAAG,GACtD,EACC,EACE,EAAmB,EAAS,MAAM,CAAC,AAAC,GAAM,EAAE,eAAe,EAAE,MAAM,CAGnE,EAAwC,CAAC,EAC/C,IAAK,IAAM,KAAK,EAAU,CACzB,IAAM,EAAU,EAAE,YAAY,EAAI,UAClC,CAAa,CAAC,EAAQ,CAAG,CAAC,CAAa,CAAC,EAAQ,GAAI,CAAC,CAAI,CAC1D,CACA,IAAM,EAAY,OAAO,OAAO,CAAC,GAC/B,GAAG,CAAC,CAAC,CAAC,EAAS,EAAM,GAAK,CAAC,SAC3B,QACA,EACA,WAAY,EAAa,EAAK,EAAQ,EAAc,IAAM,EAC3D,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,KAAK,CAAG,EAAE,KAAK,EAG5B,EAOF,CAAC,EACL,IAAK,IAAM,KAAK,EAAU,CACzB,IAAM,EAAW,EAAE,QAAQ,CACrB,EAAS,GAAU,SAAW,EAAE,UAAU,EAAI,QAChD,CAAC,CAAU,CAAC,EAAO,EAAE,CACxB,CAAU,CAAC,EAAO,CAAG,CAAE,MAAO,EAAG,OAAQ,EAAG,QAAS,EAAE,EAExD,CAAU,CAAC,EAAO,CAAC,KAAK,GACpB,EAAE,UAAU,EAAE,CAAU,CAAC,EAAO,CAAC,MAAM,GAC3C,CAAU,CAAC,EAAO,CAAC,OAAO,EAAI,EAAE,kBAAkB,EAAI,CACvD,CACA,IAAM,EAAW,OAAO,OAAO,CAAC,GAC9B,GAAG,CAAC,CAAC,CAAC,EAAQ,EAAK,GAAK,AAAC,EACzB,SACA,MAAO,EAAK,KAAK,CACjB,OAAQ,EAAK,MAAM,CACnB,YAAa,EAAK,KAAK,CAAG,EAAK,EAAK,MAAM,CAAG,EAAK,KAAK,CAAI,IAAM,EACjE,QAAS,EAAK,OAAO,CACtB,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,KAAK,CAAG,EAAE,KAAK,EAG5B,EAAM,IAAI,KA6BhB,MAAO,CACN,QAAS,CACR,2BACA,EACA,cACA,eA3FD,EAAa,EAAK,EAAgB,EAAc,IAAM,cA4FrD,EACA,YA1FD,EAAgB,EAAK,EAAc,EAAiB,IAAM,kBA2FzD,mBACA,CACD,EACA,qBACA,EACA,YAzCmB,EAAS,KAAK,CAAC,EAAG,IAAI,GAAG,CAAC,AAAC,IAC9C,IAMI,EANE,EAAW,EAAE,QAAQ,CACrB,EAAW,IAAI,KAAK,EAAE,UAAU,EAEhC,EAAW,KAAK,KAAK,CAAC,CADb,EAAI,OAAO,GAAK,EAAS,OAAO,EAAA,EACV,KAC/B,EAAY,KAAK,KAAK,CAAC,EAAW,IAWxC,OAPC,EADG,EAAW,GACJ,CADQ,AACR,EAAG,EAAS,KAAK,CAAC,CAClB,EAAY,GACZ,CAAA,AADgB,EACb,EAAU,KAAK,CAAC,CAEnB,CAAA,EAAG,KAAK,KAAK,CAAC,EAAY,IAAI,KAAK,CAAC,CAGxC,CACN,GAAI,EAAE,EAAE,CACR,aAAc,EAAE,aAAa,EAAI,UACjC,WAAY,EAAE,WAAW,CACzB,SAAU,EAAE,gBAAgB,EAAI,EAChC,QAAS,EAAE,YAAY,EAAI,UAC3B,OAAQ,EAAE,UAAU,GAAI,EACxB,SAAU,GAAU,MAAQ,KAC5B,KAAM,CACP,CACD,EAgBA,CACD,GAwD6C,CAAA,EAAA,EAAA,KAAA,AAAK,EAClD,MACC,EACA,EAAe,EAAE,IAEjB,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GAExC,GAAM,CAAE,KAAM,CAAY,CAAE,CAAG,MAAM,EACnC,IAAI,CAAC,iCACL,MAAM,CAAC,KACP,EAAE,CAAC,aAAc,GACjB,GAAG,CAAC,OAAQ,EAAU,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,EACjD,KAAK,CAAC,OAAQ,CAAE,WAAW,CAAM,GAE7B,EAAU,GAAgB,EAAE,CAG5B,EAAe,IAAI,IACzB,IAAK,IAAM,KAAK,EACX,EAAE,IADkB,SACL,EAAI,CAAC,EAAa,GAAG,CAAC,EAAE,aAAa,GAAG,AAC1D,EAAa,GAAG,CAAC,EAAE,aAAa,CAAE,GAKpC,IAAM,EAAY,EAAQ,MAAM,CAC1B,EACL,EAAY,EACT,EAAQ,MAAM,CAAC,CAAC,EAAK,IAAM,EAAO,GAAE,CAAH,iBAAqB,EAAI,CAAC,EAAG,GAC/D,EACC,EACE,EACL,EAAY,EACT,EAAQ,MAAM,CAAC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,qBAAyB,GAAI,CAAC,CAAG,GACnE,EACC,EACE,EACL,EAAY,EACT,EAAQ,MAAM,CACd,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,uBAA2B,GAAI,CAAC,CAClD,GACG,EACH,EACE,EACL,EAAY,EACT,EAAQ,MAAM,CAAC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,mBAAuB,GAAI,CAAC,CAAG,GACjE,EACC,EACE,EACL,EAAY,EACT,EAAQ,MAAM,CAAC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,kBAAsB,GAAI,CAAC,CAAG,GAChE,EACC,EACE,EACL,EAAY,EACT,EAAQ,MAAM,CACd,CAAC,EAAK,IAAM,EAAO,GAAE,CAAH,wBAA4B,GAAI,CAAC,CACnD,GACG,EACH,EACE,EACL,EAAY,EACT,EAAQ,MAAM,CACd,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,0BAA8B,GAAI,CAAC,CACrD,GACG,EACH,EACE,EAAkB,EAAQ,MAAM,CACrC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,yBAA6B,GAAI,CAAC,CACpD,GAEK,EAAiB,EAAQ,MAAM,CACpC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,eAAmB,GAAI,CAAC,CAC1C,GAIK,EAAe,MAAM,IAAI,CAAC,EAAa,MAAM,IACjD,GAAG,CAAC,AAAC,IAAM,AAAC,CACZ,GAAI,EAAE,aAAa,EAAI,GACvB,KAAM,EAAE,eAAe,EAAI,UAC3B,iBAAkB,EAAE,kBAAkB,EAAI,EAC1C,aAAc,EAAE,sBAAsB,EAAI,EAC1C,WAAY,EAAE,oBAAoB,EAAI,EACtC,cAAe,EAAE,oBAAoB,EAAI,EACzC,gBAAiB,EAAE,2BAA2B,EAAI,EAClD,sBAAuB,EAAE,6BAA6B,EAAI,CAC3D,CAAC,GACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,gBAAgB,CAAG,EAAE,gBAAgB,EAGlD,EAUF,CAAC,EACL,IAAK,IAAM,KAAK,EAAS,CACxB,IAAM,EAAO,EAAE,YAAY,EAAI,YAC3B,CAAC,CAAQ,CAAC,EAAK,EAAE,CACpB,CAAQ,CAAC,EAAK,CAAG,CAChB,aAAc,EACd,eAAgB,EAChB,mBAAoB,EACpB,YAAa,EACb,WAAY,EACZ,QAAS,EACV,EAED,CAAQ,CAAC,EAAK,CAAC,YAAY,EAAI,EAAE,oBAAoB,EAAI,EACzD,CAAQ,CAAC,EAAK,CAAC,cAAc,EAAI,EAAE,wBAAwB,EAAI,EAC/D,CAAQ,CAAC,EAAK,CAAC,kBAAkB,EAAI,EAAE,0BAA0B,EAAI,EACrE,CAAQ,CAAC,EAAK,CAAC,WAAW,EACxB,CAAC,EAAE,oBAAoB,GAAI,CAAC,EAAK,EAAD,AAAG,oBAAoB,GAAI,CAAC,CAAK,IACnE,CAAQ,CAAC,EAAK,CAAC,UAAU,EAAI,EAAE,oBAAoB,EAAI,EACvD,CAAQ,CAAC,EAAK,CAAC,OAAO,EAAI,EAAE,gBAAgB,EAAI,CACjD,CAEA,IAAM,EAAS,OAAO,OAAO,CAAC,GAC5B,GAAG,CAAC,CAAC,CAAC,EAAM,EAAK,GAAK,CAAC,MACvB,EACA,aAAc,EAAK,YAAY,CAC/B,aACC,EAAK,UAAU,CAAG,EAAI,EAAK,cAAc,CAAG,EAAK,UAAU,CAAG,EAC/D,iBACC,EAAK,UAAU,CAAG,EAAI,EAAK,kBAAkB,CAAG,EAAK,UAAU,CAAG,EACnE,WACC,EAAK,UAAU,CAAG,EAAK,EAAK,WAAW,CAAG,EAAK,UAAU,CAAI,IAAM,EACpE,QAAS,EAAK,OAAO,CACtB,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,YAAY,CAAG,EAAE,YAAY,EAG1C,EASF,CAAC,EACL,IAAK,IAAM,KAAK,EAAS,CACxB,IAAM,EAAO,EAAE,IACX,AADe,CACd,CAAe,CAAC,EAAK,EAAE,CAC3B,CAAe,CAAC,EAAK,CAAG,CACvB,UAAW,EAAE,CACb,WAAY,EAAE,CACd,YAAa,EAAE,CACf,UAAW,EACX,UAAW,EACZ,EAED,CAAe,CAAC,EAAK,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,kBAAkB,EAAI,GAC7D,CAAe,CAAC,EAAK,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE,sBAAsB,EAAI,GAClE,CAAe,CAAC,EAAK,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE,oBAAoB,EAAI,GACjE,CAAe,CAAC,EAAK,CAAC,SAAS,EAAI,EAAE,oBAAoB,EAAI,EAC7D,CAAe,CAAC,EAAK,CAAC,SAAS,EAAI,EAAE,oBAAoB,EAAI,CAC9D,CAEA,IAAM,EAAc,OAAO,OAAO,CAAC,GACjC,GAAG,CAAC,CAAC,CAAC,EAAM,EAAK,GAAK,CAAC,MACvB,EACA,iBACC,EAAK,SAAS,CAAC,MAAM,CAAG,EACrB,EAAK,SAAS,CAAC,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAG,GAAK,EAAK,SAAS,CAAC,MAAM,CACjE,EACJ,aACC,EAAK,UAAU,CAAC,MAAM,CAAG,EACtB,EAAK,UAAU,CAAC,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAG,GACzC,EAAK,UAAU,CAAC,MAAM,CACrB,EACJ,WACC,EAAK,WAAW,CAAC,MAAM,CAAG,EACvB,EAAK,WAAW,CAAC,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAG,GAC1C,EAAK,WAAW,CAAC,MAAM,CACtB,EACJ,cAAe,EAAK,SAAS,CAC7B,cAAe,EAAK,SAAS,CAC9B,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,IAAI,CAAC,aAAa,CAAC,EAAE,IAAI,GAGtC,EAAmE,EAAE,CA0B3E,OAzBI,EAAsB,IAAI,AAC7B,EAAmB,IAAI,CAAC,CACvB,KAAM,gBACN,SAAU,EAAsB,GAAK,OAAS,SAC9C,QAAS,CAAC,sBAAsB,EAAE,EAAoB,OAAO,CAAC,GAAG,kCAAkC,CAAC,CACpG,iBAAmB,AAAD,IAAM,CAAA,CAAmB,CAAI,GAChD,GAEG,EAAe,IAAI,AACtB,EAAmB,IAAI,CAAC,CACvB,KAAM,aACN,SAAU,EAAe,GAAK,OAAS,SACvC,QAAS,CAAC,sBAAsB,EAAE,EAAa,OAAO,CAAC,GAAG,sCAAsC,CAAC,CACjG,iBAAmB,CAAC,EAAe,EAAA,CAAE,CAAI,EAAkB,CAC5D,GAEG,EAAgB,IAAI,AACvB,EAAmB,IAAI,CAAC,CACvB,KAAM,UACN,SAAU,EAAgB,GAAK,OAAS,SACxC,QAAS,CAAC,wBAAwB,EAAE,EAAc,OAAO,CAAC,GAAG,+BAA+B,CAAC,CAC7F,iBAAkB,CACnB,GAGM,CACN,QAAS,CACR,iBAAkB,EAClB,oBAAqB,EACrB,sBAAuB,EACvB,kBAAmB,EACnB,kBAAmB,EACnB,qBAAsB,EACtB,gBAAiB,kBACjB,iBACA,CACD,eACA,SACA,cACA,qBACA,CACD,CACD,GA0D+C,CAAA,EAAA,EAAA,KAAA,AAAK,EACpD,MACC,EACA,EAAe,EAAE,IAEjB,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,EAAY,IAAI,KACtB,EAAU,OAAO,CAAC,EAAU,OAAO,GAAK,GAExC,GAAM,CAAE,KAAM,CAAa,CAAE,CAAG,MAAM,EACpC,IAAI,CAAC,mCACL,MAAM,CAAC,KACP,EAAE,CAAC,aAAc,GACjB,GAAG,CAAC,eAAgB,EAAU,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,EACzD,KAAK,CAAC,gBAAiB,CAAE,WAAW,CAAM,GAEtC,EAAU,GAAiB,EAAE,CAG7B,EAAa,EAAQ,MAAM,CAC3B,EACL,EAAa,EACV,EAAQ,MAAM,CAAC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,oBAAwB,EAAI,CAAC,EAAG,GAClE,EACC,EACE,EACL,EAAa,EACV,EAAQ,MAAM,CAAC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,aAAiB,GAAI,CAAC,CAAG,GAC3D,EACC,EACE,EAAe,EAAQ,MAAM,CAClC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,YAAgB,GAAI,CAAC,CACvC,GAEK,EAAc,EAAQ,MAAM,CACjC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,WAAe,GAAI,CAAC,CACtC,GAEK,EAAqB,EAAQ,MAAM,CACxC,AAAC,IAAyB,IAAnB,EAAE,YAAY,EACpB,MAAM,CACF,EAAiB,EAAQ,MAAM,CACpC,AAAC,GAAM,AAAiC,IAAhC,EAAE,qBAAqB,GAAI,CAAC,EACnC,MAAM,CACF,EAAsB,EAAQ,MAAM,CACzC,AAAC,GAAM,AAAC,GAAE,UAAU,GAAI,CAAC,CAAI,IAAM,CAAC,EAAE,qBAAqB,GAAI,CAAC,CAAI,IACnE,MAAM,CAGF,EAUF,CAAC,EACL,IAAK,IAAM,KAAK,EAAS,CACxB,IAAM,EAAW,EAAE,QAAQ,EAAI,eAC3B,CAAC,CAAY,CAAC,EAAS,EAAE,CAC5B,CAAY,CAAC,EAAS,CAAG,CACxB,UAAW,EACX,UAAW,EACX,QAAS,EACT,OAAQ,EACR,QAAS,EAAE,CACX,QAAS,EAAE,CACZ,EAED,CAAY,CAAC,EAAS,CAAC,SAAS,GAChC,CAAY,CAAC,EAAS,CAAC,SAAS,EAAI,EAAE,UAAU,EAAI,EACpD,CAAY,CAAC,EAAS,CAAC,OAAO,EAAI,EAAE,aAAa,EAAI,EACrD,CAAY,CAAC,EAAS,CAAC,MAAM,EAAI,EAAE,YAAY,EAAI,EACnD,CAAY,CAAC,EAAS,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,qBAAqB,EAAI,GAC/D,CAAY,CAAC,EAAS,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,cAAc,EAAI,EACzD,CAEA,IAAM,EAAa,OAAO,OAAO,CAAC,GAChC,GAAG,CAAC,CAAC,CAAC,EAAU,EAAK,GAAK,CAAC,UAC3B,EACA,UAAW,EAAK,SAAS,CACzB,UAAW,EAAK,SAAS,CACzB,QAAS,EAAK,OAAO,CACrB,OAAQ,EAAK,MAAM,CACnB,UACC,EAAK,OAAO,CAAC,MAAM,CAAG,EACnB,EAAK,OAAO,CAAC,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAG,GAAK,EAAK,OAAO,CAAC,MAAM,CAC7D,EACJ,UACC,EAAK,OAAO,CAAC,MAAM,CAAG,EACnB,EAAK,OAAO,CAAC,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAG,GAAK,EAAK,OAAO,CAAC,MAAM,CAC7D,EACL,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,OAAO,CAAG,EAAE,OAAO,EAGhC,EAAgB,EACpB,MAAM,CAAC,AAAC,GAAM,CAAC,EAAE,UAAU,GAAI,CAAC,CAAI,GACpC,KAAK,CAAC,EAAG,IACT,GAAG,CAAE,AAAD,IAAO,AAAC,CACZ,GAAI,EAAE,OAAO,CACb,KAAM,EAAE,SAAS,EAAI,UACrB,SAAU,EAAE,QAAQ,EAAI,gBACxB,UAAW,EAAE,UAAU,EAAI,EAC3B,QAAS,EAAE,aAAa,EAAI,EAC5B,OAAQ,EAAE,YAAY,EAAI,EAC1B,OAAQ,EAAE,qBAAqB,EAAI,EACnC,MACC,CAAC,EAAE,yBAAyB,GAAI,CAAC,CAAI,EACjC,KACD,AAAqC,CAAC,GAArC,EAAE,yBAAyB,GAAI,CAAC,CAC/B,OACA,SACP,CAAC,EA8BF,MAAO,CACN,QAAS,YACR,YACA,YACA,eACA,EACA,iCACA,iBACA,sBACA,CACD,aACA,gBACA,EACA,gBAxCuB,EACtB,MAAM,CAAC,AAAC,IAAyB,IAAnB,EAAE,YAAY,EAAa,CAAC,EAAE,UAAU,GAAI,CAAC,CAAI,GAC/D,KAAK,CAAC,EAAG,IACT,GAAG,CAAC,AAAC,IAAM,AAAC,CACZ,GAAI,EAAE,OAAO,CACb,KAAM,EAAE,SAAS,EAAI,UACrB,cAAe,EAAE,qBAAqB,EAAI,EAC1C,aAAc,EAAE,qBAAqB,EAAI,GACzC,eAAgB,EAAE,sBAAsB,EAAI,iBAC5C,gBAAiB,EAAE,yBAAyB,EAAI,EACjD,CAAC,EA+BD,uBA5B8B,EAC7B,MAAM,CACN,AAAC,GAAM,EAAE,iBAAiB,EAAI,EAAE,iBAAiB,GAAK,EAAE,aAAa,EAErE,KAAK,CAAC,EAAG,IACT,GAAG,CAAC,AAAC,IAAM,AAAC,CACZ,OAAQ,EAAE,OAAO,CACjB,SAAU,EAAE,SAAS,EAAI,UACzB,aAAc,EAAE,aAAa,EAAI,EACjC,iBAAkB,EAAE,iBAAiB,EAAI,EACzC,OAAQ,EAAE,sBAAsB,EAAI,2BACpC,WAAY,EAAE,2BAA2B,EAAI,GAC9C,CAAC,CAiBF,CACD,GAqDyC,CAAA,EAAA,EAAA,KAAA,AAAK,EAC9C,MAAO,IACN,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAE7B,CAAE,KAAM,CAAU,CAAE,CAAG,MAAM,EACjC,IAAI,CAAC,6BACL,MAAM,CAAC,KACP,EAAE,CAAC,aAAc,GACjB,KAAK,CAAC,eAAgB,CAAE,WAAW,CAAM,GACzC,KAAK,CAAC,KAEF,EAAU,GAAc,EAAE,CAG1B,EAAiB,EAAQ,MAAM,CAC/B,EACL,EAAiB,EACd,EAAQ,MAAM,CAAC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,WAAe,EAAI,CAAC,EAAG,GACzD,EACC,EACE,EACL,EAAiB,EACd,EAAQ,MAAM,CAAC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,gBAAoB,GAAI,CAAC,CAAG,GAC9D,EACC,EAGE,EAAe,EAAQ,MAAM,CAAC,AAAC,GAAM,AAAc,UAAZ,OAAO,EAAY,MAAM,CAChE,EAAiB,EAAQ,MAAM,CAAC,AAAC,GAAoB,UAAd,EAAE,OAAO,EAAc,MAAM,CACpE,EAAkB,EAAQ,MAAM,CACrC,AAAC,GAAoB,YAAd,EAAE,OAAO,EAAkB,CAAC,EAAE,iBAAiB,GAAI,CAAC,CAAI,IAC9D,MAAM,CACF,EAAmB,EAAQ,MAAM,CACrC,AAAD,GAAqB,YAAd,EAAE,OAAO,EACf,MAAM,CACF,EAA2B,EAAQ,MAAM,CAC9C,AAAC,GACA,CAAC,EAAE,iBAAiB,EAAI,CAAC,EAAI,IAC7B,CAAC,EAAE,uBAAuB,GAAI,CAAC,CAAI,IACnC,MAAM,CAGF,EASF,CAAC,EACL,IAAK,IAAM,KAAK,EAAS,CACxB,IAAM,EAAU,EAAE,OAAO,EAAI,SACzB,CAAC,CAAW,CAAC,EAAQ,EAAE,CAC1B,CAAW,CAAC,EAAQ,CAAG,CACtB,MAAO,EACP,aAAc,EAAE,CAChB,eAAgB,EAAE,CAClB,mBAAoB,EAAE,CACtB,QAAS,EACV,EAED,CAAW,CAAC,EAAQ,CAAC,KAAK,GAC1B,CAAW,CAAC,EAAQ,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,YAAY,EAAI,GACzD,CAAW,CAAC,EAAQ,CAAC,cAAc,CAAC,IAAI,CAAC,EAAE,cAAc,EAAI,GAC7D,CAAW,CAAC,EAAQ,CAAC,kBAAkB,CAAC,IAAI,CAAC,EAAE,iBAAiB,EAAI,GACpE,CAAW,CAAC,EAAQ,CAAC,OAAO,EAAI,EAAE,aAAa,EAAI,CACpD,CAEA,IAAM,EAAY,OAAO,OAAO,CAAC,GAC/B,GAAG,CAAC,CAAC,CAAC,EAAS,EAAK,GAAK,CAAC,SAC1B,EACA,MAAO,EAAK,KAAK,CACjB,eACC,EAAK,YAAY,CAAC,MAAM,CAAG,EACxB,EAAK,YAAY,CAAC,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAG,GAC3C,EAAK,YAAY,CAAC,MAAM,CACvB,EACJ,iBACC,EAAK,cAAc,CAAC,MAAM,CAAG,EAC1B,EAAK,cAAc,CAAC,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAG,GAC7C,EAAK,cAAc,CAAC,MAAM,CACzB,EACJ,oBACC,EAAK,kBAAkB,CAAC,MAAM,CAAG,EAC9B,EAAK,kBAAkB,CAAC,MAAM,CAAC,CAAC,EAAG,IAAM,EAAI,EAAG,GACjD,EAAK,kBAAkB,CAAC,MAAM,CAC7B,EACJ,QAAS,EAAK,OAAO,CACtB,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,KAAK,CAAG,EAAE,KAAK,EAG5B,EAAsB,EAC1B,MAAM,CAAC,AAAC,GAAM,CAAC,EAAE,iBAAiB,GAAI,CAAC,CAAI,IAC3C,KAAK,CAAC,EAAG,IACT,GAAG,CAAC,AAAC,IACL,IAAM,EAAwB,EAAE,AAC5B,EAAC,EAAE,uBAAuB,GAAI,CAAC,CAAI,KACtC,EAAY,IAAI,CAAC,2BACd,AAA4B,IAA3B,EAAE,gBAAgB,GAAI,CAAC,EAAQ,EAAY,IAAI,CAAC,kBACjD,AAA6B,IAA5B,EAAE,iBAAiB,GAAI,CAAC,EAC5B,EAAY,IAAI,CAAC,4BACW,AAAzB,IAAC,EAAE,aAAa,GAAI,CAAC,EAAQ,EAAY,IAAI,CAAC,kBAC9C,AAA0B,IAAzB,EAAE,cAAc,GAAI,CAAC,EACzB,EAAY,IAAI,CAAC,uBAElB,IAAI,EAAoB,0BAQxB,MAPI,AAAc,UAAZ,OAAO,CACZ,EAAoB,+BACZ,CAAC,EAAE,uBAAuB,GAAI,CAAC,CAAI,IAC3C,EAAoB,wBACZ,AAA0B,GAAzB,GAAE,cAAc,GAAI,CAAC,GAC9B,EAAoB,yBAAA,EAEd,CACN,GAAI,EAAE,WAAW,CACjB,KAAM,EAAE,aAAa,EAAI,UACzB,YAAa,EAAE,YAAY,EAAI,EAC/B,iBAAkB,EAAE,iBAAiB,EAAI,EACzC,qBAAsB,EAAE,uBAAuB,EAAI,EACnD,cAAe,EAAE,cAAc,EAAI,cACnC,EACA,mBACD,CACD,GACC,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,gBAAgB,CAAG,EAAE,gBAAgB,EAGlD,EAAgC,EAAQ,MAAM,CACnD,AAAC,GAAM,CAAC,EAAE,cAAc,GAAI,CAAC,CAAI,GAChC,MAAM,CAKF,EACL,EAAiB,EACd,EAAQ,MAAM,CACd,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,wBAA4B,GAAI,CAAC,CACnD,GACG,EACH,EACE,EAAuB,EAAQ,MAAM,CAC1C,AAAC,GACA,AAAmC,IAAlC,EAAE,uBAAuB,GAAI,CAAC,EAAU,CAAC,EAAE,cAAc,GAAI,CAAC,CAAI,GACnE,MAAM,CACF,EAAc,EAAQ,MAAM,CACjC,AAAC,GAAM,CAAC,EAAE,uBAAuB,EAAI,GAAA,CAAG,CAAI,KAC3C,MAAM,CAUF,EAA4D,EAAE,CAC9D,EAAQ,IAAI,KAClB,IAAK,IAAI,EAAI,GAAI,GAAK,EAAG,IAAK,CAC7B,IAAM,EAAO,IAAI,KAAK,GACtB,EAAK,OAAO,CAAC,EAAK,OAAO,GAAK,GAC9B,EAAa,IAAI,CAAC,CACjB,KAAM,EAAK,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,CACtC,eAAgB,EAAiB,CAAC,KAAK,MAAM,GAAK,EAAA,CAAG,CAAI,EACzD,YAAa,EAAkB,KAAK,KAAK,CAAC,CAAC,KAAK,MAAM,GAAK,EAAA,CAAG,CAAI,GAClE,aAAc,EAAmB,KAAK,KAAK,CAAC,CAAC,KAAK,MAAM,GAAK,EAAA,CAAG,CAAI,EACrE,EACD,CAEA,MAAO,CACN,QAAS,gBACR,iBACA,EACA,8BACA,EACA,mCACA,sBACA,2BACA,CACD,YACA,EACA,gBAAiB,eACjB,EACA,iBAAkB,CACjB,mBAlCD,EAAiB,EACb,CAAC,IAAiB,CAA2B,CAAC,CAAI,EACpD,IACC,IAgCF,iBArCD,EAAc,EAAK,EAAuB,EAAe,IAAM,yBAsC9D,EACA,mBAzDD,EAAiB,EACb,EAAgC,EAAkB,IACnD,CAwDH,CACD,CACD"}