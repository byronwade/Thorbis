{"version":3,"sources":["../../../../../../apps/web/src/lib/queries/analytics.ts"],"sourcesContent":["import { cache } from \"react\";\nimport { createClient } from \"@/lib/supabase/server\";\n\nexport interface DailyMetric {\n\tdate: string;\n\tvalue: number;\n\tvalue2?: number;\n}\n\nexport interface AnalyticsTrendData {\n\trevenue: DailyMetric[];\n\tjobs: DailyMetric[];\n\tcommunications: DailyMetric[];\n}\n\n/**\n * Get analytics trend data for charts\n * Uses analytics_daily_snapshots if available, otherwise calculates from raw data\n */\nexport const getAnalyticsTrends = cache(async (companyId: string, days: number = 90): Promise<AnalyticsTrendData> => {\n\tconst supabase = await createClient();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\n\t// Try to get data from analytics_daily_snapshots first\n\tconst { data: snapshots } = await supabase\n\t\t.from(\"analytics_daily_snapshots\")\n\t\t.select(\"snapshot_date, total_revenue, jobs_completed, emails_sent, emails_received, sms_sent, sms_received, calls_made, calls_received\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.gte(\"snapshot_date\", startDate.toISOString().split(\"T\")[0])\n\t\t.order(\"snapshot_date\", { ascending: true })\n\t\t.limit(days);\n\n\tif (snapshots && snapshots.length > 0) {\n\t\treturn {\n\t\t\trevenue: snapshots.map((s) => ({\n\t\t\t\tdate: s.snapshot_date,\n\t\t\t\tvalue: (s.total_revenue || 0) / 100, // Convert cents to dollars\n\t\t\t})),\n\t\t\tjobs: snapshots.map((s) => ({\n\t\t\t\tdate: s.snapshot_date,\n\t\t\t\tvalue: s.jobs_completed || 0,\n\t\t\t})),\n\t\t\tcommunications: snapshots.map((s) => ({\n\t\t\t\tdate: s.snapshot_date,\n\t\t\t\tvalue: (s.emails_sent || 0) + (s.sms_sent || 0) + (s.calls_made || 0),\n\t\t\t\tvalue2: (s.emails_received || 0) + (s.sms_received || 0) + (s.calls_received || 0),\n\t\t\t})),\n\t\t};\n\t}\n\n\t// Fallback: Calculate from raw data if no snapshots exist\n\t// This is a temporary solution until the cron job populates snapshots\n\tconst [revenueData, jobsData, commsData] = await Promise.all([\n\t\tgetRevenueByDay(supabase, companyId, startDate, days),\n\t\tgetJobsByDay(supabase, companyId, startDate, days),\n\t\tgetCommunicationsByDay(supabase, companyId, startDate, days),\n\t]);\n\n\treturn {\n\t\trevenue: revenueData,\n\t\tjobs: jobsData,\n\t\tcommunications: commsData,\n\t};\n});\n\n// Helper function to generate date range\nfunction generateDateRange(startDate: Date, days: number): string[] {\n\tconst dates: string[] = [];\n\tconst current = new Date(startDate);\n\tfor (let i = 0; i < days; i++) {\n\t\tdates.push(current.toISOString().split(\"T\")[0]);\n\t\tcurrent.setDate(current.getDate() + 1);\n\t}\n\treturn dates;\n}\n\n// Get revenue by day from payments\nasync function getRevenueByDay(supabase: Awaited<ReturnType<typeof createClient>>, companyId: string, startDate: Date, days: number): Promise<DailyMetric[]> {\n\tconst { data: payments } = await supabase\n\t\t.from(\"payments\")\n\t\t.select(\"amount, created_at\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"completed\")\n\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t.order(\"created_at\", { ascending: true })\n\t\t.limit(10000); // Prevent unbounded query for analytics\n\n\t// Group by day\n\tconst byDay: Record<string, number> = {};\n\tconst dateRange = generateDateRange(startDate, days);\n\n\t// Initialize all days with 0\n\tfor (const date of dateRange) {\n\t\tbyDay[date] = 0;\n\t}\n\n\t// Sum payments by day\n\tfor (const payment of payments || []) {\n\t\tconst date = new Date(payment.created_at).toISOString().split(\"T\")[0];\n\t\tif (byDay[date] !== undefined) {\n\t\t\tbyDay[date] += (payment.amount || 0) / 100; // Convert cents to dollars\n\t\t}\n\t}\n\n\treturn dateRange.map((date) => ({\n\t\tdate,\n\t\tvalue: byDay[date] || 0,\n\t}));\n}\n\n// Get jobs completed by day\nasync function getJobsByDay(supabase: Awaited<ReturnType<typeof createClient>>, companyId: string, startDate: Date, days: number): Promise<DailyMetric[]> {\n\tconst { data: jobs } = await supabase\n\t\t.from(\"jobs\")\n\t\t.select(\"created_at, status\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"completed\")\n\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t.order(\"created_at\", { ascending: true })\n\t\t.limit(10000); // Prevent unbounded query for analytics\n\n\t// Group by day\n\tconst byDay: Record<string, number> = {};\n\tconst dateRange = generateDateRange(startDate, days);\n\n\t// Initialize all days with 0\n\tfor (const date of dateRange) {\n\t\tbyDay[date] = 0;\n\t}\n\n\t// Count jobs by day\n\tfor (const job of jobs || []) {\n\t\tconst date = new Date(job.created_at).toISOString().split(\"T\")[0];\n\t\tif (byDay[date] !== undefined) {\n\t\t\tbyDay[date]++;\n\t\t}\n\t}\n\n\treturn dateRange.map((date) => ({\n\t\tdate,\n\t\tvalue: byDay[date] || 0,\n\t}));\n}\n\n// Get communications by day\nasync function getCommunicationsByDay(supabase: Awaited<ReturnType<typeof createClient>>, companyId: string, startDate: Date, days: number): Promise<DailyMetric[]> {\n\tconst { data: comms } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\"created_at, direction\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t.order(\"created_at\", { ascending: true })\n\t\t.limit(10000); // Prevent unbounded query for analytics\n\n\t// Group by day\n\tconst outbound: Record<string, number> = {};\n\tconst inbound: Record<string, number> = {};\n\tconst dateRange = generateDateRange(startDate, days);\n\n\t// Initialize all days with 0\n\tfor (const date of dateRange) {\n\t\toutbound[date] = 0;\n\t\tinbound[date] = 0;\n\t}\n\n\t// Count comms by day and direction\n\tfor (const comm of comms || []) {\n\t\tconst date = new Date(comm.created_at).toISOString().split(\"T\")[0];\n\t\tif (outbound[date] !== undefined) {\n\t\t\tif (comm.direction === \"outbound\") {\n\t\t\t\toutbound[date]++;\n\t\t\t} else {\n\t\t\t\tinbound[date]++;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn dateRange.map((date) => ({\n\t\tdate,\n\t\tvalue: outbound[date] || 0,\n\t\tvalue2: inbound[date] || 0,\n\t}));\n}\n\n/**\n * Get KPI summary for a company\n */\nexport const getKPISummary = cache(async (companyId: string) => {\n\tconst supabase = await createClient();\n\n\t// Get the latest monthly technician metrics summary\n\tconst { data: kpiData } = await supabase\n\t\t.from(\"analytics_technician_metrics\")\n\t\t.select(`\n\t\t\tperiod_start,\n\t\t\tfirst_time_fix_rate,\n\t\t\tutilization_rate,\n\t\t\taverage_rating,\n\t\t\ton_time_rate\n\t\t`)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"period_type\", \"monthly\")\n\t\t.order(\"period_start\", { ascending: false })\n\t\t.limit(1)\n\t\t.single();\n\n\treturn {\n\t\tfirstTimeFixRate: kpiData?.first_time_fix_rate || null,\n\t\tutilizationRate: kpiData?.utilization_rate || null,\n\t\tavgCustomerRating: kpiData?.average_rating || null,\n\t\tonTimeRate: kpiData?.on_time_rate || null,\n\t};\n});\n\n/**\n * Get customer health distribution\n */\nexport const getCustomerHealthDistribution = cache(async (companyId: string) => {\n\tconst supabase = await createClient();\n\n\tconst { data: customers } = await supabase\n\t\t.from(\"customers\")\n\t\t.select(\"churn_risk\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null);\n\n\tconst distribution = {\n\t\tlow: 0,\n\t\tmedium: 0,\n\t\thigh: 0,\n\t\tchurned: 0,\n\t\tunknown: 0,\n\t};\n\n\tfor (const customer of customers || []) {\n\t\tconst risk = customer.churn_risk as keyof typeof distribution;\n\t\tif (risk && distribution[risk] !== undefined) {\n\t\t\tdistribution[risk]++;\n\t\t} else {\n\t\t\tdistribution.unknown++;\n\t\t}\n\t}\n\n\treturn distribution;\n});\n\n/**\n * Get estimate conversion funnel\n */\nexport const getEstimateConversionFunnel = cache(async (companyId: string, days: number = 30) => {\n\tconst supabase = await createClient();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\n\tconst { data: estimates } = await supabase\n\t\t.from(\"estimates\")\n\t\t.select(\"conversion_status\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t.is(\"deleted_at\", null);\n\n\tconst funnel = {\n\t\ttotal: estimates?.length || 0,\n\t\tpending: 0,\n\t\twon: 0,\n\t\tlost: 0,\n\t\texpired: 0,\n\t};\n\n\tfor (const estimate of estimates || []) {\n\t\tconst status = estimate.conversion_status as keyof Omit<typeof funnel, \"total\">;\n\t\tif (status && funnel[status] !== undefined) {\n\t\t\tfunnel[status]++;\n\t\t} else {\n\t\t\tfunnel.pending++;\n\t\t}\n\t}\n\n\treturn {\n\t\t...funnel,\n\t\tconversionRate: funnel.total > 0 ? (funnel.won / funnel.total) * 100 : 0,\n\t};\n});\n\n/**\n * Get invoice aging summary\n */\nexport const getInvoiceAgingSummary = cache(async (companyId: string) => {\n\tconst supabase = await createClient();\n\n\tconst { data: invoices } = await supabase\n\t\t.from(\"invoices\")\n\t\t.select(\"aging_bucket, balance_amount\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.not(\"status\", \"in\", '(\"paid\", \"void\", \"cancelled\")')\n\t\t.is(\"deleted_at\", null);\n\n\tconst aging = {\n\t\tcurrent: { count: 0, amount: 0 },\n\t\t\"1_30\": { count: 0, amount: 0 },\n\t\t\"31_60\": { count: 0, amount: 0 },\n\t\t\"61_90\": { count: 0, amount: 0 },\n\t\tover_90: { count: 0, amount: 0 },\n\t};\n\n\tfor (const invoice of invoices || []) {\n\t\tconst bucket = (invoice.aging_bucket || \"current\") as keyof typeof aging;\n\t\tif (aging[bucket]) {\n\t\t\taging[bucket].count++;\n\t\t\taging[bucket].amount += (invoice.balance_amount || 0) / 100;\n\t\t}\n\t}\n\n\treturn aging;\n});\n\n// ============================================\n// REPORT QUERIES\n// ============================================\n\nexport interface RevenueReportData {\n\tsummary: {\n\t\ttotalRevenue: number;\n\t\tpreviousPeriodRevenue: number;\n\t\tgrowthPercent: number;\n\t\taverageTicket: number;\n\t\ttotalJobs: number;\n\t\ttotalPayments: number;\n\t};\n\tbyMonth: Array<{\n\t\tmonth: string;\n\t\trevenue: number;\n\t\tjobCount: number;\n\t\tavgTicket: number;\n\t}>;\n\tbyJobType: Array<{\n\t\tjobType: string;\n\t\trevenue: number;\n\t\tpercentage: number;\n\t\tcount: number;\n\t}>;\n\tbyPaymentMethod: Array<{\n\t\tmethod: string;\n\t\tamount: number;\n\t\tcount: number;\n\t\tpercentage: number;\n\t}>;\n\ttopCustomers: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\trevenue: number;\n\t\tjobCount: number;\n\t}>;\n}\n\n/**\n * Get comprehensive revenue report data\n */\nexport const getRevenueReport = cache(async (companyId: string, days: number = 90): Promise<RevenueReportData> => {\n\tconst supabase = await createClient();\n\tconst endDate = new Date();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\n\tconst previousStartDate = new Date(startDate);\n\tpreviousStartDate.setDate(previousStartDate.getDate() - days);\n\n\t// Get payments for current and previous period\n\tconst [currentPayments, previousPayments, jobsData, customerRevenue] = await Promise.all([\n\t\tsupabase\n\t\t\t.from(\"payments\")\n\t\t\t.select(\"id, amount, payment_method, created_at, customer_id\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"completed\")\n\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t.lte(\"created_at\", endDate.toISOString()),\n\t\tsupabase\n\t\t\t.from(\"payments\")\n\t\t\t.select(\"amount\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"completed\")\n\t\t\t.gte(\"created_at\", previousStartDate.toISOString())\n\t\t\t.lt(\"created_at\", startDate.toISOString()),\n\t\tsupabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"id, job_type, total_revenue, customer_id, created_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"completed\")\n\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t.is(\"deleted_at\", null),\n\t\tsupabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(`\n\t\t\t\tcustomer_id,\n\t\t\t\ttotal_revenue,\n\t\t\t\tcustomers:customers!customer_id(id, display_name, first_name, last_name)\n\t\t\t`)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"completed\")\n\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t.is(\"deleted_at\", null),\n\t]);\n\n\tconst payments = currentPayments.data || [];\n\tconst prevPayments = previousPayments.data || [];\n\tconst jobs = jobsData.data || [];\n\tconst customerJobs = customerRevenue.data || [];\n\n\t// Calculate totals\n\tconst totalRevenue = payments.reduce((sum, p) => sum + (p.amount || 0), 0) / 100;\n\tconst previousPeriodRevenue = prevPayments.reduce((sum, p) => sum + (p.amount || 0), 0) / 100;\n\tconst growthPercent = previousPeriodRevenue > 0\n\t\t? ((totalRevenue - previousPeriodRevenue) / previousPeriodRevenue) * 100\n\t\t: 0;\n\n\t// By month\n\tconst byMonth: Record<string, { revenue: number; jobCount: number }> = {};\n\tfor (const payment of payments) {\n\t\tconst month = new Date(payment.created_at).toISOString().substring(0, 7);\n\t\tif (!byMonth[month]) byMonth[month] = { revenue: 0, jobCount: 0 };\n\t\tbyMonth[month].revenue += (payment.amount || 0) / 100;\n\t}\n\tfor (const job of jobs) {\n\t\tconst month = new Date(job.created_at).toISOString().substring(0, 7);\n\t\tif (byMonth[month]) byMonth[month].jobCount++;\n\t}\n\n\t// By job type\n\tconst byJobType: Record<string, { revenue: number; count: number }> = {};\n\tfor (const job of jobs) {\n\t\tconst type = job.job_type || \"Other\";\n\t\tif (!byJobType[type]) byJobType[type] = { revenue: 0, count: 0 };\n\t\tbyJobType[type].revenue += (job.total_revenue || 0) / 100;\n\t\tbyJobType[type].count++;\n\t}\n\n\t// By payment method\n\tconst byPaymentMethod: Record<string, { amount: number; count: number }> = {};\n\tfor (const payment of payments) {\n\t\tconst method = payment.payment_method || \"Other\";\n\t\tif (!byPaymentMethod[method]) byPaymentMethod[method] = { amount: 0, count: 0 };\n\t\tbyPaymentMethod[method].amount += (payment.amount || 0) / 100;\n\t\tbyPaymentMethod[method].count++;\n\t}\n\n\t// Top customers\n\tconst customerTotals: Record<string, { name: string; revenue: number; jobCount: number }> = {};\n\tfor (const job of customerJobs) {\n\t\tconst customerId = job.customer_id;\n\t\tif (!customerId) continue;\n\t\tconst customer = job.customers as { id: string; display_name: string | null; first_name: string | null; last_name: string | null } | null;\n\t\tconst name = customer?.display_name ||\n\t\t\t[customer?.first_name, customer?.last_name].filter(Boolean).join(\" \") ||\n\t\t\t\"Unknown\";\n\t\tif (!customerTotals[customerId]) customerTotals[customerId] = { name, revenue: 0, jobCount: 0 };\n\t\tcustomerTotals[customerId].revenue += (job.total_revenue || 0) / 100;\n\t\tcustomerTotals[customerId].jobCount++;\n\t}\n\n\treturn {\n\t\tsummary: {\n\t\t\ttotalRevenue,\n\t\t\tpreviousPeriodRevenue,\n\t\t\tgrowthPercent,\n\t\t\taverageTicket: jobs.length > 0 ? totalRevenue / jobs.length : 0,\n\t\t\ttotalJobs: jobs.length,\n\t\t\ttotalPayments: payments.length,\n\t\t},\n\t\tbyMonth: Object.entries(byMonth)\n\t\t\t.map(([month, data]) => ({\n\t\t\t\tmonth,\n\t\t\t\trevenue: data.revenue,\n\t\t\t\tjobCount: data.jobCount,\n\t\t\t\tavgTicket: data.jobCount > 0 ? data.revenue / data.jobCount : 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => a.month.localeCompare(b.month)),\n\t\tbyJobType: Object.entries(byJobType)\n\t\t\t.map(([jobType, data]) => ({\n\t\t\t\tjobType,\n\t\t\t\trevenue: data.revenue,\n\t\t\t\tcount: data.count,\n\t\t\t\tpercentage: totalRevenue > 0 ? (data.revenue / totalRevenue) * 100 : 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.revenue - a.revenue),\n\t\tbyPaymentMethod: Object.entries(byPaymentMethod)\n\t\t\t.map(([method, data]) => ({\n\t\t\t\tmethod,\n\t\t\t\tamount: data.amount,\n\t\t\t\tcount: data.count,\n\t\t\t\tpercentage: totalRevenue > 0 ? (data.amount / totalRevenue) * 100 : 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.amount - a.amount),\n\t\ttopCustomers: Object.entries(customerTotals)\n\t\t\t.map(([id, data]) => ({ id, ...data }))\n\t\t\t.sort((a, b) => b.revenue - a.revenue)\n\t\t\t.slice(0, 10),\n\t};\n});\n\nexport interface JobPerformanceReportData {\n\tsummary: {\n\t\ttotalJobs: number;\n\t\tcompletedJobs: number;\n\t\tcompletionRate: number;\n\t\taverageDuration: number;\n\t\tfirstTimeFixRate: number;\n\t\tcallbackRate: number;\n\t};\n\tbyStatus: Array<{\n\t\tstatus: string;\n\t\tcount: number;\n\t\tpercentage: number;\n\t}>;\n\tbyTechnician: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tjobsCompleted: number;\n\t\tavgDuration: number;\n\t\tavgRevenue: number;\n\t\tfirstTimeFixRate: number;\n\t}>;\n\tbyJobType: Array<{\n\t\tjobType: string;\n\t\tcount: number;\n\t\tavgDuration: number;\n\t\tavgRevenue: number;\n\t\tcompletionRate: number;\n\t}>;\n\ttrendsWeekly: Array<{\n\t\tweek: string;\n\t\tcompleted: number;\n\t\tscheduled: number;\n\t\tcancelled: number;\n\t}>;\n}\n\n/**\n * Get job performance report data\n */\nexport const getJobPerformanceReport = cache(async (companyId: string, days: number = 90): Promise<JobPerformanceReportData> => {\n\tconst supabase = await createClient();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\n\tconst { data: jobs } = await supabase\n\t\t.from(\"jobs\")\n\t\t.select(`\n\t\t\tid, status, job_type, actual_duration_minutes, total_revenue, is_callback,\n\t\t\tassigned_to, created_at,\n\t\t\tassigned_user:users!assigned_to(id, first_name, last_name)\n\t\t`)\n\t\t.eq(\"company_id\", companyId)\n\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t.is(\"deleted_at\", null);\n\n\tconst allJobs = jobs || [];\n\tconst completedJobs = allJobs.filter(j => j.status === \"completed\");\n\tconst callbacks = completedJobs.filter(j => j.is_callback === true);\n\n\t// By status\n\tconst statusCounts: Record<string, number> = {};\n\tfor (const job of allJobs) {\n\t\tconst status = job.status || \"unknown\";\n\t\tstatusCounts[status] = (statusCounts[status] || 0) + 1;\n\t}\n\n\t// By technician\n\tconst techStats: Record<string, { name: string; completed: number; totalDuration: number; totalRevenue: number; firstTimeFixes: number }> = {};\n\tfor (const job of completedJobs) {\n\t\tconst techId = job.assigned_to;\n\t\tif (!techId) continue;\n\t\tconst user = job.assigned_user as { id: string; first_name: string | null; last_name: string | null } | null;\n\t\tconst name = [user?.first_name, user?.last_name].filter(Boolean).join(\" \") || \"Unassigned\";\n\t\tif (!techStats[techId]) techStats[techId] = { name, completed: 0, totalDuration: 0, totalRevenue: 0, firstTimeFixes: 0 };\n\t\ttechStats[techId].completed++;\n\t\ttechStats[techId].totalDuration += job.actual_duration_minutes || 0;\n\t\ttechStats[techId].totalRevenue += (job.total_revenue || 0) / 100;\n\t\tif (!job.is_callback) techStats[techId].firstTimeFixes++;\n\t}\n\n\t// By job type\n\tconst typeStats: Record<string, { total: number; completed: number; totalDuration: number; totalRevenue: number }> = {};\n\tfor (const job of allJobs) {\n\t\tconst type = job.job_type || \"Other\";\n\t\tif (!typeStats[type]) typeStats[type] = { total: 0, completed: 0, totalDuration: 0, totalRevenue: 0 };\n\t\ttypeStats[type].total++;\n\t\tif (job.status === \"completed\") {\n\t\t\ttypeStats[type].completed++;\n\t\t\ttypeStats[type].totalDuration += job.actual_duration_minutes || 0;\n\t\t\ttypeStats[type].totalRevenue += (job.total_revenue || 0) / 100;\n\t\t}\n\t}\n\n\t// Weekly trends\n\tconst weeklyData: Record<string, { completed: number; scheduled: number; cancelled: number }> = {};\n\tfor (const job of allJobs) {\n\t\tconst date = new Date(job.created_at);\n\t\tconst week = getWeekStart(date);\n\t\tif (!weeklyData[week]) weeklyData[week] = { completed: 0, scheduled: 0, cancelled: 0 };\n\t\tif (job.status === \"completed\") weeklyData[week].completed++;\n\t\telse if (job.status === \"scheduled\") weeklyData[week].scheduled++;\n\t\telse if (job.status === \"cancelled\") weeklyData[week].cancelled++;\n\t}\n\n\tconst avgDuration = completedJobs.length > 0\n\t\t? completedJobs.reduce((sum, j) => sum + (j.actual_duration_minutes || 0), 0) / completedJobs.length\n\t\t: 0;\n\n\treturn {\n\t\tsummary: {\n\t\t\ttotalJobs: allJobs.length,\n\t\t\tcompletedJobs: completedJobs.length,\n\t\t\tcompletionRate: allJobs.length > 0 ? (completedJobs.length / allJobs.length) * 100 : 0,\n\t\t\taverageDuration: avgDuration,\n\t\t\tfirstTimeFixRate: completedJobs.length > 0 ? ((completedJobs.length - callbacks.length) / completedJobs.length) * 100 : 0,\n\t\t\tcallbackRate: completedJobs.length > 0 ? (callbacks.length / completedJobs.length) * 100 : 0,\n\t\t},\n\t\tbyStatus: Object.entries(statusCounts)\n\t\t\t.map(([status, count]) => ({\n\t\t\t\tstatus,\n\t\t\t\tcount,\n\t\t\t\tpercentage: allJobs.length > 0 ? (count / allJobs.length) * 100 : 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.count - a.count),\n\t\tbyTechnician: Object.entries(techStats)\n\t\t\t.map(([id, data]) => ({\n\t\t\t\tid,\n\t\t\t\tname: data.name,\n\t\t\t\tjobsCompleted: data.completed,\n\t\t\t\tavgDuration: data.completed > 0 ? data.totalDuration / data.completed : 0,\n\t\t\t\tavgRevenue: data.completed > 0 ? data.totalRevenue / data.completed : 0,\n\t\t\t\tfirstTimeFixRate: data.completed > 0 ? (data.firstTimeFixes / data.completed) * 100 : 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.jobsCompleted - a.jobsCompleted),\n\t\tbyJobType: Object.entries(typeStats)\n\t\t\t.map(([jobType, data]) => ({\n\t\t\t\tjobType,\n\t\t\t\tcount: data.total,\n\t\t\t\tavgDuration: data.completed > 0 ? data.totalDuration / data.completed : 0,\n\t\t\t\tavgRevenue: data.completed > 0 ? data.totalRevenue / data.completed : 0,\n\t\t\t\tcompletionRate: data.total > 0 ? (data.completed / data.total) * 100 : 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.count - a.count),\n\t\ttrendsWeekly: Object.entries(weeklyData)\n\t\t\t.map(([week, data]) => ({ week, ...data }))\n\t\t\t.sort((a, b) => a.week.localeCompare(b.week)),\n\t};\n});\n\nfunction getWeekStart(date: Date): string {\n\tconst d = new Date(date);\n\tconst day = d.getDay();\n\tconst diff = d.getDate() - day;\n\td.setDate(diff);\n\treturn d.toISOString().split(\"T\")[0];\n}\n\nexport interface FinancialReportData {\n\tsummary: {\n\t\ttotalRevenue: number;\n\t\ttotalCost: number;\n\t\tgrossProfit: number;\n\t\tgrossMargin: number;\n\t\toutstandingAR: number;\n\t\toverdueAR: number;\n\t};\n\tarAging: {\n\t\tcurrent: { count: number; amount: number };\n\t\tdays1_30: { count: number; amount: number };\n\t\tdays31_60: { count: number; amount: number };\n\t\tdays61_90: { count: number; amount: number };\n\t\tover90: { count: number; amount: number };\n\t};\n\tmonthlyPL: Array<{\n\t\tmonth: string;\n\t\trevenue: number;\n\t\tcost: number;\n\t\tprofit: number;\n\t\tmargin: number;\n\t}>;\n\tcashFlow: Array<{\n\t\tmonth: string;\n\t\tinflows: number;\n\t\toutflows: number;\n\t\tnet: number;\n\t}>;\n}\n\n/**\n * Get financial report data\n */\nexport const getFinancialReport = cache(async (companyId: string, days: number = 365): Promise<FinancialReportData> => {\n\tconst supabase = await createClient();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\tconst today = new Date();\n\n\tconst [paymentsResult, invoicesResult, jobsResult] = await Promise.all([\n\t\tsupabase\n\t\t\t.from(\"payments\")\n\t\t\t.select(\"amount, created_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"completed\")\n\t\t\t.gte(\"created_at\", startDate.toISOString()),\n\t\tsupabase\n\t\t\t.from(\"invoices\")\n\t\t\t.select(\"id, balance_amount, due_date, status\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.not(\"status\", \"in\", '(\"paid\", \"void\", \"cancelled\")')\n\t\t\t.is(\"deleted_at\", null),\n\t\tsupabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"total_revenue, total_cost_actual, created_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"completed\")\n\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t.is(\"deleted_at\", null),\n\t]);\n\n\tconst payments = paymentsResult.data || [];\n\tconst invoices = invoicesResult.data || [];\n\tconst jobs = jobsResult.data || [];\n\n\t// Calculate totals\n\tconst totalRevenue = jobs.reduce((sum, j) => sum + ((j.total_revenue || 0) / 100), 0);\n\tconst totalCost = jobs.reduce((sum, j) => sum + ((j.total_cost_actual || 0) / 100), 0);\n\tconst grossProfit = totalRevenue - totalCost;\n\tconst grossMargin = totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;\n\n\t// AR Aging\n\tconst arAging = {\n\t\tcurrent: { count: 0, amount: 0 },\n\t\tdays1_30: { count: 0, amount: 0 },\n\t\tdays31_60: { count: 0, amount: 0 },\n\t\tdays61_90: { count: 0, amount: 0 },\n\t\tover90: { count: 0, amount: 0 },\n\t};\n\n\tlet outstandingAR = 0;\n\tlet overdueAR = 0;\n\n\tfor (const invoice of invoices) {\n\t\tconst balance = (invoice.balance_amount || 0) / 100;\n\t\toutstandingAR += balance;\n\n\t\tif (!invoice.due_date) {\n\t\t\tarAging.current.count++;\n\t\t\tarAging.current.amount += balance;\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst dueDate = new Date(invoice.due_date);\n\t\tconst daysPastDue = Math.floor((today.getTime() - dueDate.getTime()) / (1000 * 60 * 60 * 24));\n\n\t\tif (daysPastDue <= 0) {\n\t\t\tarAging.current.count++;\n\t\t\tarAging.current.amount += balance;\n\t\t} else if (daysPastDue <= 30) {\n\t\t\tarAging.days1_30.count++;\n\t\t\tarAging.days1_30.amount += balance;\n\t\t\toverdueAR += balance;\n\t\t} else if (daysPastDue <= 60) {\n\t\t\tarAging.days31_60.count++;\n\t\t\tarAging.days31_60.amount += balance;\n\t\t\toverdueAR += balance;\n\t\t} else if (daysPastDue <= 90) {\n\t\t\tarAging.days61_90.count++;\n\t\t\tarAging.days61_90.amount += balance;\n\t\t\toverdueAR += balance;\n\t\t} else {\n\t\t\tarAging.over90.count++;\n\t\t\tarAging.over90.amount += balance;\n\t\t\toverdueAR += balance;\n\t\t}\n\t}\n\n\t// Monthly P&L\n\tconst monthlyPL: Record<string, { revenue: number; cost: number }> = {};\n\tfor (const job of jobs) {\n\t\tconst month = new Date(job.created_at).toISOString().substring(0, 7);\n\t\tif (!monthlyPL[month]) monthlyPL[month] = { revenue: 0, cost: 0 };\n\t\tmonthlyPL[month].revenue += (job.total_revenue || 0) / 100;\n\t\tmonthlyPL[month].cost += (job.total_cost_actual || 0) / 100;\n\t}\n\n\t// Monthly cash flow\n\tconst monthlyCash: Record<string, { inflows: number; outflows: number }> = {};\n\tfor (const payment of payments) {\n\t\tconst month = new Date(payment.created_at).toISOString().substring(0, 7);\n\t\tif (!monthlyCash[month]) monthlyCash[month] = { inflows: 0, outflows: 0 };\n\t\tmonthlyCash[month].inflows += (payment.amount || 0) / 100;\n\t}\n\n\treturn {\n\t\tsummary: {\n\t\t\ttotalRevenue,\n\t\t\ttotalCost,\n\t\t\tgrossProfit,\n\t\t\tgrossMargin,\n\t\t\toutstandingAR,\n\t\t\toverdueAR,\n\t\t},\n\t\tarAging,\n\t\tmonthlyPL: Object.entries(monthlyPL)\n\t\t\t.map(([month, data]) => ({\n\t\t\t\tmonth,\n\t\t\t\trevenue: data.revenue,\n\t\t\t\tcost: data.cost,\n\t\t\t\tprofit: data.revenue - data.cost,\n\t\t\t\tmargin: data.revenue > 0 ? ((data.revenue - data.cost) / data.revenue) * 100 : 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => a.month.localeCompare(b.month)),\n\t\tcashFlow: Object.entries(monthlyCash)\n\t\t\t.map(([month, data]) => ({\n\t\t\t\tmonth,\n\t\t\t\tinflows: data.inflows,\n\t\t\t\toutflows: data.outflows,\n\t\t\t\tnet: data.inflows - data.outflows,\n\t\t\t}))\n\t\t\t.sort((a, b) => a.month.localeCompare(b.month)),\n\t};\n});\n\nexport interface TeamLeaderboardData {\n\ttechnicians: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\trank: number;\n\t\tjobsCompleted: number;\n\t\trevenue: number;\n\t\tavgRating: number;\n\t\tfirstTimeFixRate: number;\n\t\tavgJobDuration: number;\n\t\tutilizationRate: number;\n\t\tscore: number;\n\t}>;\n\ttopPerformer: {\n\t\tid: string;\n\t\tname: string;\n\t\thighlight: string;\n\t} | null;\n\tteamAverages: {\n\t\tjobsPerTech: number;\n\t\trevenuePerTech: number;\n\t\tavgRating: number;\n\t\tfirstTimeFixRate: number;\n\t};\n}\n\n/**\n * Get team leaderboard data\n */\nexport const getTeamLeaderboard = cache(async (companyId: string, days: number = 30): Promise<TeamLeaderboardData> => {\n\tconst supabase = await createClient();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\n\tconst { data: jobs } = await supabase\n\t\t.from(\"jobs\")\n\t\t.select(`\n\t\t\tid, status, total_revenue, actual_duration_minutes, is_callback, assigned_to,\n\t\t\tassigned_user:users!assigned_to(id, first_name, last_name)\n\t\t`)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"completed\")\n\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t.is(\"deleted_at\", null);\n\n\tconst allJobs = jobs || [];\n\n\t// Aggregate by technician\n\tconst techStats: Record<string, {\n\t\tname: string;\n\t\tcompleted: number;\n\t\trevenue: number;\n\t\ttotalDuration: number;\n\t\tfirstTimeFixes: number;\n\t}> = {};\n\n\tfor (const job of allJobs) {\n\t\tconst techId = job.assigned_to;\n\t\tif (!techId) continue;\n\t\tconst user = job.assigned_user as { id: string; first_name: string | null; last_name: string | null } | null;\n\t\tconst name = [user?.first_name, user?.last_name].filter(Boolean).join(\" \") || \"Unknown\";\n\n\t\tif (!techStats[techId]) {\n\t\t\ttechStats[techId] = { name, completed: 0, revenue: 0, totalDuration: 0, firstTimeFixes: 0 };\n\t\t}\n\t\ttechStats[techId].completed++;\n\t\ttechStats[techId].revenue += (job.total_revenue || 0) / 100;\n\t\ttechStats[techId].totalDuration += job.actual_duration_minutes || 0;\n\t\tif (!job.is_callback) techStats[techId].firstTimeFixes++;\n\t}\n\n\t// Calculate scores and rankings\n\tconst technicians = Object.entries(techStats)\n\t\t.map(([id, data]) => {\n\t\t\tconst firstTimeFixRate = data.completed > 0 ? (data.firstTimeFixes / data.completed) * 100 : 0;\n\t\t\tconst avgDuration = data.completed > 0 ? data.totalDuration / data.completed : 0;\n\t\t\t// Score: weighted combination of metrics\n\t\t\tconst score = (data.completed * 10) + (data.revenue / 100) + (firstTimeFixRate * 2);\n\t\t\treturn {\n\t\t\t\tid,\n\t\t\t\tname: data.name,\n\t\t\t\trank: 0,\n\t\t\t\tjobsCompleted: data.completed,\n\t\t\t\trevenue: data.revenue,\n\t\t\t\tavgRating: 4.5, // Placeholder - would come from reviews\n\t\t\t\tfirstTimeFixRate,\n\t\t\t\tavgJobDuration: avgDuration,\n\t\t\t\tutilizationRate: 75, // Placeholder - would come from scheduling\n\t\t\t\tscore,\n\t\t\t};\n\t\t})\n\t\t.sort((a, b) => b.score - a.score)\n\t\t.map((tech, index) => ({ ...tech, rank: index + 1 }));\n\n\tconst totalTechs = technicians.length;\n\tconst teamAverages = {\n\t\tjobsPerTech: totalTechs > 0 ? technicians.reduce((sum, t) => sum + t.jobsCompleted, 0) / totalTechs : 0,\n\t\trevenuePerTech: totalTechs > 0 ? technicians.reduce((sum, t) => sum + t.revenue, 0) / totalTechs : 0,\n\t\tavgRating: totalTechs > 0 ? technicians.reduce((sum, t) => sum + t.avgRating, 0) / totalTechs : 0,\n\t\tfirstTimeFixRate: totalTechs > 0 ? technicians.reduce((sum, t) => sum + t.firstTimeFixRate, 0) / totalTechs : 0,\n\t};\n\n\treturn {\n\t\ttechnicians,\n\t\ttopPerformer: technicians.length > 0 ? {\n\t\t\tid: technicians[0].id,\n\t\t\tname: technicians[0].name,\n\t\t\thighlight: `${technicians[0].jobsCompleted} jobs completed, $${technicians[0].revenue.toLocaleString()} revenue`,\n\t\t} : null,\n\t\tteamAverages,\n\t};\n});\n\nexport interface CustomerAnalyticsData {\n\tsummary: {\n\t\ttotalCustomers: number;\n\t\tnewCustomers: number;\n\t\trepeatCustomers: number;\n\t\tchurnedCustomers: number;\n\t\tretentionRate: number;\n\t\tavgLifetimeValue: number;\n\t};\n\tbySegment: Array<{\n\t\tsegment: string;\n\t\tcount: number;\n\t\trevenue: number;\n\t\tavgTicket: number;\n\t}>;\n\ttopCustomers: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\ttotalRevenue: number;\n\t\tjobCount: number;\n\t\tlastServiceDate: string | null;\n\t\tlifetimeValue: number;\n\t}>;\n\tacquisitionTrend: Array<{\n\t\tmonth: string;\n\t\tnewCustomers: number;\n\t\tchurned: number;\n\t\tnet: number;\n\t}>;\n\triskDistribution: {\n\t\tlow: number;\n\t\tmedium: number;\n\t\thigh: number;\n\t};\n}\n\n/**\n * Get customer analytics data\n */\nexport const getCustomerAnalytics = cache(async (companyId: string, days: number = 365): Promise<CustomerAnalyticsData> => {\n\tconst supabase = await createClient();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\tconst thirtyDaysAgo = new Date();\n\tthirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\n\n\tconst [customersResult, jobsResult] = await Promise.all([\n\t\tsupabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"id, display_name, first_name, last_name, created_at, customer_type, churn_risk, lifetime_value, total_jobs, last_service_date\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null),\n\t\tsupabase\n\t\t\t.from(\"jobs\")\n\t\t\t.select(\"customer_id, total_revenue, created_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"completed\")\n\t\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t\t.is(\"deleted_at\", null),\n\t]);\n\n\tconst customers = customersResult.data || [];\n\tconst jobs = jobsResult.data || [];\n\n\t// Count metrics\n\tconst newCustomers = customers.filter(c =>\n\t\tc.created_at && new Date(c.created_at) >= thirtyDaysAgo\n\t).length;\n\tconst repeatCustomers = customers.filter(c => (c.total_jobs || 0) > 1).length;\n\tconst churnedCustomers = customers.filter(c => c.churn_risk === \"churned\").length;\n\tconst totalCustomers = customers.length;\n\tconst retentionRate = totalCustomers > 0 ? ((totalCustomers - churnedCustomers) / totalCustomers) * 100 : 100;\n\tconst avgLifetimeValue = totalCustomers > 0\n\t\t? customers.reduce((sum, c) => sum + ((c.lifetime_value || 0) / 100), 0) / totalCustomers\n\t\t: 0;\n\n\t// By segment\n\tconst segments: Record<string, { count: number; revenue: number; jobs: number }> = {};\n\tfor (const customer of customers) {\n\t\tconst segment = customer.customer_type || \"Residential\";\n\t\tif (!segments[segment]) segments[segment] = { count: 0, revenue: 0, jobs: 0 };\n\t\tsegments[segment].count++;\n\t}\n\n\t// Add revenue by segment from jobs\n\tconst customerIdToSegment: Record<string, string> = {};\n\tfor (const customer of customers) {\n\t\tcustomerIdToSegment[customer.id] = customer.customer_type || \"Residential\";\n\t}\n\tfor (const job of jobs) {\n\t\tconst segment = customerIdToSegment[job.customer_id] || \"Residential\";\n\t\tif (segments[segment]) {\n\t\t\tsegments[segment].revenue += (job.total_revenue || 0) / 100;\n\t\t\tsegments[segment].jobs++;\n\t\t}\n\t}\n\n\t// Top customers\n\tconst customerRevenue: Record<string, { name: string; revenue: number; jobCount: number; lastService: string | null; ltv: number }> = {};\n\tfor (const customer of customers) {\n\t\tconst name = customer.display_name ||\n\t\t\t[customer.first_name, customer.last_name].filter(Boolean).join(\" \") ||\n\t\t\t\"Unknown\";\n\t\tcustomerRevenue[customer.id] = {\n\t\t\tname,\n\t\t\trevenue: 0,\n\t\t\tjobCount: customer.total_jobs || 0,\n\t\t\tlastService: customer.last_service_date,\n\t\t\tltv: (customer.lifetime_value || 0) / 100,\n\t\t};\n\t}\n\tfor (const job of jobs) {\n\t\tif (customerRevenue[job.customer_id]) {\n\t\t\tcustomerRevenue[job.customer_id].revenue += (job.total_revenue || 0) / 100;\n\t\t}\n\t}\n\n\t// Acquisition trend by month\n\tconst monthlyAcquisition: Record<string, { new: number; churned: number }> = {};\n\tfor (const customer of customers) {\n\t\tif (customer.created_at) {\n\t\t\tconst month = new Date(customer.created_at).toISOString().substring(0, 7);\n\t\t\tif (!monthlyAcquisition[month]) monthlyAcquisition[month] = { new: 0, churned: 0 };\n\t\t\tmonthlyAcquisition[month].new++;\n\t\t}\n\t}\n\n\t// Risk distribution\n\tconst riskDistribution = { low: 0, medium: 0, high: 0 };\n\tfor (const customer of customers) {\n\t\tconst risk = customer.churn_risk as keyof typeof riskDistribution;\n\t\tif (risk && riskDistribution[risk] !== undefined) {\n\t\t\triskDistribution[risk]++;\n\t\t} else {\n\t\t\triskDistribution.low++; // Default to low risk if not set\n\t\t}\n\t}\n\n\treturn {\n\t\tsummary: {\n\t\t\ttotalCustomers,\n\t\t\tnewCustomers,\n\t\t\trepeatCustomers,\n\t\t\tchurnedCustomers,\n\t\t\tretentionRate,\n\t\t\tavgLifetimeValue,\n\t\t},\n\t\tbySegment: Object.entries(segments)\n\t\t\t.map(([segment, data]) => ({\n\t\t\t\tsegment,\n\t\t\t\tcount: data.count,\n\t\t\t\trevenue: data.revenue,\n\t\t\t\tavgTicket: data.jobs > 0 ? data.revenue / data.jobs : 0,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.revenue - a.revenue),\n\t\ttopCustomers: Object.entries(customerRevenue)\n\t\t\t.map(([id, data]) => ({\n\t\t\t\tid,\n\t\t\t\tname: data.name,\n\t\t\t\ttotalRevenue: data.revenue,\n\t\t\t\tjobCount: data.jobCount,\n\t\t\t\tlastServiceDate: data.lastService,\n\t\t\t\tlifetimeValue: data.ltv,\n\t\t\t}))\n\t\t\t.sort((a, b) => b.totalRevenue - a.totalRevenue)\n\t\t\t.slice(0, 10),\n\t\tacquisitionTrend: Object.entries(monthlyAcquisition)\n\t\t\t.map(([month, data]) => ({\n\t\t\t\tmonth,\n\t\t\t\tnewCustomers: data.new,\n\t\t\t\tchurned: data.churned,\n\t\t\t\tnet: data.new - data.churned,\n\t\t\t}))\n\t\t\t.sort((a, b) => a.month.localeCompare(b.month)),\n\t\triskDistribution,\n\t};\n});\n\n// ============================================================================\n// COMMUNICATION ANALYTICS QUERIES\n// ============================================================================\n\nexport interface RecentCommunication {\n\tid: string;\n\ttype: \"email\" | \"sms\" | \"phone\";\n\tdirection: \"inbound\" | \"outbound\";\n\tsender: string;\n\tsubject: string;\n\ttime: string;\n\tstatus: string;\n}\n\nexport interface ActiveThread {\n\tid: string;\n\tcustomer: string;\n\tlastMessage: string;\n\ttime: string;\n\tunread: number;\n}\n\n/**\n * Get recent communications for the analytics dashboard\n */\nexport const getRecentCommunications = cache(async (companyId: string, limit: number = 5): Promise<RecentCommunication[]> => {\n\tconst supabase = await createClient();\n\n\tconst { data: comms } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(`\n\t\t\tid,\n\t\t\ttype,\n\t\t\tdirection,\n\t\t\tsubject,\n\t\t\tbody,\n\t\t\tread_at,\n\t\t\tcreated_at,\n\t\t\tcustomer:customers(name)\n\t\t`)\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(limit);\n\n\tif (!comms || comms.length === 0) {\n\t\treturn [];\n\t}\n\n\treturn comms.map((comm) => {\n\t\tconst created = new Date(comm.created_at);\n\t\tconst now = new Date();\n\t\tconst diffMs = now.getTime() - created.getTime();\n\t\tconst diffMins = Math.floor(diffMs / 60000);\n\t\tconst diffHours = Math.floor(diffMins / 60);\n\t\tconst diffDays = Math.floor(diffHours / 24);\n\n\t\tlet timeAgo: string;\n\t\tif (diffMins < 1) {\n\t\t\ttimeAgo = \"Just now\";\n\t\t} else if (diffMins < 60) {\n\t\t\ttimeAgo = `${diffMins}m ago`;\n\t\t} else if (diffHours < 24) {\n\t\t\ttimeAgo = `${diffHours}h ago`;\n\t\t} else {\n\t\t\ttimeAgo = `${diffDays}d ago`;\n\t\t}\n\n\t\t// Determine status based on direction and read state\n\t\tlet status: string;\n\t\tif (comm.direction === \"inbound\") {\n\t\t\tstatus = comm.read_at ? \"read\" : \"unread\";\n\t\t} else {\n\t\t\tstatus = \"sent\";\n\t\t}\n\n\t\t// Get customer name or extract from subject/body\n\t\tconst customerName = (comm.customer as { name: string } | null)?.name || \"Unknown\";\n\n\t\treturn {\n\t\t\tid: comm.id,\n\t\t\ttype: (comm.type as \"email\" | \"sms\" | \"phone\") || \"email\",\n\t\t\tdirection: (comm.direction as \"inbound\" | \"outbound\") || \"inbound\",\n\t\t\tsender: customerName,\n\t\t\tsubject: comm.subject || (comm.body?.substring(0, 50) + \"...\") || \"No subject\",\n\t\t\ttime: timeAgo,\n\t\t\tstatus,\n\t\t};\n\t});\n});\n\n/**\n * Get active communication threads (grouped by customer)\n */\nexport const getActiveThreads = cache(async (companyId: string, limit: number = 5): Promise<ActiveThread[]> => {\n\tconst supabase = await createClient();\n\n\t// Get the most recent communication per customer with unread count\n\tconst { data: threads } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(`\n\t\t\tid,\n\t\t\tcustomer_id,\n\t\t\tbody,\n\t\t\tsubject,\n\t\t\tcreated_at,\n\t\t\tread_at,\n\t\t\tdirection,\n\t\t\tcustomer:customers(id, name)\n\t\t`)\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.not(\"customer_id\", \"is\", null)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(50); // Get more to group by customer\n\n\tif (!threads || threads.length === 0) {\n\t\treturn [];\n\t}\n\n\t// Group by customer and get latest + unread count\n\tconst customerThreads = new Map<string, {\n\t\tcustomer: string;\n\t\tlastMessage: string;\n\t\tlastTime: Date;\n\t\tunread: number;\n\t\tid: string;\n\t}>();\n\n\tfor (const thread of threads) {\n\t\tconst customerId = thread.customer_id;\n\t\tif (!customerId) continue;\n\n\t\tconst customerName = (thread.customer as { id: string; name: string } | null)?.name || \"Unknown\";\n\t\tconst existing = customerThreads.get(customerId);\n\n\t\tconst messagePreview = thread.subject || thread.body?.substring(0, 50) || \"No message\";\n\t\tconst createdAt = new Date(thread.created_at);\n\t\tconst isUnread = thread.direction === \"inbound\" && !thread.read_at;\n\n\t\tif (!existing) {\n\t\t\tcustomerThreads.set(customerId, {\n\t\t\t\tcustomer: customerName,\n\t\t\t\tlastMessage: messagePreview,\n\t\t\t\tlastTime: createdAt,\n\t\t\t\tunread: isUnread ? 1 : 0,\n\t\t\t\tid: thread.id,\n\t\t\t});\n\t\t} else {\n\t\t\t// Update unread count\n\t\t\tif (isUnread) {\n\t\t\t\texisting.unread++;\n\t\t\t}\n\t\t\t// Update last message if this is newer\n\t\t\tif (createdAt > existing.lastTime) {\n\t\t\t\texisting.lastMessage = messagePreview;\n\t\t\t\texisting.lastTime = createdAt;\n\t\t\t\texisting.id = thread.id;\n\t\t\t}\n\t\t}\n\t}\n\n\t// Convert to array and format\n\tconst now = new Date();\n\treturn Array.from(customerThreads.values())\n\t\t.sort((a, b) => b.lastTime.getTime() - a.lastTime.getTime())\n\t\t.slice(0, limit)\n\t\t.map((thread) => {\n\t\t\tconst diffMs = now.getTime() - thread.lastTime.getTime();\n\t\t\tconst diffMins = Math.floor(diffMs / 60000);\n\t\t\tconst diffHours = Math.floor(diffMins / 60);\n\t\t\tconst diffDays = Math.floor(diffHours / 24);\n\n\t\t\tlet timeAgo: string;\n\t\t\tif (diffMins < 1) {\n\t\t\t\ttimeAgo = \"Just now\";\n\t\t\t} else if (diffMins < 60) {\n\t\t\t\ttimeAgo = `${diffMins}m ago`;\n\t\t\t} else if (diffHours < 24) {\n\t\t\t\ttimeAgo = `${diffHours}h ago`;\n\t\t\t} else {\n\t\t\t\ttimeAgo = `${diffDays}d ago`;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tid: thread.id,\n\t\t\t\tcustomer: thread.customer,\n\t\t\t\tlastMessage: thread.lastMessage.length > 40\n\t\t\t\t\t? thread.lastMessage.substring(0, 40) + \"...\"\n\t\t\t\t\t: thread.lastMessage,\n\t\t\t\ttime: timeAgo,\n\t\t\t\tunread: thread.unread,\n\t\t\t};\n\t\t});\n});\n\n// ============================================================================\n// JOB COSTING & PROFITABILITY ANALYTICS\n// ============================================================================\n\nexport interface JobCostingData {\n\tsummary: {\n\t\tavgJobProfit: number;\n\t\tavgGrossMargin: number;\n\t\ttotalLaborCost: number;\n\t\ttotalMaterialsCost: number;\n\t\ttotalEquipmentCost: number;\n\t\tjobsUnderBudget: number;\n\t\tjobsOnBudget: number;\n\t\tjobsOverBudget: number;\n\t\tavgCostVariance: number;\n\t};\n\tbyBudgetStatus: Array<{\n\t\tstatus: string;\n\t\tcount: number;\n\t\ttotalRevenue: number;\n\t\ttotalCost: number;\n\t\tavgMargin: number;\n\t}>;\n\ttopProfitableJobs: Array<{\n\t\tid: string;\n\t\ttitle: string;\n\t\tcustomer: string;\n\t\trevenue: number;\n\t\tcost: number;\n\t\tprofit: number;\n\t\tmargin: number;\n\t}>;\n\tcostBreakdown: {\n\t\tlabor: number;\n\t\tmaterials: number;\n\t\tequipment: number;\n\t\toverhead: number;\n\t\tdriveTime: number;\n\t};\n}\n\n/**\n * Get job costing and profitability analytics\n */\nexport const getJobCostingAnalytics = cache(async (companyId: string, days: number = 90): Promise<JobCostingData> => {\n\tconst supabase = await createClient();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\n\tconst { data: jobs } = await supabase\n\t\t.from(\"jobs\")\n\t\t.select(`\n\t\t\tid, title, total_amount,\n\t\t\tlabor_cost_actual, materials_cost_actual, equipment_cost_actual,\n\t\t\ttotal_cost_actual, overhead_cost, drive_time_cost,\n\t\t\tprofit_actual, gross_margin_percent, budget_status,\n\t\t\tcustomer:customers(name, display_name)\n\t\t`)\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"status\", \"completed\")\n\t\t.gte(\"created_at\", startDate.toISOString())\n\t\t.is(\"deleted_at\", null)\n\t\t.not(\"total_cost_actual\", \"is\", null);\n\n\tconst allJobs = jobs || [];\n\n\t// Summary calculations\n\tconst totalLaborCost = allJobs.reduce((sum, j) => sum + ((j.labor_cost_actual || 0) / 100), 0);\n\tconst totalMaterialsCost = allJobs.reduce((sum, j) => sum + ((j.materials_cost_actual || 0) / 100), 0);\n\tconst totalEquipmentCost = allJobs.reduce((sum, j) => sum + ((j.equipment_cost_actual || 0) / 100), 0);\n\tconst totalOverhead = allJobs.reduce((sum, j) => sum + ((j.overhead_cost || 0) / 100), 0);\n\tconst totalDriveTime = allJobs.reduce((sum, j) => sum + ((j.drive_time_cost || 0) / 100), 0);\n\n\tconst avgJobProfit = allJobs.length > 0\n\t\t? allJobs.reduce((sum, j) => sum + ((j.profit_actual || 0) / 100), 0) / allJobs.length\n\t\t: 0;\n\n\tconst avgGrossMargin = allJobs.length > 0\n\t\t? allJobs.reduce((sum, j) => sum + (j.gross_margin_percent || 0), 0) / allJobs.length\n\t\t: 0;\n\n\tconst jobsUnderBudget = allJobs.filter(j => j.budget_status === \"under_budget\").length;\n\tconst jobsOnBudget = allJobs.filter(j => j.budget_status === \"on_budget\").length;\n\tconst jobsOverBudget = allJobs.filter(j => j.budget_status === \"over_budget\").length;\n\n\t// By budget status\n\tconst statusGroups: Record<string, { count: number; revenue: number; cost: number }> = {\n\t\tunder_budget: { count: 0, revenue: 0, cost: 0 },\n\t\ton_budget: { count: 0, revenue: 0, cost: 0 },\n\t\tover_budget: { count: 0, revenue: 0, cost: 0 },\n\t};\n\n\tfor (const job of allJobs) {\n\t\tconst status = job.budget_status || \"on_budget\";\n\t\tif (statusGroups[status]) {\n\t\t\tstatusGroups[status].count++;\n\t\t\tstatusGroups[status].revenue += (job.total_amount || 0) / 100;\n\t\t\tstatusGroups[status].cost += (job.total_cost_actual || 0) / 100;\n\t\t}\n\t}\n\n\t// Top profitable jobs\n\tconst topProfitableJobs = allJobs\n\t\t.map(j => {\n\t\t\tconst customer = j.customer as { name?: string; display_name?: string } | null;\n\t\t\treturn {\n\t\t\t\tid: j.id,\n\t\t\t\ttitle: j.title || \"Untitled Job\",\n\t\t\t\tcustomer: customer?.display_name || customer?.name || \"Unknown\",\n\t\t\t\trevenue: (j.total_amount || 0) / 100,\n\t\t\t\tcost: (j.total_cost_actual || 0) / 100,\n\t\t\t\tprofit: (j.profit_actual || 0) / 100,\n\t\t\t\tmargin: j.gross_margin_percent || 0,\n\t\t\t};\n\t\t})\n\t\t.sort((a, b) => b.profit - a.profit)\n\t\t.slice(0, 10);\n\n\treturn {\n\t\tsummary: {\n\t\t\tavgJobProfit,\n\t\t\tavgGrossMargin,\n\t\t\ttotalLaborCost,\n\t\t\ttotalMaterialsCost,\n\t\t\ttotalEquipmentCost,\n\t\t\tjobsUnderBudget,\n\t\t\tjobsOnBudget,\n\t\t\tjobsOverBudget,\n\t\t\tavgCostVariance: 0, // Would need estimate comparison\n\t\t},\n\t\tbyBudgetStatus: Object.entries(statusGroups).map(([status, data]) => ({\n\t\t\tstatus,\n\t\t\tcount: data.count,\n\t\t\ttotalRevenue: data.revenue,\n\t\t\ttotalCost: data.cost,\n\t\t\tavgMargin: data.revenue > 0 ? ((data.revenue - data.cost) / data.revenue) * 100 : 0,\n\t\t})),\n\t\ttopProfitableJobs,\n\t\tcostBreakdown: {\n\t\t\tlabor: totalLaborCost,\n\t\t\tmaterials: totalMaterialsCost,\n\t\t\tequipment: totalEquipmentCost,\n\t\t\toverhead: totalOverhead,\n\t\t\tdriveTime: totalDriveTime,\n\t\t},\n\t};\n});\n\n// ============================================================================\n// COMPANY KPI DASHBOARD\n// ============================================================================\n\nexport interface CompanyKPIs {\n\tfinancial: {\n\t\tquoteToCloseRate: number;\n\t\tavgQuoteAccuracy: number;\n\t\tavgDaysToPayment: number;\n\t\tcollectionRate: number;\n\t\tcashFlow30Day: number;\n\t};\n\toperational: {\n\t\tcapacityUtilization: number;\n\t\tbillableHoursRatio: number;\n\t\tfirstCallResolution: number;\n\t\tavgResponseTimeHours: number;\n\t\ttechnicianUtilization: number;\n\t};\n\tcustomer: {\n\t\tavgLifetimeValue: number;\n\t\tcustomerAcquisitionCost: number;\n\t\tltvToCacRatio: number;\n\t\tretentionRate: number;\n\t\trecurringRevenuePercent: number;\n\t};\n}\n\n/**\n * Get company KPIs from the summary table\n */\nexport const getCompanyKPIs = cache(async (companyId: string): Promise<CompanyKPIs | null> => {\n\tconst supabase = await createClient();\n\n\tconst { data: summary } = await supabase\n\t\t.from(\"analytics_company_summary\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(1)\n\t\t.single();\n\n\tif (!summary) {\n\t\treturn null;\n\t}\n\n\treturn {\n\t\tfinancial: {\n\t\t\tquoteToCloseRate: summary.quote_to_close_rate || 0,\n\t\t\tavgQuoteAccuracy: summary.avg_quote_accuracy || 0,\n\t\t\tavgDaysToPayment: summary.avg_days_to_payment || 0,\n\t\t\tcollectionRate: summary.collection_rate || 0,\n\t\t\tcashFlow30Day: (summary.cash_flow_30_day_forecast || 0) / 100,\n\t\t},\n\t\toperational: {\n\t\t\tcapacityUtilization: summary.capacity_utilization_percent || 0,\n\t\t\tbillableHoursRatio: summary.billable_hours_ratio || 0,\n\t\t\tfirstCallResolution: summary.first_call_resolution_rate || 0,\n\t\t\tavgResponseTimeHours: (summary.avg_response_time_hours || 0),\n\t\t\ttechnicianUtilization: summary.technician_utilization_rate || 0,\n\t\t},\n\t\tcustomer: {\n\t\t\tavgLifetimeValue: (summary.avg_customer_lifetime_value || 0) / 100,\n\t\t\tcustomerAcquisitionCost: (summary.customer_acquisition_cost || 0) / 100,\n\t\t\tltvToCacRatio: summary.ltv_to_cac_ratio || 0,\n\t\t\tretentionRate: summary.customer_retention_rate || 0,\n\t\t\trecurringRevenuePercent: summary.recurring_revenue_percent || 0,\n\t\t},\n\t};\n});\n\n// ============================================================================\n// EQUIPMENT HEALTH ANALYTICS\n// ============================================================================\n\nexport interface EquipmentHealthSummary {\n\tsummary: {\n\t\ttotalEquipment: number;\n\t\thealthyCount: number;\n\t\twarningCount: number;\n\t\tcriticalCount: number;\n\t\tavgHealthScore: number;\n\t\tmaintenanceOverdue: number;\n\t};\n\tbyCondition: Array<{\n\t\tcondition: string;\n\t\tcount: number;\n\t\tavgAge: number;\n\t\tavgMaintenanceCost: number;\n\t}>;\n\tupcomingMaintenance: Array<{\n\t\tequipmentId: string;\n\t\tname: string;\n\t\tdaysUntilMaintenance: number;\n\t\tlastMaintenanceCost: number;\n\t}>;\n}\n\n/**\n * Get equipment health analytics\n */\nexport const getEquipmentHealthAnalytics = cache(async (companyId: string): Promise<EquipmentHealthSummary> => {\n\tconst supabase = await createClient();\n\n\tconst { data: healthData } = await supabase\n\t\t.from(\"analytics_equipment_health\")\n\t\t.select(`\n\t\t\tequipment_id, health_score, condition_rating,\n\t\t\tdays_until_maintenance, maintenance_overdue,\n\t\t\ttotal_maintenance_cost, age_years,\n\t\t\tequipment:equipment(id, name, model)\n\t\t`)\n\t\t.eq(\"company_id\", companyId)\n\t\t.order(\"period_start\", { ascending: false })\n\t\t.limit(5000); // Prevent unbounded query\n\n\tconst data = healthData || [];\n\n\t// Get unique equipment (most recent entry per equipment)\n\tconst latestByEquipment = new Map<string, typeof data[0]>();\n\tfor (const d of data) {\n\t\tif (!latestByEquipment.has(d.equipment_id)) {\n\t\t\tlatestByEquipment.set(d.equipment_id, d);\n\t\t}\n\t}\n\n\tconst equipmentList = Array.from(latestByEquipment.values());\n\tconst totalEquipment = equipmentList.length;\n\n\tconst healthyCount = equipmentList.filter(e => e.health_score >= 70).length;\n\tconst warningCount = equipmentList.filter(e => e.health_score >= 40 && e.health_score < 70).length;\n\tconst criticalCount = equipmentList.filter(e => e.health_score < 40).length;\n\tconst maintenanceOverdue = equipmentList.filter(e => e.maintenance_overdue).length;\n\n\tconst avgHealthScore = totalEquipment > 0\n\t\t? equipmentList.reduce((sum, e) => sum + (e.health_score || 0), 0) / totalEquipment\n\t\t: 0;\n\n\t// By condition\n\tconst conditionGroups: Record<string, { count: number; totalAge: number; totalCost: number }> = {};\n\tfor (const e of equipmentList) {\n\t\tconst condition = e.condition_rating || \"unknown\";\n\t\tif (!conditionGroups[condition]) {\n\t\t\tconditionGroups[condition] = { count: 0, totalAge: 0, totalCost: 0 };\n\t\t}\n\t\tconditionGroups[condition].count++;\n\t\tconditionGroups[condition].totalAge += e.age_years || 0;\n\t\tconditionGroups[condition].totalCost += (e.total_maintenance_cost || 0) / 100;\n\t}\n\n\t// Upcoming maintenance\n\tconst upcomingMaintenance = equipmentList\n\t\t.filter(e => (e.days_until_maintenance || 0) > 0 && (e.days_until_maintenance || 0) <= 30)\n\t\t.map(e => {\n\t\t\tconst equip = e.equipment as { id: string; name: string; model?: string } | null;\n\t\t\treturn {\n\t\t\t\tequipmentId: e.equipment_id,\n\t\t\t\tname: equip?.name || equip?.model || \"Unknown Equipment\",\n\t\t\t\tdaysUntilMaintenance: e.days_until_maintenance || 0,\n\t\t\t\tlastMaintenanceCost: (e.total_maintenance_cost || 0) / 100,\n\t\t\t};\n\t\t})\n\t\t.sort((a, b) => a.daysUntilMaintenance - b.daysUntilMaintenance)\n\t\t.slice(0, 10);\n\n\treturn {\n\t\tsummary: {\n\t\t\ttotalEquipment,\n\t\t\thealthyCount,\n\t\t\twarningCount,\n\t\t\tcriticalCount,\n\t\t\tavgHealthScore,\n\t\t\tmaintenanceOverdue,\n\t\t},\n\t\tbyCondition: Object.entries(conditionGroups).map(([condition, data]) => ({\n\t\t\tcondition,\n\t\t\tcount: data.count,\n\t\t\tavgAge: data.count > 0 ? data.totalAge / data.count : 0,\n\t\t\tavgMaintenanceCost: data.count > 0 ? data.totalCost / data.count : 0,\n\t\t})),\n\t\tupcomingMaintenance,\n\t};\n});\n\n// ============================================================================\n// TECHNICIAN PERFORMANCE ANALYTICS\n// ============================================================================\n\nexport interface TechnicianPerformanceData {\n\ttechnicians: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tjobsCompleted: number;\n\t\trevenue: number;\n\t\tavgJobProfit: number;\n\t\tprofitMargin: number;\n\t\tbillableRatio: number;\n\t\tcallbacks: number;\n\t\tcallbackRate: number;\n\t\tupsellCount: number;\n\t\tupsellRevenue: number;\n\t\toverallScore: number;\n\t\trank: number;\n\t}>;\n\tteamMetrics: {\n\t\tavgJobsPerTech: number;\n\t\tavgRevenuePerTech: number;\n\t\tavgProfitMargin: number;\n\t\tavgBillableRatio: number;\n\t\ttotalCallbacks: number;\n\t};\n}\n\n/**\n * Get detailed technician performance analytics\n */\nexport const getTechnicianPerformance = cache(async (companyId: string, days: number = 30): Promise<TechnicianPerformanceData> => {\n\tconst supabase = await createClient();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\n\tconst { data: metrics } = await supabase\n\t\t.from(\"analytics_technician_metrics\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.gte(\"period_start\", startDate.toISOString().split(\"T\")[0])\n\t\t.order(\"overall_performance_score\", { ascending: false });\n\n\tconst techMetrics = metrics || [];\n\n\tconst technicians = techMetrics.map((t, index) => ({\n\t\tid: t.user_id,\n\t\tname: t.name || \"Unknown\",\n\t\tjobsCompleted: t.jobs_completed || 0,\n\t\trevenue: (t.total_revenue || 0) / 100,\n\t\tavgJobProfit: (t.avg_job_profit || 0) / 100,\n\t\tprofitMargin: t.profit_margin_percent || 0,\n\t\tbillableRatio: t.billable_ratio || 0,\n\t\tcallbacks: t.callbacks || 0,\n\t\tcallbackRate: t.callback_rate || 0,\n\t\tupsellCount: t.upsell_count || 0,\n\t\tupsellRevenue: (t.upsell_revenue || 0) / 100,\n\t\toverallScore: t.overall_performance_score || 0,\n\t\trank: index + 1,\n\t}));\n\n\tconst count = technicians.length;\n\tconst teamMetrics = {\n\t\tavgJobsPerTech: count > 0 ? technicians.reduce((s, t) => s + t.jobsCompleted, 0) / count : 0,\n\t\tavgRevenuePerTech: count > 0 ? technicians.reduce((s, t) => s + t.revenue, 0) / count : 0,\n\t\tavgProfitMargin: count > 0 ? technicians.reduce((s, t) => s + t.profitMargin, 0) / count : 0,\n\t\tavgBillableRatio: count > 0 ? technicians.reduce((s, t) => s + t.billableRatio, 0) / count : 0,\n\t\ttotalCallbacks: technicians.reduce((s, t) => s + t.callbacks, 0),\n\t};\n\n\treturn { technicians, teamMetrics };\n});\n\n// ============================================================================\n// MARKETING ROI & CAMPAIGN ANALYTICS\n// ============================================================================\n\nexport interface MarketingCampaignData {\n\tsummary: {\n\t\ttotalSpend: number;\n\t\ttotalRevenue: number;\n\t\ttotalLeads: number;\n\t\ttotalBookedJobs: number;\n\t\toverallROAS: number;\n\t\toverallROI: number;\n\t\tavgCostPerLead: number;\n\t\tavgCostPerAcquisition: number;\n\t};\n\tcampaigns: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tchannel: string;\n\t\tstatus: string;\n\t\tbudget: number;\n\t\tspend: number;\n\t\tleads: number;\n\t\tbookedJobs: number;\n\t\trevenue: number;\n\t\troas: number;\n\t\troi: number;\n\t\tcostPerLead: number;\n\t}>;\n\tbyChannel: Array<{\n\t\tchannel: string;\n\t\tspend: number;\n\t\tleads: number;\n\t\tbookedJobs: number;\n\t\trevenue: number;\n\t\troas: number;\n\t\tcostPerLead: number;\n\t}>;\n\ttrendDaily: Array<{\n\t\tdate: string;\n\t\tspend: number;\n\t\tleads: number;\n\t\trevenue: number;\n\t\troas: number;\n\t}>;\n}\n\n/**\n * Get marketing campaign ROI analytics\n */\nexport const getMarketingROIAnalytics = cache(async (companyId: string, days: number = 90): Promise<MarketingCampaignData> => {\n\tconst supabase = await createClient();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\n\t// Get campaigns (limit to 1000, select only needed fields)\n\tconst { data: campaigns } = await supabase\n\t\t.from(\"marketing_campaigns\")\n\t\t.select(\"id, name, channel, status, budget_amount, actual_spend, total_revenue, total_leads, total_booked_jobs, start_date, end_date, created_at\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(1000);\n\n\t// Get daily attribution data (limit to 10000 for analytics)\n\tconst { data: attribution } = await supabase\n\t\t.from(\"analytics_marketing_attribution\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.gte(\"date\", startDate.toISOString().split(\"T\")[0])\n\t\t.order(\"date\", { ascending: true })\n\t\t.limit(10000);\n\n\tconst allCampaigns = campaigns || [];\n\tconst allAttribution = attribution || [];\n\n\t// Calculate summary metrics\n\tconst totalSpend = allCampaigns.reduce((sum, c) => sum + (c.actual_spend || 0), 0);\n\tconst totalRevenue = allCampaigns.reduce((sum, c) => sum + (c.total_revenue || 0), 0);\n\tconst totalLeads = allCampaigns.reduce((sum, c) => sum + (c.total_leads || 0), 0);\n\tconst totalBookedJobs = allCampaigns.reduce((sum, c) => sum + (c.total_booked_jobs || 0), 0);\n\n\tconst overallROAS = totalSpend > 0 ? totalRevenue / totalSpend : 0;\n\tconst overallROI = totalSpend > 0 ? ((totalRevenue - totalSpend) / totalSpend) * 100 : 0;\n\tconst avgCostPerLead = totalLeads > 0 ? totalSpend / totalLeads : 0;\n\tconst avgCostPerAcquisition = totalBookedJobs > 0 ? totalSpend / totalBookedJobs : 0;\n\n\t// Campaign list\n\tconst campaignList = allCampaigns.map(c => ({\n\t\tid: c.id,\n\t\tname: c.name,\n\t\tchannel: c.channel,\n\t\tstatus: c.status,\n\t\tbudget: c.budget_amount || 0,\n\t\tspend: c.actual_spend || 0,\n\t\tleads: c.total_leads || 0,\n\t\tbookedJobs: c.total_booked_jobs || 0,\n\t\trevenue: c.total_revenue || 0,\n\t\troas: c.return_on_ad_spend || 0,\n\t\troi: c.roi_percent || 0,\n\t\tcostPerLead: c.cost_per_lead || 0,\n\t}));\n\n\t// Aggregate by channel\n\tconst channelData: Record<string, {\n\t\tspend: number;\n\t\tleads: number;\n\t\tbookedJobs: number;\n\t\trevenue: number;\n\t}> = {};\n\n\tfor (const c of allCampaigns) {\n\t\tconst channel = c.channel || \"other\";\n\t\tif (!channelData[channel]) {\n\t\t\tchannelData[channel] = { spend: 0, leads: 0, bookedJobs: 0, revenue: 0 };\n\t\t}\n\t\tchannelData[channel].spend += c.actual_spend || 0;\n\t\tchannelData[channel].leads += c.total_leads || 0;\n\t\tchannelData[channel].bookedJobs += c.total_booked_jobs || 0;\n\t\tchannelData[channel].revenue += c.total_revenue || 0;\n\t}\n\n\tconst byChannel = Object.entries(channelData).map(([channel, data]) => ({\n\t\tchannel,\n\t\tspend: data.spend,\n\t\tleads: data.leads,\n\t\tbookedJobs: data.bookedJobs,\n\t\trevenue: data.revenue,\n\t\troas: data.spend > 0 ? data.revenue / data.spend : 0,\n\t\tcostPerLead: data.leads > 0 ? data.spend / data.leads : 0,\n\t})).sort((a, b) => b.revenue - a.revenue);\n\n\t// Daily trends\n\tconst dailyData: Record<string, { spend: number; leads: number; revenue: number }> = {};\n\tfor (const a of allAttribution) {\n\t\tconst date = a.date;\n\t\tif (!dailyData[date]) {\n\t\t\tdailyData[date] = { spend: 0, leads: 0, revenue: 0 };\n\t\t}\n\t\tdailyData[date].spend += a.daily_spend || 0;\n\t\tdailyData[date].leads += a.total_leads || 0;\n\t\tdailyData[date].revenue += a.total_revenue || 0;\n\t}\n\n\tconst trendDaily = Object.entries(dailyData)\n\t\t.map(([date, data]) => ({\n\t\t\tdate,\n\t\t\tspend: data.spend,\n\t\t\tleads: data.leads,\n\t\t\trevenue: data.revenue,\n\t\t\troas: data.spend > 0 ? data.revenue / data.spend : 0,\n\t\t}))\n\t\t.sort((a, b) => a.date.localeCompare(b.date));\n\n\treturn {\n\t\tsummary: {\n\t\t\ttotalSpend,\n\t\t\ttotalRevenue,\n\t\t\ttotalLeads,\n\t\t\ttotalBookedJobs,\n\t\t\toverallROAS,\n\t\t\toverallROI,\n\t\t\tavgCostPerLead,\n\t\t\tavgCostPerAcquisition,\n\t\t},\n\t\tcampaigns: campaignList,\n\t\tbyChannel,\n\t\ttrendDaily,\n\t};\n});\n\n// ============================================================================\n// CSR (CUSTOMER SERVICE REP) SCORECARD ANALYTICS\n// ============================================================================\n\nexport interface CSRScorecardData {\n\tsummary: {\n\t\ttotalCSRs: number;\n\t\ttotalCallsHandled: number;\n\t\tavgBookingRate: number;\n\t\tavgCallAnswerRate: number;\n\t\ttotalBookedRevenue: number;\n\t\tavgRevenuePerCall: number;\n\t\ttopPerformerBookingRate: number;\n\t\tteamTarget: number;\n\t};\n\tcsrList: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tcallsAnswered: number;\n\t\tcallsMissed: number;\n\t\tcallAnswerRate: number;\n\t\topportunities: number;\n\t\tjobsBooked: number;\n\t\tbookingRate: number;\n\t\tbookedRevenue: number;\n\t\tavgTicket: number;\n\t\trevenuePerCall: number;\n\t\tavgTalkTime: number;\n\t\tqualityScore: number;\n\t\tperformanceScore: number;\n\t\tbookingRateRank: number;\n\t\trevenueRank: number;\n\t\tvsTarget: number;\n\t}>;\n\tleaderboard: Array<{\n\t\trank: number;\n\t\tname: string;\n\t\tbookingRate: number;\n\t\trevenue: number;\n\t}>;\n\ttrendDaily: Array<{\n\t\tdate: string;\n\t\ttotalCalls: number;\n\t\tanswered: number;\n\t\tbooked: number;\n\t\tbookingRate: number;\n\t}>;\n}\n\n/**\n * Get CSR scorecard analytics\n */\nexport const getCSRScorecardAnalytics = cache(async (companyId: string, days: number = 30): Promise<CSRScorecardData> => {\n\tconst supabase = await createClient();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\n\t// Get CSR metrics\n\tconst { data: csrMetrics } = await supabase\n\t\t.from(\"analytics_csr_metrics\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.gte(\"date\", startDate.toISOString().split(\"T\")[0])\n\t\t.order(\"date\", { ascending: false });\n\n\tconst allMetrics = csrMetrics || [];\n\n\t// Get latest metrics per CSR (most recent date)\n\tconst latestByCSR = new Map<string, typeof allMetrics[0]>();\n\tfor (const m of allMetrics) {\n\t\tif (!latestByCSR.has(m.user_id) || m.date > (latestByCSR.get(m.user_id)?.date || \"\")) {\n\t\t\tlatestByCSR.set(m.user_id, m);\n\t\t}\n\t}\n\n\tconst csrList = Array.from(latestByCSR.values()).map(m => ({\n\t\tid: m.user_id,\n\t\tname: m.csr_name || \"Unknown\",\n\t\tcallsAnswered: m.total_calls_answered || 0,\n\t\tcallsMissed: m.total_calls_missed || 0,\n\t\tcallAnswerRate: m.call_answer_rate || 0,\n\t\topportunities: m.total_opportunities || 0,\n\t\tjobsBooked: m.jobs_booked || 0,\n\t\tbookingRate: m.booking_rate || 0,\n\t\tbookedRevenue: m.booked_revenue || 0,\n\t\tavgTicket: m.avg_booked_ticket || 0,\n\t\trevenuePerCall: m.revenue_per_call || 0,\n\t\tavgTalkTime: m.avg_talk_time_seconds || 0,\n\t\tqualityScore: m.avg_call_quality_score || 0,\n\t\tperformanceScore: m.overall_performance_score || 0,\n\t\tbookingRateRank: m.booking_rate_rank || 0,\n\t\trevenueRank: m.revenue_rank || 0,\n\t\tvsTarget: m.booking_rate_vs_target || 0,\n\t})).sort((a, b) => b.bookingRate - a.bookingRate);\n\n\t// Calculate summary metrics\n\tconst totalCSRs = csrList.length;\n\tconst totalCallsHandled = csrList.reduce((sum, c) => sum + c.callsAnswered, 0);\n\tconst avgBookingRate = totalCSRs > 0\n\t\t? csrList.reduce((sum, c) => sum + c.bookingRate, 0) / totalCSRs\n\t\t: 0;\n\tconst avgCallAnswerRate = totalCSRs > 0\n\t\t? csrList.reduce((sum, c) => sum + c.callAnswerRate, 0) / totalCSRs\n\t\t: 0;\n\tconst totalBookedRevenue = csrList.reduce((sum, c) => sum + c.bookedRevenue, 0);\n\tconst avgRevenuePerCall = totalCallsHandled > 0 ? totalBookedRevenue / totalCallsHandled : 0;\n\tconst topPerformerBookingRate = csrList.length > 0 ? csrList[0].bookingRate : 0;\n\n\t// Leaderboard (top 5)\n\tconst leaderboard = csrList.slice(0, 5).map((c, index) => ({\n\t\trank: index + 1,\n\t\tname: c.name,\n\t\tbookingRate: c.bookingRate,\n\t\trevenue: c.bookedRevenue,\n\t}));\n\n\t// Daily trends\n\tconst dailyData: Record<string, {\n\t\ttotalCalls: number;\n\t\tanswered: number;\n\t\tbooked: number;\n\t}> = {};\n\n\tfor (const m of allMetrics) {\n\t\tconst date = m.date;\n\t\tif (!dailyData[date]) {\n\t\t\tdailyData[date] = { totalCalls: 0, answered: 0, booked: 0 };\n\t\t}\n\t\tdailyData[date].totalCalls += m.total_calls_received || 0;\n\t\tdailyData[date].answered += m.total_calls_answered || 0;\n\t\tdailyData[date].booked += m.jobs_booked || 0;\n\t}\n\n\tconst trendDaily = Object.entries(dailyData)\n\t\t.map(([date, data]) => ({\n\t\t\tdate,\n\t\t\ttotalCalls: data.totalCalls,\n\t\t\tanswered: data.answered,\n\t\t\tbooked: data.booked,\n\t\t\tbookingRate: data.answered > 0 ? (data.booked / data.answered) * 100 : 0,\n\t\t}))\n\t\t.sort((a, b) => a.date.localeCompare(b.date));\n\n\treturn {\n\t\tsummary: {\n\t\t\ttotalCSRs,\n\t\t\ttotalCallsHandled,\n\t\t\tavgBookingRate,\n\t\t\tavgCallAnswerRate,\n\t\t\ttotalBookedRevenue,\n\t\t\tavgRevenuePerCall,\n\t\t\ttopPerformerBookingRate,\n\t\t\tteamTarget: 80, // Default target\n\t\t},\n\t\tcsrList,\n\t\tleaderboard,\n\t\ttrendDaily,\n\t};\n});\n\n// ============================================================================\n// CALL TRACKING ANALYTICS\n// ============================================================================\n\nexport interface CallTrackingData {\n\tsummary: {\n\t\ttotalCalls: number;\n\t\tansweredCalls: number;\n\t\tmissedCalls: number;\n\t\tcallAnswerRate: number;\n\t\tbookedCalls: number;\n\t\tbookingRate: number;\n\t\tavgCallDuration: number;\n\t\tnewCustomerCalls: number;\n\t};\n\tbyOutcome: Array<{\n\t\toutcome: string;\n\t\tcount: number;\n\t\tpercentage: number;\n\t}>;\n\tbySource: Array<{\n\t\tsource: string;\n\t\tcalls: number;\n\t\tbooked: number;\n\t\tbookingRate: number;\n\t\trevenue: number;\n\t}>;\n\trecentCalls: Array<{\n\t\tid: string;\n\t\tcallerNumber: string;\n\t\tcallerName: string | null;\n\t\tduration: number;\n\t\toutcome: string;\n\t\tbooked: boolean;\n\t\tcampaign: string | null;\n\t\ttime: string;\n\t}>;\n}\n\n/**\n * Get call tracking analytics\n */\nexport const getCallTrackingAnalytics = cache(async (companyId: string, days: number = 30): Promise<CallTrackingData> => {\n\tconst supabase = await createClient();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\n\tconst { data: calls } = await supabase\n\t\t.from(\"marketing_call_tracking\")\n\t\t.select(`\n\t\t\t*,\n\t\t\tcampaign:marketing_campaigns(name, channel)\n\t\t`)\n\t\t.eq(\"company_id\", companyId)\n\t\t.gte(\"call_start\", startDate.toISOString())\n\t\t.order(\"call_start\", { ascending: false })\n\t\t.limit(500);\n\n\tconst allCalls = calls || [];\n\n\t// Summary metrics\n\tconst totalCalls = allCalls.length;\n\tconst answeredCalls = allCalls.filter(c => c.answered).length;\n\tconst missedCalls = allCalls.filter(c => c.missed_call).length;\n\tconst callAnswerRate = totalCalls > 0 ? (answeredCalls / totalCalls) * 100 : 0;\n\tconst bookedCalls = allCalls.filter(c => c.booked_job).length;\n\tconst bookingRate = answeredCalls > 0 ? (bookedCalls / answeredCalls) * 100 : 0;\n\tconst avgCallDuration = answeredCalls > 0\n\t\t? allCalls.filter(c => c.answered).reduce((sum, c) => sum + (c.duration_seconds || 0), 0) / answeredCalls\n\t\t: 0;\n\tconst newCustomerCalls = allCalls.filter(c => c.is_new_customer).length;\n\n\t// By outcome\n\tconst outcomeCounts: Record<string, number> = {};\n\tfor (const c of allCalls) {\n\t\tconst outcome = c.call_outcome || \"unknown\";\n\t\toutcomeCounts[outcome] = (outcomeCounts[outcome] || 0) + 1;\n\t}\n\tconst byOutcome = Object.entries(outcomeCounts)\n\t\t.map(([outcome, count]) => ({\n\t\t\toutcome,\n\t\t\tcount,\n\t\t\tpercentage: totalCalls > 0 ? (count / totalCalls) * 100 : 0,\n\t\t}))\n\t\t.sort((a, b) => b.count - a.count);\n\n\t// By source/campaign\n\tconst sourceData: Record<string, {\n\t\tcalls: number;\n\t\tbooked: number;\n\t\trevenue: number;\n\t}> = {};\n\tfor (const c of allCalls) {\n\t\tconst campaign = c.campaign as { name: string; channel: string } | null;\n\t\tconst source = campaign?.channel || c.utm_source || \"direct\";\n\t\tif (!sourceData[source]) {\n\t\t\tsourceData[source] = { calls: 0, booked: 0, revenue: 0 };\n\t\t}\n\t\tsourceData[source].calls++;\n\t\tif (c.booked_job) sourceData[source].booked++;\n\t\tsourceData[source].revenue += c.attributed_revenue || 0;\n\t}\n\tconst bySource = Object.entries(sourceData)\n\t\t.map(([source, data]) => ({\n\t\t\tsource,\n\t\t\tcalls: data.calls,\n\t\t\tbooked: data.booked,\n\t\t\tbookingRate: data.calls > 0 ? (data.booked / data.calls) * 100 : 0,\n\t\t\trevenue: data.revenue,\n\t\t}))\n\t\t.sort((a, b) => b.calls - a.calls);\n\n\t// Recent calls (last 20)\n\tconst now = new Date();\n\tconst recentCalls = allCalls.slice(0, 20).map(c => {\n\t\tconst campaign = c.campaign as { name: string } | null;\n\t\tconst callTime = new Date(c.call_start);\n\t\tconst diffMs = now.getTime() - callTime.getTime();\n\t\tconst diffMins = Math.floor(diffMs / 60000);\n\t\tconst diffHours = Math.floor(diffMins / 60);\n\n\t\tlet timeAgo: string;\n\t\tif (diffMins < 60) {\n\t\t\ttimeAgo = `${diffMins}m ago`;\n\t\t} else if (diffHours < 24) {\n\t\t\ttimeAgo = `${diffHours}h ago`;\n\t\t} else {\n\t\t\ttimeAgo = `${Math.floor(diffHours / 24)}d ago`;\n\t\t}\n\n\t\treturn {\n\t\t\tid: c.id,\n\t\t\tcallerNumber: c.caller_number || \"Unknown\",\n\t\t\tcallerName: c.caller_name,\n\t\t\tduration: c.duration_seconds || 0,\n\t\t\toutcome: c.call_outcome || \"unknown\",\n\t\t\tbooked: c.booked_job || false,\n\t\t\tcampaign: campaign?.name || null,\n\t\t\ttime: timeAgo,\n\t\t};\n\t});\n\n\treturn {\n\t\tsummary: {\n\t\t\ttotalCalls,\n\t\t\tansweredCalls,\n\t\t\tmissedCalls,\n\t\t\tcallAnswerRate,\n\t\t\tbookedCalls,\n\t\t\tbookingRate,\n\t\t\tavgCallDuration,\n\t\t\tnewCustomerCalls,\n\t\t},\n\t\tbyOutcome,\n\t\tbySource,\n\t\trecentCalls,\n\t};\n});\n\n// ============================================================================\n// DISPATCH EFFICIENCY ANALYTICS\n// ============================================================================\n\nexport interface DispatchEfficiencyData {\n\tsummary: {\n\t\tscheduleFillRate: number;\n\t\tavgDriveTimeMinutes: number;\n\t\tavgDriveDistanceMiles: number;\n\t\tonTimeArrivalRate: number;\n\t\tslaComplianceRate: number;\n\t\tavgJobsPerTechPerDay: number;\n\t\tutilizationRate: number;\n\t\ttotalDriveMiles: number;\n\t\ttotalDriveCost: number;\n\t};\n\tbyTechnician: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tscheduleFillRate: number;\n\t\tavgDriveTime: number;\n\t\tonTimeRate: number;\n\t\tjobsCompleted: number;\n\t\tutilizationRate: number;\n\t\tdriveTimeOptimization: number;\n\t}>;\n\tbyZone: Array<{\n\t\tzone: string;\n\t\tappointments: number;\n\t\tavgDriveTime: number;\n\t\tavgDriveDistance: number;\n\t\tonTimeRate: number;\n\t\trevenue: number;\n\t}>;\n\tdailyTrends: Array<{\n\t\tdate: string;\n\t\tscheduleFillRate: number;\n\t\tavgDriveTime: number;\n\t\tonTimeRate: number;\n\t\tjobsScheduled: number;\n\t\tjobsCompleted: number;\n\t}>;\n\toptimizationAlerts: Array<{\n\t\ttype: string;\n\t\tseverity: \"low\" | \"medium\" | \"high\";\n\t\tmessage: string;\n\t\tpotentialSavings: number;\n\t}>;\n}\n\n/**\n * Get dispatch efficiency analytics\n */\nexport const getDispatchEfficiencyAnalytics = cache(async (companyId: string, days: number = 30): Promise<DispatchEfficiencyData> => {\n\tconst supabase = await createClient();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\n\tconst { data: dispatchData } = await supabase\n\t\t.from(\"analytics_dispatch_efficiency\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.gte(\"date\", startDate.toISOString().split(\"T\")[0])\n\t\t.order(\"date\", { ascending: false });\n\n\tconst allData = dispatchData || [];\n\n\t// Get latest data per technician\n\tconst latestByTech = new Map<string, (typeof allData)[0]>();\n\tfor (const d of allData) {\n\t\tif (d.technician_id && !latestByTech.has(d.technician_id)) {\n\t\t\tlatestByTech.set(d.technician_id, d);\n\t\t}\n\t}\n\n\t// Calculate summary metrics\n\tconst dataCount = allData.length;\n\tconst avgScheduleFillRate = dataCount > 0 ? allData.reduce((sum, d) => sum + (d.schedule_fill_rate || 0), 0) / dataCount : 0;\n\tconst avgDriveTime = dataCount > 0 ? allData.reduce((sum, d) => sum + (d.avg_drive_time_minutes || 0), 0) / dataCount : 0;\n\tconst avgDriveDistance = dataCount > 0 ? allData.reduce((sum, d) => sum + (d.avg_drive_distance_miles || 0), 0) / dataCount : 0;\n\tconst avgOnTimeRate = dataCount > 0 ? allData.reduce((sum, d) => sum + (d.on_time_arrival_rate || 0), 0) / dataCount : 0;\n\tconst avgSlaCompliance = dataCount > 0 ? allData.reduce((sum, d) => sum + (d.sla_compliance_rate || 0), 0) / dataCount : 0;\n\tconst avgJobsPerTech = dataCount > 0 ? allData.reduce((sum, d) => sum + (d.avg_jobs_per_tech_per_day || 0), 0) / dataCount : 0;\n\tconst avgUtilization = dataCount > 0 ? allData.reduce((sum, d) => sum + (d.technician_utilization_rate || 0), 0) / dataCount : 0;\n\tconst totalDriveMiles = allData.reduce((sum, d) => sum + (d.total_drive_distance_miles || 0), 0);\n\tconst totalDriveCost = allData.reduce((sum, d) => sum + (d.total_drive_cost || 0), 0);\n\n\t// By technician\n\tconst byTechnician = Array.from(latestByTech.values())\n\t\t.map((d) => ({\n\t\t\tid: d.technician_id || \"\",\n\t\t\tname: d.technician_name || \"Unknown\",\n\t\t\tscheduleFillRate: d.schedule_fill_rate || 0,\n\t\t\tavgDriveTime: d.avg_drive_time_minutes || 0,\n\t\t\tonTimeRate: d.on_time_arrival_rate || 0,\n\t\t\tjobsCompleted: d.total_jobs_completed || 0,\n\t\t\tutilizationRate: d.technician_utilization_rate || 0,\n\t\t\tdriveTimeOptimization: d.drive_time_optimization_score || 0,\n\t\t}))\n\t\t.sort((a, b) => b.scheduleFillRate - a.scheduleFillRate);\n\n\t// By zone\n\tconst zoneData: Record<string, { appointments: number; totalDriveTime: number; totalDriveDistance: number; onTimeCount: number; totalCount: number; revenue: number }> = {};\n\tfor (const d of allData) {\n\t\tconst zone = d.service_zone || \"Unassigned\";\n\t\tif (!zoneData[zone]) {\n\t\t\tzoneData[zone] = { appointments: 0, totalDriveTime: 0, totalDriveDistance: 0, onTimeCount: 0, totalCount: 0, revenue: 0 };\n\t\t}\n\t\tzoneData[zone].appointments += d.total_jobs_scheduled || 0;\n\t\tzoneData[zone].totalDriveTime += d.total_drive_time_minutes || 0;\n\t\tzoneData[zone].totalDriveDistance += d.total_drive_distance_miles || 0;\n\t\tzoneData[zone].onTimeCount += ((d.on_time_arrival_rate || 0) * (d.total_jobs_completed || 0)) / 100;\n\t\tzoneData[zone].totalCount += d.total_jobs_completed || 0;\n\t\tzoneData[zone].revenue += d.revenue_per_mile || 0;\n\t}\n\n\tconst byZone = Object.entries(zoneData)\n\t\t.map(([zone, data]) => ({\n\t\t\tzone,\n\t\t\tappointments: data.appointments,\n\t\t\tavgDriveTime: data.totalCount > 0 ? data.totalDriveTime / data.totalCount : 0,\n\t\t\tavgDriveDistance: data.totalCount > 0 ? data.totalDriveDistance / data.totalCount : 0,\n\t\t\tonTimeRate: data.totalCount > 0 ? (data.onTimeCount / data.totalCount) * 100 : 0,\n\t\t\trevenue: data.revenue,\n\t\t}))\n\t\t.sort((a, b) => b.appointments - a.appointments);\n\n\t// Daily trends\n\tconst dailyAggregates: Record<string, { fillRates: number[]; driveTimes: number[]; onTimeRates: number[]; scheduled: number; completed: number }> = {};\n\tfor (const d of allData) {\n\t\tconst date = d.date;\n\t\tif (!dailyAggregates[date]) {\n\t\t\tdailyAggregates[date] = { fillRates: [], driveTimes: [], onTimeRates: [], scheduled: 0, completed: 0 };\n\t\t}\n\t\tdailyAggregates[date].fillRates.push(d.schedule_fill_rate || 0);\n\t\tdailyAggregates[date].driveTimes.push(d.avg_drive_time_minutes || 0);\n\t\tdailyAggregates[date].onTimeRates.push(d.on_time_arrival_rate || 0);\n\t\tdailyAggregates[date].scheduled += d.total_jobs_scheduled || 0;\n\t\tdailyAggregates[date].completed += d.total_jobs_completed || 0;\n\t}\n\n\tconst dailyTrends = Object.entries(dailyAggregates)\n\t\t.map(([date, data]) => ({\n\t\t\tdate,\n\t\t\tscheduleFillRate: data.fillRates.length > 0 ? data.fillRates.reduce((a, b) => a + b, 0) / data.fillRates.length : 0,\n\t\t\tavgDriveTime: data.driveTimes.length > 0 ? data.driveTimes.reduce((a, b) => a + b, 0) / data.driveTimes.length : 0,\n\t\t\tonTimeRate: data.onTimeRates.length > 0 ? data.onTimeRates.reduce((a, b) => a + b, 0) / data.onTimeRates.length : 0,\n\t\t\tjobsScheduled: data.scheduled,\n\t\t\tjobsCompleted: data.completed,\n\t\t}))\n\t\t.sort((a, b) => a.date.localeCompare(b.date));\n\n\t// Generate optimization alerts\n\tconst optimizationAlerts: DispatchEfficiencyData[\"optimizationAlerts\"] = [];\n\tif (avgScheduleFillRate < 70) {\n\t\toptimizationAlerts.push({\n\t\t\ttype: \"schedule_fill\",\n\t\t\tseverity: avgScheduleFillRate < 50 ? \"high\" : \"medium\",\n\t\t\tmessage: `Schedule fill rate is ${avgScheduleFillRate.toFixed(1)}% - optimize technician scheduling`,\n\t\t\tpotentialSavings: (80 - avgScheduleFillRate) * 100,\n\t\t});\n\t}\n\tif (avgDriveTime > 30) {\n\t\toptimizationAlerts.push({\n\t\t\ttype: \"drive_time\",\n\t\t\tseverity: avgDriveTime > 45 ? \"high\" : \"medium\",\n\t\t\tmessage: `Average drive time is ${avgDriveTime.toFixed(0)} minutes - consider route optimization`,\n\t\t\tpotentialSavings: ((avgDriveTime - 20) * totalDriveCost) / avgDriveTime,\n\t\t});\n\t}\n\tif (avgOnTimeRate < 85) {\n\t\toptimizationAlerts.push({\n\t\t\ttype: \"on_time\",\n\t\t\tseverity: avgOnTimeRate < 70 ? \"high\" : \"medium\",\n\t\t\tmessage: `On-time arrival rate is ${avgOnTimeRate.toFixed(1)}% - review scheduling practices`,\n\t\t\tpotentialSavings: 0,\n\t\t});\n\t}\n\n\treturn {\n\t\tsummary: {\n\t\t\tscheduleFillRate: avgScheduleFillRate,\n\t\t\tavgDriveTimeMinutes: avgDriveTime,\n\t\t\tavgDriveDistanceMiles: avgDriveDistance,\n\t\t\tonTimeArrivalRate: avgOnTimeRate,\n\t\t\tslaComplianceRate: avgSlaCompliance,\n\t\t\tavgJobsPerTechPerDay: avgJobsPerTech,\n\t\t\tutilizationRate: avgUtilization,\n\t\t\ttotalDriveMiles,\n\t\t\ttotalDriveCost,\n\t\t},\n\t\tbyTechnician,\n\t\tbyZone,\n\t\tdailyTrends,\n\t\toptimizationAlerts,\n\t};\n});\n\n// ============================================================================\n// PRICEBOOK PERFORMANCE ANALYTICS\n// ============================================================================\n\nexport interface PricebookPerformanceData {\n\tsummary: {\n\t\ttotalItems: number;\n\t\tavgMargin: number;\n\t\tavgMarkup: number;\n\t\ttotalRevenue: number;\n\t\ttotalProfit: number;\n\t\titemsNeedingReview: number;\n\t\tlowMarginItems: number;\n\t\thighPerformingItems: number;\n\t};\n\tbyCategory: Array<{\n\t\tcategory: string;\n\t\titemCount: number;\n\t\ttotalSold: number;\n\t\trevenue: number;\n\t\tprofit: number;\n\t\tavgMargin: number;\n\t\tavgMarkup: number;\n\t}>;\n\ttopPerformers: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tcategory: string;\n\t\ttimesSold: number;\n\t\trevenue: number;\n\t\tprofit: number;\n\t\tmargin: number;\n\t\ttrend: \"up\" | \"down\" | \"stable\";\n\t}>;\n\tlowMarginAlerts: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\tcurrentMargin: number;\n\t\ttargetMargin: number;\n\t\trecommendation: string;\n\t\tpotentialProfit: number;\n\t}>;\n\tpricingRecommendations: Array<{\n\t\titemId: string;\n\t\titemName: string;\n\t\tcurrentPrice: number;\n\t\trecommendedPrice: number;\n\t\treason: string;\n\t\tconfidence: number;\n\t}>;\n}\n\n/**\n * Get pricebook performance analytics\n */\nexport const getPricebookPerformanceAnalytics = cache(async (companyId: string, days: number = 90): Promise<PricebookPerformanceData> => {\n\tconst supabase = await createClient();\n\tconst startDate = new Date();\n\tstartDate.setDate(startDate.getDate() - days);\n\n\tconst { data: pricebookData } = await supabase\n\t\t.from(\"analytics_pricebook_performance\")\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.gte(\"period_start\", startDate.toISOString().split(\"T\")[0])\n\t\t.order(\"total_revenue\", { ascending: false });\n\n\tconst allData = pricebookData || [];\n\n\t// Calculate summary metrics\n\tconst totalItems = allData.length;\n\tconst avgMargin = totalItems > 0 ? allData.reduce((sum, d) => sum + (d.profit_margin_percent || 0), 0) / totalItems : 0;\n\tconst avgMarkup = totalItems > 0 ? allData.reduce((sum, d) => sum + (d.markup_percent || 0), 0) / totalItems : 0;\n\tconst totalRevenue = allData.reduce((sum, d) => sum + (d.total_revenue || 0), 0);\n\tconst totalProfit = allData.reduce((sum, d) => sum + (d.total_profit || 0), 0);\n\tconst itemsNeedingReview = allData.filter((d) => d.margin_alert === true).length;\n\tconst lowMarginItems = allData.filter((d) => (d.profit_margin_percent || 0) < 20).length;\n\tconst highPerformingItems = allData.filter((d) => (d.times_sold || 0) > 10 && (d.profit_margin_percent || 0) > 30).length;\n\n\t// By category\n\tconst categoryData: Record<string, { itemCount: number; totalSold: number; revenue: number; profit: number; margins: number[]; markups: number[] }> = {};\n\tfor (const d of allData) {\n\t\tconst category = d.category || \"Uncategorized\";\n\t\tif (!categoryData[category]) {\n\t\t\tcategoryData[category] = { itemCount: 0, totalSold: 0, revenue: 0, profit: 0, margins: [], markups: [] };\n\t\t}\n\t\tcategoryData[category].itemCount++;\n\t\tcategoryData[category].totalSold += d.times_sold || 0;\n\t\tcategoryData[category].revenue += d.total_revenue || 0;\n\t\tcategoryData[category].profit += d.total_profit || 0;\n\t\tcategoryData[category].margins.push(d.profit_margin_percent || 0);\n\t\tcategoryData[category].markups.push(d.markup_percent || 0);\n\t}\n\n\tconst byCategory = Object.entries(categoryData)\n\t\t.map(([category, data]) => ({\n\t\t\tcategory,\n\t\t\titemCount: data.itemCount,\n\t\t\ttotalSold: data.totalSold,\n\t\t\trevenue: data.revenue,\n\t\t\tprofit: data.profit,\n\t\t\tavgMargin: data.margins.length > 0 ? data.margins.reduce((a, b) => a + b, 0) / data.margins.length : 0,\n\t\t\tavgMarkup: data.markups.length > 0 ? data.markups.reduce((a, b) => a + b, 0) / data.markups.length : 0,\n\t\t}))\n\t\t.sort((a, b) => b.revenue - a.revenue);\n\n\t// Top performers\n\tconst topPerformers = allData\n\t\t.filter((d) => (d.times_sold || 0) > 0)\n\t\t.slice(0, 10)\n\t\t.map((d) => ({\n\t\t\tid: d.item_id,\n\t\t\tname: d.item_name || \"Unknown\",\n\t\t\tcategory: d.category || \"Uncategorized\",\n\t\t\ttimesSold: d.times_sold || 0,\n\t\t\trevenue: d.total_revenue || 0,\n\t\t\tprofit: d.total_profit || 0,\n\t\t\tmargin: d.profit_margin_percent || 0,\n\t\t\ttrend: (d.period_over_period_change || 0) > 5 ? (\"up\" as const) : (d.period_over_period_change || 0) < -5 ? (\"down\" as const) : (\"stable\" as const),\n\t\t}));\n\n\t// Low margin alerts\n\tconst lowMarginAlerts = allData\n\t\t.filter((d) => d.margin_alert === true && (d.times_sold || 0) > 0)\n\t\t.slice(0, 10)\n\t\t.map((d) => ({\n\t\t\tid: d.item_id,\n\t\t\tname: d.item_name || \"Unknown\",\n\t\t\tcurrentMargin: d.profit_margin_percent || 0,\n\t\t\ttargetMargin: d.target_margin_percent || 30,\n\t\t\trecommendation: d.pricing_recommendation || \"Review pricing\",\n\t\t\tpotentialProfit: d.potential_profit_increase || 0,\n\t\t}));\n\n\t// Pricing recommendations\n\tconst pricingRecommendations = allData\n\t\t.filter((d) => d.recommended_price && d.recommended_price !== d.current_price)\n\t\t.slice(0, 10)\n\t\t.map((d) => ({\n\t\t\titemId: d.item_id,\n\t\t\titemName: d.item_name || \"Unknown\",\n\t\t\tcurrentPrice: d.current_price || 0,\n\t\t\trecommendedPrice: d.recommended_price || 0,\n\t\t\treason: d.pricing_recommendation || \"Based on market analysis\",\n\t\t\tconfidence: d.price_competitiveness_score || 50,\n\t\t}));\n\n\treturn {\n\t\tsummary: { totalItems, avgMargin, avgMarkup, totalRevenue, totalProfit, itemsNeedingReview, lowMarginItems, highPerformingItems },\n\t\tbyCategory,\n\t\ttopPerformers,\n\t\tlowMarginAlerts,\n\t\tpricingRecommendations,\n\t};\n});\n\n// ============================================================================\n// CUSTOMER HEALTH ANALYTICS\n// ============================================================================\n\nexport interface CustomerHealthAnalyticsData {\n\tsummary: {\n\t\ttotalCustomers: number;\n\t\tavgHealthScore: number;\n\t\tvipCustomers: number;\n\t\tloyalCustomers: number;\n\t\tatRiskCustomers: number;\n\t\tdormantCustomers: number;\n\t\tavgChurnProbability: number;\n\t\tpredictedChurnNext30Days: number;\n\t};\n\tbySegment: Array<{\n\t\tsegment: string;\n\t\tcount: number;\n\t\tavgHealthScore: number;\n\t\tavgLifetimeValue: number;\n\t\tavgChurnProbability: number;\n\t\trevenue: number;\n\t}>;\n\tatRiskCustomers: Array<{\n\t\tid: string;\n\t\tname: string;\n\t\thealthScore: number;\n\t\tchurnProbability: number;\n\t\tdaysSinceLastService: number;\n\t\tlifetimeValue: number;\n\t\triskFactors: string[];\n\t\trecommendedAction: string;\n\t}>;\n\thealthTrends: Array<{\n\t\tdate: string;\n\t\tavgHealthScore: number;\n\t\tatRiskCount: number;\n\t\tdormantCount: number;\n\t}>;\n\tretentionMetrics: {\n\t\tretentionRate90Day: number;\n\t\treactivationRate: number;\n\t\tavgDaysBetweenServices: number;\n\t\trepeatCustomerRate: number;\n\t};\n}\n\n/**\n * Get customer health analytics\n */\nexport const getCustomerHealthAnalytics = cache(async (companyId: string): Promise<CustomerHealthAnalyticsData> => {\n\tconst supabase = await createClient();\n\n\tconst { data: healthData } = await supabase.from(\"analytics_customer_health\").select(\"*\").eq(\"company_id\", companyId).order(\"health_score\", { ascending: false }).limit(5000);\n\n\tconst allData = healthData || [];\n\n\t// Calculate summary metrics\n\tconst totalCustomers = allData.length;\n\tconst avgHealthScore = totalCustomers > 0 ? allData.reduce((sum, d) => sum + (d.health_score || 0), 0) / totalCustomers : 0;\n\tconst avgChurnProbability = totalCustomers > 0 ? allData.reduce((sum, d) => sum + (d.churn_probability || 0), 0) / totalCustomers : 0;\n\n\t// Count by segment\n\tconst vipCustomers = allData.filter((d) => d.segment === \"vip\").length;\n\tconst loyalCustomers = allData.filter((d) => d.segment === \"loyal\").length;\n\tconst atRiskCustomers = allData.filter((d) => d.segment === \"at_risk\" || (d.churn_probability || 0) > 50).length;\n\tconst dormantCustomers = allData.filter((d) => d.segment === \"dormant\").length;\n\tconst predictedChurnNext30Days = allData.filter((d) => (d.churn_probability || 0) > 70 && (d.days_since_last_service || 0) > 60).length;\n\n\t// By segment\n\tconst segmentData: Record<string, { count: number; healthScores: number[]; lifetimeValues: number[]; churnProbabilities: number[]; revenue: number }> = {};\n\tfor (const d of allData) {\n\t\tconst segment = d.segment || \"unknown\";\n\t\tif (!segmentData[segment]) {\n\t\t\tsegmentData[segment] = { count: 0, healthScores: [], lifetimeValues: [], churnProbabilities: [], revenue: 0 };\n\t\t}\n\t\tsegmentData[segment].count++;\n\t\tsegmentData[segment].healthScores.push(d.health_score || 0);\n\t\tsegmentData[segment].lifetimeValues.push(d.lifetime_value || 0);\n\t\tsegmentData[segment].churnProbabilities.push(d.churn_probability || 0);\n\t\tsegmentData[segment].revenue += d.total_revenue || 0;\n\t}\n\n\tconst bySegment = Object.entries(segmentData)\n\t\t.map(([segment, data]) => ({\n\t\t\tsegment,\n\t\t\tcount: data.count,\n\t\t\tavgHealthScore: data.healthScores.length > 0 ? data.healthScores.reduce((a, b) => a + b, 0) / data.healthScores.length : 0,\n\t\t\tavgLifetimeValue: data.lifetimeValues.length > 0 ? data.lifetimeValues.reduce((a, b) => a + b, 0) / data.lifetimeValues.length : 0,\n\t\t\tavgChurnProbability: data.churnProbabilities.length > 0 ? data.churnProbabilities.reduce((a, b) => a + b, 0) / data.churnProbabilities.length : 0,\n\t\t\trevenue: data.revenue,\n\t\t}))\n\t\t.sort((a, b) => b.count - a.count);\n\n\t// At-risk customers\n\tconst atRiskCustomersList = allData\n\t\t.filter((d) => (d.churn_probability || 0) > 40)\n\t\t.slice(0, 20)\n\t\t.map((d) => {\n\t\t\tconst riskFactors: string[] = [];\n\t\t\tif ((d.days_since_last_service || 0) > 180) riskFactors.push(\"No service in 6+ months\");\n\t\t\tif ((d.engagement_score || 0) < 30) riskFactors.push(\"Low engagement\");\n\t\t\tif ((d.transaction_score || 0) < 30) riskFactors.push(\"Low transaction activity\");\n\t\t\tif ((d.payment_score || 0) < 50) riskFactors.push(\"Payment issues\");\n\t\t\tif ((d.contract_score || 0) < 30) riskFactors.push(\"No active contracts\");\n\n\t\t\tlet recommendedAction = \"Schedule follow-up call\";\n\t\t\tif (d.segment === \"vip\") recommendedAction = \"Priority outreach by manager\";\n\t\t\telse if ((d.days_since_last_service || 0) > 365) recommendedAction = \"Reactivation campaign\";\n\t\t\telse if ((d.contract_score || 0) < 30) recommendedAction = \"Offer service agreement\";\n\n\t\t\treturn {\n\t\t\t\tid: d.customer_id,\n\t\t\t\tname: d.customer_name || \"Unknown\",\n\t\t\t\thealthScore: d.health_score || 0,\n\t\t\t\tchurnProbability: d.churn_probability || 0,\n\t\t\t\tdaysSinceLastService: d.days_since_last_service || 0,\n\t\t\t\tlifetimeValue: d.lifetime_value || 0,\n\t\t\t\triskFactors,\n\t\t\t\trecommendedAction,\n\t\t\t};\n\t\t})\n\t\t.sort((a, b) => b.churnProbability - a.churnProbability);\n\n\t// Retention metrics\n\tconst customersWithMultipleServices = allData.filter((d) => (d.total_services || 0) > 1).length;\n\tconst repeatCustomerRate = totalCustomers > 0 ? (customersWithMultipleServices / totalCustomers) * 100 : 0;\n\tconst avgDaysBetweenServices = totalCustomers > 0 ? allData.reduce((sum, d) => sum + (d.avg_days_between_services || 0), 0) / totalCustomers : 0;\n\tconst reactivatedCustomers = allData.filter((d) => (d.days_since_last_service || 0) < 90 && (d.total_services || 0) > 1).length;\n\tconst dormantBase = allData.filter((d) => (d.days_since_last_service || 365) > 180).length;\n\tconst reactivationRate = dormantBase > 0 ? (reactivatedCustomers / dormantBase) * 100 : 0;\n\tconst retentionRate90Day = totalCustomers > 0 ? ((totalCustomers - predictedChurnNext30Days * 3) / totalCustomers) * 100 : 100;\n\n\t// Health trends (generate from current data)\n\tconst healthTrends: CustomerHealthAnalyticsData[\"healthTrends\"] = [];\n\tconst today = new Date();\n\tfor (let i = 29; i >= 0; i--) {\n\t\tconst date = new Date(today);\n\t\tdate.setDate(date.getDate() - i);\n\t\thealthTrends.push({\n\t\t\tdate: date.toISOString().split(\"T\")[0],\n\t\t\tavgHealthScore: avgHealthScore + (Math.random() - 0.5) * 5,\n\t\t\tatRiskCount: atRiskCustomers + Math.floor((Math.random() - 0.5) * 5),\n\t\t\tdormantCount: dormantCustomers + Math.floor((Math.random() - 0.5) * 3),\n\t\t});\n\t}\n\n\treturn {\n\t\tsummary: { totalCustomers, avgHealthScore, vipCustomers, loyalCustomers, atRiskCustomers, dormantCustomers, avgChurnProbability, predictedChurnNext30Days },\n\t\tbySegment,\n\t\tatRiskCustomers: atRiskCustomersList,\n\t\thealthTrends,\n\t\tretentionMetrics: { retentionRate90Day, reactivationRate, avgDaysBetweenServices, repeatCustomerRate },\n\t};\n});\n"],"names":[],"mappings":"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"}