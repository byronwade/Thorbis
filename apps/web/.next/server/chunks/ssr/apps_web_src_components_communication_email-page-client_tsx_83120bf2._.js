module.exports=[116381,a=>{"use strict";var b=a.i(861467),c=a.i(642278),d=a.i(169021),e=(0,d.createServerReference)("40c9873b94db1de913ae9956b543ae7d67e32a3a25",d.callServer,void 0,d.findSourceMapURL,"archiveAllEmailsAction"),f=(0,d.createServerReference)("70f55d0fe7fe54925069d66485de41507bc67cdf38",d.callServer,void 0,d.findSourceMapURL,"fetchEmailContentAction"),g=a.i(201489),h=a.i(726683),i=(0,d.createServerReference)("408f0392fe38f20921ddeedcb09702a487a451816c",d.callServer,void 0,d.findSourceMapURL,"toggleSpamEmailAction"),j=a.i(984872),k=(0,d.createServerReference)("40acfa669f558a4f0b50a4d805bdaca76777deb01d",d.callServer,void 0,d.findSourceMapURL,"retryFailedEmailAction");a.i(445255);var l=a.i(18170);a.i(297229);var m=a.i(489904),n=a.i(700760),o=a.i(112932),p=a.i(766153),q=a.i(984270),r=a.i(789815),s=a.i(898062),t=a.i(320091),u=a.i(145679);function v({customer:a,fallbackName:c,fallbackEmail:d,fallbackPhone:e,className:f,size:g="default"}){let h=a?.email||d,i=a?.phone||e,j=(0,o.getCustomerDisplayName)(a?{...a,email:a.email||d}:null,c||d),k=!!a?.id,v=(0,o.getCustomerInitials)(a);return(0,b.jsxs)(m.Popover,{children:[(0,b.jsx)(m.PopoverTrigger,{asChild:!0,children:(0,b.jsxs)("button",{type:"button",className:(0,n.cn)("inline-flex items-center gap-1 rounded-full border border-border/50 bg-muted/50 hover:bg-muted transition-colors cursor-pointer","sm"===g?"px-2 py-0.5 text-xs":"px-2.5 py-1 text-sm",f),children:[(0,b.jsx)("span",{className:"font-medium truncate max-w-[150px]",children:j}),(0,b.jsx)(p.ChevronDown,{className:(0,n.cn)("text-muted-foreground","sm"===g?"h-3 w-3":"h-3.5 w-3.5")})]})}),(0,b.jsxs)(m.PopoverContent,{className:"w-72 p-0",align:"start",children:[(0,b.jsxs)("div",{className:"p-4",children:[(0,b.jsxs)("div",{className:"flex items-start gap-3 mb-3",children:[(0,b.jsx)("div",{className:(0,n.cn)("flex items-center justify-center rounded-full bg-primary/10 text-primary font-semibold","sm"===g?"h-10 w-10 text-sm":"h-12 w-12 text-base"),children:v||(0,b.jsx)(t.User,{className:"h-5 w-5"})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsx)("p",{className:"font-semibold text-foreground truncate",children:j}),a?.company_name&&(0,b.jsx)("p",{className:"text-xs text-muted-foreground truncate",children:a.company_name}),!k&&(0,b.jsx)("span",{className:"inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400 mt-1",children:"Not linked"})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[h&&(0,b.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,b.jsx)(r.Mail,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),(0,b.jsx)("a",{href:`mailto:${h}`,className:"text-foreground hover:text-primary truncate transition-colors",children:h})]}),i&&(0,b.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,b.jsx)(s.Phone,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),(0,b.jsx)("a",{href:`tel:${i}`,className:"text-foreground hover:text-primary transition-colors",children:i})]}),!h&&!i&&(0,b.jsx)("p",{className:"text-sm text-muted-foreground italic",children:"No contact info available"})]})]}),k&&(0,b.jsx)("div",{className:"border-t border-border px-4 py-3 bg-muted/30",children:(0,b.jsx)(l.Button,{variant:"outline",size:"sm",className:"w-full",asChild:!0,children:(0,b.jsxs)(u.default,{href:`/dashboard/customers/${a.id}`,children:[(0,b.jsx)("span",{children:"View Full Profile"}),(0,b.jsx)(q.ExternalLink,{className:"h-3.5 w-3.5 ml-1.5"})]})})})]})]})}var w=a.i(301784),x=a.i(735040),y=(0,d.createServerReference)("401d356a968cf8d1f995402d9f67be44efdfa030c2",d.callServer,void 0,d.findSourceMapURL,"saveDraftAction"),z=(0,d.createServerReference)("402a8624506c3a970451b4011123033b4cf44a1c0d",d.callServer,void 0,d.findSourceMapURL,"deleteDraftAction"),A=a.i(156916);a.i(956852);var B=a.i(90125);a.i(839984);var C=a.i(372712);a.i(928414);var D=a.i(745250),E=a.i(251048),F=a.i(863041),F=F,G=a.i(587969),H=a.i(624126),I=a.i(348466),I=I,J=a.i(534375),K=a.i(220578),L=a.i(280503),L=L,M=a.i(198803),N=a.i(21220),O=a.i(739044),P=a.i(283753),Q=a.i(339632),R=a.i(927396),R=R,S=a.i(300298),T=a.i(783281),U=a.i(578256),V=a.i(992163);a.i(516775);var W=a.i(560272);a.i(413309);var X=a.i(54210);a.i(146697);var Y=a.i(778737),Z=a.i(263758),$=a.i(337850),_=a.i(638727),aa=a.i(50900),ab=a.i(101482);function ac({value:a,onChange:c,placeholder:d="Search or type email...",className:e,recentRecipients:f=[]}){let g=(0,T.useRef)(null),h=(0,T.useRef)(null),[i,j]=(0,T.useState)(""),[k,l]=(0,T.useState)(!1),[m,o]=(0,T.useState)([]),[p,q]=(0,T.useState)([]),[s,u]=(0,T.useState)(!1),[v,w]=(0,T.useState)(0),[x,y]=(0,T.useTransition)(),[z,A]=(0,T.useState)(!0),B=(0,T.useMemo)(()=>`recipient-${Math.random().toString(36).slice(2)}`,[]),C=(0,T.useMemo)(()=>new Set((a||[]).map(a=>a.email.toLowerCase())),[a]);(0,T.useEffect)(()=>{if(i.trim().length<2){o([]),q([]);return}let a=setTimeout(()=>{u(!0),y(async()=>{try{try{let a=await (0,U.searchCustomers)(i,{limit:5});if(a.success&&a.data){let b=(Array.isArray(a.data)?a.data:[a.data]).filter(a=>a.email&&!C.has(a.email.toLowerCase())).map(a=>({id:a.id,type:"customer",name:a.display_name||`${a.first_name||""} ${a.last_name||""}`.trim()||"Customer",email:a.email,subtitle:a.company_name||void 0}));o(b)}else o([])}catch(a){o([])}try{let a=await (0,V.searchVendors)(i);if(a.success&&a.data){let b=(Array.isArray(a.data)?a.data:[a.data]).filter(a=>a.email&&!C.has(a.email.toLowerCase())).map(a=>({id:a.id,type:"vendor",name:a.display_name||a.name,email:a.email}));q(b)}else q([])}catch(a){q([])}}catch(a){o([]),q([])}finally{u(!1)}})},200);return()=>clearTimeout(a)},[i,C]);let D=(0,T.useMemo)(()=>{let a=[];/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i.trim())&&!C.has(i.trim().toLowerCase())&&a.push({id:"custom",label:"Add Email",icon:(0,b.jsx)(r.Mail,{className:"h-4 w-4"}),suggestions:[{id:`custom-${i}`,type:"custom",name:i.trim(),email:i.trim()}]});let c=f.filter(a=>!C.has(a.email.toLowerCase()));return c.length>0&&i.trim().length<2&&a.push({id:"recent",label:"From this thread",icon:(0,b.jsx)(r.Mail,{className:"h-4 w-4"}),suggestions:c.map(a=>({id:a.id,type:a.type,name:a.name,email:a.email}))}),m.length>0&&a.push({id:"customers",label:"Customers",icon:(0,b.jsx)(t.User,{className:"h-4 w-4"}),suggestions:m}),p.length>0&&a.push({id:"vendors",label:"Vendors",icon:(0,b.jsx)(Z.Building2,{className:"h-4 w-4"}),suggestions:p}),a},[i,m,p,f,C]),E=(0,T.useMemo)(()=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i.trim()),[i]),F=(0,T.useMemo)(()=>{let a=i.trim();return a.length>0&&!C.has(a.toLowerCase())},[i,C]),G=(0,T.useMemo)(()=>D.flatMap(a=>a.suggestions||[]),[D]),H=(0,T.useCallback)(b=>{let d={id:b.id,type:b.type,name:b.name,email:b.email};C.has(d.email.toLowerCase())||c([...a||[],d]),j(""),o([]),q([]),g.current?.focus()},[a,c,C]),I=(0,T.useCallback)(()=>{let a=i.trim();E&&H({id:`custom-${a}`,type:"custom",name:a,email:a})},[i,E,H]),J=(0,T.useCallback)(b=>{c((a||[]).filter(a=>a.email!==b))},[a,c]),K=(0,T.useCallback)(b=>{let c=a||[];"Backspace"===b.key&&""===i&&c.length>0?(b.preventDefault(),J(c[c.length-1].email)):"ArrowDown"===b.key?(b.preventDefault(),w(a=>Math.min(a+1,G.length-1))):"ArrowUp"===b.key?(b.preventDefault(),w(a=>Math.max(a-1,0))):"Enter"===b.key?(b.preventDefault(),G.length>0&&v<G.length?H(G[v]):i.trim()&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i.trim())&&H({id:`custom-${i}`,type:"custom",name:i.trim(),email:i.trim()})):"Escape"===b.key?l(!1):(","===b.key||";"===b.key||"Tab"===b.key)&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i.trim())&&(b.preventDefault(),H({id:`custom-${i}`,type:"custom",name:i.trim(),email:i.trim()}))},[i,a,G,v,H,J]);(0,T.useEffect)(()=>{let a=a=>{h.current&&!h.current.contains(a.target)&&l(!1)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[]),(0,T.useEffect)(()=>{w(0)},[G.length]);let L=k&&(D.length>0||s||0===i.trim().length);return(0,b.jsxs)("div",{ref:h,className:(0,n.cn)("relative",e),children:[(0,b.jsxs)("div",{className:(0,n.cn)("flex flex-wrap items-center gap-1.5 min-h-[36px] px-2 py-1.5","rounded-lg border border-input bg-background","transition-colors cursor-text",k&&"border-primary ring-1 ring-primary/20"),onClick:()=>g.current?.focus(),children:[(a||[]).map(a=>(0,b.jsxs)("div",{className:(0,n.cn)("flex items-center gap-1.5 h-7 pl-2 pr-1 rounded-md border text-xs font-medium",(a=>{switch(a){case"customer":return"bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-500/20";case"vendor":return"bg-purple-500/10 text-purple-600 dark:text-purple-400 border-purple-500/20";case"team":return"bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/20";default:return"bg-muted text-muted-foreground border-border"}})(a.type)),children:[(a=>{switch(a){case"customer":return(0,b.jsx)(t.User,{className:"h-3 w-3"});case"vendor":return(0,b.jsx)(Z.Building2,{className:"h-3 w-3"});case"team":return(0,b.jsx)(ab.Users,{className:"h-3 w-3"});default:return(0,b.jsx)(r.Mail,{className:"h-3 w-3"})}})(a.type),(0,b.jsx)("span",{className:"max-w-[120px] truncate",children:a.name||a.email}),(0,b.jsx)("button",{type:"button",onClick:b=>{b.stopPropagation(),J(a.email)},className:"ml-0.5 p-0.5 rounded hover:bg-black/10 dark:hover:bg-white/10 transition-colors",children:(0,b.jsx)(S.X,{className:"h-3 w-3"})})]},a.email)),(0,b.jsxs)("div",{className:"flex-1 min-w-[140px] flex items-center gap-1.5",children:[(0,b.jsx)(aa.Search,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),(0,b.jsxs)("form",{autoComplete:"off",onSubmit:a=>a.preventDefault(),className:"flex-1",children:[(0,b.jsx)("input",{type:"text",name:"decoy",autoComplete:"off",tabIndex:-1,style:{position:"absolute",left:"-9999px",width:"1px",height:"1px"},"aria-hidden":"true"}),(0,b.jsx)("input",{ref:g,type:"text",value:i,onChange:a=>j(a.target.value),onFocus:()=>{l(!0),A(!1)},onBlur:()=>{setTimeout(()=>A(!0),100)},onKeyDown:K,placeholder:0===(a||[]).length?d:"Add more...",className:"flex-1 bg-transparent text-sm outline-none placeholder:text-muted-foreground w-full",autoComplete:"chrome-off",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false","data-form-type":"other","data-lpignore":"true","data-1p-ignore":"true",role:"combobox","aria-autocomplete":"list","aria-expanded":L,"aria-controls":"recipient-suggestions",name:B,readOnly:z})]})]})]}),L&&(0,b.jsxs)("div",{className:"absolute z-50 left-0 right-0 mt-1.5 bg-popover border border-border rounded-lg shadow-lg overflow-hidden",children:[(0,b.jsxs)(X.ScrollArea,{className:"max-h-[280px]",children:[s&&(0,b.jsxs)("div",{className:"flex items-center gap-2 px-3 py-3 text-sm text-muted-foreground",children:[(0,b.jsx)(M.Loader2,{className:"h-4 w-4 animate-spin"}),"Searching..."]}),F&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{className:"p-1.5",children:(0,b.jsxs)("button",{type:"button",onClick:I,disabled:!E,className:(0,n.cn)("flex items-center gap-2 w-full px-2 py-2 text-left rounded-md transition-colors",E?"hover:bg-accent cursor-pointer":"opacity-60 cursor-not-allowed"),children:[(0,b.jsx)("div",{className:(0,n.cn)("flex items-center justify-center h-7 w-7 shrink-0 rounded-full",E?"bg-blue-500/10":"bg-muted"),children:(0,b.jsx)(r.Mail,{className:(0,n.cn)("h-4 w-4",E?"text-blue-600 dark:text-blue-400":"text-muted-foreground")})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsxs)("div",{className:"text-sm font-medium",children:['Add "',i.trim(),'"']}),(0,b.jsx)("div",{className:"text-xs text-muted-foreground",children:E?"Use this email address":"Enter a valid email address"})]}),(0,b.jsx)(_.Plus,{className:"h-4 w-4 text-muted-foreground shrink-0"})]})}),(D.length>0||s)&&(0,b.jsx)(Y.Separator,{})]}),!s&&0===D.length&&i.trim().length>=2&&!F&&(0,b.jsxs)("div",{className:"px-3 py-4 text-center",children:[(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"No results found"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground/70 mt-1",children:"Type a valid email to add manually"})]}),!s&&i.trim().length<2&&0===D.length&&(0,b.jsxs)("div",{className:"p-2",children:[(0,b.jsx)("p",{className:"px-2 py-1.5 text-[10px] font-medium text-muted-foreground/70 uppercase tracking-wider",children:"Quick Add"}),(0,b.jsxs)("div",{className:"space-y-0.5",children:[(0,b.jsxs)("button",{type:"button",className:"flex items-center gap-2 w-full px-2 py-2 text-sm text-left rounded-md hover:bg-accent transition-colors",onClick:()=>g.current?.focus(),children:[(0,b.jsx)("div",{className:"flex items-center justify-center h-8 w-8 rounded-full bg-blue-500/10",children:(0,b.jsx)(t.User,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("span",{className:"font-medium",children:"Search customers"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:"Type to search your customers"})]}),(0,b.jsx)($.ChevronRight,{className:"h-4 w-4 text-muted-foreground"})]}),(0,b.jsxs)("button",{type:"button",className:"flex items-center gap-2 w-full px-2 py-2 text-sm text-left rounded-md hover:bg-accent transition-colors",onClick:()=>g.current?.focus(),children:[(0,b.jsx)("div",{className:"flex items-center justify-center h-8 w-8 rounded-full bg-purple-500/10",children:(0,b.jsx)(Z.Building2,{className:"h-4 w-4 text-purple-600 dark:text-purple-400"})}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("span",{className:"font-medium",children:"Search vendors"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:"Type to search your vendors"})]}),(0,b.jsx)($.ChevronRight,{className:"h-4 w-4 text-muted-foreground"})]})]})]}),!s&&D.map((a,c)=>(0,b.jsxs)("div",{children:[c>0&&(0,b.jsx)(Y.Separator,{}),(0,b.jsxs)("div",{className:"p-1.5",children:[(0,b.jsxs)("div",{className:"flex items-center gap-1 px-2 py-0.5 text-[10px] font-medium text-muted-foreground/70 uppercase tracking-wider",children:[(0,b.jsx)("span",{className:"opacity-70",children:a.icon}),a.label]}),(0,b.jsx)("div",{className:"space-y-0.5",children:a.suggestions?.map(a=>{let c=G.findIndex(b=>b.id===a.id)===v;return(0,b.jsxs)("button",{type:"button",onClick:()=>H(a),className:(0,n.cn)("flex items-center gap-2 w-full px-2 py-1.5 text-left rounded-md transition-colors",c?"bg-accent":"hover:bg-accent/50"),children:[(0,b.jsx)(W.Avatar,{className:"h-7 w-7 shrink-0",children:(0,b.jsx)(W.AvatarFallback,{className:"text-[10px] bg-muted",children:"vendor"===a.type?(0,b.jsx)(Z.Building2,{className:"h-3.5 w-3.5"}):"custom"===a.type?(0,b.jsx)(r.Mail,{className:"h-3.5 w-3.5"}):a.name.split(" ").map(a=>a[0]).join("").toUpperCase().slice(0,2)})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsx)("div",{className:"text-sm font-medium truncate",children:a.name}),(0,b.jsxs)("div",{className:"text-xs text-muted-foreground truncate",children:[a.email,a.subtitle&&` • ${a.subtitle}`]})]}),(0,b.jsx)(_.Plus,{className:"h-4 w-4 text-muted-foreground shrink-0"})]},a.id)})})]})]},a.id))]}),(0,b.jsx)("div",{className:"px-3 py-1.5 border-t border-border bg-muted/30",children:(0,b.jsxs)("p",{className:"text-[10px] text-muted-foreground",children:[(0,b.jsx)("kbd",{className:"px-1 py-0.5 rounded bg-muted text-[10px] font-mono",children:"↑↓"})," navigate",(0,b.jsx)("span",{className:"mx-1.5",children:"•"}),(0,b.jsx)("kbd",{className:"px-1 py-0.5 rounded bg-muted text-[10px] font-mono",children:"Enter"})," select",(0,b.jsx)("span",{className:"mx-1.5",children:"•"}),(0,b.jsx)("kbd",{className:"px-1 py-0.5 rounded bg-muted text-[10px] font-mono",children:","})," add email"]})})]})]})}let ad=(0,a.i(226559).default)(async()=>{},{loadableGenerated:{modules:[321019]},loading:()=>(0,b.jsx)("div",{className:"flex items-center justify-center py-4",children:(0,b.jsx)(M.Loader2,{className:"h-5 w-5 animate-spin text-muted-foreground"})}),ssr:!1}),ae=[{id:"follow-up",label:"Friendly follow-up",body:"Hi there,\n\nJust checking in — let me know if you have any questions or if you'd like to see anything else from my side.\n\nBest,"},{id:"thank-you",label:"Thank you note",body:"Hi there,\n\nThanks again for your patience while we sorted this out. Let me know if there's anything else I can help with.\n\nWarm regards,"},{id:"next-steps",label:"Outline next steps",body:"Hi there,\n\nI've outlined the next steps:\n1. Review the details above.\n2. Confirm when you'd like to move forward.\n3. I'll lock everything in once you reply.\n\nLet me know if you want to adjust anything."},{id:"introduction",label:"Introduction",body:"Hi there,\n\nI wanted to reach out and introduce myself. I'm looking forward to working with you.\n\nPlease let me know if you have any questions.\n\nBest regards,"}],af=[{id:"none",label:"No signature",value:""},{id:"support",label:"Thorbis Support",value:"\n\nThanks,\nThorbis Support Team"},{id:"tech",label:"Technical Lead",value:"\n\nBest regards,\nJordan – Technical Lead"}];function ag({companyId:a,onClose:c,onSent:d,initialRecipient:e,className:f}){let{toast:g}=(0,E.useToast)(),h=(0,T.useRef)(null),i=(0,T.useRef)(null),j=(0,T.useRef)(null),[k,o]=(0,T.useState)(""),[q,r]=(0,T.useState)(""),[s,t]=(0,T.useState)(e?[e]:[]),[u,v]=(0,T.useState)([]),[w,U]=(0,T.useState)([]),[V,W]=(0,T.useState)(!1),[X,Y]=(0,T.useState)(!1),[Z,$]=(0,T.useState)([]),[_,aa]=(0,T.useState)("support"),[ab,ag]=(0,T.useState)(!1),[ah,ai]=(0,T.useState)(!1),[aj,ak]=(0,T.useState)(null),[al,am]=(0,T.useState)(null),[an,ao]=(0,T.useState)(!1),[ap,aq]=(0,T.useState)(!1),[ar,as]=(0,T.useState)(""),[at,au]=(0,T.useState)(""),[av,aw]=(0,T.useState)(!1),[ax,ay]=(0,T.useState)(5),az=(0,T.useRef)(null),aA=(0,T.useRef)(null),aB=(0,T.useRef)(null),aC=(0,T.useRef)(null),aD=(0,T.useMemo)(()=>af.find(a=>a.id===_)??af[0],[_]),aE=(0,T.useMemo)(()=>s.find(a=>"customer"===a.type&&a.id),[s]);(0,T.useEffect)(()=>{(k||q||s.length>0)&&ai(!0)},[k,q,s]);let aF=(0,T.useCallback)(async()=>{if(!an&&(k||q||0!==s.length)){ao(!0);try{let a=s.find(a=>"customer"===a.type),b=await y({id:al||void 0,to:s.map(a=>a.email).filter(Boolean),cc:u.map(a=>a.email).filter(Boolean),bcc:w.map(a=>a.email).filter(Boolean),subject:q,body:k,customerId:a?.id,attachments:Z.length>0?Z.map(a=>({filename:a.filename,content:a.content,contentType:a.contentType})):void 0});b.success&&b.draftId?(am(b.draftId),ak(new Date),ai(!1)):console.error("Failed to save draft:",b.error)}catch(a){console.error("Error saving draft:",a)}finally{ao(!1)}}},[k,q,s,u,w,Z,al,an]);(0,T.useEffect)(()=>{if(ah)return j.current=setTimeout(()=>{aF()},3e4),()=>{j.current&&clearTimeout(j.current)}},[ah,aF]),(0,T.useEffect)(()=>()=>{az.current&&clearTimeout(az.current),aA.current&&clearInterval(aA.current),j.current&&clearTimeout(j.current)},[]);let aG=(0,T.useCallback)(()=>{let a=h.current;a&&(a.style.height="auto",a.style.height=`${a.scrollHeight}px`)},[]);(0,T.useEffect)(()=>{aG()},[k,aG]),(0,T.useEffect)(()=>{setTimeout(()=>h.current?.focus(),100)},[]);let aH=(0,T.useCallback)(()=>{az.current&&(clearTimeout(az.current),az.current=null),aA.current&&(clearInterval(aA.current),aA.current=null),null!==aB.current&&(A.toast.dismiss(aB.current),aB.current=null),aw(!1),ay(5),aC.current=null,g.success("Send cancelled")},[g]),aI=(0,T.useCallback)(async()=>{let a=aC.current;if(a){null!==aB.current&&(A.toast.dismiss(aB.current),aB.current=null),ag(!0);try{let b=await (0,x.sendCustomerEmailAction)(a);if(b.success){if(al)try{await z(al)}catch(a){console.error("Failed to delete draft after send:",a)}g.success("Email sent successfully"),d?.(b.data??{}),c()}else g.error(b.error||"Failed to send email")}catch(a){console.error("Send failed:",a),g.error(a instanceof Error?a.message:"Failed to send")}finally{ag(!1),aw(!1),aC.current=null}}},[g,d,c,al]),aJ=async()=>{if(!a)return void g.error("Unable to send - missing company context");let c=s.map(a=>a.email).filter(Boolean);if(0===c.length)return void g.error("Add at least one recipient");if(!q.trim())return void g.error("Please add a subject");if(!k.trim())return void g.error("Please write a message");let d=k+(aD?.value||""),e=s.find(a=>"customer"===a.type),f=u.map(a=>a.email).filter(Boolean),h=w.map(a=>a.email).filter(Boolean);aC.current={to:c,subject:q,body:d,customerName:e?.name||"Customer",companyId:a,customerId:e?.id,cc:f.length>0?f:void 0,bcc:h.length>0?h:void 0,attachments:Z.length>0?Z.map(a=>({filename:a.filename,content:a.content,contentType:a.contentType})):void 0},aw(!0),ay(5);let i=5;aB.current=A.toast.info((0,b.jsxs)("div",{className:"flex items-center justify-between gap-4 w-full",children:[(0,b.jsxs)("span",{children:["Sending email in ",i,"s..."]}),(0,b.jsx)("button",{className:"text-sm font-medium text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",onClick:()=>aH(),children:"Undo"})]}),{duration:5500}),aA.current=setInterval(()=>{ay(--i),null!==aB.current&&i>0&&A.toast.info((0,b.jsxs)("div",{className:"flex items-center justify-between gap-4 w-full",children:[(0,b.jsxs)("span",{children:["Sending email in ",i,"s..."]}),(0,b.jsx)("button",{className:"text-sm font-medium text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",onClick:()=>aH(),children:"Undo"})]}),{id:aB.current,duration:5500}),i<=0&&aA.current&&(clearInterval(aA.current),aA.current=null)},1e3),az.current=setTimeout(()=>{aA.current&&(clearInterval(aA.current),aA.current=null),aI()},5e3)},aK=async b=>{if(!a)return void g.error("Unable to send - missing company context");let e=s.map(a=>a.email).filter(Boolean);if(0===e.length)return void g.error("Add at least one recipient");if(!q.trim())return void g.error("Please add a subject");ag(!0);try{let f=k+(aD?.value||""),h=s.find(a=>"customer"===a.type),i=u.map(a=>a.email).filter(Boolean),j=w.map(a=>a.email).filter(Boolean),l=await (0,x.sendCustomerEmailAction)({to:e,subject:q,body:f,customerName:h?.name||"Customer",companyId:a,customerId:h?.id,cc:i.length>0?i:void 0,bcc:j.length>0?j:void 0,attachments:Z.length>0?Z.map(a=>({filename:a.filename,content:a.content,contentType:a.contentType})):void 0,scheduledFor:b.toISOString()});if(l.success){let a=b.toLocaleString("en-US",{weekday:"short",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"});g.success(`Email scheduled for ${a}`),d?.(l.data??{}),c()}else g.error(l.error||"Failed to schedule email")}catch(a){console.error("Schedule failed:",a),g.error(a instanceof Error?a.message:"Failed to schedule")}finally{ag(!1),aq(!1)}},aL=a=>{let b=new Date,c=new Date(b);switch(c.setDate(c.getDate()+1),a){case"tomorrow_morning":return c.setHours(9,0,0,0),c;case"tomorrow_afternoon":return c.setHours(14,0,0,0),c;case"monday_morning":{let a=new Date(b),c=(8-b.getDay())%7||7;return a.setDate(a.getDate()+c),a.setHours(9,0,0,0),a}default:return c}},aM=(0,T.useCallback)(async a=>{let b=a.target.files;if(!b||0===b.length)return;let c=[];for(let a of Array.from(b)){if(a.size>0xa00000){g.error(`File "${a.name}" is too large (max 10MB)`);continue}try{let b=await new Promise((b,c)=>{let d=new FileReader;d.onload=()=>{let a=d.result.split(",")[1];b(a)},d.onerror=c,d.readAsDataURL(a)});c.push({filename:a.name,content:b,contentType:a.type,size:a.size})}catch{g.error(`Failed to read file "${a.name}"`)}}c.length>0&&$(a=>[...a,...c]),i.current&&(i.current.value="")},[g]),aN=(0,T.useCallback)(a=>{$(b=>b.filter(b=>b.filename!==a))},[]),aO=(0,T.useCallback)(async()=>{ah&&(k||q||s.length>0)&&await aF(),c()},[ah,k,q,s,aF,c]),aP=(0,T.useCallback)(async()=>{if(al)try{await z(al)}catch(a){console.error("Failed to delete draft:",a)}c()},[al,c]);return(0,b.jsx)(D.TooltipProvider,{children:(0,b.jsxs)("div",{className:(0,n.cn)("flex flex-col h-full overflow-hidden bg-card",f),children:[(0,b.jsxs)("div",{className:"flex items-center justify-between px-3 py-2 border-b border-border/50",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("span",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wide",children:"New Message"}),an?(0,b.jsx)("span",{className:"text-[10px] text-muted-foreground/60",children:"· Saving draft..."}):aj?(0,b.jsxs)("span",{className:"text-[10px] text-muted-foreground/60",children:["· Draft saved ",aj.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]}):null]}),(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-muted-foreground hover:text-foreground",onClick:aO,children:(0,b.jsx)(S.X,{className:"h-4 w-4"})})]}),(0,b.jsxs)("div",{className:"px-3 py-2 space-y-2 border-b border-border/50",children:[(0,b.jsxs)("div",{className:"flex items-start gap-2",children:[(0,b.jsx)("span",{className:"text-xs font-medium text-muted-foreground w-12 pt-2",children:"To:"}),(0,b.jsx)(ac,{value:s,onChange:t,placeholder:"Search customers, vendors, or type email...",className:"flex-1"}),(0,b.jsxs)("div",{className:"flex items-center gap-1 pt-1.5",children:[!V&&(0,b.jsx)("button",{type:"button",onClick:()=>W(!0),className:"text-xs text-muted-foreground hover:text-foreground px-1.5 py-0.5 rounded hover:bg-muted transition-colors",children:"Cc"}),!X&&(0,b.jsx)("button",{type:"button",onClick:()=>Y(!0),className:"text-xs text-muted-foreground hover:text-foreground px-1.5 py-0.5 rounded hover:bg-muted transition-colors",children:"Bcc"})]})]}),V&&(0,b.jsxs)("div",{className:"flex items-start gap-2",children:[(0,b.jsx)("span",{className:"text-xs font-medium text-muted-foreground w-12 pt-2",children:"Cc:"}),(0,b.jsx)(ac,{value:u,onChange:v,placeholder:"Add Cc recipients...",className:"flex-1"}),(0,b.jsx)("button",{type:"button",onClick:()=>{W(!1),v([])},className:"text-xs text-muted-foreground hover:text-destructive pt-2",children:"×"})]}),X&&(0,b.jsxs)("div",{className:"flex items-start gap-2",children:[(0,b.jsx)("span",{className:"text-xs font-medium text-muted-foreground w-12 pt-2",children:"Bcc:"}),(0,b.jsx)(ac,{value:w,onChange:U,placeholder:"Add Bcc recipients...",className:"flex-1"}),(0,b.jsx)("button",{type:"button",onClick:()=>{Y(!1),U([])},className:"text-xs text-muted-foreground hover:text-destructive pt-2",children:"×"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("span",{className:"text-xs font-medium text-muted-foreground w-12",children:"Subject:"}),(0,b.jsx)("input",{type:"text",value:q,onChange:a=>r(a.target.value),placeholder:"Subject",className:"flex-1 bg-transparent text-sm outline-none placeholder:text-muted-foreground",autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:"true",name:"email-subject"})]})]}),aE?.id&&(0,b.jsx)("div",{className:"px-3 py-2 border-b border-border/50",children:(0,b.jsx)(ad,{customerId:aE.id})}),(0,b.jsxs)("div",{className:"flex-1 flex flex-col min-h-0 overflow-hidden",children:[(0,b.jsxs)("div",{className:"px-3 py-2 flex-1 overflow-y-auto",children:[(0,b.jsx)("textarea",{ref:h,value:k,onChange:a=>o(a.target.value),onInput:aG,onKeyDown:a=>{"Enter"===a.key&&(a.metaKey||a.ctrlKey)&&(a.preventDefault(),aJ())},placeholder:"Write your message...",className:"w-full resize-none bg-transparent text-sm outline-none placeholder:text-muted-foreground min-h-[80px]",rows:3}),aD.value&&(0,b.jsxs)("div",{className:"mt-2 pt-2 border-t border-dashed border-border/50",children:[(0,b.jsxs)("div",{className:"text-xs text-muted-foreground mb-1 flex items-center justify-between",children:[(0,b.jsx)("span",{children:"Signature"}),(0,b.jsx)("button",{type:"button",onClick:()=>aa("none"),className:"text-[10px] hover:text-foreground transition-colors",children:"Remove"})]}),(0,b.jsx)("div",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:aD.value.trim()})]})]}),Z.length>0&&(0,b.jsx)("div",{className:"px-3 py-2 border-t border-border/50",children:(0,b.jsx)("div",{className:"flex flex-wrap gap-2",children:Z.map(a=>{var c;return(0,b.jsxs)("div",{className:"flex items-center gap-1.5 px-2 py-1 bg-background border rounded-md text-xs",children:[(0,b.jsx)(N.Paperclip,{className:"h-3 w-3 text-muted-foreground"}),(0,b.jsx)("span",{className:"max-w-[120px] truncate",children:a.filename}),(0,b.jsxs)("span",{className:"text-muted-foreground",children:["(",(c=a.size)<1024?`${c} B`:c<1048576?`${(c/1024).toFixed(1)} KB`:`${(c/1048576).toFixed(1)} MB`,")"]}),(0,b.jsx)("button",{type:"button",onClick:()=>aN(a.filename),className:"ml-1 text-muted-foreground hover:text-destructive",children:"×"})]},a.filename)})})})]}),(0,b.jsx)("input",{ref:i,type:"file",multiple:!0,className:"hidden",onChange:aM,accept:"*/*"}),(0,b.jsxs)("div",{className:"flex items-center justify-between gap-1 border-t border-border/50 px-2 py-1.5",children:[(0,b.jsxs)("div",{className:"flex items-center gap-0.5",children:[(0,b.jsxs)(D.Tooltip,{children:[(0,b.jsx)(D.TooltipTrigger,{asChild:!0,children:(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>i.current?.click(),children:(0,b.jsx)(N.Paperclip,{className:"h-4 w-4 text-muted-foreground"})})}),(0,b.jsx)(D.TooltipContent,{side:"top",children:"Attach file"})]}),(0,b.jsxs)(D.Tooltip,{children:[(0,b.jsx)(D.TooltipTrigger,{asChild:!0,children:(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",children:(0,b.jsx)(J.Link,{className:"h-4 w-4 text-muted-foreground"})})}),(0,b.jsx)(D.TooltipContent,{side:"top",children:"Insert link"})]}),(0,b.jsx)("div",{className:"w-px h-4 bg-border mx-1"}),(0,b.jsxs)(B.DropdownMenu,{children:[(0,b.jsx)(B.DropdownMenuTrigger,{asChild:!0,children:(0,b.jsxs)(l.Button,{variant:"ghost",size:"sm",className:"h-7 px-2 gap-1",children:[(0,b.jsx)(F.default,{className:"h-3.5 w-3.5 text-muted-foreground"}),(0,b.jsx)(p.ChevronDown,{className:"h-3 w-3 text-muted-foreground"})]})}),(0,b.jsxs)(B.DropdownMenuContent,{align:"start",className:"w-40",children:[(0,b.jsxs)(B.DropdownMenuItem,{children:[(0,b.jsx)(F.default,{className:"h-4 w-4 mr-2"})," Bold"]}),(0,b.jsxs)(B.DropdownMenuItem,{children:[(0,b.jsx)(I.default,{className:"h-4 w-4 mr-2"})," Italic"]}),(0,b.jsxs)(B.DropdownMenuItem,{children:[(0,b.jsx)(R.default,{className:"h-4 w-4 mr-2"})," Underline"]}),(0,b.jsx)(B.DropdownMenuSeparator,{}),(0,b.jsxs)(B.DropdownMenuItem,{children:[(0,b.jsx)(K.List,{className:"h-4 w-4 mr-2"})," Bullet list"]}),(0,b.jsxs)(B.DropdownMenuItem,{children:[(0,b.jsx)(L.default,{className:"h-4 w-4 mr-2"})," Numbered list"]})]})]}),(0,b.jsxs)(B.DropdownMenu,{children:[(0,b.jsx)(B.DropdownMenuTrigger,{asChild:!0,children:(0,b.jsxs)(l.Button,{variant:"ghost",size:"sm",className:"h-7 px-2 gap-1",children:[(0,b.jsx)(P.Sparkles,{className:"h-3.5 w-3.5 text-muted-foreground"}),(0,b.jsx)("span",{className:"text-xs text-muted-foreground hidden sm:inline",children:"Templates"})]})}),(0,b.jsxs)(B.DropdownMenuContent,{align:"start",className:"w-48",children:[ae.map(a=>(0,b.jsx)(B.DropdownMenuItem,{onClick:()=>{var b;let c;return b=a.id,void((c=ae.find(a=>a.id===b))&&o(c.body))},children:a.label},a.id)),(0,b.jsx)(B.DropdownMenuSeparator,{}),(0,b.jsxs)(B.DropdownMenuItem,{className:"text-muted-foreground text-xs",children:["Signature: ",aD.label]}),af.map(a=>(0,b.jsx)(B.DropdownMenuItem,{onClick:()=>aa(a.id),className:(0,n.cn)("pl-6",_===a.id&&"font-medium text-primary"),children:a.label},a.id))]})]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-1",children:[(0,b.jsxs)(D.Tooltip,{children:[(0,b.jsx)(D.TooltipTrigger,{asChild:!0,children:(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-muted-foreground hover:text-destructive",onClick:aP,children:(0,b.jsx)(Q.Trash2,{className:"h-4 w-4"})})}),(0,b.jsx)(D.TooltipContent,{side:"top",children:"Discard"})]}),av?(0,b.jsx)(l.Button,{size:"sm",className:"h-7 px-3 gap-1.5 rounded-full bg-amber-500 hover:bg-amber-600",onClick:aH,children:(0,b.jsxs)("span",{className:"text-xs font-medium",children:["Undo (",ax,"s)"]})}):(0,b.jsxs)("div",{className:"flex items-center",children:[(0,b.jsxs)(l.Button,{size:"sm",className:"h-7 px-3 gap-1.5 rounded-l-full rounded-r-none",onClick:aJ,disabled:ab||!k.trim()||0===s.length,children:[ab?(0,b.jsx)(M.Loader2,{className:"h-3.5 w-3.5 animate-spin"}):(0,b.jsx)(O.Send,{className:"h-3.5 w-3.5"}),(0,b.jsx)("span",{className:"text-xs font-medium",children:"Send"})]}),(0,b.jsxs)(m.Popover,{open:ap,onOpenChange:aq,children:[(0,b.jsx)(m.PopoverTrigger,{asChild:!0,children:(0,b.jsx)(l.Button,{size:"sm",className:"h-7 px-1.5 rounded-l-none rounded-r-full border-l border-primary-foreground/20",disabled:ab||!k.trim()||0===s.length,children:(0,b.jsx)(p.ChevronDown,{className:"h-3.5 w-3.5"})})}),(0,b.jsx)(m.PopoverContent,{className:"w-72 p-2",align:"end",children:(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)("p",{className:"text-xs font-medium text-muted-foreground px-2 py-1",children:"Schedule send"}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsxs)(l.Button,{variant:"ghost",size:"sm",className:"w-full justify-start h-8 text-xs",onClick:()=>aK(aL("tomorrow_morning")),children:[(0,b.jsx)(H.Clock,{className:"h-3.5 w-3.5 mr-2"}),"Tomorrow morning (9:00 AM)"]}),(0,b.jsxs)(l.Button,{variant:"ghost",size:"sm",className:"w-full justify-start h-8 text-xs",onClick:()=>aK(aL("tomorrow_afternoon")),children:[(0,b.jsx)(H.Clock,{className:"h-3.5 w-3.5 mr-2"}),"Tomorrow afternoon (2:00 PM)"]}),(0,b.jsxs)(l.Button,{variant:"ghost",size:"sm",className:"w-full justify-start h-8 text-xs",onClick:()=>aK(aL("monday_morning")),children:[(0,b.jsx)(G.Calendar,{className:"h-3.5 w-3.5 mr-2"}),"Monday morning (9:00 AM)"]})]}),(0,b.jsxs)("div",{className:"border-t border-border pt-2",children:[(0,b.jsx)("p",{className:"text-xs font-medium text-muted-foreground px-2 py-1",children:"Pick date & time"}),(0,b.jsxs)("div",{className:"flex gap-2 px-2",children:[(0,b.jsx)("div",{className:"flex-1",children:(0,b.jsx)(C.Input,{type:"date",value:ar,onChange:a=>as(a.target.value),min:new Date().toISOString().split("T")[0],className:"h-8 text-xs"})}),(0,b.jsx)("div",{className:"flex-1",children:(0,b.jsx)(C.Input,{type:"time",value:at,onChange:a=>au(a.target.value),className:"h-8 text-xs"})})]}),(0,b.jsxs)(l.Button,{size:"sm",className:"w-full mt-2 h-8 text-xs",onClick:()=>{ar&&at?aK(new Date(`${ar}T${at}`)):g.error("Please select both date and time")},disabled:!ar||!at,children:[(0,b.jsx)(H.Clock,{className:"h-3.5 w-3.5 mr-2"}),"Schedule"]})]})]})})]})]})]})]}),(0,b.jsx)("div",{className:"px-3 pb-1.5 text-[10px] text-muted-foreground/60 text-right",children:"⌘ + Enter to send"})]})})}a.i(458393);var ah=a.i(82012),F=F,ai=a.i(990782),aj=a.i(642599),I=I,L=L,ak=a.i(94436),R=R;let al=a=>{let b=a.match(/<([^>]+)>/);return b&&b[1]?b[1].trim():(a.includes("@")&&a.length,a.trim())};function am(a,b,c){if("string"==typeof a&&a.length>0){let b=al(a);if(b.length>1&&b.includes("@"))return b}if(Array.isArray(a)&&a.length>0){let b=a[0];if("string"==typeof b&&b.length>0){let a=al(b);if(a.length>1&&a.includes("@"))return a}if(b&&"object"==typeof b&&"email"in b){let a=b.email;if(a&&"string"==typeof a&&a.length>0)return al(a)}}if(a&&"object"==typeof a&&!Array.isArray(a)&&"email"in a&&"string"==typeof a.email&&a.email.length>0)return al(a.email);let d=function(a,b){if(!a||!b)return null;let c=a[b];if(!c)return null;if("string"==typeof c&&c.includes("@"))return al(c);if("object"==typeof c){let a=c.data;if(a&&b&&a[b])return al(a[b])}return null}(b,c);return d||"Unknown"}function an(a){if(!a)return[];if(Array.isArray(a))return a.map(a=>"string"==typeof a?a.trim():"").filter(Boolean);if("string"==typeof a){let b=a.trim();if(!b)return[];if(b.startsWith("[")&&b.endsWith("]"))try{let a=JSON.parse(b);if(Array.isArray(a))return a.map(a=>"string"==typeof a?a.trim():"").filter(Boolean)}catch(a){}return b.split(/[;,]+/).map(a=>a.trim()).filter(Boolean)}return[]}let ao=[{id:"follow-up",label:"Friendly follow-up",body:"Hi there,\n\nJust checking in — let me know if you have any questions or if you'd like to see anything else from my side.\n\nBest,"},{id:"thank-you",label:"Thank you note",body:"Hi there,\n\nThanks again for your patience while we sorted this out. Let me know if there's anything else I can help with.\n\nWarm regards,"},{id:"next-steps",label:"Outline next steps",body:"Hi there,\n\nI've outlined the next steps:\n1. Review the details above.\n2. Confirm when you'd like to move forward.\n3. I'll lock everything in once you reply.\n\nLet me know if you want to adjust anything."}],ap=[{id:"none",label:"No signature",value:""},{id:"support",label:"Thorbis Support",value:"\n\nThanks,\nThorbis Support Team"},{id:"tech",label:"Technical Lead",value:"\n\nBest regards,\nJordan – Technical Lead"}];function aq({mode:a,selectedEmail:c,companyId:d,onClose:e,onSent:f,className:g}){let{toast:h}=(0,E.useToast)(),i=(0,T.useRef)(null),j=(0,T.useRef)(null),[k,o]=(0,T.useState)(""),[q,r]=(0,T.useState)(!1),[s,t]=(0,T.useState)(!1),[u,v]=(0,T.useState)("support"),[w,y]=(0,T.useState)(!1),[z,A]=(0,T.useState)([]),[S,U]=(0,T.useState)([]),[V,W]=(0,T.useState)([]),[X,Y]=(0,T.useState)(!1),[Z,$]=(0,T.useState)(!1),[_,aa]=(0,T.useState)(""),[ab,ad]=(0,T.useState)([]),[ae,af]=(0,T.useState)(!1),[ag,al]=(0,T.useState)(""),[aq,ar]=(0,T.useState)(""),[as,at]=(0,T.useState)(!1),[au,av]=(0,T.useState)(5),aw=(0,T.useRef)(null),ax=(0,T.useRef)(null),ay=(0,T.useRef)(null),az=(0,T.useMemo)(()=>ap.find(a=>a.id===u)??ap[0],[u]),aA=(0,T.useMemo)(()=>{if(!c)return[];let a=[],b=new Set,d=(c,d,e="custom")=>{let f=c.toLowerCase();c&&"Unknown"!==c&&!b.has(f)&&(b.add(f),a.push({id:`thread-${c}`,type:e,name:d||c,email:c}))},e=am(c.from_address,c.provider_metadata,"from");return d(e,c.customer?.display_name||c.from_name||e,c.customer_id?"customer":"custom"),an(c.to_address).forEach(a=>d(a)),c.cc_address&&an(c.cc_address).forEach(a=>d(a)),a},[c]);(0,T.useEffect)(()=>{if(!c)return;let b=c.subject?.trim()||"No subject",d="forward"===a?"Fwd:":"Re:";aa(b.toLowerCase().startsWith(d.toLowerCase())?b:`${d} ${b}`);let e=am(c.from_address,c.provider_metadata,"from"),f=an(c.to_address),g=new Map,h=(a,b,c="custom")=>{a&&"Unknown"!==a&&!g.has(a.toLowerCase())&&g.set(a.toLowerCase(),{id:`initial-${a}`,type:c,name:b||a,email:a})};"reply"===a?h(e,c.customer?.display_name||c.from_name||e,c.customer_id?"customer":"custom"):"reply-all"===a&&(h(e,c.customer?.display_name||c.from_name||e,c.customer_id?"customer":"custom"),f.forEach(a=>h(a)),c.cc_address&&an(c.cc_address).forEach(a=>h(a))),A(Array.from(g.values()))},[a,c]);let aB=(0,T.useCallback)(()=>{let a=i.current;a&&(a.style.height="auto",a.style.height=`${Math.min(a.scrollHeight,200)}px`)},[]);(0,T.useEffect)(()=>{aB()},[k,aB]),(0,T.useEffect)(()=>{setTimeout(()=>i.current?.focus(),100)},[]);let aC=(0,T.useCallback)(async()=>{let a=ay.current;if(a){t(!0),at(!1);try{let b=await (0,x.sendCustomerEmailAction)(a);b.success?(h.success("Email sent successfully"),f?.(b.data??{}),e()):h.error(b.error||"Failed to send")}catch(a){console.error("Send failed:",a),h.error(a instanceof Error?a.message:"Failed to send")}finally{t(!1),ay.current=null}}},[h,f,e]),aD=(0,T.useCallback)(()=>{aw.current&&(clearTimeout(aw.current),aw.current=null),ax.current&&(clearInterval(ax.current),ax.current=null),at(!1),av(5),ay.current=null,h.success("Email cancelled - not sent")},[h]);(0,T.useEffect)(()=>()=>{aw.current&&clearTimeout(aw.current),ax.current&&clearInterval(ax.current)},[]);let aE=a=>{let b,c=new Date;switch(a){case"tomorrow_morning":(b=new Date(c)).setDate(b.getDate()+1),b.setHours(8,0,0,0);break;case"tomorrow_afternoon":(b=new Date(c)).setDate(b.getDate()+1),b.setHours(13,0,0,0);break;case"monday_morning":let d=(b=new Date(c)).getDay();b.setDate(b.getDate()+(0===d?1:8-d)),b.setHours(8,0,0,0)}return b},aF=async a=>{if(!c||!d)return void h.error("Unable to schedule - missing context");let b=z.map(a=>a.email).filter(Boolean);if(0===b.length)return void h.error("Add at least one recipient");if(!k.trim())return void h.error("Please write a message");if(a<=new Date)return void h.error("Schedule time must be in the future");let g=k+(az?.value||""),i=z.find(a=>"customer"===a.type),j=S.map(a=>a.email).filter(Boolean),l=V.map(a=>a.email).filter(Boolean);t(!0);try{let k=await (0,x.sendCustomerEmailAction)({to:b,subject:_,body:g,customerName:i?.name||c.customer?.display_name||c.customer?.first_name||c.from_name||c.from_address||"Customer",companyId:d,customerId:c.customer_id??void 0,cc:j.length>0?j:void 0,bcc:l.length>0?l:void 0,attachments:ab.length>0?ab.map(a=>({filename:a.filename,content:a.content,contentType:a.contentType})):void 0,scheduledFor:a.toISOString()});if(k.success){let b=a.toLocaleString("en-US",{weekday:"short",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"});h.success(`Email scheduled for ${b}`),f?.(k.data??{}),e()}else h.error(k.error||"Failed to schedule email")}catch(a){console.error("Schedule failed:",a),h.error(a instanceof Error?a.message:"Failed to schedule")}finally{t(!1),af(!1)}},aG=async()=>{if(!c||!d)return void h.error("Unable to send - missing context");let a=z.map(a=>a.email).filter(Boolean);if(0===a.length)return void h.error("Add at least one recipient");if(!k.trim())return void h.error("Please write a message");let e=k+(az?.value||""),f=z.find(a=>"customer"===a.type),g=S.map(a=>a.email).filter(Boolean),i=V.map(a=>a.email).filter(Boolean);ay.current={to:a,subject:_,body:e,customerName:f?.name||c.customer?.display_name||c.customer?.first_name||c.from_name||c.from_address||"Customer",companyId:d,customerId:c.customer_id??void 0,cc:g.length>0?g:void 0,bcc:i.length>0?i:void 0,attachments:ab.length>0?ab.map(a=>({filename:a.filename,content:a.content,contentType:a.contentType})):void 0},at(!0),av(5),h.info((0,b.jsxs)("div",{className:"flex items-center justify-between gap-4 w-full",children:[(0,b.jsxs)("span",{children:["Sending email in ",5,"s..."]}),(0,b.jsx)("button",{className:"text-sm font-medium text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",onClick:()=>aD(),children:"Undo"})]}),{duration:5500});let j=5;ax.current=setInterval(()=>{av(--j),j<=0&&ax.current&&(clearInterval(ax.current),ax.current=null)},1e3),aw.current=setTimeout(()=>{ax.current&&(clearInterval(ax.current),ax.current=null),aC()},5e3)},aH=(0,T.useCallback)(async a=>{let b=a.target.files;if(!b||0===b.length)return;let c=[];for(let a of Array.from(b)){if(a.size>0xa00000){h.error(`File "${a.name}" is too large (max 10MB)`);continue}try{let b=await new Promise((b,c)=>{let d=new FileReader;d.onload=()=>{let a=d.result.split(",")[1];b(a)},d.onerror=c,d.readAsDataURL(a)});c.push({filename:a.name,content:b,contentType:a.type,size:a.size})}catch(b){h.error(`Failed to read file "${a.name}"`)}}c.length>0&&ad(a=>[...a,...c]),j.current&&(j.current.value="")},[h]),aI=(0,T.useCallback)(a=>{ad(b=>b.filter(b=>b.filename!==a))},[]),aJ=(0,T.useMemo)(()=>{if(!c)return"";let a=c.customer?.display_name||c.from_name||c.from_address||"Unknown",b=new Date(c.created_at).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"});return`On ${b}, ${a} wrote:
${c.body||""}`},[c]),aK=(0,T.useMemo)(()=>{if(!c?.body&&!c?.subject)return[];let a=`${c.subject||""} ${c.body||""}`.toLowerCase(),b=[];return(a.includes("?")||a.includes("when")||a.includes("can you"))&&((a.includes("schedule")||a.includes("appointment")||a.includes("when"))&&(b.push("Yes, I can schedule that. What time works best for you?"),b.push("Let me check our availability and get back to you shortly.")),(a.includes("price")||a.includes("cost")||a.includes("quote"))&&(b.push("I'll prepare a quote for you and send it over shortly."),b.push("The pricing depends on a few factors. Could you provide more details?")),(a.includes("available")||a.includes("free"))&&(b.push("Yes, I'm available. When would you like to meet?"),b.push("Let me check my schedule and get back to you."))),(a.includes("thank")||a.includes("thanks")||a.includes("appreciate"))&&(b.push("You're welcome! Let me know if you need anything else."),b.push("Happy to help! Don't hesitate to reach out.")),(a.includes("confirm")||a.includes("let me know"))&&(b.push("Confirmed! I'll proceed as discussed."),b.push("Got it, thanks for confirming.")),(a.includes("urgent")||a.includes("asap")||a.includes("emergency"))&&(b.push("I understand the urgency. I'm on it right now."),b.push("I'll prioritize this and get back to you shortly.")),(a.includes("invoice")||a.includes("payment")||a.includes("bill"))&&(b.push("I'll send the invoice right away."),b.push("Thank you for the payment confirmation.")),0===b.length&&(b.push("Thanks for reaching out. I'll get back to you shortly."),b.push("Got it, thanks for the update."),b.push("I'll look into this and follow up.")),b.slice(0,3)},[c]);return c?(0,b.jsx)(D.TooltipProvider,{children:(0,b.jsxs)("div",{className:(0,n.cn)("w-full overflow-hidden rounded-xl border border-border bg-background shadow-sm transition-all duration-200","focus-within:border-primary/50 focus-within:shadow-md",g),children:[(0,b.jsxs)("button",{type:"button",onClick:()=>r(!q),className:"flex w-full items-center justify-between gap-2 px-3 py-2 text-left hover:bg-muted/50 transition-colors",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[(0,b.jsx)("span",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wide shrink-0",children:"forward"===a?"Forward":"Reply"}),(0,b.jsx)("span",{className:"text-sm text-foreground truncate",children:z.length>0?z.map(a=>a.name).join(", "):"Add recipients..."})]}),q?(0,b.jsx)(ai.ChevronUp,{className:"h-4 w-4 text-muted-foreground shrink-0"}):(0,b.jsx)(p.ChevronDown,{className:"h-4 w-4 text-muted-foreground shrink-0"})]}),q&&(0,b.jsxs)("div",{className:"border-t border-border/50 px-3 py-2 space-y-2 bg-muted/30",children:[(0,b.jsxs)("div",{className:"flex items-start gap-2",children:[(0,b.jsx)("span",{className:"text-xs font-medium text-muted-foreground w-12 pt-2",children:"To:"}),(0,b.jsx)(ac,{value:z,onChange:A,placeholder:"Search customers, vendors, or type email...",recentRecipients:aA,className:"flex-1"}),(0,b.jsxs)("div",{className:"flex items-center gap-1 pt-1.5",children:[!X&&(0,b.jsx)("button",{type:"button",onClick:()=>Y(!0),className:"text-xs text-muted-foreground hover:text-foreground px-1.5 py-0.5 rounded hover:bg-muted transition-colors",children:"Cc"}),!Z&&(0,b.jsx)("button",{type:"button",onClick:()=>$(!0),className:"text-xs text-muted-foreground hover:text-foreground px-1.5 py-0.5 rounded hover:bg-muted transition-colors",children:"Bcc"})]})]}),X&&(0,b.jsxs)("div",{className:"flex items-start gap-2",children:[(0,b.jsx)("span",{className:"text-xs font-medium text-muted-foreground w-12 pt-2",children:"Cc:"}),(0,b.jsx)(ac,{value:S,onChange:U,placeholder:"Add Cc recipients...",recentRecipients:aA,className:"flex-1"}),(0,b.jsx)("button",{type:"button",onClick:()=>{Y(!1),U([])},className:"text-xs text-muted-foreground hover:text-destructive pt-2",children:"×"})]}),Z&&(0,b.jsxs)("div",{className:"flex items-start gap-2",children:[(0,b.jsx)("span",{className:"text-xs font-medium text-muted-foreground w-12 pt-2",children:"Bcc:"}),(0,b.jsx)(ac,{value:V,onChange:W,placeholder:"Add Bcc recipients...",recentRecipients:aA,className:"flex-1"}),(0,b.jsx)("button",{type:"button",onClick:()=>{$(!1),W([])},className:"text-xs text-muted-foreground hover:text-destructive pt-2",children:"×"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("span",{className:"text-xs font-medium text-muted-foreground w-12",children:"Subject:"}),(0,b.jsx)("input",{type:"text",value:_,onChange:a=>aa(a.target.value),placeholder:"Subject",className:"flex-1 bg-transparent text-base md:text-sm outline-none placeholder:text-muted-foreground"})]})]}),aK.length>0&&!k&&(0,b.jsx)("div",{className:"px-3 py-2 border-b border-border/50",children:(0,b.jsxs)("div",{className:"flex items-center gap-1.5 flex-wrap",children:[(0,b.jsx)(P.Sparkles,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),aK.map((a,c)=>(0,b.jsx)("button",{type:"button",onClick:()=>{o(a),i.current?.focus()},className:"text-xs px-2.5 py-1 rounded-full border border-border bg-muted/50 hover:bg-muted hover:border-primary/50 transition-colors truncate max-w-[200px]",title:a,children:a.length>40?`${a.slice(0,40)}...`:a},c))]})}),(0,b.jsxs)("div",{className:"px-3 py-2",children:[(0,b.jsx)("textarea",{ref:i,value:k,onChange:a=>o(a.target.value),onInput:aB,onKeyDown:a=>{"Enter"===a.key&&(a.metaKey||a.ctrlKey)&&(a.preventDefault(),aG())},placeholder:"Write your reply...",className:(0,n.cn)("w-full resize-none bg-transparent outline-none","text-base md:text-sm","placeholder:text-muted-foreground","min-h-[80px] max-h-[200px]"),rows:3}),az.value&&(0,b.jsxs)("div",{className:"mt-2 pt-2 border-t border-dashed border-border/50",children:[(0,b.jsxs)("div",{className:"text-xs text-muted-foreground mb-1 flex items-center justify-between",children:[(0,b.jsx)("span",{children:"Signature"}),(0,b.jsx)("button",{type:"button",onClick:()=>v("none"),className:"text-[10px] hover:text-foreground transition-colors",children:"Remove"})]}),(0,b.jsx)("div",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:az.value.trim()})]})]}),c.body&&(0,b.jsxs)("div",{className:"px-3 pb-2",children:[(0,b.jsxs)("button",{type:"button",onClick:()=>y(!w),className:"text-xs text-muted-foreground hover:text-foreground flex items-center gap-1",children:[(0,b.jsx)(ak.MoreHorizontal,{className:"h-3 w-3"}),w?"Hide":"Show"," quoted text"]}),w&&(0,b.jsx)("div",{className:"mt-2 pl-3 border-l-2 border-muted text-xs text-muted-foreground whitespace-pre-wrap max-h-[100px] overflow-y-auto",children:aJ})]}),ab.length>0&&(0,b.jsx)("div",{className:"px-3 py-2 border-t border-border/50 bg-muted/20",children:(0,b.jsx)("div",{className:"flex flex-wrap gap-2",children:ab.map(a=>{var c;return(0,b.jsxs)("div",{className:"flex items-center gap-1.5 px-2 py-1 bg-background border rounded-md text-xs",children:[(0,b.jsx)(N.Paperclip,{className:"h-3 w-3 text-muted-foreground"}),(0,b.jsx)("span",{className:"max-w-[120px] truncate",children:a.filename}),(0,b.jsxs)("span",{className:"text-muted-foreground",children:["(",(c=a.size)<1024?`${c} B`:c<1048576?`${(c/1024).toFixed(1)} KB`:`${(c/1048576).toFixed(1)} MB`,")"]}),(0,b.jsx)("button",{type:"button",onClick:()=>aI(a.filename),className:"ml-1 text-muted-foreground hover:text-destructive",children:"×"})]},a.filename)})})}),(0,b.jsx)("input",{ref:j,type:"file",multiple:!0,className:"hidden",onChange:aH,accept:"*/*"}),(0,b.jsxs)("div",{className:"flex items-center justify-between gap-1 border-t border-border/50 px-2 py-1.5 bg-muted/30",children:[(0,b.jsxs)("div",{className:"flex items-center gap-0.5",children:[(0,b.jsxs)(D.Tooltip,{children:[(0,b.jsx)(D.TooltipTrigger,{asChild:!0,children:(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>j.current?.click(),children:(0,b.jsx)(N.Paperclip,{className:"h-4 w-4 text-muted-foreground"})})}),(0,b.jsx)(D.TooltipContent,{side:"top",children:"Attach file"})]}),(0,b.jsxs)(D.Tooltip,{children:[(0,b.jsx)(D.TooltipTrigger,{asChild:!0,children:(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",children:(0,b.jsx)(aj.ImageIcon,{className:"h-4 w-4 text-muted-foreground"})})}),(0,b.jsx)(D.TooltipContent,{side:"top",children:"Insert image"})]}),(0,b.jsxs)(D.Tooltip,{children:[(0,b.jsx)(D.TooltipTrigger,{asChild:!0,children:(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",children:(0,b.jsx)(J.Link,{className:"h-4 w-4 text-muted-foreground"})})}),(0,b.jsx)(D.TooltipContent,{side:"top",children:"Insert link"})]}),(0,b.jsx)("div",{className:"w-px h-4 bg-border mx-1"}),(0,b.jsxs)(B.DropdownMenu,{children:[(0,b.jsx)(B.DropdownMenuTrigger,{asChild:!0,children:(0,b.jsxs)(l.Button,{variant:"ghost",size:"sm",className:"h-7 px-2 gap-1",children:[(0,b.jsx)(F.default,{className:"h-3.5 w-3.5 text-muted-foreground"}),(0,b.jsx)(p.ChevronDown,{className:"h-3 w-3 text-muted-foreground"})]})}),(0,b.jsxs)(B.DropdownMenuContent,{align:"start",className:"w-40",children:[(0,b.jsxs)(B.DropdownMenuItem,{children:[(0,b.jsx)(F.default,{className:"h-4 w-4 mr-2"})," Bold"]}),(0,b.jsxs)(B.DropdownMenuItem,{children:[(0,b.jsx)(I.default,{className:"h-4 w-4 mr-2"})," Italic"]}),(0,b.jsxs)(B.DropdownMenuItem,{children:[(0,b.jsx)(R.default,{className:"h-4 w-4 mr-2"})," Underline"]}),(0,b.jsx)(B.DropdownMenuSeparator,{}),(0,b.jsxs)(B.DropdownMenuItem,{children:[(0,b.jsx)(K.List,{className:"h-4 w-4 mr-2"})," Bullet list"]}),(0,b.jsxs)(B.DropdownMenuItem,{children:[(0,b.jsx)(L.default,{className:"h-4 w-4 mr-2"})," Numbered list"]})]})]}),(0,b.jsxs)(B.DropdownMenu,{children:[(0,b.jsx)(B.DropdownMenuTrigger,{asChild:!0,children:(0,b.jsxs)(l.Button,{variant:"ghost",size:"sm",className:"h-7 px-2 gap-1",children:[(0,b.jsx)(P.Sparkles,{className:"h-3.5 w-3.5 text-muted-foreground"}),(0,b.jsx)("span",{className:"text-xs text-muted-foreground hidden sm:inline",children:"Templates"})]})}),(0,b.jsxs)(B.DropdownMenuContent,{align:"start",className:"w-48",children:[ao.map(a=>(0,b.jsx)(B.DropdownMenuItem,{onClick:()=>{var b;let c;return b=a.id,void((c=ao.find(a=>a.id===b))&&o(c.body))},children:a.label},a.id)),(0,b.jsx)(B.DropdownMenuSeparator,{}),(0,b.jsxs)(B.DropdownMenuItem,{className:"text-muted-foreground text-xs",children:["Signature: ",az.label]}),ap.map(a=>(0,b.jsx)(B.DropdownMenuItem,{onClick:()=>v(a.id),className:(0,n.cn)("pl-6",u===a.id&&"font-medium text-primary"),children:a.label},a.id))]})]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-1",children:[(0,b.jsxs)(D.Tooltip,{children:[(0,b.jsx)(D.TooltipTrigger,{asChild:!0,children:(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-muted-foreground hover:text-destructive",onClick:e,children:(0,b.jsx)(Q.Trash2,{className:"h-4 w-4"})})}),(0,b.jsx)(D.TooltipContent,{side:"top",children:"Discard"})]}),as?(0,b.jsx)(l.Button,{size:"sm",className:"h-7 px-3 gap-1.5 rounded-full bg-amber-500 hover:bg-amber-600",onClick:aD,children:(0,b.jsxs)("span",{className:"text-xs font-medium",children:["Undo (",au,"s)"]})}):(0,b.jsxs)("div",{className:"flex items-center",children:[(0,b.jsxs)(l.Button,{size:"sm",className:"h-7 px-3 gap-1.5 rounded-l-full rounded-r-none",onClick:aG,disabled:s||!k.trim(),children:[s?(0,b.jsx)(M.Loader2,{className:"h-3.5 w-3.5 animate-spin"}):(0,b.jsx)(O.Send,{className:"h-3.5 w-3.5"}),(0,b.jsx)("span",{className:"text-xs font-medium",children:"Send"})]}),(0,b.jsxs)(m.Popover,{open:ae,onOpenChange:af,children:[(0,b.jsx)(m.PopoverTrigger,{asChild:!0,children:(0,b.jsx)(l.Button,{size:"sm",className:"h-7 px-1.5 rounded-l-none rounded-r-full border-l border-primary-foreground/20",disabled:s||!k.trim(),children:(0,b.jsx)(p.ChevronDown,{className:"h-3.5 w-3.5"})})}),(0,b.jsx)(m.PopoverContent,{className:"w-72 p-2",align:"end",children:(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)("p",{className:"text-xs font-medium text-muted-foreground px-2 py-1",children:"Schedule send"}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsxs)(l.Button,{variant:"ghost",size:"sm",className:"w-full justify-start h-8 text-xs",onClick:()=>aF(aE("tomorrow_morning")),children:[(0,b.jsx)(H.Clock,{className:"h-3.5 w-3.5 mr-2"}),"Tomorrow morning (8:00 AM)"]}),(0,b.jsxs)(l.Button,{variant:"ghost",size:"sm",className:"w-full justify-start h-8 text-xs",onClick:()=>aF(aE("tomorrow_afternoon")),children:[(0,b.jsx)(H.Clock,{className:"h-3.5 w-3.5 mr-2"}),"Tomorrow afternoon (1:00 PM)"]}),(0,b.jsxs)(l.Button,{variant:"ghost",size:"sm",className:"w-full justify-start h-8 text-xs",onClick:()=>aF(aE("monday_morning")),children:[(0,b.jsx)(G.Calendar,{className:"h-3.5 w-3.5 mr-2"}),"Monday morning (8:00 AM)"]})]}),(0,b.jsxs)("div",{className:"border-t border-border pt-2",children:[(0,b.jsx)("p",{className:"text-xs font-medium text-muted-foreground px-2 py-1",children:"Pick date & time"}),(0,b.jsxs)("div",{className:"flex gap-2 px-2",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)(ah.Label,{htmlFor:"schedule-date",className:"sr-only",children:"Date"}),(0,b.jsx)(C.Input,{id:"schedule-date",type:"date",value:ag,onChange:a=>al(a.target.value),min:new Date().toISOString().split("T")[0],className:"h-8 text-xs"})]}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)(ah.Label,{htmlFor:"schedule-time",className:"sr-only",children:"Time"}),(0,b.jsx)(C.Input,{id:"schedule-time",type:"time",value:aq,onChange:a=>ar(a.target.value),className:"h-8 text-xs"})]})]}),(0,b.jsxs)(l.Button,{size:"sm",className:"w-full mt-2 h-8 text-xs",onClick:()=>{ag&&aq?aF(new Date(`${ag}T${aq}`)):h.error("Please select both date and time")},disabled:!ag||!aq,children:[(0,b.jsx)(H.Clock,{className:"h-3.5 w-3.5 mr-2"}),"Schedule"]})]})]})})]})]})]})]}),(0,b.jsx)("div",{className:"px-3 pb-1.5 text-[10px] text-muted-foreground/60 text-right",children:"⌘ + Enter to send"})]})}):null}var ar=a.i(916680),as=a.i(452168),at=a.i(805034),au=a.i(541087),av=a.i(187056),aw=a.i(854729),ax=a.i(558520),ay=a.i(190121),az=a.i(579741),az=az,aA=a.i(744789),aB=a.i(530762),aC=a.i(246840),aD=a.i(521995),aE=a.i(27878),aF=a.i(171768),aG=a.i(334044);a.i(799390);var aH=a.i(985943);a.i(400355);var aI=a.i(694340);a.i(897346);var aJ=a.i(75892),aK=a.i(337241),aL=a.i(127487),aM=a.i(692569),aN=a.i(287580);function aO({initialEmails:a,initialInboxType:d,initialFolder:m,initialCategory:p,initialEmailId:q,companyId:r}){let s=(0,aK.useRouter)(),x=(0,aK.useSearchParams)(),y=(0,aK.useParams)(),z=x?.get("inbox")||d,E=x?.get("folder")||m,F=x?.get("category")||p,G=y?.id,H=x?.get("id"),I=G||H||q,[J,K]=(0,T.useTransition)(),[L,N]=(0,T.useState)(a),[P,R]=(0,T.useState)(!1),[U,V]=(0,T.useState)(null),[Z,_]=(0,T.useState)(()=>q&&a.emails&&a.emails.find(a=>a.id===q)||null),[aa,ab]=(0,T.useState)(()=>Z?{html:Z.body_html||null,text:Z.body||null}:null),[ac,ad]=(0,T.useState)(!1),[ae,af]=(0,T.useState)(""),[ah,ai]=(0,T.useState)(""),aj=(0,T.useRef)(null),al=(0,T.useRef)(Z),{toggleSidebar:am}=(0,aL.useSidebar)(),[an,ao]=(0,T.useState)(null),[ap,aO]=(0,T.useState)(!1),[aP,aQ]=(0,T.useState)(!1),[aR,aS]=(0,T.useState)(""),[aT,aU]=(0,T.useState)(!1),[aV,aW]=(0,T.useState)(!1),aX=(0,aM.useRoleStore)(a=>a.role),aY=aX===aN.USER_ROLES.OWNER||aX===aN.USER_ROLES.ADMIN;(0,T.useEffect)(()=>{if(x?.get("compose")==="true"&&!ap){aO(!0),_(null),ab(null),al.current=null;let a=new URLSearchParams(x?.toString()||"");a.delete("compose"),a.delete("to"),a.delete("name"),a.delete("customerId");let b=a.toString()?`/dashboard/communication/email?${a.toString()}`:"/dashboard/communication/email";s.replace(b)}},[x,s,ap]),(0,T.useEffect)(()=>{let a=a=>{let b=a.target;"INPUT"!==b.tagName&&"TEXTAREA"!==b.tagName&&!b.isContentEditable&&("c"!==a.key||a.metaKey||a.ctrlKey||a.altKey||ap||(a.preventDefault(),aO(!0),_(null),ab(null),al.current=null))};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[ap]);let aZ=(0,T.useCallback)(async(a=!1)=>{R(!0),V(null),K(async()=>{try{let a=await (0,g.getEmailsAction)({limit:50,offset:0,type:"all",inboxType:z,folder:"personal"===z?E:void 0,category:"company"===z?F:void 0,search:ae||void 0,sortBy:"created_at",sortOrder:"desc"}),b=a.emails.map(a=>{let b=a.to_address;if("string"==typeof a.to_address){let c=a.to_address.trim();if(c.startsWith("[")&&c.endsWith("]"))try{let c=JSON.parse(a.to_address);Array.isArray(c)&&c.length>0&&(b=c[0])}catch{}}return{...a,to_address:b}});N({...a,emails:b});let c=al.current;if(c){let b=a.emails.find(a=>a.id===c.id);b?(_(b),al.current=b):(_(null),al.current=null,ab(null))}}catch(b){console.error("Failed to fetch emails:",b);let a=b instanceof Error?b.message:"Failed to load emails";V(a),A.toast.error("Failed to load emails",{description:a})}finally{R(!1)}})},[ae,E,z,F]);(0,T.useEffect)(()=>{ae&&aZ()},[ae]);let a$=(0,T.useRef)(P);a$.current=P,(0,T.useEffect)(()=>{let a=setInterval(()=>{ap||a$.current||aZ()},3e4),b=()=>{aZ()};return window.addEventListener("email-received",b),window.addEventListener("email-sent",b),()=>{clearInterval(a),window.removeEventListener("email-received",b),window.removeEventListener("email-sent",b)}},[aZ,ap]);let a_=(0,T.useRef)(E),a0=(0,T.useRef)(z),a1=(0,T.useRef)(F);(0,T.useEffect)(()=>{let a=E!==a_.current,b=z!==a0.current,c=F!==a1.current;(a||b||c)&&(a_.current=E,a0.current=z,a1.current=F,aZ())},[E,z,F,aZ]),(0,T.useEffect)(()=>(aj.current&&clearTimeout(aj.current),aj.current=setTimeout(()=>{af(ah)},300),()=>{aj.current&&clearTimeout(aj.current)}),[ah]);let a2=(0,T.useCallback)(a=>{_(a),al.current=a;let b=new URLSearchParams;E&&"inbox"!==E&&b.set("folder",E),b.set("id",a.id),s.replace(`/dashboard/communication/email?${b.toString()}`,{scroll:!1}),a.body_html||a.body?(ab({html:a.body_html||null,text:a.body||null}),ad(!1)):(ad(!0),f(a.id).then(a=>{a.success?ab({html:a.html||null,text:a.text||null}):ab({html:null,text:null})}).catch(()=>{ab({html:null,text:null})}).finally(()=>{ad(!1)})),a.read_at||(N(b=>({...b,emails:b.emails.map(b=>b.id===a.id?{...b,read_at:new Date().toISOString()}:b)})),(0,h.markEmailAsReadAction)({emailId:a.id}).then(a=>{a.success&&window.dispatchEvent(new CustomEvent("email-read"))}).catch(console.error))},[s,E]);(0,T.useEffect)(()=>{if(!I||I!==al.current?.id)if(I&&L?.emails){let a=L.emails.find(a=>a.id===I);a&&(_(a),al.current=a,a.body_html||a.body?ab({html:a.body_html||null,text:a.body||null}):(ad(!0),f(a.id).then(a=>{a.success?ab({html:a.html||null,text:a.text||null}):ab({html:null,text:null})}).catch(()=>{ab({html:null,text:null})}).finally(()=>{ad(!1)})),a.read_at||(N(b=>({...b,emails:b.emails.map(b=>b.id===a.id?{...b,read_at:new Date().toISOString()}:b)})),(0,h.markEmailAsReadAction)({emailId:a.id}).catch(console.error)))}else!I&&Z&&(_(null),al.current=null,ab(null))},[I,L?.emails]);let a3=(0,T.useCallback)(()=>{aZ(!0),A.toast.success("Refreshing emails...")},[aZ]),a4=(0,T.useCallback)(async a=>{try{if("archive"!==E&&(N(b=>({...b,emails:b.emails.filter(b=>b.id!==a),total:b.total-1})),Z?.id===a)){_(null),ab(null),al.current=null;let a=new URLSearchParams;E&&"inbox"!==E&&a.set("folder",E),s.replace(`/dashboard/communication/email?${a.toString()}`,{scroll:!1})}let b=await (0,c.archiveEmailAction)(a);b.success?(A.toast.success("Email archived"),window.dispatchEvent(new CustomEvent("email-archived"))):(aZ(!1),A.toast.error("Failed to archive email",{description:b.error||"Unknown error"}))}catch(a){aZ(!1),A.toast.error("Failed to archive email")}},[aZ,E,Z,s]),a5=(0,T.useCallback)(async()=>{if(!L?.emails||0===L.emails.length){A.toast.info("No emails to archive"),aU(!1);return}try{R(!0),aU(!1);let a=await e(E||"inbox");a.success?(A.toast.success(`Archived ${a.archived} email${1===a.archived?"":"s"}`),aZ(!1),_(null),ab(null),window.dispatchEvent(new CustomEvent("email-archived"))):A.toast.error("Failed to archive emails",{description:a.error||"Unknown error"})}catch(a){A.toast.error("Failed to archive emails")}finally{R(!1)}},[L,E,aZ]),a6=(0,T.useCallback)(async a=>{try{let b=L?.emails.find(b=>b.id===a),c=b?.tags||[],d=!(c.includes("spam")||b?.category==="spam");N(b=>d&&"spam"!==E||!d&&"spam"===E?{...b,emails:b.emails.filter(b=>b.id!==a),total:b.total-1}:{...b,emails:b.emails.map(b=>{if(b.id===a){let a=d?[...c,"spam"]:c.filter(a=>"spam"!==a);return{...b,tags:a.length>0?a:null,category:d?"spam":null}}return b})}),Z?.id===a&&(d&&"spam"!==E||!d&&"spam"===E)&&(_(null),ab(null),al.current=null),(await i(a)).success?(A.toast.success(d?"Email marked as spam":"Email removed from spam"),window.dispatchEvent(new CustomEvent("email-spam-toggled"))):(aZ(!1),A.toast.error("Failed to update spam status"))}catch{aZ(!1),A.toast.error("Failed to update spam status")}},[aZ,Z,E,L]),a7=(0,T.useCallback)(async a=>{try{let b=L?.emails.find(b=>b.id===a),c=b?.tags||[],d=!c.includes("starred");if(N(b=>{let e=b.emails.map(b=>{if(b.id===a){let a=d?[...c,"starred"]:c.filter(a=>"starred"!==a);return{...b,tags:a.length>0?a:null}}return b});if("starred"===E){let a=e.filter(a=>(a.tags||[]).includes("starred"));return{...b,emails:a,total:a.length}}return{...b,emails:e}}),Z?.id===a){let a=d?[...c,"starred"]:c.filter(a=>"starred"!==a);_({...Z,tags:a.length>0?a:null}),"starred"!==E||d||(_(null),ab(null))}(await (0,j.toggleStarEmailAction)(a)).success?window.dispatchEvent(new CustomEvent("email-starred-toggled")):(aZ(!1),A.toast.error("Failed to star email"))}catch{aZ(!1),A.toast.error("Failed to star email")}},[aZ,Z,E,L]),a8=(0,T.useCallback)(()=>{if(!Z)return;let a=`
			<!DOCTYPE html>
			<html>
			<head>
				<title>${Z.subject||"Email"}</title>
				<style>
					body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
					.header { border-bottom: 1px solid #e5e7eb; padding-bottom: 20px; margin-bottom: 20px; }
					.subject { font-size: 24px; font-weight: 600; margin-bottom: 12px; }
					.meta { color: #6b7280; font-size: 14px; }
					.meta-row { margin-bottom: 4px; }
					.body { line-height: 1.6; }
				</style>
			</head>
			<body>
				<div class="header">
					<div class="subject">${Z.subject||"No Subject"}</div>
					<div class="meta">
						<div class="meta-row"><strong>From:</strong> ${Z.from_name||""} &lt;${Z.from_address||"Unknown"}&gt;</div>
						<div class="meta-row"><strong>To:</strong> ${Z.to_address||"Unknown"}</div>
						<div class="meta-row"><strong>Date:</strong> ${new Date(Z.created_at).toLocaleString()}</div>
					</div>
				</div>
				<div class="body">
					${aa?.html||Z.body_html||aa?.text||Z.body||"No content"}
				</div>
			</body>
			</html>
		`,b=window.open("","_blank");b&&(b.document.write(a),b.document.close(),b.focus(),setTimeout(()=>b.print(),250))},[Z,aa]),a9=(0,T.useCallback)(()=>{if(!Z)return;let a=`----=_Part_${Date.now()}_${Math.random().toString(36).slice(2)}`,b=new Date(Z.created_at).toUTCString(),c=new Blob([`MIME-Version: 1.0
Date: ${b}
Subject: ${Z.subject||"No Subject"}
From: ${Z.from_name?`${Z.from_name} <${Z.from_address}>`:Z.from_address||"Unknown"}
To: ${Z.to_address||"Unknown"}
Content-Type: multipart/alternative; boundary="${a}"

--${a}
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 7bit

${aa?.text||Z.body||"No content"}

--${a}
Content-Type: text/html; charset="UTF-8"
Content-Transfer-Encoding: 7bit

${aa?.html||Z.body_html||"<p>No content</p>"}

--${a}--
`],{type:"message/rfc822"}),d=URL.createObjectURL(c),e=document.createElement("a");e.href=d;let f=(Z.subject||"email").replace(/[^a-z0-9\s-]/gi,"_").replace(/\s+/g,"_").slice(0,50)||"email";e.download=`${f}.eml`,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(d),A.toast.success("Email downloaded")},[Z,aa]),ba=(0,T.useCallback)(async a=>{try{if(N(b=>({...b,emails:b.emails.filter(b=>b.id!==a),total:b.total-1})),Z?.id===a){_(null),ab(null),al.current=null;let a=new URLSearchParams;E&&"inbox"!==E&&a.set("folder",E),s.replace(`/dashboard/communication/email?${a.toString()}`,{scroll:!1})}A.toast.success("Email moved to trash")}catch{aZ(!1),A.toast.error("Failed to delete email")}},[aZ,Z,E,s]),bb=(0,T.useCallback)(async a=>{if(a){aW(!0);try{let b=await k(a);b.success?(A.toast.success("Email sent successfully!"),aZ(!0)):A.toast.error("Failed to send email",{description:b.error||"Please try again later"})}catch(a){console.error("Failed to retry email:",a),A.toast.error("Failed to send email",{description:a instanceof Error?a.message:"Unknown error occurred"})}finally{aW(!1)}}},[aZ]),bc=!Z&&!ap,bd=Z||ap;return(0,b.jsxs)("div",{className:"flex h-full w-full flex-col overflow-hidden bg-sidebar",children:[(0,b.jsxs)("div",{className:"flex flex-1 overflow-hidden min-h-0 md:gap-2",children:[(0,b.jsx)("div",{className:(0,n.cn)("bg-card mb-1 shadow-sm flex flex-col overflow-hidden","w-full h-full","md:w-[400px] lg:w-[480px] md:rounded-tr-2xl",bc?"flex":"hidden md:flex"),children:(0,b.jsxs)("div",{className:"w-full h-full flex flex-col",children:[(0,b.jsx)("div",{className:"sticky top-0 z-15 flex items-center justify-between gap-1.5 p-2 pb-0 transition-colors bg-card",children:(0,b.jsx)("div",{className:"w-full",children:(0,b.jsx)("div",{className:"grid grid-cols-12 gap-2 mt-1",children:(0,b.jsxs)("div",{className:"col-span-12 flex gap-2",children:[(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",onClick:am,className:"h-10 w-10 p-0 md:h-8 md:w-8 shrink-0",title:"Toggle sidebar",children:(0,b.jsx)(aA.PanelLeft,{className:"h-5 w-5 md:h-4 md:w-4 text-muted-foreground"})}),(0,b.jsxs)("div",{className:"relative flex-1",children:[(0,b.jsx)(C.Input,{type:"search",placeholder:"Search emails...",value:ah,onChange:a=>ai(a.target.value),className:"h-10 md:h-8 pl-9 pr-20 text-base md:text-sm border-input bg-white dark:bg-[#141414] dark:border-none"}),(0,b.jsx)("svg",{width:"10",height:"10",viewBox:"0 0 10 10",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:"absolute left-3 top-1/2 -translate-y-1/2 fill-[#71717A] dark:fill-[#6F6F6F]",children:(0,b.jsx)("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M6.81038 7.0756C6.18079 7.54011 5.40248 7.81466 4.56004 7.81466C2.46451 7.81466 0.765747 6.11589 0.765747 4.02037C0.765747 1.92484 2.46451 0.226074 4.56004 0.226074C6.65557 0.226074 8.35433 1.92484 8.35433 4.02037C8.35433 4.8628 8.07978 5.64112 7.61527 6.27071L9.70535 8.36078C9.92761 8.58305 9.92761 8.94341 9.70535 9.16568C9.48308 9.38794 9.12272 9.38794 8.90046 9.16568L6.81038 7.0756ZM7.21604 4.02037C7.21604 5.48724 6.02691 6.67637 4.56004 6.67637C3.09317 6.67637 1.90403 5.48724 1.90403 4.02037C1.90403 2.5535 3.09317 1.36436 4.56004 1.36436C6.02691 1.36436 7.21604 2.5535 7.21604 4.02037Z"})}),ah&&(0,b.jsx)("button",{onClick:()=>ai(""),className:"absolute right-2 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground",children:(0,b.jsx)(S.X,{className:"h-3 w-3"})})]}),(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",onClick:a3,disabled:P,className:"h-10 w-10 p-0 md:h-8 md:w-8",title:"Refresh",children:(0,b.jsx)(aC.RefreshCw,{className:`h-5 w-5 md:h-4 md:w-4 text-muted-foreground ${P?"animate-spin":""}`})}),aY&&"archive"!==E&&L?.emails&&L.emails.length>0&&(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",onClick:()=>aU(!0),disabled:P,className:"h-8 w-8 p-0 group/archive-all hover:bg-destructive/10",title:"Archive all emails",children:(0,b.jsx)(as.Archive,{className:"h-4 w-4 text-muted-foreground group-hover/archive-all:text-destructive transition-colors"})})]})})})}),(0,b.jsx)("div",{className:(0,n.cn)("bg-[#006FFE] relative z-5 h-0.5 w-full transition-opacity",P?"opacity-100 animate-pulse":"opacity-0")}),(0,b.jsx)("div",{className:"relative z-1 flex-1 overflow-hidden pt-0 min-h-0",children:(0,b.jsx)("div",{className:"hide-link-indicator flex h-full w-full",children:(0,b.jsx)("div",{className:"flex flex-1 flex-col",id:"mail-list-scroll",children:(0,b.jsx)(X.ScrollArea,{className:"scrollbar-none flex-1 overflow-x-hidden h-full",children:U&&(!L?.emails||0===L.emails.length)?(0,b.jsx)("div",{className:"flex items-center justify-center p-8",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)(ar.AlertTriangle,{className:"h-8 w-8 text-destructive mx-auto mb-4"}),(0,b.jsx)("p",{className:"text-sm text-destructive mb-2 font-medium",children:"Failed to load emails"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mb-4",children:U}),(0,b.jsx)(l.Button,{variant:"outline",size:"sm",onClick:()=>aZ(),children:"Try Again"})]})}):L?.emails?.length?(0,b.jsx)("div",{className:"min-h-[200px] px-2",children:L.emails.map(a=>{let c=Z?.id===a.id;return(0,b.jsx)("div",{className:"select-none md:my-1",children:(0,b.jsxs)("div",{className:(0,n.cn)("hover:bg-accent group flex cursor-pointer flex-col items-start rounded-lg py-2 text-left text-sm transition-all hover:opacity-100 relative",c?"bg-accent opacity-100":"",a.read_at?"opacity-60":"opacity-100"),onClick:()=>a2(a),children:[(0,b.jsxs)("div",{className:"dark:bg-panelDark absolute right-2 z-25 flex -translate-y-1/2 items-center gap-1 rounded-xl border bg-white p-1 opacity-0 shadow-sm group-hover:opacity-100 top-[-1] transition-opacity duration-200",onClick:a=>a.stopPropagation(),children:[(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-6 w-6 overflow-visible p-0 hover:bg-accent group/star",onClick:b=>{b.stopPropagation(),a7(a.id)},title:a.tags&&Array.isArray(a.tags)&&a.tags.includes("starred")?"Unstar":"Star",children:(0,b.jsx)(aF.Star,{className:(0,n.cn)("h-4 w-4 transition-colors group-hover/star:text-yellow-500",a.tags&&Array.isArray(a.tags)&&a.tags.includes("starred")?"fill-yellow-500 text-yellow-500":"text-muted-foreground")})}),(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 hover:bg-accent group/spam",onClick:b=>{b.stopPropagation(),a6(a.id)},title:"spam"===a.category?"Not spam":"Spam",children:(0,b.jsx)(ax.Flag,{className:(0,n.cn)("h-4 w-4 transition-colors group-hover/spam:text-orange-500","spam"===a.category?"fill-orange-500 text-orange-500":"text-muted-foreground")})}),(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 hover:bg-accent group/archive",onClick:b=>{b.stopPropagation(),a4(a.id)},title:"Archive",children:(0,b.jsx)(as.Archive,{className:"h-4 w-4 text-muted-foreground transition-colors group-hover/archive:text-blue-500"})})]}),(0,b.jsxs)("div",{className:"relative flex w-full items-center justify-between gap-4 px-2",children:[(0,b.jsx)(W.Avatar,{className:"h-8 w-8 shrink-0 rounded-full border",children:(0,b.jsx)(W.AvatarFallback,{className:"bg-white dark:bg-[#373737] text-[#9F9F9D] font-bold text-xs",children:a.from_address?.[0]?.toUpperCase()||"U"})}),(0,b.jsx)("div",{className:"flex w-full justify-between",children:(0,b.jsxs)("div",{className:"w-full",children:[(0,b.jsxs)("div",{className:"flex w-full flex-row items-center justify-between",children:[(0,b.jsx)("div",{className:"flex flex-row items-center gap-[4px]",children:(0,b.jsx)("span",{className:"font-bold text-md flex items-baseline gap-1 group-hover:opacity-100",children:(0,b.jsxs)("div",{className:"flex items-center gap-1",children:[(0,b.jsx)("span",{className:"line-clamp-1 overflow-hidden text-sm",children:"outbound"===a.direction?a.to_address||"Unknown recipient":a.from_name||a.from_address||"Unknown sender"}),!a.read_at&&(0,b.jsx)("span",{className:"ml-0.5 size-2 rounded-full bg-[#006FFE]"})]})})}),(0,b.jsx)("p",{className:"text-muted-foreground text-nowrap text-xs font-normal opacity-70 transition-opacity group-hover:opacity-100 dark:text-[#8C8C8C]",children:a.created_at?new Date(a.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):""})]}),(0,b.jsxs)("div",{className:"flex justify-between items-center gap-2",children:[(0,b.jsx)("p",{className:"mt-1 line-clamp-1 min-w-0 overflow-hidden text-sm text-[#8C8C8C] flex-1",children:a.subject||"No subject"}),(0,b.jsxs)("div",{className:"flex items-center gap-1 shrink-0",children:[a.customer?.id&&(0,b.jsxs)(u.default,{href:`/dashboard/customers/${a.customer.id}`,onClick:a=>a.stopPropagation(),className:"px-1.5 py-0.5 rounded text-[10px] bg-primary/10 text-primary hover:bg-primary/20 transition-colors flex items-center gap-0.5",title:`View ${(0,o.getCustomerDisplayName)(a.customer)} profile`,children:[(0,b.jsx)(t.User,{className:"h-2.5 w-2.5"}),(0,b.jsx)("span",{className:"hidden sm:inline",children:(0,o.getCustomerDisplayName)(a.customer)})]}),"draft"===a.status&&(0,b.jsx)("span",{className:"px-1.5 py-0.5 rounded text-[10px] bg-muted text-muted-foreground",children:"Draft"}),"failed"===a.status&&(0,b.jsxs)(D.Tooltip,{children:[(0,b.jsx)(D.TooltipTrigger,{asChild:!0,children:(0,b.jsxs)("span",{className:"px-1.5 py-0.5 rounded text-[10px] bg-destructive/10 text-destructive cursor-help flex items-center gap-0.5",children:[(0,b.jsx)(ar.AlertTriangle,{className:"h-2.5 w-2.5"}),"Failed"]})}),(0,b.jsxs)(D.TooltipContent,{children:[(0,b.jsx)("p",{className:"font-medium",children:"Email failed to send"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"Click email to retry or view details"})]})]}),"outbound"===a.direction&&"draft"!==a.status&&"failed"!==a.status&&(0,b.jsx)("span",{className:"px-1.5 py-0.5 rounded text-[10px] bg-blue-500/10 text-blue-600",children:"Sent"})]})]})]})})]})]})},a.id)})}):(0,b.jsx)("div",{className:"flex items-center justify-center p-8",children:(0,b.jsx)("div",{className:"text-center",children:P?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(M.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground mx-auto mb-3"}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loading emails..."})]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("p",{className:"text-sm font-medium text-muted-foreground mb-1",children:ae?"No emails found":"No emails yet"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:ae?"Try adjusting your search terms":"Emails will appear here when received"})]})})})})})})})]})}),ap?(0,b.jsx)("div",{className:(0,n.cn)("bg-card mb-1 shadow-sm flex flex-col min-w-0 overflow-hidden","w-full h-full","md:rounded-tl-2xl md:flex-1",bd?"flex":"hidden md:flex"),children:(0,b.jsx)(ag,{companyId:r,onClose:()=>aO(!1),onSent:()=>{aO(!1),aZ(!0)},className:"h-full"})}):Z?(0,b.jsx)("div",{className:(0,n.cn)("bg-card mb-1 shadow-sm flex flex-col min-w-0 overflow-hidden","w-full h-full","md:rounded-tl-2xl md:flex-1",bd?"flex":"hidden md:flex"),children:(0,b.jsx)("div",{className:"relative flex-1 min-h-0 flex flex-col",children:(0,b.jsxs)("div",{className:"bg-card relative flex flex-col overflow-hidden transition-all duration-300 h-full flex-1 min-h-0",children:[(0,b.jsxs)("div",{className:"sticky top-0 z-15 flex shrink-0 items-center justify-between gap-1.5 p-2 pb-0 transition-colors bg-card",children:[(0,b.jsxs)("div",{className:"flex flex-1 items-center gap-2",children:[(0,b.jsxs)(l.Button,{variant:"ghost",size:"sm",onClick:()=>{_(null),ab(null),al.current=null;let a=new URLSearchParams;E&&"inbox"!==E&&a.set("folder",E),s.push(`/dashboard/communication/email?${a.toString()}`,{scroll:!1})},className:"h-10 w-10 p-0 md:h-8 md:w-8",title:"Back to list",children:[(0,b.jsx)(at.ArrowLeft,{className:"h-5 w-5 md:hidden text-muted-foreground"}),(0,b.jsx)(S.X,{className:"h-4 w-4 hidden md:block text-muted-foreground"})]}),(0,b.jsx)(Y.Separator,{orientation:"vertical",className:"h-4 bg-border/60 hidden md:block"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-1",children:[(0,b.jsxs)(l.Button,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 md:h-8 md:w-auto md:px-2",onClick:()=>ao("reply-all"),title:"Reply all",children:[(0,b.jsx)(aE.ReplyAll,{className:"h-5 w-5 md:h-4 md:w-4 md:mr-1.5 text-muted-foreground"}),(0,b.jsx)("span",{className:"text-sm leading-none font-medium hidden md:inline",children:"Reply all"})]}),(0,b.jsxs)(aH.Sheet,{open:aP,onOpenChange:aQ,children:[(0,b.jsx)(aH.SheetTrigger,{asChild:!0,children:(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 md:h-8 md:w-8 hidden md:flex",title:"Notes",children:(0,b.jsx)(aG.StickyNote,{className:"h-4 w-4 text-muted-foreground"})})}),(0,b.jsxs)(aH.SheetContent,{children:[(0,b.jsxs)(aH.SheetHeader,{children:[(0,b.jsx)(aH.SheetTitle,{children:"Email Notes"}),(0,b.jsx)(aH.SheetDescription,{children:"Add private notes about this email."})]}),(0,b.jsxs)("div",{className:"py-4",children:[(0,b.jsx)(aJ.Textarea,{placeholder:"Add your notes here...",value:aR,onChange:a=>aS(a.target.value),className:"min-h-[200px] resize-none"}),(0,b.jsxs)("div",{className:"mt-4 flex justify-end gap-2",children:[(0,b.jsx)(l.Button,{variant:"outline",size:"sm",onClick:()=>aQ(!1),children:"Cancel"}),(0,b.jsx)(l.Button,{size:"sm",onClick:()=>{A.toast.success("Notes saved"),aQ(!1)},children:"Save Notes"})]})]})]})]}),(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 md:h-8 md:w-8 group/star",title:Z?.tags?.includes("starred")?"Unstar":"Star",onClick:()=>Z&&a7(Z.id),children:(0,b.jsx)(aF.Star,{className:(0,n.cn)("h-5 w-5 md:h-4 md:w-4 transition-colors group-hover/star:text-yellow-500",Z?.tags?.includes("starred")?"fill-yellow-500 text-yellow-500":"text-muted-foreground")})}),(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 md:h-8 md:w-8 hidden md:flex group/spam",title:Z?.category==="spam"?"Not spam":"Spam",onClick:()=>Z&&a6(Z.id),children:(0,b.jsx)(ax.Flag,{className:(0,n.cn)("h-4 w-4 transition-colors group-hover/spam:text-orange-500",Z?.category==="spam"?"fill-orange-500 text-orange-500":"text-muted-foreground")})}),(0,b.jsx)(l.Button,{variant:"destructive",size:"sm",className:"h-10 w-10 p-0 md:h-8 md:w-8",title:"Archive",onClick:()=>Z&&a4(Z.id),children:(0,b.jsx)(as.Archive,{className:"h-5 w-5 md:h-4 md:w-4"})}),(0,b.jsxs)(B.DropdownMenu,{children:[(0,b.jsx)(B.DropdownMenuTrigger,{asChild:!0,children:(0,b.jsx)(l.Button,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 md:h-8 md:w-8",title:"More",children:(0,b.jsx)(ak.MoreHorizontal,{className:"h-5 w-5 md:h-4 md:w-4 text-muted-foreground"})})}),(0,b.jsxs)(B.DropdownMenuContent,{align:"end",className:"w-48",children:[(0,b.jsxs)(B.DropdownMenuItem,{onClick:()=>Z&&a6(Z.id),className:"md:hidden",children:[(0,b.jsx)(ax.Flag,{className:"h-4 w-4 mr-2"}),Z?.category==="spam"?"Not spam":"Mark as spam"]}),(0,b.jsxs)(B.DropdownMenuItem,{onClick:()=>aQ(!0),className:"md:hidden",children:[(0,b.jsx)(aG.StickyNote,{className:"h-4 w-4 mr-2"}),"Notes"]}),(0,b.jsx)(B.DropdownMenuSeparator,{className:"md:hidden"}),(0,b.jsxs)(B.DropdownMenuItem,{onClick:a8,children:[(0,b.jsx)(aB.Printer,{className:"h-4 w-4 mr-2"}),"Print"]}),(0,b.jsxs)(B.DropdownMenuItem,{onClick:a9,children:[(0,b.jsx)(av.Download,{className:"h-4 w-4 mr-2"}),"Download as .eml"]}),(0,b.jsx)(B.DropdownMenuSeparator,{}),(0,b.jsxs)(B.DropdownMenuItem,{onClick:()=>Z&&ba(Z.id),className:"text-destructive focus:text-destructive",children:[(0,b.jsx)(Q.Trash2,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]})]})]}),(0,b.jsx)("div",{className:"flex min-h-0 flex-1 flex-col overflow-hidden",children:(0,b.jsxs)("div",{className:"relative overflow-hidden flex-1 h-full min-h-0 flex flex-col",children:[(0,b.jsx)(D.TooltipProvider,{delayDuration:100,children:(0,b.jsxs)("div",{className:"border-b border-border/50 px-2 py-4 space-y-3",children:[(0,b.jsx)("h1",{className:"text-base font-semibold text-foreground",children:Z.subject||"No Subject"}),(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsx)(W.Avatar,{className:"h-9 w-9 shrink-0 rounded-md cursor-pointer",children:(0,b.jsx)(W.AvatarFallback,{className:"bg-muted text-muted-foreground font-semibold text-sm rounded-md",children:Z.from_address?.[0]?.toUpperCase()||"U"})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("span",{className:"font-semibold text-sm text-foreground",children:Z.from_name||Z.from_address||"Unknown"}),!Z.read_at&&(0,b.jsx)("div",{className:"h-2 w-2 rounded-full bg-primary"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[(0,b.jsxs)("span",{children:["to ",Z.to_address?.split("@")[0]||"you"]}),(0,b.jsx)(v,{customer:Z.customer,fallbackName:Z.from_name||void 0,fallbackEmail:Z.from_address||void 0,size:"sm"})]})]}),(0,b.jsx)("div",{className:"flex items-center gap-2",children:(0,b.jsx)("span",{className:"text-xs text-muted-foreground whitespace-nowrap",children:new Date(Z.created_at).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})})})]}),"outbound"===Z.direction&&(0,b.jsx)("div",{className:"flex flex-col gap-2 pt-2",children:(0,b.jsxs)("div",{className:"flex items-center gap-1 flex-wrap",children:[(0,b.jsxs)(D.Tooltip,{children:[(0,b.jsx)(D.TooltipTrigger,{asChild:!0,children:(0,b.jsxs)("div",{className:(0,n.cn)("flex items-center gap-1.5 px-2 py-1 rounded-full text-xs",Z.sent_at?"bg-blue-500/10 text-blue-600":"bg-muted text-muted-foreground"),children:[(0,b.jsx)(O.Send,{className:"h-3 w-3"}),(0,b.jsx)("span",{children:"Sent"})]})}),(0,b.jsx)(D.TooltipContent,{children:(0,b.jsx)("p",{children:Z.sent_at?`Sent ${new Date(Z.sent_at).toLocaleString()}`:"Not sent yet"})})]}),Z.sent_at&&(0,b.jsx)($.ChevronRight,{className:"h-3 w-3 text-muted-foreground"}),Z.sent_at&&(0,b.jsxs)(D.Tooltip,{children:[(0,b.jsx)(D.TooltipTrigger,{asChild:!0,children:(0,b.jsxs)("div",{className:(0,n.cn)("flex items-center gap-1.5 px-2 py-1 rounded-full text-xs",Z.delivered_at?"bg-green-500/10 text-green-600":"bg-muted text-muted-foreground"),children:[(0,b.jsx)(au.CheckCheck,{className:"h-3 w-3"}),(0,b.jsx)("span",{children:"Delivered"})]})}),(0,b.jsx)(D.TooltipContent,{children:(0,b.jsx)("p",{children:Z.delivered_at?`Delivered ${new Date(Z.delivered_at).toLocaleString()}`:"Waiting..."})})]}),Z.delivered_at&&(0,b.jsx)($.ChevronRight,{className:"h-3 w-3 text-muted-foreground"}),Z.delivered_at&&(0,b.jsxs)(D.Tooltip,{children:[(0,b.jsx)(D.TooltipTrigger,{asChild:!0,children:(0,b.jsxs)("div",{className:(0,n.cn)("flex items-center gap-1.5 px-2 py-1 rounded-full text-xs",Z.opened_at?"bg-purple-500/10 text-purple-600":"bg-muted/50 text-muted-foreground/70"),children:[(0,b.jsx)(aw.Eye,{className:"h-3 w-3"}),(0,b.jsxs)("span",{children:["Opened",Z.open_count&&Z.open_count>1?` (${Z.open_count})`:""]}),(0,b.jsx)(ar.AlertTriangle,{className:"h-3 w-3 text-amber-500"})]})}),(0,b.jsxs)(D.TooltipContent,{children:[(0,b.jsx)("p",{children:Z.opened_at?`Opened ${new Date(Z.opened_at).toLocaleString()}`:"Not opened"}),(0,b.jsx)("p",{className:"text-xs text-amber-500 mt-1",children:"⚠️ Unreliable metric"})]})]}),Z.delivered_at&&(0,b.jsx)($.ChevronRight,{className:"h-3 w-3 text-muted-foreground"}),Z.delivered_at&&(0,b.jsxs)(D.Tooltip,{children:[(0,b.jsx)(D.TooltipTrigger,{asChild:!0,children:(0,b.jsxs)("div",{className:(0,n.cn)("flex items-center gap-1.5 px-2 py-1 rounded-full text-xs",Z.clicked_at?"bg-amber-500/10 text-amber-600":"bg-muted text-muted-foreground"),children:[(0,b.jsx)(az.default,{className:"h-3 w-3"}),(0,b.jsxs)("span",{children:["Clicked",Z.click_count&&Z.click_count>1?` (${Z.click_count})`:""]})]})}),(0,b.jsx)(D.TooltipContent,{children:(0,b.jsx)("p",{children:Z.clicked_at?`Clicked ${new Date(Z.clicked_at).toLocaleString()}`:"No clicks"})})]})]})})]})}),(0,b.jsxs)("div",{className:"flex-1 overflow-hidden flex flex-col min-h-0",children:[(0,b.jsx)("div",{className:"flex-1 overflow-y-auto px-2 py-4",children:ac?(0,b.jsx)("div",{className:"flex items-center justify-center py-12",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)(M.Loader2,{className:"h-8 w-8 animate-spin text-muted-foreground mx-auto mb-4"}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loading email content..."})]})}):(0,b.jsx)(w.EmailContent,{html:aa?.html||Z.body_html||null,text:aa?.text||Z.body||null,attachments:null})}),(0,b.jsx)("div",{className:"px-2 py-4 pb-safe",children:an?(0,b.jsx)(aq,{mode:an,selectedEmail:Z,companyId:r,onClose:()=>ao(null),onSent:()=>{ao(null),aZ(!0)}}):"failed"===Z.status?(0,b.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,b.jsx)(l.Button,{variant:"default",size:"sm",className:"h-11 px-4 flex-1 md:flex-none md:h-9",onClick:()=>bb(Z.id),disabled:aV,children:aV?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(M.Loader2,{className:"h-5 w-5 md:h-4 md:w-4 mr-2 animate-spin"}),"Sending..."]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(aC.RefreshCw,{className:"h-5 w-5 md:h-4 md:w-4 mr-2"}),"Retry Send"]})}),Z.failure_reason&&(0,b.jsxs)("div",{className:"w-full flex items-start gap-2 p-3 rounded-lg bg-destructive/10 border border-destructive/20",children:[(0,b.jsx)(ar.AlertTriangle,{className:"h-4 w-4 text-destructive shrink-0 mt-0.5"}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsx)("p",{className:"text-sm font-medium text-destructive",children:"Failed to send"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-0.5",children:Z.failure_reason})]})]})]}):(0,b.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,b.jsxs)(l.Button,{variant:"default",size:"sm",className:"h-11 px-4 flex-1 md:flex-none md:h-9",onClick:()=>ao("reply"),children:[(0,b.jsx)(aD.Reply,{className:"h-5 w-5 md:h-4 md:w-4 mr-2"}),"Reply"]}),(0,b.jsxs)(l.Button,{variant:"outline",size:"sm",className:"h-11 px-3 flex-1 md:flex-none md:h-9 md:px-4",onClick:()=>ao("reply-all"),children:[(0,b.jsx)(aE.ReplyAll,{className:"h-5 w-5 md:h-4 md:w-4 mr-2"}),(0,b.jsx)("span",{className:"hidden xs:inline",children:"Reply All"}),(0,b.jsx)("span",{className:"xs:hidden",children:"All"})]}),(0,b.jsxs)(l.Button,{variant:"outline",size:"sm",className:"h-11 px-3 flex-1 md:flex-none md:h-9 md:px-4",onClick:()=>ao("forward"),children:[(0,b.jsx)(ay.Forward,{className:"h-5 w-5 md:h-4 md:w-4 mr-2"}),"Forward"]})]})})]})]})})]})})}):null]}),(0,b.jsx)(aI.AlertDialog,{open:aT,onOpenChange:aU,children:(0,b.jsxs)(aI.AlertDialogContent,{children:[(0,b.jsxs)(aI.AlertDialogHeader,{children:[(0,b.jsxs)(aI.AlertDialogTitle,{className:"flex items-center gap-2",children:[(0,b.jsx)(ar.AlertTriangle,{className:"h-5 w-5 text-destructive"}),"Archive All ",E?E.charAt(0).toUpperCase()+E.slice(1):"Inbox"," Emails"]}),(0,b.jsxs)(aI.AlertDialogDescription,{children:["This will archive ",(0,b.jsx)("strong",{children:L?.emails?.length||0})," email",1!==(L?.emails?.length||0)?"s":""," from your ",(0,b.jsx)("strong",{children:E||"inbox"})," folder. This action can be undone by viewing the Archive folder."]})]}),(0,b.jsxs)(aI.AlertDialogFooter,{children:[(0,b.jsx)(aI.AlertDialogCancel,{children:"Cancel"}),(0,b.jsx)(aI.AlertDialogAction,{onClick:a5,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Archive All"})]})]})})]})}a.s(["EmailPageClient",()=>aO],116381)}];

//# sourceMappingURL=apps_web_src_components_communication_email-page-client_tsx_83120bf2._.js.map