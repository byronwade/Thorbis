module.exports=[894527,a=>{"use strict";var b=a.i(780195),c=a.i(666680),d=a.i(136874);async function e(a,b,f=24){let g=(0,c.randomBytes)(32).toString("hex"),h=new Date(Date.now()+60*f*6e4),i=await (0,d.createClient)();if(!i)throw Error("Supabase client not configured");let{error:j}=await i.from("verification_tokens").insert({token:g,email:a,type:"email_verification",user_id:b,expires_at:h.toISOString(),used:!1});if(j)throw Error(`Failed to create verification token: ${j.message}`);return{token:g,expiresAt:h}}async function f(a,b){let c=await (0,d.createClient)();if(!c)throw Error("Supabase client not configured");let e=new Date().toISOString(),{data:f,error:g}=await c.from("verification_tokens").select("*").eq("token",a).eq("type",b).eq("used",!1).gt("expires_at",e).limit(1).single();if(g||!f)return null;let{error:h}=await c.from("verification_tokens").update({used:!0,used_at:e}).eq("id",f.id);if(h)throw Error(`Failed to consume token: ${h.message}`);return f}(0,a.i(395731).ensureServerEntryExports)([e,f]),(0,b.registerServerReference)(e,"7034ce66d9a6f04fced44178db5603fb8162d4c9b3",null),(0,b.registerServerReference)(f,"603497ccaebba8bf63345189429088660fa96f2f7c",null),a.s(["createEmailVerificationToken",()=>e,"verifyAndConsumeToken",()=>f])},402417,a=>{"use strict";a.i(894527),a.s([])},261967,a=>{"use strict";a.i(666680);var b=a.i(857782);async function c(){(await (0,b.cookies)()).delete("csrf_token")}a.s(["clearCSRFToken",()=>c])},533673,a=>a.a(async(b,c)=>{try{var d=a.i(780195),e=a.i(198114),f=a.i(463556),g=a.i(837666);a.i(761364);var h=a.i(615236),i=a.i(439630),j=a.i(603662);a.i(373845),a.i(302545),a.i(453648),a.i(726075),a.i(568339),a.i(730601),a.i(557077),a.i(525536),a.i(468606),a.i(764685),a.i(828933);var k=a.i(395731),l=b([e]);async function m(a,b){return await (0,e.sendEmail)({to:a,subject:"Welcome to Thorbis!",template:(0,j.default)(b),templateType:f.EmailTemplate.WELCOME})}async function n(a,b){return await (0,e.sendEmail)({to:a,subject:"Verify your email address",template:(0,g.default)(b),templateType:f.EmailTemplate.EMAIL_VERIFICATION})}async function o(a,b){return await (0,e.sendEmail)({to:a,subject:"Reset your password",template:(0,i.default)(b),templateType:f.EmailTemplate.PASSWORD_RESET})}async function p(a,b){return await (0,e.sendEmail)({to:a,subject:"Your password has been changed",template:(0,h.default)(b),templateType:f.EmailTemplate.PASSWORD_CHANGED})}[e]=l.then?(await l)():l,(0,k.ensureServerEntryExports)([m,n,o,p]),(0,d.registerServerReference)(m,"60cd5f53eb1efcb28d1d07a912bd5e7d712c67dba4",null),(0,d.registerServerReference)(n,"6023fe8da1be4e2415a54f88e6efff40f7ba45f6b8",null),(0,d.registerServerReference)(o,"60f9c4960f02fa51814339399e5801d8c8870d94d1",null),(0,d.registerServerReference)(p,"60ce20ce09c4cd81626a89e9ce3b45ab9d9632bc6b",null),a.s(["sendEmailVerification",()=>n,"sendPasswordChanged",()=>p,"sendPasswordReset",()=>o,"sendWelcomeEmail",()=>m]),c()}catch(a){c(a)}},!1),304381,a=>a.a(async(b,c)=>{try{var d=a.i(780195),e=a.i(951615),f=a.i(750227),g=a.i(594770),h=a.i(218188);a.i(692167);var i=a.i(852596),j=a.i(146057);a.i(467361);var k=a.i(445074);a.i(402417);var l=a.i(894527),m=a.i(507523),n=a.i(261967),o=a.i(518216),p=a.i(136874),q=a.i(933427),r=a.i(533673),s=a.i(395731),t=b([r]);[r]=t.then?(await t)():t;let D=j.z.object({name:j.z.string().trim().min(2,"Name must be at least 2 characters").max(100,"Name is too long"),email:j.z.string().email("Invalid email address"),phone:j.z.string().trim().min(10,"Phone number is required").refine(a=>a.replace(/\D/g,"").length>=10,"Enter a valid phone number"),password:j.z.string().min(8,"Password must be at least 8 characters").max(100,"Password is too long").regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,"Password must contain uppercase, lowercase, and number"),companyName:j.z.string().trim().min(2,"Company name must be at least 2 characters").max(200,"Company name is too long").optional(),terms:j.z.boolean().refine(a=>!0===a,"You must accept the terms and conditions")}),E=j.z.object({email:j.z.string().email("Invalid email address"),password:j.z.string().min(1,"Password is required")});j.z.object({email:j.z.string().email("Invalid email address")}),j.z.object({password:j.z.string().min(8,"Password must be at least 8 characters").max(100,"Password is too long").regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,"Password must contain uppercase, lowercase, and number"),confirmPassword:j.z.string()}).refine(a=>a.password===a.confirmPassword,{message:"Passwords don't match",path:["confirmPassword"]});let F="avatars",G=a=>new Promise(b=>{setTimeout(b,a)}),H=async a=>{for(let b=1;b<=3;b+=1)try{let c=await a();if(c&&"object"==typeof c&&"error"in c&&c.error instanceof g.AuthApiError&&"over_request_rate_limit"===c.error.code){if(3===b)throw c.error;await G(200*b);continue}return c}catch(a){if(a instanceof g.AuthApiError&&"over_request_rate_limit"===a.code&&b<3){await G(200*b);continue}throw a}throw Error("Supabase auth operation failed after retries")};function u(a){let b=a.trim(),c=b.replace(/\D/g,"");return c?b.startsWith("+")||11===c.length&&c.startsWith("1")?`+${c}`:10===c.length?`+1${c}`:`+${c}`:b}let I=(a,b)=>{};async function v(a,b,c){if(!a)throw Error("Supabase client not configured");if(!b.type.startsWith("image/"))throw Error("Avatar must be an image");if(b.size>5242880)throw Error("Avatar must be smaller than 5MB");let d=await b.arrayBuffer(),g=(0,f.extname)(b.name)||".jpg",h=`${c}/profile${g}`,{error:i}=await a.storage.from(F).upload(h,e.Buffer.from(d),{cacheControl:"3600",contentType:b.type||"image/jpeg",upsert:!0});if(i)throw Error(i.message);let{data:{publicUrl:j}}=a.storage.from(F).getPublicUrl(h);return j}let J=()=>{let a=null;return async()=>a||(a=await (0,q.createServiceSupabaseClient)())},K=async()=>{let a=await (0,p.createClient)();if(!a)throw Error("Authentication service is not configured. Please check your environment variables.");return a},L=async({supabase:a,validated:b,normalizedPhone:c,companyName:d})=>{let{data:e,error:f}=await H(()=>a.auth.signUp({email:b.email,password:b.password,options:{data:{name:b.name,phone:c,companyName:d??null},emailRedirectTo:`${m.sendgridConfig.siteUrl}/auth/callback`}}));if(f)throw Error(f.message);if(!e.user)throw Error("Failed to create user account");return e},M=async({ensureServiceSupabase:a,userId:b,normalizedPhone:c,name:d,companyName:e,avatarFile:f})=>{let g=null;if(f)try{let c=await a();g=await v(c,f,b)}catch(a){I("Avatar upload failed",a)}try{let d=await a(),e={phone:c};if(g&&(e.avatar_url=g),!d)throw Error("Admin client not configured");await d.from("profiles").update(e).eq("id",b)}catch(a){I("Failed to update user profile",a)}if(g)try{let f=await a();if(!f)throw Error("Admin client not configured");await f.auth.admin.updateUserById(b,{user_metadata:{name:d,phone:c,companyName:e??null,avatarUrl:g}})}catch(a){I("Failed to sync avatar metadata",a)}},N=async({email:a,name:b,requiresConfirmation:c,userId:d})=>{if(c){let{token:c,expiresAt:e}=await (0,l.createEmailVerificationToken)(a,d,24),f=`${m.sendgridConfig.siteUrl}/auth/verify-email?token=${c}`,g=await (0,r.sendEmailVerification)(a,{name:b,verificationUrl:f});return g.success||I("Failed to send verification email",g.error),{success:!0,data:{requiresEmailConfirmation:!0,message:"Account created! Please check your email to verify your account.",expiresAt:e.toISOString()}}}let e=await (0,r.sendWelcomeEmail)(a,{name:b,loginUrl:`${m.sendgridConfig.siteUrl}/dashboard/welcome`});return e.success||I("Failed to send welcome email",e.error),null},O=async a=>{let{data:{user:b}}=await H(()=>a.auth.getUser());if(!b)throw Error("You must be signed in to complete your profile.");return b},P=async({ensureServiceSupabase:a,avatarFile:b,userId:c,fallbackAvatar:d})=>{if(!b)return d;try{let d=await a();return await v(d,b,c)}catch(a){return I("Avatar upload failed",a),d}},Q=async({ensureServiceSupabase:a,userId:b,name:c,normalizedPhone:d,avatarUrl:e})=>{let f={};if(c&&(f.name=c),d&&(f.phone=d),e&&(f.avatar=e),0===Object.keys(f).length)return null;try{let f=await a();if(!f)throw Error("Admin client not configured");let{error:g}=await f.from("profiles").update({full_name:c||void 0,phone:d||void 0,avatar_url:e||void 0}).eq("id",b);if(g)return I("Failed to update user profile",g),{success:!1,error:`Failed to update your profile: ${g.message}`}}catch(a){return I("Failed to update user profile",a),{success:!1,error:"Failed to update your profile. Please try again."}}return null},R=async({ensureServiceSupabase:a,userId:b,name:c,normalizedPhone:d,avatarUrl:e,existingMetadata:f})=>{if(c||d||e)try{let g=await a(),h={...f};if(c&&(h.name=c),d&&(h.phone=d),e&&(h.avatarUrl=e),!g)throw Error("Admin client not configured");await g.auth.admin.updateUserById(b,{user_metadata:h})}catch(a){I("Failed to sync user metadata",a)}},S=async({ensureServiceSupabase:a,userId:b,name:c,normalizedPhone:d,avatarFile:e,existingAvatar:f,existingMetadata:g})=>{let h=await P({ensureServiceSupabase:a,avatarFile:e,userId:b,fallbackAvatar:f}),i=await Q({ensureServiceSupabase:a,userId:b,name:c,normalizedPhone:d,avatarUrl:h});return i||(await R({ensureServiceSupabase:a,userId:b,name:c,normalizedPhone:d,avatarUrl:h,existingMetadata:g}),null)},T=async({ensureServiceSupabase:a,userId:b})=>{let c=await a();if(!c)throw Error("Admin client not configured");let{data:d}=await c.from("company_memberships").select("company_id").eq("user_id",b).eq("status","active").limit(1).maybeSingle();return d?"/dashboard":"/dashboard/welcome"};async function w(a){try{let b,c,d,e,f,g,j=(b=a.get("companyName"),c="string"==typeof b&&b.trim().length>0?b:void 0,d={name:a.get("name")??"",email:a.get("email")??"",phone:a.get("phone")??"",password:a.get("password")??"",companyName:c,terms:"on"===a.get("terms")||"true"===a.get("terms")},e=D.parse(d),g=(f=a.get("avatar"))instanceof File&&f.size>0?f:null,{validated:e,normalizedPhone:u(e.phone),companyName:e.companyName?.trim()||void 0,avatarFile:g});await (0,o.checkRateLimit)(j.validated.email,o.authRateLimiter);let k=await K(),l=await L({supabase:k,validated:j.validated,normalizedPhone:j.normalizedPhone,companyName:j.companyName}),m=l.user?.id;if(!m)throw Error("Failed to create user account");let n=J();await M({ensureServiceSupabase:n,userId:m,normalizedPhone:j.normalizedPhone,name:j.validated.name,companyName:j.companyName,avatarFile:j.avatarFile});let p=await N({email:j.validated.email,name:j.validated.name,requiresConfirmation:!l.session,userId:m});if(p)return p;(0,h.revalidatePath)("/","layout"),(0,i.redirect)("/dashboard")}catch(a){if(a instanceof j.z.ZodError)return{success:!1,error:a.issues[0]?.message||"Validation error"};if(a instanceof Error&&"NEXT_REDIRECT"!==a.message)return{success:!1,error:a.message};throw a}}async function x(a){try{let b,c,d,e,f=await K(),g=await O(f),j=(c=(b=a.get("avatar"))instanceof File&&b.size>0?b:null,d=a.get("name")??null,e=a.get("phone")??null,{name:d,normalizedPhone:(a=>{if(!a)return null;if(a.replace(/\D/g,"").length<10)throw Error("Please enter a valid phone number with at least 10 digits.");return u(a)})(e),avatarFile:c}),k=J(),l=await S({ensureServiceSupabase:k,userId:g.id,name:j.name,normalizedPhone:j.normalizedPhone,avatarFile:j.avatarFile,existingAvatar:g.user_metadata?.avatar_url||g.user_metadata?.picture||null,existingMetadata:g.user_metadata});if(l)return l;let m=await T({ensureServiceSupabase:k,userId:g.id}).catch(a=>(I("Error checking company status",a),"/welcome"));(0,h.revalidatePath)("/","layout"),(0,i.redirect)(m)}catch(a){if(a instanceof j.z.ZodError)return{success:!1,error:a.issues[0]?.message||"Validation error"};if(a instanceof Error&&"NEXT_REDIRECT"!==a.message)return{success:!1,error:a.message};throw a}}async function y(a){try{let b={email:a.get("email"),password:a.get("password")},c=E.parse(b);try{await (0,o.checkRateLimit)(c.email,o.authRateLimiter)}catch(a){if(a instanceof o.RateLimitError)return{success:!1,error:a.message};throw a}let d=await (0,p.createClient)();if(!d)return{success:!1,error:"Authentication service is not configured. Please check your environment variables."};let{data:e,error:f}=await H(()=>d.auth.signInWithPassword({email:c.email,password:c.password}));if(f)return{success:!1,error:f.message};if(!e.session)return{success:!1,error:"Failed to create session. Please try again."};(0,h.revalidatePath)("/","layout"),(0,i.redirect)("/dashboard")}catch(a){if(a instanceof j.z.ZodError)return{success:!1,error:a.issues[0]?.message||"Validation error"};if(a instanceof g.AuthUnknownError)return console.error("AuthUnknownError during sign in:",a),{success:!1,error:"Unable to connect to authentication service. Please check your internet connection and try again."};if(a instanceof Error&&"NEXT_REDIRECT"!==a.message)return console.error("Sign in error:",a),{success:!1,error:a.message};throw a}}async function z(){try{let a=await (0,p.createClient)();if(!a)return{success:!1,error:"Authentication service is not configured."};let{error:b}=await H(()=>a.auth.signOut());if(b)return{success:!1,error:b.message};await (0,n.clearCSRFToken)(),await (0,k.clearActiveCompany)(),(0,h.revalidatePath)("/","layout"),(0,i.redirect)("/login")}catch(a){if(a instanceof Error&&"NEXT_REDIRECT"!==a.message)return{success:!1,error:a.message};throw a}}async function A(a){try{let b=await (0,p.createClient)();if(!b)return{success:!1,error:"Authentication service is not configured."};let{data:c,error:d}=await H(()=>b.auth.signInWithOAuth({provider:a,options:{redirectTo:"http://localhost:3000/auth/callback"}}));if(d)return{success:!1,error:d.message};return c.url&&(0,i.redirect)(c.url),{success:!0}}catch(a){if(a instanceof Error&&"NEXT_REDIRECT"!==a.message)return{success:!1,error:a.message};throw a}}async function B(a){try{let b=await (0,l.verifyAndConsumeToken)(a,"email_verification");if(!b)return{success:!1,error:"Invalid or expired verification link. Please request a new one."};if(!await (0,p.createClient)())return{success:!1,error:"Authentication service is not configured."};if(b.userId){let a=await (0,r.sendWelcomeEmail)(b.email,{name:((a,b)=>{if(a&&"object"==typeof a){let c=a[b];if("string"==typeof c)return c}})(b.metadata,"name")||"User",loginUrl:`${m.sendgridConfig.siteUrl}/login`});a.success||I("Failed to send welcome email",a.error)}return{success:!0,data:{message:"Email verified successfully! You can now sign in.",email:b.email}}}catch(a){return I("Error verifying email",a),{success:!1,error:a instanceof Error?a.message:"Failed to verify email"}}}async function C(){try{let{getActiveCompanyId:b}=await a.A(37652),c=await b();if(!c)return{success:!1,error:"No active company found"};return{success:!0,companyId:c}}catch(a){return console.error("Error getting company ID:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}(0,s.ensureServerEntryExports)([w,x,y,z,A,B,C]),(0,d.registerServerReference)(w,"40a077d417fa2b11d683f07ec8bb2ca3c9c655c334",null),(0,d.registerServerReference)(x,"400b5913384a41b843ca003dc0a74cea0e477916c8",null),(0,d.registerServerReference)(y,"408e8fc1db798842edf6c24a18a2cd1740e566d283",null),(0,d.registerServerReference)(z,"00a228ba285079c20ec6c715bf57b47a3f7e51fdd8",null),(0,d.registerServerReference)(A,"40d94f3b8b55439595538e1778fa2eae06491ea7d1",null),(0,d.registerServerReference)(B,"4018bd1859a5dbb4fc151daa2bafdede7ef34238b3",null),(0,d.registerServerReference)(C,"004a65e68193c806a3cb2c2358d8e8dba07a581a1a",null),a.s(["completeProfile",()=>x,"getCompanyIdAction",()=>C,"signIn",()=>y,"signInWithOAuth",()=>A,"signOut",()=>z,"signUp",()=>w,"verifyEmail",()=>B]),c()}catch(a){c(a)}},!1)];

//# sourceMappingURL=_7802c23d._.js.map