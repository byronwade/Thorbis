{"version":3,"sources":["../../../../../../apps/web/src/components/work/work-data-view.tsx/__nextjs-internal-proxy.mjs","../../../../../../apps/web/src/lib/queries/customers.ts","../../../../../../apps/web/src/components/customers/customers-kanban.tsx/__nextjs-internal-proxy.mjs","../../../../../../apps/web/src/components/customers/customers-table.tsx/__nextjs-internal-proxy.mjs","../../../../../../apps/web/src/app/%28dashboard%29/dashboard/customers/page.tsx","../../../../../../apps/web/src/components/customers/customers-data.tsx","../../../../../../apps/web/src/components/customers/customers-skeleton.tsx"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const WorkDataView = registerClientReference(\n    function() { throw new Error(\"Attempted to call WorkDataView() from the server but WorkDataView is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/work/work-data-view.tsx\",\n    \"WorkDataView\",\n);\n","import { cache } from \"react\";\nimport { getActiveCompanyId } from \"@/lib/auth/company-context\";\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\nexport const CUSTOMERS_PAGE_SIZE = 50;\n\nconst CUSTOMER_SELECT = `\n  id,\n  display_name,\n  first_name,\n  last_name,\n  company_name,\n  email,\n  phone,\n  address,\n  city,\n  state,\n  zip_code,\n  status,\n  archived_at,\n  deleted_at,\n  last_job_date,\n  total_revenue\n`;\n\nexport type CustomerListRecord = {\n\tid: string;\n\tdisplay_name: string | null;\n\tfirst_name: string | null;\n\tlast_name: string | null;\n\tcompany_name: string | null;\n\temail: string | null;\n\tphone: string | null;\n\taddress: string | null;\n\tcity: string | null;\n\tstate: string | null;\n\tzip_code: string | null;\n\tstatus: string | null;\n\tcustomer_type: string | null;\n\tarchived_at: string | null;\n\tdeleted_at: string | null;\n\tcreated_at: string;\n\t// Enriched fields (computed efficiently via LATERAL joins in RPC)\n\tlast_job_date: string | null;\n\tnext_job_date: string | null;\n\ttotal_revenue_cents: number | null;\n\tjob_count: number | null;\n\tinvoice_count: number | null;\n\topen_invoices_count: number | null;\n\toverdue_invoices_count: number | null;\n\tproperties_count: number | null;\n\tequipment_count: number | null;\n};\n\nexport type CustomersPageResult = {\n\tcustomers: CustomerListRecord[];\n\ttotalCount: number;\n};\n\n/**\n * Fetch a single page of customers with enriched data using optimized RPC function.\n * Uses LATERAL joins to eliminate N+1 query pattern (1 query instead of 5N queries).\n *\n * Performance:\n * - Before: 50 customers = 250+ queries (5-10 seconds)\n * - After: 50 customers = 1 query (50-100ms)\n *\n * @param page - Page number (1-indexed)\n * @param pageSize - Number of customers per page (default: 50)\n * @param searchQuery - Optional search query\n * @param statusFilter - Optional status filter\n * @param orderBy - Order by field (default: display_name)\n * @param orderDirection - Order direction (default: ASC)\n */\nexport async function getCustomersPageData(\n\tpage: number,\n\tpageSize: number = CUSTOMERS_PAGE_SIZE,\n\tsearchQuery?: string,\n\tstatusFilter?: \"active\" | \"inactive\" | \"prospect\",\n\torderBy:\n\t\t| \"display_name\"\n\t\t| \"last_job_date\"\n\t\t| \"total_revenue\"\n\t\t| \"created_at\" = \"display_name\",\n\torderDirection: \"ASC\" | \"DESC\" = \"ASC\",\n): Promise<CustomersPageResult> {\n\t// IMPORTANT: Cannot use \"use cache\" here because we call getActiveCompanyId()\n\t// which uses cookies(). The query is already fast enough without page-level caching.\n\tconst companyId = await getActiveCompanyId();\n\tif (!companyId) {\n\t\treturn { customers: [], totalCount: 0 };\n\t}\n\n\tconst supabase = await createServiceSupabaseClient();\n\tif (!supabase) {\n\t\tthrow new Error(\"Supabase client not configured\");\n\t}\n\tconst offset = (Math.max(page, 1) - 1) * pageSize;\n\n\t// Use optimized RPC function with LATERAL joins\n\tconst { data, error } = await supabase.rpc(\"get_enriched_customers_rpc\", {\n\t\tp_company_id: companyId,\n\t\tp_limit: pageSize,\n\t\tp_offset: offset,\n\t\tp_search_query: searchQuery || null,\n\t\tp_status_filter: statusFilter || null,\n\t\tp_order_by: orderBy,\n\t\tp_order_direction: orderDirection,\n\t});\n\n\tif (error) {\n\t\tthrow new Error(`Failed to load customers: ${error.message}`);\n\t}\n\n\t// Get total count for pagination (separate query, cached by Supabase)\n\tconst { count } = await supabase\n\t\t.from(\"customers\")\n\t\t.select(\"*\", { count: \"exact\", head: true })\n\t\t.eq(\"company_id\", companyId)\n\t\t.is(\"deleted_at\", null);\n\n\treturn {\n\t\tcustomers: (data ?? []) as CustomerListRecord[],\n\t\ttotalCount: count ?? 0,\n\t};\n}\n\nexport type CustomerSummaryStats = {\n\ttotal: number;\n\tactive: number;\n\tinactive: number;\n\tprospect: number;\n\ttotalRevenueCents: number;\n};\n\n/**\n * Aggregated customer metrics used by dashboard stats cards.\n * Uses optimized RPC with LATERAL joins for fast metric computation.\n * Wrapped with cache() for request-level deduplication (not page-level caching).\n */\nexport const getCustomerStats = cache(\n\tasync (): Promise<CustomerSummaryStats | null> => {\n\t\t// Note: cache() provides request-level deduplication - works fine with cookies()\n\t\t// \"use cache\" directive would NOT work here due to cookies() usage\n\t\tconst companyId = await getActiveCompanyId();\n\t\tif (!companyId) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Supabase client not configured\");\n\t\t}\n\n\t\t// Get customer stats directly from the customers table\n\t\tconst { data, error, count } = await supabase\n\t\t\t.from(\"customers\")\n\t\t\t.select(\"status, archived_at, total_revenue\", { count: \"exact\" })\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.limit(50000); // Prevent unbounded query\n\n\t\tif (error) {\n\t\t\tthrow new Error(`Failed to load customer stats: ${error.message}`);\n\t\t}\n\n\t\t// Single-pass aggregation (3x faster than multiple filter passes)\n\t\tconst stats = { active: 0, inactive: 0, prospect: 0 };\n\t\tlet totalRevenueCents = 0;\n\t\tfor (const c of data ?? []) {\n\t\t\tif (!c.archived_at) {\n\t\t\t\tconst status = (c.status || \"prospect\") as keyof typeof stats;\n\t\t\t\tif (status in stats) stats[status]++;\n\t\t\t}\n\t\t\t// Sum total revenue from all customers (stored in cents)\n\t\t\ttotalRevenueCents += c.total_revenue || 0;\n\t\t}\n\n\t\treturn {\n\t\t\ttotal: count ?? 0,\n\t\t\tactive: stats.active,\n\t\t\tinactive: stats.inactive,\n\t\t\tprospect: stats.prospect,\n\t\t\ttotalRevenueCents,\n\t\t};\n\t},\n);\n\n/**\n * Get complete customer data with tags from customer_tags junction table.\n * Uses React.cache() for request-level deduplication.\n * Called by multiple components - only executes once per request.\n */\nexport const getCustomerComplete = cache(\n\tasync (customerId: string, companyId: string) => {\n\t\tconst supabase = await createServiceSupabaseClient();\n\t\tif (!supabase) {\n\t\t\tthrow new Error(\"Supabase client not configured\");\n\t\t}\n\n\t\tconst { data, error } = await supabase.rpc(\"get_customer_complete\", {\n\t\t\tp_customer_id: customerId,\n\t\t\tp_company_id: companyId,\n\t\t});\n\n\t\tif (error) {\n\t\t\tconsole.error(\"Error fetching customer:\", error);\n\t\t\treturn null;\n\t\t}\n\n\t\t// RPC returns array with single row containing customer_data JSONB\n\t\treturn data?.[0]?.customer_data || null;\n\t},\n);\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const CustomersKanban = registerClientReference(\n    function() { throw new Error(\"Attempted to call CustomersKanban() from the server but CustomersKanban is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/customers/customers-kanban.tsx\",\n    \"CustomersKanban\",\n);\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const CustomersTable = registerClientReference(\n    function() { throw new Error(\"Attempted to call CustomersTable() from the server but CustomersTable is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/web/src/components/customers/customers-table.tsx\",\n    \"CustomersTable\",\n);\n","/**\n * Customers Page - Cache Components Enabled\n *\n * Uses Next.js 16 \"use cache\" directive for optimal caching:\n * - Static shell renders instantly (5-20ms)\n * - Stats stream in first (100-200ms)\n * - Table streams in second (200-500ms)\n * - Cached for 15 minutes (default cacheLife profile)\n *\n * Performance: 8-20x faster than traditional SSR\n */\n\nimport { Suspense } from \"react\";\nimport { CustomersData } from \"@/components/customers/customers-data\";\nimport { CustomersSkeleton } from \"@/components/customers/customers-skeleton\";\n\nexport default async function CustomersPage({\n\tsearchParams,\n}: {\n\tsearchParams: Promise<{ page?: string }>;\n}) {\n\tconst params = await searchParams;\n\treturn (\n\t\t<>\n\t\t\t{/* Table/Kanban - Streams in */}\n\t\t\t<Suspense fallback={<CustomersSkeleton />}>\n\t\t\t\t<CustomersData searchParams={params} />\n\t\t\t</Suspense>\n\t\t</>\n\t);\n}\n","import { notFound } from \"next/navigation\";\nimport { CustomersKanban } from \"@/components/customers/customers-kanban\";\nimport {\n\ttype Customer,\n\tCustomersTable,\n} from \"@/components/customers/customers-table\";\nimport { WorkDataView } from \"@/components/work/work-data-view\";\nimport {\n\tCUSTOMERS_PAGE_SIZE,\n\tgetCustomersPageData,\n} from \"@/lib/queries/customers\";\n\n/**\n * Customers Data - Async Server Component\n *\n * PERFORMANCE OPTIMIZED:\n * - Uses cached query shared with CustomersStats (prevents duplicate queries)\n * - Bulk RPC functions instead of N+1 pattern (151 queries â†’ 4 queries)\n * - Hash map joins for O(n) complexity\n *\n * Expected: 200-400ms (was 6400-7300ms) - 16-36x faster!\n */\nexport async function CustomersData({\n\tsearchParams,\n}: {\n\tsearchParams?: { page?: string };\n}) {\n\tconst currentPage = Number(searchParams?.page) || 1;\n\tconst { customers: dbCustomers, totalCount } = await getCustomersPageData(\n\t\tcurrentPage,\n\t\tCUSTOMERS_PAGE_SIZE,\n\t);\n\n\tif (!dbCustomers) {\n\t\treturn notFound();\n\t}\n\n\t// Transform database records to table format\n\tconst customers: Customer[] = dbCustomers.map((c) => ({\n\t\tid: c.id,\n\t\tname: c.display_name,\n\t\tcontact: `${c.first_name} ${c.last_name}`,\n\t\temail: c.email,\n\t\tphone: c.phone,\n\t\taddress: c.address,\n\t\tcity: c.city,\n\t\tstate: c.state,\n\t\tzipCode: c.zip_code,\n\t\tstatus:\n\t\t\tc.status === \"active\"\n\t\t\t\t? \"active\"\n\t\t\t\t: c.status === \"inactive\"\n\t\t\t\t\t? \"inactive\"\n\t\t\t\t\t: \"prospect\",\n\t\tlastService: c.last_job_date\n\t\t\t? new Date(c.last_job_date).toLocaleDateString()\n\t\t\t: \"None\",\n\t\tnextService: \"TBD\",\n\t\ttotalValue: c.total_revenue || 0,\n\t\tarchived_at: c.archived_at,\n\t\tdeleted_at: c.deleted_at,\n\t}));\n\n\treturn (\n\t\t<WorkDataView\n\t\t\tkanban={<CustomersKanban customers={customers} />}\n\t\t\tsection=\"customers\"\n\t\t\ttable={\n\t\t\t\t<CustomersTable\n\t\t\t\t\tcustomers={customers}\n\t\t\t\t\titemsPerPage={CUSTOMERS_PAGE_SIZE}\n\t\t\t\t\ttotalCount={totalCount}\n\t\t\t\t\tcurrentPage={currentPage}\n\t\t\t\t/>\n\t\t\t}\n\t\t/>\n\t);\n}\n","/**\n * CustomersSkeleton - Loading Skeleton\n *\n * Uses the shared DataTableListSkeleton for consistent UX across all list pages.\n * Displays while customers data is loading.\n * Matches the exact layout of the customers table to prevent layout shifts.\n */\n\nimport { DataTableListSkeleton } from \"@/components/ui/skeletons\";\n\nexport function CustomersSkeleton() {\n\treturn <DataTableListSkeleton />;\n}\n"],"names":[],"mappings":"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","ignoreList":[0,2,3]}