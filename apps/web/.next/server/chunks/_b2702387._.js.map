{"version":3,"sources":["../../../../../apps/web/src/lib/telnyx/calls.ts","../../../../../apps/web/src/lib/telnyx/config-validator.ts"],"sourcesContent":["/**\n * Telnyx Calls Service - Call Control & Management\n *\n * Production-ready call control with:\n * - Retry logic with exponential backoff\n * - Request timeouts (prevents hanging)\n * - Circuit breaker protection\n * - Structured logging\n *\n * Handles all call-related operations including:\n * - Initiating outbound calls\n * - Answering incoming calls\n * - Call control (mute, hold, transfer)\n * - Call recording\n * - Hangup operations\n */\n\nimport { telnyxLogger } from \"./logger\";\nimport { withRetry } from \"./retry\";\n\nconst TELNYX_API_BASE = \"https://api.telnyx.com/v2\";\n\n// Request timeout for call control operations (15 seconds)\nconst REQUEST_TIMEOUT_MS = 15000;\n\n/**\n * Call control command types\n */\nexport type CallCommand =\n\t| \"answer\"\n\t| \"reject\"\n\t| \"hangup\"\n\t| \"bridge\"\n\t| \"speak\"\n\t| \"gather_using_audio\"\n\t| \"gather_using_speak\"\n\t| \"playback_start\"\n\t| \"playback_stop\"\n\t| \"record_start\"\n\t| \"record_stop\"\n\t| \"send_dtmf\"\n\t| \"transfer\";\n\n/**\n * Call status types from Telnyx webhooks\n */\nexport type CallStatus =\n\t| \"initiated\"\n\t| \"ringing\"\n\t| \"answered\"\n\t| \"active\"\n\t| \"hangup\"\n\t| \"machine_greeting_detected\"\n\t| \"machine_greeting_ended\";\n\n/**\n * Make a direct HTTP request to Telnyx REST API with retry and timeout\n */\nasync function telnyxCallRequest<T>(\n\tendpoint: string,\n\tbody: Record<string, unknown>,\n\toptions?: {\n\t\t/** Operation name for logging */\n\t\toperation?: string;\n\t\t/** Custom timeout in ms (default: 15000) */\n\t\ttimeout?: number;\n\t\t/** Skip retry logic (for time-sensitive operations) */\n\t\tskipRetry?: boolean;\n\t}\n): Promise<{ success: boolean; data?: T; error?: string }> {\n\tconst apiKey = process.env.TELNYX_API_KEY;\n\tif (!apiKey) {\n\t\treturn { success: false, error: \"TELNYX_API_KEY is not configured\" };\n\t}\n\n\tconst operation = options?.operation || endpoint;\n\tconst timeout = options?.timeout ?? REQUEST_TIMEOUT_MS;\n\n\tconst makeRequest = async (): Promise<{ success: boolean; data?: T; error?: string }> => {\n\t\t// Create abort controller for timeout\n\t\tconst controller = new AbortController();\n\t\tconst timeoutId = setTimeout(() => controller.abort(), timeout);\n\n\t\ttry {\n\t\t\ttelnyxLogger.debug(\"Call API request\", {\n\t\t\t\tendpoint,\n\t\t\t\toperation,\n\t\t\t});\n\n\t\t\tconst response = await fetch(`${TELNYX_API_BASE}${endpoint}`, {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify(body),\n\t\t\t\tsignal: controller.signal,\n\t\t\t});\n\n\t\t\tclearTimeout(timeoutId);\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorMessage =\n\t\t\t\t\tresult?.errors?.[0]?.detail ||\n\t\t\t\t\tresult?.errors?.[0] ||\n\t\t\t\t\tresponse.statusText;\n\n\t\t\t\ttelnyxLogger.warn(\"Call API error response\", {\n\t\t\t\t\tendpoint,\n\t\t\t\t\toperation,\n\t\t\t\t\tstatus: response.status,\n\t\t\t\t\terror: errorMessage,\n\t\t\t\t});\n\n\t\t\t\t// Throw for retry logic to catch\n\t\t\t\tconst error = new Error(`Telnyx ${response.status}: ${errorMessage}`);\n\t\t\t\t(error as Error & { statusCode: number }).statusCode = response.status;\n\t\t\t\tthrow error;\n\t\t\t}\n\n\t\t\ttelnyxLogger.debug(\"Call API success\", {\n\t\t\t\tendpoint,\n\t\t\t\toperation,\n\t\t\t});\n\n\t\t\treturn { success: true, data: result.data };\n\t\t} catch (error) {\n\t\t\tclearTimeout(timeoutId);\n\n\t\t\tif (error instanceof Error && error.name === \"AbortError\") {\n\t\t\t\ttelnyxLogger.error(\"Call API timeout\", {\n\t\t\t\t\tendpoint,\n\t\t\t\t\toperation,\n\t\t\t\t\ttimeoutMs: timeout,\n\t\t\t\t});\n\t\t\t\tthrow new Error(`Request timeout after ${timeout}ms`);\n\t\t\t}\n\n\t\t\tthrow error;\n\t\t}\n\t};\n\n\ttry {\n\t\t// Use retry logic unless skipped\n\t\tif (options?.skipRetry) {\n\t\t\treturn await makeRequest();\n\t\t}\n\n\t\treturn await withRetry(makeRequest, {\n\t\t\tendpoint: `calls:${operation}`,\n\t\t\tconfig: {\n\t\t\t\tmaxRetries: 2, // Fewer retries for call operations (time-sensitive)\n\t\t\t\tbaseDelayMs: 500,\n\t\t\t\tmaxDelayMs: 2000,\n\t\t\t},\n\t\t\tonRetry: (attempt, error, delayMs) => {\n\t\t\t\ttelnyxLogger.warn(\"Retrying call API request\", {\n\t\t\t\t\tendpoint,\n\t\t\t\t\toperation,\n\t\t\t\t\tattempt,\n\t\t\t\t\terror: error.message,\n\t\t\t\t\tdelayMs,\n\t\t\t\t});\n\t\t\t},\n\t\t});\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"Call API request failed\", {\n\t\t\tendpoint,\n\t\t\toperation,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Request failed\",\n\t\t};\n\t}\n}\n\n/**\n * Initiate an outbound call\n */\nexport async function initiateCall(params: {\n\tto: string;\n\tfrom: string;\n\tconnectionId: string;\n\twebhookUrl?: string;\n\tansweringMachineDetection?: \"premium\" | \"detect\" | \"disabled\";\n\tcustomHeaders?: Array<{ name: string; value: string }>;\n}) {\n\tconst result = await telnyxCallRequest<{\n\t\tcall_control_id: string;\n\t\tcall_session_id: string;\n\t}>(\n\t\t\"/calls\",\n\t\t{\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t\tconnection_id: params.connectionId,\n\t\t\twebhook_url: params.webhookUrl,\n\t\t\tanswering_machine_detection:\n\t\t\t\tparams.answeringMachineDetection || \"disabled\",\n\t\t\tcustom_headers: params.customHeaders,\n\t\t},\n\t\t{ operation: \"initiate\" }\n\t);\n\n\tif (!(result.success && result.data)) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: result.error || \"Failed to initiate call\",\n\t\t};\n\t}\n\n\treturn {\n\t\tsuccess: true,\n\t\tcallControlId: result.data.call_control_id,\n\t\tcallSessionId: result.data.call_session_id,\n\t\tdata: result.data,\n\t};\n}\n\n/**\n * Answer an incoming call\n */\nexport async function answerCall(params: {\n\tcallControlId: string;\n\twebhookUrl?: string;\n\tclientState?: string;\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/answer`,\n\t\t{\n\t\t\twebhook_url: params.webhookUrl,\n\t\t\tclient_state: params.clientState,\n\t\t},\n\t\t{ operation: \"answer\", skipRetry: true } // Time-sensitive, no retry\n\t);\n}\n\n/**\n * Reject an incoming call\n */\nexport async function rejectCall(params: {\n\tcallControlId: string;\n\tcause?: \"CALL_REJECTED\" | \"USER_BUSY\";\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/reject`,\n\t\t{ cause: params.cause || \"CALL_REJECTED\" },\n\t\t{ operation: \"reject\", skipRetry: true }\n\t);\n}\n\n/**\n * Hangup an active call\n */\nexport async function hangupCall(params: { callControlId: string }) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/hangup`,\n\t\t{},\n\t\t{ operation: \"hangup\" }\n\t);\n}\n\n/**\n * Start call recording\n */\nexport async function startRecording(params: {\n\tcallControlId: string;\n\tformat?: \"wav\" | \"mp3\";\n\tchannels?: \"single\" | \"dual\";\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/record_start`,\n\t\t{\n\t\t\tformat: params.format || \"mp3\",\n\t\t\tchannels: params.channels || \"single\",\n\t\t},\n\t\t{ operation: \"record_start\" }\n\t);\n}\n\n/**\n * Stop call recording\n */\nexport async function stopRecording(params: { callControlId: string }) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/record_stop`,\n\t\t{},\n\t\t{ operation: \"record_stop\" }\n\t);\n}\n\n/**\n * Play audio to the call\n */\nexport async function playAudio(params: {\n\tcallControlId: string;\n\taudioUrl: string;\n\tloop?: number;\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/playback_start`,\n\t\t{\n\t\t\taudio_url: params.audioUrl,\n\t\t\tloop: params.loop,\n\t\t},\n\t\t{ operation: \"playback_start\" }\n\t);\n}\n\n/**\n * Speak text to the call using text-to-speech\n */\nexport async function speakText(params: {\n\tcallControlId: string;\n\ttext: string;\n\tvoice?: \"male\" | \"female\";\n\tlanguage?: string;\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/speak`,\n\t\t{\n\t\t\tpayload: params.text,\n\t\t\tvoice: params.voice || \"female\",\n\t\t\tlanguage: params.language || \"en-US\",\n\t\t},\n\t\t{ operation: \"speak\" }\n\t);\n}\n\n/**\n * Transfer a call to another number\n */\nexport async function transferCall(params: {\n\tcallControlId: string;\n\tto: string;\n\tfrom: string;\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/transfer`,\n\t\t{\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t},\n\t\t{ operation: \"transfer\" }\n\t);\n}\n\n/**\n * Send DTMF tones (phone keypad presses)\n */\nexport async function sendDTMF(params: {\n\tcallControlId: string;\n\tdigits: string;\n}) {\n\treturn telnyxCallRequest(\n\t\t`/calls/${params.callControlId}/actions/send_dtmf`,\n\t\t{ digits: params.digits },\n\t\t{ operation: \"send_dtmf\" }\n\t);\n}\n\n/**\n * Gather user input using audio prompts\n */\nexport async function gatherInput(params: {\n\tcallControlId: string;\n\taudioUrl?: string;\n\tspeakText?: string;\n\tvalidDigits?: string;\n\tmaxDigits?: number;\n\tminDigits?: number;\n\ttimeout?: number;\n\tterminatingDigit?: string;\n}) {\n\tconst useAudio = !!params.audioUrl;\n\tconst endpoint = useAudio\n\t\t? `/calls/${params.callControlId}/actions/gather_using_audio`\n\t\t: `/calls/${params.callControlId}/actions/gather_using_speak`;\n\n\tconst body = useAudio\n\t\t? {\n\t\t\t\taudio_url: params.audioUrl,\n\t\t\t\tvalid_digits: params.validDigits,\n\t\t\t\tmax: params.maxDigits,\n\t\t\t\tmin: params.minDigits,\n\t\t\t\ttimeout_millis: params.timeout,\n\t\t\t\tterminating_digit: params.terminatingDigit || \"#\",\n\t\t\t}\n\t\t: {\n\t\t\t\tpayload: params.speakText || \"\",\n\t\t\t\tvalid_digits: params.validDigits,\n\t\t\t\tmax: params.maxDigits,\n\t\t\t\tmin: params.minDigits,\n\t\t\t\ttimeout_millis: params.timeout,\n\t\t\t\tterminating_digit: params.terminatingDigit || \"#\",\n\t\t\t};\n\n\treturn telnyxCallRequest(endpoint, body, {\n\t\toperation: useAudio ? \"gather_audio\" : \"gather_speak\",\n\t});\n}\n","/**\n * Telnyx Configuration Validator\n *\n * Validates all required Telnyx environment variables and configuration.\n * Provides clear error messages for missing or invalid configuration.\n */\n\nimport { TELNYX_CONFIG } from \"./client\";\n\nexport type ValidationResult = {\n\tvalid: boolean;\n\terrors: string[];\n\twarnings: string[];\n\tconfig: {\n\t\tapiKey: boolean;\n\t\tconnectionId: boolean;\n\t\tmessagingProfileId: boolean;\n\t\twebhookSecret: boolean;\n\t\tpublicKey: boolean;\n\t\tsiteUrl: boolean;\n\t};\n};\n\nfunction isLocalUrl(url: string): boolean {\n\tconst lowered = url.toLowerCase();\n\treturn (\n\t\tlowered.includes(\"localhost\") ||\n\t\tlowered.includes(\"127.0.0.1\") ||\n\t\tlowered.includes(\"0.0.0.0\") ||\n\t\tlowered.endsWith(\".local\") ||\n\t\tlowered.includes(\"://local\")\n\t);\n}\n\nfunction getBaseAppUrl(): string | undefined {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\tfor (const candidate of candidates) {\n\t\tif (candidate && candidate.trim()) {\n\t\t\tconst trimmed = candidate.trim();\n\t\t\tif (!isLocalUrl(trimmed)) {\n\t\t\t\treturn trimmed.startsWith(\"http\") ? trimmed : `https://${trimmed}`;\n\t\t\t}\n\t\t}\n\t}\n\n\tconst vercelUrl = process.env.VERCEL_URL;\n\tif (vercelUrl && !isLocalUrl(vercelUrl)) {\n\t\treturn vercelUrl.startsWith(\"http\") ? vercelUrl : `https://${vercelUrl}`;\n\t}\n\n\treturn undefined;\n}\n\n/**\n * Validate all Telnyx configuration\n */\nexport function validateTelnyxConfig(): ValidationResult {\n\tconst errors: string[] = [];\n\tconst warnings: string[] = [];\n\tconst config = {\n\t\tapiKey: false,\n\t\tconnectionId: false,\n\t\tmessagingProfileId: false,\n\t\twebhookSecret: false,\n\t\tpublicKey: false,\n\t\tsiteUrl: false,\n\t};\n\n\t// Check API Key (required)\n\tif (!TELNYX_CONFIG.apiKey || TELNYX_CONFIG.apiKey.trim() === \"\") {\n\t\terrors.push(\n\t\t\t\"TELNYX_API_KEY is not set. This is required for all Telnyx operations.\",\n\t\t);\n\t} else if (TELNYX_CONFIG.apiKey.length < 20) {\n\t\terrors.push(\n\t\t\t\"TELNYX_API_KEY appears to be invalid (too short). Get your API key from https://portal.telnyx.com\",\n\t\t);\n\t} else {\n\t\tconfig.apiKey = true;\n\t}\n\n\t// Check Connection ID (required for voice calls)\n\tif (!TELNYX_CONFIG.connectionId || TELNYX_CONFIG.connectionId.trim() === \"\") {\n\t\terrors.push(\n\t\t\t\"NEXT_PUBLIC_TELNYX_CONNECTION_ID is not set. This is required for phone calls. Get it from Telnyx Portal → Mission Control → Connections.\",\n\t\t);\n\t} else {\n\t\tconfig.connectionId = true;\n\t}\n\n\t// Check Messaging Profile ID (required for SMS)\n\tif (\n\t\t!TELNYX_CONFIG.messagingProfileId ||\n\t\tTELNYX_CONFIG.messagingProfileId.trim() === \"\"\n\t) {\n\t\terrors.push(\n\t\t\t\"TELNYX_DEFAULT_MESSAGING_PROFILE_ID or NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID is not set. This is required for SMS/MMS. Run getDefaultMessagingProfile() to fetch it automatically from Telnyx.\",\n\t\t);\n\t} else {\n\t\tconfig.messagingProfileId = true;\n\t}\n\n\t// Check Webhook Secret (recommended for production)\n\tif (\n\t\t!TELNYX_CONFIG.webhookSecret ||\n\t\tTELNYX_CONFIG.webhookSecret.trim() === \"\"\n\t) {\n\t\twarnings.push(\n\t\t\t\"TELNYX_WEBHOOK_SECRET is not set. Webhook signature verification will be disabled. Set this in production for security.\",\n\t\t);\n\t} else {\n\t\tconfig.webhookSecret = true;\n\t}\n\n\t// Check Public Key (recommended for production)\n\tif (!TELNYX_CONFIG.publicKey || TELNYX_CONFIG.publicKey.trim() === \"\") {\n\t\twarnings.push(\n\t\t\t\"TELNYX_PUBLIC_KEY is not set. Webhook signature verification may not work correctly. Get it from Telnyx Portal → API Keys.\",\n\t\t);\n\t} else {\n\t\tconfig.publicKey = true;\n\t}\n\n\t// Check Site URL (required for webhooks)\n\tconst siteUrl = getBaseAppUrl();\n\tif (!siteUrl) {\n\t\terrors.push(\n\t\t\t\"NEXT_PUBLIC_SITE_URL or SITE_URL is not set to a valid production URL. This is required for webhook callbacks. Set it to your production domain (e.g., https://thorbis.co).\",\n\t\t);\n\t} else if (isLocalUrl(siteUrl)) {\n\t\tconst isProduction =\n\t\t\tprocess.env.VERCEL_ENV === \"production\" ||\n\t\t\tprocess.env.DEPLOYMENT_ENV === \"production\";\n\t\tif (isProduction) {\n\t\t\terrors.push(\n\t\t\t\t`Site URL is set to localhost (${siteUrl}) but you're in production. Set NEXT_PUBLIC_SITE_URL to your production domain.`,\n\t\t\t);\n\t\t} else {\n\t\t\twarnings.push(\n\t\t\t\t`Site URL is set to localhost (${siteUrl}). This will not work in production.`,\n\t\t\t);\n\t\t}\n\t} else {\n\t\tconfig.siteUrl = true;\n\t}\n\n\treturn {\n\t\tvalid: errors.length === 0,\n\t\terrors,\n\t\twarnings,\n\t\tconfig,\n\t};\n}\n\n/**\n * Validate configuration for SMS operations\n */\nexport async function validateSmsConfig(): Promise<{\n\tvalid: boolean;\n\terror?: string;\n\tsuggestedProfileId?: string;\n}> {\n\tconst validation = validateTelnyxConfig();\n\n\tif (!validation.config.apiKey) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: \"TELNYX_API_KEY is required for SMS operations\",\n\t\t};\n\t}\n\n\tif (!validation.config.messagingProfileId) {\n\t\t// Try to fetch messaging profile automatically\n\t\ttry {\n\t\t\tconst { getDefaultMessagingProfile } = await import(\n\t\t\t\t\"./messaging-profile-fetcher\"\n\t\t\t);\n\t\t\tconst profileResult = await getDefaultMessagingProfile();\n\n\t\t\tif (profileResult.success && profileResult.profile) {\n\t\t\t\treturn {\n\t\t\t\t\tvalid: false,\n\t\t\t\t\terror:\n\t\t\t\t\t\t\"TELNYX_DEFAULT_MESSAGING_PROFILE_ID is required for SMS operations.\",\n\t\t\t\t\tsuggestedProfileId: profileResult.profile.id,\n\t\t\t\t};\n\t\t\t}\n\t\t} catch {\n\t\t\t// If fetch fails, return generic error\n\t\t}\n\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"TELNYX_DEFAULT_MESSAGING_PROFILE_ID is required for SMS operations. Run getDefaultMessagingProfile() to fetch it automatically from Telnyx.\",\n\t\t};\n\t}\n\n\tif (!validation.config.siteUrl) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be set to a valid production URL for SMS webhooks.\",\n\t\t};\n\t}\n\n\treturn { valid: true };\n}\n\n/**\n * Validate configuration for voice call operations\n */\nexport function validateCallConfig(): {\n\tvalid: boolean;\n\terror?: string;\n} {\n\tconst validation = validateTelnyxConfig();\n\n\tif (!validation.config.apiKey) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: \"TELNYX_API_KEY is required for phone calls\",\n\t\t};\n\t}\n\n\tif (!validation.config.connectionId) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_TELNYX_CONNECTION_ID is required for phone calls. Get it from Telnyx Portal → Mission Control → Connections.\",\n\t\t};\n\t}\n\n\tif (!validation.config.siteUrl) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be set to a valid production URL for call webhooks.\",\n\t\t};\n\t}\n\n\treturn { valid: true };\n}\n\n/**\n * Get formatted error message for display to users\n */\nfunction getFormattedErrorMessage(validation: ValidationResult): string {\n\tif (validation.valid) {\n\t\treturn \"\";\n\t}\n\n\tconst lines = [\"Telnyx configuration errors:\"];\n\tvalidation.errors.forEach((error, index) => {\n\t\tlines.push(`${index + 1}. ${error}`);\n\t});\n\n\tif (validation.warnings.length > 0) {\n\t\tlines.push(\"\");\n\t\tlines.push(\"Warnings:\");\n\t\tvalidation.warnings.forEach((warning, index) => {\n\t\t\tlines.push(`${index + 1}. ${warning}`);\n\t\t});\n\t}\n\n\treturn lines.join(\"\\n\");\n}\n"],"names":[],"mappings":"wCAiBA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAwCA,eAAe,EACd,CAAgB,CAChB,CAA6B,CAC7B,CAOC,EAED,IAAM,EAAS,QAAQ,GAAG,CAAC,cAAc,CACzC,GAAI,CAAC,EACJ,MADY,AACL,CAAE,SAAS,EAAO,MAAO,kCAAmC,EAGpE,IAAM,EAAY,GAAS,WAAa,EAClC,EAAU,GAAS,SArDC,EAqDU,GAE9B,EAAc,UAEnB,IAAM,EAAa,IAAI,gBACjB,EAAY,WAAW,IAAM,EAAW,KAAK,GAAI,GAEvD,GAAI,CACH,EAAA,YAAY,CAAC,KAAK,CAAC,mBAAoB,UACtC,YACA,CACD,GAEA,IAAM,EAAW,MAAM,MAAM,GAAG,yBAAkB,GAAU,CAAE,CAC7D,OAAQ,OACR,QAAS,CACR,cAAe,CAAC,OAAO,EAAE,EAAA,CAAQ,CACjC,eAAgB,kBACjB,EACA,KAAM,KAAK,SAAS,CAAC,GACrB,OAAQ,EAAW,MAAM,AAC1B,GAEA,aAAa,GAEb,IAAM,EAAS,MAAM,EAAS,IAAI,GAElC,GAAI,CAAC,EAAS,EAAE,CAAE,CACjB,IAAM,EACL,GAAQ,QAAQ,CAAC,EAAE,EAAE,QACrB,GAAQ,QAAQ,CAAC,EAAE,EACnB,EAAS,UAAU,CAEpB,EAAA,YAAY,CAAC,IAAI,CAAC,0BAA2B,CAC5C,qBACA,EACA,OAAQ,EAAS,MAAM,CACvB,MAAO,CACR,GAGA,IAAM,EAAQ,AAAI,MAAM,CAAC,OAAO,EAAE,EAAS,MAAM,CAAC,EAAE,EAAE,EAAA,CAAc,CAEpE,OADC,EAAyC,UAAU,CAAG,EAAS,MAAM,CAChE,CACP,CAOA,OALA,EAAA,YAAY,CAAC,KAAK,CAAC,mBAAoB,UACtC,YACA,CACD,GAEO,CAAE,SAAS,EAAM,KAAM,EAAO,IAAI,AAAC,CAC3C,CAAE,MAAO,EAAO,CAGf,GAFA,aAAa,GAET,aAAiB,OAAS,AAAe,cAAc,GAAvB,IAAI,CAMvC,MALA,EAAA,YAAY,CAAC,KAAK,CAAC,mBAAoB,UACtC,YACA,EACA,UAAW,CACZ,GACU,AAAJ,MAAU,CAAC,sBAAsB,EAAE,EAAQ,EAAE,CAAC,CAGrD,OAAM,CACP,CACD,EAEA,GAAI,CAEH,GAAI,GAAS,UACZ,CADuB,MAChB,MAAM,IAGd,OAAO,MAAM,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,EAAa,CACnC,SAAU,CAAC,MAAM,EAAE,EAAA,CAAW,CAC9B,OAAQ,CACP,WAAY,EACZ,YAAa,IACb,WAAY,GACb,EACA,QAAS,CAAC,EAAS,EAAO,KACzB,EAAA,YAAY,CAAC,IAAI,CAAC,4BAA6B,UAC9C,YACA,UACA,EACA,MAAO,EAAM,OAAO,SACpB,CACD,EACD,CACD,EACD,CAAE,MAAO,EAAO,CAOf,OANA,EAAA,YAAY,CAAC,KAAK,CAAC,0BAA2B,UAC7C,YACA,EACA,MAAO,aAAiB,MAAQ,EAAM,OAAO,CAAG,eACjD,GAEO,CACN,QAAS,GACT,MAAO,aAAiB,MAAQ,EAAM,OAAO,CAAG,gBACjD,CACD,CACD,CAKO,eAAe,EAAa,CAOlC,EACA,IAAM,EAAS,MAAM,EAIpB,SACA,CACC,GAAI,EAAO,EAAE,CACb,KAAM,EAAO,IAAI,CACjB,cAAe,EAAO,YAAY,CAClC,YAAa,EAAO,UAAU,CAC9B,4BACC,EAAO,yBAAyB,EAAI,WACrC,eAAgB,EAAO,aAAa,AACrC,EACA,CAAE,UAAW,UAAW,UAGzB,AAAM,EAAO,EAAT,CAAC,IAAe,EAAI,EAAO,IAAI,CAO5B,CACN,CARqC,OAQ5B,GACT,cAAe,EAAO,IAAI,CAAC,eAAe,CAC1C,cAAe,EAAO,IAAI,CAAC,eAAe,CAC1C,KAAM,EAAO,IAAI,AAClB,EAXQ,CACN,SAAS,EACT,MAAO,EAAO,KAAK,EAAI,yBACxB,CASF,CAKO,eAAe,EAAW,CAIhC,EACA,OAAO,EACN,CAAC,OAAO,EAAE,EAAO,aAAa,CAAC,eAAe,CAAC,CAC/C,CACC,YAAa,EAAO,UAAU,CAC9B,aAAc,EAAO,WAAW,AACjC,EACA,CAAE,UAAW,SAAU,WAAW,CAAK,EAAE,AAE3C,CAKO,eAAe,EAAW,CAGhC,EACA,MAXqE,CAW9D,EACN,CAAC,OAAO,EAAE,EAAO,aAAa,CAAC,eAAe,CAAC,CAC/C,CAAE,MAAO,EAAO,KAAK,EAAI,eAAgB,EACzC,CAAE,UAAW,SAAU,WAAW,CAAK,EAEzC,CAKO,eAAe,EAAW,CAAiC,EACjE,OAAO,EACN,CAAC,OAAO,EAAE,EAAO,aAAa,CAAC,eAAe,CAAC,CAC/C,CAAC,EACD,CAAE,UAAW,QAAS,EAExB,CAKO,eAAe,EAAe,CAIpC,EACA,OAAO,EACN,CAAC,OAAO,EAAE,EAAO,aAAa,CAAC,qBAAqB,CAAC,CACrD,CACC,OAAQ,EAAO,MAAM,EAAI,MACzB,SAAU,EAAO,QAAQ,EAAI,QAC9B,EACA,CAAE,UAAW,cAAe,EAE9B,CAKO,eAAe,EAAc,CAAiC,EACpE,OAAO,EACN,CAAC,OAAO,EAAE,EAAO,aAAa,CAAC,oBAAoB,CAAC,CACpD,CAAC,EACD,CAAE,UAAW,aAAc,EAE7B,CAKO,eAAe,EAAU,CAI/B,EACA,OAAO,EACN,CAAC,OAAO,EAAE,EAAO,aAAa,CAAC,uBAAuB,CAAC,CACvD,CACC,UAAW,EAAO,QAAQ,CAC1B,KAAM,EAAO,IAAI,AAClB,EACA,CAAE,UAAW,gBAAiB,EAEhC,CAKO,eAAe,EAAU,CAK/B,EACA,OAAO,EACN,CAAC,OAAO,EAAE,EAAO,aAAa,CAAC,cAAc,CAAC,CAC9C,CACC,QAAS,EAAO,IAAI,CACpB,MAAO,EAAO,KAAK,EAAI,SACvB,SAAU,EAAO,QAAQ,EAAI,OAC9B,EACA,CAAE,UAAW,OAAQ,EAEvB,CAKO,eAAe,EAAa,CAIlC,EACA,OAAO,EACN,CAAC,OAAO,EAAE,EAAO,aAAa,CAAC,iBAAiB,CAAC,CACjD,CACC,GAAI,EAAO,EAAE,CACb,KAAM,EAAO,IAAI,AAClB,EACA,CAAE,UAAW,UAAW,EAE1B,CAKO,eAAe,EAAS,CAG9B,EACA,OAAO,EACN,CAAC,OAAO,EAAE,EAAO,aAAa,CAAC,kBAAkB,CAAC,CAClD,CAAE,OAAQ,EAAO,MAAM,AAAC,EACxB,CAAE,UAAW,WAAY,EAE3B,CAKO,eAAe,EAAY,CASjC,EACA,IAAM,EAAW,CAAC,CAAC,EAAO,QAAQ,CAuBlC,OAAO,EAtBU,EACd,CAAC,OAAO,EAAE,EAAO,EAqBK,UAAU,CArBF,CAAC,2BAA2B,CAAC,CAC3D,CAAC,OAAO,EAAE,EAAO,aAAa,CAAC,2BAA2B,CAAC,CAEjD,EACV,CACA,UAAW,EAAO,QAAQ,CAC1B,aAAc,EAAO,WAAW,CAChC,IAAK,EAAO,SAAS,CACrB,IAAK,EAAO,SAAS,CACrB,eAAgB,EAAO,OAAO,CAC9B,kBAAmB,EAAO,gBAAgB,EAAI,GAC/C,EACC,CACA,QAAS,EAAO,SAAS,EAAI,GAC7B,aAAc,EAAO,WAAW,CAChC,IAAK,EAAO,SAAS,CACrB,IAAK,EAAO,SAAS,CACrB,eAAgB,EAAO,OAAO,CAC9B,kBAAmB,EAAO,gBAAgB,EAAI,GAC/C,EAEuC,CACxC,UAAW,EAAW,eAAiB,cACxC,EACD,0PC9YA,IAAA,EAAA,EAAA,CAAA,CAAA,QAgBA,SAAS,EAAW,CAAW,EAC9B,IAAM,EAAU,EAAI,WAAW,GAC/B,OACC,EAAQ,QAAQ,CAAC,cACjB,EAAQ,QAAQ,CAAC,cACjB,EAAQ,QAAQ,CAAC,YACjB,EAAQ,QAAQ,CAAC,WACjB,EAAQ,QAAQ,CAAC,WAEnB,CA6BO,SAAS,IACf,IAAM,EAAmB,EAAE,CACrB,EAAqB,EAAE,CACvB,EAAS,CACd,QAAQ,EACR,cAAc,EACd,oBAAoB,EACpB,eAAe,EACf,WAAW,EACX,SAAS,CACV,CAGI,CAAC,EAAA,aAAa,CAAC,MAAM,EAAoC,IAAI,CAApC,EAAA,aAAa,CAAC,MAAM,CAAC,IAAI,GAI3C,EAAA,aAAa,CAAC,MAAM,CAAC,MAAM,CAAG,GACxC,CAD4C,CACrC,IAAI,CACV,qGAGD,EAAO,MAAM,EAAG,EARhB,EAAO,IAAI,CACV,0EAWE,AAAC,EAAA,aAAa,CAAC,YAAY,EAA0C,IAAI,CAA1C,EAAA,aAAa,CAAC,YAAY,CAAC,IAAI,GAKjE,EAAO,YAAY,EAAG,EAJtB,EAAO,IAAI,CACV,6IAQD,AAAC,EAAA,aAAa,CAAC,kBAAkB,EACjC,AAA4C,IAC3C,GADD,aAAa,CAAC,kBAAkB,CAAC,IAAI,GAMrC,EAAO,kBAAkB,EAAG,EAJ5B,EAAO,IAAI,CACV,oMAQD,AAAC,EAAA,aAAa,CAAC,aAAa,EACW,IACtC,CADD,EAAA,aAAa,CAAC,aAAa,CAAC,IAAI,GAMhC,EAAO,aAAa,EAAG,EAJvB,EAAS,IAAI,CACZ,2HAOE,AAAC,EAAA,aAAa,CAAC,SAAS,EAAuC,IAAI,CAAvC,EAAA,aAAa,CAAC,SAAS,CAAC,IAAI,GAK3D,EAAO,SAAS,CAAG,GAJnB,EAAS,IAAI,CACZ,8HAOF,IAAM,EAAU,AA/FjB,SAAS,EAOR,IAAK,IAAM,IANQ,SAMK,WAAY,KAJnC,QAAQ,GAAG,CAAC,QAAQ,yBAEpB,QAAQ,GAAG,CAAC,OAAO,CACnB,CAEA,GAAI,GAAa,EAAU,IAAI,GAAI,CAClC,IAAM,EAAU,EAAU,IAAI,GAC9B,GAAI,CAAC,EAAW,GACf,OADyB,AAClB,EAAQ,UAAU,CAAC,QAAU,EAAU,CAAC,QAAQ,EAAE,EAAA,CAE3D,AAFoE,CAKrE,IAAM,EAAY,QAAQ,GAAG,CAAC,UAAU,CACxC,GAAI,GAAa,CAAC,EAAW,GAC5B,OAAO,EADiC,AACvB,UAAU,CAAC,QAAU,EAAY,CAAC,QAAQ,EAAE,EAAA,CAI/D,AAJ0E,IAmGzE,OArBK,EAIM,EAAW,GAEO,EANf,KAIkB,QAE9B,QAAQ,GAAG,CAAC,UAAU,EACS,eAA/B,QAAQ,GAAG,CAAC,cAAc,CAE1B,EAAO,IAAI,CACV,CAAC,8BAA8B,EAAE,EAAQ,+EAA+E,CAAC,EAG1H,EAAS,IAAI,CACZ,CAAC,8BAA8B,EAAE,EAAQ,oCAAoC,CAAC,EAIhF,EAAO,OAAO,EAAG,EAjBjB,EAAO,IAAI,CACV,+KAmBK,CACN,MAAyB,IAAlB,EAAO,MAAM,QACpB,WACA,EACA,QACD,CACD,CAKO,eAAe,IAKrB,IAAM,EAAa,IAEnB,GAAI,CAAC,EAAW,MAAM,CAAC,MAAM,CAC5B,CAD8B,KACvB,CACN,OAAO,EACP,MAAO,+CACR,EAGD,GAAI,CAAC,EAAW,MAAM,CAAC,kBAAkB,CAAE,CAE1C,GAAI,CACH,GAAM,4BAAE,CAA0B,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,QAGjC,EAAgB,MAAM,IAE5B,GAAI,EAAc,OAAO,EAAI,EAAc,OAAO,CACjD,CADmD,KAC5C,CACN,OAAO,EACP,MACC,sEACD,mBAAoB,EAAc,OAAO,CAAC,EAAE,AAC7C,CAEF,CAAE,KAAM,CAER,CAEA,MAAO,CACN,OAAO,EACP,MACC,6IACF,CACD,QAEA,AAAK,EAAW,EAAZ,IAAkB,CAAC,OAAO,CAQvB,CARyB,AAQvB,OAAO,CAAK,EAPb,CACN,OAAO,EACP,MACC,8EACF,CAIF,CAKO,SAAS,IAIf,IAAM,EAAa,WAEnB,AAAK,EAAW,EAAZ,IAAkB,CAAC,MAAM,CAOxB,CAP0B,CAOf,MAAM,CAAC,YAAY,CAQ9B,CARgC,CAQrB,MAAM,CAAC,OAAO,CAQvB,CARyB,AAQvB,OAAO,CAAK,EAPb,CACN,OAAO,EACP,MACC,+EACF,EAZO,CACN,OAAO,EACP,MACC,0HACF,EAXO,CACN,OAAO,EACP,MAAO,4CACR,CAoBF"}