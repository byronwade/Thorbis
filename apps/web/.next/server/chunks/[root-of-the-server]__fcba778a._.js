module.exports=[254799,(e,t,a)=>{t.exports=e.x("crypto",()=>require("crypto"))},247731,e=>{"use strict";var t=e.i(254799),a=e.i(273568),r=e.i(278378);async function n(e,a){let n=process.env.OPENAI_API_KEY;if(n){let t,o=Date.now(),i=!1;try{let c=await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({model:"text-embedding-3-small",input:e,dimensions:1536})});if(c.ok){let t=await c.json();return i=!0,a&&r.openaiTracker.track("embeddings",a,{success:!0,responseTimeMs:Date.now()-o,estimatedCostCents:Math.ceil(e.length/1e3*.002)}).catch(()=>{}),t.data[0].embedding}t=`API returned ${c.status}`}catch(e){t=e instanceof Error?e.message:"Unknown error",console.error("Failed to generate OpenAI embedding:",e)}finally{!i&&a&&r.openaiTracker.track("embeddings",a,{success:!1,responseTimeMs:Date.now()-o,errorMessage:t}).catch(()=>{})}}let o=t.default.createHash("sha256").update(e).digest("hex"),i=[];for(let e=0;e<1536;e++){let t=o.charCodeAt(e%o.length);i.push((t/128-1)*Math.sin(e))}let c=Math.sqrt(i.reduce((e,t)=>e+t*t,0));return i.map(e=>e/c)}async function o(e,r,o){let i=(0,a.createServiceSupabaseClient)(),c=t.default.randomUUID(),s=await n(o.content,e),m=t.default.createHash("sha256").update(o.content).digest("hex"),{data:d}=await i.from("ai_memory").select("id").eq("company_id",e).eq("content_hash",m).maybeSingle();if(d)return await i.from("ai_memory").update({access_count:i.rpc("increment",{x:1}),last_accessed_at:new Date().toISOString()}).eq("id",d.id),d.id;let{error:l}=await i.from("ai_memory").insert({id:c,company_id:e,user_id:r,content:o.content,content_hash:m,memory_type:o.memoryType,scope:o.scope,entity_type:o.entityType,entity_id:o.entityId,source_message_id:o.sourceMessageId,source_chat_id:o.sourceChatId,embedding:s,importance:o.importance||.5,access_count:0,tags:o.tags||[],metadata:o.metadata||{},created_at:new Date().toISOString()});if(l)throw console.error("Failed to store memory:",l),l;return c}async function i(e,t,a){let r=[];for(let n of a)try{let a=await o(e,t,n);r.push(a)}catch(e){console.error("Failed to store memory:",e)}return r}async function c(e,t,r){let o=(0,a.createServiceSupabaseClient)(),i=r?.limit||10,c=r?.minSimilarity||.5,d=await n(t,e),{data:l,error:y}=await o.rpc("vector_memory_search",{p_company_id:e,p_query_embedding:d,p_user_id:r?.userId||null,p_scope:r?.scope||null,p_memory_types:r?.memoryTypes||null,p_entity_type:r?.entityType||null,p_entity_id:r?.entityId||null,p_limit:i,p_min_similarity:c});if(y)return console.error("Failed to search memories:",y),s(e,t,r);if(l&&l.length>0){let t=l.map(e=>e.id);await m(e,t)}return(l||[]).map(e=>({id:e.id,content:e.content,memoryType:e.memory_type,similarity:e.similarity,importance:e.importance,createdAt:e.created_at,accessCount:e.access_count}))}async function s(e,t,r){let n=(0,a.createServiceSupabaseClient)(),o=r?.limit||10,i=n.from("ai_memory").select("id, content, memory_type, importance, created_at, access_count").eq("company_id",e).is("deleted_at",null).order("importance",{ascending:!1}).limit(o);r?.userId&&(i=i.eq("user_id",r.userId)),r?.scope&&(i=i.eq("scope",r.scope)),r?.memoryTypes&&r.memoryTypes.length>0&&(i=i.in("memory_type",r.memoryTypes)),r?.entityType&&(i=i.eq("entity_type",r.entityType)),r?.entityId&&(i=i.eq("entity_id",r.entityId)),i=i.ilike("content",`%${t}%`);let{data:c,error:s}=await i;return s?(console.error("Fallback search failed:",s),[]):(c||[]).map(e=>({id:e.id,content:e.content,memoryType:e.memory_type,similarity:.5,importance:e.importance,createdAt:e.created_at,accessCount:e.access_count}))}async function m(e,t){let r=(0,a.createServiceSupabaseClient)();for(let a of t)await r.from("ai_memory").update({access_count:r.sql`access_count + 1`,last_accessed_at:new Date().toISOString()}).eq("id",a).eq("company_id",e)}async function d(e,t,r,n){let o=(0,a.createServiceSupabaseClient)(),i=n?.limit||20,c=o.from("ai_memory").select("id, content, memory_type, importance, created_at").eq("company_id",e).eq("entity_type",t).eq("entity_id",r).is("deleted_at",null).order("importance",{ascending:!1}).limit(i);n?.memoryTypes&&n.memoryTypes.length>0&&(c=c.in("memory_type",n.memoryTypes));let{data:s,error:m}=await c;return m?(console.error("Failed to get entity memories:",m),[]):(s||[]).map(e=>({id:e.id,content:e.content,memoryType:e.memory_type,importance:e.importance,createdAt:e.created_at}))}async function l(e,t,r){let n=(0,a.createServiceSupabaseClient)(),{error:o}=await n.from("ai_memory").update({importance:Math.max(0,Math.min(1,r))}).eq("id",t).eq("company_id",e);o&&console.error("Failed to update memory importance:",o)}async function y(e,t){let r=(0,a.createServiceSupabaseClient)(),{error:n}=await r.from("ai_memory").update({deleted_at:new Date().toISOString()}).eq("id",t).eq("company_id",e);return!n||(console.error("Failed to delete memory:",n),!1)}async function p(e,t,a,r,n,o){let c=[];for(let e of(c.push({content:n.substring(0,500),memoryType:"interaction",scope:t?"user":"company",sourceMessageId:r,sourceChatId:a,importance:.5,metadata:{role:o}}),[/(?:remember|note|important)[:\s]+(.+?)(?:\.|$)/gi,/(?:always|never|usually)[:\s]+(.+?)(?:\.|$)/gi]))for(let o of n.matchAll(e))o[1]&&o[1].length>10&&c.push({content:o[1].trim(),memoryType:"fact",scope:t?"user":"company",sourceMessageId:r,sourceChatId:a,importance:.7});return i(e,t,c)}async function u(e){let t=(0,a.createServiceSupabaseClient)(),{data:r,error:n}=await t.from("ai_memory").select("memory_type, scope, importance, access_count, created_at").eq("company_id",e).is("deleted_at",null);if(n||!r)return{totalMemories:0,byType:{},byScope:{},averageImportance:0,totalAccessCount:0,memoriesLast7Days:0};let o={},i={},c=0,s=0,m=new Date(Date.now()-6048e5),d=0;for(let e of r)o[e.memory_type]=(o[e.memory_type]||0)+1,i[e.scope]=(i[e.scope]||0)+1,c+=e.importance,s+=e.access_count,new Date(e.created_at)>m&&d++;return{totalMemories:r.length,byType:o,byScope:i,averageImportance:r.length>0?c/r.length:0,totalAccessCount:s,memoriesLast7Days:d}}async function _(e){return{consolidated:0,deleted:0}}async function f(e,t){let r=(0,a.createServiceSupabaseClient)(),n=t?.maxAge||90,o=t?.minAccessCount||1,i=new Date(Date.now()-24*n*36e5),{data:c,error:s}=await r.from("ai_memory").select("id").eq("company_id",e).is("deleted_at",null).lt("created_at",i.toISOString()).lte("access_count",o);if(s||!c)return{affected:0,deleted:0};if(t?.dryRun)return{affected:c.length,deleted:0};let m=c.map(e=>e.id);return m.length>0&&await r.from("ai_memory").update({deleted_at:new Date().toISOString()}).in("id",m).eq("company_id",e),{affected:c.length,deleted:c.length}}e.s(["consolidateMemories",()=>_,"decayOldMemories",()=>f,"deleteMemory",()=>y,"extractMemoriesFromConversation",()=>p,"getEntityMemories",()=>d,"getMemoryStatistics",()=>u,"searchMemories",()=>c,"storeMemories",()=>i,"storeMemory",()=>o,"updateMemoryImportance",()=>l])}];

//# sourceMappingURL=%5Broot-of-the-server%5D__fcba778a._.js.map