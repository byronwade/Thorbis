module.exports=[254799,(e,t,a)=>{t.exports=e.x("crypto",()=>require("crypto"))},247731,e=>{"use strict";var t=e.i(273568),a=e.i(254799);async function r(e){let t=process.env.OPENAI_API_KEY;if(t)try{let a=await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:"text-embedding-3-small",input:e,dimensions:1536})});if(a.ok)return(await a.json()).data[0].embedding}catch(e){console.error("Failed to generate OpenAI embedding:",e)}let r=a.default.createHash("sha256").update(e).digest("hex"),o=[];for(let e=0;e<1536;e++){let t=r.charCodeAt(e%r.length);o.push((t/128-1)*Math.sin(e))}let n=Math.sqrt(o.reduce((e,t)=>e+t*t,0));return o.map(e=>e/n)}async function o(e,o,n){let i=(0,t.createServiceSupabaseClient)(),c=a.default.randomUUID(),m=await r(n.content),s=a.default.createHash("sha256").update(n.content).digest("hex"),{data:d}=await i.from("ai_memory").select("id").eq("company_id",e).eq("content_hash",s).maybeSingle();if(d)return await i.from("ai_memory").update({access_count:i.rpc("increment",{x:1}),last_accessed_at:new Date().toISOString()}).eq("id",d.id),d.id;let{error:y}=await i.from("ai_memory").insert({id:c,company_id:e,user_id:o,content:n.content,content_hash:s,memory_type:n.memoryType,scope:n.scope,entity_type:n.entityType,entity_id:n.entityId,source_message_id:n.sourceMessageId,source_chat_id:n.sourceChatId,embedding:m,importance:n.importance||.5,access_count:0,tags:n.tags||[],metadata:n.metadata||{},created_at:new Date().toISOString()});if(y)throw console.error("Failed to store memory:",y),y;return c}async function n(e,t,a){let r=[];for(let n of a)try{let a=await o(e,t,n);r.push(a)}catch(e){console.error("Failed to store memory:",e)}return r}async function i(e,a,o){let n=(0,t.createServiceSupabaseClient)(),i=o?.limit||10,s=o?.minSimilarity||.5,d=await r(a),{data:y,error:l}=await n.rpc("vector_memory_search",{p_company_id:e,p_query_embedding:d,p_user_id:o?.userId||null,p_scope:o?.scope||null,p_memory_types:o?.memoryTypes||null,p_entity_type:o?.entityType||null,p_entity_id:o?.entityId||null,p_limit:i,p_min_similarity:s});if(l)return console.error("Failed to search memories:",l),c(e,a,o);if(y&&y.length>0){let t=y.map(e=>e.id);await m(e,t)}return(y||[]).map(e=>({id:e.id,content:e.content,memoryType:e.memory_type,similarity:e.similarity,importance:e.importance,createdAt:e.created_at,accessCount:e.access_count}))}async function c(e,a,r){let o=(0,t.createServiceSupabaseClient)(),n=r?.limit||10,i=o.from("ai_memory").select("id, content, memory_type, importance, created_at, access_count").eq("company_id",e).is("deleted_at",null).order("importance",{ascending:!1}).limit(n);r?.userId&&(i=i.eq("user_id",r.userId)),r?.scope&&(i=i.eq("scope",r.scope)),r?.memoryTypes&&r.memoryTypes.length>0&&(i=i.in("memory_type",r.memoryTypes)),r?.entityType&&(i=i.eq("entity_type",r.entityType)),r?.entityId&&(i=i.eq("entity_id",r.entityId)),i=i.ilike("content",`%${a}%`);let{data:c,error:m}=await i;return m?(console.error("Fallback search failed:",m),[]):(c||[]).map(e=>({id:e.id,content:e.content,memoryType:e.memory_type,similarity:.5,importance:e.importance,createdAt:e.created_at,accessCount:e.access_count}))}async function m(e,a){let r=(0,t.createServiceSupabaseClient)();for(let t of a)await r.from("ai_memory").update({access_count:r.sql`access_count + 1`,last_accessed_at:new Date().toISOString()}).eq("id",t).eq("company_id",e)}async function s(e,a,r,o){let n=(0,t.createServiceSupabaseClient)(),i=o?.limit||20,c=n.from("ai_memory").select("id, content, memory_type, importance, created_at").eq("company_id",e).eq("entity_type",a).eq("entity_id",r).is("deleted_at",null).order("importance",{ascending:!1}).limit(i);o?.memoryTypes&&o.memoryTypes.length>0&&(c=c.in("memory_type",o.memoryTypes));let{data:m,error:s}=await c;return s?(console.error("Failed to get entity memories:",s),[]):(m||[]).map(e=>({id:e.id,content:e.content,memoryType:e.memory_type,importance:e.importance,createdAt:e.created_at}))}async function d(e,a,r){let o=(0,t.createServiceSupabaseClient)(),{error:n}=await o.from("ai_memory").update({importance:Math.max(0,Math.min(1,r))}).eq("id",a).eq("company_id",e);n&&console.error("Failed to update memory importance:",n)}async function y(e,a){let r=(0,t.createServiceSupabaseClient)(),{error:o}=await r.from("ai_memory").update({deleted_at:new Date().toISOString()}).eq("id",a).eq("company_id",e);return!o||(console.error("Failed to delete memory:",o),!1)}async function l(e,t,a,r,o,i){let c=[];for(let e of(c.push({content:o.substring(0,500),memoryType:"interaction",scope:t?"user":"company",sourceMessageId:r,sourceChatId:a,importance:.5,metadata:{role:i}}),[/(?:remember|note|important)[:\s]+(.+?)(?:\.|$)/gi,/(?:always|never|usually)[:\s]+(.+?)(?:\.|$)/gi]))for(let n of o.matchAll(e))n[1]&&n[1].length>10&&c.push({content:n[1].trim(),memoryType:"fact",scope:t?"user":"company",sourceMessageId:r,sourceChatId:a,importance:.7});return n(e,t,c)}async function p(e){let a=(0,t.createServiceSupabaseClient)(),{data:r,error:o}=await a.from("ai_memory").select("memory_type, scope, importance, access_count, created_at").eq("company_id",e).is("deleted_at",null);if(o||!r)return{totalMemories:0,byType:{},byScope:{},averageImportance:0,totalAccessCount:0,memoriesLast7Days:0};let n={},i={},c=0,m=0,s=new Date(Date.now()-6048e5),d=0;for(let e of r)n[e.memory_type]=(n[e.memory_type]||0)+1,i[e.scope]=(i[e.scope]||0)+1,c+=e.importance,m+=e.access_count,new Date(e.created_at)>s&&d++;return{totalMemories:r.length,byType:n,byScope:i,averageImportance:r.length>0?c/r.length:0,totalAccessCount:m,memoriesLast7Days:d}}async function u(e){return{consolidated:0,deleted:0}}async function _(e,a){let r=(0,t.createServiceSupabaseClient)(),o=a?.maxAge||90,n=a?.minAccessCount||1,i=new Date(Date.now()-24*o*36e5),{data:c,error:m}=await r.from("ai_memory").select("id").eq("company_id",e).is("deleted_at",null).lt("created_at",i.toISOString()).lte("access_count",n);if(m||!c)return{affected:0,deleted:0};if(a?.dryRun)return{affected:c.length,deleted:0};let s=c.map(e=>e.id);return s.length>0&&await r.from("ai_memory").update({deleted_at:new Date().toISOString()}).in("id",s).eq("company_id",e),{affected:c.length,deleted:c.length}}e.s(["consolidateMemories",()=>u,"decayOldMemories",()=>_,"deleteMemory",()=>y,"extractMemoriesFromConversation",()=>l,"getEntityMemories",()=>s,"getMemoryStatistics",()=>p,"searchMemories",()=>i,"storeMemories",()=>n,"storeMemory",()=>o,"updateMemoryImportance",()=>d])}];

//# sourceMappingURL=%5Broot-of-the-server%5D__fcba778a._.js.map