module.exports=[14646,e=>{"use strict";var r,a=e.i(443608);let t=a.z.string().email("Invalid email address").min(1,"Email is required"),i=a.z.object({to:a.z.union([t,a.z.array(t)]),subject:a.z.string().min(1,"Subject is required").max(200),replyTo:t.optional()});var s=((r={}).WELCOME="welcome",r.EMAIL_VERIFICATION="email-verification",r.PASSWORD_RESET="password-reset",r.PASSWORD_CHANGED="password-changed",r.MAGIC_LINK="magic-link",r.JOB_CONFIRMATION="job-confirmation",r.APPOINTMENT_REMINDER="appointment-reminder",r.TECH_EN_ROUTE="tech-en-route",r.JOB_COMPLETE="job-complete",r.INVOICE="invoice",r.ESTIMATE="estimate",r.INVOICE_SENT="invoice-sent",r.PAYMENT_RECEIVED="payment-received",r.PAYMENT_REMINDER="payment-reminder",r.ESTIMATE_SENT="estimate-sent",r.REVIEW_REQUEST="review-request",r.SERVICE_REMINDER="service-reminder",r.WELCOME_CUSTOMER="welcome-customer",r.PORTAL_INVITATION="portal-invitation",r.TEAM_INVITATION="team-invitation",r.VERIFICATION_SUBMITTED="verification-submitted",r.VERIFICATION_COMPLETE="verification-complete",r.WAITLIST_SUBSCRIPTION="waitlist-subscription",r.WAITLIST_ADMIN_NOTIFICATION="waitlist-admin-notification",r.GENERIC="generic",r);e.s(["EmailTemplate",()=>s,"emailSendSchema",0,i])},627847,e=>{"use strict";var r=e.i(471312),a=e.i(273568),t=e.i(798348);let i=new Map;async function s(e){let r=await (0,a.createServiceSupabaseClient)(),{data:t,error:i}=await r.from("company_email_domains").select(`
			id,
			domain_name,
			reply_to_email,
			daily_limit,
			hourly_limit,
			emails_sent_today,
			emails_sent_this_hour,
			is_platform_subdomain
		`).eq("company_id",e).eq("status","verified").eq("sending_enabled",!0).eq("is_suspended",!1).order("is_platform_subdomain",{ascending:!0}).order("created_at",{ascending:!1}).maybeSingle();return i?(console.error("Error fetching company email domain:",i),null):t?{domainId:t.id,domain:t.domain_name,replyToEmail:t.reply_to_email,dailyLimit:t.daily_limit||1e3,hourlyLimit:t.hourly_limit||100,emailsSentToday:t.emails_sent_today||0,emailsSentThisHour:t.emails_sent_this_hour||0}:null}async function n(e){let r=await (0,a.createServiceSupabaseClient)(),{data:t,error:s}=await r.from("company_email_domains").select(`
			daily_limit,
			hourly_limit,
			emails_sent_today,
			emails_sent_this_hour,
			is_suspended,
			daily_limit_reset_at,
			hourly_limit_reset_at
		`).eq("id",e).single();if(s||!t)return{allowed:!1,reason:"Domain not found or error fetching limits"};if(t.is_suspended)return{allowed:!1,reason:"Domain is suspended due to reputation issues"};let n=t.daily_limit||1e3,o=t.hourly_limit||100,l=t.emails_sent_today||0,u=t.emails_sent_this_hour||0;if(l>=n)return{allowed:!1,reason:`Daily email limit reached (${n} emails/day)`,remaining:0,resetAt:t.daily_limit_reset_at||m()};if(u>=o)return{allowed:!1,reason:`Hourly email limit reached (${o} emails/hour)`,remaining:0,resetAt:t.hourly_limit_reset_at||d()};let f=`${e}:minute`,p=c(),_=i.get(f);return _&&_.windowStart===p&&_.count>=10?{allowed:!1,reason:"Rate limit: Too many emails per minute (10/min)",remaining:0}:{allowed:!0,remaining:Math.min(n-l,o-u)}}async function o(e){let r=await (0,a.createServiceSupabaseClient)(),{data:t,error:i}=await r.rpc("increment_email_counter",{p_domain_id:e});return i?"PGRST202"===i.code||i.message.includes("function")?await l(e):(console.error("Error incrementing email counter:",i),{allowed:!1,reason:i.message}):t&&"object"==typeof t?{allowed:t.allowed,reason:t.reason,remaining:t.remaining}:{allowed:!0}}async function l(e){let r=await (0,a.createServiceSupabaseClient)(),{data:t,error:s}=await r.from("company_email_domains").select("emails_sent_today, emails_sent_this_hour, daily_limit, hourly_limit").eq("id",e).single();if(s||!t)return{allowed:!1,reason:"Domain not found"};let n=t.daily_limit||1e3,o=t.hourly_limit||100;if((t.emails_sent_today||0)>=n)return{allowed:!1,reason:"Daily limit reached"};if((t.emails_sent_this_hour||0)>=o)return{allowed:!1,reason:"Hourly limit reached"};let{error:l}=await r.from("company_email_domains").update({emails_sent_today:(t.emails_sent_today||0)+1,emails_sent_this_hour:(t.emails_sent_this_hour||0)+1}).eq("id",e);if(l)return console.error("Error updating email counters:",l),{allowed:!1,reason:l.message};let m=`${e}:minute`,d=c(),u=i.get(m);return u&&u.windowStart===d?u.count++:i.set(m,{count:1,windowStart:d}),{allowed:!0,remaining:Math.min(n-(t.emails_sent_today||0)-1,o-(t.emails_sent_this_hour||0)-1)}}function c(){return Math.floor(Date.now()/6e4)}function m(){let e=new Date(new Date);return e.setUTCDate(e.getUTCDate()+1),e.setUTCHours(0,0,0,0),e.toISOString()}function d(){let e=new Date(new Date);return e.setUTCHours(e.getUTCHours()+1,0,0,0),e.toISOString()}async function u(){let e=await (0,a.createServiceSupabaseClient)(),{error:r}=await e.from("company_email_domains").update({emails_sent_today:0,daily_limit_reset_at:m()}).neq("id","");return r?(console.error("Error resetting daily counters:",r),{success:!1,error:r.message}):{success:!0}}async function f(){let e=await (0,a.createServiceSupabaseClient)(),{error:r}=await e.from("company_email_domains").update({emails_sent_this_hour:0,hourly_limit_reset_at:d()}).neq("id","");return r?(console.error("Error resetting hourly counters:",r),{success:!1,error:r.message}):{success:!0}}(0,t.ensureServerEntryExports)([s,n,o,u,f]),(0,r.registerServerReference)(s,"407a5a7d0a7dd7989a963eb2485a3527c1dcb20a70",null),(0,r.registerServerReference)(n,"40af86a915f04df8d7cc189fe26e45e0cc24663080",null),(0,r.registerServerReference)(o,"4029b163c1c0acfd806352a72fe8030c8ae4f7f8ac",null),(0,r.registerServerReference)(u,"006acf41615a2f7795c47b6d7a3016e18300f2ad17",null),(0,r.registerServerReference)(f,"004cdde5e6ae8991bab4ba61ae40647c2b823200ba",null),e.s(["checkRateLimit",()=>n,"getCompanyActiveDomain",()=>s,"incrementEmailCounter",()=>o])},628849,e=>{"use strict";var r=e.i(264591),a=e.i(129236),t=e.i(830048);let i="resend",s="postmark";function n(e){switch(e){case"resend":return(0,r.isResendConfigured)();case"postmark":return(0,a.isPostmarkConfigured)();default:return!1}}async function o(e){if(!(0,r.isResendConfigured)()||!r.resend)return{success:!1,error:"Resend is not configured"};try{let a=[];if(e.tags)for(let[r,t]of Object.entries(e.tags))a.push({name:r,value:t});e.communicationId&&a.push({name:"communication_id",value:e.communicationId});let{data:t,error:i}=await r.resend.emails.send({from:e.from||r.emailConfig.from,to:e.to,subject:e.subject,html:e.html,text:e.text,replyTo:e.replyTo,tags:a.length>0?a:void 0});if(i)return{success:!1,error:i.message||"Resend send failed"};return{success:!0,messageId:t?.id}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Resend send failed"}}}async function l(e){if(!(0,a.isPostmarkConfigured)())return{success:!1,error:"Postmark is not configured"};try{let r={...e.tags};e.communicationId&&(r.communication_id=e.communicationId),e.companyId&&(r.company_id=e.companyId);let t=e.tags?.template||e.tags?.type||"transactional",i=await (0,a.sendPostmarkEmail)({to:e.to,subject:e.subject,html:e.html,text:e.text,from:e.from||a.postmarkConfig.from,replyTo:e.replyTo,tag:t,metadata:r});if(!i.success)return{success:!1,error:i.error};return{success:!0,messageId:i.data.MessageID}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Postmark send failed"}}}async function c(e,r){try{let a=await (0,t.sendCompanyGmailEmail)(e,{to:r.to,subject:r.subject,html:r.html,text:r.text,replyTo:r.replyTo,cc:r.cc,bcc:r.bcc});if(!a.success)return{success:!1,error:a.error};return{success:!0,messageId:a.messageId}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Gmail send failed"}}}async function m(e){try{if(!await (0,t.isGmailIntegrationEnabled)())return!1;let r=await (0,t.getCompanyGmailTokens)(e);return null!==r&&r.isValid}catch{return!1}}async function d(e){let r=[];if(Array.isArray(e.to)?e.to.join(", "):e.to,e.companyId){let a=await (0,t.getCompanyEmailProvider)(e.companyId);if("disabled"===a)return{success:!1,error:"Email is disabled for this company",usedFallback:!1,attempts:[]};if("gmail"===a&&await m(e.companyId)){let a=Date.now(),t=await c(e.companyId,e),i=Date.now()-a;if(r.push({provider:"gmail",success:t.success,messageId:t.messageId,error:t.error,latencyMs:i}),t.success)return{success:!0,provider:"gmail",messageId:t.messageId,usedFallback:!1,attempts:r};console.warn(`[EmailProvider] ✗ Gmail send failed in ${i}ms: ${t.error}`)}}if(n(i)){let a=Date.now(),t=await o(e),s=Date.now()-a;if(r.push({provider:i,success:t.success,messageId:t.messageId,error:t.error,latencyMs:s}),t.success)return{success:!0,provider:i,messageId:t.messageId,usedFallback:!1,attempts:r};console.warn(`[EmailProvider] ✗ Primary provider failed in ${s}ms: ${t.error}`)}else console.warn(`[EmailProvider] Primary provider (${i}) not configured`);if(n(s)){let a=Date.now(),t=await l(e),i=Date.now()-a;if(r.push({provider:s,success:t.success,messageId:t.messageId,error:t.error,latencyMs:i}),t.success)return{success:!0,provider:s,messageId:t.messageId,usedFallback:!0,attempts:r};console.error(`[EmailProvider] ✗ Fallback provider also failed in ${i}ms: ${t.error}`)}else console.warn(`[EmailProvider] Fallback provider (${s}) not configured`);let a=r.map(e=>`${e.provider}: ${e.error}`).join("; ");return console.error(`[EmailProvider] ✗ All providers failed: ${a}`),{success:!1,error:`All email providers failed. ${a}`,usedFallback:r.length>1,attempts:r}}function u(){let e,t,o=n(i),l=n(s),c=(t=[],(0,r.isResendConfigured)()&&t.push("resend"),(0,a.isPostmarkConfigured)()&&t.push("postmark"),t);return e=o&&l?"fully_configured":o?"primary_only":l?"fallback_only":"not_configured",{primaryConfigured:o,fallbackConfigured:l,fallbackEnabled:!0,configuredProviders:c,status:e}}e.s(["getProviderSetupInfo",()=>u,"sendEmailWithFallback",()=>d])},641979,e=>e.a(async(r,a)=>{try{var t=e.i(471312),i=e.i(291770),s=e.i(443608),n=e.i(511368),o=e.i(795824),l=e.i(14646),c=e.i(100357),m=e.i(627847),d=e.i(264591),u=e.i(628849),f=e.i(63714),p=e.i(798348),_=r([i]);async function g({to:r,subject:a,template:t,templateType:p,replyTo:_,tags:g=[],companyId:w,communicationId:v,fromOverride:E,cc:I,bcc:b,attachments:S,isMarketingEmail:T=!1,skipPreSendChecks:C=!1,textContent:A="",unsubscribeUrl:R,listId:D}){let k=null,P=null,N=null;try{if(d.emailConfig.isDevelopment)return{success:!0,data:{id:`dev-mode-${Date.now()}`,message:"Email logged in development mode (not actually sent)"}};let s=(0,u.getProviderSetupInfo)();if("not_configured"===s.status)return{success:!1,error:"Email service not configured. Please add RESEND_API_KEY or POSTMARK_API_KEY to environment variables."};let O=await (0,n.createClient)();if(w){if(!(N=await (0,m.getCompanyActiveDomain)(w)))return{success:!1,error:"No active email domain configured for this company. Please set up email in settings."};k=N.domainId,P=N.replyToEmail?N.replyToEmail:`support@${N.domain}`}let M=_||P||void 0,$=l.emailSendSchema.parse({to:r,subject:a,replyTo:M}),j=Array.isArray($.to)?$.to:[$.to];if(w&&k){let e=await (0,m.checkRateLimit)(N.domainId);if(!e.allowed)return{success:!1,error:e.reason||"Rate limit exceeded"};if(C){let e=await (0,c.checkSuppressionList)(w,j),r=j.filter(r=>{let a=e.get(r.toLowerCase());return!a?.suppressed});if(0===r.length)return{success:!1,error:"All recipients are on suppression list"};r.length<j.length&&($.to=1===r.length?r[0]:r)}else{let e=await (0,i.render)(t),r=A||h(e),s=await (0,c.runPreSendChecks)(w,N.domainId,j,a,e,r,T);if(!s.allowed)return{success:!1,error:`Deliverability check failed: ${s.errors.join("; ")}`,data:{spamScore:s.spamScore,warnings:s.warnings,suggestions:s.suggestions}};let n=j.filter(e=>{let r=s.recipientStatus?.find(r=>r.email.toLowerCase()===e.toLowerCase());return!r?.suppressed});if(0===n.length)return{success:!1,error:"All recipients are on suppression list - no emails sent"};n.length<j.length&&($.to=1===n.length?n[0]:n),s.warnings.length>0&&console.warn("[Email Deliverability Warnings]",s.warnings)}let r=await (0,m.incrementEmailCounter)(N.domainId);if(!r.allowed)return{success:!1,error:r.reason||"Rate limit exceeded"}}let F=E||d.emailConfig.from;if(w&&O){let e=await y(O,w);e&&(F=e)}let L=await (0,i.render)(t);if(v){let{addEmailTracking:r}=await e.A(137050);L=r(L,v)}let q=[...g,{name:"template",value:p},{name:"environment",value:"production"}];v&&q.push({name:"communication_id",value:v}),w&&q.push({name:"company_id",value:w});let x={"X-Priority":"3","X-Mailer":"Stratos Email System"};T&&R&&(x["List-Unsubscribe"]=`<${R}>`,x["List-Unsubscribe-Post"]="List-Unsubscribe=One-Click"),D&&(x["List-Id"]=D),T||(x["Auto-Submitted"]="auto-generated",x.Precedence="bulk");let U={};for(let e of q)U[e.name]=e.value;let W=Date.now(),V=await (0,u.sendEmailWithFallback)({to:$.to,subject:$.subject,html:L,text:A||h(L),from:F,replyTo:$.replyTo,tags:U,communicationId:v,companyId:w,cc:I,bcc:b,attachments:S}),G=Date.now()-W;for(let e of V.attempts)e.success?await (0,f.recordSendSuccess)(e.provider,e.messageId||"",e.latencyMs,{companyId:w,domainId:k||void 0,metadata:{template:p}}):await (0,f.recordSendFailure)(e.provider,e.error||"Unknown error",e.latencyMs,{companyId:w,domainId:k||void 0,metadata:{template:p}});if(V.usedFallback&&V.success){let e=V.attempts.find(e=>"resend"===e.provider);await (0,f.recordFallbackTriggered)("resend","postmark",e?.error||"Primary failed",{companyId:w,metadata:{template:p}})}if(V.success){try{O&&await O.from("email_logs").insert({to:Array.isArray($.to)?$.to.join(", "):$.to,from:F,subject:$.subject,html_body:L,status:"sent",message_id:V.messageId,company_id:w||null,metadata:{template:p,tags:q,provider:V.provider,usedFallback:V.usedFallback,latencyMs:G},sent_at:new Date().toISOString()})}catch(e){}if(k)try{await (0,o.recordDeliveryEvent)({domainId:k,eventType:"delivered",emailId:V.messageId,metadata:{template:p,provider:V.provider}})}catch(e){}return{success:!0,data:{id:V.messageId,message:`Email sent successfully via ${V.provider}${V.usedFallback?" (fallback)":""}`}}}console.error(`[EmailSender] ✗ All providers failed: ${V.error}`);try{O&&await O.from("email_logs").insert({to:Array.isArray($.to)?$.to.join(", "):$.to,from:F,subject:$.subject,html_body:L,status:"failed",error_message:V.error||"All providers failed",company_id:w||null,metadata:{template:p,tags:q,attempts:V.attempts,latencyMs:G},retry_count:0,max_retries:3,next_retry_at:new Date(Date.now()+3e5).toISOString()})}catch(e){}if(k)try{await (0,o.recordDeliveryEvent)({domainId:k,eventType:"bounced",metadata:{error:V.error,template:p,attempts:V.attempts.length}})}catch(e){}return{success:!1,error:V.error||"Failed to send email (all providers failed)"}}catch(e){if(e instanceof s.z.ZodError)return{success:!1,error:e.issues[0]?.message||"Invalid email data"};return{success:!1,error:e instanceof Error?e.message:"Failed to send email"}}}async function y(e,r){let{data:a}=await e.from("companies").select("name").eq("id",r).single(),t=a?.name||"Notification",{data:i}=await e.from("company_email_domains").select("domain_name, is_platform_subdomain").eq("company_id",r).eq("status","verified").eq("sending_enabled",!0).eq("is_suspended",!1).order("is_platform_subdomain",{ascending:!0}).order("created_at",{ascending:!1}).maybeSingle();if(i?.domain_name)return w(t,`notifications@${i.domain_name}`);let{data:s}=await e.from("communication_email_settings").select("smtp_from_email, smtp_from_name").eq("company_id",r).maybeSingle();return s?.smtp_from_email?w(s.smtp_from_name,s.smtp_from_email):null}function w(e,r){return e?.trim()?`${e} <${r}>`:r}function h(e){let r=e.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"");return r=(r=(r=(r=(r=(r=(r=r.replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"")).replace(/<\/(p|div|h[1-6]|li|br|tr)>/gi,"\n")).replace(/<(br|hr)\s*\/?>/gi,"\n")).replace(/<[^>]+>/g," ")).replace(/&nbsp;/gi," ").replace(/&amp;/gi,"&").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&quot;/gi,'"').replace(/&#39;/gi,"'").replace(/&mdash;/gi,"—").replace(/&ndash;/gi,"–")).replace(/\s+/g," ").trim()).replace(/\n\s*\n/g,"\n\n")}async function v(r,a,t,i){let{addToSuppressionList:s,addToGlobalBounceList:n}=await e.A(555200);"hard"===t&&await s(r,a,"bounce",i),await n(a,t,i)}async function E(r,a){let{addToSuppressionList:t}=await e.A(555200);await t(r,a,"complaint","User reported email as spam")}[i]=_.then?(await _)():_,(0,p.ensureServerEntryExports)([g,v,E]),(0,t.registerServerReference)(g,"40f8c061cf84f884e77af3425bc24b8a8d72f598fb",null),(0,t.registerServerReference)(v,"78a8ea4f1cfa571a366adccf36ac04b1c85d61ae2b",null),(0,t.registerServerReference)(E,"6045f8436f9cdfdadb7bfe3955677adfc5f4102de0",null),e.s(["handleBounceWebhook",()=>v,"handleComplaintWebhook",()=>E,"sendEmail",()=>g]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=apps_web_src_lib_email_d758aae7._.js.map