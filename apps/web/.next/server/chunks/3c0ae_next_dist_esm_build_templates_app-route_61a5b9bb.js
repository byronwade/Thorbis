module.exports=[552685,e=>{"use strict";var t=e.i(755535),n=e.i(377233),r=e.i(490003),o=e.i(492991),a=e.i(241970),i=e.i(357699),s=e.i(212454),l=e.i(48717),u=e.i(798301),c=e.i(986366),d=e.i(983537),p=e.i(147475),m=e.i(561930),h=e.i(803747),g=e.i(368557),f=e.i(42037),v=e.i(193695);e.i(432036);var y=e.i(573881),b=e.i(23322),_=e.i(424830),w=e.i(353344),x=e.i(443608);function R({id:e,model:t,created:n}){return{id:null!=e?e:void 0,modelId:null!=t?t:void 0,timestamp:null!=n?new Date(1e3*n):void 0}}var z=x.z.object({reasoningFormat:x.z.enum(["parsed","raw","hidden"]).optional(),reasoningEffort:x.z.string().optional(),parallelToolCalls:x.z.boolean().optional(),user:x.z.string().optional(),structuredOutputs:x.z.boolean().optional(),serviceTier:x.z.enum(["on_demand","flex","auto"]).optional()}),E=x.z.object({error:x.z.object({message:x.z.string(),type:x.z.string()})}),T=(0,w.createJsonErrorResponseHandler)({errorSchema:E,errorToMessage:e=>e.error.message}),I=["openai/gpt-oss-20b","openai/gpt-oss-120b"];function A(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var k=class{constructor(e,t){this.specificationVersion="v2",this.supportedUrls={"image/*":[/^https?:\/\/.*$/]},this.modelId=e,this.config=t}get provider(){return this.config.provider}async getArgs({prompt:e,maxOutputTokens:t,temperature:n,topP:r,topK:o,frequencyPenalty:a,presencePenalty:i,stopSequences:s,responseFormat:l,seed:u,stream:c,tools:d,toolChoice:p,providerOptions:m}){var h,g;let f=[],v=await (0,w.parseProviderOptions)({provider:"groq",providerOptions:m,schema:z}),y=null==(h=null==v?void 0:v.structuredOutputs)||h;null!=o&&f.push({type:"unsupported-setting",setting:"topK"}),(null==l?void 0:l.type)!=="json"||null==l.schema||y||f.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is only supported with structuredOutputs"});let{tools:b,toolChoice:x,toolWarnings:R}=function({tools:e,toolChoice:t,modelId:n}){e=(null==e?void 0:e.length)?e:void 0;let r=[];if(null==e)return{tools:void 0,toolChoice:void 0,toolWarnings:r};let o=[];for(let t of e)if("provider-defined"===t.type)if("groq.browser_search"===t.id)I.includes(n)?o.push({type:"browser_search"}):r.push({type:"unsupported-tool",tool:t,details:`Browser search is only supported on the following models: ${I.join(", ")}. Current model: ${n}`});else r.push({type:"unsupported-tool",tool:t});else o.push({type:"function",function:{name:t.name,description:t.description,parameters:t.inputSchema}});if(null==t)return{tools:o,toolChoice:void 0,toolWarnings:r};let a=t.type;switch(a){case"auto":case"none":case"required":return{tools:o,toolChoice:a,toolWarnings:r};case"tool":return{tools:o,toolChoice:{type:"function",function:{name:t.toolName}},toolWarnings:r};default:throw new _.UnsupportedFunctionalityError({functionality:`tool choice type: ${a}`})}}({tools:d,toolChoice:p,modelId:this.modelId});return{args:{model:this.modelId,user:null==v?void 0:v.user,parallel_tool_calls:null==v?void 0:v.parallelToolCalls,max_tokens:t,temperature:n,top_p:r,frequency_penalty:a,presence_penalty:i,stop:s,seed:u,response_format:(null==l?void 0:l.type)==="json"?y&&null!=l.schema?{type:"json_schema",json_schema:{schema:l.schema,name:null!=(g=l.name)?g:"response",description:l.description}}:{type:"json_object"}:void 0,reasoning_format:null==v?void 0:v.reasoningFormat,reasoning_effort:null==v?void 0:v.reasoningEffort,service_tier:null==v?void 0:v.serviceTier,messages:function(e){let t=[];for(let{role:n,content:r}of e)switch(n){case"system":t.push({role:"system",content:r});break;case"user":if(1===r.length&&"text"===r[0].type){t.push({role:"user",content:r[0].text});break}t.push({role:"user",content:r.map(e=>{switch(e.type){case"text":return{type:"text",text:e.text};case"file":{if(!e.mediaType.startsWith("image/"))throw new _.UnsupportedFunctionalityError({functionality:"Non-image file content parts"});let t="image/*"===e.mediaType?"image/jpeg":e.mediaType;return{type:"image_url",image_url:{url:e.data instanceof URL?e.data.toString():`data:${t};base64,${(0,w.convertToBase64)(e.data)}`}}}}})});break;case"assistant":{let e="",n="",o=[];for(let t of r)switch(t.type){case"reasoning":n+=t.text;break;case"text":e+=t.text;break;case"tool-call":o.push({id:t.toolCallId,type:"function",function:{name:t.toolName,arguments:JSON.stringify(t.input)}})}t.push({role:"assistant",content:e,...n.length>0?{reasoning:n}:null,...o.length>0?{tool_calls:o}:null});break}case"tool":for(let e of r){let n,r=e.output;switch(r.type){case"text":case"error-text":n=r.value;break;case"content":case"json":case"error-json":n=JSON.stringify(r.value)}t.push({role:"tool",tool_call_id:e.toolCallId,content:n})}break;default:throw Error(`Unsupported role: ${n}`)}return t}(e),tools:b,tool_choice:x},warnings:[...f,...R]}}async doGenerate(e){var t,n,r,o,a,i,s,l,u,c;let{args:d,warnings:p}=await this.getArgs({...e,stream:!1}),m=JSON.stringify(d),{responseHeaders:h,value:g,rawValue:f}=await (0,w.postJsonToApi)({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:(0,w.combineHeaders)(this.config.headers(),e.headers),body:d,failedResponseHandler:T,successfulResponseHandler:(0,w.createJsonResponseHandler)(S),abortSignal:e.abortSignal,fetch:this.config.fetch}),v=g.choices[0],y=[],b=v.message.content;null!=b&&b.length>0&&y.push({type:"text",text:b});let _=v.message.reasoning;if(null!=_&&_.length>0&&y.push({type:"reasoning",text:_}),null!=v.message.tool_calls)for(let e of v.message.tool_calls)y.push({type:"tool-call",toolCallId:null!=(t=e.id)?t:(0,w.generateId)(),toolName:e.function.name,input:e.function.arguments});return{content:y,finishReason:A(v.finish_reason),usage:{inputTokens:null!=(r=null==(n=g.usage)?void 0:n.prompt_tokens)?r:void 0,outputTokens:null!=(a=null==(o=g.usage)?void 0:o.completion_tokens)?a:void 0,totalTokens:null!=(s=null==(i=g.usage)?void 0:i.total_tokens)?s:void 0,cachedInputTokens:null!=(c=null==(u=null==(l=g.usage)?void 0:l.prompt_tokens_details)?void 0:u.cached_tokens)?c:void 0},response:{...R(g),headers:h,body:f},warnings:p,request:{body:m}}}async doStream(e){let t,{args:n,warnings:r}=await this.getArgs({...e,stream:!0}),o=JSON.stringify({...n,stream:!0}),{responseHeaders:a,value:i}=await (0,w.postJsonToApi)({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:(0,w.combineHeaders)(this.config.headers(),e.headers),body:{...n,stream:!0},failedResponseHandler:T,successfulResponseHandler:(0,w.createEventSourceResponseHandler)(q),abortSignal:e.abortSignal,fetch:this.config.fetch}),s=[],l="unknown",u={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0,cachedInputTokens:void 0},c=!0,d=!1,p=!1;return{stream:i.pipeThrough(new TransformStream({start(e){e.enqueue({type:"stream-start",warnings:r})},transform(t,n){var r,o,a,i,m,h,g,f,v,y,b,x,z,E,T,I,k,S;if(e.includeRawChunks&&n.enqueue({type:"raw",rawValue:t.rawValue}),!t.success){l="error",n.enqueue({type:"error",error:t.error});return}let q=t.value;if("error"in q){l="error",n.enqueue({type:"error",error:q.error});return}c&&(c=!1,n.enqueue({type:"response-metadata",...R(q)})),(null==(r=q.x_groq)?void 0:r.usage)!=null&&(u.inputTokens=null!=(o=q.x_groq.usage.prompt_tokens)?o:void 0,u.outputTokens=null!=(a=q.x_groq.usage.completion_tokens)?a:void 0,u.totalTokens=null!=(i=q.x_groq.usage.total_tokens)?i:void 0,u.cachedInputTokens=null!=(h=null==(m=q.x_groq.usage.prompt_tokens_details)?void 0:m.cached_tokens)?h:void 0);let C=q.choices[0];if((null==C?void 0:C.finish_reason)!=null&&(l=A(C.finish_reason)),(null==C?void 0:C.delta)==null)return;let N=C.delta;if(null!=N.reasoning&&N.reasoning.length>0&&(p||(n.enqueue({type:"reasoning-start",id:"reasoning-0"}),p=!0),n.enqueue({type:"reasoning-delta",id:"reasoning-0",delta:N.reasoning})),null!=N.content&&N.content.length>0&&(d||(n.enqueue({type:"text-start",id:"txt-0"}),d=!0),n.enqueue({type:"text-delta",id:"txt-0",delta:N.content})),null!=N.tool_calls)for(let e of N.tool_calls){let t=e.index;if(null==s[t]){if("function"!==e.type)throw new _.InvalidResponseDataError({data:e,message:"Expected 'function' type."});if(null==e.id)throw new _.InvalidResponseDataError({data:e,message:"Expected 'id' to be a string."});if((null==(g=e.function)?void 0:g.name)==null)throw new _.InvalidResponseDataError({data:e,message:"Expected 'function.name' to be a string."});n.enqueue({type:"tool-input-start",id:e.id,toolName:e.function.name}),s[t]={id:e.id,type:"function",function:{name:e.function.name,arguments:null!=(f=e.function.arguments)?f:""},hasFinished:!1};let r=s[t];(null==(v=r.function)?void 0:v.name)!=null&&(null==(y=r.function)?void 0:y.arguments)!=null&&(r.function.arguments.length>0&&n.enqueue({type:"tool-input-delta",id:r.id,delta:r.function.arguments}),(0,w.isParsableJson)(r.function.arguments)&&(n.enqueue({type:"tool-input-end",id:r.id}),n.enqueue({type:"tool-call",toolCallId:null!=(b=r.id)?b:(0,w.generateId)(),toolName:r.function.name,input:r.function.arguments}),r.hasFinished=!0));continue}let r=s[t];!r.hasFinished&&((null==(x=e.function)?void 0:x.arguments)!=null&&(r.function.arguments+=null!=(E=null==(z=e.function)?void 0:z.arguments)?E:""),n.enqueue({type:"tool-input-delta",id:r.id,delta:null!=(T=e.function.arguments)?T:""}),(null==(I=r.function)?void 0:I.name)!=null&&(null==(k=r.function)?void 0:k.arguments)!=null&&(0,w.isParsableJson)(r.function.arguments)&&(n.enqueue({type:"tool-input-end",id:r.id}),n.enqueue({type:"tool-call",toolCallId:null!=(S=r.id)?S:(0,w.generateId)(),toolName:r.function.name,input:r.function.arguments}),r.hasFinished=!0))}},flush(e){p&&e.enqueue({type:"reasoning-end",id:"reasoning-0"}),d&&e.enqueue({type:"text-end",id:"txt-0"}),e.enqueue({type:"finish",finishReason:l,usage:u,...null!=t?{providerMetadata:t}:{}})}})),request:{body:o},response:{headers:a}}}},S=x.z.object({id:x.z.string().nullish(),created:x.z.number().nullish(),model:x.z.string().nullish(),choices:x.z.array(x.z.object({message:x.z.object({content:x.z.string().nullish(),reasoning:x.z.string().nullish(),tool_calls:x.z.array(x.z.object({id:x.z.string().nullish(),type:x.z.literal("function"),function:x.z.object({name:x.z.string(),arguments:x.z.string()})})).nullish()}),index:x.z.number(),finish_reason:x.z.string().nullish()})),usage:x.z.object({prompt_tokens:x.z.number().nullish(),completion_tokens:x.z.number().nullish(),total_tokens:x.z.number().nullish(),prompt_tokens_details:x.z.object({cached_tokens:x.z.number().nullish()}).nullish()}).nullish()}),q=x.z.union([x.z.object({id:x.z.string().nullish(),created:x.z.number().nullish(),model:x.z.string().nullish(),choices:x.z.array(x.z.object({delta:x.z.object({content:x.z.string().nullish(),reasoning:x.z.string().nullish(),tool_calls:x.z.array(x.z.object({index:x.z.number(),id:x.z.string().nullish(),type:x.z.literal("function").optional(),function:x.z.object({name:x.z.string().nullish(),arguments:x.z.string().nullish()})})).nullish()}).nullish(),finish_reason:x.z.string().nullable().optional(),index:x.z.number()})),x_groq:x.z.object({usage:x.z.object({prompt_tokens:x.z.number().nullish(),completion_tokens:x.z.number().nullish(),total_tokens:x.z.number().nullish(),prompt_tokens_details:x.z.object({cached_tokens:x.z.number().nullish()}).nullish()}).nullish()}).nullish()}),E]),C=x.z.object({language:x.z.string().nullish(),prompt:x.z.string().nullish(),responseFormat:x.z.string().nullish(),temperature:x.z.number().min(0).max(1).nullish(),timestampGranularities:x.z.array(x.z.string()).nullish()}),N=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2"}get provider(){return this.config.provider}async getArgs({audio:e,mediaType:t,providerOptions:n}){var r,o,a,i,s;let l=await (0,w.parseProviderOptions)({provider:"groq",providerOptions:n,schema:C}),u=new FormData,c=e instanceof Uint8Array?new Blob([e]):new Blob([(0,w.convertBase64ToUint8Array)(e)]);u.append("model",this.modelId);let d=(0,w.mediaTypeToExtension)(t);if(u.append("file",new File([c],"audio",{type:t}),`audio.${d}`),l){let e={language:null!=(r=l.language)?r:void 0,prompt:null!=(o=l.prompt)?o:void 0,response_format:null!=(a=l.responseFormat)?a:void 0,temperature:null!=(i=l.temperature)?i:void 0,timestamp_granularities:null!=(s=l.timestampGranularities)?s:void 0};for(let t in e){let n=e[t];void 0!==n&&u.append(t,String(n))}}return{formData:u,warnings:[]}}async doGenerate(e){var t,n,r,o,a,i,s;let l=null!=(r=null==(n=null==(t=this.config._internal)?void 0:t.currentDate)?void 0:n.call(t))?r:new Date,{formData:u,warnings:c}=await this.getArgs(e),{value:d,responseHeaders:p,rawValue:m}=await (0,w.postFormDataToApi)({url:this.config.url({path:"/audio/transcriptions",modelId:this.modelId}),headers:(0,w.combineHeaders)(this.config.headers(),e.headers),formData:u,failedResponseHandler:T,successfulResponseHandler:(0,w.createJsonResponseHandler)(O),abortSignal:e.abortSignal,fetch:this.config.fetch});return{text:d.text,segments:null!=(a=null==(o=d.segments)?void 0:o.map(e=>({text:e.text,startSecond:e.start,endSecond:e.end})))?a:[],language:null!=(i=d.language)?i:void 0,durationInSeconds:null!=(s=d.duration)?s:void 0,warnings:c,response:{timestamp:l,modelId:this.modelId,headers:p,body:m}}}},O=x.z.object({text:x.z.string(),x_groq:x.z.object({id:x.z.string()}),task:x.z.string().nullish(),language:x.z.string().nullish(),duration:x.z.number().nullish(),segments:x.z.array(x.z.object({id:x.z.number(),seek:x.z.number(),start:x.z.number(),end:x.z.number(),text:x.z.string(),tokens:x.z.array(x.z.number()),temperature:x.z.number(),avg_logprob:x.z.number(),compression_ratio:x.z.number(),no_speech_prob:x.z.number()})).nullish()}),j={browserSearch:(0,w.createProviderDefinedToolFactory)({id:"groq.browser_search",name:"browser_search",inputSchema:x.z.object({})})};function P(e={}){var t;let n=null!=(t=(0,w.withoutTrailingSlash)(e.baseURL))?t:"https://api.groq.com/openai/v1",r=()=>(0,w.withUserAgentSuffix)({Authorization:`Bearer ${(0,w.loadApiKey)({apiKey:e.apiKey,environmentVariableName:"GROQ_API_KEY",description:"Groq"})}`,...e.headers},"ai-sdk/groq/2.0.29"),o=t=>new k(t,{provider:"groq.chat",url:({path:e})=>`${n}${e}`,headers:r,fetch:e.fetch}),a=e=>{if(new.target)throw Error("The Groq model function cannot be called with the new keyword.");return o(e)},i=t=>new N(t,{provider:"groq.transcription",url:({path:e})=>`${n}${e}`,headers:r,fetch:e.fetch}),s=function(e){return a(e)};return s.languageModel=a,s.chat=o,s.textEmbeddingModel=e=>{throw new _.NoSuchModelError({modelId:e,modelType:"textEmbeddingModel"})},s.imageModel=e=>{throw new _.NoSuchModelError({modelId:e,modelType:"imageModel"})},s.transcription=i,s.transcriptionModel=i,s.tools=j,s}P();var H=e.i(476674),G=e.i(297676);let U=`You are an AI assistant specialized in extracting structured information from field service call transcripts.

Your job is to analyze conversations between customer service representatives (CSRs) and customers, then extract relevant information into a structured JSON format.

Focus on extracting:
1. Customer Information: name, email, phone, company, address
2. Job Details: title, description, urgency, job type, estimated duration
3. Appointment Needs: preferred date/time, duration, special requirements

IMPORTANT RULES:
- Only extract information explicitly mentioned in the conversation
- Assign confidence scores (0-100) based on clarity and completeness
- If information is unclear or partially mentioned, use lower confidence scores
- For addresses, try to extract full address components (street, city, state, zip)
- For dates/times, convert natural language to ISO format when possible
- Distinguish between urgent and non-urgent issues
- Identify the primary reason for the call (job type)

Return JSON with this exact structure:
{
  "customerInfo": {
    "name": string | null,
    "email": string | null,
    "phone": string | null,
    "company": string | null,
    "address": {
      "street": string | null,
      "city": string | null,
      "state": string | null,
      "zipCode": string | null,
      "full": string | null
    },
    "confidence": number
  },
  "jobDetails": {
    "title": string | null,
    "description": string | null,
    "urgency": "low" | "normal" | "high" | "emergency" | null,
    "type": string | null,
    "estimatedDuration": number | null,
    "confidence": number
  },
  "appointmentNeeds": {
    "preferredDate": string | null,
    "preferredTime": string | null,
    "timePreference": "morning" | "afternoon" | "evening" | "anytime" | null,
    "duration": number | null,
    "specialRequirements": string | null,
    "confidence": number
  },
  "callSummary": string,
  "sentiment": "positive" | "neutral" | "negative",
  "tags": string[]
}`,D=`Analyze the following call transcript and extract all relevant information:

TRANSCRIPT:
{transcript}

Extract customer information, job details, and appointment needs. Be thorough but only include information that is clearly stated. Assign confidence scores based on how explicit and complete the information is.`,F=`You previously extracted information from a call transcript. Here is the new portion of the conversation:

PREVIOUS EXTRACTION:
{previousExtraction}

NEW TRANSCRIPT PORTION:
{newTranscript}

Update the extraction with any new information found. Maintain or update confidence scores. Only change fields that have new or contradicting information.`,M=process.env.GROQ_API_KEY?P({apiKey:process.env.GROQ_API_KEY}):null,$=process.env.GOOGLE_GENERATIVE_AI_API_KEY?(0,b.createGoogleGenerativeAI)({apiKey:process.env.GOOGLE_GENERATIVE_AI_API_KEY}):null;async function K(e){try{let t,{transcript:n,previousExtraction:r,mode:o="full"}=await e.json();if(!(n&&Array.isArray(n)))return G.NextResponse.json({error:"Invalid transcript format"},{status:400});let a=n.map(e=>{let t=e.timestamp.toLocaleTimeString(),n="csr"===e.speaker?"CSR":"Customer";return`[${t}] ${n}: ${e.text}`}).join("\n");return t="update"===o&&r?F.replace("{previousExtraction}",JSON.stringify(r)).replace("{newTranscript}",a):D.replace("{transcript}",a),(0,H.streamText)({model:function(){if(M)return M("llama-3.3-70b-versatile");if($)return $("gemini-2.0-flash-exp");throw Error("No AI provider configured. Please set GROQ_API_KEY or GOOGLE_GENERATIVE_AI_API_KEY")}(),system:U,prompt:t,temperature:.3}).toTextStreamResponse()}catch(e){return G.NextResponse.json({error:"Failed to extract data",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function J(){let e=!!process.env.GROQ_API_KEY,t=!!process.env.GOOGLE_GENERATIVE_AI_API_KEY;return G.NextResponse.json({status:"ok",providers:{groq:e,google:t},activeProvider:e?"groq":t?"google":"none"})}e.s(["GET",()=>J,"POST",()=>K],705485);var V=e.i(705485);let L=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/ai/extract-call-data/route",pathname:"/api/ai/extract-call-data",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/ai/extract-call-data/route.ts",nextConfigOutput:"",userland:V}),{workAsyncStorage:B,workUnitAsyncStorage:Y,serverHooks:Q}=L;function W(){return(0,r.patchFetch)({workAsyncStorage:B,workUnitAsyncStorage:Y})}async function X(e,t,r){L.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let b="/api/ai/extract-call-data/route";b=b.replace(/\/index$/,"")||"/";let _=await L.prepare(e,t,{srcPage:b,multiZoneDraftMode:!1});if(!_)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:x,nextConfig:R,parsedUrl:z,isDraftMode:E,prerenderManifest:T,routerServerContext:I,isOnDemandRevalidate:A,revalidateOnlyGenerated:k,resolvedPathname:S,clientReferenceManifest:q,serverActionsManifest:C}=_,N=(0,l.normalizeAppPath)(b),O=!!(T.dynamicRoutes[N]||T.routes[S]),j=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,z,!1):t.end("This page could not be found"),null);if(O&&!E){let e=!!T.routes[S],t=T.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await j();throw new v.NoFallbackError}}let P=null;!O||L.isDev||E||(P="/index"===(P=S)?"/":P);let H=!0===L.isDev||!O,G=O&&!H;C&&q&&(0,i.setReferenceManifestsSingleton)({page:b,clientReferenceManifest:q,serverActionsManifest:C,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:C})});let U=e.method||"GET",D=(0,a.getTracer)(),F=D.getActiveScopeSpan(),M={params:x,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r)=>L.onRequestError(e,t,r,I)},sharedContext:{buildId:w}},$=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),J=c.NextRequestAdapter.fromNodeNextRequest($,(0,c.signalFromNodeResponse)(t));try{let i=async e=>L.handle(J,M).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=D.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=n.get("next.route");if(r){let t=`${U} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${b}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var a,l;let u=async({previousCacheEntry:n})=>{try{if(!s&&A&&k&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await i(o);e.fetchMetrics=M.renderOpts.fetchMetrics;let l=M.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=M.renderOpts.collectedTags;if(!O)return await (0,m.sendResponse)($,K,a,M.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,r=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:r}}}}catch(t){throw(null==n?void 0:n.isStale)&&await L.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:G,isOnDemandRevalidate:A})},I),t}},c=await L.handleResponse({req:e,nextConfig:R,cacheKey:P,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:k,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:s});if(!O)return null;if((null==c||null==(a=c.value)?void 0:a.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",A?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&O||d.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)($,K,new Response(c.value.body,{headers:d,status:c.value.status||200})),null};F?await l(F):await D.withPropagatedContext(e.headers,()=>D.trace(d.BaseServerSpan.handleRequest,{spanName:`${U} ${b}`,kind:a.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await L.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:G,isOnDemandRevalidate:A})}),O)throw t;return await (0,m.sendResponse)($,K,new Response(null,{status:500})),null}}e.s(["handler",()=>X,"patchFetch",()=>W,"routeModule",()=>L,"serverHooks",()=>Q,"workAsyncStorage",()=>B,"workUnitAsyncStorage",()=>Y],552685)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_61a5b9bb.js.map