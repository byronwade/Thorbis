{"version":3,"sources":["../../../../../apps/web/src/actions/telnyx.ts","../../../../../apps/web/src/lib/telnyx/provision-company.ts"],"sourcesContent":["/**\n * Telnyx Server Actions\n *\n * Server-side actions for Telnyx VoIP operations:\n * - Phone number management\n * - Call operations\n * - SMS operations\n * - Voicemail operations\n *\n * All actions include proper authentication and authorization checks.\n */\n\n\"use server\";\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { revalidatePath } from \"next/cache\";\nimport { headers } from \"next/headers\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport {\n\tanswerCall,\n\thangupCall,\n\tinitiateCall,\n\trejectCall,\n\tstartRecording,\n\tstopRecording,\n} from \"@/lib/telnyx/calls\";\nimport { TELNYX_CONFIG } from \"@/lib/telnyx/client\";\nimport {\n\tvalidateCallConfig,\n\tvalidateSmsConfig,\n} from \"@/lib/telnyx/config-validator\";\nimport { verifyConnection } from \"@/lib/telnyx/connection-setup\";\nimport { formatPhoneNumber, sendMMS, sendSMS } from \"@/lib/telnyx/messaging\";\nimport { verifyMessagingProfile } from \"@/lib/telnyx/messaging-profile-setup\";\nimport {\n\ttype NumberFeature,\n\ttype NumberType,\n\tpurchaseNumber,\n\treleaseNumber,\n\tsearchAvailableNumbers,\n} from \"@/lib/telnyx/numbers\";\nimport {\n\tverifySmsCapability,\n\tverifyVoiceCapability,\n} from \"@/lib/telnyx/phone-number-setup\";\nimport {\n\ttype CompanyTelnyxSettingsRow,\n\tensureCompanyTelnyxSetup,\n\tfetchCompanyTelnyxSettings,\n} from \"@/lib/telnyx/provision-company\";\nimport type { Database, Json } from \"@/types/supabase\";\nimport { ensureMessagingCampaign } from \"./messaging-branding\";\n\ntype TypedSupabaseClient = SupabaseClient<Database>;\n\nfunction normalizePhoneNumber(phoneNumber: string): string {\n\treturn formatPhoneNumber(phoneNumber);\n}\n\nfunction extractAreaCode(phoneNumber: string): string | null {\n\tconst digits = phoneNumber.replace(/\\D/g, \"\");\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn digits.slice(1, 4);\n\t}\n\tif (digits.length === 10) {\n\t\treturn digits.slice(0, 3);\n\t}\n\treturn null;\n}\n\nconst DEFAULT_MESSAGING_PROFILE_ID =\n\tprocess.env.TELNYX_DEFAULT_MESSAGING_PROFILE_ID ||\n\tprocess.env.NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID ||\n\t\"\";\n\nconst DEFAULT_PHONE_NUMBER_FEATURES: Json = [\"voice\", \"sms\", \"mms\"];\n\nfunction formatDisplayPhoneNumber(phoneNumber: string): string {\n\tconst digits = phoneNumber.replace(/\\D/g, \"\");\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn `+1 (${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;\n\t}\n\tif (digits.length === 10) {\n\t\treturn `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;\n\t}\n\treturn phoneNumber;\n}\n\nasync function getCompanyTelnyxSettings(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string | null,\n): Promise<CompanyTelnyxSettingsRow | null> {\n\tif (!companyId) {\n\t\treturn null;\n\t}\n\n\tconst existing = await fetchCompanyTelnyxSettings(supabase, companyId);\n\tif (existing && existing.status === \"ready\") {\n\t\treturn existing;\n\t}\n\n\tconst provisionResult = await ensureCompanyTelnyxSetup({\n\t\tcompanyId,\n\t\tsupabase,\n\t});\n\n\tif (!provisionResult.success) {\n\t\treturn null;\n\t}\n\n\treturn provisionResult.settings ?? null;\n}\n\nfunction normalizeBaseUrl(url: string): string {\n\tconst trimmed = url.trim().replace(/\\/+$/, \"\");\n\tif (/^https?:\\/\\//i.test(trimmed)) {\n\t\tif (/^http:\\/\\//i.test(trimmed) && !isLocalUrl(trimmed)) {\n\t\t\treturn trimmed.replace(/^http:\\/\\//i, \"https://\");\n\t\t}\n\t\treturn trimmed;\n\t}\n\treturn `https://${trimmed}`;\n}\n\nfunction isLocalUrl(url: string): boolean {\n\tconst lowered = url.toLowerCase();\n\treturn (\n\t\tlowered.includes(\"localhost\") ||\n\t\tlowered.includes(\"127.0.0.1\") ||\n\t\tlowered.includes(\"0.0.0.0\") ||\n\t\tlowered.endsWith(\".local\") ||\n\t\tlowered.includes(\"://local\")\n\t);\n}\n\nfunction shouldUseUrl(url: string): boolean {\n\tif (!url) {\n\t\treturn false;\n\t}\n\tconst trimmed = url.trim();\n\tif (!trimmed) {\n\t\treturn false;\n\t}\n\tconst isHostedProduction =\n\t\t(process.env.VERCEL === \"1\" && process.env.VERCEL_ENV === \"production\") ||\n\t\tprocess.env.DEPLOYMENT_ENV === \"production\";\n\n\tif (isHostedProduction && isLocalUrl(trimmed)) {\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nasync function getBaseAppUrl(): Promise<string | undefined> {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\tfor (const candidate of candidates) {\n\t\tif (candidate && shouldUseUrl(candidate)) {\n\t\t\treturn normalizeBaseUrl(candidate);\n\t\t}\n\t}\n\n\tconst vercelUrl = process.env.VERCEL_URL;\n\tif (vercelUrl && shouldUseUrl(vercelUrl)) {\n\t\treturn normalizeBaseUrl(\n\t\t\tvercelUrl.startsWith(\"http\") ? vercelUrl : `https://${vercelUrl}`,\n\t\t);\n\t}\n\n\ttry {\n\t\tconst hdrs = await headers();\n\t\tconst origin = hdrs.get(\"origin\");\n\t\tif (origin && shouldUseUrl(origin)) {\n\t\t\treturn normalizeBaseUrl(origin);\n\t\t}\n\t\tconst host = hdrs.get(\"host\");\n\t\tif (host && shouldUseUrl(host)) {\n\t\t\tconst protocol = host.includes(\"localhost\") ? \"http\" : \"https\";\n\t\t\treturn normalizeBaseUrl(`${protocol}://${host}`);\n\t\t}\n\t} catch {\n\t\t// headers() not available outside of a request context\n\t}\n\n\treturn undefined;\n}\n\nasync function buildAbsoluteUrl(path: string): Promise<string | undefined> {\n\tconst base = await getBaseAppUrl();\n\tif (!base) {\n\t\treturn undefined;\n\t}\n\tconst normalizedPath = path.startsWith(\"/\") ? path : `/${path}`;\n\treturn `${base}${normalizedPath}`;\n}\n\nasync function getTelnyxWebhookUrl(\n\tcompanyId?: string,\n): Promise<string | undefined> {\n\tif (companyId) {\n\t\treturn buildAbsoluteUrl(`/api/webhooks/telnyx?company=${companyId}`);\n\t}\n\treturn buildAbsoluteUrl(\"/api/webhooks/telnyx\");\n}\n\nasync function getPhoneNumberId(\n\tsupabase: TypedSupabaseClient,\n\tphoneNumber: string,\n): Promise<string | null> {\n\tconst normalized = normalizePhoneNumber(phoneNumber);\n\tconst { data } = await supabase\n\t\t.from(\"phone_numbers\")\n\t\t.select(\"id\")\n\t\t.eq(\"phone_number\", normalized)\n\t\t.is(\"deleted_at\", null)\n\t\t.maybeSingle();\n\n\treturn data?.id ?? null;\n}\n\nasync function ensurePhoneNumberRecordExists(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n\tphoneNumber: string | null,\n): Promise<void> {\n\tif (!phoneNumber) {\n\t\treturn;\n\t}\n\n\tconst normalized = normalizePhoneNumber(phoneNumber);\n\tconst { data } = await supabase\n\t\t.from(\"phone_numbers\")\n\t\t.select(\"id\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.eq(\"phone_number\", normalized)\n\t\t.limit(1);\n\n\tif (data && data.length > 0) {\n\t\treturn;\n\t}\n\n\tawait supabase.from(\"phone_numbers\").insert({\n\t\tcompany_id: companyId,\n\t\tphone_number: normalized,\n\t\tformatted_number: formatDisplayPhoneNumber(normalized),\n\t\tcountry_code: \"US\",\n\t\tarea_code: extractAreaCode(normalized),\n\t\tnumber_type: \"local\",\n\t\tstatus: \"active\",\n\t\tfeatures: DEFAULT_PHONE_NUMBER_FEATURES,\n\t});\n}\n\nasync function resolveOutboundPhoneNumber(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n\texplicitFrom?: string | null,\n\tdefaultNumber?: string | null,\n): Promise<string | null> {\n\tif (explicitFrom) {\n\t\treturn normalizePhoneNumber(explicitFrom);\n\t}\n\n\tconst normalizedDefault = defaultNumber\n\t\t? normalizePhoneNumber(defaultNumber)\n\t\t: null;\n\n\ttry {\n\t\tconst { data } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"phone_number, number_type\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"status\", \"active\");\n\n\t\tif (data && data.length > 0) {\n\t\t\tconst tollFree = data.find((n) => n.number_type === \"toll-free\");\n\t\t\tif (tollFree) {\n\t\t\t\treturn normalizePhoneNumber(tollFree.phone_number);\n\t\t\t}\n\n\t\t\tif (normalizedDefault) {\n\t\t\t\tconst defaultExists = data.some(\n\t\t\t\t\t(n) => normalizePhoneNumber(n.phone_number) === normalizedDefault,\n\t\t\t\t);\n\t\t\t\tif (defaultExists) {\n\t\t\t\t\treturn normalizedDefault;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn normalizePhoneNumber(data[0].phone_number);\n\t\t}\n\t} catch (error) {\n\t\tconsole.warn(\n\t\t\t\"Failed to load company phone numbers for outbound selection:\",\n\t\t\terror,\n\t\t);\n\t}\n\n\treturn normalizedDefault;\n}\n\nasync function mergeProviderMetadata(\n\tsupabase: TypedSupabaseClient,\n\tcommunicationId: string,\n\tpatch: Record<string, Json>,\n): Promise<void> {\n\tconst { data } = await supabase\n\t\t.from(\"communications\")\n\t\t.select(\"provider_metadata\")\n\t\t.eq(\"id\", communicationId)\n\t\t.maybeSingle();\n\n\tconst currentMetadata =\n\t\t(data?.provider_metadata as Record<string, Json> | null) ?? {};\n\tconst mergedMetadata: Record<string, Json> = {\n\t\t...currentMetadata,\n\t\t...patch,\n\t};\n\n\tawait supabase\n\t\t.from(\"communications\")\n\t\t.update({\n\t\t\tprovider_metadata: mergedMetadata,\n\t\t})\n\t\t.eq(\"id\", communicationId);\n}\n\n// =====================================================================================\n// PHONE NUMBER MANAGEMENT ACTIONS\n// =====================================================================================\n\n/**\n * Search for available phone numbers to purchase\n */\nexport async function searchPhoneNumbers(params: {\n\tareaCode?: string;\n\tnumberType?: NumberType;\n\tfeatures?: NumberFeature[];\n\tlimit?: number;\n}) {\n\ttry {\n\t\tconst result = await searchAvailableNumbers({\n\t\t\tcountryCode: \"US\",\n\t\t\tareaCode: params.areaCode,\n\t\t\tnumberType: params.numberType,\n\t\t\tfeatures: params.features,\n\t\t\tlimit: params.limit || 10,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to search phone numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Purchase a phone number and associate it with the current company\n */\nexport async function purchasePhoneNumber(params: {\n\tphoneNumber: string;\n\tcompanyId: string;\n\tbillingGroupId?: string;\n}) {\n\ttry {\n\t\t// Validate configuration\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tconst callConfig = validateCallConfig();\n\t\tif (!smsConfig.valid || !callConfig.valid) {\n\t\t\tlet errorMessage =\n\t\t\t\t\"Telnyx configuration is incomplete. Please configure all required environment variables.\";\n\n\t\t\t// If we have a suggested profile ID, include it in the error\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} to use it.`;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst normalizedPhoneNumber = normalizePhoneNumber(params.phoneNumber);\n\t\tconst formattedNumber = formatDisplayPhoneNumber(normalizedPhoneNumber);\n\t\tconst areaCode = extractAreaCode(normalizedPhoneNumber);\n\n\t\t// Purchase number from Telnyx\n\t\tconst messagingProfileId = DEFAULT_MESSAGING_PROFILE_ID || undefined;\n\n\t\tconst result = await purchaseNumber({\n\t\t\tphoneNumber: normalizedPhoneNumber,\n\t\t\tconnectionId: TELNYX_CONFIG.connectionId,\n\t\t\tmessagingProfileId,\n\t\t\tbillingGroupId: params.billingGroupId,\n\t\t\tcustomerReference: `company_${params.companyId}`,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\t// Store in database\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: params.companyId,\n\t\t\t\ttelnyx_phone_number_id: result.orderId,\n\t\t\t\ttelnyx_connection_id: TELNYX_CONFIG.connectionId,\n\t\t\t\tphone_number: normalizedPhoneNumber,\n\t\t\t\tformatted_number: formattedNumber,\n\t\t\t\tcountry_code: \"US\",\n\t\t\t\tarea_code: areaCode,\n\t\t\t\tnumber_type: \"local\",\n\t\t\t\tfeatures: [\"voice\", \"sms\"],\n\t\t\t\tstatus: \"pending\",\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\ttry {\n\t\t\tawait ensureMessagingCampaign(\n\t\t\t\tparams.companyId,\n\t\t\t\t{ id: data.id, e164: normalizedPhoneNumber },\n\t\t\t\t{ supabase },\n\t\t\t);\n\t\t} catch (_campaignError) {}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to purchase phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Get all phone numbers for a company\n */\nexport async function getCompanyPhoneNumbers(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"created_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get phone numbers\",\n\t\t};\n\t}\n}\n\n/**\n * Update phone number configuration\n */\nasync function updatePhoneNumber(params: {\n\tphoneNumberId: string;\n\troutingRuleId?: string;\n\tforwardToNumber?: string;\n\tvoicemailEnabled?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.update({\n\t\t\t\tcall_routing_rule_id: params.routingRuleId,\n\t\t\t\tforward_to_number: params.forwardToNumber,\n\t\t\t\tvoicemail_enabled: params.voicemailEnabled,\n\t\t\t})\n\t\t\t.eq(\"id\", params.phoneNumberId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to update phone number\",\n\t\t};\n\t}\n}\n\n/**\n * Release (delete) a phone number\n */\nasync function deletePhoneNumber(phoneNumberId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get phone number details\n\t\tconst { data: phoneNumber } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"id\", phoneNumberId)\n\t\t\t.single();\n\n\t\tif (!phoneNumber) {\n\t\t\treturn { success: false, error: \"Phone number not found\" };\n\t\t}\n\n\t\t// Release from Telnyx if we have the ID\n\t\tif (phoneNumber.telnyx_phone_number_id) {\n\t\t\tawait releaseNumber(phoneNumber.telnyx_phone_number_id);\n\t\t}\n\n\t\t// Soft delete in database\n\t\tconst { error } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tstatus: \"deleted\",\n\t\t\t})\n\t\t\t.eq(\"id\", phoneNumberId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/phone-numbers\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to delete phone number\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// CALL OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Initiate an outbound call\n */\nexport async function makeCall(params: {\n\tto: string;\n\tfrom: string;\n\tcompanyId: string;\n\tcustomerId?: string;\n\tjobId?: string;\n\tpropertyId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconsole.log(\"ðŸ“ž makeCall called with params:\", params);\n\n\t\tconst callConfig = validateCallConfig();\n\t\tconsole.log(\"ðŸ” Call config validation:\", callConfig);\n\t\tif (!callConfig.valid) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: callConfig.error || \"Call configuration is invalid\",\n\t\t\t};\n\t\t}\n\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t);\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t\tcompanySettings?.default_outbound_number || null,\n\t\t);\n\n\t\tconst connectionOverride =\n\t\t\tcompanySettings?.call_control_application_id ||\n\t\t\tTELNYX_CONFIG.connectionId;\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tparams.companyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings?.default_outbound_number || null,\n\t\t);\n\n\t\tif (!connectionOverride) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"No Telnyx connection configured for this company.\",\n\t\t\t};\n\t\t}\n\n\t\tif (!fromAddress) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured. Please provision numbers first.\",\n\t\t\t};\n\t\t}\n\n\t\t// TEMP: Skip connection verification - Level 2 required for API access\n\t\t// const connectionStatus = await verifyConnection(connectionOverride);\n\t\t// if (connectionStatus.needsFix) {\n\t\t// \treturn {\n\t\t// \t\tsuccess: false,\n\t\t// \t\terror: `Connection configuration issue: ${connectionStatus.issues.join(\", \")}. Run fixConnection() to auto-fix.`,\n\t\t// \t};\n\t\t// }\n\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\n\t\t// TEMP: Skip voice capability check - Level 2 required for API access\n\t\t// const voiceCapability = await verifyVoiceCapability(fromAddress);\n\t\t// if (!voiceCapability.hasVoice) {\n\t\t// \treturn {\n\t\t// \t\tsuccess: false,\n\t\t// \t\terror:\n\t\t// \t\t\tvoiceCapability.error || \"Phone number does not support voice calls\",\n\t\t// \t};\n\t\t// }\n\n\t\tconst telnyxWebhookUrl = await getTelnyxWebhookUrl(params.companyId);\n\t\tconsole.log(\"ðŸ”— Webhook URL:\", telnyxWebhookUrl);\n\t\tif (!telnyxWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\n\t\tconsole.log(\"ðŸ“¤ Initiating call:\", {\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\tconnectionId: connectionOverride,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t});\n\n\t\tconst result = await initiateCall({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\tconnectionId: connectionOverride,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t\tansweringMachineDetection: \"premium\",\n\t\t});\n\n\t\tconsole.log(\"ðŸ“¥ Telnyx API response:\", result);\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tproperty_id: params.propertyId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"phone\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: \"\",\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_call_control_id: result.callControlId,\n\t\t\t\ttelnyx_call_session_id: result.callSessionId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\tconsole.log(\"âœ… Call created successfully:\", {\n\t\t\tcallControlId: result.callControlId,\n\t\t\tcommunicationId: data.id,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcallControlId: result.callControlId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"âŒ makeCall error:\", error);\n\t\tconsole.error(\"Error details:\", {\n\t\t\tmessage: error instanceof Error ? error.message : String(error),\n\t\t\tstack: error instanceof Error ? error.stack : undefined,\n\t\t});\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to make call\",\n\t\t};\n\t}\n}\n\n/**\n * Answer an incoming call\n/**\n * Answer an incoming call\n */\nasync function acceptCall(callControlId: string) {\n\ttry {\n\t\tconst telnyxWebhookUrl = await getTelnyxWebhookUrl();\n\t\tif (!telnyxWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\t\tconst result = await answerCall({\n\t\t\tcallControlId,\n\t\t\twebhookUrl: telnyxWebhookUrl,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to answer call\",\n\t\t};\n\t}\n}\n\n/**\n * Reject an incoming call\n */\nasync function declineCall(callControlId: string) {\n\ttry {\n\t\tconst result = await rejectCall({\n\t\t\tcallControlId,\n\t\t\tcause: \"CALL_REJECTED\",\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to reject call\",\n\t\t};\n\t}\n}\n\n/**\n * End an active call\n */\nasync function endCall(callControlId: string) {\n\ttry {\n\t\tconst result = await hangupCall({ callControlId });\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to end call\",\n\t\t};\n\t}\n}\n\n/**\n * Start recording a call\n */\nexport async function startCallRecording(callControlId: string) {\n\ttry {\n\t\tconst result = await startRecording({\n\t\t\tcallControlId,\n\t\t\tformat: \"mp3\",\n\t\t\tchannels: \"single\",\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to start recording\",\n\t\t};\n\t}\n}\n\n/**\n * Stop recording a call\n */\nexport async function stopCallRecording(callControlId: string) {\n\ttry {\n\t\tconst result = await stopRecording({ callControlId });\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to stop recording\",\n\t\t};\n\t}\n}\n\n/**\n * Transfer an active call to another number\n */\nexport async function transferActiveCall(params: {\n\tcallControlId: string;\n\tto: string;\n\tfrom: string;\n}) {\n\ttry {\n\t\tconst { transferCall } = await import(\"@/lib/telnyx/calls\");\n\t\tconst result = await transferCall({\n\t\t\tcallControlId: params.callControlId,\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t});\n\n\t\treturn result;\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to transfer call\",\n\t\t};\n\t}\n}\n\n/**\n * Transcribe a call recording using AssemblyAI\n *\n * Submits the recording URL to AssemblyAI for post-call transcription.\n * AssemblyAI will process the audio and send the transcript via webhook.\n *\n * @param recordingUrl - URL of the call recording (from Telnyx)\n * @param communicationId - Database ID of the communication record\n * @returns Success/error response with transcription job ID\n */\nexport async function transcribeCallRecording(params: {\n\trecordingUrl: string;\n\tcommunicationId: string;\n}) {\n\ttry {\n\t\tconst { submitTranscription } = await import(\"@/lib/assemblyai/client\");\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst webhookUrl = await buildAbsoluteUrl(\"/api/webhooks/assemblyai\");\n\t\tif (!webhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL.\",\n\t\t\t};\n\t\t}\n\n\t\t// Submit to AssemblyAI\n\t\tconst result = await submitTranscription({\n\t\t\taudio_url: params.recordingUrl,\n\t\t\tspeaker_labels: true, // Enable speaker diarization\n\t\t\twebhook_url: webhookUrl,\n\t\t});\n\n\t\tif (!(result.success && result.data)) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: result.error || \"Failed to submit transcription\",\n\t\t\t};\n\t\t}\n\n\t\t// Store transcription job ID in database\n\t\tawait mergeProviderMetadata(supabase, params.communicationId, {\n\t\t\tassemblyai_transcription_id: result.data.id,\n\t\t\tassemblyai_status: result.data.status,\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\ttranscriptionId: result.data.id,\n\t\t\tstatus: result.data.status,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to transcribe recording\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// SMS OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Send an SMS message\n */\nexport async function sendTextMessage(params: {\n\tto: string;\n\tfrom: string;\n\ttext: string;\n\tcompanyId?: string; // Optional - will be fetched if not provided\n\tcustomerId?: string;\n\tjobId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\tconsole.error(\"âŒ Supabase client unavailable\");\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get company ID if not provided\n\t\tlet companyId = params.companyId;\n\t\tif (!companyId) {\n\t\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\t\tcompanyId = await getActiveCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t\t}\n\t\t}\n\n\t\tconsole.log(\"ðŸ“± SMS Send Request:\", {\n\t\t\tto: params.to,\n\t\t\tfrom: params.from,\n\t\t\tcompanyId,\n\t\t});\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t);\n\t\tif (!companySettings) {\n\t\t\tconsole.error(\"âŒ Company settings not found\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Unable to provision Telnyx resources for this company. Please verify the company's onboarding is complete and try again.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\"âœ… Company settings loaded:\", {\n\t\t\tmessagingProfileId: companySettings.messaging_profile_id,\n\t\t\tdefaultNumber: companySettings.default_outbound_number,\n\t\t});\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tif (!smsConfig.valid && !companySettings?.messaging_profile_id) {\n\t\t\tlet errorMessage = smsConfig.error || \"SMS configuration is invalid\";\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} or provision company-specific settings.`;\n\t\t\t}\n\t\t\tconsole.error(\"âŒ SMS config invalid:\", errorMessage);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\t\tconsole.log(\"âœ… SMS config valid\");\n\n\t\tconst messagingProfileId =\n\t\t\tcompanySettings?.messaging_profile_id || DEFAULT_MESSAGING_PROFILE_ID;\n\t\tif (!messagingProfileId) {\n\t\t\tconsole.error(\"âŒ No messaging profile ID\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Messaging profile is not configured for this company. Please provision communications before sending SMS.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\"âœ… Using messaging profile:\", messagingProfileId);\n\n\t\tif (messagingProfileId) {\n\t\t\tconst messagingProfileStatus =\n\t\t\t\tawait verifyMessagingProfile(messagingProfileId);\n\t\t\tif (messagingProfileStatus.needsFix) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t\"âŒ Messaging profile needs fix:\",\n\t\t\t\t\tmessagingProfileStatus.issues,\n\t\t\t\t);\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Messaging profile configuration issue: ${messagingProfileStatus.issues.join(\", \")}. Run fixMessagingProfile() or reprovision the company.`,\n\t\t\t\t};\n\t\t\t}\n\t\t\tconsole.log(\"âœ… Messaging profile verified\");\n\t\t}\n\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\t\tif (!fromAddress) {\n\t\t\tconsole.error(\"âŒ No from number available\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured. Please provision numbers first.\",\n\t\t\t};\n\t\t}\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\t\tconsole.log(\"âœ… Phone numbers normalized:\", {\n\t\t\tfrom: fromAddress,\n\t\t\tto: toAddress,\n\t\t});\n\n\t\t// Verify phone number has SMS capability\n\t\tconsole.log(\"ðŸ” Verifying SMS capability for:\", fromAddress);\n\t\tconst smsCapability = await verifySmsCapability(fromAddress);\n\t\tif (!smsCapability.hasSms) {\n\t\t\tconsole.error(\"âŒ SMS capability check failed:\", smsCapability.error);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: smsCapability.error || \"Phone number does not support SMS\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\"âœ… SMS capability verified\");\n\n\t\tconst webhookUrl = await getTelnyxWebhookUrl(companyId);\n\t\tif (!webhookUrl) {\n\t\t\tconsole.error(\"âŒ No webhook URL\");\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\t\tconsole.log(\"âœ… Webhook URL:\", webhookUrl);\n\n\t\t// Send SMS via Telnyx\n\t\tconsole.log(\"ðŸ“¤ Sending SMS via Telnyx API...\");\n\t\tconst result = await sendSMS({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\ttext: params.text,\n\t\t\twebhookUrl,\n\t\t\tmessagingProfileId,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\tconsole.error(\"âŒ Telnyx API failed:\", result.error);\n\n\t\t\t// Check if error is 10DLC registration required\n\t\t\tif (\n\t\t\t\tresult.error &&\n\t\t\t\t(result.error.includes(\"10DLC\") ||\n\t\t\t\t\tresult.error.includes(\"Not 10DLC registered\") ||\n\t\t\t\t\tresult.error.includes(\"A2P\"))\n\t\t\t) {\n\t\t\t\tconsole.log(\n\t\t\t\t\t\"ðŸ”„ Detected 10DLC registration required, attempting auto-registration...\",\n\t\t\t\t);\n\n\t\t\t\t// Import 10DLC registration function\n\t\t\t\tconst { registerCompanyFor10DLC } = await import(\n\t\t\t\t\t\"@/actions/ten-dlc-registration\"\n\t\t\t\t);\n\n\t\t\t\tconst registrationResult = await registerCompanyFor10DLC(\n\t\t\t\t\tcompanyId,\n\t\t\t\t);\n\n\t\t\t\tif (registrationResult.success) {\n\t\t\t\t\tconsole.log(\"âœ… 10DLC registration successful, retrying SMS send...\");\n\n\t\t\t\t\t// Retry the SMS send now that 10DLC is registered\n\t\t\t\t\tconst retryResult = await sendSMS({\n\t\t\t\t\t\tto: toAddress,\n\t\t\t\t\t\tfrom: fromAddress,\n\t\t\t\t\t\ttext: params.text,\n\t\t\t\t\t\twebhookUrl,\n\t\t\t\t\t\tmessagingProfileId,\n\t\t\t\t\t});\n\n\t\t\t\t\tif (!retryResult.success) {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\terror: `10DLC registration completed but SMS still failed: ${retryResult.error}. The campaign may need additional approval time.`,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\t// Update result with retry success\n\t\t\t\t\tresult.success = true;\n\t\t\t\t\tresult.messageId = retryResult.messageId;\n\t\t\t\t\tconsole.log(\"âœ… SMS retry successful after 10DLC registration\");\n\t\t\t\t} else {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: `10DLC registration failed: ${registrationResult.error}. Original error: ${result.error}`,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treturn result;\n\t\t\t}\n\t\t}\n\t\tconsole.log(\"âœ… Telnyx API success:\", result.messageId);\n\n\t\t// Create communication record\n\t\tconsole.log(\"ðŸ’¾ Creating communication record in database...\");\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"sms\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: params.text,\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_message_id: result.messageId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.messageId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\tconsole.error(\"SMS send error:\", error);\n\t\tconsole.error(\"Error details:\", {\n\t\t\tmessage: error instanceof Error ? error.message : String(error),\n\t\t\tstack: error instanceof Error ? error.stack : undefined,\n\t\t\ttype: typeof error,\n\t\t\tstringified: JSON.stringify(error, null, 2),\n\t\t});\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: `Failed to send SMS: ${String(error)}`,\n\t\t};\n\t}\n}\n\n/**\n * Send an MMS message with media\n */\nexport async function sendMMSMessage(params: {\n\tto: string;\n\tfrom: string;\n\ttext?: string;\n\tmediaUrls: string[];\n\tcompanyId?: string; // Optional - will be fetched if not provided\n\tcustomerId?: string;\n\tjobId?: string;\n\tpropertyId?: string;\n\tinvoiceId?: string;\n\testimateId?: string;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get company ID if not provided\n\t\tlet companyId = params.companyId;\n\t\tif (!companyId) {\n\t\t\tconst { getActiveCompanyId } = await import(\"@/lib/auth/company-context\");\n\t\t\tcompanyId = await getActiveCompanyId();\n\t\t\tif (!companyId) {\n\t\t\t\treturn { success: false, error: \"No active company found\" };\n\t\t\t}\n\t\t}\n\n\t\tconst companySettings = await getCompanyTelnyxSettings(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t);\n\t\tif (!companySettings) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Unable to provision Telnyx resources for this company. Please verify onboarding is complete.\",\n\t\t\t};\n\t\t}\n\n\t\tawait ensurePhoneNumberRecordExists(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\n\t\tconst smsConfig = await validateSmsConfig();\n\t\tif (!smsConfig.valid && !companySettings.messaging_profile_id) {\n\t\t\tlet errorMessage = smsConfig.error || \"SMS configuration is invalid\";\n\t\t\tif (smsConfig.suggestedProfileId) {\n\t\t\t\terrorMessage += ` Found messaging profile \"${smsConfig.suggestedProfileId}\" in your Telnyx account. Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${smsConfig.suggestedProfileId} or reprovision the company.`;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: errorMessage,\n\t\t\t};\n\t\t}\n\n\t\tconst messagingProfileId =\n\t\t\tcompanySettings.messaging_profile_id || DEFAULT_MESSAGING_PROFILE_ID;\n\t\tif (!messagingProfileId) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Messaging profile is not configured for this company. Please provision communications before sending MMS.\",\n\t\t\t};\n\t\t}\n\n\t\tconst fromAddress = await resolveOutboundPhoneNumber(\n\t\t\tsupabase,\n\t\t\tcompanyId,\n\t\t\tparams.from,\n\t\t\tcompanySettings.default_outbound_number,\n\t\t);\n\t\tif (!fromAddress) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Company does not have a default outbound phone number configured.\",\n\t\t\t};\n\t\t}\n\t\tconst toAddress = normalizePhoneNumber(params.to);\n\n\t\tconst webhookUrl = await getTelnyxWebhookUrl(companyId);\n\t\tif (!webhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror:\n\t\t\t\t\t\"Site URL is not configured. Set NEXT_PUBLIC_SITE_URL or SITE_URL to a public https domain.\",\n\t\t\t};\n\t\t}\n\n\t\tif (messagingProfileId) {\n\t\t\tconst messagingProfileStatus =\n\t\t\t\tawait verifyMessagingProfile(messagingProfileId);\n\t\t\tif (messagingProfileStatus.needsFix) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: `Messaging profile configuration issue: ${messagingProfileStatus.issues.join(\", \")}. Run fixMessagingProfile() or reprovision the company.`,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tconst smsCapability = await verifySmsCapability(fromAddress);\n\t\tif (!smsCapability.hasSms) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: smsCapability.error || \"Phone number does not support SMS/MMS\",\n\t\t\t};\n\t\t}\n\n\t\tconst result = await sendMMS({\n\t\t\tto: toAddress,\n\t\t\tfrom: fromAddress,\n\t\t\ttext: params.text,\n\t\t\tmediaUrls: params.mediaUrls,\n\t\t\twebhookUrl,\n\t\t\tmessagingProfileId,\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\tconst phoneNumberId = await getPhoneNumberId(supabase, fromAddress);\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: companyId,\n\t\t\t\tcustomer_id: params.customerId,\n\t\t\t\tjob_id: params.jobId ?? null,\n\t\t\t\tproperty_id: params.propertyId ?? null,\n\t\t\t\tinvoice_id: params.invoiceId ?? null,\n\t\t\t\testimate_id: params.estimateId ?? null,\n\t\t\t\ttype: \"sms\",\n\t\t\t\tchannel: \"telnyx\",\n\t\t\t\tdirection: \"outbound\",\n\t\t\t\tfrom_address: fromAddress,\n\t\t\t\tto_address: toAddress,\n\t\t\t\tbody: params.text || \"\",\n\t\t\t\tattachments: params.mediaUrls.map((url) => ({ url, type: \"image\" })),\n\t\t\t\tattachment_count: params.mediaUrls.length,\n\t\t\t\tstatus: \"queued\",\n\t\t\t\tpriority: \"normal\",\n\t\t\t\tphone_number_id: phoneNumberId,\n\t\t\t\tis_archived: false,\n\t\t\t\tis_automated: false,\n\t\t\t\tis_internal: false,\n\t\t\t\tis_thread_starter: true,\n\t\t\t\ttelnyx_message_id: result.messageId,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessageId: result.messageId,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Failed to send MMS\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// WEBRTC OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Generate WebRTC credentials for browser calling\n */\nexport async function getWebRTCCredentials() {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\t// Get current user\n\t\tconst {\n\t\t\tdata: { user },\n\t\t\terror: userError,\n\t\t} = await supabase.auth.getUser();\n\t\tif (userError || !user) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"User not authenticated\",\n\t\t\t};\n\t\t}\n\n\t\t// OPTION 1: Use static credentials from environment (recommended for production)\n\t\tconst staticUsername = process.env.TELNYX_WEBRTC_USERNAME;\n\t\tconst staticPassword = process.env.TELNYX_WEBRTC_PASSWORD;\n\n\t\tif (staticUsername && staticPassword) {\n\t\t\tconst credential = {\n\t\t\t\tusername: staticUsername,\n\t\t\t\tpassword: staticPassword,\n\t\t\t\texpires_at: Date.now() + 86_400 * 1000, // 24 hours from now\n\t\t\t\trealm: \"sip.telnyx.com\",\n\t\t\t\tsip_uri: `sip:${staticUsername}@sip.telnyx.com`,\n\t\t\t\tstun_servers: [\n\t\t\t\t\t\"stun:stun.telnyx.com:3478\",\n\t\t\t\t\t\"stun:stun.telnyx.com:3479\",\n\t\t\t\t],\n\t\t\t\tturn_servers: [\n\t\t\t\t\t{\n\t\t\t\t\t\turls: [\n\t\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=udp\",\n\t\t\t\t\t\t\t\"turn:turn.telnyx.com:3478?transport=tcp\",\n\t\t\t\t\t\t],\n\t\t\t\t\t\tusername: staticUsername,\n\t\t\t\t\t\tcredential: staticPassword,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t};\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tcredential,\n\t\t\t};\n\t\t}\n\n\t\tconst { generateWebRTCToken } = await import(\"@/lib/telnyx/webrtc\");\n\t\tconst result = await generateWebRTCToken({\n\t\t\tusername: user.email || user.id,\n\t\t\tttl: 86_400, // 24 hours\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\treturn result;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tcredential: result.credential,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get WebRTC credentials\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// VOICEMAIL OPERATIONS ACTIONS\n// =====================================================================================\n\n/**\n * Get all voicemails for a company\n */\nasync function getVoicemails(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        customer:customers(id, first_name, last_name, email, phone),\n        phone_number:phone_numbers(phone_number, formatted_number)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"received_at\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to get voicemails\",\n\t\t};\n\t}\n}\n\n/**\n * Mark voicemail as read\n */\nasync function markVoicemailAsRead(voicemailId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.update({\n\t\t\t\tis_read: true,\n\t\t\t\tread_at: new Date().toISOString(),\n\t\t\t\tread_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", voicemailId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to mark voicemail as read\",\n\t\t};\n\t}\n}\n\n/**\n * Delete voicemail\n */\nasync function deleteVoicemail(voicemailId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"voicemails\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", voicemailId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/communication\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error ? error.message : \"Failed to delete voicemail\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// CALL ROUTING RULES ACTIONS\n// =====================================================================================\n\n/**\n * Get all call routing rules for a company\n */\nexport async function getCallRoutingRules(companyId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.select(\n\t\t\t\t`\n        *,\n        created_by_user:users!call_routing_rules_created_by_fkey(id, name, email),\n        forward_to_user:users!call_routing_rules_forward_to_user_id_fkey(id, name, email)\n      `,\n\t\t\t)\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.is(\"deleted_at\", null)\n\t\t\t.order(\"priority\", { ascending: false });\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: data || [],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get call routing rules\",\n\t\t};\n\t}\n}\n\n/**\n * Create a new call routing rule\n */\nasync function createCallRoutingRule(params: {\n\tcompanyId: string;\n\tuserId: string;\n\tname: string;\n\tdescription?: string;\n\troutingType:\n\t\t| \"direct\"\n\t\t| \"round_robin\"\n\t\t| \"ivr\"\n\t\t| \"business_hours\"\n\t\t| \"conditional\";\n\tpriority?: number;\n\tbusinessHours?: Record<string, unknown>;\n\ttimezone?: string;\n\tafterHoursAction?: \"voicemail\" | \"forward\" | \"hangup\";\n\tafterHoursForwardTo?: string;\n\tteamMembers?: string[];\n\tringTimeout?: number;\n\tivrMenu?: Record<string, unknown>;\n\tivrGreetingUrl?: string;\n\tforwardToNumber?: string;\n\tforwardToUserId?: string;\n\tenableVoicemail?: boolean;\n\tvoicemailGreetingUrl?: string;\n\tvoicemailTranscriptionEnabled?: boolean;\n\tvoicemailEmailNotifications?: boolean;\n\trecordCalls?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.insert({\n\t\t\t\tcompany_id: params.companyId,\n\t\t\t\tcreated_by: params.userId,\n\t\t\t\tname: params.name,\n\t\t\t\tdescription: params.description,\n\t\t\t\trouting_type: params.routingType,\n\t\t\t\tpriority: params.priority || 0,\n\t\t\t\tbusiness_hours: params.businessHours,\n\t\t\t\ttimezone: params.timezone || \"America/Los_Angeles\",\n\t\t\t\tafter_hours_action: params.afterHoursAction,\n\t\t\t\tafter_hours_forward_to: params.afterHoursForwardTo,\n\t\t\t\tteam_members: params.teamMembers,\n\t\t\t\tring_timeout: params.ringTimeout || 20,\n\t\t\t\tivr_menu: params.ivrMenu,\n\t\t\t\tivr_greeting_url: params.ivrGreetingUrl,\n\t\t\t\tforward_to_number: params.forwardToNumber,\n\t\t\t\tforward_to_user_id: params.forwardToUserId,\n\t\t\t\tenable_voicemail: params.enableVoicemail !== false,\n\t\t\t\tvoicemail_greeting_url: params.voicemailGreetingUrl,\n\t\t\t\tvoicemail_transcription_enabled:\n\t\t\t\t\tparams.voicemailTranscriptionEnabled !== false,\n\t\t\t\tvoicemail_email_notifications:\n\t\t\t\t\tparams.voicemailEmailNotifications !== false,\n\t\t\t\trecord_calls: params.recordCalls,\n\t\t\t\tis_active: true,\n\t\t\t})\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to create call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Update an existing call routing rule\n */\nexport async function updateCallRoutingRule(params: {\n\truleId: string;\n\tname?: string;\n\tdescription?: string;\n\tpriority?: number;\n\tbusinessHours?: Record<string, unknown>;\n\ttimezone?: string;\n\tafterHoursAction?: \"voicemail\" | \"forward\" | \"hangup\";\n\tafterHoursForwardTo?: string;\n\tteamMembers?: string[];\n\tringTimeout?: number;\n\tivrMenu?: Record<string, unknown>;\n\tivrGreetingUrl?: string;\n\tforwardToNumber?: string;\n\tforwardToUserId?: string;\n\tenableVoicemail?: boolean;\n\tvoicemailGreetingUrl?: string;\n\tvoicemailTranscriptionEnabled?: boolean;\n\tvoicemailEmailNotifications?: boolean;\n\trecordCalls?: boolean;\n\tisActive?: boolean;\n}) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst updateData: Record<string, unknown> = {};\n\n\t\tif (params.name !== undefined) {\n\t\t\tupdateData.name = params.name;\n\t\t}\n\t\tif (params.description !== undefined) {\n\t\t\tupdateData.description = params.description;\n\t\t}\n\t\tif (params.priority !== undefined) {\n\t\t\tupdateData.priority = params.priority;\n\t\t}\n\t\tif (params.businessHours !== undefined) {\n\t\t\tupdateData.business_hours = params.businessHours;\n\t\t}\n\t\tif (params.timezone !== undefined) {\n\t\t\tupdateData.timezone = params.timezone;\n\t\t}\n\t\tif (params.afterHoursAction !== undefined) {\n\t\t\tupdateData.after_hours_action = params.afterHoursAction;\n\t\t}\n\t\tif (params.afterHoursForwardTo !== undefined) {\n\t\t\tupdateData.after_hours_forward_to = params.afterHoursForwardTo;\n\t\t}\n\t\tif (params.teamMembers !== undefined) {\n\t\t\tupdateData.team_members = params.teamMembers;\n\t\t}\n\t\tif (params.ringTimeout !== undefined) {\n\t\t\tupdateData.ring_timeout = params.ringTimeout;\n\t\t}\n\t\tif (params.ivrMenu !== undefined) {\n\t\t\tupdateData.ivr_menu = params.ivrMenu;\n\t\t}\n\t\tif (params.ivrGreetingUrl !== undefined) {\n\t\t\tupdateData.ivr_greeting_url = params.ivrGreetingUrl;\n\t\t}\n\t\tif (params.forwardToNumber !== undefined) {\n\t\t\tupdateData.forward_to_number = params.forwardToNumber;\n\t\t}\n\t\tif (params.forwardToUserId !== undefined) {\n\t\t\tupdateData.forward_to_user_id = params.forwardToUserId;\n\t\t}\n\t\tif (params.enableVoicemail !== undefined) {\n\t\t\tupdateData.enable_voicemail = params.enableVoicemail;\n\t\t}\n\t\tif (params.voicemailGreetingUrl !== undefined) {\n\t\t\tupdateData.voicemail_greeting_url = params.voicemailGreetingUrl;\n\t\t}\n\t\tif (params.voicemailTranscriptionEnabled !== undefined) {\n\t\t\tupdateData.voicemail_transcription_enabled =\n\t\t\t\tparams.voicemailTranscriptionEnabled;\n\t\t}\n\t\tif (params.voicemailEmailNotifications !== undefined) {\n\t\t\tupdateData.voicemail_email_notifications =\n\t\t\t\tparams.voicemailEmailNotifications;\n\t\t}\n\t\tif (params.recordCalls !== undefined) {\n\t\t\tupdateData.record_calls = params.recordCalls;\n\t\t}\n\t\tif (params.isActive !== undefined) {\n\t\t\tupdateData.is_active = params.isActive;\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update(updateData)\n\t\t\t.eq(\"id\", params.ruleId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to update call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Delete a call routing rule\n */\nexport async function deleteCallRoutingRule(ruleId: string, userId: string) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update({\n\t\t\t\tdeleted_at: new Date().toISOString(),\n\t\t\t\tdeleted_by: userId,\n\t\t\t})\n\t\t\t.eq(\"id\", ruleId);\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to delete call routing rule\",\n\t\t};\n\t}\n}\n\n/**\n * Toggle call routing rule active status\n */\nexport async function toggleCallRoutingRule(ruleId: string, isActive: boolean) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"call_routing_rules\")\n\t\t\t.update({ is_active: isActive })\n\t\t\t.eq(\"id\", ruleId)\n\t\t\t.select()\n\t\t\t.single();\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\trevalidatePath(\"/dashboard/settings/communications/call-routing\");\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to toggle call routing rule\",\n\t\t};\n\t}\n}\n\n// =====================================================================================\n// PHONE NUMBER USAGE STATISTICS ACTIONS\n// =====================================================================================\n\n/**\n * Get usage statistics for a phone number\n */\nasync function getPhoneNumberUsageStats(\n\tphoneNumberId: string,\n\tdays = 30,\n) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\t// Get call statistics\n\t\tconst { data: callStats, error: callError } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, call_duration, created_at\")\n\t\t\t.eq(\"type\", \"phone\")\n\t\t\t.eq(\"phone_number_id\", phoneNumberId)\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (callError) {\n\t\t\tthrow callError;\n\t\t}\n\n\t\t// Get SMS statistics\n\t\tconst { data: smsStats, error: smsError } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, created_at\")\n\t\t\t.eq(\"type\", \"sms\")\n\t\t\t.eq(\"phone_number_id\", phoneNumberId)\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (smsError) {\n\t\t\tthrow smsError;\n\t\t}\n\n\t\t// Calculate aggregates\n\t\tconst calls = callStats || [];\n\t\tconst sms = smsStats || [];\n\n\t\tconst incomingCalls = calls.filter((c) => c.direction === \"inbound\").length;\n\t\tconst outgoingCalls = calls.filter(\n\t\t\t(c) => c.direction === \"outbound\",\n\t\t).length;\n\t\tconst totalCallDuration = calls.reduce(\n\t\t\t(sum, c) => sum + (c.call_duration || 0),\n\t\t\t0,\n\t\t);\n\t\tconst incomingSms = sms.filter((s) => s.direction === \"inbound\").length;\n\t\tconst outgoingSms = sms.filter((s) => s.direction === \"outbound\").length;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tincomingCalls,\n\t\t\t\toutgoingCalls,\n\t\t\t\ttotalCalls: incomingCalls + outgoingCalls,\n\t\t\t\ttotalCallDuration,\n\t\t\t\tincomingSms,\n\t\t\t\toutgoingSms,\n\t\t\t\ttotalSms: incomingSms + outgoingSms,\n\t\t\t\tdailyStats: aggregateDailyStats([...calls, ...sms], days),\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get usage statistics\",\n\t\t};\n\t}\n}\n\n/**\n * Get company-wide usage statistics\n */\nasync function getCompanyUsageStats(companyId: string, days = 30) {\n\ttry {\n\t\tconst supabase = await createClient();\n\t\tif (!supabase) {\n\t\t\treturn { success: false, error: \"Service unavailable\" };\n\t\t}\n\n\t\tconst startDate = new Date();\n\t\tstartDate.setDate(startDate.getDate() - days);\n\n\t\t// Get all communications for the company\n\t\tconst { data: communications, error } = await supabase\n\t\t\t.from(\"communications\")\n\t\t\t.select(\"type, direction, status, call_duration, created_at\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.in(\"type\", [\"phone\", \"sms\"])\n\t\t\t.gte(\"created_at\", startDate.toISOString());\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\tconst items = communications || [];\n\t\tconst calls = items.filter((i) => i.type === \"phone\");\n\t\tconst sms = items.filter((i) => i.type === \"sms\");\n\n\t\tconst incomingCalls = calls.filter((c) => c.direction === \"inbound\").length;\n\t\tconst outgoingCalls = calls.filter(\n\t\t\t(c) => c.direction === \"outbound\",\n\t\t).length;\n\t\tconst totalCallDuration = calls.reduce(\n\t\t\t(sum, c) => sum + (c.call_duration || 0),\n\t\t\t0,\n\t\t);\n\t\tconst incomingSms = sms.filter((s) => s.direction === \"inbound\").length;\n\t\tconst outgoingSms = sms.filter((s) => s.direction === \"outbound\").length;\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tincomingCalls,\n\t\t\t\toutgoingCalls,\n\t\t\t\ttotalCalls: incomingCalls + outgoingCalls,\n\t\t\t\ttotalCallDuration,\n\t\t\t\taverageCallDuration:\n\t\t\t\t\tcalls.length > 0 ? totalCallDuration / calls.length : 0,\n\t\t\t\tincomingSms,\n\t\t\t\toutgoingSms,\n\t\t\t\ttotalSms: incomingSms + outgoingSms,\n\t\t\t\tdailyStats: aggregateDailyStats(items, days),\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to get usage statistics\",\n\t\t};\n\t}\n}\n\n/**\n * Helper function to aggregate daily statistics\n */\nfunction aggregateDailyStats(\n\titems: Array<{ created_at: string; type: string; call_duration?: number }>,\n\tdays: number,\n) {\n\tconst dailyStats: Record<\n\t\tstring,\n\t\t{ date: string; calls: number; sms: number; duration: number }\n\t> = {};\n\n\t// Initialize all days\n\tfor (let i = 0; i < days; i++) {\n\t\tconst date = new Date();\n\t\tdate.setDate(date.getDate() - i);\n\t\tconst dateStr = date.toISOString().split(\"T\")[0];\n\t\tdailyStats[dateStr] = { date: dateStr, calls: 0, sms: 0, duration: 0 };\n\t}\n\n\t// Aggregate data\n\titems.forEach((item) => {\n\t\tconst dateStr = item.created_at.split(\"T\")[0];\n\t\tif (dailyStats[dateStr]) {\n\t\t\tif (item.type === \"phone\") {\n\t\t\t\tdailyStats[dateStr].calls += 1;\n\t\t\t\tdailyStats[dateStr].duration += item.call_duration || 0;\n\t\t\t} else if (item.type === \"sms\") {\n\t\t\t\tdailyStats[dateStr].sms += 1;\n\t\t\t}\n\t\t}\n\t});\n\n\treturn Object.values(dailyStats).sort((a, b) => a.date.localeCompare(b.date));\n}\n","import type { SupabaseClient } from \"@supabase/supabase-js\";\nimport type { Database } from \"@/types/supabase\";\nimport { telnyxClient } from \"./client\";\nimport {\n\ttype NumberFeature,\n\ttype NumberType,\n\tpurchaseNumber,\n\tsearchAvailableNumbers,\n} from \"./numbers\";\n\nexport type CompanyTelnyxSettingsRow = {\n\tcompany_id: string;\n\tstatus: string;\n\tmessaging_profile_id: string | null;\n\tcall_control_application_id: string | null;\n\tdefault_outbound_number: string | null;\n\tdefault_outbound_phone_number_id: string | null;\n\tten_dlc_brand_id: string | null;\n\tten_dlc_campaign_id: string | null;\n\twebhook_secret: string | null;\n\tmetadata: Record<string, unknown> | null;\n\tlast_provisioned_at: string | null;\n\tcreated_at: string | null;\n\tupdated_at: string | null;\n};\n\ntype TypedSupabaseClient = SupabaseClient<Database>;\n\ntype ProvisionOptions = {\n\tcompanyId: string;\n\tsupabase: TypedSupabaseClient;\n\tareaCode?: string;\n\tnumberQuantity?: number;\n\tfeatures?: NumberFeature[];\n};\n\nconst DEFAULT_FEATURES: NumberFeature[] = [\"sms\", \"mms\", \"voice\"];\nconst COMPANY_SETTINGS_TABLE = \"company_telnyx_settings\";\n\nasync function getBaseAppUrl(): Promise<string | undefined> {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\n\tfor (const candidate of candidates) {\n\t\tif (!candidate) continue;\n\t\tconst trimmed = candidate.trim();\n\t\tif (!trimmed) continue;\n\t\tconst isLocal = /localhost|127\\.0\\.0\\.1|0\\.0\\.0\\.0/i.test(trimmed);\n\t\tif (isLocal) {\n\t\t\tcontinue;\n\t\t}\n\t\tif (trimmed.startsWith(\"http\")) {\n\t\t\treturn trimmed.replace(/\\/+$/, \"\");\n\t\t}\n\t\treturn `https://${trimmed.replace(/\\/+$/, \"\")}`;\n\t}\n\n\treturn undefined;\n}\n\nasync function buildCompanyWebhookUrl(\n\tcompanyId: string,\n): Promise<string | undefined> {\n\tconst base = await getBaseAppUrl();\n\tif (!base) {\n\t\treturn undefined;\n\t}\n\treturn `${base}/api/webhooks/telnyx?company=${companyId}`;\n}\n\nfunction formatDisplay(phoneNumber: string): string {\n\tconst digits = phoneNumber.replace(/[^0-9]/g, \"\");\n\tif (digits.length === 11 && digits.startsWith(\"1\")) {\n\t\treturn `(${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;\n\t}\n\tif (digits.length === 10) {\n\t\treturn `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;\n\t}\n\treturn phoneNumber;\n}\n\ntype ProvisionResult = {\n\tsuccess: boolean;\n\tsettings?: CompanyTelnyxSettingsRow;\n\terror?: string;\n\tlog: string[];\n};\n\nasync function ensurePhoneNumbersInserted(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n\tphoneNumbers: Array<{\n\t\tphoneNumber: string;\n\t\tareaCode?: string;\n\t\tcountryCode?: string;\n\t\ttelnyxPhoneNumberId?: string;\n\t\tnumberType?: NumberType;\n\t}>,\n\tdefaults: {\n\t\tmessagingProfileId: string | null;\n\t\tconnectionId: string | null;\n\t},\n): Promise<void> {\n\tif (phoneNumbers.length === 0) {\n\t\treturn;\n\t}\n\n\tfor (const number of phoneNumbers) {\n\t\tconst digits = number.phoneNumber.replace(/[^0-9]/g, \"\");\n\t\tconst e164 = digits.startsWith(\"+\")\n\t\t\t? digits\n\t\t\t: digits.startsWith(\"1\") && digits.length === 11\n\t\t\t\t? `+${digits}`\n\t\t\t\t: `+1${digits}`;\n\n\t\tconst row = {\n\t\t\tcompany_id: companyId,\n\t\t\tphone_number: e164,\n\t\t\tformatted_number: formatDisplay(e164),\n\t\t\tarea_code: number.areaCode || e164.slice(2, 5),\n\t\t\tcountry_code: number.countryCode || \"US\",\n\t\t\tnumber_type: number.numberType || \"local\",\n\t\t\tstatus: \"active\",\n\t\t\tfeatures: DEFAULT_FEATURES,\n\t\t\ttelnyx_phone_number_id: number.telnyxPhoneNumberId || null,\n\t\t\ttelnyx_messaging_profile_id: defaults.messagingProfileId,\n\t\t\ttelnyx_connection_id: defaults.connectionId,\n\t\t};\n\n\t\tconst { data: existing } = await supabase\n\t\t\t.from(\"phone_numbers\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"phone_number\", e164)\n\t\t\t.maybeSingle();\n\n\t\tif (existing?.id) {\n\t\t\tawait supabase.from(\"phone_numbers\").update(row).eq(\"id\", existing.id);\n\t\t} else {\n\t\t\tawait supabase.from(\"phone_numbers\").insert(row);\n\t\t}\n\t}\n}\n\nasync function createMessagingProfile(companyName: string, webhookUrl: string) {\n\tconst response = await telnyxClient.messagingProfiles.create({\n\t\tname: `${companyName} - Thorbis`,\n\t\tenabled: true,\n\t\twebhook_url: webhookUrl,\n\t\twebhook_api_version: \"2\",\n\t});\n\treturn response.data as any;\n}\n\nasync function createCallControlApplication(\n\tcompanyName: string,\n\twebhookUrl: string,\n) {\n\tconst response = await telnyxClient.callControlApplications.create({\n\t\tapplication_name: `${companyName} - Thorbis`,\n\t\twebhook_event_url: webhookUrl,\n\t\twebhook_api_version: \"2\",\n\t\tanswering_machine_detection: \"premium\",\n\t});\n\treturn response.data as any;\n}\n\nasync function purchaseNumbers(\n\tcompanyId: string,\n\toptions: {\n\t\tquantity: number;\n\t\tareaCode?: string;\n\t\tfeatures?: NumberFeature[];\n\t\tmessagingProfileId: string;\n\t\tconnectionId: string;\n\t},\n): Promise<\n\tArray<{\n\t\tphoneNumber: string;\n\t\ttelnyxPhoneNumberId?: string;\n\t\tareaCode?: string;\n\t\tnumberType?: NumberType;\n\t}>\n> {\n\tconst search = await searchAvailableNumbers({\n\t\tareaCode: options.areaCode,\n\t\tfeatures: options.features || DEFAULT_FEATURES,\n\t\tlimit: Math.max(options.quantity * 2, options.quantity),\n\t});\n\n\tif (!search.success || !search.data || search.data.length === 0) {\n\t\tthrow new Error(\"No available phone numbers found for requested criteria\");\n\t}\n\n\tconst purchased: Array<{\n\t\tphoneNumber: string;\n\t\ttelnyxPhoneNumberId?: string;\n\t\tareaCode?: string;\n\t\tnumberType?: NumberType;\n\t}> = [];\n\tconst candidates = search.data as any[];\n\n\tfor (const candidate of candidates) {\n\t\tif (purchased.length >= options.quantity) {\n\t\t\tbreak;\n\t\t}\n\n\t\tconst number = candidate.phone_number as string;\n\t\tconst purchaseResult = await purchaseNumber({\n\t\t\tphoneNumber: number,\n\t\t\tmessagingProfileId: options.messagingProfileId,\n\t\t\tconnectionId: options.connectionId,\n\t\t\tcustomerReference: `company:${companyId}`,\n\t\t});\n\n\t\tif (!purchaseResult.success) {\n\t\t\tthrow new Error(\n\t\t\t\tpurchaseResult.error ||\n\t\t\t\t\t`Failed to purchase number ${number} from Telnyx`,\n\t\t\t);\n\t\t}\n\n\t\tpurchased.push({\n\t\t\tphoneNumber: number,\n\t\t\tareaCode: candidate.national_destination_code || candidate.area_code,\n\t\t\ttelnyxPhoneNumberId: candidate.id || candidate.phone_number,\n\t\t\tnumberType: candidate.number_type,\n\t\t});\n\t}\n\n\tif (purchased.length === 0) {\n\t\tthrow new Error(\"Failed to purchase any phone numbers\");\n\t}\n\n\t// Enable messaging on all purchased numbers\n\tfor (const number of purchased) {\n\t\tif (number.telnyxPhoneNumberId) {\n\t\t\ttry {\n\t\t\t\tconst TELNYX_API_KEY = process.env.TELNYX_API_KEY;\n\t\t\t\tif (!TELNYX_API_KEY) {\n\t\t\t\t\tthrow new Error(\"TELNYX_API_KEY not configured\");\n\t\t\t\t}\n\n\t\t\t\tawait fetch(\n\t\t\t\t\t`https://api.telnyx.com/v2/phone_numbers/${number.telnyxPhoneNumberId}/messaging`,\n\t\t\t\t\t{\n\t\t\t\t\t\tmethod: \"PATCH\",\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\t\tAuthorization: `Bearer ${TELNYX_API_KEY}`,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\t\tmessaging_profile_id: options.messagingProfileId,\n\t\t\t\t\t\t}),\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\t// Log but don't fail - messaging can be enabled later\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`Failed to enable messaging on ${number.phoneNumber}:`,\n\t\t\t\t\terror,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn purchased;\n}\n\nexport async function fetchCompanyTelnyxSettings(\n\tsupabase: TypedSupabaseClient,\n\tcompanyId: string,\n): Promise<CompanyTelnyxSettingsRow | null> {\n\tconst { data } = await (supabase as any)\n\t\t.from(COMPANY_SETTINGS_TABLE)\n\t\t.select(\"*\")\n\t\t.eq(\"company_id\", companyId)\n\t\t.maybeSingle();\n\n\treturn (data as CompanyTelnyxSettingsRow | null) ?? null;\n}\n\nexport async function ensureCompanyTelnyxSetup(\n\toptions: ProvisionOptions,\n): Promise<ProvisionResult> {\n\tconst { supabase, companyId } = options;\n\tconst log: string[] = [];\n\n\tconst existing = await fetchCompanyTelnyxSettings(supabase, companyId);\n\tif (\n\t\texisting &&\n\t\texisting.status === \"ready\" &&\n\t\texisting.messaging_profile_id &&\n\t\texisting.call_control_application_id\n\t) {\n\t\tlog.push(\"Existing Telnyx configuration found\");\n\t\treturn { success: true, settings: existing, log };\n\t}\n\n\tconst { data: company } = await supabase\n\t\t.from(\"companies\")\n\t\t.select(\"id, name\")\n\t\t.eq(\"id\", companyId)\n\t\t.maybeSingle();\n\n\tif (!company) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Company not found\",\n\t\t\tlog,\n\t\t};\n\t}\n\n\tconst webhookUrl = await buildCompanyWebhookUrl(companyId);\n\tif (!webhookUrl) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be configured with a public URL to provision Telnyx resources\",\n\t\t\tlog,\n\t\t};\n\t}\n\n\ttry {\n\t\tlog.push(\"Creating messaging profile\");\n\t\tconst messagingProfile = await createMessagingProfile(\n\t\t\tcompany.name || \"Company\",\n\t\t\twebhookUrl,\n\t\t);\n\t\tconst messagingProfileId = messagingProfile?.id as string;\n\n\t\tlog.push(\"Creating call control application\");\n\t\tconst callApplication = await createCallControlApplication(\n\t\t\tcompany.name || \"Company\",\n\t\t\twebhookUrl,\n\t\t);\n\t\tconst connectionId = callApplication?.id as string;\n\n\t\tif (!messagingProfileId || !connectionId) {\n\t\t\tthrow new Error(\n\t\t\t\t\"Failed to provision messaging profile or call control application\",\n\t\t\t);\n\t\t}\n\n\t\tlog.push(\"Purchasing phone numbers\");\n\t\tconst purchasedNumbers = await purchaseNumbers(companyId, {\n\t\t\tquantity: Math.max(options.numberQuantity || 1, 1),\n\t\t\tareaCode: options.areaCode,\n\t\t\tfeatures: options.features || DEFAULT_FEATURES,\n\t\t\tmessagingProfileId,\n\t\t\tconnectionId,\n\t\t});\n\n\t\tawait ensurePhoneNumbersInserted(supabase, companyId, purchasedNumbers, {\n\t\t\tmessagingProfileId,\n\t\t\tconnectionId,\n\t\t});\n\n\t\tconst defaultNumber =\n\t\t\tpurchasedNumbers.find((n) => n.numberType === \"toll-free\") ||\n\t\t\tpurchasedNumbers[0];\n\n\t\tconst upsertResult = await (supabase as any)\n\t\t\t.from(COMPANY_SETTINGS_TABLE)\n\t\t\t.upsert(\n\t\t\t\t{\n\t\t\t\t\tcompany_id: companyId,\n\t\t\t\t\tstatus: \"ready\",\n\t\t\t\t\tmessaging_profile_id: messagingProfileId,\n\t\t\t\t\tcall_control_application_id: connectionId,\n\t\t\t\t\tdefault_outbound_number: defaultNumber?.phoneNumber || null,\n\t\t\t\t\tdefault_outbound_phone_number_id:\n\t\t\t\t\t\tdefaultNumber?.telnyxPhoneNumberId || null,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\tlog,\n\t\t\t\t\t\tpurchased_numbers: purchasedNumbers.map((n) => n.phoneNumber),\n\t\t\t\t\t},\n\t\t\t\t\tlast_provisioned_at: new Date().toISOString(),\n\t\t\t\t},\n\t\t\t\t{ onConflict: \"company_id\" },\n\t\t\t)\n\t\t\t.select(\"*\")\n\t\t\t.single();\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tsettings: upsertResult.data as CompanyTelnyxSettingsRow,\n\t\t\tlog,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to provision Telnyx resources\",\n\t\t\tlog,\n\t\t};\n\t}\n}\n\nexport async function purchaseAdditionalNumbers(\n\toptions: ProvisionOptions & { quantity: number },\n): Promise<ProvisionResult> {\n\tconst { supabase, companyId, quantity } = options;\n\tconst log: string[] = [];\n\n\tconst settings = await fetchCompanyTelnyxSettings(supabase, companyId);\n\tif (\n\t\t!settings ||\n\t\tsettings.status !== \"ready\" ||\n\t\t!settings.messaging_profile_id ||\n\t\t!settings.call_control_application_id\n\t) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\t\"Company Telnyx configuration is not ready. Run ensureCompanyTelnyxSetup first.\",\n\t\t\tlog,\n\t\t};\n\t}\n\n\ttry {\n\t\tlog.push(`Purchasing ${quantity} additional numbers`);\n\t\tconst purchasedNumbers = await purchaseNumbers(companyId, {\n\t\t\tquantity,\n\t\t\tareaCode: options.areaCode,\n\t\t\tfeatures: options.features || DEFAULT_FEATURES,\n\t\t\tmessagingProfileId: settings.messaging_profile_id,\n\t\t\tconnectionId: settings.call_control_application_id,\n\t\t});\n\n\t\tawait ensurePhoneNumbersInserted(supabase, companyId, purchasedNumbers, {\n\t\t\tmessagingProfileId: settings.messaging_profile_id,\n\t\t\tconnectionId: settings.call_control_application_id,\n\t\t});\n\n\t\t// Prefer toll-free numbers as the default outbound if available\n\t\tconst tollFreeNumber = purchasedNumbers.find(\n\t\t\t(n) => n.numberType === \"toll-free\",\n\t\t);\n\t\tif (\n\t\t\ttollFreeNumber &&\n\t\t\tsettings.default_outbound_number !== tollFreeNumber.phoneNumber\n\t\t) {\n\t\t\tawait supabase\n\t\t\t\t.from(COMPANY_SETTINGS_TABLE)\n\t\t\t\t.update({\n\t\t\t\t\tdefault_outbound_number: tollFreeNumber.phoneNumber,\n\t\t\t\t\tdefault_outbound_phone_number_id:\n\t\t\t\t\t\ttollFreeNumber.telnyxPhoneNumberId || null,\n\t\t\t\t})\n\t\t\t\t.eq(\"company_id\", companyId);\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tsettings,\n\t\t\tlog,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror:\n\t\t\t\terror instanceof Error\n\t\t\t\t\t? error.message\n\t\t\t\t\t: \"Failed to purchase phone numbers\",\n\t\t\tlog,\n\t\t};\n\t}\n}\n"],"names":[],"mappings":"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"}