{"version":3,"sources":["../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/server/route-modules/app-page/module.compiled.js","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/server/route-modules/app-page/vendored/rsc/react.ts","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/dist/compiled/%40edge-runtime/cookies/index.js","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/server/web/spec-extension/adapters/reflect.ts","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/server/request/utils.ts","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server.ts","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../../node_modules/.pnpm/next%4016.0.4_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.0_react%4019.2.0__react%4019.2.0/node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../../packages/database/src/service-client.ts","../../../../../apps/web/src/lib/telnyx/config-validator.ts","../../../../../apps/web/src/lib/telnyx/messaging-profile-fetcher.ts","../../../../../apps/web/src/lib/telnyx/connection-setup.ts","../../../../../apps/web/src/lib/telnyx/webhooks.ts"],"sourcesContent":["if (process.env.NEXT_RUNTIME === 'edge') {\n  module.exports = require('next/dist/server/route-modules/app-page/module.js')\n} else {\n  if (process.env.__NEXT_EXPERIMENTAL_REACT) {\n    if (process.env.NODE_ENV === 'development') {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo-experimental.runtime.dev.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page-experimental.runtime.dev.js')\n      }\n    } else {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo-experimental.runtime.prod.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page-experimental.runtime.prod.js')\n      }\n    }\n  } else {\n    if (process.env.NODE_ENV === 'development') {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo.runtime.dev.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page.runtime.dev.js')\n      }\n    } else {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo.runtime.prod.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page.runtime.prod.js')\n      }\n    }\n  }\n}\n","module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['react-rsc']!.React\n","\"use strict\";\nvar __defProp = Object.defineProperty;\nvar __getOwnPropDesc = Object.getOwnPropertyDescriptor;\nvar __getOwnPropNames = Object.getOwnPropertyNames;\nvar __hasOwnProp = Object.prototype.hasOwnProperty;\nvar __export = (target, all) => {\n  for (var name in all)\n    __defProp(target, name, { get: all[name], enumerable: true });\n};\nvar __copyProps = (to, from, except, desc) => {\n  if (from && typeof from === \"object\" || typeof from === \"function\") {\n    for (let key of __getOwnPropNames(from))\n      if (!__hasOwnProp.call(to, key) && key !== except)\n        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });\n  }\n  return to;\n};\nvar __toCommonJS = (mod) => __copyProps(__defProp({}, \"__esModule\", { value: true }), mod);\n\n// src/index.ts\nvar src_exports = {};\n__export(src_exports, {\n  RequestCookies: () => RequestCookies,\n  ResponseCookies: () => ResponseCookies,\n  parseCookie: () => parseCookie,\n  parseSetCookie: () => parseSetCookie,\n  stringifyCookie: () => stringifyCookie\n});\nmodule.exports = __toCommonJS(src_exports);\n\n// src/serialize.ts\nfunction stringifyCookie(c) {\n  var _a;\n  const attrs = [\n    \"path\" in c && c.path && `Path=${c.path}`,\n    \"expires\" in c && (c.expires || c.expires === 0) && `Expires=${(typeof c.expires === \"number\" ? new Date(c.expires) : c.expires).toUTCString()}`,\n    \"maxAge\" in c && typeof c.maxAge === \"number\" && `Max-Age=${c.maxAge}`,\n    \"domain\" in c && c.domain && `Domain=${c.domain}`,\n    \"secure\" in c && c.secure && \"Secure\",\n    \"httpOnly\" in c && c.httpOnly && \"HttpOnly\",\n    \"sameSite\" in c && c.sameSite && `SameSite=${c.sameSite}`,\n    \"partitioned\" in c && c.partitioned && \"Partitioned\",\n    \"priority\" in c && c.priority && `Priority=${c.priority}`\n  ].filter(Boolean);\n  const stringified = `${c.name}=${encodeURIComponent((_a = c.value) != null ? _a : \"\")}`;\n  return attrs.length === 0 ? stringified : `${stringified}; ${attrs.join(\"; \")}`;\n}\nfunction parseCookie(cookie) {\n  const map = /* @__PURE__ */ new Map();\n  for (const pair of cookie.split(/; */)) {\n    if (!pair)\n      continue;\n    const splitAt = pair.indexOf(\"=\");\n    if (splitAt === -1) {\n      map.set(pair, \"true\");\n      continue;\n    }\n    const [key, value] = [pair.slice(0, splitAt), pair.slice(splitAt + 1)];\n    try {\n      map.set(key, decodeURIComponent(value != null ? value : \"true\"));\n    } catch {\n    }\n  }\n  return map;\n}\nfunction parseSetCookie(setCookie) {\n  if (!setCookie) {\n    return void 0;\n  }\n  const [[name, value], ...attributes] = parseCookie(setCookie);\n  const {\n    domain,\n    expires,\n    httponly,\n    maxage,\n    path,\n    samesite,\n    secure,\n    partitioned,\n    priority\n  } = Object.fromEntries(\n    attributes.map(([key, value2]) => [\n      key.toLowerCase().replace(/-/g, \"\"),\n      value2\n    ])\n  );\n  const cookie = {\n    name,\n    value: decodeURIComponent(value),\n    domain,\n    ...expires && { expires: new Date(expires) },\n    ...httponly && { httpOnly: true },\n    ...typeof maxage === \"string\" && { maxAge: Number(maxage) },\n    path,\n    ...samesite && { sameSite: parseSameSite(samesite) },\n    ...secure && { secure: true },\n    ...priority && { priority: parsePriority(priority) },\n    ...partitioned && { partitioned: true }\n  };\n  return compact(cookie);\n}\nfunction compact(t) {\n  const newT = {};\n  for (const key in t) {\n    if (t[key]) {\n      newT[key] = t[key];\n    }\n  }\n  return newT;\n}\nvar SAME_SITE = [\"strict\", \"lax\", \"none\"];\nfunction parseSameSite(string) {\n  string = string.toLowerCase();\n  return SAME_SITE.includes(string) ? string : void 0;\n}\nvar PRIORITY = [\"low\", \"medium\", \"high\"];\nfunction parsePriority(string) {\n  string = string.toLowerCase();\n  return PRIORITY.includes(string) ? string : void 0;\n}\nfunction splitCookiesString(cookiesString) {\n  if (!cookiesString)\n    return [];\n  var cookiesStrings = [];\n  var pos = 0;\n  var start;\n  var ch;\n  var lastComma;\n  var nextStart;\n  var cookiesSeparatorFound;\n  function skipWhitespace() {\n    while (pos < cookiesString.length && /\\s/.test(cookiesString.charAt(pos))) {\n      pos += 1;\n    }\n    return pos < cookiesString.length;\n  }\n  function notSpecialChar() {\n    ch = cookiesString.charAt(pos);\n    return ch !== \"=\" && ch !== \";\" && ch !== \",\";\n  }\n  while (pos < cookiesString.length) {\n    start = pos;\n    cookiesSeparatorFound = false;\n    while (skipWhitespace()) {\n      ch = cookiesString.charAt(pos);\n      if (ch === \",\") {\n        lastComma = pos;\n        pos += 1;\n        skipWhitespace();\n        nextStart = pos;\n        while (pos < cookiesString.length && notSpecialChar()) {\n          pos += 1;\n        }\n        if (pos < cookiesString.length && cookiesString.charAt(pos) === \"=\") {\n          cookiesSeparatorFound = true;\n          pos = nextStart;\n          cookiesStrings.push(cookiesString.substring(start, lastComma));\n          start = pos;\n        } else {\n          pos = lastComma + 1;\n        }\n      } else {\n        pos += 1;\n      }\n    }\n    if (!cookiesSeparatorFound || pos >= cookiesString.length) {\n      cookiesStrings.push(cookiesString.substring(start, cookiesString.length));\n    }\n  }\n  return cookiesStrings;\n}\n\n// src/request-cookies.ts\nvar RequestCookies = class {\n  constructor(requestHeaders) {\n    /** @internal */\n    this._parsed = /* @__PURE__ */ new Map();\n    this._headers = requestHeaders;\n    const header = requestHeaders.get(\"cookie\");\n    if (header) {\n      const parsed = parseCookie(header);\n      for (const [name, value] of parsed) {\n        this._parsed.set(name, { name, value });\n      }\n    }\n  }\n  [Symbol.iterator]() {\n    return this._parsed[Symbol.iterator]();\n  }\n  /**\n   * The amount of cookies received from the client\n   */\n  get size() {\n    return this._parsed.size;\n  }\n  get(...args) {\n    const name = typeof args[0] === \"string\" ? args[0] : args[0].name;\n    return this._parsed.get(name);\n  }\n  getAll(...args) {\n    var _a;\n    const all = Array.from(this._parsed);\n    if (!args.length) {\n      return all.map(([_, value]) => value);\n    }\n    const name = typeof args[0] === \"string\" ? args[0] : (_a = args[0]) == null ? void 0 : _a.name;\n    return all.filter(([n]) => n === name).map(([_, value]) => value);\n  }\n  has(name) {\n    return this._parsed.has(name);\n  }\n  set(...args) {\n    const [name, value] = args.length === 1 ? [args[0].name, args[0].value] : args;\n    const map = this._parsed;\n    map.set(name, { name, value });\n    this._headers.set(\n      \"cookie\",\n      Array.from(map).map(([_, value2]) => stringifyCookie(value2)).join(\"; \")\n    );\n    return this;\n  }\n  /**\n   * Delete the cookies matching the passed name or names in the request.\n   */\n  delete(names) {\n    const map = this._parsed;\n    const result = !Array.isArray(names) ? map.delete(names) : names.map((name) => map.delete(name));\n    this._headers.set(\n      \"cookie\",\n      Array.from(map).map(([_, value]) => stringifyCookie(value)).join(\"; \")\n    );\n    return result;\n  }\n  /**\n   * Delete all the cookies in the cookies in the request.\n   */\n  clear() {\n    this.delete(Array.from(this._parsed.keys()));\n    return this;\n  }\n  /**\n   * Format the cookies in the request as a string for logging\n   */\n  [Symbol.for(\"edge-runtime.inspect.custom\")]() {\n    return `RequestCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`;\n  }\n  toString() {\n    return [...this._parsed.values()].map((v) => `${v.name}=${encodeURIComponent(v.value)}`).join(\"; \");\n  }\n};\n\n// src/response-cookies.ts\nvar ResponseCookies = class {\n  constructor(responseHeaders) {\n    /** @internal */\n    this._parsed = /* @__PURE__ */ new Map();\n    var _a, _b, _c;\n    this._headers = responseHeaders;\n    const setCookie = (_c = (_b = (_a = responseHeaders.getSetCookie) == null ? void 0 : _a.call(responseHeaders)) != null ? _b : responseHeaders.get(\"set-cookie\")) != null ? _c : [];\n    const cookieStrings = Array.isArray(setCookie) ? setCookie : splitCookiesString(setCookie);\n    for (const cookieString of cookieStrings) {\n      const parsed = parseSetCookie(cookieString);\n      if (parsed)\n        this._parsed.set(parsed.name, parsed);\n    }\n  }\n  /**\n   * {@link https://wicg.github.io/cookie-store/#CookieStore-get CookieStore#get} without the Promise.\n   */\n  get(...args) {\n    const key = typeof args[0] === \"string\" ? args[0] : args[0].name;\n    return this._parsed.get(key);\n  }\n  /**\n   * {@link https://wicg.github.io/cookie-store/#CookieStore-getAll CookieStore#getAll} without the Promise.\n   */\n  getAll(...args) {\n    var _a;\n    const all = Array.from(this._parsed.values());\n    if (!args.length) {\n      return all;\n    }\n    const key = typeof args[0] === \"string\" ? args[0] : (_a = args[0]) == null ? void 0 : _a.name;\n    return all.filter((c) => c.name === key);\n  }\n  has(name) {\n    return this._parsed.has(name);\n  }\n  /**\n   * {@link https://wicg.github.io/cookie-store/#CookieStore-set CookieStore#set} without the Promise.\n   */\n  set(...args) {\n    const [name, value, cookie] = args.length === 1 ? [args[0].name, args[0].value, args[0]] : args;\n    const map = this._parsed;\n    map.set(name, normalizeCookie({ name, value, ...cookie }));\n    replace(map, this._headers);\n    return this;\n  }\n  /**\n   * {@link https://wicg.github.io/cookie-store/#CookieStore-delete CookieStore#delete} without the Promise.\n   */\n  delete(...args) {\n    const [name, options] = typeof args[0] === \"string\" ? [args[0]] : [args[0].name, args[0]];\n    return this.set({ ...options, name, value: \"\", expires: /* @__PURE__ */ new Date(0) });\n  }\n  [Symbol.for(\"edge-runtime.inspect.custom\")]() {\n    return `ResponseCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`;\n  }\n  toString() {\n    return [...this._parsed.values()].map(stringifyCookie).join(\"; \");\n  }\n};\nfunction replace(bag, headers) {\n  headers.delete(\"set-cookie\");\n  for (const [, value] of bag) {\n    const serialized = stringifyCookie(value);\n    headers.append(\"set-cookie\", serialized);\n  }\n}\nfunction normalizeCookie(cookie = { name: \"\", value: \"\" }) {\n  if (typeof cookie.expires === \"number\") {\n    cookie.expires = new Date(cookie.expires);\n  }\n  if (cookie.maxAge) {\n    cookie.expires = new Date(Date.now() + cookie.maxAge * 1e3);\n  }\n  if (cookie.path === null || cookie.path === void 0) {\n    cookie.path = \"/\";\n  }\n  return cookie;\n}\n// Annotate the CommonJS export names for ESM import in node:\n0 && (module.exports = {\n  RequestCookies,\n  ResponseCookies,\n  parseCookie,\n  parseSetCookie,\n  stringifyCookie\n});\n","export class ReflectAdapter {\n  static get<T extends object>(\n    target: T,\n    prop: string | symbol,\n    receiver: unknown\n  ): any {\n    const value = Reflect.get(target, prop, receiver)\n    if (typeof value === 'function') {\n      return value.bind(target)\n    }\n\n    return value\n  }\n\n  static set<T extends object>(\n    target: T,\n    prop: string | symbol,\n    value: any,\n    receiver: any\n  ): boolean {\n    return Reflect.set(target, prop, value, receiver)\n  }\n\n  static has<T extends object>(target: T, prop: string | symbol): boolean {\n    return Reflect.has(target, prop)\n  }\n\n  static deleteProperty<T extends object>(\n    target: T,\n    prop: string | symbol\n  ): boolean {\n    return Reflect.deleteProperty(target, prop)\n  }\n}\n","import { StaticGenBailoutError } from '../../client/components/static-generation-bailout'\nimport { afterTaskAsyncStorage } from '../app-render/after-task-async-storage.external'\nimport type { WorkStore } from '../app-render/work-async-storage.external'\n\nexport function throwWithStaticGenerationBailoutErrorWithDynamicError(\n  route: string,\n  expression: string\n): never {\n  throw new StaticGenBailoutError(\n    `Route ${route} with \\`dynamic = \"error\"\\` couldn't be rendered statically because it used ${expression}. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`\n  )\n}\n\nexport function throwForSearchParamsAccessInUseCache(\n  workStore: WorkStore,\n  constructorOpt: Function\n): never {\n  const error = new Error(\n    `Route ${workStore.route} used \\`searchParams\\` inside \"use cache\". Accessing dynamic request data inside a cache scope is not supported. If you need some search params inside a cached function await \\`searchParams\\` outside of the cached function and pass only the required search params as arguments to the cached function. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n  )\n\n  Error.captureStackTrace(error, constructorOpt)\n  workStore.invalidDynamicUsageError ??= error\n\n  throw error\n}\n\nexport function isRequestAPICallableInsideAfter() {\n  const afterTaskStore = afterTaskAsyncStorage.getStore()\n  return afterTaskStore?.rootTaskSpawnPhase === 'action'\n}\n","module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['react-rsc']!.ReactServerDOMTurbopackServer\n","/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","\"use server\";\n\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\";\nimport type { Database } from \"./types\";\n\n/**\n * Creates a Supabase client using the service role key.\n * This bypasses RLS and is intended for background jobs / automation.\n *\n * Performance Optimization:\n * - Uses SUPABASE_POOLER_URL (Transaction Mode) if available for 30-50% faster queries\n * - Falls back to NEXT_PUBLIC_SUPABASE_URL (Session Mode) if pooler not configured\n * - Transaction Mode supports 10,000+ concurrent connections vs 100 in Session Mode\n *\n * @returns Supabase client with service role, or null if not configured\n */\nexport async function createServiceSupabaseClient() {\n\t// Prefer pooler URL for Transaction Mode (better performance)\n\tconst supabaseUrl =\n\t\tprocess.env.SUPABASE_POOLER_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n\tconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n\tif (!supabaseUrl || !serviceRoleKey) {\n\t\treturn null;\n\t}\n\n\treturn createSupabaseClient<Database>(supabaseUrl, serviceRoleKey, {\n\t\tauth: {\n\t\t\tpersistSession: false,\n\t\t\tautoRefreshToken: false,\n\t\t},\n\t\tdb: {\n\t\t\tschema: \"public\",\n\t\t},\n\t\tglobal: {\n\t\t\theaders: {\n\t\t\t\t\"x-my-custom-header\": \"service-role\",\n\t\t\t},\n\t\t},\n\t});\n}\n\nexport type ServiceSupabaseClient = Awaited<\n\tReturnType<typeof createServiceSupabaseClient>\n>;\n","/**\n * Telnyx Configuration Validator\n *\n * Validates all required Telnyx environment variables and configuration.\n * Provides clear error messages for missing or invalid configuration.\n */\n\nimport { TELNYX_CONFIG } from \"./client\";\n\nexport type ValidationResult = {\n\tvalid: boolean;\n\terrors: string[];\n\twarnings: string[];\n\tconfig: {\n\t\tapiKey: boolean;\n\t\tconnectionId: boolean;\n\t\tmessagingProfileId: boolean;\n\t\twebhookSecret: boolean;\n\t\tpublicKey: boolean;\n\t\tsiteUrl: boolean;\n\t};\n};\n\nfunction isLocalUrl(url: string): boolean {\n\tconst lowered = url.toLowerCase();\n\treturn (\n\t\tlowered.includes(\"localhost\") ||\n\t\tlowered.includes(\"127.0.0.1\") ||\n\t\tlowered.includes(\"0.0.0.0\") ||\n\t\tlowered.endsWith(\".local\") ||\n\t\tlowered.includes(\"://local\")\n\t);\n}\n\nfunction getBaseAppUrl(): string | undefined {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\tfor (const candidate of candidates) {\n\t\tif (candidate && candidate.trim()) {\n\t\t\tconst trimmed = candidate.trim();\n\t\t\tif (!isLocalUrl(trimmed)) {\n\t\t\t\treturn trimmed.startsWith(\"http\") ? trimmed : `https://${trimmed}`;\n\t\t\t}\n\t\t}\n\t}\n\n\tconst vercelUrl = process.env.VERCEL_URL;\n\tif (vercelUrl && !isLocalUrl(vercelUrl)) {\n\t\treturn vercelUrl.startsWith(\"http\") ? vercelUrl : `https://${vercelUrl}`;\n\t}\n\n\treturn undefined;\n}\n\n/**\n * Validate all Telnyx configuration\n */\nexport function validateTelnyxConfig(): ValidationResult {\n\tconst errors: string[] = [];\n\tconst warnings: string[] = [];\n\tconst config = {\n\t\tapiKey: false,\n\t\tconnectionId: false,\n\t\tmessagingProfileId: false,\n\t\twebhookSecret: false,\n\t\tpublicKey: false,\n\t\tsiteUrl: false,\n\t};\n\n\t// Check API Key (required)\n\tif (!TELNYX_CONFIG.apiKey || TELNYX_CONFIG.apiKey.trim() === \"\") {\n\t\terrors.push(\n\t\t\t\"TELNYX_API_KEY is not set. This is required for all Telnyx operations.\",\n\t\t);\n\t} else if (TELNYX_CONFIG.apiKey.length < 20) {\n\t\terrors.push(\n\t\t\t\"TELNYX_API_KEY appears to be invalid (too short). Get your API key from https://portal.telnyx.com\",\n\t\t);\n\t} else {\n\t\tconfig.apiKey = true;\n\t}\n\n\t// Check Connection ID (required for voice calls)\n\tif (!TELNYX_CONFIG.connectionId || TELNYX_CONFIG.connectionId.trim() === \"\") {\n\t\terrors.push(\n\t\t\t\"NEXT_PUBLIC_TELNYX_CONNECTION_ID is not set. This is required for phone calls. Get it from Telnyx Portal → Mission Control → Connections.\",\n\t\t);\n\t} else {\n\t\tconfig.connectionId = true;\n\t}\n\n\t// Check Messaging Profile ID (required for SMS)\n\tif (\n\t\t!TELNYX_CONFIG.messagingProfileId ||\n\t\tTELNYX_CONFIG.messagingProfileId.trim() === \"\"\n\t) {\n\t\terrors.push(\n\t\t\t\"TELNYX_DEFAULT_MESSAGING_PROFILE_ID or NEXT_PUBLIC_TELNYX_MESSAGING_PROFILE_ID is not set. This is required for SMS/MMS. Run getDefaultMessagingProfile() to fetch it automatically from Telnyx.\",\n\t\t);\n\t} else {\n\t\tconfig.messagingProfileId = true;\n\t}\n\n\t// Check Webhook Secret (recommended for production)\n\tif (\n\t\t!TELNYX_CONFIG.webhookSecret ||\n\t\tTELNYX_CONFIG.webhookSecret.trim() === \"\"\n\t) {\n\t\twarnings.push(\n\t\t\t\"TELNYX_WEBHOOK_SECRET is not set. Webhook signature verification will be disabled. Set this in production for security.\",\n\t\t);\n\t} else {\n\t\tconfig.webhookSecret = true;\n\t}\n\n\t// Check Public Key (recommended for production)\n\tif (!TELNYX_CONFIG.publicKey || TELNYX_CONFIG.publicKey.trim() === \"\") {\n\t\twarnings.push(\n\t\t\t\"TELNYX_PUBLIC_KEY is not set. Webhook signature verification may not work correctly. Get it from Telnyx Portal → API Keys.\",\n\t\t);\n\t} else {\n\t\tconfig.publicKey = true;\n\t}\n\n\t// Check Site URL (required for webhooks)\n\tconst siteUrl = getBaseAppUrl();\n\tif (!siteUrl) {\n\t\terrors.push(\n\t\t\t\"NEXT_PUBLIC_SITE_URL or SITE_URL is not set to a valid production URL. This is required for webhook callbacks. Set it to your production domain (e.g., https://thorbis.co).\",\n\t\t);\n\t} else if (isLocalUrl(siteUrl)) {\n\t\tconst isProduction =\n\t\t\tprocess.env.VERCEL_ENV === \"production\" ||\n\t\t\tprocess.env.DEPLOYMENT_ENV === \"production\";\n\t\tif (isProduction) {\n\t\t\terrors.push(\n\t\t\t\t`Site URL is set to localhost (${siteUrl}) but you're in production. Set NEXT_PUBLIC_SITE_URL to your production domain.`,\n\t\t\t);\n\t\t} else {\n\t\t\twarnings.push(\n\t\t\t\t`Site URL is set to localhost (${siteUrl}). This will not work in production.`,\n\t\t\t);\n\t\t}\n\t} else {\n\t\tconfig.siteUrl = true;\n\t}\n\n\treturn {\n\t\tvalid: errors.length === 0,\n\t\terrors,\n\t\twarnings,\n\t\tconfig,\n\t};\n}\n\n/**\n * Validate configuration for SMS operations\n */\nexport async function validateSmsConfig(): Promise<{\n\tvalid: boolean;\n\terror?: string;\n\tsuggestedProfileId?: string;\n}> {\n\tconst validation = validateTelnyxConfig();\n\n\tif (!validation.config.apiKey) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: \"TELNYX_API_KEY is required for SMS operations\",\n\t\t};\n\t}\n\n\tif (!validation.config.messagingProfileId) {\n\t\t// Try to fetch messaging profile automatically\n\t\ttry {\n\t\t\tconst { getDefaultMessagingProfile } = await import(\n\t\t\t\t\"./messaging-profile-fetcher\"\n\t\t\t);\n\t\t\tconst profileResult = await getDefaultMessagingProfile();\n\n\t\t\tif (profileResult.success && profileResult.profile) {\n\t\t\t\treturn {\n\t\t\t\t\tvalid: false,\n\t\t\t\t\terror:\n\t\t\t\t\t\t\"TELNYX_DEFAULT_MESSAGING_PROFILE_ID is required for SMS operations.\",\n\t\t\t\t\tsuggestedProfileId: profileResult.profile.id,\n\t\t\t\t};\n\t\t\t}\n\t\t} catch {\n\t\t\t// If fetch fails, return generic error\n\t\t}\n\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"TELNYX_DEFAULT_MESSAGING_PROFILE_ID is required for SMS operations. Run getDefaultMessagingProfile() to fetch it automatically from Telnyx.\",\n\t\t};\n\t}\n\n\tif (!validation.config.siteUrl) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be set to a valid production URL for SMS webhooks.\",\n\t\t};\n\t}\n\n\treturn { valid: true };\n}\n\n/**\n * Validate configuration for voice call operations\n */\nexport function validateCallConfig(): {\n\tvalid: boolean;\n\terror?: string;\n} {\n\tconst validation = validateTelnyxConfig();\n\n\tif (!validation.config.apiKey) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: \"TELNYX_API_KEY is required for phone calls\",\n\t\t};\n\t}\n\n\tif (!validation.config.connectionId) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_TELNYX_CONNECTION_ID is required for phone calls. Get it from Telnyx Portal → Mission Control → Connections.\",\n\t\t};\n\t}\n\n\tif (!validation.config.siteUrl) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror:\n\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be set to a valid production URL for call webhooks.\",\n\t\t};\n\t}\n\n\treturn { valid: true };\n}\n\n/**\n * Get formatted error message for display to users\n */\nfunction getFormattedErrorMessage(validation: ValidationResult): string {\n\tif (validation.valid) {\n\t\treturn \"\";\n\t}\n\n\tconst lines = [\"Telnyx configuration errors:\"];\n\tvalidation.errors.forEach((error, index) => {\n\t\tlines.push(`${index + 1}. ${error}`);\n\t});\n\n\tif (validation.warnings.length > 0) {\n\t\tlines.push(\"\");\n\t\tlines.push(\"Warnings:\");\n\t\tvalidation.warnings.forEach((warning, index) => {\n\t\t\tlines.push(`${index + 1}. ${warning}`);\n\t\t});\n\t}\n\n\treturn lines.join(\"\\n\");\n}\n","/**\n * Messaging Profile Fetcher\n *\n * Fetches messaging profiles from Telnyx API to help with configuration.\n */\n\nimport { telnyxClient } from \"./client\";\n\nexport type MessagingProfile = {\n\tid: string;\n\tname: string;\n\tenabled: boolean;\n\twebhook_url: string | null;\n\twebhook_failover_url: string | null;\n\twebhook_api_version: string | null;\n};\n\nexport type ListMessagingProfilesResult = {\n\tsuccess: boolean;\n\tprofiles?: MessagingProfile[];\n\terror?: string;\n};\n\n/**\n * List all messaging profiles from Telnyx\n */\nasync function listMessagingProfiles(): Promise<ListMessagingProfilesResult> {\n\ttry {\n\t\tconst response = await telnyxClient.messagingProfiles.list();\n\t\tconst profiles = (response.data || []) as any[];\n\n\t\tconst formattedProfiles: MessagingProfile[] = profiles.map((profile) => ({\n\t\t\tid: profile.id,\n\t\t\tname: profile.name || \"Unnamed Profile\",\n\t\t\tenabled: profile.enabled !== false,\n\t\t\twebhook_url: profile.webhook_url || null,\n\t\t\twebhook_failover_url: profile.webhook_failover_url || null,\n\t\t\twebhook_api_version: profile.webhook_api_version || null,\n\t\t}));\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tprofiles: formattedProfiles,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error?.message || \"Failed to list messaging profiles\",\n\t\t};\n\t}\n}\n\n/**\n * Get the default messaging profile (first enabled profile, or first profile if none enabled)\n */\nexport async function getDefaultMessagingProfile(): Promise<{\n\tsuccess: boolean;\n\tprofile?: MessagingProfile;\n\terror?: string;\n\trecommendation?: string;\n}> {\n\tconst result = await listMessagingProfiles();\n\n\tif (!result.success || !result.profiles) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: result.error || \"Failed to fetch messaging profiles\",\n\t\t};\n\t}\n\n\tif (result.profiles.length === 0) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"No messaging profiles found in Telnyx account\",\n\t\t\trecommendation:\n\t\t\t\t\"Create a messaging profile in Telnyx Portal → Messaging → Profiles\",\n\t\t};\n\t}\n\n\t// Prefer enabled profiles\n\tconst enabledProfiles = result.profiles.filter((p) => p.enabled);\n\tconst selectedProfile =\n\t\tenabledProfiles.length > 0 ? enabledProfiles[0] : result.profiles[0];\n\n\tlet recommendation: string | undefined;\n\tif (result.profiles.length > 1) {\n\t\trecommendation = `Found ${result.profiles.length} messaging profiles. Using \"${selectedProfile.name}\" (ID: ${selectedProfile.id}). To use a different profile, set TELNYX_DEFAULT_MESSAGING_PROFILE_ID to the desired profile ID.`;\n\t}\n\n\treturn {\n\t\tsuccess: true,\n\t\tprofile: selectedProfile,\n\t\trecommendation,\n\t};\n}\n\n/**\n * Get messaging profile by ID\n */\nasync function getMessagingProfileById(profileId: string): Promise<{\n\tsuccess: boolean;\n\tprofile?: MessagingProfile;\n\terror?: string;\n}> {\n\ttry {\n\t\tconst response = await telnyxClient.messagingProfiles.retrieve(profileId);\n\t\tconst profileData = response.data as any;\n\n\t\tif (!profileData) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Messaging profile ${profileId} not found`,\n\t\t\t};\n\t\t}\n\n\t\tconst profile: MessagingProfile = {\n\t\t\tid: profileData.id,\n\t\t\tname: profileData.name || \"Unnamed Profile\",\n\t\t\tenabled: profileData.enabled !== false,\n\t\t\twebhook_url: profileData.webhook_url || null,\n\t\t\twebhook_failover_url: profileData.webhook_failover_url || null,\n\t\t\twebhook_api_version: profileData.webhook_api_version || null,\n\t\t};\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tprofile,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error?.message || \"Failed to retrieve messaging profile\",\n\t\t};\n\t}\n}\n","/**\n * Connection Setup & Verification\n *\n * Verifies connection configuration and can auto-update webhook URLs.\n */\n\nimport { TELNYX_CONFIG, telnyxClient } from \"./client\";\n\nexport type ConnectionStatus = {\n\texists: boolean;\n\tisActive: boolean;\n\thasWebhookUrl: boolean;\n\twebhookUrl: string | null;\n\twebhookFailoverUrl: string | null;\n\twebhookApiVersion: string | null;\n\tconnectionType: string | null;\n\tsupportsVoice: boolean;\n\tneedsFix: boolean;\n\tissues: string[];\n};\n\nexport type ConnectionFixResult = {\n\tsuccess: boolean;\n\tfixed: boolean;\n\terror?: string;\n\tchanges: string[];\n};\n\nfunction getWebhookUrl(): string | undefined {\n\tconst candidates = [\n\t\tprocess.env.NEXT_PUBLIC_SITE_URL,\n\t\tprocess.env.SITE_URL,\n\t\tprocess.env.NEXT_PUBLIC_APP_URL,\n\t\tprocess.env.APP_URL,\n\t];\n\tfor (const candidate of candidates) {\n\t\tif (candidate && candidate.trim()) {\n\t\t\tconst trimmed = candidate.trim();\n\t\t\tconst isLocal =\n\t\t\t\ttrimmed.includes(\"localhost\") ||\n\t\t\t\ttrimmed.includes(\"127.0.0.1\") ||\n\t\t\t\ttrimmed.includes(\"0.0.0.0\");\n\t\t\tif (!isLocal) {\n\t\t\t\tconst normalized = trimmed.startsWith(\"http\")\n\t\t\t\t\t? trimmed\n\t\t\t\t\t: `https://${trimmed}`;\n\t\t\t\treturn `${normalized.replace(/\\/+$/, \"\")}/api/webhooks/telnyx`;\n\t\t\t}\n\t\t}\n\t}\n\treturn undefined;\n}\n\n/**\n * Verify connection configuration\n */\nexport async function verifyConnection(\n\tconnectionId?: string,\n): Promise<ConnectionStatus> {\n\tconst connId = connectionId || TELNYX_CONFIG.connectionId;\n\n\tconst status: ConnectionStatus = {\n\t\texists: false,\n\t\tisActive: false,\n\t\thasWebhookUrl: false,\n\t\twebhookUrl: null,\n\t\twebhookFailoverUrl: null,\n\t\twebhookApiVersion: null,\n\t\tconnectionType: null,\n\t\tsupportsVoice: false,\n\t\tneedsFix: false,\n\t\tissues: [],\n\t};\n\n\tif (!connId || connId.trim() === \"\") {\n\t\tstatus.issues.push(\"Connection ID is not configured\");\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n\n\ttry {\n\t\tconst connection =\n\t\t\tawait telnyxClient.callControlApplications.retrieve(connId);\n\t\tconst connectionData = connection.data as any;\n\n\t\tif (!connectionData) {\n\t\t\tstatus.issues.push(`Connection ${connId} not found in Telnyx`);\n\t\t\tstatus.needsFix = true;\n\t\t\treturn status;\n\t\t}\n\n\t\tstatus.exists = true;\n\t\tstatus.isActive = connectionData.active !== false;\n\t\tstatus.webhookUrl = connectionData.webhook_event_url || null;\n\t\tstatus.webhookFailoverUrl =\n\t\t\tconnectionData.webhook_event_failover_url || null;\n\t\tstatus.webhookApiVersion = connectionData.webhook_api_version || null;\n\t\tstatus.connectionType = connectionData.type || null;\n\n\t\t// Check if connection supports voice\n\t\t// Call Control Applications typically support voice\n\t\tstatus.supportsVoice = true;\n\n\t\t// Check webhook URL\n\t\tconst expectedWebhookUrl = getWebhookUrl();\n\t\tif (!expectedWebhookUrl) {\n\t\t\tstatus.issues.push(\n\t\t\t\t\"NEXT_PUBLIC_SITE_URL is not set to a valid production URL\",\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t} else if (!status.webhookUrl) {\n\t\t\tstatus.issues.push(\n\t\t\t\t`Webhook URL is not set. Expected: ${expectedWebhookUrl} (with optional ?company=... for multi-tenant)`,\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t} else {\n\t\t\t// Accept both base webhook URL and company-specific URLs (with query params)\n\t\t\tconst baseUrl = status.webhookUrl.split(\"?\")[0];\n\t\t\tif (\n\t\t\t\tbaseUrl === expectedWebhookUrl ||\n\t\t\t\tstatus.webhookUrl === expectedWebhookUrl\n\t\t\t) {\n\t\t\t\tstatus.hasWebhookUrl = true;\n\t\t\t} else {\n\t\t\t\tstatus.issues.push(\n\t\t\t\t\t`Webhook URL base is not set correctly. Expected: ${expectedWebhookUrl}, Current: ${baseUrl}`,\n\t\t\t\t);\n\t\t\t\tstatus.needsFix = true;\n\t\t\t}\n\t\t}\n\n\t\t// Check webhook API version\n\t\tif (status.webhookApiVersion !== \"2\") {\n\t\t\tstatus.issues.push(\n\t\t\t\t`Webhook API version should be \"2\", but is \"${status.webhookApiVersion || \"not set\"}\"`,\n\t\t\t);\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\t// Check if connection is active\n\t\tif (!status.isActive) {\n\t\t\tstatus.issues.push(\"Connection is not active\");\n\t\t\tstatus.needsFix = true;\n\t\t}\n\n\t\treturn status;\n\t} catch (error: any) {\n\t\tif (error?.statusCode === 404) {\n\t\t\tstatus.issues.push(`Connection ${connId} not found in Telnyx`);\n\t\t} else {\n\t\t\tstatus.issues.push(error?.message || \"Failed to retrieve connection\");\n\t\t}\n\t\tstatus.needsFix = true;\n\t\treturn status;\n\t}\n}\n\n/**\n * Auto-fix connection configuration\n */\nexport async function fixConnection(\n\tconnectionId?: string,\n\toptions?: {\n\t\twebhookUrl?: string;\n\t\twebhookFailoverUrl?: string;\n\t},\n): Promise<ConnectionFixResult> {\n\tconst connId = connectionId || TELNYX_CONFIG.connectionId;\n\tconst changes: string[] = [];\n\n\tif (!connId || connId.trim() === \"\") {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: \"Connection ID is not configured\",\n\t\t\tchanges: [],\n\t\t};\n\t}\n\n\ttry {\n\t\t// Get current status\n\t\tconst status = await verifyConnection(connId);\n\t\tif (!status.needsFix) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tfixed: false,\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Get expected webhook URL\n\t\tconst expectedWebhookUrl = options?.webhookUrl || getWebhookUrl();\n\t\tif (!expectedWebhookUrl) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tfixed: false,\n\t\t\t\terror:\n\t\t\t\t\t\"NEXT_PUBLIC_SITE_URL must be set to a valid production URL to configure webhooks\",\n\t\t\t\tchanges: [],\n\t\t\t};\n\t\t}\n\n\t\t// Prepare update\n\t\tconst updateData: Record<string, unknown> = {};\n\n\t\t// Fix webhook URL\n\t\tif (status.webhookUrl !== expectedWebhookUrl) {\n\t\t\tupdateData.webhook_event_url = expectedWebhookUrl;\n\t\t\tchanges.push(`Updated webhook URL to ${expectedWebhookUrl}`);\n\t\t}\n\n\t\t// Fix webhook failover URL\n\t\tconst expectedFailoverUrl =\n\t\t\toptions?.webhookFailoverUrl ||\n\t\t\tprocess.env.TELNYX_WEBHOOK_FAILOVER_URL ||\n\t\t\tnull;\n\t\tif (status.webhookFailoverUrl !== expectedFailoverUrl) {\n\t\t\tupdateData.webhook_event_failover_url = expectedFailoverUrl;\n\t\t\tif (expectedFailoverUrl) {\n\t\t\t\tchanges.push(`Updated webhook failover URL to ${expectedFailoverUrl}`);\n\t\t\t} else {\n\t\t\t\tchanges.push(\"Removed webhook failover URL\");\n\t\t\t}\n\t\t}\n\n\t\t// Fix webhook API version\n\t\tif (status.webhookApiVersion !== \"2\") {\n\t\t\tupdateData.webhook_api_version = \"2\";\n\t\t\tchanges.push(\"Updated webhook API version to 2\");\n\t\t}\n\n\t\t// Fix connection active status\n\t\tif (!status.isActive) {\n\t\t\tupdateData.active = true;\n\t\t\tchanges.push(\"Activated connection\");\n\t\t}\n\n\t\t// Apply updates if needed\n\t\tif (Object.keys(updateData).length > 0) {\n\t\t\tawait telnyxClient.callControlApplications.update(connId, updateData);\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tfixed: changes.length > 0,\n\t\t\tchanges,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tfixed: false,\n\t\t\terror: error?.message || \"Failed to update connection\",\n\t\t\tchanges,\n\t\t};\n\t}\n}\n\n/**\n * Get connection details\n */\nasync function getConnectionDetails(connectionId?: string): Promise<{\n\tsuccess: boolean;\n\tdata?: any;\n\terror?: string;\n}> {\n\tconst connId = connectionId || TELNYX_CONFIG.connectionId;\n\n\tif (!connId || connId.trim() === \"\") {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: \"Connection ID is not configured\",\n\t\t};\n\t}\n\n\ttry {\n\t\tconst connection =\n\t\t\tawait telnyxClient.callControlApplications.retrieve(connId);\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdata: connection.data,\n\t\t};\n\t} catch (error: any) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error?.message || \"Failed to retrieve connection\",\n\t\t};\n\t}\n}\n","/**\n * Telnyx Webhooks Service - Webhook Verification & Processing\n *\n * Production-ready webhook security:\n * - MANDATORY signature verification in production (fail-closed)\n * - Timestamp validation (replay protection)\n * - Database-backed deduplication (works across serverless instances)\n * - Multi-tenant support (company_id scoping)\n * - Structured logging\n */\n\nimport crypto from \"node:crypto\";\nimport { TELNYX_CONFIG } from \"./client\";\nimport { telnyxLogger } from \"./logger\";\nimport { TelnyxWebhookError, TelnyxErrorCode } from \"./errors\";\nimport { telnyxMetrics } from \"./metrics\";\nimport { createServiceSupabaseClient } from \"@/lib/supabase/service-client\";\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nconst WEBHOOK_CONFIG = {\n\t// Maximum age for webhook timestamps (replay protection)\n\tmaxTimestampAgeSeconds: 300, // 5 minutes\n\t// Minimum allowed timestamp age (future timestamps)\n\tminTimestampAgeFutureSeconds: 60, // 1 minute tolerance for clock skew\n\t// Deduplication window\n\tdedupWindowMinutes: 5,\n\t// Log level for webhook events\n\tlogLevel: (process.env.TELNYX_WEBHOOK_LOG_LEVEL || \"info\") as \"debug\" | \"info\",\n};\n\n// In-memory fallback for development (NOT used in production)\nconst processedWebhooksInMemory = new Map<string, number>();\nconst DEDUP_WINDOW_MS = WEBHOOK_CONFIG.dedupWindowMinutes * 60 * 1000;\n\n/**\n * Check if we're in production mode\n * IMPORTANT: Fail closed - if NODE_ENV is not explicitly 'development', treat as production\n */\nfunction isProductionMode(): boolean {\n\treturn process.env.NODE_ENV !== \"development\";\n}\n\n/**\n * Telnyx webhook event types\n */\nexport type WebhookEventType =\n\t// Call events\n\t| \"call.initiated\"\n\t| \"call.answered\"\n\t| \"call.hangup\"\n\t| \"call.bridged\"\n\t| \"call.speak.ended\"\n\t| \"call.playback.started\"\n\t| \"call.playback.ended\"\n\t| \"call.dtmf.received\"\n\t| \"call.gather.ended\"\n\t| \"call.recording.saved\"\n\t| \"call.machine.detection.ended\"\n\t| \"call.machine.premium.detection.ended\"\n\t// Message events\n\t| \"message.sent\"\n\t| \"message.delivered\"\n\t| \"message.sending_failed\"\n\t| \"message.delivery_failed\"\n\t| \"message.received\"\n\t| \"message.finalized\"\n\t// Fax events\n\t| \"fax.received\"\n\t| \"fax.sent\"\n\t| \"fax.failed\"\n\t// Number events\n\t| \"number_reservation.created\"\n\t| \"number_reservation.deleted\"\n\t| \"number_order.created\"\n\t| \"number_order.updated\"\n\t// Conference events\n\t| \"conference.created\"\n\t| \"conference.ended\"\n\t| \"conference.participant.joined\"\n\t| \"conference.participant.left\";\n\n/**\n * Base webhook payload structure\n */\nexport type WebhookPayload = {\n\tdata: {\n\t\tevent_type: WebhookEventType;\n\t\tid: string;\n\t\toccurred_at: string;\n\t\tpayload: Record<string, unknown>;\n\t\trecord_type: string;\n\t};\n\tmeta?: {\n\t\tattempt_number: number;\n\t\tdelivered_to: string;\n\t};\n};\n\n/**\n * Call webhook payload types\n */\nexport interface CallInitiatedPayload extends WebhookPayload {\n\tdata: {\n\t\tevent_type: \"call.initiated\";\n\t\tpayload: {\n\t\t\tcall_control_id: string;\n\t\t\tcall_leg_id: string;\n\t\t\tcall_session_id: string;\n\t\t\tclient_state: string | null;\n\t\t\tconnection_id: string;\n\t\t\tdirection: \"incoming\" | \"outgoing\";\n\t\t\tfrom: string;\n\t\t\tstart_time: string;\n\t\t\tstate: \"parked\";\n\t\t\tto: string;\n\t\t};\n\t} & WebhookPayload[\"data\"];\n}\n\nexport interface CallAnsweredPayload extends WebhookPayload {\n\tdata: {\n\t\tevent_type: \"call.answered\";\n\t\tpayload: {\n\t\t\tcall_control_id: string;\n\t\t\tcall_leg_id: string;\n\t\t\tcall_session_id: string;\n\t\t\tclient_state: string | null;\n\t\t\tconnection_id: string;\n\t\t\tfrom: string;\n\t\t\tstart_time: string;\n\t\t\tstate: \"answered\";\n\t\t\tto: string;\n\t\t};\n\t} & WebhookPayload[\"data\"];\n}\n\nexport interface CallHangupPayload extends WebhookPayload {\n\tdata: {\n\t\tevent_type: \"call.hangup\";\n\t\tpayload: {\n\t\t\tcall_control_id: string;\n\t\t\tcall_leg_id: string;\n\t\t\tcall_session_id: string;\n\t\t\tclient_state: string | null;\n\t\t\tconnection_id: string;\n\t\t\tend_time: string;\n\t\t\tfrom: string;\n\t\t\thangup_cause: string;\n\t\t\thangup_source: string;\n\t\t\tsip_hangup_cause: string;\n\t\t\tstart_time: string;\n\t\t\tstate: \"hangup\";\n\t\t\tto: string;\n\t\t};\n\t} & WebhookPayload[\"data\"];\n}\n\n/**\n * Message webhook payload types\n */\nexport interface MessageReceivedPayload extends WebhookPayload {\n\tdata: {\n\t\tevent_type: \"message.received\";\n\t\tpayload: {\n\t\t\tid: string;\n\t\t\tfrom: {\n\t\t\t\tphone_number: string;\n\t\t\t\tcarrier: string;\n\t\t\t\tline_type: string;\n\t\t\t};\n\t\t\tto: Array<{\n\t\t\t\tphone_number: string;\n\t\t\t\tstatus: string;\n\t\t\t}>;\n\t\t\ttext: string;\n\t\t\tmedia: Array<{\n\t\t\t\turl: string;\n\t\t\t\tcontent_type: string;\n\t\t\t\tsize: number;\n\t\t\t}>;\n\t\t\treceived_at: string;\n\t\t\twebhook_url: string;\n\t\t\twebhook_failover_url: string;\n\t\t};\n\t} & WebhookPayload[\"data\"];\n}\n\n// =============================================================================\n// SIGNATURE VERIFICATION (FAIL-CLOSED IN PRODUCTION)\n// =============================================================================\n\n/**\n * Verify webhook signature from Telnyx\n *\n * Telnyx signs webhooks with Ed25519 using your public key.\n * The signature is sent in the `telnyx-signature-ed25519` header.\n *\n * SECURITY: This function FAILS CLOSED in production.\n * - Production: Rejects ALL webhooks if public key is not configured\n * - Development: Allows skipping verification with warning\n */\nexport function verifyWebhookSignature(params: {\n\tpayload: string | Buffer;\n\tsignature: string;\n\ttimestamp: string;\n\tcorrelationId?: string;\n}): { valid: boolean; error?: string } {\n\tconst correlationId = params.correlationId || \"unknown\";\n\tconst isProduction = isProductionMode();\n\n\ttry {\n\t\tconst publicKeyBase64 = TELNYX_CONFIG.publicKey;\n\n\t\t// CRITICAL: Fail closed in production if no public key\n\t\tif (!publicKeyBase64) {\n\t\t\tif (isProduction) {\n\t\t\t\ttelnyxLogger.error(\n\t\t\t\t\t\"SECURITY: Webhook rejected - TELNYX_PUBLIC_KEY not configured in production\",\n\t\t\t\t\t{ correlationId }\n\t\t\t\t);\n\t\t\t\treturn {\n\t\t\t\t\tvalid: false,\n\t\t\t\t\terror: \"TELNYX_PUBLIC_KEY is required in production - webhook rejected\",\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// Development only: allow with warning\n\t\t\ttelnyxLogger.warn(\n\t\t\t\t\"[DEV ONLY] Webhook signature verification skipped - TELNYX_PUBLIC_KEY not configured\",\n\t\t\t\t{ correlationId }\n\t\t\t);\n\t\t\treturn { valid: true };\n\t\t}\n\n\t\t// Validate required parameters\n\t\tif (!params.signature) {\n\t\t\ttelnyxLogger.warn(\"Webhook missing signature header\", { correlationId });\n\t\t\treturn { valid: false, error: \"Missing telnyx-signature-ed25519 header\" };\n\t\t}\n\n\t\tif (!params.timestamp) {\n\t\t\ttelnyxLogger.warn(\"Webhook missing timestamp header\", { correlationId });\n\t\t\treturn { valid: false, error: \"Missing telnyx-timestamp header\" };\n\t\t}\n\n\t\t// Build signed payload: timestamp|payload\n\t\tconst payloadBuffer = Buffer.isBuffer(params.payload)\n\t\t\t? params.payload\n\t\t\t: Buffer.from(params.payload);\n\t\tconst signedPayload = Buffer.concat([\n\t\t\tBuffer.from(params.timestamp),\n\t\t\tBuffer.from(\"|\"),\n\t\t\tpayloadBuffer,\n\t\t]);\n\n\t\t// Create public key from base64 DER format\n\t\tconst publicKey = crypto.createPublicKey({\n\t\t\tkey: Buffer.from(publicKeyBase64, \"base64\"),\n\t\t\tformat: \"der\",\n\t\t\ttype: \"spki\",\n\t\t});\n\n\t\t// Verify Ed25519 signature\n\t\tconst isValid = crypto.verify(\n\t\t\tnull, // Ed25519 doesn't use a separate hash algorithm\n\t\t\tsignedPayload,\n\t\t\tpublicKey,\n\t\t\tBuffer.from(params.signature, \"base64\")\n\t\t);\n\n\t\tif (!isValid) {\n\t\t\ttelnyxLogger.warn(\"Webhook signature verification failed - invalid signature\", {\n\t\t\t\tcorrelationId,\n\t\t\t});\n\t\t\treturn { valid: false, error: \"Invalid signature\" };\n\t\t}\n\n\t\ttelnyxLogger.debug(\"Webhook signature verified successfully\", { correlationId });\n\t\treturn { valid: true };\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"Webhook signature verification error\", {\n\t\t\tcorrelationId,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: error instanceof Error ? error.message : \"Signature verification failed\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// PAYLOAD PARSING\n// =============================================================================\n\n/**\n * Parse and validate webhook payload\n */\nexport function parseWebhookPayload(\n\trawPayload: string | Buffer\n): WebhookPayload | null {\n\ttry {\n\t\tconst payload =\n\t\t\ttypeof rawPayload === \"string\"\n\t\t\t\t? JSON.parse(rawPayload)\n\t\t\t\t: JSON.parse(rawPayload.toString());\n\n\t\t// Validate required fields\n\t\tif (!(payload.data?.event_type && payload.data.payload)) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn payload as WebhookPayload;\n\t} catch {\n\t\treturn null;\n\t}\n}\n\n/**\n * Extract event type from webhook payload\n */\nexport function getEventType(payload: WebhookPayload): WebhookEventType {\n\treturn payload.data.event_type;\n}\n\n/**\n * Type guard for call events\n */\nexport function isCallEvent(eventType: WebhookEventType): boolean {\n\treturn eventType.startsWith(\"call.\");\n}\n\n/**\n * Type guard for message events\n */\nexport function isMessageEvent(eventType: WebhookEventType): boolean {\n\treturn eventType.startsWith(\"message.\");\n}\n\n/**\n * Format webhook response for Telnyx\n */\nexport function createWebhookResponse(success: boolean, message?: string) {\n\treturn {\n\t\tsuccess,\n\t\tmessage:\n\t\t\tmessage ||\n\t\t\t(success\n\t\t\t\t? \"Webhook processed successfully\"\n\t\t\t\t: \"Webhook processing failed\"),\n\t};\n}\n\n// =============================================================================\n// TIMESTAMP VALIDATION (REPLAY PROTECTION)\n// =============================================================================\n\n/**\n * Validate webhook timestamp to prevent replay attacks\n * Rejects webhooks older than 5 minutes or too far in the future\n */\nexport function isWebhookTimestampValid(\n\ttimestamp: string,\n\tmaxAgeSeconds = WEBHOOK_CONFIG.maxTimestampAgeSeconds\n): { valid: boolean; error?: string; ageSeconds?: number } {\n\ttry {\n\t\tif (!timestamp) {\n\t\t\treturn { valid: false, error: \"Missing timestamp\" };\n\t\t}\n\n\t\tlet webhookTimeMs: number;\n\n\t\tconst numericTimestamp = Number(timestamp);\n\t\tif (Number.isFinite(numericTimestamp)) {\n\t\t\t// Telnyx sends UNIX seconds as the timestamp header\n\t\t\twebhookTimeMs = numericTimestamp * 1000;\n\t\t} else {\n\t\t\tconst parsed = new Date(timestamp).getTime();\n\t\t\tif (Number.isNaN(parsed)) {\n\t\t\t\treturn { valid: false, error: \"Invalid timestamp format\" };\n\t\t\t}\n\t\t\twebhookTimeMs = parsed;\n\t\t}\n\n\t\tconst now = Date.now();\n\t\tconst ageSeconds = (now - webhookTimeMs) / 1000;\n\n\t\t// Check if too old\n\t\tif (ageSeconds > maxAgeSeconds) {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\terror: `Timestamp too old: ${Math.round(ageSeconds)}s (max ${maxAgeSeconds}s)`,\n\t\t\t\tageSeconds,\n\t\t\t};\n\t\t}\n\n\t\t// Check if too far in the future (clock skew tolerance)\n\t\tif (ageSeconds < -WEBHOOK_CONFIG.minTimestampAgeFutureSeconds) {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\terror: `Timestamp too far in future: ${Math.round(-ageSeconds)}s`,\n\t\t\t\tageSeconds,\n\t\t\t};\n\t\t}\n\n\t\treturn { valid: true, ageSeconds };\n\t} catch (error) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: error instanceof Error ? error.message : \"Timestamp validation failed\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// DATABASE-BACKED DEDUPLICATION (Multi-Tenant)\n// =============================================================================\n\n/**\n * Check if a webhook has already been processed (async, database-backed)\n *\n * @param companyId - The company ID for multi-tenant isolation\n * @param webhookId - The unique webhook ID from Telnyx\n * @param source - The webhook source (default: 'telnyx')\n */\nexport async function isWebhookDuplicateAsync(\n\tcompanyId: string,\n\twebhookId: string,\n\tsource = \"telnyx\"\n): Promise<boolean> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tif (!supabase) {\n\t\t\t// Fallback to in-memory for development\n\t\t\ttelnyxLogger.warn(\"Database not available, using in-memory deduplication\");\n\t\t\treturn isWebhookDuplicateInMemory(webhookId);\n\t\t}\n\n\t\tconst { data, error } = await supabase\n\t\t\t.from(\"webhook_dedup_cache\")\n\t\t\t.select(\"id\")\n\t\t\t.eq(\"company_id\", companyId)\n\t\t\t.eq(\"webhook_id\", webhookId)\n\t\t\t.eq(\"source\", source)\n\t\t\t.gt(\"expires_at\", new Date().toISOString())\n\t\t\t.maybeSingle();\n\n\t\tif (error) {\n\t\t\ttelnyxLogger.error(\"Database dedup check failed\", { error: error.message, webhookId });\n\t\t\t// Fail open on database errors to not block webhooks\n\t\t\treturn false;\n\t\t}\n\n\t\treturn data !== null;\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"Deduplication check error\", {\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\twebhookId,\n\t\t});\n\t\t// Fail open on errors\n\t\treturn false;\n\t}\n}\n\n/**\n * Mark a webhook as processed (async, database-backed)\n *\n * @param companyId - The company ID for multi-tenant isolation\n * @param webhookId - The unique webhook ID from Telnyx\n * @param source - The webhook source (default: 'telnyx')\n */\nexport async function markWebhookProcessedAsync(\n\tcompanyId: string,\n\twebhookId: string,\n\tsource = \"telnyx\"\n): Promise<void> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tif (!supabase) {\n\t\t\t// Fallback to in-memory for development\n\t\t\tmarkWebhookProcessedInMemory(webhookId);\n\t\t\treturn;\n\t\t}\n\n\t\tconst expiresAt = new Date(Date.now() + DEDUP_WINDOW_MS).toISOString();\n\n\t\tconst { error } = await supabase.from(\"webhook_dedup_cache\").upsert(\n\t\t\t{\n\t\t\t\tcompany_id: companyId,\n\t\t\t\twebhook_id: webhookId,\n\t\t\t\tsource,\n\t\t\t\tprocessed_at: new Date().toISOString(),\n\t\t\t\texpires_at: expiresAt,\n\t\t\t},\n\t\t\t{\n\t\t\t\tonConflict: \"company_id,webhook_id,source\",\n\t\t\t\tignoreDuplicates: false,\n\t\t\t}\n\t\t);\n\n\t\tif (error) {\n\t\t\ttelnyxLogger.error(\"Failed to mark webhook as processed\", {\n\t\t\t\terror: error.message,\n\t\t\t\twebhookId,\n\t\t\t});\n\t\t}\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"Mark webhook processed error\", {\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\twebhookId,\n\t\t});\n\t}\n}\n\n/**\n * Cleanup expired webhook dedup entries\n * Call this periodically (e.g., via cron job or after processing)\n */\nexport async function cleanupExpiredWebhookDedup(): Promise<number> {\n\ttry {\n\t\tconst supabase = await createServiceSupabaseClient();\n\n\t\tif (!supabase) {\n\t\t\tcleanupProcessedWebhooksInMemory();\n\t\t\treturn 0;\n\t\t}\n\n\t\t// Use the database function for atomic cleanup\n\t\tconst { data, error } = await supabase.rpc(\"cleanup_expired_webhook_dedup\");\n\n\t\tif (error) {\n\t\t\ttelnyxLogger.error(\"Webhook dedup cleanup failed\", { error: error.message });\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst deletedCount = data as number;\n\t\tif (deletedCount > 0) {\n\t\t\ttelnyxLogger.info(`Cleaned up ${deletedCount} expired webhook dedup entries`);\n\t\t}\n\n\t\treturn deletedCount;\n\t} catch (error) {\n\t\ttelnyxLogger.error(\"Webhook dedup cleanup error\", {\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t});\n\t\treturn 0;\n\t}\n}\n\n// =============================================================================\n// IN-MEMORY FALLBACK (Development Only)\n// =============================================================================\n\nfunction isWebhookDuplicateInMemory(webhookId: string): boolean {\n\tcleanupProcessedWebhooksInMemory();\n\treturn processedWebhooksInMemory.has(webhookId);\n}\n\nfunction markWebhookProcessedInMemory(webhookId: string): void {\n\tprocessedWebhooksInMemory.set(webhookId, Date.now());\n}\n\nfunction cleanupProcessedWebhooksInMemory(): void {\n\tconst cutoff = Date.now() - DEDUP_WINDOW_MS;\n\tfor (const [id, timestamp] of processedWebhooksInMemory.entries()) {\n\t\tif (timestamp < cutoff) {\n\t\t\tprocessedWebhooksInMemory.delete(id);\n\t\t}\n\t}\n}\n\n// =============================================================================\n// COMPREHENSIVE WEBHOOK VALIDATION (Async, Multi-Tenant)\n// =============================================================================\n\nexport interface WebhookValidationResult {\n\tvalid: boolean;\n\terror?: string;\n\terrorCode?: TelnyxErrorCode;\n\tpayload?: WebhookPayload;\n\tisDuplicate?: boolean;\n\tcorrelationId: string;\n}\n\n/**\n * Comprehensive webhook validation (async, multi-tenant)\n *\n * Validates:\n * 1. Signature (MANDATORY in production - fail-closed)\n * 2. Timestamp (replay protection)\n * 3. Payload structure\n * 4. Deduplication (database-backed for serverless)\n *\n * @param params.companyId - Required for multi-tenant deduplication\n */\nexport async function validateWebhookAsync(params: {\n\tcompanyId: string;\n\trawPayload: string | Buffer;\n\tsignature: string;\n\ttimestamp: string;\n\tcorrelationId?: string;\n}): Promise<WebhookValidationResult> {\n\tconst correlationId =\n\t\tparams.correlationId ||\n\t\t`wh_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\n\n\ttelnyxLogger.debug(\"Validating webhook\", {\n\t\tcorrelationId,\n\t\tcompanyId: params.companyId,\n\t});\n\n\t// 1. Validate signature (FAIL-CLOSED in production)\n\tconst signatureResult = verifyWebhookSignature({\n\t\tpayload: params.rawPayload,\n\t\tsignature: params.signature,\n\t\ttimestamp: params.timestamp,\n\t\tcorrelationId,\n\t});\n\n\tif (!signatureResult.valid) {\n\t\ttelnyxMetrics.recordWebhook(false);\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: signatureResult.error || \"Invalid signature\",\n\t\t\terrorCode: TelnyxErrorCode.WEBHOOK_SIGNATURE_INVALID,\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// 2. Validate timestamp (replay protection)\n\tconst timestampResult = isWebhookTimestampValid(params.timestamp);\n\tif (!timestampResult.valid) {\n\t\ttelnyxLogger.warn(\"Webhook timestamp validation failed\", {\n\t\t\tcorrelationId,\n\t\t\terror: timestampResult.error,\n\t\t});\n\t\ttelnyxMetrics.recordWebhook(false);\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: timestampResult.error || \"Invalid timestamp\",\n\t\t\terrorCode: TelnyxErrorCode.WEBHOOK_TIMESTAMP_INVALID,\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// 3. Parse payload\n\tconst payload = parseWebhookPayload(params.rawPayload);\n\tif (!payload) {\n\t\ttelnyxLogger.warn(\"Webhook payload parsing failed\", { correlationId });\n\t\ttelnyxMetrics.recordWebhook(false);\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: \"Invalid webhook payload structure\",\n\t\t\terrorCode: TelnyxErrorCode.WEBHOOK_VALIDATION_FAILED,\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// 4. Check for duplicates (database-backed)\n\tconst webhookId = payload.data.id;\n\tif (webhookId) {\n\t\tconst isDuplicate = await isWebhookDuplicateAsync(\n\t\t\tparams.companyId,\n\t\t\twebhookId\n\t\t);\n\n\t\tif (isDuplicate) {\n\t\t\ttelnyxLogger.info(\"Duplicate webhook detected, skipping\", {\n\t\t\t\tcorrelationId,\n\t\t\t\twebhookId,\n\t\t\t\tcompanyId: params.companyId,\n\t\t\t});\n\t\t\ttelnyxMetrics.recordWebhook(true); // Count as processed\n\t\t\treturn {\n\t\t\t\tvalid: true,\n\t\t\t\tpayload,\n\t\t\t\tisDuplicate: true,\n\t\t\t\tcorrelationId,\n\t\t\t};\n\t\t}\n\n\t\t// Mark as processed\n\t\tawait markWebhookProcessedAsync(params.companyId, webhookId);\n\t}\n\n\ttelnyxLogger.info(\"Webhook validated successfully\", {\n\t\tcorrelationId,\n\t\teventType: payload.data.event_type,\n\t\twebhookId,\n\t\tcompanyId: params.companyId,\n\t});\n\n\ttelnyxMetrics.recordWebhook(true);\n\n\treturn {\n\t\tvalid: true,\n\t\tpayload,\n\t\tisDuplicate: false,\n\t\tcorrelationId,\n\t};\n}\n\n// =============================================================================\n// LEGACY SYNC API (Deprecated - use validateWebhookAsync)\n// =============================================================================\n\n/**\n * @deprecated Use validateWebhookAsync for production (supports database dedup)\n * Synchronous validation - only uses in-memory deduplication\n */\nexport function validateWebhook(params: {\n\trawPayload: string | Buffer;\n\tsignature: string;\n\ttimestamp: string;\n\tcorrelationId?: string;\n}): WebhookValidationResult {\n\tconst correlationId =\n\t\tparams.correlationId ||\n\t\t`wh_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\n\n\ttelnyxLogger.warn(\n\t\t\"Using deprecated sync validateWebhook - migrate to validateWebhookAsync\",\n\t\t{ correlationId }\n\t);\n\n\t// 1. Validate signature\n\tconst signatureResult = verifyWebhookSignature({\n\t\tpayload: params.rawPayload,\n\t\tsignature: params.signature,\n\t\ttimestamp: params.timestamp,\n\t\tcorrelationId,\n\t});\n\n\tif (!signatureResult.valid) {\n\t\ttelnyxMetrics.recordWebhook(false);\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: signatureResult.error || \"Invalid signature\",\n\t\t\terrorCode: TelnyxErrorCode.WEBHOOK_SIGNATURE_INVALID,\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// 2. Validate timestamp\n\tconst timestampResult = isWebhookTimestampValid(params.timestamp);\n\tif (!timestampResult.valid) {\n\t\ttelnyxMetrics.recordWebhook(false);\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: timestampResult.error || \"Invalid timestamp\",\n\t\t\terrorCode: TelnyxErrorCode.WEBHOOK_TIMESTAMP_INVALID,\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// 3. Parse payload\n\tconst payload = parseWebhookPayload(params.rawPayload);\n\tif (!payload) {\n\t\ttelnyxMetrics.recordWebhook(false);\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\terror: \"Invalid webhook payload structure\",\n\t\t\terrorCode: TelnyxErrorCode.WEBHOOK_VALIDATION_FAILED,\n\t\t\tcorrelationId,\n\t\t};\n\t}\n\n\t// 4. Check for duplicates (in-memory only - not safe for serverless!)\n\tconst webhookId = payload.data.id;\n\tif (webhookId) {\n\t\tconst isDuplicate = isWebhookDuplicateInMemory(webhookId);\n\t\tif (isDuplicate) {\n\t\t\ttelnyxMetrics.recordWebhook(true);\n\t\t\treturn {\n\t\t\t\tvalid: true,\n\t\t\t\tpayload,\n\t\t\t\tisDuplicate: true,\n\t\t\t\tcorrelationId,\n\t\t\t};\n\t\t}\n\t\tmarkWebhookProcessedInMemory(webhookId);\n\t}\n\n\ttelnyxMetrics.recordWebhook(true);\n\n\treturn {\n\t\tvalid: true,\n\t\tpayload,\n\t\tisDuplicate: false,\n\t\tcorrelationId,\n\t};\n}\n\n// =============================================================================\n// LEGACY EXPORTS (For backwards compatibility)\n// =============================================================================\n\n/** @deprecated Use isWebhookDuplicateAsync */\nexport function isWebhookDuplicate(webhookId: string): boolean {\n\treturn isWebhookDuplicateInMemory(webhookId);\n}\n\n/** @deprecated Use markWebhookProcessedAsync */\nexport function markWebhookProcessed(webhookId: string): void {\n\tmarkWebhookProcessedInMemory(webhookId);\n}\n\n/** @deprecated Internal use only */\nexport function clearProcessedWebhooks(): void {\n\tprocessedWebhooksInMemory.clear();\n}\n\n/** Get deduplication stats (in-memory only) */\nexport function getDeduplicationStats(): {\n\ttrackedWebhooks: number;\n\toldestTimestamp: number | null;\n} {\n\tcleanupProcessedWebhooksInMemory();\n\n\tlet oldestTimestamp: number | null = null;\n\tfor (const timestamp of processedWebhooksInMemory.values()) {\n\t\tif (oldestTimestamp === null || timestamp < oldestTimestamp) {\n\t\t\toldestTimestamp = timestamp;\n\t\t}\n\t}\n\n\treturn {\n\t\ttrackedWebhooks: processedWebhooksInMemory.size,\n\t\toldestTimestamp,\n\t};\n}\n"],"names":["process","env","NEXT_RUNTIME","module","exports","require","__NEXT_EXPERIMENTAL_REACT","NODE_ENV","TURBOPACK","vendored","React","ReflectAdapter","get","target","prop","receiver","value","Reflect","bind","set","has","deleteProperty","isRequestAPICallableInsideAfter","throwForSearchParamsAccessInUseCache","throwWithStaticGenerationBailoutErrorWithDynamicError","route","expression","StaticGenBailoutError","workStore","constructorOpt","error","Error","captureStackTrace","invalidDynamicUsageError","afterTaskStore","afterTaskAsyncStorage","getStore","rootTaskSpawnPhase","ReactServerDOMTurbopackServer","registerServerReference","ensureServerEntryExports","actions","i","length","action"],"mappings":"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","ignoreList":[0,1,2,3,4,5,6,7]}