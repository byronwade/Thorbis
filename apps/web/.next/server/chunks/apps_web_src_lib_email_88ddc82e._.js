module.exports=[795824,e=>{"use strict";var t=e.i(471312),r=e.i(273568);async function a(e){let t=await (0,r.createServiceSupabaseClient)(),{error:a}=await t.rpc("update_domain_reputation",{p_domain_id:e.domainId,p_event_type:e.eventType});return a?(console.error("Error recording delivery event:",a),{success:!1,error:a.message}):{success:!0}}async function n(e){let t=await (0,r.createServiceSupabaseClient)(),n={"email.delivered":"delivered","email.bounced":"bounced","email.complained":"complained","email.opened":"opened","email.clicked":"clicked","email.delivery_delayed":"soft_bounce"}[e.type];if(!n)return{success:!0};let s=e.data.from;if(!s)return{success:!0};let o=s.includes("@")?s.split("@")[1]:s,{data:i}=await t.from("company_email_domains").select("id").eq("domain_name",o).maybeSingle();return i?a({domainId:i.id,eventType:n,emailId:e.data.email_id,metadata:e.data}):{success:!0}}async function s(e){let t=await (0,r.createServiceSupabaseClient)(),{data:a,error:n}=await t.from("company_email_domains").select("id, domain_name, reputation_score, bounce_rate, total_emails_sent, hard_bounces, soft_bounces, spam_complaints, is_suspended, last_health_check").eq("id",e).single();if(n||!a)return null;let s=a.total_emails_sent+a.hard_bounces+a.soft_bounces,o=s>0?(a.hard_bounces+a.soft_bounces)/s*100:0,i=a.total_emails_sent>0?a.spam_complaints/a.total_emails_sent*100:0,c=s>0?a.total_emails_sent/s*100:100,l="healthy";return a.is_suspended?l="suspended":a.reputation_score<30||o>10||i>.5?l="critical":(a.reputation_score<60||o>5||i>.2)&&(l="warning"),{domainId:a.id,domain:a.domain_name,reputationScore:Number(a.reputation_score),bounceRate:Number(o.toFixed(2)),complaintRate:Number(i.toFixed(3)),deliveryRate:Number(c.toFixed(2)),status:l,totalEmailsSent:a.total_emails_sent,hardBounces:a.hard_bounces,softBounces:a.soft_bounces,complaints:a.spam_complaints,lastHealthCheck:a.last_health_check}}async function o(e){let t=await (0,r.createServiceSupabaseClient)(),{data:a,error:n}=await t.from("company_email_domains").select("id, domain_name, reputation_score, bounce_rate, total_emails_sent, hard_bounces, soft_bounces, spam_complaints, is_suspended, last_health_check").eq("company_id",e);return n||!a?[]:a.map(e=>{let t=e.total_emails_sent+e.hard_bounces+e.soft_bounces,r=t>0?(e.hard_bounces+e.soft_bounces)/t*100:0,a=e.total_emails_sent>0?e.spam_complaints/e.total_emails_sent*100:0,n=t>0?e.total_emails_sent/t*100:100,s="healthy";return e.is_suspended?s="suspended":e.reputation_score<30||r>10||a>.5?s="critical":(e.reputation_score<60||r>5||a>.2)&&(s="warning"),{domainId:e.id,domain:e.domain_name,reputationScore:Number(e.reputation_score),bounceRate:Number(r.toFixed(2)),complaintRate:Number(a.toFixed(3)),deliveryRate:Number(n.toFixed(2)),status:s,totalEmailsSent:e.total_emails_sent,hardBounces:e.hard_bounces,softBounces:e.soft_bounces,complaints:e.spam_complaints,lastHealthCheck:e.last_health_check}})}async function i(){let e=await (0,r.createServiceSupabaseClient)(),{data:t}=await e.from("company_email_domains").select("id, reputation_score, hard_bounces, soft_bounces, spam_complaints, total_emails_sent").eq("is_suspended",!1);if(!t)return{checked:0,suspended:0,warnings:0};let a=0,n=0;for(let r of t){let t=r.total_emails_sent+r.hard_bounces+r.soft_bounces,s=t>100?(r.hard_bounces+r.soft_bounces)/t*100:0,o=r.total_emails_sent>100?r.spam_complaints/r.total_emails_sent*100:0;r.reputation_score<20||s>15||o>1?(await e.from("company_email_domains").update({is_suspended:!0,suspension_reason:`Auto-suspended: Reputation ${r.reputation_score}, Bounce rate ${s.toFixed(1)}%, Complaint rate ${o.toFixed(2)}%`,suspended_at:new Date().toISOString(),last_health_check:new Date().toISOString()}).eq("id",r.id),a++):r.reputation_score<50||s>8||o>.3?(await e.from("company_email_domains").update({last_health_check:new Date().toISOString()}).eq("id",r.id),n++):await e.from("company_email_domains").update({last_health_check:new Date().toISOString()}).eq("id",r.id)}return{checked:t.length,suspended:a,warnings:n}}async function c(e){let t=await s(e);if(!t)return null;let r=[];return t.bounceRate>5&&r.push("High bounce rate detected. Clean your email list and remove invalid addresses."),t.complaintRate>.1&&r.push("Spam complaints detected. Ensure recipients have opted in and make unsubscribe easy."),t.reputationScore<70&&r.push("Reputation score is below optimal. Reduce sending volume temporarily and focus on engagement."),("warning"===t.status||"critical"===t.status)&&r.push("Domain health is degraded. Review your email content and sending practices."),0===r.length&&r.push("Domain health is good. Continue monitoring and maintain current practices."),{domain:t.domain,period:{start:new Date(Date.now()-2592e6).toISOString(),end:new Date().toISOString()},metrics:{totalSent:t.totalEmailsSent,delivered:t.totalEmailsSent-t.hardBounces,bounced:t.hardBounces+t.softBounces,complained:t.complaints,deliveryRate:t.deliveryRate,bounceRate:t.bounceRate,complaintRate:t.complaintRate},reputation:{current:t.reputationScore,change:0,status:t.status},recommendations:r}}(0,e.i(798348).ensureServerEntryExports)([a,n,s,o,i,c]),(0,t.registerServerReference)(a,"404d6f2891af89c71d5bde33d110a216bdd3ee4729",null),(0,t.registerServerReference)(n,"40ad037af6f6ab1a3004746d3a1b65afa65527002d",null),(0,t.registerServerReference)(s,"400b8fb96146bfd004a3166563a5ab5536bb610c70",null),(0,t.registerServerReference)(o,"405c57a8fed352b8679525b56014eb8c49105c850c",null),(0,t.registerServerReference)(i,"00c53a1f02416c3261983f8096f19a3450bfd51775",null),(0,t.registerServerReference)(c,"40ecf2c792e84ef4b898fda98ec27277b4a9dddef2",null),e.s(["processResendWebhookEvent",()=>n,"recordDeliveryEvent",()=>a])},129236,e=>{"use strict";var t=e.i(666680);let r={apiKey:process.env.POSTMARK_API_KEY||"",webhookSecret:process.env.POSTMARK_WEBHOOK_SECRET||"",from:process.env.POSTMARK_FROM_EMAIL||process.env.EMAIL_FROM||"notifications@stratos.app",isConfigured:!!process.env.POSTMARK_API_KEY,providerName:"postmark"};async function a(e,t){if(!r.apiKey)return{success:!1,error:"Postmark API key is not configured. Set POSTMARK_API_KEY environment variable."};try{let a=await fetch(`https://api.postmarkapp.com${e}`,{...t,headers:{"X-Postmark-Server-Token":r.apiKey,"Content-Type":"application/json",Accept:"application/json",...t.headers}}),n=await a.json().catch(()=>({}));if(!a.ok)return{success:!1,error:n.Message||n.message||a.statusText,errorCode:n.ErrorCode};return{success:!0,data:n}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Postmark request failed"}}}async function n(e){let{to:t,subject:n,html:s,text:o,from:i=r.from,replyTo:c,tag:l,trackOpens:d=!0,trackLinks:u=!0,metadata:m,messageStream:p="outbound"}=e,_=Array.isArray(t)?t.join(", "):t,f=await a("/email",{method:"POST",body:JSON.stringify({From:i,To:_,Subject:n,HtmlBody:s,TextBody:o,ReplyTo:c,Tag:l,TrackOpens:d,TrackLinks:u?"HtmlAndText":"None",MessageStream:p,Metadata:m})});return f.success||console.error(`[Postmark] Email send failed: ${f.error}`),f}async function s(){return a("/server",{method:"GET"})}function o(e){let{token:a}=e;if(!r.webhookSecret)return console.warn("[Postmark] No webhook secret configured - accepting webhook without verification"),!0;if(!a)return console.error("[Postmark] Webhook missing token"),!1;try{let e=Buffer.from(r.webhookSecret),n=Buffer.from(a);if(e.length!==n.length)return!1;return t.default.timingSafeEqual(e,n)}catch{return!1}}async function i(){let e=Date.now();try{let t=await s(),r=Date.now()-e;if(t.success)return{healthy:!0,provider:"postmark",latencyMs:r};return console.error(`[Postmark] Health check failed: ${t.error}`),{healthy:!1,provider:"postmark",latencyMs:r,error:t.error}}catch(a){let t=Date.now()-e,r=a instanceof Error?a.message:"Unknown error";return console.error(`[Postmark] Health check error: ${r}`),{healthy:!1,provider:"postmark",latencyMs:t,error:r}}}function c(){return r.isConfigured}e.s(["checkPostmarkHealth",()=>i,"isPostmarkConfigured",()=>c,"postmarkConfig",0,r,"sendPostmarkEmail",()=>n,"verifyPostmarkWebhook",()=>o])},63714,e=>{"use strict";var t=e.i(471312),r=e.i(273568);async function a(e){try{let t=await (0,r.createServiceSupabaseClient)();e.eventType.includes("success");let{error:a}=await t.from("email_provider_events").insert({provider:e.provider,event_type:e.eventType,message_id:e.messageId||null,latency_ms:e.latencyMs||null,error_message:e.error||null,metadata:e.metadata||null,company_id:e.companyId||null,domain_id:e.domainId||null,created_at:new Date().toISOString()});if(a)return console.error(`[ProviderMonitor] Failed to record event: ${a.message}`),{success:!1,error:a.message};return{success:!0}}catch(e){return console.error(`[ProviderMonitor] Error recording event: ${e instanceof Error?e.message:"Unknown error"}`),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function n(e,t,r,n){await a({provider:e,eventType:"send_success",messageId:t,latencyMs:r,...n})}async function s(e,t,r,n){await a({provider:e,eventType:"send_failure",error:t,latencyMs:r,...n})}async function o(e,t,r,n){await a({provider:e,eventType:"fallback_triggered",error:r,metadata:{fallback_provider:t,...n?.metadata},...n})}async function i(e,t="24h"){try{let a=await (0,r.createServiceSupabaseClient)(),n=new Date,s=new Date(n.getTime()-({"1h":36e5,"24h":864e5,"7d":6048e5,"30d":2592e6})[t]).toISOString(),{data:o,error:i}=await a.from("email_provider_events").select("event_type, latency_ms, error_message, created_at").eq("provider",e).gte("created_at",s).order("created_at",{ascending:!1});if(i)return console.error(`[ProviderMonitor] Failed to get stats: ${i.message}`),null;if(!o||0===o.length)return{provider:e,period:t,totalEvents:0,successCount:0,failureCount:0,successRate:0,averageLatencyMs:0,p95LatencyMs:0,fallbackCount:0,lastEventAt:null,lastError:null};let c=o.filter(e=>"send_success"===e.event_type||"send_failure"===e.event_type),l=o.filter(e=>"send_success"===e.event_type),d=o.filter(e=>"send_failure"===e.event_type),u=o.filter(e=>"fallback_triggered"===e.event_type),m=l.map(e=>e.latency_ms).filter(e=>null!==e).sort((e,t)=>e-t),p=m.length>0?m.reduce((e,t)=>e+t,0)/m.length:0,_=Math.floor(.95*m.length),f=m.length>0?m[_]||m[m.length-1]:0,h=d[0];return{provider:e,period:t,totalEvents:o.length,successCount:l.length,failureCount:d.length,successRate:c.length>0?l.length/c.length*100:0,averageLatencyMs:Math.round(p),p95LatencyMs:Math.round(f),fallbackCount:u.length,lastEventAt:o[0]?new Date(o[0].created_at):null,lastError:h?.error_message||null}}catch(e){return console.error(`[ProviderMonitor] Error getting stats: ${e instanceof Error?e.message:"Unknown error"}`),null}}async function c(){let e,[t,r]=await Promise.all([i("resend","24h"),i("postmark","24h")]),a=e=>e&&0!==e.totalEvents?e.successRate>=99?"healthy":e.successRate>=95?"degraded":"down":"unknown",n=(t?.fallbackCount||0)+(r?.fallbackCount||0),s=(t?.successCount||0)+(t?.failureCount||0)+(r?.successCount||0)+(r?.failureCount||0),o=s>0?n/s*100:0,c=a(t),l=a(r);return"down"===c&&"down"===l?e="CRITICAL: Both providers are down. Check API keys and provider status.":"down"===c?e="Primary provider (Resend) is down. Traffic is using fallback.":o>10?e="High fallback rate detected. Review primary provider health.":"degraded"===c&&(e="Primary provider showing degraded performance. Monitor closely."),{resend:{status:c,successRate24h:t?.successRate||0,avgLatencyMs:t?.averageLatencyMs||0,totalSent24h:t?.successCount||0,lastError:t?.lastError||void 0,lastSuccessAt:t?.lastEventAt||void 0},postmark:{status:l,successRate24h:r?.successRate||0,avgLatencyMs:r?.averageLatencyMs||0,totalSent24h:r?.successCount||0,lastError:r?.lastError||void 0,lastSuccessAt:r?.lastEventAt||void 0},overall:{primaryProvider:"resend",fallbackProvider:"postmark",fallbackRate24h:o,recommendedAction:e}}}async function l(e=30){try{let t=await (0,r.createServiceSupabaseClient)(),a=new Date;a.setDate(a.getDate()-e);let{data:n,error:s}=await t.from("email_provider_events").delete().lt("created_at",a.toISOString()).select("id");if(s)return console.error(`[ProviderMonitor] Cleanup failed: ${s.message}`),{deleted:0,error:s.message};return{deleted:n?.length||0}}catch(t){let e=t instanceof Error?t.message:"Unknown error";return console.error(`[ProviderMonitor] Cleanup error: ${e}`),{deleted:0,error:e}}}async function d(e){let t=await i(e,"1h");return t&&0!==t.totalEvents?t.successRate<90?{shouldAlert:!0,severity:"critical",reason:`${e} success rate is ${t.successRate.toFixed(1)}% (below 90%)`}:t.successRate<99?{shouldAlert:!0,severity:"warning",reason:`${e} success rate is ${t.successRate.toFixed(1)}% (below 99%)`}:t.averageLatencyMs>5e3?{shouldAlert:!0,severity:"warning",reason:`${e} average latency is ${t.averageLatencyMs}ms (above 5s)`}:{shouldAlert:!1,severity:"info"}:{shouldAlert:!1,severity:"info"}}(0,e.i(798348).ensureServerEntryExports)([a,n,s,o,i,c,l,d]),(0,t.registerServerReference)(a,"40e06418f4b93b40c84a25511e0468e1e8a41ddecf",null),(0,t.registerServerReference)(n,"783861d25688b32ba086bbe9e45444975c36a1b285",null),(0,t.registerServerReference)(s,"78255c3fa8c9facf7c3f353202f2907836e8eb5539",null),(0,t.registerServerReference)(o,"78766431b437b16f7cb00b4d64a2f3be5e092ed724",null),(0,t.registerServerReference)(i,"60c643a41ce1a8e6cc8338da6e2f3678c386910460",null),(0,t.registerServerReference)(c,"00a122f9d5fe3a1603c636c3a251886129b66154f8",null),(0,t.registerServerReference)(l,"40d3c4ceeaee653aa257a28ed429a7fd272fa9fb66",null),(0,t.registerServerReference)(d,"40c7885bdc4fe4cdd5f57e78579230c58088adbef4",null),e.s(["recordFallbackTriggered",()=>o,"recordProviderEvent",()=>a,"recordSendFailure",()=>s,"recordSendSuccess",()=>n])}];

//# sourceMappingURL=apps_web_src_lib_email_88ddc82e._.js.map