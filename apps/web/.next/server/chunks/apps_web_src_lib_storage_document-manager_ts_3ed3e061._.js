module.exports=[423922,537721,e=>{"use strict";var t=e.i(666680),a=e.i(511368);let i=[".exe",".bat",".cmd",".com",".scr",".pif",".application",".gadget",".msi",".msp",".msc",".vbs",".vbe",".js",".jse",".ws",".wsf",".wsc",".wsh",".ps1",".ps1xml",".ps2",".ps2xml",".psc1",".psc2",".msh",".msh1",".msh2",".mshxml",".msh1xml",".msh2xml",".app",".dmg",".pkg",".mpkg",".command",".sh",".bash",".zsh",".fish",".ksh",".csh",".run",".bin",".deb",".rpm",".snap",".jar",".war",".ear",".dll",".sys",".drv",".cpl",".inf",".ins",".isp",".lnk",".mde",".mdt",".mdw",".mdz",".ops",".pcd",".prg",".reg",".scf",".sct",".shb",".shs",".url",".ade",".adp",".mdb",".accdb",".ace",".arj",".cab"],s={avatar:5242880,image:0x1400000,document:0x6400000,video:262144e3,general:262144e3,invoice:0x1400000,estimate:0x1400000,contract:0x3200000},r={image:["image/jpeg","image/png","image/gif","image/webp","image/svg+xml","image/bmp","image/tiff","image/heic","image/heif"],document:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.oasis.opendocument.text","application/vnd.oasis.opendocument.spreadsheet","application/vnd.oasis.opendocument.presentation","text/plain","text/csv","application/rtf"],video:["video/mp4","video/mpeg","video/quicktime","video/x-msvideo","video/webm","video/x-matroska"],audio:["audio/mpeg","audio/mp4","audio/wav","audio/webm","audio/ogg","audio/flac"],archive:["application/zip","application/x-rar-compressed","application/x-7z-compressed","application/x-tar","application/gzip"],cad:["application/acad","application/x-acad","application/autocad_dwg","image/vnd.dwg","image/vnd.dxf"]},n={"image/jpeg":[{bytes:[255,216,255],offset:0}],"image/png":[{bytes:[137,80,78,71],offset:0}],"image/gif":[{bytes:[71,73,70,56],offset:0}],"image/webp":[{bytes:[82,73,70,70],offset:0}],"application/pdf":[{bytes:[37,80,68,70],offset:0}],"application/zip":[{bytes:[80,75,3,4],offset:0}],"video/mp4":[{bytes:[102,116,121,112],offset:4}]};async function o(e,t={}){var a,i;let n,m,f,g,{context:h="general",maxSize:y,allowedMimeTypes:v,checkMagicNumbers:w=!0,strictMode:b=!1}=t,_=[],x=[];if(!(e&&e instanceof File))return _.push("Invalid file object"),{valid:!1,errors:_,warnings:x};if(!e.name||""===e.name.trim())return _.push("File must have a name"),{valid:!1,errors:_,warnings:x};let F=p(e.name);F!==e.name&&x.push("Filename was sanitized for security");let $=l(e.name).toLowerCase();if(c($))return _.push(`File type "${$}" is not allowed for security reasons`),{valid:!1,errors:_,warnings:x};let z=y??s[h];e.size>z&&_.push(`File size (${u(e.size)}) exceeds maximum allowed size (${u(z)})`),0===e.size&&_.push("File is empty"),v&&v.length>0&&!v.includes(e.type)&&_.push(`File type "${e.type}" is not allowed. Allowed types: ${v.join(", ")}`);let j=function(e){for(let[t,a]of Object.entries(r))if(a.includes(e))return t;return e.startsWith("image/")?"image":e.startsWith("video/")?"video":e.startsWith("audio/")?"audio":e.startsWith("text/")?"document":void 0}(e.type);if(w&&e.size>0)try{(g=await d(e)??void 0)&&g!==e.type&&(b?_.push(`File signature mismatch. Claimed: "${e.type}", Detected: "${g}"`):x.push(`File type mismatch detected. Using detected type: ${g}`))}catch(e){x.push("Could not verify file signature")}let U=(a=e,n=[],m=[],(f=(i=F).split(".")).length>2&&c(`.${f.at(-2)}`)&&n.push("File has suspicious double extension that could hide malicious content"),i.length>255&&n.push("Filename is too long"),a.name.includes("\0")&&n.push("Filename contains null bytes"),a.type&&"application/octet-stream"!==a.type||m.push("File type could not be determined. Upload may be rejected."),{errors:n,warnings:m});return _.push(...U.errors),x.push(...U.warnings),{valid:0===_.length,errors:_,warnings:x,metadata:{sanitizedName:F,detectedMimeType:g,category:j}}}function c(e){let t=e.toLowerCase();return i.includes(t)}function l(e){let t=e.lastIndexOf(".");return -1===t||t===e.length-1?"":e.substring(t)}function p(e){let t=l(e),a=e.substring(0,e.length-t.length).replace(/\.\./g,"");return(a=a.replace(/[<>:"|?*]/g,"").replace(/[\x00-\x1F\x80-\x9F]/g,"").replace(/^\.+/,"").replace(/\s+/g,"-").replace(/--+/g,"-").replace(/^-|-$/g,"")).length>200&&(a=a.substring(0,200)),a||(a=`file-${Date.now()}`),a+t.toLowerCase()}async function d(e){let t=e.slice(0,8192),a=new Uint8Array(await t.arrayBuffer());for(let[e,t]of Object.entries(n))for(let i of t)if(i.bytes.every((e,t)=>a[i.offset+t]===e))return e;return null}function u(e){if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return`${Number.parseFloat((e/1024**t).toFixed(2))} ${["Bytes","KB","MB","GB","TB"][t]}`}async function m(e){let a=await e.arrayBuffer();return Array.from(new Uint8Array(await t.default.subtle.digest("SHA-256",a))).map(e=>e.toString(16).padStart(2,"0")).join("")}async function f(e,t){try{var i,s,r,n;let c,l,d,u,f,g,y=await o(e,t.validationOptions);if(!y.valid)return{success:!1,error:y.errors.join("; "),warnings:y.warnings};let v=await (0,a.createClient)();if(!v)return{success:!1,error:"Supabase client not available"};let{data:{user:w},error:b}=await v.auth.getUser();if(b||!w)return{success:!1,error:"User not authenticated"};let{data:_}=await v.from("company_memberships").select("id, role").eq("user_id",w.id).eq("company_id",t.companyId).eq("status","active").single();if(!_)return{success:!1,error:"User does not have access to this company"};let x=function(e,t){if(t)return t;switch(e.type){case"customer":return"customer-documents";case"job":return"job-photos";case"invoice":return"invoices";case"estimate":return"estimates";case"contract":return"contracts";default:return"company-files"}}(t.context,t.bucket),F=(i=t.companyId,s=t.context,r=y.metadata?.sanitizedName||e.name,c=p(r),l=Date.now(),d=Math.random().toString(36).substring(2,8),u=`${l}-${d}-${c}`,f=[i],"general"!==s.type?f.push(`${s.type}s`):f.push("general"),s.id&&f.push(s.id),s.folder&&f.push(s.folder),f.push(u),f.join("/")),{data:$,error:z}=await v.storage.from(x).upload(F,e,{cacheControl:"3600",upsert:!1});if(z)return{success:!1,error:`Storage upload failed: ${z.message}`};let{data:{publicUrl:j}}=v.storage.from(x).getPublicUrl($.path),U=await m(e),k=(n=t.context,g=[],"general"===n.type?g.push("general"):g.push(`${n.type}s`),n.id&&g.push(n.id),n.folder&&g.push(n.folder),`/${g.join("/")}`),{data:C,error:q}=await v.from("attachments").insert({company_id:t.companyId,entity_type:t.context.type,entity_id:t.context.id,file_name:y.metadata?.sanitizedName||e.name,original_file_name:e.name,file_size:e.size,mime_type:y.metadata?.detectedMimeType||e.type,storage_provider:"supabase",storage_url:j,storage_path:$.path,storage_bucket:x,folder_path:k,checksum:U,is_image:e.type.startsWith("image/"),is_document:e.type.includes("pdf")||e.type.includes("document"),is_video:e.type.startsWith("video/"),is_public:t.isPublic??!1,is_internal:t.isInternal??!1,description:t.description,tags:t.tags||[],expiry_date:t.expiryDate,uploaded_by:w.id,virus_scan_status:"pending"}).select().single();if(q)return await v.storage.from(x).remove([$.path]),{success:!1,error:`Database tracking failed: ${q.message}`};return h(C.id,x,$.path).catch(console.error),{success:!0,attachmentId:C.id,storageUrl:j,storagePath:$.path,publicUrl:j,warnings:y.warnings}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Upload failed"}}}async function g(e,t=3600){try{let i=await (0,a.createClient)();if(!i)return{error:"Supabase client not available"};let{data:s,error:r}=await i.from("attachments").select("storage_bucket, storage_path, company_id, virus_scan_status").eq("id",e).single();if(r||!s)return{error:"File not found"};let{data:{user:n}}=await i.auth.getUser();if(!n)return{error:"User not authenticated"};let{data:o}=await i.from("company_memberships").select("id").eq("user_id",n.id).eq("company_id",s.company_id).eq("status","active").single();if(!o)return{error:"Access denied"};if("infected"===s.virus_scan_status)return{error:"File failed security scan and cannot be downloaded"};let{data:c,error:l}=await i.storage.from(s.storage_bucket).createSignedUrl(s.storage_path,t);if(l)return{error:l.message};return await i.rpc("track_file_download",{p_attachment_id:e}),{url:c.signedUrl}}catch(e){return{error:e instanceof Error?e.message:"Failed to generate download URL"}}}async function h(e,t,i){try{let s=await (0,a.createClient)();if(!s)return;await s.functions.invoke("virus-scan",{body:{attachmentId:e,bucket:t,path:i}})}catch(e){}}e.s(["sanitizeFileName",()=>p,"validateFile",()=>o],537721),e.s(["getDownloadUrl",()=>g,"uploadDocument",()=>f],423922)}];

//# sourceMappingURL=apps_web_src_lib_storage_document-manager_ts_3ed3e061._.js.map