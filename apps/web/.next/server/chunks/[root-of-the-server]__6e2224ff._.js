module.exports=[918622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},193695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},666680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},664598,(e,t,r)=>{"use strict";t.exports=e.r(918622)},849614,(e,t,r)=>{"use strict";t.exports=e.r(664598).vendored["react-rsc"].React},848347,(e,t,r)=>{"use strict";var a=Object.defineProperty,s=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,n=Object.prototype.hasOwnProperty,o={},l={RequestCookies:()=>f,ResponseCookies:()=>g,parseCookie:()=>d,parseSetCookie:()=>p,stringifyCookie:()=>u};for(var c in l)a(o,c,{get:l[c],enumerable:!0});function u(e){var t;let r=["path"in e&&e.path&&`Path=${e.path}`,"expires"in e&&(e.expires||0===e.expires)&&`Expires=${("number"==typeof e.expires?new Date(e.expires):e.expires).toUTCString()}`,"maxAge"in e&&"number"==typeof e.maxAge&&`Max-Age=${e.maxAge}`,"domain"in e&&e.domain&&`Domain=${e.domain}`,"secure"in e&&e.secure&&"Secure","httpOnly"in e&&e.httpOnly&&"HttpOnly","sameSite"in e&&e.sameSite&&`SameSite=${e.sameSite}`,"partitioned"in e&&e.partitioned&&"Partitioned","priority"in e&&e.priority&&`Priority=${e.priority}`].filter(Boolean),a=`${e.name}=${encodeURIComponent(null!=(t=e.value)?t:"")}`;return 0===r.length?a:`${a}; ${r.join("; ")}`}function d(e){let t=new Map;for(let r of e.split(/; */)){if(!r)continue;let e=r.indexOf("=");if(-1===e){t.set(r,"true");continue}let[a,s]=[r.slice(0,e),r.slice(e+1)];try{t.set(a,decodeURIComponent(null!=s?s:"true"))}catch{}}return t}function p(e){if(!e)return;let[[t,r],...a]=d(e),{domain:s,expires:i,httponly:n,maxage:o,path:l,samesite:c,secure:u,partitioned:p,priority:f}=Object.fromEntries(a.map(([e,t])=>[e.toLowerCase().replace(/-/g,""),t]));{var g,y,v={name:t,value:decodeURIComponent(r),domain:s,...i&&{expires:new Date(i)},...n&&{httpOnly:!0},..."string"==typeof o&&{maxAge:Number(o)},path:l,...c&&{sameSite:m.includes(g=(g=c).toLowerCase())?g:void 0},...u&&{secure:!0},...f&&{priority:h.includes(y=(y=f).toLowerCase())?y:void 0},...p&&{partitioned:!0}};let e={};for(let t in v)v[t]&&(e[t]=v[t]);return e}}t.exports=((e,t,r,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of i(t))n.call(e,r)||void 0===r||a(e,r,{get:()=>t[r],enumerable:!(o=s(t,r))||o.enumerable});return e})(a({},"__esModule",{value:!0}),o);var m=["strict","lax","none"],h=["low","medium","high"],f=class{constructor(e){this._parsed=new Map,this._headers=e;const t=e.get("cookie");if(t)for(const[e,r]of d(t))this._parsed.set(e,{name:e,value:r})}[Symbol.iterator](){return this._parsed[Symbol.iterator]()}get size(){return this._parsed.size}get(...e){let t="string"==typeof e[0]?e[0]:e[0].name;return this._parsed.get(t)}getAll(...e){var t;let r=Array.from(this._parsed);if(!e.length)return r.map(([e,t])=>t);let a="string"==typeof e[0]?e[0]:null==(t=e[0])?void 0:t.name;return r.filter(([e])=>e===a).map(([e,t])=>t)}has(e){return this._parsed.has(e)}set(...e){let[t,r]=1===e.length?[e[0].name,e[0].value]:e,a=this._parsed;return a.set(t,{name:t,value:r}),this._headers.set("cookie",Array.from(a).map(([e,t])=>u(t)).join("; ")),this}delete(e){let t=this._parsed,r=Array.isArray(e)?e.map(e=>t.delete(e)):t.delete(e);return this._headers.set("cookie",Array.from(t).map(([e,t])=>u(t)).join("; ")),r}clear(){return this.delete(Array.from(this._parsed.keys())),this}[Symbol.for("edge-runtime.inspect.custom")](){return`RequestCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`}toString(){return[...this._parsed.values()].map(e=>`${e.name}=${encodeURIComponent(e.value)}`).join("; ")}},g=class{constructor(e){var t,r,a;this._parsed=new Map,this._headers=e;const s=null!=(a=null!=(r=null==(t=e.getSetCookie)?void 0:t.call(e))?r:e.get("set-cookie"))?a:[];for(const e of Array.isArray(s)?s:function(e){if(!e)return[];var t,r,a,s,i,n=[],o=0;function l(){for(;o<e.length&&/\s/.test(e.charAt(o));)o+=1;return o<e.length}for(;o<e.length;){for(t=o,i=!1;l();)if(","===(r=e.charAt(o))){for(a=o,o+=1,l(),s=o;o<e.length&&"="!==(r=e.charAt(o))&&";"!==r&&","!==r;)o+=1;o<e.length&&"="===e.charAt(o)?(i=!0,o=s,n.push(e.substring(t,a)),t=o):o=a+1}else o+=1;(!i||o>=e.length)&&n.push(e.substring(t,e.length))}return n}(s)){const t=p(e);t&&this._parsed.set(t.name,t)}}get(...e){let t="string"==typeof e[0]?e[0]:e[0].name;return this._parsed.get(t)}getAll(...e){var t;let r=Array.from(this._parsed.values());if(!e.length)return r;let a="string"==typeof e[0]?e[0]:null==(t=e[0])?void 0:t.name;return r.filter(e=>e.name===a)}has(e){return this._parsed.has(e)}set(...e){let[t,r,a]=1===e.length?[e[0].name,e[0].value,e[0]]:e,s=this._parsed;return s.set(t,function(e={name:"",value:""}){return"number"==typeof e.expires&&(e.expires=new Date(e.expires)),e.maxAge&&(e.expires=new Date(Date.now()+1e3*e.maxAge)),(null===e.path||void 0===e.path)&&(e.path="/"),e}({name:t,value:r,...a})),function(e,t){for(let[,r]of(t.delete("set-cookie"),e)){let e=u(r);t.append("set-cookie",e)}}(s,this._headers),this}delete(...e){let[t,r]="string"==typeof e[0]?[e[0]]:[e[0].name,e[0]];return this.set({...r,name:t,value:"",expires:new Date(0)})}[Symbol.for("edge-runtime.inspect.custom")](){return`ResponseCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`}toString(){return[...this._parsed.values()].map(u).join("; ")}}},335014,(e,t,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"ReflectAdapter",{enumerable:!0,get:function(){return a}});class a{static get(e,t,r){let a=Reflect.get(e,t,r);return"function"==typeof a?a.bind(e):a}static set(e,t,r,a){return Reflect.set(e,t,r,a)}static has(e,t){return Reflect.has(e,t)}static deleteProperty(e,t){return Reflect.deleteProperty(e,t)}}},52773,(e,t,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a={isRequestAPICallableInsideAfter:function(){return c},throwForSearchParamsAccessInUseCache:function(){return l},throwWithStaticGenerationBailoutErrorWithDynamicError:function(){return o}};for(var s in a)Object.defineProperty(r,s,{enumerable:!0,get:a[s]});let i=e.r(797518),n=e.r(324725);function o(e,t){throw Object.defineProperty(new i.StaticGenBailoutError(`Route ${e} with \`dynamic = "error"\` couldn't be rendered statically because it used ${t}. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`),"__NEXT_ERROR_CODE",{value:"E543",enumerable:!1,configurable:!0})}function l(e,t){let r=Object.defineProperty(Error(`Route ${e.route} used \`searchParams\` inside "use cache". Accessing dynamic request data inside a cache scope is not supported. If you need some search params inside a cached function await \`searchParams\` outside of the cached function and pass only the required search params as arguments to the cached function. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`),"__NEXT_ERROR_CODE",{value:"E842",enumerable:!1,configurable:!0});throw Error.captureStackTrace(r,t),e.invalidDynamicUsageError??=r,r}function c(){let e=n.afterTaskAsyncStorage.getStore();return(null==e?void 0:e.rootTaskSpawnPhase)==="action"}},479404,(e,t,r)=>{"use strict";t.exports=e.r(664598).vendored["react-rsc"].ReactServerDOMTurbopackServer},471312,(e,t,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"registerServerReference",{enumerable:!0,get:function(){return a.registerServerReference}});let a=e.r(479404)},798348,(e,t,r)=>{"use strict";function a(e){for(let t=0;t<e.length;t++){let r=e[t];if("function"!=typeof r)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof r}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"ensureServerEntryExports",{enumerable:!0,get:function(){return a}})},273568,e=>{"use strict";var t=e.i(471312),r=e.i(381259);async function a(){let e=process.env.SUPABASE_POOLER_URL||"https://togejqdwggezkxahomeh.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;return e&&t?(0,r.createClient)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1},db:{schema:"public"},global:{headers:{"x-my-custom-header":"service-role"}}}):null}(0,e.i(798348).ensureServerEntryExports)([a]),(0,t.registerServerReference)(a,"00a13dbd00149949fc1367d3e76ae7d789e07f5321",null),e.s(["createServiceSupabaseClient",()=>a])},100357,e=>{"use strict";var t=e.i(273568);let r={urgency:["act now","limited time","urgent","immediate","expires","hurry","don't miss","last chance","final notice","deadline"],money:["free","$$$","cash","discount","save big","best price","cheap","bargain","bonus","prize","winner","congratulations"],suspicious:["click here","click below","buy now","order now","subscribe now","sign up free","no obligation","risk free","100% free","act immediately"],formatting:["ALL CAPS WORDS","!!!","???","$$$","***","###"]},a={urgency:2,money:3,suspicious:4,formatting:1.5,excessiveLinks:5,noUnsubscribe:3,shortContent:2,imageHeavy:3};async function s(e,r){let a=await (0,t.createServiceSupabaseClient)(),s=new Map;for(let e of r)s.set(e.toLowerCase(),{suppressed:!1});let{data:i}=await a.from("email_suppressions").select("email, reason, created_at").eq("company_id",e).in("email",r.map(e=>e.toLowerCase()));if(i)for(let e of i)s.set(e.email,{suppressed:!0,reason:e.reason,suppressedAt:e.created_at});let{data:n}=await a.from("email_global_bounces").select("email, bounce_type, created_at").in("email",r.map(e=>e.toLowerCase())).eq("bounce_type","hard");if(n)for(let e of n){let t=s.get(e.email);t?.suppressed||s.set(e.email,{suppressed:!0,reason:`Global hard bounce: ${e.bounce_type}`,suppressedAt:e.created_at})}return s}function i(e,t,s,i){let n,o=0,l=[],c=`${e} ${s}`.toLowerCase(),u=t.toLowerCase();for(let[e,t]of Object.entries(r)){let r=a[e]||1;for(let e of t){let t=RegExp(e.toLowerCase(),"gi"),a=c.match(t);a&&(o+=a.length*r,a.length>1&&l.push(`Contains "${e}" ${a.length} times`))}}let d=e.split(" ").filter(e=>e.length>3&&e===e.toUpperCase());d.length>0&&(o+=3*d.length,l.push(`Subject contains ${d.length} ALL CAPS words`));let p=(e.match(/!/g)||[]).length;p>1&&(o+=2*p,l.push(`Excessive exclamation marks in subject (${p})`));let m=(u.match(/<a\s/gi)||[]).length,h=s.split(/\s+/).length;h>0&&m/h>.1&&(o+=a.excessiveLinks,l.push(`High link density (${m} links in ${h} words)`)),(u.match(/<img\s/gi)||[]).length>0&&s.length<200&&(o+=a.imageHeavy,l.push("Image-heavy email with little text")),i||(o+=a.noUnsubscribe,l.push("Missing unsubscribe link (required for marketing emails)")),s.length<50&&(o+=a.shortContent,l.push("Very short email content")),(u.includes("display:none")||u.includes("font-size:0"))&&(o+=10,l.push("Contains hidden text (spam technique)"));let f=/<a[^>]*href=["']([^"']+)["'][^>]*>([^<]+)<\/a>/gi;for(;null!==(n=f.exec(t));){let e=n[1].toLowerCase(),t=n[2].toLowerCase();if(t.includes("click here")||t.includes("click this")||t.startsWith("http")&&!t.includes(new URL(e).hostname)){o+=5,l.push("Contains deceptive or vague link text");break}}return{score:Math.min(o,100),issues:l}}async function n(e){let r=await (0,t.createServiceSupabaseClient)(),{data:a}=await r.from("company_email_domains").select("created_at, emails_sent_today, total_emails_sent, warmup_completed").eq("id",e).single();if(!a)return{inWarmup:!0,daysSinceCreation:0,recommendedDailyLimit:10,currentDaySent:0,suggestions:["Domain not found"]};let s=new Date(a.created_at),i=Math.floor((new Date().getTime()-s.getTime())/864e5),n=20;for(let[e,t]of Object.entries({0:20,2:50,4:100,7:200,14:500,21:1e3,28:2500,35:5e3,42:1e4}))i>=parseInt(e)&&(n=t);let o=i<42&&!a.warmup_completed,l=[];return o&&(l.push(`Domain is in warm-up period (day ${i}/42). Recommended daily limit: ${n} emails.`),a.emails_sent_today>=.8*n&&l.push("Approaching daily warm-up limit. Consider spreading sends across multiple days.")),{inWarmup:o,daysSinceCreation:i,recommendedDailyLimit:n,currentDaySent:a.emails_sent_today||0,suggestions:l}}async function o(e){let r=await (0,t.createServiceSupabaseClient)(),{data:a}=await r.from("company_email_domains").select("status, is_suspended, sending_enabled, spf_verified, dkim_verified, dmarc_verified").eq("id",e).single();if(!a)return{canSend:!1,issues:["Domain not found"],dnsStatus:{spf:!1,dkim:!1,dmarc:!1}};let s=[];return"verified"!==a.status&&s.push(`Domain not verified (status: ${a.status})`),a.is_suspended&&s.push("Domain is suspended"),a.sending_enabled||s.push("Sending is disabled for this domain"),a.spf_verified||s.push("SPF record not verified - emails may fail authentication"),a.dkim_verified||s.push("DKIM not verified - emails may fail authentication"),a.dmarc_verified||s.push("DMARC not configured - reduces deliverability"),{canSend:0===s.length,issues:s,dnsStatus:{spf:a.spf_verified||!1,dkim:a.dkim_verified||!1,dmarc:a.dmarc_verified||!1}}}async function l(e,t,r,a,c,u,d=!1){let p=[],m=[],h=[],f=await o(t);f.canSend?f.dnsStatus.dmarc||p.push("DMARC not configured - consider adding for better deliverability"):m.push(...f.issues);let g=await s(e,r),y=[],v=0;for(let[e,t]of g)y.push({email:e,suppressed:t.suppressed,reason:t.reason}),t.suppressed&&v++;v>0&&p.push(`${v} recipient(s) on suppression list and will be skipped`),v===r.length&&m.push("All recipients are on suppression list - no emails will be sent");let b=c.includes("unsubscribe")||c.includes("List-Unsubscribe"),w=i(a,c,u,b||!d);w.score>=60?(m.push(`High spam score (${w.score}/100) - email likely to be filtered`),m.push(...w.issues)):w.score>=30&&(p.push(`Moderate spam score (${w.score}/100) - consider improvements`),p.push(...w.issues));let _=await n(t);if(_.inWarmup){h.push(..._.suggestions);let e=r.length-v,t=_.recommendedDailyLimit-_.currentDaySent;e>t&&p.push(`Sending ${e} emails exceeds warm-up limit (${t} remaining today). Consider sending over multiple days.`)}return c.includes("<!DOCTYPE")||c.includes("<html")||h.push("Consider using proper HTML structure with DOCTYPE for better rendering"),u.length<100&&h.push("Consider adding more text content - very short emails may look suspicious"),d&&!b&&m.push("Marketing emails MUST include an unsubscribe link (CAN-SPAM requirement)"),c.includes("{{")||c.includes("{name}")||a.includes("{{")||h.push("Consider adding personalization (recipient name, company) for better engagement"),{allowed:0===m.length,warnings:p,errors:m,suggestions:h,spamScore:w.score,recipientStatus:y}}async function c(e,r,a,s){let i=await (0,t.createServiceSupabaseClient)(),{error:n}=await i.from("email_suppressions").upsert({company_id:e,email:r.toLowerCase(),reason:a,details:s,created_at:new Date().toISOString()},{onConflict:"company_id,email"});return n?(console.error("Error adding to suppression list:",n),{success:!1,error:n.message}):{success:!0}}async function u(e,r,a){if("hard"!==r)return{success:!0};let s=await (0,t.createServiceSupabaseClient)(),{error:i}=await s.from("email_global_bounces").upsert({email:e.toLowerCase(),bounce_type:r,bounce_reason:a,bounce_count:1,last_bounce_at:new Date().toISOString(),created_at:new Date().toISOString()},{onConflict:"email"});return i?(console.error("Error adding to global bounce list:",i),{success:!1,error:i.message}):{success:!0}}async function d(e,r){let a=await (0,t.createServiceSupabaseClient)(),{error:s}=await a.from("email_suppressions").delete().eq("company_id",e).eq("email",r.toLowerCase());return s?(console.error("Error removing from suppression list:",s),{success:!1,error:s.message}):{success:!0}}async function p(e,r=100,a=0){let s=await (0,t.createServiceSupabaseClient)(),{data:i,count:n,error:o}=await s.from("email_suppressions").select("email, reason, details, created_at",{count:"exact"}).eq("company_id",e).order("created_at",{ascending:!1}).range(a,a+r-1);return o?(console.error("Error fetching suppression list:",o),{data:[],total:0}):{data:i||[],total:n||0}}e.s(["addToGlobalBounceList",()=>u,"addToSuppressionList",()=>c,"calculateSpamScore",()=>i,"checkDomainWarmup",()=>n,"checkSuppressionList",()=>s,"getSuppressionList",()=>p,"removeFromSuppressionList",()=>d,"runPreSendChecks",()=>l,"verifyDomainStatus",()=>o])},926458,e=>{"use strict";var t=e.i(755535),r=e.i(377233),a=e.i(490003),s=e.i(492991),i=e.i(241970),n=e.i(357699),o=e.i(212454),l=e.i(48717),c=e.i(798301),u=e.i(986366),d=e.i(983537),p=e.i(147475),m=e.i(561930),h=e.i(803747),f=e.i(368557),g=e.i(42037),y=e.i(193695);e.i(432036);var v=e.i(573881),b=e.i(297676),w=e.i(273568),_=e.i(129236),S=e.i(795824),R=e.i(63714),k=e.i(100357);async function x(e){try{let t,r=await e.text(),a=e.headers.get("X-Postmark-Token");if(!(0,_.verifyPostmarkWebhook)({payload:r,token:a}))return console.error("[Postmark Webhook] Invalid webhook signature"),b.NextResponse.json({error:"Invalid webhook signature"},{status:401});try{t=JSON.parse(r)}catch{return console.error("[Postmark Webhook] Invalid JSON payload"),b.NextResponse.json({error:"Invalid JSON payload"},{status:400})}switch(await (0,R.recordProviderEvent)({provider:"postmark",eventType:"webhook_received",messageId:t.MessageID,metadata:{recordType:t.RecordType,recipient:t.Recipient}}),t.RecordType){case"Delivery":await C(t);break;case"Bounce":await E(t);break;case"SpamComplaint":await D(t);break;case"Open":await A(t);break;case"Click":await O(t)}return b.NextResponse.json({received:!0})}catch(e){return console.error("[Postmark Webhook] Error processing webhook:",e instanceof Error?e.message:"Unknown error"),b.NextResponse.json({received:!0,error:"Processing error"})}}async function C(e){let t=await (0,w.createServiceSupabaseClient)();if(e.MessageID){let{error:r}=await t.from("email_logs").update({status:"delivered",delivered_at:e.DeliveredAt||new Date().toISOString(),metadata:void t.rpc}).eq("message_id",e.MessageID);r&&console.warn(`[Postmark Webhook] Could not update email_logs: ${r.message}`)}let r=await P(e.Metadata);r&&await (0,S.recordDeliveryEvent)({domainId:r,eventType:"delivered",emailId:e.MessageID,metadata:{provider:"postmark",recipient:e.Recipient}})}async function E(e){let t=await (0,w.createServiceSupabaseClient)(),r="HardBounce"===e.Type||1===e.TypeCode||"BadEmailAddress"===e.Type;if(e.MessageID&&await t.from("email_logs").update({status:"bounced",error_message:`${e.Type}: ${e.Description}`,bounced_at:e.BouncedAt||new Date().toISOString()}).eq("message_id",e.MessageID),r&&e.Recipient){let t=e.Metadata?.company_id;t&&await (0,k.addToSuppressionList)(t,e.Recipient,"hard_bounce",`Postmark: ${e.Type} - ${e.Description}`)}let a=await P(e.Metadata);a&&await (0,S.recordDeliveryEvent)({domainId:a,eventType:"bounced",emailId:e.MessageID,metadata:{provider:"postmark",recipient:e.Recipient,bounceType:e.Type,description:e.Description,isHardBounce:r}})}async function D(e){let t=await (0,w.createServiceSupabaseClient)();if(e.MessageID&&await t.from("email_logs").update({status:"spam_complaint",error_message:"Recipient marked as spam"}).eq("message_id",e.MessageID),e.Recipient){let t=e.Metadata?.company_id;t&&await (0,k.addToSuppressionList)(t,e.Recipient,"spam_complaint","Postmark: Recipient marked email as spam")}let r=await P(e.Metadata);r&&await (0,S.recordDeliveryEvent)({domainId:r,eventType:"complained",emailId:e.MessageID,metadata:{provider:"postmark",recipient:e.Recipient}})}async function A(e){let t=await (0,w.createServiceSupabaseClient)();if(e.MessageID){let{data:r}=await t.from("email_logs").select("metadata").eq("message_id",e.MessageID).maybeSingle(),a=r?.metadata||{},s=a.openCount||0;await t.from("email_logs").update({metadata:{...a,openCount:s+1,lastOpenedAt:new Date().toISOString()}}).eq("message_id",e.MessageID)}let r=await P(e.Metadata);r&&await (0,S.recordDeliveryEvent)({domainId:r,eventType:"opened",emailId:e.MessageID,metadata:{provider:"postmark",recipient:e.Recipient}})}async function O(e){let t=await (0,w.createServiceSupabaseClient)();if(e.MessageID){let{data:r}=await t.from("email_logs").select("metadata").eq("message_id",e.MessageID).maybeSingle(),a=r?.metadata||{},s=a.clickCount||0;await t.from("email_logs").update({metadata:{...a,clickCount:s+1,lastClickedAt:new Date().toISOString()}}).eq("message_id",e.MessageID)}let r=await P(e.Metadata);r&&await (0,S.recordDeliveryEvent)({domainId:r,eventType:"clicked",emailId:e.MessageID,metadata:{provider:"postmark",recipient:e.Recipient}})}async function P(e){if(e?.domain_id)return e.domain_id;if(e?.company_id){let t=await (0,w.createServiceSupabaseClient)(),{data:r}=await t.from("company_email_domains").select("id").eq("company_id",e.company_id).eq("sending_enabled",!0).limit(1).maybeSingle();return r?.id||null}return null}async function I(){return b.NextResponse.json({status:"ok",provider:"postmark",message:"Postmark webhook endpoint is active",timestamp:new Date().toISOString()})}e.s(["GET",()=>I,"POST",()=>x],768772);var M=e.i(768772);let T=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/webhooks/postmark/route",pathname:"/api/webhooks/postmark",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/webhooks/postmark/route.ts",nextConfigOutput:"",userland:M}),{workAsyncStorage:$,workUnitAsyncStorage:j,serverHooks:q}=T;function L(){return(0,a.patchFetch)({workAsyncStorage:$,workUnitAsyncStorage:j})}async function N(e,t,a){T.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let b="/api/webhooks/postmark/route";b=b.replace(/\/index$/,"")||"/";let w=await T.prepare(e,t,{srcPage:b,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:_,params:S,nextConfig:R,parsedUrl:k,isDraftMode:x,prerenderManifest:C,routerServerContext:E,isOnDemandRevalidate:D,revalidateOnlyGenerated:A,resolvedPathname:O,clientReferenceManifest:P,serverActionsManifest:I}=w,M=(0,l.normalizeAppPath)(b),$=!!(C.dynamicRoutes[M]||C.routes[O]),j=async()=>((null==E?void 0:E.render404)?await E.render404(e,t,k,!1):t.end("This page could not be found"),null);if($&&!x){let e=!!C.routes[O],t=C.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await j();throw new y.NoFallbackError}}let q=null;!$||T.isDev||x||(q="/index"===(q=O)?"/":q);let L=!0===T.isDev||!$,N=$&&!L;I&&P&&(0,n.setReferenceManifestsSingleton)({page:b,clientReferenceManifest:P,serverActionsManifest:I,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:I})});let U=e.method||"GET",H=(0,i.getTracer)(),B=H.getActiveScopeSpan(),W={params:S,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>T.onRequestError(e,t,a,E)},sharedContext:{buildId:_}},F=new c.NodeNextRequest(e),K=new c.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(F,(0,u.signalFromNodeResponse)(t));try{let n=async e=>T.handle(G,W).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${U} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${b}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var i,l;let c=async({previousCacheEntry:r})=>{try{if(!o&&D&&A&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await n(s);e.fetchMetrics=W.renderOpts.fetchMetrics;let l=W.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=W.renderOpts.collectedTags;if(!$)return await (0,m.sendResponse)(F,K,i,W.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==W.renderOpts.collectedRevalidate&&!(W.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&W.renderOpts.collectedRevalidate,a=void 0===W.renderOpts.collectedExpire||W.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:W.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:N,isOnDemandRevalidate:D})},E),t}},u=await T.handleResponse({req:e,nextConfig:R,cacheKey:q,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:A,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:o});if(!$)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",D?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&$||d.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(F,K,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};B?await l(B):await H.withPropagatedContext(e.headers,()=>H.trace(d.BaseServerSpan.handleRequest,{spanName:`${U} ${b}`,kind:i.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:N,isOnDemandRevalidate:D})}),$)throw t;return await (0,m.sendResponse)(F,K,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>L,"routeModule",()=>T,"serverHooks",()=>q,"workAsyncStorage",()=>$,"workUnitAsyncStorage",()=>j],926458)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__6e2224ff._.js.map