module.exports=[911413,e=>{"use strict";var t=e.i(755535),a=e.i(377233),r=e.i(490003),n=e.i(492991),s=e.i(241970),i=e.i(357699),o=e.i(212454),l=e.i(48717),c=e.i(798301),d=e.i(986366),u=e.i(983537),p=e.i(147475),h=e.i(561930),g=e.i(803747),m=e.i(368557),R=e.i(42037),f=e.i(193695);e.i(432036);var y=e.i(573881),w=e.i(297676),P=e.i(443608);e.i(715051);var v=e.i(511368);let x="Stratos-FMS/1.0 (support@stratos.app)";class C{apiKey;baseUrl="https://roads.googleapis.com/v1";cache=new Map;cacheTTL=36e5;constructor(){this.apiKey=process.env.GOOGLE_API_KEY||process.env.GOOGLE_MAPS_API_KEY}generateCacheKey(e,t){return`roads:${e}:${JSON.stringify(t)}`}getFromCache(e){let t=this.cache.get(e);return t&&Date.now()-t.timestamp<this.cacheTTL?t.data:null}setInCache(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}formatPath(e){return e.map(e=>`${e.latitude},${e.longitude}`).join("|")}async snapToRoads(e,t={}){if(!this.apiKey)return console.warn("Google Roads API key not configured"),null;if(0===e.length||e.length>100)return console.error("Path must have between 1 and 100 points"),null;let a=this.generateCacheKey("snap",{path:e,options:t}),r=this.getFromCache(a);if(r)return r;try{let r=new URLSearchParams({key:this.apiKey,path:this.formatPath(e)});t.interpolate&&r.append("interpolate","true");let n=`${this.baseUrl}/snapToRoads?${r.toString()}`,s=await fetch(n,{headers:{"User-Agent":x}});if(!s.ok)return console.error("Roads API error:",s.status),null;let i=await s.json(),o={snappedPoints:i.snappedPoints||[],warningMessage:i.warningMessage};return this.setInCache(a,o),o}catch(e){return console.error("Roads API error:",e),null}}async getSpeedLimits(e){if(!this.apiKey)return console.warn("Google Roads API key not configured"),null;if(0===e.length||e.length>100)return console.error("Path must have between 1 and 100 points"),null;let t=this.generateCacheKey("speedLimits",{path:e}),a=this.getFromCache(t);if(a)return a;try{let a=new URLSearchParams({key:this.apiKey,path:this.formatPath(e)}),r=`${this.baseUrl}/speedLimits?${a.toString()}`,n=await fetch(r,{headers:{"User-Agent":x}});if(!n.ok)return console.error("Roads API speed limits error:",n.status),null;let s=await n.json(),i={snappedPoints:s.snappedPoints||[],speedLimits:s.speedLimits||[]};return this.setInCache(t,i),i}catch(e){return console.error("Roads API speed limits error:",e),null}}async getSpeedLimitsByPlaceIds(e){if(!this.apiKey)return console.warn("Google Roads API key not configured"),null;if(0===e.length||e.length>100)return console.error("Must provide between 1 and 100 place IDs"),null;let t=this.generateCacheKey("speedLimitsByPlace",{placeIds:e}),a=this.getFromCache(t);if(a)return a;try{let a=new URLSearchParams({key:this.apiKey});for(let t of e)a.append("placeId",t);let r=`${this.baseUrl}/speedLimits?${a.toString()}`,n=await fetch(r,{headers:{"User-Agent":x}});if(!n.ok)return console.error("Roads API speed limits by place error:",n.status),null;let s=(await n.json()).speedLimits||[];return this.setInCache(t,s),s}catch(e){return console.error("Roads API speed limits by place error:",e),null}}async getNearestRoad(e){if(!this.apiKey)return console.warn("Google Roads API key not configured"),null;let t=this.generateCacheKey("nearest",{point:e}),a=this.getFromCache(t);if(a)return a;try{let a,r=new URLSearchParams({key:this.apiKey,points:`${e.latitude},${e.longitude}`}),n=`${this.baseUrl}/nearestRoads?${r.toString()}`,s=await fetch(n,{headers:{"User-Agent":x}});if(!s.ok)return console.error("Roads API nearest road error:",s.status),null;let i=await s.json();if(i.snappedPoints&&i.snappedPoints.length>0){let t=i.snappedPoints[0],r=this.calculateDistance(e,t.location);a={snappedPoint:t,distanceMeters:r}}else a={snappedPoint:null};return this.setInCache(t,a),a}catch(e){return console.error("Roads API nearest road error:",e),null}}calculateDistance(e,t){let a=e.latitude*Math.PI/180,r=t.latitude*Math.PI/180,n=(t.latitude-e.latitude)*Math.PI/180,s=(t.longitude-e.longitude)*Math.PI/180,i=Math.sin(n/2)*Math.sin(n/2)+Math.cos(a)*Math.cos(r)*Math.sin(s/2)*Math.sin(s/2);return 2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))*6371e3}calculatePathDistance(e){let t=0;for(let a=1;a<e.length;a++)t+=this.calculateDistance({latitude:e[a-1].location.latitude,longitude:e[a-1].location.longitude},e[a].location);return t}async analyzeRoute(e){if(!this.apiKey)return console.warn("Google Roads API key not configured"),null;let t=await this.snapToRoads(e,{interpolate:!0});if(!t||0===t.snappedPoints.length)return null;let a=await this.getSpeedLimits(e),r=this.calculatePathDistance(t.snappedPoints),n=a?.speedLimits||[],s=n.map(e=>e.speedLimit);return{totalDistanceMeters:r,snappedPath:t.snappedPoints,speedLimits:n,averageSpeedLimit:s.length>0?s.reduce((e,t)=>e+t,0)/s.length:void 0,maxSpeedLimit:s.length>0?Math.max(...s):void 0,minSpeedLimit:s.length>0?Math.min(...s):void 0}}async trackTechnicianRoute(e,t){if(!this.apiKey)return console.warn("Google Roads API key not configured"),null;let a=[],r=[];for(let e=0;e<t.length;e+=100){let n=t.slice(e,e+100).map(e=>({latitude:e.latitude,longitude:e.longitude})),s=await this.snapToRoads(n,{interpolate:!0});s&&a.push(...s.snappedPoints);let i=await this.getSpeedLimits(n);i&&r.push(...i.speedLimits)}let n=this.calculatePathDistance(a),s=[];for(let e of t)if(void 0!==e.speed){let t=r.find(t=>{let r=a.find(e=>e.placeId===t.placeId);return!!r&&100>this.calculateDistance(e,r.location)});t&&e.speed>t.speedLimit&&s.push({location:{latitude:e.latitude,longitude:e.longitude},speedLimit:t.speedLimit,timestamp:e.timestamp})}let i=r.length>0?r.reduce((e,t)=>e+t.speedLimit,0)/r.length:30;return{technicianId:e,snappedPath:a,speedLimits:r,totalDistanceMeters:n,estimatedDuration:Math.round(n/(1609.34*i/3600)),potentialSpeedingPoints:s.length>0?s:void 0}}async batchSnapRoutes(e){let t=new Map;for(let a=0;a<e.length;a+=5){let r=e.slice(a,a+5).map(async e=>{let a=await this.snapToRoads(e.path);a&&t.set(e.id,a)});await Promise.all(r)}return t}isConfigured(){return!!this.apiKey}clearCache(){this.cache.clear()}}let I=new C,b=P.z.object({latitude:P.z.number(),longitude:P.z.number()}),A=P.z.object({action:P.z.literal("snap"),path:P.z.array(b).min(1).max(100),interpolate:P.z.boolean().optional()}),E=P.z.object({action:P.z.literal("speed-limits"),path:P.z.array(b).min(1).max(100)}),S=P.z.object({action:P.z.literal("speed-limits-by-place"),placeIds:P.z.array(P.z.string()).min(1).max(100)}),N=P.z.object({action:P.z.literal("nearest"),point:b}),z=P.z.object({action:P.z.literal("analyze"),path:P.z.array(b).min(2).max(100)}),M=P.z.object({action:P.z.literal("track"),technicianId:P.z.string(),gpsPoints:P.z.array(b.extend({timestamp:P.z.string().optional(),speed:P.z.number().optional()})).min(1).max(500)}),j=P.z.object({action:P.z.literal("batch-snap"),routes:P.z.array(P.z.object({id:P.z.string(),path:P.z.array(b).min(1).max(100)})).min(1).max(10)}),L=P.z.discriminatedUnion("action",[A,E,S,N,z,M,j]);async function T(e){try{let t=await (0,v.createClient)(),{data:{user:a}}=await t.auth.getUser();if(!a)return w.NextResponse.json({error:"Unauthorized"},{status:401});if(!I.isConfigured())return w.NextResponse.json({error:"Roads service is not configured. Set GOOGLE_API_KEY environment variable."},{status:503});let r=await e.json(),n=L.parse(r);switch(n.action){case"snap":{let e=await I.snapToRoads(n.path,{interpolate:n.interpolate});if(!e)return w.NextResponse.json({error:"Failed to snap to roads"},{status:500});return w.NextResponse.json({success:!0,data:e})}case"speed-limits":{let e=await I.getSpeedLimits(n.path);if(!e)return w.NextResponse.json({error:"Failed to get speed limits"},{status:500});return w.NextResponse.json({success:!0,data:e})}case"speed-limits-by-place":{let e=await I.getSpeedLimitsByPlaceIds(n.placeIds);if(!e)return w.NextResponse.json({error:"Failed to get speed limits by place"},{status:500});return w.NextResponse.json({success:!0,data:e})}case"nearest":{let e=await I.getNearestRoad(n.point);if(!e)return w.NextResponse.json({error:"Failed to find nearest road"},{status:500});return w.NextResponse.json({success:!0,data:e})}case"analyze":{let e=await I.analyzeRoute(n.path);if(!e)return w.NextResponse.json({error:"Failed to analyze route"},{status:500});return w.NextResponse.json({success:!0,data:e})}case"track":{let e=await I.trackTechnicianRoute(n.technicianId,n.gpsPoints);if(!e)return w.NextResponse.json({error:"Failed to track technician route"},{status:500});return w.NextResponse.json({success:!0,data:e})}case"batch-snap":{let e=await I.batchSnapRoutes(n.routes),t={};return e.forEach((e,a)=>{t[a]=e}),w.NextResponse.json({success:!0,data:{results:t,count:e.size}})}default:return w.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){if(console.error("Roads API error:",e),e instanceof P.z.ZodError)return w.NextResponse.json({error:"Invalid request data",details:e.errors},{status:400});return w.NextResponse.json({error:"Failed to process roads request",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}e.s(["POST",()=>T],578198);var k=e.i(578198);let U=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/roads/route",pathname:"/api/roads",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/roads/route.ts",nextConfigOutput:"",userland:k}),{workAsyncStorage:K,workUnitAsyncStorage:O,serverHooks:_}=U;function D(){return(0,r.patchFetch)({workAsyncStorage:K,workUnitAsyncStorage:O})}async function $(e,t,r){U.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/roads/route";w=w.replace(/\/index$/,"")||"/";let P=await U.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!P)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:v,params:x,nextConfig:C,parsedUrl:I,isDraftMode:b,prerenderManifest:A,routerServerContext:E,isOnDemandRevalidate:S,revalidateOnlyGenerated:N,resolvedPathname:z,clientReferenceManifest:M,serverActionsManifest:j}=P,L=(0,l.normalizeAppPath)(w),T=!!(A.dynamicRoutes[L]||A.routes[z]),k=async()=>((null==E?void 0:E.render404)?await E.render404(e,t,I,!1):t.end("This page could not be found"),null);if(T&&!b){let e=!!A.routes[z],t=A.dynamicRoutes[L];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await k();throw new f.NoFallbackError}}let K=null;!T||U.isDev||b||(K="/index"===(K=z)?"/":K);let O=!0===U.isDev||!T,_=T&&!O;j&&M&&(0,i.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:M,serverActionsManifest:j,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:j})});let D=e.method||"GET",$=(0,s.getTracer)(),F=$.getActiveScopeSpan(),q={params:x,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:O,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>U.onRequestError(e,t,r,E)},sharedContext:{buildId:v}},H=new c.NodeNextRequest(e),G=new c.NodeNextResponse(t),B=d.NextRequestAdapter.fromNodeNextRequest(H,(0,d.signalFromNodeResponse)(t));try{let i=async e=>U.handle(B,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=$.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${D} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${D} ${w}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var s,l;let c=async({previousCacheEntry:a})=>{try{if(!o&&S&&N&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(n);e.fetchMetrics=q.renderOpts.fetchMetrics;let l=q.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let c=q.renderOpts.collectedTags;if(!T)return await (0,h.sendResponse)(H,G,s,q.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(s.headers);c&&(t[R.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,r=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await U.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:S})},E),t}},d=await U.handleResponse({req:e,nextConfig:C,cacheKey:K,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:N,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:o});if(!T)return null;if((null==d||null==(s=d.value)?void 0:s.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",S?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&T||u.delete(R.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(H,G,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};F?await l(F):await $.withPropagatedContext(e.headers,()=>$.trace(u.BaseServerSpan.handleRequest,{spanName:`${D} ${w}`,kind:s.SpanKind.SERVER,attributes:{"http.method":D,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await U.onRequestError(e,t,{routerKind:"App Router",routePath:L,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:S})}),T)throw t;return await (0,h.sendResponse)(H,G,new Response(null,{status:500})),null}}e.s(["handler",()=>$,"patchFetch",()=>D,"routeModule",()=>U,"serverHooks",()=>_,"workAsyncStorage",()=>K,"workUnitAsyncStorage",()=>O],911413)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_ec042f25.js.map