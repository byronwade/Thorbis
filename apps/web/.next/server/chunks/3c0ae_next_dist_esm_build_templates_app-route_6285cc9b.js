module.exports=[955242,e=>{"use strict";var t=e.i(755535),r=e.i(377233),a=e.i(490003),i=e.i(492991),s=e.i(241970),n=e.i(357699),o=e.i(212454),l=e.i(48717),c=e.i(798301),u=e.i(986366),d=e.i(983537),h=e.i(147475),p=e.i(561930),y=e.i(803747),m=e.i(368557),g=e.i(42037),f=e.i(193695);e.i(432036);var v=e.i(573881),w=e.i(297676);let S=["assault","homicide","robbery","sexual-assault"],C=["burglary","motor-vehicle-theft","theft","vandalism","arson"],R=new class{apiKey;baseUrl="https://api.crimeometer.com/v2";constructor(){this.apiKey=process.env.CRIMEOMETER_API_KEY||""}async getCrimeIncidents(e,t,r={}){if(!this.apiKey)return console.error("CrimeoMeter API key not configured"),[];let{radius:a=500,startDate:i,endDate:s,limit:n=50}=r;try{let r=new URL(`${this.baseUrl}/incidents/raw-data`);r.searchParams.set("lat",e.toString()),r.searchParams.set("lon",t.toString()),r.searchParams.set("distance",(a/1e3).toString()),r.searchParams.set("limit",n.toString());let o=s||new Date().toISOString().split("T")[0],l=i||new Date(Date.now()-7776e6).toISOString().split("T")[0];r.searchParams.set("datetime_ini",l),r.searchParams.set("datetime_end",o);let c=await fetch(r.toString(),{headers:{"x-api-key":this.apiKey,"Content-Type":"application/json"}});if(!c.ok)throw Error(`CrimeoMeter API error: ${c.status}`);let u=await c.json();if(!u.incidents||!Array.isArray(u.incidents))return[];return u.incidents.map(e=>({id:e.incident_id,source:e.source,incidentDate:e.incident_date,reportDate:e.report_date,category:this.normalizeCategory(e.incident_offense),type:e.incident_offense,description:e.incident_offense_description,address:e.incident_address,lat:e.incident_latitude,lng:e.incident_longitude,distance:e.distance?1e3*e.distance:void 0}))}catch(e){return console.error("Error fetching crime incidents:",e),[]}}async getSafetyScore(e,t){if(!this.apiKey)return console.error("CrimeoMeter API key not configured"),null;try{let r=new URL(`${this.baseUrl}/city-safety-score`);r.searchParams.set("lat",e.toString()),r.searchParams.set("lon",t.toString());let a=await fetch(r.toString(),{headers:{"x-api-key":this.apiKey,"Content-Type":"application/json"}});if(!a.ok)return this.calculateSafetyScoreFromIncidents(e,t);let i=await a.json();if(!i.safety_score)return this.calculateSafetyScoreFromIncidents(e,t);return{score:i.safety_score,grade:this.scoreToGrade(i.safety_score),level:this.scoreToLevel(i.safety_score),comparison:i.comparison}}catch(r){return console.error("Error fetching safety score:",r),this.calculateSafetyScoreFromIncidents(e,t)}}async calculateSafetyScoreFromIncidents(e,t){let r,a=await this.getCrimeIncidents(e,t,{radius:1e3,limit:100});if(0===a.length)return{score:75,grade:"B",level:"safe"};let i=0,s=0;a.forEach(e=>{S.includes(e.category)?i++:C.includes(e.category)&&s++});let n=3*i+s;return{score:r=n<=5?90:n<=10?80:n<=20?70:n<=35?60:n<=50?50:n<=75?40:n<=100?30:20,grade:this.scoreToGrade(r),level:this.scoreToLevel(r)}}async getLocationSafetyReport(e,t,r=500){let[a,i]=await Promise.all([this.getSafetyScore(e,t),this.getCrimeIncidents(e,t,{radius:r,limit:100})]);if(!a)return null;let s=this.calculateCrimeStats(i),n=this.calculateRiskAssessment(a,s);return{lat:e,lng:t,radius:r,safetyScore:a,crimeStats:s,recentIncidents:i.slice(0,10),riskAssessment:n}}calculateCrimeStats(e){let t={assault:0,burglary:0,homicide:0,"motor-vehicle-theft":0,robbery:0,"sexual-assault":0,theft:0,vandalism:0,arson:0,drugs:0,fraud:0,other:0},r=0,a=0;e.forEach(e=>{t[e.category]++,S.includes(e.category)&&r++,C.includes(e.category)&&a++});let i="other",s=0;return Object.keys(t).forEach(e=>{t[e]>s&&(s=t[e],i=e)}),{totalIncidents:e.length,incidentsByCategory:t,recentTrend:"stable",mostCommonCrime:i,violentCrimeCount:r,propertyCrimeCount:a}}calculateRiskAssessment(e,t){let r,a,i=[],s=this.levelToRisk(e.level);return r=0===t.violentCrimeCount?"low":t.violentCrimeCount<=3?"moderate":t.violentCrimeCount<=10?"high":"very-high",a=t.propertyCrimeCount<=5?"low":t.propertyCrimeCount<=15?"moderate":t.propertyCrimeCount<=30?"high":"very-high",("high"===r||"very-high"===r)&&(i.push("Schedule appointments during daylight hours only"),i.push("Use two-person teams when possible"),i.push("Share arrival/departure times with dispatch")),("high"===a||"very-high"===a)&&(i.push("Never leave vehicle unlocked or tools visible"),i.push("Use locking toolboxes and cable locks"),i.push("Park in visible, well-lit locations")),t.incidentsByCategory.burglary>5&&i.push("Good opportunity to discuss security system upgrades with customer"),t.incidentsByCategory["motor-vehicle-theft"]>3&&i.push("Consider using vehicle tracking and steering wheel lock"),{overallRisk:s,violentCrimeRisk:r,propertyCrimeRisk:a,timeBasedRisk:{daytime:"very-high"===s?"high":"high"===s?"moderate":"low",evening:"low"===s?"low":"moderate"===s?"moderate":"high",night:"low"===s?"moderate":"high"},recommendations:i}}normalizeCategory(e){let t=e.toLowerCase();return t.includes("assault")||t.includes("battery")?"assault":t.includes("burglar")?"burglary":t.includes("murder")||t.includes("homicide")||t.includes("manslaughter")?"homicide":t.includes("vehicle")||t.includes("auto")||t.includes("car theft")?"motor-vehicle-theft":t.includes("robbery")?"robbery":t.includes("rape")||t.includes("sexual")?"sexual-assault":t.includes("theft")||t.includes("larceny")||t.includes("shoplifting")?"theft":t.includes("vandal")||t.includes("criminal mischief")||t.includes("damage")?"vandalism":t.includes("arson")?"arson":t.includes("drug")||t.includes("narcotic")?"drugs":t.includes("fraud")||t.includes("forgery")||t.includes("identity")?"fraud":"other"}scoreToGrade(e){return e>=97?"A+":e>=93?"A":e>=90?"A-":e>=87?"B+":e>=83?"B":e>=80?"B-":e>=77?"C+":e>=73?"C":e>=70?"C-":e>=67?"D+":e>=63?"D":e>=60?"D-":"F"}scoreToLevel(e){return e>=85?"very-safe":e>=70?"safe":e>=50?"moderate":e>=30?"unsafe":"very-unsafe"}levelToRisk(e){switch(e){case"very-safe":case"safe":return"low";case"moderate":return"moderate";case"unsafe":return"high";case"very-unsafe":return"very-high"}}async getServiceCallSafety(e,t,r){let a,i=await this.getLocationSafetyReport(t,r,500),s=[],n=[];if(!i)return{address:e,safetyGrade:"N/A",riskLevel:"moderate",recentCrimesNearby:0,schedulingRecommendation:"Standard scheduling - unable to retrieve crime data",technicianSafetyNotes:["Unable to assess area - use standard safety protocols"],equipmentSecurityNotes:["Use standard equipment security measures"]};let o=i.riskAssessment.overallRisk;switch(o){case"low":a="No scheduling restrictions - area is relatively safe",s.push("Standard safety awareness appropriate"),n.push("Standard vehicle security sufficient");break;case"moderate":a="Prefer daytime appointments when possible",s.push("Be aware of surroundings"),s.push("Notify dispatch of arrival/departure"),n.push("Keep vehicle locked"),n.push("Don't leave tools visible");break;case"high":a="Schedule during daylight hours only (8AM-5PM)",s.push("Stay alert and aware at all times"),s.push("Park in visible location"),s.push("Keep phone accessible"),s.push("Check in with dispatch hourly"),n.push("Use locked toolboxes only"),n.push("Never leave vehicle unattended with tools visible"),n.push("Consider bringing only necessary tools");break;case"very-high":a="CAUTION: High-risk area. Two-person team recommended. Daytime only.",s.push("Two-person team strongly recommended"),s.push("Check in with dispatch every 30 minutes"),s.push("Have exit strategy planned"),s.push("Trust instincts - leave if uncomfortable"),n.push("Bring only essential tools"),n.push("One person stays with vehicle at all times"),n.push("GPS tracking enabled on vehicle and phone")}return i.crimeStats.incidentsByCategory.burglary>5&&s.push(`High burglary area (${i.crimeStats.incidentsByCategory.burglary} recent incidents) - good security upsell opportunity`),i.crimeStats.incidentsByCategory["motor-vehicle-theft"]>2&&n.push(`Elevated vehicle theft risk (${i.crimeStats.incidentsByCategory["motor-vehicle-theft"]} recent incidents) - use steering wheel lock`),i.crimeStats.incidentsByCategory.theft>10&&n.push("High theft area - document tools with photos before/after"),{address:e,safetyGrade:i.safetyScore.grade,riskLevel:o,recentCrimesNearby:i.crimeStats.totalIncidents,schedulingRecommendation:a,technicianSafetyNotes:s,equipmentSecurityNotes:n}}async isEveningAppointmentSafe(e,t){let r=await this.getSafetyScore(e,t);return r?"very-safe"===r.level||"safe"===r.level?{safe:!0,recommendation:"Evening appointment acceptable in this area"}:"moderate"===r.level?{safe:!1,recommendation:"Daytime appointment recommended for this area",alternativeTimeSlots:["8:00 AM - 12:00 PM","12:00 PM - 4:00 PM"]}:{safe:!1,recommendation:"Daytime only - two-person team recommended for this area",alternativeTimeSlots:["9:00 AM - 12:00 PM","1:00 PM - 3:00 PM"]}:{safe:!1,recommendation:"Unable to determine safety - recommend daytime appointment",alternativeTimeSlots:["9:00 AM - 11:00 AM","1:00 PM - 3:00 PM"]}}async rankLocationsBySafety(e){return(await Promise.all(e.map(async e=>{let t=await this.getSafetyScore(e.lat,e.lng);return{...e,safety:t}}))).map(e=>{let t;return t=!e.safety||e.safety.score>=70?"any":e.safety.score>=50?"daytime":"morning-only",{address:e.address,safetyScore:e.safety?.score||50,grade:e.safety?.grade||"N/A",suggestedTimeSlot:t}}).sort((e,t)=>t.safetyScore-e.safetyScore)}async getSecurityUpsellOpportunities(e,t){let r=await this.getLocationSafetyReport(e,t,1e3);if(!r)return{hasOpportunity:!1,opportunityStrength:"low",relevantCrimes:[],suggestedProducts:[],talkingPoints:[]};let a=[],i=[],s=[];r.crimeStats.incidentsByCategory.burglary>3&&(a.push({type:"Burglary",count:r.crimeStats.incidentsByCategory.burglary}),i.push("Smart home security system"),i.push("Video doorbell"),i.push("Motion-activated cameras"),s.push(`There have been ${r.crimeStats.incidentsByCategory.burglary} burglaries reported in this area recently`)),r.crimeStats.incidentsByCategory["motor-vehicle-theft"]>2&&(a.push({type:"Vehicle Theft",count:r.crimeStats.incidentsByCategory["motor-vehicle-theft"]}),i.push("Driveway security camera"),i.push("Smart garage door opener"),s.push("Vehicle thefts have been reported nearby - driveway cameras can help")),r.crimeStats.incidentsByCategory.theft>10&&(a.push({type:"Theft/Larceny",count:r.crimeStats.incidentsByCategory.theft}),i.push("Package lockbox"),i.push("Video doorbell with package detection"),s.push("High theft area - package protection is valuable for online shoppers")),r.crimeStats.incidentsByCategory.vandalism>5&&(a.push({type:"Vandalism",count:r.crimeStats.incidentsByCategory.vandalism}),i.push("Motion-activated flood lights"),i.push("Smart exterior lighting"),s.push("Good lighting deters vandalism and improves camera footage quality"));let n=a.length>0,o="low";return a.reduce((e,t)=>e+t.count,0)>20?o="high":a.reduce((e,t)=>e+t.count,0)>10&&(o="medium"),{hasOpportunity:n,opportunityStrength:o,relevantCrimes:a,suggestedProducts:i,talkingPoints:s}}};var b=e.i(511368);e.i(16106);var k=e.i(985647),E=e.i(350318);async function P(e){try{let t=e.nextUrl.searchParams,r=t.get("lat"),a=t.get("lng"),i=t.get("address"),s=t.get("action")||"safety";if(!(r&&a))return w.NextResponse.json({error:"lat and lng required"},{status:400});let n=await (0,b.createClient)();if(!n)return w.NextResponse.json({error:"Database connection failed"},{status:500});let{data:{user:o}}=await n.auth.getUser();if(!o)return w.NextResponse.json({error:"Unauthorized"},{status:401});let l=await (0,k.getActiveCompanyId)();if(!l)return w.NextResponse.json({error:"No active company selected"},{status:401});let c=await (0,E.checkApiQuota)(l,"crimeometer");if(c&&!c.has_quota)return w.NextResponse.json({error:"API quota exceeded",currentUsage:c.current_usage,limit:c.monthly_limit},{status:429});let u=parseFloat(r),d=parseFloat(a),h={incidents:"incidents",safety:"safety_score",report:"safety_report","service-call":"service_call_safety","evening-check":"evening_check","rank-locations":"rank_locations","upsell-opportunities":"upsell_opportunities"}[s];if(!h)return w.NextResponse.json({error:"Invalid action"},{status:400});let p=await (0,E.withUsageTracking)(l,"crimeometer",h,async()=>{switch(s){case"incidents":let e=t.get("radius"),r=t.get("startDate"),a=t.get("endDate"),n=t.get("limit");return await R.getCrimeIncidents(u,d,{radius:e?parseInt(e):void 0,startDate:r||void 0,endDate:a||void 0,limit:n?parseInt(n):void 0});case"safety":return await R.getSafetyScore(u,d);case"report":let o=t.get("radius");return await R.getLocationSafetyReport(u,d,o?parseInt(o):void 0);case"service-call":if(!i)throw Error("address required for service-call action");return await R.getServiceCallSafety(i,u,d);case"evening-check":return await R.isEveningAppointmentSafe(u,d);case"rank-locations":let l=t.get("locations");if(!l)throw Error("locations required (JSON array)");try{let e=JSON.parse(l);return await R.rankLocationsBySafety(e)}catch{throw Error("Invalid locations JSON")}case"upsell-opportunities":return await R.getSecurityUpsellOpportunities(u,d);default:throw Error(`Unknown action: ${s}`)}});if(!p)return w.NextResponse.json({error:"No data found"},{status:404});return w.NextResponse.json(p,{headers:{"Cache-Control":"public, s-maxage=3600, stale-while-revalidate=7200"}})}catch(e){if(console.error("CrimeoMeter API error:",e),e instanceof Error&&(e.message.includes("required")||e.message.includes("Invalid")))return w.NextResponse.json({error:e.message},{status:400});return w.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>P],798394);var x=e.i(798394);let A=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/risk/crime-realtime/route",pathname:"/api/risk/crime-realtime",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/risk/crime-realtime/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:N,workUnitAsyncStorage:T,serverHooks:_}=A;function I(){return(0,a.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:T})}async function M(e,t,a){A.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/risk/crime-realtime/route";w=w.replace(/\/index$/,"")||"/";let S=await A.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!S)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:C,params:R,nextConfig:b,parsedUrl:k,isDraftMode:E,prerenderManifest:P,routerServerContext:x,isOnDemandRevalidate:N,revalidateOnlyGenerated:T,resolvedPathname:_,clientReferenceManifest:I,serverActionsManifest:M}=S,U=(0,l.normalizeAppPath)(w),O=!!(P.dynamicRoutes[U]||P.routes[_]),B=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,k,!1):t.end("This page could not be found"),null);if(O&&!E){let e=!!P.routes[_],t=P.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await B();throw new f.NoFallbackError}}let D=null;!O||A.isDev||E||(D="/index"===(D=_)?"/":D);let q=!0===A.isDev||!O,j=O&&!q;M&&I&&(0,n.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:I,serverActionsManifest:M,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:M})});let H=e.method||"GET",L=(0,s.getTracer)(),K=L.getActiveScopeSpan(),$={params:R,prerenderManifest:P,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>A.onRequestError(e,t,a,x)},sharedContext:{buildId:C}},F=new c.NodeNextRequest(e),G=new c.NodeNextResponse(t),V=u.NextRequestAdapter.fromNodeNextRequest(F,(0,u.signalFromNodeResponse)(t));try{let n=async e=>A.handle(V,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${w}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var s,l;let c=async({previousCacheEntry:r})=>{try{if(!o&&N&&T&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await n(i);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=$.renderOpts.collectedTags;if(!O)return await (0,p.sendResponse)(F,G,s,$.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,y.toNodeOutgoingHttpHeaders)(s.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,a=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:N})},x),t}},u=await A.handleResponse({req:e,nextConfig:b,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:P,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:T,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:o});if(!O)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",N?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,y.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&O||d.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(F,G,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};K?await l(K):await L.withPropagatedContext(e.headers,()=>L.trace(d.BaseServerSpan.handleRequest,{spanName:`${H} ${w}`,kind:s.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:N})}),O)throw t;return await (0,p.sendResponse)(F,G,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>I,"routeModule",()=>A,"serverHooks",()=>_,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>T],955242)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_6285cc9b.js.map