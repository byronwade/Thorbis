module.exports=[193220,e=>{"use strict";var t=e.i(755535),a=e.i(377233),r=e.i(490003),n=e.i(492991),o=e.i(241970),s=e.i(357699),i=e.i(212454),c=e.i(48717),l=e.i(798301),u=e.i(986366),d=e.i(983537),_=e.i(147475),m=e.i(561930),p=e.i(803747),h=e.i(368557),v=e.i(42037),g=e.i(193695);e.i(432036);var f=e.i(573881),y=e.i(297676),w=e.i(273568);async function R(e){let t=e.headers.get("authorization"),a=process.env.CRON_SECRET;if(!a)return y.NextResponse.json({error:"Cron secret not configured"},{status:500});if(t!==`Bearer ${a}`)return y.NextResponse.json({error:"Unauthorized"},{status:401});try{let e=(0,w.createServiceSupabaseClient)(),t=[],{data:a,error:r}=await e.from("companies").select("id").is("deleted_at",null);if(r||!a)return y.NextResponse.json({error:"Failed to fetch companies",details:r?.message},{status:500});let n=new Date().toISOString().split("T")[0];for(let r of a)try{await b(e,r.id,n),t.push({companyId:r.id,success:!0})}catch(a){let e=a instanceof Error?a.message:"Unknown error";t.push({companyId:r.id,success:!1,error:e})}return y.NextResponse.json({success:!0,summaryDate:n,processed:a.length,results:t})}catch(t){let e=t instanceof Error?t.message:"Unknown error";return y.NextResponse.json({error:"Failed",details:e},{status:500})}}async function b(e,t,a){let r=new Date(a),n=new Date(r);n.setDate(n.getDate()-30);let o=new Date(r);o.setDate(o.getDate()-90);let s=new Date(r);s.setFullYear(s.getFullYear()-1);let{data:i}=await e.from("analytics_daily_snapshots").select("*").eq("company_id",t).gte("snapshot_date",o.toISOString().split("T")[0]).order("snapshot_date",{ascending:!1}),c=i??[],l=c.slice(0,30),u=c.slice(0,7),d=l.reduce((e,t)=>e+(t.total_revenue??0),0),_=u.reduce((e,t)=>e+(t.total_revenue??0),0),m=l.reduce((e,t)=>e+(t.average_ticket??0),0)/Math.max(l.length,1),p=l.reduce((e,t)=>e+(t.jobs_completed??0),0),h=l.reduce((e,t)=>e+(t.jobs_created??0),0),v=l.reduce((e,t)=>e+(t.jobs_cancelled??0),0),g=l.reduce((e,t)=>e+(t.first_time_fix_count??0),0),f=l.reduce((e,t)=>e+(t.callback_count??0),0),y=p>0?g/p*100:0,w=l.reduce((e,t)=>e+(t.estimates_created??0),0),R=l.reduce((e,t)=>e+(t.estimates_approved??0),0),b=l.reduce((e,t)=>e+(t.estimates_declined??0),0),E=l.reduce((e,t)=>e+(t.new_customers??0),0),x=l[0]?.total_active_customers??0,C=l.reduce((e,t)=>e+(t.emails_sent??0),0),S=l.reduce((e,t)=>e+(t.emails_received??0),0),O=l.reduce((e,t)=>e+(t.sms_sent??0),0),T=l.reduce((e,t)=>e+(t.sms_received??0),0),j=l.reduce((e,t)=>e+(t.calls_made??0),0),q=l.reduce((e,t)=>e+(t.calls_received??0),0),A=l.filter(e=>e.average_response_time_minutes).map(e=>e.average_response_time_minutes),N=A.length>0?Math.round(A.reduce((e,t)=>e+t,0)/A.length):0,D=l.reduce((e,t)=>e+(t.contracts_created??0),0),M=l.reduce((e,t)=>e+(t.contracts_renewed??0),0),I=l.reduce((e,t)=>e+(t.contracts_cancelled??0),0),P=l[0]?.active_contracts??0,U=l.reduce((e,t)=>e+(t.contract_revenue??0),0),k=l[0]?.active_technicians??0,H=l.filter(e=>e.utilization_rate).map(e=>e.utilization_rate),F=H.length>0?H.reduce((e,t)=>e+t,0)/H.length:0,z=k>0?p/k:0,$=k>0?d/k:0,K=l[0]?.outstanding_revenue??0,{data:B}=await e.from("invoices").select("balance_amount, due_date, status").eq("company_id",t).in("status",["sent","partial","overdue"]).is("deleted_at",null),L=0,G=0,V=0,X=0,W=0;for(let e of B??[]){if(!e.due_date||!e.balance_amount)continue;let t=Math.floor((r.getTime()-new Date(e.due_date).getTime())/864e5);t<=0?L+=e.balance_amount:t<=30?G+=e.balance_amount:t<=60?V+=e.balance_amount:t<=90?X+=e.balance_amount:W+=e.balance_amount}let{data:Y}=await e.from("estimates").select("total_amount, conversion_probability").eq("company_id",t).in("status",["draft","sent","pending"]).is("deleted_at",null),Z=(Y??[]).reduce((e,t)=>e+(t.total_amount??0),0),J=(Y??[]).reduce((e,t)=>e+(t.total_amount??0)*((t.conversion_probability??50)/100),0),{data:Q}=await e.from("estimates").select("id, total_amount").eq("company_id",t).eq("conversion_status","won").gte("created_at",n.toISOString()).is("deleted_at",null),ee=w>0?(Q?.length??0)/w*100:0,{data:et}=await e.from("jobs").select("total_amount, estimated_amount").eq("company_id",t).eq("status","completed").not("estimated_amount","is",null).gte("created_at",n.toISOString()).is("deleted_at",null),ea=0,er=0;for(let e of et??[])e.estimated_amount&&e.estimated_amount>0&&(ea+=Math.max(0,100-Math.abs(((e.total_amount??0)-e.estimated_amount)/e.estimated_amount*100)),er++);let en=er>0?ea/er:0,eo=l.filter(e=>e.capacity_utilization).map(e=>e.capacity_utilization),es=eo.length>0?eo.reduce((e,t)=>e+t,0)/eo.length:0,ei=l.reduce((e,t)=>e+(t.billable_hours??0),0),ec=l.reduce((e,t)=>e+(t.non_billable_hours??0),0),el=d/30,eu=30*(l.reduce((e,t)=>e+(t.payments_value??0),0)/30)-.6*el*30,{data:ed}=await e.from("invoices").select("created_at, paid_at").eq("company_id",t).eq("status","paid").not("paid_at","is",null).gte("paid_at",n.toISOString()).is("deleted_at",null),e_=0,em=0;for(let e of ed??[])e.created_at&&e.paid_at&&(e_+=Math.floor((new Date(e.paid_at).getTime()-new Date(e.created_at).getTime())/864e5),em++);let ep=em>0?e_/em:0,eh=l.reduce((e,t)=>e+(t.invoices_value??0),0),ev=l.reduce((e,t)=>e+(t.payments_value??0),0),{data:eg}=await e.from("customers").select("total_revenue").eq("company_id",t).is("deleted_at",null).gt("total_revenue",0),ef=eg&&eg.length>0?eg.reduce((e,t)=>e+(t.total_revenue??0),0)/eg.length:0,ey=250*(E>0),{data:ew}=await e.from("jobs").select("gross_margin_percent").eq("company_id",t).eq("status","completed").not("gross_margin_percent","is",null).gte("created_at",n.toISOString()).is("deleted_at",null),eR=ew&&ew.length>0?ew.reduce((e,t)=>e+(t.gross_margin_percent??0),0)/ew.length:0,{data:eb}=await e.from("service_agreements").select("monthly_value").eq("company_id",t).eq("status","active"),eE=(eb??[]).reduce((e,t)=>e+(t.monthly_value??0)*12,0),ex=l.reduce((e,t)=>e+(t.preventive_maintenance_count??0),0),eC=p-ex,eS=d/30,eO=c.slice(30,60).reduce((e,t)=>e+(t.total_revenue??0),0),eT=l.reduce((e,t)=>e+(t.churned_customers??0),0),ej={},eq={},eA={};for(let e of l)e.most_common_job_type&&(ej[e.most_common_job_type]=(ej[e.most_common_job_type]??0)+(e.most_common_job_type_count??0)),e.most_common_lead_source&&(eq[e.most_common_lead_source]=(eq[e.most_common_lead_source]??0)+(e.most_common_lead_source_count??0)),e.most_common_payment_method&&(eA[e.most_common_payment_method]=(eA[e.most_common_payment_method]??0)+(e.most_common_payment_method_count??0));let eN=Object.entries(ej).sort((e,t)=>t[1]-e[1])[0],eD=Object.entries(eq).sort((e,t)=>t[1]-e[1])[0],eM=Object.entries(eA).sort((e,t)=>t[1]-e[1])[0];await e.from("analytics_company_summary").upsert({company_id:t,summary_date:a,period_type:"monthly",revenue_total:d,avg_job_value:Math.round(m),revenue_7day_ma:Math.round(_/7),revenue_30day_ma:Math.round(eS),revenue_growth_mom:eO>0?(d-eO)/eO*100:0,jobs_completed:p,jobs_created:h,jobs_cancelled:v,first_time_fix_rate:y,callback_rate:p>0?f/p*100:0,estimates_created:w,estimates_approved:R,estimates_declined:b,estimate_win_rate:w>0?R/w*100:0,pipeline_value:Z,weighted_pipeline_value:Math.round(J),new_customers:E,total_customers:x,churned_customers:eT,customer_retention_rate:x>0?(x-eT)/x*100:100,emails_sent:C,emails_received:S,sms_sent:O,sms_received:T,calls_made:j,calls_received:q,total_communications:C+S+O+T+j+q,avg_response_time_minutes:N,contracts_created:D,contracts_renewed:M,contracts_cancelled:I,active_contracts:P,contract_revenue:U,contract_renewal_rate:D+M>0?M/(D+M)*100:0,active_technicians:k,utilization_rate:F,jobs_per_tech_per_day:z/30,revenue_per_tech:Math.round($),accounts_receivable_total:K,ar_current:L,ar_1_30:G,ar_31_60:V,ar_61_90:X,ar_over_90:W,most_common_job_type:eN?.[0]??null,most_common_lead_source:eD?.[0]??null,most_common_payment_method:eM?.[0]??null,quote_to_close_rate:ee,avg_quote_accuracy:en,capacity_utilization_percent:es,billable_hours_ratio:ei+ec>0?ei/(ei+ec)*100:0,cash_flow_30_day_forecast:eu,cash_flow_60_day_forecast:2*eu,cash_flow_90_day_forecast:3*eu,avg_days_to_payment:ep,collection_rate:eh>0?ev/eh*100:0,customer_acquisition_cost:ey,avg_customer_lifetime_value:ef,ltv_to_cac_ratio:ey>0?ef/ey:0,first_call_resolution_rate:y,technician_utilization_rate:es,revenue_per_technician:k>0?d/k:0,avg_job_profitability:eR,service_agreement_revenue:eE,recurring_revenue_percent:d>0?eE/12/(d/30)*100:0,preventive_vs_reactive_ratio:eC>0?ex/eC:0,updated_at:new Date().toISOString()},{onConflict:"company_id,summary_date,period_type"})}e.s(["GET",()=>R,"maxDuration",0,300],176271);var E=e.i(176271);let x=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cron/calculate-company-summary/route",pathname:"/api/cron/calculate-company-summary",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/cron/calculate-company-summary/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:C,workUnitAsyncStorage:S,serverHooks:O}=x;function T(){return(0,r.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:S})}async function j(e,t,r){x.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/cron/calculate-company-summary/route";y=y.replace(/\/index$/,"")||"/";let w=await x.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:b,nextConfig:E,parsedUrl:C,isDraftMode:S,prerenderManifest:O,routerServerContext:T,isOnDemandRevalidate:j,revalidateOnlyGenerated:q,resolvedPathname:A,clientReferenceManifest:N,serverActionsManifest:D}=w,M=(0,c.normalizeAppPath)(y),I=!!(O.dynamicRoutes[M]||O.routes[A]),P=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,C,!1):t.end("This page could not be found"),null);if(I&&!S){let e=!!O.routes[A],t=O.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await P();throw new g.NoFallbackError}}let U=null;!I||x.isDev||S||(U="/index"===(U=A)?"/":U);let k=!0===x.isDev||!I,H=I&&!k;D&&N&&(0,s.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:N,serverActionsManifest:D,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:D})});let F=e.method||"GET",z=(0,o.getTracer)(),$=z.getActiveScopeSpan(),K={params:b,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>x.onRequestError(e,t,r,T)},sharedContext:{buildId:R}},B=new l.NodeNextRequest(e),L=new l.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let s=async e=>x.handle(G,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=z.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${F} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${y}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),c=async n=>{var o,c;let l=async({previousCacheEntry:a})=>{try{if(!i&&j&&q&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await s(n);e.fetchMetrics=K.renderOpts.fetchMetrics;let c=K.renderOpts.pendingWaitUntil;c&&r.waitUntil&&(r.waitUntil(c),c=void 0);let l=K.renderOpts.collectedTags;if(!I)return await (0,m.sendResponse)(B,L,o,K.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(o.headers);l&&(t[v.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,r=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:j})},T),t}},u=await x.handleResponse({req:e,nextConfig:E,cacheKey:U,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:j,revalidateOnlyGenerated:q,responseGenerator:l,waitUntil:r.waitUntil,isMinimalMode:i});if(!I)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",j?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,p.fromNodeOutgoingHttpHeaders)(u.value.headers);return i&&I||d.delete(v.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(B,L,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};$?await c($):await z.withPropagatedContext(e.headers,()=>z.trace(d.BaseServerSpan.handleRequest,{spanName:`${F} ${y}`,kind:o.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},c))}catch(t){if(t instanceof g.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:j})}),I)throw t;return await (0,m.sendResponse)(B,L,new Response(null,{status:500})),null}}e.s(["handler",()=>j,"patchFetch",()=>T,"routeModule",()=>x,"serverHooks",()=>O,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>S],193220)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_70aec92d.js.map