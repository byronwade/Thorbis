module.exports=[536804,477902,e=>{"use strict";var t=e.i(273568),i=e.i(56418),a=e.i(443608);let r="Stratos-FMS/1.0 (support@stratos.app)",n=a.z.object({title:a.z.string(),link:a.z.string().url(),snippet:a.z.string(),displayLink:a.z.string(),formattedUrl:a.z.string().optional(),pagemap:a.z.object({cse_thumbnail:a.z.array(a.z.object({src:a.z.string(),width:a.z.string().optional(),height:a.z.string().optional()})).optional(),metatags:a.z.array(a.z.record(a.z.string())).optional()}).optional()});a.z.object({results:a.z.array(n),totalResults:a.z.number(),searchTime:a.z.number(),query:a.z.string(),searchType:a.z.enum(["web","news","image"]),nextPageToken:a.z.string().optional()});class s{apiKey;searchEngineId;cache=new Map;cacheTTL=9e5;constructor(){this.apiKey=process.env.GOOGLE_API_KEY||"AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0",this.searchEngineId=process.env.GOOGLE_SEARCH_ENGINE_ID||process.env.GOOGLE_CSE_ID||process.env.NEXT_PUBLIC_GOOGLE_SEARCH_ENGINE_ID}async search(e,t={}){if(!this.apiKey||!this.searchEngineId)return console.warn("Google Custom Search not configured: missing API key or Search Engine ID"),null;let i=this.getCacheKey(e,t,"web"),a=this.cache.get(i);if(a&&Date.now()-a.timestamp<this.cacheTTL)return a.data;try{let a=this.buildParams(e,t),n=`https://www.googleapis.com/customsearch/v1?${a.toString()}`,s=await fetch(n,{headers:{"User-Agent":r}});if(!s.ok){let e=await s.json();return console.error("Google Custom Search error:",e),null}let o=await s.json(),c=this.parseResponse(o,e,"web");return this.cache.set(i,{data:c,timestamp:Date.now()}),c}catch(e){return console.error("Google Custom Search failed:",e),null}}async searchNews(e,t={}){let{daysBack:i=7,...a}=t,r={...a,dateRestrict:`d${i}`,sort:"date"},n=this.getCacheKey(e,r,"news"),s=this.cache.get(n);if(s&&Date.now()-s.timestamp<this.cacheTTL)return s.data;let o=await this.search(e,r);return o&&(o.searchType="news",this.cache.set(n,{data:o,timestamp:Date.now()})),o}async searchImages(e,t={}){if(!this.apiKey||!this.searchEngineId)return console.warn("Google Custom Search not configured"),null;let i=this.getCacheKey(e,t,"image"),a=this.cache.get(i);if(a&&Date.now()-a.timestamp<this.cacheTTL)return a.data;try{let a=this.buildParams(e,t);a.set("searchType","image");let n=`https://www.googleapis.com/customsearch/v1?${a.toString()}`,s=await fetch(n,{headers:{"User-Agent":r}});if(!s.ok){let e=await s.json();return console.error("Google Image Search error:",e),null}let o=await s.json(),c=this.parseImageResponse(o,e);return this.cache.set(i,{data:c,timestamp:Date.now()}),c}catch(e){return console.error("Google Image Search failed:",e),null}}async searchSite(e,t,i={}){return this.search(e,{...i,siteSearch:t})}async searchTechnical(e,t={}){let i=`${e} documentation OR tutorial OR guide`;return this.search(i,t)}buildParams(e,t){let i=new URLSearchParams({key:this.apiKey,cx:this.searchEngineId,q:e});return t.num&&i.set("num",String(Math.min(t.num,10))),t.start&&i.set("start",String(t.start)),t.siteSearch&&i.set("siteSearch",t.siteSearch),t.siteSearchExclude&&(i.set("siteSearch",t.siteSearchExclude),i.set("siteSearchFilter","e")),t.dateRestrict&&i.set("dateRestrict",t.dateRestrict),t.safe&&i.set("safe",t.safe),t.filter&&i.set("filter",t.filter),t.gl&&i.set("gl",t.gl),t.lr&&i.set("lr",t.lr),"date"===t.sort&&i.set("sort","date"),i}parseResponse(e,t,i){let a=e.items||[],r=e.searchInformation;return{results:a.map(e=>({title:e.title||"",link:e.link||"",snippet:e.snippet||"",displayLink:e.displayLink||"",formattedUrl:e.formattedUrl,pagemap:e.pagemap})),totalResults:Number.parseInt(r?.totalResults||"0",10),searchTime:r?.searchTime||0,query:t,searchType:i,nextPageToken:e.queries?e.queries.nextPage?.[0]?.startIndex?.toString():void 0}}parseImageResponse(e,t){let i=e.items||[],a=e.searchInformation;return{results:i.map(e=>({title:e.title||"",link:e.link||"",snippet:e.snippet||"",displayLink:e.displayLink||"",formattedUrl:e.image?.contextLink,pagemap:{cse_thumbnail:[{src:e.image?.thumbnailLink||e.link,width:String(e.image?.thumbnailWidth||""),height:String(e.image?.thumbnailHeight||"")}]}})),totalResults:Number.parseInt(a?.totalResults||"0",10),searchTime:a?.searchTime||0,query:t,searchType:"image"}}getCacheKey(e,t,i){return`search:${i}:${e}:${JSON.stringify(t)}`}isConfigured(){return!!this.apiKey&&!!this.searchEngineId}getConfigStatus(){return{configured:this.isConfigured(),hasApiKey:!!this.apiKey,hasSearchEngineId:!!this.searchEngineId}}clearCache(){this.cache.clear()}}let o=new s;e.i(208069);var c=e.i(679774);let l=(0,c.tool)({description:"List all available database tables and their purposes. Use this to understand what data is available.",inputSchema:(0,c.jsonSchema)({type:"object",properties:{verbose:{type:"boolean",description:"Return detailed output if true"}},required:[]}),execute:async()=>({success:!0,tables:[{name:"customers",description:"Customer records with contact info, revenue, and status"},{name:"team_members",description:"Employee/staff records with roles, contact info, and assignments"},{name:"vendors",description:"Supplier/vendor records with contact and payment info"},{name:"jobs",description:"Work orders and service jobs with status, scheduling, and costs"},{name:"appointments",description:"Scheduled appointments and service calls"},{name:"invoices",description:"Customer invoices with line items and payment status"},{name:"estimates",description:"Price estimates/quotes for customers"},{name:"contracts",description:"Service contracts and agreements"},{name:"payments",description:"Payment records and transactions"},{name:"properties",description:"Customer properties/service locations"},{name:"equipment",description:"Equipment and assets at properties"},{name:"communications",description:"Email, SMS, and call history"},{name:"price_book_items",description:"Service and product pricing catalog"},{name:"materials",description:"Materials and parts inventory"},{name:"purchase_orders",description:"Orders placed with vendors"},{name:"time_entries",description:"Time tracking for jobs and employees"},{name:"expenses",description:"Business expenses and costs"},{name:"service_agreements",description:"Recurring service agreements"},{name:"maintenance_plans",description:"Equipment maintenance schedules"},{name:"notes",description:"Notes attached to various records"},{name:"tags",description:"Tags/labels for organizing records"},{name:"finance_virtual_buckets",description:"Financial savings goals and allocations"},{name:"scheduled_notifications",description:"Scheduled reminders and notifications"}]})}),u=(0,c.tool)({description:"Query any database table to retrieve records. Use this for flexible data access when specific tools don't cover your needs.",inputSchema:a.z.object({table:a.z.string().describe("Table name to query (e.g., 'customers', 'jobs', 'invoices')"),select:a.z.string().optional().default("*").describe("Columns to select (comma-separated or * for all)"),filters:a.z.array(a.z.object({column:a.z.string(),operator:a.z.enum(["eq","neq","gt","gte","lt","lte","like","ilike","in","is"]),value:a.z.union([a.z.string(),a.z.number(),a.z.boolean(),a.z.null(),a.z.array(a.z.string())])})).optional().describe("Filters to apply"),orderBy:a.z.object({column:a.z.string(),ascending:a.z.boolean().default(!1)}).optional().describe("Sort order"),limit:a.z.coerce.number().optional().default(50).describe("Max records to return"),offset:a.z.coerce.number().optional().default(0).describe("Records to skip for pagination")}),execute:async({table:e,select:i,filters:a,orderBy:r,limit:n,offset:s},{companyId:o})=>{let c=(0,t.createServiceSupabaseClient)(),l=["customers","team_members","vendors","jobs","appointments","invoices","estimates","contracts","payments","properties","equipment","communications","price_book_items","materials","purchase_orders","time_entries","expenses","service_agreements","maintenance_plans","notes","tags","finance_virtual_buckets","scheduled_notifications","job_line_items","invoice_line_items","estimate_line_items"];if(!l.includes(e))return{success:!1,error:`Table '${e}' is not accessible. Available: ${l.join(", ")}`};let u=c.from(e).select(i);if(u=u.eq("company_id",o),a)for(let e of a)switch(e.operator){case"eq":u=u.eq(e.column,e.value);break;case"neq":u=u.neq(e.column,e.value);break;case"gt":u=u.gt(e.column,e.value);break;case"gte":u=u.gte(e.column,e.value);break;case"lt":u=u.lt(e.column,e.value);break;case"lte":u=u.lte(e.column,e.value);break;case"like":u=u.like(e.column,e.value);break;case"ilike":u=u.ilike(e.column,e.value);break;case"in":u=u.in(e.column,e.value);break;case"is":u=u.is(e.column,e.value)}r&&(u=u.order(r.column,{ascending:r.ascending})),u=u.range(s,s+n-1);let{data:d,error:m,count:p}=await u;return m?{success:!1,error:m.message}:{success:!0,data:d,count:d?.length||0,table:e}}}),d=(0,c.tool)({description:"Get a specific record by its ID from any table. Use when you need full details of a known record.",inputSchema:a.z.object({table:a.z.string().describe("Table name"),id:a.z.string().describe("Record UUID"),select:a.z.string().optional().default("*").describe("Columns to select")}),execute:async({table:e,id:i,select:a},{companyId:r})=>{let n=(0,t.createServiceSupabaseClient)();if(!["customers","team_members","vendors","jobs","appointments","invoices","estimates","contracts","payments","properties","equipment","communications","price_book_items","materials","purchase_orders","time_entries","expenses","service_agreements","maintenance_plans","notes","finance_virtual_buckets"].includes(e))return{success:!1,error:`Table '${e}' is not accessible`};let{data:s,error:o}=await n.from(e).select(a).eq("id",i).eq("company_id",r).single();return o?{success:!1,error:o.message}:{success:!0,record:s,table:e}}}),m=(0,c.tool)({description:"Get records related to a specific entity (e.g., all jobs for a customer, all invoices for a job).",inputSchema:a.z.object({parentTable:a.z.string().describe("Parent table (e.g., 'customers')"),parentId:a.z.string().describe("Parent record ID"),childTable:a.z.string().describe("Related table to query (e.g., 'jobs')"),foreignKey:a.z.string().describe("Foreign key column in child table (e.g., 'customer_id')"),select:a.z.string().optional().default("*"),limit:a.z.coerce.number().optional().default(50)}),execute:async({parentTable:e,parentId:i,childTable:a,foreignKey:r,select:n,limit:s},{companyId:o})=>{let c=(0,t.createServiceSupabaseClient)(),{data:l,error:u}=await c.from(a).select(n).eq(r,i).eq("company_id",o).limit(s);return u?{success:!1,error:u.message}:{success:!0,data:l,count:l?.length||0,parentTable:e,childTable:a}}}),p=(0,c.tool)({description:"Get a comprehensive overview of the entire company including counts and summaries from all major tables.",inputSchema:a.z.object({verbose:a.z.boolean().optional().describe("Return detailed output if true")}),execute:async(e,{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),[r,n,s,o,c,l,u,d,m,p]=await Promise.all([a.from("customers").select("id, status",{count:"exact"}).eq("company_id",i),a.from("team_members").select("id, status, role",{count:"exact"}).eq("company_id",i),a.from("vendors").select("id, status",{count:"exact"}).eq("company_id",i),a.from("jobs").select("id, status, total_amount",{count:"exact"}).eq("company_id",i),a.from("invoices").select("id, status, total_amount, balance_amount",{count:"exact"}).eq("company_id",i),a.from("estimates").select("id, status, total_amount",{count:"exact"}).eq("company_id",i),a.from("contracts").select("id, status, total_value",{count:"exact"}).eq("company_id",i),a.from("properties").select("id",{count:"exact"}).eq("company_id",i),a.from("equipment").select("id",{count:"exact"}).eq("company_id",i),a.from("appointments").select("id, status",{count:"exact"}).eq("company_id",i)]),g=r.data?.filter(e=>"active"===e.status).length||0,h=n.data?.filter(e=>"active"===e.status).length||0,y=o.data?.filter(e=>["pending","scheduled","in_progress"].includes(e.status)).length||0,f=o.data?.filter(e=>"completed"===e.status).length||0,b=c.data?.filter(e=>["sent","viewed"].includes(e.status)).length||0,_=c.data?.filter(e=>e.balance_amount>0).reduce((e,t)=>e+t.balance_amount,0)||0,v=l.data?.filter(e=>["sent","viewed"].includes(e.status)).length||0,w=u.data?.filter(e=>"active"===e.status).length||0,S={};return n.data?.forEach(e=>{S[e.role||"unassigned"]=(S[e.role||"unassigned"]||0)+1}),{success:!0,overview:{customers:{total:r.count||0,active:g},team:{total:n.count||0,active:h,byRole:S},vendors:{total:s.count||0},jobs:{total:o.count||0,open:y,completed:f},invoices:{total:c.count||0,pending:b,outstandingBalance:_/100},estimates:{total:l.count||0,pending:v},contracts:{total:u.count||0,active:w},properties:{total:d.count||0},equipment:{total:m.count||0},appointments:{total:p.count||0}}}}}),g=(0,c.tool)({description:"Search across multiple tables simultaneously using full-text search with relevance ranking. Use for broad searches when you don't know which entity type contains the information.",inputSchema:a.z.object({query:a.z.string().describe("Search term - supports multi-word queries and typo tolerance"),limit:a.z.coerce.number().optional().default(10).describe("Results per table")}),execute:async({query:e,limit:a},{companyId:r})=>{let n=(0,t.createServiceSupabaseClient)(),s=await (0,i.searchAllEntities)(n,r,e,{limit:a}),o={};s.customers.length>0&&(o.customers=s.customers),s.jobs.length>0&&(o.jobs=s.jobs),s.properties.length>0&&(o.properties=s.properties),s.equipment.length>0&&(o.equipment=s.equipment),s.priceBookItems.length>0&&(o.priceBookItems=s.priceBookItems);let c=Object.values(o).reduce((e,t)=>e+t.length,0);return{success:!0,results:o,totalResults:c,query:e}}}),h=(0,c.tool)({description:"Search for customers by name, email, phone, or address using full-text search with relevance ranking. Supports multi-word queries and typo tolerance.",inputSchema:a.z.object({query:a.z.string().describe("Search query - can be name, email, phone, or address"),limit:a.z.number().optional().default(10).describe("Maximum results to return")}),execute:async({query:e,limit:a},{companyId:r})=>{let n=(0,t.createServiceSupabaseClient)(),s=await (0,i.searchCustomersFullText)(n,r,e,{limit:a});return{success:!0,customers:s,count:s.length}}}),y=(0,c.tool)({description:"Get detailed information about a specific customer including their jobs, invoices, and communication history",inputSchema:a.z.object({customerId:a.z.string().describe("The UUID of the customer")}),execute:async({customerId:e},{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),[r,n,s]=await Promise.all([a.from("customers").select("*").eq("id",e).eq("company_id",i).single(),a.from("jobs").select("id, title, status, total_amount, scheduled_start").eq("customer_id",e).order("created_at",{ascending:!1}).limit(5),a.from("invoices").select("id, invoice_number, status, total_amount, balance_amount, due_date").eq("customer_id",e).order("created_at",{ascending:!1}).limit(5)]);return r.error?{success:!1,error:r.error.message}:{success:!0,customer:r.data,recentJobs:n.data||[],recentInvoices:s.data||[]}}}),f=(0,c.tool)({description:"Create a new customer in the system. Use this when a new customer contacts the business.",inputSchema:a.z.object({firstName:a.z.string().describe("Customer's first name"),lastName:a.z.string().describe("Customer's last name"),email:a.z.string().describe("Customer's email address"),phone:a.z.string().describe("Customer's phone number"),address:a.z.string().optional().describe("Street address"),city:a.z.string().optional().describe("City"),state:a.z.string().optional().describe("State"),zipCode:a.z.string().optional().describe("ZIP code"),source:a.z.string().optional().describe("How the customer found us (referral, google, etc.)")}),execute:async(e,{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),{data:r,error:n}=await a.from("customers").insert({company_id:i,first_name:e.firstName,last_name:e.lastName,display_name:`${e.firstName} ${e.lastName}`,email:e.email,phone:e.phone,address:e.address,city:e.city,state:e.state,zip_code:e.zipCode,source:e.source,status:"active"}).select().single();return n?{success:!1,error:n.message}:{success:!0,customer:r,message:`Created customer ${r.display_name}`}}}),b=(0,c.tool)({description:"Update customer information",inputSchema:a.z.object({customerId:a.z.string().describe("Customer ID to update"),updates:a.z.object({firstName:a.z.string().optional(),lastName:a.z.string().optional(),email:a.z.string().optional(),phone:a.z.string().optional(),address:a.z.string().optional(),city:a.z.string().optional(),state:a.z.string().optional(),zipCode:a.z.string().optional(),notes:a.z.string().optional()}).describe("Fields to update")}),execute:async({customerId:e,updates:i},{companyId:a})=>{let r=(0,t.createServiceSupabaseClient)(),n={};i.firstName&&(n.first_name=i.firstName),i.lastName&&(n.last_name=i.lastName),i.email&&(n.email=i.email),i.phone&&(n.phone=i.phone),i.address&&(n.address=i.address),i.city&&(n.city=i.city),i.state&&(n.state=i.state),i.zipCode&&(n.zip_code=i.zipCode),i.notes&&(n.notes=i.notes),(i.firstName||i.lastName)&&(n.display_name=`${i.firstName||""} ${i.lastName||""}`.trim());let{data:s,error:o}=await r.from("customers").update(n).eq("id",e).eq("company_id",a).select().single();return o?{success:!1,error:o.message}:{success:!0,customer:s}}}),_=(0,c.tool)({description:"Search for team members by name, role, or department. Use this to find employees to assign or contact.",inputSchema:a.z.object({query:a.z.string().optional().describe("Search query - name or email"),role:a.z.string().optional().describe("Filter by role (technician, admin, manager, etc.)"),limit:a.z.coerce.number().optional().default(20)}),execute:async({query:e,role:i,limit:a},{companyId:r})=>{let n=(0,t.createServiceSupabaseClient)().from("team_members").select("id, first_name, last_name, email, phone, role, department, status, hire_date, avatar_url").eq("company_id",r).eq("status","active");e&&(n=n.or(`first_name.ilike.%${e}%,last_name.ilike.%${e}%,email.ilike.%${e}%`)),i&&(n=n.eq("role",i));let{data:s,error:o}=await n.limit(a);return o?{success:!1,error:o.message}:{success:!0,teamMembers:s,count:s?.length||0}}}),v=(0,c.tool)({description:"Get detailed information about a team member including their schedule and performance",inputSchema:a.z.object({teamMemberId:a.z.string().describe("The team member's ID")}),execute:async({teamMemberId:e},{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),[r,n]=await Promise.all([a.from("team_members").select("*").eq("id",e).eq("company_id",i).single(),a.from("jobs").select("id, title, status, scheduled_start, total_amount").eq("assigned_to",e).order("scheduled_start",{ascending:!1}).limit(10)]);return r.error?{success:!1,error:r.error.message}:{success:!0,teamMember:r.data,recentJobs:n.data||[]}}}),w=(0,c.tool)({description:"Send an email to a team member for internal communication, assignments, or updates.",inputSchema:a.z.object({teamMemberId:a.z.string().describe("Team member ID to send email to"),subject:a.z.string().describe("Email subject"),body:a.z.string().describe("Email body (HTML supported)")}),execute:async({teamMemberId:i,subject:a,body:r},{companyId:n})=>{let s=(0,t.createServiceSupabaseClient)(),{data:o}=await s.from("team_members").select("email, first_name, last_name").eq("id",i).eq("company_id",n).single();if(!o?.email)return{success:!1,error:"Team member email not found"};let{sendSendGridEmail:c}=await e.A(433907),l=await c({companyId:n,to:o.email,subject:a,html:r});return l.success?{success:!0,messageId:l.messageId,message:`Email sent to ${o.first_name} ${o.last_name}`}:{success:!1,error:l.error}}}),S=(0,c.tool)({description:"Send an SMS to a team member for urgent updates or assignments.",inputSchema:a.z.object({teamMemberId:a.z.string().describe("Team member ID"),message:a.z.string().max(160).describe("SMS message (max 160 chars)")}),execute:async({teamMemberId:i,message:a},{companyId:r})=>{let n=(0,t.createServiceSupabaseClient)(),{data:s}=await n.from("team_members").select("phone, first_name, last_name").eq("id",i).eq("company_id",r).single();if(!s?.phone)return{success:!1,error:"Team member phone not found"};let{data:o}=await n.from("phone_numbers").select("phone_number").eq("company_id",r).eq("is_primary",!0).single();if(!o)return{success:!1,error:"No company phone configured"};let{sendSms:c}=await e.A(696422),l=await c({from:o.phone_number,to:s.phone,body:a});return l.success?{success:!0,messageId:l.messageSid,message:`SMS sent to ${s.first_name} ${s.last_name}`}:{success:!1,error:l.error}}}),z=(0,c.tool)({description:"Search for vendors/suppliers by name, category, or status",inputSchema:a.z.object({query:a.z.string().optional().describe("Search query - name or contact"),category:a.z.string().optional().describe("Vendor category (supplies, equipment, parts, etc.)"),limit:a.z.coerce.number().optional().default(20)}),execute:async({query:e,category:i,limit:a},{companyId:r})=>{let n=(0,t.createServiceSupabaseClient)().from("vendors").select("id, name, contact_name, email, phone, category, status, account_number, payment_terms").eq("company_id",r);e&&(n=n.or(`name.ilike.%${e}%,contact_name.ilike.%${e}%`)),i&&(n=n.eq("category",i));let{data:s,error:o}=await n.limit(a);return o?{success:!1,error:o.message}:{success:!0,vendors:s,count:s?.length||0}}}),q=(0,c.tool)({description:"Get detailed information about a vendor including purchase history",inputSchema:a.z.object({vendorId:a.z.string().describe("Vendor ID")}),execute:async({vendorId:e},{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),[r,n]=await Promise.all([a.from("vendors").select("*").eq("id",e).eq("company_id",i).single(),a.from("purchase_orders").select("id, po_number, status, total_amount, order_date").eq("vendor_id",e).order("order_date",{ascending:!1}).limit(10)]);return r.error?{success:!1,error:r.error.message}:{success:!0,vendor:r.data,recentPurchases:n.data||[]}}}),I=(0,c.tool)({description:"Send an email to a vendor for orders, inquiries, or communication.",inputSchema:a.z.object({vendorId:a.z.string().describe("Vendor ID"),subject:a.z.string().describe("Email subject"),body:a.z.string().describe("Email body")}),execute:async({vendorId:i,subject:a,body:r},{companyId:n})=>{let s=(0,t.createServiceSupabaseClient)(),{data:o}=await s.from("vendors").select("email, name, contact_name").eq("id",i).eq("company_id",n).single();if(!o?.email)return{success:!1,error:"Vendor email not found"};let{sendSendGridEmail:c}=await e.A(433907),l=await c({companyId:n,to:o.email,subject:a,html:r});return l.success?{success:!0,messageId:l.messageId,message:`Email sent to ${o.name}`}:{success:!1,error:l.error}}}),k=(0,c.tool)({description:"Send an SMS to a vendor contact for urgent communication.",inputSchema:a.z.object({vendorId:a.z.string().describe("Vendor ID"),message:a.z.string().max(160).describe("SMS message")}),execute:async({vendorId:i,message:a},{companyId:r})=>{let n=(0,t.createServiceSupabaseClient)(),{data:s}=await n.from("vendors").select("phone, name").eq("id",i).eq("company_id",r).single();if(!s?.phone)return{success:!1,error:"Vendor phone not found"};let{data:o}=await n.from("phone_numbers").select("phone_number").eq("company_id",r).eq("is_primary",!0).single();if(!o)return{success:!1,error:"No company phone configured"};let{sendSms:c}=await e.A(696422),l=await c({from:o.phone_number,to:s.phone,body:a});return l.success?{success:!0,messageId:l.messageSid,message:`SMS sent to ${s.name}`}:{success:!1,error:l.error}}}),C=(0,c.tool)({description:"Search for service properties by address, customer, or type",inputSchema:a.z.object({query:a.z.string().optional().describe("Address or property name search"),customerId:a.z.string().optional().describe("Filter by customer"),propertyType:a.z.string().optional().describe("Property type (residential, commercial, etc.)"),limit:a.z.coerce.number().optional().default(20)}),execute:async({query:e,customerId:i,propertyType:a,limit:r},{companyId:n})=>{let s=(0,t.createServiceSupabaseClient)().from("properties").select("id, name, address, city, state, zip_code, property_type, customer:customers(display_name)").eq("company_id",n);e&&(s=s.or(`address.ilike.%${e}%,name.ilike.%${e}%`)),i&&(s=s.eq("customer_id",i)),a&&(s=s.eq("property_type",a));let{data:o,error:c}=await s.limit(r);return c?{success:!1,error:c.message}:{success:!0,properties:o,count:o?.length||0}}}),j=(0,c.tool)({description:"Get detailed property information including equipment and service history",inputSchema:a.z.object({propertyId:a.z.string().describe("Property ID")}),execute:async({propertyId:e},{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),[r,n,s]=await Promise.all([a.from("properties").select("*, customer:customers(display_name, phone, email)").eq("id",e).eq("company_id",i).single(),a.from("equipment").select("id, name, model, serial_number, install_date, warranty_expiry, last_service_date").eq("property_id",e).limit(20),a.from("jobs").select("id, title, status, scheduled_start, completed_at").eq("property_id",e).order("scheduled_start",{ascending:!1}).limit(10)]);return r.error?{success:!1,error:r.error.message}:{success:!0,property:r.data,equipment:n.data||[],serviceHistory:s.data||[]}}}),T=(0,c.tool)({description:"Search for equipment/assets by type, customer, or model",inputSchema:a.z.object({query:a.z.string().optional().describe("Equipment name, model, or serial number"),customerId:a.z.string().optional(),equipmentType:a.z.string().optional().describe("Equipment type (HVAC, plumbing, electrical, etc.)"),limit:a.z.coerce.number().optional().default(20)}),execute:async({query:e,customerId:i,equipmentType:a,limit:r},{companyId:n})=>{let s=(0,t.createServiceSupabaseClient)().from("equipment").select("id, name, model, serial_number, equipment_type, install_date, warranty_expiry, last_service_date, property:properties(address, customer:customers(display_name))").eq("company_id",n);e&&(s=s.or(`name.ilike.%${e}%,model.ilike.%${e}%,serial_number.ilike.%${e}%`)),a&&(s=s.eq("equipment_type",a));let{data:o,error:c}=await s.limit(r);return c?{success:!1,error:c.message}:{success:!0,equipment:o,count:o?.length||0}}}),D=(0,c.tool)({description:"Get equipment that is due or overdue for maintenance service",inputSchema:a.z.object({daysAhead:a.z.number().optional().default(30).describe("Look ahead days for upcoming maintenance")}),execute:async({daysAhead:e},{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),r=new Date(Date.now()+24*e*36e5),{data:n,error:s}=await a.from("equipment").select("id, name, model, last_service_date, next_service_date, property:properties(address, customer:customers(display_name, phone, email))").eq("company_id",i).lte("next_service_date",r.toISOString()).order("next_service_date",{ascending:!0}).limit(50);if(s)return{success:!1,error:s.message};let o=n?.filter(e=>new Date(e.next_service_date)<new Date)||[],c=n?.filter(e=>new Date(e.next_service_date)>=new Date)||[];return{success:!0,overdue:o,upcoming:c,overdueCount:o.length,upcomingCount:c.length}}}),x=(0,c.tool)({description:"Search for jobs by title, job number, description, or status using full-text search with relevance ranking. Supports multi-word queries and typo tolerance.",inputSchema:a.z.object({query:a.z.string().optional().describe("Search query - searches job number, title, description"),status:a.z.enum(["pending","scheduled","in_progress","completed","cancelled"]).optional(),customerId:a.z.string().optional(),limit:a.z.coerce.number().optional().default(10)}),execute:async({query:e,status:a,customerId:r,limit:n},{companyId:s})=>{let o=(0,t.createServiceSupabaseClient)();if(e&&!a&&!r){let t=await (0,i.searchJobsFullText)(o,s,e,{limit:n});return{success:!0,jobs:t,count:t.length}}let c=o.from("jobs").select("id, job_number, title, status, total_amount, scheduled_start, scheduled_end, customer:customers(display_name, phone)").eq("company_id",s).is("deleted_at",null);e&&(c=c.or(`title.ilike.%${e}%,job_number.ilike.%${e}%`)),a&&(c=c.eq("status",a)),r&&(c=c.eq("customer_id",r));let{data:l,error:u}=await c.order("scheduled_start",{ascending:!1}).limit(n);return u?{success:!1,error:u.message}:{success:!0,jobs:l,count:l?.length||0}}}),A=(0,c.tool)({description:"Schedule a new appointment for a customer. Use this to book service calls or consultations.",inputSchema:a.z.object({customerId:a.z.string().describe("Customer to schedule for"),propertyId:a.z.string().describe("Property UUID where service will be performed"),title:a.z.string().describe("Appointment title/description"),startTime:a.z.string().describe("Start time in ISO format (YYYY-MM-DDTHH:mm:ss)"),duration:a.z.coerce.number().describe("Duration in minutes"),type:a.z.enum(["service","consultation","estimate","follow_up"]).default("service"),notes:a.z.string().optional().describe("Additional notes for the technician")}),execute:async(e,{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),r=new Date(e.startTime),n=new Date(r.getTime()+6e4*e.duration),{data:s,error:o}=await a.from("appointments").insert({company_id:i,customer_id:e.customerId,property_id:e.propertyId,title:e.title,start_time:r.toISOString(),end_time:n.toISOString(),duration:e.duration,type:e.type,notes:e.notes,status:"scheduled"}).select().single();return o?{success:!1,error:o.message}:{success:!0,appointment:s,message:`Scheduled appointment for ${r.toLocaleString()}`}}}),E=(0,c.tool)({description:"Find available appointment slots for scheduling. Returns available time windows.",inputSchema:a.z.object({date:a.z.string().describe("Date to check (YYYY-MM-DD)"),duration:a.z.coerce.number().default(60).describe("Required duration in minutes")}),execute:async({date:e,duration:i},{companyId:a})=>{let r=(0,t.createServiceSupabaseClient)(),n=new Date(e),s=new Date(n.setHours(8,0,0,0)),o=new Date(n.setHours(18,0,0,0)),{data:c}=await r.from("appointments").select("start_time, end_time").eq("company_id",a).gte("start_time",s.toISOString()).lte("start_time",o.toISOString()).neq("status","cancelled"),l=[],u=s;for(;u<o;){let e=new Date(u.getTime()+6e4*i);!c?.some(t=>{let i=new Date(t.start_time),a=new Date(t.end_time);return u<a&&e>i})&&e<=o&&l.push({start:u.toISOString(),end:e.toISOString()}),u=new Date(u.getTime()+18e5)}return{success:!0,availableSlots:l,date:e}}}),R=(0,c.tool)({description:"Search for invoices by number, customer, or status",inputSchema:a.z.object({query:a.z.string().optional(),status:a.z.enum(["draft","sent","viewed","paid","overdue","cancelled"]).optional(),customerId:a.z.string().optional(),limit:a.z.coerce.number().optional().default(10)}),execute:async({query:e,status:i,customerId:a,limit:r},{companyId:n})=>{let s=(0,t.createServiceSupabaseClient)().from("invoices").select("id, invoice_number, title, status, total_amount, balance_amount, due_date, customer:customers(display_name)").eq("company_id",n);e&&(s=s.ilike("invoice_number",`%${e}%`)),i&&(s=s.eq("status",i)),a&&(s=s.eq("customer_id",a));let{data:o,error:c}=await s.order("created_at",{ascending:!1}).limit(r);return c?{success:!1,error:c.message}:{success:!0,invoices:o,count:o?.length||0}}}),$=(0,c.tool)({description:"Create a new invoice for a customer",inputSchema:a.z.object({customerId:a.z.string().describe("Customer to invoice"),title:a.z.string().describe("Invoice title/description"),lineItems:a.z.array(a.z.object({description:a.z.string(),quantity:a.z.coerce.number(),unitPrice:a.z.coerce.number().describe("Price in cents")})).describe("Line items for the invoice"),dueDate:a.z.string().optional().describe("Due date (YYYY-MM-DD)"),notes:a.z.string().optional()}),execute:async(e,{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),r=e.lineItems.reduce((e,t)=>e+t.quantity*t.unitPrice,0),n=Math.round(.08*r),s=r+n,o=`INV-${Date.now().toString(36).toUpperCase()}`,{data:c,error:l}=await a.from("invoices").insert({company_id:i,customer_id:e.customerId,invoice_number:o,title:e.title,line_items:e.lineItems,subtotal:r,tax_amount:n,total_amount:s,balance_amount:s,due_date:e.dueDate?new Date(e.dueDate).toISOString():null,notes:e.notes,status:"draft"}).select().single();return l?{success:!1,error:l.message}:{success:!0,invoice:c,message:`Created invoice ${o} for $${(s/100).toFixed(2)}`}}}),M=(0,c.tool)({description:"Get a financial summary including revenue, outstanding balances, and trends. Use this to provide business advice.",inputSchema:a.z.object({period:a.z.enum(["today","week","month","quarter","year"]).default("month")}),execute:async({period:e},{companyId:i})=>{let a,r=(0,t.createServiceSupabaseClient)(),n=new Date;switch(e){case"today":a=new Date(n.setHours(0,0,0,0));break;case"week":a=new Date(n.setDate(n.getDate()-7));break;case"month":a=new Date(n.setMonth(n.getMonth()-1));break;case"quarter":a=new Date(n.setMonth(n.getMonth()-3));break;case"year":a=new Date(n.setFullYear(n.getFullYear()-1))}let[s,o,c]=await Promise.all([r.from("invoices").select("total_amount, paid_amount, balance_amount, status").eq("company_id",i).gte("created_at",a.toISOString()),r.from("payments").select("amount").eq("company_id",i).eq("status","completed").gte("created_at",a.toISOString()),r.from("invoices").select("id, invoice_number, balance_amount, due_date, customer:customers(display_name)").eq("company_id",i).eq("status","sent").lt("due_date",new Date().toISOString()).gt("balance_amount",0)]),l=s.data?.reduce((e,t)=>e+t.total_amount,0)||0,u=o.data?.reduce((e,t)=>e+t.amount,0)||0;return{success:!0,period:e,summary:{totalInvoiced:l/100,totalCollected:u/100,totalOutstanding:(s.data?.reduce((e,t)=>e+t.balance_amount,0)||0)/100,invoiceCount:s.data?.length||0,collectionRate:l>0?(u/l*100).toFixed(1):0},overdueInvoices:c.data||[]}}}),U=(0,c.tool)({description:"Get virtual financial buckets for the company. These are savings goals and fund allocations.",inputSchema:a.z.object({verbose:a.z.boolean().optional().describe("Return detailed output if true")}),execute:async(e,{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),{data:r,error:n}=await a.from("finance_virtual_buckets").select("*").eq("company_id",i).eq("is_active",!0);return n?{success:!1,error:n.message}:{success:!0,buckets:r}}}),P=(0,c.tool)({description:"Transfer funds to a virtual bucket for savings goals. This is for financial planning.",inputSchema:a.z.object({bucketId:a.z.string().describe("Target bucket ID"),amount:a.z.coerce.number().describe("Amount to transfer in cents"),note:a.z.string().optional().describe("Note for the transfer")}),execute:async({bucketId:e,amount:i,note:a},{companyId:r})=>{let n=(0,t.createServiceSupabaseClient)(),{data:s,error:o}=await n.from("finance_virtual_buckets").select("*").eq("id",e).eq("company_id",r).single();if(o||!s)return{success:!1,error:"Bucket not found"};let c=(s.current_balance||0)+i,{error:l}=await n.from("finance_virtual_buckets").update({current_balance:c,updated_at:new Date().toISOString()}).eq("id",e);return l?{success:!1,error:l.message}:{success:!0,message:`Transferred $${(i/100).toFixed(2)} to ${s.name}. New balance: $${(c/100).toFixed(2)}`,bucket:{...s,current_balance:c}}}}),O=(0,c.tool)({description:"Send an email to a customer. Use this for follow-ups, reminders, or responding to inquiries.",inputSchema:a.z.object({to:a.z.string().describe("Recipient email address"),subject:a.z.string().describe("Email subject line"),body:a.z.string().describe("Email body content (HTML supported)"),customerId:a.z.string().optional().describe("Associated customer UUID for tracking")}),execute:async(i,{companyId:a})=>{let{sendSendGridEmail:r}=await e.A(433907);if(!r)return{success:!1,error:"Email service not configured"};let n=await r({companyId:a,to:i.to,subject:i.subject,html:i.body});if(!n.success)return{success:!1,error:n.error};let s=(0,t.createServiceSupabaseClient)();return await s.from("communications").insert({company_id:a,customer_id:i.customerId,type:"email",direction:"outbound",to_address:i.to,subject:i.subject,body:i.body,body_html:i.body,status:"sent",sent_at:new Date().toISOString(),provider_message_id:data?.id}),{success:!0,messageId:data?.id,message:`Email sent to ${i.to}`}}}),L=(0,c.tool)({description:"Send an SMS text message to a customer. Use for appointment reminders or quick updates.",inputSchema:a.z.object({to:a.z.string().describe("Phone number (format: +1XXXXXXXXXX)"),message:a.z.string().max(160).describe("Message content (max 160 characters)"),customerId:a.z.string().optional().describe("Associated customer ID")}),execute:async(i,{companyId:a})=>{let r=(0,t.createServiceSupabaseClient)(),{data:n}=await r.from("phone_numbers").select("phone_number, twilio_phone_sid").eq("company_id",a).eq("is_primary",!0).single();if(!n)return{success:!1,error:"No phone number configured for company"};let{sendSms:s}=await e.A(696422),o=await s({from:n.phone_number,to:i.to,text:i.message});return o.success?(await r.from("communications").insert({company_id:a,customer_id:i.customerId,type:"sms",direction:"outbound",to_address:i.to,body:i.message,status:"sent",sent_at:new Date().toISOString(),twilio_message_sid:o.messageSid}),{success:!0,messageId:o.messageSid,message:`SMS sent to ${i.to}`}):{success:!1,error:o.error}}}),N=(0,c.tool)({description:"Initiate a phone call to a customer. The call will be connected through the business phone system.",inputSchema:a.z.object({to:a.z.string().describe("Phone number to call (format: +1XXXXXXXXXX)"),customerId:a.z.string().optional().describe("Associated customer ID"),reason:a.z.string().optional().describe("Reason for the call (for logging)")}),execute:async(i,{companyId:a})=>{let r=(0,t.createServiceSupabaseClient)(),{data:n}=await r.from("phone_numbers").select("phone_number, twilio_phone_sid").eq("company_id",a).eq("is_primary",!0).single();if(!n)return{success:!1,error:"No phone number configured"};let{initiateCall:s}=await e.A(500438),o=await s({connectionId:n.twilio_phone_sid,from:n.phone_number,to:i.to});return o.success?(await r.from("communications").insert({company_id:a,customer_id:i.customerId,type:"call",direction:"outbound",to_address:i.to,from_address:n.phone_number,body:i.reason||"Outbound call",status:"pending",telnyx_call_control_id:o.callControlId}),{success:!0,callControlId:o.callControlId,message:`Call initiated to ${i.to}`}):{success:!1,error:o.error}}}),F=(0,c.tool)({description:"Get communication history with a customer (calls, texts, emails)",inputSchema:a.z.object({customerId:a.z.string().describe("Customer ID to get history for"),type:a.z.enum(["all","email","sms","call"]).optional().default("all"),limit:a.z.coerce.number().optional().default(20)}),execute:async({customerId:e,type:i,limit:a},{companyId:r})=>{let n=(0,t.createServiceSupabaseClient)().from("communications").select("*").eq("company_id",r).eq("customer_id",e);"all"!==i&&(n=n.eq("type",i));let{data:s,error:o}=await n.order("created_at",{ascending:!1}).limit(a);return o?{success:!1,error:o.message}:{success:!0,communications:s}}}),G=(0,c.tool)({description:"Get key business metrics for the dashboard. Use this to provide business insights and recommendations.",inputSchema:a.z.object({verbose:a.z.boolean().optional().describe("Return detailed output if true")}),execute:async(e,{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),r=new Date,n=new Date(r.setDate(r.getDate()-30)),[s,o,c]=await Promise.all([a.from("customers").select("id",{count:"exact",head:!0}).eq("company_id",i).eq("status","active"),a.from("jobs").select("id, status, total_amount").eq("company_id",i).gte("created_at",n.toISOString()),a.from("invoices").select("id, total_amount, balance_amount, status").eq("company_id",i).gte("created_at",n.toISOString())]),l=o.data?.filter(e=>"completed"===e.status)||[],u=c.data?.filter(e=>"sent"===e.status&&e.balance_amount>0)||[];return{success:!0,metrics:{activeCustomers:s.count||0,jobsLast30Days:o.data?.length||0,completedJobsLast30Days:l.length,jobCompletionRate:o.data?.length?(l.length/o.data.length*100).toFixed(1):0,invoicesLast30Days:c.data?.length||0,overdueInvoiceCount:u.length,totalOutstanding:u.reduce((e,t)=>e+t.balance_amount,0)/100}}}}),B=(0,c.tool)({description:"Get proactive business insights and recommendations. Use this to help owners make decisions.",inputSchema:a.z.object({verbose:a.z.boolean().optional().describe("Return detailed output if true")}),execute:async(e,{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),[r,n,s]=await Promise.all([a.from("invoices").select("id, invoice_number, balance_amount, due_date, customer:customers(display_name, phone, email)").eq("company_id",i).eq("status","sent").lt("due_date",new Date().toISOString()).gt("balance_amount",0).limit(5),a.from("customers").select("id, display_name, phone, email, last_job_date").eq("company_id",i).eq("status","active").lt("last_job_date",new Date(Date.now()-7776e6).toISOString()).limit(5),a.from("appointments").select("id, title, start_time, customer:customers(display_name, phone)").eq("company_id",i).eq("status","scheduled").gte("start_time",new Date().toISOString()).lt("start_time",new Date(Date.now()+864e5).toISOString()).limit(10)]),o=[];if(r.data&&r.data.length>0){let e=r.data.reduce((e,t)=>e+t.balance_amount,0);o.push({type:"overdue_invoices",severity:"high",title:`${r.data.length} overdue invoices totaling $${(e/100).toFixed(2)}`,recommendation:"Consider sending payment reminders or initiating collection calls",data:r.data})}return n.data&&n.data.length>0&&o.push({type:"inactive_customers",severity:"medium",title:`${n.data.length} customers haven't had service in 90+ days`,recommendation:"Send re-engagement emails or offer maintenance service promotions",data:n.data}),s.data&&s.data.length>0&&o.push({type:"upcoming_appointments",severity:"info",title:`${s.data.length} appointments scheduled for tomorrow`,recommendation:"Consider sending reminder messages to customers",data:s.data}),{success:!0,insights:o}}}),H=(0,c.tool)({description:"Schedule a reminder email or SMS to be sent at a specific time. Use for appointment reminders, payment reminders, or follow-ups.",inputSchema:a.z.object({recipientType:a.z.enum(["customer","team_member","vendor"]).describe("Type of recipient"),recipientId:a.z.string().describe("ID of the recipient"),channel:a.z.enum(["email","sms","both"]).describe("Communication channel"),subject:a.z.string().optional().describe("Email subject (for email channel)"),message:a.z.string().describe("Message content"),sendAt:a.z.string().describe("When to send (ISO format)"),relatedTo:a.z.object({type:a.z.enum(["job","invoice","appointment","estimate"]).optional(),id:a.z.string().optional()}).optional().describe("Related entity")}),execute:async(e,{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),r=null,n=null,s="";if("customer"===e.recipientType){let{data:t}=await a.from("customers").select("email, phone, display_name").eq("id",e.recipientId).eq("company_id",i).single();t&&(r=t.email,n=t.phone,s=t.display_name)}else if("team_member"===e.recipientType){let{data:t}=await a.from("team_members").select("email, phone, first_name, last_name").eq("id",e.recipientId).eq("company_id",i).single();t&&(r=t.email,n=t.phone,s=`${t.first_name} ${t.last_name}`)}else if("vendor"===e.recipientType){let{data:t}=await a.from("vendors").select("email, phone, name").eq("id",e.recipientId).eq("company_id",i).single();t&&(r=t.email,n=t.phone,s=t.name)}if(!r&&!n)return{success:!1,error:"Recipient contact information not found"};let{data:o,error:c}=await a.from("scheduled_notifications").insert({company_id:i,recipient_type:e.recipientType,recipient_id:e.recipientId,recipient_name:s,recipient_email:r,recipient_phone:n,channel:e.channel,subject:e.subject,message:e.message,scheduled_at:e.sendAt,related_type:e.relatedTo?.type,related_id:e.relatedTo?.id,status:"scheduled"}).select().single();return c?{success:!1,error:c.message}:{success:!0,reminder:o,message:`Reminder scheduled for ${s} at ${new Date(e.sendAt).toLocaleString()}`}}}),W=(0,c.tool)({description:"Cancel a scheduled reminder",inputSchema:a.z.object({reminderId:a.z.string().describe("ID of the reminder to cancel")}),execute:async({reminderId:e},{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),{error:r}=await a.from("scheduled_notifications").update({status:"cancelled"}).eq("id",e).eq("company_id",i);return r?{success:!1,error:r.message}:{success:!0,message:"Reminder cancelled successfully"}}}),V=(0,c.tool)({description:"Get list of scheduled reminders for a customer, job, or entity",inputSchema:a.z.object({recipientType:a.z.enum(["customer","team_member","vendor"]).optional(),recipientId:a.z.string().optional(),relatedType:a.z.enum(["job","invoice","appointment","estimate"]).optional(),relatedId:a.z.string().optional(),status:a.z.enum(["scheduled","sent","cancelled","failed"]).optional().default("scheduled")}),execute:async(e,{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)().from("scheduled_notifications").select("*").eq("company_id",i);e.recipientType&&(a=a.eq("recipient_type",e.recipientType)),e.recipientId&&(a=a.eq("recipient_id",e.recipientId)),e.relatedType&&(a=a.eq("related_type",e.relatedType)),e.relatedId&&(a=a.eq("related_id",e.relatedId)),e.status&&(a=a.eq("status",e.status));let{data:r,error:n}=await a.order("scheduled_at",{ascending:!0});return n?{success:!1,error:n.message}:{success:!0,reminders:r,count:r?.length||0}}}),Y=(0,c.tool)({description:"Send an immediate notification to a customer, team member, or vendor. Use for urgent updates.",inputSchema:a.z.object({recipientType:a.z.enum(["customer","team_member","vendor"]).describe("Type of recipient"),recipientId:a.z.string().describe("ID of the recipient"),channel:a.z.enum(["email","sms","both"]).describe("Communication channel"),subject:a.z.string().optional().describe("Email subject"),message:a.z.string().describe("Message content"),priority:a.z.enum(["normal","high","urgent"]).optional().default("normal")}),execute:async(i,{companyId:a})=>{let r=(0,t.createServiceSupabaseClient)(),n={},s=null,o=null,c="";if("customer"===i.recipientType){let{data:e}=await r.from("customers").select("email, phone, display_name").eq("id",i.recipientId).single();e&&(s=e.email,o=e.phone,c=e.display_name)}else if("team_member"===i.recipientType){let{data:e}=await r.from("team_members").select("email, phone, first_name, last_name").eq("id",i.recipientId).single();e&&(s=e.email,o=e.phone,c=`${e.first_name} ${e.last_name}`)}else if("vendor"===i.recipientType){let{data:e}=await r.from("vendors").select("email, phone, name").eq("id",i.recipientId).single();e&&(s=e.email,o=e.phone,c=e.name)}if(("email"===i.channel||"both"===i.channel)&&s){let{sendSendGridEmail:t}=await e.A(433907);t&&(n.email=await t({companyId:a,to:s,subject:i.subject||"Notification",html:i.message}))}if(("sms"===i.channel||"both"===i.channel)&&o){let{data:t}=await r.from("phone_numbers").select("phone_number").eq("company_id",a).eq("is_primary",!0).single();if(t){let{sendSms:r}=await e.A(696422),s=await r({companyId:a,from:t.phone_number,to:o,body:i.message.slice(0,160)});n.sms=s.success?{success:!0,messageId:s.messageSid}:{success:!1,error:s.error}}}return{success:!0,results:n,message:`Notification sent to ${c}`}}}),J=(0,c.tool)({description:"Get detailed job costing report including labor, materials, and profit margins",inputSchema:a.z.object({jobId:a.z.string().optional().describe("Specific job UUID, or omit for summary"),period:a.z.enum(["week","month","quarter","year"]).optional().default("month"),limit:a.z.coerce.number().optional().default(20)}),execute:async({jobId:e,period:i,limit:a},{companyId:r})=>{let n,s=(0,t.createServiceSupabaseClient)();if(e){let{data:t,error:i}=await s.from("jobs").select("*, customer:customers(display_name), line_items, labor_cost, material_cost, total_amount").eq("id",e).eq("company_id",r).single();if(i)return{success:!1,error:i.message};let a=t?.labor_cost||0,n=t?.material_cost||0,o=t?.total_amount||0,c=o-a-n;return{success:!0,job:{...t,costing:{laborCost:a/100,materialCost:n/100,totalCost:(a+n)/100,revenue:o/100,profit:c/100,marginPercent:(o>0?c/o*100:0).toFixed(1)}}}}let o=new Date;switch(i){case"week":n=new Date(o.setDate(o.getDate()-7));break;case"month":n=new Date(o.setMonth(o.getMonth()-1));break;case"quarter":n=new Date(o.setMonth(o.getMonth()-3));break;case"year":n=new Date(o.setFullYear(o.getFullYear()-1))}let{data:c}=await s.from("jobs").select("id, title, labor_cost, material_cost, total_amount, status, completed_at, customer:customers(display_name)").eq("company_id",r).eq("status","completed").gte("completed_at",n.toISOString()).order("completed_at",{ascending:!1}).limit(a),l={totalJobs:c?.length||0,totalRevenue:(c?.reduce((e,t)=>e+(t.total_amount||0),0)||0)/100,totalLaborCost:(c?.reduce((e,t)=>e+(t.labor_cost||0),0)||0)/100,totalMaterialCost:(c?.reduce((e,t)=>e+(t.material_cost||0),0)||0)/100,totalProfit:0,averageMargin:0};return l.totalProfit=l.totalRevenue-l.totalLaborCost-l.totalMaterialCost,l.averageMargin=l.totalRevenue>0?l.totalProfit/l.totalRevenue*100:0,{success:!0,period:i,summary:l,jobs:c}}}),K=(0,c.tool)({description:"Get revenue breakdown by customer, service type, or time period",inputSchema:a.z.object({groupBy:a.z.enum(["customer","service_type","month","week"]).default("month"),period:a.z.enum(["month","quarter","year"]).default("quarter"),limit:a.z.coerce.number().optional().default(20)}),execute:async({groupBy:e,period:i,limit:a},{companyId:r})=>{let n,s=(0,t.createServiceSupabaseClient)(),o=new Date;switch(i){case"month":n=new Date(o.setMonth(o.getMonth()-1));break;case"quarter":n=new Date(o.setMonth(o.getMonth()-3));break;case"year":n=new Date(o.setFullYear(o.getFullYear()-1))}let{data:c}=await s.from("invoices").select("id, total_amount, paid_amount, created_at, customer:customers(id, display_name), job:jobs(service_type)").eq("company_id",r).eq("status","paid").gte("created_at",n.toISOString()),l={};c?.forEach(t=>{let i="",a="";if("customer"===e)i=t.customer?.id||"unknown",a=t.customer?.display_name||"Unknown";else if("service_type"===e)i=t.job?.service_type||"general",a=t.job?.service_type||"General";else if("month"===e){let e=new Date(t.created_at);i=`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}`,a=e.toLocaleDateString("en-US",{year:"numeric",month:"short"})}else if("week"===e){let e=new Date(t.created_at),r=new Date(e.setDate(e.getDate()-e.getDay()));i=r.toISOString().split("T")[0],a=`Week of ${r.toLocaleDateString()}`}l[i]||(l[i]={label:a,revenue:0,count:0}),l[i].revenue+=(t.paid_amount||0)/100,l[i].count+=1});let u=Object.values(l).sort((e,t)=>t.revenue-e.revenue).slice(0,a),d=u.reduce((e,t)=>e+t.revenue,0);return{success:!0,groupBy:e,period:i,breakdown:u,totalRevenue:d}}}),X=(0,c.tool)({description:"Get accounts receivable aging report showing outstanding invoices by age (30/60/90+ days)",inputSchema:a.z.object({verbose:a.z.boolean().optional().describe("Return detailed output if true")}),execute:async(e,{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),r=new Date,{data:n}=await a.from("invoices").select("id, invoice_number, balance_amount, due_date, created_at, customer:customers(display_name, phone, email)").eq("company_id",i).in("status",["sent","viewed"]).gt("balance_amount",0),s={current:{amount:0,count:0,invoices:[]},days30:{amount:0,count:0,invoices:[]},days60:{amount:0,count:0,invoices:[]},days90Plus:{amount:0,count:0,invoices:[]}};n?.forEach(e=>{let t=new Date(e.due_date),i=Math.floor((r.getTime()-t.getTime())/864e5);i<=0?(s.current.amount+=e.balance_amount,s.current.count+=1,s.current.invoices?.push(e)):i<=30?(s.days30.amount+=e.balance_amount,s.days30.count+=1,s.days30.invoices?.push(e)):i<=60?(s.days60.amount+=e.balance_amount,s.days60.count+=1,s.days60.invoices?.push(e)):(s.days90Plus.amount+=e.balance_amount,s.days90Plus.count+=1,s.days90Plus.invoices?.push(e))}),Object.keys(s).forEach(e=>{s[e].amount=s[e].amount/100});let o=s.current.amount+s.days30.amount+s.days60.amount+s.days90Plus.amount;return{success:!0,aging:s,totalOutstanding:o,totalInvoices:n?.length||0}}}),Q=(0,c.tool)({description:"Get team member performance metrics including jobs completed, revenue generated, and ratings",inputSchema:a.z.object({teamMemberId:a.z.string().optional().describe("Specific team member UUID, or omit for all"),period:a.z.enum(["week","month","quarter","year"]).default("month")}),execute:async({teamMemberId:e,period:i},{companyId:a})=>{let r,n=(0,t.createServiceSupabaseClient)(),s=new Date;switch(i){case"week":r=new Date(s.setDate(s.getDate()-7));break;case"month":r=new Date(s.setMonth(s.getMonth()-1));break;case"quarter":r=new Date(s.setMonth(s.getMonth()-3));break;case"year":r=new Date(s.setFullYear(s.getFullYear()-1))}let o=n.from("jobs").select("id, assigned_to, status, total_amount, completed_at").eq("company_id",a).gte("created_at",r.toISOString());e&&(o=o.eq("assigned_to",e));let{data:c}=await o,{data:l}=await n.from("team_members").select("id, first_name, last_name, role").eq("company_id",a).eq("status","active"),u={};return l?.forEach(e=>{u[e.id]={name:`${e.first_name} ${e.last_name}`,role:e.role,jobsAssigned:0,jobsCompleted:0,completionRate:0,revenue:0}}),c?.forEach(e=>{e.assigned_to&&u[e.assigned_to]&&(u[e.assigned_to].jobsAssigned+=1,"completed"===e.status&&(u[e.assigned_to].jobsCompleted+=1,u[e.assigned_to].revenue+=(e.total_amount||0)/100))}),Object.values(u).forEach(e=>{e.completionRate=e.jobsAssigned>0?e.jobsCompleted/e.jobsAssigned*100:0}),{success:!0,period:i,performance:Object.values(u).sort((e,t)=>t.revenue-e.revenue)}}}),Z=(0,c.tool)({description:"Get customer lifetime value (CLV) analysis showing total revenue and engagement per customer",inputSchema:a.z.object({customerId:a.z.string().optional().describe("Specific customer UUID, or omit for top customers"),limit:a.z.coerce.number().optional().default(20)}),execute:async({customerId:e,limit:i},{companyId:a})=>{let r=(0,t.createServiceSupabaseClient)();if(e){let[t,i,n]=await Promise.all([r.from("customers").select("*").eq("id",e).eq("company_id",a).single(),r.from("invoices").select("total_amount, paid_amount, status, created_at").eq("customer_id",e),r.from("jobs").select("id, status, completed_at").eq("customer_id",e)]);if(t.error)return{success:!1,error:t.error.message};let s=(i.data?.filter(e=>"paid"===e.status).reduce((e,t)=>e+(t.paid_amount||0),0)||0)/100,o=n.data?.length||0,c=i.data?.sort((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime())[0],l=new Date(c?c.created_at:t.data.created_at),u=Math.max(1,Math.floor((Date.now()-l.getTime())/2592e6));return{success:!0,customer:t.data,clv:{totalRevenue:s,jobCount:o,averageJobValue:o>0?s/o:0,customerSince:l.toISOString(),monthsAsCustomer:u,monthlyAverageRevenue:s/u}}}let{data:n}=await r.from("customers").select("id, display_name, total_revenue, job_count, created_at").eq("company_id",a).eq("status","active").order("total_revenue",{ascending:!1}).limit(i);return{success:!0,topCustomers:n?.map(e=>({...e,totalRevenue:(e.total_revenue||0)/100,averageJobValue:e.job_count>0?(e.total_revenue||0)/100/e.job_count:0}))}}}),ee=(0,c.tool)({description:"Search for estimates by customer, status, or amount",inputSchema:a.z.object({query:a.z.string().optional(),status:a.z.enum(["draft","sent","viewed","approved","rejected","expired"]).optional(),customerId:a.z.string().optional(),limit:a.z.coerce.number().optional().default(20)}),execute:async({query:e,status:i,customerId:a,limit:r},{companyId:n})=>{let s=(0,t.createServiceSupabaseClient)().from("estimates").select("id, estimate_number, title, status, total_amount, valid_until, customer:customers(display_name)").eq("company_id",n);e&&(s=s.ilike("estimate_number",`%${e}%`)),i&&(s=s.eq("status",i)),a&&(s=s.eq("customer_id",a));let{data:o,error:c}=await s.order("created_at",{ascending:!1}).limit(r);return c?{success:!1,error:c.message}:{success:!0,estimates:o,count:o?.length||0}}}),et=(0,c.tool)({description:"Search for contracts by customer, status, or type",inputSchema:a.z.object({query:a.z.string().optional(),status:a.z.enum(["draft","sent","active","expired","cancelled"]).optional(),customerId:a.z.string().optional(),limit:a.z.coerce.number().optional().default(20)}),execute:async({query:e,status:i,customerId:a,limit:r},{companyId:n})=>{let s=(0,t.createServiceSupabaseClient)().from("contracts").select("id, contract_number, title, status, total_value, start_date, end_date, customer:customers(display_name)").eq("company_id",n);e&&(s=s.ilike("contract_number",`%${e}%`)),i&&(s=s.eq("status",i)),a&&(s=s.eq("customer_id",a));let{data:o,error:c}=await s.order("created_at",{ascending:!1}).limit(r);return c?{success:!1,error:c.message}:{success:!0,contracts:o,count:o?.length||0}}}),ei=(0,c.tool)({description:"Store a fact, preference, or important information about an entity (customer, job, property, etc.) for future reference. Use this to remember important details that should persist across conversations.",inputSchema:a.z.object({content:a.z.string().describe("The fact or information to remember"),memoryType:a.z.enum(["fact","preference","interaction","context","entity","procedure","feedback"]).describe("Type of memory"),entityType:a.z.enum(["customer","job","property","equipment","invoice","estimate","team_member"]).optional().describe("Type of entity this memory relates to"),entityId:a.z.string().optional().describe("ID of the related entity"),importance:a.z.enum(["low","medium","high"]).default("medium").describe("How important is this memory"),tags:a.z.array(a.z.string()).optional().describe("Tags to categorize the memory")}),execute:async({content:t,memoryType:i,entityType:a,entityId:r,importance:n,tags:s},{companyId:o,userId:c})=>{let{storeMemory:l}=await e.A(872412);return{success:!0,message:"Memory stored successfully",memoryId:await l(o,c||"system",{content:t,memoryType:i,entityType:a,entityId:r,importance:{low:.3,medium:.6,high:.9}[n],tags:s,sourceType:"agent"}),summary:`Remembered: "${t.substring(0,50)}..."`}}}),ea=(0,c.tool)({description:"Search through stored memories using natural language. Use this to recall facts, preferences, or context about customers, jobs, or other entities.",inputSchema:a.z.object({query:a.z.string().describe("Natural language search query (e.g., 'customer preferences for Johnson family')"),entityType:a.z.enum(["customer","job","property","equipment","invoice","estimate","team_member"]).optional().describe("Filter to specific entity type"),entityId:a.z.string().optional().describe("Filter to specific entity UUID"),memoryTypes:a.z.array(a.z.enum(["fact","preference","interaction","context","entity","procedure","feedback"])).optional().describe("Filter by memory types"),limit:a.z.coerce.number().optional().default(5).describe("Max memories to return")}),execute:async({query:t,entityType:i,entityId:a,memoryTypes:r,limit:n},{companyId:s})=>{let{searchMemories:o}=await e.A(872412),c=await o(s,t,{entityType:i,entityId:a,memoryTypes:r,limit:n,minSimilarity:.5});return 0===c.length?{success:!0,message:"No relevant memories found",memories:[]}:{success:!0,message:`Found ${c.length} relevant memories`,memories:c.map(e=>({content:e.content,type:e.memoryType,relevance:Math.round(100*e.similarity)+"%",entityType:e.entityType,createdAt:e.createdAt}))}}}),er=(0,c.tool)({description:"Retrieve all stored memories about a specific entity (customer, job, property, etc.). Use this before interacting with a customer or job to get full context.",inputSchema:a.z.object({entityType:a.z.enum(["customer","job","property","equipment","invoice","estimate","team_member"]).describe("Type of entity"),entityId:a.z.string().describe("Entity ID"),memoryTypes:a.z.array(a.z.enum(["fact","preference","interaction","context","entity","procedure","feedback"])).optional().describe("Filter by memory types"),limit:a.z.coerce.number().optional().default(20).describe("Max memories to return")}),execute:async({entityType:t,entityId:i,memoryTypes:a,limit:r},{companyId:n})=>{let{getEntityMemories:s}=await e.A(872412),o=await s(n,t,i,{types:a,limit:r});if(0===o.length)return{success:!0,message:`No memories stored for this ${t}`,memories:[]};let c={};for(let e of o)c[e.memory_type]||(c[e.memory_type]=[]),c[e.memory_type].push({content:e.content,importance:e.importance});return{success:!0,message:`Found ${o.length} memories for ${t}`,memoriesByType:c,totalCount:o.length}}}),en=(0,c.tool)({description:"Automatically recall relevant memories and context based on what's being discussed. Use this at the start of conversations or when switching topics to get background information.",inputSchema:a.z.object({topic:a.z.string().describe("The current topic or context (e.g., 'scheduling job for Smith residence', 'invoice payment issue')"),customerName:a.z.string().optional().describe("Customer name if known"),jobId:a.z.string().optional().describe("Job UUID if discussing a specific job")}),execute:async({topic:i,customerName:a,jobId:r},{companyId:n})=>{let{searchMemories:s}=await e.A(872412),o=(0,t.createServiceSupabaseClient)(),c={memories:[]};if(c.memories=(await s(n,i,{limit:5,minSimilarity:.4})).map(e=>({content:e.content,type:e.memoryType,relevance:Math.round(100*e.similarity)+"%"})),a){let{data:e}=await o.from("customers").select("id, name, notes").eq("company_id",n).ilike("name",`%${a}%`).limit(1).single();if(e)for(let t of(c.customer=e,await s(n,`${a} customer preferences`,{entityType:"customer",entityId:e.id,limit:3})))c.memories.some(e=>e.content===t.content)||c.memories.push({content:t.content,type:t.memoryType,relevance:Math.round(100*t.similarity)+"%"})}if(r){let{data:e}=await o.from("jobs").select("id, title, status, description").eq("id",r).eq("company_id",n).single();e&&(c.job={id:e.id,title:e.title,status:e.status})}return{success:!0,topic:i,context:c,summary:c.memories.length>0?`Found ${c.memories.length} relevant memories for context`:"No specific memories found, but retrieved available entity info"}}}),es=(0,c.tool)({description:"Search across all customer communications (calls, emails, SMS) to find specific conversations, topics, or issues discussed. Great for finding 'what did the customer say about...'",inputSchema:a.z.object({query:a.z.string().describe("Search query (e.g., 'water heater issue', 'preferred time morning')"),channel:a.z.enum(["email","sms","call","all"]).optional().default("all").describe("Filter by communication channel"),customerId:a.z.string().optional().describe("Filter to specific customer UUID"),direction:a.z.enum(["inbound","outbound","all"]).optional().default("all").describe("Filter by direction"),limit:a.z.coerce.number().optional().default(10).describe("Max results")}),execute:async({query:e,channel:i,customerId:a,direction:r,limit:n},{companyId:s})=>{let o=(0,t.createServiceSupabaseClient)().from("communications").select(`
				id, type, channel, direction, subject, body_plain,
				call_transcript, call_sentiment, from_name, to_name,
				customer_id, created_at,
				customer:customers(id, name)
			`).eq("company_id",s).is("deleted_at",null).order("created_at",{ascending:!1}).limit(n);"all"!==i&&(o=o.eq("channel",i)),a&&(o=o.eq("customer_id",a)),"all"!==r&&(o=o.eq("direction",r)),o=o.or(`body_plain.ilike.%${e}%,call_transcript.ilike.%${e}%,subject.ilike.%${e}%`);let{data:c,error:l}=await o;return l?{success:!1,error:l.message}:{success:!0,message:`Found ${c?.length||0} communications matching "${e}"`,results:c?.map(e=>({id:e.id,channel:e.channel,direction:e.direction,subject:e.subject,preview:(e.body_plain||e.call_transcript||"").substring(0,200),sentiment:e.call_sentiment,customerName:e.customer?.name,date:e.created_at}))}}}),eo=(0,c.tool)({description:"Get the full transcript of a phone call along with extracted insights. Use when you need to review what was discussed in a specific call.",inputSchema:a.z.object({communicationId:a.z.string().describe("The communication UUID of the call")}),execute:async({communicationId:e},{companyId:i})=>{let a=(0,t.createServiceSupabaseClient)(),{data:r,error:n}=await a.from("communications").select(`
				id, type, channel, direction, call_duration, call_transcript,
				call_sentiment, call_recording_url, from_name, to_name,
				customer_id, created_at,
				customer:customers(id, name, email, phone)
			`).eq("id",e).eq("company_id",i).single();return n?{success:!1,error:n.message}:r?.call_transcript?{success:!0,call:{id:r.id,direction:r.direction,duration:r.call_duration?`${Math.floor(r.call_duration/60)}m ${r.call_duration%60}s`:"Unknown",sentiment:r.call_sentiment,customerName:r.customer?.name,date:r.created_at,transcript:r.call_transcript,hasRecording:!!r.call_recording_url}}:{success:!1,error:"No transcript available for this communication"}}}),ec=(0,c.tool)({description:"Search through voicemail transcriptions to find messages about specific topics or from specific customers.",inputSchema:a.z.object({query:a.z.string().optional().describe("Search query for transcription content"),customerId:a.z.string().optional().describe("Filter to specific customer UUID"),urgentOnly:a.z.boolean().optional().default(!1).describe("Only show urgent voicemails"),unreadOnly:a.z.boolean().optional().default(!1).describe("Only show unread voicemails"),limit:a.z.coerce.number().optional().default(10).describe("Max results")}),execute:async({query:e,customerId:i,urgentOnly:a,unreadOnly:r,limit:n},{companyId:s})=>{let o=(0,t.createServiceSupabaseClient)().from("voicemails").select(`
				id, from_number, duration, transcription, transcription_confidence,
				is_read, is_urgent, received_at, customer_id,
				customer:customers(id, name)
			`).eq("company_id",s).is("deleted_at",null).order("received_at",{ascending:!1}).limit(n);i&&(o=o.eq("customer_id",i)),a&&(o=o.eq("is_urgent",!0)),r&&(o=o.eq("is_read",!1)),e&&(o=o.ilike("transcription",`%${e}%`));let{data:c,error:l}=await o;return l?{success:!1,error:l.message}:{success:!0,message:`Found ${c?.length||0} voicemails`,voicemails:c?.map(e=>({id:e.id,from:e.from_number,customerName:e.customer?.name,duration:e.duration?`${Math.floor(e.duration/60)}m ${e.duration%60}s`:"Unknown",transcription:e.transcription,confidence:e.transcription_confidence,isUrgent:e.is_urgent,isRead:e.is_read,receivedAt:e.received_at}))}}}),el=(0,c.tool)({description:"Get the complete communication history for a customer including calls, emails, SMS, and voicemails. Use this to understand the full context of a customer relationship.",inputSchema:a.z.object({customerId:a.z.string().describe("Customer UUID"),days:a.z.number().optional().default(90).describe("Look back this many days"),includeTranscripts:a.z.boolean().optional().default(!1).describe("Include full call transcripts")}),execute:async({customerId:e,days:i,includeTranscripts:a},{companyId:r})=>{let n=(0,t.createServiceSupabaseClient)(),s=new Date;s.setDate(s.getDate()-i);let{data:o,error:c}=await n.from("communications").select(`
				id, type, channel, direction, subject, body_plain,
				call_transcript, call_sentiment, call_duration,
				from_name, to_name, created_at, status
			`).eq("company_id",r).eq("customer_id",e).is("deleted_at",null).gte("created_at",s.toISOString()).order("created_at",{ascending:!1}),{data:l,error:u}=await n.from("voicemails").select("id, from_number, duration, transcription, is_urgent, received_at").eq("company_id",r).eq("customer_id",e).is("deleted_at",null).gte("received_at",s.toISOString()).order("received_at",{ascending:!1});return c?{success:!1,error:c.message}:{success:!0,customerId:e,period:`Last ${i} days`,summary:{emails:o?.filter(e=>"email"===e.channel).length||0,calls:o?.filter(e=>"call"===e.channel).length||0,sms:o?.filter(e=>"sms"===e.channel).length||0,voicemails:l?.length||0},communications:o?.map(e=>({id:e.id,channel:e.channel,direction:e.direction,subject:e.subject,preview:a?(e.body_plain||e.call_transcript||"").substring(0,500):(e.body_plain||e.call_transcript||"").substring(0,100),sentiment:e.call_sentiment,date:e.created_at})),voicemails:l?.map(e=>({id:e.id,duration:e.duration,transcription:e.transcription?.substring(0,200),isUrgent:e.is_urgent,date:e.received_at}))}}}),eu=(0,c.tool)({description:"Analyze a communication (call, email, SMS) and extract key insights like customer preferences, issues, sentiment. Automatically stores insights in memory for future reference.",inputSchema:a.z.object({communicationId:a.z.string().describe("Communication ID to analyze"),insightTypes:a.z.array(a.z.enum(["preference","issue","sentiment","action_item","feedback"])).optional().describe("Types of insights to extract")}),execute:async({communicationId:i,insightTypes:a},{companyId:r,userId:n})=>{let s=(0,t.createServiceSupabaseClient)(),{data:o,error:c}=await s.from("communications").select(`
				id, channel, direction, subject, body_plain, call_transcript,
				call_sentiment, customer_id,
				customer:customers(id, name)
			`).eq("id",i).eq("company_id",r).single();if(c||!o)return{success:!1,error:"Communication not found"};let l=o.body_plain||o.call_transcript||"";if(!l)return{success:!1,error:"No content to analyze"};let u=[];for(let e of[/prefer[s]?\s+(morning|afternoon|evening|weekend|monday|tuesday|wednesday|thursday|friday)/gi,/best\s+time[s]?\s+(?:is|are|would be)\s+([^.]+)/gi,/don'?t\s+(?:like|want|prefer)\s+([^.]+)/gi])for(let t of l.matchAll(e))u.push({type:"preference",content:`Customer prefers: ${t[0]}`,importance:"medium"});for(let e of[/problem[s]?\s+with\s+([^.]+)/gi,/issue[s]?\s+with\s+([^.]+)/gi,/not\s+working\s+([^.]+)/gi,/broken\s+([^.]+)/gi])for(let t of l.matchAll(e))u.push({type:"issue",content:`Reported issue: ${t[0]}`,importance:"high"});if(o.customer_id&&u.length>0){let{storeMemory:t}=await e.A(872412);for(let e of u)await t(r,n||"system",{content:e.content,memoryType:e.type,entityType:"customer",entityId:o.customer_id,importance:"high"===e.importance?.9:.6,sourceType:"communication",sourceChatId:i})}return{success:!0,communicationId:i,channel:o.channel,customerName:o.customer?.name,extractedInsights:u,storedToMemory:u.length>0&&!!o.customer_id,sentiment:o.call_sentiment}}}),ed=(0,c.tool)({description:`Get weather forecast and alerts for a specific location. Provides 7-day forecast, hourly conditions, and any active weather alerts. Use this when:
- Scheduling outdoor jobs
- Checking if weather is suitable for work
- Planning technician routes
- Informing customers about weather delays

Returns forecast periods, temperature, wind, precipitation chances, and any severe weather alerts.`,inputSchema:a.z.object({lat:a.z.number().describe("Latitude of the location"),lon:a.z.number().describe("Longitude of the location"),includeHourly:a.z.boolean().optional().default(!0).describe("Include hourly forecast for next 24 hours")}),execute:async({lat:t,lon:i,includeHourly:a})=>{let{weatherService:r}=await e.A(870936),n=await r.getWeatherData(t,i);return n?{success:!0,location:n.location,currentConditions:n.hourly?.periods?.[0]||null,forecast:n.forecast?.periods?.slice(0,7)||[],hourly:a&&n.hourly?.periods?.slice(0,12)||[],alerts:n.alerts,hasActiveAlerts:n.hasActiveAlerts,highestSeverity:n.highestSeverity,enrichedAt:n.enrichedAt}:{success:!1,error:"Unable to fetch weather data for this location"}}}),em=(0,c.tool)({description:`Check if weather conditions are suitable for outdoor field service work at a specific location. Considers:
- Severe weather alerts
- Precipitation (rain, snow, storms)
- Extreme temperatures (freezing or excessive heat)
- Wind conditions

Returns a clear recommendation on whether to proceed with outdoor work.`,inputSchema:a.z.object({lat:a.z.number().describe("Latitude of the job location"),lon:a.z.number().describe("Longitude of the job location"),jobType:a.z.string().optional().describe("Type of job (e.g., 'roofing', 'HVAC outdoor', 'landscaping')")}),execute:async({lat:t,lon:i,jobType:a})=>{let{weatherService:r}=await e.A(870936),n=await r.getWeatherData(t,i);if(!n)return{success:!1,suitable:null,error:"Unable to fetch weather data"};let s=r.isSuitableForOutdoorWork(n);return{success:!0,suitable:s.suitable,reason:s.reason||"Weather conditions are acceptable for outdoor work",currentConditions:n.hourly?.periods?.[0]?{temperature:n.hourly.periods[0].temperature,temperatureUnit:n.hourly.periods[0].temperatureUnit,shortForecast:n.hourly.periods[0].shortForecast,windSpeed:n.hourly.periods[0].windSpeed}:null,alerts:n.alerts.map(e=>({event:e.event,severity:e.severity,headline:e.headline})),jobType:a,recommendation:s.suitable?"Proceed with outdoor work":`Consider rescheduling: ${s.reason}`}}}),ep=(0,c.tool)({description:`Quickly check for active weather alerts at a location without fetching the full forecast. Use this for:
- Quick safety checks
- Emergency notifications
- Batch checking multiple job sites

Returns only alert information (faster than full weather data).`,inputSchema:a.z.object({lat:a.z.number().describe("Latitude"),lon:a.z.number().describe("Longitude")}),execute:async({lat:t,lon:i})=>{let{weatherService:a}=await e.A(870936),r=await a.getActiveAlerts(t,i);return{success:!0,hasAlerts:r.length>0,alertCount:r.length,alerts:r.map(e=>({event:e.event,severity:e.severity,urgency:e.urgency,headline:e.headline,instruction:e.instruction,expires:e.expires}))}}}),eg=(0,c.tool)({description:`Get real-time traffic conditions and incidents near a job location or along a route. Detects:
- Traffic accidents/crashes
- Road construction
- Road closures
- Police activity
- Congestion levels

Useful for:
- Planning technician dispatch
- Estimating arrival times
- Routing around incidents
- Notifying customers of delays`,inputSchema:a.z.object({destinationLat:a.z.number().describe("Latitude of the destination/job site"),destinationLon:a.z.number().describe("Longitude of the destination/job site"),originLat:a.z.number().optional().describe("Latitude of origin (e.g., shop/office) to check route"),originLon:a.z.number().optional().describe("Longitude of origin to check route")}),execute:async({destinationLat:t,destinationLon:i,originLat:a,originLon:r})=>{let{trafficService:n}=await e.A(159864),s=await n.getTrafficIncidents(t,i,a,r);return s?{success:!0,totalIncidents:s.totalIncidents,nearbyIncidents:s.nearbyIncidents,routeAffectingIncidents:s.routeAffectingIncidents,incidents:s.incidents.map(e=>({type:e.type,severity:e.severity,description:e.description,distance:e.distance,affectsRoute:e.affectsRoute})),recommendation:s.routeAffectingIncidents>0?`${s.routeAffectingIncidents} incident(s) may affect travel time`:"No significant traffic issues detected",enrichedAt:s.enrichedAt}:{success:!1,error:"Unable to fetch traffic data. Check Google Maps API configuration."}}}),eh=(0,c.tool)({description:`Convert a street address to GPS coordinates (latitude/longitude). Use this when:
- You have an address but need coordinates for weather/traffic lookup
- Verifying an address is valid
- Getting standardized/formatted address

Returns coordinates and Google's formatted version of the address.`,inputSchema:a.z.object({address:a.z.string().describe("Street address (e.g., '123 Main St')"),city:a.z.string().describe("City name"),state:a.z.string().describe("State (e.g., 'CA' or 'California')"),zipCode:a.z.string().describe("ZIP code"),country:a.z.string().optional().default("USA").describe("Country (defaults to USA)")}),execute:async({address:t,city:i,state:a,zipCode:r,country:n})=>{let{geocodeAddressSilent:s}=await e.A(263185),o=await s(t,i,a,r,n);return o?{success:!0,coordinates:{lat:o.lat,lon:o.lon},formattedAddress:o.formattedAddress}:{success:!1,error:"Unable to geocode address. The address may be invalid or geocoding service unavailable."}}}),ey=(0,c.tool)({description:`Get a comprehensive conditions summary for a property/job site including weather, traffic, and alerts. This is the "one-stop" tool for checking all external conditions before dispatching or scheduling.

Combines:
- Current and forecast weather
- Weather alerts
- Traffic conditions (if shop coordinates provided)
- Work suitability assessment`,inputSchema:a.z.object({propertyLat:a.z.number().describe("Latitude of the property"),propertyLon:a.z.number().describe("Longitude of the property"),shopLat:a.z.number().optional().describe("Shop/office latitude for traffic routing"),shopLon:a.z.number().optional().describe("Shop/office longitude for traffic routing"),jobType:a.z.string().optional().describe("Type of job being performed (for work suitability)")}),execute:async({propertyLat:t,propertyLon:i,shopLat:a,shopLon:r,jobType:n})=>{let{weatherService:s}=await e.A(870936),{trafficService:o}=await e.A(159864),[c,l]=await Promise.all([s.getWeatherData(t,i),a&&r?o.getTrafficIncidents(t,i,a,r):Promise.resolve(null)]),u={success:!0,propertyLocation:{lat:t,lon:i}};if(c){let e=s.isSuitableForOutdoorWork(c);u.weather={current:c.hourly?.periods?.[0]?{temperature:c.hourly.periods[0].temperature,temperatureUnit:c.hourly.periods[0].temperatureUnit,conditions:c.hourly.periods[0].shortForecast,wind:c.hourly.periods[0].windSpeed}:null,forecast:c.forecast?.periods?.slice(0,3).map(e=>({name:e.name,temperature:e.temperature,shortForecast:e.shortForecast})),alerts:c.alerts.map(e=>({event:e.event,severity:e.severity,headline:e.headline})),hasAlerts:c.hasActiveAlerts,highestAlertSeverity:c.highestSeverity},u.workSuitability={suitable:e.suitable,reason:e.reason||"Conditions acceptable",jobType:n}}else u.weather={error:"Weather data unavailable"},u.workSuitability={suitable:null,reason:"Unable to assess"};l?u.traffic={totalIncidents:l.totalIncidents,routeAffecting:l.routeAffectingIncidents,incidents:l.incidents.slice(0,5).map(e=>({type:e.type,severity:e.severity,description:e.description}))}:a&&r&&(u.traffic={error:"Traffic data unavailable"});let d=[];return c?.hasActiveAlerts&&d.push(`Weather alert: ${c.highestSeverity}`),c&&!s.isSuitableForOutdoorWork(c).suitable&&d.push("Weather not suitable for outdoor work"),l&&l.routeAffectingIncidents>0&&d.push(`${l.routeAffectingIncidents} traffic incident(s) on route`),u.overallStatus=0===d.length?"good":"caution",u.issues=d,u.recommendation=0===d.length?"Conditions look good for this job":`Review before proceeding: ${d.join("; ")}`,u}}),ef={plumbing:{name:"Uniform Plumbing Code (UPC) / International Plumbing Code (IPC)",commonRequirements:["Drain pipe slope: 1/4 inch per foot minimum","Vent pipes must extend through roof","P-traps required on all fixtures","Water heater T&P relief valve required","Backflow prevention on potable water","Minimum fixture unit calculations for pipe sizing","Air gap requirements for indirect waste"],permitTriggers:["New water heater installation","Moving or adding fixtures","New water/sewer line connections","Gas line work","Sewer line replacement"]},electrical:{name:"National Electrical Code (NEC)",commonRequirements:["GFCI required in kitchens, bathrooms, garages, outdoors","AFCI required in bedrooms and living areas","Smoke detectors on every floor and bedroom","Panel accessibility clearance: 36 inches","Wire sizing based on amperage load","Grounding requirements for all circuits","Box fill calculations for junction boxes"],permitTriggers:["New circuits or subpanels","Service upgrade","Adding outlets or switches","Electric vehicle charger installation","Generator installation"]},hvac:{name:"International Mechanical Code (IMC)",commonRequirements:["Proper equipment sizing (Manual J calculation)","Ductwork sizing (Manual D calculation)","Combustion air requirements for gas appliances","Clearances from combustible materials","Condensate drain requirements","Refrigerant line sizing and insulation","Energy efficiency minimums (SEER ratings)"],permitTriggers:["New HVAC system installation","Equipment replacement (like-for-like may be exempt)","Ductwork modifications","Gas line work","Mini-split installation"]},general:{name:"International Building Code (IBC) / International Residential Code (IRC)",commonRequirements:["Egress window requirements for bedrooms","Stair rise/run specifications (7.75 in max rise, 10 in min run)","Handrail requirements (34-38 inches height)","Smoke and CO detector placement","Fire-rated assemblies where required","Structural load calculations"],permitTriggers:["Structural modifications","Adding/removing walls","Roof replacement (varies by jurisdiction)","Window/door changes","Additions or conversions"]},roofing:{name:"International Building Code (IBC) - Roofing Section",commonRequirements:["Minimum roof slope requirements by material","Underlayment requirements","Ice and water shield in cold climates","Flashing requirements at penetrations","Ventilation requirements (1:150 or 1:300 ratio)","Fire-rated materials in certain zones"],permitTriggers:["Complete re-roof (varies by jurisdiction)","Structural repairs","Adding skylights or vents","Changing roofing material type"]}},eb=(0,c.tool)({description:`Search for relevant building code requirements based on the type of work being performed. Returns common code requirements, permit triggers, and best practices for:
- Plumbing (UPC/IPC)
- Electrical (NEC)
- HVAC (IMC)
- General construction (IBC/IRC)
- Roofing

Use this to help technicians understand code requirements before starting work.`,inputSchema:a.z.object({tradeType:a.z.enum(["plumbing","electrical","hvac","general","roofing"]).describe("The trade or type of work"),workDescription:a.z.string().optional().describe("Specific description of the work being performed"),state:a.z.string().optional().describe("State abbreviation (codes vary by jurisdiction)")}),execute:async({tradeType:e,workDescription:t,state:i})=>{let a=ef[e],r=[];if(t){let e=t.toLowerCase();for(let t of a.commonRequirements){let i=t.toLowerCase();e.split(/\s+/).some(e=>e.length>3&&i.includes(e))&&r.push(t)}}return{success:!0,tradeType:e,codeName:a.name,commonRequirements:a.commonRequirements,relevantToWork:r.length>0?r:null,permitTriggers:a.permitTriggers,jurisdictionNote:i?`Note: Requirements may vary in ${i}. Always verify with local building department.`:"Requirements vary by jurisdiction. Always verify with local building department.",disclaimer:"This is general guidance only. Consult actual code books and local jurisdiction for specific requirements."}}}),e_=(0,c.tool)({description:`Determine if a permit is likely required for specific work and what type of permit. Helps field service companies understand when to pull permits and advise customers.

Returns:
- Whether permit is typically required
- Type of permit needed
- Common exceptions
- Inspection requirements`,inputSchema:a.z.object({workType:a.z.string().describe("Type of work being performed (e.g., 'water heater replacement', 'outlet installation')"),propertyType:a.z.enum(["residential","commercial"]).optional().default("residential"),city:a.z.string().optional().describe("City for jurisdiction-specific guidance"),state:a.z.string().optional().describe("State abbreviation")}),execute:async({workType:e,propertyType:t,city:i,state:a})=>{let r=e.toLowerCase(),n=!1,s="unknown",o="medium",c=[],l=[];return(r.includes("outlet")||r.includes("circuit")||r.includes("panel")||r.includes("electrical")||r.includes("wire")||r.includes("ev charger"))&&(n=!0,s="electrical",l.push("Rough-in inspection","Final inspection"),(r.includes("panel")||r.includes("service"))&&c.push("Service upgrades typically require utility coordination")),(r.includes("water heater")||r.includes("plumbing")||r.includes("sewer")||r.includes("drain")||r.includes("fixture"))&&(n=!0,s="plumbing",l.push("Rough-in inspection","Final inspection"),r.includes("water heater")&&(c.push("Water heater permits often include gas and electrical inspections"),o="high")),(r.includes("hvac")||r.includes("furnace")||r.includes("air condition")||r.includes("ac ")||r.includes("heat pump")||r.includes("mini-split"))&&(n=!0,s="mechanical",l.push("Final inspection"),c.push("EPA certification required for refrigerant handling")),(r.includes("roof")||r.includes("re-roof"))&&(n=!0,s="building/roofing",l.push("Final inspection"),c.push("Requirements vary significantly by jurisdiction - some exempt repairs under certain square footage"),o="low"),(r.includes("gas line")||r.includes("gas pipe"))&&(n=!0,s="gas/plumbing",l.push("Pressure test inspection","Final inspection"),c.push("Gas work requires licensed gas fitter in most jurisdictions"),o="high"),!r.includes("repair")||r.includes("replace")||r.includes("install")||(n=!1,c.push("Minor repairs typically exempt, but verify with local jurisdiction"),o="low"),(r.includes("like for like")||r.includes("same location"))&&(c.push("Like-for-like replacements may be exempt in some jurisdictions"),o="low"),{success:!0,workType:e,propertyType:t,location:i&&a?`${i}, ${a}`:a||"Not specified",permitRequired:n,permitType:n?s:null,confidence:o,typicalInspections:n?l:[],notes:c,recommendations:n?["Contact local building department for specific requirements","Have contractor license number ready","Allow 1-3 business days for permit processing","Schedule inspections in advance"]:["Document work performed for records","When in doubt, contact local building department"],disclaimer:"Permit requirements vary by jurisdiction. Always verify with local building department."}}}),ev=(0,c.tool)({description:`Generate a code compliance and safety checklist for a specific type of job. Helps technicians ensure they're meeting code requirements during installation or repair.

Returns a checklist of items to verify for code compliance.`,inputSchema:a.z.object({jobType:a.z.string().describe("Type of job (e.g., 'water heater installation', 'panel upgrade', 'AC replacement')"),includesSafety:a.z.boolean().optional().default(!0).describe("Include safety checklist items")}),execute:async({jobType:e,includesSafety:t})=>{let i=e.toLowerCase(),a=[];return(i.includes("water heater")||i.includes("hot water"))&&(a.push({category:"Temperature & Pressure Relief",items:["T&P relief valve installed in top 6 inches of tank","Discharge pipe routes to within 6 inches of floor","Discharge pipe same size as valve outlet","No valves or restrictions in discharge line"]}),a.push({category:"Seismic & Stability",items:["Seismic straps installed (required in seismic zones)","Unit stable and level","Proper clearances maintained"]}),a.push({category:"Connections",items:["Proper venting for gas units (draft hood, flue)","Gas shutoff valve accessible","Sediment trap on gas line","Dielectric unions on water connections","Expansion tank installed if closed system"]})),(i.includes("panel")||i.includes("electrical")||i.includes("breaker"))&&(a.push({category:"Panel Requirements",items:["36-inch clearance in front of panel","30-inch width clearance","78-inch height clearance","Panel cover intact and secured","All breakers labeled","No exposed conductors"]}),a.push({category:"Grounding & Bonding",items:["Ground rod(s) installed","Bonding jumper at water heater","CSST gas line bonded (if applicable)","Grounding electrode conductor sized properly"]})),(i.includes("hvac")||i.includes("furnace")||i.includes("ac")||i.includes("heat pump"))&&(a.push({category:"Equipment Installation",items:["Clearances from combustibles maintained","Condensate drain properly routed","Secondary drain pan with float switch (if in attic)","Filter access provided","Disconnect within sight of unit"]}),a.push({category:"Ductwork & Airflow",items:["Supply and return balanced","Duct connections sealed","No kinks in flex duct","Adequate return air"]}),(i.includes("gas")||i.includes("furnace"))&&a.push({category:"Gas & Combustion",items:["Combustion air adequate","Gas pressure verified","CO testing performed","Heat exchanger inspected"]})),t&&a.push({category:"General Safety",items:["Work area secured and clean","PPE used appropriately","All utilities verified off before work","Test equipment calibrated","Customer informed of work"]}),a.length===+!!t&&a.unshift({category:"General Code Compliance",items:["Work matches permit scope (if applicable)","Materials meet code requirements","Manufacturer installation instructions followed","All connections secure","System tested and operational","Area cleaned up"]}),{success:!0,jobType:e,checklist:a,totalItems:a.reduce((e,t)=>e+t.items.length,0),reminder:"Document completion of each item. Photos recommended for permit inspections.",disclaimer:"This checklist is general guidance. Refer to local codes and manufacturer instructions."}}}),ew=(0,c.tool)({description:`Proactively analyze recent customer communications to extract insights and learnings. Scans the last N days of communications and identifies:
- Customer preferences mentioned in calls/emails
- Common issues or complaints
- Positive feedback and compliments
- Service requests patterns
- Emergency situations or urgent needs

Use this for periodic learning runs to build customer knowledge.`,inputSchema:a.z.object({companyId:a.z.string().describe("Company ID"),daysBack:a.z.number().optional().default(7).describe("Number of days to look back"),limit:a.z.number().optional().default(50).describe("Maximum communications to analyze"),focusArea:a.z.enum(["all","preferences","issues","feedback","urgent"]).optional().default("all").describe("Focus on specific type of insights")}),execute:async({companyId:t,daysBack:i,limit:a,focusArea:r})=>{let{createServiceSupabaseClient:n}=await e.A(10419),s=n(),o=new Date;o.setDate(o.getDate()-i);let{data:c,error:l}=await s.from("communications").select(`
				id,
				channel,
				direction,
				call_transcript,
				call_sentiment,
				body_plain,
				customer_id,
				created_at,
				customer:customers!customer_id(id, name)
			`).eq("company_id",t).gte("created_at",o.toISOString()).not("call_transcript","is",null).order("created_at",{ascending:!1}).limit(a);if(l||!c)return{success:!1,error:l?.message||"No communications found"};let u=[],d={preferences:[/prefer[s]?\s+([^.]+)/gi,/like[s]?\s+([^.]+)/gi,/want[s]?\s+([^.]+)/gi,/always\s+([^.]+)/gi,/please\s+([^.]+)/gi],issues:[/problem[s]?\s+with\s+([^.]+)/gi,/issue[s]?\s+with\s+([^.]+)/gi,/not\s+working\s+([^.]+)/gi,/broken\s+([^.]+)/gi,/complaint[s]?\s+about\s+([^.]+)/gi,/frustrated\s+([^.]+)/gi],feedback:[/great\s+([^.]+)/gi,/excellent\s+([^.]+)/gi,/thank\s+you\s+for\s+([^.]+)/gi,/appreciate\s+([^.]+)/gi,/happy\s+with\s+([^.]+)/gi],urgent:[/emergency\s+([^.]+)/gi,/urgent\s+([^.]+)/gi,/asap\s+([^.]+)/gi,/right\s+away\s+([^.]+)/gi,/immediately\s+([^.]+)/gi]};for(let e of c){let t=e.call_transcript||e.body_plain||"";if(!t)continue;let i=e.customer;for(let a of"all"===r?Object.keys(d):[r])for(let r of d[a]||[])for(let n of t.matchAll(r))u.push({customerId:e.customer_id,customerName:i?.name||null,type:a,content:n[0],source:`${e.channel} on ${new Date(e.created_at).toLocaleDateString()}`,importance:"urgent"===a||"issues"===a?"high":"medium"});e.call_sentiment&&["negative","very_negative"].includes(e.call_sentiment)&&u.push({customerId:e.customer_id,customerName:i?.name||null,type:"sentiment",content:`Negative sentiment detected in ${e.channel} communication`,source:`${e.channel} on ${new Date(e.created_at).toLocaleDateString()}`,importance:"high"})}return{success:!0,communicationsAnalyzed:c.length,daysBack:i,focusArea:r,insightsFound:u.length,insights:u.slice(0,100),summary:{byType:{preferences:u.filter(e=>"preferences"===e.type).length,issues:u.filter(e=>"issues"===e.type).length,feedback:u.filter(e=>"feedback"===e.type).length,urgent:u.filter(e=>"urgent"===e.type).length,sentiment:u.filter(e=>"sentiment"===e.type).length},highImportance:u.filter(e=>"high"===e.importance).length}}}}),eS=(0,c.tool)({description:`Analyze completed jobs to learn patterns about:
- Common job durations by type
- Frequently used materials
- Customer satisfaction indicators
- Technician performance patterns
- Seasonal job patterns

Helps improve scheduling and resource allocation.`,inputSchema:a.z.object({companyId:a.z.string().describe("Company ID"),daysBack:a.z.number().optional().default(30).describe("Days to look back"),jobType:a.z.string().optional().describe("Filter by job type")}),execute:async({companyId:t,daysBack:i,jobType:a})=>{let{createServiceSupabaseClient:r}=await e.A(10419),n=r(),s=new Date;s.setDate(s.getDate()-i);let o=n.from("jobs").select(`
				id,
				title,
				job_type,
				status,
				scheduled_start,
				scheduled_end,
				actual_start,
				actual_end,
				total_amount,
				customer:customers!customer_id(name),
				property:properties!property_id(address_line1, city)
			`).eq("company_id",t).eq("status","completed").gte("created_at",s.toISOString()).order("created_at",{ascending:!1}).limit(100);a&&(o=o.eq("job_type",a));let{data:c,error:l}=await o;if(l||!c)return{success:!1,error:l?.message||"No jobs found"};let u={},d={},m=[];for(let e of c){let t=e.job_type||"unknown";if(e.actual_start&&e.actual_end){let i=(new Date(e.actual_end).getTime()-new Date(e.actual_start).getTime())/6e4;if(u[t]||(u[t]=[]),u[t].push(i),e.scheduled_start&&e.scheduled_end){let a=(new Date(e.scheduled_end).getTime()-new Date(e.scheduled_start).getTime())/6e4;m.push({jobType:t,scheduledMinutes:a,actualMinutes:i,accuracy:100*Math.min(a/i,i/a)})}}e.total_amount&&(d[t]||(d[t]=[]),d[t].push(e.total_amount))}let p={};for(let[e,t]of Object.entries(u)){let i=t.reduce((e,t)=>e+t,0)/t.length;p[e]={avg:Math.round(i),min:Math.round(Math.min(...t)),max:Math.round(Math.max(...t)),count:t.length}}let g={};for(let[e,t]of Object.entries(d)){let i=t.reduce((e,t)=>e+t,0)/t.length;g[e]={avg:Math.round(100*i)/100,min:Math.min(...t),max:Math.max(...t),count:t.length}}let h=m.length>0?m.reduce((e,t)=>e+t.accuracy,0)/m.length:null;return{success:!0,jobsAnalyzed:c.length,daysBack:i,insights:{durationByType:p,revenueByType:g,schedulingAccuracy:h?`${Math.round(h)}% average accuracy`:"Insufficient data"},recommendations:Object.entries(p).map(([e,t])=>({jobType:e,recommendedDuration:t.avg,note:t.max>1.5*t.avg?`Consider allocating buffer time - some ${e} jobs take up to ${t.max} minutes`:null}))}}}),ez=(0,c.tool)({description:`Build a comprehensive customer profile by aggregating all available data:
- Communication history and sentiment
- Job history and preferences
- Payment history
- Property information
- Stored memories and notes

Use this to prepare for customer interactions or to understand customer value.`,inputSchema:a.z.object({customerId:a.z.string().describe("Customer UUID"),companyId:a.z.string().describe("Company ID")}),execute:async({customerId:t,companyId:i})=>{let{createServiceSupabaseClient:a}=await e.A(10419),r=a(),[n,s,o,c,l]=await Promise.all([r.from("customers").select("*").eq("id",t).eq("company_id",i).single(),r.from("jobs").select("id, title, job_type, status, total_amount, created_at").eq("customer_id",t).order("created_at",{ascending:!1}).limit(20),r.from("communications").select("id, channel, direction, call_sentiment, created_at").eq("customer_id",t).order("created_at",{ascending:!1}).limit(50),r.from("invoices").select("id, status, total, paid_amount, created_at").eq("customer_id",t).order("created_at",{ascending:!1}).limit(20),r.from("ai_memory").select("content, memory_type, importance, created_at").eq("company_id",i).eq("entity_id",t).eq("entity_type","customer").order("importance",{ascending:!1}).limit(20)]),u=n.data,d=s.data||[],m=o.data||[],p=c.data||[],g=l.data||[];if(!u)return{success:!1,error:"Customer not found"};let h=d.filter(e=>"completed"===e.status),y=d.reduce((e,t)=>e+(t.total_amount||0),0),f=[...new Set(d.map(e=>e.job_type).filter(Boolean))],b=m.map(e=>e.call_sentiment).filter(Boolean),_=b.filter(e=>"negative"===e||"very_negative"===e).length,v=b.filter(e=>"positive"===e||"very_positive"===e).length,w=p.filter(e=>"paid"===e.status),S=p.filter(e=>"overdue"===e.status),z=p.filter(e=>"paid"!==e.status).reduce((e,t)=>e+((t.total||0)-(t.paid_amount||0)),0),q="new";return h.length>=5&&y>5e3?q="vip":h.length>=2&&(q="regular"),(_>v||S.length>2)&&(q="at_risk"),{success:!0,customer:{id:u.id,name:u.name,email:u.email,phone:u.phone,createdAt:u.created_at},tier:q,jobHistory:{totalJobs:d.length,completedJobs:h.length,totalRevenue:y,commonJobTypes:f,recentJobs:d.slice(0,5).map(e=>({title:e.title,type:e.job_type,status:e.status,amount:e.total_amount}))},communicationHistory:{totalInteractions:m.length,channelBreakdown:{calls:m.filter(e=>"phone"===e.channel).length,emails:m.filter(e=>"email"===e.channel).length,sms:m.filter(e=>"sms"===e.channel).length},sentimentSummary:{positive:v,negative:_,neutral:b.length-v-_}},financials:{totalInvoices:p.length,paidInvoices:w.length,overdueInvoices:S.length,currentBalance:z,paymentHealth:0===S.length?"good":S.length<3?"fair":"poor"},memories:g.map(e=>({content:e.content,type:e.memory_type,importance:e.importance})),recommendations:"at_risk"===q?["Review recent negative interactions","Consider follow-up call to address concerns","Check for outstanding payment issues"]:"vip"===q?["Prioritize this customer's requests","Consider loyalty discount or perks","Proactive maintenance reminders"]:["Standard service approach","Opportunity to build relationship"]}}}),eq=(0,c.tool)({description:"Calculate optimal driving route between locations with distance and duration",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),waypoints:a.z.array(a.z.object({address:a.z.string().describe("Full address"),lat:a.z.number().optional().describe("Latitude if known"),lng:a.z.number().optional().describe("Longitude if known")})).min(2).describe("Array of waypoints (minimum 2: origin and destination)"),optimizeOrder:a.z.boolean().optional().default(!1).describe("Whether to optimize waypoint order for shortest route")}),execute:async({waypoints:e})=>{let t=(await Promise.all(e.map(async e=>{if(e.lat&&e.lng)return{...e,coordinates:[e.lng,e.lat]};let t=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e.address)}&limit=1`;try{let i=await fetch(t,{headers:{"User-Agent":"Stratos-FSM/1.0 (https://stratos.app; support@stratos.app)",Accept:"application/json"}});if(!i.ok)return console.warn(`Geocoding failed for ${e.address}: ${i.status}`),{...e,coordinates:null};let a=await i.json();if(a.length>0)return{...e,coordinates:[parseFloat(a[0].lon),parseFloat(a[0].lat)]}}catch(t){console.warn(`Geocoding error for ${e.address}:`,t)}return{...e,coordinates:null}}))).filter(e=>e.coordinates);if(t.length<2)return{error:"Could not geocode enough waypoints for routing"};let i=process.env.OPENROUTESERVICE_API_KEY;if(i)try{let e=t.map(e=>e.coordinates),a=await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson",{method:"POST",headers:{Authorization:i,"Content-Type":"application/json"},body:JSON.stringify({coordinates:e,instructions:!0})}),r=await a.json();if(r.features?.[0]){let e=r.features[0];return{distance_km:(e.properties.summary.distance/1e3).toFixed(1),duration_minutes:Math.round(e.properties.summary.duration/60),waypoints:t.map(e=>e.address),geometry:e.geometry}}}catch{}let a=t.map(e=>e.coordinates),r=0;for(let e=0;e<a.length-1;e++){let[t,i]=a[e],[n,s]=a[e+1],o=(s-i)*Math.PI/180,c=(n-t)*Math.PI/180,l=Math.sin(o/2)*Math.sin(o/2)+Math.cos(i*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(c/2)*Math.sin(c/2);r+=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371}let n=1.3*r,s=Math.round(n/50*60);return{distance_km:n.toFixed(1),duration_minutes:s,waypoints:t.map(e=>e.address),note:"Estimated based on straight-line distance"}}}),eI=(0,c.tool)({description:"Find nearby supply stores for parts (plumbing, electrical, HVAC, hardware)",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),location:a.z.object({lat:a.z.number().describe("Latitude"),lng:a.z.number().describe("Longitude")}),supplyType:a.z.enum(["plumbing","electrical","hvac","hardware","all"]).default("all"),radiusKm:a.z.number().optional().default(10)}),execute:async({location:e,supplyType:t,radiusKm:i})=>{let a={plumbing:'["shop"="trade"]["trade"~"plumbing|bathroom"]',electrical:'["shop"="trade"]["trade"~"electrical"]',hvac:'["shop"="trade"]["trade"~"hvac|air_conditioning"]',hardware:'["shop"="doityourself"]',all:'["shop"~"trade|doityourself|hardware"]'}[t],r=`[out:json][timeout:25];(node${a}(around:${1e3*i},${e.lat},${e.lng});way${a}(around:${1e3*i},${e.lat},${e.lng}););out center;`;try{let e=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:r});return{suppliers:(await e.json()).elements.map(e=>({name:e.tags?.name||"Unknown Supplier",phone:e.tags?.phone,website:e.tags?.website,lat:e.lat||e.center?.lat,lng:e.lon||e.center?.lon})).filter(e=>"Unknown Supplier"!==e.name).slice(0,10),searchRadius:i,supplyType:t}}catch{return{error:"Failed to search for suppliers"}}}}),ek=(0,c.tool)({description:"Search company inventory for parts by name, SKU, or category",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),query:a.z.string().describe("Search query"),category:a.z.string().optional(),inStockOnly:a.z.boolean().optional().default(!1)}),execute:async({companyId:e,query:t,category:i,inStockOnly:a})=>{let r=(await createClient()).from("inventory").select("id, sku, name, description, category, quantity_on_hand, quantity_reserved, reorder_point, unit_cost, unit_price, location").eq("company_id",e).or(`name.ilike.%${t}%,sku.ilike.%${t}%,description.ilike.%${t}%`);i&&(r=r.eq("category",i)),a&&(r=r.gt("quantity_on_hand",0));let{data:n,error:s}=await r.order("name").limit(20);return s?{error:s.message}:{items:n.map(e=>({...e,available:e.quantity_on_hand-(e.quantity_reserved||0),needsReorder:e.quantity_on_hand<=(e.reorder_point||0)})),total:n.length}}}),eC=(0,c.tool)({description:"Check if required parts are available in inventory for a job",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),parts:a.z.array(a.z.object({itemId:a.z.string().optional(),sku:a.z.string().optional(),name:a.z.string().optional(),quantity:a.z.number()}))}),execute:async({companyId:e,parts:t})=>{if(!t.length)return{error:"At least one part is required"};let i=await createClient(),a=t.filter(e=>e.itemId).map(e=>e.itemId),r=t.filter(e=>e.sku&&!e.itemId).map(e=>e.sku),n=i.from("inventory").select("id, sku, name, quantity_on_hand, quantity_reserved, unit_cost, unit_price").eq("company_id",e).is("deleted_at",null),s=[];a.length>0&&s.push(`id.in.(${a.join(",")})`),r.length>0&&s.push(`sku.in.(${r.join(",")})`);let o=[];if(s.length>0){let{data:e}=await n.or(s.join(","));o=e||[]}let c=t.filter(e=>!e.itemId&&!e.sku&&e.name);if(c.length>0){let t=await Promise.all(c.map(async t=>{let{data:a}=await i.from("inventory").select("id, sku, name, quantity_on_hand, quantity_reserved, unit_cost, unit_price").eq("company_id",e).is("deleted_at",null).ilike("name",`%${t.name}%`).limit(1).single();return a}));o.push(...t.filter(e=>null!==e))}let l=t.map(e=>{let t=o.find(t=>e.itemId&&t.id===e.itemId||e.sku&&t.sku===e.sku||e.name&&t.name.toLowerCase().includes(e.name.toLowerCase()));if(!t)return{...e,found:!1,available:0,canFulfill:!1};let i=t.quantity_on_hand-(t.quantity_reserved||0);return{itemId:t.id,sku:t.sku,name:t.name,found:!0,available:i,needed:e.quantity,canFulfill:i>=e.quantity,unitPrice:t.unit_price,totalPrice:(t.unit_price||0)*e.quantity}});return{allPartsAvailable:l.every(e=>e.canFulfill),parts:l,missingParts:l.filter(e=>!e.canFulfill),totalEstimatedPrice:l.reduce((e,t)=>e+(t.totalPrice||0),0)}}}),ej=(0,c.tool)({description:"Get inventory items at or below reorder point",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),category:a.z.string().optional(),limit:a.z.coerce.number().optional().default(50).describe("Max items to return")}),execute:async({companyId:e,category:t,limit:i})=>{let a=(await createClient()).from("inventory").select("id, sku, name, category, quantity_on_hand, reorder_point, reorder_quantity, unit_cost").eq("company_id",e).is("deleted_at",null).not("reorder_point","is",null);t&&(a=a.eq("category",t));let{data:r,error:n}=await a.order("quantity_on_hand",{ascending:!0}).limit(2*i);if(n)return{error:n.message};let s=r.filter(e=>e.quantity_on_hand<=(e.reorder_point||0)).slice(0,i).map(e=>({...e,shortfall:(e.reorder_point||0)-e.quantity_on_hand,suggestedOrderQty:e.reorder_quantity||10,urgency:0===e.quantity_on_hand?"critical":e.quantity_on_hand<=(e.reorder_point||0)/2?"high":"normal"}));return{lowStockCount:s.length,items:s,criticalCount:s.filter(e=>"critical"===e.urgency).length}}}),eT=(0,c.tool)({description:"Get list of equipment installed at a customer's property",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),propertyId:a.z.string().optional(),customerId:a.z.string().optional()}),execute:async({companyId:e,propertyId:t,customerId:i})=>{if(!t&&!i)return{error:"Either propertyId or customerId is required"};let a=await createClient(),r=a.from("equipment").select("id, name, model_number, serial_number, manufacturer, install_date, warranty_expiry, last_service_date, next_service_due, status, notes").eq("company_id",e).is("deleted_at",null);if(t)r=r.eq("property_id",t);else if(i){let{data:e}=await a.from("properties").select("id").eq("customer_id",i).is("deleted_at",null);if(!e?.length)return{equipment:[],total:0,message:"No properties found for this customer"};r=r.in("property_id",e.map(e=>e.id))}let{data:n,error:s}=await r.order("name").limit(100);if(s)return{error:s.message};let o=new Date;return{equipment:n.map(e=>({...e,warrantyStatus:e.warranty_expiry?new Date(e.warranty_expiry)>o?"active":"expired":"unknown",serviceDue:!!e.next_service_due&&new Date(e.next_service_due)<=o})),total:n.length}}}),eD=(0,c.tool)({description:"Get service history for a specific piece of equipment",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),equipmentId:a.z.string().describe("Equipment UUID"),limit:a.z.coerce.number().optional().default(10)}),execute:async({companyId:e,equipmentId:t,limit:i})=>{let a=await createClient(),{data:r}=await a.from("equipment").select("*").eq("id",t).eq("company_id",e).single();if(!r)return{error:"Equipment not found"};let{data:n}=await a.from("job_equipment").select("job:jobs(id, title, status, completed_at), notes, work_performed, created_at").eq("equipment_id",t).order("created_at",{ascending:!1}).limit(i);return{equipment:{id:r.id,name:r.name,model:r.model_number,serial:r.serial_number},serviceHistory:n||[],totalServices:n?.length||0}}}),ex=(0,c.tool)({description:"Check warranty status for equipment",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),equipmentId:a.z.string().describe("Equipment UUID")}),execute:async({companyId:e,equipmentId:t})=>{let i=await createClient(),{data:a,error:r}=await i.from("equipment").select("id, name, model_number, serial_number, warranty_expiry, warranty_type, warranty_notes").eq("id",t).eq("company_id",e).single();if(r||!a)return{error:"Equipment not found"};let n=new Date,s=a.warranty_expiry?new Date(a.warranty_expiry):null,o="unknown",c=null;return s&&(o=(c=Math.ceil((s.getTime()-n.getTime())/864e5))<0?"expired":c<=30?"expiring_soon":"active"),{equipment:{name:a.name,model:a.model_number,serial:a.serial_number},warranty:{status:o,expiryDate:a.warranty_expiry,daysRemaining:c&&c>0?c:0,type:a.warranty_type}}}}),eA=(0,c.tool)({description:"Find available technicians with specific skills or certifications",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),skills:a.z.array(a.z.string()).optional(),certifications:a.z.array(a.z.string()).optional(),date:a.z.string().optional().describe("Date to check availability")}),execute:async({companyId:e,skills:t,certifications:i,date:a})=>{try{let r=await createClient(),{data:n,error:s}=await r.from("company_memberships").select("id, role, skills, certifications, service_areas, user:users(id, first_name, last_name, email)").eq("company_id",e).eq("role","technician");if(s)return{error:s.message};let o=n;if(t?.length&&(o=o.filter(e=>t.some(t=>(e.skills||[]).map(e=>e.toLowerCase()).includes(t.toLowerCase())))),i?.length&&(o=o.filter(e=>i.some(t=>(e.certifications||[]).map(e=>e.toLowerCase()).includes(t.toLowerCase())))),a){let e=new Date(a);e.setHours(0,0,0,0);let t=new Date(a);t.setHours(23,59,59,999);let{data:i}=await r.from("jobs").select("assigned_to").is("deleted_at",null).in("assigned_to",o.map(e=>e.id)).gte("scheduled_start",e.toISOString()).lte("scheduled_start",t.toISOString()),n={};i?.forEach(e=>{e.assigned_to&&(n[e.assigned_to]=(n[e.assigned_to]||0)+1)}),o=o.map(e=>({...e,jobsOnDate:n[e.id]||0,availability:0===(n[e.id]||0)?"available":4>(n[e.id]||0)?"partially_booked":"fully_booked"}))}return{technicians:o.map(e=>({id:e.id,name:`${e.user?.first_name} ${e.user?.last_name}`,skills:e.skills,certifications:e.certifications,availability:e.availability})),total:o.length}}catch(e){return{error:e instanceof Error?e.message:"Failed to find technicians"}}}}),eE=(0,c.tool)({description:"Get a technician's current workload and schedule",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),technicianId:a.z.string().describe("Technician membership UUID"),startDate:a.z.string(),endDate:a.z.string()}),execute:async({companyId:e,technicianId:t,startDate:i,endDate:a})=>{try{let r=await createClient(),{data:n}=await r.from("company_memberships").select("id, user:users(first_name, last_name)").eq("id",t).eq("company_id",e).single();if(!n)return{error:"Technician not found"};let{data:s}=await r.from("jobs").select("id, title, status, scheduled_start, scheduled_end, customer:customers(name)").eq("assigned_to",t).is("deleted_at",null).gte("scheduled_start",i).lte("scheduled_start",a).order("scheduled_start");return{technician:{id:n.id,name:`${n.user?.first_name} ${n.user?.last_name}`},summary:{totalJobs:s?.length||0,completed:s?.filter(e=>"completed"===e.status).length||0,scheduled:s?.filter(e=>"scheduled"===e.status).length||0},jobs:s?.map(e=>({id:e.id,title:e.title,status:e.status,scheduledStart:e.scheduled_start,customer:e.customer?.name}))||[]}}catch(e){return{error:e instanceof Error?e.message:"Failed to get technician workload"}}}}),eR=(0,c.tool)({description:"Search price book for services, parts, and flat-rate pricing",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),query:a.z.string(),category:a.z.string().optional()}),execute:async({companyId:e,query:t,category:i})=>{let a=(await createClient()).from("price_book_items").select("id, name, description, category, sku, unit_price, cost, is_active").eq("company_id",e).eq("is_active",!0).or(`name.ilike.%${t}%,description.ilike.%${t}%,sku.ilike.%${t}%`);i&&(a=a.eq("category",i));let{data:r,error:n}=await a.order("name").limit(20);return n?{error:n.message}:{items:r.map(e=>({...e,profit:e.unit_price-(e.cost||0)})),total:r.length}}}),e$=(0,c.tool)({description:"Calculate an estimate total from price book items",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),items:a.z.array(a.z.object({priceBookItemId:a.z.string().optional(),name:a.z.string().optional(),quantity:a.z.number().default(1),customPrice:a.z.number().optional()})),discount:a.z.object({type:a.z.enum(["percentage","fixed"]),value:a.z.number()}).optional(),taxRate:a.z.number().optional()}),execute:async({companyId:e,items:t,discount:i,taxRate:a})=>{let r=await createClient(),n=t.filter(e=>e.priceBookItemId).map(e=>e.priceBookItemId),s=[];if(n.length>0){let{data:e}=await r.from("price_book_items").select("id, name, unit_price, cost").in("id",n);s=e||[]}let o=t.map(e=>{let t=s.find(t=>t.id===e.priceBookItemId),i=e.customPrice||t?.unit_price||0;return{name:e.name||t?.name||"Unknown Item",quantity:e.quantity,unitPrice:i,lineTotal:i*e.quantity}}),c=o.reduce((e,t)=>e+t.lineTotal,0),l=0;i&&(l="percentage"===i.type?c*(i.value/100):i.value);let u=c-l,d=(a||0)/100*u;return{lineItems:o,subtotal:c,discount:l>0?{...i,amount:l}:null,tax:{rate:a||0,amount:d},grandTotal:u+d}}}),eM=(0,c.tool)({description:"Suggest the best technician for a job based on skills, location, and availability",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),jobType:a.z.string(),requiredSkills:a.z.array(a.z.string()).optional(),preferredDate:a.z.string()}),execute:async({companyId:e,jobType:t,requiredSkills:i,preferredDate:a})=>{try{let r=await createClient(),{data:n}=await r.from("company_memberships").select("id, skills, preferred_job_types, user:users(first_name, last_name)").eq("company_id",e).eq("role","technician");if(!n?.length)return{error:"No technicians found"};let s=new Date(a);s.setHours(0,0,0,0);let o=new Date(a);o.setHours(23,59,59,999);let{data:c}=await r.from("jobs").select("assigned_to").is("deleted_at",null).in("assigned_to",n.map(e=>e.id)).gte("scheduled_start",s.toISOString()).lte("scheduled_start",o.toISOString()),l={};c?.forEach(e=>{e.assigned_to&&(l[e.assigned_to]=(l[e.assigned_to]||0)+1)});let u=n.map(e=>{let a=0,r=[],n=(e.skills||[]).map(e=>e.toLowerCase()),s=(i||[]).filter(e=>n.includes(e.toLowerCase()));s.length>0&&(a+=40*(s.length/(i?.length||1)),r.push(`Matches ${s.length} skills`)),(e.preferred_job_types||[]).map(e=>e.toLowerCase()).includes(t.toLowerCase())&&(a+=20,r.push("Prefers this job type"));let o=l[e.id]||0;return 0===o?(a+=30,r.push("Fully available")):o<3&&(a+=15,r.push(`${o} jobs scheduled`)),{id:e.id,name:`${e.user?.first_name} ${e.user?.last_name}`,score:Math.round(a),reasons:r,jobsOnDate:o}});return u.sort((e,t)=>t.score-e.score),{recommendations:u.slice(0,5),bestMatch:u[0]}}catch(e){return{error:e instanceof Error?e.message:"Failed to suggest technician"}}}}),eU=(0,c.tool)({description:"Optimize the order of jobs for a technician to minimize travel time",inputSchema:a.z.object({companyId:a.z.string().describe("Company UUID"),technicianId:a.z.string(),date:a.z.string()}),execute:async({technicianId:e,date:t})=>{try{let i=await createClient(),a=new Date(t);a.setHours(0,0,0,0);let r=new Date(t);r.setHours(23,59,59,999);let{data:n}=await i.from("jobs").select("id, title, scheduled_start, priority, property:properties(address, city, latitude, longitude)").eq("assigned_to",e).is("deleted_at",null).gte("scheduled_start",a.toISOString()).lte("scheduled_start",r.toISOString()).order("scheduled_start");if(!n||n.length<2)return{message:"Not enough jobs to optimize",jobs:n||[]};let s=n.filter(e=>e.property?.latitude).map(e=>({...e,lat:e.property?.latitude,lng:e.property?.longitude}));if(s.length<2)return{message:"Not enough jobs with location data",jobs:n};let o=[],c=[...s],l={lat:s[0].lat,lng:s[0].lng};for(;c.length>0;){let e=0,t=1/0;c.forEach((i,a)=>{let r=Math.sqrt((i.lat-l.lat)**2+(i.lng-l.lng)**2),n="high"===i.priority?.8:1;r*n<t&&(t=r*n,e=a)});let i=c.splice(e,1)[0];o.push(i),l={lat:i.lat,lng:i.lng}}return{optimizedOrder:o.map((e,t)=>({order:t+1,jobId:e.id,title:e.title,address:`${e.property?.address}, ${e.property?.city}`})),jobCount:o.length}}catch(e){return{error:e instanceof Error?e.message:"Failed to optimize job order"}}}}),eP=(0,c.tool)({description:"Search the web for information. Use this to find answers to questions, research topics, look up current events, regulations, industry news, competitor information, or any general knowledge questions.",inputSchema:a.z.object({query:a.z.string().describe("The search query - be specific and include relevant keywords"),numResults:a.z.number().optional().default(5).describe("Number of results to return (1-10)"),dateRestrict:a.z.string().optional().describe("Limit to recent results: d7 (7 days), m1 (1 month), y1 (1 year)")}),execute:async({query:e,numResults:t,dateRestrict:i})=>{if(!o.isConfigured())return{success:!1,error:"Web search is not configured. Please set GOOGLE_API_KEY and GOOGLE_SEARCH_ENGINE_ID.",configStatus:o.getConfigStatus()};let a=await o.search(e,{num:Math.min(t,10),dateRestrict:i});return a?{success:!0,query:e,totalResults:a.totalResults,searchTime:a.searchTime,results:a.results.map(e=>({title:e.title,url:e.link,snippet:e.snippet,source:e.displayLink}))}:{success:!1,error:"Search failed. Please try again."}}}),eO=(0,c.tool)({description:"Search for recent news articles. Use this for industry news, current events, company updates, regulation changes, or any time-sensitive information.",inputSchema:a.z.object({query:a.z.string().describe("The news search query - include topic and relevant keywords"),daysBack:a.z.number().optional().default(7).describe("How many days back to search (1-30)"),numResults:a.z.number().optional().default(5).describe("Number of results to return (1-10)")}),execute:async({query:e,daysBack:t,numResults:i})=>{if(!o.isConfigured())return{success:!1,error:"Web search is not configured. Please set GOOGLE_API_KEY and GOOGLE_SEARCH_ENGINE_ID."};let a=await o.searchNews(e,{daysBack:Math.min(t,30),num:Math.min(i,10)});return a?{success:!0,query:e,searchType:"news",daysBack:t,totalResults:a.totalResults,results:a.results.map(e=>({title:e.title,url:e.link,snippet:e.snippet,source:e.displayLink}))}:{success:!1,error:"News search failed. Please try again."}}}),eL=(0,c.tool)({description:"Search for technical documentation, guides, tutorials, and code examples. Use this when looking for how to do something technical, API documentation, troubleshooting guides, or code references.",inputSchema:a.z.object({query:a.z.string().describe("The technical search query - include technology names and specific topics"),numResults:a.z.number().optional().default(5).describe("Number of results to return (1-10)")}),execute:async({query:e,numResults:t})=>{if(!o.isConfigured())return{success:!1,error:"Web search is not configured. Please set GOOGLE_API_KEY and GOOGLE_SEARCH_ENGINE_ID."};let i=await o.searchTechnical(e,{num:Math.min(t,10)});return i?{success:!0,query:e,searchType:"technical",totalResults:i.totalResults,results:i.results.map(e=>({title:e.title,url:e.link,snippet:e.snippet,source:e.displayLink}))}:{success:!1,error:"Technical search failed. Please try again."}}}),eN=(0,c.tool)({description:"Search within a specific website. Use this to find information on a particular site like manufacturer documentation, government sites, or specific company websites.",inputSchema:a.z.object({query:a.z.string().describe("The search query"),site:a.z.string().describe("The domain to search within (e.g., 'epa.gov', 'osha.gov', 'lennox.com')"),numResults:a.z.number().optional().default(5).describe("Number of results to return (1-10)")}),execute:async({query:e,site:t,numResults:i})=>{if(!o.isConfigured())return{success:!1,error:"Web search is not configured. Please set GOOGLE_API_KEY and GOOGLE_SEARCH_ENGINE_ID."};let a=await o.searchSite(e,t,{num:Math.min(i,10)});return a?{success:!0,query:e,site:t,totalResults:a.totalResults,results:a.results.map(e=>({title:e.title,url:e.link,snippet:e.snippet}))}:{success:!1,error:"Site search failed. Please try again."}}}),eF={sendEmail:{isDestructive:!0,actionType:"send_communication",riskLevel:"high",requiresOwnerApproval:!0,description:"Sends an email to a customer on behalf of your company",affectedEntityType:"customer"},sendSms:{isDestructive:!0,actionType:"send_communication",riskLevel:"high",requiresOwnerApproval:!0,description:"Sends an SMS message to a customer on behalf of your company",affectedEntityType:"customer"},initiateCall:{isDestructive:!0,actionType:"send_communication",riskLevel:"critical",requiresOwnerApproval:!0,description:"Initiates a phone call to a customer",affectedEntityType:"customer"},sendTeamEmail:{isDestructive:!0,actionType:"send_communication",riskLevel:"medium",requiresOwnerApproval:!0,description:"Sends an internal email to a team member",affectedEntityType:"team_member"},sendTeamSms:{isDestructive:!0,actionType:"send_communication",riskLevel:"medium",requiresOwnerApproval:!0,description:"Sends an SMS to a team member",affectedEntityType:"team_member"},sendVendorEmail:{isDestructive:!0,actionType:"send_communication",riskLevel:"high",requiresOwnerApproval:!0,description:"Sends an email to a vendor on behalf of your company",affectedEntityType:"vendor"},sendVendorSms:{isDestructive:!0,actionType:"send_communication",riskLevel:"high",requiresOwnerApproval:!0,description:"Sends an SMS to a vendor on behalf of your company",affectedEntityType:"vendor"},sendImmediateNotification:{isDestructive:!0,actionType:"send_communication",riskLevel:"high",requiresOwnerApproval:!0,description:"Sends an immediate notification to a recipient",affectedEntityType:"notification"},createInvoice:{isDestructive:!0,actionType:"financial",riskLevel:"high",requiresOwnerApproval:!0,description:"Creates a new invoice that will be sent to a customer",affectedEntityType:"invoice"},transferToBucket:{isDestructive:!0,actionType:"financial",riskLevel:"critical",requiresOwnerApproval:!0,description:"Transfers funds between financial buckets",affectedEntityType:"finance_bucket"},createAppointment:{isDestructive:!0,actionType:"bulk_update",riskLevel:"medium",requiresOwnerApproval:!0,description:"Creates a new appointment which commits company resources",affectedEntityType:"appointment"},cancelReminder:{isDestructive:!0,actionType:"delete",riskLevel:"low",requiresOwnerApproval:!0,description:"Cancels a scheduled reminder",affectedEntityType:"reminder"},updateCustomer:{isDestructive:!0,actionType:"bulk_update",riskLevel:"medium",requiresOwnerApproval:!0,description:"Modifies customer record information",affectedEntityType:"customer"}};function eG(e){return e in eF}function eB(e){return eF[e]||null}async function eH(e,i){let a=(0,t.createServiceSupabaseClient)(),{data:r,error:n}=await a.rpc("is_company_owner",{p_company_id:e,p_user_id:i});return n?(console.error("Error checking owner status:",n),!1):!0===r}async function eW(e){var i,a;let r,n=(0,t.createServiceSupabaseClient)(),s=eB(e.toolName);if(!s)return{success:!1,error:`Tool '${e.toolName}' is not registered as destructive`};let o=new Date;o.setHours(o.getHours()+24);let{data:c,error:l}=await n.from("ai_pending_actions").insert({company_id:e.companyId,chat_id:e.chatId,message_id:e.messageId,user_id:e.userId,tool_name:e.toolName,tool_args:e.toolArgs,action_type:s.actionType,action_title:`AI wants to: ${s.description}`,action_summary:(i=e.toolName,a=e.toolArgs,r=[s.description],(a.to||a.recipient)&&r.push(`Recipient: ${a.to||a.recipient}`),a.subject&&r.push(`Subject: "${a.subject}"`),a.customerId&&r.push(`Customer ID: ${a.customerId}`),a.amount&&r.push(`Amount: $${a.amount/100}`),r.join(" | ")),action_details:{toolName:e.toolName,toolArgs:e.toolArgs,metadata:s},affected_entity_type:s.affectedEntityType,affected_entity_ids:e.affectedEntityIds||[],affected_count:e.affectedEntityIds?.length||1,risk_level:s.riskLevel,status:"pending",urgency:"critical"===s.riskLevel?"high":"high"===s.riskLevel?"medium":"low",expires_at:o.toISOString(),action_log_id:crypto.randomUUID()}).select("id").single();return l?(console.error("Error creating pending action:",l),{success:!1,error:l.message}):{success:!0,pendingActionId:c.id}}async function eV(e,i,a){let r=(0,t.createServiceSupabaseClient)(),{error:n}=await r.from("ai_pending_actions").update({status:"executed",executed_at:new Date().toISOString(),execution_result:a,updated_at:new Date().toISOString()}).eq("company_id",e).eq("id",i).eq("status","approved");return!n||(console.error("Error marking action as executed:",n),!1)}async function eY(e,i,a){let r=(0,t.createServiceSupabaseClient)(),{error:n}=await r.from("ai_pending_actions").update({status:"failed",execution_error:a,updated_at:new Date().toISOString()}).eq("company_id",e).eq("id",i).eq("status","approved");return!n||(console.error("Error marking action as failed:",n),!1)}async function eJ(e,t,i){if(!eG(e))return{intercept:!1};let a=eB(e);if(!a||!a.requiresOwnerApproval)return{intercept:!1};await eH(i.companyId,i.userId);let r=await eW({companyId:i.companyId,chatId:i.chatId,messageId:i.messageId,userId:i.userId,toolName:e,toolArgs:t});return r.success?{intercept:!0,pendingActionId:r.pendingActionId,metadata:a}:{intercept:!0,error:r.error,metadata:a}}e.s(["aiAgentTools",0,{listDatabaseTables:l,queryDatabase:u,getRecordById:d,getRelatedRecords:m,getCompanyOverview:p,searchAllEntities:g,searchCustomers:h,getCustomerDetails:y,createCustomer:f,updateCustomer:b,searchTeamMembers:_,getTeamMemberDetails:v,sendTeamEmail:w,sendTeamSms:S,searchVendors:z,getVendorDetails:q,sendVendorEmail:I,sendVendorSms:k,searchProperties:C,getPropertyDetails:j,searchEquipment:T,getMaintenanceDue:D,searchJobs:x,createAppointment:A,getAvailableSlots:E,searchInvoices:R,createInvoice:$,getFinancialSummary:M,getVirtualBuckets:U,transferToBucket:P,sendEmail:O,sendSms:L,initiateCall:N,getCommunicationHistory:F,scheduleReminder:H,cancelReminder:W,getScheduledReminders:V,sendImmediateNotification:Y,getJobCostingReport:J,getRevenueBreakdown:K,getARAgingReport:X,getTeamPerformanceReport:Q,getCustomerLifetimeValue:Z,getDashboardMetrics:G,getProactiveInsights:B,searchEstimates:ee,searchContracts:et},"analyzeRecentCommunicationsTool",0,ew,"buildCustomerProfileTool",0,ez,"calculateEstimateTool",0,e$,"checkEquipmentWarrantyTool",0,ex,"checkPartsAvailabilityTool",0,eC,"checkWeatherForJobTool",0,em,"createAppointmentTool",0,A,"createInvoiceTool",0,$,"extractCommunicationInsightsTool",0,eu,"findNearbySuppliersTool",0,eI,"findTechniciansBySkillsTool",0,eA,"geocodeAddressTool",0,eh,"getAvailableSlotsTool",0,E,"getCallTranscriptTool",0,eo,"getCodeComplianceChecklistTool",0,ev,"getCompanyOverviewTool",0,p,"getCustomerCommunicationHistoryTool",0,el,"getCustomerDetailsTool",0,y,"getDestructiveToolMetadata",()=>eB,"getEntityMemoriesTool",0,er,"getEquipmentServiceHistoryTool",0,eD,"getLowStockAlertsTool",0,ej,"getPermitRequirementsTool",0,e_,"getPropertyConditionsTool",0,ey,"getPropertyEquipmentTool",0,eT,"getRouteTool",0,eq,"getTechnicianWorkloadTool",0,eE,"getTrafficConditionsTool",0,eg,"getWeatherAlertsTool",0,ep,"getWeatherForLocationTool",0,ed,"isDestructiveTool",()=>eG,"learnFromCompletedJobsTool",0,eS,"optimizeJobOrderTool",0,eU,"recallContextTool",0,en,"scheduleReminderTool",0,H,"searchBuildingCodesTool",0,eb,"searchCommunicationsFullTextTool",0,es,"searchCustomersTool",0,h,"searchInventoryTool",0,ek,"searchInvoicesTool",0,R,"searchJobsTool",0,x,"searchMemoriesTool",0,ea,"searchPriceBookTool",0,eR,"searchVoicemailTranscriptsTool",0,ec,"sendEmailTool",0,O,"sendSmsTool",0,L,"storeMemoryTool",0,ei,"suggestTechnicianForJobTool",0,eM,"toolCategories",0,{listDatabaseTables:"reporting",queryDatabase:"reporting",getRecordById:"reporting",getRelatedRecords:"reporting",getCompanyOverview:"reporting",searchAllEntities:"reporting",searchCustomers:"customer",getCustomerDetails:"customer",createCustomer:"customer",updateCustomer:"customer",searchTeamMembers:"team",getTeamMemberDetails:"team",sendTeamEmail:"team",sendTeamSms:"team",searchVendors:"vendor",getVendorDetails:"vendor",sendVendorEmail:"vendor",sendVendorSms:"vendor",searchProperties:"property",getPropertyDetails:"property",searchEquipment:"equipment",getMaintenanceDue:"equipment",searchJobs:"scheduling",createAppointment:"scheduling",getAvailableSlots:"scheduling",searchInvoices:"financial",createInvoice:"financial",getFinancialSummary:"reporting",getVirtualBuckets:"financial",transferToBucket:"financial",sendEmail:"communication",sendSms:"communication",initiateCall:"communication",getCommunicationHistory:"communication",scheduleReminder:"notification",cancelReminder:"notification",getScheduledReminders:"notification",sendImmediateNotification:"notification",getJobCostingReport:"reporting",getRevenueBreakdown:"reporting",getARAgingReport:"reporting",getTeamPerformanceReport:"reporting",getCustomerLifetimeValue:"reporting",getDashboardMetrics:"reporting",getProactiveInsights:"reporting",searchEstimates:"financial",searchContracts:"financial"},"updateCustomerTool",0,b,"webSearchNewsTool",0,eO,"webSearchSiteTool",0,eN,"webSearchTechnicalTool",0,eL,"webSearchTool",0,eP],477902),e.s(["markActionExecuted",()=>eV,"markActionFailed",()=>eY,"shouldInterceptTool",()=>eJ],536804)}];

//# sourceMappingURL=apps_web_src_lib_ai_action-approval_ts_833f5fdf._.js.map