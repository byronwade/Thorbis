module.exports=[689788,e=>{"use strict";var t=e.i(755535),r=e.i(377233),n=e.i(490003),s=e.i(492991),a=e.i(241970),o=e.i(357699),i=e.i(212454),l=e.i(48717),c=e.i(798301),u=e.i(986366),d=e.i(983537),p=e.i(147475),m=e.i(561930),f=e.i(803747),h=e.i(368557),y=e.i(42037),g=e.i(193695);e.i(432036);var x=e.i(573881),w=e.i(297676),v=e.i(350318);e.i(16106);var R=e.i(985647);let A=new class{projectId;location;serviceAccountKey;tokenCache=null;processors;constructor(){this.projectId=process.env.GOOGLE_CLOUD_PROJECT_ID||null,this.location=process.env.GOOGLE_CLOUD_LOCATION||"us",this.serviceAccountKey=process.env.GOOGLE_SERVICE_ACCOUNT_KEY||null,this.processors={general:process.env.GOOGLE_DOCUMENT_AI_GENERAL_PROCESSOR_ID||null,invoice:process.env.GOOGLE_DOCUMENT_AI_INVOICE_PROCESSOR_ID||null,receipt:process.env.GOOGLE_DOCUMENT_AI_RECEIPT_PROCESSOR_ID||null,form:process.env.GOOGLE_DOCUMENT_AI_FORM_PROCESSOR_ID||null,ocr:process.env.GOOGLE_DOCUMENT_AI_OCR_PROCESSOR_ID||null}}isConfigured(){return!!(this.projectId&&this.serviceAccountKey&&(this.processors.general||this.processors.ocr))}async getAccessToken(){if(!this.serviceAccountKey)throw Error("GOOGLE_SERVICE_ACCOUNT_KEY not configured");if(this.tokenCache&&Date.now()<this.tokenCache.expiry)return this.tokenCache.token;let t=JSON.parse(this.serviceAccountKey),r=Math.floor(Date.now()/1e3),n={iss:t.client_email,scope:"https://www.googleapis.com/auth/cloud-platform",aud:"https://oauth2.googleapis.com/token",iat:r,exp:r+3600},s=Buffer.from(JSON.stringify({alg:"RS256",typ:"JWT"})).toString("base64url"),a=Buffer.from(JSON.stringify(n)).toString("base64url"),o=`${s}.${a}`,i=(await e.A(485685)).createSign("RSA-SHA256");i.update(o);let l=i.sign(t.private_key,"base64url"),c=`${o}.${l}`,u=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",assertion:c})});if(!u.ok)throw Error(`Failed to get access token: ${u.statusText}`);let d=await u.json();return this.tokenCache={token:d.access_token,expiry:Date.now()+(d.expires_in-60)*1e3},d.access_token}getProcessorUrl(e){return`https://${this.location}-documentai.googleapis.com/v1/projects/${this.projectId}/locations/${this.location}/processors/${e}:process`}async processDocument(e,t){let r=await this.getAccessToken(),n=t||this.processors.general||this.processors.ocr;if(!n)throw Error("No Document AI processor configured");let s={skipHumanReview:!0};if(e.content)s.rawDocument={content:e.content,mimeType:e.mimeType};else if(e.gcsUri)s.gcsDocument={gcsUri:e.gcsUri,mimeType:e.mimeType};else throw Error("Either content or gcsUri must be provided");let a=await fetch(this.getProcessorUrl(n),{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(!a.ok){let e=await a.text();throw Error(`Document AI error: ${e}`)}let o=await a.json();return this.parseDocumentResponse(o.document)}parseDocumentResponse(e){let t=[];if(e.pages&&Array.isArray(e.pages))for(let r of e.pages){let n={pageNumber:r.pageNumber||1,width:r.dimension?.width||0,height:r.dimension?.height||0,blocks:[],paragraphs:[],tables:[]};if(r.blocks&&Array.isArray(r.blocks))for(let t of r.blocks)n.blocks.push({text:this.getTextFromLayout(t.layout,e.text),confidence:t.layout?.confidence||0,boundingPoly:t.layout?.boundingPoly||{normalizedVertices:[]}});if(r.paragraphs&&Array.isArray(r.paragraphs))for(let t of r.paragraphs)n.paragraphs.push({text:this.getTextFromLayout(t.layout,e.text),confidence:t.layout?.confidence||0});if(r.tables&&Array.isArray(r.tables))for(let t of r.tables){let r=[],s=[];if(t.headerRows&&Array.isArray(t.headerRows))for(let n of t.headerRows){let t=[];if(n.cells&&Array.isArray(n.cells))for(let r of n.cells)t.push(this.getTextFromLayout(r.layout,e.text));r.push(t)}if(t.bodyRows&&Array.isArray(t.bodyRows))for(let r of t.bodyRows){let t=[];if(r.cells&&Array.isArray(r.cells))for(let n of r.cells)t.push(this.getTextFromLayout(n.layout,e.text));s.push(t)}n.tables.push({headerRows:r,bodyRows:s,confidence:t.layout?.confidence||0})}t.push(n)}let r=[];if(e.entities&&Array.isArray(e.entities))for(let t of e.entities)r.push(this.parseEntity(t));return{text:e.text||"",pages:t,entities:r,mimeType:e.mimeType||"application/pdf",confidence:this.calculateOverallConfidence(t)}}getTextFromLayout(e,t){if(!e||!e.textAnchor)return"";let r=e.textAnchor;if(!r.textSegments||0===r.textSegments.length)return"";let n="";for(let e of r.textSegments){let r=parseInt(e.startIndex||"0",10),s=parseInt(e.endIndex||"0",10);n+=t.substring(r,s)}return n.trim()}parseEntity(e){let t={type:e.type||"unknown",mentionText:e.mentionText||"",confidence:e.confidence||0};if(e.normalizedValue){let r=e.normalizedValue;if(t.normalizedValue={},r.text&&(t.normalizedValue.text=r.text),r.moneyValue){let e=r.moneyValue;t.normalizedValue.moneyValue={currencyCode:e.currencyCode||"USD",units:e.units||"0",nanos:e.nanos}}if(r.dateValue){let e=r.dateValue;t.normalizedValue.dateValue={year:e.year||0,month:e.month||0,day:e.day||0}}}return e.properties&&Array.isArray(e.properties)&&(t.properties=e.properties.map(e=>this.parseEntity(e))),t}calculateOverallConfidence(e){if(0===e.length)return 0;let t=0,r=0;for(let n of e)for(let e of n.blocks)t+=e.confidence,r++;return r>0?t/r:0}async processVendorInvoice(e){let t=this.processors.invoice||this.processors.form||this.processors.general,r=await this.processDocument(e,t||void 0),n={vendorName:null,vendorAddress:null,invoiceNumber:null,invoiceDate:null,dueDate:null,subtotal:null,tax:null,total:null,currency:"USD",lineItems:[],paymentTerms:null,purchaseOrderNumber:null,rawText:r.text,confidence:r.confidence};for(let e of r.entities){let t=e.type.toLowerCase(),r=e.normalizedValue?.text||e.mentionText;if(t.includes("supplier")||t.includes("vendor"))n.vendorName=r;else if(t.includes("invoice_id")||t.includes("invoice_number"))n.invoiceNumber=r;else if(t.includes("invoice_date"))n.invoiceDate=this.formatDate(e.normalizedValue?.dateValue);else if(t.includes("due_date")||t.includes("payment_due"))n.dueDate=this.formatDate(e.normalizedValue?.dateValue);else if(t.includes("subtotal")||t.includes("net_amount"))n.subtotal=this.extractMoneyValue(e);else if(t.includes("tax")||t.includes("vat"))n.tax=this.extractMoneyValue(e);else if(t.includes("total")||t.includes("amount_due"))n.total=this.extractMoneyValue(e);else if(t.includes("currency"))n.currency=r||"USD";else if(t.includes("purchase_order")||t.includes("po_number"))n.purchaseOrderNumber=r;else if(t.includes("payment_terms"))n.paymentTerms=r;else if(t.includes("line_item")&&e.properties){let t=this.extractLineItem(e);t&&n.lineItems.push(t)}}if(0===n.lineItems.length&&r.pages.length>0)for(let e of r.pages)for(let t of e.tables){let e=this.extractLineItemsFromTable(t);n.lineItems.push(...e)}return n}async processEquipmentWarranty(e){let t=await this.processDocument(e),r={manufacturer:null,modelNumber:null,serialNumber:null,purchaseDate:null,warrantyStartDate:null,warrantyEndDate:null,warrantyType:null,coverageDetails:[],exclusions:[],contactInfo:{phone:null,email:null,website:null},rawText:t.text,confidence:t.confidence},n=t.text.toLowerCase(),s=t.text.match(/model\s*(?:no\.?|number|#)?\s*:?\s*([A-Z0-9-]+)/i);s&&(r.modelNumber=s[1]);let a=t.text.match(/serial\s*(?:no\.?|number|#)?\s*:?\s*([A-Z0-9-]+)/i);a&&(r.serialNumber=a[1]);let o=t.text.match(/warranty\s*(?:period|term)?\s*:?\s*(\d+)\s*(?:year|month)/i);o&&(r.warrantyType=`${o[1]} ${o[0].includes("month")?"months":"years"}`);let i=t.text.match(/(?:phone|tel|call)\s*:?\s*([\d-().\s]+)/i);i&&(r.contactInfo.phone=i[1].trim());let l=t.text.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);l&&(r.contactInfo.email=l[1]);let c=t.text.match(/(https?:\/\/[^\s]+|www\.[^\s]+)/i);for(let e of(c&&(r.contactInfo.website=c[1]),[/parts\s+and\s+labor/i,/compressor/i,/heat\s+exchanger/i,/coil/i,/refrigerant/i,/electrical/i])){let t=n.match(e);t&&r.coverageDetails.push(t[0])}if(n.includes("exclusion")||n.includes("not covered")||n.includes("does not include")){let e=t.text.match(/(?:exclusion|not covered|does not include)[:\s]*([\s\S]*?)(?:\n\n|$)/i);e&&(r.exclusions=e[1].split(/[•\-\n]/).filter(e=>e.trim()).map(e=>e.trim()).slice(0,10))}return r}async processPermitDocument(e){let t=await this.processDocument(e),r={permitNumber:null,permitType:null,issueDate:null,expirationDate:null,propertyAddress:null,ownerName:null,contractorName:null,contractorLicense:null,scopeOfWork:null,inspectionRequirements:[],fees:{permitFee:null,inspectionFee:null,total:null},issuingAuthority:null,rawText:t.text,confidence:t.confidence},n=t.text.match(/permit\s*(?:no\.?|number|#)?\s*:?\s*([A-Z0-9-]+)/i);for(let e of(n&&(r.permitNumber=n[1]),["HVAC","mechanical","plumbing","electrical","building","construction","renovation"]))if(t.text.toLowerCase().includes(e.toLowerCase())){r.permitType=e;break}let s=t.text.match(/(?:property|site|job)\s*address\s*:?\s*([\s\S]*?)(?:\n|$)/i);s&&(r.propertyAddress=s[1].trim());let a=t.text.match(/(?:contractor|license)\s*(?:no\.?|number|#)?\s*:?\s*([A-Z0-9-]+)/i);for(let e of(a&&(r.contractorLicense=a[1]),[/rough.?in\s*inspection/i,/final\s*inspection/i,/framing\s*inspection/i,/underground\s*inspection/i])){let n=t.text.match(e);n&&r.inspectionRequirements.push(n[0])}for(let e of t.entities)if(e.type.toLowerCase().includes("fee")||e.type.toLowerCase().includes("amount")){let t=this.extractMoneyValue(e);e.type.toLowerCase().includes("permit")?r.fees.permitFee=t:e.type.toLowerCase().includes("inspection")?r.fees.inspectionFee=t:e.type.toLowerCase().includes("total")&&(r.fees.total=t)}return r}async processCustomerContract(e){let t=this.processors.form||this.processors.general,r=await this.processDocument(e,t||void 0),n={contractNumber:null,contractDate:null,customerName:null,customerAddress:null,serviceAddress:null,contractType:null,startDate:null,endDate:null,totalValue:null,paymentTerms:null,scopeOfWork:[],signatures:[],specialTerms:[],rawText:r.text,confidence:r.confidence},s=r.text.match(/contract\s*(?:no\.?|number|#)?\s*:?\s*([A-Z0-9-]+)/i);for(let e of(s&&(n.contractNumber=s[1]),["service agreement","maintenance contract","installation contract","repair agreement","annual service"]))if(r.text.toLowerCase().includes(e)){n.contractType=e;break}for(let e of r.entities){let t=e.type.toLowerCase(),r=e.normalizedValue?.text||e.mentionText;t.includes("customer")||t.includes("client")?n.customerName=r:t.includes("address")&&!n.customerAddress?n.customerAddress=r:t.includes("service_address")||t.includes("property")?n.serviceAddress=r:t.includes("start_date")||t.includes("effective_date")?n.startDate=this.formatDate(e.normalizedValue?.dateValue):t.includes("end_date")||t.includes("expiration")?n.endDate=this.formatDate(e.normalizedValue?.dateValue):(t.includes("total")||t.includes("contract_value"))&&(n.totalValue=this.extractMoneyValue(e))}let a=r.text.match(/scope\s*of\s*work\s*:?\s*([\s\S]*?)(?:terms|conditions|payment|\n\n)/i);return a&&(n.scopeOfWork=a[1].split(/[•\-\n]/).filter(e=>e.trim().length>10).map(e=>e.trim()).slice(0,20)),n}async extractEquipmentInfo(e){let t=this.processors.ocr||this.processors.general,r=await this.processDocument(e,t||void 0),n={manufacturer:null,modelNumber:null,serialNumber:null,manufactureDate:null,specifications:{},ratings:{voltage:null,amperage:null,btu:null,seer:null,tonnage:null},refrigerantType:null,rawText:r.text,confidence:r.confidence},s=r.text;for(let e of["Carrier","Trane","Lennox","Rheem","Goodman","York","Bryant","Amana","Daikin","American Standard","Ruud","Heil","Payne","Coleman","Maytag","Frigidaire","Mitsubishi","Fujitsu","LG","Samsung"])if(s.toLowerCase().includes(e.toLowerCase())){n.manufacturer=e;break}for(let e of[/model\s*(?:no\.?|number|#)?\s*:?\s*([A-Z0-9-]+)/i,/m\/n\s*:?\s*([A-Z0-9-]+)/i,/mod\s*:?\s*([A-Z0-9-]+)/i]){let t=s.match(e);if(t){n.modelNumber=t[1];break}}for(let e of[/serial\s*(?:no\.?|number|#)?\s*:?\s*([A-Z0-9-]+)/i,/s\/n\s*:?\s*([A-Z0-9-]+)/i,/ser\s*:?\s*([A-Z0-9-]+)/i]){let t=s.match(e);if(t){n.serialNumber=t[1];break}}let a=s.match(/(\d{2,3})\s*(?:v|volt)/i);a&&(n.ratings.voltage=`${a[1]}V`);let o=s.match(/(\d+\.?\d*)\s*(?:a|amp)/i);o&&(n.ratings.amperage=`${o[1]}A`);let i=s.match(/(\d{2,3},?\d{3})\s*(?:btu|btuh)/i);i&&(n.ratings.btu=i[1].replace(",",""));let l=s.match(/seer\s*:?\s*(\d+\.?\d*)/i);l&&(n.ratings.seer=l[1]);let c=s.match(/(\d\.?\d*)\s*ton/i);for(let e of(c&&(n.ratings.tonnage=c[1]),[/R-?410A/i,/R-?22/i,/R-?32/i,/R-?134a/i,/R-?404A/i,/R-?407C/i])){let t=s.match(e);if(t){n.refrigerantType=t[0].toUpperCase();break}}let u=s.match(/(?:mfg|manufactured|mfr)\s*(?:date)?\s*:?\s*(\d{1,2}[-/]\d{1,2}[-/]\d{2,4})/i);return u&&(n.manufactureDate=u[1]),n}async processReceipt(e){let t=this.processors.receipt||this.processors.general,r=await this.processDocument(e,t||void 0),n={merchantName:null,merchantAddress:null,transactionDate:null,transactionTime:null,subtotal:null,tax:null,total:null,paymentMethod:null,cardLastFour:null,lineItems:[],rawText:r.text,confidence:r.confidence};for(let e of r.entities){let t=e.type.toLowerCase(),r=e.normalizedValue?.text||e.mentionText;if(t.includes("merchant")||t.includes("supplier")||t.includes("store"))n.merchantName=r;else if(t.includes("address")&&!n.merchantAddress)n.merchantAddress=r;else if(t.includes("date")&&!n.transactionDate)n.transactionDate=this.formatDate(e.normalizedValue?.dateValue);else if(t.includes("time"))n.transactionTime=r;else if(t.includes("subtotal"))n.subtotal=this.extractMoneyValue(e);else if(t.includes("tax"))n.tax=this.extractMoneyValue(e);else if(t.includes("total"))n.total=this.extractMoneyValue(e);else if(t.includes("payment")||t.includes("tender"))n.paymentMethod=r;else if(t.includes("line_item")&&e.properties){let t=this.extractLineItem(e);t&&n.lineItems.push(t)}}let s=r.text.match(/(?:card|visa|mastercard|amex|discover)[^\d]*(\d{4})\s*$/im);return s&&(n.cardLastFour=s[1]),n}async extractText(e){let t=this.processors.ocr||this.processors.general,r=await this.processDocument(e,t||void 0);return{text:r.text,confidence:r.confidence}}formatDate(e){return e&&e.year?`${e.year}-${String(e.month).padStart(2,"0")}-${String(e.day).padStart(2,"0")}`:null}extractMoneyValue(e){if(e.normalizedValue?.moneyValue){let t=e.normalizedValue.moneyValue;return parseInt(t.units||"0",10)+(t.nanos||0)/1e9}let t=e.mentionText.match(/\$?\s*([\d,]+\.?\d*)/);return t?parseFloat(t[1].replace(",","")):null}extractLineItem(e){if(!e.properties)return null;let t={description:"",quantity:null,unitPrice:null,amount:null};for(let r of e.properties){let e=r.type.toLowerCase();e.includes("description")||e.includes("item")?t.description=r.mentionText:e.includes("quantity")||e.includes("qty")?t.quantity=parseFloat(r.mentionText)||null:e.includes("unit_price")||e.includes("price")?t.unitPrice=this.extractMoneyValue(r):e.includes("amount")||e.includes("total")?t.amount=this.extractMoneyValue(r):(e.includes("part")||e.includes("sku"))&&(t.partNumber=r.mentionText)}return t.description?t:null}extractLineItemsFromTable(e){let t=[],r=e.headerRows[0]||[],n=-1,s=-1,a=-1,o=-1;for(let i of(r.forEach((e,t)=>{let r=e.toLowerCase();r.includes("desc")||r.includes("item")||r.includes("product")?n=t:r.includes("qty")||r.includes("quantity")?s=t:r.includes("price")||r.includes("unit")?a=t:(r.includes("amount")||r.includes("total")||r.includes("ext"))&&(o=t)}),-1===n&&r.length>=4&&(n=0,s=1,a=2,o=3),e.bodyRows)){if(i.length<2)continue;let e={description:n>=0&&i[n]?i[n]:i[0],quantity:s>=0&&i[s]&&parseFloat(i[s])||null,unitPrice:a>=0&&i[a]&&parseFloat(i[a].replace(/[$,]/g,""))||null,amount:o>=0&&i[o]&&parseFloat(i[o].replace(/[$,]/g,""))||null};e.description&&t.push(e)}return t}};var b=e.i(511368);async function C(e){try{let t=await (0,b.createClient)();if(!t)return w.NextResponse.json({error:"Database connection failed"},{status:500});let{data:{user:r}}=await t.auth.getUser();if(!r)return w.NextResponse.json({error:"Unauthorized"},{status:401});let n=await (0,R.getActiveCompanyId)();if(!n)return w.NextResponse.json({error:"No active company selected"},{status:401});if(!A.isConfigured())return w.NextResponse.json({error:"Document AI service not configured"},{status:503});let s=await (0,v.checkApiQuota)(n,"google_document_ai");if(s&&!s.has_quota)return w.NextResponse.json({error:"API quota exceeded",currentUsage:s.current_usage,limit:s.monthly_limit},{status:429});let{action:a,content:o,gcsUri:i,mimeType:l}=await e.json();if(!a)return w.NextResponse.json({error:"action is required"},{status:400});if(!o&&!i)return w.NextResponse.json({error:"Either content (base64) or gcsUri is required"},{status:400});if(!l)return w.NextResponse.json({error:"mimeType is required"},{status:400});let c={content:o,gcsUri:i,mimeType:l},u={process:"process","extract-text":"extract_text","vendor-invoice":"vendor_invoice","equipment-warranty":"equipment_warranty",permit:"permit",contract:"contract","equipment-info":"equipment_info",receipt:"receipt"},d=u[a];if(!d)return w.NextResponse.json({error:`Invalid action: ${a}`,validActions:Object.keys(u)},{status:400});let p=await (0,v.withUsageTracking)(n,"google_document_ai",d,async()=>{switch(a){case"process":return await A.processDocument(c);case"extract-text":return await A.extractText(c);case"vendor-invoice":return await A.processVendorInvoice(c);case"equipment-warranty":return await A.processEquipmentWarranty(c);case"permit":return await A.processPermitDocument(c);case"contract":return await A.processCustomerContract(c);case"equipment-info":return await A.extractEquipmentInfo(c);case"receipt":return await A.processReceipt(c);default:throw Error(`Unknown action: ${a}`)}});if(!p)return w.NextResponse.json({error:"Failed to process document"},{status:500});return w.NextResponse.json(p)}catch(e){if(console.error("Document AI API error:",e),e instanceof Error)return w.NextResponse.json({error:e.message},{status:500});return w.NextResponse.json({error:"Internal server error"},{status:500})}}async function T(){try{let e=A.isConfigured();return w.NextResponse.json({configured:e,supportedActions:["process","extract-text","vendor-invoice","equipment-warranty","permit","contract","equipment-info","receipt"],supportedMimeTypes:["application/pdf","image/png","image/jpeg","image/gif","image/tiff","image/webp","image/bmp"],maxFileSize:"20MB",documentation:"https://cloud.google.com/document-ai/docs"})}catch(e){return console.error("Document AI config check error:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>T,"POST",()=>C],984158);var _=e.i(984158);let E=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/documents/ai/route",pathname:"/api/documents/ai",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/documents/ai/route.ts",nextConfigOutput:"",userland:_}),{workAsyncStorage:D,workUnitAsyncStorage:N,serverHooks:O}=E;function I(){return(0,n.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:N})}async function S(e,t,n){E.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/documents/ai/route";w=w.replace(/\/index$/,"")||"/";let v=await E.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:R,params:A,nextConfig:b,parsedUrl:C,isDraftMode:T,prerenderManifest:_,routerServerContext:D,isOnDemandRevalidate:N,revalidateOnlyGenerated:O,resolvedPathname:I,clientReferenceManifest:S,serverActionsManifest:k}=v,V=(0,l.normalizeAppPath)(w),L=!!(_.dynamicRoutes[V]||_.routes[I]),P=async()=>((null==D?void 0:D.render404)?await D.render404(e,t,C,!1):t.end("This page could not be found"),null);if(L&&!T){let e=!!_.routes[I],t=_.dynamicRoutes[V];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await P();throw new g.NoFallbackError}}let U=null;!L||E.isDev||T||(U="/index"===(U=I)?"/":U);let q=!0===E.isDev||!L,M=L&&!q;k&&S&&(0,o.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:S,serverActionsManifest:k,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:k})});let j=e.method||"GET",$=(0,a.getTracer)(),F=$.getActiveScopeSpan(),G={params:A,prerenderManifest:_,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>E.onRequestError(e,t,n,D)},sharedContext:{buildId:R}},z=new c.NodeNextRequest(e),H=new c.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(z,(0,u.signalFromNodeResponse)(t));try{let o=async e=>E.handle(K,G).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${j} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${w}`)}),i=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var a,l;let c=async({previousCacheEntry:r})=>{try{if(!i&&N&&O&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await o(s);e.fetchMetrics=G.renderOpts.fetchMetrics;let l=G.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let c=G.renderOpts.collectedTags;if(!L)return await (0,m.sendResponse)(z,H,a,G.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[y.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==G.renderOpts.collectedRevalidate&&!(G.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&G.renderOpts.collectedRevalidate,n=void 0===G.renderOpts.collectedExpire||G.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:G.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:N})},D),t}},u=await E.handleResponse({req:e,nextConfig:b,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:_,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:O,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:i});if(!L)return null;if((null==u||null==(a=u.value)?void 0:a.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",N?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return i&&L||d.delete(y.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(z,H,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};F?await l(F):await $.withPropagatedContext(e.headers,()=>$.trace(d.BaseServerSpan.handleRequest,{spanName:`${j} ${w}`,kind:a.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:V,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:N})}),L)throw t;return await (0,m.sendResponse)(z,H,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>I,"routeModule",()=>E,"serverHooks",()=>O,"workAsyncStorage",()=>D,"workUnitAsyncStorage",()=>N],689788)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_ac8c7f8e.js.map