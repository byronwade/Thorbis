module.exports=[387721,e=>{"use strict";var t=e.i(755535),a=e.i(377233),i=e.i(490003),o=e.i(492991),n=e.i(241970),r=e.i(357699),s=e.i(212454),l=e.i(48717),d=e.i(798301),u=e.i(986366),c=e.i(983537),p=e.i(147475),m=e.i(561930),h=e.i(803747),T=e.i(368557),b=e.i(42037),v=e.i(193695);e.i(432036);var g=e.i(573881);e.i(715051);var w=e.i(511368),z=e.i(297676),E=e.i(443608);E.z.object({latitude:E.z.number(),longitude:E.z.number()});let y=E.z.object({seconds:E.z.string()}),R=E.z.object({shipmentIndex:E.z.number(),isPickup:E.z.boolean(),visitRequestIndex:E.z.number(),startTime:E.z.string(),detour:y.optional(),shipmentLabel:E.z.string().optional(),visitLabel:E.z.string().optional()}),S=E.z.object({travelDuration:y,travelDistanceMeters:E.z.number(),trafficInfoUnavailable:E.z.boolean().optional(),waitDuration:y.optional(),totalDuration:y.optional(),startTime:E.z.string().optional(),routePolyline:E.z.object({points:E.z.string()}).optional()}),D=E.z.object({vehicleIndex:E.z.number(),vehicleLabel:E.z.string().optional(),vehicleStartTime:E.z.string(),vehicleEndTime:E.z.string(),visits:E.z.array(R),transitions:E.z.array(S),breaks:E.z.array(E.z.object({startTime:E.z.string(),duration:y})).optional(),metrics:E.z.object({performedShipmentCount:E.z.number(),travelDuration:y,waitDuration:y.optional(),delayDuration:y.optional(),breakDuration:y.optional(),visitDuration:y,totalDuration:y,travelDistanceMeters:E.z.number()}).optional(),routeTotalCost:E.z.number().optional()}),f=E.z.object({routes:E.z.array(D).optional().default([]),skippedShipments:E.z.array(E.z.object({index:E.z.number(),label:E.z.string().optional(),reasons:E.z.array(E.z.object({code:E.z.string(),exampleVehicleIndex:E.z.number().optional()})).optional()})).optional(),metrics:E.z.object({aggregatedRouteMetrics:E.z.object({performedShipmentCount:E.z.number(),travelDuration:y,waitDuration:y.optional(),delayDuration:y.optional(),breakDuration:y.optional(),visitDuration:y,totalDuration:y,travelDistanceMeters:E.z.number()}).optional(),skippedMandatoryShipmentCount:E.z.number().optional(),usedVehicleCount:E.z.number().optional(),earliestVehicleStartTime:E.z.string().optional(),latestVehicleEndTime:E.z.string().optional(),costs:E.z.record(E.z.number()).optional(),totalCost:E.z.number().optional()}).optional()});class I{static instance;apiKey;baseUrl="https://routeoptimization.googleapis.com/v1";cache=new Map;CACHE_TTL=3e5;constructor(){this.apiKey=process.env.GOOGLE_API_KEY||"AIzaSyCVKN0pddG230vvjT0EMP9sSIR31j1q2t0",this.apiKey||console.warn("GoogleRouteOptimizationService: No API key found. Set GOOGLE_API_KEY environment variable.")}static getInstance(){return I.instance||(I.instance=new I),I.instance}isConfigured(){return!!this.apiKey}getCacheKey(e,t){let a=e.map(e=>e.id).join(","),i=t.map(e=>e.id).join(",");return`${a}_${i}`}cleanCache(){let e=Date.now();for(let[t,a]of this.cache.entries())e-a.timestamp>this.CACHE_TTL&&this.cache.delete(t)}minutesToDuration(e){return{seconds:String(60*e)}}durationToMinutes(e){return Math.round(parseInt(e.seconds,10)/60)}dateToIso(e){return e.toISOString()}async optimizeRoutes(e,t,a={}){if(!this.apiKey)throw Error("Route Optimization API key not configured");if(0===e.length)return{routes:[],unassignedJobs:[],totalTravelTime:0,totalTravelDistance:0,totalJobs:0,assignedJobs:0};if(0===t.length)return{routes:[],unassignedJobs:e.map(e=>({jobId:e.id,jobName:e.name,reason:"No technicians available"})),totalTravelTime:0,totalTravelDistance:0,totalJobs:e.length,assignedJobs:0};let i=this.getCacheKey(e,t);this.cleanCache();let o=this.cache.get(i);if(o)return o.result;let n=new Date,r=a.workdayStart||new Date(n.setHours(8,0,0,0)),s=a.workdayEnd||new Date(n.setHours(18,0,0,0)),l={model:{shipments:e.map(e=>({deliveries:[{arrivalLocation:e.location,duration:this.minutesToDuration(e.duration),timeWindows:e.timeWindowStart&&e.timeWindowEnd?[{startTime:this.dateToIso(e.timeWindowStart),endTime:this.dateToIso(e.timeWindowEnd)}]:void 0,label:e.name}],label:e.id,penaltyCost:"urgent"===e.priority?1e4:"high"===e.priority?5e3:"low"===e.priority?100:1e3,loadDemands:e.loadRequirements?Object.fromEntries(Object.entries(e.loadRequirements).map(([e,t])=>[e,{amount:String(t)}])):void 0})),vehicles:t.map(e=>({startLocation:e.startLocation,endLocation:e.endLocation||e.startLocation,startTimeWindows:[{startTime:this.dateToIso(e.workdayStart),endTime:this.dateToIso(e.workdayStart)}],endTimeWindows:[{startTime:this.dateToIso(e.workdayStart),endTime:this.dateToIso(e.workdayEnd)}],travelMode:"DRIVING",loadLimits:e.vehicleCapacity?Object.fromEntries(Object.entries(e.vehicleCapacity).map(([e,t])=>[e,{maxLoad:String(t)}])):void 0,breakRule:e.breakTime?{breakRequests:[{earliestStartTime:this.dateToIso(e.breakTime.earliestStart),latestStartTime:this.dateToIso(e.breakTime.latestStart),minDuration:this.minutesToDuration(e.breakTime.duration)}]}:void 0,label:e.id})),globalStartTime:this.dateToIso(r),globalEndTime:this.dateToIso(s)},considerRoadTraffic:a.considerTraffic??!0,populatePolylines:a.includePolylines??!1,populateTransitionPolylines:a.includePolylines??!1},d=await fetch(`${this.baseUrl}/projects/-:optimizeTours?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!d.ok){let e=await d.json();throw Error(`Route Optimization API error: ${e.error?.message||d.statusText}`)}let u=await d.json(),c=f.parse(u),p=this.convertToOptimizationResult(c,e,t);return this.cache.set(i,{result:p,timestamp:Date.now()}),p}async optimizeSingleTechnicianRoute(e,t,a={}){let i=await this.optimizeRoutes(e,[t],a);return 0===i.routes.length?null:i.routes[0]}async getOptimalJobSequence(e,t,a){let i=new Date,o={id:"temp",name:"Temporary",startLocation:t,endLocation:a||t,workdayStart:new Date(i.getFullYear(),i.getMonth(),i.getDate(),0,0,0),workdayEnd:new Date(i.getFullYear(),i.getMonth(),i.getDate(),23,59,59)},n=await this.optimizeRoutes(e,[o],{considerTraffic:!0});if(0===n.routes.length)return{sequence:e.map(e=>e.id),totalTravelTime:0,totalTravelDistance:0};let r=n.routes[0];return{sequence:r.jobs.map(e=>e.jobId),totalTravelTime:r.totalTravelTime,totalTravelDistance:r.totalTravelDistance}}async calculateSavings(e,t){let a=await this.getOptimalJobSequence(e,t),i=0,o=t;for(let t of e)i+=this.haversineDistance(o,t.location),o=t.location;let n=Math.round(i/1e3/40*60),r=a.totalTravelTime,s=Math.max(0,n-r);return{originalTime:n,optimizedTime:r,timeSaved:s,percentSaved:n>0?Math.round(s/n*100):0}}haversineDistance(e,t){let a=e.latitude*Math.PI/180,i=t.latitude*Math.PI/180,o=(t.latitude-e.latitude)*Math.PI/180,n=(t.longitude-e.longitude)*Math.PI/180,r=Math.sin(o/2)*Math.sin(o/2)+Math.cos(a)*Math.cos(i)*Math.sin(n/2)*Math.sin(n/2);return 2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))*6371e3}convertToOptimizationResult(e,t,a){let i=[];for(let o of e.routes){let e=a[o.vehicleIndex];if(!e)continue;let n=[];for(let e=0;e<o.visits.length;e++){let a=o.visits[e];o.transitions[e+1];let i=t[a.shipmentIndex];if(!i)continue;let r=new Date(a.startTime),s=new Date(r.getTime()+60*i.duration*1e3);n.push({jobId:i.id,jobName:i.name,arrivalTime:r,departureTime:s,travelTimeFromPrevious:e>0?this.durationToMinutes(o.transitions[e].travelDuration):0,travelDistanceFromPrevious:e>0?o.transitions[e].travelDistanceMeters:0})}let r=o.breaks?.map(e=>({startTime:new Date(e.startTime),duration:this.durationToMinutes(e.duration)}));i.push({technicianId:e.id,technicianName:e.name,jobs:n,totalTravelTime:o.metrics?this.durationToMinutes(o.metrics.travelDuration):0,totalTravelDistance:o.metrics?.travelDistanceMeters||0,totalWorkTime:o.metrics?this.durationToMinutes(o.metrics.totalDuration):0,startTime:new Date(o.vehicleStartTime),endTime:new Date(o.vehicleEndTime),breaks:r})}let o=e.skippedShipments?.map(e=>{let a=t[e.index],i=e.reasons?.[0]?.code||"UNKNOWN";return{jobId:a?.id||String(e.index),jobName:a?.name||`Job ${e.index}`,reason:({DEMAND_EXCEEDS_VEHICLE_CAPACITY:"Job requirements exceed vehicle capacity",CANNOT_BE_PERFORMED_WITHIN_VEHICLE_DISTANCE_LIMIT:"Job is too far from technician's route",CANNOT_BE_PERFORMED_WITHIN_VEHICLE_DURATION_LIMIT:"Not enough time in technician's schedule",CANNOT_BE_PERFORMED_WITHIN_VEHICLE_TRAVEL_DURATION_LIMIT:"Travel time exceeds limit",CANNOT_BE_PERFORMED_WITHIN_VEHICLE_TIME_WINDOWS:"Job time window conflicts with technician schedule",UNKNOWN:"Unable to schedule job"})[i]||i}})||[],n=i.reduce((e,t)=>e+t.jobs.length,0);return{routes:i,unassignedJobs:o,totalTravelTime:i.reduce((e,t)=>e+t.totalTravelTime,0),totalTravelDistance:i.reduce((e,t)=>e+t.totalTravelDistance,0),totalJobs:t.length,assignedJobs:n}}clearCache(){this.cache.clear()}}let C=I.getInstance(),j=E.z.object({latitude:E.z.number(),longitude:E.z.number()}),k=E.z.object({id:E.z.string(),name:E.z.string(),address:E.z.string().optional().default(""),location:j,duration:E.z.number().min(1),timeWindowStart:E.z.string().datetime().optional(),timeWindowEnd:E.z.string().datetime().optional(),priority:E.z.enum(["low","normal","high","urgent"]).optional(),requiredSkills:E.z.array(E.z.string()).optional(),loadRequirements:E.z.record(E.z.number()).optional()}),N=E.z.object({id:E.z.string(),name:E.z.string(),startLocation:j,endLocation:j.optional(),workdayStart:E.z.string().datetime(),workdayEnd:E.z.string().datetime(),skills:E.z.array(E.z.string()).optional(),vehicleCapacity:E.z.record(E.z.number()).optional(),breakTime:E.z.object({earliestStart:E.z.string().datetime(),latestStart:E.z.string().datetime(),duration:E.z.number()}).optional()}),O=E.z.object({jobs:E.z.array(k).min(1),technicians:E.z.array(N).min(1),options:E.z.object({considerTraffic:E.z.boolean().optional(),includePolylines:E.z.boolean().optional(),workdayStart:E.z.string().datetime().optional(),workdayEnd:E.z.string().datetime().optional()}).optional()}),M=E.z.object({jobs:E.z.array(k).min(1),startLocation:j,endLocation:j.optional()});async function _(e){try{let t=await (0,w.createClient)(),{data:{user:a}}=await t.auth.getUser();if(!a)return z.NextResponse.json({error:"Unauthorized"},{status:401});if(!C.isConfigured())return z.NextResponse.json({error:"Route Optimization service is not configured. Set GOOGLE_API_KEY environment variable."},{status:503});let i=await e.json(),{searchParams:o}=new URL(e.url),n=o.get("action");if("sequence"===n){let e=M.parse(i),t=e.jobs.map(e=>({...e,timeWindowStart:e.timeWindowStart?new Date(e.timeWindowStart):void 0,timeWindowEnd:e.timeWindowEnd?new Date(e.timeWindowEnd):void 0})),a=await C.getOptimalJobSequence(t,e.startLocation,e.endLocation);return z.NextResponse.json({success:!0,data:a})}if("savings"===n){let e=M.parse(i),t=e.jobs.map(e=>({...e,timeWindowStart:e.timeWindowStart?new Date(e.timeWindowStart):void 0,timeWindowEnd:e.timeWindowEnd?new Date(e.timeWindowEnd):void 0})),a=await C.calculateSavings(t,e.startLocation);return z.NextResponse.json({success:!0,data:a})}let r=O.parse(i),s=r.jobs.map(e=>({...e,timeWindowStart:e.timeWindowStart?new Date(e.timeWindowStart):void 0,timeWindowEnd:e.timeWindowEnd?new Date(e.timeWindowEnd):void 0})),l=r.technicians.map(e=>({...e,workdayStart:new Date(e.workdayStart),workdayEnd:new Date(e.workdayEnd),breakTime:e.breakTime?{earliestStart:new Date(e.breakTime.earliestStart),latestStart:new Date(e.breakTime.latestStart),duration:e.breakTime.duration}:void 0})),d=r.options?{...r.options,workdayStart:r.options.workdayStart?new Date(r.options.workdayStart):void 0,workdayEnd:r.options.workdayEnd?new Date(r.options.workdayEnd):void 0}:void 0,u=await C.optimizeRoutes(s,l,d);return z.NextResponse.json({success:!0,data:{routes:u.routes.map(e=>({...e,startTime:e.startTime.toISOString(),endTime:e.endTime.toISOString(),jobs:e.jobs.map(e=>({...e,arrivalTime:e.arrivalTime.toISOString(),departureTime:e.departureTime.toISOString()})),breaks:e.breaks?.map(e=>({startTime:e.startTime.toISOString(),duration:e.duration}))})),unassignedJobs:u.unassignedJobs,summary:{totalTravelTime:u.totalTravelTime,totalTravelDistance:u.totalTravelDistance,totalJobs:u.totalJobs,assignedJobs:u.assignedJobs}}})}catch(e){if(console.error("Route optimization error:",e),e instanceof E.z.ZodError)return z.NextResponse.json({error:"Invalid request data",details:e.errors},{status:400});return z.NextResponse.json({error:"Failed to optimize routes",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}e.s(["POST",()=>_],736200);var x=e.i(736200);let P=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/dispatch/optimize/route",pathname:"/api/dispatch/optimize",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/dispatch/optimize/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:A,workUnitAsyncStorage:L,serverHooks:W}=P;function q(){return(0,i.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:L})}async function H(e,t,i){P.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/dispatch/optimize/route";w=w.replace(/\/index$/,"")||"/";let z=await P.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!z)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:E,params:y,nextConfig:R,parsedUrl:S,isDraftMode:D,prerenderManifest:f,routerServerContext:I,isOnDemandRevalidate:C,revalidateOnlyGenerated:j,resolvedPathname:k,clientReferenceManifest:N,serverActionsManifest:O}=z,M=(0,l.normalizeAppPath)(w),_=!!(f.dynamicRoutes[M]||f.routes[k]),x=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,S,!1):t.end("This page could not be found"),null);if(_&&!D){let e=!!f.routes[k],t=f.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await x();throw new v.NoFallbackError}}let A=null;!_||P.isDev||D||(A="/index"===(A=k)?"/":A);let L=!0===P.isDev||!_,W=_&&!L;O&&N&&(0,r.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:N,serverActionsManifest:O,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:O})});let q=e.method||"GET",H=(0,n.getTracer)(),U=H.getActiveScopeSpan(),K={params:y,prerenderManifest:f,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,i)=>P.onRequestError(e,t,i,I)},sharedContext:{buildId:E}},J=new d.NodeNextRequest(e),F=new d.NodeNextResponse(t),V=u.NextRequestAdapter.fromNodeNextRequest(J,(0,u.signalFromNodeResponse)(t));try{let r=async e=>P.handle(V,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=H.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${q} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${w}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var n,l;let d=async({previousCacheEntry:a})=>{try{if(!s&&C&&j&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await r(o);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&i.waitUntil&&(i.waitUntil(l),l=void 0);let d=K.renderOpts.collectedTags;if(!_)return await (0,m.sendResponse)(J,F,n,K.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[b.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=b.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,i=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=b.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==a?void 0:a.isStale)&&await P.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:W,isOnDemandRevalidate:C})},I),t}},u=await P.handleResponse({req:e,nextConfig:R,cacheKey:A,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:f,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:j,responseGenerator:d,waitUntil:i.waitUntil,isMinimalMode:s});if(!_)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",C?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),D&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&_||c.delete(b.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,T.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(J,F,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};U?await l(U):await H.withPropagatedContext(e.headers,()=>H.trace(c.BaseServerSpan.handleRequest,{spanName:`${q} ${w}`,kind:n.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await P.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:W,isOnDemandRevalidate:C})}),_)throw t;return await (0,m.sendResponse)(J,F,new Response(null,{status:500})),null}}e.s(["handler",()=>H,"patchFetch",()=>q,"routeModule",()=>P,"serverHooks",()=>W,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>L],387721)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_f5fc0fdd.js.map