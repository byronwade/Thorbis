module.exports=[920916,e=>{"use strict";var s=e.i(755535),t=e.i(377233),n=e.i(490003),i=e.i(492991),o=e.i(241970),r=e.i(357699),a=e.i(212454),l=e.i(48717),c=e.i(798301),u=e.i(986366),d=e.i(983537),h=e.i(147475),p=e.i(561930),g=e.i(803747),f=e.i(368557),m=e.i(42037),v=e.i(193695);e.i(432036);var b=e.i(573881),y=e.i(297676),w=e.i(244284),E=e.i(160505),S=e.i(394972),C=e.i(155611),R=e.i(267706),k=e.i(895811),N=e.i(70110);async function P(e){try{return await fetch(e,{method:"HEAD",headers:{"User-Agent":"Telnyx-Health-Check/1.0"}}),{accessible:!0}}catch(e){return{accessible:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function T(){let e={urlAccessible:!1,signatureVerificationWorks:!1,timestampValidationWorks:!1,webhookUrl:null,issues:[],warnings:[]},s=function(){for(let e of["http://localhost:3000",process.env.SITE_URL,"http://localhost:3000",process.env.APP_URL])if(e&&e.trim()){let s=e.trim();if(!(s.includes("localhost")||s.includes("127.0.0.1")||s.includes("0.0.0.0"))){let e=s.startsWith("http")?s:`https://${s}`;return`${e.replace(/\/+$/,"")}/api/webhooks/telnyx`}}}();if(!s)return e.issues.push("NEXT_PUBLIC_SITE_URL is not set to a valid production URL"),e;e.webhookUrl=s;let t=await P(s);t.accessible?e.urlAccessible=!0:e.issues.push(`Webhook URL is not accessible: ${t.error||"Unknown error"}`);let n=function(){if(!k.TELNYX_CONFIG.publicKey||""===k.TELNYX_CONFIG.publicKey.trim())return{works:!1,error:"TELNYX_PUBLIC_KEY is not configured"};if(!k.TELNYX_CONFIG.webhookSecret||""===k.TELNYX_CONFIG.webhookSecret.trim())return{works:!1,error:"TELNYX_WEBHOOK_SECRET is not configured"};try{let e=JSON.stringify({test:"data"}),s=Math.floor(Date.now()/1e3).toString();return(0,N.verifyWebhookSignature)({payload:e,signature:"invalid_signature_for_testing",timestamp:s}),{works:!0}}catch(e){return{works:!1,error:e instanceof Error?e.message:"Signature verification failed"}}}();n.works?e.signatureVerificationWorks=!0:n.error?.includes("not configured")?e.warnings.push(`Signature verification not configured: ${n.error}`):e.issues.push(`Signature verification failed: ${n.error||"Unknown error"}`);let i=function(){try{let e=Math.floor(Date.now()/1e3).toString(),s=(0,N.isWebhookTimestampValid)(e),t=(Math.floor(Date.now()/1e3)-400).toString(),n=(0,N.isWebhookTimestampValid)(t);if(s&&!n)return{works:!0};return{works:!1,error:"Timestamp validation logic may be incorrect"}}catch(e){return{works:!1,error:e instanceof Error?e.message:"Timestamp validation failed"}}}();return i.works?e.timestampValidationWorks=!0:e.issues.push(`Timestamp validation failed: ${i.error||"Unknown error"}`),e}async function _(e){let s=[],t=[],n=await (0,w.validateSmsConfig)();if(n.valid)s.push({success:!0,component:"SMS Configuration",message:"SMS configuration is valid"});else{let e=["Set TELNYX_API_KEY","Set NEXT_PUBLIC_SITE_URL to a valid production URL"];n.suggestedProfileId?e.push(`Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${n.suggestedProfileId} (found in your Telnyx account)`):e.push("Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID or run getDefaultMessagingProfile() to fetch it"),s.push({success:!1,component:"SMS Configuration",message:n.error||"SMS configuration is invalid",recommendations:e}),t.push(...s[s.length-1].recommendations||[])}let i=await (0,C.verifyMessagingProfile)();if(i.needsFix){let e=["Run fixMessagingProfile() to auto-fix webhook URLs","Verify messaging profile is enabled in Telnyx Portal"];if(!i.exists)try{let s=await (0,S.getDefaultMessagingProfile)();s.success&&s.profile&&e.unshift(`Set TELNYX_DEFAULT_MESSAGING_PROFILE_ID=${s.profile.id} (found "${s.profile.name}" in your Telnyx account)`)}catch{}s.push({success:!1,component:"Messaging Profile",message:"Messaging profile has configuration issues",details:{issues:i.issues,hasWebhookUrl:i.hasWebhookUrl,isActive:i.isActive},recommendations:e}),t.push(...s[s.length-1].recommendations||[])}else s.push({success:!0,component:"Messaging Profile",message:"Messaging profile is properly configured"});if(e){let n=await (0,R.verifySmsCapability)(e);n.hasSms?s.push({success:!0,component:"Phone Number SMS Capability",message:`Phone number ${e} supports SMS`,details:{phoneNumber:e}}):(s.push({success:!1,component:"Phone Number SMS Capability",message:n.error||"Phone number does not support SMS",details:{phoneNumber:e},recommendations:["Verify phone number is purchased with SMS capability","Ensure phone number is associated with a messaging profile","Check phone number status in Telnyx Portal"]}),t.push(...s[s.length-1].recommendations||[]))}let o=await T();!o.urlAccessible||o.issues.length>0?(s.push({success:!1,component:"Webhook Health",message:"Webhook configuration has issues",details:{urlAccessible:o.urlAccessible,signatureVerificationWorks:o.signatureVerificationWorks,issues:o.issues},recommendations:["Ensure webhook URL is publicly accessible","Configure TELNYX_PUBLIC_KEY and TELNYX_WEBHOOK_SECRET"]}),t.push(...s[s.length-1].recommendations||[])):s.push({success:!0,component:"Webhook Health",message:"Webhooks are healthy"});let r=s.every(e=>e.success),a=r?"SMS diagnostics passed - System is ready for SMS":`SMS diagnostics failed - ${s.filter(e=>!e.success).length} issue(s) found`;return{timestamp:new Date().toISOString(),overall:{healthy:r,summary:a},components:s,recommendations:[...new Set(t)]}}async function x(e){let s=[],t=[],n=(0,w.validateCallConfig)();n.valid?s.push({success:!0,component:"Call Configuration",message:"Call configuration is valid"}):(s.push({success:!1,component:"Call Configuration",message:n.error||"Call configuration is invalid",recommendations:["Set TELNYX_API_KEY","Set NEXT_PUBLIC_TELNYX_CONNECTION_ID","Set NEXT_PUBLIC_SITE_URL to a valid production URL"]}),t.push(...s[s.length-1].recommendations||[]));let i=await (0,E.verifyConnection)();if(i.needsFix?(s.push({success:!1,component:"Connection",message:"Connection has configuration issues",details:{issues:i.issues,hasWebhookUrl:i.hasWebhookUrl,isActive:i.isActive},recommendations:["Run fixConnection() to auto-fix webhook URLs","Verify connection is active in Telnyx Portal"]}),t.push(...s[s.length-1].recommendations||[])):s.push({success:!0,component:"Connection",message:"Connection is properly configured"}),e){let n=await (0,R.verifyVoiceCapability)(e);n.hasVoice?s.push({success:!0,component:"Phone Number Voice Capability",message:`Phone number ${e} supports voice`,details:{phoneNumber:e}}):(s.push({success:!1,component:"Phone Number Voice Capability",message:n.error||"Phone number does not support voice",details:{phoneNumber:e},recommendations:["Verify phone number is purchased with voice capability","Ensure phone number is associated with a connection","Check phone number status in Telnyx Portal"]}),t.push(...s[s.length-1].recommendations||[]))}let o=await T();!o.urlAccessible||o.issues.length>0?(s.push({success:!1,component:"Webhook Health",message:"Webhook configuration has issues",details:{urlAccessible:o.urlAccessible,signatureVerificationWorks:o.signatureVerificationWorks,issues:o.issues},recommendations:["Ensure webhook URL is publicly accessible","Configure TELNYX_PUBLIC_KEY and TELNYX_WEBHOOK_SECRET"]}),t.push(...s[s.length-1].recommendations||[])):s.push({success:!0,component:"Webhook Health",message:"Webhooks are healthy"});let r=s.every(e=>e.success),a=r?"Call diagnostics passed - System is ready for calls":`Call diagnostics failed - ${s.filter(e=>!e.success).length} issue(s) found`;return{timestamp:new Date().toISOString(),overall:{healthy:r,summary:a},components:s,recommendations:[...new Set(t)]}}async function A(e){let[s,t]=await Promise.all([_(e),x(e)]),n=s.overall.healthy&&t.overall.healthy;return{sms:s,calls:t,overall:{healthy:n,summary:n?"All diagnostics passed - System is production ready":"Some diagnostics failed - Review individual reports"}}}var U=e.i(273568);async function I(){let e={ready:!1,envVars:{valid:!1,errors:[],warnings:[]},connection:{configured:!1,verified:!1,issues:[]},messagingProfile:{configured:!1,verified:!1,issues:[]},phoneNumbers:{configured:!1,count:0,issues:[]},webhooks:{healthy:!1,issues:[],warnings:[]},overall:{ready:!1,summary:"",recommendations:[]}},s=(0,w.validateTelnyxConfig)();if(e.envVars.valid=s.valid,e.envVars.errors=s.errors,e.envVars.warnings=s.warnings,s.config.connectionId){e.connection.configured=!0;try{let s=await (0,E.verifyConnection)();e.connection.verified=!s.needsFix,e.connection.issues=s.issues}catch(s){e.connection.issues.push(s instanceof Error?s.message:"Failed to verify connection")}}else e.connection.issues.push("Connection ID is not configured");if(s.config.messagingProfileId){e.messagingProfile.configured=!0;try{let s=await (0,C.verifyMessagingProfile)();e.messagingProfile.verified=!s.needsFix,e.messagingProfile.issues=s.issues}catch(s){e.messagingProfile.issues.push(s instanceof Error?s.message:"Failed to verify messaging profile")}}else e.messagingProfile.issues.push("Messaging profile ID is not configured");try{let s=await (0,U.createServiceSupabaseClient)(),{data:t,error:n}=await s.from("phone_numbers").select("id").is("deleted_at",null).in("status",["active","pending"]);n?e.phoneNumbers.issues.push(`Failed to query phone numbers: ${n.message}`):(e.phoneNumbers.count=t?.length||0,e.phoneNumbers.configured=(t?.length||0)>0,0===e.phoneNumbers.count&&e.phoneNumbers.issues.push("No phone numbers are configured. Purchase at least one phone number from Telnyx."))}catch(s){e.phoneNumbers.issues.push(s instanceof Error?s.message:"Failed to check phone numbers")}try{let s=await T();e.webhooks.healthy=s.urlAccessible&&s.signatureVerificationWorks&&s.timestampValidationWorks&&0===s.issues.length,e.webhooks.issues=s.issues,e.webhooks.warnings=s.warnings}catch(s){e.webhooks.issues.push(s instanceof Error?s.message:"Failed to check webhook health")}let t=e.envVars.valid&&e.connection.configured&&e.connection.verified&&e.messagingProfile.configured&&e.messagingProfile.verified&&e.phoneNumbers.configured&&e.phoneNumbers.count>0&&e.webhooks.healthy;e.ready=t;let n=[];return e.envVars.valid||n.push("Fix environment variable configuration errors (see envVars.errors)"),e.connection.configured&&e.connection.verified||n.push("Configure and verify connection ID in Telnyx Portal → Mission Control → Connections"),e.messagingProfile.configured&&e.messagingProfile.verified||n.push("Configure and verify messaging profile in Telnyx Portal → Messaging → Profiles"),e.phoneNumbers.configured&&0!==e.phoneNumbers.count||n.push("Purchase at least one phone number with SMS and voice capabilities"),e.webhooks.healthy||n.push("Fix webhook configuration issues (see webhooks.issues)"),e.overall.recommendations=n,e.overall.ready=t,e.overall.summary=t?"Production ready - All checks passed":`Not production ready - ${n.length} issue(s) need attention`,e}async function L(e){try{let s,t=e.headers.get("authorization"),n=process.env.CRON_SECRET;if(!(n&&t===`Bearer ${n}`))return y.NextResponse.json({error:"Unauthorized"},{status:401});let i=e.nextUrl.searchParams,o=i.get("type")||"full",r=i.get("phoneNumber")||void 0;switch(o){case"sms":s=await _(r);break;case"calls":s=await x(r);break;default:s=await A(r)}let a=await I();return y.NextResponse.json({success:!0,diagnostics:s,productionReadiness:a,timestamp:new Date().toISOString()})}catch(e){return y.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function M(e){try{let s,t=e.headers.get("authorization"),n=process.env.CRON_SECRET;if(!(n&&t===`Bearer ${n}`))return y.NextResponse.json({error:"Unauthorized"},{status:401});let i=await e.json(),o=i.type||"full",r=i.phoneNumber||void 0;switch(o){case"sms":s=await _(r);break;case"calls":s=await x(r);break;default:s=await A(r)}let a=await I();return y.NextResponse.json({success:!0,diagnostics:s,productionReadiness:a,timestamp:new Date().toISOString()})}catch(e){return y.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Unknown error"},{status:500})}}e.s(["GET",()=>L,"POST",()=>M],578271);var O=e.i(578271);let D=new s.AppRouteRouteModule({definition:{kind:t.RouteKind.APP_ROUTE,page:"/api/telnyx/diagnostics/route",pathname:"/api/telnyx/diagnostics",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/telnyx/diagnostics/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:W,workUnitAsyncStorage:V,serverHooks:F}=D;function $(){return(0,n.patchFetch)({workAsyncStorage:W,workUnitAsyncStorage:V})}async function H(e,s,n){D.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/telnyx/diagnostics/route";y=y.replace(/\/index$/,"")||"/";let w=await D.prepare(e,s,{srcPage:y,multiZoneDraftMode:!1});if(!w)return s.statusCode=400,s.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:E,params:S,nextConfig:C,parsedUrl:R,isDraftMode:k,prerenderManifest:N,routerServerContext:P,isOnDemandRevalidate:T,revalidateOnlyGenerated:_,resolvedPathname:x,clientReferenceManifest:A,serverActionsManifest:U}=w,I=(0,l.normalizeAppPath)(y),L=!!(N.dynamicRoutes[I]||N.routes[x]),M=async()=>((null==P?void 0:P.render404)?await P.render404(e,s,R,!1):s.end("This page could not be found"),null);if(L&&!k){let e=!!N.routes[x],s=N.dynamicRoutes[I];if(s&&!1===s.fallback&&!e){if(C.experimental.adapterPath)return await M();throw new v.NoFallbackError}}let O=null;!L||D.isDev||k||(O="/index"===(O=x)?"/":O);let W=!0===D.isDev||!L,V=L&&!W;U&&A&&(0,r.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:A,serverActionsManifest:U,serverModuleMap:(0,a.createServerModuleMap)({serverActionsManifest:U})});let F=e.method||"GET",$=(0,o.getTracer)(),H=$.getActiveScopeSpan(),X={params:S,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:W,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:n.waitUntil,onClose:e=>{s.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(s,t,n)=>D.onRequestError(e,s,n,P)},sharedContext:{buildId:E}},Y=new c.NodeNextRequest(e),K=new c.NodeNextResponse(s),B=u.NextRequestAdapter.fromNodeNextRequest(Y,(0,u.signalFromNodeResponse)(s));try{let r=async e=>D.handle(B,X).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":s.statusCode,"next.rsc":!1});let t=$.getRootSpanAttributes();if(!t)return;if(t.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${t.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=t.get("next.route");if(n){let s=`${F} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":s}),e.updateName(s)}else e.updateName(`${F} ${y}`)}),a=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var o,l;let c=async({previousCacheEntry:t})=>{try{if(!a&&T&&_&&!t)return s.statusCode=404,s.setHeader("x-nextjs-cache","REVALIDATED"),s.end("This page could not be found"),null;let o=await r(i);e.fetchMetrics=X.renderOpts.fetchMetrics;let l=X.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let c=X.renderOpts.collectedTags;if(!L)return await (0,p.sendResponse)(Y,K,o,X.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),s=(0,g.toNodeOutgoingHttpHeaders)(o.headers);c&&(s[m.NEXT_CACHE_TAGS_HEADER]=c),!s["content-type"]&&e.type&&(s["content-type"]=e.type);let t=void 0!==X.renderOpts.collectedRevalidate&&!(X.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&X.renderOpts.collectedRevalidate,n=void 0===X.renderOpts.collectedExpire||X.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:X.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:s},cacheControl:{revalidate:t,expire:n}}}}catch(s){throw(null==t?void 0:t.isStale)&&await D.onRequestError(e,s,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:V,isOnDemandRevalidate:T})},P),s}},u=await D.handleResponse({req:e,nextConfig:C,cacheKey:O,routeKind:t.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:_,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:a});if(!L)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});a||s.setHeader("x-nextjs-cache",T?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),k&&s.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return a&&L||d.delete(m.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||s.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(Y,K,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};H?await l(H):await $.withPropagatedContext(e.headers,()=>$.trace(d.BaseServerSpan.handleRequest,{spanName:`${F} ${y}`,kind:o.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(s){if(s instanceof v.NoFallbackError||await D.onRequestError(e,s,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:V,isOnDemandRevalidate:T})}),L)throw s;return await (0,p.sendResponse)(Y,K,new Response(null,{status:500})),null}}e.s(["handler",()=>H,"patchFetch",()=>$,"routeModule",()=>D,"serverHooks",()=>F,"workAsyncStorage",()=>W,"workUnitAsyncStorage",()=>V],920916)}];

//# sourceMappingURL=3c0ae_next_dist_esm_build_templates_app-route_67d04895.js.map