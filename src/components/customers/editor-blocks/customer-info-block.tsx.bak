/**
 * Customer Info Block - Custom Tiptap Node
 *
 * Displays customer basic information as an editable block:
 * - Name (first_name, last_name)
 * - Email
 * - Phone
 * - Company name
 * - Customer type badge
 *
 * This is a Tiptap Node Extension that renders as a React component
 */

import { Node, mergeAttributes } from "@tiptap/core";
import { ReactNodeViewRenderer, NodeViewWrapper } from "@tiptap/react";
import type { NodeViewProps } from "@tiptap/react";
import { Building2, Mail, Phone, User } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { CollapsibleSectionWrapper } from "./collapsible-section-wrapper";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

// React component that renders the block
export function CustomerInfoBlockComponent({ node, updateAttributes, editor }: any) {
  const {
    firstName,
    lastName,
    email,
    phone,
    secondaryPhone,
    billingEmail,
    companyName,
    customerType
  } = node.attrs;
  const isEditable = editor.isEditable;

  return (
    <NodeViewWrapper className="customer-info-block">
      <CollapsibleSectionWrapper
        title="Customer Information"
        icon={<User className="size-5" />}
        defaultOpen={true}
        storageKey="customer-info-section"
        badge={<Badge variant="outline">{customerType || "residential"}</Badge>}
        isEditable={isEditable}
      >
        <div className="grid gap-6 md:grid-cols-2">
          {/* First Name */}
          <div className="space-y-2">
            <Label htmlFor={`firstName-${node.attrs.id}`}>First Name *</Label>
            {isEditable ? (
              <Input
                id={`firstName-${node.attrs.id}`}
                value={firstName || ""}
                onChange={(e) => updateAttributes({ firstName: e.target.value })}
                placeholder="John"
              />
            ) : (
              <p className="text-sm">{firstName || "—"}</p>
            )}
          </div>

          {/* Last Name */}
          <div className="space-y-2">
            <Label htmlFor={`lastName-${node.attrs.id}`}>Last Name *</Label>
            {isEditable ? (
              <Input
                id={`lastName-${node.attrs.id}`}
                value={lastName || ""}
                onChange={(e) => updateAttributes({ lastName: e.target.value })}
                placeholder="Smith"
              />
            ) : (
              <p className="text-sm">{lastName || "—"}</p>
            )}
          </div>

          {/* Email */}
          <div className="space-y-2">
            <Label htmlFor={`email-${node.attrs.id}`} className="flex items-center gap-1">
              <Mail className="size-3" />
              Email *
            </Label>
            {isEditable ? (
              <Input
                id={`email-${node.attrs.id}`}
                type="email"
                value={email || ""}
                onChange={(e) => updateAttributes({ email: e.target.value })}
                placeholder="john@example.com"
              />
            ) : (
              <a
                href={`mailto:${email}`}
                className="text-primary text-sm hover:underline"
              >
                {email || "—"}
              </a>
            )}
          </div>

          {/* Phone */}
          <div className="space-y-2">
            <Label htmlFor={`phone-${node.attrs.id}`} className="flex items-center gap-1">
              <Phone className="size-3" />
              Phone *
            </Label>
            {isEditable ? (
              <Input
                id={`phone-${node.attrs.id}`}
                type="tel"
                value={phone || ""}
                onChange={(e) => updateAttributes({ phone: e.target.value })}
                placeholder="(555) 123-4567"
              />
            ) : (
              <a href={`tel:${phone}`} className="text-primary text-sm hover:underline">
                {phone || "—"}
              </a>
            )}
          </div>

          {/* Secondary Phone */}
          <div className="space-y-2">
            <Label htmlFor={`secondaryPhone-${node.attrs.id}`} className="flex items-center gap-1">
              <Phone className="size-3" />
              Secondary Phone
            </Label>
            {isEditable ? (
              <Input
                id={`secondaryPhone-${node.attrs.id}`}
                type="tel"
                value={secondaryPhone || ""}
                onChange={(e) => updateAttributes({ secondaryPhone: e.target.value })}
                placeholder="(555) 987-6543"
              />
            ) : (
              secondaryPhone ? (
                <a href={`tel:${secondaryPhone}`} className="text-primary text-sm hover:underline">
                  {secondaryPhone}
                </a>
              ) : (
                <p className="text-muted-foreground text-sm">—</p>
              )
            )}
          </div>

          {/* Billing Email */}
          <div className="space-y-2">
            <Label htmlFor={`billingEmail-${node.attrs.id}`} className="flex items-center gap-1">
              <Mail className="size-3" />
              Billing Email
            </Label>
            {isEditable ? (
              <Input
                id={`billingEmail-${node.attrs.id}`}
                type="email"
                value={billingEmail || ""}
                onChange={(e) => updateAttributes({ billingEmail: e.target.value })}
                placeholder="billing@example.com"
              />
            ) : (
              billingEmail ? (
                <a
                  href={`mailto:${billingEmail}`}
                  className="text-primary text-sm hover:underline"
                >
                  {billingEmail}
                </a>
              ) : (
                <p className="text-muted-foreground text-sm">Same as primary</p>
              )
            )}
          </div>

          {/* Company Name */}
          <div className="space-y-2">
            <Label htmlFor={`companyName-${node.attrs.id}`} className="flex items-center gap-1">
              <Building2 className="size-3" />
              Company Name
            </Label>
            {isEditable ? (
              <Input
                id={`companyName-${node.attrs.id}`}
                value={companyName || ""}
                onChange={(e) => updateAttributes({ companyName: e.target.value })}
                placeholder="Optional"
              />
            ) : (
              <p className="text-sm">{companyName || "—"}</p>
            )}
          </div>

          {/* Customer Type */}
          <div className="space-y-2">
            <Label htmlFor={`customerType-${node.attrs.id}`}>Customer Type *</Label>
            {isEditable ? (
              <Select
                value={customerType || "residential"}
                onValueChange={(value) => updateAttributes({ customerType: value })}
              >
                <SelectTrigger id={`customerType-${node.attrs.id}`}>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="residential">Residential</SelectItem>
                  <SelectItem value="commercial">Commercial</SelectItem>
                  <SelectItem value="industrial">Industrial</SelectItem>
                </SelectContent>
              </Select>
            ) : (
              <p className="text-sm capitalize">{customerType || "residential"}</p>
            )}
          </div>
        </div>
      </CollapsibleSectionWrapper>
    </NodeViewWrapper>
  );
}

// Tiptap Node Extension
export const CustomerInfoBlock = Node.create({
  name: "customerInfoBlock",

  group: "block",

  atom: true,

  draggable: true,

  addAttributes() {
    return {
      id: {
        default: null,
      },
      firstName: {
        default: "",
      },
      lastName: {
        default: "",
      },
      email: {
        default: "",
      },
      phone: {
        default: "",
      },
      secondaryPhone: {
        default: "",
      },
      billingEmail: {
        default: "",
      },
      companyName: {
        default: "",
      },
      customerType: {
        default: "residential",
      },
    };
  },

  parseHTML() {
    return [
      {
        tag: 'div[data-type="customer-info-block"]',
      },
    ];
  },

  renderHTML({ HTMLAttributes }) {
    return ["div", mergeAttributes(HTMLAttributes, { "data-type": "customer-info-block" }), 0];
  },

  addNodeView() {
    return ReactNodeViewRenderer(CustomerInfoBlockComponent);
  },

  addCommands() {
    return {
      insertCustomerInfoBlock:
        (attributes: any) =>
        ({ commands }: any) => {
          return commands.insertContent({
            type: this.name,
            attrs: attributes,
          });
        },
    };
  },
});
